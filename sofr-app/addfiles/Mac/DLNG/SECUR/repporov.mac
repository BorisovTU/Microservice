/*
$Name:        repporov.mac
$Module:      Ценные бумаги
$Description: Отчет "Оценка портфеля ценных бумаг Банка"
*/

/*Поддержка 22.09.2011 Мантис 0012973*/
/*Поддержка 21.01.2011 Мантис 0007582*/
/*Мантис 25589 03/03/2014 */
/*Поддержка gko 27/02/2015 добавлены колонки 39.1/40.1 */
/*Поддержка adv 12/01/2016 добавлены колонки <N1_USR1>, <N1_USR2>*/

/*Гущина С.С. Мантис 24745 - формирование отчета Запрос на утро*/
/*14.12.2015 - support 389440*/
/*18.01.2016 - доработка отчета в связи с изменениями с 01.01.2016*/
/*21.02.2016 - adv запуск отчета по одной ц/б. 
               Использование временной таблицы для формирования отчета*/
/*22.09.2016 - Гущина С.С. Добавлена колонка "Фактически сформированный резерв на возможные потери" */
/*06.12.2016 - Гущина С.С. добавлены колонки начисленный купон / дисконт на внебалансе, установлен ХФ по ускорению формирования отчета*/
/*08.10.2018 - GAA: 468254 Добавлено поле "ID инструмента" - для отбражения fiid ц/б */
/*20.11.2018 - Гущина С.С. в оценке портфеля по портфелю до погашения не показывать разделение учета этих ц/б 
                           как "Бумаги, справедливая стоимость которых может быть надежно определена" 
                           или "Бумаги, справедливая стоимость которых НЕ может быть надежно определена"*/
/*08.01.2019 - Гущина С.С. изменение названий портфелей */
/*26.01.2019 - Гущина С.С. добавление колонки дата последнего курса Средневзвешенная цена и колонка
                           количество дней от последней котировки до даты отчета          */
/*10.02.2019 - Гущина С.С. добавление колонки котировка - курс Средневзвешенная цена*/

/*03.06.2019 - support 487071 ТСС для 115 - ищем курс НКД за предыдущий рабочий день*/
/*10.06.2019 - Гущина С.С. добавлены колонки по ОР и резерв под проц.доход*/
/*11.06.2019 - Гущина С.С. в колонке резерва замена на расчетную сумму резерва под вложения вместо "ПолучитьСуммуРезерва"*/

IMPORT "DLReport_h.mac";
IMPORT "repporov_form.mac";
import "secinter.mac", "spRepFn2.mac", "globals.mac", "DLReport_h.mac", "sp_car.mac",  "dlmisc.mac";
import RsbDataSet;

var Excel;

var start_time, cur_time, t1, t2;
record AccBuf(account); 
//adv для отладки по определенным бумагам, ПоОпределеннымБумагам перевести в true, в ОпределенныеБумаги перечислить id бумаг, через запятую
//добавил if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  t.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/


/*при отладке отчета по одной бумаге раскомменатирть строку, следующую закомментарить.
  после отладки вернуть как было. 
  не забываем что макрос используется на бою!!!*/
//var ПоОпределеннымБумагам =/* False */True, ОпределенныеБумаги = "3427";//"3257"; 
var ПоОпределеннымБумагам = False /*True*/, ОпределенныеБумаги = ""; /*"1667"*/



PRIVATE VAR  m_Form = DL_PorOv_Panel();

  PRIVATE MACRO UpdateFormFields():INTEGER
    DlRepFormData.Department      = m_Form.GetFieldValue( PNFLD_REPPOROV_Dprt );
    DlRepFormData.RepDate         = m_Form.GetFieldValue( PNFLD_REPPOROV_DATE ) - 1; /*будем брать данные на конец предшествующей даты*/
    DlRepFormData.SSPU            = m_Form.GetFieldValue( PNFLD_REPPOROV_SSPU );
    DlRepFormData.SSSD            = m_Form.GetFieldValue( PNFLD_REPPOROV_SSSD );
    DlRepFormData.ASCB            = m_Form.GetFieldValue( PNFLD_REPPOROV_ASCB );
    DlRepFormData.BPP_SSPU        = m_Form.GetFieldValue( PNFLD_REPPOROV_BPP_SSPU );
    DlRepFormData.BPP_SSSD        = m_Form.GetFieldValue( PNFLD_REPPOROV_BPP_SSSD );
    DlRepFormData.BPP_ASCB        = m_Form.GetFieldValue( PNFLD_REPPOROV_BPP_ASCB );
    DlRepFormData.BPP_CONTR       = m_Form.GetFieldValue( PNFLD_REPPOROV_BPP_CONTR );
    DlRepFormData.PVO             = m_Form.GetFieldValue( PNFLD_REPPOROV_PVO );
    DlRepFormData.OD_             = m_Form.GetFieldValue( PNFLD_REPPOROV_OD_ );
    DlRepFormData.OD              = m_Form.GetFieldValue( PNFLD_REPPOROV_OD );
    DlRepFormData.PKU             = m_Form.GetFieldValue( PNFLD_REPPOROV_PKU );
    DlRepFormData.PDO             = m_Form.GetFieldValue( PNFLD_REPPOROV_PDO );
    DlRepFormData.Back_KSU        = m_Form.GetFieldValue( PNFLD_REPPOROV_BACK_KSU );
    DlRepFormData.Back_BPP_KSU    = m_Form.GetFieldValue( PNFLD_REPPOROV_BACK_BPP_KSU );
    DlRepFormData.IsExportToExel  = m_Form.GetFieldValue( PNFLD_REPPOROV_TO_EXEL );
    DlRepFormData.IsUseApostrofs  = m_Form.GetFieldValue( PNFLD_REPPOROV_WITH_APOSTROFS );

    Excel = DlRepFormData.IsExportToExel;
  END;

private const ConvDate_2072 = date(02,01,2019); //дата фиксации рублевого покрытия для Fiid = 2072 GAA: 476586  
/*GAA:476586*/  
MACRO CheckFI (_fiid, _FaceValueFI, Repdate: date, LotDate: date, _portfolio: Integer): date
 
var DateConv = Repdate;

if (_portfolio != 6/*ПВО*/ )/*GAA: 484970 по ц/б полученным по ОР - конвертировать по куросу на Repdate*/
if ((_fiid == 2072)/*GAA:483628*/ and (LotDate < ConvDate_2072))
     DateConv = ConvDate_2072;
elif (( _FaceValueFI!= NATCUR ) and (not FI_IsBond(_fiid)))
     DateConv = LotDate;
else
     DateConv;
   end;  
else 
  DateConv;	 
end;
    return  DateConv;
END; /*CheckFI*/ 

private const StatLine = "Выпуск отчета \"Оценка портфеля ценных бумаг Банка\"";

private const SP_RATETYPE_TSS_reqcom = 12/*14*/;/*GAA: 485158*/

private const
   /* Идентификаторы учетных портфелей. */
   PortfID_Undef             = 0,
   PortfID_SSPU              = 1,   /* ССПУ_ЦБ */
   PortfID_SSSD              = 2,   /* СССД_ЦБ */
   PortfID_Contr             = 3,   /* ПКУ */
   PortfID_Promissory        = 4,   /* ПДО */
   PortfID_ASCB              = 5,   /* АС_ЦБ */
   PortfID_Back              = 6,   /* ПВО */
   PortfID_Unadmitted_SSPU   = 7,   /* БПП_ССПУ_ЦБ */
   PortfID_OD_req            = 8,   /* ПВО_БПП */
   PortfID_OD_com            = 9,   /* -ОД */
   PortfID_Unadmitted_SSSD   = 10,  /* БПП_СССД_ЦБ */
   PortfID_Unadmitted_ASCB   = 11,  /* БПП_АС_ЦБ */
   PortfID_Unadmitted_CONTR  = 12,  /* БПП_ПКУ */
   PortfID_Back_KSU          = 13,  /* ПВО_КСУ */
   PortfID_Back_BPP_KSU      = 14;  /* ПВО_БПП_КСУ */

private const ДИСКОНТ          = 1;
private const ПРОЦЕНТ          = 2;
private const БОНУС            = 3;
private const КОРРЕКТИРОВКАЭПС = 4;

/* Данные отчета */
private class (TBaseReportData) ReportData()

   var
      WasExistsDepData  = false,
      WasCollectedData  = false,                       
      UniqStr           = TUniqStrCollector,
      PortfNameArray    = TArray;

   /* Конструктор */
   initTBaseReportData( DlRepFormData.IsUseApostrofs );
     
   /* Названия портфелей. */
   PortfNameArray[PortfID_Undef]              = "Undefined";
   PortfNameArray[PortfID_SSPU]               = SSPUPORTFNAME;
   PortfNameArray[PortfID_SSSD]               = SSSDPORTFNAME;
   PortfNameArray[PortfID_ASCB]               = ASCBPORTFNAME;
   PortfNameArray[PortfID_Unadmitted_SSPU]    = "Ц/б, переданные без прекращения признания из оцениваемых по СС через прибыль или убыток";
   PortfNameArray[PortfID_Unadmitted_SSSD]    = "Ц/б, переданные без прекращения признания из оцениваемых по СС через прочий совокупный доход";
   PortfNameArray[PortfID_Unadmitted_ASCB]    = "Ц/б, переданные без прекращения признания из оцениваемых по АС (амортизированной стоимости)";
   PortfNameArray[PortfID_Unadmitted_CONTR]   = "Ц/б, переданные без прекращения признания из портфеля контрольного участия";
   PortfNameArray[PortfID_Back]               = BACKPORTFNAME;
   PortfNameArray[PortfID_OD_com]             = ODCOMPORTFNAME;/* -ОД*/
   PortfNameArray[PortfID_OD_req]             = ODREQPORTFNAME; /* ПВО_БПП*/
   PortfNameArray[PortfID_Contr]              = CONTRPORTFNAME;
   PortfNameArray[PortfID_Promissory]         = PROMISSPORTFNAME;
   PortfNameArray[PortfID_Back_KSU]           = BACKKSUPORTFNAME;   
   PortfNameArray[PortfID_Back_BPP_KSU]       = BACKBPPKSUPORTFNAME;

end;

var TableHead =
   "┌────────────────────┬──────────────────────────────┬─────────────────────────┬────────────┬──────────────────┬──────────────────┬─────────┬─────────┬─────────┬──────────┬────────┬────────┬────────────┬─────────┬─────────┬───────────────────────────────────────┬────────────────────────────────────────┬─────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬────────────────────────────────────┬─────────────────────────────┬─────────────────────────────────────────┬─────────────────────────────────────────┬────────────────────────────────────┬──────────────────────┬──────────────────┬──────────────────┬──────────────────┬─────────────────────┬──────────────────────────────────────┬───────────────────────────────────┬──────────────────────────────────────┬──────────────────────────────────────┐\n" +
   "│ Номер лицевого     │                              │       Наименование      │ Тип ценной │       № гос.     │       ISIN       │  Дата   │  Дата   │  Дата   │   Дата   │ Валюта │Коли-   │  Номинал   │Ставка   │Кол-во   │                                       │                                        │                Затраты              │                 НКД                │       Начисленный процентный       │       Начисленный дисконтный       │         Остаток премии             │  Начисленная корректировка  │ Прогнозное значение процентного дохода, │ Прогнозное значение дисконтного дохода, │       Прогнозное значение премии,  │ Прогнозное значение  │ Общий процентный │ Общий дисконтный │ Общий остаток    │ Общая корректировка │           Сумма переоценки,          │          Справедливая             │           Расчетная балансовая       │          Прогнозное значение         │\n" +
   "│ счета              │                              │       ценной бумаги     │   бумаги   │    регистрации   │                  │погашения│ выпуска │погашения│пересмотра│номинала│чество  │   за ед.   │дохода по│шт.      │           Балансовая стоимость        │          Покупная стоимость            │                                     │                                    │       доход на балансе             │       доход на балансе             │           на балансе               │      до ЭПС на балансе      │ подлежащего начислению на дату отчета   │ подлежащего начислению на дату отчета   │ подлежащей списанию на дату отчета │ корректировки до ЭПС,│ доход, руб.      │ доход, руб.      │ премии, руб.     │ % до ЭПС, руб.      │          отраженная на балансе       │            стоимость              │                стоимость             │      суммы предстоящей переоценки    │\n" +
   "│ вложений в ц/б     │           Эмитент            │                         │            │                  │                  │ купона  │облигации│облигации│    %%    │        │ц/б     │            │купону   │         │                                       │                                        │                                     │                                    │                                    │                                    │                                    │                             │                                         │                                         │                                    │ подлежащей начислению│                  │                  │                  │                     │                                      │                                   │                                      │                                      │\n" +
   "│                    │                              │                         │            │                  │                  │         │         │         │          │        │в де-   │            │         │         ├───────────────────┬───────────────────┼────────────────────┬───────────────────┼───────────────────┬─────────────────┼──────────────────┬─────────────────┼──────────────────┬─────────────────┼──────────────────┬─────────────────┼──────────────────┬─────────────────┼─────────────────────────────┼────────────────────┬────────────────────┼────────────────────┬────────────────────┼──────────────────┬─────────────────┤ на дату отчета       │                  │                  │                  │                     ├───────────────────┬──────────────────┼────────────────┬──────────────────┼───────────────────┬──────────────────┼───────────────────┬──────────────────┤\n" +
   "│                    │                              │                         │            │                  │                  │         │         │         │          │        │позитар-│            │         │         │                   │                   │                    │                   │                   │                 │                  │                 │                  │                 │                  │                 │                  │                 │                             │                    │                    │                    │                    │                  │                 │                      │                  │                  │                  │                     │                   │                  │                │                  │                   │                  │                   │                  │\n" +
   "│                    │                              │                         │            │                  │                  │         │         │         │          │        │ной     │            │         │         │        вал.       │        руб.       │       вал.         │       руб.        │       вал.        │      руб.       │      вал.        │       руб.      │       вал.       │       руб.      │       вал.       │       руб.      │       вал.       │       руб.      │             руб.            │         вал.       │        руб.        │        вал.        │          руб.      │       вал.       │       руб.      │                      │                  │                  │                  │                     │       вал.        │       руб.       │     вал.       │       руб.       │       вал.        │       руб.       │       вал.        │       руб.       │\n" +
   "│                    │                              │                         │            │                  │                  │         │         │         │          │        │расписке│            │         │         │                   │                   │                    │                   │                   │                 │                  │                 │                  │                 │                  │                 │                  │                 │                             │                    │                    │                    │                    │                  │                 │                      │                  │                  │                  │                     │                   │                  │                │                  │                   │                  │                   │                  │\n" +
   "├────────────────────┼──────────────────────────────┼─────────────────────────┼────────────┼──────────────────┼──────────────────┼─────────┼─────────┼─────────┼──────────┼────────┼────────┼────────────┼─────────┼─────────┼───────────────────┼───────────────────┼────────────────────┼───────────────────┼───────────────────┼─────────────────┼──────────────────┼─────────────────┼──────────────────┼─────────────────┼──────────────────┼─────────────────┼──────────────────┼─────────────────┼─────────────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼──────────────────┼─────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼─────────────────────┼───────────────────┼──────────────────┼────────────────┼──────────────────┼───────────────────┼──────────────────┼───────────────────┼──────────────────┤\n" +
   "│         1          │              2               │            3            │     4      │        5         │        6         │    7    │     8   │    9    │    10    │   10   │   11   │     12     │    13   │    14   │        15         │        16         │        17          │        18         │        19         │       20        │       21         │       22        │        23        │       24        │        25        │       26        │        27        │       28        │              29             │          30        │         31         │         32         │         33         │        34        │       35        │          36          │        37        │        38        │        39        │          40         │        41         │        42        │       43       │        44        │        45         │        46        │         47        │        48        │\n" +
   "├────────────────────┼──────────────────────────────┼─────────────────────────┼────────────┼──────────────────┼──────────────────┼─────────┼─────────┼─────────┼──────────┼────────┼────────┼────────────┼─────────┼─────────┼───────────────────┼───────────────────┼────────────────────┼───────────────────┼───────────────────┼─────────────────┼──────────────────┼─────────────────┼──────────────────┼─────────────────┼──────────────────┼─────────────────┼──────────────────┼─────────────────┼─────────────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼──────────────────┼─────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼─────────────────────┼───────────────────┼──────────────────┼────────────────┼──────────────────┼───────────────────┼──────────────────┼───────────────────┼──────────────────┤";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
PRIVATE VAR Cap = "Оценка портфеля ценных бумаг Банка по состоянию на ########## ";
PRIVATE VAR Branch = "Филиал: #";
PRIVATE VAR ReportRunFalse = "#";

const FontStyleTitel =  "ex_FS(b)";
/*GAA: пользовательские поля до hf39*/
macro DateRevision(Id, Dat)       /*Дата пересмотра %*/
  var DatePer;
  var query1, rs1;
  var query2, rs2;
  var query3, rs3;
  var perFut,perReal;
  
 /* msgbox(id);*/
 /*при определении даты изменения %% ставки исключили купоны фиксированного дохода, не % от номинала*/
  query1 = RSDCommand("select max(d.T_DRAWINGDATE) as daterate from DFIWARNTS_dbt d "+
                      "where  d.T_DRAWINGDATE >= ? and d.T_FIID = ? and /*d.T_RELATIVEINCOME='X'and*/ D.T_FIRSTDATE <> to_date('01,01,0001','dd,mm,yyyy') and d.T_DRAWINGDATE < ("+ 
                      "select min (d2.T_DRAWINGDATE) from DFIWARNTS_dbt d2 "+
                      "where d2.T_DRAWINGDATE >= ? and d2.T_FIID = ? and /*d2.T_RELATIVEINCOME='X'and*/ D2.T_FIRSTDATE <> to_date('01,01,0001','dd,mm,yyyy') " +
                      "and d2.T_ISPARTIAL <>'X' and d2.T_INCOMERATE not in ("+
                          "select d3.T_INCOMERATE from DFIWARNTS_dbt d3 where d3.T_FIID = ?"+
                          "and d3.T_DRAWINGDATE = ("+
                             "select min(d4.T_DRAWINGDATE) T_INCOMERATE from DFIWARNTS_dbt d4 where /*d4.T_RELATIVEINCOME='X'and*/  d4.T_DRAWINGDATE >= ? and d4.T_FIID = ? and d4.T_ISPARTIAL = chr(0))))");

  query1.AddParam("", RSDBP_IN, Dat);
  query1.AddParam("", RSDBP_IN, Id);
  query1.AddParam("", RSDBP_IN, Dat);
  query1.AddParam("", RSDBP_IN, Id);
  query1.AddParam("", RSDBP_IN, Id);
  query1.AddParam("", RSDBP_IN, Dat);
  query1.AddParam("", RSDBP_IN, Id);

  query1.execute();

  rs1 = TRsbDataSet(query1);
  rs1.MoveNext();
  DatePer = date_as_string(1,rs1.daterate);
  if (DatePer == "")/*если нет изменений %% купонов*/
   query1 = RSDCommand("select max (d.T_DRAWINGDATE) as daterate1 from DFIWARNTS_dbt d "+
                      "where d.T_DRAWINGDATE >= ? and d.T_FIID = ? and D.T_FIRSTDATE <> to_date('01,01,0001','dd,mm,yyyy') ");

   query1.AddParam("", RSDBP_IN, Dat);
   query1.AddParam("", RSDBP_IN, Id);

   query1.execute();

   rs1 = TRsbDataSet(query1);
   rs1.MoveNext();
   DatePer = date_as_string(1,rs1.daterate1);
  else 
  end;
  return DatePer;
end;

macro DateCursCCpr(ID, FaceValueFi, FaceValue, AvoirKind, Dat, sincedate, RateCurCC)       /*Дата последнего курса Средневзвешенная цена и сам курс*/
  var DatePer;
  var ВНЕБИРЖА = 4414; /*ВНЕБИРЖА*/
  var MarcetID = 2;
  Var sql, sql1, cmd, cmd1;
  var rate;
     if (((AvoirKind == 43)or ((AvoirKind == 28) /*and (Id != 650)*/))      /*если ц/б еврооблигация то берем ВНЕБИРЖЕВОЙ курс, исключение Россия 2030*/
       or (((AvoirKind == 1) or (AvoirKind == 2)) and (FACEVALUEFI != 0))
       )   /**/
         if (Id != 650)
         sql =       " select t_sincedate as sincedate, t_rate/POWER (10, t_point) as rate, t_isrelative as rel, t_fiid as faceid from dratedef_dbt where T_OTHERFI = "+ Id;
         sql = sql + " and t_sincedate <= " + GetSQLDate(Dat);
         sql = sql + " and T_TYPE = 4 "; /*Средневзвешенная цена*/
         sql = sql + " and t_rate <>0";
         sql = sql + " and T_MARKET_PLACE =" + ВНЕБИРЖА;
         cmd = TrsbDataSet(sql);
         If (cmd.movenext())
           setparm(5,cmd.sincedate);
           setparm(6,cmd.rate);
           return;
         else
      
          sql1 = " select def.T_RATEID, def.T_FIID, def.T_OTHERFI, def.T_NAME, def.T_DEFINITION, ";
          sql1 = sql1 + " def.T_TYPE, def.T_ISDOMINANT, def.T_ISRELATIVE, def.T_INFORMATOR, ";
          sql1 = sql1 + " def.T_MARKET_PLACE, def.T_ISINVERSE, hist.T_RATE/POWER(10,hist.t_point) as rate, hist.T_SCALE, hist.T_POINT, ";
          sql1 = sql1 + " def.T_INPUTDATE, def.T_INPUTTIME, def.T_OPER, hist.t_SINCEDATE as sincedate, def.T_SECTION ";
          sql1 = sql1 + " From dratedef_dbt def, dratehist_dbt hist ";
          sql1 = sql1 + " where def.T_OTHERFI = " + Id + " and ";
          sql1 = sql1 + " def.t_type = 4  and ";
          sql1 = sql1 + " hist.t_rateid = def.t_rateid ";
          sql1 = sql1 + " and hist.t_sincedate <= " + GetSQLDate(Dat);
          sql1 = sql1 + " and def.T_MARKET_PLACE =" + ВНЕБИРЖА;
          sql1 = sql1 + " and hist.t_rate <>0";
          sql1 = sql1 + " and rownum = 1";
          sql1 = sql1 + " ORDER BY hist.T_RATEID, hist.T_SINCEDATE DESC";
          cmd1 = TrsbDataSet(sql1);
          If (cmd1.movenext())
           setparm(5,cmd1.sincedate);
           setparm(6,cmd1.rate);
           return;
          end; 
         end;

         end; /*if (Id != 650)*/
         /*если не нашли курс внебиржи или бумага 650, то ищем курс по другим биржам - только облигации и 
           акции (обычных и привилегированных), номинированных в иностранной валюте*/
         sql =       " select t_sincedate as sincedate, t_rate/POWER (10, t_point) as rate, t_isrelative as rel, t_fiid as faceid from dratedef_dbt where T_OTHERFI = "+ Id;
         sql = sql + " and t_sincedate <= " + GetSQLDate(Dat);
         sql = sql + " and T_TYPE = 4 "; /*Средневзвешенная цена*/
         sql = sql + " and t_rate <>0";
         sql = sql + " and T_MARKET_PLACE not in ("+ВНЕБИРЖА+","+MarcetID+")";
         cmd = TrsbDataSet(sql);
         If (cmd.movenext())
           setparm(5,cmd.sincedate);
           setparm(6,cmd.rate);
           return;
         else
      
          sql1 = " select def.T_RATEID, def.T_FIID, def.T_OTHERFI, def.T_NAME, def.T_DEFINITION, ";
          sql1 = sql1 + " def.T_TYPE, def.T_ISDOMINANT, def.T_ISRELATIVE, def.T_INFORMATOR, ";
          sql1 = sql1 + " def.T_MARKET_PLACE, def.T_ISINVERSE, hist.T_RATE/POWER(10,hist.t_point) as rate, hist.T_SCALE, hist.T_POINT, ";
          sql1 = sql1 + " def.T_INPUTDATE, def.T_INPUTTIME, def.T_OPER, hist.t_SINCEDATE as sincedate, def.T_SECTION ";
          sql1 = sql1 + " From dratedef_dbt def, dratehist_dbt hist";
          sql1 = sql1 + " where def.T_OTHERFI = " + Id + " and ";
          sql1 = sql1 + " def.t_type = 4  and ";
          sql1 = sql1 + " hist.t_rateid = def.t_rateid";
          sql1 = sql1 + " and hist.t_sincedate <= " + GetSQLDate(Dat);
          sql1 = sql1 + " and def.T_MARKET_PLACE not in ("+ВНЕБИРЖА+","+MarcetID+")";
          sql1 = sql1 + " and hist.t_rate <>0";
          sql1 = sql1 + " and rownum = 1";
          sql1 = sql1 + " ORDER BY hist.T_RATEID, hist.T_SINCEDATE DESC";
          cmd1 = TrsbDataSet(sql1);
          If (cmd1.movenext())
           setparm(5,cmd1.sincedate);
           setparm(6,cmd1.rate);
           return;
          end; 
         end;


     else  /*все остальные бумаги (кроме облигаций и акций, номинированных в ин.валюте*/
         sql =       " select t_sincedate as sincedate, t_rate/POWER (10, t_point) as rate, t_isrelative as rel, t_fiid as faceid from dratedef_dbt where T_OTHERFI = "+ Id;
         sql = sql + " and t_sincedate <= " + GetSQLDate(Dat);
         sql = sql + " and T_TYPE = 4 "; /*Средневзвешенная цена*/
         sql = sql + " and t_rate <>0";
         sql = sql + " and T_MARKET_PLACE <>" + MarcetID;
         cmd = TrsbDataSet(sql);
         If (cmd.movenext())
           setparm(5,cmd.sincedate);
           setparm(6,cmd.rate);
           return;
         else
      
          sql1 = " select def.T_RATEID, def.T_FIID, def.T_OTHERFI, def.T_NAME, def.T_DEFINITION, ";
          sql1 = sql1 + " def.T_TYPE, def.T_ISDOMINANT, def.T_ISRELATIVE, def.T_INFORMATOR, ";
          sql1 = sql1 + " def.T_MARKET_PLACE, def.T_ISINVERSE, hist.T_RATE/POWER(10,hist.t_point) as rate, hist.T_SCALE, hist.T_POINT, ";
          sql1 = sql1 + " def.T_INPUTDATE, def.T_INPUTTIME, def.T_OPER, hist.t_SINCEDATE as sincedate, def.T_SECTION ";
          sql1 = sql1 + " From dratedef_dbt def, dratehist_dbt hist";
          sql1 = sql1 + " where def.T_OTHERFI = " + Id + " and ";
          sql1 = sql1 + " def.t_type = 4  and ";
          sql1 = sql1 + " hist.t_rateid = def.t_rateid";
          sql1 = sql1 + " and hist.t_sincedate <= " + GetSQLDate(Dat);
          sql1 = sql1 + " and def.T_MARKET_PLACE <>" + MarcetID;
          sql1 = sql1 + " and hist.t_rate <>0";
          sql1 = sql1 + " and rownum = 1";
          sql1 = sql1 + " ORDER BY hist.T_RATEID, hist.T_SINCEDATE DESC";
          cmd1 = TrsbDataSet(sql1);
          If (cmd1.movenext())
           setparm(5,cmd1.sincedate);
           setparm(6,cmd1.rate);
           return;
          end; 
         end;


     end;

           setparm(5,"");
           setparm(6,"");
           return;
  
end;



MACRO GetFiidRate(fiid, repdate, kind) /*Значение курса "НКД нa 1 ц/б" за текущую дату если есть или предыдущую, также позволяет вывести дату курса*/
 var Query, select2, query2, rate, sdate, facevalue;
 var Select =RSDCommand(" select * from (SELECT cur.t_rateid as rateid, cur.t_rate / POWER (10, cur.t_point) AS rate, cur.t_sincedate  FROM dratedef_dbt cur  WHERE cur.t_type = 15 AND cur.t_otherfi = ? " +
                        " AND t_sincedate = ?"+
                        " UNION "+
                        " SELECT hist.t_rateid as rateid, hist.t_rate / POWER (10, hist.t_point) AS rate, hist.t_sincedate  FROM dratehist_dbt hist  WHERE hist.t_rateid IN " +
                        " (SELECT t_rateid  FROM dratedef_dbt WHERE t_type = 15 AND t_otherfi = ?) " +
                        "  AND t_sincedate = (select max (t_sincedate) from dratehist_dbt hist " +
                        "  WHERE hist.t_rateid IN (SELECT t_rateid FROM dratedef_dbt  WHERE t_type = 15 AND t_otherfi = ?) and  t_sincedate<= ?) " + 
                        " ORDER BY rateid, t_sincedate DESC ) where rownum =1 ");

     Select.addParam( "", RSDBP_IN, fiid);
     Select.addParam( "", RSDBP_IN, date(repdate));
     Select.addParam( "", RSDBP_IN, fiid);
     Select.addParam( "", RSDBP_IN, fiid);
     Select.addParam( "", RSDBP_IN, date(repdate));
     
     Query = TRsbDataSet(select);

     if (kind ==1) /*вернем дату курса*/
      if(query.movenext())
        sdate = date(Query.t_sincedate);
        return sdate;
      end;
     end;
     
     if(kind ==2) /*вернем курс*/
      if(Query.MoveNext())
        rate = Query.rate;                                                                                                                                             
        Select2 = RSDCommand("SELECT t_fiid as faceid, t_isrelative as rel FROM dratedef_dbt WHERE t_rateid = ? AND t_type = 15"); /*конвертнем в money с учетом призака в "%"*/
        Select2.addParam( "", RSDBP_IN,query.rateid);
        Query2 = TRsbDataSet(select2);
         if (query2.movenext())
             if (query2.rel=="X") /*курс в % от номинала*/ 
              facevalue = money(GetFaceValue( fiid,date(repdate)));
              rate = facevalue*money(rate)/100;
              if (SmartConvertSum(rate,money(rate),Repdate, query2.faceid, query2.faceid,false)==true);
                return rate;
              end;
             else
              if (SmartConvertSum(rate,money(rate),Repdate, query2.faceid, query2.faceid,false)==true);
                return rate;
              end;
             end;
         end;
      end;
     end; 
END;


macro PrintHead(Rep)
   Rep.PrintFormatString( Cap, "N1_H0", string(DlRepFormData.RepDate + 1) );
   Rep.CopyAllSheetInTotalBook( NULL, false, "N1_Cap", 0 );

   Rep.PrintFormatString( Branch, "N1_H0_1", DL_GetDepartmentNameByCode(DlRepFormData.Department) );
   Rep.CopyAllSheetInTotalBook( NULL, false, "N1_Branch", 1 );

   Rep.CopyAllSheetInTotalBook( NULL, false, "N1_TableHead", 0 );

   Rep.RegisterTable( "N1_TableLine", TableHead,
                      "N1_A1",
                      "N1_A2",   
                      "N1_A3",    
                      "N1_A4",
                      "N1_A5",
                      "N1_A6",
                      "N1_A7",
                      "N1_A8",
                      "N1_A9",
                      "N1_A46", //GAA: пользовательские поля до hf39
                      "N1_A10",
                      "N1_A11",
                      "N1_A12",
                      "N1_A13",
                      "N1_A14",
                      "N1_A15",   
                      "N1_A16",    
                      "N1_A17",
                      "N1_A18",
                      "N1_A19",
                      "N1_A20",
                      "N1_A21",
                      "N1_A22",
                      "N1_A23",
                      "N1_A24",
                      "N1_A25",
                      "N1_A26",
                      "N1_A43",
                      "N1_A44",
                      "N1_USR1", // adv
                      "N1_USR2", // adv
                      "N1_A47",
                      "N1_A27",
                      "N1_A28",
                      "N1_A29",
                      "N1_A30",
                      "N1_A41",
                      "N1_A42",
                      "N1_A48",
                      "N1_A31",
                      "N1_A32",
                      "N1_A49",
                      "N1_A50",
                      "N1_A33",
                      "N1_A34",
                      "N1_A35",
                      "N1_A36",
                      "N1_A35_1",  //GAA: пользовательские поля до hf39
                      "N1_A36_1",  //GAA: пользовательские поля до hf39
                      "N1_A37",
                      "N1_A38",
                      "N1_A39",
                      "N1_A40",
                      "N1_A45",   //GAA: пользовательские поля до hf39
                      "N1_A47_1", //GAA, old: N1_A47. пользовательские поля до hf39
                      "N1_A48_1", //GAA, old: N1_A48. пользовательские поля до hf39
                      "N1_USR6" , //резерв под проц.доход
                      "N1_USR4" , //ОР под вложения
                      "N1_USR5" , //ОР под процентный доход
                      "N1_A49_1", //GAA, old: N1_A49. пользовательские поля до hf39
                      "N1_A54",   //GAA: пользовательские поля до hf39
                      "N1_A55",   //GAA: пользовательские поля до hf39
                      "N1_A56",   //GAA: пользовательские поля до hf39
                      "N1_A57",   //GAA: пользовательские поля до hf39
                      "N1_A58",   //GAA: пользовательские поля до hf39
                      "N1_A59",   //GAA: пользовательские поля до hf39
                      "N1_USR3",/*GAA:468940*/                         
                      "N1_A60", //GAA: пользовательские поля до hf39
                      "N1_A61", //GAA: пользовательские поля до hf39
                      "N1_A62"  //GAA: пользовательские поля до hf39
                   );
end;

macro DStr(Val)
   if( Val != null)
      return Val;
   else
      return "";
   end;
end;                       

macro PrintDString( Rep, Account, IssShName, AvrName, AvKindShName, LSIN, ISIN, CoupDrawDate, BondFirstDate, BondRetDate,/**/DateRevis, DateCursCC, CountDCursCC, RateCurCC,//GAA: пользовательские поля до hf39
                    FaceValCcy, AvDep, FaceValue, IncomeRate, AvoirAmountStr, BalCostCUR, BalCostRUR, BuyCostCUR, BuyCostRUR,
                    OutlayCUR, OutlayRUR, NKD_CUR, NKD_RUR, Calc_PD_CUR, Calc_PD_RUR, Calc_DD_CUR, Calc_DD_RUR,
                    PrepCalc_Bonus_CUR, PrepCalc_Bonus_RUR, Bonus_Rest_CUR, Bonus_Rest_RUR,

                    BegBonus_CUR, BegBonus_RUR, //adv

                    PrepCalc_PD_CUR, PrepCalc_PD_RUR, PrepCalc_DD_CUR, PrepCalc_DD_RUR, Common_PD, Common_DD, OverAmountCUR, OverAmountRUR,
                    TSS_CUR, TSS_RUR, /**/curTSS_CUR, curTSS_RUR,/**/ CalcBalCostCUR, CalcBalCostRUR, PrepOverAmountCUR, PrepOverAmountRUR,
                    /**/ NKDone, /**/InsExpCommBuyCUR, InsExpCommBuyRUR,/**/Prim, Rez,RezPD, ORez, ORezPD, 
                    KK, priznak_spv, INN_emitent, kod_okato, okved_emitent, kod_dlya_form_711, kod_vida_instr_f120, FIID,/*GAA:468940*///GAA: пользовательские поля до hf39
                    CorrIntToEIR, PrepCorrIntToEIR, TotalBonusRestRUR, TotalCorr
                  )

   var SumPrecision = 0;
   if(IsHaveFractPart(AvDep) OR IsHaveFractPart(AvoirAmountStr)) 
      SumPrecision = 6; 
   end;

   Rep.PrintTableLine( "N1_A1",  DStr(Account),            null,
                       "N1_A2",  DStr(IssShName),          null,
                       "N1_A3",  DStr(AvrName),            null,
                       "N1_A4",  DStr(AvKindShName),       null,
                       "N1_A5",  DStr(LSIN),               null,
                       "N1_A6",  DStr(ISIN),               null,
                       "N1_A7",  DStr(CoupDrawDate),       null,
                       "N1_A8",  DStr(BondFirstDate),      null,
                       "N1_A9",  DStr(BondRetDate),        null,
                          "N1_A46",   DStr(DateRevis),          null,//GAA: пользовательские поля до hf39
                       "N1_A10", DStr(FaceValCcy),         null,
                       "N1_A11", DStr(AvDep),              SumPrecision,
                       "N1_A12", DStr(FaceValue),          null,
                       "N1_A13", DStr(IncomeRate),         null,
                          "N1_A14",   DStr(AvoirAmountStr),  /* SumPrecision ААИ Айс 355738 */ SetPrecisionByFractPart( AvoirAmountStr, 6, 0 ),
                       "N1_A15", DStr(BalCostCUR),         null,
                       "N1_A16", DStr(BalCostRUR),         null,
                       "N1_A17", DStr(BuyCostCUR),         null,
                       "N1_A18", DStr(BuyCostRUR),         null,
                       "N1_A19", DStr(OutlayCUR),          null,
                       "N1_A20", DStr(OutlayRUR),          null,
                       "N1_A21", DStr(NKD_CUR),            null,
                       "N1_A22", DStr(NKD_RUR),            null,
                       "N1_A23", DStr(Calc_PD_CUR),        null,
                       "N1_A24", DStr(Calc_PD_RUR),        null,
                       "N1_A25", DStr(Calc_DD_CUR),        null,
                       "N1_A26", DStr(Calc_DD_RUR),        null,
                       "N1_A43", DStr(Bonus_Rest_CUR),     null,
                       "N1_A44", DStr(Bonus_Rest_RUR),     null,
                          "N1_USR1",   DStr(BegBonus_CUR),    null, // adv
                          "N1_USR2",   DStr(BegBonus_RUR),    null, // adv                     
                       "N1_A47", DStr(CorrIntToEIR),       null,
                       "N1_A27", DStr(PrepCalc_PD_CUR),    null,
                       "N1_A28", DStr(PrepCalc_PD_RUR),    null,
                       "N1_A29", DStr(PrepCalc_DD_CUR),    null,
                       "N1_A30", DStr(PrepCalc_DD_RUR),    null,
                       "N1_A41", DStr(PrepCalc_Bonus_CUR), null,
                       "N1_A42", DStr(PrepCalc_Bonus_RUR), null,
                       "N1_A48", DStr(PrepCorrIntToEIR),   null,
                       "N1_A31", DStr(Common_PD),          null,
                       "N1_A32", DStr(Common_DD),          null,
                       "N1_A49", DStr(TotalBonusRestRUR),  null,
                       "N1_A50", DStr(TotalCorr),          null,
                       "N1_A33", DStr(OverAmountCUR),      null,
                       "N1_A34", DStr(OverAmountRUR),      null,
                       "N1_A35", DStr(TSS_CUR),            null,
                       "N1_A36", DStr(TSS_RUR),            null,
                          "N1_A35_1", DStr(curTSS_CUR),         null,//GAA: пользовательские поля до hf39
                          "N1_A36_1", DStr(curTSS_RUR),         null,//GAA: пользовательские поля до hf39
                       "N1_A37", DStr(CalcBalCostCUR),     null,
                       "N1_A38", DStr(CalcBalCostRUR),     null,
                       "N1_A39", DStr(PrepOverAmountCUR),  null,
                       "N1_A40", DStr(PrepOverAmountRUR),  null,
                          "N1_A45",   DStr(NKDone),             null,   //GAA: пользовательские поля до hf39
                          "N1_A47_1",   dstr(Prim),               null, //GAA: пользовательские поля до hf39
                          "N1_A48_1",   dstr(Rez),                null, //GAA: пользовательские поля до hf39
                          "N1_USR6" ,   dstr(RezPD)  ,                      null, // ОР под процентный доход
                          "N1_USR4" ,   dstr(ORez) ,                       null, // ОР под вложения
                          "N1_USR5" ,   dstr(ORezPD)  ,                      null, // ОР под процентный доход
                          "N1_A49_1",   dstr(KK),                 null, //GAA: пользовательские поля до hf39
                          "N1_A54",   DStr(priznak_spv),        null,   //GAA: пользовательские поля до hf39
                          "N1_A55",   DStr(INN_emitent),        null,   //GAA: пользовательские поля до hf39
                          "N1_A56",   DStr(kod_okato),          null,   //GAA: пользовательские поля до hf39
                          "N1_A57",   DStr(okved_emitent),      null,   //GAA: пользовательские поля до hf39
                          "N1_A58",   DStr(kod_dlya_form_711),  null,   //GAA: пользовательские поля до hf39
                          "N1_A59",   DStr(kod_vida_instr_f120),null,   //GAA: пользовательские поля до hf39
                          "N1_USR3",  DStr(FIID),               null, /*GAA:468940 */                            
                          "N1_A60",   DStr(DateCursCC),         null,   //GAA: пользовательские поля до hf39
                          "N1_A61",   DStr(CountDCursCC),       null,   //GAA: пользовательские поля до hf39
                          "N1_A62",   DStr(RateCurCC),          null    //GAA: пользовательские поля до hf39

                     );
end;

macro PrintItogString( Rep, Account, AvoirAmountStr, BalCostCUR, BalCostRUR, BuyCostCUR, BuyCostRUR,
                    OutlayCUR, OutlayRUR, NKD_CUR, NKD_RUR, Calc_PD_CUR, Calc_PD_RUR, Calc_DD_CUR, Calc_DD_RUR,
                    PrepCalc_Bonus_CUR, PrepCalc_Bonus_RUR, Bonus_Rest_CUR, Bonus_Rest_RUR,

                    BegBonus_CUR, BegBonus_RUR, // adv//21

                    PrepCalc_PD_CUR, PrepCalc_PD_RUR, PrepCalc_DD_CUR, PrepCalc_DD_RUR, Common_PD, Common_DD, OverAmountCUR, OverAmountRUR,
                    TSS_CUR, TSS_RUR, /**/ curTSS_CUR, curTSS_RUR, /**/CalcBalCostCUR, CalcBalCostRUR, PrepOverAmountCUR, PrepOverAmountRUR, InsExpCommBuyCUR, InsExpCommBuyRUR,  //GAA: пользовательские поля до hf39
                    CorrIntToEIR, PrepCorrIntToEIR, TotalBonusRestRUR, TotalCorr
                  )

      Rep.Merge("N1_A1","N1_A13");

      Rep.PrintTableLine( "N1_A1",  DStr(Account),            null,
                          "N1_A14", DStr(AvoirAmountStr),     SetPrecisionByFractPart( AvoirAmountStr, 6, 0 ),
                          "N1_A15", DStr(BalCostCUR),         null,
                          "N1_A16", DStr(BalCostRUR),         null,
                          "N1_A17", DStr(BuyCostCUR),         null,
                          "N1_A18", DStr(BuyCostRUR),         null,
                          "N1_A19", DStr(OutlayCUR),          null,
                          "N1_A20", DStr(OutlayRUR),          null,
                          "N1_A21", DStr(NKD_CUR),            null,
                          "N1_A22", DStr(NKD_RUR),            null,
                          "N1_A23", DStr(Calc_PD_CUR),        null,
                          "N1_A24", DStr(Calc_PD_RUR),        null,
                          "N1_A25", DStr(Calc_DD_CUR),        null,
                          "N1_A26", DStr(Calc_DD_RUR),        null,
                          "N1_A43", DStr(Bonus_Rest_CUR),     null,
                          "N1_A44", DStr(Bonus_Rest_RUR),     null,
                          "N1_USR1",   DStr(BegBonus_CUR),    null, // adv//GAA: пользовательские поля до hf39
                          "N1_USR2",   DStr(BegBonus_RUR),    null, // adv//GAA: пользовательские поля до hf39
                          "N1_A47", DStr(CorrIntToEIR),       null,
                          "N1_A27", DStr(PrepCalc_PD_CUR),    null,
                          "N1_A28", DStr(PrepCalc_PD_RUR),    null,
                          "N1_A29", DStr(PrepCalc_DD_CUR),    null,
                          "N1_A30", DStr(PrepCalc_DD_RUR),    null,
                          "N1_A42", DStr(PrepCalc_Bonus_RUR), null,
                          "N1_A48", DStr(PrepCorrIntToEIR),   null,
                          "N1_A31", DStr(Common_PD),          null,
                          "N1_A32", DStr(Common_DD),          null,
                          "N1_A49", DStr(TotalBonusRestRUR),  null,
                          "N1_A50", DStr(TotalCorr),          null,
                          "N1_A33", DStr(OverAmountCUR),      null,
                          "N1_A34", DStr(OverAmountRUR),      null,
                          "N1_A35", DStr(TSS_CUR),            null,
                          "N1_A36", DStr(TSS_RUR),            null,
                          "N1_A35_1", DStr(curTSS_CUR),         null,//GAA: пользовательские поля до hf39
                          "N1_A36_1", DStr(curTSS_RUR),         null,//GAA: пользовательские поля до hf39
                          "N1_A37", DStr(CalcBalCostCUR),     null,
                          "N1_A38", DStr(CalcBalCostRUR),     null,
                          "N1_A39", DStr(PrepOverAmountCUR),  null,
                          "N1_A40", DStr(PrepOverAmountRUR),  null
                        );
end;

/* Сбор данных во временный файл. */
private macro CollectData( Data, TempFile )

  macro GetSQLParamForAlias( T ): string
    return string(
       " " + T + ".T_SUMID,     "+
       " " + T + ".T_INSTANCE,  "+
       " " + T + ".T_CHANGEDATE,        "+
       " " + T + ".T_FIID,      "+
       " " + T + ".T_PORTFOLIO, "+
       " " + T + ".T_GROUPID,   "+
       " " + T + ".T_DATE,      "+
       " " + T + ".T_AMOUNT,    "+
       " " + T + ".T_AMOUNTBD,  "+
       " " + T + ".T_SUM,       "+
       " " + T + ".T_CURRENCY,  "+
       " " + T + ".T_COST,      "+
       " " + T + ".T_BALANCECOST,       "+
       " " + T + ".T_BALANCECOSTBD,     "+
       " " + T + ".T_NKDAMOUNT, "+
       " " + T + ".T_INTERESTINCOME,    "+
       " " + T + ".T_INTERESTDATE,      "+
       " " + T + ".T_BEGDISCOUNT,       "+
       " " + T + ".T_DISCOUNTINCOME,    "+
       " " + T + ".T_DISCOUNTDATE,      "+
       " " + T + ".T_OUTLAY,    "+
       " " + T + ".T_OVERAMOUNT,        "+
       " " + T + ".T_OVERAMOUNTBD,      "+
       " " + T + ".T_OVERDATE,  "+
       " " + T + ".T_STATE,     "+
       " " + T + ".T_BONUS,     "+
       " " + T + ".T_BEGBONUS,  "+
       " " + T + ".T_BONUSDATE, "+
       " " + T + ".T_OLDBEGDATE,        "+
       " " + T + ".T_OLDBEGDISCOUNT,    "+
       " " + T + ".T_DOCKIND,   "+
       " " + T + ".T_DOCID,     "+
       " " + T + ".T_PARTNUM,   "+
       " " + T + ".T_PARTY,     "+
       " " + T + ".T_BUY_SALE,  "+
       " " + T + ".T_KIND,      "+
       " " + T + ".T_DEALID,    "+
       " " + T + ".T_ENTERDATE, "+
       " " + T + ".T_PARENT,    "+
       " " + T + ".t_BegInterestDate,   "+
       " " + T + ".t_BegDiscountDate,   "+
       " " + T + ".t_DiscountCorr,      "+
       " " + T + ".t_OldBegBonus,       "+
       " " + T + ".t_RecalcDate,        "+
       " " + T + ".T_BEGBONUSDATE,      "+
       " " + T + ".T_BEGDATE,   "+
       " " + T + ".T_INCOMERESERV,      "+
       " " + T + ".BlockKind,   "+       
       " " + T +  ".T_Department,       "+
       " " + T + ".T_OLDBONUS   ") ;
  end;    

   Data.WasExistsDepData = false;
   record acnt(account);

   macro ПолучитьУчетныйПортфель( LotBuy, Group )

      if( (DlRepFormData.SSPU) and
          ((LotBuy.Portfolio == KINDPORT_SSPU) and (LotBuy.State == PM_WRTSUM_FORM)
             and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_SSPU;

      elif( (DlRepFormData.SSSD) and
            ((LotBuy.Portfolio == KINDPORT_SSSD) and (LotBuy.State == PM_WRTSUM_FORM) 
               and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_SSSD;

      elif( (DlRepFormData.ASCB) and
            ((LotBuy.Portfolio == KINDPORT_ASCB) and (LotBuy.State == PM_WRTSUM_FORM) 
              and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_ASCB;

      elif( (DlRepFormData.PKU) and
            ((LotBuy.Portfolio == KINDPORT_CONTR) and (LotBuy.State == PM_WRTSUM_FORM) 
              and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Contr;

      elif( (DlRepFormData.PDO) and
            ((LotBuy.Portfolio == KINDPORT_PROMISSORY) and (LotBuy.State == PM_WRTSUM_FORM) 
             and (LotBuy.Amount != 0) and (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_BUY)) )
         return PortfID_Promissory;
      /*В портфель ПВО отбираются лоты, изначально купленные по сделкам обратного РЕПО БПП, не проданные впоследствии*/
      elif( (DlRepFormData.PVO) and (LotBuy.BlockKind == 2) ) 
         return PortfID_Back;
      /*Для портфеля БПП в отчет отбираются лоты, которые проданы из портфелей "ССПУ_ЦБ", "СССД_ЦБ", "АС_ЦБ", "ПКУ" и имеют признак "БПП"*/
      elif( (DlRepFormData.BPP_SSPU) and
            (LotBuy.Portfolio == KINDPORT_SSPU) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)  
          )
         return PortfID_Unadmitted_SSPU;
      elif( (DlRepFormData.BPP_SSSD) and
            (LotBuy.Portfolio == KINDPORT_SSSD) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)  
          )
         return PortfID_Unadmitted_SSSD;
      elif( (DlRepFormData.BPP_ASCB) and
            (LotBuy.Portfolio == KINDPORT_ASCB) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)
          )
         return PortfID_Unadmitted_ASCB;
      elif( (DlRepFormData.BPP_CONTR) and
            (LotBuy.Portfolio == KINDPORT_CONTR) and
             (LotBuy.State == PM_WRTSUM_SALE_BPP)
          )
         return PortfID_Unadmitted_CONTR;
      elif( (DlRepFormData.OD_) AND
               (LotBuy.Buy_Sale == PM_WRITEOFF_SUM_SALE) and ((LotBuy.AmountBD != 0)) and (IsTwoPart(Group)
                and (LotBuy.State == PM_WRTSUM_NOTFORM))
          )
         return PortfID_OD_com; /* -ОД*/
      elif( (DlRepFormData.OD) AND (LotBuy.BlockKind == 1) )
         return PortfID_OD_req;  /*ПВО_БПП*/
      elif( (DlRepFormData.Back_KSU) and (LotBuy.BlockKind == 4)) 
         return PortfID_Back_KSU;
      elif( (DlRepFormData.Back_BPP_KSU) AND (LotBuy.BlockKind == 3)) 
         return PortfID_Back_BPP_KSU;
      end;

      return PortfID_Undef;
   end;

   var Group, IsBack, LegKind,
       dl_leg  = TRecHandler( "dl_leg" ),
       dl_tick = TRecHandler( "dl_tick" ),
       account = TRecHandler( "account" ),
       pmwrtsum,
       LotState, LotAmount, PortfID, FD, IssShName, Nrec, count, IsTrue = false,
       AvKindShName, AccountNum, Amount, Select = "", Query, Point = false, selectbpp, pmwbpp;

   macro ОбработатьВыборкуЛотов( Select:string, PortfStr:string )

      var Acc = TRecHandler( "account" );//GAA hf39 перенесены пользовательские правки
      var repdataCache = RsbSQLInsert("repporst.tmp");
      var repdataArr = TArray();
      var prevPortfID = 0, prevFIID = -1, prevAccountNum = "", prevAvKindShName = "";
      var sz = 0, cnt = 0, i = 0;

      InitProgress(-1, StatLine, "Отбор лотов (" + PortfStr + ")");

      var q =   " select q.*, "
              + "        pt.t_ShortName as IssShName, "
              + "        avrk.t_ShortName as AvKindShName"
              + "   from ("+Select+") q, dfininstr_dbt fin, davrkinds_dbt avrk, dparty_dbt pt "
              + "  where fin.t_FIID = q.t_FIID "
              + "    and avrk.t_FI_Kind = fin.t_FI_Kind "
              + "    and avrk.t_AvoirKind = fin.t_AvoirKind "
              + "    and pt.t_PartyID = RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) "
              + " order by q.t_FIID, q.t_Portfolio, q.t_State";

      Query = DL_RSDCommand(q);

      Query.AddParam(DlRepFormData.RepDate+1);/*GAA hf39 скорее всего должен быть "-1"*/
      
 //     cnt = Query.getCount();//GAA:488225 Отключение "градускинка" - для уменьшения времени формирования отчета
      RemProgress();

 //     if(cnt > 0) //GAA:488225 Отключение "градускинка" - для уменьшения времени формирования отчета

        InitProgress(-1/*cnt*/, StatLine, "Перебор лотов (" + PortfStr + ")" );

        pmwrtsum = Query.execute();

        while( pmwrtsum.Next() )
        
           if( ПолучитьСделкуПоЛоту(pmwrtsum, dl_tick, true, true) )
              Group = GetOperationGroup(dl_tick.rec.DealType);

              /* Получим учетный портфель. */
              PortfID = ПолучитьУчетныйПортфель(pmwrtsum, Group);
              if( PortfID != PortfID_Undef )

                 FD = NULL;

                 if(((PortfID == KINDPORT_SSPU) or
                     (PortfID == KINDPORT_SSSD) or
                     (PortfID == KINDPORT_ASCB) or
                     (PortfID == KINDPORT_CONTR) or
                     (PortfID == KINDPORT_PROMISSORY)
                    ) and
                    (prevPortfID == PortfID) and
                    (prevFIID == pmwrtsum.FIID)
                   )
                   AccountNum     = prevAccountNum;
                   AvKindShName   = prevAvKindShName;
                 else

                   if( (PortfID == PortfID_Unadmitted_SSPU) or (PortfID == PortfID_Unadmitted_SSSD) or (PortfID == PortfID_Unadmitted_ASCB) or (PortfID == PortfID_Unadmitted_CONTR) )

                      selectbpp = DL_RSDCommand("select * from dpmwrtsum_dbt where t_SumID = ?");
                      selectbpp.addParam(pmwrtsum.Parent);
                      pmwbpp = selectbpp.execute();
          
                      if( pmwbpp.movenext() )
                         if( ПолучитьСделкуПоЛоту(pmwbpp, dl_tick, true, true) )
                            FD = repSPFirstDoc( dl_tick, false, pmwrtsum.SumID );
                         end;
                      end;
                   end;

                   if( (PortfID == PortfID_OD_req) or (PortfID == PortfID_OD_com) or (PortfID == PortfID_Back_BPP_KSU))
                      FD = repSPFirstDoc( LEG_KIND_DL_TICK, pmwrtsum.DealID, pmwrtsum.SumID );
                   end; 

                   if( FD == NULL )
                      LegKind = GetLegKindByLotDeal(pmwrtsum, dl_tick.rec);
                      IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);
                      FD = repSPFirstDoc(dl_tick, IsBack, pmwrtsum.SumID);
                   end;

               // Golovkin ID : 428819
               if((PortfID == PortfID_Back_KSU) and (pmwrtsum.portfolio == KINDPORT_BACK_BPP_KSU))

                  var Categ = "";
                  Acc.Clear;

                  if(IsDealKSU(FD.Group))
                     Categ = "Ц/б, ПВО";
                  else
                     Categ = "Полученные КСУ";
                  end;

                  if(FD.IsExistAccount( Categ, null, true, null, Acc, null, DlRepFormData.RepDate ))
                     account = Acc.rec;
                  end;
               else 
                   account = ЛСчетНаКоторомУчитываетсяЛот(pmwrtsum, DlRepFormData.RepDate, FD);
               end;
               
                   /* Получаем номер лицевого счета*/
                   AccountNum = account.Account;

               /*gko ID : 302536 */
              if (((pmwrtsum.sumid ==126309) or (pmwrtsum.sumid ==126310) or (pmwrtsum.sumid ==85055)) AND (account.Account==""))
                 AccountNum = "50110840600000000195";
              elif((pmwrtsum.sumid ==477473) and (account.Account==""))
                 AccountNum = "60102810900000000001";
              elif((pmwrtsum.sumid ==839084) and (account.Account==""))
                 AccountNum = "60102810500000001565";
              else
                AccountNum  = account.Account;
              end;

               IssShName = GetPartyShortNameByID(FI_GetIssuerOnDate(FD.fininstr, DlRepFormData.RepDate + 1));

                   /* A3а - Тип ценной бумаги - Краткое наименование вида ц/б 
                   A3б - в. Номер выпуска */
                   AvKindShName = pmwrtsum.AvKindShName + " в." + FD.avoiriss.rec.Issue;
                 end;


                 if( (PortfID == PortfID_OD_com) )
                    Amount = pmwrtsum.AmountBD;
                 else
                    Amount = pmwrtsum.Amount;
                 end;

                 /* Добавляем запись во временную базу */
                 //ВставитьЗапись();

                 sz = repdataArr.size;
                 repdataArr[sz] = TRecHandler("repporst.tmp");

                 repdataArr[sz].Clear();

                 repdataArr[sz].rec.PortfID        = PortfID;
                 repdataArr[sz].rec.IsQuoted       = 1;
                 repdataArr[sz].rec.DealID         = 0;
                 repdataArr[sz].rec.LegKind        = 0;
                 repdataArr[sz].rec.FIID           = pmwrtsum.FIID;
                 repdataArr[sz].rec.LotAmount      = Amount; //pmwrtsum.Amount;/*GAA:485158 */
                 repdataArr[sz].rec.IssShName      = pmwrtsum.IssShName;
                 repdataArr[sz].rec.AvKindShName   = AvKindShName;
                 repdataArr[sz].rec.Account        = AccountNum;
                 /*в docID сохраним SumID лота*/
                 repdataArr[sz].rec.DocID          = pmwrtsum.SumID;
                 repdataArr[sz].rec.PartNum        = pmwrtsum.PartNum;
                 repdataArr[sz].rec.Department     = pmwrtsum.Department;

                 Data.WasCollectedData = true;
                 Data.WasExistsDepData = true;

                 prevPortfID        = PortfID;
                 prevFIID           = pmwrtsum.FIID;
                 prevAccountNum     = AccountNum; 
                 prevAvKindShName   = AvKindShName;

              end;
           end;
           UseProgress(i = i + 1);
        end;

        repdataCache.AddRecordArray(repdataArr);

        repdataCache.Insert();

        RemProgress();
 //     end;//GAA:488225 Отключение "градускинка" - для уменьшения времени формирования отчета
   end;

   var Num = 0;
   InitProgress(7, StatLine, "Перебор набора портфелей");

   /*Отбираются :
      а) не проданные по состоянию на начало отчетной даты лоты обычных покупок и операций зачисления, статус которых равен "поставлен", относящиеся к данному "учетному портфелю". 
      б) по незакрытым на дату отчета сделкам РЕПО отбираются лоты статусом "поставлен" или "не по-ставлен". 
   */

   /*БПП*/
   if( DlRepFormData.BPP_SSPU or DlRepFormData.BPP_SSSD or DlRepFormData.BPP_ASCB or DlRepFormData.BPP_CONTR )
      Select = " SELECT T1.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V1.*, 0 as BlockKind FROM v_scwrthistex V1, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V1.t_SumID " +
               "            AND wrtsum.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
                               "   AND wrtsum.t_party = -1 ";

if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/

         Select = Select +     "            AND wrtsum.t_dockind  = " + string(DLDOC_PAYMENT) +
               "            AND wrtsum.t_kind     = 210 " +
               "            AND wrtsum.t_Department = " + DlRepFormData.Department +
               "            AND V1.t_state = " + string(PM_WRTSUM_SALE_BPP) +
               "            AND V1.t_portfolio in( ";
      if( DlRepFormData.BPP_SSPU )
         Select = Select + string(KINDPORT_SSPU);
         Point = true;
      end;
      if( DlRepFormData.BPP_SSSD )
         if( Point )
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_SSSD);
         Point = true;
      end;
      if( DlRepFormData.BPP_ASCB )
         if( Point )
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_ASCB);
         Point = true;
      end;
      if( DlRepFormData.BPP_CONTR )
         if( Point )
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_CONTR);
         Point = true;
      end;

      Select = Select + " )) T1 " +
                        " WHERE T1.t_instance = (SELECT MAX (V11.t_instance) " +
                        "                          FROM v_scwrthistex V11 " +
                        "                         WHERE V11.t_sumid = T1.t_sumid " +
                        "                           AND V11.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";
      Point  = false;

      ОбработатьВыборкуЛотов(Select, "БПП");
   end;
   UseProgress(Num = Num + 1);

   /*"ССПУ_ЦБ" /"СССД_ЦБ" / "АС_ЦБ" / "ПДО" / "ПКУ"*/
   if( DlRepFormData.SSPU or DlRepFormData.SSSD or DlRepFormData.ASCB or DlRepFormData.PKU or DlRepFormData.PDO )

       /*по kind = 210 отберем лоты, вернувшиеся из БПП
                   20 обычные покупки
                   40,110, 130 зачисления, зачисления при конвертации, зачисления в глоб. опции
                   90 зачисления при перемещении
       */

       Select = " SELECT T2.* " +
                "   FROM (SELECT /*+LEADING(wrtsum)*/ V2.*, 0 as BlockKind FROM v_scwrthistex V2, dpmwrtsum_dbt wrtsum " +
                "          WHERE wrtsum.t_SumID = V2.t_SumID " +
                "            AND wrtsum.t_buy_sale = " + string(PM_WRITEOFF_SUM_BUY) +
                "            AND wrtsum.t_party = -1 " +
                "            AND wrtsum.t_dockind in(" + string(DLDOC_PAYMENT) + ", " +
                                                         string(DL_ISSUE_UNION) + ", " +
                                                         string(DL_MOVINGDOC) + ") " +
                "            AND wrtsum.t_Department = " + DlRepFormData.Department +
                "            AND wrtsum.t_kind in(20,210,40,110,130,90) " +
                "            AND V2.t_Amount != 0 " ;

if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/

             Select = Select +    "            AND V2.t_state = " + string(PM_WRTSUM_FORM) +
                "            AND V2.t_Portfolio in ( ";
      if( DlRepFormData.SSPU )
         Select = Select + string(KINDPORT_SSPU);
         Point = true;
      end;
      if( DlRepFormData.SSSD )
         if(Point)
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_SSSD);
         Point = true;
      end;
      if( DlRepFormData.PKU )
         if(Point)
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_CONTR);
         Point = true;
      end;
      if( DlRepFormData.ASCB )
         if(Point)
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_ASCB);
         Point = true;
      end;
      if( DlRepFormData.PDO )
         if(Point)
            Select = Select + ",";
         end;
         Select = Select + string(KINDPORT_PROMISSORY);
      end;

      Select = Select + " )) T2 " +
                        " WHERE T2.t_instance = (SELECT MAX (V22.t_instance) " +
                        "                          FROM v_scwrthistex V22 " +
                        "                         WHERE V22.t_sumid = T2.t_sumid " +
                        "                           AND V22.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";
      Point = false;

      ОбработатьВыборкуЛотов(Select, "ССПУ_ЦБ, СССД_ЦБ, АС_ЦБ, ПДО, ПКУ");
   end;
   UseProgress(Num = Num + 1);

   /* ПВО (РЕПО/зачисления) */
   if( DlRepFormData.PVO )

      Select = " SELECT T3.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V3.*, 2 as BlockKind FROM v_scwrthistex V3, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V3.t_SumID " +
               "            AND wrtsum.t_Party = -1 " ;
if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/
        select=select +       "            AND wrtsum.t_dockind in(" + string(DLDOC_PAYMENT) + ", " + string(DL_ISSUE_UNION) + ") " +   
               "            AND wrtsum.t_Department = " + DlRepFormData.Department +
               "            AND ( (V3.t_State = " + string(PM_WRTSUM_FORM) + " and " +
               "                   wrtsum.t_DealID = (select tick.t_DealID " +
               "                                        from ddl_tick_dbt tick " +
               "                                       where tick.t_DealID = wrtsum.t_DealID " +
               "                                         and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
               "                                         and ( tick.t_DealStatus < 20 or " +
               "                                               (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(DlRepFormData.RepDate) + ") " +
               "                                             ) " +
               "                                     ) and " +
               "                   V3.t_AmountBD = 0 " +
               "                  ) " +
               "                  OR " +
               "                  wrtsum.t_kind in(40,110,130) " +
               "                )" +
               "            AND V3.t_Portfolio = " + string(KINDPORT_BACK) +
               "            AND (V3.t_Amount > 0 OR " +
               "                 Exists( select 1 " +
               "                           from v_scwrthistex V333 " +
               "                          where V333.t_State = " + string(PM_WRTSUM_NOTFORM) +
               "                            and V333.t_Portfolio = " + KINDPORT_BASICDEBT +
               "                            and V333.t_Source = V3.t_SumID "  +
               "                            and V333.t_Amount > 0 " +
               "                            and V333.t_instance =(SELECT MAX (t_instance) " +
               "                                                    FROM v_scwrthistex " +
               "                                                   WHERE t_sumid = V333.t_sumid " +
               "                                                     AND t_changedate <= "+ GetSQLDate(DlRepFormData.RepDate) + " ) " +
               "                       ) " +
               "                )" +
               "        ) T3 " +
               " WHERE T3.t_instance = (SELECT MAX (V33.t_instance) " +
               "                          FROM v_scwrthistex V33 " +
               "                         WHERE V33.t_sumid = T3.t_sumid " +
               "                           AND V33.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";

      ОбработатьВыборкуЛотов(Select, "ПВО");
   end;
   UseProgress(Num = Num + 1);

   /*ПВО_БПП*/
   if(DlRepFormData.OD)

      Select = " SELECT T4.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V4.*, 1 as BlockKind FROM v_scwrthistex V4, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V4.t_SumID " +
               "            AND wrtsum.t_Party = -1 " ;

if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/

select=select+      "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +   
               "            AND wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
               "            AND wrtsum.t_Department = " + DlRepFormData.Department +
               "            AND wrtsum.t_DealID = (select tick.t_DealID " +
               "                                     from ddl_tick_dbt tick " +
               "                                    where tick.t_DealID = wrtsum.t_DealID " +
               "                                      and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
               "                                      and ( tick.t_DealStatus < 20 or " +
               "                                            (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(DlRepFormData.RepDate) + ")" +
               "                                          ) " +
               "                                  ) " +
               "            AND V4.t_Amount > 0 " +
               "            AND V4.t_Portfolio = " + string(KINDPORT_BASICDEBT) +
               "            AND V4.t_State = " + string(PM_WRTSUM_NOTFORM) +
               "            AND Exists( SELECT buy1.t_SumID from dpmwrtsum_dbt buy1 where buy1.t_SumID = V4.t_Source and buy1.t_Portfolio = " + KINDPORT_BACK + ") " +
               "        ) T4 " +
               " WHERE T4.t_instance = (SELECT MAX (V44.t_instance) " +
               "                          FROM v_scwrthistex V44 " +
               "                         WHERE V44.t_sumid = T4.t_sumid " +
               "                           AND V44.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";

      ОбработатьВыборкуЛотов(Select, "ПВО_БПП");
   end;
   UseProgress(Num = Num + 1);

   /* - ОД */
   if( DlRepFormData.OD_ )

      Select = " SELECT T5.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V5.*, 0 as BlockKind FROM v_scwrthistex V5, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V5.t_SumID " +
               "            AND wrtsum.t_Party = -1 ";

if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/

         Select = Select + "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +   
               "            AND wrtsum.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_SALE) +
               "            AND wrtsum.t_Department = " + DlRepFormData.Department +
               "            AND wrtsum.t_DealID = (select tick.t_DealID " +
               "                                     from ddl_tick_dbt tick " +
               "                                    where tick.t_DealID = wrtsum.t_DealID " +
               "                                      and rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
               "                                      and ( tick.t_DealStatus < 20 or " +
               "                                            (tick.t_DealStatus = 20 and tick.t_CloseDate > " + GetSQLDate(DlRepFormData.RepDate) + ")" +
               "                                          ) " +
               "                                  ) " +
               "            AND V5.t_AmountBD > 0 " +
               "            AND V5.t_State = " + string(PM_WRTSUM_NOTFORM) +
               "        ) T5 " +
               " WHERE T5.t_instance = (SELECT MAX (V55.t_instance) " +
               "                          FROM v_scwrthistex V55 " +
               "                         WHERE V55.t_sumid = T5.t_sumid " +
               "                           AND V55.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";

      ОбработатьВыборкуЛотов(Select, "ОД");
   end;
   UseProgress(Num = Num + 1);

   /* ПВО КСУ */
   if( DlRepFormData.Back_KSU )
/*
      Select = " SELECT T6.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V6.*, 4 as BlockKind FROM v_scwrthistex V6, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V6.t_SumID " +
               "            AND wrtsum.t_Party = -1 " ;

if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/

         Select = Select + "            AND wrtsum.t_dockind  = " + string(DLDOC_PAYMENT) +   
               "            AND wrtsum.t_Department = " + DlRepFormData.Department + 
               "            AND V6.t_State = " + string(PM_WRTSUM_FORM) +
               "            AND V6.t_Portfolio = " + string(KINDPORT_BACK_KSU) +
               "            AND V6.t_Amount > 0 " +
               "        ) T6 " +
               " WHERE T6.t_instance = (SELECT MAX (V66.t_instance) " +
               "                          FROM v_scwrthistex V66 " +
               "                         WHERE V66.t_sumid = T6.t_sumid " +
               "                           AND V66.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";
*/
               // Golovkin ID : 428819
               Select = 
               " SELECT T6.*                                                              " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/                                      " +
               "               V6.*, 4 AS BlockKind                                       " +
               "           FROM v_scwrthistex V6, dpmwrtsum_dbt wrtsum                    " +
               "          WHERE     wrtsum.t_SumID = V6.t_SumID                           " +
               "                AND wrtsum.t_Party = -1                                   " ;

               if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) 
                   select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; 
               end;     /*adv*/               

               Select = Select + 
               "                AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +
               "                AND wrtsum.t_Department = " + DlRepFormData.Department +
               "                AND V6.t_State = " + string(PM_WRTSUM_FORM) +
               "                AND V6.t_Portfolio = " + string(KINDPORT_BACK_KSU) +
               "                AND V6.t_Amount > 0) T6                                   " +
               "  WHERE T6.t_instance =                                                   " +
               "           (SELECT MAX (V66.t_instance)                                   " +
               "              FROM v_scwrthistex V66                                      " +
               "             WHERE     V66.t_sumid = T6.t_sumid                           " +
               "                   AND V66.t_changedate <=                                " +
               "                          " + GetSQLDate(DlRepFormData.RepDate) + ")      " +
               " UNION ALL                                                                " +
               " SELECT T7.*                                                              " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/                                      " +
               "               V7.*, 4 AS BlockKind                                       " +
               "           FROM v_scwrthistex V7, dpmwrtsum_dbt wrtsum                    " +
               "          WHERE     wrtsum.t_SumID = V7.t_SumID                           " +
               "                AND wrtsum.t_Party = -1                                   " ;

               if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) 
                   select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; 
               end;     /*adv*/               
               
               Select = Select +
               "                AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) + 
               "                AND wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
               "                AND wrtsum.t_Department = " + DlRepFormData.Department +
               "                AND wrtsum.t_DealID =                                     " +
               "                       (SELECT tick.t_DealID                              " +
               "                          FROM ddl_tick_dbt tick                          " +
               "                         WHERE     tick.t_DealID = wrtsum.t_DealID        " +
               "                               AND (   tick.t_DealStatus < 20             " +
               "                                    OR (    tick.t_DealStatus = 20        " +
               "                                        AND (   tick.t_CloseDate >  " + GetSQLDate(DlRepFormData.RepDate) +
               "                                             OR rsb_secur.DealIsRepo (    " +
               "                                                   tick.t_DealID) = 0     " +
               "                                             OR rsb_secur.DealIsLoan (    " +
               "                                                   tick.t_DealID) = 0)))) " +
               "                AND v7.t_Amount > 0                                       " +
               "                AND v7.t_Portfolio = " + string(KINDPORT_BACK_BPP_KSU) +
               "                AND V7.t_State = " + string(PM_WRTSUM_NOTFORM) +
               "                AND EXISTS                                                " +
               "                       (SELECT buy1.t_SumID                               " +
               "                          FROM dpmwrtsum_dbt buy1                         " +
               "                         WHERE     buy1.t_SumID = V7.t_Source             " +
               "                               AND buy1.t_Portfolio = 12)) T7             " +
               "  WHERE T7.t_instance =                                                   " +
               "           (SELECT MAX (V77.t_instance)                                   " +
               "              FROM v_scwrthistex V77                                      " +
               "             WHERE     V77.t_sumid = T7.t_sumid                           " +
               "                   AND V77.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";

      ОбработатьВыборкуЛотов(Select, "ПВО_КСУ");
   end;
   UseProgress(Num = Num + 1);

   /*ПВО_БПП_КСУ*/
   if(DlRepFormData.Back_BPP_KSU)

      Select = " SELECT T7.* " +
               "   FROM (SELECT /*+LEADING(wrtsum)*/ V7.*, 3 as BlockKind FROM v_scwrthistex V7, dpmwrtsum_dbt wrtsum " +
               "          WHERE wrtsum.t_SumID = V7.t_SumID " +
               "            AND wrtsum.t_Party = -1 ";

if ((ПоОпределеннымБумагам) and (ОпределенныеБумаги != "")) select = select + "   and  wrtsum.t_fiid in (" + ОпределенныеБумаги + ") "; end;     /*adv*/

         Select = Select + "            AND wrtsum.t_dockind = " + string(DLDOC_PAYMENT) +   
               "            AND wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
               "            AND wrtsum.t_Department = " + DlRepFormData.Department +
               "            AND wrtsum.t_DealID = (select tick.t_DealID " +
               "                                     from ddl_tick_dbt tick " +
               "                                    where tick.t_DealID = wrtsum.t_DealID " +
               "                                      and ( tick.t_DealStatus < 20 "+
               "                                           or (    tick.t_DealStatus = 20 " +
               "                                               and (   tick.t_CloseDate > " + GetSQLDate(DlRepFormData.RepDate) + 
               "                                                    or rsb_secur.DealIsRepo(tick.t_DealID)=0 or rsb_secur.DealIsLoan(tick.t_DealID)=0"+
               "                                                   )"+
               "                                              )"+
               "                                          )"+
               "                                  ) " +
               "            AND V7.t_Amount > 0 " +
               "            AND V7.t_Portfolio = " + string(KINDPORT_BACK_BPP_KSU) +
               "            AND V7.t_State = " + string(PM_WRTSUM_NOTFORM) +
               "            AND Exists( SELECT buy1.t_SumID from dpmwrtsum_dbt buy1 where buy1.t_SumID = V7.t_Source and buy1.t_Portfolio = " + KINDPORT_BACK_KSU + ") " +
               "        ) T7 " +
               " WHERE T7.t_instance = (SELECT MAX (V77.t_instance) " +
               "                          FROM v_scwrthistex V77 " +
               "                         WHERE V77.t_sumid = T7.t_sumid " +
               "                           AND V77.t_changedate <= " + GetSQLDate(DlRepFormData.RepDate) + ") ";

      ОбработатьВыборкуЛотов(Select, "ПВО_БПП_КСУ");
   end;

   RemProgress();
end;

/*GAA hf39:Нигде в макросе не используется, поэтому не пеоеносил изменения из пользовательской версии*/
private macro ПолучитьСуммуНесуществЗатрат(tick, FIFace:integer, OnDate:Date, CommShort_val:@money, CommShort_rur:@money)
   CommShort_val = CommShort_rur = $0;

   /*Оплаченные комиссии и неоплаченные (для неоплаченных передаем дату конвертации OnDate) без НДС
     переводим в рубли*/
   if( not SP_GetSumCom( null, null, CommShort_rur, null, 
                         tick.rec.BofficeKind, tick.rec.DealID, null, null, null, 0, 1,   
                         1, 1, 0, 1, OnDate, NATCUR, true,
                         true )
     )
      return false;
   end;

   if( FIFace != NATCUR )   
      /*Оплаченные комиссии и неоплаченные (для неоплаченных передаем дату конвертации OnDate) без НДС
        переводим в валюту номинала*/
      if( not SP_GetSumCom( null, null, CommShort_val, null,
                            tick.rec.BofficeKind, tick.rec.DealID, null, null, null, 0, 1,   
                            1, 1, 0, 1, OnDate, FIFace, true,
                            true )
        )
      return false;
   end;
      end;

   return true; 
end;

macro ПолучитьСуммуРезерва(Fiid, acc)//GAA: пользовательские поля до hf39

   var cmd, RS, res = $0;
   var cmd1, RS1;
   if(substr(acc,1,1)!= "9")/*пока такая заглушка...*/
    cmd = RSDCommand( " SELECT distinct accdoc.t_Account       " +
                     "   FROM dmcaccdoc_dbt accdoc             " +
                     "  WHERE accdoc.T_FIID        = ?         " +
                     "    AND accdoc.T_CATNUM      = 241       " );

    cmd.addParam( "", RSDBP_IN, Fiid      );
    cmd.execute(); 
    RS = TRsbDataSet( cmd );

    while( RS.MoveNext() )  
     cmd1 = RSDCommand( " SELECT *                              " +
                     "   FROM DACCOUNT_DBT acc                 " +
                     "  WHERE acc.T_ACCOUNT        = ?         ");

     cmd1.addParam( "", RSDBP_IN, Rs.t_Account);
     cmd1.execute(); 
     RS1 = TRsbDataSet(cmd1);
      while( RS1.MoveNext() )  
        res= res + abs(GetRestAccount(Rs1.rec, DlRepFormData.RepDate));
      end;
    end;
   end;
   if (res == 0)
    return "";
   end;
   return res;
end;

//GAA hf39 Пока перенес данные пользовательские правки
macro ВозможностьНадежногоОпределенияСправедливойСтоимости(Fiid)
  var Avoiriss = TRecHandler( "avoiriss.dbt" );
  var Fininstr = TRecHandler( "fininstr.dbt" );
  var ВозможностьНадежногоОпределенияСправедливойСтоимости = "";
   if (ПолучитьФинИн(Fiid, Fininstr, Avoiriss) == 0)
    GetMainObjAttr( null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), 27/*ВозможностьНадежногоОпределенияСправедливойСтоимости*/, ВозможностьНадежногоОпределенияСправедливойСтоимости);
  end;
  return ВозможностьНадежногоОпределенияСправедливойСтоимости;
end;
  
macro  КатегорияКачестваЦБ(Fiid)
  var Avoiriss = TRecHandler( "avoiriss.dbt" );
  var Fininstr = TRecHandler( "fininstr.dbt" );
  var КатегорияКачества = "";

  if (ПолучитьФинИн(Fiid, Fininstr, Avoiriss) == 0)
    GetMainObjAttr( null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), 13/*КатегорияКачества*/, КатегорияКачества);
  end;
  return КатегорияКачества;
end;
/*
macro  код_ИНН_эмитента(Fiid)     ////поиск для F4   FI_GetIssuerOnDate(FD.fininstr, DlRepFormData.RepDate + 1)-id эмитента DlRepFormData.RepDate+1-дата 16-код для инн
  var Avoiriss = TRecHandler( "avoiriss.dbt" );
  var Fininstr = TRecHandler( "fininstr.dbt" );
  var код_ИНН_эмитента = "";
  код_ИНН_эмитента = GetCodeParty(FI_GetIssuerOnDate(FD.fininstr, DlRepFormData.RepDate + 1)-id эмитента, 16)
  return  код_ИНН_эмитента;
end;
*/
macro  код_711_формы(Fiid)
  var Avoiriss = TRecHandler( "avoiriss.dbt" );
  var Fininstr = TRecHandler( "fininstr.dbt" );
  var код_711_формы = "";

  if (ПолучитьФинИн(Fiid, Fininstr, Avoiriss) == 0)
    DL_GetObjAttrName(OBJTYPE_AVOIRISS, 1, DL_GetMainObjAttr( Avoiriss, 1, OBJTYPE_AVOIRISS ), null, @код_711_формы, null );
    //GetMainObjAttr( null, OBJTYPE_AVOIRISS, UniID(Avoiriss, OBJTYPE_AVOIRISS), 1/*Категория для формы 711*/, NULL, NULL, код_711_формы);
  end;
  return код_711_формы;
end;
/*GAA hf39*/

MACRO WRTChargeIncomToLotsTMP_Rep( pCalcDate   :DATE,
                                   pFIID       :INTEGER,
                                   pDepartment :INTEGER,
                                   pPort       :INTEGER
                                 )

   /*Заполняется только для облигаций, купленных в портфели ССПУ_ЦБ, СССД_ЦБ, АС_ЦБ (в том числе и проданным БПП из этих портфелей)*/
   if( (pPort != KINDPORT_SSPU) and (pPort != KINDPORT_SSSD) and (pPort != KINDPORT_ASCB) )
      return;
   end;

   VAR cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTChargeIncomToLotsTMP_Rep(?, ?, ?, ?, ?, ?, ?, ?, -1, 0, ?, ?, ?);\n end; ");

   cmd.addParam("p_CalcDate",   RSDBP_IN, pCalcDate );
   cmd.addParam("p_FIID",       RSDBP_IN, pFIID );
   cmd.addParam("p_Department", RSDBP_IN, pDepartment );

   
   cmd.addParam("p_P1", RSDBP_IN, pPort );
   cmd.addParam("p_P2", RSDBP_IN, -1 );
   cmd.addParam("p_P3", RSDBP_IN, -1 );
   cmd.addParam("p_P4", RSDBP_IN, -1 );
   cmd.addParam("p_P5", RSDBP_IN, -1 );

   cmd.addParam("p_CalcInterest", RSDBP_IN, 1 );
   cmd.addParam("p_CalcDiscount", RSDBP_IN, 1 );
   cmd.addParam("p_CalcBonus",    RSDBP_IN, 1 );

   cmd.execute();

end;

MACRO GetChargeIncomByLotsTMP( p_SumID        :INTEGER,
                               p_IncCalcKind  :INTEGER
                             )
   var Query, QueryData;

   Query = " SELECT TMP.* "+
           "   FROM DPMWRTSUM_TMP TMP "+
           "  WHERE TMP.T_SUMID = ? ";

   var cmd = DL_RsdCommand(Query);

   cmd.addParam(p_SumID );
   QueryData = cmd.execute();

   if( QueryData.MoveNext() )
      if( p_IncCalcKind == ПРОЦЕНТ )
         return money(QueryData.InterestAdd);
      elif(p_IncCalcKind == БОНУС)
         return money(QueryData.BonusAdd);
      elif(p_IncCalcKind == ДИСКОНТ)
         return money(QueryData.DiscountAdd);
      elif(p_IncCalcKind == КОРРЕКТИРОВКАЭПС)
         return money(-1*QueryData.WrtCorrIntToEIR); 
      end;
   end;

   return $0.0;
end;

/* Печать отобранных данных. */
private macro PrintData( Rep, Data, TempFile )

   /* Итоги раздела, всей таблицы. */
   class TSummary
      var
         AvAmount           = $0,
         BalCostRUR         = $0,
         BuyCostRUR         = $0,
         OutlayRUR          = $0,
         NKD_RUR            = $0,
         Calc_PD_RUR        = $0,
         Calc_DD_RUR        = $0,
         PrepCalc_Bonus_RUR = $0,
         PrepCalc_PD_RUR    = $0,
         PrepCalc_DD_RUR    = $0,
         OverAmountRUR      = $0,
         TSS_RUR            = $0, 
         curTSS_RUR         = $0, //GAA: пользовательские поля до hf39
         CalcBalCostRUR     = $0,
         PrepOverAmountRUR  = $0,
         Bonus_Rest_RUR     = $0,
         BegBonus_RUR       = $0,//GAA test 
         InsExpCommBuyRUR   = $0,
         CorrIntToEIR       = $0,
         PrepCorrIntToEIR   = $0;

      /* Добавить данные. */
      macro AddData( _AvAmount, _BalanceCost, _BuyCost, _Outlay, _NKD, _Calc_PD, _Calc_DD, _PrepCalc_Bonus, _Bonus_Rest,/**/_BegBonus_RUR, //GAA test
                     _PrepCalc_PD, _PrepCalc_DD, _OverAmount, _TSS, _curTSS,_CalcBalCost, _PrepOverAmount, _InsExpCommBuyRUR, /*Prim,*/
                     _CorrIntToEIR, _PrepCorrIntToEIR )
         inc( AvAmount,         _AvAmount      );
         inc( BalCostRUR,       _BalanceCost   );
         inc( BuyCostRUR,       _BuyCost       );
         inc( OutlayRUR,        _Outlay        );
         inc( NKD_RUR,          _NKD           );
         inc( Calc_PD_RUR,      _Calc_PD       );
         inc( Calc_DD_RUR,      _Calc_DD       );
         inc( PrepCalc_Bonus_RUR,_PrepCalc_Bonus );
         inc( Bonus_Rest_RUR,   _Bonus_Rest );
         inc( BegBonus_RUR,   _BegBonus_RUR );//GAA test
         inc( PrepCalc_PD_RUR,  _PrepCalc_PD   );
         inc( PrepCalc_DD_RUR,  _PrepCalc_DD   );
         inc( OverAmountRUR,    _OverAmount    );
         inc( TSS_RUR,          _TSS           );
         inc( curTSS_RUR,       _curTSS        );//GAA: пользовательские поля до hf39
         inc( CalcBalCostRUR,   _CalcBalCost   );
         inc( PrepOverAmountRUR,_PrepOverAmount);
         inc( InsExpCommBuyRUR, _InsExpCommBuyRUR);
         inc( CorrIntToEIR,     _CorrIntToEIR);
         inc( PrepCorrIntToEIR, _PrepCorrIntToEIR);
      end;

      /* Очистить итоги. */
      macro Clear
         AvAmount           = $0;
         BalCostRUR         = $0;
         BuyCostRUR         = $0;
         OutlayRUR          = $0;
         NKD_RUR            = $0;
         Calc_PD_RUR        = $0;
         Calc_DD_RUR        = $0;
         PrepCalc_Bonus_RUR = $0;
         PrepCalc_PD_RUR    = $0;
         PrepCalc_DD_RUR    = $0;
         OverAmountRUR      = $0;
         TSS_RUR            = $0; 
         curTSS_RUR         = $0; //GAA: пользовательские поля до hf39
         CalcBalCostRUR     = $0;
         PrepOverAmountRUR  = $0;
         Bonus_Rest_RUR     = $0;
         BegBonus_RUR       = $0; //GAA test
         InsExpCommBuyRUR   = $0;
         CorrIntToEIR       = $0;
         PrepCorrIntToEIR   = $0;
      end;
   end;

   /* Данные одной строки отчета. */
   class TLineSummary
      var
         PortfID, Account, IssShName, AvKindShName, AvrName, FIID,
         AvAmount, 
         BalCostCUR, BalCostRUR, BuyCostCUR, BuyCostRUR, OutlayCUR, OutlayRUR,
         NKD_CUR, NKD_RUR, Calc_PD_CUR, Calc_PD_RUR, Calc_DD_CUR, Calc_DD_RUR,
         PrepCalc_Bonus_CUR, PrepCalc_Bonus_RUR, PrepCalc_PD_CUR, PrepCalc_PD_RUR, PrepCalc_DD_CUR, PrepCalc_DD_RUR,
         Common_PD, Common_DD, OverAmountCUR, OverAmountRUR,
         TSS_CUR, TSS_RUR, /**/curTSS_CUR, curTSS_RUR, /**/ CalcBalCostCUR, CalcBalCostRUR, PrepOverAmountCUR, PrepOverAmountRUR,//GAA: пользовательские поля до hf39
         Bonus_Rest_CUR, Bonus_Rest_RUR, 

         BegBonus_CUR, BegBonus_RUR, //adv
InsExpCommBuyCUR, InsExpCommBuyRUR, Prim,//GAA: пользовательские поля до hf39
         CorrIntToEIR, PrepCorrIntToEIR;

      /* Очистить итоги. */
      macro Clear
         PortfID           = 0;
         AvKindShName      = "";
         AvrName           = "";
         Account           = "";
         FIID              = -1;
         AvAmount          = $0;
         BalCostCUR        = $0;
         BalCostRUR        = $0;
         BuyCostCUR        = $0; 
         BuyCostRUR        = $0;
         OutlayCUR         = $0;
         OutlayRUR         = $0;
         NKD_CUR           = $0;
         NKD_RUR           = $0;
         Calc_PD_CUR       = $0;
         Calc_PD_RUR       = $0;
         Calc_DD_CUR       = $0;
         Calc_DD_RUR       = $0;
         PrepCalc_Bonus_CUR= $0;
         PrepCalc_Bonus_RUR= $0;
         PrepCalc_PD_CUR   = $0;
         PrepCalc_PD_RUR   = $0;
         PrepCalc_DD_CUR   = $0;
         PrepCalc_DD_RUR   = $0;
         Common_PD         = $0;
         Common_DD         = $0;
         OverAmountCUR     = $0;
         OverAmountRUR     = $0;
         TSS_CUR           = $0;
         TSS_RUR           = $0;
         curTSS_CUR        = $0;//GAA: пользовательские поля до hf39
         curTSS_RUR        = $0;//GAA: пользовательские поля до hf39
         CalcBalCostCUR    = $0;
         CalcBalCostRUR    = $0;
         PrepOverAmountCUR = $0;
         PrepOverAmountRUR = $0;      
         Bonus_Rest_CUR    = $0;
         Bonus_Rest_RUR    = $0;

         BegBonus_CUR      = $0; //adv
         BegBonus_RUR      = $0; //adv

         InsExpCommBuyCUR  = $0;
         InsExpCommBuyRUR  = $0;
         Prim              = "";//GAA: пользовательские поля до hf39
         CorrIntToEIR      = $0;
         PrepCorrIntToEIR  = $0;
      end;

      /* Конструктор */
      Clear();
   end;

   /* Печать подвала раздела. */
   macro PrintFoot1( LastPortfID, PortfSumm )

      PrintItogString( Rep, "Итого по портфелю: " + Data.PortfNameArray[LastPortfID], Data.NumToStr(PortfSumm.AvAmount, 0), "", Data.NumToStr(PortfSumm.BalCostRUR, 2,false), "", 
                    Data.NumToStr(PortfSumm.BuyCostRUR, 2,false),
                    "", Data.NumToStr(PortfSumm.OutlayRUR,2, false), "", Data.NumToStr(PortfSumm.NKD_RUR,2, false), "", 
                    Data.NumToStr(PortfSumm.Calc_PD_RUR,2, false), "", Data.NumToStr(PortfSumm.Calc_DD_RUR,2, false),
                    "", Data.NumToStr(PortfSumm.PrepCalc_Bonus_RUR,2, false),
                    "", Data.NumToStr(PortfSumm.Bonus_Rest_RUR,2, false),
                    "",  Data.NumToStr(PortfSumm.BegBonus_RUR,2, false), 
                    "", Data.NumToStr(PortfSumm.PrepCalc_PD_RUR,2, false), "", Data.NumToStr(PortfSumm.PrepCalc_DD_RUR,2, false), 
                    "", "", "", Data.NumToStr(PortfSumm.OverAmountRUR,2, false),
                    "", Data.NumToStr(PortfSumm.TSS_RUR,8, false), "", Data.NumToStr(PortfSumm.curTSS_RUR,8, false),"", Data.NumToStr(PortfSumm.CalcBalCostRUR,2, false), 
                    "", Data.NumToStr(PortfSumm.PrepOverAmountRUR,2, false),
                    "", Data.NumToStr(PortfSumm.InsExpCommBuyRUR,2, false),
                    Data.NumToStr(PortfSumm.CorrIntToEIR,2, false), Data.NumToStr(PortfSumm.PrepCorrIntToEIR,2, false),
                    Data.NumToStr(PortfSumm.PrepCalc_Bonus_RUR+PortfSumm.Bonus_Rest_RUR,2, false),
                    Data.NumToStr(PortfSumm.CorrIntToEIR+PortfSumm.PrepCorrIntToEIR,2, false)
                  );
   end;

   /* Печать итоговых данных по всей таблице. */
   macro PrintFootTable( Summary )
      PrintDString( Rep, "ВСЕГО ", "", "", "", "", "", "", "", "", "",
                    "", "", "", "", "", "", "", Data.NumToStr(Summary.AvAmount, 0), "", Data.NumToStr(Summary.BalCostRUR, 2,false), "", 
                    Data.NumToStr(Summary.BuyCostRUR, 2,false),
                    "", Data.NumToStr(Summary.OutlayRUR,2, false), "", Data.NumToStr(Summary.NKD_RUR,2, false), "", 
                    Data.NumToStr(Summary.Calc_PD_RUR,2, false), "", Data.NumToStr(Summary.Calc_DD_RUR,2, false),
                    "", Data.NumToStr(Summary.PrepCalc_Bonus_RUR,2, false), 
                    "", Data.NumToStr(Summary.Bonus_Rest_RUR,2, false), 
                    "", Data.NumToStr(Summary.BegBonus_RUR,2, false),
                    "", Data.NumToStr(Summary.PrepCalc_PD_RUR,2, false), "", Data.NumToStr(Summary.PrepCalc_DD_RUR,2, false), 
                    "", "", "", Data.NumToStr(Summary.OverAmountRUR,2, false),
                    "", Data.NumToStr(Summary.TSS_RUR,8, false),"", Data.NumToStr(Summary.curTSS_RUR,8, false), "", Data.NumToStr(Summary.CalcBalCostRUR,2, false), 
                    "", Data.NumToStr(Summary.PrepOverAmountRUR,2, false),
                    "", "", Data.NumToStr(Summary.InsExpCommBuyRUR,2, false),
                    "", "", "", "", "", "", "", "", "", "", "", "", "",
                    Data.NumToStr(Summary.CorrIntToEIR,2, false), Data.NumToStr(Summary.PrepCorrIntToEIR,2, false),
                    Data.NumToStr(Summary.PrepCalc_Bonus_RUR+Summary.Bonus_Rest_RUR,2, false),
                    Data.NumToStr(Summary.CorrIntToEIR+Summary.PrepCorrIntToEIR,2, false)
                  );
   end;

   /* Функция-итератор-сумматор для временного файла.
      Возвращает данные из временного файла через класс TLineSummary.
      При необходимости суммируем данные.
      Функция возвращает true, если данные есть, false в противном случае. */
   var IteratorFirstCall   = true;
   var IteratorContinue    = true;
   var  sel, datsel;
   var PrevDep             = -1;

   macro TempFileIterator(LineSumm)

      /* Добавить данные в LineSumm */
      macro AddDataToLineSumm( IsFirstStep:bool )
         /*получить дату поставки в БПП*/
         macro GetSetBppDate(SumID)

            var Select, pmw;

            Select = RSDCommand( " SELECT T.t_changedate " +
                                 "   FROM (SELECT V.* FROM v_scwrthistex V " +
                                 "          WHERE V.t_SumID = ?) T " +
                                 "  WHERE T.t_instance = (SELECT Min (Vi.t_instance) " +
                                 "                        FROM v_scwrthistex Vi " +
                                 "                       WHERE Vi.t_sumid = T.t_sumid " +
                                 "                         AND Vi.t_action = 50) "
                               );

            Select.addParam("", RSDBP_IN, SumID);
            Select.execute();

            pmw = TRsbDataSet(Select);

            if( pmw.MoveNext() )
                return SQL_ConvTypeDate(pmw.changedate);
            end;

            return date(0,0,0);

         end;

         /* Получаем курс бумаги в рублях и валюте.
            Алгоритм работы: Курс вида "XXX" в валюте номинала за последний
            рабочий день, предшествующий отчетной дате; если за эту дату курс не
            введен, то выводится курс этого вида с наибольшей датой, не
            превышающей отчетную, если ВН - не рубли, то XXX пересчитывается в
            руб. по курсу на дату, предшествующую отчетной, если нет XXX в ВН, то
            берется XXX в рублях, если XXX ни в ВН, ни в рублях не найдена, то
            поле не заполняется.
            RateType - вид курса
            Price    - сюда запишем цену
            */
         macro GetRateInfo(   fininstr, RateType, PriceRUR:@Double, PriceCUR:@Double )
           var
              FIFrom         = fininstr.FIID,
              FITo           = fininstr.FaceValueFI,
              CnvDate        = DlRepFormData.RepDate,
              InformUser;
           var SinceDate      = date(0,0,0);
           var nDays = СС_ДНЕЙ();
           PriceRUR       = "";
           PriceCUR       = "";
           /* Если некотируемой ц/б и курса вида "TCC", то в случае,
              когда курса нет, пользователя не информируем. */
           InformUser = ((RateType !=  SP_RATETYPE_RightCost) and (RateType !=  SP_RATETYPE_TSS_reqcom));

           InitError();
           if( not ConvSumDbl( PriceCUR, 1, CnvDate, FIFrom, FITo, false, RateType, SinceDate ) )
           /* Не нашли курс. Сбрасываем ошибку после ConvSum.
              Пробуем найти курс в рублях. */
              InitError();

              FITo = NATCUR;

              if( not ConvSumDbl(PriceRUR, 1, CnvDate, FIFrom, FITo, false, RateType, SinceDate) ) 
            /* Не нашли курс. Сбрасываем ошибку после ConvSum.
               Выдаем предупрежедение пользователю. */

                 if( InformUser )
                   if ((fininstr.AvoirKind != 51 ) and (fininstr.fiid != 1465)) /*PNV КСУ*/
                    Data.UniqStr.AddString(
                         "Для ценной бумаги \"" + string(fininstr.FI_Code)
                       + "\" не удалось получить курс вида \""
                       + GetRateTypeName(RateType) + "\" на "
                       + DateToStr( CnvDate, true) );
                   end;/*PNV*/
                 end;

                 PriceRUR       = "";
                 PriceCUR       = "";
                 return false;

              else
                if((CnvDate - SinceDate) > nDays)
                  PriceRUR       = "";
                  PriceCUR       = "";
                  return false;
                end;
              end;
           else
              
              if((CnvDate - SinceDate) > nDays)
                PriceRUR       = "";
                PriceCUR       = "";
                return false;
              end;

            /* Нашли курс в валюте номинала. Переводим сумму в рубли. */
              if( (not SmartConvertSumDbl(  PriceRUR, PriceCUR, CnvDate, FITo, NATCUR )) and InformUser )
            /* Не смогли сконвертировать. */
                  Data.UniqStr.AddString(
                      GetCurrencyConvertErrorMsg(FITo, NATCUR, CnvDate) );
              end;
           end;
/*GAA: 485158*/
           if (((PriceCur==0) or (PriceCUR == "")) and (PriceRur!=0))
              ConvSumDbl( PriceCUR, PriceRur, CnvDate, NATCUR, fininstr.FaceValueFI, false, 0/*основной курс*/);
           end;
/**/
           return true;
         end;
/*GAA hf39 перенес пользовательские правки*/
/*      Получение ТСС для бумаг у которых нет НОСС для граф 39.1/70.1  */
        macro GetRateInfo115( fininstr, RateType, PriceRUR:@Double, PriceCUR:@Double, nDays115Share: Integer/*GAA: 485158 26.04.2019*/ )
           var
              FIFrom         = fininstr.FIID,
              FITo           = fininstr.FaceValueFI,
              CnvDate        = DlRepFormData.RepDate,
              Scale = 1, Point = 9, NKD, NKDrur, InformUser, NewCnvDate;

           PriceRUR       = "";
           PriceCUR       = "";
           NKD = $0; NKDrur = $0;
           var SinceDate      = date(0,0,0);/*GAA: 485158 26.04.2019*/
           NewCnvDate = CnvDate;
           /* Если некотируемой ц/б и курса вида "TCC", то в случае,
              когда курса нет, пользователя не информируем. */
           InformUser = /*IsQuoted or (*/(RateType !=  SP_RATETYPE_RightCost) and (RateType !=  SP_RATETYPE_TSS_reqcom)/*)*/;

           InitError();
           While (((PriceCur=="") or (PriceCur==0)) and ((CnvDate-NewCnvDate)<nDays115Share/*90*/))/*GAA: 485158 26.04.2019*/
              if( not ConvSumDbl( PriceCUR, 1, NewCnvDate, FIFrom, FITo, false, RateType, SinceDate /*GAA: 485158 26.04.2019*/) )
              /* Не нашли курс. Сбрасываем ошибку после ConvSum.
                 Пробуем найти курс в рублях. */
                 InitError();
            
                 FITo = NATCUR;
            
                 if( not ConvSumDbl(PriceRUR, 1, NewCnvDate, FIFrom, FITo, false, RateType, SinceDate/*GAA: 485158 26.04.2019*/) ) 
             /* Не нашли курс. Сбрасываем ошибку после ConvSum.
                   Выдаем предупрежедение пользователю. */
            
                   if( InformUser )
                     if ( (fininstr.AvoirKind != 51 ) and (fininstr.fiid != 1465) )/*PNV КСУ*/
                       Data.UniqStr.AddString(
                            "Для ценной бумаги \"" + string(fininstr.FI_Code)
                          + "\" не удалось получить курс вида \""
                          + GetRateTypeName(RateType) + "\" на "
                          + DateToStr( NewCnvDate, true) );
                     end;
                   end;
            
                   PriceRUR       = "";
                   PriceCUR       = "";
                   return false;
              
                 end;
                if((CnvDate - SinceDate) > nDays115Share)/*GAA: 485158 26.04.2019*/
                  PriceRUR       = "";
                  PriceCUR       = "";
                  return false;
                end;
              else
                if((CnvDate - SinceDate) > nDays115Share)/*GAA: 485158 26.04.2019*/
                  PriceRUR       = "";
                  PriceCUR       = "";
                  return false;
                end;              
              /* Нашли курс в валюте номинала. Переводим сумму в рубли. */
                 if( (not SmartConvertSumDbl(  PriceRUR, PriceCUR, CnvDate, FITo, NATCUR )) and InformUser )
               /* Не смогли сконвертировать. */
                     Data.UniqStr.AddString(
                        GetCurrencyConvertErrorMsg(FITo, NATCUR, CnvDate) );
                 end;
              end;
              NewCnvDate=NewCnvDate-1;
             end;
        
            if( FI_IsAvrKindBond( ToInt(fininstr.AvoirKind) ) )/*если ц\б явл. облигацией, то + НКД*/
              if (GetFiidRate(fininstr.FIID, DlRepFormData.RepDate, 1)!=DlRepFormData.RepDate)  /*если курса НКД на дату нет, то расчет по анкете*/
                 if (not IsWorkday(CnvDate))/*CHVA 487071 если день расчетов выпадает на выходной, то ищем курс НКД на одну ц/б за предыдущий рабочий день и если не найден, то только тогда расчет ведем по анкете*/
                   CnvDate = getNextWorkDate(m_Form.GetFieldValue( PNFLD_REPPOROV_DATE ),-1); /*будем брать данные на конец предшествующей даты*/
                   if (GetFiidRate(fininstr.FIID, CnvDate, 1) == CnvDate)
                      NKD = Round(GetFiidRate(fininstr.FIID, CnvDate, 2),9);
                      if ((fininstr.FaceValueFI!=NATCUR) and (SmartConvertSumDbl( NKDrur, NKD, CnvDate, fininstr.FaceValueFI, NATCUR ) ==true))
                          PriceRuR = (PriceRuR + NKDrur) ;
                          PriceCur = (PriceCuR + NKD);
                      else
                          PriceRuR = (PriceRuR + NKD);
                          PriceCur = (PriceCuR + NKD);
                      end;
                   else
                      NKD = Round(НКД(FIFrom, pow(10,9) , CnvDate,  false, false, null, null, false, false/*gko*/)/pow(10,9),9);   /*НКД в валюте номинала*/
                      if ((fininstr.FaceValueFI!=NATCUR) and (SmartConvertSumDbl( NKDrur, NKD, CnvDate, fininstr.FaceValueFI, NATCUR ) ==true))
                          PriceRuR = (PriceRuR + NKDrur) ;
                          PriceCur = (PriceCuR + NKD);
                      else
                          PriceRuR = (PriceRuR + NKD);
                          PriceCur = (PriceCuR + NKD);
                      end;
                   end;
                 else /*CHVA 487071*/
                 NKD = Round(НКД(FIFrom, pow(10,9) , CnvDate,  false, false, null, null, false, false/*gko*/)/pow(10,9),9);   /*НКД в валюте номинала*/
                   if ((fininstr.FaceValueFI!=NATCUR) and (SmartConvertSumDbl( NKDrur, NKD, CnvDate, fininstr.FaceValueFI, NATCUR ) ==true))
                    PriceRuR = (PriceRuR + NKDrur) ;
                    PriceCur = (PriceCuR + NKD);
                   else
                    PriceRuR = (PriceRuR + NKD);
                    PriceCur = (PriceCuR + NKD);
                   end;
                 end;  
              else
                 NKD = Round(GetFiidRate(fininstr.FIID, DlRepFormData.RepDate, 2),9);
                   if ((fininstr.FaceValueFI!=NATCUR) and (SmartConvertSumDbl( NKDrur, NKD, CnvDate, fininstr.FaceValueFI, NATCUR ) ==true))
                    PriceRuR = (PriceRuR + NKDrur);
                    PriceCuR =(PriceCuR + NKD);
                   else
                    PriceRuR =(PriceRuR + NKD);
                    PriceCuR =(PriceCuR + NKD);
                   end;
               end;
            end;
            
           if (((PriceCur==0) or (PriceCUR == "")) and (PriceRur!=0))
              ConvSumDbl( PriceCUR, PriceRur, CnvDate, NATCUR, fininstr.FaceValueFI, false, 0/*основной курс*/);
           end;

           return true;
         end;

         macro ПолучитьДД(BegDate,FIID,Amount,Cost,DiscountDate,Discount,BegDiscount,RecalcDate,OldBegDiscount)
            var SelPDD, DataPDD;
            if( DlRepFormData.RepDate > DiscountDate )
            SelPDD = RsdCommand("select RSB_PMWRTOFF.WRTCalcDiscountIncome(?,?,?,?,?,?,?,?,?,?,?,?,?) as DD from dual "); 

            SelPDD.addParam("",  RSDBP_IN,     DlRepFormData.RepDate );  
            SelPDD.addParam("",  RSDBP_IN,     BegDate );                
            SelPDD.addParam("",  RSDBP_IN,     0 );                      
            SelPDD.addParam("",  RSDBP_IN,     FIID );                   
            SelPDD.addParam("",  RSDBP_IN,     Amount );                 
            SelPDD.addParam("",  RSDBP_IN,     Cost );                   
            SelPDD.addParam("",  RSDBP_IN,     DiscountDate );           
            SelPDD.addParam("",  RSDBP_IN,     Discount );               
            SelPDD.addParam("",  RSDBP_IN,     BegDiscount );            
            SelPDD.addParam("",  RSDBP_IN,     OldBegDiscount );         
            SelPDD.addParam("",  RSDBP_IN,     -1);/*для нашего банка передаем именно -1*/                        
            SelPDD.addParam("",  RSDBP_IN,     0);                       
            SelPDD.addParam("",  RSDBP_IN,     RecalcDate );         



            SelPDD.execute();
          
            DataPDD = TRsbDataSet(SelPDD);
            if(DataPDD.MoveNext())
               return ToMoney(DataPDD.DD);
              end;
            end;
               return $0;
            end;

         macro ПолучитьПодлНачПД(BegDate,FIID,Amount,NKD,InterestDate,Interest)
            var SelPDD, DataPDD;
            if( DlRepFormData.RepDate > InterestDate )
            SelPDD = RsdCommand("select RSB_PMWRTOFF.WRTCalcInterestIncome(?,?,?,?,?,?,?,?,?) as PD from dual "
                               ); 

            SelPDD.addParam("",  RSDBP_IN,     DlRepFormData.RepDate );
            SelPDD.addParam("",  RSDBP_IN,     BegDate );
            SelPDD.addParam("",  RSDBP_IN,     0 );
            SelPDD.addParam("",  RSDBP_IN,     FIID );
            SelPDD.addParam("",  RSDBP_IN,     Amount );
            SelPDD.addParam("",  RSDBP_IN,     NKD );
            SelPDD.addParam("",  RSDBP_IN,     InterestDate );
            SelPDD.addParam("",  RSDBP_IN,     Interest );
            SelPDD.addParam("",  RSDBP_IN,     NULL );
            SelPDD.addParam("",  RSDBP_IN,     FALSE );
            SelPDD.addParam("",  RSDBP_IN,     1 );
            SelPDD.execute();
          
            DataPDD = TRsbDataSet(SelPDD);
            if(DataPDD.MoveNext())
               return ToMoney(DataPDD.PD);
            else
               return $0;
              end;
            end;
               return $0;
            end;

         macro ПолучитьПодлНачПремию(BegDate,FIID,Amount,Cost/*GAA: 492182 */,PrevBonusDate,PrevBonus,Bonus0,OldBonus0,RecalcDate)
            var SelPDD, DataPDD, Bonus = $0;

            if( DlRepFormData.RepDate > PrevBonusDate )
            SelPDD = RsdCommand("select RSB_PMWRTOFF.WRTCalcBonus(?,?,?,?,?,?,?,?,?,?,?,?,?) as Bonus from dual "
                               ); 

            SelPDD.addParam("",  RSDBP_IN,     DlRepFormData.RepDate ); 
            SelPDD.addParam("",  RSDBP_IN,     BegDate );               
            SelPDD.addParam("",  RSDBP_IN,     0 );         //GAA: 492182  LnkKind -  Вид связи списания -- изменения в hf52, 53
            SelPDD.addParam("",  RSDBP_IN,     FIID );
            SelPDD.addParam("",  RSDBP_IN,     Amount );  
            SelPDD.addParam("",  RSDBP_IN,     Cost );    //GAA: 492182      стоимость         -- изменения в hf52, 53               
            SelPDD.addParam("",  RSDBP_IN,     PrevBonusDate );         
            SelPDD.addParam("",  RSDBP_IN,     PrevBonus );             
            SelPDD.addParam("",  RSDBP_IN,     Bonus0 );                
            SelPDD.addParam("",  RSDBP_IN,     OldBonus0 );
            SelPDD.addParam("",  RSDBP_IN,     -1);/*для нашего банка передаем именно -1*/                        
            SelPDD.addParam("",  RSDBP_IN,     0);                       
            SelPDD.addParam("",  RSDBP_IN,     RecalcDate );
            SelPDD.execute();                                                
          
            DataPDD = TRsbDataSet(SelPDD);
            if(DataPDD.MoveNext())
               Bonus = ToMoney(DataPDD.Bonus);
            end;

            if (Bonus > $0)
               return Bonus;
            else
               return $0;
            end;
            end;
               return $0;
            end; 

/*GAA hf39*/

         record fininstr("fininstr");
         var Select = "", pmwrtsum, cmd, DataSet;
         var 
            BalCostCUR = $0, BalCostRUR = $0, BuyCostCUR = $0, BuyCostRUR = $0,
            OutlayCUR = $0, OutlayRUR = $0, NKD_CUR = $0, NKD_RUR = $0,
            Calc_PD_CUR = $0, Calc_PD_RUR = $0, Calc_DD_CUR = $0, Calc_DD_RUR = $0, 
            PrepCalc_Bonus_CUR = $0, PrepCalc_Bonus_RUR = $0, PrepCalc_PD_CUR = $0,
            PrepCalc_PD_RUR = $0, PrepCalc_DD_CUR = $0, PrepCalc_DD_RUR = $0, Common_PD = $0, Common_DD = $0,
            OverAmountCUR = $0, OverAmountRUR = $0, TSS_CUR = 0, TSS_RUR = 0,curTSS_CUR = 0, curTSS_RUR = 0,
            CalcBalCostCUR = $0, CalcBalCostRUR = $0, PrepOverAmountCUR = $0, PrepOverAmountRUR = $0, 
            Amount, SetDate,
            Bonus_Rest_CUR = $0, Bonus_Rest_RUR = $0, InsExpCommBuyCUR = $0, InsExpCommBuyRUR = $0, ErrMes = "",
            CorrIntToEIR = $0, PrepCorrIntToEIR = $0;

         var BegBonus_CUR = $0, BegBonus_RUR = $0; //adv
         var cmd3427= $0, RS3427 = $0; /*gss для определения остатка на счете премии по ц/б 3427*/

         Select = DL_RSDCommand(  " SELECT T.* " +
                                  "   FROM (select V.* FROM v_scwrthistex V "
                                  "          where V.t_SumID = ? ) T "
                                  "  WHERE T.t_instance = (SELECT MAX(Vi.t_instance) " +
                                  "                          FROM v_scwrthistex Vi " +
                                  "                         WHERE Vi.t_sumid = T.t_sumid " +
                                  "                           AND Vi.t_changedate <= ?) "
                               );

         Select.addParam(datsel.DocID);
         Select.addParam(DlRepFormData.RepDate);

         pmwrtsum = Select.execute();

         pmwrtsum.MoveNext();

         ПолучитьФинИн( pmwrtsum.FIID, fininstr );

         Amount = datsel.LotAmount;

         if( datsel.PortfID == PortfID_Back )
           //добавить суммы из лотов ПВО_БПП 
           
           cmd = DL_RSDCommand(  " SELECT nvl(sum(T.t_Amount), 0) Amount, "
                               + "        nvl(sum(T.t_NKDAmount), 0) NKDAmount, " 
                               + "        nvl(sum(T.t_Outlay), 0) Outlay, "
                               + "        nvl(sum(T.t_OverAmount), 0) OverAmount, "
                               + "        nvl(sum(T.t_BalanceCost), 0) BalanceCost, "
                               + "        nvl(sum(T.t_Cost), 0) Cost, "
                               + "        nvl(sum(T.t_BegBonus), 0) BegBonus, "
                               + "        nvl(sum(T.t_Bonus), 0) Bonus, "
                               + "        nvl(sum(T.t_OldBonus), 0) OldBonus, "
                               + "        nvl(sum(T.t_DiscountIncome), 0) DiscountIncome, "
                               + "        nvl(sum(T.t_InterestIncome), 0) InterestIncome, "
                               + "        nvl(sum(T.t_CorrIntToEIR), 0) CorrIntToEIR, "
                               + "        nvl(sum(T.t_CorrValue), 0) CorrValue "
                               + "   FROM (select V.* "
                               + "           from v_scwrthistex V "
                               + "          where V.t_State = " + string(PM_WRTSUM_NOTFORM) 
                               + "            and V.t_Portfolio = " + KINDPORT_BASICDEBT
                               + "            and V.t_Source = ? ) T "
                               + "  WHERE T.t_instance =( SELECT MAX(Vi.t_instance) " 
                               + "                          FROM v_scwrthistex Vi "
                               + "                         WHERE Vi.t_sumid = T.t_sumid "
                               + "                           AND Vi.t_changedate <= ? ) "
                              );

           cmd.AddParam(pmwrtsum.SumID);
           cmd.AddParam(DlRepFormData.RepDate);

           DataSet = cmd.Execute();
           if(DataSet.moveNext())
             Amount = pmwrtsum.Amount= pmwrtsum.Amount         +  DataSet.Amount;        
             pmwrtsum.NKDAmount      = pmwrtsum.NKDAmount      +  DataSet.NKDAmount;
             pmwrtsum.Outlay         = pmwrtsum.Outlay         +  DataSet.Outlay;
             pmwrtsum.OverAmount     = pmwrtsum.OverAmount     +  DataSet.OverAmount;    
             pmwrtsum.BalanceCost    = pmwrtsum.BalanceCost    +  DataSet.BalanceCost;   
             pmwrtsum.Cost           = pmwrtsum.Cost           +  DataSet.Cost;          
             pmwrtsum.BegBonus       = pmwrtsum.BegBonus       +  DataSet.BegBonus;      
             pmwrtsum.Bonus          = pmwrtsum.Bonus          +  DataSet.Bonus;         
             pmwrtsum.OldBonus       = pmwrtsum.OldBonus       +  DataSet.OldBonus;      
             pmwrtsum.DiscountIncome = pmwrtsum.DiscountIncome +  DataSet.DiscountIncome;
             pmwrtsum.InterestIncome = pmwrtsum.InterestIncome +  DataSet.InterestIncome;
             pmwrtsum.CorrintToEIR   = pmwrtsum.CorrintToEIR   +  DataSet.CorrintToEIR + DataSet.CorrValue;
           end;

           if(Amount <= 0)
             return;
           end;
         end;

         if( (IsFirstStep == true) or (PrevDep != pmwrtsum.Department) )/*на филиал обязательно смотрим, т.к. специального отбора или сортировки по филиалам нет*/
            /*начислим во временную таблицу ДД, ПД и премию по лотам данной ц\б*/
            WRTChargeIncomToLotsTMP_Rep(DlRepFormData.RepDate,datsel.FIID,pmwrtsum.Department,datsel.PortfID);
         end;
         PrevDep = pmwrtsum.Department;

         IF( fininstr.FaceValueFI != NATCUR )//!!1

            if( (datsel.PortfID != PortfID_OD_req) and (datsel.PortfID != PortfID_OD_com) )  /*для портфелей ПВО_БПП и -ОД колонки по НКД и Затратам пустые*/

               if( FI_IsBond(fininstr.FIID) )
                  NKD_CUR = pmwrtsum.NKDAmount;

                  if( not SmartConvertSumDbl(NKD_RUR, NKD_CUR, DlRepFormData.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate));
                  end;
               end;

               if( datsel.PortfID != PortfID_Back )
                  OutlayCUR = pmwrtsum.Outlay;

                  if( not SmartConvertSumDbl(OutlayRUR, OutlayCUR, DlRepFormData.RepDate, fininstr.FaceValueFI, NATCUR) )
                     Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate));
                  end;
               end;

               if( (datsel.PortfID == PortfID_Unadmitted_SSPU) OR (datsel.PortfID == PortfID_Unadmitted_SSSD) OR (datsel.PortfID == PortfID_Unadmitted_ASCB) OR (datsel.PortfID == PortfID_Unadmitted_CONTR) ) /*для БПП ищем дату поставки БПП*/
                  SetDate = GetSetBppDate(pmwrtsum.SumID);
               else
                  SetDate = SQL_ConvTypeDate(pmwrtsum.Date);
               end;

               /*покупная стоимость*/
              if(fininstr.FaceValueFI != NATCUR)
                      BuyCostCUR = pmwrtsum.Cost;
                  if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req)))) 
                      BuyCostCUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate); 
                  end; //adv1 банк решил для лотов с премией выводить стоимость по номиналу
              
                      /*Сначала пересчитывается в валюту номинала по курсу на дату поставки, а затем уже в рубли*/
                  if( not SmartConvertSumDbl(
                          BuyCostCUR, BuyCostCUR,
                          SetDate, fininstr.FaceValueFI/*pmwrtsum.Currency*/, fininstr.FaceValueFI ) )
                       Data.UniqStr.AddString(
                        GetCurrencyConvertErrorMsg( fininstr.FaceValueFI/*pmwrtsum.Currency*/, fininstr.FaceValueFI, SetDate) );
                  end;
                     
                  if (fininstr.fiid ==85)   /*gko заглушка по теме ID : 351390 */
                     if( not SmartConvertSumDbl( BuyCostRUR, BuyCostCUR, SQL_ConvTypeDate(pmwrtsum.Date), fininstr.FaceValueFI, NATCUR ) )
                        Data.UniqStr.AddString(
                        GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, SQL_ConvTypeDate(pmwrtsum.Date) ) );
                     end;
                  else
                    if( not SmartConvertSumDbl(
                         BuyCostRUR, BuyCostCUR,
    /*GAA:476586*/            CheckFI(fininstr.fiid,fininstr.FaceValueFI,DlRepFormData.RepDate, SQL_ConvTypeDate(pmwrtsum.Date)/**/, datsel.PortfID/*GAA: 484970*/ )/* DlRepFormData.RepDate*/,
                        fininstr.FaceValueFI, NATCUR ) )
                      Data.UniqStr.AddString(
                        GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                    end;
                  end;
              else
                   BuyCostRUR = pmwrtsum.Cost;
                  if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req)))) 
                    BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate); 
                  end; //adv1 
                  if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req))) and (fininstr.FIID == 1089)) 
                     if(pmwrtsum.DATE == date(10,02,2016))
                       BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, pmwrtsum.DEALDATE); 
                     else
                       BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, pmwrtsum.DATE); 
                     end;

                  end; //для ОФЗ 52001 - fiid 1089
              end;
            else /* +\- ОД */

              if(datsel.PortfID == PortfID_OD_req)

                  if( FI_IsBond(fininstr.FIID) )
                  NKD_CUR = pmwrtsum.NKDAmount;

                    if( not SmartConvertSumDbl(
                         NKD_RUR, NKD_CUR,
                         DlRepFormData.RepDate, fininstr.FaceValueFI, NATCUR ) )
                       Data.UniqStr.AddString(
                         GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                    end;
                  end;

                BuyCostCuR = pmwrtsum.Cost;
                if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req)))) 
                  BuyCostCUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate); 
                end; //adv1

                if( not SmartConvertSumDbl(
                       BuyCostRUR, BuyCostCuR/*pmwrtsum.BalanceCost*/,
                       DlRepFormData.RepDate, fininstr.FaceValueFI, NATCUR ) )
                    Data.UniqStr.AddString(
                            GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                end;
/*GAA hf39 перенес для информации пользовательские правки*/
/*
                BuyCostRUR = BuyCostRUR/* - pmwrtsum.OverAmount*/;
                if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req)))) 
                   BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate);
                end; //adv1 
                if((pmwrtsum.BegBonus !=0) and (datsel.PortfID != PortfID_Back) and (fininstr.FIID == 1089)) 
                     if(pmwrtsum.DATE == date(10,02,2016))
                       BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, pmwrtsum.DEALDATE); 
                     else
                       BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, pmwrtsum.DATE); 
                     end;

                end; //для ОФЗ 52001 - fiid 1089
*/
              else
                if( not SmartConvertSumDbl(
                       BuyCostRUR, pmwrtsum.BalanceCostBD,
                       DlRepFormData.RepDate, fininstr.FaceValueFI, NATCUR ) )
                    Data.UniqStr.AddString(
                            GetCurrencyConvertErrorMsg( fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                end;

                BuyCostRUR = pmwrtsum.BalanceCostBD - pmwrtsum.OverAmountBD;
              end;

            end;

            /*ПД для УП "ССПУ_ЦБ", "СССД_ЦБ", "АС_ЦБ" "БПП", "ПВО"*/
            /*ДД для УП "ССПУ_ЦБ", "СССД_ЦБ", "АС_ЦБ" "БПП"*/ 
            if( FI_IsBond(fininstr.FIID) and ((datsel.PortfID == PortfID_SSPU) or (datsel.PortfID == PortfID_SSSD) 
                or (datsel.PortfID == PortfID_ASCB) or (datsel.PortfID == PortfID_Unadmitted_SSPU) or (datsel.PortfID == PortfID_Unadmitted_SSSD)
                or (datsel.PortfID == PortfID_Back)  or (datsel.PortfID == PortfID_Unadmitted_ASCB)))

               /*начисленные ПД и ДД*/
               Calc_PD_CUR = ToMoney(pmwrtsum.InterestIncome);
               if( not SmartConvertSum( Calc_PD_RUR, Calc_PD_CUR, DlRepFormData.RepDate,
                                       fininstr.FaceValueFI, NATCUR ) )
                   Data.UniqStr.AddString(
                    GetCurrencyConvertErrorMsg(
                     fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
               end;

               if( (datsel.PortfID != PortfID_Back) )
                  Calc_DD_CUR = ToMoney(pmwrtsum.DiscountIncome);
                  if( not SmartConvertSum( Calc_DD_RUR, Calc_DD_CUR, DlRepFormData.RepDate,
                                       fininstr.FaceValueFI, NATCUR ) )
                      Data.UniqStr.AddString(
                        GetCurrencyConvertErrorMsg(
                          fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                  end;
                 /*считаем подлежащий начислению ДД*/
// 20.08.19 RAS Возврат дистрибутивных значений                 
PrepCalc_DD_CUR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, ДИСКОНТ );
//GAA hf39 перенесены пользовательские правки 
                  /*PrepCalc_DD_CUR = ПолучитьДД(SQL_ConvTypeDate(pmwrtsum.BegDate),fininstr.FIID,Amount,pmwrtsum.Cost,SQL_ConvTypeDate(pmwrtsum.DiscountDate),Calc_DD_CUR,pmwrtsum.BegDiscount,SQL_ConvTypeDate(pmwrtsum.RecalcDate),pmwrtsum.OldBegDiscount);*/
                  if( not SmartConvertSum( PrepCalc_DD_RUR, PrepCalc_DD_CUR, DlRepFormData.RepDate,
                                       fininstr.FaceValueFI, NATCUR ) )
                      Data.UniqStr.AddString(
                         GetCurrencyConvertErrorMsg(
                           fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                  end;    

               end;

//  20.08.19 RAS Возврат дистрибутивных значений              
               PrepCalc_PD_CUR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, ПРОЦЕНТ );
//GAA hf39 перенесены пользовательские правки 
               /*PrepCalc_PD_CUR = ПолучитьПодлНачПД(SQL_ConvTypeDate(pmwrtsum.BegDate),fininstr.FIID,Amount,NKD_CUR,SQL_ConvTypeDate(pmwrtsum.InterestDate),Calc_PD_CUR);*/
               if( not SmartConvertSum( PrepCalc_PD_RUR, PrepCalc_PD_CUR, DlRepFormData.RepDate,
                     fininstr.FaceValueFI, NATCUR ) )
                   Data.UniqStr.AddString(
                          GetCurrencyConvertErrorMsg(
                     fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
               end;

//20.08.19. RAS возврат дистрибутивных значений.
              PrepCalc_Bonus_CUR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, БОНУС );
//GAA hf39 перенесены пользовательские правки 
               /*if( (datsel.PortfID != PortfID_Back) ) // adv требование банка, кропе ПВО
               PrepCalc_Bonus_CUR = ПолучитьПодлНачПремию(SQL_ConvTypeDate(pmwrtsum.BegBonusDate),fininstr.FIID,Amount,pmwrtsum.Cost /*GAA: 492182 */,
                                                          SQL_ConvTypeDate(pmwrtsum.BonusDate),money(pmwrtsum.Bonus),
                                                          money(pmwrtsum.BegBonus),
                                                          money(pmwrtsum.OldBegBonus),SQL_ConvTypeDate(pmwrtsum.RecalcDate) );
               end;*/
              if (PrepCalc_PD_CUR < PrepCalc_Bonus_CUR) 
                  PrepCalc_Bonus_CUR = PrepCalc_PD_CUR;
               end;

               if( not SmartConvertSum( PrepCalc_Bonus_RUR, PrepCalc_Bonus_CUR, DlRepFormData.RepDate,
                     fininstr.FaceValueFI, NATCUR ) )
                   Data.UniqStr.AddString(
                          GetCurrencyConvertErrorMsg(
                     fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
               end;
               /*Общий процентный доход*/
               Common_PD = PrepCalc_PD_RUR + Calc_PD_RUR;
               /*Общий дисконтный доход*/
               Common_DD = PrepCalc_DD_RUR + Calc_DD_RUR;

               if( (datsel.PortfID != PortfID_Back) ) // adv требование банка, кропе ПВО//
                 Bonus_Rest_CUR = pmwrtsum.BegBonus - pmwrtsum.Bonus + pmwrtsum.OldBonus;
             
                 if( not SmartConvertSum( Bonus_Rest_RUR, Bonus_Rest_CUR, DlRepFormData.RepDate,
                     fininstr.FaceValueFI, NATCUR ) )
                   Data.UniqStr.AddString(
                          GetCurrencyConvertErrorMsg(
                     fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                 end;

                  //adv начальная премия, расчет пользовательской колонки
                 BegBonus_CUR = pmwrtsum.BegBonus;
                                 
                 if( not SmartConvertSum( BegBonus_RUR, BegBonus_CUR, DlRepFormData.RepDate,
                        fininstr.FaceValueFI, NATCUR ) )
                      Data.UniqStr.AddString(
                             GetCurrencyConvertErrorMsg(
                        fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                 end;

                 CorrIntToEIR     = ToMoney(pmwrtsum.CorrIntToEIR + pmwrtsum.CorrValue);
                 PrepCorrIntToEIR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, КОРРЕКТИРОВКАЭПС );
               end;

            end;
//GAA hf39 перенесены пользовательские правки 
            /*Затраты и НКД в -ОД не выводятся (по факту затраты в ПВО тоже 0)*/
            if( (datsel.PortfID != PortfID_OD_com) )
               BalCostCUR = pmwrtsum.BalanceCost;
            else
               BalCostCUR = pmwrtsum.BalanceCostBD;
            end;
            if (fininstr.FIID == 85) /*gko заглушка по теме ID : 351390 */
               if( not SmartConvertSum(   BalCostRUR, BalCostCUR, SQL_ConvTypeDate(pmwrtsum.date),
                                          fininstr.FaceValueFI, NATCUR ) )
                   Data.UniqStr.AddString(
                       GetCurrencyConvertErrorMsg(
                          fininstr.FaceValueFI, NATCUR, SQL_ConvTypeDate(pmwrtsum.date)) );
               end;
            else
               if( not SmartConvertSum(   BalCostRUR, BalCostCUR, DlRepFormData.RepDate,
                                       fininstr.FaceValueFI, NATCUR ) )
                  Data.UniqStr.AddString(
                    GetCurrencyConvertErrorMsg(
                       fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
               end;
            end;
//GAA hf39 

            if( (((datsel.PortfID == PortfID_SSSD) or (datsel.PortfID == PortfID_Unadmitted_SSPU) or (datsel.PortfID == PortfID_Unadmitted_SSSD) or 
                  (datsel.PortfID == PortfID_Back)) 
                ) OR
                (datsel.PortfID == PortfID_SSPU) OR 
                (datsel.PortfID == PortfID_OD_req)
              )
               OverAmountRUR = pmwrtsum.OverAmount;
            elif(((datsel.PortfID == PortfID_OD_com))  
                )
               OverAmountRUR = pmwrtsum.OverAmountBD;
            end;
/*GAA hf 39 Перенесены пользовательские правки
            if( not SmartConvertSum(OverAmountCUR, OverAmountRUR, DlRepFormData.RepDate, NATCUR, fininstr.FaceValueFI) )
               Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(NATCUR, fininstr.FaceValueFI, DlRepFormData.RepDate));
            end;
*/
/*GAA: временное решение по рублевой переоценке для выпуска fiid = 2072*/
   /*GAA:476586 Т.к. по вылютным долевым ц/б с 01.01.2019 фиксируюется валютное покрытие на дату ПП, то нельзя просто конверить OverAmountRUR в OverAmountCUR*/
           if (( fininstr.FaceValueFI != NATCUR ) and (not FI_IsBond(fininstr.FIID)))
              OverAmountCUR = BalCostCuR - BuyCostCUR;/*Балансовая стоимость в вал. - Покупная стоимость в вал.*/
           else/**/
            if ((datsel.IsQuoted == 0) and (OverAmountRUR!=0) and (SQL_ConvTypeDate(pmwrtsum.overdate)!=date(0,0,0))) /*gko ID : 353097 */
                if( not SmartConvertSum( OverAmountCUR, OverAmountRUR,
                                          SQL_ConvTypeDate(pmwrtsum.overdate)/*DlRepFormData.RepDate*/,
                                         NATCUR, fininstr.FaceValueFI ) )
                   Data.UniqStr.AddString(  GetCurrencyConvertErrorMsg(NATCUR, fininstr.FaceValueFI, SQL_ConvTypeDate(pmwrtsum.overdate)/*DlRepFormData.RepDate*/) );
                end;
            else
                if( not SmartConvertSum( OverAmountCUR, OverAmountRUR, DlRepFormData.RepDate,
                                        NATCUR, fininstr.FaceValueFI ) )
                   Data.UniqStr.AddString(
                      GetCurrencyConvertErrorMsg(
                         NATCUR, fininstr.FaceValueFI, DlRepFormData.RepDate) );
                end;
            end;
           end;/*GAA*/

 
/*GAA hf39 перенесены пользовательские правки
           /*<А15>=<A17> + <A19> + <A21> + <A23> + <A25> + <A33>*/
            BalCostCUR = BuyCostCUR + OutlayCUR + NKD_CUR + Calc_PD_CUR + Calc_DD_CUR + OverAmountCUR;

            if( (datsel.PortfID != PortfID_Contr) and (datsel.PortfID != PortfID_Unadmitted_CONTR) )
               if( not SmartConvertSum(BalCostRUR, BalCostCUR, DlRepFormData.RepDate, fininstr.FaceValueFI, NATCUR) )
                  Data.UniqStr.AddString(GetCurrencyConvertErrorMsg(fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate));
               end;
            else
               BalCostRUR = BuyCostRUR + OutlayRUR + NKD_RUR + Calc_PD_RUR + Calc_DD_RUR + OverAmountRUR;
            end;
*/
            /* - Курс вида <ТСС>  - это для всех остальных, если она есть, а <ТССОБ> - для портфеля -ОД */
            if( datsel.PortfID == PortfID_OD_com ) /* -ОД */
               GetRateInfo(fininstr, SP_RATETYPE_TSS_reqcom, @TSS_RUR, @TSS_CUR);
            else
               GetRateInfo(fininstr, SP_RATETYPE_RightCost, @TSS_RUR, @TSS_CUR);
            end;
//GAA hf39 перенесены пользовательские правки
            if (not FI_IsShare(fininstr.fiid, true))
            /* - Курс вида <ТСС>  - это для всех остальных, если она есть, а <ТССОБ> - для портфеля -ОД. Все на дату отчета для колонок 39.1/40.1 */
               if( datsel.PortfID == PortfID_OD_com ) /* -ОД */
                  GetRateInfo115( fininstr,  4 /*курс Средневзвешенная цена*/, @curTSS_RUR,
                        @curTSS_CUR, 90 /*GAA: 485158 26.04.2019 кол-во дней за которые искать котировку*/);
               else
                  GetRateInfo115( fininstr, 4 /*курс Средневзвешенная цена*/, @curTSS_RUR,
                        @curTSS_CUR, 90 /*GAA: 485158 26.04.2019 кол-во дней за которые искать котировку*/);
               end;
            elif ((TSS_RUR != 0)  or (TSS_CUR != 0))/*GAA: 485158 26.04.2019*/
              curTSS_RUR  =  TSS_RUR;
              curTSS_CUR  =  TSS_CUR;
            else
               GetRateInfo115( fininstr, 4 /*курс Средневзвешенная цена*/, @curTSS_RUR, @curTSS_CUR,  30 /*кол-во дней за которые искать котировку*/);
            end;

//GAA hf39
            if( curTSS_CUR != 0 ) //Kondrashina 487817
               /*Расчетная балансовая*/
               CalcBalCostCUR = Amount * curTSS_CUR;//Kondrashina 487817
               if( not SmartConvertSum( CalcBalCostRUR, CalcBalCostCUR, DlRepFormData.RepDate,
                                     fininstr.FaceValueFI, NATCUR ) )
                  Data.UniqStr.AddString(
                   GetCurrencyConvertErrorMsg(
                      fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
               end;
               // Не заполняется для учётных портфелей АС_ЦБ, БПП_АС_ЦБ, ПКУ, БПП_ПКУ, ПДО, ПВО_КСУ, ПВО_БПП_КСУ,
               // т.к. в перечисленных портфелях переоценка ценных бумаг не выполняется
               if( not ((datsel.PortfID == PortfID_ASCB) or
                        (datsel.PortfID == PortfID_Unadmitted_ASCB) or
                        (datsel.PortfID == PortfID_Contr) or
                        (datsel.PortfID == PortfID_Unadmitted_CONTR) or
                        (datsel.PortfID == PortfID_Promissory) or
                        (datsel.PortfID == PortfID_Back_KSU) or
                        (datsel.PortfID == PortfID_Back_BPP_KSU)))

                  /*Сумма предстоящей переоценки*/
                  PrepOverAmountCUR = CalcBalCostCUR - BalCostCUR - min(PrepCalc_Bonus_CUR, PrepCalc_PD_CUR) 
                                                     - PrepCalc_PD_CUR - PrepCalc_DD_CUR;
                  if( not SmartConvertSum( PrepOverAmountRUR, PrepOverAmountCUR, DlRepFormData.RepDate,
                                        fininstr.FaceValueFI, NATCUR ) )
                      Data.UniqStr.AddString(
                         GetCurrencyConvertErrorMsg(
                            fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                  end;
               end;
            end;
         ELSE//!!1
            if( (datsel.PortfID != PortfID_OD_req) and (datsel.PortfID != PortfID_OD_com) )  /*для портфелей +\-ОД колонки по НКД и Затратам пустые*/

              if( FI_IsBond(fininstr.FIID) )
                  NKD_RUR = pmwrtsum.NKDAmount;
              end;

              if(datsel.PortfID != PortfID_Back)
                 OutlayRUR = pmwrtsum.Outlay;
              end;

              if( (datsel.PortfID == PortfID_Unadmitted_SSPU) OR (datsel.PortfID == PortfID_Unadmitted_SSSD) OR (datsel.PortfID == PortfID_Unadmitted_ASCB) OR (datsel.PortfID == PortfID_Unadmitted_CONTR) ) /*для БПП ищем дату поставки БПП*/
                 SetDate = GetSetBppDate(pmwrtsum.SumID);
              else
                 SetDate = SQL_ConvTypeDate(pmwrtsum.Date);
              end;
              /*покупная стоимость*/
//              if( pmwrtsum.Currency != NATCUR )
//                 BuyCostRUR = pmwrtsum.Cost;
//                 if( (datsel.PortfID != PortfID_Contr) and ((datsel.PortfID != PortfID_Unadmitted_CONTR)) )
//GAA hf39 перенесены пользовательские правки
              if(fininstr.FaceValueFI != NATCUR)
                 BuyCostCuR = pmwrtsum.Cost;
                if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req))))
                   BuyCostCUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate);
                end; //adv1

                    /*пересчитывается в в рубли по курсу на дату поставки*/
                if( not SmartConvertSumDbl(BuyCostRUR, BuyCostRUR, SetDate, pmwrtsum.Currency, NATCUR) )
                       Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( pmwrtsum.Currency, NATCUR, SetDate));
                end;
             // end;
              else
                 BuyCostRUR = pmwrtsum.Cost;
//GAA hf39 перенесены пользовательские правки
                 if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req))))
                   BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate);
                 end; //adv1 
                 if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req))) and (fininstr.FIID == 1089)) 
                     if(pmwrtsum.DATE == date(10,02,2016))
                       BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, pmwrtsum.DEALDATE); 
                     else
                       BuyCostRUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, pmwrtsum.DATE); 
                     end;
                     
                 end; //для ОФЗ 52001 - fiid 1089
              end;
            else /* +\- ОД */
              if( datsel.PortfID == PortfID_OD_req )
//                BuyCostRUR = pmwrtsum.BalanceCost - pmwrtsum.OverAmount;
//GAA hf39 перенесены пользовательские правки
               if( FI_IsBond(fininstr.FIID) )
                  NKD_RUR = pmwrtsum.NKDAmount;
               end;
                  if(fininstr.FaceValueFI != NATCUR) // adv 394497 
                      BuyCostCuR =  pmwrtsum.Cost;
                      if((pmwrtsum.BegBonus !=0) and  (not ((datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_OD_req))))
                         BuyCostCUR = pmwrtsum.amount*GetFaceValue(fininstr.FIID, DlRepFormData.RepDate); 
                      end; //adv1

                      /*пересчитывается в рубли по курсу на дату поставки*/
                      if( not SmartConvertSumDbl(BuyCostRUR, BuyCostCuR, DlRepFormData.RepDate, pmwrtsum.Currency, NATCUR ) )
                                        Data.UniqStr.AddString(GetCurrencyConvertErrorMsg( pmwrtsum.Currency, NATCUR, DlRepFormData.RepDate) );
                      end;
                  else
                        BuyCostRuR =  pmwrtsum.Cost;
                  end;

              else
                BuyCostRUR = pmwrtsum.BalanceCostBD - pmwrtsum.OverAmountBD;
              end;
            end;

            /*ПД для УП "ССПУ_ЦБ", "СССД_ЦБ", "АС_ЦБ" "БПП", "ПВО"*/
            /*ДД для УП "ССПУ_ЦБ", "СССД_ЦБ", "АС_ЦБ" "БПП"*/ 
            if( FI_IsBond(fininstr.FIID) and ((datsel.PortfID == PortfID_SSPU) or (datsel.PortfID == PortfID_SSSD)
                   or (datsel.PortfID == PortfID_ASCB) or (datsel.PortfID == PortfID_Unadmitted_SSPU) or (datsel.PortfID == PortfID_Unadmitted_SSSD)
                   or (datsel.PortfID == PortfID_Back) or (datsel.PortfID == PortfID_Unadmitted_ASCB)))

               /*начисленные ПД и ДД*/
               Calc_PD_RUR = ToMoney(pmwrtsum.InterestIncome);

               if( (datsel.PortfID != PortfID_Back) )
                  Calc_DD_RUR = ToMoney(pmwrtsum.DiscountIncome);
                 /*считаем подлежащий начислению ДД*/
//20.08.19 RAS Возврат дистрибутивных значений 
               PrepCalc_DD_RUR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, ДИСКОНТ );
//GAA hf39 перенесены пользовательские правки
                  /*PrepCalc_DD_RUR = ПолучитьДД(SQL_ConvTypeDate(pmwrtsum.BegDate),fininstr.FIID,Amount,pmwrtsum.Cost,SQL_ConvTypeDate(pmwrtsum.DiscountDate),Calc_DD_RUR,pmwrtsum.BegDiscount,SQL_ConvTypeDate(pmwrtsum.RecalcDate),pmwrtsum.OldBegDiscount);*/
               end;

// 20.08.19. RAS возврат дистрибутивных значений.
              PrepCalc_PD_RUR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, ПРОЦЕНТ );
              PrepCalc_Bonus_RUR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, БОНУС );
//GAA hf39 перенесены пользовательские правки
               /*PrepCalc_PD_RUR = ПолучитьПодлНачПД(SQL_ConvTypeDate(pmwrtsum.BegDate),fininstr.FIID,Amount,NKD_RUR,SQL_ConvTypeDate(pmwrtsum.InterestDate),Calc_PD_RUR);

if( (datsel.PortfID != PortfID_Back) ) //adv требование банка, кроме ПВО
               PrepCalc_Bonus_RUR = ПолучитьПодлНачПремию(SQL_ConvTypeDate(pmwrtsum.BegBonusDate),fininstr.FIID,Amount,pmwrtsum.Cost /*GAA: 492182 */,
                                                          SQL_ConvTypeDate(pmwrtsum.BonusDate),money(pmwrtsum.Bonus),money(pmwrtsum.BegBonus),
                                                          money(pmwrtsum.OldBegBonus),SQL_ConvTypeDate(pmwrtsum.RecalcDate));
               end;*/

               if (PrepCalc_PD_RUR < PrepCalc_Bonus_RUR) 
                  PrepCalc_Bonus_RUR = PrepCalc_PD_RUR;
               end;

               PrepCalc_Bonus_CUR = 0;

               /*Общий процентный доход*/
               Common_PD = PrepCalc_PD_RUR + Calc_PD_RUR;
               /*Общий дисконтный доход*/
               Common_DD = PrepCalc_DD_RUR + Calc_DD_RUR;

               if( (datsel.PortfID != PortfID_Back) ) // adv требование банка, кропе ПВО
                  Bonus_Rest_RUR = pmwrtsum.BegBonus - pmwrtsum.Bonus + pmwrtsum.OldBonus;
                  if(fininstr.FIID == 3427)/*2019.08.12 - временная заглушка для определения остатка на счете премии по ц/б 3427. 
                       Так как счет нам известен, не будем его искать, а просто ищем остаток на конкретном счете на дату отчета
                        делаем заглушку только здесь, так как сумма для бумаги заполняется здесь */
                     Bonus_Rest_RUR = 0;

                     cmd3427 = RSDCommand( " SELECT *                              " +
                                     "   FROM DACCOUNT_DBT acc                 " +
                                     "  WHERE acc.T_ACCOUNT        = ?         ");
                    
                     cmd3427.addParam( "", RSDBP_IN, "50208810200004003427");
                     cmd3427.execute(); 
                     RS3427 = TRsbDataSet(cmd3427);
                      while( RS3427.MoveNext() )  
                        Bonus_Rest_RUR= abs(GetRestAccount(Rs3427.rec, DlRepFormData.RepDate));
                      end;
                  end;
                      /*2019.08.11 - GSS почему-то здесь не заполниляли первоначальную премию*/
                 if(fininstr.FaceValueFI != NATCUR)
                  BegBonus_CUR = pmwrtsum.BegBonus;
                                 
                  if( not SmartConvertSum( BegBonus_RUR, BegBonus_CUR, DlRepFormData.RepDate,
                        fininstr.FaceValueFI, NATCUR ) )
                      Data.UniqStr.AddString(
                             GetCurrencyConvertErrorMsg(
                         fininstr.FaceValueFI, NATCUR, DlRepFormData.RepDate) );
                  end;
                 else
                   BegBonus_RUR = pmwrtsum.BegBonus;
                 end;
                      /*2019.08.11 - GSS почему-то здесь не заполниляли первоначальную премию*/
               end;

               CorrIntToEIR     = ToMoney(pmwrtsum.CorrIntToEIR + pmwrtsum.CorrValue);
               PrepCorrIntToEIR = GetChargeIncomByLotsTMP( pmwrtsum.SumID, КОРРЕКТИРОВКАЭПС );

            end;

//GAA hf39 перенесены пользовательские правки
            /*Затраты и НКД в -ОД не выводятся (по факту затраты в ПВО тоже 0)*/
            if( (datsel.PortfID != PortfID_OD_com) )
               BalCostRUR = pmwrtsum.BalanceCost;
            else
               BalCostRUR = pmwrtsum.BalanceCostBD;
            end;

//GAA hf39
            if( (((datsel.PortfID == PortfID_SSSD) or (datsel.PortfID == PortfID_Unadmitted_SSPU) or (datsel.PortfID == PortfID_Unadmitted_SSSD) or 
                 (datsel.PortfID == PortfID_Back))) OR
                 (datsel.PortfID == PortfID_SSPU) OR
                 (datsel.PortfID == PortfID_OD_req)
              )
               OverAmountRUR = pmwrtsum.OverAmount;
            elif(((datsel.PortfID == PortfID_OD_com))  
                )
               OverAmountRUR = pmwrtsum.OverAmountBD;
            end;
//GAA hf39 перенесены пользовательские правки
//            BalCostRUR = BuyCostRUR + OutlayRUR + NKD_RUR + Calc_PD_RUR + Calc_DD_RUR + OverAmountRUR;

            /* - Курс вида <ТСС>  - это для всех остальных, если она есть, а <ТССОБ> - для портфеля -ОД */
            if( datsel.PortfID == PortfID_OD_com ) /* -ОД */
               GetRateInfo( fininstr, SP_RATETYPE_TSS_reqcom, @TSS_RUR,
                     null );
            else
               GetRateInfo( fininstr, SP_RATETYPE_RightCost, @TSS_RUR,
                     null );
            end;
//GAA hf39 перенесены пользовательские правки
            if (not FI_IsShare(fininstr.fiid, true))
              /* - Курс вида <ТСС>  - это для всех остальных, если она есть, а <ТССОБ> - для портфеля -ОД, колонка 39.1/40.1 */
              if( datsel.PortfID == PortfID_OD_com ) /* -ОД */
                 GetRateInfo115( fininstr, 4 /*курс Средневзвешенная цена*/, @curTSS_RUR,
                       null,  90 /*кол-во дней за которые искать котировку*/);/*GAA: 485158 26.04.2019*/
              else
                 GetRateInfo115( fininstr, 4 /*курс Средневзвешенная цена*/, @curTSS_RUR,
                       null,  90 /*кол-во дней за которые искать котировку*/);
              end;
            elif (TSS_RUR != 0) /*GAA: 485158 26.04.2019*/
              curTSS_RUR  =  TSS_RUR;
              curTSS_CUR  =  TSS_CUR;
            else
               GetRateInfo115( fininstr, 4 /*курс Средневзвешенная цена*/, @curTSS_RUR, null,  30 /*кол-во дней за которые искать котировку*/);
            end;
//GAA hf39

            if( TSS_RUR != 0 )
                /*Расчетная балансовая*/
               CalcBalCostRUR = Amount * TSS_RUR;
               // Не заполняется для учётных портфелей АС_ЦБ, БПП_АС_ЦБ, ПКУ, БПП_ПКУ, ПДО, ПВО_КСУ, ПВО_БПП_КСУ,
               // т.к. в перечисленных портфелях переоценка ценных бумаг не выполняется
               if( not ((datsel.PortfID == PortfID_ASCB) or
                        (datsel.PortfID == PortfID_Unadmitted_ASCB) or
                        (datsel.PortfID == PortfID_Contr) or
                        (datsel.PortfID == PortfID_Unadmitted_CONTR) or
                        (datsel.PortfID == PortfID_Promissory) or
                        (datsel.PortfID == PortfID_Back_KSU) or
                        (datsel.PortfID == PortfID_Back_BPP_KSU)))
                  /*Сумма предстоящей переоценки*/
                  PrepOverAmountRUR = CalcBalCostRUR - BalCostRUR - PrepCalc_PD_RUR - PrepCalc_DD_RUR;
               end;
            end;
         END;//!!1
//GAA hf39 перенесены пользовательские правки
         // Golovkin 07.06.2017 ID : 433683
//        if (ВозможностьНадежногоОпределенияСправедливойСтоимости(fininstr.fiid) != "") //ЧВА 461926
        if (ВозможностьНадежногоОпределенияСправедливойСтоимости(fininstr.fiid) != 1) //GAA: 468254 На категории может быть как пустое значение, так и значение "Нет"(2). 1 - "Да"
          if (ПолучитьСуммуРезерва(fininstr.FIID, LineSumm.Account) != 0) /*and 
             (ПолучитьСуммуРезерва(fininstr.FIID, LineSumm.Account) != ""))*/
            BalCostCUR = BuyCostCUR + NKD_CUR + Calc_PD_CUR + Calc_DD_CUR + OverAmountCUR + Bonus_Rest_CUR;
            BalCostRUR = BuyCostRUR + NKD_RUR + Calc_PD_RUR + Calc_DD_RUR + OverAmountRUR + Bonus_Rest_RUR;
          end;
        end;


         /* Добавляем данные в LineSumm. */
         LineSumm.PortfID        = datsel.PortfID;
         LineSumm.IssShName = GetPartyShortNameByID( /*FD.*/fininstr./*rec.*/Issuer ); /*LineSumm.IssShName      = datsel.IssShName; 406382*/
         LineSumm.AvKindShName   = datsel.AvKindShName;
         LineSumm.AvrName        = fininstr.Name;
         LineSumm.Account        = datsel.Account;
         LineSumm.FIID           = datsel.FIID;
         LineSumm.AvAmount       = LineSumm.AvAmount + Amount;

         LineSumm.BalCostCUR     = LineSumm.BalCostCUR + BalCostCUR;
         LineSumm.BalCostRUR     = LineSumm.BalCostRUR + BalCostRUR;

         LineSumm.BuyCostCUR     = LineSumm.BuyCostCUR + BuyCostCUR;
         LineSumm.BuyCostRUR     = LineSumm.BuyCostRUR + BuyCostRUR;

         LineSumm.OutlayCUR      = LineSumm.OutlayCUR + OutlayCUR;
         LineSumm.OutlayRUR      = LineSumm.OutlayRUR + OutlayRUR;

         LineSumm.NKD_CUR        = LineSumm.NKD_CUR + NKD_CUR;
         LineSumm.NKD_RUR        = LineSumm.NKD_RUR + NKD_RUR;

         LineSumm.Calc_PD_CUR    = LineSumm.Calc_PD_CUR + Calc_PD_CUR;
         LineSumm.Calc_PD_RUR    = LineSumm.Calc_PD_RUR + Calc_PD_RUR;

         LineSumm.Calc_DD_CUR    = LineSumm.Calc_DD_CUR + Calc_DD_CUR;
         LineSumm.Calc_DD_RUR    = LineSumm.Calc_DD_RUR + Calc_DD_RUR;

         LineSumm.PrepCalc_Bonus_CUR = LineSumm.PrepCalc_Bonus_CUR + PrepCalc_Bonus_CUR;
         LineSumm.PrepCalc_Bonus_RUR = LineSumm.PrepCalc_Bonus_RUR + PrepCalc_Bonus_RUR;

         LineSumm.PrepCalc_PD_CUR = LineSumm.PrepCalc_PD_CUR + PrepCalc_PD_CUR;
         LineSumm.PrepCalc_PD_RUR = LineSumm.PrepCalc_PD_RUR + PrepCalc_PD_RUR;

         LineSumm.PrepCalc_DD_CUR = LineSumm.PrepCalc_DD_CUR + PrepCalc_DD_CUR;
         LineSumm.PrepCalc_DD_RUR = LineSumm.PrepCalc_DD_RUR + PrepCalc_DD_RUR;

         LineSumm.Common_PD       = LineSumm.Common_PD + Common_PD;
         LineSumm.Common_DD       = LineSumm.Common_DD + Common_DD;

         LineSumm.OverAmountCUR   = LineSumm.OverAmountCUR + OverAmountCUR;
         LineSumm.OverAmountRUR   = LineSumm.OverAmountRUR + OverAmountRUR;

         LineSumm.TSS_CUR         = TSS_CUR;
         LineSumm.TSS_RUR         = TSS_RUR;
//GAA hf39 перенесены пользовательские правки
         LineSumm.curTSS_CUR      = curTSS_CUR;
         LineSumm.curTSS_RUR      = curTSS_RUR;
//GAA hf39
         LineSumm.CalcBalCostCUR  = LineSumm.CalcBalCostCUR + CalcBalCostCUR;
         LineSumm.CalcBalCostRUR  = LineSumm.CalcBalCostRUR + CalcBalCostRUR;

         LineSumm.PrepOverAmountCUR = LineSumm.PrepOverAmountCUR + PrepOverAmountCUR;
         LineSumm.PrepOverAmountRUR = LineSumm.PrepOverAmountRUR + PrepOverAmountRUR;

         LineSumm.Bonus_Rest_CUR = LineSumm.Bonus_Rest_CUR + Bonus_Rest_CUR;
         LineSumm.Bonus_Rest_RUR = LineSumm.Bonus_Rest_RUR + Bonus_Rest_RUR;

         LineSumm.BegBonus_CUR = LineSumm.BegBonus_CUR + BegBonus_CUR; // adv
         LineSumm.BegBonus_RUR = LineSumm.BegBonus_RUR + BegBonus_RUR; // adv

         LineSumm.InsExpCommBuyCUR = LineSumm.InsExpCommBuyCUR + InsExpCommBuyCUR;
         LineSumm.InsExpCommBuyRUR = LineSumm.InsExpCommBuyRUR + InsExpCommBuyRUR;

         LineSumm.CorrIntToEIR     = LineSumm.CorrIntToEIR + CorrIntToEIR;
         LineSumm.PrepCorrIntToEIR = LineSumm.PrepCorrIntToEIR + PrepCorrIntToEIR;

      end;

      var FirstRec, NoSubPart;

      if( IteratorFirstCall )
         /* При первом вызове итератора инициализируем временный файл.
            При повторном вызове текущая запись файла будет содержать
            необработанные данные. */
         InitProgressBar( NRecords(TempFile), StatLine, "Выпуск отчета" );
         IteratorFirstCall = false;
      end;                                   
      /* Очищаем класс хранения данных и пробуем его заполнить. */
      LineSumm.Clear;
      if( IteratorContinue )

         UseProgressBar;

         /* Есть данные во временном файле.
            Запишем в LineSumm данные из одной строки временного файла. */
         FirstRec= datsel.GetRecord();
         AddDataToLineSumm(true);

         /* Отберем все записи файла, которые должны быть представлены
            в виде одной строки отчета и просуммируем их. */
         IteratorContinue = datsel.MoveNext();
         while( IteratorContinue
                and (FirstRec.PortfID == datsel.PortfID)
                and (FirstRec.Account == datsel.Account)
                and (FirstRec.FIID    == datsel.FIID)
              ) 
             UseProgressBar;
             AddDataToLineSumm(false);
             IteratorContinue = datsel.MoveNext();
         end;
         /* Получили данные. */
         return true;
      else
         /* Не смогли получить запись. */
         RemProgressBar;
         return false;
      end;
   end;

   var
      fiwarnt     = TBFile( "fiwarnts", "R", 1 ),
      fininstr    = TRecHandler( "fininstr" ),
      avoir       = TRecHandler( "avoiriss" ),
      PrevPortfID = null,
      LineSumm    = TLineSummary(),
      PortfSumm   = TSummary(),
      TotalSumm   = TSummary(),
      CurPortf, CoupDrawDate, BondRetDate, BondFirstDate, /**/DateRevis, DateCursCC, RateCurCC, CountDCursCC, //GAA hf39 перенесены пользовательские правки
      IncomeRate, 
      AvDep = "", AvAmount, AvoirAmountStr,
      FaceValCcy, FaceValue, DaysInYear, DaysInCoupon,
 //GAA hf39 перенесены пользовательские правки
      NKDone, Prim = "", KK="", ORez = 0, ORezPD = 0,REZV = 0,RezPD = 0, КОР = 0, КР = 0,
      priznak_spv = "", INN_emitent="" , kod_okato="",  okved_emitent="", kod_dlya_form_711="",  kod_vida_instr_f120=""
      ;

   /* Строки в отчете сортируем по балансовому счету 2 порядка, и последним 7 цифрам балансового счета.*/
   sel = DL_RSDCommand(" select * from drepporst_tmp "+
                       " order by t_portfid, substr(t_account,1,5), substr(t_account,LENGTH(t_account)-6,7), " +
                       "          t_fiid, t_Department "
                       );


   datsel = sel.execute();

   IteratorContinue = datsel.MoveNext();
 
   while( TempFileIterator(LineSumm) )
      
      CurPortf = LineSumm.PortfID;

      /* Печать заголовков и подвалов
         ******************************************************************/

      /* Печатаем заголовок нового раздела и итоги предыдущего. */
      if( PrevPortfID != CurPortf )

         /* Предыдущий раздел. */
         if( PrevPortfID != null )
            PrintFoot1( PrevPortfID, PortfSumm );
         end;

         /* Новый раздел. */
         Rep.Merge("N1_A1","N1_A45");
         Rep.PrintTableLine( "N1_A1", "Портфель: " + Data.PortfNameArray[LineSumm.PortfID], null );

         PortfSumm.Clear();
         PrevPortfID = CurPortf;
      end;

      /* Печать строки
         ******************************************************************/
      fininstr.Clear();
      avoir.Clear();
      if( ПолучитьФинИн(LineSumm.FIID, fininstr, avoir) )
         InformUser("Не могу получить ценную бумагу (FIID = " + string(LineSumm.FIID) + ")", true);
      end;

      /* Дата погашения купона
         Плановая дата погашения последнего купона выпуска ц/б сделки,
         максимальная из всех дат погашения купонов данного выпуска, но не
         превышающая отчетную дату (выводится только для облигаций) */
      /* Валюта номинала
         Букв. код валюты номинала */
      FaceValCcy = GetFinInstrCcy(fininstr.rec.FaceValueFI, true);

      /* Номинал за ед.
         Номинал ц/б в валюте номинала */
      FaceValue = ЧислоCЗаданнойТочностью( DoubleToMoney( GetFaceValue(fininstr.rec.FIID, DlRepFormData.RepDate) ), 4);

//GAA hf39 перенесены пользовательские правки
   /*купон*/
       if  (GetFiidRate(fininstr.rec.FIID, DlRepFormData.RepDate, 1)!=DlRepFormData.RepDate) /*если курса в дату по бумаге нет, то по курсу 0*/
         NKDone = "-";
       else
         NKDone = round(GetFiidRate(fininstr.rec.FIID, DlRepFormData.RepDate, 2),2);
      end;
//GAA hf39

      if(( FI_IsBond(fininstr.rec.FIID) ) AND ( FI_IsCouponAvoiriss(fininstr.rec.FIID) ))
         CoupDrawDate = GetCoupon_MaxDrDateOnFrDate( fininstr.rec.FIID, DlRepFormData.RepDate );
         if( CoupDrawDate != ZeroDate )
            /*ставка дохода по купону*/
            fiwarnt.Clear();
            fiwarnt.rec.IsPartial   = UNSET_CHAR;
            fiwarnt.rec.FIID        = fininstr.rec.FIID;
            fiwarnt.rec.DrawingDate = CoupDrawDate;
            if( fiwarnt.GetLE() and 
                (fiwarnt.rec.IsPartial == UNSET_CHAR) and
                (fiwarnt.rec.FIID == fininstr.rec.FIID) and
                (fiwarnt.rec.DrawingDate == CoupDrawDate)
              ) 
               if(avoir.rec.IncomeRate != 0)
                      IncomeRate = avoir.rec.IncomeRate;
               elif(fiwarnt.rec.IncomeRate != 0)  
                  IncomeRate = fiwarnt.rec.IncomeRate;
               else
                 /*Заполняется только для купонных облигаций - ставка по купону, действующему на отчетную дату. 
                   Если для купона, действующего на отчетную дату ставка  указана в справочнике, то выводится именно она. 
                   Если ставка не указана, то вычисляется ставка по купону в % годовых по формуле: 100%*B*C/(N*T), 
                   где B- количество дней в году, C - сумма купона, N -сумма номинала, действующего на дату погашения купона, 
                   T - длительность купона. Величины T и B вычисляются в соответствии с методом, указанным в справочнике ценных бумаг, 
                   в поле "Базис расчета НКД". Длительность купона = дата погашения купона - дата начала действия купона + 1*/
                  ПолучитьПараметрыБазисаРасчетаКупона(avoir.rec.NKDBase_Kind, fiwarnt.rec, DlRepFormData.RepDate, DaysInYear, DaysInCoupon);

                  var v_FaceValueOnDate = DoubleToMoney(GetFaceValue(fininstr.rec.FIID,fiwarnt.rec.DrawingDate));

                  if( (v_FaceValueOnDate != $0) and (DaysInCoupon != 0 ) )
                     IncomeRate = 100.0 * DaysInYear * fiwarnt.rec.IncomeVolume / (v_FaceValueOnDate * DaysInCoupon);
                  else
                     IncomeRate = 0.0;
                  end;

                  IncomeRate = ЧислоCЗаданнойТочностью( DoubleToMoney( IncomeRate), 4);
               end;
            else
               IncomeRate   = "";
            end;
            CoupDrawDate = date_as_string(1, CoupDrawDate);
         else
            CoupDrawDate = "";
            IncomeRate   = "";
         end;
      else
         CoupDrawDate = "";
         IncomeRate   = "";
      end;      
      /* Дата погашения облигации
         Плановая дата погашения выпуска (выводится только для облигаций) */
      if( FI_IsBond(fininstr.rec.FIID) )
         BondRetDate = date_as_string(1,fininstr.rec.DrawingDate);
         BondFirstDate = date_as_string(1,fininstr.rec.Issued);
//GAA hf39 перенесены пользовательские правки
      // if( FI_IsAvrKindBond( ToInt(fininstr.AvoirKind) ) )/*если ц\б явл. облигацией, то заполним поле*/
         DateRevis = DateRevision(fininstr.rec.FIID,DlRepFormData.RepDate);
         DateCursCCpr(fininstr.rec.FIID, fininstr.rec.FaceValueFi, fininstr.rec.FaceValue, fininstr.rec.AvoirKind, DlRepFormData.RepDate, DateCursCC, RateCurCC);
/*DateCursCCpr(ID, FaceValueFi, FaceValue, AvoirKind, Dat, sincedate, RateCurCC)*/
         if (DateCursCC != "")
          CountDCursCC = date(GetDateAfterWorkDays(DlRepFormData.RepDate+1,-1)) - date(DateCursCC);
         else
          CountDCursCC = "";
         end;

         DateCursCC = date_as_string(1,DateCursCC);
    
      else
         BondRetDate = "";
         BondFirstDate = "";
//GAA hf39 перенесены пользовательские правки
         DateRevis = "";
//         DateCursCC = DateCursCCpr(fininstr.rec.FIID,DlRepFormData.RepDate);
         /*DateCursCC = DateCursCCpr(fininstr.rec.FIID,fininstr.rec.FaceValueFi, fininstr.rec.FaceValue, fininstr.rec.AvoirKind, DlRepFormData.RepDate);*/
         DateCursCCpr(fininstr.rec.FIID,fininstr.rec.FaceValueFi, fininstr.rec.FaceValue, fininstr.rec.AvoirKind, DlRepFormData.RepDate, DateCursCC, RateCurCC);

         if (DateCursCC != "")
          CountDCursCC = date(GetDateAfterWorkDays(DlRepFormData.RepDate+1,-1)) - date(DateCursCC);
         else
          CountDCursCC = "";
         end;

         DateCursCC = date_as_string(1,DateCursCC);

 /*        DateCursCC = date_as_string(1,DateCursCCpr(fininstr.rec.FIID,DlRepFormData.RepDate));*/

      end;
      /* % от объема эмиссии
         = <A10> * 100 / (объем выпуска из анкеты ц/б) */
      if( FI_GetQtyOnDate(fininstr, DlRepFormData.RepDate) == 0.0 )
         if ((fininstr.rec.AvoirKind != 51 ) and (fininstr.rec.fiid != 1465) )/*PNV КСУ*/
            Data.UniqStr.AddString( "Для ценной бумаги \"" + string(fininstr.rec.FI_Code) + "\" не задан объем выпуска" );
         end;/*PNV*/
      end;

      /* Если вид ц/б = депозитарная расписка, то выводится количество ц/б в одной депоз. расписке
         (определяется из анкеты данной ДР) иначе - поле не заполняется
      */
      AvDep = "";
      if( FI_IsDeposReceipt(fininstr.rec.FIID) )
//GAA hf39 перенесены пользовательские правки
//         AvDep = avoir.rec.NumBaseFI;
         AvDep = readNoteForObject( OBJTYPE_AVOIRISS,
                                    UniID(avoir, OBJTYPE_AVOIRISS),
                                    NOTEKIND_AVOIR_DEPORECAMOUNT, DlRepFormData.RepDate );

      end;
//      AvAmount       = LineSumm.AvAmount;
//      AvoirAmountStr = AvAmount;
//GAA hf39 перенесены пользовательские правки
      /*PNV*/
      AvAmount       = LineSumm.AvAmount;
      AvoirAmountStr = Data.NumToStr( AvAmount, 0 );
      if ((BondRetDate == DateRevis)  and ( FI_IsAvrKindBond( ToInt(fininstr.rec.AvoirKind))))/*если ц\б явл. облигацией, то заполним поле*/
        Prim = "Дата погашения облигации и Дата пересмотра % совпадают ";
      else
        Prim = "";
      end;
      INN_emitent = GetCodeParty(FI_GetIssuerOnDate(fininstr, DlRepFormData.RepDate + 1), 16);
      KK = КатегорияКачестваЦБ(fininstr.rec.fiid);
      kod_dlya_form_711 = код_711_формы(fininstr.rec.Fiid);
      if(((curPortf == 5) or (curPortf == 11)) or (((curPortf == 2) or (curPortf == 10)) and ((fininstr.rec.fiid == 2820) or (fininstr.rec.fiid == 2821) or (fininstr.rec.fiid == 2822) 
          or (fininstr.rec.fiid ==3353) or (fininstr.rec.fiid ==3498 ) or (fininstr.rec.fiid ==3257 ) or (fininstr.rec.fiid == 2380 )
          or (fininstr.rec.fiid == 3594 ) )))/*портфель Ц/б, оцениваемые по АС*/
       КР = double( readNoteForObject( OBJTYPE_AVOIRISS, UniID(avoir, OBJTYPE_AVOIRISS), NOTEKIND_AVOIR_RSKPERC, DlRepFormData.RepDate ) );/*коэффицент резерва на бумаге*/
       КОР = double( readNoteForObject( OBJTYPE_AVOIRISS, UniID(avoir, OBJTYPE_AVOIRISS),/* NOTEKIND_AVOIR_RSKPERC*/24, DlRepFormData.RepDate ) );/*коэффицент оценочного резерва на бумаге*/
       if(fininstr.rec.fiid == 2380) /*пока по бумаге 2380, в дальнейшем требуется доработать проверку долевая бумага или нет*/
        ORez = 0; /*((КОР-КР)* (LineSumm.BuyCostRUR+LineSumm.NKD_RUR+LineSumm.Bonus_Rest_RUR+LineSumm.OverAmountRUR)) / 100;*/ /*ОР по 2380 не формируется*/
       else
        ORez = ((КОР-КР)* (LineSumm.BuyCostRUR+LineSumm.NKD_RUR+LineSumm.Bonus_Rest_RUR)) / 100;
       end;
       ORezPD = ((КОР-КР)* (LineSumm.Calc_PD_RUR+LineSumm.Calc_DD_RUR))/100;
       RezPD = (КР * (LineSumm.Calc_PD_RUR+LineSumm.Calc_DD_RUR))/100;
       if(fininstr.rec.fiid == 2380)
        REZV  = (КР * (LineSumm.BuyCostRUR+LineSumm.NKD_RUR+LineSumm.Bonus_Rest_RUR+LineSumm.OverAmountRUR))/100;
       else
        REZV  = (КР * (LineSumm.BuyCostRUR+LineSumm.NKD_RUR+LineSumm.Bonus_Rest_RUR))/100;
       end;
      else
       ORez = 0;
       ORezPD = 0;
       RezPD = 0;
       REZV  = 0;
      end;
      PrintDString( Rep, LineSumm.Account, LineSumm.IssShName, LineSumm.AvrName, 
                    LineSumm.AvKindShName, avoir.rec.LSIN, avoir.rec.ISIN,
                    CoupDrawDate, BondFirstDate, BondRetDate,/**/ DateRevis, DateCursCC, CountDCursCC, Data.NumToStr(RateCurCC,8, true),//GAA hf39 перенесены пользовательские правки
                    FaceValCcy, AvDep, Data.NumToStr(FaceValue), Data.NumToStr(IncomeRate,4, true),
                    AvoirAmountStr, Data.NumToStr(LineSumm.BalCostCUR,2, true), Data.NumToStr(LineSumm.BalCostRUR,2, true), 
                    Data.NumToStr(LineSumm.BuyCostCUR,2, true), Data.NumToStr(LineSumm.BuyCostRUR,2, true),
                    Data.NumToStr(LineSumm.OutlayCUR,2, true), Data.NumToStr(LineSumm.OutlayRUR,2, true), 
                    Data.NumToStr(LineSumm.NKD_CUR,2, true), Data.NumToStr(LineSumm.NKD_RUR,2, true), 
                    Data.NumToStr(LineSumm.Calc_PD_CUR,2, true), Data.NumToStr(LineSumm.Calc_PD_RUR,2, true), 
                    Data.NumToStr(LineSumm.Calc_DD_CUR,2, true), Data.NumToStr(LineSumm.Calc_DD_RUR,2, true),
                    Data.NumToStr(LineSumm.PrepCalc_Bonus_CUR,2, true), Data.NumToStr(LineSumm.PrepCalc_Bonus_RUR,2, true), 
                    Data.NumToStr(LineSumm.Bonus_Rest_CUR,2, true), Data.NumToStr(LineSumm.Bonus_Rest_RUR,2, true), 

                    Data.NumToStr(LineSumm.BegBonus_CUR,2, true), Data.NumToStr(LineSumm.BegBonus_RUR,2, true), // adv

                    Data.NumToStr(LineSumm.PrepCalc_PD_CUR,2, true), Data.NumToStr(LineSumm.PrepCalc_PD_RUR,2, true), 
                    Data.NumToStr(LineSumm.PrepCalc_DD_CUR,2, true), Data.NumToStr(LineSumm.PrepCalc_DD_RUR,2, true), 
                    Data.NumToStr(LineSumm.Common_PD,2, true), Data.NumToStr(LineSumm.Common_DD,2, true), 
                    Data.NumToStr(LineSumm.OverAmountCUR,2, true), Data.NumToStr(LineSumm.OverAmountRUR,2, true),
                    Data.NumToStr(LineSumm.TSS_CUR,8, true), Data.NumToStr(LineSumm.TSS_RUR,8, true), 
                    Data.NumToStr(LineSumm.curTSS_CUR,8, true), Data.NumToStr(LineSumm.curTSS_RUR,8, true), //GAA hf39 перенесены пользовательские правки
                    Data.NumToStr(LineSumm.CalcBalCostCUR,2, true), Data.NumToStr(LineSumm.CalcBalCostRUR,2, true), 
                    Data.NumToStr(LineSumm.PrepOverAmountCUR,2, true), Data.NumToStr(LineSumm.PrepOverAmountRUR,2, true),
                    NKDone ,
                    Data.NumToStr(LineSumm.InsExpCommBuyCUR,2, true), Data.NumToStr(LineSumm.InsExpCommBuyRUR,2, true),
 //GAA hf39 перенесены пользовательские правки
                   Prim,
                    /*ПолучитьСуммуРезерва(fininstr.rec.FIID, LineSumm.Account),*/ /*заменили на расчетную сумму резерва под вложения и под ПДД*/
                    Data.NumToStr(RezV,2,true),
                    Data.NumToStr(RezPD,2,true),Data.NumToStr(ORez,2,true), Data.NumToStr(ORezPD,2,true),
                    KK, priznak_spv, INN_emitent, kod_okato,  okved_emitent, kod_dlya_form_711,  kod_vida_instr_f120,  avoir.rec.FIID/*GAA:468940*/,
                    Data.NumToStr(LineSumm.CorrIntToEIR,2, true), Data.NumToStr(LineSumm.PrepCorrIntToEIR,2, true),
                    Data.NumToStr(LineSumm.Bonus_Rest_RUR+LineSumm.PrepCalc_Bonus_RUR,2, true),
                    Data.NumToStr(LineSumm.CorrIntToEIR+LineSumm.PrepCorrIntToEIR,2, true)

                  );

      /* Собираем статистику. */
      PortfSumm.AddData( AvAmount, LineSumm.BalCostRUR, LineSumm.BuyCostRUR, LineSumm.OutlayRUR, LineSumm.NKD_RUR, LineSumm.Calc_PD_RUR,
                         LineSumm.Calc_DD_RUR, LineSumm.PrepCalc_Bonus_RUR, LineSumm.Bonus_Rest_RUR,

                         LineSumm.BegBonus_RUR, // adv

                         LineSumm.PrepCalc_PD_RUR, LineSumm.PrepCalc_DD_RUR, LineSumm.OverAmountRUR,
                         LineSumm.TSS_RUR, LineSumm.curTSS_RUR, LineSumm.CalcBalCostRUR, LineSumm.PrepOverAmountRUR, LineSumm.InsExpCommBuyRUR,
                         LineSumm.CorrIntToEIR, LineSumm.PrepCorrIntToEIR);
      TotalSumm.AddData( AvAmount, LineSumm.BalCostRUR, LineSumm.BuyCostRUR, LineSumm.OutlayRUR, LineSumm.NKD_RUR, LineSumm.Calc_PD_RUR,
                         LineSumm.Calc_DD_RUR, LineSumm.PrepCalc_Bonus_RUR, LineSumm.Bonus_Rest_RUR,

                         LineSumm.BegBonus_RUR, // adv

                         LineSumm.PrepCalc_PD_RUR, LineSumm.PrepCalc_DD_RUR, LineSumm.OverAmountRUR,
                         LineSumm.TSS_RUR,  LineSumm.curTSS_RUR, LineSumm.CalcBalCostRUR, LineSumm.PrepOverAmountRUR, LineSumm.InsExpCommBuyRUR,
                         LineSumm.CorrIntToEIR, LineSumm.PrepCorrIntToEIR);
   end;
 
   /* Печать последней строки, итого раздела и данных по всей таблице. */
   if( PrevPortfID != null )
      PrintFoot1( PrevPortfID, PortfSumm );
   end;
   PrintFootTable( TotalSumm );

   RemProgressBar;
end;

/*По конкретному филиалу*/
PRIVATE MACRO ОтчетПоФилиалу(Rep, Data)
   file TempFile( "repporst.tmp" ) write;

   ClearGlobalTmp( "drepporst_tmp" );

   CollectData( Data, TempFile );

   if( Data.WasCollectedData AND Data.WasExistsDepData )
      PrintHead( Rep );
      PrintData( Rep, Data, TempFile );
      Rep.EndTable();
      Rep.CopyAllSheetInTotalBook( NULL, false, Rep.GetTableRange(), 0 );
   end;
END;

/*По всем филиалам*/
PRIVATE MACRO ОтчетПоФилиалам(Rep, Data)
   var Department = TBFile( "dp_dep", "R" );

   Department.Clear();
   while( Department.Next() )
      DlRepFormData.Department = Department.rec.Code;
      ОтчетПоФилиалу(Rep, Data);
   end;
END;

macro ЗапуститьОтчет( Rep )

   file TempFile( "repporst.tmp" ) write;

   var Data = ReportData();

  if( (DlRepFormData.SSPU == "X") or
      (DlRepFormData.SSSD == "X") or
      (DlRepFormData.ASCB == "X") or
      (DlRepFormData.BPP_SSPU == "X") or
      (DlRepFormData.BPP_SSSD == "X") or
      (DlRepFormData.BPP_ASCB == "X") or
      (DlRepFormData.BPP_CONTR == "X") or
      (DlRepFormData.PVO == "X") or
      (DlRepFormData.OD_ == "X") or
      (DlRepFormData.OD == "X") or
      (DlRepFormData.PKU == "X") or
      (DlRepFormData.PDO == "X") or
      (DlRepFormData.Back_KSU == "X") or
      (DlRepFormData.Back_BPP_KSU == "X") 
    )

      /* Имеет смысл выпускать отчет. */
      if( DlRepFormData.Department != -1 )
        ОтчетПоФилиалу(Rep, Data);
      else
        ОтчетПоФилиалам(Rep, Data);
      end;

      if( Data.WasCollectedData )
start_time = TIME();
msgbox("Начало выполнения печати отчета  " + start_time);
cur_time = TIME();
         Rep.AddStandardFooter( "N1_" );
         Rep.CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );
msgbox("Закончили выполнять печать отчета  " + cur_time + "| Время выполнения " + (cur_time - start_time));
      else
         Rep.PrintFormatString( ReportRunFalse, "N1_ReportRunFalse", "Нет данных, удовлетворяющих параметрам отчета" );
         Rep.CopyAllSheetInTotalBook( NULL, false, "N1_ReportRunFalse", 1 );
      end;
   end;

   /* Печать протокола */
   var i:integer = 0;
   while( i < Data.UniqStr.Size )
     msgbox( Data.UniqStr.(i) );
     i = i + 1;
   end;
end;

PRIVATE CLASS (DL_CReportTemplate) SP_Portf_Report
  PRIVATE MACRO PrintMode():INTEGER
     if( Excel )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;  
  END;                                                                                                                                                                         

  PRIVATE MACRO BeginReport()
     Dl_CallInsertStat(PrintMode());
     CreateTotalBook();     
     SetActiveSheet( "Отчет" );
  END;
  
  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO Create()
var t0 = Time();
msgbox("СТАРТ ОТЧЕТА  " + t0);  
    ЗапуститьОтчет( this );
var t1 = Time();
msgbox("ОКОНЧАНИЕ ОТЧЕТА  " + t1 + "|Время выполнения " + (t1 - t0));
  END;
  
  initDL_CReportTemplate( NULL, "Report_portf.xls" );
END;

macro MakeReports()
  while(m_Form.Run())
     UpdateFormFields();
    SP_Portf_Report().Run();
  end;
end; 

MakeReports();
exit(1);
