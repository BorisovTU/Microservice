/*
$Name:        nptxpit6_new.mac
$Module:      Ценные бумаги
$Description: Форма 6-НДФЛ с 01.01.2021
*/

Import DPInter, SFInter, "DLReport_h.mac", "nptxpit6_new_form.mac", "RepPersonalIncomeTax.mac", "nptxcalcfun.mac", "TaxReportBase.mac", likepy, "scsrvrepfun.mac", "nptxslice.mac";

CONST NPTXPIT6NEW_REPORTKIND = 20142;
PRIVATE CONST POI_MODE = true;
PRIVATE CONST POI_SIZE_PACK = 100;

private var Form;
private var NPTXPayerInfoArr = TArray();

private var SheetsNamesNPTX2 = TArray();
private var SheetsNamesAttach2 = TArray();
private var ItogSym;

private class ByClientNumerator()

   private var KeyPairStore = TArray();
   private var CodeGen = DL_CodeGenerator(1);

   macro GetNexNumbByClientId(ClientId)
     var idx = DL_FindKeyPairInArr(KeyPairStore,ClientId);
     if (idx >= 0)
       return KeyPairStore[idx].Value;
     end;
     var nextCode = CodeGen.GetNextValInt();
     KeyPairStore[KeyPairStore.size] = DL_KeyPair(ClientId,nextCode);
     return nextCode;
   end;

end;

PRIVATE MACRO RemoveFromArrByIdx(arr:@TArray, idx)
   var i = idx;
   while(i < arr.Size - 1)
      arr[i] = arr[i + 1];
      i = i + 1;
   end;
   arr.Size = arr.Size - 1;
end;

private class OldIdx(_Idx, _SubIdx)
  var Idx = _Idx;
  var SubIdx = _SubIdx;
end;

private class CollapseStruct(_Idx, _Code, _Sum, _SubIdx)
  var Idx = _Idx;
  var Code = _Code;
  var SubIdx = _SubIdx;
  var Sum = _Sum;
  var IsMinus = ValType(_SubIdx) != V_UNDEF;
end;

macro MinusCodeSort(left:Variant, right:Variant, data:Variant)

end;

macro SortBySum(left:Variant, right:Variant, data:Variant)
  return IIF(left.Sum > right.Sum, -1, (IIF(left.Sum < right.Sum, 1, 0)));
end;

private class MinusMoveStruct(_PlusSum, _PlusCode, _Idx, _MinusCodes)
  var PlusSum = _PlusSum;
  var PlusCode = _PlusCode;
  var Idx = _Idx;
  var MinusCodes = TArray ();
  var i = -1;
  while ((i = i + 1) < _MinusCodes.size)
    if (_MinusCodes[i] and _MinusCodes[i].IsShow)
      MinusCodes[MinusCodes.size] = CollapseStruct(_Idx, _MinusCodes[i].MSCode, _MinusCodes[i].MSnnn, i);
    end;
  end;

  macro SortMinus()
    MinusCodes.sort(@SortBySum);
  end;

  macro GetMinus()
    var MSnnn = $0;
    var j = -1;
    while((j=j+1) < MinusCodes.Size)
      MSnnn = MSnnn + MinusCodes[j].Sum;
    end;
    return MSnnn;
  end;

  macro GetOD()
    return PlusSum - GetMinus();
  end;

  SortMinus();
end;

private class OverMinus(_Month, _Code)
  var Month = _Month;
  var MCode = _Code;
end;

macro CheckForPosCollapseStruct(struct)
  return (struct != NULL) and (struct.Sum > $0);
end;

macro MakeSortedPLusByCodeAndSum(NPTXCodeParmArr, Code)
  var i = -1;
  var retArr = TArray();
  while ((i=i+1) < NPTXCodeParmArr.Size)
    if ((NPTXCodeParmArr[i].PSCode != NULL) and (NPTXCodeParmArr[i].PSCode == Code))
      retArr[retArr.size] = CollapseStruct(i, Code, NPTXCodeParmArr[i].PSnnn);
    end;
  end;
  retArr.Sort(@SortBySum);
  return filter(retArr, @CheckForPosCollapseStruct);
end;

macro MakeSortedMinusByCodeAndSum(NPTXCodeParmArr, Code)
  var i = -1, j = -1;
  var retArr = TArray();
  while ((i=i+1) < NPTXCodeParmArr.Size)
    j = -1;
    while ((j=j+1) < NPTXCodeParmArr[i].MinusCodes.Size)
      if ((NPTXCodeParmArr[i].MinusCodes[j] != NULL) and (NPTXCodeParmArr[i].MinusCodes[j].MSCode != NULL) and (NPTXCodeParmArr[i].MinusCodes[j].MSCode == Code))
        retArr[retArr.size] = CollapseStruct(i, Code, NPTXCodeParmArr[i].MinusCodes[j].MSnnn, j);
      end;
    end;
  end;
  retArr.Sort(@SortBySum);
  return filter(retArr, @CheckForPosCollapseStruct);
end;

macro MakeSortedCodesByNobkind(NPTXCodeParmArr, NOBKind)
  var i = -1;
  var retArr = TArray();
  i = NPTXCodeParmArr.Size;
  while ((i=i-1) >= 0)
    if ((NPTXCodeParmArr[i].NOBKind != NULL) and (NPTXCodeParmArr[i].NOBKind == NOBKind))
      retArr[retArr.size] = CollapseStruct(i, NPTXCodeParmArr[i].PSCode, 0);
    end;
  end;
  return retArr;
end;

macro MakeCopyNPTXCodeParmArr(NPTXCodeParmArr)
  var copyArr = TArray();
  //делаем полную копию NPTXCodeParmArr по значениям
  var i = -1;
  var j = -1;
  while ((i=i+1) < NPTXCodeParmArr.Size)
    copyArr[i] = NPTXPlusCodeParm(
       NPTXCodeParmArr[i].Month,
       NPTXCodeParmArr[i].PSCode,
       NPTXCodeParmArr[i].PSnnn,
       NPTXCodeParmArr[i].ЧНБ,
       NPTXCodeParmArr[i].NOBKind,
       NULL,
       NPTXCodeParmArr[i].IsShow);
    if (NPTXCodeParmArr[i].MinusCodes != NULL)
      j = -1;
      while ((j=j+1) < NPTXCodeParmArr[i].MinusCodes.size)
        copyArr[i].MinusCodes[j] = 
        NPTXMinusCodeParm(
           NPTXCodeParmArr[i].MinusCodes[j].MSCode,
           NPTXCodeParmArr[i].MinusCodes[j].MSnnn,
           NPTXCodeParmArr[i].MinusCodes[j].IsShow);
      end;
    end;
  end;
  return copyArr;
end;

macro GetCurrNameNPTX2(Name1:string, Name2:string, Name3:string)
   var Name = substr(Name1, 1, 20) + substr(Name2, 1, 1) + substr(Name3, 1, 1);
   var NameSheet = "";
   var CntEqualNamesNPTX2 = 0;

   NameSheet = Name;
   var i = 0;
   while(i < SheetsNamesNPTX2.Size)
      if(StrUpr(NameSheet) == StrUpr(SheetsNamesNPTX2[i]))
         CntEqualNamesNPTX2 = CntEqualNamesNPTX2 + 1;
         NameSheet = substr(Name, 1, 31 - StrLen(" " + string(CntEqualNamesNPTX2))) + " " + string(CntEqualNamesNPTX2);
         i = 0;
      else
         i = i + 1;
      end;
   end;

   SheetsNamesNPTX2[SheetsNamesNPTX2.Size] = NameSheet;

   return NameSheet;
end;

macro GetCurrNameAttach2(Name1:string, Name2:string, Name3:string)
   var Name = substr(Name1, 1, 20) + substr(Name2, 1, 1) + substr(Name3, 1, 1);
   var NameSheet = "";
   var CntEqualNamesAttach2 = 0;

   NameSheet = Name + " Приложение";
   var i = 0;
   while(i < SheetsNamesAttach2.Size)
      if(StrUpr(NameSheet) == StrUpr(SheetsNamesAttach2[i]))
         CntEqualNamesAttach2 = CntEqualNamesAttach2 + 1;
         NameSheet = substr(Name, 1, 31 - StrLen(" Приложение " + string(CntEqualNamesAttach2))) + " Приложение " + string(CntEqualNamesAttach2);
         i = 0;
      else
         i = i + 1;
      end;
   end;

   SheetsNamesAttach2[SheetsNamesAttach2.Size] = NameSheet;

   return NameSheet;
end;

CLASS (NPTXRepCalc2_NPTXPIT6) NPTXRepCalc_NPTXPIT6_NEW(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS)
   private var m_SetHighRate = NULL;
   private var m_SetRetHighRate = NULL;
   private var m_QueryHighRate = NULL;
   private var m_QueryRetHighRate = NULL;
   private var m_CmdHighRate = NULL;
   private var m_CmdRetHighRate = NULL;

   private var m_BeginDate021 = Date(0, 0, 0);
   private var m_EndDate021 = Date(0, 0, 0);
   private var m_BeginDate022 = Date(0, 0, 0);
   private var m_EndDate022 = Date(0, 0, 0);
   private var m_BeginDate023 = Date(0, 0, 0);
   private var m_EndDate023 = Date(0, 0, 0);
   private var m_BeginDate024 = Date(0, 0, 0);
   private var m_EndDate024 = Date(0, 0, 0);

   var m_Sum021 = 0;
   var m_Sum022 = 0;
   var m_Sum023 = 0;
   var m_Sum024 = 0;
   var m_Sum021_HighRate = 0;
   var m_Sum022_HighRate = 0;
   var m_Sum023_HighRate = 0;
   var m_Sum024_HighRate = 0;

   var m_StatPart1 = false;

   macro GetTaxReturnSums(TaxToReturnDue:@Money, IsHighRate:BOOL)
      var query = "select nvl(sum(t_TaxToReturnDue), 0) as t_TaxToReturnDue " +
                  "from dnptx6calc2_tmp " +
                  "where 1=1 ";//t_DateTaxReturn between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate);
                  //аналогично как в предыдущем

      if(IsHighRate != NULL)
         if(IsHighRate)
            query = query + " and t_IsHighRate = chr(88)";
         else
            query = query + " and t_IsHighRate <> chr(88)";
         end;
      end;
      var cmd = DL_RSDCommand(query);
      var ds = cmd.Execute();

      if(ds.MoveNext())
         TaxToReturnDue = ds.TaxToReturnDue;
      else
         TaxToReturnDue = $0.0;
      end;
   end;

   private var lastWorkDay = NULL;
   private macro GetLastWorkDayYear(pDate):DATE
      var Year:Integer;
      var IsWorkDay = 0;
      var query = "";
      var cmd;
      var DataSet;

      if(lastWorkDay == NULL)
         DateSplit(pDate, NULL, NULL, Year);
         lastWorkDay = Date(31, 12, Year);

         while(IsWorkDay == 0)
            query = "select rsi_rsbcalendar.IsWorkDay(?) as t_IsWorkDay from dual";
            cmd = DL_RSDCommand(query);
            cmd.AddParam(lastWorkDay);
            DataSet = cmd.Execute();
            if(DataSet.MoveNext())
               IsWorkDay = DataSet.IsWorkDay;
               if(IsWorkDay != 0)
                  break;
               end;
            end;

            lastWorkDay = lastWorkDay - 1;
         end;
      end;

      return lastWorkDay;
   end;

   macro GetPeriods()
      var dayEnd:INTEGER;
      var monthEnd:INTEGER;
      var Year:INTEGER;

      m_BeginDate021 = m_EndDate021 = m_BeginDate022 = m_EndDate022 = m_BeginDate023 = m_EndDate023 = m_BeginDate024 = m_EndDate024 = ZeroDate;

      DateSplit(m_EndDate, dayEnd, monthEnd, Year);

      if((dayEnd == 31) and (monthEnd == 3))
         m_BeginDate021 = Date(1, 1, Year);
         m_EndDate021 = Date(22, 1, Year);
         m_BeginDate022 = Date(23, 1, Year);
         m_EndDate022 = Date(22, 2, Year);
         m_BeginDate023 = Date(23, 2, Year);
         m_EndDate023 = Date(22, 3, Year);
      elif((dayEnd == 30) and (monthEnd == 6))
         m_BeginDate021 = Date(23, 3, Year);
         m_EndDate021 = Date(22, 4, Year);
         m_BeginDate022 = Date(23, 4, Year);
         m_EndDate022 = Date(22, 5, Year);
         m_BeginDate023 = Date(23, 5, Year);
         m_EndDate023 = Date(22, 6, Year);
      elif((dayEnd == 30) and (monthEnd == 9))
         m_BeginDate021 = Date(23, 6, Year);
         m_EndDate021 = Date(22, 7, Year);
         m_BeginDate022 = Date(23, 7, Year);
         m_EndDate022 = Date(22, 8, Year);
         m_BeginDate023 = Date(23, 8, Year);
         m_EndDate023 = Date(22, 9, Year);
      elif((dayEnd == 31) and (monthEnd == 12))
         m_BeginDate021 = Date(23, 9, Year);
         m_EndDate021 = Date(22, 10, Year);
         m_BeginDate022 = Date(23, 10, Year);
         m_EndDate022 = Date(22, 11, Year);
         m_BeginDate023 = Date(23, 11, Year);
         m_EndDate023 = Date(22, 12, Year);
         m_BeginDate024 = Date(23, 12, Year);
         m_EndDate024 = Date(31, 12, Year);
      end;
   end;

   macro Calculate()
      SQL_Truncate("dnptx6calc2_tmp");

      if((m_BeginDate021 != ZeroDate) and (m_EndDate021 != ZeroDate) and (m_BeginDate022 != ZeroDate) and (m_EndDate022 != ZeroDate)  and (m_BeginDate023 != ZeroDate) and
         (m_EndDate023 != ZeroDate))

         InitProgress(-1, "6-НДФЛ с 01.01.2021", "Отбор данных для раздела 1");

         var query = "insert into dnptx6calc2_tmp (" +
                     "                               t_Module," +
                     "                               t_Num," +
                     "                               t_TypeOper," +
                     "                               t_ClientID," +
                     "                               t_Client," +
                     "                               t_ClientCode," +
                     "                               t_DatePlusFact," +
                     "                               t_DatePaid," +
                     "                               t_DateTransfer," +
                     "                               t_BaseDate," +
                     "                               t_TaxPaidDate," +
                     "                               t_DateOper," +
                     "                               t_DocKind," +
                     "                               t_DocID," +
                     "                               t_NumOper," +
                     "                               t_Rate," +
                     "                               t_TotalPlus," +
                     "                               t_TotalMinus," +
                     "                               t_TaxCalculated," +
                     "                               t_TaxDue," +
                     "                               t_TaxToReturnDue," +
                     "                               t_DateTaxReturn," +
                     "                               t_IsHighRate" +
                     "                            )" +
                     " WITH mcaccdoc " +
                     " AS (" +
                     "       SELECT mcad.* " +
                     "       FROM dmcaccdoc_dbt mcad " +
                     "       WHERE mcad.t_Catid IN (438, 1007, 884, 885) " +
                     "         and mcad.t_IsCommon = chr(88) " +
                     "    )" +
                     " select 0," +
                     "        0," +
                     "        ''," +
                     "        0," +
                     "        ''," +
                     "        ''," +
                     "        to_date('01.01.0001', 'dd.mm.yyyy')," +
                     "        q.t_DatePaid," +
                     "        to_date('01.01.0001', 'dd.mm.yyyy')," +
                     "        0," +
                     "        nvl(sum(q.t_TaxPaid), 0) as t_TaxPaid, " +
                     "        to_date('01.01.0001', 'dd.mm.yyyy')," +
                     "        0," +
                     "        0," +
                     "        ''," +
                     "        q.t_Rate, " +
                     "        0," +
                     "        0," +
                     "        0," +
                     "        0," +
                     "        nvl(sum(q.t_TaxToReturnDue), 0) as t_TaxToReturnSum, " +
                     "        q.t_DateTaxReturn, " +
                     "        q.t_IsHighRate " +
                     " from (" +
                     //Погашение СЭБ + Погашение купона СЭБ
                     "         select q1.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q1.t_TaxPaid > 0 " +
                     "                         then q1.t_TaxPaid " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                (" +
                     "                   case " +
                     "                   when RSI_NPTX.ResidenceStatus(q1.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "                      then ( " +
                     "                              case " +
                     "                                 when q1.t_IsHighRate = 'X' " +
                     "                                    then '15'" +
                     "                                 else '13' " +
                     "                              end " +
                     "                           ) " +
                     "                      else " +
                     "                         case " +
                     "                         when exists(" +
                     "                                       select 1 " +
                     "                                       from dnotetext_dbt notetext " +
                     "                                       where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                         and notetext.t_DocumentID = LPAD(q1.t_Client, 10, '0') " +
                     "                                         and notetext.t_NoteKind = 77 " +
                     "                                         and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                    )" +
                     "                            then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q1.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                            else '30' " +
                     "                         end " +
                     "                   end " +
                     "                ) as t_Rate," +
                     "                (" +
                     "                   case " +
                     "                      when q1.t_TaxPaid < 0 " +
                     "                         then q1.t_TaxPaid * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                (" +
                     "                   case " +
                     "                      when q1.t_TaxPaid < 0 " +
                     "                         then q1.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q1.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/ " +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                    and TaxPaidObj.t_Kind in (" +
                                                                      //string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                      string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                      string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                      string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                      string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                  ")" +
                     "                    and RSI_NPTX.ResidenceStatus(TaxPaidObj.t_Client, " + GetSQLDate(m_EndDate) + ") = 1" +
                     "                    and TaxPaidObj.t_FromOutSyst <> chr(88)" +
                     "                 union all" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/ " +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and  " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in (" +
                                                                     string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                     string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                     string(TXOBJ_PAIDGENERAL) + ", " +
                                                                     string(TXOBJ_PAIDMATERIAL_IIS) + ", " +
                                                                     string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                     string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                     string(TXOBJ_PAIDBILL) + ", " +
                                                                     string(TXOBJ_DIVPAY_SEC) +
                                                                 ")" +
                     "                    and TaxPaidObj.t_FromOutSyst <> chr(88)" +
                     "              ) q1, " +
                     "              ddl_tick_dbt tick, " +
                     "              dnptxobdc_dbt obdc, " +
                     "              doproper_dbt oproper " +
                     "         where " + IIF(m_ByCB, "1", "0") + " = 1" +
                     "           and q1.t_AnaliticKind1 = " + string(TXOBJ_KIND1020) +
                     "           and obdc.t_ObjID = q1.t_ObjID " +
                     "           and oproper.t_ID_Operation = obdc.t_DocID " +
                     "           and tick.t_DealID = to_number(oproper.t_DocumentID) " +
                     "           and tick.t_BOfficeKind = " + string(DL_RETIREMENT_OWN) +
                     "         union all " +
                     // Возврат дивидендов
                     "         select q2.t_DatePaid," + 
                     "                ( " +
                     "                   case " +
                     "                      when q2.t_PaidGeneralSum > 0 and q2.t_PaidSpecialSum <= 0" +
                     "                         then q2.t_PaidGeneralSum " +
                     "                      when q2.t_PaidGeneralSum <= 0 and q2.t_PaidSpecialSum > 0 " +
                     "                         then q2.t_PaidSpecialSum " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                (" +
                     "                   case " +
                     "                   when RSI_NPTX.ResidenceStatus(q2.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "                      then " +
                     "                         case " +
                     "                            when q2.t_PaidSpecialSum <> 0 " +
                     "                               and q2.t_PaidGeneralSum = 0 " +
                     "                               then '9' " +
                     "                            when q2.t_PaidSpecialSum = 0 " +
                     "                               and q2.t_PaidGeneralSum <> 0" +
                     "                               then " +
                     "                                  case " +
                     "                                  when q2.t_IsHighRate = 'X'" +
                     "                                     then '15' " +
                     "                                  else '13' " +
                     "                                  end " +
                     "                            else '13'" +
                     "                         end " +
                     "                   else " +
                     "                      case " +
                     "                      when exists(" +
                     "                                    select 1 " +
                     "                                    from dnotetext_dbt notetext " +
                     "                                    where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                      and notetext.t_DocumentID = LPAD(q2.t_Client, 10, '0') " +
                     "                                      and notetext.t_NoteKind = 77 " +
                     "                                      and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                 )" +
                     "                         then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q2.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                      else '30' " +
                     "                      end " +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                (" +
                     "                   case " +
                     "                      when q2.t_PaidGeneralSum < 0 and q2.t_PaidSpecialSum = 0 " +
                     "                         then q2.t_PaidGeneralSum * -1 " +
                     "                      when q2.t_PaidGeneralSum = 0 and q2.t_PaidSpecialSum < 0 " +
                     "                         then q2.t_PaidSpecialSum * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q2.t_PaidGeneralSum < 0 or q2.t_PaidSpecialSum < 0 " +
                     "                         then q2.t_DatePaid " +
                     "                      else to_date('01.01.001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q2.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(PaidGeneralObjHigh DNPTXOBJ_DBT_IDX1)*/" +
                     "                        PaidGeneralObjHigh.t_Sum0 as t_PaidGeneralSum, " +
                     "                        0 as t_PaidSpecialSum, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        PaidGeneralObjHigh.t_ObjID, " +
                     "                        PaidGeneralObjHigh.t_AnaliticKind1, " +
                     "                        PaidGeneralObjHigh.t_Analitic1, " +
                     "                        PaidGeneralObjHigh.t_Client, " +
                     "                        PaidGeneralObjHigh.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt PaidGeneralObjHigh " +
                     "                 where PaidGeneralObjHigh.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and PaidGeneralObjHigh.t_Kind in (" +
                                                                           //  string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                             string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                             string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                             string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                             string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                         ")" +
                     "                   and PaidGeneralObjHigh.t_FromOutSyst <> chr(88) " +
                     "                 union all" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        (" +
                     "                           case " +
                     "                           when TaxPaidObj.t_Kind in (" +
                                                                              string(TXOBJ_PAIDGENERAL) + ", " +
                                                                              string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                              string(TXOBJ_DIVPAY_SEC) +
                                                                          ")" +
                     "                              then TaxPaidObj.t_Sum0 " +
                     "                           else 0 " +
                     "                           end " +
                     "                        ) as t_PaidGeneralSum, " +
                     "                        (" +
                     "                           case " +
                     "                           when TaxPaidObj.t_Kind in (" +
                                                                              string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                              string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                          ")" +
                     "                              then TaxPaidObj.t_Sum0 " +
                     "                           else 0 " +
                     "                           end " +
                     "                        ) as t_PaidSpecialSum, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in (" +
                                                                     string(TXOBJ_PAIDGENERAL) + ", " +
                                                                     string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                     string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                     string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                 ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "              ) q2, " +
                     "              ddl_tick_dbt tick, " +
                     "              ddl_leg_dbt leg, " +
                     "              dnptxobdc_dbt obdc, " +
                     "              doproper_dbt oproper " +
                     "         where 1 = " + IIF(m_ByCB, "1", "0") +
                     "           and q2.t_AnaliticKind1 = " + string(TXOBJ_KIND1100) +
                     "           and tick.t_BOfficeKind = " + string(DL_RETURN_DIVIDEND) +
                     "           and obdc.t_ObjID = q2.t_ObjID " +
                     "           and oproper.t_ID_Operation = obdc.t_DocID " +
                     "           and tick.t_DealID = to_number(oproper.t_DocumentID) " +
                     "           and rsb_secur.IsDividendReturnRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1 " +
                     "           and leg.t_DealID = tick.t_DealID " +
                     "           and leg.t_LegKind = 0 " +
                     "           and leg.t_LegID = 0" +
                     "         union all" +
                     // СО БУ при выплате дохода ЮЛН, для которых указан фактический получатеель дохода - физ. лицо
                     "         select q3.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q3.t_PaidGeneralSum > 0 and q3.t_PaidSpecialSum = 0 " +
                     "                         then q3.t_PaidGeneralSum " +
                     "                      when q3.t_PaidGeneralSum = 0 and q3.t_PaidSpecialSum > 0 " +
                     "                         then q3.t_PaidSpecialSum " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                ( " +
                     "                   case " +
                     "                   when rsi_nptx.ResidenceStatus(q3.t_Client, " + GetSQLDate(m_EndDate) + ") = 1" +
                     "                      then " +
                     "                         case " +
                     "                         when q3.t_PaidSpecialSum <> 0 and q3.t_PaidGeneralSum = 0 " +
                     "                            then '9'" +
                     "                         when q3.t_PaidSpecialSum = 0 and q3.t_PaidGeneralSum <> 0 " +
                     "                            then " +
                     "                               case " +
                     "                               when q3.t_IsHighRate = 'X'" +
                     "                                  then '15'" +
                     "                               else '13'" +
                     "                               end " +
                     "                         else '9/13'" +
                     "                         end " +
                     "                   else " +
                     "                      case " +
                     "                      when exists(" +
                     "                                    select 1" +
                     "                                    from dnotetext_dbt notetext " +
                     "                                    where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                      and notetext.t_DocumentID = LPAD(q3.t_Client, 10, '0')" +
                     "                                      and notetext.t_NoteKind = 77 " +
                     "                                      and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                 )" +
                     "                         then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q3.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                      else '30'" +
                     "                      end " +
                     "                   end" +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q3.t_PaidGeneralSum < 0 and q3.t_PaidSpecialSum = 0 " +
                     "                         then q3.t_PaidGeneralSum * -1 " +
                     "                      when q3.t_PaidGeneralSum = 0 and q3.t_PaidSpecialSum < 0 " +
                     "                         then q3.t_PaidSpecialSum * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q3.t_PaidGeneralSum < 0 or q3.t_PaidSpecialSum < 0 " +
                     "                         then q3.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q3.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(TaxPaidObjHigh DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObjHigh.t_Sum0 as t_PaidGeneralSum, " +
                     "                        0 as t_PaidSpecialSum, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObjHigh.t_ObjID, " +
                     "                        TaxPaidObjHigh.t_AnaliticKind1, " +
                     "                        TaxPaidObjHigh.t_Analitic1, " +
                     "                        TaxPaidObjHigh.t_Client, " +
                     "                        TaxPaidObjHigh.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObjHigh " +
                     "                 where TaxPaidObjHigh.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObjHigh.t_Kind in (" +
                                                                      //   string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                         string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                         string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                         string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                         string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                     ")" +
                     "                   and TaxPaidObjHigh.t_FromOutSyst <> chr(88) " +
                     "                   and TaxPaidObjHigh.t_User <> chr(88) " +
                     "                 union all" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        (" +
                     "                           case " +
                     "                           when TaxPaidObj.t_Kind in (" +
                                                                              string(TXOBJ_PAIDGENERAL) + ", " +
                                                                              string(TXOBJ_PAIDGENERAL_IIS) +
                                                                          ")" +
                     "                              then TaxPaidObj.t_Sum0 " +
                     "                           else 0 " +
                     "                           end " +
                     "                        ) as t_PaidGeneralSum, " +
                     "                        (" +
                     "                           case " +
                     "                           when TaxPaidObj.t_Kind in (" +
                                                                              string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                              string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                          ")" +
                     "                              then TaxPaidObj.t_Sum0 " +
                     "                           else 0 " +
                     "                           end " +
                     "                        ) as t_PaidSpecialSum, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                   and TaxPaidObj.t_User <> chr(88) " +
                     "              ) q3, " +
                     "              ddl_tick_dbt tick " +
                     "         where 1 = " + IIF(m_ByCB, "1", "0") +
                     "           and q3.t_AnaliticKind1 = " + string(TXOBJ_KIND1010) +
                     "           and tick.t_DealID = q3.t_Analitic1 " +
                     "           and tick.t_BOfficeKind = " + string(DL_SECURITYDOC) +
                     "           and rsi_nutx.IsNonResidentPayerNUTX(tick.t_ClientID, " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "         union all" +
                     // Списание денежных средств
                     "         select q4.t_DatePaid, " +
                     "                (" +
                     "                   case " +
                     "                      when q4.t_TaxPaid > 0 " +
                     "                         then q4.t_TaxPaid " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                (" +
                     "                   case " +
                     "                   when rsi_nptx.ResidenceStatus(q4.t_Client, " + GetSQLDate(m_EndDate) + ") = 1" +
                     "                      then " +
                     "                         case " +
                     "                         when q4.t_IsHighRate = 'X'" +
                     "                            then '15'" +
                     "                         else '13'" +
                     "                         end " +
                     "                   else " +
                     "                      case " +
                     "                      when exists(" +
                     "                                    select 1" +
                     "                                    from dnotetext_dbt notetext " +
                     "                                    where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                      and notetext.t_DocumentID = LPAD(q4.t_Client, 10, '0')" +
                     "                                      and notetext.t_NoteKind = 77 " +
                     "                                      and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                 )" +
                     "                         then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q4.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                      else '30'" +
                     "                      end " +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q4.t_TaxPaid < 0 " +
                     "                         then q4.t_TaxPaid * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q4.t_TaxPaid < 0 " +
                     "                         then q4.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q4.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(TaxPaidObjHigh DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObjHigh.t_Sum0 as t_TaxPaid, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObjHigh.t_ObjID, " +
                     "                        TaxPaidObjHigh.t_AnaliticKind1, " +
                     "                        TaxPaidObjHigh.t_Analitic1, " +
                     "                        TaxPaidObjHigh.t_Client, " +
                     "                        TaxPaidObjHigh.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObjHigh " +
                     "                 where TaxPaidObjHigh.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObjHigh.t_Kind in(" +
                                                                     //   string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                    ")" +
                     "                   and TaxPaidObjHigh.t_FromOutSyst <> chr(88) " +
                     "                 union all " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/"
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                    string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                    string(TXOBJ_PAIDMATERIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDBILL) + ", " +
                                                                    string(TXOBJ_DIVPAY_SEC) +
                                                                ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "              ) q4, " +
                     "              dnptxobdc_dbt nptxobdc, " +
                     "              dnptxop_dbt nptxop " +
                     "         where 1 = " + IIF(m_ByCB, "1", "0") +
                     "           and nptxobdc.t_ObjID = q4.t_ObjID " +
                     "           and nptxop.t_ID = nptxobdc.t_DocID " +
                     "           and nptxop.t_DocKind = " + string(DL_WRTMONEY) +
                     "           and nptxop.t_SubKind_Operation = " + string(DL_NPTXOP_WRTKIND_WRTOFF) +
                     "           and nptxop.t_FlagTax = 'X'" +
                     "         union all " +
                     // Списание ценных бумаг
                     "         select q5.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q5.t_TaxPaid > 0 " +
                     "                         then q5.t_TaxPaid " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                ( " +
                     "                   case " +
                     "                   when rsi_nptx.ResidenceStatus(q5.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "                      then " +
                     "                         case " +
                     "                         when q5.t_IsHighRate = 'X' " +
                     "                            then '15' " +
                     "                         else '13'" +
                     "                         end " +
                     "                   else " +
                     "                      case " +
                     "                      when exists(" +
                     "                                    select 1" +
                     "                                    from dnotetext_dbt notetext " +
                     "                                    where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                      and notetext.t_DocumentID = LPAD(q5.t_Client, 10, '0')" +
                     "                                      and notetext.t_NoteKind = 77 " +
                     "                                      and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                 )" +
                     "                         then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q5.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                      else '30'" +
                     "                      end " +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q5.t_TaxPaid < 0 " +
                     "                         then q5.t_TaxPaid * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q5.t_TaxPaid < 0 " +
                     "                         then q5.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q5.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                 //   string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                   and TaxPaidObj.t_User <> chr(88) " +
                     "                 union all " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                    string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                    string(TXOBJ_PAIDMATERIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDBILL) + ", " +
                                                                    string(TXOBJ_DIVPAY_SEC) +
                                                                ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                   and TaxPaidObj.t_User <> chr(88) " +
                     "              ) q5, " +
                     "              dnptxobdc_dbt obdc, " +
                     "              doproper_dbt oproper " +
                     "         where 1 = " + IIF(m_ByCB, "1", "0") +
                     "           and q5.t_AnaliticKind1 = " + string(TXOBJ_KIND1070) +
                     "           and obdc.t_ObjID = q5.t_ObjID " +
                     "           and oproper.t_ID_Operation = obdc.t_DocID " +
                     "           and oproper.t_DocKind = " + string(DL_AVRWRT) +
                     // Операции удержания НДФЛ (в т. ч. из созданные безынтерфейсно в Депозитарии)
                     "         union all " +
                     "         select q6.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q6.t_TaxPaid > 0 " +
                     "                         then q6.t_TaxPaid " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                (" +
                     "                   case " +
                     "                   when rsi_nptx.ResidenceStatus(q6.t_Client, " + GetSQLDate(m_EndDate) + ") = 1" +
                     "                      then " +
                     "                         case " +
                     "                         when q6.t_IsHighRate = 'X'" +
                     "                            then '15'" +
                     "                         else '13'" +
                     "                         end " +
                     "                   else " +
                     "                      case " +
                     "                      when exists(" +
                     "                                    select 1" +
                     "                                    from dnotetext_dbt notetext " +
                     "                                    where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                      and notetext.t_DocumentID = LPAD(q6.t_Client, 10, '0')" +
                     "                                      and notetext.t_NoteKind = 77 " +
                     "                                      and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                 )" +
                     "                         then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q6.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                      else '30'" +
                     "                      end " +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q6.t_TaxPaid < 0 " +
                     "                         then q6.t_TaxPaid * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q6.t_TaxPaid < 0 " +
                     "                         then q6.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q6.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                //    string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                 union all " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                    string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                    string(TXOBJ_PAIDMATERIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDBILL) + ", " +
                                                                    string(TXOBJ_DIVPAY_SEC) +
                                                                ")" +
                     "                 and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "              ) q6, " +
                     "              dnptxobdc_dbt nptxobdc, " +
                     "              dnptxop_dbt nptxop, " +
                     "              ddppmobj_dbt dppmobj " +
                     "         where nptxobdc.t_ObjID = q6.t_ObjID " +
                     "           and nptxop.t_ID = nptxobdc.t_DocID " +
                     "           and nptxop.t_DocKind = " + string(DL_HOLDNDFL) +
                     "           and dppmobj.t_ObjKind(+) = nptxop.t_DocKind " +
                     "           and dppmobj.t_ObjID(+) = nptxop.t_ID " +
                     "           and (" +
                     "                  1 = " + IIF(m_ByCB, "1", "0") +
                     "                  and dppmobj.t_ID IS NULL " +
                     "                  or 1 = " + IIF(m_ByDepo, "1", "0") +
                     "                  and not dppmobj.t_ID IS NULL " +
                     "               )" +
                     "         union all " +
                     // Операции расчета выплат в депозитарии
                     "         select q7.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q7.t_PaidGeneralSum > 0 and q7.t_PaidSpecialSum = 0 " +
                     "                         then q7.t_PaidGeneralSum " +
                     "                      when q7.t_PaidGeneralSum = 0 and q7.t_PaidSpecialSum > 0 " +
                     "                         then q7.t_PaidSpecialSum " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                (" +
                     "                   case " +
                     "                   when rsi_nptx.ResidenceStatus(q7.t_Client, " + GetSQLDate(m_EndDate) + ") = 1" +
                     "                      then (" +
                     "                              case " +
                     "                                 when q7.t_PaidGeneralSum > 0 and q7.t_PaidSpecialSum = 0 " +
                     "                                 then (" +
                     "                                         case " +
                     "                                            when q7.t_IsHighRate = 'X'" +
                     "                                               then '15'" +
                     "                                            else '13'" +
                     "                                         end " +
                     "                                      )" +
                     "                                 else '9' " +
                     "                              end " +
                     "                           )" +
                     "                   else " +
                     "                      case " +
                     "                      when exists(" +
                     "                                    select 1" +
                     "                                    from dnotetext_dbt notetext " +
                     "                                    where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                      and notetext.t_DocumentID = LPAD(q7.t_Client, 10, '0')" +
                     "                                      and notetext.t_NoteKind = 77 " +
                     "                                      and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                 )" +
                     "                         then TO_CHAR(RSB_STRUCT.getDouble(RSI_RSB_KERNEL.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q7.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + "))) " +
                     "                      else (" +
                     "                              case " +
                     "                                 when q7.t_PaidGeneralSum > 0 and q7.t_PaidSpecialSum = 0 " +
                     "                                    then '30' " +
                     "                                 else '15' " +
                     "                              end " +
                     "                           )" +
                     "                      end " +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q7.t_PaidGeneralSum < 0 and q7.t_PaidSpecialSum = 0 " +
                     "                         then q7.t_PaidGeneralSum * -1 " +
                     "                      when q7.t_PaidGeneralSum = 0 and q7.t_PaidSpecialSum < 0 " +
                     "                         then q7.t_PaidSpecialSum * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when (q7.t_PaidGeneralSum < 0 and q7.t_PaidSpecialSum = 0 or " +
                     "                            q7.t_PaidGeneralSum = 0 and q7.t_PaidSpecialSum < 0) " +
                     "                         then q7.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q7.t_IsHighRate " +
                     "         from (" +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        PaidGeneralObj.t_Sum0 as t_PaidGeneralSum, " +
                     "                        0 as t_PaidSpecialSum, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        PaidGeneralObj.t_ObjID, " +
                     "                        PaidGeneralObj.t_AnaliticKind1, " +
                     "                        PaidGeneralObj.t_Analitic1, " +
                     "                        PaidGeneralObj.t_Client, " +
                     "                        PaidGeneralObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt PaidGeneralObj " +
                     "                 where PaidGeneralObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and PaidGeneralObj.t_Kind in(" +
                                                                      //  string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                        string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                    ")" +
                     "                   and PaidGeneralObj.t_FromOutSyst <> chr(88) " +
                     "                 union all " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        ( " +
                     "                           case " +
                     "                              when TaxPaidObj.t_Kind in(" +
                                                                                string(TXOBJ_PAIDGENERAL) + ", " +
                                                                                string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                                string(TXOBJ_DIVPAY_SEC) +
                                                                            ")" +
                     "                                 then TaxPaidObj.t_Sum0 " +
                     "                              else 0 " +
                     "                           end " +
                     "                        ) as t_PaidGeneralSum, " +
                     "                        ( " +
                     "                           case " +
                     "                              when TaxPaidObj.t_Kind in(" +
                                                                                string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                                string(TXOBJ_PAIDSPECIAL_IIS) +
                                                                            ")" +
                     "                                 then TaxPaidObj.t_Sum0 " +
                     "                              else 0 " +
                     "                           end " +
                     "                        ) as t_PaidSpecialSum, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in(" +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                    string(TXOBJ_DIVPAY_SEC) +
                                                                ")" +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "              ) q7, " +
                     "              ddppmobj_dbt dppmobj " +
                     "         where 1 = " + IIF(m_ByDepo, "1", "0") +
                     "           and q7.t_AnaliticKind1 in(" +
                                                             string(TXOBJ_KIND1095) + ", " +
                                                             string(TXOBJ_KIND1098) +
                                                         ")" +
                     "           and dppmobj.t_ObjKind = " + string(OBJTYPE_NPTXOBJ) +
                     "           and dppmobj.t_ObjID = q7.t_ObjID " +
                     // Операции погашения собственных векселей банка, погашение собственных векселей банка, выданных другим фииалом, выкупа собственных векселей,
                     // зачет взаимных требований, мена векселей
                     "         union all " +
                     "         select q8.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q8.t_TaxPaid > 0 " +
                     "                         then q8.t_TaxPaid " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                (" +
                     "                   case " +
                     "                      when rsi_nptx.ResidenceStatus(q8.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "                         then ( " +
                     "                                 case " +
                     "                                    when q8.t_IsHighRate = 'X' " +
                     "                                       then '15' " +
                     "                                    else '13' " +
                     "                                 end " +
                     "                              ) " +
                     "                      else (" +
                     "                              case " +
                     "                                 when exists( " +
                     "                                               select 1 " +
                     "                                               from dnotetext_dbt notetext " +
                     "                                               where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                                 and notetext.t_DocumentID = LPAD(q8.t_Client, 10, '0') " +
                     "                                                 and notetext.t_NoteKind = 77 " +
                     "                                                 and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                            ) " +
                     "                                    then to_char(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q8.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + ")))" +
                     "                                 else '30' " +
                     "                              end " +
                     "                           )" +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q8.t_TaxPaid < 0 " +
                     "                         then q8.t_TaxPaid * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q8.t_TaxPaid < 0 " +
                     "                         then q8.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q8.t_IsHighRate " +
                     "         from ( " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid, " +
                     "                        TaxPaidObj.t_Kind " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in( " +
                                                                //    string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                ") " +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                 union all " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid, " +
                     "                        TaxPaidObj.t_Kind " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in( " +
                                                                    string(TXOBJ_PAIDBILL) +
                                                                ") " +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "              ) q8, " +
                     "              doproper_dbt oproper, " +
                     "              dnptxobdc_dbt nptxobdc, " +
                     "              doprkoper_dbt oprkoper, " +
                     "              doprstep_dbt oprstep, " +
                     "              ddl_order_dbt dl_order " +
                     "         where 1 = " + IIF(m_ByVS, "1", "0") +
                     "           and nptxobdc.t_ObjID = q8.t_ObjID " +
                     "           and oproper.t_ID_Operation = nptxobdc.t_DocID " +
                     "           and oprstep.t_ID_Step = nptxobdc.t_Step " +
                     "           and oprstep.t_ID_Operation = oproper.t_ID_Operation " +
                     "           and dl_order.t_DocKind = oproper.t_DocKind " +
                     "           and LPAD(dl_order.t_ContractID, 10, '0') = oproper.t_DocumentID " +
                     "           and ( " +
                     "                  dl_order.t_DocKind = " + string(DL_VEKSELDRAWORDER) +
                     "                  and INSTR(oprkoper.t_SysTypes, " + GetSQLChar("Ф") + ") = 0 " +
                     "                   or dl_order.t_DocKind = " + string(DL_VSBARTERORDER) +
                     "                   or dl_order.t_DocKind = " + string(DL_VSINTERCHANGE) +
                     "               ) " +
                     "           and oprkoper.t_Kind_Operation = oproper.t_Kind_Operation " +
                     "         union all " +
                     //Пользовательские объекты НДР
                     "         select q9.t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when q9.t_TaxPaid > 0 " +
                     "                      then q9.t_TaxPaid " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when rsi_nptx.ResidenceStatus(q9.t_Client, " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "                      then ( " +
                     "                              case " +
                     "                                 when q9.t_IsHighRate = chr(88) " +
                     "                                 then '15' " +
                     "                                 else '13' " +
                     "                              end " +
                     "                           ) " +
                     "                      else (" +
                     "                              case " +
                     "                                 when exists( " +
                     "                                               select 1 " +
                     "                                               from dnotetext_dbt notetext " +
                     "                                               where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                                 and notetext.t_DocumentID = LPAD(q9.t_Client, 10, '0') " +
                     "                                                 and notetext.t_NoteKind = 77 " +
                     "                                                 and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                            ) " +
                     "                                 then to_char(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(q9.t_Client, 10, '0'), 77, " + GetSQLDate(m_EndDate) + ")))" +
                     "                                 else '30' " +
                     "                              end " +
                     "                           )" +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when q9.t_TaxPaid < 0 " +
                     "                      then q9.t_TaxPaid * -1 " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when q9.t_TaxPaid < 0 " +
                     "                      then q9.t_DatePaid " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                q9.t_IsHighRate " +
                     "         from ( " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(88) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in( " +
                                                                //    string(TXOBJ_PAIDGENERAL_15) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_1) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_2) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_9) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_15_IIS) +
                                                                ") " +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                   and TaxPaidObj.t_User = chr(88) " +
                     "                 union all " +
                     "                 select /*+ index(TaxPaidObj DNPTXOBJ_DBT_IDX1)*/" +
                     "                        TaxPaidObj.t_Sum0 as t_TaxPaid, " +
                     "                        chr(0) as t_IsHighRate, " +
                     "                        TaxPaidObj.t_ObjID, " +
                     "                        TaxPaidObj.t_AnaliticKind1, " +
                     "                        TaxPaidObj.t_Analitic1, " +
                     "                        TaxPaidObj.t_Client, " +
                     "                        TaxPaidObj.t_Date as t_DatePaid " +
                     "                 from dnptxobj_dbt TaxPaidObj " +
                     "                 where TaxPaidObj.t_Date between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                   and TaxPaidObj.t_Kind in( " +
                                                                    string(TXOBJ_PAIDMATERIAL) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL) + ", " +
                                                                    string(TXOBJ_PAIDMATERIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDGENERAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDSPECIAL_IIS) + ", " +
                                                                    string(TXOBJ_PAIDBILL) + ", " +
                                                                    string(TXOBJ_DIVPAY_SEC) +
                                                                ") " +
                     "                   and TaxPaidObj.t_FromOutSyst <> chr(88) " +
                     "                   and TaxPaidObj.t_User = chr(88) " +
                     "              ) q9 " +
                     "         union all " +
                     //Пользовательские проводки
                     "         select acctrn.t_Date_Carry as t_DatePaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when account.t_AccountID = acctrn.t_AccountID_Payer " +
                     "                      then acctrn.t_Sum_NatCur " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxPaid, " +
                     "                ( " +
                     "                   case " +
                     "                      when rsi_nptx.ResidenceStatus(party.t_PartyID,  " + GetSQLDate(m_EndDate) + ") = 1 " +
                     "                      then ( " +
                     "                              case " +
                     "                                 when acctrn.t_CatID = 1007 " +
                     "                                 then '15' " +
                     "                                 else '13' " +
                     "                              end " +
                     "                           ) " +
                     "                      else ( " +
                     "                              case " +
                     "                                 when exists( " +
                     "                                               select 1 " +
                     "                                               from dnotetext_dbt notetext " +
                     "                                               where notetext.t_ObjectType = " + string(OBJTYPE_PARTY) +
                     "                                                 and notetext.t_DocumentID = LPAD(party.t_PartyID, 10, '0') " +
                     "                                                 and notetext.t_NoteKind = 77 " +
                     "                                                 and " + GetSQLDate(m_EndDate) + " between notetext.t_Date and notetext.t_ValidToDate " +
                     "                                            ) " +
                     "                                 then to_char(rsb_struct.getDouble(rsi_rsb_kernel.GetNote(" + string(OBJTYPE_PARTY) + ", LPAD(party.t_PartyID, 10, '0'), 77, " + GetSQLDate(m_EndDate) + ")))" +
                     "                                 else '30' " +
                     "                              end " +
                     "                           ) " +
                     "                   end " +
                     "                ) as t_Rate, " +
                     "                ( " +
                     "                   case " +
                     "                      when account.t_AccountID = acctrn.t_AccountID_Receiver " +
                     "                      then acctrn.t_Sum_NatCur " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_TaxToReturnDue, " +
                     "                ( " +
                     "                   case " +
                     "                      when account.t_AccountID = acctrn.t_AccountID_Receiver " +
                     "                      then acctrn.t_Date_Carry " +
                     "                      else to_date('01.01.0001', 'dd.mm.yyyy') " +
                     "                   end " +
                     "                ) as t_DateTaxReturn, " +
                     "                ( " +
                     "                   case " +
                     "                      when acctrn.t_CatID = 1007 " +
                     "                      then chr(88) " +
                     "                      else chr(0) " +
                     "                   end " +
                     "                ) t_IsHighRate " +
                     "           from (" +
                     //Для перечисления налога
                     "                   select /*+ index(trn DACCTRN_DBT_IDXA)*/ trn.*," +
                     "                          CHR (88) trn_Payer," +
                     "                          mcaccdoc.t_CatID" +
                     "                   from dacctrn_dbt trn" +
                     "                        join mcaccdoc " +
                     "                        on trn.t_Account_Payer = mcaccdoc.t_Account" +
                     "                           and mcaccdoc.t_ID = ( " +
                     "                                                  select max(sub_mcaccdoc.t_ID) " +
                     "                                                  from dmcaccdoc_dbt sub_mcaccdoc " +
                     "                                                  where sub_mcaccdoc.t_Account = trn.t_Account_Payer " +
                     "                                                    and sub_mcaccdoc.t_IsCommon = chr(88) " +
                     "                                                    and sub_mcaccdoc.t_Catid IN (438, 1007, 884, 885) " +
                     "                                               ) " +
                     "                   where trn.t_Date_Carry between " + GetSQLDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                     and not exists(" +
                     "                                      select 1 " +
                     "                                      from doprdocs_dbt oprdocs" +
                     "                                      where oprdocs.t_AccTrnID = trn.t_AccTrnID" +
                     "                                   )" +
                     "                   union all" +
                     //Для возврата налога
                     "                   select /*+ index(trn DACCTRN_DBT_IDXB)*/" +
                     "                          trn.*," +
                     "                          CHR (0) trn_Payer, " +
                     "                          mcaccdoc.t_CatID " +
                     "                   from dacctrn_dbt trn" +
                     "                        join mcaccdoc " +
                     "                        on trn.t_Account_Receiver = mcaccdoc.t_Account" +
                     "                           and mcaccdoc.t_ID = ( " +
                     "                                                   select max(sub_mcaccdoc.t_ID) " +
                     "                                                   from dmcaccdoc_dbt sub_mcaccdoc " +
                     "                                                   where sub_mcaccdoc.t_Account = trn.t_Account_Payer " +
                     "                                                     and sub_mcaccdoc.t_IsCommon = chr(88) " +
                     "                                                     and sub_mcaccdoc.t_Catid IN (438, 1007, 884, 885) " +
                     "                                               ) " +
                     "                   where trn.t_Date_Carry between " + GetSqlDate(m_BeginDate021) + " and " + GetSQLDate(m_EndDate) +
                     "                     and not exists( " +
                     "                                      select 1" +
                     "                                      from doprdocs_dbt oprdocs " +
                     "                                      where oprdocs.t_AccTrnID = trn.t_AccTrnID" +
                     "                                   )" +
                     "                ) acctrn " +
                     "                join daccount_dbt account " +
                     "                on account.t_accountid = decode(acctrn.trn_Payer, CHR (88), acctrn.t_AccountID_Receiver, acctrn.t_AccountID_Payer) " +
                     "                join dparty_dbt party " +
                     "                on party.t_PartyID = account.t_Client " +
                     "                   and party.t_LegalForm = 2 " +
                     "      ) q " +
                     " group by q.t_IsHighRate, q.t_Rate, q.t_DatePaid, q.t_DateTaxReturn ";
   
         var cmd = RSDCommand(query);
         cmd.NullConversion = true;
         cmd.Execute();

         RemProgress();

         m_StatPart1 = true;
      else
         m_StatPart1 = false;
      end;
   end;

   macro Returns()
      if(m_SetRet == NULL)
         m_QueryRet = " SELECT "
                       + " COUNT(1) OVER() as t_Count "
                      + " ,t_DateTaxReturn as t_DateTaxReturn "
                      + " ,t_TaxToReturnDue as t_TaxToReturnDue "
                    + " FROM "
                       + " dnptx6calc2_tmp "
                    + " WHERE "
                       + " t_TaxToReturnDue > 0 "
                       + " and t_IsHighRate <> chr(88)"
                    + " ORDER BY "
                       + "  t_DateTaxReturn ASC ";
 
         m_CmdRet = RsdCommand(m_QueryRet);
         m_CmdRet.NullConversion = true;
         m_CmdRet.Execute();
 
         m_SetRet = RsdRecordset(m_CmdRet, RSDVAL_CLIENT, RSDVAL_STATIC);
      end;

      return m_SetRet;
   end;

   macro ReturnsHighRate()
      if(m_SetRetHighRate == NULL)
         m_QueryRetHighRate = " SELECT "
                               + " COUNT(1) OVER() as t_Count "
                              + " ,t_DateTaxReturn as t_DateTaxReturn "
                              + " ,t_TaxToReturnDue as t_TaxToReturnDue "
                            + " FROM "
                               + " dnptx6calc2_tmp "
                            + " WHERE "
                               + " t_TaxToReturnDue > 0 "
                               + " and t_IsHighRate = chr(88)"
                            + " ORDER BY "
                               + "  t_DateTaxReturn ASC ";
 
         m_CmdRetHighRate = RsdCommand(m_QueryRetHighRate);
         m_CmdRetHighRate.NullConversion = true;
         m_CmdRetHighRate.Execute();
 
         m_SetRetHighRate = RsdRecordset(m_CmdRetHighRate, RSDVAL_CLIENT, RSDVAL_STATIC);
      end;

      return m_SetRetHighRate;
   end;

   macro GetPaidSums()
      if((m_Sum021 == 0) and (m_Sum022 == 0) and (m_Sum023 == 0) and (m_Sum024 == 0) and (m_Sum021_HighRate == 0) and (m_Sum022_HighRate == 0) and (m_Sum023_HighRate == 0) and (m_Sum024_HighRate == 0))
         var query = " SELECT q.t_IsHighRate, " +
                     "        nvl(sum(q.t_Period1), 0) as t_Period1, " +
                     "        nvl(sum(q.t_Period2), 0) as t_Period2, " +
                     "        nvl(sum(q.t_Period3), 0) as t_Period3, " +
                     "        nvl(sum(q.t_Period4), 0) as t_Period4 " +
                     " FROM ( " +
                     "         SELECT t_IsHighRate, " +
                     "                ( " +
                             //Для поля 021
                     "                   case " +
                     "                      when t_DatePaid between ? and ? " +
                     "                      then t_TaxPaidDate " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_Period1, " +
                             //Для поля 022
                     "                ( " +
                     "                   case " +
                     "                      when t_DatePaid between ? and ? " +
                     "                      then t_TaxPaidDate " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_Period2, " +
                             //Для поля 023
                     "                ( " +
                     "                   case " +
                     "                      when t_DatePaid between ? and ? " +
                     "                      then t_TaxPaidDate " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_Period3, " +
                             //Для поля 024
                     "                ( " +
                     "                   case " +
                     "                      when t_DatePaid between ? and ? " +
                     "                      then t_TaxPaidDate " +
                     "                      else 0 " +
                     "                   end " +
                     "                ) as t_Period4 " +
                     "         FROM dnptx6calc2_tmp " +
                     "      ) q " +
                     " GROUP BY q.t_IsHighRate " +
                     " ORDER BY q.t_IsHighRate";

         var cmd = DL_RsdCommand(query);
         //Для поля 021
         cmd.AddParam(m_BeginDate021);
         cmd.AddParam(m_EndDate021);
         //Для поля 022
         cmd.AddParam(m_BeginDate022);
         cmd.AddParam(m_EndDate022);
         //Для поля 023
         cmd.AddParam(m_BeginDate023);
         cmd.AddParam(m_EndDate023);
         //Для поля 024
         cmd.AddParam(m_BeginDate024);
         cmd.AddParam(m_EndDate024);

         var DS = cmd.Execute();

         while(DS.MoveNext())
            if(DS.IsHighRate == SET_CHAR)
               m_Sum021_HighRate = DS.Period1;
               m_Sum022_HighRate = DS.Period2;
               m_Sum023_HighRate = DS.Period3;
               m_Sum024_HighRate = DS.Period4;
            else
               m_Sum021 = DS.Period1;
               m_Sum022 = DS.Period2;
               m_Sum023 = DS.Period3;
               m_Sum024 = DS.Period4;
            end;
         end;
      end;
   end;

   InitNPTXRepCalc2_NPTXPIT6(_BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS);
   GetPeriods();
END;

CLASS NPTXPayerInfo(_ClientID:integer, _ClientINN:string, _LastName:string, _FirstName:string, _MiddleName:string, _ResidenceStatus:string, _DateBirth:Date,
                           _ResidenceCountry:string, _DocumentType:string, _DocumentNumber:string, _ArrCodeParm:TArray)
   var ClientID         = _ClientID;
   var ClientINN        = _ClientINN;
   var LastName         = _LastName;
   var FirstName        = _FirstName;
   var MiddleName       = _MiddleName;
   var ResidenceStatus  = _ResidenceStatus;
   var DateBirth        = _DateBirth;
   var ResidenceCountry  = _ResidenceCountry;
   var DocumentType     = _DocumentType;
   var DocumentNumber   = _DocumentNumber;
   var ArrCodeParm      = TArray();
   var Income15         = TArray();
   var RateIndex = -1;

   private var i = 0;
   private var j = 0;
   private var j1 = 0;
   private var k = 0;
   while(i < _ArrCodeParm.Size)
      j = 0;
      j1 = 0;
      RateIndex = -1;
      while(j < _ArrCodeParm[i].NPTXCodeParmArr.Size)
         RateIndex = AddInArrCodeParms(ArrCodeParm, _ArrCodeParm[i].NPTXCodeParmArr[j].Month, _ArrCodeParm[i].NPTXCodeParmArr[j].PScode,
                                       _ArrCodeParm[i].NPTXCodeParmArr[j].PSnnn, NULL/*_ArrCodeParm[i].NPTXCodeParmArr[j].MSCode*/,
                                       _ArrCodeParm[i].NPTXCodeParmArr[j].GetMinusSum(), 0.0, 0.0, 0.0, 0.0, 0.0, _ArrCodeParm[i].Rate,
                                       _ArrCodeParm[i].NPTXCodeParmArr[j].ЧНБ, 0.0, 0.0, 0.0, _ArrCodeParm[i].IsHighRate, 0.0, _ArrCodeParm[i].DepoMinus, _ArrCodeParm[i].NPTXCodeParmArr[j].IsShow, NULL, 
                                       ((_ArrCodeParm[i].NPTXCodeParmArr[j].PScode == NULL) AND (_ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes.Size > 0)),_ArrCodeParm[i].RateType, _ArrCodeParm[i].NPTXCodeParmArr[j].NOBKind);

         if(RateIndex >= 0)
            k = 0;
            while(k < _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes.Size)
               ArrCodeParm[RateIndex].NPTXCodeParmArr[j1].MinusCodes[ArrCodeParm[RateIndex].NPTXCodeParmArr[j1].MinusCodes.Size] = NPTXMinusCodeParm(
                  _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].MSCode, _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].MSnnn, _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].IsShow);
               k = k + 1;
            end;
            
            j1 = j1 + 1;
         end;

         j = j + 1;
      end;

      if(j == 0)
         ArrCodeParm[ArrCodeParm.Size] = NPTXRateParm(0, NULL, _ArrCodeParm[i].PlusSum, NULL, _ArrCodeParm[i].MinusSum, _ArrCodeParm[i].TaxBaseSum, _ArrCodeParm[i].TaxCalculated,
                                                      _ArrCodeParm[i].TaxPaid, _ArrCodeParm[i].TaxToReturnDue, _ArrCodeParm[i].TaxDue, _ArrCodeParm[i].Rate, 0.0,
                                                      _ArrCodeParm[i].DivPlus, _ArrCodeParm[i].TaxCalculatedDiv, _ArrCodeParm[i].TaxOver,
                                                      _ArrCodeParm[i].IsHighRate, _ArrCodeParm[i].Znp, _ArrCodeParm[i].DepoMinus);
      else
         if(RateIndex >= 0)
            ArrCodeParm[RateIndex].TaxBaseSum = _ArrCodeParm[i].TaxBaseSum;
            ArrCodeParm[RateIndex].TaxCalculated = _ArrCodeParm[i].TaxCalculated;
            ArrCodeParm[RateIndex].TaxPaid = _ArrCodeParm[i].TaxPaid;
            ArrCodeParm[RateIndex].TaxToReturnDue = _ArrCodeParm[i].TaxToReturnDue;
            ArrCodeParm[RateIndex].TaxDue = _ArrCodeParm[i].TaxDue;
            ArrCodeParm[RateIndex].DivPlus = _ArrCodeParm[i].DivPlus;
            ArrCodeParm[RateIndex].TaxCalculatedDiv = _ArrCodeParm[i].TaxCalculatedDiv;
            ArrCodeParm[RateIndex].TaxOver = _ArrCodeParm[i].TaxOver;
            ArrCodeParm[RateIndex].Znp = _ArrCodeParm[i].Znp;
            ArrCodeParm[RateIndex].DepoMinus = _ArrCodeParm[i].DepoMinus;
            //после доработки множественности кодов вычета, потерялось суммирование
            //плюс - для единобразия
            ArrCodeParm[RateIndex].MinusSum = _ArrCodeParm[i].MinusSum;
            ArrCodeParm[RateIndex].PlusSum = _ArrCodeParm[i].PlusSum;
            if (_ArrCodeParm[RateIndex].Income15.size > 0)
              ArrCodeParm[RateIndex].Income15 = _ArrCodeParm[i].Income15;
            end;
         end;
      end;
      i = i + 1;
   end;
END;

var GeneralNOBSums = TArray();
var HighRateNOBSums = TArray();

CLASS (NPTXRepCalc_NPTXPIT6) NPTXRepCalc_NPTXPIT6_NEW_2(_Investors, _BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS, IsPart2:BOOL)
   m_PersnIdcMain = TBFile("persnidc.dbt");
   m_ArrCodeParms = TArray();
   private var m_MinusG_618_Store;
   private var m_MinusG_619_Store;
   private var m_cmd;
   
   m_count = 0;

   MACRO ClearData()
      m_Pg = NULL;
      m_Pm = NULL;
      m_Ps = NULL;
      m_Pp = NULL;
      m_PersnIdcMain.Clear();
      m_TaxCalculated = $0.0;
      m_PlusSum = $0.0;
      m_MinusSum = $0.0;
      m_ResidenceStatus = -1;

      var i = 0;
      while(i < m_ArrCodeParms.Size)
        m_ArrCodeParms[i].NPTXCodeParmArr.Size = 0;
        i = i + 1;
      end;
      m_ArrCodeParms.Size = 0;

      m_MinusG_618 = null;
      m_MinusG_619 = null;
   END;

   MACRO MinusG_618(ClientId, infRate, ResidenceStatus)
      var key = string(infRate) + "_" + ClientId;
      var MinusG_618;
      m_MinusG_618_Store = IIF((ValType(m_MinusG_618_Store) != V_UNDEF), m_MinusG_618_Store, TArray());
      var idx = DL_FindKeyPairInArr(m_MinusG_618_Store, key);
      if (idx == -1)
         if( (infRate == INFORATE_TOTAL) and (ResidenceStatus == 1) )
            MinusG_618 = GetRubSumByClientOperDocKind(ClientId, string(TXOBJ_MINUSG_618), date(1,1,m_CurrYear), m_RepDate, DL_CALCNDFL, null, GetTypeContract()) + //созданные в операциях расчета НОБ
                         GetRubSumByClientOperDocKind(ClientId, string(TXOBJ_MINUSG_618), date(1,1,m_CurrYear), m_RepDate, 0 /*только пользовательские*/, null, GetTypeContract());
         else
            MinusG_618 = $0;
         end;
         idx = m_MinusG_618_Store.size;
         m_MinusG_618_Store[idx] = DL_KeyPair(key,ExtRound(MinusG_618));
      end;
      return m_MinusG_618_Store[idx].Value;
   END;

   MACRO MinusG_619(ClientId, infRate, ResidenceStatus)
      var key = string(infRate) + "_" + ClientId;
      var MinusG_619;
      m_MinusG_619_Store = IIF((ValType(m_MinusG_619_Store) != V_UNDEF), m_MinusG_619_Store, TArray());
      var idx = DL_FindKeyPairInArr(m_MinusG_619_Store, key);
      if (idx == -1)
         if ((m_InfoRate == INFORATE_TOTAL) and (ResidenceStatus == 1) 
             and (IIS_CONTRACTS == SET_CHAR))
           MinusG_619 = GetRubSumByClientOperDocKind(ClientId,
                                                     string(TXOBJ_MINUSG_619),
                                                     date(1,1,m_CurrYear),
                                                     m_RepDate,
                                                     DL_CALCNDFL,
                                                     null,
                                                     1)
                        + GetRubSumByClientOperDocKind(ClientId,
                                                       string(TXOBJ_MINUSG_619),
                                                       date(1,1,m_CurrYear),
                                                       m_RepDate,
                                                       0,
                                                       null,
                                                       1);
         else
           MinusG_619 = $0;
         end;
         idx = m_MinusG_619_Store.size;
         m_MinusG_619_Store[idx] = DL_KeyPair(key,ExtRound(MinusG_619));
      end;
      return m_MinusG_619_Store[idx].Value;
   END;

   MACRO Init(Investor, BeginDate, EndDate, IsConsiderCB, IsConsiderDepo, IsConsiderVS)
      m_RepDate = m_EndDate = EndDate;
      m_Investor = Investor;
      m_CurrSign = 0;
  
      if(IsConsiderCB != null)
         m_IsConsiderCB = IsConsiderCB;
      end;
  
      if(IsConsiderDEPO != null)
         m_IsConsiderDEPO = IsConsiderDEPO;
      end;
  
      if(IsConsiderVS != null)
         m_IsConsiderVS = IsConsiderVS;
      end;

      DateSplit(m_RepDate, null, null, m_CurrYear);
  
      m_BeginDate = date(1, 1, m_CurrYear);

      m_query = " SELECT "
                  + " pt.t_PartyID "
                 + " ,pt.t_NotResident "
                 + " ,persn.t_Name1 AS Name1 "
                 + " ,persn.t_Name2 AS Name2 "
                 + " ,persn.t_Name3 AS Name3 "
                 + " ,persn.t_Born AS BirthDate "
                 + " ,persn.t_BirsPlase "
                 + " ,NVL((CASE "
                           + " WHEN pt.t_NRCountry <> CHR(1) "
                           + " THEN "
                               + " (SELECT "
                                    + " cn.t_CodeNum3 "
                                + " FROM "
                                    + " dcountry_dbt cn "
                                + " WHERE "
                                    + " cn.t_CodeLat3 = pt.t_NRCountry) "
                           + " ELSE "
                               + " CHR(1) "
                       + " END), CHR(1)) AS t_Citizenship "
                 + " ,NVL((CASE "
                           + " WHEN pt.t_NotResident = 'X' "
                             + " OR (pt.t_NRCountry <> CHR(1) "
                            +  " AND pt.t_NRCountry <> 'RUS') "
                           + " THEN "
                               + " (SELECT "
                                    + " cn.t_CodeNum3 "
                                + " FROM "
                                    + " dadress_dbt adr "
                                   + " ,dcountry_dbt cn "
                                + " WHERE "
                                    + " adr.t_PartyID = pt.t_PartyID "
                                + " AND adr.t_Type = " + PTADDR_REAL + " "
                                + " AND adr.t_Country <> CHR(1) "
                                + " AND cn.t_CodeLat3 = adr.t_Country) "
                           + " ELSE "
                               + " CHR(1) "
                       + " END), CHR(1)) AS t_ResidenceCountry "
                 + " ,NVL((CASE "
                           + " WHEN pt.t_NotResident = 'X' "
                             + " OR (pt.t_NRCountry <> CHR(1) "
                             + " AND pt.t_NRCountry <> 'RUS') "
                           + " THEN "
                               + " (SELECT "
                                    + " adr.t_Adress "
                                + " FROM "
                                    + " dadress_dbt adr "
                                + " WHERE "
                                    + " adr.t_PartyID = pt.t_PartyID "
                                + " AND adr.t_Type = " + PTADDR_REAL + ") "
                           + " ELSE "
                               + " CHR(1) "
                       + " END), CHR(1)) AS t_ResidenceAdress "
                 + " ,NVL((SELECT "
                           + " objcode.t_Code "
                       + " FROM "
                           + " dobjcode_dbt objcode "
                       + " WHERE "
                           + " objcode.t_ObjectType = " + OBJTYPE_PARTY + " "
                       + " AND objcode.t_CodeKind = " + PTCK_INN + " "
                       + " AND objcode.t_ObjectID = pt.t_PartyID "
                       + " AND objcode.t_State = 0), CHR(1)) AS t_ClientINN "
                 + " ,COUNT(1) OVER () AS COUNT "
                 + " , ("
                       + "CASE "
                       + "WHEN EXISTS(SELECT 1 "
                                   + "FROM DSFCONTR_DBT sfcontr "
                                   + "WHERE sfcontr.T_PARTYID = pt.t_PartyID "
                                   + "  AND sfcontr.T_SERVKIND = 7 "
                                   + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_RepDate)
                                   + "  AND ( "
                                   + "         sfcontr.T_DATECLOSE >= " + GetSQLDate(m_RepDate)
                                   + "      OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy') "
                                   + "      ) "
                                   + ") "
                 + "       AND NOT EXISTS(SELECT 1 "
                                       + "FROM DSFCONTR_DBT sfcontr, DDLCONTR_DBT dlcontr "
                                       + "WHERE sfcontr.T_PARTYID = pt.t_PartyID"
                                       + "  AND dlcontr.t_SfContrID = sfcontr.t_ID "
                                       + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_RepDate)
                                       + "  AND ( "
                                       + "         sfcontr.T_DATECLOSE >= " + GetSQLDate(m_RepDate)
                                       + "      OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy')"
                                       + "      ) "
                                       + ") "
                       + "THEN 1 "
                       + "ELSE 0 "
                       + "END "
                 + "   ) as t_IsDepoClient"
                 + " ,max(q.t_OperDate) as t_MaxOperDate "
              + " FROM "
                  + " dparty_dbt pt "
                  + " inner join dpersn_dbt persn "
                  + " on persn.t_PersonID = pt.t_PartyID "
                  + " inner join "
                  + " ( "
                  + "    select nptxop.t_OperDate, nptxop.t_Client as t_ClientID "
                  + "    from dnptxop_dbt nptxop "
                  + "    where nptxop.t_OperDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate)
                  + "      and nptxop.t_Status > 0 "
                  + "      and ( "
                  + "             ( "
                  + "                nptxop.t_DocKind = " + string(DL_WRTMONEY)
                  + "                and nptxop.t_SubKind_Operation = " + string(DL_NPTXOP_WRTKIND_WRTOFF)
                  + "             ) "
                  + "          or ( "
                  + "                nptxop.t_DocKind = " + string(DL_CALCNDFL)
                  + "                and nptxop.t_SubKind_Operation in( " + string(DL_TXBASECALC_OPTYPE_ENDYEAR) + ", "
                                                                          + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS)
                                                                   + ") "
                  + "             ) "
                  + "          ) "
                  + "    union "
                  + "    select tick.t_DealDate as t_OperDate, tick.t_ClientID "
                  + "    from ddl_tick_dbt tick "
                  + "    where tick.t_DealDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) /*6, 7*/
                  + "      and tick.t_DealStatus > 0 "
                  + "      and ( "
                  + "             ( "
                  + "                tick.t_BOfficeKind = " + string(DL_AVRWRT)
                  + "                and tick.t_DealType = 2010 "
                  + "             ) "
                  + "          or ( "
                  + "                tick.t_BOfficeKind = " + string(DL_RETIREMENT_OWN)
                  + "                and tick.t_DealType = 2052 "
                  /*+ "                and exists( "
                  + "                             select 1 "
                  + "                             from dnptxobj_dbt obj "
                  + "                             where obj.t_AnaliticKind1 = 1020 "
                  + "                               and obj.t_Analitic1 = tick.t_DealID "
                  + "                          ) "*/
                  + "             ) "
                  + "          or ( "
                  + "                tick.t_BOfficeKind = " + string(DL_RETURN_DIVIDEND)
                  + "                and tick.t_DealType = 12108 "
                  /*+ "                and exists( "
                  + "                             select 1 "
                  + "                             from dnptxobj_dbt obj "
                  + "                             where obj.t_AnaliticKind1 = 1100 "
                  + "                               and obj.t_Analitic1 = tick.t_DealID "
                  + "                          ) "*/
                  + "             ) "
                  + "          ) "
                  + "      union "
                  + "      select dl_order.t_SignDate as t_OperDate, dl_order.t_Contractor as t_ClientID "
                  + "      from ddl_order_dbt dl_order "
                  + "      where dl_order.t_SignDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) /*11, 12*/
                  + "        and dl_order.t_DocKind = " + string(DL_VEKSELDRAWORDER)
                  + "        and dl_order.t_Kind_Operation = " + string(VSOP_REPAY)
                  + "        and dl_order.t_ContractStatus > 0 "
                  + " ) q "
                  + " on q.t_ClientID = pt.t_PartyID "
               + " WHERE "
                  + " pt.t_LegalForm = " + legal_form_phys + " "
              + " AND (1 = " + IIF(m_IsConsiderCB, 1, 0) + " "
               + " AND (EXISTS (SELECT "
                               + " 1 "
                           + " FROM "
                               + " dnptxop_dbt txop "
                           + " WHERE "
                               + " txop.t_DocKind = " + DL_CALCNDFL + " "
                           + " AND txop.t_OperDate BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + " AND txop.t_Client = pt.t_PartyID "
                           + "    AND EXISTS "
                           + "    (SELECT 1 "
                           + "    FROM dnptxobdc_dbt dc, dnptxobj_dbt txobj "
                           + "   WHERE dc.t_docid =  txop.t_id  "
                           + "   AND dc.t_objid = txobj.t_objid "
                           + "   AND txobj.t_level >= 5 "
                           + "   AND txobj.t_kind IN "
                           + "        (SELECT DISTINCT "
                           + "                kind.t_element "
                           + "           FROM dnptxkind_dbt kind "
                           + "          WHERE LOWER (t_code) LIKE "
                           + "                   ('plus%')) "
                           + "   AND txobj.t_Sum > 0 "
                           + " )) "
                           + " OR EXISTS  "
                           + "        (SELECT 1  "
                           + "           FROM dnptxobj_dbt obj  "
                           + "          WHERE     obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                                                  TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                                                  TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                           + "                                   )"
                           + "                AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + "                AND obj.t_Client = pt.t_PartyID  "
                           + "                AND obj.t_User <> 'X'  "
                           + "                AND EXISTS  "
                           + "                        (SELECT 1  "
                           + "                           FROM dnptxobdc_dbt odc,  "
                           + "                                dnptxop_dbt  txop  "
                           + "                          WHERE     odc.t_ObjID =  "
                           + "                                    obj.t_ObjID  "
                           + "                                AND txop.t_ID =  "
                           + "                                    odc.t_DocID  "
                           + "                                AND txop.t_DocKind = "+string(DL_CALCNDFL)+")  "
                           + "                AND obj.t_FromOutSyst <> 'X')  "
                           + " OR EXISTS  "
                           + "        (SELECT 1  "
                           + "           FROM dnptxobj_dbt obj  "
                           + "          WHERE     obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                                                  TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                                                  TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                           + "                                   )"
                           + "                AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + "                AND obj.t_Client = pt.t_PartyID  "
                           + "                AND obj.t_User = 'X'  "
                           + "                AND obj.t_FromOutSyst <> 'X')  "
                           + " OR EXISTS  "
                           + "        (SELECT 1  "
                           + "           FROM dnptxobj_dbt obj  "
                           + "          WHERE     obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                                                  TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                                                  TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                           + "                                   )"
                           + "                AND obj.t_Client = pt.t_PartyID  "
                           + "                AND obj.t_User <> 'X'  "
                           + "                AND EXISTS  "
                           + "                        (SELECT 1  "
                           + "                           FROM dnptxobdc_dbt odc,  "
                           + "                                dnptxop_dbt  txop  "
                           + "                          WHERE     odc.t_ObjID =  "
                           + "                                    obj.t_ObjID  "
                           + "                                AND txop.t_ID =  "
                           + "                                    odc.t_DocID  "
                           + "                                AND txop.t_DocKind = "+string(DL_HOLDNDFL)
                           + "                                AND txop.t_PrevDate =  " + GetSQLDate(m_BeginDate) + " )"
                           + "                AND obj.t_FromOutSyst <> 'X')  "
                           + " OR EXISTS  "
                           + "        (SELECT 1  "
                           + "           FROM dnptxobj_dbt obj  "
                           + "          WHERE     obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                                                  TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                                                  TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                           + "                                   )"
                           + "                AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + "                AND obj.t_Client = pt.t_PartyID  "
                           + "                AND obj.t_User <> 'X'  "
                           + "                AND EXISTS  "
                           + "                        (SELECT 1  "
                           + "                           FROM dnptxobdc_dbt odc,  "
                           + "                                dnptxop_dbt  txop  "
                           + "                          WHERE     odc.t_ObjID =  "
                           + "                                    obj.t_ObjID  "
                           + "                                AND txop.t_ID =  "
                           + "                                    odc.t_DocID  "
                           + "                                AND txop.t_DocKind = "+string(DL_WRTMONEY)+")  "
                           + "                AND obj.t_FromOutSyst <> 'X')  "
                           + " OR EXISTS  "
                           + "        (SELECT 1  "
                           + "           FROM dnptxobj_dbt obj  "
                           + "          WHERE     obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                                                  TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS
                           + "                                   )"
                           + "                AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + "                AND obj.t_Client = pt.t_PartyID  "
                           + "                AND obj.t_User <> 'X'  "
                           + "                AND obj.t_AnaliticKind1 = 1020  "
                           + "                AND EXISTS  "
                           + "                        (SELECT 1  "
                           + "                           FROM ddl_tick_dbt dl_tick  "
                           + "                          WHERE     dl_tick.t_DealID =  "
                           + "                                    obj.t_Analitic1  "
                           + "                                AND dl_tick.t_BOfficeKind =  "
                           + "                                    "+string(DL_RETIREMENT_OWN)+")  "
                           + "                AND obj.t_FromOutSyst <> 'X')  "
                           + " OR EXISTS  "
                           + "        (SELECT 1  "
                           + "           FROM dnptxobj_dbt obj  "
                           + "          WHERE     obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                                                  TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS
                           + "                                   )"
                           + "                AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + "                AND obj.t_Client = pt.t_PartyID  "
                           + "                AND (EXISTS  "
                           + "                         (SELECT 1  "
                           + "                            FROM dnptxobdc_dbt dc,  "
                           + "                                 doproper_dbt opr  "
                           + "                           WHERE     dc.t_ObjID =  "
                           + "                                     obj.t_ObjID  "
                           + "                                 AND opr.t_ID_Operation =  "
                           + "                                     dc.t_DocID  "
                           + "                                 AND opr.t_DocKind IN ("+string(DL_VEKSELDRAWORDER)+", "+string(DL_VSBARTERORDER)+", "+string(DL_VSINTERCHANGE)+"))))  "
                    + " ) "
               + "  OR  ("
                    + " EXISTS (SELECT "
                                + " 1 "
                            + " FROM "
                                + " dnptxobj_dbt txobj "
                            + " WHERE "
                                + " ("
                                   + " ("
                                      + " pt.t_NotResident = 'X' "
                                      + " and txobj.t_Kind IN ("
                                                               + TXOBJ_BASEMATERIAL + ", "
                                                               + TXOBJ_BASEMATERIAL_IIS + ", "
                                                               + TXOBJ_BASEGENERAL + ", "
                                                               + TXOBJ_BASEGENERAL_IIS + ", "
                                                               + TXOBJ_BASESPECIAL + ", "
                                                               + TXOBJ_BASESPECIAL_IIS
                                                           + ") "
                                   + " )"
                                   + " or txobj.t_Kind IN ("
                                                          + TXOBJ_BASESPECIAL + ", "
                                                          + TXOBJ_BASESPECIAL_IIS + ", "
                                                          + TXOBJ_BASEG1 + ", "
                                                          + TXOBJ_BASEG2 + ", "
                                                          + TXOBJ_BASEG3 + ", "
                                                          + TXOBJ_BASEG4 + ", "
                                                          + TXOBJ_BASEG5 + ", "
                                                          + TXOBJ_BASEG6 + ", "
                                                          + TXOBJ_BASEG7 + ", "
                                                          + TXOBJ_BASEG8 + ", "
                                                          + TXOBJ_BASEG9
                                   + "                    )"
                                + " )"
                            + " AND (txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                              + " OR txobj.t_Analitickind6 = 0) "
                            + " AND txobj.t_Client = pt.t_PartyID "
                            + " AND txobj.t_FromOutSyst <> 'X'"
                            + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                            + " AND txobj.t_Sum > 0) "
                     + ") "
                + " OR 1 = " + IIF(m_IsConsiderDEPO, 1, 0) + " "
                + " AND EXISTS (SELECT "
                                + " 1 "
                            + " FROM "
                                + " dnptxobj_dbt txobj "
                            + " WHERE "
                                + " ("
                                   + " ("
                                      + " pt.t_NotResident = 'X'"
                                      + " and txobj.t_Kind IN ("
                                                               + TXOBJ_BASEMATERIAL + ", "
                                                               + TXOBJ_BASEMATERIAL_IIS + ", "
                                                               + TXOBJ_BASEGENERAL + ", "
                                                               + TXOBJ_BASEGENERAL_IIS + ", "
                                                               + TXOBJ_BASESPECIAL + ", "
                                                               + TXOBJ_BASESPECIAL_IIS
                                                               + IIF(m_EndDate < Date(1, 1, 2021), ", " + TXOBJ_BASESPECIAL_DIV, "")
                                                           + ") "
                                   + " )"
                                   + " or txobj.t_Kind IN ("
                                                            + TXOBJ_BASESPECIAL + ", "
                                                            + TXOBJ_BASESPECIAL_IIS + ", "
                                                            + TXOBJ_BASEG1 + ", "
                                                            + TXOBJ_BASEG2 + ", "
                                                            + TXOBJ_BASEG3 + ", "
                                                            + TXOBJ_BASEG4 + ", "
                                                            + TXOBJ_BASEG5 + ", "
                                                            + TXOBJ_BASEG6 + ", "
                                                            + TXOBJ_BASEG7 + ", "
                                                            + TXOBJ_BASEG8 + ", "
                                                            + TXOBJ_BASEG9
                                      + "                )"
                            + " )"
                            + " AND (txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                              + " OR txobj.t_Analitickind6 = 0) "
                            + " AND txobj.t_Client = pt.t_PartyID "
                            + " AND txobj.t_FromOutSyst <> 'X'"
                            + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                            + " AND txobj.t_Sum > 0) "
                + " OR 1 = " + IIF(m_IsConsiderVS, 1, 0) + " "
               + " AND EXISTS (SELECT "
                               + " 1 "
                           + " FROM "
                               + " dnptxobj_dbt txobj "
                           + " WHERE "
                               + " txobj.t_Kind IN (" + TXOBJ_BASEBILL + ") "
                           + " AND txobj.t_Client = pt.t_PartyID "
                           + " AND txobj.t_FromOutSyst <> 'X'"
                           + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                           + " AND txobj.t_Sum > 0) "
                + IIF(m_RepDate == date(31,12,2022), "OR Exists(SELECT 1 FROM DNPTXDIAS_DBT ds WHERE ds.t_ClientID = pt.t_PartyID AND ds.t_IIS <> 'X') ", "")
              +") "
              + " AND (1 = " + IIF(((ValType(Investor) != V_GENOBJ) and (Investor > 0)) or ((ValType(Investor) == V_GENOBJ) and (Investor[0] > 0)), 0, 1) + IIF(ValType(Investor) != V_GENOBJ, " OR pt.t_PartyID = " + Investor, " OR pt.t_PartyID in (");
              if((ValType(Investor) == V_GENOBJ) and (Investor[0] > 0))
                 m_query = m_query + Investor[0];
                 var i = 1;
                 while(i < Investor.Size())
                    m_query = m_query + ", " + Investor[i];
                    i = i + 1;
                 end;
                 m_query = m_query + ")";
              end;
              m_query = m_query + ") "
              + " GROUP BY "
                  + " pt.t_PartyID "
                 + " ,pt.t_NotResident "
                 + " ,persn.t_Name1 "
                 + " ,persn.t_Name2 "
                 + " ,persn.t_Name3 "
                 + " ,persn.t_Born "
                 + " ,persn.t_BirsPlase "
                 + " ,pt.t_NRCountry "
              + " ORDER BY "
                  + " persn.t_Name1 ASC "
                 + " ,persn.t_Name2 ASC "
                 + " ,persn.t_Name3 ASC ";

      m_cmd = DL_RSDCommand(m_query);
      m_count = m_cmd.GetCount();
   END;

   MACRO Next():BOOL
      if(m_RS == NULL)
         m_RS = m_cmd.Execute();
      end;
      return m_RS.MoveNext();
   END;

   MACRO Count():Integer
      return m_count;
   END;

   MACRO OurKPP():String
      var ErrCode = 0;
      var RegVal = false;
      PRIVATE RECORD OurBankRec("party.dbt");

      GetRegistryValue("COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ", V_BOOL, RegVal, ErrCode);

      if(ErrCode == 0)
         if(RegVal)
            if(ПолучитьСубъекта({OurBank}, OurBankRec) == 0)
               var str = String(ReadNoteForObject(OBJTYPE_PARTY, UniID(OurBankRec, OBJTYPE_PARTY), 79, m_RepDate));
               var SlashIndex = Index(str, "/");
               if(SlashIndex > 0)
                  return SubStr(str, 1, SlashIndex-1);
               end;

               return str;
            else
               MsgBox("Ошибка получения субъекта " + {OurBank});
               return OurKPP();
            end;
         else
            return OurKPP();
         end;
      else
         MsgBox("Ошибка чтения значения настройки \"COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ\". Код " + ErrCode);
         return OurKPP();
      end;
   END;

   MACRO OurFNSCode():String
      var ErrCode = 0;
      var RegVal = false;
      PRIVATE RECORD OurBankRec("party.dbt");

      GetRegistryValue("COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ", V_BOOL, RegVal, ErrCode);

      if(ErrCode == 0)
         if(RegVal)
            if(ПолучитьСубъекта({OurBank}, OurBankRec) == 0)
               var str = String(ReadNoteForObject(OBJTYPE_PARTY, UniID(OurBankRec, OBJTYPE_PARTY), 79, m_RepDate));
               var SlashIndex = Index(str, "/");
               if(SlashIndex > 0)
                  return SubStr(str, SlashIndex + 1);
               end;

               return str;
            else
               MsgBox("Ошибка получения субъекта " + {OurBank});
               return OurFNSCode();
            end;
         else
            return OurFNSCode();
         end;
      else
         MsgBox("Ошибка чтения значения настройки \"COMMON\\НДФЛ\\ИФНС ПО МЕСТУ НАХОЖ. ДЛЯ 6-НДФЛ\". Код " + ErrCode);
         return OurKPP();
      end;
   END;

   PRIVATE MACRO GetEndDayOfMonth(Month, Year)
      if((Month == 1) or (Month == 3)  or (Month == 5)  or (Month == 7) or (Month == 8)  or (Month == 10) or (Month == 12))
         return date(31, Month, Year);
      elif((Month == 2) and (Int(double(Year) / 4) != double(Year) / 4))
         return date(28, Month, Year);
      elif((Month == 2) and (Int(double(Year) / 4) == double(Year) / 4))
         return date(29, Month, Year);
      elif((Month == 4) or (Month == 6) or (Month == 9) or (Month == 11))
         return date(30, Month, Year);
      end;

      return date(0, 0, 0);
   END;

   PRIVATE MACRO RecalcNOB(PayerInfo, RateIndex, RateVal)
     var NOBSum = $0;
     var i = -1;
     var bufSum = $0;
     PayerInfo.ArrCodeParm[RateIndex].PlusSum = $0;
     PayerInfo.ArrCodeParm[RateIndex].MinusSum = $0;
     PayerInfo.ArrCodeParm[RateIndex].TaxBaseSum = $0;
     while ((i=i+1) < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.size)
       NOBSum = NOBSum + (ExtRound(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn) - PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum(NULL, true));
       PayerInfo.ArrCodeParm[RateIndex].PlusSum = PayerInfo.ArrCodeParm[RateIndex].PlusSum + ExtRound(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn);
       PayerInfo.ArrCodeParm[RateIndex].MinusSum = PayerInfo.ArrCodeParm[RateIndex].MinusSum + PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum(NULL, true);
     end;
     if ((PayerInfo.ArrCodeParm[RateIndex].TaxPaid != $0) and (PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue != 0))
       bufSum = PayerInfo.ArrCodeParm[RateIndex].TaxPaid - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue;
       PayerInfo.ArrCodeParm[RateIndex].TaxPaid = IIF(bufSum > $0, ABS(bufSum), $0);
       PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue = IIF(bufSum < $0, ABS(bufSum), $0);
     end;
     PayerInfo.ArrCodeParm[RateIndex].TaxBaseSum = NOBSum;
     PayerInfo.ArrCodeParm[RateIndex].TaxCalculated = ExtRound(NOBSum) * RateVal / 100.0;
     PayerInfo.ArrCodeParm[RateIndex].TaxDue = ExtRound(PayerInfo.ArrCodeParm[RateIndex].TaxCalculated,0) 
                + ExtRound(-PayerInfo.ArrCodeParm[RateIndex].TaxPaid - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue,0);
     if(PayerInfo.ArrCodeParm[RateIndex].TaxDue >= 0)
       PayerInfo.ArrCodeParm[RateIndex].TaxOver = 0;
     else
       PayerInfo.ArrCodeParm[RateIndex].TaxOver = -PayerInfo.ArrCodeParm[RateIndex].TaxDue;
       PayerInfo.ArrCodeParm[RateIndex].TaxDue = 0;
     end;
     
   END;

   PRIVATE MACRO GetNOBSum(PayerInfo, RateIndex, indexCode)
      var i = 0;
      var sum = 0;

      while(i <= indexCode)
         if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSCode == PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[indexCode].PSCode)
            sum = sum + PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn - PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum();
         end;

         i = i + 1;
      end;

      return sum;  
   END;

   PRIVATE MACRO GetNOBSumByPSAndMonth(PayerInfo, RateIndex, PSCode, Month)
      var i = 0;
      var sum = 0;

      while(i < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.size)
         if((PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSCode == PSCode) and (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].Month <= Month))
            sum = sum + PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn - PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum();
         end;

         i = i + 1;
      end;

      return sum;  
   END;

   PRIVATE MACRO IsLastElemOfNOBKind(RateParm, index)
      var i = index + 1;

      while(i < RateParm.NPTXCodeParmArr.Size)
         if(RateParm.NPTXCodeParmArr[i].PSCode == RateParm.NPTXCodeParmArr[index].PSCode)
            return false;
         end;
         i = i + 1;
      end;

      return true;
   END;

   PRIVATE MACRO DeleteFromNOBKinds(RateParm:@NPTXRateParm, index)
      var i = index;
      while(i < RateParm.NPTXCodeParmArr.Size - 1)
         RateParm.NPTXCodeParmArr[i] = RateParm.NPTXCodeParmArr[i + 1];
         i = i + 1;
      end;

      RateParm.NPTXCodeParmArr.Size = RateParm.NPTXCodeParmArr.Size - 1;
   END;

   MACRO CalcNPTXPIT2General(PayerInfo:@NPTXPayerInfo, PlusSumPrm:@MONEY, TaxBasePrm:@MONEY, PlusSumHighPrm:@MONEY, TaxBaseHighPrm:@MONEY)
      var PlusSum = $0, MinusSum = $0, PlusSum15 = $0, MinusSum15 = $0, TaxBase15 = $0;
      var indexTotal = IndexOfRate(PayerInfo.ArrCodeParm, 13, false);
      var indexHigh = IndexOfRate(PayerInfo.ArrCodeParm, 15, true);
      var i = 0, j = 0, k = 0, l = 0, j2 = 0;
      var codeBufPlusSums = TArray();
      var codeBufMinusSums = TArray();
      var codeBuf = TArray();
      var odBuf = Tarray();
      var sortedArr = TArray();
      var bufIdx = -1;
      var totalRecBuf = null;
      var MSnnn = $0, OD = $0, calcOD = $0, bufOD = $0;
      var minusFind = false;
      var OD2 = $0;
      var D15 = $0;
      var NOBSum = $0;
      var mnsSum = $0;
      var fromIndex, toIndex;

      //проверка на отрицательные суммы и "схлопывание"
      if (indexTotal >= 0)
        i = -1;
        while ((i=i+1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.Size)
          totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
          if (totalRecBuf.PSnnn < 0.0)
            codeBuf[codeBuf.size] = CollapseStruct(i, totalRecBuf.PSCode, totalRecBuf.PSnnn);
          end;

          j=-1;
          while ((j=j+1) < totalRecBuf.MinusCodes.Size)
            if (totalRecBuf.MinusCodes[j].MSnnn < 0.0)
              codeBuf[codeBuf.size] = CollapseStruct(i, totalRecBuf.MinusCodes[j].MSCode, totalRecBuf.MinusCodes[j].MSnnn, j);
            end;
          end;
        end;
      end;
      
      MACRO MaxOperDate()
         return Date(m_RS.MaxOperDate);
      END;

      if (indexTotal >= 0)
        i = -1;
        while ((i = i + 1) < codeBuf.size)
          if (not codeBuf[i].IsMinus)
            sortedArr = MakeSortedPlusByCodeAndSum(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr, codeBuf[i].Code);
          else
            sortedArr = MakeSortedMinusByCodeAndSum(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr, codeBuf[i].Code);
          end;
          j = -1;
          while ((j=j+1) < sortedArr.size)
            codeBuf[i].Sum = codeBuf[i].Sum + sortedArr[j].Sum;
            if (ExtRound(codeBuf[i].Sum) >= $0)
              if (not codeBuf[i].IsMinus)
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = codeBuf[i].Sum;
                //если он вдруг нулевой, то его "стираем"
                if (ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn) == 0)
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL;
                end;
              else
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx].MSnnn = codeBuf[i].Sum;
                //если он вдруг нулевой, то его "стираем"
                if (ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx].MSnnn) == $0)
                  //пока делаем просто null чтобы не сбить индексы
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx] = NULL;
                end;
              end;

              while ((j=j-1) >= 0)
                if (not codeBuf[i].IsMinus)
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = 0.0;
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL; 
                else
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx] = NULL;
                end;
              end;
              if (not codeBuf[i].IsMinus)
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].PSnnn = 0.0;
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].PSCode = NULL; 
              else
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].MinusCodes[codeBuf[i].SubIdx] = NULL;
              end;
              RemoveFromArrByIdx(@codeBuf,i);
              i=i-1;
              break;
            end;
          end;
        end;

        //подчищаем null значения в minuscodes
        i = -1;
        while ((i = i + 1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.size)
          if (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes != NULL)
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes = filter(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes);
          end;
        end;
      end;

      var oldArr;
      //проверка на отрицательный ОД (остаток доходов, т.е. доход минус вычеты), и перенос излишних вычетов в предыдущие (или следующие) месяцы
      if (indexTotal >= 0)
        //делаем полную копию NPTXCodeParmArr по значениям
        oldArr = MakeCopyNPTXCodeParmArr(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr);

        i = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.Size;
        while ((i=i-1) >= 0)
          totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
          if (not totalRecBuf.IsShow)
            continue;
          end;

          MSnnn = totalRecBuf.GetMinusSum(true);

          if (ExtRound(totalRecBuf.PSnnn - MSnnn) < $0)
            var psCode = totalRecBuf.PSCode;
            if (psCode == NULL)
              k = -1;
              while ((k = k + 1) < GetCodeGroupsValue().size)
                if (find(GetCodeGroupsValue()[k],totalRecBuf.MinusCodes[0].MSCode) != -1)
                  psCode = GetCodeGroups()[k].Key;
                  break;
                end;
              end;
            end;
            odBuf[odBuf.size] = MinusMoveStruct(totalRecBuf.PSnnn, psCode, i, totalRecBuf.MinusCodes);
          end;
        end;

        i = -1;
        while ((i=i+1) < odBuf.size)
          //j2 = 0;
          j=odBuf[i].Idx;
          while (((j=j-1) >= 0) and (j != odBuf[i].Idx))
            totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j];
            if ((totalRecBuf.PSCode != NULL) and (totalRecBuf.PSCode == odBuf[i].PlusCode))
              MSnnn = totalRecBuf.GetMinusSum(true);

              OD2 = totalRecBuf.PSnnn - MSnnn;

              j2 = -1;

              while (((j2=j2+1) < odBuf[i].MinusCodes.size) and (ExtRound(OD2) > 0))
                mnsSum = min(min(odBuf[i].MinusCodes[j2].Sum,ABS(odBuf[i].GetOD())),OD2);
                if (mnsSum <= $0)
                  continue;
                end;
                
                OD2 = OD2 - mnsSum;
                odBuf[i].MinusCodes[j2].Sum = ExtRound(odBuf[i].MinusCodes[j2].Sum - mnsSum);
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn
                  = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn - mnsSum;

                if (ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn) == $0)
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx] = NULL;
                end;
                
                l = -1;
                minusFind = false;
                while(((l=l+1) < totalRecBuf.MinusCodes.Size) )
                  //ищем что среди кодов вычетов, нет вычета который мы запомнили
                  if (totalRecBuf.MinusCodes[l].MSCode == odBuf[i].MinusCodes[j2].Code)
                    minusFind = true;
                    PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[l].MSnnn = 
                      PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[l].MSnnn + mnsSum;
                    break;
                  end;
                end;
                if (not minusFind)
                  PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes.size] = 
                                            NPTXMinusCodeParm(odBuf[i].MinusCodes[j2].Code, mnsSum, true);
                end;
              end;
            end;

            if (ExtRound(odBuf[i].GetOD()) >= $0)
              break;
            end;

            //закольцовываем
            if (j == 0)
              j = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.size;
            end;
          end;
        end;

        //подчищаем null значения в minuscodes
        i = -1;
        while ((i = i + 1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.size)
          if (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes != NULL)
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes = filter(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes);
          end;
        end;

      end;

      var wasNotReDef = false;
      var needRecalcNob = false;

      i = -1;
      while ((i = i + 1) < odBuf.size)
        OD = odBuf[i].GetOD();
        if (OD < -0.5)
          wasNotReDef = true;
          MsgBox("По клиенту с PartyID = " + PayerInfo.ClientID + " (" + PayerInfo.LastName + " " + PayerInfo.FirstName + " " +  PayerInfo.MiddleName + 
               "), не распределено превышение расходов над доходами на сумму "+string(ABS(odBuf[i].GetOD())));
        elif ((OD < 0.0) and (OD >= -0.5))
          j=-1;
          while(((j=j+1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes.size) and (ExtRound(OD) < 0.0))
            mnsSum = min(ABS(OD),PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn);
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn = 
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn - mnsSum;
            OD=OD+mnsSum;
            needRecalcNob = true;
          end;
        end;
      end;
      if (wasNotReDef)
        MsgBox("По клиенту с PartyID = " + PayerInfo.ClientID + " (" + PayerInfo.LastName + " " + PayerInfo.FirstName + " " +  PayerInfo.MiddleName + ") вычеты возвращены в исходное состояние");
        PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr = oldArr;
      end;
      
      if (indexTotal >= 0)
        ////идём сверху вниз
        i = -1;
        while ((i=i+1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.Size)
          if ( ((PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes == NULL) 
             OR (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes.Size == 0)) and (totalRecBuf.PSCode == NULL))
            RemoveFromArrByIdx(@PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr,i);
            i = i - 1;
          end;
        end;
      end;

      if((indexTotal >= 0) and (indexHigh >= 0))
        if (    (ExtRound(PayerInfo.ArrCodeParm[indexHigh].PlusSum) == $0) 
            and (ExtRound(PayerInfo.ArrCodeParm[indexHigh].MinusSum) == $0) 
            and (ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxBaseSum) == $0) 
            and (ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxCalculated) == $0))

          //требование из ТЗ по переносу оплаченных сумм из ставки 15% в ставку 13% в случае если по ставке 15% суммы доходов и расходов, а также исчисленного налога - нулевые

          PayerInfo.ArrCodeParm[indexTotal].TaxPaid = PayerInfo.ArrCodeParm[indexTotal].TaxPaid + PayerInfo.ArrCodeParm[indexHigh].TaxPaid;
          PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue = PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue + PayerInfo.ArrCodeParm[indexHigh].TaxToReturnDue;
          PayerInfo.ArrCodeParm[indexTotal].TaxDue = PayerInfo.ArrCodeParm[indexTotal].TaxCalculated - PayerInfo.ArrCodeParm[indexTotal].TaxPaid + PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue;
          if(PayerInfo.ArrCodeParm[indexTotal].TaxDue >= 0)
             PayerInfo.ArrCodeParm[indexTotal].TaxOver = 0;
          else
             PayerInfo.ArrCodeParm[indexTotal].TaxOver = ABS(PayerInfo.ArrCodeParm[indexTotal].TaxDue);
             PayerInfo.ArrCodeParm[indexTotal].TaxDue = 0;
          end;
          RemoveFromArrByIdx(@PayerInfo.ArrCodeParm,indexHigh);
          indexHigh = -1;
          needRecalcNob = true;
        end;
      end;

      if((indexTotal >= 0) and (indexHigh >= 0) and ((ExtRound(PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue) > $0) or (ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxToReturnDue) > $0)))
        //переброс удержанного отрицательного налога
        if ((Abs(ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxToReturnDue)) * (-1)) < (Abs(ExtRound(PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue)) * (-1)))
          fromIndex = indexHigh;
          toIndex = indexTotal;
        else
          fromIndex = indexTotal;
          toIndex = indexHigh;
        end;
        PayerInfo.ArrCodeParm[toIndex].TaxToReturnDue = PayerInfo.ArrCodeParm[toIndex].TaxToReturnDue + PayerInfo.ArrCodeParm[fromIndex].TaxToReturnDue;
        PayerInfo.ArrCodeParm[fromIndex].TaxToReturnDue = 0.0;
        needRecalcNob = true;
      end;

      if ((indexTotal >= 0) and (PayerInfo.ArrCodeParm[indexTotal].Income15.size > 0) and true)
        i = -1;
        while ((i = i + 1) < PayerInfo.ArrCodeParm[indexTotal].Income15.size)
          sortedArr = MakeSortedCodesByNobkind(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr, PayerInfo.ArrCodeParm[indexTotal].Income15[i].Key);
          j = -1;
          D15 = 1;
          while ((j = j + 1) < sortedArr.size)
            totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx];
            OD = totalRecBuf.PSnnn - totalRecBuf.GetMinusSum();
            D15 = min(PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value, OD);
            if (D15 > $0)
              PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = 
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn - D15;
              PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value = PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value - D15;

              AddInArrCodeParms(PayerInfo.ArrCodeParm, totalRecBuf.Month, totalRecBuf.PSCode, D15, NULL, NULL, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, true);
              if ((ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn) == $0) and 
                  ((PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes == NULL) or 
                   (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes.size == 0))
                 )
                PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL;
              end;
              if (PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value <= $0)
                break;
              end;
            end;
          end;
        end;

        needRecalcNob = true;
      end;

      if (needRecalcNob)
        if (indexTotal >= 0)
          RecalcNOB(PayerInfo, indexTotal, 13.0);
          indexHigh = IndexOfRate(PayerInfo.ArrCodeParm, 15, true);
          if (indexHigh >= 0)
            RecalcNOB(PayerInfo, indexHigh, 15.0);
          end;
        end;
      end;
   END;

   SQL_Truncate("dnptx6calc1_tmp");

   if(IsPart2)
      Init(_Investors, _BeginDate, _EndDate, _ByCB, _ByDepo, _ByVS);
   end;

   m_TaxAgentParm = TaxAgentParm();
   m_TaxAgentParm.Load();
END;

private macro NDLFPayerStatus(PartyID)
   var Status = 0;
   PRIVATE RECORD party("party.dbt");
   if(ПолучитьСубъекта(PartyID, party) == 0)
      GetMainObjAttr(NULL, OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 42, NULL, NULL, Status);
   end;

   return Status;
end;

CLASS (DL_XML) NPTXPit6_NEW_XML
   macro CreateXMLObj()
      CreateXML();
   end;

   macro GetXMLObj()
      return m_xml;
   end;

   macro SetFileName(fileName)
      if(fileName != NULL)
         m_FileName = fileName;
      end;
   end;

   macro GetFileName()
      return m_FileName;
   end;


   macro SaveXML()
      var NameFile = GetFileName(); 
      var DirFileLen = 0;
          
      var NameFileTxt = GetTxtFileName(NameFile); 

      var nm, ext;
      SplitFile(NameFileTxt, nm, ext);

      var FileNameLen = strlen(nm+ext);
    
      DirFileLen = strlen(NameFileTxt);

      var NamePath = substr(NameFileTxt, 1, DirFileLen - FileNameLen);
      m_xml.save(NamePath + NameFile);
   end;

   macro Save()
      SaveXML();
   end;

   macro CreateNode(nodeName /* attrName, attrValue, ... */)
      var node = NULL;
      var numParm = 2;
      var attrName = "", attrValue = "";

      node = m_xml.createNode(1, nodeName, NameSpace);
      while(GetParm(numParm, attrName))
        GetParm(numParm + 1, attrValue);
        node.setAttributeNode(CreateAttr(attrName, attrValue));
        numParm = numParm + 2;
      end;
  
      return node;
   end;

   InitDL_XML();
   m_FileName = "NO_NDFL6.2_0000_0000_0000000000000000000_00000000_0";
END;

CLASS (TaxReportBase) NPTX_Pit6_NEW_Report()
   private const ReturnsOnPage = 16;
   private const CodesOnPageApp2 = 15;

   private var m_RepCalc = NULL;
   private var m_RepCalc2 = NULL;
   private var m_InXML = UNSET_CHAR;
   private var m_XMLFile = NULL;
   private var m_Number = 1;
   private var m_PageNum = 1;
   private var m_CurrNameNPTX2 = "";
   private var m_CurrNameApp2 = "";
   private var m_Part1PageCount = 0;
   private var m_Part1HighRatePageCount = 0;
   private var m_Part2PageCount = 0;
   private var m_Part2HighRatePageCount = 0;
   private var m_NPTX2PageCount = 0;
   private var m_ByClientNumerator = ByClientNumerator();

   var RateParmNPTX2Arr = TArray();

   private var m_IsPart1, m_IsPart2, m_IsApp1, m_IsApp1Client, m_IsSlice;

   private macro BeginReport()
      var partyNumber = 0;
      var NumberQuery, NumberCmd, NumberDS;

      m_IsPart1      = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P1_CHECKBOX) == SET_CHAR);
      m_IsPart2      = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_CHECKBOX) == SET_CHAR);
      m_IsApp1       = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_APP1_CHECKBOX) == SET_CHAR);
      m_IsApp1Client = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_FORCLIENT_CHECKBOX) == SET_CHAR);
      m_IsSlice      = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_SLICE_CHECKBOX) == SET_CHAR);

      //т.к. поле "клиент" относится только к справке, тот тут фильтровать не надо (отрефакторить ой как напрашивается)
      m_RepCalc2 = NPTXRepCalc_NPTXPIT6_NEW_2(0, 
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_BEGDATE),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_ENDDATE),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_BOCB_CHECKBOX),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DEPO_CHECKBOX),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_VS_CHECKBOX),
                                              m_IsPart2);

      SetIsShowAppl(false);

      CreateTotalBook();

      m_InXML = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_XML_CHECKBOX);

      if(m_InXML == SET_CHAR)
         m_XMLFile.CreateXMLObj();
      end;

      NumberQuery = "select count(1) as t_Count " +
                    "from ddl_report_stat_dbt " +
                    "where t_ReportKind = " + string(NPTXPIT6NEW_REPORTKIND);

      NumberCmd = DL_RSDCommand(NumberQuery);
      /*NumberDS = NumberCmd.Execute();
      if(NumberDS.MoveNext())
         m_Number = Int(NumberDS.Count) + 1;
      end;*/

      Dl_CallInsertStat(m_OutMode);
   end;

   PRIVATE MACRO PrintTitle(PageCount)
      var Year;
      var P2_EndDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_ENDDATE),
          RepDate    = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);

      DateSplit(P2_EndDate, NULL, NULL, Year);

      UseNewSheetInTotalBook();
      SetActiveSheet("Титульный лист");

      PrintOneRow("N1_OurInn", m_RepCalc2.OurInn(), 12);
      PrintOneRow("N1_OurKpp", m_RepCalc2.OurKPP(), 9);
      PrintOneRow("N1_Num", string(m_PageNum:3:o), 3);
      PrintOneRow("N1_PP", m_RepCalc2.PP(), 2);
      PrintOnERow("N1_Year", string(Year), 4);
      PrintOneRow("N1_OurFNSCode", m_RepCalc2.OurFNScode(), 4);
      PrintOneRow("N1_OurName", m_RepCalc2.OurName(), 160);
      PrintOneRow("N1_OKTMO", substr(m_RepCalc2.OurOKTMO(), 1, 11), 11);
      PrintOneRow("N1_OurPhone", m_RepCalc2.OurPhone(), 20);
      PrintOneRow("N1_Page", string(PageCount:3:o), 3);
      if((m_RepCalc2.FirstPersonLastName() != NULL) and (m_RepCalc2.FirstPersonLastName() != ""))
        PrintOneRow("N1_FIOPerson1", m_RepCalc2.FirstPersonLastName(), 20);
        PrintOneRow("N1_FIOPerson2", m_RepCalc2.FirstPersonFirstName(), 20);
        PrintOneRow("N1_FIOPerson3", m_RepCalc2.FirstPersonMiddleName(), 20);
      end;
      PrintOneDateRow("N1_Date", RepDate);

      CopyAllSheetInTotalBook("Титульный лист", false, "N1_PrintArea", 0, "Титульный лист");
   END;

   PRIVATE MACRO PrintPart1(Part2Exists:BOOL, Sum021:Money, Sum022:Money, Sum023:Money, Sum024:Money, Sum021_HighRate:Money, Sum022_HighRate:Money, Sum023_HighRate:Money, Sum024_HighRate:Money)
      var PayNumber = 1;
      var TaxPaidDate = 0;
      var TaxToReturnDue_Total = 0;
      var RetExists = false;
      var RetNumber = 1;
      var Part1Num = 0;
      var IsFirst = true;
      var RetHighRateExists = false;
      var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);

      RetExists = m_RepCalc.Returns().MoveFirst();

      if(RetExists or Part2Exists or (Sum021 > 0) or (Sum022 > 0) or (Sum023 > 0) or (Sum024 > 0) or (Sum021_HighRate > 0) or (Sum022_HighRate > 0) or
         (Sum023_HighRate > 0) or (Sum024_HighRate > 0))

         InitProgress(m_Part1PageCount + m_Part1HighRatePageCount, "Печать раздела 1", "Печать раздела 1");
         m_RepCalc.GetTaxReturnSums(@TaxToReturnDue_Total, false);
         while(RetExists or IsFirst)
            m_PageNum = m_PageNum + 1;
            RetNumber = 1;
            TaxPaidDate = Sum021 + Sum022 + Sum023 + Sum024;

            UseNewSheetInTotalBook();
            SetActiveSheet("Расчет Раздел 1");
            PrintOneRow("N2_OurInn", m_RepCalc2.OurINN(), 12);
            PrintOneRow("N2_OurKpp", m_RepCalc2.OurKPP(), 9);
            PrintOneRow("N2_Num", string(m_PageNum:3:o), 3);
            PrintOneRow("N2_KBK", "18210102010011000110", 20);

            PrintOneSumRow("N2_TaxPaid_Total", TaxPaidDate, 15, false);

            if(Sum021 > 0)
               PrintOneSumRow("N2_TaxPaid1Date_", Sum021, 15, false);
            end;
            if(Sum022 > 0)
               PrintOneSumRow("N2_TaxPaid2Date_", Sum022, 15, false);
            end;
            if(Sum023 > 0)
               PrintOneSumRow("N2_TaxPaid3Date_", Sum023, 15, false);
            end;
            if(Sum024 > 0)
               PrintOneSumRow("N2_TaxPaid4Date_", Sum024, 15, false);
            end;

            PrintOneSumRow("N2_TaxToReturnDue_Total_", string(TaxToReturnDue_Total), 15, false);

            while(RetExists and (RetNumber <= ReturnsOnPage))
               PrintOneDateRow("N2_DateTaxReturn" + string(RetNumber) + "_", Date(m_RepCalc.Returns().Value("t_DateTaxReturn")));
               PrintOneSumRow("N2_TaxReturn" + string(RetNumber) + "_", m_RepCalc.Returns().Value("t_TaxToReturnDue"), 15, false);
               RetExists = m_RepCalc.Returns().MoveNext();
               RetNumber = RetNumber + 1;
            end;
            PrintFormatString(NULL, "N2_Date", string(RepDate:f));

            IsFirst = false;

            CopyAllSheetInTotalBook("Расчет Раздел 1", false, "N2_PrintArea", 0, "Расчет Раздел 1 " + string(Part1Num + 1));
            UseProgress(Part1Num = Part1Num + 1);
         end;

         m_RepCalc.GetTaxReturnSums(@TaxToReturnDue_Total, true);
         RetHighRateExists = m_RepCalc.ReturnsHighRate().MoveFirst();
         if(RetHighRateExists or (Sum021_HighRate > 0) or (Sum022_HighRate > 0) or (Sum023_HighRate > 0) or (Sum024_HighRate > 0))
            IsFirst = true;
            while(RetHighRateExists or (IsFirst and ((Sum021_HighRate > 0) or (Sum022_HighRate > 0) or (Sum023_HighRate > 0) or (Sum024_HighRate > 0))))
               m_PageNum = m_PageNum + 1;
               RetNumber = 1;
               TaxPaidDate = Sum021_HighRate + Sum022_HighRate + Sum023_HighRate + Sum024_HighRate;
               IsFirst = false;

               UseNewSheetInTotalBook();
               SetActiveSheet("Расчет Раздел 1");
               PrintOneRow("N2_OurInn", m_RepCalc2.OurINN(), 12);
               PrintOneRow("N2_OurKpp", m_RepCalc2.OurKPP(), 9);
               PrintOneRow("N2_Num", string(m_PageNum:3:o), 3);
               PrintOneRow("N2_KBK", "18210102080011000110", 20);

               PrintOneSumRow("N2_TaxPaid_Total", TaxPaidDate, 15, false);

               if(Sum021_HighRate > 0)
                  PrintOneSumRow("N2_TaxPaid1Date_", Sum021_HighRate, 15, false);
               end;
               if(Sum022_HighRate > 0)
                  PrintOneSumRow("N2_TaxPaid2Date_", Sum022_HighRate, 15, false);
               end;
               if(Sum023_HighRate > 0)
                  PrintOneSumRow("N2_TaxPaid3Date_", Sum023_HighRate, 15, false);
               end;
               if(Sum024_HighRate > 0)
                  PrintOneSumRow("N2_TaxPaid4Date_", Sum024_HighRate, 15, false);
               end;

               PrintOneSumRow("N2_TaxToReturnDue_Total", string(TaxToReturnDue_Total), 15, false);

               while(RetHighRateExists and (RetNumber <= ReturnsOnPage))
                  PrintOneDateRow("N2_DateTaxReturn" + string(RetNumber) + "_", Date(m_RepCalc.ReturnsHighRate().Value("t_DateTaxReturn")));
                  PrintOneSumRow("N2_TaxReturn" + string(RetNumber) + "_", m_RepCalc.ReturnsHighRate().Value("t_TaxToReturnDue"), 15, false);
                  RetHighRateExists = m_RepCalc.ReturnsHighRate().MoveNext();
                  RetNumber = RetNumber + 1;
               end;

               PrintFormatString(NULL, "N2_DATE", string(RepDate:f));

               CopyAllSheetInTotalBook("Расчет Раздел 1", false, "N2_PrintArea", 0, "Расчет Раздел 1 " + string(Part1Num + 1));
               UseProgress(Part1Num = Part1Num + 1);
            end;
         end;
         RemProgress();
      end;
   END;
   private var КБК1 = "18210102010011000110";
   private var КБК2 = "18210102070011000110";
   private var КБК3 = "18210102080011000110";

   PRIVATE MACRO РассчитатьНОБиНалогДЕПО_31_12_2022(ClientID:integer, KBK:string, AddWhere:string, IIS:bool, НОБ_ДЕПО:@money, Налог_ДЕПО:@money, Налог_Расчет:@money)
     var query, cmd, DataSet;

     НОБ_ДЕПО     = $0;
     Налог_ДЕПО   = $0;
     Налог_Расчет = $0;

     query =   " select NVL(SUM(t_TaxByPay), 0) as SumTaxByPay, "
             + "        NVL(SUM(t_TaxBase), 0) as SumTaxBase, "
             + "        NVL(SUM(t_TaxBase*t_TaxRate/100.0), 0) as SumTaxCalc "
             + "   from dnptxdias_dbt "
             + "  where t_ClientID = ? "
             + "    and t_Year = 2022 "
             + "    and t_IIS = " + IIF(IIS, "'X'", "CHR(0)")
             + AddWhere;

     cmd = DL_RSDCommand();

     cmd.AddParam(ClientID);

     if(KBK != "")
       query = query + " and t_KBK = ? ";
       cmd.AddParam(KBK);
     end;

     DataSet = cmd.Execute(query);
     if(DataSet.moveNext())
       НОБ_ДЕПО     = DataSet.SumTaxBase;
       Налог_ДЕПО   = DataSet.SumTaxByPay;
       Налог_Расчет = DataSet.SumTaxCalc;
     end;

   END;

   PRIVATE MACRO РассчитатьДЕПО_31_12_2022(ClientID, KBK, Rate, TotalPlus, TotalMinus, TaxBaseSum:@money, TaxCalculated:@money, Paid:@money)
     var query, cmd, DataSet;
     var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";
     var Клиент_НОБ_ДЕПО_КБК1, Клиент_НОБ_ДЕПО_КБК2, Клиент_НОБ15_ДЕПО, Клиент_НОБ_ДЕПО_КБК3;
     var Клиент_Налог_ДЕПО_КБК1,Клиент_Налог_ДЕПО_КБК2, Клиент_Налог15_ДЕПО, Клиент_Налог_ДЕПО_КБК3;
     var Клиент_Налог_СОФР, Клиент_Налог_СОФР_ИИС, Клиент_Налог15_СОФР, Клиент_Налог15_СОФР_ИИС;
     var Клиент_Налог_КБК1, Клиент_Налог_КБК2, Клиент_Налог_КБК3;
     var Клиент_Налог_форма_КБК2, Клиент_Налог_форма_КБК1, Клиент_Налог_форма_КБК3;
     var Клиент_НОБ_ДЕПО, Клиент_НОБ_ДЕПО_ИИС, Клиент_Налог_ДЕПО, Клиент_Налог_ДЕПО_ИИС;
     var Клиент_НОБ_СОФР, Клиент_НОБ_СОФР_ИИС, Клиент_НОБ15_СОФР, Клиент_НОБ15_СОФР_ИИС;
     var Клиент_НОБ_форма_КБК2, Клиент_НОБ_форма_КБК1, Клиент_НОБ15_форма_КБК3;
     var Клиент_Налог_Расчет_ДЕПО_КБК1, Клиент_Налог_Расчет_ДЕПО_КБК2, Клиент_Налог_Расчет_ДЕПО_15, Клиент_Налог_Расчет_ДЕПО_КБК3;
     var ClientResident;
     var Bg2, Bg3, Bg5, Bg9;
     var Client_DivPay_Sec_0, Client_PaidGeneral_0, Client_PaidMaterial, Client_PaidGeneral, Client_PaidMaterial_ИИС, Client_PaidGeneral_ИИС, Client_DivPay_Sec, Client_PaidBill;
     var НОБ_форма_КБК1 = $0, Налог_КБК2 = $0, НОБ15_форма_КБК3 = $0, Налог_форма_КБК3 = $0;
     var DivPay_Sec_0 = $0, PaidGeneral_0 = $0, PaidMaterial = $0, PaidGeneral = $0, PaidMaterial_ИИС = $0, PaidGeneral_ИИС = $0, DivPay_Sec = $0, PaidBill = $0;
     var Клиент_НОБ_ДЕПО_КБК2_13, Клиент_Налог_ДЕПО_КБК2_13, Клиент_Налог_Расчет_ДЕПО_КБК2_13;
     var Клиент_НОБ_ДЕПО_КБК2_30, Клиент_Налог_ДЕПО_КБК2_30, Клиент_Налог_Расчет_ДЕПО_КБК2_30;
     var Клиент_Налог_КБК2_13, Клиент_Налог_КБК2_30;
     var Налог_КБК2_13 = $0, Налог_КБК2_30 = $0;
     var НОБ15_СОФР_ИИС = $0, НОБ15_СОФР = $0;


     macro ПолучитьНалогСОФР(ClientID, NpTxKindsStr, IIS)
       var SOFR_Taxe = $0;

       SOFR_Taxe =  GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), DL_CALCNDFL, null, IIS, AddWhereNotOut) + //созданные в операциях расчета НОБ
                    GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), 0 /*только пользовательские*/,null, IIS, AddWhereNotOut) +
                    GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), m_RepCalc2.BeginDate(), NULL, DL_HOLDNDFL, null, 0, AddWhereNotOut) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
                    GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), DL_WRTMONEY, null, IIS, AddWhereNotOut) + //созданные в операциях списания/зачисления денежных средств
                    GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), DL_RETIREMENT_OWN, null, IIS, AddWhereNotOut) + //созданные в операциях погашения ОЭБ
                    /*плюс операции в ПС <Векселя банка>*/
                    GetRubSumByClientFromVeksel(ClientID, string(NpTxKindsStr), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                                              string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                                              string(DL_VSINTERCHANGE) );      //зачет взаимных требований

       return SOFR_Taxe;
     end;

     TaxBaseSum = $0;
     TaxCalculated = $0;
     Paid = $0;

     cmd = DL_RSDCommand();

     query = "select * from (select distinct t_ClientID from dnptx6calc1_tmp union select distinct t_ClientID from dnptxdias_dbt) ";

     if(ClientID > 0)
       query = query + " where t_ClientID = ? ";
       cmd.AddParam(ClientID);
     end;

     DataSet = cmd.Execute(query);
     while(DataSet.moveNext())
       Клиент_НОБ_ДЕПО_КБК1   = $0;
       Клиент_НОБ_ДЕПО_КБК2   = $0;
       Клиент_НОБ15_ДЕПО      = $0;
       Клиент_НОБ_ДЕПО_КБК3   = $0;
       Клиент_Налог_ДЕПО_КБК1 = $0;
       Клиент_Налог_ДЕПО_КБК2 = $0;
       Клиент_Налог15_ДЕПО    = $0;
       Клиент_Налог_ДЕПО_КБК3 = $0;

       Клиент_Налог_СОФР       = $0;
       Клиент_Налог_СОФР_ИИС   = $0;
       Клиент_Налог15_СОФР     = $0;
       Клиент_Налог15_СОФР_ИИС = $0;

       Клиент_Налог_КБК1       = $0;
       Клиент_Налог_КБК2       = $0;
       Клиент_Налог_КБК3       = $0;

       Клиент_Налог_форма_КБК2 = $0;
       Клиент_Налог_форма_КБК1 = $0;
       Клиент_Налог_форма_КБК3 = $0;

       Клиент_НОБ_ДЕПО         = $0;
       Клиент_НОБ_ДЕПО_ИИС     = $0;
       Клиент_Налог_ДЕПО       = $0;
       Клиент_Налог_ДЕПО_ИИС   = $0;

       Клиент_НОБ_СОФР         = $0;
       Клиент_НОБ_СОФР_ИИС     = $0;
       Клиент_НОБ15_СОФР       = $0;
       Клиент_НОБ15_СОФР_ИИС   = $0;

       Клиент_НОБ_форма_КБК2   = $0;
       Клиент_НОБ_форма_КБК1   = $0;
       Клиент_НОБ15_форма_КБК3 = $0;

       Client_DivPay_Sec_0     = $0;
       Client_PaidGeneral_0    = $0;
       Client_PaidMaterial     = $0;
       Client_PaidGeneral      = $0;
       Client_PaidMaterial_ИИС = $0;
       Client_PaidGeneral_ИИС  = $0;
       Client_DivPay_Sec       = $0;
       Client_PaidBill         = $0;

       Клиент_Налог_Расчет_ДЕПО_КБК1 = $0; 
       Клиент_Налог_Расчет_ДЕПО_КБК2 = $0; 
       Клиент_Налог_Расчет_ДЕПО_15   = $0; 
       Клиент_Налог_Расчет_ДЕПО_КБК3 = $0;

       Клиент_НОБ_ДЕПО_КБК2_13          = $0;
       Клиент_Налог_ДЕПО_КБК2_13        = $0;
       Клиент_Налог_Расчет_ДЕПО_КБК2_13 = $0;
       Клиент_НОБ_ДЕПО_КБК2_30          = $0;
       Клиент_Налог_ДЕПО_КБК2_30        = $0;
       Клиент_Налог_Расчет_ДЕПО_КБК2_30 = $0;
       Клиент_Налог_КБК2_13             = $0;
       Клиент_Налог_КБК2_30             = $0;                             


       ClientResident = false;
       if( DL_GetPartyResident(DataSet.ClientID) == NPTXPARTY_RESIDENT )
         ClientResident = true;
       end;

       if((ClientResident == true) and (Rate == 30))
         continue;
       elif((ClientResident == false) and (Rate != 30))
         continue;
       end;

       РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, КБК1, " and t_TaxRate <> 15 ", false, @Клиент_НОБ_ДЕПО_КБК1, @Клиент_Налог_ДЕПО_КБК1, @Клиент_Налог_Расчет_ДЕПО_КБК1);
       РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, КБК2, " and t_TaxRate <> 15 ", false, @Клиент_НОБ_ДЕПО_КБК2, @Клиент_Налог_ДЕПО_КБК2, @Клиент_Налог_Расчет_ДЕПО_КБК2);

       if(Rate == 13)
         РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, КБК2, " and t_TaxRate = 13 ", false, @Клиент_НОБ_ДЕПО_КБК2_13, @Клиент_Налог_ДЕПО_КБК2_13, @Клиент_Налог_Расчет_ДЕПО_КБК2_13);
       end;

       if(Rate == 30)
         РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, КБК2, " and t_TaxRate = 30 ", false, @Клиент_НОБ_ДЕПО_КБК2_30, @Клиент_Налог_ДЕПО_КБК2_30, @Клиент_Налог_Расчет_ДЕПО_КБК2_30);
       end;

       РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, "",   " and t_TaxRate = 15 ",  false, @Клиент_НОБ15_ДЕПО,    @Клиент_Налог15_ДЕПО,    @Клиент_Налог_Расчет_ДЕПО_15);
       РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, КБК3, " and t_TaxRate = 15 ",  false, @Клиент_НОБ_ДЕПО_КБК3, @Клиент_Налог_ДЕПО_КБК3, @Клиент_Налог_Расчет_ДЕПО_КБК3);

       Клиент_Налог_СОФР = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDBILL), 0);

       Клиент_Налог_СОФР_ИИС = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL_IIS), 1);

       Клиент_Налог15_СОФР = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL_15_2+","+TXOBJ_PAIDGENERAL_15_9), 0);

       Клиент_Налог15_СОФР_ИИС = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL_15_IIS), 1);
             
       Клиент_Налог_КБК1 = round(Клиент_Налог_Расчет_ДЕПО_КБК1, 0) - Клиент_Налог_ДЕПО_КБК1;
       Клиент_Налог_КБК2 = round(Клиент_Налог_Расчет_ДЕПО_КБК2, 0) - Клиент_Налог_ДЕПО_КБК2;
       Клиент_Налог_КБК2_13 = round(Клиент_Налог_Расчет_ДЕПО_КБК2_13, 0) - Клиент_Налог_ДЕПО_КБК2_13;
       Клиент_Налог_КБК2_30 = round(Клиент_Налог_Расчет_ДЕПО_КБК2_30, 0) - Клиент_Налог_ДЕПО_КБК2_30;

       Клиент_Налог_КБК3 = round(Клиент_Налог_Расчет_ДЕПО_КБК3, 0) - Клиент_Налог_ДЕПО_КБК3;

       Клиент_Налог_форма_КБК2 = Клиент_Налог_КБК2;
       Клиент_Налог_форма_КБК1 = Клиент_Налог_СОФР + Клиент_Налог_СОФР_ИИС - Клиент_Налог_КБК2;
       Клиент_Налог_форма_КБК3 = Клиент_Налог15_СОФР + Клиент_Налог15_СОФР_ИИС;

       РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, "", " and t_TaxRate <> 15 ", false, @Клиент_НОБ_ДЕПО,     @Клиент_Налог_ДЕПО);
       РассчитатьНОБиНалогДЕПО_31_12_2022(DataSet.ClientID, "", " and t_TaxRate <> 15 ", true,  @Клиент_НОБ_ДЕПО_ИИС, @Клиент_Налог_ДЕПО_ИИС);

       Bg2 = GetRubSumByClient(DataSet.ClientID, string(TXOBJ_BASEG2), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), null, 0, null, AddWhereNotOut);
       Bg3 = GetRubSumByClient(DataSet.ClientID, string(TXOBJ_BASEG3), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), null, 0, null, AddWhereNotOut);
       Bg5 = GetRubSumByClient(DataSet.ClientID, string(TXOBJ_BASEG5), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), null, 1, null, AddWhereNotOut);
       Bg9 = GetRubSumByClient(DataSet.ClientID, string(TXOBJ_BASEG9), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), null, 0, null, AddWhereNotOut);

       if(KBK == КБК1)
         Client_DivPay_Sec_0     = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_DIVPAY_SEC_0),     0);
         Client_PaidGeneral_0    = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL_0),    0);
         Client_PaidMaterial     = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDMATERIAL),     0);
         Client_PaidGeneral      = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL),      0);
         Client_PaidMaterial_ИИС = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDMATERIAL_IIS), 1);
         Client_PaidGeneral_ИИС  = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDGENERAL_IIS),  1);
         Client_DivPay_Sec       = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_DIVPAY_SEC),       0);
         Client_PaidBill         = ПолучитьНалогСОФР(DataSet.ClientID, string(TXOBJ_PAIDBILL),         0);
       end;

       if(ClientResident == true)
         Клиент_НОБ_СОФР = max((min(Bg2+Клиент_НОБ_ДЕПО, NPTX_LIMINCOME_MAX15) - Клиент_НОБ_ДЕПО), 0) + min(Bg3, NPTX_LIMINCOME_MAX15) + min(Bg9, NPTX_LIMINCOME_MAX15); 
       else
         Клиент_НОБ_СОФР = GetRubSumByClient(DataSet.ClientID, string(TXOBJ_BASEGENERAL), m_RepCalc2.BeginDate(), m_RepCalc2.EndDate(), null, 0, null, AddWhereNotOut);
       end;

       Клиент_НОБ_СОФР_ИИС = max(min(Bg5+Клиент_НОБ_ДЕПО_ИИС, NPTX_LIMINCOME_MAX15) - Клиент_НОБ_ДЕПО_ИИС, 0); 

       Клиент_НОБ15_СОФР     = Bg2 + Bg3 + Bg9 - Клиент_НОБ_СОФР; 
       Клиент_НОБ15_СОФР_ИИС = Bg5 - Клиент_НОБ_СОФР_ИИС;

       Клиент_НОБ_форма_КБК2   = 0;
       Клиент_НОБ_форма_КБК1   = Клиент_НОБ_СОФР   + Клиент_НОБ_СОФР_ИИС;
       Клиент_НОБ15_форма_КБК3 = Клиент_НОБ15_СОФР + Клиент_НОБ15_СОФР_ИИС;

       НОБ_форма_КБК1   = НОБ_форма_КБК1   + Клиент_НОБ_форма_КБК1;
       Налог_КБК2       = Налог_КБК2       + Клиент_Налог_КБК2;
       Налог_КБК2_13    = Налог_КБК2_13    + Клиент_Налог_КБК2_13;
       Налог_КБК2_30    = Налог_КБК2_30    + Клиент_Налог_КБК2_30;
       НОБ15_форма_КБК3 = НОБ15_форма_КБК3 + Клиент_НОБ15_форма_КБК3;
       Налог_форма_КБК3 = Налог_форма_КБК3 + Клиент_Налог_форма_КБК3;

       НОБ15_СОФР_ИИС   = НОБ15_СОФР_ИИС + Клиент_НОБ15_СОФР_ИИС;
       НОБ15_СОФР       = НОБ15_СОФР     + Клиент_НОБ15_СОФР;    

       DivPay_Sec_0     = DivPay_Sec_0     + Client_DivPay_Sec_0;
       PaidGeneral_0    = PaidGeneral_0    + Client_PaidGeneral_0;
       PaidMaterial     = PaidMaterial     + Client_PaidMaterial;    
       PaidGeneral      = PaidGeneral      + Client_PaidGeneral;     
       PaidMaterial_ИИС = PaidMaterial_ИИС + Client_PaidMaterial_ИИС;
       PaidGeneral_ИИС  = PaidGeneral_ИИС  + Client_PaidGeneral_ИИС; 
       DivPay_Sec       = DivPay_Sec       + Client_DivPay_Sec;      
       PaidBill         = PaidBill         + Client_PaidBill;        
     end;

     if(ClientID > 0)
       if(KBK == КБК1)
         TaxBaseSum    = НОБ_форма_КБК1;
         TaxCalculated = max((Rate/100.0) * (TotalPlus - TotalMinus) - DivPay_Sec_0 - PaidGeneral_0 - max(IIF(Rate == 13, Налог_КБК2_13, Налог_КБК2_30), 0), 0);
         Paid          = PaidMaterial + PaidGeneral + PaidMaterial_ИИС+ PaidGeneral_ИИС + DivPay_Sec + PaidBill - max(IIF(Rate == 13, Налог_КБК2_13, Налог_КБК2_30), 0); 
       elif(KBK == КБК2)
         TaxBaseSum    = $0;
         TaxCalculated = IIF(Rate == 13, Max(Налог_КБК2_13, 0), Налог_КБК2_30);
         Paid          = IIF(Rate == 13, Max(Налог_КБК2_13, 0), Налог_КБК2_30);
       elif(KBK == КБК3)
         TaxBaseSum    = НОБ15_форма_КБК3;
         TaxCalculated = НОБ15_СОФР*(Rate/100.0) + НОБ15_СОФР_ИИС*(Rate/100.0); 
         Paid          = Налог_форма_КБК3;
       end;
     else
       if(KBK == КБК1)
         TaxBaseSum    = НОБ_форма_КБК1;
         TaxCalculated = max((Rate/100.0) * (TotalPlus - TotalMinus) - DivPay_Sec_0 - PaidGeneral_0 - max(IIF(Rate == 13, Налог_КБК2_13, Налог_КБК2_30), 0), 0);
         Paid          = PaidMaterial + PaidGeneral + PaidMaterial_ИИС+ PaidGeneral_ИИС + DivPay_Sec + PaidBill - max(IIF(Rate == 13, Налог_КБК2_13, Налог_КБК2_30), 0); 
       elif(KBK == КБК2)
         TaxBaseSum    = $0;
         TaxCalculated = IIF(Rate == 13, Max(Налог_КБК2_13, 0), Налог_КБК2_30);
         Paid          = IIF(Rate == 13, Max(Налог_КБК2_13, 0), Налог_КБК2_30);
       elif(KBK == КБК3)
         TaxBaseSum    = НОБ15_форма_КБК3;
         TaxCalculated = Налог_форма_КБК3;
         Paid          = Налог_форма_КБК3;
       end;
     end;
   END;

   //При запуске за дату 31.12.2022
   PRIVATE MACRO PrintPart2_31_12_2022(KBK, Rate, Part2Num:@integer)
     var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);
     var existsRate       = false;
     var find             = false;
     var TotalPlus        = 0;
     var DivPlus          = 0;
     var Amount           = 0;
     var TotalMinus       = 0;
     var TaxCalculated    = 0;
     var TaxCalculatedDiv = 0;
     var Znp              = 0;
     var TaxPaid          = 0;
     var TaxDue           = 0;
     var TaxOver          = 0;
     var TaxToReturnDue   = 0;
     var TaxBaseSum       = 0;
     
     existsRate = m_RepCalc2.Rates().MoveFirst();

     while(existsRate)
       if((m_RepCalc2.Rates().Value("t_KBK") == KBK) AND (m_RepCalc2.Rates().Value("t_Rate") == Rate))
         РассчитатьДЕПО_31_12_2022(-1, KBK, Rate, m_RepCalc2.Rates().Value("t_TotalPlus"), m_RepCalc2.Rates().Value("t_TotalMinus"), @TaxBaseSum, @TaxCalculated, @TaxPaid);

         DivPlus          = m_RepCalc2.Rates().Value("t_DivPlus");
         Amount           = SQL_ConvTypeInteger(m_RepCalc2.Rates().Value("t_CountFL"));
         TotalPlus        = m_RepCalc2.Rates().Value("t_TotalPlus");
         TotalMinus       = m_RepCalc2.Rates().Value("t_TotalMinus");
         TaxCalculatedDiv = m_RepCalc2.Rates().Value("t_TaxCalculatedDiv");
         Znp              = m_RepCalc2.Rates().Value("t_Znp");

         find = true;
         break;
       end;

       existsRate = m_RepCalc2.Rates().MoveNext();
     end;

     if(find == false)
       РассчитатьДЕПО_31_12_2022(-1, KBK, Rate, 0, 0, @TaxBaseSum, @TaxCalculated, @TaxPaid);
     end;

     if(TaxPaid > 0)
       TaxToReturnDue = 0;
     else
       TaxToReturnDue = -TaxPaid;
       TaxPaid = 0;
     end;

     if(TaxPaid <= TaxCalculated)
       TaxDue  = TaxCalculated - (TaxPaid + Znp) - TaxToReturnDue;
     else
       TaxOver = TaxPaid - TaxCalculated + TaxToReturnDue;
     end;

     if(   (TotalPlus        != 0)
        or (DivPlus          != 0)
        or (Amount           != 0)
        or (TotalMinus       != 0)
        or (TaxCalculated    != 0)
        or (TaxCalculatedDiv != 0)
        or (Znp              != 0)
        or (TaxPaid          != 0)
        or (TaxDue           != 0)
        or (TaxOver          != 0)
        or (TaxToReturnDue   != 0)
       )

       m_PageNum = m_PageNum + 1;
       UseNewSheetInTotalBook();
       SetActiveSheet("Расчет Раздел 2");

       PrintOneRow("N3_OurInn", m_RepCalc2.OurINN(), 12);
       PrintOneRow("N3_OurKpp", m_RepCalc2.OurKPP(), 9);

       PrintOneRow("N3_Num", string(m_PageNum:3:o), 3);

       PrintOneSumRow("N3_Rate", Rate, 2, false);
       PrintOneRow("N3_KBK", KBK, 20);

       PrintOneSumRow("N3_TotalPlus",        TotalPlus, 14, true);
       PrintOneSumRow("N3_DivPlus",          DivPlus, 14, true);
       PrintOneSumRow("N3_Amount",           Amount, 6, false);
       PrintOneSumRow("N3_TotalMinus",       TotalMinus, 14, true);
       PrintOneSumRow("N3_TaxCalculated",    TaxCalculated, 15, false);
       PrintOneSumRow("N3_TaxCalculatedDiv", TaxCalculatedDiv, 15, false);

       PrintOneSumRow("N3_Znp", Znp, 15, false);
       PrintOneSumRow("N3_TaxPaid", TaxPaid, 15, false);
       //пока идём по пути наименьшего сопротивления, и селекты не "ломаем"
       taxDue = TaxDue - TaxOver;
       taxOver = 0.0;
       if (taxDue < 0)
          taxOver = ABS(taxDue);
          taxDue = 0.0;
       end;
       PrintOneSumRow("N3_TaxDue", round(taxDue,0), 15, false);
       PrintOneSumRow("N3_TaxOver", round(taxOver,0), 15, false);
       PrintOneSumRow("N3_TaxToReturnDue", round(TaxToReturnDue,0), 15, false);

       PrintFormatString(NULL, "N3_Date", string(RepDate:f));
       CopyAllSheetInTotalBook("Расчет Раздел 2", false, "N3_PrintArea", 0, "Расчет Раздел 2 " + Part2Num);

       Part2Num = Part2Num + 1;
     end;
   END;

   PRIVATE MACRO PrintPart2(RateExists)
      var Part2Num = 1;
      var CurRate = 0;
      var IsHighRate = UNSET_CHAR;
      var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);
      var taxDue, taxOver;

      if(m_RepCalc2.EndDate() == date(31,12,2022))
        InitProgress(-1, "Форма 6-НДФЛ с 01.01.2021", "Печать раздела 2");

        PrintPart2_31_12_2022(КБК1, 13, @Part2Num);
        PrintPart2_31_12_2022(КБК1, 30, @Part2Num);
        PrintPart2_31_12_2022(КБК2, 13, @Part2Num);
        PrintPart2_31_12_2022(КБК2, 30, @Part2Num);
        PrintPart2_31_12_2022(КБК3, 15, @Part2Num);

        RemProgress();
      else
        if(RateExists)
           InitProgress(m_Part2PageCount, "Форма 6-НДФЛ с 01.01.2021", "Печать раздела 2");
           while(RateExists)
              CurRate = m_RepCalc2.Rates().Value("t_Rate");
              IsHighRate = m_RepCalc2.Rates().Value("t_IsHighRate");
              
              m_PageNum = m_PageNum + 1;
              UseNewSheetInTotalBook();
              SetActiveSheet("Расчет Раздел 2");

              PrintOneRow("N3_OurInn", m_RepCalc2.OurINN(), 12);
              PrintOneRow("N3_OurKpp", m_RepCalc2.OurKPP(), 9);

              PrintOneRow("N3_Num", string(m_PageNum:3:o), 3);

              PrintOneSumRow("N3_Rate", CurRate, 2, false);
              PrintOneRow("N3_KBK", m_RepCalc2.Rates().Value("t_KBK"), 20);

              PrintOneSumRow("N3_TotalPlus", m_RepCalc2.Rates().Value("t_TotalPlus"), 14, true);
              PrintOneSumRow("N3_DivPlus", m_RepCalc2.Rates().Value("t_DivPlus"), 14, true);
              PrintOneSumRow("N3_Amount", SQL_ConvTypeInteger(m_RepCalc2.Rates().Value("t_CountFL")), 6, false);
              PrintOneSumRow("N3_TotalMinus", m_RepCalc2.Rates().Value("t_TotalMinus"), 14, true);
              PrintOneSumRow("N3_TaxCalculated", m_RepCalc2.Rates().Value("t_TaxCalculated"), 15, false);
              PrintOneSumRow("N3_TaxCalculatedDiv", m_RepCalc2.Rates().Value("t_TaxCalculatedDiv"), 15, false);

              PrintOneSumRow("N3_Znp", m_RepCalc2.Rates().Value("t_Znp"), 15, false);
              PrintOneSumRow("N3_TaxPaid", m_RepCalc2.Rates().Value("t_TaxPaid"), 15, false);
              //пока идём по пути наименьшего сопротивления, и селекты не "ломаем"
              taxDue = SQL_ConvTypeSum(m_RepCalc2.Rates().Value("t_TaxDue")) - SQL_ConvTypeSum(m_RepCalc2.Rates().Value("t_TaxOver"));
              taxOver = 0.0;
              if (taxDue < 0)
                 taxOver = ABS(taxDue);
                 taxDue = 0.0;
              end;
              PrintOneSumRow("N3_TaxDue", round(taxDue,0), 15, false);
              PrintOneSumRow("N3_TaxOver", round(taxOver,0), 15, false);
              PrintOneSumRow("N3_TaxToReturnDue", round(m_RepCalc2.Rates().Value("t_TaxToReturnDue"),0), 15, false);

              PrintFormatString(NULL, "N3_Date", string(RepDate:f));
              CopyAllSheetInTotalBook("Расчет Раздел 2", false, "N3_PrintArea", 0, "Расчет Раздел 2 " + Part2Num);

              UseProgress(Part2Num);
              Part2Num = Part2Num + 1;
              RateExists = m_RepCalc2.Rates().MoveNext();
           end;
           RemProgress();
        end;
      end;
   END;

   PRIVATE MACRO PrintNPTXPit2(PayerInfo, RateIndex)
      var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);

      m_PageNum = m_PageNum + 1;
      UseNewSheetInTotalBook();
      SetActiveSheet("Приложение 1 (Справка о дохода)");

      PrintOneRow("N4_OurInn", m_RepCalc2.OurINN(), 12);
      PrintOneRow("N4_OurKpp", m_RepCalc2.OurKPP(), 9);
      PrintOneRow("N4_Num", string(m_PageNum:3:o), 3);
      PrintOneSumRow("N4_NumberRef", m_ByClientNumerator.GetNexNumbByClientId(PayerInfo.ClientID), 7, false);
      PrintOneRow("N4_ClientINN", PayerInfo.ClientINN, 12);
      PrintOneRow("N4_SecondName", PayerInfo.LastName, 35);
      PrintOneRow("N4_FirstName", PayerInfo.FirstName, 35);
      PrintOneRow("N4_MiddleName", PayerInfo.MiddleName, 35);
      PrintOneRow("N4_ResidenceStatus", string(PayerInfo.ResidenceStatus), 1);
      PrintOneDateRow("N4_DateBirth", PayerInfo.DateBirth);
      PrintOneRow("N4_Citizenship", PayerInfo.ResidenceCountry, 3);
      PrintOneRow("N4_DocumentType", PayerInfo.DocumentType, 2);
      PrintOneRow("N4_DocumentNumber", PayerInfo.DocumentNumber, 20);

      PrintOneSumRow("N4_Rate", Int(PayerInfo.ArrCodeParm[RateIndex].Rate), 2, false);
      if(PayerInfo.ArrCodeParm[RateIndex].IsHighRate == SET_CHAR)
         PrintOneRow("N4_KBK", "18210102080011000110", 20);
      else
         PrintOneRow("N4_KBK", "18210102010011000110", 20);
      end;
      var taxBase = PayerInfo.ArrCodeParm[RateIndex].PlusSum - PayerInfo.ArrCodeParm[RateIndex].MinusSum;
      PrintOneSumRow("N4_TotalPlus", PayerInfo.ArrCodeParm[RateIndex].PlusSum, 17, true);
      PrintOneSumRow("N4_TaxBaseSum", taxBase, 17, true);
      PrintOneSumRow("N4_TaxCalculated", PayerInfo.ArrCodeParm[RateIndex].TaxCalculated, 11, false);
      PrintOneSumRow("N4_TaxPaid", PayerInfo.ArrCodeParm[RateIndex].TaxPaid - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue, 11, false);
      PrintOneSumRow("N4_Znp", PayerInfo.ArrCodeParm[RateIndex].Znp, 11, false);
      PrintOneSumRow("N4_TaxPaid1_", PayerInfo.ArrCodeParm[RateIndex].TaxPaid - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue, 11, false);
      PrintOneSumRow("N4_TaxToReturnDue", PayerInfo.ArrCodeParm[RateIndex].TaxOver, 11, false);
      var n = 1;

      PrintOneSumRow("N4_TotalPlus_NoTax", ExtRound(Min(ExtRound(PayerInfo.ArrCodeParm[RateIndex].TaxDue, 0) / PayerInfo.ArrCodeParm[RateIndex].Rate * 100.0, taxBase), NULL, true), 17, true);
      PrintOneSumRow("N4_TaxDue", PayerInfo.ArrCodeParm[RateIndex].TaxDue, 11, false);

      PrintFormatString(NULL, "N4_Date", string(RepDate:f));
      CopyAllSheetInTotalBook("Приложение 1 (Справка о дохода)", false, "N4_PrintArea", 0, m_CurrNameNPTX2);
   END;

   PRIVATE MACRO PrintNPTXPit2_31_12_2022(PayerInfo, RateIndex, Rate, KBK, TotalPlus, TotalMinus, printed:@bool)
      var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);
      var taxBase          = 0;
      var TaxCalculated    = 0;
      var Znp              = 0;
      var TaxPaid          = 0;
      var TaxDue           = 0;
      var TaxOver          = 0;
      var TaxPaid1_        = 0;
      var TotalPlus_NoTax  = 0;

      printed = false;
     
      РассчитатьДЕПО_31_12_2022(PayerInfo.ClientID, KBK, Rate, TotalPlus, TotalMinus, @TaxBase, @TaxCalculated, @TaxPaid);

      TaxPaid1_       = TaxPaid;

      if(RateIndex >= 0)
        Znp             = PayerInfo.ArrCodeParm[RateIndex].Znp;
        TaxPaid1_       = TaxPaid1_ - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue;
        TotalPlus_NoTax = ExtRound(Min(ExtRound(PayerInfo.ArrCodeParm[RateIndex].TaxDue, 0) / PayerInfo.ArrCodeParm[RateIndex].Rate * 100.0, taxBase), NULL, true);
      end;

      if(TaxPaid > TaxCalculated)
        TaxOver = TaxPaid - TaxCalculated;
      end;

      if(TaxPaid < TaxCalculated)
        TaxDue = TaxCalculated - TaxPaid;
      end;

      if((taxBase          != 0) or
         (TotalPlus        != 0) or
         (TotalMinus       != 0) or
         (TaxCalculated    != 0) or
         (Znp              != 0) or
         (TaxPaid          != 0) or
         (TaxDue           != 0) or
         (TaxOver          != 0) or
         (TaxPaid1_        != 0) or
         (TotalPlus_NoTax  != 0)
        )

        m_PageNum = m_PageNum + 1;
        UseNewSheetInTotalBook();
        SetActiveSheet("Приложение 1 (Справка о дохода)");

        PrintOneRow("N4_OurInn", m_RepCalc2.OurINN(), 12);
        PrintOneRow("N4_OurKpp", m_RepCalc2.OurKPP(), 9);
        PrintOneRow("N4_Num", string(m_PageNum:3:o), 3);
        PrintOneSumRow("N4_NumberRef", m_ByClientNumerator.GetNexNumbByClientId(PayerInfo.ClientID), 7, false);
        PrintOneRow("N4_ClientINN", PayerInfo.ClientINN, 12);
        PrintOneRow("N4_SecondName", PayerInfo.LastName, 35);
        PrintOneRow("N4_FirstName", PayerInfo.FirstName, 35);
        PrintOneRow("N4_MiddleName", PayerInfo.MiddleName, 35);
        PrintOneRow("N4_ResidenceStatus", string(PayerInfo.ResidenceStatus), 1);
        PrintOneDateRow("N4_DateBirth", PayerInfo.DateBirth);
        PrintOneRow("N4_Citizenship", PayerInfo.ResidenceCountry, 3);
        PrintOneRow("N4_DocumentType", PayerInfo.DocumentType, 2);
        PrintOneRow("N4_DocumentNumber", PayerInfo.DocumentNumber, 20);

        PrintOneSumRow("N4_Rate", Int(Rate), 2, false);
        PrintOneRow("N4_KBK", KBK, 20);

        PrintOneSumRow("N4_TotalPlus", TotalPlus, 17, true);
        PrintOneSumRow("N4_TaxBaseSum", taxBase, 17, true);
        PrintOneSumRow("N4_TaxCalculated", TaxCalculated, 11, false);
        PrintOneSumRow("N4_TaxPaid", TaxPaid, 11, false);
        PrintOneSumRow("N4_Znp", Znp, 11, false);
        PrintOneSumRow("N4_TaxPaid1_", TaxPaid1_, 11, false);
        PrintOneSumRow("N4_TaxToReturnDue", TaxOver, 11, false);
        var n = 1;

        PrintOneSumRow("N4_TotalPlus_NoTax", TotalPlus_NoTax, 17, true);
        PrintOneSumRow("N4_TaxDue", TaxDue, 11, false);

        PrintFormatString(NULL, "N4_Date", string(RepDate:f));


        m_CurrNameNPTX2 = GetCurrNameNPTX2(PayerInfo.LastName, PayerInfo.FirstName, PayerInfo.MiddleName);
        CopyAllSheetInTotalBook("Приложение 1 (Справка о дохода)", false, "N4_PrintArea", 0, m_CurrNameNPTX2);

        printed = true;
      end;
   END;

   PRIVATE MACRO PrintApp2(PayerInfo, RateIndex, KBK)
      var i = 0;
      var IndexOfLastMinus = 0; //индекс последнего элемента массива NPTXCodeParmArr[i].MinusCodes, напечатанного на одной странице,
                                //нужен для перехода на следующую страницу, если у последнего кода NPTXCodeParmArr количество MinusCodes > 1
      var PageNum = 1;
      var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);
      var IsMinus = false;
      var SaveCurrNameAppSheet = m_CurrNameApp2;
      
      while(i < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size())
         m_PageNum = m_PageNum + 1;
         UseNewSheetInTotalBook();
         SetActiveSheet("Приложение к Справке");

         PrintOneRow("N5_OurInn", m_RepCalc2.OurINN(), 12);
         PrintOneRow("N5_OurKpp", m_RepCalc2.OurKPP(), 9);

         PrintOneRow("N5_Num", string(m_PageNum:3:o), 3);

         PrintOneSumRow("N5_NumberRef", m_ByClientNumerator.GetNexNumbByClientId(PayerInfo.ClientID), 7, false);

         PrintOneSumRow("N5_Rate", Int(PayerInfo.ArrCodeParm[RateIndex].Rate), 2, false);
         PrintOneRow("N5_KBK", KBK, 20);

         var j = 1; //нужно для перехода на новую страницу, если NPTXCodeParmArr.Size() > 15
         
         //Если для печати всех элементов NPTXCodeParmArr не хватает одной страницы, то создаем новую страницу
         while((i < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size()) and (j <= CodesOnPageApp2))
            //Для того случая, когда NPTXCodeParmArr[i].MinusCodes не помещаются на одной странице
            if(IndexOfLastMinus == 0)
               //пропускаем если основной объект не показывается, плюс все его коды вычета
               if (((not PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].IsShow) or (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSCode == NULL)) and 
                   (filter(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes,@FindIsShowMinusCode).size == 0))
                 i = i + 1;
                 continue;
               end;

               PrintOneSumRow("N5_MonthTax" + string(j) + "_", Int(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].Month), 2, false);

               if((PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn > 0.0) and (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].IsShow))
                  PrintOneRow("N5_In_Code" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSCode, 4);
                  PrintOneSumRow("N5_In_Sum" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn, 17, true);
               end;
            end;
            IsMinus = false;

            if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes.Size > 0)
               var k = IndexOfLastMinus;

               //Для последнего NPTXCodeParmArr[i] на одной странице (j = 14), если NPTXCodeParmArr[i].MinusCodes.Size > 1, то сначала печатаем один
               //NPTXCodeParmArr[i].MinusCodes[0], затем создаём новую страницу и печатаем остальные NPTXCodeParmArr[i].MinusCodes
               while((k < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes.Size) and (j <= CodesOnPageApp2))
                  //печатаем, только те что показываются
                  if (PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes[k].IsShow)
                    PrintOneRow("N5_Off_code" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes[k].MSCode, 3);
                    PrintOneSumRow("N5_Off_sum" + string(j) + "_", PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes[k].MSnnn, 16, true);
                    j = j + 1;
                    IsMinus = true;
                  end;
                  k = k + 1;
               end;
               
               IndexOfLastMinus = 0;
               if((j > CodesOnPageApp2) and (k < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].MinusCodes.Size))
                  IndexOfLastMinus = k;
               end;
            else
               PrintOneRow("N5_Off_code" + string(j) + "_", "", 3);
               PrintOneSumRow("N5_Off_sum" + string(j) + "_", "", 16, true);
            end;

            if(IndexOfLastMinus == 0)
               i = i + 1;
            end;
            if(not IsMinus)
               j = j + 1;
            end;
         end;

         if(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.Size() > CodesOnPageApp2)
            m_CurrNameApp2 = SaveCurrNameAppSheet + " " + string(PageNum);
         end;

         PrintFormatString(NULL, "N5_Date", string(RepDate:f));
         CopyAllSheetInTotalBook("Приложение к Справке", false, "N5_PrintArea", 0, m_CurrNameApp2);

         PageNum = PageNum + 1;
      end;
      
   END;

   private macro CreateNodeSvSumDoh(CodeParm:NPTXPlusCodeParm)
      var nodeSvSumDoh = NULL, nodeSvSumVych = NULL;

      if((CodeParm.PSCode != NULL) and (CodeParm.PSCode != "") and (CodeParm.IsShow))
         nodeSvSumDoh = m_XMLFile.CreateNode("СвСумДох",
                                             "Месяц", string(int(CodeParm.Month):o:2),
                                             "КодДоход", substr(CodeParm.PScode, 1, 4),
                                             "СумДоход", substr(string(ExtRound(CodeParm.PSnnn):0:2), 1, 17));

         if(nodeSvSumDoh != NULL)
            var i = 0;
            while(i < CodeParm.MinusCodes.Size)
               if (CodeParm.MinusCodes[i].IsShow)
                  nodeSvSumVych = m_XMLFile.CreateNode("СвСумВыч",
                                                       "КодВычет", substr(CodeParm.MinusCodes[i].MSCode, 1, 4),
                                                       "СумВычет", substr(string(ExtRound(CodeParm.MinusCodes[i].MSnnn):0:2), 1, 17));
                  if(nodeSvSumVych != NULL)
                     nodeSvSumDoh.appendChild(nodeSvSumVych);
                  end;
               end;

               i = i + 1;
            end;
         end;
      end;

      return nodeSvSumDoh;
   end;

   private macro CreateNodeDohVych(RateParm:NPTXRateParm)
      var nodeDohVych = NULL, nodeSvSumDoh = NULL;

      nodeDohVych = m_XMLFile.CreateNode("ДохВыч");

      if(nodeDohVych != NULL)
         var i = 0;
         while(i < RateParm.NPTXCodeParmArr.Size())
            nodeSvSumDoh = CreateNodeSvSumDoh(RateParm.NPTXCodeParmArr[i]);
            if(nodeSvSumDoh != NULL)
               nodeDohVych.appendChild(nodeSvSumDoh);
            end;
            i = i + 1;
         end;
      end;

      return nodeDohVych;
   end;

   private macro CreateNodeNalVychSSI(RateParm:NPTXRateParm, PayerInfo:NPTXPayerInfo)
      var nodeNalVychSSI = NULL, nodePredVychSSI = NULL, nodeUvedVych = NULL;

      nodeNalVychSSI = m_XMLFile.CreateNode("НалВычССИ");

      if(nodeNalVychSSI != NULL)
         /*if(m_RepCalc2.MinusG_618(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus) > 0.0)
            nodePredVychSSI = m_XMLFile.CreateNode("ПредВычССИ",
                                                    "КодВычет", "618",
                                                    "СумВычет", substr(string(ExtRound(m_RepCalc2.MinusG_618(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus)):0:2), 1, 17));
            if(nodePredVychSSI != NULL)
               nodeNalVychSSI.appendChild(nodePredVychSSI);
            end;
         end;
         if(m_RepCalc2.MinusG_619(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus) > 0.0)
            nodePredVychSSI = m_XMLFile.CreateNode("ПредВычССИ",
                                                    "КодВычет", "619",
                                                    "СумВычет", substr(string(ExtRound(m_RepCalc2.MinusG_619(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus)):0:2), 1, 17));
            if(nodePredVychSSI != NULL)
               nodeNalVychSSI.appendChild(nodePredVychSSI);
            end;
         end;*/

         /*nodeUvedVych = m_XMLFile.CreateNode("УведВыч",
                                             "КодВидУвед", ...,
                                             "НомерУвед", ...,
                                             "ДатаУвед", ...,
                                             "НОУвед", ...);*/
         
      end;

      return nodeNalVychSSI;
   end;

   private macro CreateNodeSvedDoh_31_12_2022(KBK, Rate, RateParm, PayerInfo:NPTXPayerInfo)
      var nodeSvedDoh = NULL, nodeSumItNalPer = NULL, nodeNalVychSSI = NULL, nodeSumDohNeud = NULL, nodeDohVych = NULL;
      var taxBase          = 0;
      var TotalMinus       = 0;
      var TotalPlus        = 0;
      var TaxCalculated    = 0;
      var Znp              = 0;
      var TaxPaid          = 0;
      var TaxDue           = 0;
      var TaxOver          = 0;
      var TotalPlus_NoTax  = 0;

      if(RateParm != NULL)
        TotalPlus  = RateParm.PlusSum;
        TotalMinus = RateParm.MinusSum;
      end;
      
      РассчитатьДЕПО_31_12_2022(PayerInfo.ClientID, KBK, Rate, TotalPlus, TotalMinus, @taxBase, @TaxCalculated, @TaxPaid);

      if(RateParm != NULL)
        Znp             = RateParm.Znp;
        TotalPlus_NoTax = ExtRound(Min(ExtRound(RateParm.TaxDue, 0) / Rate * 100.0, taxBase), NULL, true);
      end;

      if(TaxPaid > TaxCalculated)
        TaxOver = TaxPaid - TaxCalculated;
      end;

      if(TaxPaid < TaxCalculated)
        TaxDue = TaxCalculated - TaxPaid;
      end;

      if((taxBase          != 0) or
         (TotalPlus        != 0) or
         (TotalMinus       != 0) or
         (TaxCalculated    != 0) or
         (Znp              != 0) or
         (TaxPaid          != 0) or
         (TaxDue           != 0) or
         (TaxOver          != 0) or
         (TotalPlus_NoTax  != 0) or
         (RateParm         != NULL)
        )

        nodeSvedDoh = m_XMLFile.CreateNode("СведДох",
                                           "Ставка", substr(string(Rate:0:0), 1, 2),
                                           "КБК", KBK);

        if(nodeSvedDoh != NULL)
           nodeSumItNalPer = m_XMLFile.CreateNode("СумИтНалПер",
                                                  "СумДохОбщ", substr(string(ExtRound(TotalPlus, NULL, true):0:2), 1, 17),
                                                  "НалБаза", substr(string(ExtRound(taxBase, NULL, true):0:2), 1, 17),
                                                  "НалИсчисл", substr(string(ExtRound(TaxCalculated, 0, true):0:0), 1, 15),
                                                  "НалУдерж", substr(string(ExtRound(TaxPaid, 0):0:0), 1, 15),
                                                  "АвансПлатФикс", "0",
                                                  "СумНалПрибЗач", substr(string(ExtRound(Znp, 0):0:0), 1, 15),
                                                  "НалПеречисл", substr(string(ExtRound(TaxPaid, 0):0:0), 1, 15),
                                                  "НалУдержЛиш", substr(string(ExtRound(TaxOver, 0):0:0), 1, 15));
           if(nodeSumItNalPer)
              nodeSvedDoh.appendChild(nodeSumItNalPer);
           end;

           nodeNalVychSSI = CreateNodeNalVychSSI(RateParm, PayerInfo);
           if(nodeNalVychSSI != NULL)
              nodeSvedDoh.appendChild(nodeNalVychSSI);
           end;

           nodeSumDohNeUd = m_XMLFile.CreateNode("СумДохНеУд",
                                                 "СумДохНеУдерж", substr(string(ExtRound(Min(ExtRound(TaxDue,0) / Rate * 100.0,taxBase), NULL, true):0:2), 1, 17),
                                                 "СумНеУдНал", substr(string(ExtRound(TaxDue, 0):0:0), 1, 17));
           if(nodeSvedDoh != NULL)
              nodeSvedDoh.appendChild(nodeSumDohNeUD);
           end;

           if(RateParm != NULL)
             nodeDohVych = CreateNodeDohVych(RateParm);
             if(nodeDohVych != NULL)
                nodeSvedDoh.appendChild(nodeDohVych);
             end;
           end;
        end;
      end;

      return nodeSvedDoh;
   end;

   private macro CreateNodeSvedDoh(RateParm:NPTXRateParm, PayerInfo:NPTXPayerInfo)
      var nodeSvedDoh = NULL, nodeSumItNalPer = NULL, nodeNalVychSSI = NULL, nodeSumDohNeud = NULL, nodeDohVych = NULL;

      nodeSvedDoh = m_XMLFile.CreateNode("СведДох",
                                         "Ставка", substr(string(RateParm.Rate:0:0), 1, 2),
                                         "КБК", IIF(RateParm.IsHighRate == SET_CHAR, "18210102080011000110", "18210102010011000110"));

      if(nodeSvedDoh != NULL)
         var taxBase = RateParm.PlusSum - RateParm.MinusSum;
         nodeSumItNalPer = m_XMLFile.CreateNode("СумИтНалПер",
                                                "СумДохОбщ", substr(string(ExtRound(RateParm.PlusSum, NULL, true):0:2), 1, 17),
                                                "НалБаза", substr(string(ExtRound(taxBase, NULL, true):0:2), 1, 17),
                                                "НалИсчисл", substr(string(ExtRound(RateParm.TaxCalculated, 0, true):0:0), 1, 15),
                                                "НалУдерж", substr(string(ExtRound(RateParm.TaxPaid, 0):0:0), 1, 15),
                                                "АвансПлатФикс", "0",
                                                "СумНалПрибЗач", substr(string(ExtRound(RateParm.Znp, 0):0:0), 1, 15),
                                                "НалПеречисл", substr(string(ExtRound(RateParm.TaxPaid, 0):0:0), 1, 15),
                                                "НалУдержЛиш", substr(string(ExtRound(RateParm.TaxOver, 0):0:0), 1, 15));
         if(nodeSumItNalPer)
            nodeSvedDoh.appendChild(nodeSumItNalPer);
         end;

         nodeNalVychSSI = CreateNodeNalVychSSI(RateParm, PayerInfo);
         if(nodeNalVychSSI != NULL)
            nodeSvedDoh.appendChild(nodeNalVychSSI);
         end;

         nodeSumDohNeUd = m_XMLFile.CreateNode("СумДохНеУд",
                                               "СумДохНеУдерж", substr(string(ExtRound(Min(ExtRound(RateParm.TaxDue,0) / RateParm.Rate * 100.0,taxBase), NULL, true):0:2), 1, 17),
                                               "СумНеУдНал", substr(string(ExtRound(RateParm.TaxDue, 0):0:0), 1, 17));
         if(nodeSvedDoh != NULL)
            nodeSvedDoh.appendChild(nodeSumDohNeUD);
         end;

         nodeDohVych = CreateNodeDohVych(RateParm);
         if(nodeDohVych != NULL)
            nodeSvedDoh.appendChild(nodeDohVych);
         end;
      end;

      return nodeSvedDoh;
   end;

   private macro CreateNodeSpravDoh(partyNum)
      var nodeSpravDoh = NULL, nodePoluchDoh = NULL, nodePoluchDohFIO = NULL, nodeUdLichnFL = NULL, nodeSvedDoh = NULL;

      if ((NPTXPayerInfoArr[partyNum].ArrCodeParm == NULL) or (NPTXPayerInfoArr[partyNum].ArrCodeParm.size == 0))
        return NULL;
      end;

      nodeSpravDoh = m_XMLFile.CreateNode("СправДох",
                                          "НомСпр", string(m_ByClientNumerator.GetNexNumbByClientId(NPTXPayerInfoArr[partyNum].ClientID)),
                                          "НомКорр", "00");

      if(nodeSpravDoh != NULL)
         nodePoluchDoh = m_XMLFile.CreateNode("ПолучДох",
                                              "ИННФЛ", substr(NPTXPayerInfoArr[partyNum].ClientINN, 1, 12),
                                              "Статус", substr(string(NPTXPayerInfoArr[partyNum].ResidenceStatus:0:0), 1, 1),
                                              "ДатаРожд", string(NPTXPayerInfoArr[partyNum].DateBirth:f),
                                              "Гражд", NPTXPayerInfoArr[partyNum].ResidenceCountry);

         if(nodePoluchDoh != NULL)
            nodePoluchDohFIO = m_XMLFile.CreateNode("ФИО",
                                                    "Фамилия", substr(NPTXPayerInfoArr[partyNum].LastName, 1, 60),
                                                    "Имя", substr(NPTXPayerInfoArr[partyNum].FirstName, 1, 60),
                                                    "Отчество", substr(NPTXPayerInfoArr[partyNum].MiddleName, 1, 60));
            if(nodePoluchDohFIO != NULL)
               nodePoluchDoh.appendChild(nodePoluchDohFIO);
            end;

            nodeUdLichnFL = m_XMLFile.CreateNode("УдЛичнФЛ",
                                                 "КодУдЛичн", substr(string(NPTXPayerInfoArr[partyNum].DocumentType), 1, 2),
                                                 "СерНомДок", substr(string(NPTXPayerInfoArr[partyNum].DocumentNumber), 1, 25));
            if(nodeUdLichnFL != NULL)
               nodePoluchDoh.appendChild(nodeUdLichnFL);
            end;

            nodeSpravDoh.appendChild(nodePoluchDoh);
         end;

         var i = 0;
         if(m_RepCalc2.EndDate() == date(31,12,2022))
           var printKBK1 = false;
           var printKBK2 = false;
           var printKBK3 = false;
           
           while(i < NPTXPayerInfoArr[partyNum].ArrCodeParm.Size())
              if(NPTXPayerInfoArr[partyNum].ArrCodeParm[i].IsHighRate == SET_CHAR)
                printKBK3 = true;
              else
                printKBK1 = true;
              end;

              nodeSvedDoh = CreateNodeSvedDoh_31_12_2022(IIF(NPTXPayerInfoArr[partyNum].ArrCodeParm[i].IsHighRate == SET_CHAR, КБК3, КБК1), NPTXPayerInfoArr[partyNum].ArrCodeParm[i].Rate, NPTXPayerInfoArr[partyNum].ArrCodeParm[i], NPTXPayerInfoArr[partyNum]);
              if(nodeSvedDoh != NULL)
                 nodeSpravDoh.appendChild(nodeSvedDoh);
              end;
              i = i + 1;
           end;

           var m = 1;
           while(m <= 3)
             var printed = false;

             if(((m == 1) and (printKBK1 == false)) or
                ((m == 2) and (printKBK2 == false)) or
                ((m == 3) and (printKBK3 == false)) 
               )
               nodeSvedDoh = CreateNodeSvedDoh_31_12_2022(IIF(m==1, КБК1, IIF(m==2, КБК2, КБК3)), IIF(m==1, 13, IIF(m==2, 13, 15)), NULL, NPTXPayerInfoArr[partyNum]);
               if(nodeSvedDoh != NULL)
                  nodeSpravDoh.appendChild(nodeSvedDoh);
               end;

               if(m < 3)
                 nodeSvedDoh = CreateNodeSvedDoh_31_12_2022(IIF(m==1, КБК1, IIF(m==2, КБК2, КБК3)), 30, NULL, NPTXPayerInfoArr[partyNum]);
                 if(nodeSvedDoh != NULL)
                    nodeSpravDoh.appendChild(nodeSvedDoh);
                 end;
               end;
             end;

             m = m + 1;
           end;
         else
           while(i < NPTXPayerInfoArr[partyNum].ArrCodeParm.Size())
              nodeSvedDoh = CreateNodeSvedDoh(NPTXPayerInfoArr[partyNum].ArrCodeParm[i], NPTXPayerInfoArr[partyNum]);
              if(nodeSvedDoh != NULL)
                 nodeSpravDoh.appendChild(nodeSvedDoh);
              end;
              i = i + 1;
           end;
         end;
      end;
         
      return nodeSpravDoh;
   end;

   private macro CreateNodeRaschSumNal(Rate, KBK, TotalPlus, DivPlus, Znp, CountFL, TotalMinus, TaxCalculated, TaxCalculatedDiv, TaxPaid, TaxDue, TaxOver, TaxToReturnDue)
      var nodeRaschSumNal = NULL, nodeSumNachisl = NULL, nodeSumNachislDiv = NULL, nodeSumNalUderzh = NULL, nodeSumNalNeUderzh = NULL, nodeSumNalIzlUderzh = NULL;
      var nodeSumNalVozvr = NULL;

      nodeRaschSumNal = m_XMLFile.CreateNode("РасчСумНал",
                                             "Ставка", substr(string(Rate:0:0), 1, 2),
                                             "КБК", KBK,
                                             "СумНачислНач", substr(string(TotalPlus:0:2), 1, 17),
                                             "СумНачислДив", substr(string(DivPlus:0:2), 1, 17),
                                             "СумНачислДог", "0",
                                             "СумНачислРаб", "0",
                                             "СумНачислКвал", "0",
                                             "КолКвал", "0",
                                             "СумНалИсчКвал", "0",
                                             "СумНалПриб", substr(string(Znp:0:0), 1, 15),
                                             "КолФЛ", substr(string(CountFL:0:0), 1, 6),
                                             "СумВыч", substr(string(TotalMinus:0:2), 1, 17),
                                             "СумНалИсч", substr(string(ExtRound(TaxCalculated, 0, IIF(TaxCalculated < 0, false, true)):0:0), 1, 15),
                                             "СумНалИсчДив", substr(string(ExtRound(TaxCalculatedDiv, 0, true):0:0), 1, 15),
                                             "СумНалУдерж", substr(string(TaxPaid:0:0), 1, 15),
                                             "СумНалНеУдерж", substr(string(TaxDue:0:0), 1, 15),
                                             "СумНалИзлУдерж", substr(string(TaxOver:0:0), 1, 15),
                                             "СумНалВозвр", substr(string(TaxToReturnDue:0:0), 1, 15),
                                             "СумФикс", "0");


      return nodeRaschSumNal;
   end;

   private macro CreateNodeObyazNA(Sum021:Money, Sum022:Money, Sum023:Money, Sum024:Money)
      var nodeObyazNA = NULL, nodeSvedSumNalUd = NULL, nodeSvedSumNalVoz = NULL;
      var TaxToReturnDue = $0.0;
      var TaxPaidDate = Sum021 + Sum022 + Sum023 + Sum024;

      m_RepCalc.GetTaxReturnSums(@TaxToReturnDue, false);
      nodeObyazNA = m_XMLFile.CreateNode("ОбязНА",
                                         "КБК", "18210102010011000110", 
                                         "СумНалУд", substr(string(TaxPaidDate:0:0), 1, 15),
                                         "СумНалВоз", substr(string(TaxToReturnDue:0:0), 1, 15));

      nodeSvedSumNalUd = m_XMLFile.CreateNode("СведСумНалУд",
                                              "СумНал1Срок", substr(string(Sum021:0:0), 1, 15),
                                              "СумНал2Срок", substr(string(Sum022:0:0), 1, 15),
                                              "СумНал3Срок", substr(string(Sum023:0:0), 1, 15),
                                              "СумНал4Срок", substr(string(Sum024:0:0), 1, 15));
      if( TaxPaidDate > 0 )
         nodeObyazNA.appendChild(nodeSvedSumNalUd); 
      end;

      while(m_RepCalc.Returns().MoveNext())
         nodeSvedSumNalVoz = m_XmlFile.CreateNode("СведСумНалВоз",
                                                  "ДатаВозвр", string(Date(m_RepCalc.Returns().Value("t_DateTaxReturn")):f),
                                                  "СумНал", substr(string(m_RepCalc.Returns().Value("t_TaxToReturnDue"):0:0), 1, 15));
         if(TaxToReturnDue > 0)
            nodeObyazNA.appendChild(nodeSvedSumNalVoz);
         end;
      end;

      return nodeObyazNA;
   end;

   private macro CreateNodeObyazNAHighRate(Sum021:Money, Sum022:Money, Sum023:Money, Sum024:Money)
      var nodeObyazNA = NULL, nodeSvedSumNalUd = NULL, nodeSvedSumNalVoz = NULL;
      var ExistsRets = false;
      var TaxToReturnDue = $0.0;
      var TaxPaidDate = Sum021 + Sum022 + Sum023 + Sum024;

      m_RepCalc.GetTaxReturnSums(@TaxToReturnDue, true);

      ExistsRets = m_RepCalc.ReturnsHighRate().MoveFirst();

      nodeObyazNA = m_XMLFile.CreateNode("ОбязНА",
                                         "КБК", "18210102080011000110", 
                                         "СумНалУд", substr(string(TaxPaidDate:0:0), 1, 15),
                                         "СумНалВоз", substr(string(TaxToReturnDue:0:0), 1, 15));

      if( TaxPaidDate > 0 )
         nodeSvedSumNalUd = m_XMLFile.CreateNode("СведСумНалУд",
                                                 "СумНал1Срок", substr(string(Sum021:0:0), 1, 15),
                                                 "СумНал2Срок", substr(string(Sum022:0:0), 1, 15),
                                                 "СумНал3Срок", substr(string(Sum023:0:0), 1, 15),
                                                 "СумНал4Срок", substr(string(Sum024:0:0), 1, 15));

         nodeObyazNA.appendChild(nodeSvedSumNalUd); 
      end;

      while(ExistsRets)
         nodeSvedSumNalVoz = m_XmlFile.CreateNode("СведСумНалВоз",
                                                  "ДатаВозвр", string(Date(m_RepCalc.ReturnsHighRate().Value("t_DateTaxReturn")):f),
                                                  "СумНал", IIF(ExistsRets,substr(string(m_RepCalc.ReturnsHighRate().Value("t_TaxToReturnDue"):0:0), 1, 15), "0"));
         if(TaxToReturnDue > 0)
            nodeObyazNA.appendChild(nodeSvedSumNalVoz);
         end;

         ExistsRets = m_RepCalc.ReturnsHighRate().MoveNext();
      end;

      return nodeObyazNA;
   end;

   //При запуске за дату 31.12.2022
   PRIVATE MACRO PrintPart2_31_12_2022_XML(KBK, Rate)
     var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);
     var existsRate       = false;
     var find             = false;
     var TotalPlus        = 0;
     var DivPlus          = 0;
     var Amount           = 0;
     var TotalMinus       = 0;
     var TaxCalculated    = 0;
     var TaxCalculatedDiv = 0;
     var Znp              = 0;
     var TaxPaid          = 0;
     var TaxDue           = 0;
     var TaxOver          = 0;
     var TaxToReturnDue   = 0;
     var TaxBaseSum       = 0;
     var nodeRaschSumNal = NULL;
     
     existsRate = m_RepCalc2.Rates().MoveFirst();

     while(existsRate)
       if((m_RepCalc2.Rates().Value("t_KBK") == KBK) AND (m_RepCalc2.Rates().Value("t_Rate") == Rate))
         РассчитатьДЕПО_31_12_2022(-1, KBK, Rate, m_RepCalc2.Rates().Value("t_TotalPlus"), m_RepCalc2.Rates().Value("t_TotalMinus"), @TaxBaseSum, @TaxCalculated, @TaxPaid);

         DivPlus          = m_RepCalc2.Rates().Value("t_DivPlus");
         Amount           = SQL_ConvTypeInteger(m_RepCalc2.Rates().Value("t_CountFL"));
         TotalPlus        = m_RepCalc2.Rates().Value("t_TotalPlus");
         TotalMinus       = m_RepCalc2.Rates().Value("t_TotalMinus");
         TaxCalculatedDiv = m_RepCalc2.Rates().Value("t_TaxCalculatedDiv");
         Znp              = m_RepCalc2.Rates().Value("t_Znp");
         TaxToReturnDue   = m_RepCalc2.Rates().Value("t_TaxToReturnDue");

         find = true;
         break;
       end;

       existsRate = m_RepCalc2.Rates().MoveNext();
     end;

     if(find == false)
       РассчитатьДЕПО_31_12_2022(-1, KBK, Rate, 0, 0, @TaxBaseSum, @TaxCalculated, @TaxPaid);
     end;

     if(TaxPaid > 0)
       TaxToReturnDue = 0;
     else
       TaxToReturnDue = -TaxPaid;
       TaxPaid = 0;
     end;

     if(TaxPaid <= TaxCalculated)
       TaxDue  = TaxCalculated - (TaxPaid + Znp) - TaxToReturnDue;
     else
       TaxOver = TaxPaid - TaxCalculated + TaxToReturnDue;
     end;

     if(   (TotalPlus        != 0)
        or (DivPlus          != 0)
        or (Amount           != 0)
        or (TotalMinus       != 0)
        or (TaxCalculated    != 0)
        or (TaxCalculatedDiv != 0)
        or (Znp              != 0)
        or (TaxPaid          != 0)
        or (TaxDue           != 0)
        or (TaxOver          != 0)
        or (TaxToReturnDue   != 0)
       )
       
       nodeRaschSumNal = CreateNodeRaschSumNal(Rate, KBK, TotalPlus, DivPlus, Znp, Amount, TotalMinus, TaxCalculated, TaxCalculatedDiv, TaxPaid, TaxDue, TaxOver, TaxToReturnDue)
     end;

     return nodeRaschSumNal;
   END;

   private macro CreateNodeNDFL62(year:Integer)
      var nodeNDFL62 = NULL, nodeObyazNA = NULL, RateExists = false, nodeRaschSumNal = NULL, nodeSpravDoh = NULL, nodeObyazNAHighRate = NULL;
      var partyNum = 0, rateNum = 0, RatesExists = false;
      var Lnk1, Lnk2, LnkPrev1, LnkPrev2/*, year = 0*/;
      var TaxDueQuery, TaxDueCmd, TaxDueDS, TaxDuePrevQuery, TaxDuePrevCmd, TaxDuePrevDS;
      var TaxDueSum = 0.0, TaxDuePrevSum = 0.0;

      nodeNDFL62 = m_XMLFile.CreateNode("НДФЛ6.2");

      if(nodeNDFL62 != NULL)
         if(m_IsPart1)
            if(m_RepCalc.m_StatPart1)
               m_RepCalc.GetPaidSums();
               nodeObyazNA = CreateNodeObyazNA(m_RepCalc.m_Sum021, m_RepCalc.m_Sum022, m_RepCalc.m_Sum023, m_RepCalc.m_Sum024);
               nodeObyazNAHighRate = CreateNodeObyazNAHighRate(m_RepCalc.m_Sum021_HighRate, m_RepCalc.m_Sum022_HighRate, m_RepCalc.m_Sum023_HighRate, m_RepCalc.m_Sum024_HighRate);
               
               if(nodeObyazNA != NULL)
                  nodeNDFL62.appendChild(nodeObyazNA);
               end;
               if(nodeObyazNAHighRate != NULL)
                  nodeNDFL62.appendChild(nodeObyazNAHighRate);
               end;
            end;
         end;

         if(m_IsPart2/* and (m_RepCalc2.PP() == "34") or (m_RepCalc2.PP() == "51") or (m_RepCalc2.PP() == "52") or (m_RepCalc2.PP() == "53") or (m_RepCalc2.PP() == "90")*/ )
            InitProgress(NPTXPayerInfoArr.Size(), "Форма 6-НДФЛ с 01.01.2021", "Формирование узлов СправДох");

            if(m_IsApp1)
               while(partyNum < NPTXPayerInfoArr.Size())
                  nodeSpravDoh = CreateNodeSpravDoh(partyNum);
                  if (nodeSpravDoh != NULL)
                    nodeNDFL62.appendChild(nodeSpravDoh);
                  end;
                  UseProgress(partyNum = partyNum + 1);
               end;
            end;
            RemProgress();
         end;

         if(m_RepCalc2.EndDate() == date(31,12,2022))
           InitProgress(-1, "Форма 6-НДФЛ с 01.01.2021", "Печать раздела 2");

           nodeRaschSumNal = PrintPart2_31_12_2022_XML(КБК1, 13);
           if(nodeRaschSumNal != NULL)
              nodeNDFL62.appendChild(nodeRaschSumNal);
           end;
           nodeRaschSumNal = PrintPart2_31_12_2022_XML(КБК1, 30);
           if(nodeRaschSumNal != NULL)
              nodeNDFL62.appendChild(nodeRaschSumNal);
           end;
           nodeRaschSumNal = PrintPart2_31_12_2022_XML(КБК2, 13);
           if(nodeRaschSumNal != NULL)
              nodeNDFL62.appendChild(nodeRaschSumNal);
           end;
           nodeRaschSumNal = PrintPart2_31_12_2022_XML(КБК2, 30);
           if(nodeRaschSumNal != NULL)
              nodeNDFL62.appendChild(nodeRaschSumNal);
           end;
           nodeRaschSumNal = PrintPart2_31_12_2022_XML(КБК3, 15);
           if(nodeRaschSumNal != NULL)
              nodeNDFL62.appendChild(nodeRaschSumNal);
           end;

           RemProgress();
         else
           RatesExists = m_RepCalc2.Rates().MoveFirst();
           if(RatesExists)
              InitProgress(m_RepCalc2.Rates().Value("t_Count"), "Форма 6-НДФЛ с 01.01.2021", "Формирование узлов РасчСумНал");
              while(RatesExists)
                 nodeRaschSumNal = CreateNodeRaschSumNal(m_RepCalc2.Rates().Value("t_Rate"),
                                                         m_RepCalc2.Rates().Value("t_KBK"),
                                                         m_RepCalc2.Rates().Value("t_TotalPlus"),
                                                         m_RepCalc2.Rates().Value("t_DivPlus"),
                                                         m_RepCalc2.Rates().Value("t_Znp"),
                                                         m_RepCalc2.Rates().Value("t_CountFL"),
                                                         m_RepCalc2.Rates().Value("t_TotalMinus"),
                                                         m_RepCalc2.Rates().Value("t_TaxCalculated"),
                                                         m_RepCalc2.Rates().Value("t_TaxCalculatedDiv"),
                                                         m_RepCalc2.Rates().Value("t_TaxPaid"),
                                                         m_RepCalc2.Rates().Value("t_TaxDue"),
                                                         m_RepCalc2.Rates().Value("t_TaxOver"),
                                                         m_RepCalc2.Rates().Value("t_TaxToReturnDue")
                                                        );

                 if(nodeRaschSumNal != NULL)
                    nodeNDFL62.appendChild(nodeRaschSumNal);
                 end;
                 UseProgress(rateNum = rateNum + 1);
                 RatesExists = m_RepCalc2.Rates().MoveNext();
              end;
              RemProgress();
           end;
         end;
      end;

      return nodeNDFL62;
   end;

   private macro CreateNodeSigner()
      var nodeSigner = NULL, nodeSignerFIO = NULL;

      nodeSigner = m_XMLFile.CreateNode("Подписант",
                                        "ПрПодп", "1");

      nodeSignerFIO = m_XMLFile.CreateNode("ФИО",
                                           "Фамилия", substr(m_RepCalc2.FirstPersonLastName(), 1, 60),
                                           "Имя", substr(m_RepCalc2.FirstPersonFirstName(), 1, 60),
                                           "Отчество", substr(m_RepCalc2.FirstPersonMiddleName(), 1, 60));
      nodeSigner.appendChild(nodeSignerFIO);

      return nodeSigner;
   end;

   private macro CreateNodeSvNP()
      var nodeSvNP = NULL, nodeNPUL = NULL, KPP = m_RepCalc2.OurKPP();

      if(substr(KPP, 5, 2) == "50")
         KPP = NULL;
      end;
      nodeSvNP = m_XMLFile.CreateNode("СвНП",
                                      "ОКТМО", substr(m_RepCalc2.OurOKTMO(), 1, 11),
                                      "Тлф", substr(m_RepCalc2.OurPhone(), 1, 20));
      nodeNPUL = m_XMLFile.CreateNode("НПЮЛ",
                                      "НаимОрг", substr(m_RepCalc2.OurName(), 1, 1000),
                                      "ИННЮЛ", substr(m_RepCalc2.OurINN(), 1, 10),
                                      "КПП", substr(KPP, 1, 9));
      nodeSvNP.appendChild(nodeNPUL);

      return nodeSvNP;
   end;

   private macro CreateNodeDocument()
      var nodeDocument = NULL, nodeSvNP = NULL, nodeSigner = NULL, nodeNDFL62 = NULL, year = 0;
      var RepDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_REPDATE);

      DateSplit(m_RepCalc2.EndDate(), NULL, NULL, year);
      nodeDocument = m_XMLFile.CreateNode("Документ",
                                          "КНД", "1151100",
                                          "ДатаДок", date_as_string(1, RepDate, false),
                                          "Период", m_RepCalc2.PP(),
                                          "ОтчетГод", year,
                                          "КодНО", substr(m_RepCalc2.OurFNSCode(), 1, 4),
                                          "НомКорр", "0",
                                          "ПоМесту", "214");
      nodeSvNP = CreateNodeSvNP();
      nodeDocument.appendChild(nodeSvNP);
      nodeSigner = CreateNodeSigner();
      nodeDocument.appendChild(nodeSigner);
      nodeNDFL62 = CreateNodeNDFL62(year);
      nodeDocument.appendChild(nodeNDFL62);

      return nodeDocument;
   end;

   private macro CreateXML()
      var day, month, year;
      var refID, num = "";
      var nodeFile = NULL, nodeDocument = NULL;
      var FileName = "", IndexFileName = 0;

      DateSplit(m_RepCalc2.EndDate(), day, month, year);
      GetReferenceIDByType(134, 1, refID);
      GenerateReference(refID, num);
      m_XMLFile.SetFileName("NO_NDFL6.2_1_231_00_05_03_" + num + ".xml");

      FileName = m_XMLFile.GetFileName();
      IndexFileName = Index(FileName, ".xml");
      if(IndexFileName > 0)
         FileName = substr(FileName, 1, IndexFileName - 1);
      end;
      nodeFile = m_XMLFile.CreateNode("Файл",
                                      "ИдФайл", FileName,
                                      "ВерсПрог", "RS-Bank",
                                      "ВерсФорм", "5.03");

      if(nodeFile != NULL)
         nodeDocument = CreateNodeDocument();

         nodeFile.appendChild(nodeDocument);
         m_XMLFile.GetXMLObj().appendChild(nodeFile);
      end;
   end;

   private macro GetDateOfIncomeOperation(MinDate:Date, MaxDate:Date)
      var DateOperQuery = "select nvl(max(q.t_OperDate), ?) as t_OperDate " /*1*/
                        + "from ( "
                        + "        select max(nptxop.t_OperDate) as t_OperDate "
                        + "        from dnptxop_dbt nptxop "
                        + "        where nptxop.t_CLient = ? " /*2*/
                        + "          and nptxop.t_OperDate between ? and ? " /*3, 4*/
                        + "          and nptxop.t_Status > 0 "
                        + "          and ( "
                        + "                 ( "
                        + "                    nptxop.t_DocKind = " + string(DL_WRTMONEY)
                        + "                    and nptxop.t_SubKind_Operation = " + string(DL_NPTXOP_WRTKIND_WRTOFF)
                        + "                 ) "
                        + "                 or ( "
                        + "                       nptxop.t_DocKind = " + string(DL_CALCNDFL)
                        + "                       and nptxop.t_SubKind_Operation in( " + string(DL_TXBASECALC_OPTYPE_ENDYEAR) + ", "
                                                                                       + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS)
                                                                                + ") "
                        + "                    ) "
                        + "              ) "
                        + "          and exists( "
                        + "                       select 1 "
                        + "                       from dnptxobdc_dbt obdc "
                        + "                       where obdc.t_DocID = nptxop.t_ID "
                        + "                    ) "
                        + "        union "
                        + "        select max(tick.t_DealDate) as t_OperDate "
                        + "        from ddl_tick_dbt tick "
                        + "        where tick.t_ClientID = ? " /*5*/
                        + "              and tick.t_DealDate between ? and ? " /*6, 7*/
                        + "              and tick.t_DealStatus > 0 "
                        + "              and ( "
                        + "                     ( "
                        + "                        tick.t_BOfficeKind = " + string(DL_AVRWRT)
                        + "                        and tick.t_DealType = 2010 "
                       + "                      ) "
                        + "                  or ( "
                        + "                        tick.t_BOfficeKind = " + string(DL_RETIREMENT_OWN)
                        + "                        and tick.t_DealType = 2052 "
                        + "                        and exists( "
                        + "                                     select 1 "
                        + "                                     from dnptxobj_dbt obj "
                        + "                                     where obj.t_AnaliticKind1 = 1020 "
                        + "                                       and obj.t_Analitic1 = tick.t_DealID "
                        + "                                       and obj.t_Client = ? " /*8*/
                        + "                                  ) "
                        + "                     ) "
                        + "                  or ( "
                        + "                        tick.t_BOfficeKind = " + string(DL_RETURN_DIVIDEND)
                        + "                        and tick.t_DealType = 12108 "
                        + "                        and exists( "
                        + "                                     select 1 "
                        + "                                     from dnptxobj_dbt obj "
                        + "                                     where obj.t_AnaliticKind1 = 1100 "
                        + "                                       and obj.t_Analitic1 = tick.t_DealID "
                        + "                                       and obj.t_Client = ? " /*9*/
                        + "                                  ) "
                        + "                     ) "
                        + "                  ) "
                        + "        union "
                        + "        select max(dl_order.t_SignDate) as t_OperDate "
                        + "        from ddl_order_dbt dl_order "
                        + "        where dl_order.t_Contractor = ? " /*10*/
                        + "          and dl_order.t_SignDate between ? and ? " /*11, 12*/
                        + "          and dl_order.t_DocKind = " + string(DL_VEKSELDRAWORDER)
                        + "          and dl_order.t_Kind_Operation = " + string(VSOP_REPAY)
                        + "          and dl_order.t_ContractStatus > 0 "
                        + "     ) q ";

      var DateOperCmd = DL_RSDCommand(DateOperQuery);
      DateOperCmd.AddParam(MaxDate); /*1*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*2*/
      DateOperCmd.AddParam(MinDate); /*3*/
      DateOperCmd.AddParam(MaxDate); /*4*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*5*/
      DateOperCmd.AddParam(MinDate); /*6*/
      DateOperCmd.AddParam(MaxDate); /*7*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*8*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*9*/
      DateOperCmd.AddParam(m_RepCalc2.ClientID()); /*10*/
      DateOperCmd.AddParam(MinDate); /*11*/
      DateOperCmd.AddParam(MaxDate); /*12*/

      var DateOperDS = DateOperCmd.Execute();
      if(DateOperDS.MoveNext())
         return Date(DateOperDS.OperDate);
      else
         return Date(0, 0, 0);
      end;
   end;

   private macro Create()
      var partyNum = 0;
      var RateStr = "";
      var PayExists = false;
      var RetExists = false;
      var Part2RateExists = false;

      var Sym = "";
      var Sym_ = "";
      var OldSym = "";
      var PoiNum = 0;
      var isFirst = true;

      NPTXPayerInfoArr.Size = 0;

      if(m_RepCalc2.Count() > 0)
         if(m_IsPart2)
            InitProgress(m_RepCalc2.Count(), "Форма 6-НДФЛ с 01.01.2021", "Отбор данных для раздела 2");
            while(m_RepCalc2.Next())
               m_RepCalc2.ClearData();

               // Ставка 13% (30%)
               m_RepCalc2.CalcData(INFORATE_TOTAL);

               // Ставка 9 (15%) по дивидендам
               m_RepCalc2.Refresh_TaxDivValArray();
               if(m_RepCalc2.m_TaxDivValArray.Size > 0)
                  while(m_RepCalc2.m_TaxDivValArrayCurIndex < m_RepCalc2.m_TaxDivValArray.Size())
                     m_RepCalc2.CalcData(INFORATE9_NOTRES_DIV);
                     m_RepCalc2.m_TaxDivValArrayCurIndex = m_RepCalc2.m_TaxDivValArrayCurIndex + 1;
                  end;
               end;
               m_RepCalc2.CalcData(INFORATE9_NOTRES_DIV);

               // Для депоклиентов по операциям расчета выплат по ц/б в Депозитарии своя ставка для каждой операции
               if(m_RepCalc2.IsDepoClient())
                  m_RepCalc2.CalcData(0);
               end;

               if(m_IsApp1 or m_InXML or m_IsApp1Client or m_IsSlice)
                  NPTXPayerInfoArr[NPTXPayerInfoArr.Size()] = NPTXPayerInfo(m_RepCalc2.ClientID, m_RepCalc2.ClientINN(), m_RepCalc2.LastName(),
                                                                            m_RepCalc2.FirstName(), m_RepCalc2.MiddleName(), m_RepCalc2.ResidenceStatus(),
                                                                            m_RepCalc2.DateBirth(), m_RepCalc2.Citizenship(),
                                                                            m_RepCalc2.DocumentType(), m_RepCalc2.DocumentNumber(),
                                                                            m_RepCalc2.m_ArrCodeParms);
               end;

               UseProgress(partyNum = partyNum + 1);
            end;
            RemProgress();

            if(m_IsApp1)
               var k = 0;
               while(k < NPTXPayerInfoArr.Size)
                  m_NPTX2PageCount = m_NPTX2PageCount + NPTXPayerInfoArr[k].ArrCodeParm.Size;
                  k = k + 1;
               end;
            end;

            Part2RateExists = m_RepCalc2.Rates().MoveFirst();
            m_Part2PageCount = SQL_ConvTypeInteger(m_RepCalc2.Rates().Value("t_Count"));
         end;
      else
         m_Part2PageCount = 0;
         Part2RateExists = false;
         MsgBox("За отчетный период для раздела 2 нет данных");
      end;

       if(m_IsPart1)
          m_RepCalc = NPTXRepCalc_NPTXPIT6_NEW(Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P1_BEGDATE),
                                               Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P1_ENDDATE),
                                               Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_BOCB_CHECKBOX),
                                               Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DEPO_CHECKBOX),
                                               Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_VS_CHECKBOX));

          m_RepCalc.Calculate();

          if(m_RepCalc.m_StatPart1)
             RetExists = m_RepCalc.Returns().MoveFirst();

             var ReturnsPageCount = 0;
             if(RetExists)
                ReturnsPageCount = SQL_ConvTypeInteger(m_RepCalc.Returns().Value("t_Count")) / ReturnsOnPage;
                m_Part1PageCount = Int(ReturnsPageCount);
                if(m_Part1PageCount < ReturnsPageCount)
                   m_Part1PageCount = m_Part1PageCount + 1;
                end;
             end;

             var RetHighRateExists = m_RepCalc.ReturnsHighRate().MoveFirst();
             if(RetHighRateExists)
                ReturnsPageCount = SQL_ConvTypeInteger(m_RepCalc.ReturnsHighRate().Value("t_Count")) / ReturnsOnPage;
                m_Part1HighRatePageCount = Int(ReturnsPageCount);
                if(m_Part1HighRatePageCount < ReturnsPageCount)
                   m_Part1HighRatePageCount = m_Part1HighRatePageCount + 1;
                end;
             end;

             m_RepCalc.GetPaidSums();
             if(((m_RepCalc.m_Sum021 > 0) or (m_RepCalc.m_Sum022 > 0) or (m_RepCalc.m_Sum023 > 0) or (m_RepCalc.m_Sum024 > 0)) and (m_Part1PageCount == 0))
                m_Part1PageCount = 1;
             end;

             if(((m_RepCalc.m_Sum021_HighRate > 0) or (m_RepCalc.m_Sum022_HighRate > 0) or (m_RepCalc.m_Sum023_HighRate > 0) or (m_RepCalc.m_Sum024_HighRate > 0)) and (m_Part1HighRatePageCount == 0))
                m_Part1HighRatePageCount = 1;
             end;
          end;
       end;

       PrintTitle(1 + m_Part1PageCount + m_Part1HighRatePageCount + m_Part2PageCount + m_NPTX2PageCount * 2);
       if(m_IsPart1)
          if(m_RepCalc.m_StatPart1)
             PrintPart1(Part2RateExists, m_RepCalc.m_Sum021, m_RepCalc.m_Sum022, m_RepCalc.m_Sum023, m_RepCalc.m_Sum024, m_RepCalc.m_Sum021_HighRate,
                        m_RepCalc.m_Sum022_HighRate, m_RepCalc.m_Sum023_HighRate, m_RepCalc.m_Sum024_HighRate);
          else
             MsgBox("Неверно задана дата окончания отчетного периода для раздела 1");
          end;
       end;

       if(m_IsPart2 and (m_RepCalc2.Count() > 0))
          PrintPart2(Part2RateExists);

          if(m_IsApp1)
             partyNum = 0;
             var i = 0;
             InitProgress(NPTXPayerInfoArr.Size, "Форма 6-НДФЛ с 01.01.2021", "Печать приложения №1");
             SheetsNamesNPTX2.Size = 0;
             SheetsNamesAttach2.Size = 0;
             while(i < NPTXPayerInfoArr.Size)
                var PlusSum = 0, TaxBase = 0, PlusSumHigh = 0, TaxBaseHigh = 0;
                m_RepCalc2.CalcNPTXPIT2General(@NPTXPayerInfoArr[i], @PlusSum, @TaxBase, @PlusSumHigh, @TaxBaseHigh);
                var NPTXPayer1;
                var NPTXArrCodeParm = TArray();
                var j = 0;
                if(m_RepCalc2.EndDate() == date(31,12,2022))
                  var printKBK1 = false;
                  var printKBK2 = false;
                  var printKBK3 = false;

                  while(j < NPTXPayerInfoArr[i].ArrCodeParm.Size)
                    if(NPTXPayerInfoArr[i].ArrCodeParm[j].IsHighRate == SET_CHAR)
                       printKBK3 = true;
                    else
                       printKBK1 = true;
                    end;

                    PrintNPTXPit2_31_12_2022(NPTXPayerInfoArr[i], 
                                             j,
                                             NPTXPayerInfoArr[i].ArrCodeParm[j].Rate, 
                                             IIF(NPTXPayerInfoArr[i].ArrCodeParm[j].IsHighRate == SET_CHAR, КБК3, КБК1),
                                             NPTXPayerInfoArr[i].ArrCodeParm[j].PlusSum,
                                             NPTXPayerInfoArr[i].ArrCodeParm[j].MinusSum
                                            );
                    m_CurrNameApp2 = GetCurrNameAttach2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                    PrintApp2(NPTXPayerInfoArr[i], j, IIF(NPTXPayerInfoArr[i].ArrCodeParm[j].IsHighRate == SET_CHAR, КБК3, КБК1));
                    if(POI_MODE)
                       if(isFirst)
                          Sym = Substr(m_CurrNameNPTX2, 1, 3);
                       end;
                       Sym_ = Substr(m_CurrNameNPTX2, 1, 3);
                       ItogSym = Sym + "-" + Sym_;
                       if(PoiNum >= POI_SIZE_PACK)
                          SaveSubTotalBook(ItogSym, false);
                          CreateTotalBook();
                          PoiNum = 1;
                          isFirst = true;
                       else
                          PoiNum = PoiNum + 2;
                          isFirst = false;
                       end;
                    end;

                    j = j + 1;
                  end;


                  var m = 1;
                  while(m <= 3)
                    var printed = false;

                    if(((m == 1) and (printKBK1 == false)) or
                       ((m == 2) and (printKBK2 == false)) or
                       ((m == 3) and (printKBK3 == false)) 
                      )
                      PrintNPTXPit2_31_12_2022(NPTXPayerInfoArr[i], 
                                               -1, 
                                               IIF(m==1, 13, IIF(m==2, 13, 15)),
                                               IIF(m==1, КБК1, IIF(m==2, КБК2, КБК3)),
                                               0,
                                               0, 
                                               @printed);
                      //m_CurrNameApp2 = GetCurrNameAttach2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                      //PrintApp2_31_12_2022(NPTXPayerInfoArr[i], -1, IIF(k==1, КБК1, IIF(k==2, КБК2, КБК3)), @printed);
                      if((POI_MODE) and (printed))
                         if(isFirst)
                            Sym = Substr(m_CurrNameNPTX2, 1, 3);
                         end;
                         Sym_ = Substr(m_CurrNameNPTX2, 1, 3);
                         ItogSym = Sym + "-" + Sym_;
                         if(PoiNum >= POI_SIZE_PACK)
                            SaveSubTotalBook(ItogSym, false);
                            CreateTotalBook();
                            PoiNum = 1;
                            isFirst = true;
                         else
                            PoiNum = PoiNum + 2;
                            isFirst = false;
                         end;
                      end;

                      if(m < 3)
                      
                        PrintNPTXPit2_31_12_2022(NPTXPayerInfoArr[i], 
                                                 -1,
                                                 30, 
                                                 IIF(m==1, КБК1, IIF(m==2, КБК2, КБК3)),
                                                 0,
                                                 0, 
                                                 @printed);
                        //m_CurrNameApp2 = GetCurrNameAttach2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                        //PrintApp2_31_12_2022(NPTXPayerInfoArr[i], -1, IIF(k==1, КБК1, IIF(k==2, КБК2, КБК3)), @printed);
                        if((POI_MODE) and (printed))
                           if(isFirst)
                              Sym = Substr(m_CurrNameNPTX2, 1, 3);
                           end;
                           Sym_ = Substr(m_CurrNameNPTX2, 1, 3);
                           ItogSym = Sym + "-" + Sym_;
                           if(PoiNum >= POI_SIZE_PACK)
                              SaveSubTotalBook(ItogSym, false);
                              CreateTotalBook();
                              PoiNum = 1;
                              isFirst = true;
                           else
                              PoiNum = PoiNum + 2;
                              isFirst = false;
                           end;
                        end;
                      end;
                    end;

                    m = m + 1;
                  end;

                else
                  while(j < NPTXPayerInfoArr[i].ArrCodeParm.Size)
                     m_CurrNameNPTX2 = GetCurrNameNPTX2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                     PrintNPTXPit2(NPTXPayerInfoArr[i], j);
                     m_CurrNameApp2 = GetCurrNameAttach2(NPTXPayerInfoArr[i].LastName, NPTXPayerInfoArr[i].FirstName, NPTXPayerInfoArr[i].MiddleName);
                     PrintApp2(NPTXPayerInfoArr[i], j, IIF(NPTXPayerInfoArr[i].ArrCodeParm[j].IsHighRate == SET_CHAR, КБК3, КБК1));
                     if(POI_MODE)
                        if(isFirst)
                           Sym = Substr(m_CurrNameNPTX2, 1, 3);
                        end;
                        Sym_ = Substr(m_CurrNameNPTX2, 1, 3);
                        ItogSym = Sym + "-" + Sym_;
                        if(PoiNum >= POI_SIZE_PACK)
                           SaveSubTotalBook(ItogSym, false);
                           CreateTotalBook();
                           PoiNum = 1;
                           isFirst = true;
                        else
                           PoiNum = PoiNum + 2;
                           isFirst = false;
                        end;
                     end;
                     j = j + 1;
                  end;
                end;
                UseProgress(i = i + 1);
             end;
             RemProgress();
          end;
       end;
       PoiNum = PoiNum + m_PageNum;

       if(m_InXML == SET_CHAR)
          CreateXML();
       end;
    end;

   private macro EndReport(numCopy:Integer)
      SaveTotalBook();
      if((m_InXML == SET_CHAR) and (m_RepCalc2.Count() > 0))
         m_XMLFile.Save();
         MsgBox("Сформирован файл " + m_XMLFile.GetFileName());
      end;

      if((m_InXML != SET_CHAR) and (POI_MODE) and (ItogSym != ""))
         SetLastTotalBookName(ItogSym);
         ItogSym = "";
      end;
   end;

   macro CReport_Show( NumCopy:INTEGER )
      CReport_Show(NumCopy);

      //отображение в отдельных приложениях сформированных файлов
      //для этого ещё было выключено отображение в конце формирования отчёта
      //SetIsShowAppl(false);
      //сделано это т.к. у нас при формировании файлы бьются на части
      //и во время формирования банку не нравилось, что файлы появлялись постепенно
      //да ещё и моргали

      for (var fileName, GetFullReportFileNames())
        //CDAOMSExcel(fileName,true).Show();
        var _fileName, fileExt;
        var filePath = IIF(not IsStandAlone(), "$","") + SplitFile(fileName, _fileName, fileExt);
        SC_ShowFile(filePath, _fileName+fileExt, true);
      end;
   end;

   initDL_CReportTemplate(NULL, "Report_NPTXPit6_NEW.xls", NULL, NULL, NULL, POI_MODE);
   SetPrintMode(DL_OUTREPORT_EXCEL);
   m_XMLFile = NPTXPit6_NEW_XML();
END;

CLASS (DL_CReportTemplate) NPTXPit6_NEW_Client(_BeginDate, _EndDate, _NumCount)
   private const MaxCodesOnPage = 30;

   private var m_BeginDate = _BeginDate;
   private var m_EndDate = _EndDate;
   private var m_NumCount = _NumCount;
   private var m_Day;
   private var m_Month;
   private var m_Year;
   private var m_CurrSheetName = "";
   private var m_RepCalc2;
   private var m_FirstPersonName;
   private var m_Clients;

   macro BeginReport()
      SetIsShowAppl(false);

      CreateTotalBook();

      DateSplit(m_EndDate, m_Day, m_Month, m_Year);

      m_Clients = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_CLIENTCODE);

      m_RepCalc2 = NPTXRepCalc_NPTXPIT6_NEW_2(0,
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_BEGDATE),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_ENDDATE),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_BOCB_CHECKBOX),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DEPO_CHECKBOX),
                                              Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_VS_CHECKBOX),
                                              true);

      if((m_RepCalc2.FirstPersonLastName() != NULL) and (m_RepCalc2.FirstPersonLastName() != ""))
         m_FirstPersonName = m_RepCalc2.FirstPersonLastName() + " " + substr(m_RepCalc2.FirstPersonFirstName(), 1, 1) + ". " + substr(m_RepCalc2.FirstPersonMiddleName(), 1, 1) + ".";
      else
         m_FirstPersonName = "";
      end;
   end;

   macro PrintTitle()
      PrintFormatString(NULL, "N1_Year", string(m_Year));
      PrintFormatString(NULL, "N1_PrintDate1", string(m_Day:2:o),
                              "N1_PrintDate2", string(m_Month:2:o),
                              "N1_PrintDate3", string(m_Year));
   end;

   macro PrintPart1()
      PrintFormatString(NULL, "N1_OurOKTMO", m_RepCalc2.OurOKTMO(),
                              "N1_OurPhone", m_RepCalc2.OurPhone(),
                              "N1_OurInn", m_RepCalc2.OurInn(),
                              "N1_OurKpp", m_RepCalc2.OurKpp(),
                              "N1_OurName", m_RepCalc2.OurName());
   end;

   macro PrintPart2(ClientINN, LastName, FirstName, MiddleName, ResidenceStatus, DateBirth, ResidenceCountry, DocumentType, DocumentNumber)
      PrintFormatString(NULL, "N1_ClientInn", ClientInn,
                              "N1_SecondName", LastName,
                              "N1_FirstName", FirstName,
                              "N1_MiddleName", MiddleName);

      PrintFormatString(NULL, "N1_ResidenceStatus", string(ResidenceStatus),
                              "N1_DateBirth", string(DateBirth:f),
                              "N1_CitizenShip", string(ResidenceCountry));

      PrintFormatString(NULL, "N1_DocumentType", DocumentType,
                              "N1_DocumentNumber", DocumentNumber);
   end;

   macro PrintPart3(RateParm, i:Integer)
      PrintFormatString(NULL, "N1_Rate", Int(RateParm.Rate));

      var j = 1;
      while((i < RateParm.NPTXCodeParmArr.Size) and (j <= MaxCodesOnPage))
         if ((RateParm.NPTXCodeParmArr[i].PScode != NULL) or
               //пропускаем если основной объект не показывается, плюс все его коды вычета
             (((not RateParm.NPTXCodeParmArr[i].IsShow) or (RateParm.NPTXCodeParmArr[i].PScode == null))and 
             (filter(RateParm.NPTXCodeParmArr[i].MinusCodes,@FindIsShowMinusCode).size == 0))
            )
            PrintFormatString(NULL, "N1_Month" + string(j), Int(RateParm.NPTXCodeParmArr[i].Month));
            if((RateParm.NPTXCodeParmArr[i].PScode != NULL) and (RateParm.NPTXCodeParmArr[i].IsShow))
               PrintFormatString(NULL, "N1_PlusCode" + string(j), RateParm.NPTXCodeParmArr[i].PScode,
                                       "N1_PSnnn" + string(j), string(round(RateParm.NPTXCodeParmArr[i].PSnnn,2):*:2));
            end;
            if(RateParm.NPTXCodeParmArr[i].MinusCodes.Size > 0)
               var k = 0;
               while(k < RateParm.NPTXCodeParmArr[i].MinusCodes.Size)
                  if (RateParm.NPTXCodeParmArr[i].MinusCodes[k].IsShow)
                    PrintFormatString(NULL, "N1_MinusCode" + string(j), RateParm.NPTXCodeParmArr[i].MinusCodes[k].MScode,
                                            "N1_MSnnn" + string(j), string(RateParm.NPTXCodeParmArr[i].MinusCodes[k].MSnnn:0:2));
                  end;
                  k = k + 1;
               end;
            else
               PrintFormatString(NULL, "N1_MinusCode" + string(j), "",
                                       "N1_MSnnn" + string(j), "");
            end;
            j = j + 1;
         end;
         i = i + 1;
      end;

      return i;
   end;

   macro PrintPart4(RateParm:NPTXRateParm, PayerInfo:NPTXPayerInfo)
      var n = 1;
      /*if(m_RepCalc2.MinusG_618(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus) > 0.0)
         PrintFormatString(NULL, "N1_CodeD" + string(n), "618");
         PrintFormatString(NULL, "N1_SumD" + string(n), string(m_RepCalc2.MinusG_618(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus):0:2));
         n = 2;
      end;
      if(m_RepCalc2.MinusG_619(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus) > 0.0)
         PrintFormatString(NULL, "N1_CodeD" + string(n), "619");
         PrintFormatString(NULL, "N1_SumD" + string(n), string(m_RepCalc2.MinusG_619(PayerInfo.ClientId, RateParm.RateType, PayerInfo.ResidenceStatus):0:2));
      end;*/
   end;

   macro PrintPart5(RateParm:NPTXRateParm)
      PrintFormatString(NULL, "N1_TotalPlus", string(round(RateParm.PlusSum,2):*:2),
                              "N1_TaxBaseSum", string(round(RateParm.PlusSum - RateParm.MinusSum,2):*:2),
                              "N1_TaxCalculated", string(BigInt(round(RateParm.TaxCalculated,0))),
                              "N1_TaxPaid", string(BigInt(round(RateParm.TaxPaid,0))),
                              "N1_TaxPaid1", string(BigInt(round(RateParm.TaxPaid,0))),
                              "N1_Znp", string(BigInt(round(RateParm.Znp,0))),
                              "N1_TaxToReturnDue", string(BigInt(round(RateParm.TaxOver/*TaxToReturnDue*/,0))));
   end;

   macro PrintPart6(RateParm:NPTXRateParm)
      PrintFormatString(NULL, "N1_TotalPlus_NoTax", string(ExtRound(Min(ExtRound(RateParm.TaxDue, 0) / RateParm.Rate * 100.0, RateParm.PlusSum - RateParm.MinusSum), NULL, true)),
                              "N1_TaxDue", string(round(RateParm.TaxDue, 0)));
   end;

   macro PrintFooter()
      PrintFormatString(NULL, "N1_FirstPerson", m_FirstPersonName);
   end;

   macro Create()
      var i = -1;
      var PoiNum = 0;
      var Sym = "";
      var Sym_ = "";
      var OldSym = "";
      var isFirst = true;

      var newNPTXPayerInfoArr = TArray();

      while((i=i+1) < NPTXPayerInfoArr.Size)
         if ( //пропускаем если это не тот клиент
               ((ValType(m_Clients) == V_GENOBJ) and (find( m_Clients, NPTXPayerInfoArr[i].ClientID) == -1)) or
               ((ValType(m_Clients) != V_GENOBJ) and (m_Clients > 0) and (m_Clients != NPTXPayerInfoArr[i].ClientID))
            )
            continue;
         end;
         newNPTXPayerInfoArr[newNPTXPayerInfoArr.size] = NPTXPayerInfoArr[i];
      end;
      i=0;

      InitProgress(newNPTXPayerInfoArr.Size, "Форма 6-НДФЛ с 01.01.2021", "Печать справки для выдачи клиентам");
      SheetsNamesNPTX2.Size = 0;
      while(i < newNPTXPayerInfoArr.Size)
         var j = 0;
         while(j < newNPTXPayerInfoArr[i].ArrCodeParm.Size)
            var k = 0;
            m_CurrSheetName = GetCurrNameNPTX2(newNPTXPayerInfoArr[i].LastName, newNPTXPayerInfoArr[i].FirstName, newNPTXPayerInfoArr[i].MiddleName);

            while(k < newNPTXPayerInfoArr[i].ArrCodeParm[j].NPTXCodeParmArr.Size)
               UseNewSheetInTotalBook();
               SetActiveSheet("Справка");
               PrintTitle();
               PrintPart1();
               PrintPart2(newNPTXPayerInfoArr[i].ClientINN, newNPTXPayerInfoArr[i].LastName, newNPTXPayerInfoArr[i].FirstName, newNPTXPayerInfoArr[i].MiddleName,
                          newNPTXPayerInfoArr[i].ResidenceStatus, newNPTXPayerInfoArr[i].DateBirth, newNPTXPayerInfoArr[i].ResidenceCountry, newNPTXPayerInfoArr[i].DocumentType,
                          newNPTXPayerInfoArr[i].DocumentNumber);
               k = PrintPart3(newNPTXPayerInfoArr[i].ArrCodeParm[j], k);

               PrintPart4(newNPTXPayerInfoArr[i].ArrCodeParm[j], newNPTXPayerInfoArr[i]);
               PrintPart5(newNPTXPayerInfoArr[i].ArrCodeParm[j]);
               PrintPart6(newNPTXPayerInfoArr[i].ArrCodeParm[j]);
               PrintFooter();

               CopyAllSheetInTotalBook("Справка", false, "N1_PrintArea", 0, m_CurrSheetName);
            end;

            if(POI_MODE)
               if(isFirst)
                  Sym = Substr(m_CurrSheetName, 1, 3);
               end;
               Sym_ = Substr(m_CurrSheetName, 1, 3);
               ItogSym = Sym + "-" + Sym_ + "_Client";
               if(PoiNum >= POI_SIZE_PACK)
                  SaveSubTotalBook(ItogSym, false);
                  CreateTotalBook();
                  PoiNum = 1;
                  isFirst = true;
               else
                  PoiNum = PoiNum + 1;
                  isFirst = false;
               end;
               OldSym = Sym;
            end;

            j = j + 1;
         end;
         UseProgress(i = i + 1);
      end;
      RemProgress();
   end;

   macro EndReport()
      SaveTotalBook();
   end;

   macro CReport_Show( NumCopy:INTEGER )
      CReport_Show(NumCopy);

      //отображение в отдельных приложениях сформированных файлов
      //для этого ещё было выключено отображение в конце формирования отчёта
      //SetIsShowAppl(false);
      //сделано это т.к. у нас при формировании файлы бьются на части
      //и во время формирования банку не нравилось, что файлы появлялись постепенно
      //да ещё и моргали
      for (var fileName, GetFullReportFileNames())
        //CDAOMSExcel(fileName,true).Show();
        var _fileName, fileExt;
        var filePath = IIF(not IsStandAlone(), "$","") + SplitFile(fileName, _fileName, fileExt);
        SC_ShowFile(filePath, _fileName+fileExt, true);
      end;
   end;

   InitDL_CReportTemplate(NULL, "Report_NPTXPit2_2018_Client.xls", NULL, NULL, NULL, POI_MODE);
   SetPrintMode(DL_OUTREPORT_EXCEL);
END;

/**
 @brief Вставить клиентов во временную таблицу DNPTX6CLIENT_TMP для среза
*/
private macro insertClientsInTmp ()
  var queryInsert = "INSERT INTO DNPTX6CLIENT_TMP ( " +
                    "                                t_PartyID " +
                    "                             ) " +
                    "                      VALUES ( " +
                    "                                ? " +
                    "                             ) ";

  for(var NPTXPayerInfoI, NPTXPayerInfoArr)
      var cmdInsert = DL_RSDCommand(queryInsert);
      cmdInsert.AddParam(NPTXPayerInfoI.ClientID);
      cmdInsert.ExecuteCMD();
  end;
end;


Form = NPTX_Pit6_NEW_FORM();
while(Form.Run())
   var IsPart2 = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_CHECKBOX) == SET_CHAR);
   var IsApp1 = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_APP1_CHECKBOX) == SET_CHAR);
   var IsApp1Client = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_FORCLIENT_CHECKBOX) == SET_CHAR);
   var BeginDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_BEGDATE);
   var EndDate = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_P2_ENDDATE);
   var IsSlice = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_SLICE_CHECKBOX) == SET_CHAR);
   var SliceNum = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_SLICE_NUM);
   var IsSliceDel = (Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DELSLICE_CHECKBOX) == SET_CHAR);
   var SliceNumDel = Form.GetFieldValue(NPTX_PIT6_NEW_FLDNUM_DELSLICE_NUM);
   var NumberQuery = "select count(1) as t_Count " +
                       "from ddl_report_stat_dbt " +
                       "where t_ReportKind = " + string(NPTXPIT6NEW_REPORTKIND);

   var NumberCmd = DL_RSDCommand(NumberQuery);
   var NumberDS = NumberCmd.Execute();
   var NumCount = 1;
   var newSliceNum = SliceNum;

   if(NumberDS.MoveNext())
      NumCount = SQL_ConvTypeInteger(NumberDS.Count) + 1;
   end;

   if (IsApp1 and (not IsPart2))
     MsgBox("Раздел 2 не выбран для формирования, приложение 1 сформировано не будет");
   end;

   NPTX_Pit6_NEW_Report().Run();

   if (IsApp1Client and (not IsPart2))
     MsgBox("Раздел 2 не выбран для формирования, справки для выдачи клиенту сформированы не будут");
   end;

   if(IsPart2 and IsApp1Client)
      NPTXPit6_New_Client(BeginDate, EndDate, NumCount).Run();
   end;

   if(IsSliceDel)
     if(delSlice(SliceNumDel, BeginDate, EndDate))
       newSliceNum = SliceNumDel;
     end;
   end;  

   if(IsSlice)
     insertClientsInTmp();
     insertSlice(newSliceNum, BeginDate, EndDate, NPTXPIT6_2021);
   end;
end;

Exit(1);
