/*
$Name:        sp_doc.mac
$Module:      Ценные бумаги
$Description: Макрос первичного документа сделки
*/

import OprInter, "sp_grfun.mac", "oprmassexec.mac", "BankInter", "nutxfun.mac";

// Создание графиков по сделкам
//

Private Macro UpdateFixSumDeal (DealIDQuery)
      var sql = RSDCommand(" update  ddl_tick_dbt tick " +
                           "     set tick.t_fixsum = 1 " +
                           "  where tick.t_DealID in (" + DealIDQuery + ") and tick.t_clientid <> -1 " );
      sql.execute();


End;


Private macro FindAccount(Counter)
    Var Query, cmd, DataSet, cmd_1, DataSet_1, Query_1; 
    Counter = String(Mod(Int(Counter), 1000000));
    Query =  " SELECT DISTINCT "
            +"           REPLACE (tpl.t_balance, 'Л', '_') "
            +"        || '____9900' "
            +"        || '%' "
            +"        || LPAD ("+Counter+", 6, '0') "
            +"           Findaccount "
           // +"        tpl.* "
            +"   FROM dmctempl_dbt tpl, dmccateg_dbt cat "
            +"  WHERE cat.t_number IN (SELECT DISTINCT T_NUMBER "
            +"                           FROM dmccateg_dbt cat "
            +"                          WHERE cat.t_updatemode = 0 "
            +"                                AND cat.t_id IN (SELECT /*+ PRECOMPUTE_SUBQUERY */ "
            +"                                                       DISTINCT T_CATID "
            +"                                                   FROM dmcaccdoc_dbt doc "
            +"                                                  WHERE doc.t_dockind = 176)) "
            +"        AND tpl.t_catid = cat.t_id ";

    Cmd = DL_RSDCommand(Query);

    DataSet = Cmd.Execute();

    Query_1 = " select 1 from daccount_dbt where "; 
    while(DataSet.MoveNext())
      if (Query_1 != " select 1 from daccount_dbt where ")
        Query_1 = Query_1 + " or ";
      end;
      Query_1 = Query_1 + " t_account like ('" + DataSet.FindAccount + "') ";
    end;

    Cmd_1 = DL_RSDCommand(Query_1);
    DataSet_1 = Cmd_1.Execute();
    If(DataSet_1.MoveNext())
        return 1;
    end;
    return 0;
End;

Private Macro AddRepoNumDeal  (DealIDQuery)

    Var cmd, DataSet, tick, FD, RepoNum = "", NextNum = 0; 

    var Query = " select * from ddl_tick_dbt tick " +
                "  where tick.t_DealID in (" + DealIDQuery + ") and tick.t_bofficekind = 101 and tick.t_clientid = -1 order by t_dealid asc"; 
    Cmd = DL_RSDCommand(Query);

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
       FD = SpFirstDoc(LEG_KIND_DL_TICK, DataSet.dealid);
       RepoNum = "";
       NextNum = 0;
       RepoNum = ReadNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 205);
       If(RepoNum == "")
          GenerateReference(1000013, NextNum);
          While (FindAccount(NextNum) == 1)
                GenerateReference(1000013, NextNum);
          end;
          AddNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 205, string(NextNum), FD.tick.rec.dealdate);
       end;

    end;


End;


Private Macro AddBasketNumDeal  (DealIDQuery)
    Var cmd, DataSet, tick, FD, RepoNum = 0, NextNum = 0; 

    var Query = " select * from ddl_tick_dbt tick " +
                "  where tick.t_DealID in (" + DealIDQuery + ") and tick.t_bofficekind = 101 order by t_dealid asc"; 
    Cmd = DL_RSDCommand(Query);

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
       FD = SpFirstDoc(LEG_KIND_DL_TICK, DataSet.dealid);
       RepoNum = 0;
       NextNum = 0;
       RepoNum = ReadNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 204);
       If(RepoNum == 0)
          GenerateReference(1000009, NextNum);
          AddNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick,OBJTYPE_SECDEAL), 204, int(NextNum), FD.tick.rec.dealdate);
       end;

    end;

End;


PRIVATE MACRO CreateGraphsByDeals(DealIDQuery, _IsBuy, _IsRepo, _IsOutExchange, _IsBroker, _IsBasket, _IsRET_COUPON, _IsRET_PARTLY, _IsLoan, _IsRET_ISSUE,_IsRET_ADDINCOME)
    var Query = "";
    var Cmd = null;
    var DataSet = null;
    var i = 0;
    var PrevDealID = -1;
    var tick = TRecHandler("dl_tick.dbt");
    var leg = TRecHandler("dl_leg.dbt");
    var leg2 = TRecHandler("dl_leg.dbt");
    /*******************/
    var GA = TRecHandler("dl_genagr.dbt");
    /*******************/
    var AvrRqID = 0;
    var AvrRqID2 = 0;
    var _IsKSU = false;
    var _ClientNeedNUTX = false, UseNUTX = DL_UseNUTX();

    Query = " SELECT "
              + " tick.t_DealID "
             + " ,tick.t_DealDate "
             + " ,tick.t_DealCode "
             + " ,tick.t_dealcodets"
             + " ,tick.t_BOfficeKind "
             + " ,tick.t_PreOutlay "
             + " ,tick.t_ClientID "
             + " ,tick.t_DealTime "
             + " ,tick.t_IsPartyClient "
             + " ,tick.t_PFI "
             + " ,tick.t_OriginID "
             + " ,tick.t_Flag1 "
             + " ,tick.t_Flag4 "
             + " ,tick.t_DealType "
             + " ,tick.t_BrokerID "
             + " ,tick.t_PartyID "
             + " ,tick.t_Autoclose "
             + " ,tick.t_CarryWrt "
             + " ,tick.t_IsPFI "
             + " ,tick.t_IsSpot "
             + " ,tick.t_ParentID "
             + " ,leg1.t_BitMask "
             + " ,leg1.t_SupplyTime AS SupplyTime1 "
             + " ,leg1.t_Start AS DateAvance "
             + " ,leg1.t_Maturity "
             + " ,leg1.t_Expiry "
             + " ,leg1.t_MaturityIsPrincipal "
             + " ,leg1.t_ReturnIncome "
             + " ,leg1.t_MoveDate "
             + " ,rq_del.t_ID AS AvrRqID "
             + " ,NVL(GA.t_genagrid,-1) AS GAID"
             + " ,NVL(GA.T_REPORTER_BANK, -1) AS GAREPORTER_BANK"
             + " ,NVL(GA.T_CODE, CHR (1)) AS GACODE"
             + " ,NVL(GA.T_NUMREPOZ, CHR (1)) AS GANUMREPOZ"
             + " ,NVL(GA.T_DATE_END,TO_DATE ('03.03.0003', 'DD.MM.YYYY')) AS GADATE_END"
             + " ,NVL(GA.T_NUMCONTR, CHR (1)) AS GANUMCONTR"
             + " ,NVL(GA.T_REPORTER_CONTR, 0) AS GAREPORTER_CONTR"
             + " ,NVL(GA.T_CREATOR_UTI, -1) AS GACREATOR_UTI"
             + " ,NVL(GA.T_CODE_DEAL, CHR (1)) AS GACODE_DEAL"
             + " ,NVL(GA.T_METHOD_REG, 0) AS GAMETHOD_REG"
             + " ,NVL(GA.T_METHOD_WAYTWOWAY, 0) AS GAMETHOD_WAYTWOWAY"
             + " ,NVL(GA.T_INITIATOR, -1) AS GAINITIATOR"
             + " ,NVL((CASE WHEN GA.T_FORMSECUR = 0 THEN 3 ELSE GA.T_FORMSECUR END), 3) AS GAFORMSECUR"
             + " ,NVL((CASE WHEN GA.T_TYPESECUR = 0 THEN 4 ELSE GA.T_TYPESECUR END),4) AS GATYPESECUR"
             + " ,NVL(GA.T_TYPE_SVER, -1) AS GATYPE_SVER"
             + " ,NVL(GA.T_UTI_CODE, CHR (1)) AS GAUTI_CODE"
             + " ,NVL(GA.T_WAITINGPERIOD, 0) AS WAITINGPERIOD"
             + " ,rsi_rsbparty.PT_GetPartyCode(TICK.T_PARTYID, 69) AS LEI"
             + " ,NVL (GA.T_SCANCOPY, CHR (1)) AS GASCANCOPY"
             + " ,RSB_FIINSTR.FI_IsKSU(tick.t_PFI) AS IsKSU "
             + " ,NVL(client.t_LegalForm, 0) as ClientLegalForm";

    if(UseNUTX == true)
        Query = Query +
               " ,RSB_SECUR.IsTaxResident(tick.t_ClientID, tick.t_DealDate) as ClientIsResident "
             + " ,RSI_NUTX.GetNUTaxGroup(tick.t_PFI, tick.t_DealDate) as NUTaxGroup ";
    end;

    if(_IsRepo or _IsLoan)
        Query = Query +
               " ,leg2.t_SupplyTime AS SupplyTime2 "
             + " ,leg2.t_Start AS DateAvance2 "
             + " ,leg2.t_Maturity AS Maturity2 "
             + " ,leg2.t_Expiry AS Expiry2 "
             + " ,leg2.t_MaturityIsPrincipal AS MaturityIsPrincipal2 "
             + " ,rq_del2.t_ID AS AvrRqID2 ";
    end;

    Query = Query +
            " FROM "
              + " ddl_tick_dbt tick "
              + " LEFT JOIN dparty_dbt client ON client.t_PartyID = tick.t_ClientID "
              + " LEFT JOIN ddl_leg_dbt leg1 ON (leg1.t_DealID = tick.t_DealID "
                                         + " AND leg1.t_LegKind = " + String(LEG_KIND_DL_TICK) + " "
                                         + " AND leg1.t_LegId = 0) "
              + " LEFT JOIN ddlrq_dbt rq_del ON (rq_del.t_DocKind = tick.t_bOfficeKind "
                                         + " AND rq_del.t_DocID = tick.t_DealID "
                                         + " AND rq_del.t_DealPart = 1 "
                                         + " AND rq_del.t_Type = " + String(DLRQ_TYPE_DELIVERY) + " "
                                         + " AND rq_del.t_Num = 0) "
                /******************/
              + " LEFT JOIN ddl_genagr_dbt GA ON ((GA.t_genagrid = TICK.t_genagrid)OR(GA.t_partyid = TICK.t_partyid)ANd(GA.t_pseudoga = 'X') ) ";



    if(_IsRepo or _IsLoan)
        Query = Query +
                " LEFT JOIN ddl_leg_dbt leg2 ON (leg2.t_DealID = tick.t_DealID "
                                         + " AND leg2.t_LegKind = " + String(LEG_KIND_DL_TICK_BACK) + " "
                                         + " AND leg2.t_LegId = 0) "
              + " LEFT JOIN ddlrq_dbt rq_del2 ON (rq_del2.t_DocKind = tick.t_bOfficeKind "
                                          + " AND rq_del2.t_DocID = tick.t_DealID "
                                          + " AND rq_del2.t_DealPart = 2 "
                                          + " AND rq_del2.t_Type = " + String(DLRQ_TYPE_DELIVERY) + " "
                                          + " AND rq_del2.t_Num = 0) ";
    end;

    Query = Query +
            " WHERE "
              + " tick.t_DealID in (" + DealIDQuery + ") ";

    Cmd = DL_RSDCommand(Query);

    InitProgress(-1, "Формирование графика по сделкам", "Формирование графика по сделкам");
    i = 0;

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
        if(PrevDealID == DataSet.DealID)
            continue;
        end;

        tick.Clear();
        tick.rec.DealID = DataSet.DealID;
        tick.rec.DealCode= DataSet.DealCode;
        tick.rec.dealcodets= DataSet.dealcodets;
        tick.rec.DealDate = SQL_ConvTypeDate(DataSet.DealDate);
        tick.rec.DealTime = SQL_ConvTypeTime(DataSet.DealTime);
        tick.rec.BOfficeKind = DataSet.BOfficeKind;
        tick.rec.PreOutlay = DataSet.PreOutlay;
        tick.rec.ClientID = DataSet.ClientID;
        tick.rec.IsPartyClient = DataSet.IsPartyClient;
        tick.rec.PFI = DataSet.PFI;
        tick.rec.OriginID = DataSet.OriginID;
        tick.rec.Flag1 = DataSet.Flag1;
        tick.rec.Flag4 = DataSet.Flag4;
        tick.rec.DealType = DataSet.DealType;
        tick.rec.BrokerID = DataSet.BrokerID;
        tick.rec.PartyID = DataSet.PartyID;
        tick.rec.AutoClose = DataSet.AutoClose;
        tick.rec.CarryWrt = DataSet.CarryWrt;
        tick.rec.IsPFI = DataSet.IsPFI;
        tick.rec.IsSpot = DataSet.IsSpot;
        tick.rec.ParentID = DataSet.ParentID;

        leg.Clear();
        leg.rec.BitMask = DataSet.BitMask;
        leg.rec.SupplyTime = SQL_ConvTypeTime(DataSet.SupplyTime1);
        leg.rec.Start = SQL_ConvTypeDate(DataSet.DateAvance);
        leg.rec.Maturity = SQL_ConvTypeDate(DataSet.Maturity);
        leg.rec.Expiry = SQL_ConvTypeDate(DataSet.Expiry);
        leg.rec.MaturityIsPrincipal = DataSet.MaturityIsPrincipal;
        leg.rec.ReturnIncome = DataSet.ReturnInCome;
        leg.rec.MoveDate = SQL_ConvTypeDate(DataSet.MoveDate);

        AvrRqID = SQL_ConvTypeInteger(DataSet.AvrRqID);

        if(_IsRepo or _IsLoan)
            leg2.Clear();
            leg2.rec.SupplyTime = SQL_ConvTypeTime(DataSet.SupplyTime2);
            leg2.rec.Start = SQL_ConvTypeDate(DataSet.DateAvance2);
            leg2.rec.Maturity = SQL_ConvTypeDate(DataSet.Maturity2);
            leg2.rec.Expiry = SQL_ConvTypeDate(DataSet.Expiry2);
            leg2.rec.MaturityIsPrincipal = DataSet.MaturityIsPrincipal2;

            AvrRqID2 = SQL_ConvTypeInteger(DataSet.AvrRqID2);
        end;
        if(DataSet.GAID > 0)

            GA.Clear();
            GA.rec.genagrid=DataSet.GAID;
            GA.rec.reporter_bank=DataSet.GAREPORTER_BANK;
            GA.rec.CODE=DataSet.GACODE;
            GA.rec.NUMREPOZ= DataSet.GANUMREPOZ;
            GA.rec.DATE_END= SQL_ConvTypeDate(DataSet.GADATE_END);
            GA.rec.numcontr= dataset.ganumcontr;
            GA.rec.reporter_contr= dataset.gareporter_contr;
            GA.rec.creator_uti= dataset.gacreator_uti;
            GA.rec.code_deal= dataset.gacode_deal;
            GA.rec.method_reg= dataset.gamethod_reg;
            GA.rec.method_waytwoway= dataset.gamethod_waytwoway;
            GA.rec.initiator= dataset.gainitiator;
            GA.rec.formsecur = dataset.gaformsecur;
            GA.rec.typesecur =  dataset.gatypesecur;
            GA.rec.TYPE_SVER= dataset.GATYPE_SVER;
            GA.rec.UTI_CODE= dataset.GAUTI_CODE;
            GA.rec.WAITINGPERIOD= dataset.WAITINGPERIOD;
            
        end;

        _IsKSU = false;
        if(DataSet.IsKSU > 0)
            _IsKSU = true;
        end;

        if(UseNUTX == true)
          if((DataSet.ClientIsResident == 0) and (DataSet.ClientLegalForm == legal_form_jur) and ((DataSet.NUTaxGroup == NUTAXGROUP_40) or (DataSet.NUTaxGroup == NUTAXGROUP_50)) and (not IsControlOrg(tick.rec.ClientID)))
            _ClientNeedNUTX = true;
          end;
        end;

        SetAllGrDeal(tick, leg, AvrRqID, leg2, AvrRqID2, _IsBuy, _IsRepo, _IsOutExchange, _IsBroker, _IsBasket, _IsRET_COUPON, _IsRET_PARTLY, _IsKSU, _IsLoan, _IsRET_ISSUE, GA, _ClientNeedNUTX, _IsRET_ADDINCOME);

        UseProgress(i = i + 1);

        PrevDealID = DataSet.DealID;
    end;

    InsertAllGrDeal(); //сохранить данные

    RemProgress();
END;


PRIVATE MACRO CreateGraphsByPrevClientComiss(DealIDQuery)

    var Query = "";
    var Cmd = null;
    var DataSet = null;
    var i = 0;

    Query = " SELECT "
            + " tick.t_DealId Docid"
            + " ,tick.t_Bofficekind Dockind"
            + " ,decode(tick.t_CommDate, to_date('01.01.0001','DD.MM.YYYY'), tick.t_DealDate, tick.t_CommDate) CommDate "
            + " ,tick.t_PFI "
            + " ,tick.t_DealTime "
          + " FROM "
             + " ddl_tick_dbt tick "
          + " WHERE "
          + " tick.t_clientid <> -1 "
          + " AND ((tick.t_Bofficekind <> "+DL_AVRWRT+") or ((select INSTR(RSB_SECUR.get_OperSysTypes( tick.T_DEALTYPE, NULL ), 'T') from dual ) <= 0)) "
          + " AND tick.t_dealtype != 32743"
          + " AND tick.t_DealID in (" + DealIDQuery + ")";

    Cmd = DL_RSDCommand(Query);

    InitProgress(-1, "Формирование графика для учета комиссий по сделкам клиентов в дату заключения ", "Формирование графика для учета комиссий по сделкам клиентов в дату заключения");
    i = 0;

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
         SetGrDeal(DataSet.DocKind, DataSet.DocID, DataSet.PFI,
                100,
                Date(DataSet.CommDate), Time(DataSet.DealTime), 0);

       UseProgress(i = i + 1);
    end;

    InsertAllGrDeal(); //сохранить данные

    RemProgress();


END;

PRIVATE MACRO CreateGraphsByPrevClientComissClirSPB(DealIDQuery)

    var Query = "";
    var Cmd = null;
    var DataSet = null;
    var i = 0;

/*

 SELECT 
 tick.t_DealId Docid
 ,tick.t_Bofficekind Dockind
 ,tick.t_DealDate 
 ,tick.t_PFI 
 ,tick.t_DealTime 
 ,com.t_date comdate
 FROM 
 ddl_tick_dbt tick , ddlcomis_dbt com, dsfcomiss_dbt  sfcom
 WHERE 
 tick.t_clientid <> -1 
 AND tick.t_marketid >2
 AND com.t_dockind = tick.t_Bofficekind
 AND com.t_docid =tick.t_DealId 
 AND sfcom.t_number = com.t_comnumber
 AND sfcom.t_code = 'СПбБиржКлир'
 AND tick.t_DealID in (select t_dealid from ddl_tick_dbt where t_bofficekind = 101 and  t_dealdate = to_date('10012022','ddmmyyyy')   ) 
  AND RSB_SECUR.GetGeneralMainObjAttr(101,LPAD (tick.t_DealId , 34, '0'),115,tick.t_Dealdate) = 1

*/

    Query = " SELECT "
            + " tick.t_DealId Docid"
            + " ,tick.t_Bofficekind Dockind"
            + " ,tick.t_DealDate "
            + " ,tick.t_PFI "
            + " ,tick.t_DealTime "
            + " ,com.t_date comdate"
          + " FROM "
             + " ddl_tick_dbt tick , ddlcomis_dbt com, dsfcomiss_dbt  sfcom "
          + " WHERE "
          + " tick.t_clientid <> -1 "
          + "  AND tick.t_marketid >2 "
          + "  AND com.t_dockind = tick.t_Bofficekind "
          + "  AND com.t_docid =tick.t_DealId " 
          + "  AND sfcom.t_number = com.t_comnumber "
          + "  AND sfcom.t_code = 'СПбБиржКлир' "
          + "    AND RSB_SECUR.GetGeneralMainObjAttr(101,LPAD (tick.t_DealId , 34, '0'),115,tick.t_Dealdate) = 1 "
          + " AND tick.t_DealID in (" + DealIDQuery + ")";

    Cmd = DL_RSDCommand(Query);

    InitProgress(-1, "Формирование графика для учета клиринговых комиссий по сделкам клиентов на СПБ не в дату заключения ", "Формирование графика для учета клиринговых комиссий по сделкам клиентов на СПБ не в дату заключения");
    i = 0;

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
         SetGrDeal(DataSet.DocKind, DataSet.DocID, DataSet.PFI,
                102,
                Date(DataSet.comdate), Time(DataSet.DealTime), 0);

       UseProgress(i = i + 1);
    end;

    InsertAllGrDeal(); //сохранить данные

    RemProgress();


END;


PRIVATE MACRO CreateGraphsByKSU(DealIDQuery)

    var Query = "";
    var Cmd = null;
    var DataSet = null;
    var i = 0;

    Query = " SELECT "
            + " tick.t_DealId Docid"
            + " ,tick.t_Bofficekind Dockind"
            + " ,tick.t_DealDate "
            + " ,tick.t_PFI "
            + " ,tick.t_DealTime "
          + " FROM "
             + " ddl_tick_dbt tick "
          + " WHERE "
          + " tick.t_clientid in (-1,1) and tick.t_partyid in (-1,1)  and tick.t_bofficekind = 127"
          + " AND tick.t_DealID in (" + DealIDQuery + ")";

    Cmd = DL_RSDCommand(Query);

    InitProgress(-1, "Формирование графика для учета поставки КСУ", "Формирование графика для учета поставки КСУ");
    i = 0;

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
         SetGrDeal(DataSet.DocKind, DataSet.DocID, DataSet.PFI,
                101,
                Date(DataSet.dealdate), Time(DataSet.DealTime), 0);

       UseProgress(i = i + 1);
    end;

    InsertAllGrDeal(); //сохранить данные

    RemProgress();


END;
// Создание графиков для учет комиссий по сделкам
//
PRIVATE MACRO CreateGraphsByComiss(DealIDQuery)
    var Query = "";
    var Cmd = null;
    var DataSet = null;
    var i = 0;

    Query =   " SELECT q.* "
            + "   FROM (SELECT comis.t_DocKind as t_DocKind "
            + "               ,comis.t_DocID as t_DocID "
            + "               ,(CASE WHEN comis.t_IsBankExpenses = 'X' THEN decode(tick.t_CommDate, to_date('01.01.0001','DD.MM.YYYY'), tick.t_DealDate, tick.t_CommDate) ELSE comis.t_PlanPayDate END) as t_PlanPayDate "
            + "               ,tick.t_DealTime as t_DealTime "
            + "               ,tick.t_PFI as t_PFI "
             + " ,(CASE WHEN comis.t_Contract <> tick.t_PartyContrID THEN 1 ELSE 0 END) AS t_ComContr "
            + "           FROM ddlcomis_dbt comis, ddl_tick_dbt tick, dsfcomiss_dbt sfcom "
            + "          WHERE comis.t_DocKind = tick.t_BOfficeKind "
          + " AND comis.t_DocID = tick.t_DealID "
          + " AND tick.t_DealID in (" + DealIDQuery + ") "
          + " AND comis.t_FeeType = sfcom.t_FeeType "
          + " AND comis.t_ComNumber = sfcom.t_Number "
          + " AND sfcom.t_ServiceKind = " + String(PTSK_STOCKDL) + " "
            + "         UNION "
            + "         SELECT tick.t_BOfficeKind as t_DocKind "
            + "               ,tick.t_DealID as t_DocID "
            + "               ,RSB_SECUR.GetDealPayDate1(leg.t_MaturityIsPrincipal, leg.t_Maturity, leg.t_Expiry) as t_PlanPayDate "
            + "               ,tick.t_DealTime as t_DealTime "
            + "               ,tick.t_PFI as t_PFI "
            + "               ,1 as t_ComContr "
            + "           FROM ddl_tick_dbt tick, ddl_leg_dbt leg "
            + "          WHERE tick.t_DealID IN ("+DealIDQuery+") "
            + "            AND tick.t_BOfficeKind = " + DL_SECUROWN
            + "            AND RSB_SECUR.ISOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BOfficeKind))) = 1 "
            + "            AND tick.t_Flag3 = 'X' "
            + "            AND leg.t_DealID = tick.t_DealID "
            + "            AND leg.t_LegKind = " + String(LEG_KIND_DL_TICK) + " "
            + "            AND leg.t_LegId = 0 "
            + "        ) q "
            + " GROUP BY q.t_DocKind "
            + "         ,q.t_DocID "
            + "         ,q.t_PlanPayDate "
            + "         ,q.t_DealTime "
            + "         ,q.t_PFI "
            + "         ,q.t_ComContr ";

    Cmd = DL_RSDCommand(Query);

    InitProgress(-1, "Формирование графика для учета комиссий по сделкам", "Формирование графика для учета комиссий по сделкам");
    i = 0;

    DataSet = Cmd.Execute();

    while(DataSet.MoveNext())
        SetTemplDateArrVal(IIF(SQL_ConvTypeInteger(DataSet.ComContr) == 1, DLGR_TEMPL_PAYCOM, DLGR_TEMPL_PAYCOMCONTR), DLGR_DATEKIND_COMISS);
        SetGrDeal(DataSet.DocKind, DataSet.DocID, DataSet.PFI,
                  IIF(SQL_ConvTypeInteger(DataSet.ComContr) == 1, DLGR_TEMPL_PAYCOM, DLGR_TEMPL_PAYCOMCONTR),
                  Date(DataSet.PlanPayDate), Time(DataSet.DealTime), 0);

       UseProgress(i = i + 1);
    end;

    InsertAllGrDeal(); //сохранить данные

    RemProgress();
END;

// Изменить условия учета
//
PRIVATE MACRO ChangeGrAccForDeliveryToPartRepay(DealIDQuery)
    var Query = "";
    var Cmd = null;

    Query = " UPDATE "
              + " ddlgracc_dbt gracc "
          + " SET "
              + " gracc.t_State = " + String(DLGRACC_STATE_NOTNEED) + " "
          + " WHERE "
              + " gracc.t_GrDealID IN (SELECT "
                                       + " grdeal.t_ID "
                                   + " FROM "
                                       + " ddlgrdeal_dbt grdeal "
                                      + " ,ddl_tick_dbt tick "
                                   + " WHERE "
                                       + " grdeal.t_DocID = tick.t_DealID "
                                   + " AND grdeal.t_DocKind = tick.t_BOfficeKind "
                                   + " AND grdeal.t_TemplNum = " + String(DLGR_TEMPL_DELIVERY) + " "
                                   + " AND tick.t_DealID in (" + DealIDQuery + ") "
                                   + " AND (RSB_SECUR.IsRET_PARTLY(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 "
                                     + " OR RSB_SECUR.IsRET_COUPON(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1)) "
          + " AND gracc.t_AccNum = " + String(DLGR_ACCKIND_INNER) + " ";

    Cmd = RSDCommand(Query);
    Cmd.Execute();
END;

// DealIDQuery - SQL-запрос на выборку идентификаторов ddl_tick_dbt.t_DealID
//
PRIVATE MACRO MassInitOperation_Impl(DealIDQuery:STRING, Deal )
    var Group = 0;
    var _IsBuy = false;
    var _IsRepo = false;
    var _IsOutExchange = false;
    var _IsBroker = false;
    var _IsBasket = false;
    var _IsRET_COUPON = false;
    var _IsRET_PARTLY = false;
    var _IsRET_ISSUE  = false;
    var _IsLoan = false;
    var _IsRET_ADDINCOME = false;

    if( ValType(Deal) == V_UNDEF )
       Group = SP_Mass_GetOperationGroup();
       if( Group <= 0 )
          RunError("Не определен вид операции");
          return 1;
       end;
    else
       Group = SP_GetOperationGroup( Deal ); 
    end;

    if(Group <= 0)
        RunError("Не определен вид операции");
    end;

    if(not IsEXCHANGE(Group))
        _IsOutExchange = true;
    end;

    if(IsBUY(Group))
        _IsBuy = true;
    end;

    if(IsRET_ADDINCOME(Group))
        _IsRET_ADDINCOME = true;
    end;

    if(IsREPO(Group))
        _IsRepo = true;

        if(IsBasket(Group))
            _IsBasket = true;
        end;
    elif(IsBROKER(Group))
        _IsBroker = true;
    elif(IsRET_COUPON(Group))
        _IsRET_COUPON = true;
    elif(IsRET_PARTLY(Group))
        _IsRET_PARTLY = true;
    elif(IsRET_ISSUE(Group))
        _IsRET_ISSUE = true;
    elif(IsLoan(Group))
        _IsLoan = true;
    end;

    if( _IsRepo and _IsBasket and _IsBuy and _IsOutExchange )
       // пока нет операции и не будем вставлять графики
    else
       var OldDialogFlag = SetDialogFlag(1);

       CreateGraphsByDeals(DealIDQuery, _IsBuy, _IsRepo, _IsOutExchange, _IsBroker, _IsBasket, _IsRET_COUPON, _IsRET_PARTLY, _IsLoan, _IsRET_ISSUE, _IsRET_ADDINCOME);
       //График Фиксация комиссии в дату заключения сделок
       CreateGraphsByPrevClientComiss(DealIDQuery);
       //График Фиксация клиринговых комиссий на СПБ НЕ в дату заключения сделок
		 CreateGraphsByPrevClientComissClirSPB(DealIDQuery);

       CreateGraphsByComiss(DealIDQuery);

       CreateGraphsByKSU(DealIDQuery); 

       SetDialogFlag(OldDialogFlag);

       //снять признак "П" для ВУ строки "Поставка" для ЧП
       if( _IsRET_PARTLY or _IsRET_COUPON )
          ChangeGrAccForDeliveryToPartRepay(DealIDQuery);
       end;

       //Установка признака Фикс сумма сделки по внебиржевым сделкам не Репо
       if((_IsOutExchange) and not(_IsRepo) and not(_IsRET_COUPON) and not(_IsRET_PARTLY) and not(_IsRET_ISSUE))
          UpdateFixSumDeal(DealIDQuery);
       end;

       //Установка примечания с порядковым номером сделки для внебирдевых Корзин Репо
       If((_IsBasket) and (_IsOutExchange) )
          AddBasketNumDeal(DealIDQuery);

       end;
       If(_IsRepo)
          AddRepoNumDeal(DealIDQuery);
       end;
    end;

    return 0;
END;

MACRO InitOperation(KindOpr, KindDoc, FDoc)
    record tick(dl_tick);
    SetBuff(tick, FDoc);

    return MassInitOperation_Impl(" SELECT " + String(tick.DealID) + " FROM DUAL ", tick );

OnError(RslErrObj)
    RemProgress();
    CreateErrMsg(8029, "InitOperation. " + RslErrObj.Message);
    return 1;
END;

MACRO PrepMassInitOperation()
    return 0;
END;

// ! Макрос инициализации вызываемый в транзакции.
// ! Вызов выполняется один раз для каждого вида операции, по которой будет выполнен массовый старт.
MACRO ExecMassInitOperation()
    var Query = "";
    Query = " SELECT tick.t_DealID "
          + " FROM ddl_tick_dbt tick ,doprtemp_view oprtemp "
          + " WHERE "
              + " tick.t_DealID = TO_NUMBER(oprtemp.t_DocumentID) " // корректно т.к. обрабатываются только сделки
          + " AND tick.t_BOfficeKind = oprtemp.t_DocKind ";

    return MassInitOperation_Impl(Query);

OnError(RslErrObj)
    RemProgress();
    SP_Mass_CreateMassError( 8029, "ExecMassInitOperation. " + RslErrObj.Message );
    return 1;
END;  
