/*
$Name:             sctaxlot_Report.mac
$Module:           Äêçì
$Description:      é‚Á•‚ "ë¢ÔßÎ¢†≠®• ´Æ‚Æ¢ ¢ ≠†´Æ£Æ¢Æ¨ „Á•‚•"
*/

import "spRepFn2.mac", "globals.mac", "DLReport_h.mac", "sctaxlot_Form.mac", RsbDataSet, "ws_txreportform.mac";

private const ALL_FI = -1,
              SHARE = 1,
              DEPO_RECEIPT = 2,
              BOND  = 3;
private const
  ALG_SCTX_LINKTYPE = 7302,
  ALG_SCTX_DEALKIND = 7300;

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

private var TxLots_Form;
private var TxLots_Report;
PRIVATE VAR WebMenuItem; // à≠‰Æ‡¨†Ê®Ô Æ ß†Ø„·™• Æ‚Á•‚† ®ß ¢•°

private var
  Table = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
          "≥   ç†®¨•≠Æ¢†≠®• Ê•≠≠ÎÂ   ≥         ù¨®‚•≠‚         ≥     çÆ¨®≠†´     ≥ Ç†´Ó‚† ≠Æ¨®≠†´† ≥Ç®§ ·¢Ôß®≥           èÆ™„Ø™†           ≥           è‡Æ§†¶†           ≥     Ñ†‚† ·¢Ôß®     ≥ äÆ´®Á•·‚¢Æ ¢ ·¢Ôß® ≥       à·‚ÆÁ≠®™ °„¨†£        ≥    é™Æ≠Á†‚•´Ï≠†Ô Ø‡Æ§†¶†    ≥   Ç·ØÆ¨Æ£†‚•´Ï≠†Ô ·§•´™† 1  ≥  Ç·ØÆ¨Æ£†‚•´Ï≠†Ô ·§•´™† 2   ≥                                              ë¢•§•≠®Ô Æ ØÆ™„Ø™•                                               ≥                                              ë¢•§•≠®Ô Æ Ø‡Æ§†¶•                                               ≥\n" +
          "≥          °„¨†£          ≥                         ≥                 ≥                 ≥         √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥                    ≥                    √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
          "≥                         ≥                         ≥                 ≥                 ≥         ≥ çÆ¨•‡ ·§•´™® ≥  Ç®§ ·§•´™®  ≥ çÆ¨•‡ ·§•´™® ≥  Ç®§ ·§•´™®  ≥                    ≥                    ≥ çÆ¨•‡ ·§•´™® ≥  Ç®§ ·§•´™®  ≥ çÆ¨•‡ ·§•´™® ≥  Ç®§ ·§•´™®  ≥ çÆ¨•‡ ·§•´™® ≥  Ç®§ ·§•´™®  ≥ çÆ¨•‡ ·§•´™® ≥  Ç®§ ·§•´™®  ≥Ñ†‚† ß†™´Ó-≥Ñ†‚† ØÆ·‚†¢-≥  ñ•≠† ØÆ™„Ø™®   ≥Ç†´Ó‚†      ≥   çäÑ Ø‡®     ≥ ä„‡· ≠† §†‚„  ≥ äÆ≠‚‡†£•≠‚ ØÆ ØÆ™„Ø™• ≥Ñ†‚† ß†™´Ó-≥Ñ†‚† ØÆ·‚†¢-≥  ñ•≠† Ø‡Æ§†¶®   ≥Ç†´Ó‚†      ≥   çäÑ Ø‡®     ≥ ä„‡· ≠† §†‚„  ≥ äÆ≠‚‡†£•≠‚ ØÆ Ø‡Æ§†¶• ≥\n" +
          "≥                         ≥                         ≥                 ≥                 ≥         ≥              ≥(Á†·‚Ï ·§•´™®)≥              ≥(Á†·‚Ï ·§•´™®)≥                    ≥                    ≥              ≥(Á†·‚Ï ·§•´™®)≥              ≥(Á†·‚Ï ·§•´™®)≥              ≥(Á†·‚Ï ·§•´™®)≥              ≥(Á†·‚Ï ·§•´™®)≥Á•≠®Ô      ≥™® ØÆ™„Ø™®  ≥  ¢ ¢†´Ó‚• Ê•≠Î  ≥Ê•≠Î        ≥ ØÆ™„Ø™• ¢ Çç  ≥ ØÆ·‚†¢™®      ≥                       ≥Á•≠®Ô      ≥™® Ø‡Æ§†¶®  ≥  ¢ ¢†´Ó‚• Ê•≠Î  ≥Ê•≠Î        ≥ Ø‡Æ§†¶• ¢ Çç  ≥ ØÆ·‚†¢™®      ≥                       ≥\n" +
          "≥                         ≥                         ≥                 ≥                 ≥         ≥              ≥              ≥              ≥              ≥                    ≥                    ≥              ≥              ≥              ≥              ≥              ≥              ≥              ≥              ≥·§•´™®     ≥(ØÆ ·ÆÆ‚-   ≥                 ≥ØÆ™„Ø™®     ≥               ≥ ¢ ØÆ™„Ø™•     ≥                       ≥·§•´™®     ≥(ØÆ ·ÆÆ‚-   ≥                 ≥Ø‡Æ§†¶®     ≥               ≥ ¢ Ø‡Æ§†¶•     ≥                       ≥\n" +
          "≥                         ≥                         ≥                 ≥                 ≥         ≥              ≥              ≥              ≥              ≥                    ≥                    ≥              ≥              ≥              ≥              ≥              ≥              ≥              ≥              ≥ØÆ™„Ø™®    ≥¢•‚·‚¢„ÓÈ•© ≥                 ≥            ≥               ≥               ≥                       ≥Ø‡Æ§†¶®    ≥¢•‚·‚¢„ÓÈ•© ≥                 ≥            ≥               ≥               ≥                       ≥\n" +
          "≥                         ≥                         ≥                 ≥                 ≥         ≥              ≥              ≥              ≥              ≥                    ≥                    ≥              ≥              ≥              ≥              ≥              ≥              ≥              ≥              ≥           ≥Á†·‚®)      ≥                 ≥            ≥               ≥               ≥                       ≥           ≥Á†·‚®)      ≥                 ≥            ≥               ≥               ≥                       ≥\n" +
          "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
          "≥           1             ≥           2             ≥       3         ≥        4        ≥    5    ≥      6       ≥      7       ≥      8       ≥      9       ≥         10         ≥         11         ≥      12      ≥      13      ≥      14      ≥      15      ≥      16      ≥      17      ≥      18      ≥      19      ≥    20     ≥    21      ≥       22        ≥     23     ≥      24       ≥      25       ≥          26           ≥    27     ≥     28     ≥       29        ≥     30     ≥      31       ≥      32       ≥           33          ≥\n" +
          "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var ReportHeader =
"\n\n############################################################################################## #########################\n" +
"ë¢ÔßÎ¢†≠®• ·§•´Æ™ ¢ ≠†´Æ£Æ¢Æ¨ „Á•‚•\n" +
"ß† Ø•‡®Æ§ · ########## ØÆ ##########\n" +
"Ç®§ Ê\°:    ##########################################\n" +
"ÇÎØ„·™ Ê\°: ################### #################################################################\n";


PRIVATE CLASS (DL_CReportTemplate) SP_TxLots_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL )
  PRIVATE VAR m_SheetCount = 0,
              m_report,
              m_BegDate,
              m_EndDate,
              m_ProgressValue = CTxProgressValue();
          var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

  PRIVATE VAR m_IsDataExist = false; /*§´Ô Web, •·´® ≠•‚ §†≠≠ÎÂ, ‚Æ ≠®Á•£Æ ≠• ØÆ™†ßÎ¢†•¨*/
/* ≠• ØÆ™†ßÎ¢†‚Ï Ø„·‚Î• Æ‚Á•‚ ¢ Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*¢ EW ØÆ™†ßÎ¢†•¨ ´®·‚Î ¢·•£§†*/
    end;
  END; 

  MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  /* å†™‡Æ· ¢Æß¢‡†È†•‚ Á†·‚Ï Total/Portion Æ‚ SumMoney.
        SumMoney    - ¢†´Ó‚†
        Total       - Ê•´Æ•
        Part        - Ê•´Æ•
        ê•ß„´Ï‚†‚   - ¢†´Ó‚†. */
  PRIVATE MACRO Part( SumMoney, Part, Total )
     return IIF(Total != 0, money(SumMoney  * Part / Total), 0);
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    var
       INN = "", KPP = "",
       BankName,
       FiKind = "¢·•", FiCode = "¢·•", FiName = "¢·•", AvrFIIDList, AvrFIIDCount = 0;

    record fins(fininstr);
    m_SheetCount = 0;
    m_BegDate  = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_BEGDATE );
    m_EndDate  = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_ENDDATE );

    SplitFullINN(èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†({OurBank}, PTCK_INN), INN, KPP);
   
    if( INN != "" )
      INN = " àçç " + INN;
    end;
    if( KPP != "" )
      KPP = " äèè " + KPP;
    end;
    BankName = GetPartyByID({OurBank}, true).Name;

    TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRCODE, @FiName );
    if( not m_IsWebService )
       AvrFIIDList = TArray();
       AvrFIIDList[AvrFIIDList.Size] = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRCODE );
    else
       AvrFIIDList = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRCODE );
    end;
    if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
      if( ( ValType( AvrFIIDList[0] ) == V_INTEGER )
      and ( AvrFIIDList[0] > 0 ) )
         if( èÆ´„Á®‚Ïî®≠à≠(AvrFIIDList[0], fins) == 0 )
            FiCode = fins.FI_Code;
         end;
      end;
    
      AvrFIIDCount = 1;
      while( AvrFIIDCount < AvrFIIDList.Size )
         if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
         and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
            if( èÆ´„Á®‚Ïî®≠à≠(AvrFIIDList[AvrFIIDCount], fins) == 0 )
               FiCode = FiCode + ", " + fins.FI_Code;
            end;
         end;
         AvrFIIDCount = AvrFIIDCount + 1;
      end;
    end;

    TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRKIND, @FiKind );

    SetActiveSheet( "·¢Ôß® ·§•´Æ™" );

    PrintFormatString( ReportHeader,
                       "N_H0Ä", BankName,
                       "N_H0B", INN + KPP,
                       "N_H01", m_BegDate,
                       "N_H02", m_EndDate,
                       "N_H03", FiKind,
                       "N_H04", FiCode,
                       "N_H05", FiName
                     );

    RegisterTable( "N_MainTable", Table,
                   "N_SecName",
                   "N_EmitentName",
                   "N_NominalValue",
                   "N_VN",
                   "N_TypeLink",
                   "N_BuyCode",
                   "N_BuyType",
                   "N_SellCode",
                   "N_SellType",
                   "N_LinkDate",
                   "N_LinkQnty",
                   "N_SourceCode",
                   "N_CourceType",
                   "N_DestCode",
                   "N_DestType",
                   "N_Add1Code",
                   "N_Add1type",
                   "N_Add2Code",
                   "N_Add2Type",
                   "N_BuyDateDeal",
                   "N_BuyDateDeliv",
                   "N_BuyPriceVP",
                   "N_BuyVP",
                   "N_BuyNKDvn",
                   "N_BuyCourseDeliv",
                   "N_BuyContragent",
                   "N_SellDateDeal",
                   "N_SellDateDeliv",
                   "N_SellPriceVP",
                   "N_SellVP",
                   "N_SellNKDvn",
                   "N_SellCourseDeliv",
                   "N_SellContragent");      
  END;

  PRIVATE MACRO PrintLine(IsBuy)
    VAR Nominal = GetFaceValue(m_report.FIID),
        BuyLegKind,
        SaleLegKind,
        SrcLegKind,
        DstLegKind,
        Lot1LegKind,
        Lot2LegKind,
        BuyContr  = "",
        SaleContr = "",
        BuyPrice  = "",
        SalePrice = "",
        BuyPricePoint  = 2,
        SalePricePoint = 2,
        BuyPriceFin  = "",
        SalePriceFin = "",
        BuyNKD  = "",
        SaleNKD = "",
        BuyNKDPoint  = 2,
        SaleNKDPoint = 2,
        BuyCourse  = "",
        SaleCourse = "";

    macro ç†Ø•Á†‚†‚ÏäÆ≠‚‡†£•≠‚†( PartyID )
      var sql, rsd;

      sql = RSDCommand(" SELECT t_ShortName "
          +   " FROM dparty_dbt "
          +  " WHERE t_PartyID = ? " );
   
      sql.addParam( "", RSDBP_IN, PartyID );
      sql.execute();
      rsd = TRsbDataSet(sql);
      if(rsd.MoveNext())
        return rsd.ShortName;
      end;

      return "";
    end;

    macro GetParmDeal(DealID, IsBuy,
                      LegKindName:@STRING,
                      Contr:@STRING,
                      Price:@MONEY,
                      PriceFin:@STRING,
                      NKD:@MONEY,
                      Course:@MONEY)
      var Group, LegKind, ExistBack;
      var sql, rsd;    

      file tick("dl_tick");
      file leg("dl_leg");
      record lot("pmwrtsum");

      LegKindName = "";

      tick.DealID = DealID;
      if( getEQ(tick) );
        ClearRecord(lot);
        lot.Buy_Sale = IIF(IsBuy, PM_WRITEOFF_SUM_BUY, PM_WRITEOFF_SUM_SALE);
        LegKind = GetLegKindByLotDeal(lot, tick);

        Group = SP_GetOperationGroup(tick); 
        if( (IsBACKSALE(Group) == true) OR (IsREPO(Group) == true) OR (tick.BofficeKind == DL_CONVAVR) )
          ExistBack = true;
        else 
          ExistBack = false;
        end;

        if( ExistBack )
          if( LegKind == LEG_KIND_DL_TICK )
            LegKindName = LegKindName + "1";
          elif(LegKind == LEG_KIND_DL_TICK_BACK )
            LegKindName = LegKindName + "2";
          end;
        end;

        if( Contr != null )
          Contr = ç†Ø•Á†‚†‚ÏäÆ≠‚‡†£•≠‚†(GetContrInDeal(tick));
        end;

        ClearRecord(leg);
        leg.LegKind = LegKind;
        leg.DealID = DealID;
        leg.LegID = 0;
        if( getEQ(leg) )
          if( Price != null )
            Price = GetPriceByDlTickDlLeg(tick, leg, null, null, tick.DealDate);
          end;

          if( PriceFin != null )
            sql = RSDCommand(" SELECT t_Name "
                + "   FROM dfininstr_dbt "
                + "  WHERE t_FIID = ? " );
            sql.addParam( "", RSDBP_IN, leg.CFI );
            sql.execute();
            rsd = TRsbDataSet(sql);
            if(rsd.MoveNext())
              PriceFin = rsd.Name;
            end;
          end;

          if( NKD != null )
            NKD = Part( leg.NKD, money(m_report.LnkAmount), leg.Principal ) ;
          end;

          if( (Course != null) and (leg.CFI != NATCUR) )
            SmartConvertSum(Course, $1, IIF(IsBuy, date(m_report.BuyDate), date(m_report.SaleDate)), leg.CFI, NATCUR, false);
            InitError();
          end;
        end;
      elif(DealID == 0)
        if( Price != null )
          if( ConvSum( Price, $1, IIF(IsBuy, date(m_report.BuyDate), date(m_report.SaleDate)), m_report.FIID, m_report.FaceValueFI, 1 /*‡Î≠ÆÁ≠†Ô Ê•≠†*/) )
            if( ConvSum( Price, $1, IIF(IsBuy, date(m_report.BuyDate), date(m_report.SaleDate)), m_report.FIID, m_report.FaceValueFI, 6 /*‡†·Á•‚≠†Ô Ê•≠†*/) )
              Price = $0;
            end;
          end;
          InitError();
        end;

        if( PriceFin != null )
          PriceFin = m_report.FaceValueName;
        end;
      end;
    end;

    GetParmDeal(m_report.BuyLotID,  true,  @BuyLegKind,  @BuyContr,  @BuyPrice,  @BuyPriceFin,  @BuyNKD,  @BuyCourse);
    GetParmDeal(m_report.SaleLotID, false, @SaleLegKind, @SaleContr, @SalePrice, @SalePriceFin, @SaleNKD, @SaleCourse);

    GetParmDeal(m_report.SrcDealID,  true,  @SrcLegKind,  null, null, null, null, null);
    GetParmDeal(m_report.DstDealID,  false, @DstLegKind,  null, null, null, null, null);
    GetParmDeal(m_report.lot1DealID, false, @Lot1LegKind, null, null, null, null, null);
    GetParmDeal(m_report.lot2DealID, false, @Lot2LegKind, null, null, null, null, null);

    m_IsDataExist = true;
    PrintTableLine( "N_SecName",         m_report.finName,                 null,
                    "N_EmitentName",     m_report.IssName,                 null,
                    "N_NominalValue",    Nominal,                          null,
                    "N_VN",              m_report.FaceValueName,           null,
                    "N_TypeLink",        m_report.LnkType,                 null,
                    "N_BuyCode",         m_report.BuyNumber,               null,
                    "N_BuyType",         m_report.BuyType + BuyLegKind,    null,
                    "N_SellCode",        m_report.SaleNumber,              null,
                    "N_SellType",        m_report.SaleType + SaleLegKind,  null,
                    "N_LinkDate",        date(m_report.LnkDate),           null,
                    "N_LinkQnty",        m_report.LnkAmount,               SetPrecisionByFractPart(m_report.LnkAmount, m_report.finPrecision, 0),
                    "N_SourceCode",      m_report.SrcNumber,               null,
                    "N_CourceType",      m_report.SourceType + SrcLegKind, null,
                    "N_DestCode",        m_report.DstNumber,               null,
                    "N_DestType",        m_report.DestType + DstLegKind,   null,
                    "N_Add1Code",        m_report.Lot1Number,              null,
                    "N_Add1type",        m_report.Lot1Type + Lot1LegKind,  null,
                    "N_Add2Code",        m_report.Lot2Number,              null,
                    "N_Add2Type",        m_report.Lot2Type + Lot2LegKind,  null,
                    "N_BuyDateDeal",     date(m_report.BuyDealDate),       null,
                    "N_BuyDateDeliv",    date(m_report.BuyDate),           null,
                    "N_BuyPriceVP",      BuyPrice,                         null,
                    "N_BuyVP",           BuyPriceFin,                      null,
                    "N_BuyNKDvn",        BuyNKD,                           null,
                    "N_BuyCourseDeliv",  BuyCourse,                        null,
                    "N_BuyContragent",   BuyContr,                         null,
                    "N_SellDateDeal",    date(m_report.SaleDealDate),      null,
                    "N_SellDateDeliv",   date(m_report.SaleDate),          null,
                    "N_SellPriceVP",     SalePrice,                        null,
                    "N_SellVP",          SalePriceFin,                     null,
                    "N_SellNKDvn",       SaleNKD,                          null,
                    "N_SellCourseDeliv", SaleCourse,                       null,
                    "N_SellContragent",  SaleContr,                        null
                  );
  END;
  
  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    while( m_report.MoveNext() )
      PrintLine();
      m_ProgressValue.Current = m_ProgressValue.Current + 1;
      ProgressIndicator.Update(m_ProgressValue.Current,m_ProgressValue.Maximum); // ¢·•£Æ 3 Ø†‡†¨•‡† Update(index, count, text)
    end;

    EndTable();
  END;

  PRIVATE MACRO FormQuery()
    VAR sql,
        AvrFIIDList = null,
        AvrFIIDCount : Integer = 0,
        AvrFIIDAddWhere : String = "",

        AvrKindList = null,
        AvrKindAddWhere : String = "",
        AvrKindCount : Integer = 0,
         
        GNUList = null,
        GNUAddWhere : String = "",
        GNUCount : Integer = 0;

    macro GetLotTypeName( iKind, iType, iAiasName )
      return " NVL((SELECT t_szNameAlg "
           +        " FROM dnamealg_dbt "
           +       " WHERE t_iTypeAlg = " + string(iKind)
           +         " AND t_iNumberAlg = " + iType + " ), CHR(1)) " + iAiasName 
    end;

    sql = " SELECT fin.t_FIID FIID, fin.t_FaceValueFI, fin.t_Name finName, fin.t_SumPrecision finPrecision, "
        +        " buylot.t_DealCode BuyNumber, salelot.t_DealCode SaleNumber, "
        +        " buylot.t_DealID BuyLotID, salelot.t_DealID SaleLotID, "
        +        " buylot.t_BuyDate BuyDate, salelot.t_SaleDate SaleDate, "
        +        " buylot.t_DealDate BuyDealDate, salelot.t_DealDate SaleDealDate, "
        +        " lnk.t_Amount LnkAmount, lnk.t_Date LnkDate, "
        +        " (SELECT pt.t_ShortName"
        +           " FROM dparty_dbt pt "
        +          " WHERE pt.t_PartyID = fin.t_Issuer) IssName, "
        +        " NVL((SELECT ffin.t_Name"
        +               " FROM dfininstr_dbt ffin "
        +              " WHERE ffin.t_FIID = fin.t_FaceValueFI), CHR(1)) FaceValueName, "
        +        " NVL(srclot.t_DealID, -1) SrcDealID, "
        +        " NVL(srclot.t_DealCode, CHR(1)) SrcNumber, "
        +        " NVL(dstlot.t_DealID, -1) DstDealID, "
        +        " NVL(dstlot.t_DealCode, CHR(1)) DstNumber, "
        +        " NVL(lot1lot.t_DealID, -1) Lot1DealID, "
        +        " NVL(lot1lot.t_DealCode, CHR(1)) Lot1Number, "
        +        " NVL(lot2lot.t_DealID, -1) Lot2DealID, "
        +        " NVL(lot2lot.t_DealCode, CHR(1)) Lot2Number, "

        +        GetLotTypeName(ALG_SCTX_LINKTYPE, "lnk.t_Type", "LnkType") + ", "
        +        GetLotTypeName(ALG_SCTX_DEALKIND, "buylot.t_Type", "BuyType") + ", "
        +        GetLotTypeName(ALG_SCTX_DEALKIND, "salelot.t_Type", "SaleType") + ", "
        +        GetLotTypeName(ALG_SCTX_DEALKIND, "srclot.t_Type", "SourceType") + ", "
        +        GetLotTypeName(ALG_SCTX_DEALKIND, "dstlot.t_Type", "DestType") + ", "
        +        GetLotTypeName(ALG_SCTX_DEALKIND, "lot1lot.t_Type", "Lot1Type") + ", "
        +        GetLotTypeName(ALG_SCTX_DEALKIND, "lot2lot.t_Type", "Lot2Type")

        +   " FROM dsctxlot_dbt buylot, "
        +        " dsctxlot_dbt salelot, "
        +        " dsctxlnk_dbt lnk, "
        +        " dfininstr_dbt fin, "
        +        " dsctxlot_dbt srclot, "
        +        " dsctxlot_dbt dstlot, "
        +        " dsctxlot_dbt lot1lot, "
        +        " dsctxlot_dbt lot2lot "
        +  " WHERE buylot.t_ID = lnk.t_BuyID "
        +    " AND salelot.t_ID = lnk.t_SaleID "
        +    " AND lnk.t_Date >= " + GetSQLDate(m_BegDate)
        +    " AND lnk.t_Date <= " + GetSQLDate(m_EndDate)
        +    " AND fin.t_FIID = buylot.t_FIID "
        +    " AND srclot.t_ID(+) = lnk.t_SourceID "
        +    " AND dstlot.t_ID(+) = lnk.t_DestID "
        +    " AND lot1lot.t_ID(+) = lnk.t_Lot1ID "
        +    " AND lot2lot.t_ID(+) = lnk.t_Lot2ID ";

    if( not m_IsWebService )
       AvrKindList = TArray();
       AvrKindList[AvrKindList.Size] = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRKIND );
    else
       AvrKindList = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRKIND );
    end;
    /*ß†§†≠ ¢®§ °„¨†£®*/
    if( ( ValType( AvrKindList ) != V_UNDEF ) and ( AvrKindList.Size > 0 ) )
       while( AvrKindCount < AvrKindList.Size )
          if( ( ValType( AvrKindList[AvrKindCount] ) == V_INTEGER )
          and ( AvrKindList[AvrKindCount] > 0 ) )
             if( AvrKindAddWhere == "" )
                AvrKindAddWhere = AvrKindAddWhere + " AND ( ";
             else
                AvrKindAddWhere = AvrKindAddWhere + " OR ";
             end;
             AvrKindAddWhere = AvrKindAddWhere + " RSB_FIInstr.FI_AvrKindsEQ( " + string(FIKIND_AVOIRISS) + ", " + String( AvrKindList[AvrKindCount] ) + ", fin.t_AvoirKind) > 0 ";             
          end;
          AvrKindCount = AvrKindCount + 1;
       end;
       if( AvrKindAddWhere != "" )
          AvrKindAddWhere = AvrKindAddWhere + " ) ";
       end;
       sql = sql + AvrKindAddWhere;      
    end;

    if( not m_IsWebService )
       AvrFIIDList = TArray();
       AvrFIIDList[AvrFIIDList.Size] = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRCODE );
    else
       AvrFIIDList = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_AVRCODE );
    end;
    if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
       while( AvrFIIDCount < AvrFIIDList.Size )
          if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
          and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
             if( AvrFIIDAddWhere == "" )
                AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
             else
                AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
             end;
             AvrFIIDAddWhere = AvrFIIDAddWhere + " fin.t_FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
          end;
          AvrFIIDCount = AvrFIIDCount + 1;
       end;
       if( AvrFIIDAddWhere != "" )
          AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
       end;
       sql = sql + AvrFIIDAddWhere;
    end;

    sql = sql
        + " ORDER BY fin.t_Name, "
        +       " BuyNumber, "
        +       " BuyDate, "
        +       " SaleNumber, "
        +       " SaleDate ";

    return sql;
  END;

  PRIVATE MACRO Create()
    var sql;

    m_BegDate  = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_BEGDATE );
    m_EndDate  = TxLots_Form.GetFieldValue( PNFLD_SCTXLOT_REG_ENDDATE );

    sql = FormQuery();

    m_ProgressValue.Maximum = SQL_GetNRecs( sql );
    m_ProgressValue.Current = 0;

    m_report = TRsbDataSet(sql);

    if( m_IsWebService and (WebMenuItem != null) )
      var header = "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚† " + WebMenuItem.szNameItem;
      ProgressIndicator.Start(m_ProgressValue.Maximum, header, header);
    else
      ProgressIndicator.Start(m_ProgressValue.Maximum, "é‚°Æ‡ §†≠≠ÎÂ §´Ô Æ‚Á•‚† \"ë¢ÔßÎ¢†≠®• ´Æ‚Æ¢ ¢ ≠†´Æ£Æ¢Æ¨ „Á•‚•\"", "ë¢ÔßÎ¢†≠®• ´Æ‚Æ¢ ¢ ≠†´Æ£Æ¢Æ¨ „Á•‚•" );
    end;

    ExecuteReport();

    ProgressIndicator.Stop();
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    TxLots_Form = SP_TxLots_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      TxLots_Form = WS_TX_TxLots_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = TxLots_Form.Run();
    end;

    if( stat )
      TxLots_Report = SP_TxLots_Report( null, "Report_TXLots.xlsx", null, IsWebService, ReportHashCode, POI_MODE, BIGREPORT_MODE );
      TxLots_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( TxLots_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = TxLots_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( TxLots_Report.PrintMode() );
      end;
    end;
  end;

  return FullReportFileNames;
END;
