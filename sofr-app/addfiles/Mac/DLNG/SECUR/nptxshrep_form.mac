/*******************************************************************************
 DESCRIPTION  :   Отчет "Регистр по коротким позициям" (НДФЛ) - форма ввода данных
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   01.02.2011
*******************************************************************************/
import "DlRepForm_h.mac", "globals.mac";

/*Номера полей в форме отчета*/
CONST PNFLD_TXSHREP_REG_PERIOD       = 0,
      PNFLD_TXSHREP_REG_YEAR         = 1,
      PNFLD_TXSHREP_REG_GROWTH       = 2,
      PNFLD_TXSHREP_REG_BEGINDATE    = 3,
      PNFLD_TXSHREP_REG_ENDDATE      = 4,
      PNFLD_TXSHREP_REG_INVESTORCODE = 5,
      PNFLD_TXSHREP_REG_INVESTORNAME = 6,
      PNFLD_TXSHREP_REG_AVRGROUP     = 7,
      PNFLD_TXSHREP_REG_AVRKIND      = 8,
      PNFLD_TXSHREP_REG_AVRCODE      = 9,
      PNFLD_TXSHREP_REG_AVRNAME      = 10,
      PNFLD_TXSHREP_REG_PRINTMETHOD  = 11;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  end; 
  FldShowValue = FldRealValue;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) NPTX_ShRepReg_Panel()

  PRIVATE MACRO Init()
     VAR CurMonth, PrevQuartal, Year;
     DateSplit( {curdate}, null, CurMonth, Year );

     PrevQuartal = (CurMonth - 1)/3; /*текущий квартал-1*/
     if( PrevQuartal == 0 )
        PrevQuartal = 4;
        Year        = Year - 1;
     end;
     /*сбросить поля, связанные с ц\б*/
     if( GetFieldByName(0,DL_PNFLD_AVRGROUP) )
        SetLinkedValue( DL_PNFLD_AVRGROUP, null );
     end;
     if( GetFieldByName(0,DL_PNFLD_AVRKIND) )
        SetLinkedValue( DL_PNFLD_AVRKIND, null );
     end;
     if( GetFieldByName(0,DL_PNFLD_AVRCODE) )
        SetLinkedValue( DL_PNFLD_AVRCODE, null );
     end;

     AddFieldProc( 0, PNFLD_TXSHREP_REG_PERIOD,       DL_PNFLD_PERIOD,      @DL_FldProc_Period, PrevQuartal + 12, 17, 8 ); /*(+12 - для NameAlg.dbt)*/
     AddFieldProc( 0, PNFLD_TXSHREP_REG_YEAR,         DL_PNFLD_YEAR,        @DL_FldProc_Year, Year );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_GROWTH,       DL_PNFLD_GROWTH,      @DL_FldProc_Growth);
     AddFieldProc( 0, PNFLD_TXSHREP_REG_BEGINDATE,    DL_PNFLD_BEGINDATE,   @DL_FldProc_BeginDate );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_ENDDATE,      DL_PNFLD_ENDDATE,     @DL_FldProc_EndDate );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_INVESTORCODE, DL_PNFLD_CLIENT_STOCKDL_CODE, @DL_FldProc_Client_STOCKDL_Code );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_INVESTORNAME, DL_PNFLD_CLIENT_STOCKDL_NAME, @Default );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_AVRGROUP,     DL_PNFLD_AVRGROUP,    @DL_FldProc_NpTxGroup );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_AVRKIND,      DL_PNFLD_AVRKIND,     @DL_FldProc_AvrKind );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_AVRCODE,      DL_PNFLD_AVRCODE,     @DL_FldProc_NpTxAvrCode );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_AVRNAME,      DL_PNFLD_AVRNAME,     @Default );
     AddFieldProc( 0, PNFLD_TXSHREP_REG_PRINTMETHOD,  DL_PNFLD_PRINTMETHOD, @DL_FldProc_NpTxPrintMethod, DL_OUTREPORT_EXCEL, 36, 23 );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "sp_rep.lbr", "NPTXSHRT" ); 
END;
