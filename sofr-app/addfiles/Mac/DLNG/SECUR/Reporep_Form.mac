/*******************************************************************************
 DESCRIPTION  :   Отчет "Доходы и расходы по РЕПО" - форма ввода данных
 PROGRAMMED BY:   Makarov Andrey 26-02-2008
*******************************************************************************/

import "DlRepForm_h.mac", "globals.mac";

/*Номера полей в форме отчета 9.1 "доходы по РЕПО"*/
CONST PNFLD_REPOREP91_REG_PERIOD          = 0,
      PNFLD_REPOREP91_REG_YEAR            = 1,
      PNFLD_REPOREP91_REG_GOS             = 2,
      PNFLD_REPOREP91_REG_NOTGOS          = 3,
      PNFLD_REPOREP91_REG_NOMINRUR        = 4,
      PNFLD_REPOREP91_REG_NOMINCUR        = 5,
      PNFLD_REPOREP91_REG_ALLFI           = 6,
      PNFLD_REPOREP91_REG_SHAREFI         = 7,
      PNFLD_REPOREP91_REG_BONDFI          = 8,
      PNFLD_REPOREP91_REG_AVRKIND         = 9,
      PNFLD_REPOREP91_REG_ISAPP           = 10,
      PNFLD_REPOREP91_REG_PRINTMETHOD     = 11;

/*Номера полей в форме отчета 9.2 "расходы по РЕПО"*/
CONST PNFLD_REPOREP92_REG_PERIOD          = 0,
      PNFLD_REPOREP92_REG_YEAR            = 1,
      PNFLD_REPOREP92_REG_GOS             = 2,
      PNFLD_REPOREP92_REG_NOTGOS          = 3,
      PNFLD_REPOREP92_REG_NOMINRUR        = 4,
      PNFLD_REPOREP92_REG_NOMINCUR        = 5,
      PNFLD_REPOREP92_REG_ALLFI           = 6,
      PNFLD_REPOREP92_REG_SHAREFI         = 7,
      PNFLD_REPOREP92_REG_BONDFI          = 8,
      PNFLD_REPOREP92_REG_AVRKIND         = 9,
      PNFLD_REPOREP92_REG_ISAPP           = 10,
      PNFLD_REPOREP92_REG_PRINTMETHOD     = 11;

PRIVATE CONST /* Обработчики для нестандарных контролов */
      H_RADIO_ALLFI    = 101,
      H_RADIO_SHAREFI  = 102,
      H_RADIO_BONDFI   = 103;

CLASS ReporepFormData()
  VAR RegNum,
      Period,
      Year,
      Gos,
      NotGos,
      NominateInRUR,
      NotNominateInRUR,
      Bond_Kind,
      AvrKind_All,
      AvrKind_Share,
      AvrKind_Bond,
      IsApp;

  /* Значение по умолчанию */
  Period = 0;
  Year = 0;
  Gos = "X";
  NotGos = "X";
  NominateInRUR = "X";
  NotNominateInRUR = "X";
  Bond_Kind = 0;
  AvrKind_All = "X";
  AvrKind_Share = "";
  AvrKind_Bond = "";
  IsApp = "X";
END;

VAR FormData = ReporepFormData();

/*Период*/
PRIVATE MACRO DLUSR_FldProc_Period( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  VAR Month;

  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        DateSplit( {curdate}, null, Month, null );
        FldRealValue = ((Month - 1)/3 + 1) * 3; /*номер для NameAlg.dbt*/
     end;
     FldShowValue = DL_GetNameAlg( 2264, FldRealValue );

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     DL_ListNA( 2264, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_AvrKind( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var MenuValues   = TArray,
      ReturnValues = TArray,
      Choice, Query, AvrKindsDataSet;

  if( Cmd == DLG_INIT )
    if( FldRealValue == null )
       FldRealValue = 0;
    end;
    if( FldRealValue <= 0 )
       FldShowValue = STR_ALLVALUE;
    end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
    FldRealValue = 0;
    FldShowValue = STR_ALLVALUE;
    FormData.Bond_Kind = FldRealValue;
  elif( (Cmd == DLG_KEY) AND 
        (Key == KEY_F3)  AND 
        ((pThis.GetFieldValue(PNFLD_REPOREP91_REG_BONDFI) == "X") OR 
         (pThis.GetFieldValue(PNFLD_REPOREP92_REG_BONDFI) == "X") OR
         (pThis.GetFieldValue(PNFLD_REPOREP91_REG_ALLFI) == "X") OR 
         (pThis.GetFieldValue(PNFLD_REPOREP92_REG_ALLFI) == "X")
        )
      ) 
    Query = " SELECT T_NAME, T_AVOIRKIND "
          +   " FROM Davrkinds_DBT "
          +  " WHERE T_FI_KIND = " + string(FIKIND_AVOIRISS)
          +    " AND RSB_FIInstr.FI_AvrKindsGetRoot(2, T_AVOIRKIND) = 17 "; /*RSB_FIInstr.AVOIRKIND_BOND*/

    AvrKindsDataSet = TRSBDataSet(Query);
    while( AvrKindsDataSet.MoveNext() )              
      MenuValues[MenuValues.Size]     = AvrKindsDataSet.rec.Name; 
      ReturnValues[ReturnValues.Size] = AvrKindsDataSet.rec.AVOIRKIND;
    end;   
    Choice = menu( MenuValues, null, "Вид облигаций", pThis.CurrentFldX(), pThis.CurrentFldY() );
    if( Choice >= 0 )
       FldShowValue = MenuValues[Choice]; 
       FldRealValue = ReturnValues[Choice];
       FormData.Bond_Kind = FldRealValue;
    end;
  end;

  return CM_DEFAULT;
END;


MACRO DL_FldProc_RadioButton( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER

  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
    FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
    if( Key == KEY_SPACE )
      pThis.SetLinkedValue(H_RADIO_ALLFI, "");
      pThis.SetLinkedValue(H_RADIO_SHAREFI, "");
      pThis.SetLinkedValue(H_RADIO_BONDFI,  "");

      FldShowValue = FldRealValue = "X";

      FormData.AvrKind_All   = pThis.GetFieldValue(PNFLD_REPOREP91_REG_ALLFI);
      FormData.AvrKind_Share = pThis.GetFieldValue(PNFLD_REPOREP91_REG_SHAREFI);
      FormData.AvrKind_Bond  = pThis.GetFieldValue(PNFLD_REPOREP91_REG_BONDFI);

    end;
  end;

  return CM_DEFAULT;
END;


PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = "";
    end;

    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) SP_TxReg9_1_Panel()

  PRIVATE MACRO Init()
     VAR CurMonth;

     DateSplit( {curdate}, null, CurMonth, FormData.Year );

     FormData.Period = ((CurMonth - 1)/3 + 1) * 3; /*номер для NameAlg.dbt*/

     FormData.RegNum = 1;

     /*сбросить поля, связанные с ц\б*/
     if( GetFieldByName(0,H_RADIO_ALLFI) )
        SetLinkedValue( H_RADIO_ALLFI, SET_CHAR );
     end;
     if( GetFieldByName(0,H_RADIO_SHAREFI) )
        SetLinkedValue( H_RADIO_SHAREFI, null );
     end;
     if( GetFieldByName(0,H_RADIO_BONDFI) )
        SetLinkedValue( H_RADIO_BONDFI, null );
     end;
     if( GetFieldByName(0,DL_PNFLD_AVRCODE) )
        SetLinkedValue( DL_PNFLD_AVRCODE, null );
     end;

     AddFieldProc( 0, PNFLD_REPOREP91_REG_PERIOD,          DL_PNFLD_PERIOD,      @DLUSR_FldProc_Period,     FormData.Period, 26, 6 ); 
     AddFieldProc( 0, PNFLD_REPOREP91_REG_YEAR,            DL_PNFLD_YEAR,        @DL_FldProc_Year,       FormData.Year );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_GOS,             DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,   FormData.Gos );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_NOTGOS,          DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,   FormData.NotGos );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_NOMINRUR,        DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,   FormData.NominateInRUR );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_NOMINCUR,        DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,   FormData.NotNominateInRUR );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_ALLFI,           H_RADIO_ALLFI,        @DL_FldProc_RadioButton, FormData.AvrKind_All );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_SHAREFI,         H_RADIO_SHAREFI,      @DL_FldProc_RadioButton, FormData.AvrKind_Share );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_BONDFI,          H_RADIO_BONDFI,       @DL_FldProc_RadioButton, FormData.AvrKind_Bond );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_AVRKIND,         DL_PNFLD_AVRCODE,     @DLUSR_FldProc_AvrKind );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_ISAPP,           DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,    FormData.IsApp );
     AddFieldProc( 0, PNFLD_REPOREP91_REG_PRINTMETHOD,     DL_PNFLD_PRINTMETHOD, @DL_FldProc_PrintMethod, DL_OUTREPORT_EXCEL, 38, 23 );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "sp_rep.lbr", "INC_REP1" );
END;

CLASS (DL_CPanel) SP_TxReg9_2_Panel()

  PRIVATE MACRO Init()
     VAR CurMonth;

     DateSplit( {curdate}, null, CurMonth, FormData.Year );

     FormData.Period = ((CurMonth - 1)/3 + 1) * 3; /*номер для NameAlg.dbt*/

     FormData.RegNum = 2;

     /*сбросить поля, связанные с ц\б*/
     if( GetFieldByName(0,H_RADIO_ALLFI) )
        SetLinkedValue( H_RADIO_ALLFI, SET_CHAR );
     end;
     if( GetFieldByName(0,H_RADIO_SHAREFI) )
        SetLinkedValue( H_RADIO_SHAREFI, null );
     end;
     if( GetFieldByName(0,H_RADIO_BONDFI) )
        SetLinkedValue( H_RADIO_BONDFI, null );
     end;
     if( GetFieldByName(0,DL_PNFLD_AVRCODE) )
        SetLinkedValue( DL_PNFLD_AVRCODE, null );
     end;

     AddFieldProc( 0, PNFLD_REPOREP92_REG_PERIOD,          DL_PNFLD_PERIOD,      @DLUSR_FldProc_Period,      FormData.Period, 26, 6 ); 
     AddFieldProc( 0, PNFLD_REPOREP92_REG_YEAR,            DL_PNFLD_YEAR,        @DL_FldProc_Year,        FormData.Year );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_GOS,             DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,    FormData.Gos );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_NOTGOS,          DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,    FormData.NotGos );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_NOMINRUR,        DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,    FormData.NominateInRUR );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_NOMINCUR,        DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,    FormData.NotNominateInRUR );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_ALLFI,           H_RADIO_ALLFI,        @DL_FldProc_RadioButton, FormData.AvrKind_All );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_SHAREFI,         H_RADIO_SHAREFI,      @DL_FldProc_RadioButton, FormData.AvrKind_Share );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_BONDFI,          H_RADIO_BONDFI,       @DL_FldProc_RadioButton, FormData.AvrKind_Bond );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_AVRKIND,         DL_PNFLD_AVRCODE,     @DLUSR_FldProc_AvrKind );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_ISAPP,           DL_PNFLD_CHECKBOX,    @DL_FldProc_CheckBox,    FormData.IsApp );
     AddFieldProc( 0, PNFLD_REPOREP92_REG_PRINTMETHOD,     DL_PNFLD_PRINTMETHOD, @DL_FldProc_PrintMethod, DL_OUTREPORT_EXCEL, 38, 23 );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "sp_rep.lbr", "INC_REP2" );
END;
