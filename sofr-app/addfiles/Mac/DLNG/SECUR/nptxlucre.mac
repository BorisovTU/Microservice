/*
$Name:        nptxlucre.mac
$Module:      Ценные бумаги
$Description: Отчет "Регистр по материальной выгоде" (НДФЛ)
*/

/*******************************************************************************
 DESCRIPTION  :   Отчет "Регистр по материальной выгоде" (НДФЛ)
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   24.01.2011
*******************************************************************************/
IMPORT "nptxlucre_form.mac", "RegistrReport.mac", "dv_categ.mac", "dvserv.mac";

PRIVATE CONST Строка_Итого                = 0,
              Строка_СтрокаДанных         = 1;

PRIVATE CLASS (TX_RegistrReport) NPTX_LucreReg_Report
  VAR m_BeginDate;
  VAR m_IsSecur, m_IsDerivative;
  PRIVATE VAR m_RepCalc;

  PRIVATE MACRO PrintMode():INTEGER
     return m_Form.GetFieldValue( PNFLD_LUCRE_REG_PRINTMETHOD );
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    Dl_CallInsertStat(PrintMode());
  END;

  MACRO ПечататьСтрокуТаблицы( LineType:INTEGER )

     if( LineType == Строка_СтрокаДанных )
        PrintTableLine( "N1_Client",          this.Client(),         null,   /*1  */
                        "N1_ClientDeal",      this.ClientDeal(),     null,   /*2  */
                        "N1_ClientStatus",    this.ClientStatus(),   null,   /*3  */
                        "N1_SecCode",         IIF (this.IsSecur(), this.SecCode(), ""),      null,   /*4  */
                        "N1_SecName",         IIF (this.IsSecur(), this.SecName(), ""),      null,   /*5  */
                        "N1_VN",              IIF (this.IsSecur(), this.VN(), "" ),          null,   /*6  */
                        "N1_CodeB",           this.CodeB(),          null,   /*7  */
                        "N1_DZB",             this.DZB(),            null,   /*8/  */
                        "N1_DDB",             IIF (this.IsSecur(), iif((this.DDB() == date(0,0,0)) or (this.DDB() > this.H0_2()), null, this.DDB()),""),   null,   /*9  */
                        "N1_DPB",             IIF (this.IsSecur(), this.DPB(), ""),           null,   /*10  */
                        "N1_Qnty",            IIF( this.Qnty() >= 0, this.Qnty(), ""),        this.QntyPrecision(),   /*11 */
                        "N1_PrBvp",           this.PrBvp(),          null,   /*12 */
                        "N1_ValB",            this.ValBNumber(),     null,   /*13 */
                        "N1_VpB",             IIF (this.IsSecur(), this.VpBNUmber(),""),      null,   /*14 */
                        "N1_CrBD",            IIF (this.IsSecur(), this.CrBD(true), ""),          null,   /*15 */
                        "N1_KZB",             IIF (this.IsSecur(), this.KZB(), ""),           null,   /*16 */
                        "N1_MainBvp",         this.MainBvp(),        null,   /*17 */
                        "N1_MainBrub",        this.MainBrub(),       null,   /*18 */
                        "N1_bMrktB",          this.bMrktB(),         null,   /*19 */
                        "N1_PriceMrktB",      this.PriceMrktB(),     null,   /*20 */
                        "N1_MrktB",           this.MrktB(true),      null,   /*21 */
                        "N1_DMrktB",          IIF (this.IsSecur(), this.DMrktB(true), this.DZB()),     null,   /*22 */ 
                        "N1_Material",        this.Material(),       null,   /*23 */
                        "N1_ComB",            this.ComB(),           null,   /*24 */
                        "N1_NomB",            this.NomB(),           null,   /*25 */
                        "N1_ContB",           this.ContB(),          null,   /*26 */
                        "N1_SecType",         this.SecType(),        null,   /*27 */
                        "N1_TaxRate",         this.TaxRate(),        null    /*28 */ 
                      );  

     elif( LineType == Строка_Итого )

        SetCurrentLineFont( 8, true, false );
        PrintTableLine( "N1_Client",  "Всего:", null );

        SetCurrentLineFont( 8, false, false );
        PrintTableLine( "N1_Client",  "в том числе", null );

     end;
  END;
 
  PRIVATE MACRO Create()
    var DataSet;
    var InvestorID = -1;
    var count = 0, Num = 0;
    var AvrFIID, AvrKind, AvrGroup, Investor;

    m_BeginDate = this.H0_1();
    m_EndDate   = this.H0_2();
    m_IsSecur = IIF(m_Form.GetFieldValue(PNFLD_LUCRE_REG_ISSECURITY) == SET_CHAR, true, false);
    m_IsDerivative = IIF(m_Form.GetFieldValue(PNFLD_LUCRE_REG_DERIVATIVE) == SET_CHAR, true, false);

    SetActiveSheet( "РегистрМатВыгода" );

    PrintFormatString( "",
                       "N1_H0_1", this.H0_1(), // за период с
                       "N1_H0_2", this.H0_2(), // по
                       "N1_H0_3", this.H0_3(), // Группа налогового учета
                       "N1_H0_4", this.H0_4(), // Вид ц/б
                       "N1_H0_5", this.H0_5(), // Выпуск ц/б
                       "N1_H0_6", this.H0_6()  // Инвестор
                     );

    RegisterTable( "N1_MainTable", "",
    /*1  */        "N1_Client",   
    /*2  */        "N1_ClientDeal",  
    /*3  */        "N1_ClientStatus",  
    /*4  */        "N1_SecCode",   
    /*5  */        "N1_SecName",   
    /*6  */        "N1_VN",    
    /*7  */        "N1_CodeB", 
    /*8  */        "N1_DZB",   
    /*9  */        "N1_DDB",   
    /*10 */        "N1_DPB",   
    /*11 */        "N1_Qnty",  
    /*12 */        "N1_PrBvp", 
    /*13 */        "N1_ValB",  
    /*14 */        "N1_VpB",   
    /*15 */        "N1_CrBD",  
    /*16 */        "N1_KZB",   
    /*17 */        "N1_MainBvp",   
    /*18 */        "N1_MainBrub",  
    /*19 */        "N1_bMrktB",    
    /*20 */        "N1_PriceMrktB",   
    /*21 */        "N1_MrktB", 
    /*22 */        "N1_DMrktB",    
    /*23 */        "N1_Material",  
    /*24 */        "N1_ComB",  
    /*25 */        "N1_NomB",  
    /*26 */        "N1_ContB", 
    /*27 */        "N1_SecType",   
    /*28 */        "N1_TaxRate"
                  );  

    SetCellAutoSummaPoint( "Всего:", 
                      "N1_Qnty", 6,
                      "N1_MainBvp", 2, 
                      "N1_MainBrub", 2,
                      "N1_Material", 2,
                      "N1_ComB",2
                      );
                            
    this.ПечататьСтрокуТаблицы( Строка_Итого );

    AvrFIID = m_Form.GetFieldValue( PNFLD_LUCRE_REG_AVRCODE);
    AvrKind  = m_Form.GetFieldValue( PNFLD_LUCRE_REG_AVRKIND );
    AvrGroup = m_Form.GetFieldValue( PNFLD_LUCRE_REG_AVRGROUP );
    Investor = m_Form.GetFieldValue( PNFLD_LUCRE_REG_INVESTORCODE);

    var Select = CollectDataForNPTXLucreQuery(m_IsSecur, m_IsDerivative, m_BeginDate, m_EndDate, AvrFIID, AvrKind, AvrGroup, Investor, NULL, @count);
    m_RS = Select.Execute();

    if (count > 0)
      InitProgress( count, "Регистр материальной выгоды", "Регистр материальной выгоды" );

      m_CacheFinInstr.Clear();

      this.SetCurrentLineFont( 8, false, false );
        
      while( m_RS.MoveNext() )

        this.ClearCacheOneRecord();

        ПечататьСтрокуТаблицы( Строка_СтрокаДанных );

        UseProgress( Num = Num + 1 );
      end;

      RemProgress();
    end;

    EndTable();
    
    //промежуточные итоги
    SetSubtotal(13, 10 + MAXROWSHEET,
                "K7",
                "Q7",
                "R7",
                "W7",
                "X7" 
               );

    AddStandardFooter( "N1_" );

  END;

  MACRO ClearCacheOneRecord()
     this.ClearCacheOneRecord();
     m_KZB   = null;
     m_MainBvp  = null;
     m_MainBrub = null;
     m_Material = null;
  END;

  /*Начальная дата*/
  MACRO H0_1():DATE
     return FormData.BeginDate;
  END;

  /*Конечная дата*/
  MACRO H0_2():DATE
     return FormData.EndDate;
  END;

  /*Группа налогового учета*/
  MACRO H0_3():STRING
     var AttrID = m_Form.GetFieldValue( PNFLD_LUCRE_REG_AVRGROUP),
         GroupName = "";

     if (AttrID > 0)
        DL_GetObjAttrName( OBJTYPE_AVOIRISS, OBJGROUP_AVRNPTXGROUP, AttrID, @GroupName );
        return GroupName;
     end;

     return STR_ALLVALUE;
  END;

  /*Вид ц/б*/
  MACRO H0_4():STRING
     return FormData.AvrKind;
  END;

  /*Выпуск ц/б*/
  MACRO H0_5():STRING
     return FormData.AvrName;
  END;

  /*Инвестор*/
  MACRO H0_6():STRING
     return FormData.InvestorName;
  END;

  MACRO Client():STRING
    return m_Rs.InvestorName;
  END;

  MACRO DPB():DATE
    return SQL_ConvTypeDate(m_RS.PayBuyDate);
  END;

  MACRO ValBNumber():STRING  //валюта цены
    return m_CacheFinInstr.GetISO( m_RS.ValB ).m_Number;
  END;

  MACRO VpBNumber():STRING //валюта расчетов
    return m_CacheFinInstr.GetISO( m_RS.VpB ).m_Number;      
  END;

  MACRO KZB():DOUBLE
    var Rate = 0;
    if(m_KZB == NULL)
      if(this.IsSecur())
        Rate = GetRateOnDateCrossDbl( this.DZB(), m_RS.FaceValueFI, NATCUR, true );
        if((ValType(Rate) != V_UNDEF) AND (Rate != 0.0))
          m_KZB = GetRateOnDateCrossDbl( this.DZB(), this.ValB(), NATCUR, true )/Rate;
        else
          m_KZB = 0.0;
        end;
      end;
    end;

    if((m_KZB == NULL) or (m_KZB == 0.0))
      m_KZB = NULL;
      return 1.0;
    end;

    return m_KZB;
  END;

  MACRO IsSecur():BOOL
     return (m_RS.TypeBO == 0);
  END;

  MACRO Material():MONEY
    if(m_Material == NULL)
      if(this.IsSecur() == true)        
        DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_MATERIAL), NULL, this.H0_2(), TXOBJ_DIR_ALL, NULL, @m_Material, null, m_Rs.Investor);
      else
        DL_GetNPTXOBJSumByNDeal(m_Rs.DealBuyID, string(TXOBJ_MATERIAL), NULL, this.H0_2(), TXOBJ_DIR_ALL, NULL, @m_Material);
      end;  
    end;
    return m_Material;
  END;

  MACRO ComB():MONEY
    if(m_ComB == NULL)
      DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_COM), NULL, this.H0_2(), TXOBJ_DIR_ALL, NULL, @m_ComB, null, m_Rs.Investor);
    end;
    return m_ComB;
  END;


  MACRO NomB():MONEY // номинал облигации на дату <DDB>
    if(FI_IsBond(m_Rs.FIID))
      return this.NomB();
    end;
    return NULL;
  END;


  MACRO SecType():STRING
    if(this.IsSecur() == false)
      return DL_GetNPTXSecType(m_Rs.FIID, true, 0);
    else
      return DL_GetNPTXSecType(m_Rs.FIID);
    end;
  END;
      
  MACRO TaxRate():STRING
    if(m_TaxRate == NULL)
      m_TaxRate = DL_GetClientTaxRateGeneral(m_Rs.Investor, m_EndDate) * 100.0;
    end;
    return string(m_TaxRate, "%");
  END;     
  
  initTX_RegistrReport( NPTX_LucreReg_Panel(), "Report_NPTXLucre.xls" );
END;

  
NPTX_LucreReg_Report().Run();

exit(1);