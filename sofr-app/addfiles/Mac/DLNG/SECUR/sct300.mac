/* Операция продажи ц/б today
   Шаг - списание себестоимости    */

import InsCarryDoc, "sp_categ.mac", "sp_cars.mac", "scservop.mac";

macro ExecuteStep( Doc, FDoc )

  record deal(dl_tick);
  var    FD, dat;

  SetBuff( deal, FDoc );
  FD = SPFirstDoc ( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat ); /*Дата поставки ц/б */

  if( dat > {curdate} )
    return SayErrorBuySale( deal,"Преждевременное выполнение шага запрещено.");
  end;

  if( not СписаниеСебестоимостиПриПродаже(FD, dat, Doc) )
     return 1;
  end;

  if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_DELIVERY, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
    return 1;
  end;

  /*N1 = "Завершить"*/
  if( not InsertOprStatus( SP_OPERSTATUS_SECURDEALS_N1, SP_OPERSTATUS_SECURDEALS_N1_FINISH) ) 
     msgbox( "Ошибка при установке статуса <Учет себестоимости по 1 ч online> операции" );
     return 1;
  end;

  return 0;
end;
