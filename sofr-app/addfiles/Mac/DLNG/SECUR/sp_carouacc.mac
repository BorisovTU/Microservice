/*
$Name:        sp_carouacc.mac
$Module:      Ценные бумаги
$Description: Процедуры для проводок по внебалансу в операциях с ценными бумагами
*/
IMPORT "sp_caracc.mac", "sp_grfun.mac";

/* Проводки постановки сделки на внебаланс (для операций покупки/продажи)*/
/* _ChangeSum, _Acc1, _Acc2 - необязательные параметры*/
MACRO БУ_ПоставитьНаВнебаланс( FD, Dat, _ChangeSum, _Acc1, _Acc2, GrDealID )
   var  DealType;
   var  DealSumDeb = $0, DealSumCred = $0, DebFIID, CredFIID, IsSale;
   var  ChangeSum, CarrySum, StrGround = ""; 
   var  Acc1, Acc2, AccDeb, AccCred;
   var Dпс = date(0,0,0), Dпл = date(0,0,0);
   var Tr=false, Ob=false, K1=0, K2=0;
   var  ЭтоПостановкаНаВнебаланс = (_ChangeSum == null);
   var  FiRoleDeb = null, FiRoleCred = null;
   var InOutFlag = true;
   var СуммаСделки = $0;
   var Sptkchng = TRecHandler("sptkchng.dbt");
   var v_dlrq;

   if( IsClientDeal(FD.tick.rec) ) /*только собственные сделки */
      return 0;
   end;

   if( _ChangeSum != null ) 
      ChangeSum = _ChangeSum;
   else 
      ChangeSum = $0;
   end; 

   if( ЭтоПостановкаНаВнебаланс )
      ClearRecord(Sptkchng.rec);
      if( SP_GetDealParmsByDate( FD.tick, Dat, Sptkchng, false, true ) )
         //грузим из изменений
         FillFromSPTKCHNG( Sptkchng.rec, FD.tick, FD.dl_leg );
      end;
   else
      /*ищем состояние, соответсвующее изменениям GrDealID*/
      if( GrDealID != null )
         LoadSpTkChangeData(FD, null, GrDealID);
         FD  = SPFirstDoc( GetSpChangeDlTick, FD.IsBack, false, GetSpChangeDlLeg);
      end;
   end;

   FD.SetCurPFI(FD.CurPFI());

   if( GetDealBuySale( FD.tick.rec, FD.IsBack ) == DEAL_TYPE_SALE ) 
     IsSale  = true;
     DebFIID = FD.GetPayFIID(); /*валюта расчета*/
     CredFIID= FD.FaceFIID;          /*валюта номинала*/
   else 
     IsSale  = false;
     DebFIID = FD.FaceFIID;          /*валюта номинала*/
     CredFIID= FD.GetPayFIID(); /*валюта расчета*/
   end; 

   DealType = FD.ВидСрочностиСделки();

   if( FD.DealAsResultDVExe == false )

      if( _Acc1 == null ) 
         Acc1   = "+Форвард, прочие"; 
      else 
         Acc1   = _Acc1;
      end;

      if( _Acc2 == null )       
         Acc2   = "-Форвард, прочие";
      else 
         Acc2   = _Acc2;
      end; 

   else

      if( _Acc1 == null ) 
         Acc1   = "+Форвард, дрейф"; 
      else 
         Acc1   = _Acc1;
      end;
       
      if( _Acc2 == null )       
         Acc2   = "-Форвард, дрейф";
      else 
         Acc2   = _Acc2;
      end;      
   end;

   if( ChangeSum >= $0 )  
      AccDeb    = Acc1; 
      AccCred   = Acc2;
   else 
      AccDeb    = Acc2; 
      AccCred   = Acc1;
   end; 

   /*или постановка на внебаланс всей суммы сделки*/ 
   if( ЭтоПостановкаНаВнебаланс ) 
      CarrySum  = FD.dl_leg.rec.TotalCost;
   /*или корректировка суммы на внебалансе в большую или меньшую сторону*/ 
   else
      CarrySum  = Abs(ChangeSum);
   end; 

   /*получим сумму сделки в валюте счета по дебету*/
   if( DebFIID != FD.dl_leg.rec.CFI )
      if( not SmartConvertSum( DealSumDeb, CarrySum, dat, FD.dl_leg.rec.CFI, DebFIID, true))
         return 1;
      end;
   else
      DealSumDeb = CarrySum;
   end;
   /*получим сумму сделки в валюте счета по кредиту*/
   if(DebFIID != CredFIID)
     if( not SmartConvertSum( DealSumCred, DealSumDeb, dat, DebFIID, CredFIID, true))
         return 1;
      end;
   else
     DealSumCred = DealSumDeb;
   end;

   if( ЭтоПостановкаНаВнебаланс ) 
      FiRoleDeb  = FIROLE_FIREQ; 
      FiRoleCred = FIROLE_CORACC_ACTIVE;
//      StrGround  = "Постановка требований на внебалансовый учет"; 
      StrGround  = "Постановка на внебаланс для сделки/договора № " + UserGetDealCode(FD) + " от "+ FD.tick.rec.dealdate +"."; 
   else
      if( ChangeSum >= $0 )  
         FiRoleDeb  = FIROLE_FIREQ; 
         FiRoleCred = FIROLE_CORACC_ACTIVE;
         StrGround = "Корректировка сумм требований на внебалансовом учете для сделки/договора № " + UserGetDealCode(FD) + " от "+ FD.tick.rec.dealdate +"."; 
      else
         FiRoleDeb  = FIROLE_FICOM; 
         FiRoleCred = FIROLE_CORACC_PASSIVE;
         StrGround = "Корректировка сумм обязательств на внебалансовом учете для сделки/договора № " + UserGetDealCode(FD) + " от "+ FD.tick.rec.dealdate +".";  
      end;
   end;

   /*Подготовка сумм для проводки*/
   var oldCredFIID = CredFIID, oldDealSumCred = DealSumCred;
   if( CredFIID != NATCUR )
        CredFIID = NATCUR;

     if( FD.dl_leg.rec.CFI != NATCUR )
        if( not SmartConvertSum( DealSumCred, CarrySum, dat, FD.dl_leg.rec.CFI, CredFIID, true))
           return 1;
        end;
     else
        DealSumCred = CarrySum;
      end;
   end;

   FD.SetFIIDForCorAccNum(DebFIID);
   if( not БУ_ПроводкаПоКатегориямУчета( FD, 
          AccDeb, "СчКорреспГлаваГ", /* AccDeb , AccCred*/
          dat,                   /* Дата */
          4,                     /* Глава */
          DebFIID,                /* Валюта */
          DealSumDeb,            /* Сумма */
          INPCARRY,              /* Result_Carry */
          " 1",                  /* Kind_Oper */
          FD.tick.rec.DealCode,  /* Numb_Document */
          StrGround,             /* Ground */
          0, FiRoleDeb, FiRoleCred, 
          DebFIID, null,
          CredFIID, null/*DealSumCred */            /*сумма в валюте второго счета*/
         ))
       return 1;
   end;

   CredFIID = oldCredFIID; DealSumCred = oldDealSumCred;

   if( ЭтоПостановкаНаВнебаланс ) 
      FiRoleDeb  = FIROLE_CORACC_PASSIVE; 
      FiRoleCred = FIROLE_FICOM;
//      StrGround = "Постановка обязательств на внебалансовый учет"; 
   else
      if( ChangeSum >= $0 )  
         FiRoleDeb  = FIROLE_CORACC_PASSIVE; 
         FiRoleCred = FIROLE_FICOM;
         StrGround = "Корректировка сумм обязательств на внебалансовом учете для сделки/договора № " + UserGetDealCode(FD) + " от "+ FD.tick.rec.dealdate +".";  
      else
         FiRoleDeb  = FIROLE_CORACC_ACTIVE; 
         FiRoleCred = FIROLE_FIREQ;
         StrGround = "Корректировка сумм требований на внебалансовом учете для сделки/договора № " + UserGetDealCode(FD) + " от "+ FD.tick.rec.dealdate +".";  
      end;
   end;

   /*Подготовка сумм для проводки*/
   if( DebFIID != NATCUR )
         DebFIID = NATCUR;

     if( FD.dl_leg.rec.CFI != NATCUR )
        if( not SmartConvertSum( DealSumDeb, CarrySum, dat, FD.dl_leg.rec.CFI, DebFIID, true))
            return 1;
         end;
    else
        DealSumDeb = CarrySum;
       end;
    end;                                           

   FD.SetFIIDForCorAccNum(CredFIID);
   if( not БУ_ПроводкаПоКатегориямУчета( FD, 
          "СчКорреспГлаваГ", AccCred, /* AccDeb , AccCred*/
          dat,                   /* Дата */
          4,                     /* Глава */
          DebFIID,   /* Валюта */
          DealSumDeb,                /* Сумма */
          INPCARRY,              /* Result_Carry */
          " 1",                  /* Kind_Oper */
          FD.tick.rec.DealCode,         /* Numb_Document */
          StrGround,/* Ground */
          0, FiRoleDeb, FiRoleCred, 
          null, CredFIID,
          CredFIID, DealSumCred /*сумма в валюте второго счета*/
         ))
       return 1;
   end;

   return 0;
END;

PRIVATE MACRO СписаниеСуммыСделки( FD, dat, GetLastRest )

  record  СчетУчета( account );
  record  СчетУчета2( account );

  var   КатегКредит, КатегДеб, ПлатежТребОтложен = false, ПлатежОбязатОтложен = false;
  var   ОстатокНаСчете:money = 0, ОстатокНаСчете2:money = 0;
  var   DealType = FD.ВидСрочностиСделки();
  var   v_GetLastRest = true;
  var   Ground = "";
  if( GetLastRest != null )
     v_GetLastRest = GetLastRest;
  end;

  if( DealType == СделкаToday )
     var FDold = FD;
     var query = " select ch.* " +
                 "   from dsptkchng_dbt ch " +
                 "  where ch.t_DealID = ? " +
                 "    and ch.t_OldInstance = nvl((select max(tkch.t_OldInstance) " +
                 "                                  from dsptkchng_dbt tkch " +
                 "                                 where tkch.t_DealID = ch.t_DealID), 0) ";

     var cmd = DL_RSDCommand(query);
     cmd.AddParam(FD.tick.rec.DealID);

     var DataSet = cmd.Execute();
     if( DataSet.MoveNext() )
        FillFromSPTKCHNG(DataSet, FDold.tick, FDold.dl_leg);
        FDold.InitParmArray();
        FDold.ПолучитьДатыСделки(true, false);
        DealType = FDold.ВидСрочностиСделки();
     end;
  end;

  if( FD.BuySale == DEAL_TYPE_SALE ) 
     ПлатежОбязатОтложен = ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_DELIVERY));
     ПлатежТребОтложен   = ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_PAYMENT));
  else
     ПлатежОбязатОтложен = ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_PAYMENT));
     ПлатежТребОтложен   = ТОБылоПролонгировано(FD.GetRQ(DLRQ_TYPE_DELIVERY));
  end;

  if( (not FD.БылоОтложенноеИсполнение()) OR (1==1) )  //КД Отключена проверка на отложенность
     if( FD.DealAsResultDVExe == false )
        КатегКредит = "+Форвард, прочие"; 
        КатегДеб    = "-Форвард, прочие"; 
     else
        КатегКредит = "+Форвард, дрейф"; 
        КатегДеб    = "-Форвард, дрейф"; 
     end;
  elif( ПлатежОбязатОтложен AND (not ПлатежТребОтложен) ) 
     /*есть (были) только отложенные обязательства, нет отложенных требований*/
     if( FD.DealAsResultDVExe == false )
        КатегКредит = "+Форвард, прочие";
     else
        КатегКредит = "+Форвард, дрейф";
     end;
     КатегДеб = "-Форвард, ОИ";
  elif( ПлатежТребОтложен AND (not ПлатежОбязатОтложен) )
     /*есть (были) только отложенные требования, нет отложенных обязательств*/
     КатегКредит = "+Форвард, ОИ"; 
     if( FD.DealAsResultDVExe == false )
        КатегДеб = "-Форвард, прочие";
     else
        КатегДеб = "-Форвард, дрейф";
     end;
  else /*были и отложенные требования и отложенные обязательства*/
     КатегКредит = "+Форвард, ОИ"; 
     КатегДеб    = "-Форвард, ОИ";
  end;   

  if( not FD.IsExistAccount( КатегДеб, null, true, FIROLE_FICOM, СчетУчета, null, dat ))
     return 0; /*Счета нет, списывать нечего*/
  end;
  if( not FD.IsExistAccount( КатегКредит, null, true, FIROLE_FIREQ, СчетУчета2, null, dat ))
     return 0; /*Счета нет, списывать нечего*/
  end;
  
  if((КатегКредит == "+Форвард, прочие") AND (КатегДеб == "-Форвард, прочие"))
    ОстатокНаСчете   = GetSumTrnOverFromGraph(FD.tick.rec.DealID, FD.tick.rec.BOfficeKind, DLGR_TEMPL_OFFBALANCE, КатегДеб) + 
                       GetSumTrnOverFromDocs(FD.tick.rec.DealID, FD.tick.rec.BOfficeKind, dat, IIF(FD.BuySale == DEAL_TYPE_BUY, false, true));
    ОстатокНаСчете2  = GetSumTrnOverFromGraph(FD.tick.rec.DealID, FD.tick.rec.BOfficeKind, DLGR_TEMPL_OFFBALANCE, КатегКредит) + 
                       GetSumTrnOverFromDocs(FD.tick.rec.DealID, FD.tick.rec.BOfficeKind, dat, IIF(FD.BuySale == DEAL_TYPE_BUY, true, false));
    v_GetLastRest = false;
  elif(not v_GetLastRest)
    ОстатокНаСчете  = ABS( GetRestAccount( СчетУчета, dat ) );
    ОстатокНаСчете2  = ABS( GetRestAccount( СчетУчета2, dat ) );
  end;
  Ground = "Списание с внебаланса по сделке " +UserGetDealCode(FD) +" от " +FD.tick.rec.DealDate ; 
  /*выполняем проводки на остатки по счетам*/
  FD.SetFIIDForCorAccNum(СчетУчета.Code_Currency);
  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
         СчетУчета, "СчКорреспГлаваГ", /* Деб , Кредит*/
         dat,                   /* Дата */
         4,                     /* Глава */
         СчетУчета.Code_Currency,/* Валюта */
         ОстатокНаСчете,        /* Сумма */
         INPCARRY,              /* Result_Carry */
         " 1",                  /* Kind_Oper */
         FD.tick.rec.DealCode,  /* Numb_Document */
         Ground/*"Снятие с внебалансового учета обязательств по сделке " +FD.tick.rec.DealCode*/,/* Ground */
         IIF(v_GetLastRest,GETRESTACC_DEBET,null), 
         null, FIROLE_CORACC_PASSIVE)
    )
      return 1;
  end;

  FD.SetFIIDForCorAccNum(СчетУчета2.Code_Currency);
  if( not БУ_ПроводкаПоКатегориямУчета( FD, 
         "СчКорреспГлаваГ", СчетУчета2, /* Деб , Кредит*/
         dat,                   /* Дата */
         4,                     /* Глава */
         null,/* Валюта */
         null,        /* Сумма */
         INPCARRY,              /* Result_Carry */
         " 1",                  /* Kind_Oper */
         FD.tick.rec.DealCode,  /* Numb_Document */
         Ground/*"Снятие с внебалансового учета требований по сделке " +FD.tick.rec.DealCode*/,/* Ground */
         IIF(v_GetLastRest,GETRESTACC_CREDIT,null), 
         FIROLE_CORACC_ACTIVE, null, 
         null, null,
         СчетУчета2.Code_Currency,
         ОстатокНаСчете2)
    )
      return 1;
  end;

  return 0;
END;

private var sptkchng = TBfile( "sptkchng.dbt", "R", 3 );
 
/* получить дату изменений условий сделки, при которых меняли сумму сделки или   */
/* выполнялось снятие с внебаланса и постановка на внебаланс с новой суммой      */
/* при этом полученная дата изменений должна быть больше переданной Dуч          */
/*
PRIVATE MACRO ПолучитьДатуИзмененияУсловий( FD, Dуч )

   var   loop, DealID = FD.tick.rec.DealID,  ChangeDate = FD.tick.rec.ChangeDate;

   if( ChangeDate != Date(0,0,0) )

      sptkchng.Clear();   
      sptkchng.Rewind();
      sptkchng.rec.DealID        = DealID;
      sptkchng.rec.OldChangeDate = ChangeDate;

      loop = sptkchng.GetLE();

      while( loop AND (sptkchng.rec.DealID == DealID) AND (ChangeDate > Dуч) )
         
         if( FD.IsBack == false )
            if(   (sptkchng.rec.OldTotalCost1 != FD.dl_leg.rec.totalCost)  OR 
                  (sptkchng.rec.OldCFI1 != FD.dl_leg.rec.CFI)              OR 
                  (sptkchng.rec.OldPayFIID1 != FD.GetPayFIID() )
            )
               return ChangeDate;
            end;
         else
            if(   (sptkchng.rec.OldTotalCost2 != FD.dl_leg.rec.TotalCost)  OR 
                  (sptkchng.rec.OldCFI2 != FD.dl_leg.rec.CFI)              OR 
                  (sptkchng.rec.OldPayFIID2 != FD.GetPayFIID() )
            )
               return ChangeDate;
            end;

         end;

         ChangeDate = sptkchng.rec.OldChangeDate;      

         loop = sptkchng.Prev();
      end;
   end;

   return Dуч; /*не нашли подходящую операцию изменения условий сделки, вернем дату без изменения*/   
END;
*/
/* Проводки снятия сделки с внебаланса (для операций покупки/продажи)*/
MACRO БУ_СнятьСВнебаланса( FD, Dat, GetLastRest )

  /*var DealType, КатегКредит, КатегДеб, Dуч, Dget;
  var СуммаСделкиНаДатуУчета = $0;*/

  if( IsClientDeal(FD.tick.rec) ) /*только собственные сделки */
     return 0;
  end;

  /*
  if( FD.IsBack == true )
     Dуч = FD.DateArray[DATE_DEALOUTBAL_2];
  else 
     Dуч = FD.DateArray[DATE_DEALDATE];
  end; 

  Dget= FD.DateArray[DATE_DEALBEGINEXEC];

  if( FD.tick.rec.ChangeDate > Dуч )
     Dуч = ПолучитьДатуИзмененияУсловий( FD, Dуч );
  end;  

  /*  Получаем сумму сделки (сумма которая выносится на внебаланс).                    */
  /*  Берем сумму на конец предыдущего дня, так как в течении этого дня (даты учета)   */ 
  /*  сумма могла поменяться, например при изменении сроков сделки.                    */ 
  if( ПолучитьЦеновыеУсловияСделки( FD.tick, Dget, FD.IsBack, null, null, null, СуммаСделкиНаДатуУчета ) == false )
     return 1;
  end; 
  */
  if( СписаниеСуммыСделки( FD, dat, GetLastRest ) != 0 )
     return 1;
  end; 

  return 0;
END; 
