/*                           
$Name:             RegistrReport.mac
$Module:           Ценные бумаги
$Description:      Общий класс отчетов НУ
*/
/*******************************************************************************
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   20.10.09
*******************************************************************************/
IMPORT "spCache.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac", "sccomiss.mac", "nptxfun.mac", "dvserv.mac";

MACRO CorrectGNUList(GNUList:@TArray)
  var i = 0;
  var NewGNUList = TArray();

  if(GNUList.size > 0)
    while(i < GNUList.size)
      if(GNUList[i] == 101) //Сводная НГ "Государственные и муниципальные облига-ции  - процентные"
        NewGNUList[NewGNUList.size] = 1;
        NewGNUList[NewGNUList.size] = 3;
        NewGNUList[NewGNUList.size] = 5;
      elif(GNUList[i] == 109) //Сводная НГ "Облигации, номинированные в валюте РФ - процентные"
        NewGNUList[NewGNUList.size] = 9;
        NewGNUList[NewGNUList.size] = 19;
      elif(GNUList[i] == 130) //Сводная НГ "Облигации, номинированные в иностранной валюте - процентные"
        NewGNUList[NewGNUList.size] = 32;
        NewGNUList[NewGNUList.size] = 33;
        NewGNUList[NewGNUList.size] = 43;
      else
        NewGNUList[NewGNUList.size] = GNUList[i];
      end;

      i = i + 1;
    end;

    GNUList = TArray(NewGNUList);
  end;
END;

MACRO ЛьготностьБумагиНаДату( FIID:integer, EndDate:date ):bool

  var RetVal:bool = false;
  var Year:integer = 0;

  DateSplit(EndDate, null, null, Year);

  var Select = " SELECT Rsb_SCTX.IsSPGetRate(?, -1, Rsb_Common.GetRegIntValue('SECUR\\ВИД КУРСА СРЕДНЕВЗВЕШЕННАЯ ЦЕНА', 0), ?, ?-add_months(?,-3)) as RetVal " +
               "   FROM DUAL ";

  var Query = DL_RSDCommand(Select);
  Query.addParam(FIID);
  Query.addParam(EndDate);
  Query.addParam(EndDate);
  Query.addParam(EndDate-1);

  var DataSet = Query.execute();

  if( DataSet.MoveNext() )
     RetVal = IIF((int(DataSet.RetVal)) == 0, true, false);
  end;

  return RetVal;
END;

MACRO GetCouponSumByPeriodWithOperStat( FIID, Amount, DateBeg, DateEnd, IsPartial:STRING, ToFIID:INTEGER, CouponCount:@INTEGER, ExcludeDate, CalcByDates, IsClosed:bool, CoupRetData:bool, OperStat:bool)
  var cmd, rsd;
  var Sum = 0.0, S, NumCoupon = 0;
  var DrawingDate,
      Maturity; //дата получения средств

  if( IsClosed == null )
    IsClosed = false;
  end;

  cmd = RSDCommand(
        " SELECT FI.t_FaceValueFI, FI.t_FaceValue, warnt.t_DrawingDate as DrawingDate, "
      + "        warnt.t_IncomeRate, warnt.t_IncomeScale, warnt.t_Number "
      + "   FROM dfiwarnts_dbt warnt, dfininstr_dbt FI "
      + "  WHERE warnt.t_FIID = ? and "
      + "        warnt.t_IsPartial = " + IIF(IsPartial=="X","chr(88)", "chr(0)") + " and "
      + "        warnt.t_DrawingDate <= ? and "
      + "        warnt.t_DrawingDate >= ? and "
      + IIF (((ExcludeDate != null) and (ValType(ExcludeDate) == V_DATE) and (ExcludeDate != date(0, 0, 0))), 
             "   warnt.t_DrawingDate != ? and ",
             ""
            )
      + IIF (IsClosed, 
             IIF(CheckTaxDepositoryMode() == false, " warnt.t_SpIsClosed = 'X' and ", " warnt.t_IsClosed = 'X' and "),
             ""
            )
      + "        (SELECT COUNT (1) " 
      + "           FROM DDL_TICK_DBT tick " 
      + "          WHERE     tick.t_pfi = warnt.t_fiid " 
      + "                AND tick.T_DEALTYPE in (2022,12022) " 
      + "                AND tick.T_BOFFICEKIND = 117 " 
      + "                AND tick.t_dealstatus = 20 " 
      + "                AND tick.t_number_coupon = warnt.T_NUMBER) "
      + IIF (OperStat, 
             " > 0 and ",
             " = 0 and "
            )
      + "        FI.t_FIID = warnt.t_FIID "
      + " ORDER BY warnt.t_DrawingDate ASC "
                  );

  cmd.addParam( "", RSDBP_IN, FIID );
  cmd.addParam( "", RSDBP_IN, DateEnd );
  cmd.addParam( "", RSDBP_IN, DateBeg );

  if((ExcludeDate != null) and (ValType(ExcludeDate) == V_DATE) and (ExcludeDate != date(0, 0, 0)))
     cmd.addParam( "", RSDBP_IN, ExcludeDate );
  end;

  cmd.execute();

  rsd = TRsbDataSet(cmd);
  while(rsd.MoveNext())
    DrawingDate = SQL_ConvTypeDate(rsd.DrawingDate);
    S = $0;
    Maturity = DrawingDate;

    if(CoupRetData)
      GetCoupRetData(FIID, rsd.Number, Amount, @S, @Maturity);
    end;

    /*Сумма частичных погашений*/
    if (IsPartial == "X")
       S = Amount * rsd.FaceValue * rsd.IncomeRate/MAX( 1, rsd.IncomeScale)/100.0;
    /*Сумма купонов*/
    else
      if(S == 0)
        S = СуммаКупона(FIID, Amount, DrawingDate );
      end;
    end;

    if( ToFIID != NULL )
      SmartConvertSumDbl( S, S, Maturity, int(rsd.FaceValueFI), ToFIID, true );
    end;

    /*Такие специфические суммы используются например в регистрах 9.1 и 9.2*/
    if (CalcByDates != NULL)
      S = S * (DateBeg - DrawingDate);
    end;

    Sum = Sum + S;
    NumCoupon = NumCoupon + 1;
  end;

  CouponCount = NumCoupon;
  return Sum;
END;

PRIVATE CLASS PreferentialPeriod( _BegDate:date, _EndDate:date, _Preferential:bool )
  var BegDate      = _BegDate,
      EndDate      = _EndDate,
      Preferential = _Preferential;
END;

// Налоговые периоды льготные/нельготные
CLASS TaxPeriods()

  var m_Periods = TArray();
  var m_AllDate = TArray();
  var m_MonDate = TArray();
  var m_FIID:integer = ALLFININSTR;
  var m_BegDate:date = date(0,0,0), m_EndDate:date = date(0,0,0), m_EndPrevMon:date = date(0,0,0);

  MACRO Clear()
     m_Periods.Size = 0;
     m_AllDate.Size = 0;
     m_MonDate.Size = 0;
     m_FIID = ALLFININSTR;
     m_BegDate    = date(0,0,0);
     m_EndDate    = date(0,0,0);
     m_EndPrevMon = date(0,0,0);
  END;

  MACRO Init( FIID:integer, BegDate:date, EndDate:date )
     var i = 0;

     Clear();

     m_FIID       = FIID;
     m_BegDate    = BegDate;
     m_EndDate    = EndDate;
     m_EndPrevMon = m_BegDate - 1;

     // добавляем начало периода
     if( m_BegDate <= m_EndDate )
        m_MonDate[m_MonDate.Size] = m_BegDate;
     else
        return; // не корректная ситуация
     end;

     // добавляем последнии календарные дни каждого месяца, дополнительную дату и конец периода
     var BreakWhile = false;
     while( not BreakWhile )
        if( m_EndPrevMon < m_EndDate )

           var BegMon:date = date(0,0,0);
           var CurMonth, CurYear;

           BegMon = m_EndPrevMon + 1;
           DateSplit(BegMon, null, CurMonth, CurYear);
           m_EndPrevMon = min(date(SP_LastDay(CurMonth, CurYear), CurMonth, CurYear), m_EndDate);

           m_MonDate[m_MonDate.Size] = m_EndPrevMon;
        else
           BreakWhile = true;
        end;
     end;

     if( m_MonDate.Size > 0 )
        i = 0;
        while( i < (m_MonDate.Size-1) )

           m_AllDate[m_AllDate.Size] = m_MonDate[i];

           // отберем даты окончания купонных периодов
           if( SC_UseDrawingDateTaxPeriods() ) // учитываются при формировании периодов, только если настройка V16 = да
              var select = RSDCommand(" select warnt.t_DrawingDate " +
                                      "   from dfiwarnts_dbt warnt " +
                                      "  where warnt.t_FIID = ? "  +
                                      "    and warnt.t_IsPartial != 'X' " + 
                                      "    and warnt.t_DrawingDate > ? " +
                                      "    and warnt.t_DrawingDate < ? ");

              select.addParam("", RSDBP_IN, FIID);
              select.addParam("", RSDBP_IN, m_MonDate[i]);
              select.addParam("", RSDBP_IN, m_MonDate[i+1]);
              select.execute();

              var Query = TRsbDataSet(select);
              while( Query.MoveNext() )
                 m_AllDate[m_AllDate.Size] = date(Query.DrawingDate);
              end;
           end;

           i = i + 1;
        end;
        m_AllDate[m_AllDate.Size] = m_MonDate[i];
     end;

     // определим налоговые периоды
     if( m_AllDate.Size > 0 )
        var BegDatePeriod    = m_AllDate[0];
        var PrevPreferential = ЛьготностьБумагиНаДату(m_FIID, m_AllDate[1]);

        i = 2;
        while( i < m_AllDate.Size )
           var Preferential = ЛьготностьБумагиНаДату(m_FIID, m_AllDate[i]);

           if( Preferential != PrevPreferential )
              m_Periods[m_Periods.Size] = PreferentialPeriod(BegDatePeriod, m_AllDate[i-1], PrevPreferential);
              BegDatePeriod    = m_AllDate[i-1];
              PrevPreferential = Preferential;
           end;

           i = i + 1;
        end;

        if( (m_Periods.Size == 0) or (m_Periods[m_Periods.Size-1].EndDate != m_AllDate[i-1]) )
           m_Periods[m_Periods.Size] = PreferentialPeriod(BegDatePeriod, m_AllDate[i-1], PrevPreferential);
        end;
     end;
  END;

END;


CLASS (DL_CReportTemplate) TX_RegistrReport( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, FocreFormatRep:INTEGER )

  VAR m_RS, m_H07, m_H08, m_ReportKind;
  VAR m_CacheFinInstr = TX_CacheFinInstr();
  VAR T_Dep:T_Dep_Collector;
  var m_TaxPeriods = TaxPeriods();
  VAR m_CacheISO = TX_CacheISO();
  VAR FD;
  VAR DendStr:String;
  VAR Dend = ZeroDate;
  GetRegistryValue("DEPO\\ДАТА ПРИЗН. КУПОНОВ ЦБ ИН.ЭМИТ", V_STRING, DendStr, 0); //по умолчанию в настройке должна быть дата 31,03,2024
  Dend = Date(DendStr);
  if( Dend == ZeroDate )
    Dend = Date(31, 03, 2024);
  end;
  var DendYear:INTEGER;
  DateSplit(Dend, NULL, NULL, DendYear);

  /*Кэшируемые данные для 1 записи отчета */
  PRIVATE VAR m_DZS, m_PrSvn, m_NkdSvn, m_NomS, m_NomB, m_NkdPrevVN, m_NkdBefVN, m_NKDownVN, 
              m_PrAucNom, m_CoupVN, m_CoupRub, m_AmortVN, m_AmortRub, m_ExcludeDateCouponPeriod,
              m_NkdPrevRub, m_PrBNom, m_SumSrub, m_ComS, m_NDSComS, m_DZB, m_PrBVN, m_PrSNom, m_NkdBvn,
              m_DifB, m_ComB, m_NDSComB, m_CrSZ, m_CrBZ, m_SumBrub, m_CrBD, m_CrSD, m_ifCoupPrev,
              m_SellType, m_SumSvp, m_SumSvn, m_SumBvp, m_SumBvn,
              m_DqualB, m_DqualS, m_CrBP, m_CrSP, m_DifS, m_TaxRate,
              m_K_ControlB, m_K_ControlS, m_ComB_Another, m_ComS_Another, m_DPS, m_DPB, m_Nom_H07_1,
              m_CrDDS, m_CrDDB, m_CrDZS, m_CrDZB,m_ContB_Dep, m_ContS_Dep, m_Material,
              m_DealSale = TBFile( "dl_tick.dbt", "R", 0 ),
              m_DealBuy  = TBFile( "dl_tick.dbt", "R", 0 ),
              m_LegSale  = TBFile( "dl_leg.dbt", "R", 0 ),
              m_LegBuy   = TBFile( "dl_leg.dbt", "R", 0 ),
              m_KZB, m_MainBvp, m_MainBrub,
              m_EndDate;

  MACRO CollectDataForNPTXLucreQuery(IsSecur, IsDerivative, BeginDate, EndDate, AvrFIID, AvrKind, AvrGroup, Investor, IsIIS:INTEGER, Count:@Integer, ContractIDsStr, UseAddCondition)
     var query = "";

     if (IsSecur)
         query = query + " select client.t_Name as InvestorName, av.t_TaxGroup, buylot.t_Client as Investor, FinInstr.t_FI_Code as AvrCode, FinInstr.t_Name as AvrName, "
                       + "        FinInstr.t_FaceValueFI, buylot.t_DealCodeTS as DealBuyCodeTS, buylot.t_DealDate as DealBuyDate, buylot.t_BuyDate, "
                       + "        cdlrq.t_FactDate as PayBuyDate, FinInstr.t_FIID, "
                       + "        buylot.t_Amount, FinInstr.t_SumPrecision, LegB.t_Price as BuyPrice, FinInstr.t_AvoirKind, "
                       + Get_PartyName_Query( "DealBuy",  "PartyNameBuy", "buylot.t_Client" )  + ", " /*PartyNameBuy*/
                       + "        buylot.t_DocID as DealBuyID, LegB.t_CFI as ValB, cdlrq.t_FIID as VpB, "     
            
                       + "        NPTO.GetMinMarketPrice(FinInstr.t_FIID,buylot.t_DealDate,DealBuy.t_DealID) MinMarketPrice, "
                       + "        NPTO.GetMinMarket(FinInstr.t_FIID,buylot.t_DealDate,DealBuy.t_DealID) Market, "
                       + "        NPTO.GetMinDateMarket(FinInstr.t_FIID,buylot.t_DealDate,DealBuy.t_DealID) DateMarket, "
                       + "        NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DealDate) IfMarket, "
                       + "        case when DealBuy.t_IsPartyClient = 'X' and DealBuy.t_PartyID = buylot.t_Client then 1 else 0 end IsPartyClient,  "
                       + "        0 AS TypeBO, " 
                       + "        -1 AS T_DVKIND, " 
                       + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
                       + "        ( "
                       + "           select nvl(sum(obj.t_Sum0), 0) "
                       + "           from dnptxobj_dbt obj "
                       + "           where obj.t_Date <= " + GetSQLDate(EndDate)
                       + "             and obj.t_Kind = " + string(TXOBJ_COM)
                       + "             and obj.t_AnaliticKind1 = " + string(TXOBJ_KIND1010)
                       + "             and obj.t_Analitic1 = DealBuy.t_DealID "
                       + "        ) as ComB, "
                       + "        0 as IsSaleRepl, "
                       + "        0 as IsBuyRepl, "
                       + "        0 as IsRepayCoup, "
                       + "        0 as IsBuyCoup, "
                       + "        0 as NkdB_TS, "
                       + "        0 as AllNkdB_TS, "
                       + "        NVL((SELECT MAX(rq.t_FactDate) "
                       + "               FROM ddlrq_dbt rq "
                       + "              WHERE rq.t_DocKind = DealBuy.t_BOfficeKind "
                       + "                AND rq.t_DocID = DealBuy.t_DealID "
                       + "                AND rq.t_Type IN (" + DLRQ_TYPE_PAYMENT + ", " + DLRQ_TYPE_DELIVERY + ") "
                       + "            ), "+GetSQLDate(date(0,0,0))+") as MaxPayRqFactDate, "
                       + "        NVL((SELECT MAX (T_OPERDATE) "
                       + "               FROM DNPTXOP_DBT txop "
                       + "              WHERE     txop.t_client = buylot.t_Client "
                       + "                    AND txop.t_dockind = " + DL_CALCNDFL
                       + "                    AND txop.t_Recalc = CHR(0) "
                       + "                    AND txop.T_STATUS = " + DL_TXOP_Close
                       + "                    AND txop.T_OPERDATE BETWEEN "+GetSQLDate(BeginDate)+" and "+GetSQLDate(EndDate)
                       + "                    AND NOT EXISTS "
                       + "                               (SELECT 1 "
                       + "                                  FROM dobjatcor_dbt objatcor "
                       + "                                 WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
                       + "                                       AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
                       + "                                       AND objatcor.T_GROUPID = 1 "
                       + "                                       AND objatcor.T_ATTRID = 1) "
                       + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, "
                       + "       NVL((SELECT sf.t_Number "
                       + "              FROM ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
                       + "             WHERE mp.t_SfContrID = buylot.t_Contract "
                       + "               AND dlc.t_DlContrID = mp.t_DlContrID "
                       + "               AND sf.t_ID = dlc.t_SfContrID "
                       + "           ), CHR(1)) as ContractB "
                       + "   from dnptxlot_dbt buylot, dfininstr_dbt FinInstr, davoiriss_dbt av, dparty_dbt client, ddl_tick_dbt DealBuy, ddl_leg_dbt LegB, "
                       + "        ddlrq_dbt bdlrq, ddlrq_dbt cdlrq"
                       + "  where buylot.t_Kind = " + NPTXLOTS_BUY
                       + "    and bdlrq.t_ID = buylot.t_RQID "
                       + "    and cdlrq.t_DocID = buylot.t_DocID "
                       + "    and cdlrq.t_DocKind = buylot.t_DocKind "
                       + "    and cdlrq.t_Type = " + DLRQ_TYPE_PAYMENT
                       + "    and cdlrq.t_DealPart = 1 "/*Отбираются сделки обычной покупки (из одной части)*/
                       + "    AND cdlrq.t_subkind = " + DLRQ_SUBKIND_CURRENCY
                       + "    and ((DealBuy.t_DealDate < to_date('01.01.2016','DD.MM.YYYY') "
                       + "          and (cdlrq.t_FactDate > " + GetSQLDate(BeginDate) + " or cdlrq.t_factDate = " + GetSQLDate(date(0,0,0)) + ")"
                       + "          and bdlrq.t_FactDate BETWEEN "+GetSQLDate(BeginDate)+" and "+GetSQLDate(EndDate)
                       + "         ) OR "
                       + "         (DealBuy.t_DealDate >= to_date('01.01.2016','DD.MM.YYYY') and cdlrq.t_State = " + string(DLRQ_STATE_EXEC)
                       + "          and (case when bdlrq.t_FactDate < cdlrq.t_FactDate then cdlrq.t_FactDate else bdlrq.t_FactDate end) BETWEEN "+GetSQLDate(BeginDate)+" and "+GetSQLDate(EndDate)
                       + "         ) "
                       + "        ) "
                       + "    and FinInstr.t_FIID = buylot.t_FIID " 
                       + "    and av.t_FIID = FinInstr.t_FIID "
                       + "    and client.t_PartyID = buylot.t_Client "
                       + "    and DealBuy.t_DealID = buylot.t_DocID "
                       + "    and LegB.t_DealID    = DealBuy.t_DealID " 
                       + "    and LegB.t_LegKind   = " + LEG_KIND_DL_TICK
                       + "    and LegB.t_LegID     = 0 ";

         if(UseAddCondition == true)
           query = query + " and Exists(select 1 "
                                   + "    from dnptxobj_dbt obj "
                                   + "   where obj.t_Client = buylot.t_Client "
                                   + "     and obj.t_Kind = " + TXOBJ_MATERIAL
                                   + "     and obj.t_AnaliticKind1 = " + TXOBJ_KIND1010
                                   + "     and obj.t_Analitic1 = DealBuy.t_DealID "
                                   + " )"
         end;

         if((IsIIS == 0) or (IsIIS == 1))
            query = query + "    and ( "
                          + "           ( "
                          + "              DealBuy.t_IsPartyClient = chr(88) "
                          + "              and ( "
                          + "                    ( "
                          + "                       ? = 1 "
                          + "                       and RSI_NPTO.CheckContrIIS(DealBuy.t_PartyContrID) = 1 "
                          + "                    ) "
                          + "                    or ( "
                          + "                          ? = 0 "
                          + "                          and RSI_NPTO.CheckContrIIS(DealBuy.t_PartyContrID) = 0 "
                          + "                       ) "
                          + "                  ) "
                          + "           ) "
                          + "           or ( "
                          + "                 DealBuy.t_IsPartyClient <> chr(88) "
                          + "                 and ( "
                          + "                        ( "
                          + "                           ? = 1 "
                          + "                           and RSI_NPTO.CheckContrIIS(DealBuy.t_ClientContrID) = 1 "
                          + "                        ) "
                          + "                        or ( "
                          + "                              ? = 0 "
                          + "                              and RSI_NPTO.CheckContrIIS(DealBuy.t_ClientContrID) = 0 "
                          + "                           ) "
                          + "                     ) "
                          + "              ) "
                          + "        ) ";
         end;

         if((ContractIDsStr != NULL) and (ContractIDsStr != ""))
           query = query + " and (DealBuy.t_ClientContrID IN ("+ContractIDsStr+") or DealBuy.t_PartyContrID IN ("+ContractIDsStr+")) ";
         end;
     
         if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*задана бумага*/
            query = query + " and buylot.t_FIID = " + string(AvrFIID);
         else
            if( (AvrKind != null) AND (AvrKind > 0 ) ) /*задан вид бумаги*/
               query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, " + string(AvrKind) + ", FinInstr.t_AvoirKind) = 1 ";
            end;
     
            if( (AvrGroup != null) AND (AvrGroup > 0 ) ) /*задана категория бумаги*/
               query = query +" and "+ Get_NpTxAvrGroup_Query(AvrGroup,"FinInstr.t_FIID");
            end;
         end;
     
         if( (Investor != null) AND (Investor > 0 ) )
           query = query + " and buylot.t_Client = " + Investor;
         end;

         //Добавить операции зачисления ц/б с признаком "Учитывать для расчета материальной выгоды"
         query = query + " UNION ALL "
                       + " SELECT client.t_Name as InvestorName, av.t_TaxGroup, buylot.t_Client as Investor, FinInstr.t_FI_Code as AvrCode, FinInstr.t_Name as AvrName, "
                       + "        FinInstr.t_FaceValueFI, buylot.t_DealCodeTS as DealBuyCodeTS, buylot.t_DealDate as DealBuyDate, buylot.t_BuyDate, "
                       + "        npto.GetDateFromAvrWrtIn(DealBuy.t_DealID, LegB.t_Start, DealBuy.t_DealDate ) as PayBuyDate, FinInstr.t_FIID, "
                       + "        buylot.t_Amount, FinInstr.t_SumPrecision, LegB.t_Price as BuyPrice, FinInstr.t_AvoirKind, "
                       + Get_PartyName_Query( "DealBuy",  "PartyNameBuy", "buylot.t_Client" )  + ", " /*PartyNameBuy*/
                       + "        buylot.t_DocID as DealBuyID, LegB.t_CFI as ValB, LegB.t_CFI as VpB, "     
            
                       + "        NPTO.GetMinMarketPrice(FinInstr.t_FIID,buylot.t_DealDate,DealBuy.t_DealID) MinMarketPrice, "
                       + "        NPTO.GetMinMarket(FinInstr.t_FIID,buylot.t_DealDate,DealBuy.t_DealID) Market, "
                       + "        NPTO.GetMinDateMarket(FinInstr.t_FIID,buylot.t_DealDate,DealBuy.t_DealID) DateMarket, "
                       + "        NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DealDate) IfMarket, "
                       + "        0 as IsPartyClient,  "
                       + "        0 AS TypeBO, " 
                       + "        -1 AS T_DVKIND, " 
                       + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
                       + "        ( "
                       + "           select nvl(sum(obj.t_Sum0), 0) "
                       + "           from dnptxobj_dbt obj "
                       + "           where obj.t_Date <= " + GetSQLDate(EndDate)
                       + "             and obj.t_Kind = " + string(TXOBJ_COM)
                       + "             and obj.t_AnaliticKind1 = " + string(TXOBJ_KIND1070)
                       + "             and obj.t_Analitic1 = DealBuy.t_DealID "
                       + "        ) as ComB, "
                       + "        0 as IsSaleRepl, "
                       + "        0 as IsBuyRepl, "
                       + "        0 as IsRepayCoup, "
                       + "        0 as IsBuyCoup, "
                       + "        0 as NkdB_TS, "
                       + "        0 as AllNkdB_TS, "
                       + "        NVL((SELECT MAX(rq.t_FactDate) "
                       + "               FROM ddlrq_dbt rq "
                       + "              WHERE rq.t_DocKind = DealBuy.t_BOfficeKind "
                       + "                AND rq.t_DocID = DealBuy.t_DealID "
                       + "                AND rq.t_Type IN (" + DLRQ_TYPE_DELIVERY + ") "
                       + "            ), "+GetSQLDate(date(0,0,0))+") as MaxPayRqFactDate, "
                       + "        NVL((SELECT MAX (T_OPERDATE) "
                       + "               FROM DNPTXOP_DBT txop "
                       + "              WHERE     txop.t_client = buylot.t_Client "
                       + "                    AND txop.t_dockind = " + DL_CALCNDFL
                       + "                    AND txop.t_Recalc = CHR(0) "
                       + "                    AND txop.T_STATUS = " + DL_TXOP_Close
                       + "                    AND txop.T_OPERDATE BETWEEN "+GetSQLDate(BeginDate)+" and "+GetSQLDate(EndDate)
                       + "                    AND NOT EXISTS "
                       + "                               (SELECT 1 "
                       + "                                  FROM dobjatcor_dbt objatcor "
                       + "                                 WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
                       + "                                       AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
                       + "                                       AND objatcor.T_GROUPID = 1 "
                       + "                                       AND objatcor.T_ATTRID = 1) "
                       + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, "
                       + "       NVL((SELECT sf.t_Number "
                       + "              FROM ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
                       + "             WHERE mp.t_SfContrID = buylot.t_Contract "
                       + "               AND dlc.t_DlContrID = mp.t_DlContrID "
                       + "               AND sf.t_ID = dlc.t_SfContrID "
                       + "           ), CHR(1)) as ContractB "
                       + "   FROM dnptxlot_dbt buylot, dfininstr_dbt FinInstr, davoiriss_dbt av, dparty_dbt client, ddl_tick_dbt DealBuy, ddl_leg_dbt LegB, ddlrq_dbt bdlrq "
                       + "  WHERE buylot.t_Kind = " + NPTXLOTS_BUY
                       + "    and buylot.t_DocKind = " + DL_AVRWRT
                       + "    and buylot.t_ClGOID = 0 "
                       + "    and DealBuy.t_DealID = buylot.t_DocID "
                       + "    and DealBuy.t_Flag2 = 'X' " //"Учитывать для расчета материальной выгоды"
                       + "    and bdlrq.t_ID = buylot.t_RQID "
                       + "    and bdlrq.t_FactDate BETWEEN "+GetSQLDate(BeginDate)+" and "+GetSQLDate(EndDate)
                       + "    and FinInstr.t_FIID = buylot.t_FIID " 
                       + "    and av.t_FIID = FinInstr.t_FIID "
                       + "    and client.t_PartyID = buylot.t_Client "
                       + "    and DealBuy.t_DealID = buylot.t_DocID "
                       + "    and LegB.t_DealID    = DealBuy.t_DealID " 
                       + "    and LegB.t_LegKind   = " + LEG_KIND_DL_TICK
                       + "    and LegB.t_LegID     = 0 ";

         if(UseAddCondition == true)
           query = query + " and Exists(select 1 "
                                   + "    from dnptxobj_dbt obj "
                                   + "   where obj.t_Client = buylot.t_Client "
                                   + "     and obj.t_Kind = " + TXOBJ_MATERIAL
                                   + "     and obj.t_AnaliticKind1 = " + TXOBJ_KIND1070
                                   + "     and obj.t_Analitic1 = DealBuy.t_DealID "
                                   + " )";
         end;

         if((IsIIS == 0) or (IsIIS == 1))
            query = query + "    and RSI_NPTO.CheckContrIIS(DealBuy.t_ClientContrID) = " + IsIIS;
         end;

         if((ContractIDsStr != NULL) and (ContractIDsStr != ""))
           query = query + " and (DealBuy.t_ClientContrID IN ("+ContractIDsStr+") or DealBuy.t_PartyContrID IN ("+ContractIDsStr+")) ";
         end;
     
         if( (AvrFIID != null) AND (AvrFIID > 0 ) ) /*задана бумага*/
            query = query + " and buylot.t_FIID = " + string(AvrFIID);
         else
            if( (AvrKind != null) AND (AvrKind > 0 ) ) /*задан вид бумаги*/
               query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, " + string(AvrKind) + ", FinInstr.t_AvoirKind) = 1 ";
            end;
     
            if( (AvrGroup != null) AND (AvrGroup > 0 ) ) /*задана категория бумаги*/
               query = query +" and "+ Get_NpTxAvrGroup_Query(AvrGroup,"FinInstr.t_FIID");
            end;
         end;
     
         if( (Investor != null) AND (Investor > 0 ) )
           query = query + " and buylot.t_Client = " + Investor;
         end;
     
      end;

      if (IsDerivative)
        if( query != "")
          query = query + " UNION ALL ";
        end;
     
        query = query + 
                    " SELECT client.t_Name AS InvestorName,   "+
                    "        -1 AS t_TaxGroup,        "+
                    "        ndeal.t_Client AS Investor,      "+
                    "        '' AS AvrCode,   "+
                    "        '' AS AvrName,   "+
                    "        0 AS FaceValueFI,        "+
                    "        ndeal.t_Code AS DealBuyCodeTS,   "+
                    "        ndeal.t_date AS DealBuyDate,     "+
                    "        TO_DATE ('01.01.0001', 'dd.mm.yyyy') AS t_BuyDate,       "+
                    "        TO_DATE ('01.01.0001', 'dd.mm.yyyy') AS PayBuyDate, "+
                    "        nfi.t_FIID,      "+
                    "        CASE WHEN ndeal.T_DVKIND = "+ string(DV_FORWARD) +
                    "                                  THEN NFI.T_AMOUNT ELSE -1 END AS t_Amount,     "+
                    "        nfi.t_Point as t_SumPrecision,   "+
                    "        CASE WHEN ndeal.T_DVKIND = "+ string(DV_FORWARD) +
                    "                                  THEN NFI.T_PRICE ELSE ndeal.t_BonusPrice END AS BuyPrice,      "+
                    "        -1 AS AvoirKind, "+
                    "        NVL ( (SELECT p.t_Name   "+
                    "                 FROM dparty_dbt p       "+
                    "                WHERE p.t_PartyID = ndeal.t_Client),     "+
                    "             CHR (1))    "+
                    "           AS PartyNameBuy,      "+
                    "        ndeal.t_id AS DealBuyID, "+
                    "        CASE WHEN ndeal.T_DVKIND = "+ string(DV_FORWARD) +
                    "                                  THEN NFI.T_PRICEFIID ELSE ndeal.t_BonusFIID END AS ValB,       "+
                    "        0 AS VpB,        "+
                    "        NPTO.GetMinMarketPrice_DV(ndeal.T_ID) MinMarketPrice, "+
                    "        NPTO.GetMarket_DV(ndeal.T_ID) Market, "+
                    "        NPTO.GetDateMarket_DV(ndeal.T_ID) DateMarket, "+
                    "        chr(0) IfMarket, "+
                    "        0 AS IsPartyClient,      "+
                    "        -1 AS TypeBO,    "+
                    "        ndeal.T_DVKIND, "+
                    "        0 BuyIsVirtual, "+
                    "        ( "+
                    "           select nvl(sum(obj.t_Sum0), 0) "+
                    "           from dnptxobj_dbt obj "+
                    "           where obj.t_Date <= " + GetSQLDate(EndDate) +
                    "             and obj.t_Kind = " + string(TXOBJ_COM) +
                    "             and obj.t_AnaliticKind1 = " + string(TXOBJ_KIND1090) +
                    "             and obj.t_Analitic1 = ndeal.t_ID "+
                    "        ) as ComB, "+
                    "        0 as IsSaleRepl, " +
                    "        0 as IsBuyRepl, " +
                    "        0 as IsRepayCoup, " +
                    "        0 as IsBuyCoup, "+
                    "        0 as NkdB_TS, " +
                    "        0 as AllNkdB_TS, " +
                    "        ndeal.t_Date as MaxPayRqFactDate, " + 
                    "        NVL((SELECT MAX (T_OPERDATE) " +
                    "               FROM DNPTXOP_DBT txop " +
                    "              WHERE     txop.t_client = ndeal.t_Client " +
                    "                    AND txop.t_dockind = " + DL_CALCNDFL +
                    "                    AND txop.t_Recalc = CHR(0) " +
                    "                    AND txop.T_STATUS = " + DL_TXOP_Close+
                    "                    AND txop.T_OPERDATE BETWEEN "+GetSQLDate(BeginDate)+" and "+GetSQLDate(EndDate) +
                    "                    AND NOT EXISTS " +
                    "                               (SELECT 1 " +
                    "                                  FROM dobjatcor_dbt objatcor " +
                    "                                 WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) " +
                    "                                       AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC +
                    "                                       AND objatcor.T_GROUPID = 1 " +
                    "                                       AND objatcor.T_ATTRID = 1) " +
                    "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, " +
                    "       NVL((SELECT sf.t_Number " +
                    "              FROM ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf " +
                    "             WHERE mp.t_SfContrID = ndeal.t_ClientContr " +
                    "               AND dlc.t_DlContrID = mp.t_DlContrID " +
                    "               AND sf.t_ID = dlc.t_SfContrID " +
                    "           ), CHR(1)) as ContractB " +
                    "   FROM ddvndeal_dbt ndeal,      "+
                    "        doproper_dbt opr,        "+
                    "        doprstep_dbt step,       "+
                    "        dparty_dbt client,       "+
                    "        ddvnfi_dbt nfi   "+
                    "  WHERE NDEAL.T_DATE BETWEEN " + GetSQLDate(BeginDate) +" and " + GetSQLDate(EndDate) +
                    "        and ndeal.t_Client = client.t_PartyID"+
                    "        and ndeal.T_DVKIND IN ( "+string(DV_FORWARD) + " , " + string(DV_OPTION)+ " ) " +        
                    "        and NPTO.IfMarket_DV(ndeal.T_ID) != 'X' " +
                    "        AND nfi.T_DealID = ndeal.T_ID    "+
                    "        AND NDEAL.T_STATE > 0    "+
                    "        AND LTRIM (opr.T_DocumentID, '0') = ndeal.T_ID   "+
                    "        AND step.t_ID_Operation = opr.t_ID_Operation     "+
                    "        AND opr.T_DocKind =  " + string(DL_DVNDEAL) +
                    "        and (opr.t_End_Date >=  " + GetSQLDate(BeginDate) + " or opr.t_End_Date = TO_DATE('01.01.0001','DD.MM.YYYY')) "+       
                    "        AND (step.t_Symbol = 'ф' OR step.t_Symbol = 'Ф') "+
                    "        AND step.t_IsExecute = 'X'       "+
                    "        AND client.t_LegalForm = " + string(PTLEGF_PERSN); 
     
     
        if( (AvrGroup != null) AND (AvrGroup > 0 ) ) /*задана категория бумаги*/
           query = query +" and "+ Get_NpTxAvrGroup_Query(AvrGroup,"nfi.t_FIID");
        end;
     
        if( (Investor != null) AND (Investor > 0 ) )
          query = query + " and ndeal.t_Client = " + Investor;
        end;  
     
      end;
     
      query = query + " order by DealBuyDate asc";
     
      var QuerySelect = DL_RSDCommand(query);
      if((IsIIS == 0) or (IsIIS == 1))
         QuerySelect.AddParam(IsIIS);
         QuerySelect.AddParam(IsIIS);
         QuerySelect.AddParam(IsIIS);
         QuerySelect.AddParam(IsIIS);
      end;
      Count = QuerySelect.GetCount();

      return QuerySelect;
  END;

  MACRO GetDL_FORMULA():string
     return "formula=";
  END;

  MACRO НомерТекущейСтроки()
     return (getCurrentRow()+1);
  END;

  MACRO ClearCacheOneRecord()
     m_DZS   = null;
     m_PrSvn = null;
     m_NkdSvn= null;
     m_NomS  = null;
     m_NomB  = null;
     m_NkdPrevVN = null;
     m_NkdBefVN  = null;
     m_NKDownVN  = null;
     m_PrAucNom  = null;
     m_CoupVN    = null;
     m_CoupRub   = null;
     m_AmortVN   = null;
     m_AmortRub  = null;
     m_NkdPrevRub= null;
     m_PrBNom    = null;
     m_SumSrub   = null;
     m_ComS      = null;
     m_NDSComS   = null;
     m_DealSale.Clear();
     m_DealBuy.Clear();
     m_LegSale.Clear();
     m_LegBuy.Clear(); 
     m_DZB       = null;
     m_PrBVN     = null;
     m_PrSNom    = null;
     m_SumSvn    = null;
     m_SumSvp    = null;
     m_SumBvn    = null;
     m_SumBvp    = null;
     m_NkdBvn    = null;
     m_DifB      = null;
     m_ComB      = null;
     m_NDSComB   = null;
     m_CrSZ      = null;
     m_CrBZ      = null;
     m_SumBrub   = null;
     m_CrSD      = null;
     m_CrBD      = null;
     m_ifCoupPrev= null;
     m_SellType  = null;
     m_DqualB    = null;
     m_DqualS    = null;
     m_CrBP      = null;
     m_CrSP      = null;
     m_DifS      = null;
     m_TaxRate   = null;
     m_K_ControlB = null;
     m_K_ControlS = null;
     m_ComB_Another = null;
     m_ComS_Another = null;
     m_DPS = null;
     m_DPB = null;
     m_Nom_H07_1 = null;
     m_CrDDS = null;
     m_CrDDB = null;
     m_CrDZS = null;
     m_CrDZB = null;
     m_ContB_Dep = null;
     m_ContS_Dep = null;
     m_KZB       = null;
     m_MainBvp   = null;
     m_MainBrub  = null;
     m_ExcludeDateCouponPeriod = null;
  END;

  MACRO ExecuteReport()
    T_Dep.ClearArray();
    m_CacheFinInstr.Clear();
    m_CacheISO.Clear();
  END;

  MACRO Material():MONEY
    if(m_Material == NULL)
      if(this.IsSecur() == true)        
        DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_MATERIAL), NULL, this.H0_2(), TXOBJ_DIR_ALL, NULL, @m_Material, null, m_Rs.Investor);
      else
        DL_GetNPTXOBJSumByNDeal(m_Rs.DealBuyID, string(TXOBJ_MATERIAL), NULL, this.H0_2(), TXOBJ_DIR_ALL, NULL, @m_Material);
      end;  
    end;
    return m_Material;
  END;

  PRIVATE MACRO GetDeal( Deal:TBFile, DealID:INTEGER ):BOOL
     Deal.Clear();
     Deal.rec.DealID = DealID;
     return Deal.GetEQ();
  END;

  MACRO DealSale():TBFile
     if( m_DealSale.rec.DealID == 0 )
        if( GetDeal( m_DealSale, m_RS.DealSaleID ) == false )
           MsgBox( "Не найдена сделка по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealSaleID)  );
           m_DealSale.Clear();
        end;
     end;
     return m_DealSale;
  END;

  MACRO DealBuy():TBFile
     if( m_DealBuy.rec.DealID == 0 )
        if( GetDeal( m_DealBuy, m_RS.DealBuyID ) == false )
           MsgBox( "Не найдена сделка по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealBuyID)  );
           m_DealBuy.Clear();
        end;
     end;
     return m_DealBuy;
  END;

  MACRO LegSale():TBFile
    if( m_LegSale.rec.ID == 0 )
      if( FindDL_LEG( int(m_RS.LegKindSale), m_RS.DealSaleID, 0, m_LegSale )  )
        MsgBox( "Не найдены ценовые условия сделки по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealSaleID)  );
        m_LegSale.Clear();
      end;
    end;
    return m_LegSale;
  END;

  MACRO LegBuy():TBFile
    if( m_LegBuy.rec.ID == 0 )
      if( FindDL_LEG( int(m_RS.LegKindBuy), m_RS.DealBuyID, 0, m_LegBuy )  )
        MsgBox( "Не найдены ценовые условия сделки по лоту налогового учета DSCTXLOT_DBT.t_DealID = " + string(m_RS.DealBuyID)  );
        m_LegBuy.Clear();
      end;
    end;
    return m_LegBuy;
  END;

  MACRO SaleIsBack():BOOL
     return ( IsBUY( int(m_RS.DealSaleGroup) ) OR IsAVRWRTIN( int(m_RS.DealSaleGroup) ) );
  END;

  MACRO BuyIsBack():BOOL
     return ( IsSale( int(m_RS.DealBuyGroup) ) OR IsAVRWRTOUT( int(m_RS.DealBuyGroup) ) );
  END;

  MACRO Дн():DATE // максимальная из двух дат: (<H0.7>; <DDB>+1)
     return MAX( this.H0_7(), this.DDB()+1 );
  END;

  MACRO Дп():DATE // максимальная из двух дат: (Дк-1;<DDB>), 
     return MAX( this.Дк()-1, this.DDB() );
  END;

  MACRO NomS():MONEY // номинал облигации на дату <DDS>
     if( m_NomS == NULL )
        m_NomS = GetFaceValue( m_RS.t_FIID, this.DDS(), true, false );
     end;
     return m_NomS;
  END;

  MACRO NomB():DOUBLE // номинал облигации на дату <DDB>
     if( m_NomB == NULL )
        m_NomB = GetFaceValue( m_RS.t_FIID, this.DDB(), true, false );
     end;
     return m_NomB;
  END;

  MACRO IsDUDealB():INTEGER // Сдека ДУ
    if(GenPropID(m_RS, "IsDUDealB") != -1)
      return m_RS.IsDUDealB;
    end;
    return 0;
  END;

  MACRO IsDUDealS():INTEGER // Сдека ДУ
    if(GenPropID(m_RS, "IsDUDealS") != -1)
      return m_RS.IsDUDealS;
    end;
    return 0;
  END;

  MACRO ImportDUDate():DATE // Дата перехода права собств-ти при приобретении ЦБ для ДУ
    return SQL_ConvTypeDate(m_RS.ImportDUDate);
  END;

  MACRO NomBDU():DOUBLE // номинал облигации на дату <DDB> с учетом ДУ
    if( m_NomB == NULL )
      if (IsDUDealB() == 1)
        m_NomB = GetFaceValue( m_RS.t_FIID, this.ImportDUDate(), true, false );
      else
        m_NomB = GetFaceValue( m_RS.t_FIID, this.DDB(), true, false );
      end; 
    end;
    return m_NomB;
  END;

  MACRO Дк():DATE // дата начала купона, который начинается до <H0.7> включительно, а заканчивается после <H0.7>,
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Дк;
  END;

  MACRO ДкForPeriod( BegDate:date, EndDate:date ):DATE
     var CacheFinInstr = TX_CacheFinInstr();
     return CacheFinInstr.GetCouponParms(m_RS.FIID, BegDate, EndDate).m_Дк;
  END;

  MACRO Дк1():DATE //дата погашения купона, который гасится первым в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Дк1;
  END;

  MACRO Ск1():MONEY //сумма (в валюте номинала) купона, который гасится первым в период между <H0.7> и <H0.8> включительно 
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Ск1;
  END;

  MACRO Дк2():DATE //дата погашения купона, который гасится вторым в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Дк2;
  END;

  MACRO Ск2():MONEY // сумма (в валюте номинала) купона, который гасится вторым в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Ск2;
  END;

  MACRO Дк3():DATE // дата погашения купона, который гасится третьим в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Дк3;
  END;

  MACRO Ск3():MONEY // сумма (в валюте номинала) купона, который гасится третьим в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Ск3;
  END;

  MACRO Дк4():DATE // дата погашения купона, который гасится четвертым в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Дк4;
  END;

  MACRO Ск4():MONEY // сумма (в валюте номинала) купона, который гасится четвертым в период между <H0.7> и <H0.8> включительно
     return m_CacheFinInstr.GetCouponParms( m_RS.t_FIID, this.H0_7(), this.H0_8() ).m_Ск4;
  END;

  MACRO VprS():INTEGER
     return m_RS.VprS;
  END;

  MACRO VprB():INTEGER
     return m_RS.VprB;
  END;

  MACRO DN():DATE //Дата валютирования  в операции неттинга по ц/б
    return SQL_ConvTypeDate( m_RS.t_Date );
  END;
  
  MACRO CodeN():STRING //Код операции неттинга
    return m_RS.NettDealNumber;
  END;

  MACRO SecCode():STRING // Код ценной бумаги
     return m_RS.AvrCode;
  END;

  MACRO SecName():STRING // Выпуск ценной бумаги
     return m_RS.AvrName;
  END;

  MACRO ISIN():STRING // ISIN
     return m_RS.ISIN;
  END;

  MACRO CodeS():STRING // Номер сделки продажи
     if(IsDUDealS() == 1) return "DU_" + m_RS.DealSaleCodeTS;
     end;
     return m_RS.DealSaleCodeTS;
  END;

  MACRO DZS():DATE // Дата заключения сделки реализации ЦБ
     if( m_DZS == NULL )
       m_DZS = SQL_ConvTypeDate(m_RS.DealSaleDate);
     end;
     return m_DZS;
  END;

  MACRO DDS():DATE // Дата перехода права собств-ти при реализации ЦБ
     return SQL_ConvTypeDate(m_RS.SaleDate);
  END;

  MACRO Nom():MONEY // Номинал - сумма
    return m_CacheFinInstr.GetNominalOnIssued( m_RS.t_FIID ).m_Value;
  END;

  MACRO VN():STRING // Код валюты номинала (или  Номинал - валюта)
     if( m_CacheFinInstr.GetAvrKindRoot( m_RS.FIID ).m_AvrKindRoot == AVOIRISSKIND_DEPOSITORY_RECEIPT )
       return "";
     end;
     return m_CacheFinInstr.GetISO( m_RS.FaceValueFI ).m_Number;
  END;

  MACRO Dexp():DATE //  Дата погашения ц/б
     return SQL_ConvTypeDate( m_RS.t_DrawingDate );
  END;

  MACRO ExpiryDate():DATE // Дата закрытия ц/б
     return SQL_ConvTypeDate( m_RS.t_ExpiryDate );
  END;

  MACRO Dauc():DATE //  Дата размещения ц/б
     return SQL_ConvTypeDate( m_RS.t_Issued );
  END;

  MACRO PrAucNom():DOUBLE //  Цена размещения в % от номинала
     if( m_PrAucNom == NULL )
        /*10 - Цена первичного размещения*/
        if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
          m_PrAucNom = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( Int(m_RS.t_FIID), 10 ), 10 );//m_RS.FIID может иметь тип double, поэтому приведем к Int (SCR198249)
          if( m_PrAucNom <= 0 )
             MsgBox( "Для ц/б \"" + m_RS.AvrCode + "\" не задано примечание \"" + ИмяПримечания( OBJTYPE_AVOIRISS, 10 ) );
             m_PrAucNom = 0.0;
          end;
        end;
     end;
     return m_PrAucNom;
  END;

  MACRO QntyPrecision():INTEGER //  точность кол-ва
     return m_RS.t_SumPrecision;
  END;

  MACRO Qnty():DOUBLE //  Количество проданных бумаг, шт.
     /*bug WinRep: точность денег всегда 2? приходится через double ...*/
     return double(m_RS.t_Amount);
  END;

  MACRO VPrSNumber():STRING //  Код валюты цены реализации
     return m_CacheFinInstr.GetISO( this.VprS() ).m_Number;
  END;

  MACRO PrSvp():DOUBLE // Цена реализации - в валюте
     if(IsDUDealS() == 1) return 0.0;
     end;
     return m_RS.SalePrice;
  END;

  MACRO PrSvn():DOUBLE // Цена реализации - в валюте номинала
     if( m_PrSvn == null )
        if(this.VprS() == m_RS.FaceValueFI)
          m_PrSvn = m_RS.SalePrice;
        else
          m_PrSvn = this.SumSvn() / this.Qnty();
        end;
     end;     
     return m_PrSvn;
  END;

  MACRO PrSrub():DOUBLE //  Цена реализации - в рублях
     if(this.VprS() == NATCUR)
       return m_RS.SalePrice;
     end;
     return this.SumSrub()/Qnty();
  END;

  MACRO DealSalePrice():DOUBLE
    return m_RS.DealSalePrice;
  END;

  MACRO PrSNom():DOUBLE //  Цена реализации, % от номинала (из сделки)
     if( m_PrSNom == NULL )
       if(IsDUDealS() == 1) m_PrSNom = 0.0;
       else m_PrSNom = this.DealSalePrice();
       end;
     end;
     return m_PrSNom;
  END;

  MACRO SumSmain():MONEY
    return m_RS.SDealCost;
  END;

  MACRO SumSvp():MONEY //  Стоимость реализации - в валюте 
     if( m_SumSvp == NULL )
       if(IsDUDealS() == 1) m_SumSvp = $0.0;
       else m_SumSvp = this.SumSmain()*this.Qnty()/m_RS.SaleAmount;
       end;
     end;
     return m_SumSvp;
  END;

  macro FI_IsAvrKindBond_AD(FIID)
      var Query;
      var select = RSDCommand("select count(1) amount " +
                   " from  dfiwarnts_dbt " +
                   "where  t_FIID = ? "  +
                   "  and  t_IsPartial = 'X'");

      select.addParam( "", RSDBP_IN, FIID );
      select.execute();

      Query = TRsbDataSet(select);
      if( Query.MoveNext() )
          if( Query.amount > 0 )
              return true;
          end;
      end;
      return false;
  end;

  MACRO SumSvn():MONEY //  Стоимость реализации - в валюте номинала
     if( m_SumSvn == NULL )

        if(m_RS.FaceValueFI == this.VprS())
          m_SumSvn = this.SumSvp();
        elif(this.VprS() == NATCUR) //валюта цены рубли, а валюта номинала не рубли
          m_SumSvn = this.SumSvp()/this.CrSD();
        elif(m_RS.FaceValueFI == NATCUR) //валюта номинала рубли, а валюта цены не рубли
          m_SumSvn = this.SumSvp()*this.CrSD();
        else 
          m_SumSvn = this.SumSvp()/this.CrSP();
        end;
     end;
     return m_SumSvn;
  END;


  MACRO SumSrub():MONEY // Стоимость реализации - в рублях
     if( m_SumSrub == NULL )
       if( this.VprS() != NATCUR )
          m_SumSrub = this.SumSvp()*this.CrSD();
       else
          m_SumSrub = this.SumSvp();
       end;
     end;
     return m_SumSrub;
  END;

  MACRO NKDSale()
    return m_RS.NKDSale;
  END;

  MACRO NkdSvn():MONEY //  НКД полученный при реализации (погашении)
     var Query, DataSet, MaxDate;
     var MaxCoupDate;

     if( m_NkdSvn == NULL )
        if( IsRET_ISSUE(int(m_RS.DealSaleGroup)) )
          //определим дату последнего купона
          MaxCoupDate = GetMaxCouponDrawingDateInPeriod(m_RS.t_FIID, date(1,1,2), date(1,1,9999));
          m_NkdSvn = GetCouponSumByPeriod( m_RS.FIID, this.Qnty(), SQL_ConvTypeDate(MaxCoupDate), SQL_ConvTypeDate(MaxCoupDate));
        else
          if(m_RS.FaceValueFI == this.VprS())
            m_NkdSvn = this.NKDSale()*this.Qnty()/m_RS.SaleAmount;
          else
            m_NkdSvn = this.NKDSale()*this.Qnty()/(m_RS.SaleAmount*this.CrSD());
          end;
        end;
     end;
     return m_NkdSvn;
  END;

  MACRO NkdSvp():MONEY //  НКД полученный при реализации (погашении), в валюте сделки
     return this.NKDSale()*this.Qnty()/m_RS.SaleAmount;
  END;

  MACRO NkdSrub():MONEY // НКД полученный при реализации (погашении) - Сумма, руб.
      return NkdSvn() * this.CrSD();
  END;

  MACRO Tprev():INTEGER // Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - Период, дней
     if( iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()) < this.H0_7() )
        return this.H0_7() - 1 - this.Дп();
     end;
     return 0;
  END;

  MACRO NkdPrevVN():MONEY // Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода  :
     if( m_NkdPrevVN == NULL )
        if( this.DDB() < this.H0_7() )
          if( (this.Дк() == ZeroDate) or ((this.Дк()-1) > this.DDB()) )
            m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), this.H0_7()-1);
          else
            m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), this.H0_7()-1) - this.NkdBvn();
          end;
        else
           m_NkdPrevVN = $0;
        end;
     end;
     return m_NkdPrevVN;
  END;

  MACRO NkdPrevVNForPeriod( BegDate:date, EndDate:date ):MONEY
     var RetVal:money = $0.0;

     if( this.DDB() < BegDate )
        var _Дк = this.ДкForPeriod(BegDate, EndDate);
        if( (_Дк == ZeroDate) or ((_Дк-1) > this.DDB()) )
           RetVal = НКД(m_RS.t_FIID, this.Qnty(), BegDate-1);
        else
           RetVal = НКД(m_RS.t_FIID, this.Qnty(), BegDate-1) - this.NkdBvn();
        end;
     else
        RetVal = $0;
     end;

     return RetVal;
  END;

  MACRO NkdPrevRub():MONEY //  Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - Сумма, руб
     if( m_NkdPrevRub == NULL )
        SmartConvertSum( m_NkdPrevRub, this.NkdPrevVN(), this.H0_7()-1, m_RS.FaceValueFI, NATCUR, true );
     end;
     return m_NkdPrevRub;
  END;

  MACRO NkdPrevRubForPeriod( BegDate:date, EndDate:date ):MONEY
     var RetVal:money = $0.0;
     SmartConvertSum(RetVal, this.NkdPrevVNForPeriod(BegDate, EndDate), BegDate-1, m_RS.FaceValueFI, NATCUR, true);
     return RetVal;
  END;

  MACRO GetMaxDrDateCouponOnDate( FIID, onDate )
     var select, fiwarnt;
     select = RSDCommand("select max(t_DrawingDate) as DrawingDate from dfiwarnts_dbt " +
                         " where t_fiid = ? " +
                           " and t_IsPartial != 'X' " +
                           " and t_DrawingDate <= ?" +
                           " and ( (t_IncomeRate > 0 AND t_relativeincome = CHR(88)) or (t_IncomeVolume > 0 AND t_relativeincome <> CHR(88)) ) " +
                           " and " + IIF(CheckTaxDepositoryMode() == false, " t_SpIsClosed = 'X' ", " t_IsClosed = 'X' ")
                        );

     select.addParam("", RSDBP_IN, FIID);
     select.addParam("", RSDBP_IN, onDate);
     select.execute();

     fiwarnt = TRsbDataSet(select);

     if( fiwarnt.MoveNext() )
        if( fiwarnt.DrawingDate != null )
           return Date(fiwarnt.DrawingDate);
        end;
     end;

     return ZeroDate;
  END;

  MACRO IssueDrawingDate()
     return date(m_RS.IssDrawingDate);
  END;

  MACRO ExcludeDateCouponPeriod()
     if( m_ExcludeDateCouponPeriod == NULL )
        if((this.ExpiryDate() == ZeroDate) and (IssueDrawingDate == ZeroDate))
           m_ExcludeDateCouponPeriod = this.GetDrawingDate();
        else
           m_ExcludeDateCouponPeriod = GetMaxDrDateCouponOnDate(m_RS.FIID, this.GetDrawingDate());
        end;
     end;
     return m_ExcludeDateCouponPeriod;
  END;

  MACRO FirstCouponWithOperStat(FIID, DataBegin, DateEnd)
    var CouponNumber = 0;
    var cmd, rsd;
    var DealDate;

    cmd = RSDCommand(
        " SELECT warnt.t_DrawingDate as DrawingDate, "
      + "        warnt.t_Number "
      + "   FROM dfiwarnts_dbt warnt"
      + "  WHERE warnt.t_FIID = ? and "
      + "        warnt.t_IsPartial = chr(0) and "
      + "        warnt.t_DrawingDate <= ? and "
      + "        warnt.t_DrawingDate >= ? "
      + " ORDER BY warnt.t_DrawingDate ASC "
                  );

    cmd.addParam( "", RSDBP_IN, FIID );
    cmd.addParam( "", RSDBP_IN, DateEnd );
    cmd.addParam( "", RSDBP_IN, DataBegin );

    cmd.execute(); 
    rsd = TRsbDataSet(cmd);
    if(rsd.MoveNext())
      CouponNumber = rsd.Number;

      cmd = RSDCommand(
          " SELECT tik.t_DealDate "
        + "  FROM ddl_tick_dbt tik "
        + "  WHERE tik.t_DealType in (2022,12022,12021) "
        + "    AND tik.t_BofficeKind = 117 "
        + "    AND tik.t_PFI = ? "
        + "    AND tik.t_Number_Coupon = ? "
        + "    AND tik.t_dealstatus = 20 " 
        + "    AND EXISTS (SELECT t_FactDate "
        + "                  FROM ddlrq_dbt  "
        + "                 WHERE tik.t_DealID = t_DocID  "
        + "                   AND t_DocKind = 117 "
        + "                   AND t_Type= 2 "
        + "                   AND t_State = 2 "
        + "                   AND t_DealPart = 1 "
        + "                   AND t_FactDate > TO_DATE('01.01.0001','DD.MM.YYYY') ) "
                          ); 

      cmd.addParam( "", RSDBP_IN, FIID );
      cmd.addParam( "", RSDBP_IN, CouponNumber );

      cmd.execute(); 
      rsd = TRsbDataSet(cmd);
      if (rsd.MoveNext())
        DealDate = SQL_ConvTypeDate(rsd.DealDate);
      end;
    end;

    return DealDate;
  END;

 MACRO HasCouponWithNoOper(FIID, DataBegin, DateEnd)
    var cmd, rsd;

    cmd = RSDCommand(
        " SELECT warnt.t_DrawingDate as DrawingDate, "
      + "        warnt.t_Number "
      + "   FROM dfiwarnts_dbt warnt"
      + "  WHERE warnt.t_FIID = ? and "
      + "        warnt.t_IsPartial = chr(0) and "
      + "        warnt.t_DrawingDate <= ? and "
      + "        warnt.t_DrawingDate >= ? and "
      + "       (SELECT count(1) "
      + "            FROM ddl_tick_dbt tik "
      + "           WHERE tik.t_DealType in (2022,12022, 12021)  "
      + "             AND tik.t_BofficeKind = 117  "
      + "             AND tik.t_PFI = warnt.t_FIID "
      + "             AND tik.t_Number_Coupon = warnt.t_Number "
      + "             AND tik.t_dealstatus = 20 "
      + "             AND EXISTS (SELECT t_FactDate  "
      + "                    FROM ddlrq_dbt   "
      + "                   WHERE tik.t_DealID = t_DocID  " 
      + "                     AND t_DocKind = 117  "
      + "                     AND t_Type= 2  "
      + "                     AND t_State = 2  "
      + "                     AND t_DealPart = 1  "
      + "                     AND t_FactDate > TO_DATE('01.01.0001','DD.MM.YYYY')) ) = 0 "
      + " ORDER BY warnt.t_DrawingDate ASC "
                  );

    cmd.addParam( "", RSDBP_IN, FIID );
    cmd.addParam( "", RSDBP_IN, DateEnd );
    cmd.addParam( "", RSDBP_IN, DataBegin );

    cmd.execute(); 
    rsd = TRsbDataSet(cmd);
    if(rsd.MoveNext())
      return true;
    end;

    return false;
  END;

  MACRO CoupVN():MONEY //  Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде (кроме купона, полученного при погашении бумаги) :
     if( m_CoupVN == NULL )
        m_CoupVN = GetCouponSumByPeriod( m_RS.FIID, this.Qnty(), this.Дн(), this.DDS(), null, ExcludeDateCouponPeriod(), NULL, true );
     end;
     return m_CoupVN;
  END;

  MACRO CoupVNForPeriod( BegDate:date, EndDate:date ):MONEY
     if( m_CoupVN == NULL )
        m_CoupVN = GetCouponSumByPeriod(m_RS.FIID, this.Qnty(), BegDate, EndDate, null, this.GetDrawingDate());
     end;
     return m_CoupVN;
  END;

  MACRO CoupRub():MONEY // Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде (кроме купона, полученного при погашении бумаги) - сумма, руб
     if( m_CoupRub == NULL )
        m_CoupRub = GetCouponSumByPeriod_Rub( m_RS.FIID, this.Qnty(), this.Дн(), this.DDS(), m_RS.FaceValueFI, null, ExcludeDateCouponPeriod(), NULL, NULL, true );
     end;
     return m_CoupRub;
  END;

  MACRO AmortVN():MONEY // Доходы, полученные при частичном погашении номинала :
     if( m_AmortVN == NULL )
        m_AmortVN = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), this.DDB()+1, this.DDS(), null, this.GetDrawingDate() );
     end;
     return m_AmortVN;
  END;

  MACRO AmortRub():MONEY //  Доходы, полученные при частичном погашении номинала- сумма, руб
     if( m_AmortRub == NULL )
        m_AmortRub = GetPartialSumByPeriod_Rub( m_RS.FIID, this.Qnty(), this.DDB()+1, this.DDS(), null, this.GetDrawingDate() );
     end;
     return m_AmortRub;
  END;

  MACRO NkdBefVN():MONEY //  Процентный доход, за период с даты приобретения до даты начала отчетного периода: 
     if( m_NkdBefVN == NULL )
        if( this.DDB() < this.H0_7() )
           if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
              m_NkdBefVN = this.Qnty()*this.Nom()*(1-0.01*this.PrAucNom())*(this.H0_7() - 1 - iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())) 
                            / (this.Dexp()-this.Dauc() );
           else
              m_NkdBefVN = this.Qnty()*this.Nom()*(1-0.01*this.PrBNom())*(this.H0_7()-1-iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB())) 
                            / (this.Dexp()-iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()));
           end;
        else
           m_NkdBefVN = 0;
        end;
     end;
     return m_NkdBefVN;
  END;

  MACRO NkdBefRub():MONEY // Процентный доход, за период с даты приобретения до даты начала отчетного периода - в рублях
     VAR NkdRUR = $0;
     SmartConvertSum( NkdRUR, this.NkdBefVn(), this.H0_7()-1, m_RS.FaceValueFI, NATCUR, true );
     return NkdRUR;
  END;

  MACRO NKDownVN():MONEY //  Процентный доход за период с даты приобретения по дату реализации :

     if( m_NKDownVN == NULL )
        if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
           m_NKDownVN = this.Qnty()*this.Nom()* (1-0.01*this.PrAucNom())* (this.DDS()-this.DDB()) / (this.Dexp()-this.Dauc());
        else
           m_NKDownVN = $0;
        end;
     end;
     return m_NKDownVN;
  END;

  MACRO IncRub():MONEY //  Доходы от реализации (погашения) для целей налогообложения, руб
     VAR Summa = $0;

     if( ЛьготнаяОблигация( m_RS.TaxGroupType ) )
        Summa = this.SumSRub()-this.NkdOwnVN();
     else
        Summa = this.SumSRub();
     end;
     return Summa;
  END;

  MACRO MinMrkt():double// Минимальная цена на дату заключения на ОРЦБ, расчетная цена для ЦБ не обращ. на ОРЦБ (уменьшенная на 20%)
    if(IsDUDealS() == 1) return 0.0;
    end;
    return m_RS.SaleMarketPrice;
  END;

  MACRO MrktS():STRING // Минимальная цена на дату заключения на ОРЦБ, расчетная цена для ЦБ не обращ. на ОРЦБ (уменьшенная на 20%) - источник информации 
    if(IsDUDealS() == 1) return "";
    end;
    return SQL_ConvTypeStr( m_RS.SaleMarket );
  END;

  MACRO DMrktS():DATE //  Минимальная цена на дату заключения договора, сложивш. на ОРЦБ, расчетная цена для ЦБ не обращ. на ОРЦБ (уменьшенная на 20%)- Дата котировки
    if(IsDUDealS() == 1) return NULL;
    end;
    return SQL_ConvTypeDate(m_RS.SaleDateMarket);
  END;

  MACRO DifS():MONEY //  Сумма отклонения фактической выручки ниже рыночной (расчетной) цены
     var PrDealS = 0.0;
     var VNRate = 0.0;
     var NumInList;

     if(m_DifS == NULL)
       if(this.MrktS() == "факт")
         m_DifS = 0.0;
       elif(   ( GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID( DealSale(), OBJTYPE_SECDEAL), 24, null, null, NumInList) )
        AND (NumInList == "1") /*1 - техническая сделка*/
       )
        m_DifS = 0.0;
       else
         if(this.IsBond())
           PrDealS = this.DealSalePrice();
         else
           if(m_RS.FaceValueFI == this.VprS())
             PrDealS = this.DealSalePrice();
           else
             VNRate = this.CrDZS();
             if((ValType(VNRate) != V_UNDEF) and (VNRate != 0.0))
               PrDealS = this.SumSmain() * GetRateOnDateCrossDbl(  this.DZS(), this.VprS(), NATCUR, true ) / ( m_RS.SaleAmount* VNRate);
             end;
           end;
         end;

         if(PrDealS >= this.MinMrkt())
           m_DifS = 0.0;
         else
           m_DifS = (this.MinMrkt()-PrDealS)*this.Qnty()*this.KNS()*this.CVS();
         end; 
       end;
     end;
     return m_DifS;
  END;

  MACRO ComS():MONEY //  Комиссия, уплаченная при реализации
     if( m_ComS == NULL )
        m_ComS = m_RS.CommSale * (this.Qnty()/m_RS.SaleAmount);
     end;
     return m_ComS;
  END;

  MACRO DZB():DATE // Дата заключения договора на приобретение ЦБ
     if( m_DZB == NULL )
       m_DZB = SQL_ConvTypeDate(m_RS.DealBuyDate);
     end;
     return m_DZB;
  END;

  MACRO CodeB():STRING // Номер сделки покупки
    return m_RS.DealBuyCodeTS;
  END;

  MACRO VPrBNumber():STRING //  Валюта цены приобретения
     return m_CacheFinInstr.GetISO( this.VprB() ).m_Number;
  END;

  MACRO PrBvp():DOUBLE // Цена приобретения - в валюте
     return m_RS.BuyPrice;
  END;

  MACRO PrBVN():DOUBLE // Цена приобретения - в валюте
     if( m_PrBVN == NULL )
       if(this.VprB() == m_RS.FaceValueFI)
         m_PrBVN = m_RS.BuyPrice;
       else
         m_PrBVN = this.SumBvn()/Qnty();
       end;
     end;               
     return m_PrBVN;    
  END;                  

  MACRO PrBrub():DOUBLE //  Цена приобретения - в рублях
     if(this.VprB() == NATCUR)
       return m_RS.BuyPrice;
     end;
     return this.SumBrub()/Qnty();
  END;

  MACRO DealBuyPrice():DOUBLE
    return m_RS.DealBuyPrice;
  END;

  MACRO PrBNom():DOUBLE //  Цена приобретения, % от номинала
     if( m_PrBNom == NULL )
       m_PrBNom = this.DealBuyPrice();
     end;
     return m_PrBNom;
  END;

  MACRO SumBmain():MONEY
    if( (m_TemplateName != "Report_TaxPortOnDate.xls") and (IsDUDealB() == 1) ) //Ошибка доработок по DEF-66875. В отчёте "Налоговый портфель на дату" невозможно расчитать NomS
      return (this.NomS()/m_RS.BuyAmount*this.Qnty());
    end;
    return m_RS.BDealCost;
  END;

  MACRO SumBvp():MONEY //  Стоимость приобретения - в валюте цены
     if( m_SumBvp == NULL )
        if( (m_RS.BuyAmount != 0) AND (IsDUDealS() != 1) )
          m_SumBvp = this.SumBmain()/m_RS.BuyAmount*this.Qnty();
        else
          m_SumBvp = $0.0;
        end;
     end;
     return m_SumBvp;
  END;

  MACRO SumBvn():MONEY //  Стоимость приобретения - в валюте номинала
     if( m_SumBvn == NULL )

        if(m_RS.FaceValueFI == this.VprB())
          m_SumBvn = this.SumBvp();
        elif(this.VprB() == NATCUR) //валюта цены рубли, а валюта номинала не рубли
          m_SumBvn = this.SumBvp()/this.CrBD();
        elif(m_RS.FaceValueFI == NATCUR) //валюта номинала рубли, а валюта цены не рубли
          m_SumBvn = this.SumBvp()*this.CrBD();
        else 
          m_SumBvn = this.SumBvp()/this.CrBP();
        end;
     end;
     return m_SumBvn;
  END;

  MACRO SumBrub():MONEY // Стоимость приобретения - в рублях
     if( m_SumBrub == NULL )
        if(this.VprB() == NATCUR)
          m_SumBrub = this.SumBvp();
        else
          m_SumBrub = this.SumBvp()*this.CrBD();
        end;
     end;
     return m_SumBrub
  END;

  MACRO NKDBuy()
    return m_RS.NKDBuy();
  END;

  MACRO NkdBvn():MONEY //  НКД уплаченный при приобретении - сумма в валюте номинала
     if( m_NkdBvn == NULL )
        if(m_RS.FaceValueFI == this.VprB())
          m_NkdBvn = this.NKDBuy()*this.Qnty()/m_RS.BuyAmount;
        else
          m_NkdBvn = this.NKDBuy()*this.Qnty()/(m_RS.BuyAmount*this.CrBD());
        end;
     end;
     return m_NkdBvn;
  END;

  MACRO NkdBrub():MONEY // НКД уплаченный при приобретении - сумма, руб.
     return this.NkdBvn() * this.CrBD();
  END;

  MACRO DDB():DATE // Дата перехода права собств-ти при приобретении ЦБ
     return SQL_ConvTypeDate(m_RS.BuyDate);
  END;

  MACRO MaxMrkt():DOUBLE// Максимальная цена на дату заключения на ОРЦБ; расчетная цена для ЦБ не обращ. на ОРЦБ (расч. цена ЦБ, приобр.по срочн. сделке), увелич. на 20%-Цена
    if(IsDUDealS() == 1) return 0.0;
    end;
    return m_RS.BuyMarketPrice;
  END;

  MACRO ValB():INTEGER  //валюта цены
    return m_RS.ValB;
  END;

  MACRO ValBNumber():STRING  //валюта цены (код)
      return m_CacheFinInstr.GetISO( this.ValB() ).m_Number;
  END;

  MACRO VpB():INTEGER //валюта расчетов
    return m_RS.VpB;      
  END;

  MACRO VpBNumber():STRING //валюта расчетов (код)
    return m_CacheFinInstr.GetISO( this.VpB() ).m_Number;      
  END;

  MACRO KZB():DOUBLE
    var Rate = 0;
    var m_KZB = 0;
    if(m_RS.TypeBO == 0)
      Rate = GetRateOnDateCrossDbl( this.DZB(), m_RS.FaceValueFI, NATCUR, true );
      if((ValType(Rate) != V_UNDEF) AND (Rate != 0.0))
        m_KZB = GetRateOnDateCrossDbl( this.DZB(), this.ValB(), NATCUR, true )/Rate;
      else
        m_KZB = 0.0;
      end;
    end;

    if((m_KZB == NULL) or (m_KZB == 0.0))
      m_KZB = NULL;
      return 1.0;
    end;

    return m_KZB;
  END;

  MACRO MainBvp(IsMaterial):MONEY
    if(m_MainBvp == NULL)
      if(m_RS.TypeBO == 0)
        DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_MAIN), NULL, this.H0_2(), TXOBJ_DIR_ALL, @m_MainBvp, @m_MainBrub, null, m_Rs.Investor, NULL, true);
      else
        m_MainBvp = IIF(this.IsForward(), this.PrBvp()*abs(this.Qnty(IsMaterial)), this.PrBvp());
      end;
    end;
    return m_MainBvp;
  END;

  MACRO MainBrub(IsMaterial):MONEY
    if(m_MainBrub == NULL)
      if(m_RS.TypeBO == 0)
        DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_MAIN), NULL, m_EndDate, TXOBJ_DIR_ALL, @m_MainBvp, @m_MainBrub, null, m_Rs.Investor, NULL, true);
      else
        m_MainBrub = IIF(this.IsForward(), this.PrBvp()*abs(this.Qnty(IsMaterial)), this.PrBvp());
        DV_SmartConvertSumDbl( m_MainBrub, m_MainBrub, FD.ДатаСделки(), this.ValB() , NATCUR, true );
      end;
    end;
    return m_MainBrub;
  END;

  MACRO bMrktB():STRING
     var bMrktB_str = "";
     if(m_RS.TypeBO == 0)
       bMrktB_str = IIF(m_RS.IfMarket == SET_CHAR,"да","нет");
     else
       bMrktB_str = "не обращается";
     end;
     return bMrktB_str;
  END;

  MACRO PriceMrktB():STRING
    return string(m_RS.MinMarketPrice);
  END;

  MACRO IsForward():BOOL
     return (m_RS.T_DVKIND == DV_FORWARD);
  END;

  MACRO MrktB(IsLucre):STRING // Максимальная цена на дату заключения на ОРЦБ; расчетная цена для ЦБ не обращ. на ОРЦБ (расч. цена ЦБ, приобр.по срочн. сделке), увелич. на 20% - источник информации
     if(IsLucre == NULL)
        IsLucre = false;
     end;

     if(IsDUDealS() == 1) return "";
     end;

     if(IsLucre)
        var MrktB_str = "";
        MrktB_str = IIF(m_RS.MinMarketPrice>0.,m_RS.Market,"");
        return MrktB_str;
     else
        return SQL_ConvTypeStr( m_RS.BuyMarket );
     end;
  END;

  MACRO DMrktB(IsLucre):string //  Максимальная цена на дату заключения договора, сложивш. на ОРЦБ; расчетная цена для ЦБ не обращ. на ОРЦБ (расч. цена ЦБ, приобр.по срочн. сделке), увелич. на 20% - Дата котировки
     if(IsLucre == NULL)
        IsLucre = false;
     end;

     var _DMrktB;

     if(IsDUDealS() == 1) return "";
     end;

     if(IsLucre)
        _DMrktB = IIF(m_RS.MinMarketPrice>0.,SQL_ConvType(m_RS.DateMarket),"");
     else
        _DMrktB = SQL_ConvTypeDate(m_RS.BuyDateMarket);
     end;

     return string(_DMrktB:f);
  END;

  MACRO DifB():MONEY //  Превышение стоимости приобретения над максимальной рыночной (расчетной, увеличен. на 20%)
     var PrDealB = 0.0;
     var VNRate = 0.0;
     var NumInList;

     if(m_DifB == NULL)
       if(this.MrktB() == "факт")
         m_DifB = 0.0;
       elif( ( GetMainObjAttr( null, OBJTYPE_SECDEAL, UniID( DealBuy(), OBJTYPE_SECDEAL), 24, null, null, NumInList) )
        AND (NumInList == "1") /*1 - техническая сделка*/
       )
        m_DifB = 0.0;
       else
         if(this.IsBond())
           PrDealB = this.DealBuyPrice();
         else
           if(m_RS.FaceValueFI == this.VprB())
             PrDealB = this.DealBuyPrice();
           else
             VNRate = this.CrDZB();
             if((ValType(VNRate) != V_UNDEF) and (VNRate != 0.0))
               PrDealB = this.SumBmain() * GetRateOnDateCrossDbl(  this.DZB(), this.VprB(), NATCUR, true ) / ( m_RS.BuyAmount* VNRate);
             end;
           end;
         end;

         if(PrDealB <= this.MaxMrkt())
           m_DifB = 0.0;
         else
           m_DifB = (PrDealB-this.MaxMrkt())*this.Qnty()*this.KNB()*this.CVB();
         end; 
       end;
     end;
     return m_DifB;
  END;

  MACRO SumBtax():MONEY // Cтоимость приобретенных ценных бумаг, принимаемая для целей налогообложения
     return this.SumBrub()-this.DifB();
  END;

  MACRO ComB():MONEY //Комиссия, уплаченная при приобретении  
     if( m_ComB == NULL )
        m_ComB = m_RS.CommBuy*Qnty()/m_RS.BuyAmount;
     end;
     return m_ComB;
  END;

  MACRO IsBond()
     return (m_CacheFinInstr.GetAvrKindRoot( m_RS.FIID ).m_AvrKindRoot == AVOIRISSKIND_BOND);
  END;

  MACRO CrSZ():DOUBLE //  Курс ЦБ РФ на дату заключения договора на реализацию
     if( m_CrSZ == NULL )
        if((m_RS.FaceValueFI == NATCUR) and this.IsBond())
          m_CrSZ = GetRateOnDateCrossDbl( this.DZS(), this.VprS(), NATCUR, true );
        elif((m_RS.FaceValueFI != NATCUR) and this.IsBond())
          m_CrSZ = this.CrDZS();
        else
          m_CrSZ = GetRateOnDateCrossDbl( this.DZS(), this.VprS(), NATCUR, true );
        end;
     end;

     if((m_CrSZ == NULL) or (m_CrSZ == 0.0))
       m_CrSZ = NULL;
       return 1.0;
     end;

     return m_CrSZ;
  END;
  
  MACRO printCrSZ():DOUBLE
    this.CrSZ();
    return m_CrSZ;
  END;

  MACRO CrBZ():DOUBLE //  Курс ЦБ РФ на дату заключения договора на приобретение
     if( m_CrBZ == NULL )
        if((m_RS.FaceValueFI == NATCUR) and this.IsBond())
          m_CrBZ = GetRateOnDateCrossDbl( this.DZB(), this.VprB(), NATCUR, true );
        elif((m_RS.FaceValueFI != NATCUR) and this.IsBond())
          m_CrBZ = this.CrDZB();
        else
          m_CrBZ = GetRateOnDateCrossDbl( this.DZB(), this.VprB(), NATCUR, true );
        end;
     end;

     if((m_CrBZ == NULL) or (m_CrBZ == 0.0))
       m_CrBZ = NULL;
       return 1.0;
     end;

     return m_CrBZ;
  END;

  MACRO printCrBZ():DOUBLE
     this.CrBZ();
     return m_CrBZ;
  END;

  MACRO CrSD():DOUBLE //  Курс пересчета цены/ст-ти реализации в рублевый эквивалент 
    if(m_CrSD == NULL)
      if( this.VprS() == NATCUR)
        if(m_RS.FaceValueFI == NATCUR)
          m_CrSD = 1;
        else
          m_CrSD = this.CrDDS();
        end;
      else
        if(m_RS.FaceValueFI == NATCUR)
          m_CrSD = ПолучитьКурсПостановкиНаБаланс( DealSale() );
        else
          m_CrSD = GetRateOnDateCrossDbl( this.DDS(), this.VprS(), NATCUR, true );
        end;
      end;
    end;

    if((m_CrSD == NULL) or (m_CrSD == 0.0))
      m_CrSD = NULL;
      return 1.0;
    end;

    return m_CrSD;
  END;

  MACRO printCrSD():DOUBLE
    this.CrSD();
    return m_CrSD;
  END;

  MACRO CrBD(IsLucre):DOUBLE //  Курс пересчета цены/ст-ти приобретения в рублевый эквивалент Для подвида 0204; 0205;0206:Курс ЦБ РФ на дату приобретения
    if(IsLucre == NULL)
      IsLucre = false;
    end;

    if(m_CrBD == NULL)
      if(IsLucre)
        
      else
        if( this.VprB() == NATCUR)
          if(m_RS.FaceValueFI == NATCUR)
            m_CrBD = 1;
          else
            m_CrBD = GetRateOnDateCrossDbl( this.DBV(), m_RS.FaceValueFI, NATCUR, true );
          end;
        else
          if(m_RS.FaceValueFI == NATCUR)
            m_CrBD = ПолучитьКурсПостановкиНаБаланс( DealBuy() );
          else
            m_CrBD = GetRateOnDateCrossDbl( this.DBV(), this.VprB(), NATCUR, true );
          end;
        end;
      end;
    end;

    if((m_CrBD == NULL) or (m_CrBD == 0.0))
      m_CrBD = NULL;
      return 1.0;
    end;

    return m_CrBD;
  END;

  MACRO CrDDS()
     if(m_CrDDS == null)
        m_CrDDS = GetRateOnDateCrossDbl(this.DDS(), m_RS.FaceValueFI, NATCUR, true);
     end;
     return m_CrDDS;
  END;

  MACRO CrDDB()
     if(m_CrDDB == null)
        m_CrDDB = GetRateOnDateCrossDbl(this.DDB(), m_RS.FaceValueFI, NATCUR, true);
     end;
     return m_CrDDB;
  END;

  MACRO CrDZS()
     if(m_CrDZS == null)
        m_CrDZS = GetRateOnDateCrossDbl( this.DZS(), m_RS.FaceValueFI, NATCUR, true )
     end;
     return m_CrDZS;
  END;

  MACRO CrDZB()
     if(m_CrDZB == null)
        m_CrDZB = GetRateOnDateCrossDbl( this.DZB(), m_RS.FaceValueFI, NATCUR, true )
     end;
     return m_CrDZB;
  END;

  MACRO DBV():DATE
    return this.DDB();
  END;

  MACRO printCrBD():DOUBLE
    this.CrBD();
    return m_CrBD;
  END;

  MACRO ifCoupPrev():INTEGER //  Отметка о наличии выплат купона от эмитента до начала налогового периода (1 - да, 0 - нет)
     if( m_ifCoupPrev == NULL )
        m_ifCoupPrev = 0;
        if( (m_RS.IfCoupPrev > 0) and this.IsBond() )
           m_ifCoupPrev = 1;
        end;
     end;
     return m_ifCoupPrev;
  END;

  MACRO CVN1():MONEY//  1 купон в отчетном периоде
     if( (this.Дн()  <= this.Дк1() ) and 
         (this.Дк1() <= this.DDS() ) 
       )
        return this.Qnty()*this.Ск1();
     end;
     return 0;
  END;

  MACRO CVN2():MONEY //  2 купон в отчетном периоде
     if( (this.Дн()  <= this.Дк2() ) and 
         (this.Дк2() <= this.DDS() ) 
       )
        return this.Qnty()*this.Ск2();
     end;
     return 0;
  END;

  MACRO CVN3():MONEY //  3 купон в отчетном периоде
     if( (this.Дн()  <= this.Дк3() ) and 
         (this.Дк3() <= this.DDS() ) 
       )
        return this.Qnty()*this.Ск3();
     end;
     return 0;
  END;

  MACRO CVN4():MONEY //  4 купон в отчетном периоде
     if( (this.Дн()  <= this.Дк4() ) and 
         (this.Дк4() <= this.DDS() ) 
       )
        return this.Qnty()*this.Ск4();
     end;
     return 0;
  END;
  

  MACRO SellType():INTEGER //Если <CodeS>- погашение, то <SellType>=1, в противном случае -<SellType>= 0
     if( m_SellType == NULL )

        if( IsRET_ISSUE(int(m_RS.DealSaleGroup)) )
           m_SellType = 1;
        else
           m_SellType = 0;
        end;                  
     end;
     return m_SellType;
  END;

  MACRO ContS():STRING // Контрагент по сделке реализации 
     return m_RS.PartyNameSale;
  END;

  MACRO ContB():STRING // Контрагент по сделке приобретения
     return m_RS.PartyNameBuy;
  END;

  MACRO PrefS():STRING // Номер сделки реализации - без послед. 3-х знаков
     return GetNumbersDeal( m_RS.DealSaleCodeTS, false, 3);
  END;

  MACRO SufS():STRING //  Номер сделки реализации - 3 послед. знака
     return GetNumbersDeal( m_RS.DealSaleCodeTS, true, 3);
  END;

  MACRO FilS():STRING //  Номер сделки реализации - ГО/филиал
     return T_Dep.Get_Dep(m_RS.DealSaleDepartment);
  END;

  MACRO PrefB():STRING // Номер сделки приобретения - без послед. 3-х знаков
     return GetNumbersDeal( m_RS.DealBuyCodeTS, false, 3);
  END;

  MACRO SufB():STRING //  Номер сделки приобретения - 3 послед. знака
     return GetNumbersDeal( m_RS.DealBuyCodeTS, true, 3);
  END;

  MACRO FilB():STRING //  Номер сделки приобретения - ГО/филиал
     return T_Dep.Get_Dep(m_RS.DealBuyDepartment);
  END;

  MACRO SecType() // Налоговая группа
     return m_RS.TaxGroup;
  END;

  MACRO DqualB():DATE
    if(m_DqualB == NULL)
      m_DqualB = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REQUALREPO);
      if((ValType(m_DqualB) != V_UNDEF) and (m_DqualB != ""))
        m_DqualB = date(m_DqualB);
      end;
    end;
    return m_DqualB;
  END;                                                                                    

  MACRO DqualS():DATE
    if(m_DqualS == NULL)
      m_DqualS = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealSale(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_REQUALREPO);
      if((ValType(m_DqualS) != V_UNDEF) and (m_DqualS != ""))
        m_DqualS = date(m_DqualS);
      end;
    end;
    return m_DqualS;
  END;

  MACRO CoupCount():INTEGER
    return m_RS.CoupCount;
  END;

  MACRO LastCoupDate():DATE
    if(date(m_RS.LastCoupDate) != date(0,0,0))
      return date(m_RS.LastCoupDate);
    else
      return NULL;
    end;
  END;

  MACRO CrBP():DOUBLE
    var VprBrate=NULL;
    if(m_CrBP == NULL)
      if((m_RS.FaceValueFI == NATCUR) and (this.VprB() == NATCUR))
        m_CrBP = 1;
      elif((m_RS.FaceValueFI == NATCUR) and (this.VprB() != NATCUR))
        VprBrate = GetRateOnDateCrossDbl( this.DBV(), this.VprB(), NATCUR, true );
        if((ValType(VprBrate) != V_UNDEF) AND (VprBrate != 0.0))
          m_CrBP = 1/VprBrate;
        else
          m_CrBP = 0.0;
        end;
      elif((m_RS.FaceValueFI != NATCUR) and (this.VprB() != NATCUR))
        VprBrate = GetRateOnDateCrossDbl( this.DBV(), this.VprB(), NATCUR, true );
        if((ValType(VprBrate) != V_UNDEF) AND (VprBrate != 0.0))
          m_CrBP = GetRateOnDateCrossDbl( this.DBV(), m_RS.FaceValueFI, NATCUR, true )/VprBrate;
        else
          m_CrBP = 0.0;
        end;
      else
        m_CrBP = GetRateOnDateCrossDbl( this.DBV(), m_RS.FaceValueFI, NATCUR, true );
      end;
    end;

    if((m_CrBP == NULL) or (m_CrBP == 0.0))
      m_CrBP = NULL;
      return 1.0;
    end;

    return m_CrBP;
  END;

  MACRO printCrBP():DOUBLE
    this.CrBP();
    return m_CrBP;
  END;

  MACRO CrSP():DOUBLE
    var VprSrate=NULL;

    if(m_CrSP == NULL)
      if((m_RS.FaceValueFI == NATCUR) and (this.VprS() == NATCUR))
        m_CrSP = 1.0;
      elif((m_RS.FaceValueFI == NATCUR) and (this.VprS() != NATCUR))
        VprSrate = GetRateOnDateCrossDbl( this.DDS(), this.VprS(), NATCUR, true );
        if((ValType(VprSrate) != V_UNDEF) AND (VprSrate != 0.0))
          m_CrSP = 1/VprSrate;
        else
          m_CrSP = 0.0;
        end;
      elif((m_RS.FaceValueFI != NATCUR) and (this.VprS() != NATCUR))
        VprSrate = GetRateOnDateCrossDbl( this.DDS(), this.VprS(), NATCUR, true );
        if((ValType(VprSrate) != V_UNDEF) AND (VprSrate != 0.0))
          m_CrSP = this.CrDDS()/VprSrate;
        else
          m_CrSP = 0.0;
        end;
      else
        m_CrSP = this.CrDDS();
      end;
    end;

    if((m_CrSP == NULL) or (m_CrSP == 0.0))
      m_CrSP = NULL;
      return 1.0;
    end;

    return m_CrSP;
  END;

  MACRO printCrSP():DOUBLE
    this.CrSP();
    return m_CrSP;
  END;
        
  MACRO KNS():DOUBLE
    if(this.IsBond())
      return this.NomS/100.0;
    end;
    return 1.0;
  END;

  MACRO KNB():DOUBLE
    if(this.IsBond())
      return this.NomB/100.0;
    end;
    return 1.0;
  END;

  MACRO CVB():DOUBLE
    var CVB = 0.0;
    var VBRate = 0.0;
    if((m_RS.FaceValueFI != NATCUR) and (this.VprB() != NATCUR) and (m_RS.FaceValueFI == this.VprB()))
      CVB = GetRateOnDateCrossDbl( this.DDB(), this.VprB(), NATCUR, true );
    elif((m_RS.FaceValueFI == NATCUR) and (this.VprB() == NATCUR))
      CVB = 1;
    else
      VBRate = GetRateOnDateCrossDbl( this.DZB(), this.VprB(), NATCUR, true );
      if((ValType(VBRate) != V_UNDEF) AND (VBRate != 0.0))
        CVB = this.CrDZB()*GetRateOnDateCrossDbl( this.DDB(), this.VprB(), NATCUR, true )/VBRate;
      end;
    end;
    return CVB;
  END;

  MACRO CVS():DOUBLE
    var CVS = 0.0;
    var VSRate = 0.0;
    if((m_RS.FaceValueFI != NATCUR) and (this.VprS() != NATCUR) and (m_RS.FaceValueFI == this.VprS()))
      CVS = GetRateOnDateCrossDbl( this.DDS(), this.VprS(), NATCUR, true );
    elif((m_RS.FaceValueFI == NATCUR) and (this.VprS() == NATCUR))
      CVS = 1;
    else
      VSRate = GetRateOnDateCrossDbl( this.DZS(), this.VprS(), NATCUR, true );
      if((ValType(VSRate) != V_UNDEF) AND (VSRate != 0.0))
        CVS = this.CrDZS()*GetRateOnDateCrossDbl( this.DDS(), this.VprS(), NATCUR, true )/VSRate;
      end;
    end;
    return CVS;
  END;

  MACRO NkdVN():DOUBLE //  НКД на дату неттинга
     return (m_RS.NKDS*this.Qnty()/m_RS.SaleAmount);
  END;

  MACRO ComN():DOUBLE //Комиссия, уплаченная по сделкам неттинга
    return this.ComS() + this.ComB();
  END;

  MACRO Cont():STRING
    return m_RS.PartyShortNameNett;
  END;

  MACRO FR():DOUBLE //Финансовый результат- всего, руб.
    return this.SumSrub()-this.SumBrub()-this.ComN();
  END;

  MACRO DZ():DATE
    return this.DZB();
  END;

  
  MACRO ClientStatus(Investor):STRING
    var party = TBFile("party.dbt");
    var NumInList;
    var ClientStatus = "";

    if((ValType(Investor) != V_UNDEF) and (Investor > 0))
      party.rec.PartyID = Investor;
    else
      party.rec.PartyID = m_Rs.Investor;
    end;

    if( GetMainObjAttr( null, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), 42/*Является плательщиком НДФЛ*/, null, null, NumInList))
      if(NumInList == "1")
        ClientStatus = "резидент";
      elif(NumInList == "2")
        ClientStatus = "нерезидент";
      else
        ClientStatus = "не плательщик";
      end;  
    else //считается резидентом
      if(party.GetEQ())
        if(party.rec.NotResident == SET_CHAR)
           ClientStatus = "нерезидент";
        else
           ClientStatus = "резидент";
        end;
      end;
    end;

    return ClientStatus;
  END;

  MACRO DepS():string
     return IIF(m_Rs.DepS!=0,"Да","Нет");
  END;

  MACRO DepB():string
     return IIF(m_Rs.DepB!=0,"Да","Нет");
  END;

  MACRO GetDrawingDate():DATE
     return this.Dexp();
  END;

  MACRO DP(IsSale_:bool):DATE
     var IsSale = false, vDP = ZeroDate;

     if( IsSale_ != null )
        IsSale = IsSale_;
     end;

     var sql = RSDCommand(" SELECT NVL(min(t_FactDate),TO_DATE('01-01-0001','DD-MM-YYYY')) FactDate "+
                            " FROM ddlrq_dbt " +
                           " WHERE t_DocKind    = ? AND " + 
                                 " t_DocID      = ? AND " + 
                                 " t_DealPart   = 1 AND "+
                                 " t_Type      in(?,?,?) AND " + 
                                 " t_FactDate != TO_DATE('01-01-0001','DD-MM-YYYY') "
                         );
     if( IsSale )
        sql.addParam( "", RSDBP_IN, this.DealSale().rec.BOfficeKind );
        sql.addParam( "", RSDBP_IN, this.DealSale().rec.DealID );
     else
        sql.addParam( "", RSDBP_IN, this.DealBuy().rec.BOfficeKind );
        sql.addParam( "", RSDBP_IN, this.DealBuy().rec.DealID );
     end;
     
     sql.addParam( "", RSDBP_IN, DLRQ_TYPE_PAYMENT );
     sql.addParam( "", RSDBP_IN, DLRQ_TYPE_AVANCE );
     sql.addParam( "", RSDBP_IN, DLRQ_TYPE_DEPOSIT );
     sql.execute();
     
     VAR vRS = TRsbDataSet( sql );
     
     if( vRS.MoveNext() )
        vDP = SQL_ConvTypeDate(vRS.FactDate);
     end;

     return vDP;
  END;

  MACRO DPS():DATE
     if( m_DPS == null )
        m_DPS = this.DP(true);
     end;
     return m_DPS;
  END;

  MACRO DPB():DATE
     if( m_DPB == null )
        m_DPB = this.DP();
     end;
     return m_DPB;
  END;

  /*Значение поля <Код> категории <Сделка подлежит дополнительному контролю> по сделке <CodeS>*/
  MACRO K_ControlS():string
    if( m_K_ControlS == null )
       m_K_ControlS = "";
       DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKCONTROL, DL_GetMainObjAttr( this.DealSale(), OBJGROUP_TICKCONTROL, OBJTYPE_SECDEAL ), null, null, @m_K_ControlS);
    end;
    return m_K_ControlS;
  END;

  /*Значение поля <Код> категории <Сделка подлежит дополнительному контролю> по сделке <CodeB>*/
  MACRO K_ControlB():string
    if( m_K_ControlB == null )
       m_K_ControlB = "";
       DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKCONTROL, DL_GetMainObjAttr( this.DealBuy(), OBJGROUP_TICKCONTROL, OBJTYPE_SECDEAL ), null, null, @m_K_ControlB);
    end;
    return m_K_ControlB;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Коммента-рий для категории <Сделка подлежит дополнительному контролю>>*/
  MACRO Control_CommentB():string
    var vControl_Comment = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_CONTROLCOMMENT, date(31,12,9999)); // не историчное примечание
      if((ValType(vControl_Comment) != V_UNDEF) and (vControl_Comment != ""))
        vControl_Comment = string(vControl_Comment);
      end;
    return vControl_Comment;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Коммента-рий для категории <Сделка подлежит дополнительному контролю>>*/
  MACRO Control_CommentS():string
    var vControl_Comment = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealSale(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_CONTROLCOMMENT, date(31,12,9999)); // не историчное примечание
      if((ValType(vControl_Comment) != V_UNDEF) and (vControl_Comment != ""))
        vControl_Comment = string(vControl_Comment);
      end;
    return vControl_Comment;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Комментарий для категории <Способ определения РЦ>*/
  MACRO RC_CommentS():string
    var vRC_Comment = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealSale(), OBJTYPE_SECDEAL), 29, date(31,12,9999)); // не историчное примечание
      if((ValType(vRC_Comment) != V_UNDEF) and (vRC_Comment != ""))
        vRC_Comment = string(vRC_Comment);
      end;
    return vRC_Comment;
  END;

  /*Значение поля <Примечание> для вида примечания сделки <Комментарий для категории <Способ определения РЦ>*/
  MACRO RC_CommentB():string
    var vRC_Comment = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealBuy(), OBJTYPE_SECDEAL), 29, date(31,12,9999)); // не историчное примечание
      if((ValType(vRC_Comment) != V_UNDEF) and (vRC_Comment != ""))
        vRC_Comment = string(vRC_Comment);
      end;
    return vRC_Comment;
  END;

  MACRO QS():double
     return double(m_RS.SaleAmount);
  END;

  MACRO QB():double
     return double(m_RS.BuyAmount);
  END;

  /*Значение примечания сделки "Прочие комиссии" по сделке  <CodeB> *<Qnty> /QB*/
  MACRO ComB_Another()
     if( m_ComB_Another == null )
        m_ComB_Another = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_OHTCOMISS);
        if((m_ComB_Another != null) and (ValType(m_ComB_Another) != V_UNDEF) and (m_ComB_Another != "") and (this.QB() != 0.0))
          m_ComB_Another = money(double(string(m_ComB_Another:15:6)) * this.Qnty()/this.QB());
        end;
     end;
     return m_ComB_Another;
  END;

  /*Значение примечания сделки "Прочие комиссии" по сделке  <CodeS> *<Qnty> /QS*/
  MACRO ComS_Another()
     if( m_ComS_Another == null )
        m_ComS_Another = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealSale(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_OHTCOMISS);
        if((m_ComS_Another != null) and (ValType(m_ComS_Another) != V_UNDEF) and (m_ComS_Another != "") and (this.QS() != 0.0))
          m_ComS_Another = money(double(string(m_ComS_Another:15:6)) * this.Qnty()/this.QS());
        end;
     end;
     return m_ComS_Another;
  END;

  /*Значение поля <Код> категории сделки <Способ определения РЦ>*/
  MACRO RCB():string
    var NumInList = "";
    DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKRC, DL_GetMainObjAttr( this.DealBuy(), OBJGROUP_TICKRC, OBJTYPE_SECDEAL ), null, null, @NumInList);
    return NumInList;
  END;

  /*Значение поля <Код> категории сделки <Способ определения РЦ>*/
  MACRO RCS():string
    var NumInList = "";
    DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKRC, DL_GetMainObjAttr( this.DealSale(), OBJGROUP_TICKRC, OBJTYPE_SECDEAL ), null, null, @NumInList);
    return NumInList;
  END;

  /*Значение поля <Код> категории сделки <Вид ФИСС> (фьючерс, форвард, опцион) по сделке <CodeS>*/
  MACRO RFISSS()
    var NumInList = "";
    DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKFIIS, DL_GetMainObjAttr( this.DealSale(), OBJGROUP_TICKFIIS, OBJTYPE_SECDEAL ), null, @NumInList);
    return NumInList;
  END;

  /*Значение поля <Код> категории сделки <Вид ФИСС> (фьючерс, форвард, опцион) по сделке <CodeB>*/
  MACRO RFISSB()
    var NumInList = "";
    DL_GetObjAttrName(OBJTYPE_SECDEAL, OBJGROUP_TICKFIIS, DL_GetMainObjAttr( this.DealBuy(), OBJGROUP_TICKFIIS, OBJTYPE_SECDEAL ), null, @NumInList);
    return NumInList;
  END;

  /*Значение примечания "Дата в учете" сделки <CodeS>*/
  MACRO DRS()
    var vDR = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealSale(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_DATEIN, date(31,12,9999)); // не историчное примечание
    if((ValType(vDR) != V_UNDEF) and (vDR != ""))
       vDR = date(vDR);
    end;
    return vDR;
  END;
 
 /*Значение примечания "Дата в учете" сделки <CodeB>*/
  MACRO DRB()
    var vDR = readNoteForObject(OBJTYPE_SECDEAL, UniID(this.DealBuy(), OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_DATEIN, date(31,12,9999)); // не историчное примечание
    if((ValType(vDR) != V_UNDEF) and (vDR != ""))
       vDR = date(vDR);
    end;
    return vDR;
  END;

  MACRO ReplaceAndCalculate( FromStr:string, ToStr:string, Recalc:Bool )
    if( m_ObjTemplateXLS.UsePoi() )
        this.ReplaceAndCalculate(FromStr, ToStr);
        return;
    end; 

    var Save_DisplayAlerts = m_ObjTemplateXLS.Application.DisplayAlerts,
        Save_Calculation   = m_ObjTemplateXLS.Application.Calculation;

    m_ObjTemplateXLS.Application.DisplayAlerts = false; /* Чтобы MSExcel не задавал лишних вопросов */
    m_ObjTemplateXLS.Application.Calculation   = -4135; /* xlManual */

    m_ProgressIndicator.Start( m_ObjTemplateXLS.Book.Sheets.Count, "Обработка и пересчет формул шаблона", "Обработка и пересчет формул шаблона" );
    var i = 1;
    while( i <= m_ObjTemplateXLS.Book.Sheets.Count )
       if( (Index(StrUpr(m_ObjTemplateXLS.Book.Sheets(i).Name), "СВОД") > 0) or Recalc )
          m_ObjTemplateXLS.Book.Sheets(i).Cells.Replace(FromStr, ToStr, 2/*xlPart*/, 1/*xlByRows*/, false, false, false);
       end;
       i = i + 1;
       m_ProgressIndicator.Update( i, m_ObjTemplateXLS.Book.Sheets.Count );
    end;
    m_ProgressIndicator.Stop();

    m_ObjTemplateXLS.Application.Calculate();

    m_ObjTemplateXLS.Application.Calculation   = Save_Calculation;
    m_ObjTemplateXLS.Application.DisplayAlerts = Save_DisplayAlerts;

  END;

  MACRO EndReport()
     if(( m_outmode == DL_OUTREPORT_EXCEL_NO_FORMAT) or (m_outmode ==DL_OUTREPORT_EXCEL ))
       ReplaceAndCalculate( GetDL_FORMULA(), "=" );
     end;
  END;

  MACRO printSumBvp() //DEF-85252
     if(this.SumBvp() != null)
        return Round(this.SumBvp(), 2);
     end;
  END;

  /*Курс выводим в ячейку с 4-я знаками после запятой, при этом в строке формул видим занчение курса с максимум 12 знаков после запятой*/
  MACRO printCrSD_F()
    return ВыводЧерезФормулу(this.CrSD());/*substr, чтобы не было символа "=" перед числом в строке формул*/
  END;

  /*Курс выводим в ячейку с 4-я знаками после запятой, при этом в строке формул видим занчение курса с максимум 12 знаков после запятой*/
  MACRO printCrBD_F()
    return ВыводЧерезФормулу(this.CrBD());/*substr, чтобы не было символа "=" перед числом в строке формул*/
  END;

  MACRO printPrSNom()
     return ВыводЧерезФормулу(this.PrSNom());
  END;

  MACRO printPrBNom()
     if(this.PrBNom() != null)
        return Round(this.PrBNom(), 4);//ВыводЧерезФормулу(this.PrBNom()); DEF-85252
     end;
  END;

  MACRO printPrSvp()
     return ВыводЧерезФормулу(this.PrSvp());
  END;

  MACRO printPrBvp()
     return ВыводЧерезФормулу(this.PrBvp());
  END;

  MACRO printMinMrkt()
     return ВыводЧерезФормулу(this.MinMrkt());
  END;

  MACRO printMaxMrkt()
     return ВыводЧерезФормулу(this.MaxMrkt());
  END;

  MACRO printQuoteValueS()
     return ВыводЧерезФормулу(this.QuoteValueS());
  END;

  MACRO printQuoteValueB()
     return ВыводЧерезФормулу(this.QuoteValueB());
  END;

  /*Выводится значение <клиент>, если инвестор в сделке указан в качестве клиента, <контрагент>, если инвестор в сделке указан в качестве клиента-контрагента.*/
  MACRO ClientDeal():string
     return iif(m_RS.IsPartyClient == 1,"контрагент","клиент");
  END;

  /*выводить кол-во ценных бумаг без округления , в числовом формате, по сделкам с паями, дробная часть кол-ва ЦБ должна быть видна в "строке формул" при установке курсора на ячейке.*/
  MACRO printQnty()
     return ВыводЧерезФормулу(this.Qnty());
  END;

  /*Формула!*/
  /*Требования Банк: Курсы, которые участвуют в формуле, необходимо указывать в ячейке без округления, а формат ячейки   установить  4 десятичных  знака .
    Чтобы требование выполнить, делаем через формулу*/
  MACRO printCrSZ_F()
     return ВыводЧерезФормулу(this.CrSZ());
  END;

  /*Формула!*/
  /*Требования Банк: Курсы, которые участвуют в формуле, необходимо указывать в ячейке без округления, а формат ячейки   установить  4 десятичных  знака .
    Чтобы требование выполнить, делаем через формулу*/
  MACRO printCrBZ_F()
     return ВыводЧерезФормулу(this.CrBZ());
  END;

  MACRO printNomB()
     if(this.NomB() != null)
        return Round(this.NomB(), 4);//ВыводЧерезФормулу(this.NomB()); DEF-85252
     end;
  END;

  MACRO printNomBDU()
     return ВыводЧерезФормулу(this.NomBDU());
  END;

  MACRO printNomS()
     return ВыводЧерезФормулу(this.NomS());
  END;

  MACRO ifCoup_( dat:date ):integer
     var RetVal = 0;

     if( this.IsBond() )
       var sql = RSDCommand(" SELECT Count(fiw.t_DrawingDate) Nrec " +
                            "   FROM dfiwarnts_dbt fiw " +
                            "  WHERE fiw.t_FIID         =  ? AND " +
                            "        fiw.t_IsPartial   != 'X' AND " +
                            "        fiw.t_DrawingDate  > ? AND " +
                            "        fiw.t_DrawingDate <= ? "
                           );
       sql.addParam( "", RSDBP_IN, m_RS.FIID );
       sql.addParam( "", RSDBP_IN, this.DDB() );
       sql.addParam( "", RSDBP_IN, dat );
       sql.execute();
  
       var vRS = TRsbDataSet( sql );
  
       if( vRS.MoveNext() and (vRS.Nrec > 0) )
          RetVal = 1;
       end;
     end;

     return RetVal;
  END;

  /*получить номинал из истории номиналов на дату*/
  MACRO GetFaceValueOnDate(OnDate:date)
     var FaceValue = 0.0;
     var cmd = DL_RSDCommand("select nvl(Rsb_Secur.SC_GetNominalCostByPeriod(?, ?, ?) ,0) FaceValue from dual");
     cmd.AddParam(m_RS.FIID);
     cmd.AddParam(OnDate);
     cmd.AddParam(OnDate);
     
     var DataSet = cmd.Execute();
     if(DataSet.moveNext())
       FaceValue = DataSet.FaceValue;
     end;
     return FaceValue;
  END;

  /*Параметр Val_Market_New для сделок <CodeS>*/
  MACRO Val_MarketS()
     return SQL_ConvTypeStr(m_RS.SaleVal_Market);
  END;

  /*Параметр Val_Market_New для сделок <CodeS>*/
  MACRO Val_MarketB()
     return SQL_ConvTypeStr(m_RS.BuyVal_Market);
  END;

  /*Номинал на дату Z+1 (учитывая выходные дни, для сделок <S>)*/
  /*Номинал ц/б из истории номиналов на следую-щий ближайший рабочий день к дате <DZS>. Рабочие дни определяются по системному календарю, как дни с видом обслуживания = банковское. */
  MACRO Nom_DZ_1S():MONEY
     return GetFaceValueOnDate(GetDateAfterWorkDays(this.DZS(), 1));
  END;

  MACRO printNom_DZ_1S()
     return ВыводЧерезФормулу(this.Nom_DZ_1S());
  END;

  /*Номинал на дату Z+1 (учитывая выходные дни, для сделок <B>)*/
  /*Номинал ц/б из истории номиналов на следую-щий ближайший рабочий день к дате <DZB>. Рабочие дни определяются по системному календарю, как дни с видом обслуживания = банковское. */
  MACRO Nom_DZ_1B():MONEY
     return GetFaceValueOnDate(GetDateAfterWorkDays(this.DZB(), 1));
  END;

  MACRO printNom_DZ_1B()
     return ВыводЧерезФормулу(this.Nom_DZ_1B());
  END;

  /*Номинал по условиям выпуска*/
  MACRO Nom_Sec():MONEY
     return m_RS.FaceValue;
  END;

  MACRO printNom_Sec()
     return ВыводЧерезФормулу(this.Nom_Sec());
  END;

  MACRO Nom_DZS():MONEY
     return GetFaceValueOnDate(this.DZS());
  END;

  MACRO printNom_DZS()
     return ВыводЧерезФормулу(this.Nom_DZS());
  END;

  MACRO Nom_DZB():MONEY
     return GetFaceValueOnDate(this.DZB());
  END;

  MACRO printNom_DZB()
     return ВыводЧерезФормулу(this.Nom_DZB());
  END;

  MACRO Nom_H08():MONEY
     return GetFaceValueOnDate(this.H0_8());
  END;

  MACRO printNom_H08()
     if(this.Nom_H08() != null)
        return Round(this.Nom_H08(), 4);//ВыводЧерезФормулу(this.Nom_H08()); DEF-85252
     end;
  END;

  MACRO Nom_H07_1():MONEY
     if( m_Nom_H07_1 == null )
        m_Nom_H07_1 = GetFaceValueOnDate(this.H0_7()-1);
     end;
     return m_Nom_H07_1;
  END;

  MACRO printNom_H07_1()
     return ВыводЧерезФормулу(this.Nom_H07_1());
  END;

  MACRO ИмяОсновногоЛиста()
     return "";
  END;

  MACRO ИмяСводногоЛиста()
     return "";
  END;

  MACRO ИмяКодЦБОснЛиста()
     return "";
  END;

  MACRO ИмяКодЦБСводЛиста()
     return "";
  END;

  MACRO НомерНачСтрокиСумм()
     return 29;
  END;

  MACRO НомерКонечнСтрокиЗаголовка()
     return 26;
  END;

  /*Если критерий один - используется ф-ла СУММЕСЛИ, если больше одного - СУММПРОИЗВ (было бы проще использовать СУММЕСЛИМН, но мы пока работаем в режиме совместимости до 2007, а СУММЕСЛИМН появилась после 2007)
    1 параметр - имя ячейки, по котрой суммирование
    далее пары параметров: первый - имя ячейки, по которой условие, второй параметр - само условие в кавычках*/
  macro ТекстФормулыПоВсемСделкамДляВыпуска(/*...*/)
     VAR k = 1, CellName ="", ColNameCond = "", WhereCond = "";
     VAR i = 0, j = 0, NumSheet1 = 0, NumSheet2 = 0, FormulaStr = "", BeginRow_1 = 0, BeginRow_2 = 0, SummBeginRow_1 = 0, SummBeginRow_2 = 0;
     VAR FormulaSumStr ="", FormulaCondStr = "";

     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(this.ИмяОсновногоЛиста()) )
           NumSheet1 = i;
           break;
        end;
        i = i + 1;
     end;

     i = 0;
     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(this.ИмяСводногоЛиста()) )
           NumSheet2 = i;
           break;
        end;
        i = i + 1;
     end;

     i = NumSheet1;
     while( i < NumSheet2 )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(this.ИмяОсновногоЛиста()) ) /*для первой вкладки*/
           BeginRow_1 = this.НомерКонечнСтрокиЗаголовка();
           SummBeginRow_1 = this.НомерНачСтрокиСумм();
        else
           BeginRow_1 = 1;
           SummBeginRow_1 = 2;
        end;

        if( StrUpr(m_UsedSheet[m_UsedSheet.size-1]) == StrUpr(this.ИмяСводногоЛиста()) )/*для первой(начиная с m_SHEET_2) вкладки*/
           BeginRow_2 = this.НомерКонечнСтрокиЗаголовка();
           SummBeginRow_2 = this.НомерНачСтрокиСумм();
        else
           BeginRow_2 = 1;
           SummBeginRow_2 = 2;
        end;

        if( FormulaStr != "" )
           FormulaStr = FormulaStr + "+";
        end;

        FormulaSumStr = "";
        CellName = "";
        k = 1;
        if( GetParm( k, CellName) )
           FormulaSumStr = "'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET);
        end;

        ColNameCond = "";
        WhereCond = "";
        FormulaCondStr = "";
        k = k + 1;
        while( GetParm( k, ColNameCond) AND GetParm( k+1, WhereCond))
            FormulaCondStr = FormulaCondStr + "('"+m_UsedSheet[i]+"'!$"+this.ИмяКодЦБОснЛиста()+"$"+SummBeginRow_1+":$"+this.ИмяКодЦБОснЛиста()+"$"+string(BeginRow_1+MAXROWSHEET)+"=$"+this.ИмяКодЦБСводЛиста()+"$"+(m_ReportTable.bRowTable + getCurrentRow())+")*('"+
                             m_UsedSheet[i]+"'!$"+ColNameCond+"$"+SummBeginRow_1+":$"+ColNameCond+"$"+string(BeginRow_1+MAXROWSHEET)+WhereCond+");";
            k = k + 2;
            ColNameCond = "";
            WhereCond = "";
        end;

        if( k > 2 )
           FormulaStr = FormulaStr + FormulaSUMPRODUCT()+"("+FormulaCondStr+FormulaSumStr+")";
        else
           FormulaStr = FormulaStr + FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+this.ИмяКодЦБОснЛиста()+"$"+SummBeginRow_1+":$"+this.ИмяКодЦБОснЛиста()+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+this.ИмяКодЦБСводЛиста()+"$"+SummBeginRow_2+":$"+this.ИмяКодЦБСводЛиста()+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        end;

        i = i + 1;
     end;

     return FormulaStr;
  end;

  macro ФормулаПоВсемСделкамДляВыпуска(CellName:string)
     return F(ТекстФормулыПоВсемСделкамДляВыпуска(CellName));
  end;

  InitDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode, FocreFormatRep );
END;
