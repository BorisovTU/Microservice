/*
$Name:        od05.mac
$Module:      Ценные бумаги
$Description: Ценные бумаги и долговые обязательства, переданные в залог по полученным кредитам, по состоянию на отчетную дату
$Programmer:  Котов C.
*/
import od05_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) od05_Report
  var m_BeginDate /*, m_EndDate*/;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Счет по маске*/
    macro AccountMask(acc)
      if(strlen(acc) <= 1)
        return "-";
      elif(strlen(acc) != 20)
        return acc;
      else
        return substr(acc,1,5) + "-" + substr(acc,6,3) + "-" + substr(acc,9,1) + "-" + substr(acc,10,4) + "-" + substr(acc,14);
      end;
    end;

    /*Балансовый счет*/
    macro AccountBal(acc)
      if(strlen(acc) < 5)
        return "-";
      else
        return substr(acc,1,5);
      end;
    end;

    /*Валюта счета*/
    macro AccountCur(acc)
      if(strlen(acc) < 8)
        return "-";
      else
        return substr(acc,6,3);
      end;
    end;

/*Точка входа*/
    var cnt;
    var m_cmd, m_sql_slave, m_RS_slave, m_cmd_slave;
    var nom_cost, nom_cost_cur, bal_cost, bal_cost_cur;
    var sum_nom_cost = $0, sum_bal_cost = $0;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    if(m_Form.GetFieldValue(PNFLD_PERIOD) < 13)
      /*Задан месяц*/
      m_BeginDate = date(1, m_Form.GetFieldValue(PNFLD_PERIOD), FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 1) - 1;
    else 
      /*Задан квартал*/
      m_BeginDate = date(1, (m_Form.GetFieldValue(PNFLD_PERIOD) - 12 - 1) * 3 + 1, FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 3) - 1;
    end;

/*Лист "МСФО08"*/
    SetActiveSheet("Ценные бумаги и долговые об...");
    PrintFormatString("", "reportname", "Таблица ОД_5 ""Ценные бумаги и долговые обязательства, переданные в залог по полученным кредитам, по состоянию на отчетную дату " + string(date(m_EndDate+1):f) + """");
//    var curUSD = $0;
//    convsum(curUSD, $100, m_EndDate, 7, 0);
//    curUSD = double(curUSD) / 100;
//    PrintFormatString("", "reportcur", curUSD);
    RegisterTable( "row1_0", "",
             /* 1*/ "row1_1", 
             /* 2*/ "row1_2", 
             /* 3*/ "row1_3", 
             /* 4*/ "row1_4", 
             /* 5*/ "row1_5", 
             /* 6*/ "row1_6", 
             /* 7*/ "row1_7", 
             /* 8*/ "row1_8", 
             /* 9*/ "row1_9", 
             /*10*/ "row1_10", 
             /*11*/ "row1_11", 
             /*12*/ "row1_12", 
             /*13*/ "row1_13", 
             /*14*/ "row1_14", 
             /*15*/ "row1_15", 
             /*15*/ "row1_16");
//    this.AutoFilter(6, "B", "AO");
    StartCaptureOutput();
    [
       select case when nvl(dp_dep.t_name,chr(1)) = '0000' then chr(1) else nvl(dp_dep.t_name,chr(1)) end t_departmentnum, -- Филиал
              acc.t_balance, -- Номер счета второго порядка
              substr(acc.t_account,1,5) || '-' ||
              substr(acc.t_account,6,3) || '-' ||
              substr(acc.t_account,9,1) || '-' ||
              substr(acc.t_account,10,4) || '-' ||
              substr(acc.t_account,14,7) t_account, -- Номер лицевого счета (20 знаков)
              mc.t_dockind,
              mc.t_docid,
              decode(acc.t_kind_account, 'А', -1, 1) * rsb_account.restac(acc.t_account, acc.t_code_currency, :edt1, acc.t_chapter, 0) t_rest,
              acc.t_code_currency,
              p.t_name
         from daccount_dbt acc, ddp_dep_dbt dp_dep, dmcaccdoc_dbt mc, dparty_dbt p
        where acc.t_balance='91411' and dp_dep.t_code = acc.t_department
          and rsb_account.restac(acc.t_account, acc.t_code_currency, sysdate, acc.t_chapter, 0)!=0
          /*and mc.t_account(+)=acc.t_account and mc.t_catid(+)=203 and mc.t_catnum(+)=510*/
          and mc.t_account(+)=acc.t_account and mc.t_catid=203 and mc.t_catnum=510
          and rsb_account.restac(acc.t_account, acc.t_code_currency, :edt2, acc.t_chapter, 0)!=0
          and acc.t_client = p.t_partyid
    ];
    m_cmd = RsdCommand(EndCaptureOutput());
//    m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
    m_cmd.AddParam("edt1", RSDBP_IN, m_EndDate);
    m_cmd.AddParam("edt2", RSDBP_IN, m_EndDate);
//    if(m_Form.GetFieldValue(PNFLD_CURRENCY) == "X")
//      if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
//        m_cmd.AddParam("typ", RSDBP_IN, 0);
//      else
//        m_cmd.AddParam("typ", RSDBP_IN, 1);
//      end;
//    else
//      m_cmd.AddParam("typ", RSDBP_IN, 2);
//    end;

    m_cmd.Execute();
    m_RS = TRsbDataSet(m_cmd);
    cnt = 0;

    while(m_RS.movenext)
      if(cnt == 0)
        InitProgress(int(1), "Ждите...", "Формирование таблицы \"ОД_5\"");
      end;
      StartCaptureOutput();
      // Цикл в цикле для обработки разных видов ценных бумаг
      if (m_RS.value("t_dockind") == 143)
        [   select --knd.t_sznamealg, -- Наименование ценной бумаги
                   bn.t_bcseries || ' ' || trim(bn.t_bcnumber) t_bcseries, -- Серия / выпуск
                   leg.t_principal, -- Количество бумаг*
                   cur.t_iso_number, -- Валюта, в которой номинирована ценная бумага (643 - рубли, 840 - доллары США, 978 - евро и т.д.)
                   tick.t_curdeal, -- код ФИ
                   leg.t_cost, -- Номинальная стоимость на отчетную дату в рублевом эквиваленте
                               -- Если ценная бумага номинирована в инвалюте, то номинальная стоимость на отчетную дату в инвалюте
                               -- Балансовая стоимость на отчетную дату в рублевом эквиваленте
                               -- Если ценная бумага номинирована в инвалюте, то балансовая стоимость на отчетную дату в инвалюте
                   leg.t_start, -- Дата приобретения (период приобретения)
                   leg.t_maturity, -- Дата погашения
                   tick.t_regdate -- Дата окончания залога
                    -- Классификация ценных бумаг для целей МСФО: (1а) торговые, (1б) оцениваемые через ОПУ, (2) имеющиеся в наличии для продажи; (3) удерживаемые до погашения
                    -- Особые условия залога
              from ddl_tick_dbt tick, -- Операции залога
                   ddl_leg_dbt leg,
                   dvsordlnk_dbt lnk, dvsbanner_dbt bn, /*dnamealg_dbt knd,*/ dfininstr_dbt cur
             where tick.t_dealid = :dealid
               and tick.t_bofficekind = :bofficekind
               and leg.t_dealid = tick.t_dealid
               and leg.t_legkind = 0
               and leg.t_legid = 0
               --and tick.t_avoirkind = knd.t_inumberalg
               --and knd.t_itypealg = 3522
               and cur.t_fi_kind = 1
               and cur.t_fiid = tick.t_curdeal
               and lnk.t_contractid = tick.t_dealid
               and lnk.t_bcid = bn.t_bcid;
        ];
      end;
      m_sql_slave = EndCaptureOutput();

      if (strlen(m_sql_slave) > 0)
        m_cmd_slave = RsdCommand(m_sql_slave);
        m_cmd_slave.AddParam("dealid", RSDBP_IN, m_RS.value("t_docid"));
        m_cmd_slave.AddParam("bofficekind", RSDBP_IN, m_RS.value("t_dockind"));
        m_cmd_slave.Execute();
        m_RS_slave = TRsbDataSet(m_cmd_slave);
        if(m_RS_slave.movenext)
          nom_cost = string(money(m_RS_slave.value("t_cost")));
          sum_nom_cost = sum_nom_cost + money(m_RS_slave.value("t_cost"));
          if (m_RS_slave.value("t_curdeal")!=0)
            ConvSum( nom_cost_cur, m_RS_slave.value("t_cost"), m_EndDate, m_RS_slave.value("t_curdeal"), 0 );
            nom_cost_cur = string(money(nom_cost_cur));
          else
            nom_cost_cur = "-";
          end;
          bal_cost = string(money(m_RS.value("t_rest")));
          sum_bal_cost = sum_bal_cost + money(m_RS.value("t_rest"));
          if (m_RS.value("t_code_currency")!=0)
            ConvSum( bal_cost_cur, m_RS.value("t_rest"), m_EndDate, m_RS.value("t_code_currency"), 0 );
            bal_cost_cur = string(money(bal_cost_cur));
          else
            bal_cost_cur = "-";
          end;
          /*Выводим строку отчета*/
          PrintTableLine(
              /* 1*/ "row1_1",  m_RS.value("t_departmentnum"), null,
              /* 2*/ "row1_2",  m_RS.value("t_balance"), null,
              /* 3*/ "row1_3",  m_RS.value("t_account"), null,
              /* 4*/ //"row1_4",  m_RS_slave.value("t_sznamealg"), null,
              /* 4*/ "row1_4",  m_RS.value("t_name"), null,
              /* 5*/ "row1_5",  m_RS_slave.value("t_bcseries"), null,
              /* 6*/ "row1_6",  int(m_RS_slave.value("t_principal")), null,
              /* 7*/ "row1_7",  m_RS_slave.value("t_iso_number"), null,
              /* 8*/ "row1_8",  nom_cost, null,
              /* 9*/ "row1_9",  nom_cost_cur, null,
              /*10*/ "row1_10", bal_cost, null,
              /*11*/ "row1_11", bal_cost_cur, null,
              /*12*/ "row1_12", date(m_RS_slave.value("t_start")), null,
              /*13*/ "row1_13", date(m_RS_slave.value("t_maturity")), null,
              /*14*/ "row1_14", "", null);
        end;
      end;

      cnt = cnt + 1;
      UseProgress(cnt);
    end;
    if(cnt > 0)
      /*Выводим итоговую строку отчета*/
      PrintTableLine(
          /* 1*/ "row1_1",  "", null,
          /* 2*/ "row1_2",  "", null,
          /* 3*/ "row1_3",  "", null,
          /* 4*/ "row1_4",  "", null,
          /* 5*/ "row1_5",  "", null,
          /* 6*/ "row1_6",  "", null,
          /* 7*/ "row1_7",  "", null,
          /* 8*/ "row1_8",  string(sum_nom_cost), null,
          /* 9*/ "row1_9",  "", null,
          /*10*/ "row1_10", string(sum_bal_cost), null,
          /*11*/ "row1_11", "", null,
          /*12*/ "row1_12", "", null,
          /*13*/ "row1_13", "", null,
          /*14*/ "row1_14", "", null);
      RemProgress();
    end;
    EndTable();
  END;
  
  //initTX_RegistrReport(od05_Panel(), "od05.xlsx");
  initTX_RegistrReport(od05_Panel(), "od05.xlsx", NULL, NULL, NULL, true, false );

END;

/*Точка входа*/
var r = od05_Report();
r.InitReport("ОД05", null);
r.Run();

exit(1);
