/*
 $Name: nptxcrnset015.mac
 $Module: Ценные бумаги
 $Description: Соглашение об урегулировании претензий. Шаг "Отправка записи в Хранилище"
 */

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(nptxop, ID_Operation, ID_Step)
  var NeedLoopStep = false;
  var ErrStr = "";
  var err = 0;

  err = STB_ExecuteSendToStorOnStep(nptxop.rec.DocKind, nptxop.rec.ID, ID_Operation, ID_Step, @NeedLoopStep, @ErrStr);

  if(ErrStr != "")
    err = Error(err, ErrStr);
  end;

  if(not err)
    err = DL_NPTX_SaveTbMes();

    if(not err)
      if((NeedLoopStep == true))
        if( not InsertOprStatus(46481, 2)) //Расчет НДФЛ
          return Error( "Ошибка при установке статуса вида \"Расчет НДФЛ\" операции" );        
        end;
      else
        if( not InsertOprStatus(46481, 4)) //Формирование проводок
          return Error( "Ошибка при установке статуса вида \"Формирование проводок\" операции" );        
        end;
      end;
    end;
  end;

  return err;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)
  var nptxop = TRecHandler("nptxop.dbt");
  var err = 0;

  SetBuff( nptxop, FDoc );

  err = RunAction(nptxop, ID_Operation, ID_Step);

  DL_NPTX_SaveOperLog(nptxop.rec.ID, 15);

  return err;
end;

/* Макрос постобработки */
MACRO PostStep (CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,          /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

  record nptxop("nptxop");
  var ErrStr = "";
  var err = 0;

  SetBuff( nptxop, FDoc );

  if(CommitOrRollback == 2)
    err = STB_RollbackSendToStorOnStep(nptxop.DocKind, nptxop.ID, ID_Operation, ID_Step, @ErrStr);
    if(ErrStr != "")
      msgbox(ErrStr);
    end;
  end;

  return err;
END;