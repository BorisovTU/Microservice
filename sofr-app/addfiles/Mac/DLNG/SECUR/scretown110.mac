/*
$Name:         scretown110.mac
$Module:       Ценные бумаги
$Description:  Операция погашения выпуска СЭБ. Шаг закрытие операции
*/
import "sp_categ.mac";
import "sc_qraccfd.mac", "sp_caracc.mac","qracctools.mac";
IMPORT "role_model.mac";//ролевая модель

private macro execCarryQDA(_FD)
    var SQL, CMD, RS, FDQR, PayFIID,dS, err; 
    const chapter = 5;
    const rCarry = 1;
    private var corBuf = TRecHandler("account.dbt");
    private var accBuf = TRecHandler("account.dbt");

    private var tr;
    private var DealCode = "";
    private var isDepo, isKDU;

    GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_DEPOSITARY", V_BOOL, isDepo, err);
    GetRegistryValue("SECUR\\ВЕДЕНИЕ КДУ", V_BOOL, isKDU, err);
    
    if (err)
      MsgBox("Ошибка получение значений настроек \"WORK_WITH_DEPOSITARY\", \"ВЕДЕНИЕ КДУ\"");
      return 1;
    end;

    if (isDepo and isKDU)
      CreateErrMsg(err=28055);
    elif ((not isDepo) and (not isKDU))
      CreateErrMsg(err=28056);
    end;

    if(isDepo and (not isKDU))
      return 1;
    end;

    SQL = "SELECT sc.t_qrid, " +
          "       sc.t_fiid, " +
          "       ac.t_account, " +
          "       ABS (RSI_RSB_ACCOUNT.RestAC (ac.t_ACCOUNT, " +
          "                                    ac.t_CODE_CURRENCY, " +
          "                                    SYSDATE, " +
          "                                    ac.t_CHAPTER, " +
          "                                    0)) " +
          "          Accrest " +
          "  FROM dscqracc_dbt sc, daccount_dbt ac " +
          " WHERE SC.T_ACCOUNTID = AC.T_ACCOUNTID " +
          "       AND ABS (RSI_RSB_ACCOUNT.RestAC (ac.t_ACCOUNT, " +
          "                                        ac.t_CODE_CURRENCY, " +
          "                                        SYSDATE, " +
          "                                        ac.t_CHAPTER, " +
          "                                        0)) > 0 " +
          "        AND sc.t_fiid = ?                " ;
    CMD = RSDCommand(SQL);
    CMD.AddParam("?",RSDBP_IN, _FD.Tick.Rec.Pfi);
    RS=RSDRecordset(CMD, RSDVAL_CLIENT, RSDVAL_STATIC);
    while (RS.MoveNexT())
      FDQR = SC_QRAccFD(RS.Value("t_qrid"));
      PayFIID = RS.Value("t_Fiid");
      dS = RS.Value("AccRest");
      DealCode = _FD.Tick.Rec.DealCode;
      err = НайтиОткрытьСчетаКДУ(RS.Value("t_qrid"),{Curdate},accBuf,corBuf);
      if (not err)
        tr = RsbAccTransaction();
          if(tr == null)
             RunError("Ошибка при формировании проводки");
          end;

/*DAN.Ролевая модель. Определяем конечного операциониста для проводки */
      var retvalGetMO = GetMainOperInGroup(_FD.Kind);
      if (retvalGetMO > 0)
	 Tr.Oper = retvalGetMO;
      else
         Tr.Oper = {Oper};
      end;
/*DAN*/

          tr.Date_Carry = {CurDate};

          tr.Chapter         = 5;
          tr.Department      = {OperDprt};
          tr.Number_Pack     = 10;
          tr.Numb_Document   = "";
          tr.Ground          = "Списание ценных бумаг в операции погашения №" + DealCode;
          tr.FIIDPayer       = PayFIID;
          tr.FIIDReceiver    = PayFIID;
          tr.SumPayer        = dS;
          tr.SumReceiver     = dS;
          tr.AccountPayer    = corBuf.rec.Account;
          tr.AccountReceiver = accBuf.rec.Account;
          tr.Shifr_Oper = DL_GetShifrOper(5, accBuf.rec, corBuf.rec);
          if( not tr.Carry() )
            RunError("Ошибка при выполнении проводки");
          end;    

      end;  
    end;
end;


macro ExecuteStep( Doc, FDoc )
  record deal(dl_tick);       
  var    FD, error; 
  var    dat;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal, false );

  if( FD.ЕстьНеиспТО() )
     MsgBox("Обработаны не все ТО по операции");
     return 1;
  end;

  if(FD.Tick.rec.clientid == UnknownParty)
    execCarryQDA(FD);
  end;
 

  return 0;
end;
