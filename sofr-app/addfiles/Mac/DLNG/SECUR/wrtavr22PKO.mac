/*
Name: wrtavr22PKO.mac

Операция: Списание/зачисление ценных бумаг (Списание ценных бумаг ПКО)
Шаг: Отправка сообщения в Diasoft
*/
import "PkoWriteOffBuffer.mac";
import "spDeal.mac";
import oralib;
import "cblogger2.mac";

macro ExecuteStep( Doc, ticket, DocKind, OperationID )
    record deal("dl_tick");
    SetBuff(deal, ticket);
    var logBuilder = LoggerFactory().NewItLog("wrtavr22PKO");
    var logger:c_logger = logBuilder.GetLogger();
    logger = logBuilder.WithPrefix(" Операция с ID = " + deal.dealId).GetLogger();
    var buffer = PKOWriteOff(deal.dealId);
    var rescode = 0;
    var restxt = "";
    var isNeedSendMessage = true;

    if(buffer.GetStep2Reject() == 1)
        logger.Info("Ошибка передачи неторгового поручения. Установлен признак отказа.");
        return 0;
    end;

    if (GetDialogFlag() == 0) //безынтерфейсный режим
        //отправка сообщения в диасофт о недостаточности лимитов
        if(SendLimitMessage(deal.dealId, 0, "Лимитов на списание нет"))
            MsgBox("В Диасофт отправлено сообщение о недостаточности ц/б у клиента");
            return 1;
        end;
    end;

    if(buffer.isLimitCorrected())
        //отправка сообщения в диасофт о достаточности лимитов
        if(SendLimitMessage(deal.dealId, 1, "Лимит на списание есть"))
            MsgBox("В Диасофт отправлено сообщение о блокировке ц/б");
            return 0;
        else
            restxt = "В Диасофт не отправлено сообщение о блокировке ц/б";
            rescode = 3;
            return;
        end;      
    end;

    //Вариант принудительного исполнения операции
    isNeedSendMessage = MsgBoxEx("Лимиты по операции заблокированы?", MB_YES + MB_NO, IND_NO) == IND_YES;

    if(isNeedSendMessage)
        if(SendLimitMessage(deal.dealId, 1, "Лимит на списание есть"))
            MsgBox("В Диасофт отправлено сообщение о блокировке ц/б");
            return 0;
        else
            restxt = "В Диасофт не отправлено сообщение о блокировке ц/б";
            rescode = 3;
            return;
        end;
    else
        if(SendLimitMessage(deal.dealId, 0, "Лимитов на списание нет"))
            MsgBox("В Диасофт отправлено сообщение о недостаточности ц/б у клиента");
            return 1; 
        end; 
    end;

    return 0;

    onError(errObj)
    logger.ErrorClob("Ошибка при обработке операции с ID: " + deal.dealId, GetFullErrMsg(errObj));
    return 1;
end;