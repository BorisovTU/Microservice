/*
$Name: nptxhold012.mac
$Module: Ценные бумаги
$Description: Пересчет СНОБ для операций удержания НДФЛ
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(Oper)
  var nptxop_new = TRecHandler( "nptxop" );
  var RefID;
  var err = 0;

  nptxop_new.Clear();

  GenerateNumberByReference( OBJTYPE_NPTXRECALCTB, 1 /*REFOBJ_RECALCTBOP*/, @RefID, @nptxop_new.rec.Code );
    
  nptxop_new.rec.DocKind           = DL_NPTXRECALCTB;
  nptxop_new.rec.OperDate          = Oper.rec.OperDate;
  nptxop_new.rec.Department        = {OperDprt};
  nptxop_new.rec.Oper              = Oper.rec.Oper;
  nptxop_new.rec.Status            = 0/*DL_TXOP_Prep*/;
  nptxop_new.rec.Recalc            = UNSET_CHAR;
  nptxop_new.rec.FIID              = ALLFININSTR;
  nptxop_new.rec.Client            = Oper.rec.Client;

  nptxop_new.rec.Kind_Operation    = 2043;//Пересчет СНОБ

  if ( not CreateNptxOpStep(nptxop_new, true))
    err = 1;
  end;

  if(not err)
    var CurrYear = 0;

    datesplit(Oper.rec.OperDate, NULL, NULL, CurrYear);

    if((Oper.rec.SubKind_Operation != DL_TXHOLD_OPTYPE_ENDYEAR) and (Oper.rec.Subkind_Operation != DL_TXHOLD_OPTYPE_TAXREF) and (NeedNptxNettOp(Oper.rec.Client, CurrYear, Oper.rec.OperDate)))
      if( not InsertOprStatus(46081, 12)) //Зачет удержанного НДФЛ = Выполнить
        return Error( "Ошибка при установке статуса вида \"Зачет удержанного НДФЛ\" операции" );        
      end;
    else
      if( not InsertOprStatus(46081, 9)) //Запрос СНОБ
        return Error( "Ошибка при установке статуса вида \"Запрос СНОБ\" операции" );        
      end;
    end;
  end;

  return err;
end;

MACRO ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Oper = TRecHandler( "nptxop.dbt" );
  VAR Stat = 0;

  Oper.SetRecordAddr( FDoc );

  stat = DL_NPTX_PutMsg( "Расчет сумм" );
        
  if( not stat )
     stat = RunAction(Oper);
     DL_NPTX_SaveOperLog( Oper.rec.ID, 20 );
  end;

  return stat;
END;

