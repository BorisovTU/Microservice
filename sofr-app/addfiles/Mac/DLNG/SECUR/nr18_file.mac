/*
Чтение данных из excel для заполнения отчета НР18
Сагиян Сурен. 27.03.2019
*/
import activex, oralib, likepy, BankInter,"nr18_form.mac";

private const COL_NAME    = 5,
              COL_DOCTYPE =   6,
              COL_DOCNUM =   7,
              COL_SERIA =    8,
              COL_DOCDATE = 9,
              COL_DOCDEPT = 10,
              COL_REGPLACE     = 12,
              COL_BIRTHDAY = 13,
              COL_ADRESS = 14,
              COL_JADRESS = 16,
              COL_TYPE    = 19,
              COL_COUNTRY = 20,
              COL_CODE = 23,
              COL_TAXTYPE = 25, //Chesnokov D.S. 503507
              COL_PHONE = 18,
              COL_QTY = 40,
              COL_ISIN = 38,
              COL_COUPDATE = 41;

VAR           CL_NAME,
              CL_DOCTYPE,
              CL_DOCNUM,
              CL_SERIA,
              CL_DOCDATE,
              CL_DOCDEPT,
              CL_REGPLACE,
              CL_BIRTHDAY,
              CL_ADRESS,
              CL_JADRESS,
              CL_TYPE,
              CL_COUNTRY,
              CL_COUNTRY_NUM,
              CL_CODE,
              CL_TAXTYPE,
              CL_PHONE,
              CL_QTY,
              CL_ISIN,
              CL_COUPDATE,
              CL_TAXPROC;

var Rec, Rec2;

//Заполняется буферная таблица данными из Excel
macro GetFromExcel (RowArr:TArray, RowArr2:TArray)
  var DealID_Excel:string;
  var DealCode:string = "";
  var FullNameFile = "";
  var FileName = "";
  var TermPath = GetCurDir(true) + "\\TxtFile";
  var Userpath = "";
  var DirName = "";
  var ExtName = "";
  var frow = 2;
  var row = 2;
  var sheet, sql, query_insert, query_check, query_update, cmd2, rs2;
  var valuedate:date =  Date(0, 0, 0);
  var n_part;
  var ss = $0;
  var str;
  var stop = 0;
  var flag;

  /*Выбираем файл для обработки*/
while (stop == 0)
  if(not SelectFile(FullNameFile, "$C:\\*.dbf", "Выберите файл для загрузки", 0, true))
    stop=1;
  end;
  
  row = 2;

  if (stop == 0)

  //Отделяем путь файла от имени
  splitfile(FullNameFile, FileName, ExtName);
  FileName = FileName + ExtName;
  DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);

  if (not copyfile("$" + DirName + FileName, "$" + TermPath + "\\" + FileName) )
    MsgBox("Ошибка при передаче файла на терминал");
    //msgbox(string("$" + DirName + FileName) +"|"+string(TermPath + "\\" + FileName));
    //return 0;
  end;

  /*Открываем файл*/
  BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");

  if(not OpenExcelFile(FileName, false, true, TermPath))
    MsgBox("Ошибка открытия файла \"" + TermPath + "\\" + FileName + "\"");
    EndAction(1);
    return 0;
  end;

  sheet = ExcelApplication.Sheets(1);

  //Бежим по файлу
  while (valtype(sheet.cells(row, 1).value) != V_UNDEF)
       CL_REGPLACE = trim(sheet.cells(row, COL_REGPLACE).value);
       CL_COUNTRY = trim(sheet.cells(row, COL_COUNTRY).value);
       CL_TAXTYPE = int(sheet.cells(row, COL_TAXTYPE).value);
       if (((Index(strupr(CL_REGPLACE),"РОССИЯ")<1 ) AND ( CL_COUNTRY != "RU" ) AND ( CL_COUNTRY != "")) OR (CL_TAXTYPE != 1)) //Chesnokov D.S. 503507
	      Rec = RowArr.size();
	      RowArr(Rec) = TRow();

              CL_NAME = trim(sheet.cells(row, COL_NAME).value);
	      CL_DOCTYPE = trim(sheet.cells(row, COL_DOCTYPE).value);
              CL_DOCNUM = trim(sheet.cells(row, COL_DOCNUM).value);
	      CL_SERIA = trim(sheet.cells(row, COL_SERIA).value);
              CL_DOCDATE = sheet.cells(row, COL_DOCDATE).value;
              CL_DOCDEPT = trim(sheet.cells(row, COL_DOCDEPT).value);
	      CL_REGPLACE = trim(sheet.cells(row, COL_REGPLACE).value);
              CL_BIRTHDAY = sheet.cells(row, COL_BIRTHDAY).value;
	      CL_ADRESS = trim(sheet.cells(row, COL_ADRESS).value);
	      CL_JADRESS = trim(sheet.cells(row, COL_JADRESS).value);
	      CL_PHONE = trim(sheet.cells(row, COL_PHONE).value);
	      CL_CODE = trim(sheet.cells(row, COL_CODE).value);
	      CL_QTY = sheet.cells(row, COL_QTY).value;
	      CL_ISIN = sheet.cells(row, COL_ISIN).value;
	      CL_TYPE = sheet.cells(row, COL_TYPE).value;  // 1 - физик,  2 - юрик
	      CL_COUPDATE = sheet.cells(row, COL_COUPDATE).value;

              RowArr(Rec).Source = 1;

	      if (Rec > 0) 
              	RowArr(Rec).Q0 = RowArr(Rec-1).Q0 + 1;
		RowArr(Rec).Q5 = RowArr(Rec-1).Q5 + 1;
	      else
              	RowArr(Rec).Q0 = 1;
              	RowArr(Rec).Q5 = 1;
	      end;

	      RowArr(Rec).Q10  = 4;
	      RowArr(Rec).Q20 = CL_NAME;

 	      cmd2 = RSDCommand("select t_codenum3 REZ from dcountry_dbt where /* upper(trim(t_name)) = upper(trim(?)) or*/  t_codelat2 = trim(?)");
	      cmd2.AddParam( "", RSDBP_IN, CL_COUNTRY );
	      RS2 = TRsbDataSet( cmd2 );
	      IF (RS2.MoveNext)
 		CL_COUNTRY_NUM = RS2.REZ;        
		RowArr(Rec).Q30 = CL_COUNTRY_NUM;
	      end;
              
	      RowArr(Rec).Q40 = CL_JADRESS;
	      RowArr(Rec).Q50 = CL_CODE;
	      RowArr(Rec).Q60 = CL_DOCDATE; //CL_DOCNUM;
	      RowArr(Rec).Q70 = CL_SERIA + " " + CL_DOCNUM;
	      RowArr(Rec).Q80 = RS2.REZ;

	      RowArr(Rec).D10 = 1;
	      RowArr(Rec).D20 = 11;
	      RowArr(Rec).D30 = "";

// 	      cmd2 = RSDCommand("select RSI_RSB_Fiinstr.CalcNKD_Ex( t_fiid, ?, ?, ?)  REZ from davoiriss_Dbt where t_isin=?");
//	      cmd2.AddParam( "", RSDBP_IN, date(CL_COUPDATE) );	  
//	      cmd2.AddParam( "", RSDBP_IN, CL_QTY );
//	      cmd2.AddParam( "", RSDBP_IN, 0 );
//	      cmd2.AddParam( "", RSDBP_IN, CL_ISIN );
//	      cmd2.AddParam( "", RSDBP_IN, 0 );

              cmd2 = RSDCommand("select ? * t_incomevolume rez from dfiwarnts_Dbt where t_fiid=(select t_fiid from davoiriss_Dbt where t_isin=trim(?)) and t_firstdate<=? and t_drawingdate>=?");
	      cmd2.AddParam( "", RSDBP_IN, CL_QTY );
	      cmd2.AddParam( "", RSDBP_IN, CL_ISIN );
	      cmd2.AddParam( "", RSDBP_IN, date(CL_COUPDATE) );	  
	      cmd2.AddParam( "", RSDBP_IN, date(CL_COUPDATE) );	

	      RS2 = TRsbDataSet( cmd2 );
	      IF (RS2.MoveNext)
 		 RowArr(Rec).D40 = RS2.REZ;        
	      end;




	      CL_TAXPROC = 99.99;
	      
   	      RowArr(Rec).D50 = "643";
   	      RowArr(Rec).D60 = CL_COUPDATE;
   	      RowArr(Rec).D70 = CL_TAXPROC;
   	      RowArr(Rec).D80 = "";
   	      RowArr(Rec).D90 = "";
   	      RowArr(Rec).D100 = RS2.REZ; // * CL_TAXPROC/100;
   	      RowArr(Rec).D110 = "";
   	      RowArr(Rec).D120 = "";
   	      RowArr(Rec).D130 = "";
   	      RowArr(Rec).D140 = RowArr(Rec).D100 * CL_TAXPROC;
   	      RowArr(Rec).D150 = "01"; 
   	      RowArr(Rec).D160 = "";
   	      RowArr(Rec).D170 = "Россельхозбанк";
   	      RowArr(Rec).D180 = "7725114488";
   	      RowArr(Rec).D190 = "775001002";


   	      // --- Заполнение раздела 3.3
   	      if (CL_TYPE == 1)
		      Rec2 = RowArr2.size();
		      RowArr2(Rec2) = TRow2();
	
		      RowArr2(Rec2).N2_D0 = "";
		      RowArr2(Rec2).N2_D05 = Rec2+1;
		      RowArr2(Rec2).N2_D010 = 1;
		      RowArr2(Rec2).N2_D020 = 11;
		      RowArr2(Rec2).N2_D030 = "";
		      RowArr2(Rec2).N2_D040 = "";
		      RowArr2(Rec2).N2_D050 = CL_DOCDATE;
		      RowArr2(Rec2).N2_D060 = CL_SERIA + " " + CL_DOCNUM;
		      RowArr2(Rec2).N2_D070 = CL_COUNTRY_NUM;	
		      n_part = CL_NAME;
		      RowArr2(Rec2).N2_D150 = substr(n_part, 1, Index(n_part," ")-1);
		      n_part = substr(n_part, Index(n_part," ")+1, 300 );
		      RowArr2(Rec2).N2_D160 = substr(n_part, 1, Index(n_part," ")-1);
		      n_part = substr(n_part, Index(n_part," ")+1, 300 );
		      RowArr2(Rec2).N2_D170 = n_part;
		      RowArr2(Rec2).N2_D180 = "";
		      RowArr2(Rec2).N2_D190 = CL_BIRTHDAY;
		      RowArr2(Rec2).N2_D200 = CL_COUNTRY_NUM;
		      RowArr2(Rec2).N2_D210 = "";
		      RowArr2(Rec2).N2_D220 = "";
		      RowArr2(Rec2).N2_D230 = "";
		      RowArr2(Rec2).N2_D240 = CL_DOCTYPE;
		      RowArr2(Rec2).N2_D250 = CL_SERIA + " " + CL_DOCNUM;
		      RowArr2(Rec2).N2_D260 = CL_DOCDATE;
		      RowArr2(Rec2).N2_D270 = "";
		      RowArr2(Rec2).N2_D280 = CL_JADRESS;
		      RowArr2(Rec2).N2_D290 = CL_COUNTRY_NUM;
		      RowArr2(Rec2).N2_D300 = CL_PHONE;
	      end;


          end;
      row = row + 1;
   end;

  if (not RemoveFile ("$" + TermPath + "\\" + FileName))
    MsgBox("Ошибка удаления файла " + TermPath + "\\" + FileName);
  end;

  end; // if
  end; // while

  if (valtype(ExcelApplication) != V_UNDEF)
    ExcelApplication.ActiveWorkbook.Close;
  end;

onerror()
  if (valtype(ExcelApplication) != V_UNDEF)
    ExcelApplication.ActiveWorkbook.Close;
  end;
  EndAction(1);
End;