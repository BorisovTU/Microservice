/**
 @file         sec_acts.mac
 @brief     ОТЧЕТ: "АКТЫ СВЕРКИ Ц/Б"(БО)

 # tag
 - functional_block: Отчетность_внутренняя
 - code_type: Report

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |12.02.2024 |Велигжанин А.В.|DEF-60878                                       |во избежание дублей из площадок ДБО нужно выбирать 
 |           |               |                                                | только действующие на дату отчета
 |17.05.2019 |Nikolskaya     |                                                |
*/
IMPORT SecInter, PtInter, "DlRepForm_h.mac", "sprepfun.mac";
IMPORT "or_rep_h.mac", "oralib.mac";
IMPORT "CbLogger.mac";
IMPORT  "scsrvrepfun.mac","DLReport_h.mac", "dlreport.mac";

PRIVATE CONST
     BankAcc   = 0,
     ClientAcc = 1;

PRIVATE CONST CHAPTER_22 = 22;

PRIVATE CONST CATNUM_570 = 570;
PRIVATE CONST CATNUM_580 = 580;

file Sp_ActsTmp( "sp_acts.tmp" ) write;

PRIVATE VAR KDUAcc_flag, stat;
PRIVATE VAR DlSActsRepFormData;
//PRIVATE VAR Rep;
PRIVATE VAR IsDataExists = false;
/*
PRIVATE VAR TableHeader =
"┌────────────────┬─────────────────┬────────────────────┬────────────────┬───────────────┬─────────────────┬────────────────────────┬────────────────────┬──────────────────────┬──────────────────┬──────────────────┬───────────────────┬───────────────────┬──────────────┐\n" +
"│                │                 │                    │                │               │                 │                        │                    │                      │ Остаток по       │ Расхождение      │Расхождение        │Расхождение        │              │\n" +
"│   Код ц/б      │    Эмитент ЦБ   │     Вид ц/б        │     Выпуск     │     Серия     │      Номер      │    Номер л/счета ВУ    │  Остаток по данным │  Остаток по данным   │ данным учетной   │ данных           │данных             │данных             │    Причина   │\n" +                                                                 
"│                │                 │                    │                │               │                 │                        │  внутреннего учета,│ депозитарного учета, │системы бэк-офиса,│ внутреннего учета│внутреннего и      │учётной системы и  │  расхождения │\n" +
"│                │                 │                    │                │               │                 │                        │         шт.        │         шт.          │       шт.        │ и БО             │депозитарного учета│депозитарного учета│              │\n" +
"├────────────────┼─────────────────┼────────────────────┼────────────────┼───────────────┼─────────────────┼────────────────────────┼────────────────────┼──────────────────────┼──────────────────┼──────────────────┼───────────────────┼───────────────────┼──────────────┤";

PRIVATE VAR TableHeaderLite = 
"┌───────────────────────────┬─────────────────────────────────┬─────────┬──────────────────────────────┬───────────────────────┬───────────────────────┬─────────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│                           │                                 │         │                              │                       │                       │                         │                    │  Количество ц/б    │  Количество ц/б по │  Количество ц/б по │   Расхождение      │                    │\n" +
"│    Номер счета клиента    │         Наименование            │ Договор │       Эмитент ц/б            │        Вид ц/б        │    Категория (тип)    │       Наименование      │   Регистрационый   │     по данным      │       данным       │       данным       │                    │       Причина      │\n" +                                                                 
"│                           │           клиента               │         │                              │                       │          ц/б          │           ц/б           │    номер ц/б       │ внутреннего учета, │    депозитарного   │   бухгалтерского   │                    │     расхождения    │\n" +
"│                           │                                 │         │                              │                       │                       │                         │                    │         шт.        │  учета, фактическ. │     учета, шт.     │                    │                    │\n" +
"│                           │                                 │         │                              │                       │                       │                         │                    │                    │  наличие ц/б на    │                    ├──────┬──────┬──────┤                    │\n" +
"│                           │                                 │         │                              │                       │                       │                         │                    │                    │  предъявителя и    │                    │      │      │      │                    │\n" +
"│                           │                                 │         │                              │                       │                       │                         │                    │                    │  ордерных ц/б, шт. │                    │ВУ/ДУ │ДУ/БУ │ВУ/БУ │                    │\n" +
"├───────────────────────────┼─────────────────────────────────┼─────────┼──────────────────────────────┼───────────────────────┼───────────────────────┼─────────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼──────┼──────┼──────┼────────────────────┤";
  */                                                                       
PRIVATE MACRO GetTxtPath()
   var RegistryPath = "BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\TEXTDIR";
   var Path = "";
   var stat = 0;
 
   GetRegistryValue(RegistryPath, V_STRING, Path, stat);
   if(stat) 
      msgbox("Не задана настрйка в реестре банка:|", RegistryPath);      
   end;

   return Path;
END;

PRIVATE MACRO processPath( p_path )
   var l_str, l_p, l_path = "";

   p_path = trim( p_path );

   if( substr( p_path, 1, 2 ) == ".." ) /*Ссылка на вышестоящий каталог */
      p_path = substr( p_path, 3 );

      l_str  = getCWD(false);    
      l_p    = strbrk( l_str, "\\" );
      while( l_p != 0 )
         l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
         l_str  = substr( l_str, l_p + 1 );
         l_p    = strbrk( l_str, "\\" );
      end;
      return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

   elif( substr( p_path, 1, 1 ) == "." ) /* Ссылка на текущий каталог */
      return ( getCWD + substr( p_path, 2 ) );
   end;

   return p_path;
END;

MACRO GetRepFullPath(isRemote:bool)
   var Path = "";

   if(isRemote)
      var txtPath = GetTxtPath();

      if( substr( txtPath, 1, 2 ) == ".." ) /*ссылка на вышестоящий каталог */
         txtPath = substr(txtPath, 3 );
      end;

      if( substr( txtPath, 1, 1 ) == "\\" ) /*ссылка на вышестоящий каталог*/
         txtPath = substr(txtPath, 2 );
      end;

      Path = GetCurDir(true) + "\\" + txtPath + "\\"; 
   else
      Path = processPath(GetTxtPath()) + "\\";
   end;

   // получить полный путь
   return Path;
END;
/***********************************/  

PRIVATE MACRO Subj( ReportKind ):STRING
   if( ReportKind == BankAcc )
      return "банка";
   elif( ReportKind == ClientAcc )
      return "клиентов";
   end;
END;

/**********************************************************************************************************/

PRIVATE MACRO CreateReportByKind( RepKind:integer )

   PRIVATE VAR m_RS, ExistInfo = false, IsPrintHead = true,
               RestVU = 0.0, RestCB = 0.0, RestDep = 0.0, 
               DepoDebet = 0.0, DepoKredit = 0.0, InnerDebet = 0.0, InnerKredit = 0.0, DeltaRest_VU_Dep = 0.0, DeltaRest_CB_Dep = 0.0, DeltaRest_VU_CB = 0.0, 
               m_PrevClient = "", m_PrevContr = "",
               ReportDateBeg = ZeroDate, ReportDateEnd = ZeroDate, IsPeriod = true, IsFirstDate = true;

   PRIVATE MACRO Get_Rep_Name()
      if( RepKind == BankAcc )
         return "Ценные бумаги Банка";
      elif( RepKind == ClientAcc )
         return "Ценные бумаги клиентов";
      end;
   END;

   private macro СохранитьДляОтчета(ClientID, FIID, RestCB, RestDep, Rest, ContrID, Account )
      ClearRecord(Sp_ActsTmp);

      if( ClientID <= 0 )
         ClientID = {OurBank};
      end;

      if( (ContrID == null) or (ContrID <= 0) )
         ContrID = 0;
      end;

      Sp_ActsTmp.ClientID      = ClientID;                                                           
      Sp_ActsTmp.FIID          = FIID;                                                               
      Sp_ActsTmp.RestDep       = RestDep;                                                            
      Sp_ActsTmp.Rest          = Rest;                                                               
      Sp_ActsTmp.RestCB        = RestCB;                                                             
      Sp_ActsTmp.ContrID       = ContrID;                                                            
      Sp_ActsTmp.Account       = Account;                                                            
                                                                                                           
      InsertRecTempFile( Sp_ActsTmp );                                                                                               
   end;                                                                                                  

   private macro ЕстьЗапись(ClientID, ContrID, FIID)
      var SqlQuery, SqlData;
      
      ClearRecord(Sp_ActsTmp);
        
      if( ClientID <= 0 )
         ClientID = {OurBank};
      end;

      if( (ContrID == null) or (ContrID <= 0) )
         ContrID = 0;
      end;

      SqlQuery   = RSDCommand("select count(1) NRec from dsp_acts_tmp "+
                              " where t_ClientID = ? " +
                              "   and t_FIID = ? and rownum = 1 " + /*PNV i-support 502007*/
                              IIF((ContrID!=null)and(ContrID>0)," and t_ContrID = "+string(ContrID),"")+
                              "order by t_ClientID, t_FIID");
        
      SqlQuery.addParam( "", RSDBP_IN, ClientID );
      SqlQuery.addParam( "", RSDBP_IN, FIID );
      SqlQuery.execute();
        
      SqlData = TRsbDataSet(SqlQuery);
        
      if( SqlData.MoveNext() )
         if( SqlData.NRec > 0 )
            return true;
         end;
      end;
        
      return false;
   end;                                                                                                  

   private macro СохранитьОстаткиБОЦБ(ClientID_, ContrID_, FIID, RestCB )
      var IsUpd = false, ClientID = ClientID_, ContrID = ContrID_, sqltmp;

      if( ClientID == -1 )
         ClientID = {OurBank};
      end;

      if( (ContrID == null) or (ContrID <= 0) )
         ContrID = 0;
      end;

      if( ЕстьЗапись(ClientID, ContrID, FIID) )
         sqltmp = "UPDATE dsp_acts_tmp Sp_ActsTmp SET "
                  "                                   Sp_ActsTmp.t_RestCB        =Sp_ActsTmp.t_RestCB + ? " +                                                            
                  "               where Sp_ActsTmp.t_FIID = ? and Sp_ActsTmp.t_ContrID = ? and Sp_ActsTmp.t_ClientID = ? ";
         execSQL( sqltmp, makeArray( SQLParam("", RestCB),  SQLParam("", FIID), SQLParam("", ContrID), SQLParam("", ClientID)));
      end;
   end;                                                                                                  

   private macro СохранитьОстаткиДЕПО(ClientID, FIID, RestDep, rest, contrid) /*PNV i-support 502007*/
      var IsUpd = false, sqltmp; 
       
      if( ЕстьЗапись(ClientID, contrid, FIID ) ) /*PNV i-support 502007*/
         sqltmp = " UPDATE dsp_acts_tmp Sp_ActsTmp SET "
                  "       Sp_ActsTmp.t_RestDep = Sp_ActsTmp.t_RestDep + ? " +                                                            
                  "  where Sp_ActsTmp.t_FIID = ? and Sp_ActsTmp.t_ContrID = ? and Sp_ActsTmp.t_ClientID = ? ";
         execSQL( sqltmp, makeArray( SQLParam("", RestDep),  SQLParam("", FIID), SQLParam("", ContrID), SQLParam("", ClientID)));
         IsUpd = true;
         /*PNV i-support 502007*/
      end;
        
      if( not IsUpd )
         СохранитьДляОтчета(ClientID, FIID, 0, RestDep, 0, contrid, ""); /*PNV i-support 502007*/
      end;
   end;                                                                                                  

   private macro СохранитьОстаткиВУ(ClientID_, FIID, Rest, ContrID, Account )
      return СохранитьДляОтчета(ClientID_, FIID, 0, 0, Rest, ContrID, Account);
   end; 

   PRIVATE MACRO СобратьДанныеВУ(Department)
      var Num = 0, Rep_Name = Get_Rep_Name();
      var m_SqlTxt = null, m_SqlDias, m_SqlData = null, m_RsdSqL = null, m_SqlNRec = null, m_SqlNRecData = 0;

      m_SqlTxt =  "select inacc.t_Account, inacc.T_CURRENCY FIID, inacc.t_Owner ClientID, inacc.t_ClientContrID ContrID, "+
                  "       RSB_ACCOUNT.RESTAC(inacc.T_ACCOUNT,inacc.T_CURRENCY,?,?, null) rest_ac "+
                  " from( "+
                  "      select mc.t_Account, MC.T_CURRENCY, mc.t_Owner, mc.t_ClientContrID "+ 
                  "        from dmcaccdoc_dbt mc, dfininstr_dbt fin, davrkinds_dbt avrkind "+
                  "        from dmcaccdoc_dbt mc inner join dfininstr_dbt fin on  "+
                  "          RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, case when ? = -1 then fin.t_AvoirKind else ? end, fin.t_AvoirKind) = 1 "+
                  "                              inner join   davrkinds_dbt avrkind  on"+            
                  "                                                         avrkind.t_Fi_Kind = ? "+
                  "                                                     and avrkind.t_IsEmissive = 'X' "+
                  "                                                     and fin.t_AvoirKind = avrkind.t_AvoirKind "+
                  "                                                     and fin.t_Fi_Kind   = avrkind.t_Fi_Kind "
                  "       where mc.t_Chapter      = ? "+
                  "         and mc.t_CatNum       = ? "+
                  "         and mc.t_Currency     = (case when(? = -1) then mc.t_Currency else ? end) "+ 
                  "         and mc.t_DepartmentID = ? "+
                  "         and mc.t_Currency     = fin.t_FIID "+
                  "         and RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, case when ? = -1 then fin.t_AvoirKind else ? end, fin.t_AvoirKind) = 1 "+ //
                  "         and avrkind.t_Fi_Kind = ? "+                                                                                           //
                  "         and avrkind.t_IsEmissive = 'X' "+                                                                                      //
                  "         and fin.t_AvoirKind = avrkind.t_AvoirKind "+                                                                           //
                  "         and fin.t_Fi_Kind   = avrkind.t_Fi_Kind ";
      if ( DlSActsRepFormData.IssuerCode > 0 )
         m_SqlTxt = m_SqlTxt +  "and RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) = ? ";
      end;

      m_SqlTxt = m_SqlTxt + " and mc.t_Owner = (case when(? = -1 or mc.t_CatNum = ?) then mc.t_Owner else ? end) "+ 
                     "        and mc.t_ClientContrID = (case when(? = -1 or mc.t_CatNum = ?) then mc.t_ClientContrID else ? end) "+
                     "        and exists( select acc$.* "+
                     "                      from daccount_dbt acc$ "+
                     "                     where acc$.t_Chapter = mc.t_Chapter "+
                     "                       and acc$.t_Account = mc.t_Account "+
                     "                       and acc$.t_Code_Currency = mc.t_Currency "+
                     "                       and (acc$.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') or acc$.t_Close_Date >= ?) "+
                     "                       and acc$.t_Open_Date < ? "+ 
                     "                  ) ";

      if( RepKind == ClientAcc )
         m_SqlTxt = m_SqlTxt +
                     "         and case when ( mc.t_Owner > 0 ) then NVL((select count(1) "+
                     "                                                      from dclient_dbt client "+
                     "                                                     where client.t_PartyID = mc.t_Owner "+
                     "                                                       and client.t_ServiceKind = ? "+
                     "                                                       and client.t_Department  = mc.t_DepartmentID "+
                     "                                                       and client.t_Branch = 0 "+
                     "                                            ),0) else 1 end > 0 "+
                     "         and NVL((select sfcontr.t_ServKind "+
                     "                    from dsfcontr_dbt sfcontr "+
                     "                   where sfcontr.t_ID = mc.t_ClientContrID ),0) = ? "+
                     "         and mc.t_Owner > 0 "+
                     "         and mc.t_Owner != ? ";
      end;

      m_SqlTxt = m_SqlTxt +
                     "        group by mc.t_Owner, mc.t_ClientContrID, MC.T_CURRENCY, mc.t_Account "+
                     "     ) inacc "+
                     " order by inacc.t_Owner, inacc.t_ClientContrID ";

      m_RsdSqL = RSDCommand("select count(1) nRecs from(" + m_SqlTxt + ")");

      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
      m_RsdSqL.addParam( "", RSDBP_IN, CHAPTER_22 );
      m_RsdSqL.addParam( "", RSDBP_IN, CHAPTER_22 );
      m_RsdSqL.addParam( "", RSDBP_IN, IIF(RepKind == BankAcc, CATNUM_570, CATNUM_580) );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      m_RsdSqL.addParam( "", RSDBP_IN, Department );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      m_RsdSqL.addParam( "", RSDBP_IN, FIKIND_AVOIRISS );       
        
      if ( DlSActsRepFormData.IssuerCode > 0 )
         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
      end;                                                                       
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
      m_RsdSqL.addParam( "", RSDBP_IN, CATNUM_570);
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
      m_RsdSqL.addParam( "", RSDBP_IN, CATNUM_570 );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
      m_RsdSqL.addParam( "", RSDBP_IN, ReportDateBeg );
      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
      if( RepKind == ClientAcc )
         m_RsdSqL.addParam( "", RSDBP_IN, PTSK_STOCKDL );
         m_RsdSqL.addParam( "", RSDBP_IN, PTSK_STOCKDL );
         m_RsdSqL.addParam( "", RSDBP_IN, {OurBank} );
      end;
      m_RsdSqL.execute();
      m_SqlNRec = TRsbDataSet(m_RsdSqL);
      if(m_SqlNRec.MoveNext())
         m_SqlNRecData = int(m_SqlNRec.nRecs);
      end;

      if(m_SqlNRecData >= 0)

         m_RsdSqL = RSDCommand(m_SqlTxt);

         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1  );
         m_RsdSqL.addParam( "", RSDBP_IN, CHAPTER_22 );
         m_RsdSqL.addParam( "", RSDBP_IN, CHAPTER_22 );
         m_RsdSqL.addParam( "", RSDBP_IN, IIF(RepKind == BankAcc, CATNUM_570, CATNUM_580) );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
         m_RsdSqL.addParam( "", RSDBP_IN, Department );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
         m_RsdSqL.addParam( "", RSDBP_IN, FIKIND_AVOIRISS );
         if ( DlSActsRepFormData.IssuerCode > 0 )
            m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
            m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
         end;      
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
         m_RsdSqL.addParam( "", RSDBP_IN, CATNUM_570);
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
         m_RsdSqL.addParam( "", RSDBP_IN, CATNUM_570 );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
         m_RsdSqL.addParam( "", RSDBP_IN, ReportDateBeg );
         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
         if( RepKind == ClientAcc )
            m_RsdSqL.addParam( "", RSDBP_IN, PTSK_STOCKDL );
            m_RsdSqL.addParam( "", RSDBP_IN, PTSK_STOCKDL );
            m_RsdSqL.addParam( "", RSDBP_IN, {OurBank} );
         end;
         m_RsdSqL.execute();

         m_SqlData = TRsbDataSet(m_RsdSqL);
         InitProgress( m_SqlNRecData, Rep_Name, "Просмотр данных ВУ об остатках ценных бумаг..." );
         while( m_SqlData.MoveNext() )
            /*сохранить все записи независимо от остатка на счете*/
            СохранитьОстаткиВУ(m_SqlData.ClientID, m_SqlData.FIID, SQL_ConvType(m_SqlData.rest_ac), m_SqlData.ContrID, m_SqlData.Account );
            Num = Num + 1;
            UseProgress( Num );
         end;
         RemProgress();
      end;
   END;

   PRIVATE MACRO cl_СобратьДанныеВУ()
      var m_RsdSqL;

      begaction(0, "Сбор данных ВУ");

      LogIt("Сбор данных ВУ");
      LogIt("DlSActsRepFormData.ClientCode: "+string(DlSActsRepFormData.ClientCode));
      LogIt("DlSActsRepFormData.IsPeriod: "+string(IIF(IsPeriod,1,0)));
      LogIt("ReportDateEnd: "+string(ReportDateEnd));
      LogIt("ReportDateBeg: "+string(ReportDateBeg));
      LogIt("DlSActsRepFormData.AvrCode: "+string(DlSActsRepFormData.AvrCode));
      LogIt("DlSActsRepFormData.IssuerCode: "+string(DlSActsRepFormData.IssuerCode));
      LogIt("DlSActsRepFormData.AvrKind: "+string(DlSActsRepFormData.AvrKind));

      m_RsdSqL = RSDCommand("{call sec_cl_blnc_reconc_utl.cl_GatherDataInnerAccounting(?,?,?,?,?,?,?,?,?)}");
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode ); 
      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,1,0) );
      m_RsdSqL.addParam( "", RSDBP_IN, ReportDateEnd );
      m_RsdSqL.addParam( "", RSDBP_IN, ReportDateBeg );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
      m_RsdSqL.addParam( "", RSDBP_IN, {OurBank} );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
      m_RsdSqL.execute();
      endaction(0);
   END;

   /*Пользовательская функция объединяющая СобратьПоТекЛотам и СобратьПоИсторЛотам*/
   /*Реализована только для клиентских отчетов*/
   PRIVATE MACRO cl_СобратьПоЛотам(Department)
      begaction(0, "Сбор данных по лотам");

      LogIt("Сбор данных по лотам");
      LogIt("DlSActsRepFormData.AvrKind: "+string(DlSActsRepFormData.AvrKind));
      //LogIt("Department: "+string(Department));
      LogIt("DlSActsRepFormData.ClientCode: "+string(DlSActsRepFormData.ClientCode));
      LogIt("ReportDateBeg: "+string(ReportDateBeg));
      LogIt("IIF(IsPeriod,ReportDateEnd - 1,ReportDateBeg): "+string(IIF(IsPeriod,ReportDateEnd - 1,ReportDateBeg)));
      LogIt("DlSActsRepFormData.NumContr: "+string(DlSActsRepFormData.NumContr));
      LogIt("DlSActsRepFormData.AvrCode: "+string(DlSActsRepFormData.AvrCode));

      var m_RsdSqL = RSDCommand("{call sec_cl_blnc_reconc_utl.cl_GatherLots(?,?,?,?,?,?,?)}");
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      m_RsdSqL.addParam( "", RSDBP_IN, Department );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
      m_RsdSqL.addParam( "", RSDBP_IN, ReportDateBeg );
      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd - 1,ReportDateBeg) );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );

      m_RsdSqL.Execute();
      endaction(0);
   END;

   PRIVATE MACRO cl_СобратьДанныеДЕПО()
      var sqlQuery:string = "";
      var m_RsdSqL = null;
    
      sqlQuery = string(
                 "begin \n"
                ,"  sec_cl_blnc_reconc_utl.fill_buf_by_depo_data(p_date       => :1, \n"    
                ,"                                               p_partyid    => :2, \n"       
                ,"                                               p_fiid       => :3, \n"    
                ,"                                               p_issuer     => :4, \n"      
                ,"                                               p_avoirkind  => :5, \n"      
                ,"                                               p_contractid => :6); \n"
                ,"  commit; \n"
                ,"end; \n"
                );

      m_RsdSqL = RSDCommand(sqlQuery);
      m_RsdSqL.addParam("", rsdbp_in, IIF(IsPeriod,DlSActsRepFormData.EndDate,DlSActsRepFormData.BeginDate)); //1
      m_RsdSqL.addParam("", rsdbp_in, DlSActsRepFormData.ClientCode ); //2
      m_RsdSqL.addParam("", rsdbp_in, DlSActsRepFormData.AvrCode ); //3
      m_RsdSqL.addParam("", rsdbp_in, DlSActsRepFormData.IssuerCode ); //4
      m_RsdSqL.addParam("", rsdbp_in, DlSActsRepFormData.AvrKind ); //5
      m_RsdSqL.addParam("", rsdbp_in, DlSActsRepFormData.NumContr ); //6

      Message(" Сбор данных Диасофт.");
      BegAction(0, " Сбор данных Диасофт.");

      m_RsdSqL.execute();

      sqlQuery = string(
                 "begin \n"
                ,"  sec_cl_blnc_reconc_utl.extend_buf_by_spec_depo_data(p_date => :1); \n"
                ,"  commit; \n"
                ,"end; \n"
                );

      m_RsdSqL = RSDCommand(sqlQuery);
      m_RsdSqL.addParam("", rsdbp_in, IIF(IsPeriod,DlSActsRepFormData.EndDate,DlSActsRepFormData.BeginDate));

      Message(" Сбор данных спец. депо.");
      BegAction(0, " Сбор данных спец. депо.");

      m_RsdSqL.execute();
      EndAction(0);
   END; //cl_СобратьДанныеДЕПО


   PRIVATE MACRO СобратьДанныеДЕПО_user()
      GetRegistryValue("SECUR\\ВЕДЕНИЕ КДУ", v_bool, KDUAcc_flag, stat);

      var m_SqlTxt = null, m_sqlDias, m_SqlData = null, m_RsdSqL = null, m_SqlNRec = null, m_SqlNRecData = 0;
      var Num = 0, Rep_Name = Get_Rep_Name(); /*PNV i-support 502007*/

      /*DAN*/
      m_sqlDias = "with rest as " +
                " (select r.\* " +
                "    from (select DENSE_RANK() OVER(PARTITION BY v1.deponumber, v1.accdeponumber, v1.contractnumber, v1.isin ORDER BY v1.deponumber, v1.accdeponumber, v1.contractnumber, v1.isin, v1.acc_recid desc) as drank, v1.\* " +
                "            from v_diasdeporest v1 " +
                "           where v1.REPORTDATE = ? " +
                "             AND v1.REALREPORTDATE >= ? " +
                "           order by v1.deponumber, v1.accdeponumber, v1.contractnumber, v1.isin, v1.acc_recid asc) r " +
                "   where r.drank = 1) " +
                " " +
                "SELECT distinct DBO.T_PARTYID as CLIENT, NVL(AVR.T_FIID, -1) T_FIID, " +
                "                rest.VALUE as rest_ac, CONTR.T_SFCONTRID, rest.\* " +
                "  FROM rest " +
                "  LEFT JOIN dsfcontr_dbt dbo " +
                "    ON rest.CONTRACTNUMBER = DBO.T_NUMBER " +
                "  LEFT JOIN davoiriss_dbt avr " +
                "    ON rest.isin = avr.t_isin " +
                "  LEFT JOIN DDLCONTR_DBT con " +
                "    ON con.T_SFCONTRID = DBO.T_ID " +
                "  LEFT JOIN ddlcontrmp_dbt contr " +
                "    ON contr.T_dlCONTRID = con.T_dlCONTRID " +
                "  LEFT JOIN dnotetext_dbt note107 " +
                "    ON LPAD(con.T_dlCONTRID, 34, 0) = note107.t_documentid " +
                "   AND NOTE107.t_objecttype = 207 AND NOTE107.t_notekind IN (107) " +
                "  LEFT JOIN dnotetext_dbt note104 " +
                "    ON LPAD(con.T_dlCONTRID, 34, 0) = note104.t_documentid " +
                "   AND NOTE104.t_objecttype = 207 AND NOTE104.t_notekind IN (104) " +

                "  LEFT JOIN dnotetext_dbt note106 " +
                "    ON LPAD(con.T_dlCONTRID, 34, 0) = note106.t_documentid " +
                "   AND NOTE106.t_objecttype = 207 AND NOTE106.t_notekind IN (106) " +

                "  LEFT JOIN dnotetext_dbt note115 " +
                "    ON LPAD(con.T_dlCONTRID, 34, 0) = note115.t_documentid " +
                "   AND NOTE115.t_objecttype = 207 AND NOTE115.t_notekind IN (115) " +

                "  LEFT JOIN dnotetext_dbt note101 " +
                "    ON LPAD(con.T_dlCONTRID, 34, 0) = note101.t_documentid " +
                "   AND NOTE101.t_objecttype = 207 AND NOTE101.t_notekind IN (101) " +
                "  LEFT JOIN dsfcontr_dbt sfsubcontr " +
                "    ON SFSUBCONTR.T_ID = CONTR.T_SFCONTRID " +

                "  left join ddlcontrmp_dbt mp on mp.t_sfcontrid = SFSUBCONTR.T_ID   " +

                " WHERE rest.VALUE > 0 " +
                "   and rest.accDEPONUMBER = case when sfsubcontr.t_servkindsub = 8 then " +
                "                                                             REPLACE(UTL_RAW.cast_to_varchar2(note104.t_text), CHR(0)) " +
                "                                                     else " +
                "                                                             NVL(REPLACE(UTL_RAW.cast_to_varchar2(note101.t_text), chr(0)),REPLACE(UTL_RAW.cast_to_varchar2(note107.t_text), CHR(0))) " +
                "                                             end " +
                "   AND DBO.T_PARTYID = (CASE WHEN ? = -1 THEN DBO.T_PARTYID ELSE ? END) " +

                "   AND rest.sectioncode = case when sfsubcontr.t_servkindsub = 8 and mp.t_marketid = 2 then REPLACE(UTL_RAW.cast_to_varchar2(note106.t_text), CHR(0)) " +
                "   when sfsubcontr.t_servkindsub = 8 and mp.t_marketid = 151337 then REPLACE(UTL_RAW.cast_to_varchar2(note115.t_text), CHR(0))                        " +
                "     else rest.sectioncode end                                                                                                                        " +
                "   and SFSUBCONTR.T_SERVKIND = 1 " ;

      m_RsdSqL = RSDCommand("select count(1) nRecs from(" +  m_sqlDias + ")");
      m_RsdSqL.addParam("",rsdbp_in, IIF(IsPeriod,DlSActsRepFormData.EndDate,DlSActsRepFormData.BeginDate) );
      m_RsdSqL.addParam("",rsdbp_in, IIF(IsPeriod,DlSActsRepFormData.EndDate,DlSActsRepFormData.BeginDate) );
      m_RsdSqL.addParam("",rsdbp_in, DlSActsRepFormData.ClientCode );
      m_RsdSqL.addParam("",rsdbp_in, DlSActsRepFormData.ClientCode );
      m_RsdSqL.execute();
      m_SqlNRec = TRsbDataSet(m_RsdSqL);
      if(m_SqlNRec.MoveNext())
         m_SqlNRecData = int(m_SqlNRec.nRecs);
      end;

      m_RsdSqL = RSDCommand(m_sqlDias);
      m_RsdSqL.addParam("",rsdbp_in, IIF(IsPeriod,DlSActsRepFormData.EndDate,DlSActsRepFormData.BeginDate) );
      m_RsdSqL.addParam("",rsdbp_in, IIF(IsPeriod,DlSActsRepFormData.EndDate,DlSActsRepFormData.BeginDate) );
      m_RsdSqL.addParam("",rsdbp_in, DlSActsRepFormData.ClientCode );
      m_RsdSqL.addParam("",rsdbp_in, DlSActsRepFormData.ClientCode );
      m_RsdSqL.execute();
      m_SqlData = TRsbDataSet(m_RsdSqL);

      InitProgress( m_SqlNRecData, Rep_Name, "Просмотр данных ДЕПО об остатках ценных бумаг..." );
      while( m_SqlData.MoveNext() )
         СохранитьОстаткиДЕПО(m_SqlData.CLIENT, m_SqlData.FIID, SQL_ConvType(m_SqlData.rest_ac), 0,  m_SqlData.SFCONTRID );
         Num = Num + 1;
         UseProgress( Num );
      end;
      RemProgress();
      /*PNV i-support 502007*/
   END;

   PRIVATE MACRO СобратьПоТекЛотам(Department)
      var Num = 0, Rep_Name = Get_Rep_Name();
      var m_SqlTxt = null, m_SqlData = null, m_RsdSqL = null, m_SqlNRec = null, m_SqlNRecData = 0;

      /*если не паи, то кол-во округляем до целого по правилам округления, причем для каждого лота*/
      if( RepKind == BankAcc)
         m_SqlTxt =  "SELECT NVL(SUM( case when fin.t_AvoirKind != ? "+
                     "                then round(WRTSUM.t_Amount,0) "+
                     "                else WRTSUM.t_Amount end ), 0) am, WRTSUM.t_fiid, WRTSUM.t_party, WRTSUM.t_CONTRACT "+
                     "  FROM DPMWRTSUM_DBT WRTSUM, dfininstr_dbt fin "+
                     " WHERE WRTSUM.t_Department = ? " +     
                     "  AND WRTSUM.t_Party = -1 "+
                     "   AND WRTSUM.t_Portfolio = case when ? = -1 then WRTSUM.t_Portfolio else ? end "+
                     "   AND WRTSUM.t_Trust  = chr(0) "+
                     "   AND WRTSUM.t_Buy_Sale  in (?,?) "+
                     "   AND WRTSUM.T_CHANGEDATE <= ? "+ 
                     "   AND WRTSUM.t_State = ? "+              
                     "   AND WRTSUM.t_CONTRACT = case when ? = -1 then WRTSUM.t_CONTRACT else ? end "+ 
                     "   AND WRTSUM.t_Amount > 0 "+
                     "   and fin.t_fiid = WRTSUM.t_fiid "+
                     "   and RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, case when ? = -1 then fin.t_AvoirKind else ? end, fin.t_AvoirKind) = 1 ";
         if( DlSActsRepFormData.IssuerCode > 0 )
            m_SqlTxt = m_SqlTxt + "and RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) = ? ";
         end;
         m_SqlTxt = m_SqlTxt + "   and fin.t_FIID   = case when ? = -1 then fin.t_FIID else ? end "+
                    " group by WRTSUM.t_party, WRTSUM.t_CONTRACT, WRTSUM.t_fiid";
      else
         m_SqlTxt = "WITH mindate AS( " +
                    "  SELECT max(t_enddate) t_enddate," +    
                    "         t_fiid, t_party, t_contract, t_department "+
                    "  FROM dpmwrtcl_dbt m "+
                    "  WHERE m.t_department = ? " +
                    "    AND m.t_party = CASE WHEN ? = -1 THEN m.t_party  ELSE ?  END "+   
                    "    AND m.t_begdate <= ? " +
                    "    AND m.t_enddate = TO_DATE ('31-12-9999', 'DD-MM-YYYY') " +
                    "    AND m.t_contract = CASE  WHEN ? = -1 THEN m.t_contract  ELSE ? END "+
                    " GROUP BY t_fiid, t_party, t_contract, t_department)"+

                    " SELECT  NVL ( CASE WHEN  fin.t_avoirkind != ?"
                    "                    THEN ROUND (RSB_PMWRTOFF.WRTGetAmountByClient( c.t_department, c.t_fiid, c.t_party, "+
                    "                                                                   c.t_contract,   md.t_enddate ), 0) " +
                    "                    ELSE RSB_PMWRTOFF.WRTGetAmountByClient( c.t_department, c.t_fiid, c.t_party," +  
                    "                                                            c.t_contract,  md.t_enddate ) " +
                    "               END, 0 ) am,"+
                    "         c.t_fiid, c.t_party, c.t_contract "+
                    " FROM dpmwrtcl_dbt c, dfininstr_dbt fin, mindate md "+
                    " WHERE c.t_department = md.t_department " +
                    "   AND c.t_party = md.t_party " + 
                    "   AND c.t_enddate = md.t_enddate " +
                    "   AND c.t_fiid = md.t_fiid " +
                    "   AND fin.t_fiid = c.t_fiid " +
                    "   AND c.t_contract = md.t_contract " +
                    "   AND rsb_fiinstr.fi_avrkindseq (fin.t_fi_kind, CASE  WHEN ? = -1 THEN fin.t_avoirkind  ELSE ? END, fin.t_avoirkind ) = 1 ";
         if( DlSActsRepFormData.IssuerCode > 0 )
            m_SqlTxt = m_SqlTxt +  "and fin.t_Issuer = RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) ";
         end;
         m_SqlTxt = m_SqlTxt + "   AND fin.t_fiid = CASE WHEN ? = -1  THEN fin.t_fiid  ELSE ? END" ;
      end;

      m_RsdSqL = RSDCommand("select count(1) nRecs from(" + m_SqlTxt + ")");

      if( RepKind == BankAcc) 
         m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
      end;

      m_RsdSqL.addParam( "", RSDBP_IN, Department );

      if( RepKind != BankAcc)
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
      end;

      if( RepKind == BankAcc )
         m_RsdSqL.addParam( "", RSDBP_IN, -1 );
         m_RsdSqL.addParam( "", RSDBP_IN, -1 );
         m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
         m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY_BO );
      end;

      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );

      if( RepKind == BankAcc )
        m_RsdSqL.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
      end;   

      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );

      if( RepKind != BankAcc) 
         m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
      end;

      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      if ( DlSActsRepFormData.IssuerCode > 0 )
         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
      end;
       
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );

      m_RsdSqL.execute();

      m_SqlNRec = TRsbDataSet(m_RsdSqL);
      if(m_SqlNRec.MoveNext())
         m_SqlNRecData = int(m_SqlNRec.nRecs);
      end;

      if(m_SqlNRecData > 0)

         m_RsdSqL = RSDCommand(m_SqlTxt); 

         if( RepKind == BankAcc) 
            m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
         end;

         m_RsdSqL.addParam( "", RSDBP_IN, Department );
           
         if( RepKind != BankAcc)
            m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
            m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
         end;
           
         if( RepKind == BankAcc )
            m_RsdSqL.addParam( "", RSDBP_IN, -1 );
            m_RsdSqL.addParam( "", RSDBP_IN, -1 );
            m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
            m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY_BO );
         end;

         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
       
         if( RepKind == BankAcc )
            m_RsdSqL.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
         end;   

         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );

         if( RepKind != BankAcc) 
            m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
         end;

         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
         if ( DlSActsRepFormData.IssuerCode > 0 )
            m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
            m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
         end;
    
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );

         var t_rs = RSDCommand();
         t_rs = m_RsdSqL;
         t_rs = RSDREcordset(m_RsdSqL, rsdval_client, rsdval_static);

         m_RsdSqL.execute();

         m_SqlData = TRsbDataSet(m_RsdSqL);  
         InitProgress( m_SqlNRecData, Rep_Name, "Просмотр данных БОЦБ об остатках ценных бумаг ..." );
         while( m_SqlData.MoveNext() )
            СохранитьОстаткиБОЦБ(m_SqlData.Party, m_SqlData.Contract, m_SqlData.FIID, SQL_ConvType(m_SqlData.Am) );
            Num = Num + 1;
            UseProgress( Num );
         end;
         RemProgress();
      end;
   END;

   PRIVATE MACRO СобратьПоИсторЛотам(Department)
      var Num = 0, Rep_Name = Get_Rep_Name();
      var m_SqlTxt = null, m_SqlData = null, m_RsdSqL = null, m_SqlNRec = null, m_SqlNRecData = 0;
     
      /*если не паи, то кол-во округляем до целого по правилам округления, причем для каждого лота*/
      if( RepKind == BankAcc)
         m_SqlTxt ="SELECT NVL(SUM( case when fin.t_AvoirKind != ? "+
                     "                then round(B.t_Amount,0) "+
                     "                else B.t_Amount end ), 0) am, L.t_FIID , L.t_Party, L.t_CONTRACT "+
                     "  FROM DPMWRTSUM_DBT L, DPMWRTBC_DBT B, dfininstr_dbt fin "+
                       " WHERE  L.t_Department = ? "+
                       "   AND L.t_Party = -1 "+
                     "   AND B.t_Portfolio = case when ? = -1 then B.t_Portfolio else ? end "+
                     "   AND L.t_Trust  = chr(0) "+
                     "   AND L.t_Buy_Sale  in (?,?) "+
                     "   AND L.T_CHANGEDATE > ? "+ 
                     "   AND L.T_EnterDate  <= ? "+
                     "   AND B.t_State = ? "+              
                       "   and L.t_CONTRACT = case when ? = -1 then L.t_CONTRACT else ? end "+
                     "   AND B.T_SUMID  = L.T_SUMID "+
                     "   and fin.t_fiid = L.t_FIID "+
                     "   and RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, case when ? = -1 then fin.t_AvoirKind else ? end, fin.t_AvoirKind) = 1 ";
         if ( DlSActsRepFormData.IssuerCode > 0 )
           m_SqlTxt = m_SqlTxt +  "and RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) = ? ";
         end;
       
         m_SqlTxt = m_SqlTxt +      
                     "   and fin.t_FIID   = case when ? = -1 then fin.t_FIID else ? end "+
                     "   AND B.T_INSTANCE = ( SELECT MAX(M.T_INSTANCE) "+
                     "                          FROM DPMWRTBC_DBT M "+
                     "                         WHERE M.T_CHANGEDATE <= ? "+
                     "                           AND M.T_SUMID      = L.T_SUMID "+
                     "                      ) "+
                     " group by L.t_FIID, L.t_Party, L.t_CONTRACT";
      else
         m_SqlTxt ="WITH mindate AS( " +
                   "  SELECT min(t_begdate) t_begdate," +    
                   "         t_fiid, t_party, t_contract, t_department "+
                   "   FROM dpmwrtcl_dbt m "+
                   "  WHERE m.t_department = ? " +
                   "    AND m.t_party = CASE WHEN ? = -1 THEN m.t_party  ELSE ?  END "+   
                   "    AND m.t_begdate <= ? " +
                   "    AND m.t_enddate >= ? " +
                   "    AND m.t_enddate != TO_DATE ('31-12-9999', 'DD-MM-YYYY') " +
                   "    AND m.t_contract = CASE  WHEN ? = -1 THEN m.t_contract  ELSE ? END "+
                   " GROUP BY t_fiid, t_party, t_contract, t_department)"+
        
                   " SELECT  NVL ( CASE WHEN  fin.t_avoirkind != ?"
                   "                    THEN ROUND (RSB_PMWRTOFF.WRTGetAmountByClient( c.t_department, c.t_fiid, c.t_party, "+
                   "                                                                   c.t_contract,   md.t_begdate ), 0) " +
                   "                    ELSE RSB_PMWRTOFF.WRTGetAmountByClient( c.t_department, c.t_fiid, c.t_party," +  
                   "                                                            c.t_contract,  md.t_begdate ) " +
                   "               END, 0 ) am,"+
                   "         c.t_fiid, c.t_party, c.t_contract "+
                   "  FROM dpmwrtcl_dbt c, dfininstr_dbt fin, mindate md "+
                   " WHERE c.t_department = md.t_department " +
                   "   AND c.t_party = md.t_party " + 
                   "   AND c.t_begdate = md.t_begdate " +    
                   "   AND c.t_fiid = md.t_fiid " + 
                   "   AND fin.t_fiid = c.t_fiid " +
                   "   AND c.t_contract = md.t_contract " +
                   "   AND rsb_fiinstr.fi_avrkindseq (fin.t_fi_kind, CASE  WHEN ? = -1 THEN fin.t_avoirkind  ELSE ? END, fin.t_avoirkind ) = 1 ";
         if ( DlSActsRepFormData.IssuerCode > 0 )
           m_SqlTxt = m_SqlTxt +  "and RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) = ? ";
         end;
         
         m_SqlTxt = m_SqlTxt + "   AND fin.t_fiid = CASE WHEN ? = -1  THEN fin.t_fiid  ELSE ? END" ;
      end;

      m_RsdSqL = RSDCommand("select count(1) nRecs from(" + m_SqlTxt + ")");

      if( RepKind == BankAcc) 
         m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
      end;

      m_RsdSqL.addParam( "", RSDBP_IN, Department );

      if( RepKind != BankAcc)
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
      end;

      if( RepKind == BankAcc )
         m_RsdSqL.addParam( "", RSDBP_IN, -1 );
         m_RsdSqL.addParam( "", RSDBP_IN, -1 );
         m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
         m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY_BO );
      end;

      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
      m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
     
      if( RepKind == BankAcc )
         m_RsdSqL.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
      end;   

      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );

      if( RepKind != BankAcc) 
        m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
      end;

      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );

      if ( DlSActsRepFormData.IssuerCode > 0 )
        m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
        m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
      end;      
    
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      
      if( RepKind == BankAcc)
         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
      end;

      m_RsdSqL.execute();
      m_SqlNRec = TRsbDataSet(m_RsdSqL);

      if(m_SqlNRec.MoveNext())
         m_SqlNRecData = int(m_SqlNRec.nRecs);
      end;

      if(m_SqlNRecData > 0)

         m_RsdSqL = RSDCommand(m_SqlTxt);

         if( RepKind == BankAcc) 
            m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
         end;

         m_RsdSqL.addParam( "", RSDBP_IN, Department );
         
         if( RepKind != BankAcc)
            m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
            m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.ClientCode );
         end;
         
         if( RepKind == BankAcc )
            m_RsdSqL.addParam( "", RSDBP_IN, -1 );
            m_RsdSqL.addParam( "", RSDBP_IN, -1 );
            m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
            m_RsdSqL.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY_BO );
         end;

         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
         m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
     
         if( RepKind == BankAcc )
            m_RsdSqL.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
         end;   

         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.NumContr );

         if( RepKind != BankAcc) 
            m_RsdSqL.addParam( "", RSDBP_IN, AVOIRISSKIND_INVESTMENT_SHARE );
         end;

         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrKind );
         if ( DlSActsRepFormData.IssuerCode > 0 )
           m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg) );
           m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.IssuerCode );
         end;
    
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
         m_RsdSqL.addParam( "", RSDBP_IN, DlSActsRepFormData.AvrCode );
      
         if( RepKind == BankAcc)
            m_RsdSqL.addParam( "", RSDBP_IN, IIF(IsPeriod,ReportDateEnd,ReportDateBeg)-1 );
         end;

         m_RsdSqL.execute();

         m_SqlData = TRsbDataSet(m_RsdSqL);
         InitProgress( m_SqlNRecData, Rep_Name, "Просмотр данных БОЦБ об остатках ценных бумаг ..." );
         while( m_SqlData.MoveNext() )
            /*сохранить записи с ненулевыми суммами*/
            if( SQL_ConvType(m_SqlData.Am) > 0.)
               СохранитьОстаткиБОЦБ(m_SqlData.Party, m_SqlData.Contract, m_SqlData.FIID, SQL_ConvType(m_SqlData.Am) );
            end;
            Num = Num + 1;
            UseProgress( Num );
         end;
         RemProgress();
      end;
   END;

   PRIVATE MACRO PrintCSVReport(UserNumber, Department, RepDate, RepKind)
      var csvFile, csvTable;
      var CSVFileList = TArray;

      var SmallRepName = "sec_acts";
      var CurrentRepName = SmallRepName + "_" + UserNumber;
      var ServerFullPath = GetRepFullPath(false);

      var printEngine = CTemplateSXLSX();

      macro getSCVFileName(_csvIdx : Integer)
         var csvIdx = -1;
         if (ValType(_csvIdx) == V_INTEGER)
            csvIdx = _csvIdx;
         end;

         if (csvIdx >= 0)
            return ServerFullPath + string(CurrentRepName + "_" + String(csvIdx) + ".csv");
         end;
         return ServerFullPath + string(CurrentRepName + ".csv");
      end;

      macro divideFile(fileName : String)
         var fileList = TArray;
         var csvIdx = 0, strIdx = 0;
         var str : String = "";
         var fileFrom, fileTo = null;
         fileFrom = TStreamDoc(fileName, "R");

         while (fileFrom.ReadLine(str))
            if ((csvIdx == 0 ) or (mod(strIdx, 10000) == 0))
               if (csvIdx > 0)
                  fileTo.Flush();
                  fileTo = null;
               end;
               fileList[csvIdx] = getSCVFileName(csvIdx);
               fileTo = TStreamDoc(fileList[csvIdx], "W");
               csvIdx = csvIdx + 1;
            end;

            fileTo.WriteLine(str);
            strIdx = strIdx + 1;
         end;

         if (fileTo != null)
            fileTo.Flush();
            fileTo = null;
         end;

         fileFrom.Flush();
         fileFrom = null;

         if( ExistFile("$" + toANSI(fileName)) )
            RemoveFile("$" + toANSI(fileName));
         end;
         return fileList;
      end;

      begaction(100,"Запись отчета в " + getSCVFileName);
      //import "it_utils.mac";
      //IT_StoreClobBuferANSI(getSCVFileName, "CSV");

      var file_csv, strm = null;
      strm = TStream(getSCVFileName, "C");

      var rslDefCon, resultStr, idx;
      idx = 1;
      while(true)
         rslDefCon = RsdCommand(" begin "+
                                " ? := it_rsl_string.get_varchar(?); "+
                                " end;" );
         rslDefCon.addParam("v_result",RSDBP_OUT,V_STRING, 32768);
         rslDefCon.addParam("p_index",RSDBP_IN,idx);
         rslDefCon.execute();

         resultStr = rslDefCon.value("v_result");
         if (StrLen (resultStr )==0)
            break;
         end;

         strm.write(ToANSI(resultStr,true));
         idx = idx + 1;
      end;

      strm.Flush();
      execSQL("begin it_rsl_string.clear; end;"); // Очистка буфера

      if(printEngine.UsePoi())
        printEngine.SetXLSXFormat();
      end;

      printEngine.OpenTemplate("report_sec_acts.xlsx", true);
      printEngine.SheetChange(1);

      printEngine.SetValue_NameCell("templateTitleDep", "Филиал: " + DL_GetDepartmentNameByCode(Department) );
      printEngine.SetValue_NameCell("templateTitleDate", "Дата проведения сверки: " + string(date:f) + " " + string(time:f));
      printEngine.SetValue_NameCell("templateTitleRest", "Расчет остатков за: " + string(RepDate));
      printEngine.SetValue_NameCell("templateTitlePiper", "Ценные бумаги " + Subj(RepKind));

      csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);

      CSVFileList = divideFile(getSCVFileName);
      csvTable.FillTabelFromCSV(CSVFileList,0,null,null);
      csvTable.EndTable();
      printEngine.SaveAsTemplate(SmallRepName, false);
      printEngine.Close();
      endaction();

      return CurrentRepName;
   END;

   PRIVATE MACRO GetDataOnDate(Department:integer)
      var queryAvr, selectAvr, Avr;
      var Account:string = "";
      var Rep_Name = Get_Rep_Name(), IsIncludeData = false;
      var NRecSelect, NRecData, count = 0, Num = 0;
      IsFirstDate = true;

      InitCbLog(1, "DEF-63390");

      ClearGlobalTmp( "dsp_acts_tmp" );   
      if( RepKind == BankAcc )
         /*собираем остатки по ВУ, БОЦБ и ДЕПО и записываем во временную таблицу*/
         СобратьДанныеВУ(Department);
         СобратьПоТекЛотам(Department);
         СобратьПоИсторЛотам(Department);
         СобратьДанныеДЕПО_user(Department); /*PNV i-support 502007*/
      else
         /*собираем остатки по ВУ, БОЦБ и ДЕПО и записываем во временную таблицу*/
         cl_СобратьДанныеВУ();
         cl_СобратьПоЛотам(Department);
         cl_СобратьДанныеДЕПО();
      end;

      begaction(100,"Формирование отчета...");
      var ExecPrc = RSDCommand("begin rshb_rep_sec_acts(:Department,:IsPeriod,:ReportDateBeg,:ReportDateEnd,:WithNoChanging,:KDUAcc_flag,:FullReport); end;");
      ExecPrc.addParam( "", RSDBP_IN,Department );
      ExecPrc.addParam( "", RSDBP_IN,IIF(IsPeriod,1,0) );
      ExecPrc.addParam( "", RSDBP_IN,ReportDateBeg );
      ExecPrc.addParam( "", RSDBP_IN,IIF(IsPeriod,ReportDateEnd,ReportDateBeg));
      ExecPrc.addParam( "", RSDBP_IN,DlSActsRepFormData.WithNoChanging );
      ExecPrc.addParam( "", RSDBP_IN,IIF(KDUAcc_flag,1,0) );
      ExecPrc.addParam( "", RSDBP_IN,IIF(DlSActsRepFormData.FullReport,1,0) );
      ExecPrc.execute();

      endaction();

      var CreateOnTerm = (not isStandAlone());
      var resultFileName;
      var err = 0;
      var ServerFullPath = GetRepFullPath(false);
      var ShowFilePath = IIF(CreateOnTerm, "$" + GetRepFullPath(true), ServerFullPath);
      var CurrentRepName = PrintCSVReport(UserNumber, Department, DlSActsRepFormData.EndDate, RepKind);

      if(DlSActsRepFormData.ConvertXML2XSLX)
         resultFileName = CurrentRepName + ".xls";
      else
        resultFileName = CurrentRepName + ".xlsx";
      end;

      println(time);
      if(not err)
         if (CreateOnTerm)
            if (CopyFile(ServerFullPath + resultFileName, ShowFilePath + resultFileName, true, "Копирование файла на терминал в " + substr(ShowFilePath, 2)))
               RemoveFile(ServerFullPath + resultFileName);               
            end;
         end;
         SC_ShowFile(ShowFilePath, resultFileName);
      end;

     RemProgress();
     return ExistInfo;
   END;

   PRIVATE MACRO ListerDate(Department:integer)
      /*перебор дат*/
      /*Если отчетный период больше одного дня:
           если за каждый день печатается отдельный отчет, 
                то проверяем наличие проводок за каждый день отдельно. 
                Если не было движений - в отчет за этот день данные по бумаге не включаем. 
           если печатается один отчет за весь отчетный период (без разбивки по дням), то проверяем наличие проводок в течение всего периода.*/
      ReportDateBeg = GetDateAfterWorkDays(DlSActsRepFormData.BeginDate,0);
      ReportDateEnd = GetDateAfterWorkDays(DlSActsRepFormData.EndDate,1);

      if( DlSActsRepFormData.ForEveryDate != "X" )
         /*выпускаем на период*/
         ExistInfo = false;
         IsPeriod = true;
         /*по состоянию на начало даты, следующей после последней даты отчетного периода.*/
         IsPrintHead = true;
         GetDataOnDate(Department);
      else
         /*выпускаем на начало каждой отчетной даты периода*/
         IsPeriod = false;
         while( ReportDateBeg <= ReportDateEnd )
            ReportDateBeg = GetDateAfterWorkDays(ReportDateBeg,0);
            ExistInfo = false;
            IsPrintHead = true;
            GetDataOnDate(Department);
            ReportDateBeg = ReportDateBeg + 1;
         end;
      end;
   END;
      
   var Dep = DlSActsRepFormData.DepartmentID;
   var Department, query, NumDep = 0;

   if( Dep != -1 )
      ListerDate(Dep);
   else
      query = " SELECT t_Code"
            + " FROM  ddp_dep_dbt";
      Department = TRsbDataSet( query );

      InitProgress( SQL_GetNRecs(query), "Отчет: Акт о проведении сверки наличия эмиссионных ценных бумаг", "Просмотр филиалов..." );
      while( Department.MoveNext() )
         Dep = Department.Code;
         ListerDate(Dep);
         UseProgress( NumDep = NumDep + 1 );
      end;
      RemProgress();
   end;

END;

PRIVATE MACRO Create()
   VAR SubBank   = DlSActsRepFormData.AccountBank;
   VAR SubClient = DlSActsRepFormData.AccountClient;

   if( SubBank == "X"  )
      CreateReportByKind( BankAcc );
   end;

   if( SubClient == "X" )
      CreateReportByKind( ClientAcc );
   end;
END;
  
macro MakeReport( DataFromForm )
   VAR ReportFileName, TblName = "sec_acts", errcode, errtext;
   FILE ReportOutFile() txt write; /*файл вывода для отчета*/
   DlSActsRepFormData = DataFromForm;
   
   DataFromForm.SaveExtParm;

   Create();

   if( DlSActsRepFormData.IsExportToExel )
   else     
      ReportFileName = GetTxtFileName( TblName );
      if( Open( ReportOutFile, ReportFileName ) == false )
         errcode = status( errtext );
         MsgBox( "Ошибка при открытии файла отчета|"+ ReportFileName +"|(" + errcode + ") " + errtext);
         break;
      end;

      SetOutput( ReportFileName );
      //Rep.PrintRep();
      SetOutput( NULL, true );
      close( ReportOutFile );
      ViewFile( ReportOutFile );    
   end;
   
   SetParm (1,IsDataExists);
   return ReportFileName;
end;   
