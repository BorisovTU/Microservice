/*
$Name:         rtcpown020.mac
$Module:       Ценные бумаги
$Description:  Операция погашения купона СЭБ. Шаг "Расчет погашения"
*/

import "spretownfun.mac";

PRIVATE MACRO НайтиСПИ_ПА(FD)
    private macro ClearParams(command:RsdCommand)
        command.close;
        command.deleteParam(0);
        command.deleteParam(0);
        command.deleteParam(0);
        command.deleteParam(0);
        command.deleteParam(0);
    end;

    var СПИ = TBFile("settacc.dbt");
      
    var query = "Select * from (SELECT sc.t_SettAccID SettAccID, pc.t_order "
               +"  FROM DSETTACC_DBT sc, DPMAUTOAC_DBT pc "
               +" WHERE     pc.t_SettAccID = sc.t_SettAccID "
               +"       AND sc.t_PartyID = ? "     // 1) Контрагент
               +"       AND pc.t_ServiceKind = ? " // 2) Вид обслуживания
               +"       AND pc.t_KindOper = ? "    // 3) Вид операции
               +"       AND pc.t_FIID = ?) t order by t.t_order asc " ;       // 4) Валюта
 
    var cmd = RsdCommand(query);
    
    cmd.addParam("", RSDBP_IN, FD.avrserv().rec.partyp);     // Контрагент
    cmd.addParam("", RSDBP_IN, PTSK_STOCKDL);             // Вид обслуживания - Фондовый дилинг - PTSK_STOCKDL - 1
    cmd.addParam("", RSDBP_IN, FD.tick.rec.dealtype);                // Вид операции 
    cmd.addParam("", RSDBP_IN, NATCUR); // Валюта

    cmd.execute;
    var DataSet = TRsbDataSet(cmd);
    
    if (DataSet and DataSet.moveNext)
      if(FD.avrserv().rec.TaxAgent == SET_CHAR) 
        DataSet.moveNext;
      end;
        СПИ.rec.SettAccID = DataSet.SettAccID;
        if (not СПИ.getEQ)
            return null;
        end;
      
   end; 
    return СПИ;
END;



macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step )
   record deal(dl_tick);
   var FD, dat;
   var SumComiss = $0, SumNDS = $0;


   SetBuff( deal, FDoc );
   FD = SPFirstDoc ( deal, false );

  var rRqAcc = TRecHandler( "dlrqacc.dbt", "W", 0 );
  rRqAcc.Clear();
  ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, FD.avrserv().rec.partyp, DLRQ_SUBKIND_CURRENCY, NATCUR, 10, rRqAcc);
  var SPI = НайтиСПИ_ПА(FD);
  var cmd = RsdCommand( "UPDATE ddlrqacc_dbt set t_BankID = ?, t_Chapter = ?, t_Account = ?, t_BankCodeKind = ?, t_BankCode = ?, t_BankName = ?, t_BankCorrID = ?, t_BankCorrCodeKind = ?, t_BankCorrCode = ?,t_BankCorrName = ?, t_CorrAcc = ?   where t_id = ?" );
  cmd.addParam("BankID", RsdBp_In, SPI.rec.BankID);
  cmd.addParam("Chapter", RsdBp_In, SPI.rec.Chapter);
  cmd.addParam("Account", RsdBp_In, SPI.rec.Account);
  cmd.addParam("BankCodeKind", RsdBp_In, SPI.rec.BankCodeKind);
  cmd.addParam("BankCode", RsdBp_In, SPI.rec.BankCode);
  cmd.addParam("BankName", RsdBp_In, SPI.rec.BankName);
  cmd.addParam("BankCorrID", RsdBp_In, SPI.rec.BankCorrID);
  cmd.addParam("BankCorrCodeKind", RsdBp_In, SPI.rec.BankCorrCodeKind);
  cmd.addParam("BankCorrCode", RsdBp_In, SPI.rec.BankCorrCode);
  cmd.addParam("BankCorrName", RsdBp_In, SPI.rec.BankCorrName);
  cmd.addParam("CorrAcc", RsdBp_In, SPI.rec.CorrAcc);
  cmd.addParam("t_id", RsdBp_In, rRqAcc.rec.ID );
  cmd.execute;


   dat = FD.dl_leg.rec.MoveDate;
    
   
   if(ОЭБ_РассчитатьВыплатыПоПогашению(FD, dat) != 0)
      return 1;
   end;
         
   if(FD.ExistRqPayIncome())
     if(УстановитьСтатусТО(FD.GetRQ(DLRQ_TYPE_PAYINCOME), DLRQ_STATE_FORPROCESSING, dat) != 0)
       return 1;
     end;
   end;

   if(ОЭБ_РассчитатьКомиссиюПАПриПогашении(FD, 
                                           ПолучитьКодКомиссииОЭБ_ПГКУП(), 
                                           dat, 
                                           @SumComiss, 
                                           @SumNDS) != 0)
     return 1;
   elif(SumComiss > 0)

     if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYCOMOWN, DLGR_ACCKIND_BACKOFFICE, dat, DLGRACC_STATE_FACTEXEC) != 0 )
       return 1;
     end;

   end;

   
   if(DL_UpdateGrDealAcc( FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_EXECOWN, DLGR_ACCKIND_BACKOFFICE, dat, DLGRACC_STATE_FACTEXEC) != 0 )
     return 1;
   end;

   return 0;
end;
