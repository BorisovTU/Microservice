/*
$Name:             CompareSumCup_report.mac
$Module:           Äêçì
$Description:      é‚Á•‚ "ä„‡·Æ¢†Ô ‡†ß≠®Ê† ØÆ ™„ØÆ≠†¨"
*/

IMPORT "CompareSumCup_form.mac", "spserv.mac", "spRepFun.mac", "ws_txreportform.mac";

PRIVATE VAR CompareSumCup_Form;
PRIVATE VAR CompareSumCup_Report;
PRIVATE VAR WebMenuItem; // à≠‰Æ‡¨†Ê®Ô Æ ß†Ø„·™• Æ‚Á•‚† ®ß ¢•°

PRIVATE VAR ReportHeader =
"Ñ†‚† ‰Æ‡¨®‡Æ¢†≠®Ô:       #################################################################\n" +
"èÆ´ÏßÆ¢†‚•´Ï:            #################################################################\n" +
//"###########################################################################################################################################################################################################################\n" +
"é‚Á•‚ ß† Ø•‡®Æ§ · ########## ØÆ ##########\n" +
//"###########################################################################################################################################################################################################################\n" +
"É‡„ØØ† ≠†´Æ£Æ¢Æ£Æ „Á•‚†: #################################################################\n" +
"ÇÎØ„·™ Ê/°:              #################################################################\n" +
"                                                                                               ä„‡·Æ¢†Ô ‡†ß≠®Ê† ØÆ ™„ØÆ≠†¨\n" ; 
PRIVATE VAR TableHeader =                                                                                                                                                                                                        
"⁄ƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
"≥ çÆ¨•‡ ≥     äÆ§    ≥ç†®¨•≠Æ¢†≠®• Ê•≠≠Æ© ≥   çÆ¨•‡  ≥     ä„ØÆ≠≠Î© Ø•‡®Æ§     ≥ é·‚†‚Æ™ Ê•≠≠ÎÂ °„¨†£    ≥  äÆ§   ≥  ê†·Á•‚≠†Ô ·„¨¨†  ≥Ñ†≠≠Î• ØÆ ÆØ•‡†Ê®® ØÆ£†Ë•≠®Ô≥    ä„‡·Æ¢†Ô    ≥                   ëØ‡†¢ÆÁ≠Æ:                    ≥ äÆ§ ISIN (≠Æ¨•‡ ≥\n" +
"≥   çÉ  ≥   °„¨†£®   ≥       °„¨†£®       ≥  ™„ØÆ≠†  √ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¥ ≠† §†‚„, Ø‡•§Ë•·‚¢„ÓÈ„Ó ≥ ¢†´Ó‚Î ≥ ™„ØÆ≠† ØÆ ØÆ™„Ø™†¨≥  ™„ØÆ≠† ¢ ‰†™‚®Á•·™®Â í/é  ≥     ‡†ß≠®Ê†    √ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥ £Æ·„§†‡·‚¢•≠≠Æ© ≥\n" +
"≥       ≥            ≥                    ≥          ≥Ñ†‚† ≠†Á†´† ≥    Ñ†‚†    ≥ §†‚• Æ™Æ≠Á†≠®Ô ™„ØÆ≠≠Æ£Æ≥≠Æ¨®≠†´†≥ ≠† §†‚„ Æ™Æ≠Á†≠®Ô √ƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¥                ≥% ·‚†¢™†≥   ë„¨¨†   ≥    Ñ†‚†    ≥é·‚†‚Æ™ Ê•≠≠ÎÂ ≥ ‡•£®·‚‡†Ê®®)    ≥\n" +
"≥       ≥            ≥                    ≥          ≥  ™„ØÆ≠≠Æ£Æ ≥ Æ™Æ≠Á†≠®Ô  ≥ Ø•‡®Æ§†, Ë‚.            ≥        ≥™„ØÆ≠≠Æ£Æ Ø•‡®Æ§† ¢≥  äÆ§ ≥   Ñ†‚†   ≥  ë„¨¨†   ≥                ≥   ØÆ   ≥™„ØÆ≠† ≠† 1≥  ‰®™·†Ê®®  ≥ °„¨†£ ≠† §†‚„ ≥ Ê•≠≠Æ© °„¨†£®   ≥\n" +
"≥       ≥            ≥                    ≥          ≥  Ø•‡®Æ§†   ≥ ™„ØÆ≠≠Æ£Æ  √ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¥        ≥  ¢†´Ó‚• ≠Æ¨®≠†´†  ≥¢†´Ó‚Î≥ ØÆ£†Ë•≠®Ô≥  ™„ØÆ≠†  ≥                ≥ ™„ØÆ≠„ ≥°„¨†£„ (ØÆ ≥ ¢´†§•´ÏÊ•¢ ≥   ‰®™·†Ê®®    ≥                 ≥\n" +
"≥       ≥            ≥                    ≥          ≥            ≥  Ø•‡®Æ§†   ≥èÆ ØÆ™„Ø™†¨ ≥ èÆ Æ°‡†‚≠Î¨≥        ≥                   ≥      ≥          ≥          ≥                ≥        ≥   §†≠≠Î¨  ≥§´Ô ¢ÎØ´†‚Î ≥¢´†§•´ÏÊ•¢ §´Ô ≥                 ≥\n" +
"≥       ≥            ≥                    ≥          ≥            ≥            ≥            ≥ êÖèé       ≥        ≥                   ≥      ≥          ≥          ≥                ≥        ≥·Ø‡†¢ÆÁ≠®™†≥   ™„ØÆ≠†   ≥¢ÎØ´†‚Î ™„ØÆ≠†,≥                 ≥\n" +
"≥       ≥            ≥                    ≥          ≥            ≥            ≥            ≥            ≥        ≥                   ≥      ≥          ≥          ≥                ≥        ≥           ≥            ≥      Ë‚.      ≥                 ≥\n" +
"√ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
"≥   1   ≥      2     ≥          3         ≥     4    ≥     5      ≥     6      ≥      7     ≥      8     ≥   9    ≥         10        ≥  11  ≥    12    ≥    13    ≥       14       ≥   15   ≥    16     ≥     17     ≥      18       ≥        19       ≥\n" +
"√ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

macro GetAvoirListAddWhere(RepSubKind)
   return " AND AV.t_TaxGroup in(31,32,33,43) ";
end;

PRIVATE MACRO GetSqlRest( /*types*/ )
   var i = 0, val = "", types = "", cond = "";
   while( GetParm(i, val) )
      types = types + "," + val;
      i = i + 1;
   end;

   if( types == "" )
      cond = "";
   else
      cond = " AND T_SOURCETYPE in( " + substr(types, 2) + ")";
   end;

   return "        NVL ((SELECT SUM (t_amount) FROM DV_SCTXREST "
        + "               WHERE t_fiid = fin.t_fiid "
        + "                 AND (   t_saledate > warn.t_drawingdate-1 "
        + "                       OR t_saledate =  TO_DATE ('01.01.0001',  'dd.mm.yyyy'  ) "
        + "                     ) "
        + "                 AND t_buydate <= warn.t_drawingdate-1 "
        + "                 AND t_buydate <> TO_DATE ('01.01.0001', 'dd.mm.yyyy') "
        + "                 AND t_amount > 0 "
        +                   cond
        + "             ), 0  ) ";
END;

PRIVATE CLASS (DL_CReportTemplate) SP_CRSDELTA_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  PRIVATE VAR begdate, enddate, avrgroup, avrcode;
  
  PRIVATE VAR m_IsDataExist = false; /*§´Ô Web, •·´® ≠•‚ §†≠≠ÎÂ, ‚Æ ≠®Á•£Æ ≠• ØÆ™†ßÎ¢†•¨*/

 /* ≠• ØÆ™†ßÎ¢†‚Ï Ø„·‚Î• Æ‚Á•‚ ¢ Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*¢ EW ØÆ™†ßÎ¢†•¨ ´®·‚Î ¢·•£§†*/
    end;
  END; 

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport()
     VAR group, code;

     this.SetActiveSheet( "01" );
       
     begdate  = CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_BEGINDATE );
     enddate  = CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_ENDDATE );

     CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_AVRGROUP, @group);
     CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_AVRNAME, @code );

     this.PrintFormatString( ReportHeader,
                     "Date_Time", date() + "   "  + SPTimeSplit(time()), 
                     "FIO", {Name_Oper},  
                     "BegDate", begdate,  
                     "EndDate", enddate,
                     "Group", group,
                     "SecName1", code
                   );

     this.RegisterTable( "CompSumCup", TableHeader,
               /*1  */   "SecType",       
               /*2  */   "SecCode",       
               /*3  */   "SecName", 
               /*4  */   "CoupN",           
               /*5  */   "Dbeg",
               /*6  */   "Dend", 
               /*7  */   "QntyOst", 
               /*8  */   "RepoOst", 
               /*9  */   "VN", 
               /*10 */   "CoupCalc", 
               /*11 */   "CrDend",
               /*12 */   "VP",
               /*13 */   "Doper",
               /*14 */   "Qnty",
               /*15 */   "CrDoper",
               /*16 */   "Dif", 
               /*17 */   "CoupRate", 
               /*18 */   "CoupOne", 
               /*19 */   "Dfix", 
               /*20 */   "QntyOstFix",
               /*21 */   "DifPrev",
               /*22 */   "DifAll",
               /*23 */   "ISIN" );

  END;

  PRIVATE MACRO PrintLine( P1,P2,P3,P4,P5,P6,P7,P8,P9,P10,P11,P12,P13,P14,P15,P16,P17,P18,P19,P20,P21,P22,P23, Precision)
     this.SetCurrentLineFont( 8, false, false );
     var SumPrecision = 0;
     if(IsHaveFractPart(P7) or IsHaveFractPart(P8) or IshaveFractPart(P20))
        SumPrecision = Precision;
     end;
     this.PrintTableLine( "SecType",        P1,                     null,
                          "SecCode",        P2,                     null,
                          "SecName",        P3,                     null,
                          "CoupN",          P4,                     null,
                          "Dbeg",           P5,                     null,
                          "Dend",           P6,                     null,
                          "QntyOst",        P7,                     SumPrecision,
                          "RepoOst",        P8,                     SumPrecision,
                          "VN",             P9,                     null,
                          "CoupCalc",       P10,                    null,
                          "CrDend",         P11,                    null,
                          "VP",             P12,                    null,
                          "Doper",          P13,                    null,
                          "Qnty",           P14,                    null,
                          "CrDoper",        P15,                    null,
                          "Dif",            P16,                    null,
                          "CoupRate",       P17,                    null,
                          "CoupOne",        P18,                    null,
                          "Dfix",           P19,                    null,
                          "QntyOstFix",     P20,                    SumPrecision,
                          "DifPrev",        P21,                    null,
                          "DifAll",         P22,                    null,
                          "ISIN",           P23,                    null
                        );        
  END;

  MACRO è•Á†‚†‚Ïè‡Æ¨•¶„‚ÆÁ≠Î•à‚Æ£®()
    
     this.SetSubtotal(15, 14 + MAXROWSHEET,
                        "G11",     
                        "H11",        
                        "N11"          
                    );                                                                      
  END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     è•Á†‚†‚Ïè‡Æ¨•¶„‚ÆÁ≠Î•à‚Æ£®();
  END;

  Macro ReportRun()
     var sql, cmd;
     var err = 0, mes = "", CoupOne = $0, CoupCalc = $0, Dif = $0, VN_Doper = $0, VN_Dend = $0,
         CrDend = 0.0, CrDoper = 0.0, VN_max = 0.0, DifPrev = $0, DifAll = $0, IsRetire = true,
         VP = "", Doper, CoupOperSum,
         AvrFIIDList = null,
         AvrFIIDCount : Integer = 0,
         AvrFIIDAddWhere : String = "",
         
         GNUList = null,
         GNUAddWhere : String = "",
         GNUCount : Integer = 0;
     VAR ProgressValue = CTxProgressValue();

     var SqlIsAvrDefault = 
           "         (NVL((Select ATTR.T_NUMINLIST "                              
         + "                 From dobjatcor_dbt AtCor, dobjattr_dbt Attr"         
         + "                Where AtCor.t_ObjectType = " + OBJTYPE_AVOIRISS
         + "                  And AtCor.t_GroupID    = " + OBJGROUP_AVRDEFAULT
         + "                  And AtCor.t_Object     = LPAD(fin.t_FIID, 10, '0' ) "
         + "                  And Attr.t_AttrID      = AtCor.t_AttrID "
         + "                  And Attr.t_ObjectType  = AtCor.t_ObjectType "
         + "                  And Attr.t_GroupID     = AtCor.t_GroupID "
         + "                  And AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate) "
         + "                                                   FROM DOBJATCOR_DBT t "
         + "                                                  WHERE t.T_ObjectType = AtCor.T_ObjectType "
         + "                                                    AND t.T_GroupID    = AtCor.T_GroupID "
         + "                                                    AND t.t_Object     = AtCor.t_Object "
         + "                                                    AND t.T_ValidFromDate <= " + GetSQLDate(begdate - 1)
         + "                                                    AND t.t_General    = 'X' "
         + "                                               ) "
         + "                  And AtCor.t_ValidToDate >= " + GetSQLDate(begdate - 1)
         + "              ),-1)) ";

     var SqlQntyOstFix = 
           "        (CASE WHEN warn.t_listdate <> TO_DATE('01.01.0001','dd.mm.yyyy') THEN "
         + "        NVL ((SELECT SUM (t_amount) FROM dsctxrest_dbt "
         + "               WHERE t_fiid = fin.t_fiid "
         + "                 AND ( t_saledate > warn.t_listdate "
         + "                       OR t_saledate =  TO_DATE ('01.01.0001',  'dd.mm.yyyy'  ) "
         + "                     ) "
         + "                 AND t_buydate <= warn.t_listdate "
         + "                 AND t_amount > 0 "
         + "             ), 0  ) END ) ";

     sql = " SELECT fin.t_fiid fiid ,av.t_taxgroup sectype, fin.t_fi_code seccode, fin.t_name secname, fin.t_SumPrecision Precision, "
         + "        (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN, "
         + "        warn.t_number CoupN, warn.t_firstdate Dbeg, warn.t_drawingdate Dend, "
         +          GetSqlRest(TXLOTS_BUY, TXLOTS_LOANGET) + " AS QntyOst, "
         + "        fin.t_Facevaluefi VN, "
         + "        rq.t_FIID as VP, "
         + "        rq.t_amount as CoupOperSum, "
         + "        rq.t_FactDate Doper, "
         + "        warn.t_incomerate CoupRate, warn.t_listdate Dfix, "
         +          GetSqlRest(TXLOTS_BACKREPO) + " AS RepoOst, "
         +          SqlQntyOstFix + " AS QntyOstFix, "
         + "        chr(88) AS IsRetire "
         + "   FROM dfininstr_dbt fin, davoiriss_dbt av, dfiwarnts_dbt warn, ddl_tick_dbt tick, ddl_leg_dbt leg, DDLRQ_dbt rq "
         + "  WHERE RSB_FIInstr.FI_AvrKindsGetRoot("+FIKIND_AVOIRISS+",fin.t_avoirkind) = " +AVOIRISSKIND_BOND/*¢ ØÆ£†Ë•≠®® ® ‚†™ ¢·•£§† Æ°´®£†Ê®®*/
         + "    AND fin.t_FI_Kind = "+FIKIND_AVOIRISS
         + "    AND fin.t_fiid = av.t_fiid AND fin.t_fiid = warn.t_fiid "
         +      GetAvoirListAddWhere()
         + "    AND warn.t_ispartial <> 'X' "
         + "    AND tick.t_dealid = leg.t_dealid "
         + "    AND leg.t_legkind = 0 "
         + "    AND leg.t_pfi = fin.t_fiid "
         + "    AND tick.T_BOFFICEKIND = "+DL_RETIREMENT
         + "    AND tick.t_number_coupon = warn.t_number "
         + "    AND tick.t_ClientID = -1 "/*èÆ·™Æ´Ï™„ Ì‚Æ ‡•£®·‚‡ ØÆ Ø‡®°Î´®, ‚Æ °•‡•¨ ‚Æ´Ï™Æ ÆØ•‡†Ê®® °†≠™†*/
         + "    AND rq.t_docid = tick.t_dealid "
         + "    AND rq.t_dockind = tick.T_BOFFICEKIND "
         + "    AND rq.t_subkind = " + DLRQ_SUBKIND_CURRENCY
         + "    AND rq.t_type = " + DLRQ_TYPE_PAYMENT
         + "    AND rq.t_DealPart = 1 " 
         + "    AND ((rq.t_state = "+ DLRQ_STATE_EXEC + " AND rq.t_FactDate >= " + GetSQLDate(begdate) + " AND rq.t_FactDate <= " + GetSQLDate(enddate) + ")"
         + "         OR ( " + GetSqlRest(TXLOTS_BUY,TXLOTS_LOANGET,TXLOTS_BACKREPO) + " > 0  "
         + "               AND ( (warn.t_drawingdate >= add_months(" + GetSQLDate(begdate) + ", -1) AND warn.t_drawingdate <= " + GetSQLDate(enddate) + ")"
         + "                     OR (rq.t_FactDate >= " + GetSQLDate(begdate) + " AND rq.t_FactDate <= " + GetSQLDate(enddate)
         + "                          AND " + SqlIsAvrDefault + " = 1 ) " // 'Ñ†'
         + "                   ) "
         + "            ) "
         + "        ) "
         + " UNION "
         + " SELECT fin.t_fiid fiid ,av.t_taxgroup sectype, fin.t_fi_code seccode, fin.t_name secname, fin.t_SumPrecision Precision, "
         + "        (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN, "
         + "        warn.t_number CoupN, warn.t_firstdate Dbeg, warn.t_drawingdate Dend, "
         +          GetSqlRest(TXLOTS_BUY, TXLOTS_LOANGET) + " AS QntyOst, "
         + "        fin.t_Facevaluefi VN, "
         + "        -1 as VP, "
         + "        -1 as CoupOperSum, "
         + "        TO_DATE('01.01.0001', 'DD.MM.YYYY') Doper, "
         + "        warn.t_incomerate CoupRate, warn.t_listdate Dfix, "
         +          GetSqlRest(TXLOTS_BACKREPO) + " AS RepoOst, "
         +          SqlQntyOstFix + " AS QntyOstFix, "
         + "        chr(0) AS IsRetire "
         + "   FROM dfininstr_dbt fin, davoiriss_dbt av, dfiwarnts_dbt warn "
         + "  WHERE RSB_FIInstr.FI_AvrKindsGetRoot("+FIKIND_AVOIRISS+",fin.t_avoirkind) = " +AVOIRISSKIND_BOND/*¢ ØÆ£†Ë•≠®® ® ‚†™ ¢·•£§† Æ°´®£†Ê®®*/
         + "    AND fin.t_FI_Kind = "+FIKIND_AVOIRISS
         + "    AND fin.t_fiid = av.t_fiid AND fin.t_fiid = warn.t_fiid "
         +      GetAvoirListAddWhere()
         + "    AND warn.t_ispartial <> 'X' "
         + "    AND ((warn.t_drawingdate >= add_months(" + GetSQLDate(begdate) + ", -1) AND warn.t_drawingdate <= " + GetSQLDate(enddate) + ")"
         + "         OR (" + SqlIsAvrDefault + " = 1 ) " // 'Ñ†'
         + "        )"
         + "    AND NOT EXISTS (select 1 from ddl_tick_dbt tick, ddl_leg_dbt leg, DDLRQ_dbt rq "
         + "                     where tick.t_dealid = leg.t_dealid "
         + "                       and leg.t_legkind = 0 "
         + "                       and leg.t_pfi = fin.t_fiid "
         + "                       and tick.T_BOFFICEKIND = "+DL_RETIREMENT
         + "                       and tick.t_number_coupon = warn.t_number "
         + "                       and tick.t_ClientID = -1 "/*èÆ·™Æ´Ï™„ Ì‚Æ ‡•£®·‚‡ ØÆ Ø‡®°Î´®, ‚Æ °•‡•¨ ‚Æ´Ï™Æ ÆØ•‡†Ê®® °†≠™†*/
         + "                       and rq.t_docid = tick.t_dealid "
         + "                       and rq.t_dockind = tick.T_BOFFICEKIND "
         + "                       and rq.t_subkind = " + DLRQ_SUBKIND_CURRENCY
         + "                       and rq.t_type = " + DLRQ_TYPE_PAYMENT
         + "                       and rq.t_DealPart = 1 " 
         + "                   ) "
         + "    AND " + GetSqlRest(TXLOTS_BUY,TXLOTS_LOANGET,TXLOTS_BACKREPO) + " > 0 ";

     if( not m_IsWebService )
        GNUList = TArray();
        GNUList[GNUList.Size] = CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_AVRGROUP );
     else
        GNUList = CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_AVRGROUP );
     end;
     /*ß†§†≠† ™†‚•£Æ‡®Ô °„¨†£®*/
     if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
        while( GNUCount < GNUList.Size )
           if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
           and ( GNUList[GNUCount] > 0 ) )
            if( GNUAddWhere == "" )
                 GNUAddWhere = GNUAddWhere + " AND ( ";
              else
                 GNUAddWhere = GNUAddWhere + " OR ";
              end;
              GNUAddWhere = GNUAddWhere + " av.T_TAXGROUP = " + String( GNUList[GNUCount] ) + " ";
           end;
           GNUCount = GNUCount + 1;
        end;
        if( GNUAddWhere != "" )
           GNUAddWhere = GNUAddWhere + " ) ";
        end;
        sql = sql + GNUAddWhere;
     end;
     
     if( not m_IsWebService )
        AvrFIIDList = TArray();
        AvrFIIDList[AvrFIIDList.Size] = CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_AVRCODE );
     else
        AvrFIIDList = CompareSumCup_Form.GetFieldValue( PNFLD_CRSDELTA_AVRCODE );
     end;
     if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
        while( AvrFIIDCount < AvrFIIDList.Size )
           if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
           and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
              if( AvrFIIDAddWhere == "" )
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
              else
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
              end;
              AvrFIIDAddWhere = AvrFIIDAddWhere + " av.T_fiid = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
           end;
           AvrFIIDCount = AvrFIIDCount + 1;
        end;
        if( AvrFIIDAddWhere != "" )
           AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
        end;
        sql = sql + AvrFIIDAddWhere;
     end;

     sql  = sql + " ORDER BY SecType, SecCode, Dend";

     ProgressValue.Maximum = SQL_GetNRecs (sql);
     ProgressValue.Current = 0;
     
     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
       var header = "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚† " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"è‡Æ·¨Æ‚‡ °„¨†£...","ÇÎØÆ´≠•≠®• Æ‚Á•‚†" );
     end;

     cmd = TrsbDataSet(sql);

     WHILE(cmd.movenext())
        IsRetire = SQL_ConvTypeStr( cmd.IsRetire ) == SET_CHR;

        err = 0;
        mes = "";
        CoupCalc = ë„¨¨†ä„ØÆ≠†(cmd.fiid, cmd.QntyOst, SQL_ConvTypeDate(cmd.Dend),err);

        if(err)
           mes = GetErrMsg();
           if (strlen(mes) == 0)
               InitError();
               MemoryError(err);
               mes = GetErrMsg();
           end;
        end;

        if( mes != "" )
           msgbox("éË®°™† Ø‡® ‡†·Á•‚• ·„¨¨Î ™„ØÆ≠† ¸ "+SQL_ConvTypeInteger(cmd.CoupN)+": "+mes);
        end;

        err = 0;
        mes = "";
        CoupOne = ë„¨¨†ä„ØÆ≠†(cmd.fiid, 1, SQL_ConvTypeDate(cmd.Dend),err);

        if(err)
           mes = GetErrMsg();
           if (strlen(mes) == 0)
               InitError();
               MemoryError(err);
               mes = GetErrMsg();
           end;
        end;

        if( mes != "" )
           msgbox("éË®°™† Ø‡® ‡†·Á•‚• ·„¨¨Î ™„ØÆ≠† ¸ "+SQL_ConvTypeInteger(cmd.CoupN)+": "+mes);
        end;

        VP = ""; Doper = ""; CoupOperSum = ""; CrDoper = null;
        if( IsRetire )
           VP = DL_GetISOCode(cmd.VP);
           Doper = sql_convTypeDate(cmd.Doper);
           CoupOperSum = SQL_ConvTypeSum(cmd.CoupOperSum);
           CrDoper = GetRateOnDateCrossDbl( sql_convTypeDate(cmd.Doper), cmd.VN, NATCUR, true );
        end;

        CrDend = GetRateOnDateCrossDbl( sql_convTypeDate(cmd.Dend), cmd.VN, NATCUR, true );

        Dif = $0;
        VN_max = GetRateOnDateCrossDbl( max(sql_convTypeDate(cmd.Dend), begdate - 1), cmd.VN, NATCUR, true );
        if( sql_convTypeDate(cmd.Doper) != Date(0,0,0) )
           Dif = money((CrDoper - VN_max) * CoupCalc);
        else
           Dif = money((GetRateOnDateCrossDbl( enddate, cmd.VN, NATCUR, true ) - VN_max) * CoupCalc);
        end;

        if( sql_convTypeDate(cmd.Dend) < begdate )
           DifPrev = money((GetRateOnDateCrossDbl( begdate - 1, cmd.VN, NATCUR, true ) - CrDend) * CoupCalc);
        else
           DifPrev = $0;
        end;

        DifAll = Dif + DifPrev;

        m_IsDataExist = true;     
        PrintLine(cmd.SecType,
                  string(cmd.seccode),
                  cmd.secname,
                  SQL_ConvTypeInteger(cmd.CoupN),
                  sql_convTypeDate(cmd.Dbeg), 
                  sql_convTypeDate(cmd.Dend), 
                  SQL_ConvTypeSum(cmd.QntyOst),
                  SQL_ConvTypeSum(cmd.RepoOst),
                  DL_GetISOCode(cmd.VN), 
                  CoupCalc,
                  CrDend,
                  VP,
                  Doper,
                  CoupOperSum,
                  CrDoper,
                  Dif,
                  cmd.CoupRate,
                  CoupOne,
                  sql_convTypeDate(cmd.Dfix),
                  SQL_ConvTypeSum(cmd.QntyOstFix),
                  DifPrev,
                  DifAll,
                  cmd.ISIN,
                  cmd.Precision
                 );
      
        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
       
     END;
     
     ProgressIndicator.Stop();
  END;
 
  PRIVATE MACRO Create()
    ReportRun();
  END;

    initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    CompareSumCup_Form = SP_CRSDELTA_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      CompareSumCup_Form = WS_TX_CRSDELTA_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = CompareSumCup_Form.Run();
    end;

    if( stat )
      CompareSumCup_Report = SP_CRSDELTA_Report( null, "CompSumCup.xls", false, IsWebService, ReportHashCode );
      CompareSumCup_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( CompareSumCup_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = CompareSumCup_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( CompareSumCup_Report.PrintMode() );
      end;
    end;
  end;

  return FullReportFileNames;
END;
