/*
$Name:         scbas0020.mac
$Module:       Ценные бумаги
$Description:  Операция Прямое РЕПО на корзину ц/б, Исполнения 1ч
*/

import InsCarryDoc, "sp_car.mac", "sp_car2.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  record deal(dl_tick);
  var    FD, FD2, dat;

  SetBuff(deal, FDoc); 
  FD = SPFirstDoc(deal, false);

  GetOprDate(FD.GetKindDate(DATE_DEALEXEC), dat);

  if( dat > {curdate} )
     MsgBox ("Преждевременное выполнение шага запрещено.");
     return 1;
  end;

  if( ОбработатьТОПоОплате(FD, dat, doc) != 0 )
     return 1;
  end;

  if( DL_WRTCreateCurrParmREPO( FD.tick.rec.DealID ) != 0 )
     return 1;
  end;

  FD2 = SPFirstDoc(deal, true);

  if( ВыполнитьНатуральныйУчетЦенныхБумаг(FD, Doc, dat, NULL) != 0 )
     return 1;
  end;

  var ArrFIID = FD2.RQGetArrFIID(DLRQ_TYPE_DELIVERY);
  var j:integer = 0;
  while( j < ArrFIID.size )
     if( DL_UpdateGrDealAcc(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, ArrFIID(j), DLGR_TEMPL_DELIVERY, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
        return 1;
     end;
     j = j + 1;
  end;

  if( DL_UpdateGrDealAcc(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PFI, DLGR_TEMPL_PAYMENT, DLGR_ACCKIND_BACKOFFICE, date(0,0,0), DLGRACC_STATE_FACTEXEC) != 0 )
     return 1;
  end;

  return 0;
end;
