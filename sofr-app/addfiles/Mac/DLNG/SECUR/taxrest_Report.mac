/*
$Name:             taxrest_Report.mac
$Module:           €“
$Description:      Žâç¥â "‚ë¯« âë ¯® ®áâ âª ¬ æ/¡ ¢ ¯®àâä¥«¥ ¡ ­ª "
*/

import "DLReport_h.mac", "taxrest_Form.mac", "ws_txreportform.mac";;

private var TaxRest_Form;
private var TaxRest_Report;
PRIVATE VAR WebMenuItem; // ˆ­ä®à¬ æ¨ï ® § ¯ãáª¥ ®âç¥â  ¨§ ¢¥¡

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

private var
  Table = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
          "³   Š®¤ ¡ã¬ £¨  ³    ¨¬¥­®¢ ­¨¥ ¡ã¬ £¨   ³    Š®¤   ³   „ â     ³   ü á¤¥«ª¨    ³    „ â       ³  Š®«¨ç¥áâ¢® ¡ã¬ £  ³   „ â     ³     ‚¨¤     ³  ‘ã¬¬  ¢ë¯« âë ¢   ³ Šãàá – ­   ³  ‘ã¬¬  ¢ àã¡«ïå    ³ ƒàã¯¯  ­ «®£®¢®£®  ³ Š®¤ ISIN (­®¬¥à ³\n" +
          "³               ³                         ³  ¢ «îâë  ³ ¯®£ è¥­¨ï ³ ¯à¨®¡à¥â¥­¨ï  ³  ¯®áâ ¢ª¨    ³                    ³  ¢ë¯« âë  ³   ¢ë¯« âë:  ³  ¢ «îâ¥ ­®¬¨­ «    ³    ¤ âã     ³                    ³       ãç¥â         ³ £®áã¤ àáâ¢¥­­®© ³\n" +
          "³               ³                         ³ ­®¬¨­ «  ³  ¡ã¬ £¨   ³               ³  ¯® á¤¥«ª¥   ³                    ³           ³    ªã¯®­/   ³       ¡ã¬ £¨       ³  ¢ë¯« âë    ³                    ³                    ³ à¥£¨áâà æ¨¨)    ³\n" +
          "³               ³                         ³          ³           ³               ³   ¯®ªã¯ª¨    ³                    ³           ³  ¬®àâ¨§ æ¨ï ³                    ³             ³                    ³                    ³ æ¥­­®© ¡ã¬ £¨   ³\n" +
          "³               ³                         ³          ³           ³               ³ (¯¥à¥å®¤     ³                    ³           ³             ³                    ³             ³                    ³                    ³                 ³\n" +
          "³               ³                         ³          ³           ³               ³    ¯à ¢      ³                    ³           ³             ³                    ³             ³                    ³                    ³                 ³\n" +
          "³               ³                         ³          ³           ³               ³á®¡áâ¢¥­­®áâ¨)³                    ³           ³             ³                    ³             ³                    ³                    ³                 ³\n" +
          "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
          "³       1       ³           2             ³     3    ³     4     ³       5       ³       6      ³         7          ³     8     ³      9      ³         10         ³      11     ³         12         ³         13         ³         14      ³\n" +
          "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

private var ReportHeader =
"‚ë¯« âë ¯® ®áâ âª ¬ æ/¡ ¢ ¯®àâä¥«¥ ¡ ­ª \n" +
"„ â  ##########\n" +
"ƒàã¯¯  ­ «®£®¢®£® ãç¥â  ############################################\n"
"‚¨¤ æ\¡:    ##########################################\n" +
"‚ë¯ãáª æ\¡: #################################################################\n";


PRIVATE CLASS (DL_CReportTemplate) SP_TaxRest_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL )
  PRIVATE VAR m_SheetCount = 0,
              m_report,
              m_RepDate,
              m_ProgressValue = CTxProgressValue();
          var ProgressIndicator = CreateProgressIndicator(m_IsWebService);
  
  PRIVATE VAR m_IsDataExist = false; /*¤«ï Web, ¥á«¨ ­¥â ¤ ­­ëå, â® ­¨ç¥£® ­¥ ¯®ª §ë¢ ¥¬*/
  /* ­¥ ¯®ª §ë¢ âì ¯ãáâë¥ ®âç¥â ¢ Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*¢ EW ¯®ª §ë¢ ¥¬ «¨áâë ¢á¥£¤ */
    end;
  END; 

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    var
       FiKind = "¢á¥", 
       FiName = "¢á¥",
       GroupName = "¢á¥";

    record fins(fininstr);

    m_SheetCount = 0;
    m_RepDate  = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_DATE );

    TaxRest_Form.GetFieldValue( PNFLD_TAXREST_AVRCODE, @FiName );
    TaxRest_Form.GetFieldValue( PNFLD_TAXREST_AVRKIND, @FiKind );
    TaxRest_Form.GetFieldValue( PNFLD_TAXREST_TAXGROUP, @GroupName );

    SetActiveSheet( "Žâç¥â" );

    PrintFormatString( ReportHeader,
                       "N_H0€", m_RepDate,
                       "N_H0B", GroupName,
                       "N_H01", FiKind,
                       "N_H02", FiName
                     );

    RegisterTable( "N_MainTable", Table,
                   "N_SecCode",
                   "N_SecName",
                   "N_VN",
                   "N_RetDate",
                   "N_CodeB",
                   "N_DD",
                   "N_QntyDeal",
                   "N_DatePay",
                   "N_TypePay",
                   "N_SumPayVn",
                   "N_CrCB",
                   "N_SumPayRub",
                   "N_SecType",
                   "N_ISIN");

  END;

  PRIVATE MACRO PrintLine()
    var sql, rsd,
        TypePay = "",
        DatePay = date(0,0,0),
        SumPayVn = $0,
        CrCB = $0,
        SumPayRub = $0;

    sql = RSDCommand(" SELECT warnt.* "
        +            "   FROM dfiwarnts_dbt warnt "
        +            "  WHERE warnt.t_FIID = ? "
        +            "    AND warnt.t_DrawingDate >= ? "
        +            "    AND warnt.t_DrawingDate <= ? "
        +            " ORDER BY warnt.t_DrawingDate ASC " );

    sql.addParam( "", RSDBP_IN, m_report.FIID );
    sql.addParam( "", RSDBP_IN, date(m_report.SourceDealDate) );
    sql.addParam( "", RSDBP_IN, m_RepDate );
    sql.execute();

    rsd = TRsbDataSet(sql);
    while( rsd.MoveNext() )
       DatePay = date(rsd.DrawingDate);
       if( string(rsd.IsPartial) == "X" )
          TypePay = " ¬®àâ¨§ æ¨ï";
          var FaceValue;
          if( not SP_GetNominal(m_report.FIID, SQL_ConvTypeDate(rsd.DrawingDate), FaceValue, BO_CB) )
             SumPayVn = $0;
             msgbox("¥ ¬®£ã ¯®«ãç¨âì ­®¬¨­ « ä¨­. ¨­áâã¬¥­â  (FIID = " + String(m_report.FIID) + ") ­  ¤ âã "+string(SQL_ConvTypeDate(rsd.DrawingDate)));
          else
             SumPayVn = m_report.Amount * FaceValue * rsd.IncomeRate/MAX(1, rsd.IncomeScale)/100.0;
          end;
       else
          TypePay = "ªã¯®­";
          SumPayVn = ‘ã¬¬ Šã¯®­ (m_report.FIID, m_report.Amount, DatePay);
       end;

       SmartConvertSum(CrCB, $1, DatePay, m_report.FaceValueFI, NATCUR, false);
       SumPayRub = CrCB * SumPayVn;

       PrintTableLine( "N_SecCode",         m_report.finCode,                 null,
                       "N_SecName",         m_report.finName,                 null,
                       "N_VN",              m_report.ValueFI,                 null,
                       "N_RetDate",         date(m_report.finDrawingDate),    null,
                       "N_CodeB",           m_report.SourceDealCode,          null,
                       "N_DD",             date(m_report.SourceDealDate),    null,
                       "N_QntyDeal",        m_report.Amount,                  SetPrecisionByFractPart(m_report.Amount, m_report.finPrecision, 0),
                       "N_DatePay",         DatePay,                          null,
                       "N_TypePay",         TypePay,                          null,
                       "N_SumPayVn",        SumPayVn,                         null,
                       "N_CrCB",            CrCB,                             null,
                       "N_SumPayRub",       SumPayRub,                        null,
                       "N_SecType",         m_report.GroupName,               null,
                       "N_ISIN",            m_report.ISIN,                    null
                     );
    end;
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    while( m_report.MoveNext() )
      m_IsDataExist = true;
      PrintLine();
      m_ProgressValue.Current = m_ProgressValue.Current + 1;
      ProgressIndicator.Update(m_ProgressValue.Current,m_ProgressValue.Maximum); // ¢á¥£® 3 ¯ à ¬¥à  Update(index, count, text)
    end;

    EndTable();
    AddStandardFooter( "N_" );
  END;

  PRIVATE MACRO FormQuery()
    VAR sql,
        AvrFIIDList = null,
        AvrFIIDCount : Integer = 0,
        AvrFIIDAddWhere : String = "",

        AvrKindList = null,
        AvrKindAddWhere : String = "",
        AvrKindCount : Integer = 0,
         
        GNUList = null,
        GNUAddWhere : String = "",
        GNUCount : Integer = 0;

    sql = " SELECT fin.t_FIID, "
        +        " fin.t_FaceValueFI, "
        +        " fin.t_FI_Code finCode, "
        +        " fin.t_SumPrecision finPrecision, "                
        +        " fin.t_Name finName, "
        +        " fin.t_DrawingDate finDrawingDate, "
        +        " NVL((SELECT val.t_FI_Code "
        +               " FROM dfininstr_dbt val "
        +              " WHERE val.t_FIID = fin.t_FaceValueFI), '') ValueFI, "
        +        " src.t_DealCodeTS SourceDealCode, "
        +        " src.t_BuyDate SourceDealDate, "
        +        " rest.t_Amount, "
        +        " av.t_TaxGroup GroupName, "
        +        " (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN "

        +   " FROM (SELECT rst.t_SourceID, "
        +                " SUM(rst.t_Amount) t_Amount "
        +           " FROM dsctxrest_dbt rst "
        +          " WHERE (rst.t_SaleDate > " + GetSqlDate(m_RepDate)
        +              " OR rst.t_SaleDate = TO_DATE('01-01-0001','DD-MM-YYYY')) "
        +            " AND rst.t_BuyDate <= " + GetSqlDate(m_RepDate)
        +            " AND rst.t_Amount > 0 "
        +       " GROUP BY rst.t_SourceID ) rest, "
        +       "  DAVOIRISS_DBT av, "
        +        " dsctxlot_dbt src, "
        +        " dfininstr_dbt fin "

        +  " WHERE src.t_ID = rest.t_SourceID "
        +    " AND fin.t_FIID = src.t_FIID "
        +    " AND Fin.t_FIID = av.t_FIID ";

    if( not m_IsWebService )
       GNUList = TArray();
       GNUList[GNUList.Size] = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_TAXGROUP );
    else
       GNUList = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_TAXGROUP );
    end;
    /*§ ¤ ­  ª â¥£®à¨ï ¡ã¬ £¨*/
    if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
       while( GNUCount < GNUList.Size )
          if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
          and ( GNUList[GNUCount] > 0 ) )
           if( GNUAddWhere == "" )
                GNUAddWhere = GNUAddWhere + " AND ( ";
             else
                GNUAddWhere = GNUAddWhere + " OR ";
              end;
              GNUAddWhere = GNUAddWhere + " av.t_TaxGroup = " + String( GNUList[GNUCount] ) + " ";
           end;
           GNUCount = GNUCount + 1;
        end;
        if( GNUAddWhere != "" )
           GNUAddWhere = GNUAddWhere + " ) ";
        end;
        sql = sql + GNUAddWhere;
     end;

    sql = sql
        +    " AND Exists(SELECT warnt.t_DrawingDate "
        +                 " FROM dfiwarnts_dbt warnt "
        +                " WHERE warnt.t_FIID = fin.t_FIID "
        +                  " AND warnt.t_DrawingDate >= src.t_BuyDate "
        +                  " AND warnt.t_DrawingDate <= " + GetSQLDate(m_RepDate) + ") ";

    if( not m_IsWebService )
       AvrKindList = TArray();
       AvrKindList[AvrKindList.Size] = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_AVRKIND );
    else
       AvrKindList = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_AVRKIND );
    end;
    /*§ ¤ ­ ¢¨¤ ¡ã¬ £¨*/
    if( ( ValType( AvrKindList ) != V_UNDEF ) and ( AvrKindList.Size > 0 ) )
       while( AvrKindCount < AvrKindList.Size )
          if( ( ValType( AvrKindList[AvrKindCount] ) == V_INTEGER )
          and ( AvrKindList[AvrKindCount] > 0 ) )
             if( AvrKindAddWhere == "" )
                AvrKindAddWhere = AvrKindAddWhere + " AND ( ";
             else
                AvrKindAddWhere = AvrKindAddWhere + " OR ";
             end;
             AvrKindAddWhere = AvrKindAddWhere + " RSB_FIInstr.FI_AvrKindsEQ( " + string(FIKIND_AVOIRISS) + ", " + String( AvrKindList[AvrKindCount] ) + ", fin.t_AvoirKind) > 0 ";
          end;
          AvrKindCount = AvrKindCount + 1;
       end;
       if( AvrKindAddWhere != "" )
          AvrKindAddWhere = AvrKindAddWhere + " ) ";
       end;
       sql = sql + AvrKindAddWhere;      
    end;

     if( not m_IsWebService )
        AvrFIIDList = TArray();
        AvrFIIDList[AvrFIIDList.Size] = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_AVRCODE );
     else
        AvrFIIDList = TaxRest_Form.GetFieldValue( PNFLD_TAXREST_AVRCODE );
     end;
     if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
        while( AvrFIIDCount < AvrFIIDList.Size )
           if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
           and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
              if( AvrFIIDAddWhere == "" )
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
              else
                 AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
              end;
              AvrFIIDAddWhere = AvrFIIDAddWhere + " fin.t_FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
           end;
           AvrFIIDCount = AvrFIIDCount + 1;
        end;
        if( AvrFIIDAddWhere != "" )
           AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
        end;
        sql = sql + AvrFIIDAddWhere;
     end;

    sql = sql
        + " ORDER BY GroupName, "
        +          " finCode, "
        +          " SourceDealDate, "
        +          " src.t_DealDate, "
        +          " src.t_DealTime, "
        +          " SourceDealCode ";

    return sql;
  END;

  PRIVATE MACRO Create()
    var sql;

    sql = FormQuery();

    m_ProgressValue.Maximum = SQL_GetNRecs( sql );
    m_ProgressValue.Current = 0;

    m_report = TRsbDataSet(sql);

    if( m_IsWebService and (WebMenuItem != null) )
      var header = "”®à¬¨à®¢ ­¨¥ ®âç¥â  " + WebMenuItem.szNameItem;
      ProgressIndicator.Start(m_ProgressValue.Maximum, header, header);
    else
      ProgressIndicator.Start(m_ProgressValue.Maximum, "Žâ¡®à ¤ ­­ëå ¤«ï ®âç¥â  \"‚ë¯« âë ¯® ®áâ âª ¬ æ/¡ ¢ ¯®àâä¥«¥ ¡ ­ª \"", "‚ë¯« âë ¯® ®áâ âª ¬ æ/¡ ¢ ¯®àâä¥«¥ ¡ ­ª ");
    end;    

    ExecuteReport();

    ProgressIndicator.Stop();
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    TaxRest_Form = SP_TaxRest_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      TaxRest_Form = WS_TX_TaxRest_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = TaxRest_Form.Run();
    end;

    if( stat )
      TaxRest_Report = SP_TaxRest_Report( null, "Report_TaxRest.xlsx", false, IsWebService, ReportHashCode, POI_MODE, BIGREPORT_MODE );
      TaxRest_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( TaxRest_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = TaxRest_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( TaxRest_Report.PrintMode() );
      end;
    end;
  end;

  return FullReportFileNames;
END;
