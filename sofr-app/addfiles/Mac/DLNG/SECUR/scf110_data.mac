/*
$Name:        scf110_data.mac
$Module:      Ценные бумаги
$Description: Данные для отчета "Расшифровки отдельных показателей деятельности кредитной организации" - (форма 0409110)
*/
import "spserv.mac", "dlmisc.mac", "PARAM.MAC";

Private var LLCLASS_KINDRESERV_KIND = 530;
/*Private var   NOTEKIND_AVOIR_SUMPDO_NKD_P_SSSD   = 31,                   // Сумма в ПДО из СССД на дату перехода в ВН (нкд уплаченный)
              NOTEKIND_AVOIR_SUMPDO_NKD_P_SSPU   = 32,                   // Сумма в ПДО из ССПУ на дату перехода в ВН (нкд уплаченный)
              NOTEKIND_AVOIR_SUMPDO_NKD_A_SSSD   = 33,                   // Сумма в ПДО из СССД на дату перехода в ВН (нкд начисленный)
              NOTEKIND_AVOIR_SUMPDO_NKD_A_SSPU   = 34,                   // Сумма в ПДО из ССПУ на дату перехода в ВН (нкд начисленный)
              NOTEKIND_AVOIR_SUMPDO_DISC_SSSD    = 35,                   // Сумма в ПДО из СССД на дату перехода в ВН (дисконт)
              NOTEKIND_AVOIR_SUMPDO_DISC_SSPU    = 36;                   // Сумма в ПДО из ССПУ на дату перехода в ВН (дисконт)
*/
PRIVATE MACRO LoadSFC110TMP(BegDate:date, EndDate:date, DepartmentStr:string)
  var query, cmd;

  InitProgress(-1, "Подготовка данных для раздела 2", "Подготовка данных для раздела 2");
  
  SQL_Execute("DELETE FROM DSCF110_TMP ", null, false );
  SQL_Execute("DELETE FROM dscf110_dbt where t_sysdate < sysdate - 1 or t_sessionid = sys_context('USERENV','SESSIONID') ");

  //Проводки операции резервирования по счету "-КорОР_ЦБ"
  query =   " INSERT INTO DSCF110_DBT (T_ACCTRNID, "   
          + "                          T_CARRYSUM, "
          + "                          T_ID_OPERATION, "
          + "                          T_ID_STEP, "
          + "                          T_FIID, "
          + "                          T_PORTFOLIO, "
          + "                          T_AMOUNT, "
          + "                          T_COST, "
          + "                          T_NKDAMOUNT, "
          + "                          T_INTERESTINCOME, "
          + "                          T_DISCOUNTINCOME, "
          + "                          T_OUTLAY, "
          + "                          T_CORRVALUE, "
          + "                          T_CORRINTTOEIR, "
          + "                          T_S385_16, "
          + "                          T_S386_17, "
          + "                          T_S175_16, "
          + "                          T_S176_17, "
          + "                          T_S_4_4, "
          + "                          T_S_4_2  "
          + "                         ) "
          + " with mCorAcc as (select /*+ materialize */ DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, "
          + "                         (case when cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
          + "                               when cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
          + "                               when cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
          + "                               when cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
          + "                               when cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
          + "                               when cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
          + "                               when cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
          + "                               when cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
          + "                               else -1 end) as PortfolioID "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
          + "                   where cat.t_Code     = '-КорОР_ЦБ' "
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and tpl.t_CatID    = accdoc.t_CatID "
          + "                     and tpl.t_Number   = accdoc.t_TemplNum "
          + "                 ) " 
          + " select /*+ ordered use_nl(atrn)*/atrn.t_AccTrnID, "
          + "        atrn.t_Sum_Payer, "
          + "        oprdoc.t_ID_Operation, "
          + "        oprdoc.t_ID_Step, "
          + "        TO_NUMBER(opr.t_DocumentID) as FIID, "
          + "        mCorAcc.PortfolioID, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0  "
          + "   from mCorAcc, dacctrn_dbt atrn, doprdocs_dbt oprdoc, doproper_dbt opr "
          + "  where mCorAcc.PortfolioId IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")"
          + "    and atrn.t_State         = 1 "
          + "    and atrn.t_Chapter       = mCorAcc.t_Chapter "
          + "    and atrn.t_Account_Payer = mCorAcc.t_Account "
          + "    and atrn.t_FIID_Payer    = mCorAcc.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          +IIF(DepartmentStr != "", " and atrn.t_Department IN ("+DepartmentStr+")", "")
          + "    and oprdoc.t_AccTrnID  = atrn.t_AccTrnID "
          + "    and oprdoc.t_ServDocKind = " + DL_RESERVEDOC
          + "    and opr.t_ID_Operation = oprdoc.t_ID_Operation "
          + "    and opr.t_DocKind = " + DLDOC_ISSUE;

   cmd = RSDCommand(query);
   cmd.addParam( "", RSDBP_IN, BegDate );
   cmd.addParam( "", RSDBP_IN, EndDate );
   SQL_Execute(cmd);

   //Проводки операции резервирования по счету "+КорОР_ЦБ"
   query =  " INSERT INTO DSCF110_DBT (T_ACCTRNID, "
          + "                          T_CARRYSUM, "
          + "                          T_ID_OPERATION, "
          + "                          T_ID_STEP, "
          + "                          T_FIID, "
          + "                          T_PORTFOLIO, "
          + "                          T_AMOUNT, "
          + "                          T_COST, "
          + "                          T_NKDAMOUNT, "
          + "                          T_INTERESTINCOME, "
          + "                          T_DISCOUNTINCOME, "
          + "                          T_OUTLAY, "
          + "                          T_CORRVALUE, "
          + "                          T_CORRINTTOEIR, "
          + "                          T_S385_16, "
          + "                          T_S386_17, "
          + "                          T_S175_16, "
          + "                          T_S176_17, "
          + "                          T_S_4_4, "
          + "                          T_S_4_2  "
          + "                         )"
          + " with pCorAcc as (select /*+ materialize */ DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, "
          + "                         (case when cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
          + "                               when cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
          + "                               when cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
          + "                               when cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
          + "                               when cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
          + "                               when cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
          + "                               when cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
          + "                               when cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
          + "                               else -1 end) as PortfolioID "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
          + "                   where cat.t_Code     = '+КорОР_ЦБ' "
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and tpl.t_CatID    = accdoc.t_CatID "
          + "                     and tpl.t_Number   = accdoc.t_TemplNum "
          + "                 ) "
          + " select /*+ ordered use_nl(atrn) */ atrn.t_AccTrnID, "
          + "        (-1*atrn.t_Sum_Receiver), "
          + "        oprdoc.t_ID_Operation, "
          + "        oprdoc.t_ID_Step, "
          + "        TO_NUMBER(opr.t_DocumentID) as FIID, "
          + "        pCorAcc.PortfolioID, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0  "
          + "   from pCorAcc, dacctrn_dbt atrn, doprdocs_dbt oprdoc, doproper_dbt opr  "
          + "  where pCorAcc.PortfolioId IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")"
          + "    and atrn.t_State            = 1 "
          + "    and atrn.t_Chapter          = pCorAcc.t_Chapter "
          + "    and atrn.t_Account_Receiver = pCorAcc.t_Account "
          + "    and atrn.t_FIID_Receiver    = pCorAcc.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          +IIF(DepartmentStr != "", " and atrn.t_Department IN ("+DepartmentStr+")", "")
          + "    and oprdoc.t_AccTrnID  = atrn.t_AccTrnID "
          + "    and oprdoc.t_ServDocKind = " + DL_RESERVEDOC
          + "    and opr.t_ID_Operation = oprdoc.t_ID_Operation "
          + "    and opr.t_DocKind = " + DLDOC_ISSUE;

   cmd = RSDCommand(query);
   cmd.addParam( "", RSDBP_IN, BegDate );
   cmd.addParam( "", RSDBP_IN, EndDate );
   SQL_Execute(cmd);

  SQL_Execute("commit");

   //Обновить информацию по лотам

  query = " DECLARE "+
          " l_task_name   VARCHAR2 (30); "+
          " l_sql_stmt VARCHAR2(3000); "+
          " l_chunk_sql VARCHAR2(3000); "+
          " l_try NUMBER; "+
          " l_status NUMBER; "+
        " BEGIN "+
          " l_task_name := DBMS_PARALLEL_EXECUTE.generate_task_name; "+
          " DBMS_PARALLEL_EXECUTE.CREATE_TASK (l_task_name); "+
          " l_chunk_sql := 'SELECT t_sessionid, t_id FROM DSCF110_DBT where t_sessionid = sys_context(''USERENV'',''SESSIONID'')' ;"+
          " DBMS_PARALLEL_EXECUTE.CREATE_CHUNKS_BY_SQL(l_task_name, l_chunk_sql, false) ; "+ 
          " l_sql_stmt := 'UPDATE DSCF110_DBT f110  "+
          "   SET (f110.T_AMOUNT, f110.T_COST, f110.T_NKDAMOUNT, f110.T_INTERESTINCOME, f110.T_DISCOUNTINCOME, f110.T_OUTLAY, f110.T_CORRVALUE, f110.T_CORRINTTOEIR)  "+
          "    =  (select NVL(SUM(wrt.t_Amount), 0),  "+
                        " NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_Cost + wrt.t_CostPFI, fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0),  "+
                        " NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_NKDAmount,            fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0),  "+
                        " NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_InterestIncome,       fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0),  "+
                        " NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_DiscountIncome,       fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0),  "+
                        " NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_Outlay,               fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0),  "+
                        " NVL(SUM(wrt.t_CorrValue), 0),  "+
                        " NVL(SUM(wrt.t_CorrIntToEIR), 0)   "+ 
                     " from v_scwrthistex wrt, dacctrn_dbt atrn , dfininstr_dbt fin  "+
                     " where wrt.t_ID_Operation = f110.t_ID_Operation   "+
                     "   AND f110.t_AccTrnID      = atrn.t_AccTrnID "+
                    " and wrt.t_Instance = (SELECT Max(wrt_i.t_Instance) "+ 
                                                " FROM v_scwrthistex wrt_i "+ 
                                               " WHERE wrt_i.t_sumid        = wrt.t_sumid "+ 
                                                "  AND decode(wrt_i.t_ID_Operation,wrt.t_ID_Operation,1,0)= 1  "+
                                                "  AND wrt_i.t_ChangeDate   = atrn.t_date_Carry ) "+
                    " and decode(wrt.t_Party," + UnknownParty+",1,0)=1 "+
                    " and decode(wrt.t_FIID,f110.t_FIID,1,0)=1  "+
                    " and decode(wrt.t_Portfolio,f110.t_Portfolio,1,0)=1 "+ 
                    " and fin.t_FIID         = f110.t_FIID ) "+
              " WHERE t_sessionid = :start_id AND t_id = :end_id '; "+
          " DBMS_PARALLEL_EXECUTE.RUN_TASK(l_task_name, l_sql_stmt, DBMS_SQL.NATIVE, parallel_level => 12); "+
          " L_try := 0; "+
          " L_status := DBMS_PARALLEL_EXECUTE.TASK_STATUS(l_task_name); "+
          " WHILE(l_try < 2 and L_status != DBMS_PARALLEL_EXECUTE.FINISHED)  "+
          " LOOP "+
           "  L_try := l_try + 1; "+
           "  DBMS_PARALLEL_EXECUTE.RESUME_TASK(l_task_name); "+
           "  L_status := DBMS_PARALLEL_EXECUTE.TASK_STATUS(l_task_name); "+
          " END LOOP; "+
          " DBMS_PARALLEL_EXECUTE.DROP_TASK(l_task_name); "+
        " END; " ;
   SQL_Execute(query);

   
/*
   query =   " UPDATE DSCF110_TMP f110 "
           + "    SET (f110.T_AMOUNT, f110.T_COST, f110.T_NKDAMOUNT, f110.T_INTERESTINCOME, f110.T_DISCOUNTINCOME, f110.T_OUTLAY, f110.T_CORRVALUE, f110.T_CORRINTTOEIR) "
           + "     =  (select NVL(SUM(wrt.t_Amount), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_Cost + wrt.t_CostPFI, fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_NKDAmount,            fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_InterestIncome,       fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_DiscountIncome,       fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_Outlay,               fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(SUM(wrt.t_CorrValue), 0), "
           + "                NVL(SUM(wrt.t_CorrIntToEIR), 0) "  
           + "             from v_scwrthistex wrt, dacctrn_dbt atrn , dfininstr_dbt fin "
           + "             where wrt.t_ID_Operation = f110.t_ID_Operation  "
           + "               AND f110.t_AccTrnID      = atrn.t_AccTrnID"
//           + "            and wrt.t_ID_Step      = f110.t_ID_Step "
           + "            and wrt.t_Instance = (SELECT Max(wrt_i.t_Instance) "
           + "                                        FROM v_scwrthistex wrt_i "
           + "                                       WHERE wrt_i.t_sumid        = wrt.t_sumid "
           + "                                         AND decode(wrt_i.t_ID_Operation,wrt.t_ID_Operation,1,0)= 1 "
           + "                                         AND wrt_i.t_ChangeDate   = atrn.t_date_Carry )"
           + "            and decode(wrt.t_Party," + UnknownParty+",1,0)=1"
           + "            and decode(wrt.t_FIID,f110.t_FIID,1,0)=1 "
           + "            and decode(wrt.t_Portfolio,f110.t_Portfolio,1,0)=1 "
           + "            and fin.t_FIID         = f110.t_FIID "
           + "        ) ";
 */
 /*
   query =   " UPDATE DSCF110_TMP f110 "
           + "    SET (f110.T_AMOUNT, f110.T_COST, f110.T_NKDAMOUNT, f110.T_INTERESTINCOME, f110.T_DISCOUNTINCOME, f110.T_OUTLAY, f110.T_CORRVALUE, f110.T_CORRINTTOEIR) "
           + "     =  (select NVL(SUM(wrt.t_Amount), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_Cost + wrt.t_CostPFI, fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_NKDAmount,            fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_InterestIncome,       fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_DiscountIncome,       fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(wrt.t_Outlay,               fin.t_FaceValueFI, "+NATCUR+", wrt.t_ChangeDate, 1)),2), 0), "
           + "                NVL(SUM(wrt.t_CorrValue), 0), "
           + "                NVL(SUM(wrt.t_CorrIntToEIR), 0) "  
           + "           from v_scwrthistex wrt, dfininstr_dbt fin "
           + "          where wrt.t_ID_Operation = f110.t_ID_Operation "
//           + "            and wrt.t_ID_Step      = f110.t_ID_Step "
           + "            and wrt.t_Instance     = (SELECT Max(wrt_i.t_Instance) "
           + "                                        FROM v_scwrthistex wrt_i, dacctrn_dbt atrn "
           + "                                       WHERE wrt_i.t_sumid        = wrt.t_sumid "
           + "                                         AND wrt_i.t_ID_Operation = wrt.t_ID_Operation "
           + "                                         AND wrt_i.t_ChangeDate   = atrn.t_date_Carry "
           + "                                         AND f110.t_AccTrnID      = atrn.t_AccTrnID ) "
           + "            and wrt.t_Party        = " + UnknownParty
           + "            and wrt.t_FIID         = f110.t_FIID "
           + "            and wrt.t_Portfolio    = f110.t_Portfolio "
           + "            and fin.t_FIID         = wrt.t_FIID "
           + "        ) ";
*/

  query =  " INSERT INTO DSCF110_TMP ( T_ACCTRNID, "
                                  + "  T_CARRYSUM, "
                                  + "  T_ID_OPERATION, "
                                  + "  T_ID_STEP, "
                                  + "  T_FIID, "
                                  + "  T_PORTFOLIO, "
                                  + "  T_AMOUNT, "
                                  + "  T_COST, "
                                  + "  T_NKDAMOUNT, "
                                  + "  T_INTERESTINCOME, "
                                  + "  T_DISCOUNTINCOME, "
                                  + "  T_OUTLAY, "
                                  + "  T_CORRVALUE, "
                                  + "  T_CORRINTTOEIR, "
                                  + "  T_S385_16, "
                                  + "  T_S386_17, "
                                  + "  T_S175_16, "
                                  + "  T_S176_17, "
                                  + "  T_S_4_4, "
                                  + "  T_S_4_2  )"
                           + " SELECT  T_ACCTRNID, "
                                  + "  T_CARRYSUM, "
                                  + "  T_ID_OPERATION, "
                                  + "  T_ID_STEP, "
                                  + "  T_FIID, "
                                  + "  T_PORTFOLIO, "
                                  + "  T_AMOUNT, "
                                  + "  T_COST, "
                                  + "  T_NKDAMOUNT, "
                                  + "  T_INTERESTINCOME, "
                                  + "  T_DISCOUNTINCOME, "
                                  + "  T_OUTLAY, "
                                  + "  T_CORRVALUE, "
                                  + "  T_CORRINTTOEIR, "
                                  + "  T_S385_16, "
                                  + "  T_S386_17, "
                                  + "  T_S175_16, "
                                  + "  T_S176_17, "
                                  + "  T_S_4_4, "
                                  + "  T_S_4_2  "
                                  + "  FROM DSCF110_DBT  where t_sessionid = sys_context('USERENV','SESSIONID') " ;

   SQL_Execute(query);

   SQL_Execute("DELETE FROM dscf110_dbt where t_sessionid = sys_context('USERENV','SESSIONID') ");

   //Проводки СОБУ по по счету "-КорОР_ЦБ"
   query =  " INSERT INTO DSCF110_TMP (T_ACCTRNID, "
          + "                          T_CARRYSUM, "
          + "                          T_ID_OPERATION, "
          + "                          T_ID_STEP, "
          + "                          T_FIID, "
          + "                          T_PORTFOLIO, "
          + "                          T_AMOUNT, "
          + "                          T_COST, "
          + "                          T_NKDAMOUNT, "
          + "                          T_INTERESTINCOME, "
          + "                          T_DISCOUNTINCOME, "
          + "                          T_OUTLAY, "
          + "                          T_CORRVALUE, "
          + "                          T_CORRINTTOEIR, "
          + "                          T_S385_16, "
          + "                          T_S386_17, "
          + "                          T_S175_16, "
          + "                          T_S176_17, "
          + "                          T_S_4_4, "
          + "                          T_S_4_2  "
          + "                         )"
          + " with mCorAcc as (select /*+ materialize */ DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, "
          + "                         (case when cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
          + "                               when cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
          + "                               when cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
          + "                               when cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
          + "                               when cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
          + "                               when cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
          + "                               when cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
          + "                               when cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
          + "                               else -1 end) as PortfolioID "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
          + "                   where cat.t_Code     = '-КорОР_ЦБ' "
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and tpl.t_CatID    = accdoc.t_CatID "
          + "                     and tpl.t_Number   = accdoc.t_TemplNum "
          + "                 ) "
          + " select /*+ ordered use_nl(atrn) */ atrn.t_AccTrnID, "
          + "        atrn.t_Sum_Payer, "
          + "        grdoc.t_ServDocID, "
          + "        -1, "
          + "        grd.t_FIID, "
          + "        mCorAcc.PortfolioID, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0  "
          + "   from mCorAcc, dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grd "
          + "  where mCorAcc.PortfolioId IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")"
          + "    and atrn.t_State       = 1 "
          + "    and atrn.t_Chapter       = mCorAcc.t_Chapter "
          + "    and atrn.t_Account_Payer = mCorAcc.t_Account "
          + "    and atrn.t_FIID_Payer    = mCorAcc.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          + "    and grdoc.t_DocID  = atrn.t_AccTrnID "
          + "    and grdoc.t_DocKind = " + DLDOC_CARRY
          + "    and grdoc.t_ServDocKind = " + DL_SCACCOUNTING
          + "    and grd.t_ID = grdoc.t_GrDealID ";

   cmd = RSDCommand(query);
   cmd.addParam( "", RSDBP_IN, BegDate );
   cmd.addParam( "", RSDBP_IN, EndDate );
   SQL_Execute(cmd);


   //Проводки СОБУ по по счету "+КорОР_ЦБ"
   query =  " INSERT INTO DSCF110_TMP (T_ACCTRNID, "
          + "                          T_CARRYSUM, "
          + "                          T_ID_OPERATION, "
          + "                          T_ID_STEP, "
          + "                          T_FIID, "
          + "                          T_PORTFOLIO, "
          + "                          T_AMOUNT, "
          + "                          T_COST, "
          + "                          T_NKDAMOUNT, "
          + "                          T_INTERESTINCOME, "
          + "                          T_DISCOUNTINCOME, "
          + "                          T_OUTLAY, "
          + "                          T_CORRVALUE, "
          + "                          T_CORRINTTOEIR, "
          + "                          T_S385_16, "
          + "                          T_S386_17, "
          + "                          T_S175_16, "
          + "                          T_S176_17, "
          + "                          T_S_4_4, "
          + "                          T_S_4_2  "
          + "                         )"
          + " with pCorAcc as (select /*+ materialize */ DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, "
          + "                         (case when cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
          + "                               when cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
          + "                               when cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
          + "                               when cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
          + "                               when cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
          + "                               when cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
          + "                               when cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
          + "                               when cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
          + "                               else -1 end) as PortfolioID "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
          + "                   where cat.t_Code     = '+КорОР_ЦБ' "
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and tpl.t_CatID    = accdoc.t_CatID "
          + "                     and tpl.t_Number   = accdoc.t_TemplNum "
          + "                 ) "
          + " select /*+ ordered use_nl(atrn) */ atrn.t_AccTrnID, "
          + "        (-1*atrn.t_Sum_Receiver), "
          + "        grdoc.t_ServDocID, "
          + "        -1, "
          + "        grd.t_FIID, "
          + "        pCorAcc.PortfolioID, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0, "
          + "        0  "
          + "   from pCorAcc, dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grd "
          + "  where pCorAcc.PortfolioId IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")"
          + "    and atrn.t_State            = 1 "
          + "    and atrn.t_Chapter          = pCorAcc.t_Chapter "
          + "    and atrn.t_Account_Receiver = pCorAcc.t_Account "
          + "    and atrn.t_FIID_Receiver    = pCorAcc.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          + "    and grdoc.t_DocID  = atrn.t_AccTrnID "
          + "    and grdoc.t_DocKind = " + DLDOC_CARRY
          + "    and grdoc.t_ServDocKind = " + DL_SCACCOUNTING
          + "    and grd.t_ID = grdoc.t_GrDealID ";

   cmd = RSDCommand(query);
   cmd.addParam( "", RSDBP_IN, BegDate );
   cmd.addParam( "", RSDBP_IN, EndDate );
   SQL_Execute(cmd);


   //Обновить информацию по лотам и связям
   query =   " UPDATE DSCF110_TMP f110 "
           + "    SET (f110.T_AMOUNT, f110.T_COST, f110.T_NKDAMOUNT, f110.T_INTERESTINCOME, f110.T_DISCOUNTINCOME, f110.T_OUTLAY, f110.T_CORRVALUE, f110.T_CORRINTTOEIR) "
           + "     =  (select NVL(SUM(lnk.t_Amount), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(lnk.t_CostBuy + lnk.t_CostPFIBuy - lnk.t_BonusAdd, fin.t_FaceValueFI, "+NATCUR+", lnk.t_CreateDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(lnk.t_NKDBuyAmount,                                fin.t_FaceValueFI, "+NATCUR+", lnk.t_CreateDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(lnk.t_InterestIncomeBuy+lnk.t_InterestIncomeAdd,   fin.t_FaceValueFI, "+NATCUR+", lnk.t_CreateDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(lnk.t_DiscountIncomeBuy+lnk.t_DiscountIncomeAdd,   fin.t_FaceValueFI, "+NATCUR+", lnk.t_CreateDate, 1)),2), 0), "
           + "                NVL(ROUND(SUM(RSI_RSB_FIInstr.ConvSum(lnk.t_OutlayBuy,                                   fin.t_FaceValueFI, "+NATCUR+", lnk.t_CreateDate, 1)),2), 0), "
           + "                NVL(SUM(lnk.t_CorrValueChange), 0), "
           + "                NVL(SUM(lnk.t_CorrIntToEIRChange+lnk.t_CorrIntToEIRAdd), 0) "  
           + "           from dpmwrtlnk_dbt lnk, dfininstr_dbt fin, "
           + "                (SELECT wrt.t_SumID, doc.t_DocID "
           + "                   FROM dpmwrtsum_dbt wrt, ddlgrdeal_dbt grd, ddlgrdoc_dbt doc"
           + "                  WHERE wrt.t_dealid  = grd.t_docid "                        
           + "                    AND grd.t_ID      = doc.t_GrDealID "
           + "                    AND doc.t_DocKind = " + DLDOC_CARRY
           + "                ) dts"
           + "          where lnk.t_ID_Operation = f110.t_ID_Operation "
           + "            and lnk.t_ID_Step = f110.t_ID_Step "
           + "            and Exists(select 1 "
           + "                         from v_scwrthistex wrt "
           + "                        where wrt.t_SumID        = lnk.t_BuyID "
           + "                          and decode(wrt.t_ID_Operation , lnk.t_ID_Operation,1,0)=1 "
           + "                          and decode(wrt.t_ID_Step      , lnk.t_ID_Step,1,0)=1 "
           + "                          and decode(wrt.t_FIID         , f110.t_FIID,1,0)=1 "
           + "                          and decode(wrt.t_Party        , " + UnknownParty+" ,1,0)=1 "
           + "                          and decode(wrt.t_Portfolio    , f110.t_Portfolio ,1,0)=1 "
           + "                      )"
           + "            and fin.t_FIID = f110.t_FIID "
           + "            and LNK.T_SALEID =  dts.T_SUMID "
           + "            and dts.T_DOCID = f110.T_ACCTRNID "
           + "        ) "
           + " WHERE f110.t_ID_Step = -1 ";

   SQL_Execute(query);


///////////////////////////////////////////
   query = "DELETE FROM DSCF110_TMP WHERE T_AMOUNT = 0"; //Такое вряд ли возможно, но если ошибочно у счета портфель не такой как у лота, то может быть 0
   SQL_Execute(query);
   
   //Обновить информацию по расшифровкам
   query =   " UPDATE DSCF110_TMP f110 "
           + "    SET f110.T_S_4_4 = (CASE WHEN f110.T_CARRYSUM > 0 "
           + "                                  THEN ROUND((f110.T_CARRYSUM/(f110.T_COST+f110.T_NKDAMOUNT+f110.T_INTERESTINCOME+f110.T_DISCOUNTINCOME+f110.T_CORRVALUE+f110.T_CORRINTTOEIR)*(f110.T_INTERESTINCOME+f110.T_DISCOUNTINCOME)), 2) "
           + "                             ELSE 0 END), "
           + "        f110.T_S_4_2 = (CASE WHEN f110.T_CARRYSUM < 0 "
           + "                                  THEN ROUND((ABS(f110.T_CARRYSUM)/(f110.T_COST+f110.T_NKDAMOUNT+f110.T_INTERESTINCOME+f110.T_DISCOUNTINCOME+f110.T_CORRVALUE+f110.T_CORRINTTOEIR)*(f110.T_INTERESTINCOME+f110.T_DISCOUNTINCOME)), 2) "
           + "                             ELSE 0 END) ";

   SQL_Execute(query);


   //Обновить информацию по расшифровкам
   query =   " UPDATE DSCF110_TMP f110 "
           + "    SET f110.T_S385_16 = (CASE WHEN f110.T_PORTFOLIO = "+KINDPORT_SSSD+" AND f110.T_CARRYSUM > 0 THEN (f110.T_CARRYSUM - f110.T_S_4_4) ELSE 0 END), "
           + "        f110.T_S175_16 = (CASE WHEN f110.T_PORTFOLIO = "+KINDPORT_SSSD+" AND f110.T_CARRYSUM < 0 THEN ABS(f110.T_CARRYSUM) - f110.T_S_4_2 ELSE 0 END), "
           + "        f110.T_S386_17 = (CASE WHEN f110.T_PORTFOLIO = "+KINDPORT_ASCB+" AND f110.T_CARRYSUM > 0 THEN (f110.T_CARRYSUM - f110.T_S_4_4) ELSE 0 END), "    
           + "        f110.T_S176_17 = (CASE WHEN f110.T_PORTFOLIO = "+KINDPORT_ASCB+" AND f110.T_CARRYSUM < 0 THEN ABS(f110.T_CARRYSUM) - f110.T_S_4_2 ELSE 0 END) ";

   SQL_Execute(query);

   RemProgress();

END;


CLASS SP_F110_Data(BegDate:date, EndDate:date, DepartmentList:TArray)
  private var m_BegDate = date(0,0,0), m_EndDate = date(0,0,0), m_DepartmentStr = "";
  private var m_A1, m_A2, m_A3, m_A4, m_A5, m_A6, 
   m_A7, m_A8, m_A9, m_A10, m_A11, m_A12, m_A13, m_A14, m_A15, m_A16, m_A17, m_A18, m_A19, m_A20, m_A21,  m_A22, m_A23, m_A24, m_A25, m_A26,
   m_A27, m_A28, m_A29, m_A30, m_A31, m_A32, m_A33, m_A34, m_A35, m_A36, m_A37, m_A38, m_A39, m_A40;
  private var m_ReservSum_SSPU, m_CorrEstReservSum_SSPU, m_ReservSum_SSSD, m_CorrEstReservSum_SSSD;
  private var m_PlusDeltaEstReserveInc_SSSD, m_PlusDeltaEstReserve_SSSD, m_MinusDeltaEstReserveInc_SSSD, m_MinusDeltaEstReserve_SSSD;   
  private var m_PlusDeltaEstReserveInc_ASCB, m_PlusDeltaEstReserve_ASCB, m_MinusDeltaEstReserveInc_ASCB, m_MinusDeltaEstReserve_ASCB;   

  
  PRIVATE MACRO Clear()
    m_A1  = NULL;
    m_A2  = NULL;
    m_A3  = NULL;
    m_A4  = NULL;
    m_A5  = NULL;
    m_A6  = NULL;
    m_A7  = NULL;
    m_A8  = NULL;
    m_A9  = NULL;
    m_A10 = NULL;
    m_A11 = NULL;
    m_A12 = NULL;
    m_A13 = NULL;
    m_A14 = NULL;
    m_A15 = NULL;
    m_A16 = NULL;
    m_A17 = NULL;
    m_A18 = NULL;
    m_A19 = NULL;
    m_A20 = NULL;
    m_A21 = NULL;
    m_A22 = NULL;
    m_A23 = NULL;
    m_A24 = NULL;
    m_A25 = NULL;
    m_A26 = NULL;
    m_A27 = NULL;
    m_A28 = NULL;
    m_A29 = NULL;
    m_A30 = NULL;
    m_A31 = NULL;
    m_A32 = NULL;
    m_A33 = NULL;
    m_A34 = NULL;
    m_A35 = NULL;
    m_A36 = NULL;
    m_A37 = NULL;
    m_A38 = NULL;
    m_A39 = NULL;
    m_A40 = NULL;

    m_ReservSum_SSPU = NULL;
    m_CorrEstReservSum_SSPU = NULL;
    m_ReservSum_SSSD = NULL;
    m_CorrEstReservSum_SSSD = NULL;

    m_PlusDeltaEstReserveInc_SSSD  = NULL;
    m_PlusDeltaEstReserve_SSSD     = NULL;
    m_MinusDeltaEstReserveInc_SSSD = NULL;
    m_MinusDeltaEstReserve_SSSD    = NULL;

    m_PlusDeltaEstReserveInc_ASCB  = NULL;
    m_PlusDeltaEstReserve_ASCB     = NULL;
    m_MinusDeltaEstReserveInc_ASCB = NULL;
    m_MinusDeltaEstReserve_ASCB    = NULL;

  END;
//      IsDebet = true  категория резерв стоит по дебету
  PRIVATE MACRO GetSum_PartTwo(КатегорияД, КатегорияК,IsDebet, value1, value2, value3, value4,/* ВидРез, БэкОф, КатКотОД,*/ dockind, portfolioID, принадлежностьКА )
    var query, cmd, DataSet;
    var sum = $0;
// возможно пригодится для подробных расшифровок
/*
   //Проводки операции резервирования
   query =" with CorAccD as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияД
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if(IsDebet == true)
      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;
    query = query      + "                 ) ,"
          + "  CorAccC as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияК
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if( IsDebet == false)

      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;
    query = query      + "                 ) "
          + " select NVL(SUM(atrn.t_Sum_NatCur),0)  AS SumNat"
          + "   from CorAccD, CorAccC, dacctrn_dbt atrn, doprdocs_dbt oprdoc, doproper_dbt opr  "
          + "  where atrn.t_State            = 1 "    
          + "    and atrn.t_Chapter          = CorAccC.t_Chapter "
          + "    and atrn.t_Account_Payer    = CorAccD.t_Account "
          + "    and atrn.t_Account_Receiver = CorAccC.t_Account "
          + "    and atrn.t_FIID_Receiver    = CorAccC.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          +IIF(m_DepartmentStr != "", " and atrn.t_Department IN ("+m_DepartmentStr+")", "")
          + "    and oprdoc.t_AccTrnID  = atrn.t_AccTrnID "
          + "    and oprdoc.t_ServDocKind = " + DL_RESERVEDOC
          + "    and opr.t_ID_Operation = oprdoc.t_ID_Operation "
          + "    and opr.t_DocKind = " + DLDOC_ISSUE;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_BegDate); 
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND DataSet.SumNat != V_UNDEF)
      sum = DataSet.SumNat;
    end;

    //Проводки по СОБУ
    query =" with CorAccD as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияД
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if(IsDebet == true)
      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;
    query = query      + "                 ), "
          + "  CorAccC as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияК
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if( IsDebet == false)
      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;

    query = query      + "                 ) "
          + " select NVL(SUM(atrn.t_Sum_NatCur),0)  AS SumNat"
          + "   from CorAccD, CorAccC, dacctrn_dbt atrn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grd "
          + "  where atrn.t_State       = 1 "
          + "    and atrn.t_Chapter       = CorAccD.t_Chapter "
          + "    and atrn.t_Account_Payer = CorAccD.t_Account "
          + "    and atrn.t_Account_Receiver = CorAccC.t_Account "
          + "    and atrn.t_FIID_Payer    = CorAccD.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          + "    and grdoc.t_DocID  = atrn.t_AccTrnID "
          + "    and grdoc.t_DocKind = " + DLDOC_CARRY
          + "    and grdoc.t_ServDocKind = " + DL_SCACCOUNTING
          + "    and grd.t_ID = grdoc.t_GrDealID ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_BegDate); 
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND DataSet.SumNat != V_UNDEF)
      sum =  sum + DataSet.SumNat;
    end;
*/
    query =" with CorAccD as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияД
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if(IsDebet == true)
      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;
    query = query      + "                 ), "
          + "  CorAccC as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияК
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if( IsDebet == false)
      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;

    query = query      + "                 ) "
          + " select NVL(SUM(atrn.t_Sum_NatCur),0)  AS SumNat"
          + "   from CorAccD, CorAccC, dacctrn_dbt atrn "
          + "  where atrn.t_State       = 1 "
          + "    and atrn.t_Chapter       = CorAccD.t_Chapter "
          + "    and atrn.t_Account_Payer = CorAccD.t_Account "
          + "    and atrn.t_Account_Receiver = CorAccC.t_Account "
          + "    and atrn.t_FIID_Payer    = CorAccD.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_BegDate); 
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND DataSet.SumNat != V_UNDEF)
      sum =  DataSet.SumNat;
    end;


    return sum ;

  END;

  PRIVATE MACRO GetSum_PartTwoVAForReserv(КатегорияД, КатегорияК,IsDebet, value1, value2, value3, value4,/* ВидРез, БэкОф, КатКотОД,*/ dockind, portfolioID, принадлежностьКА )
    var query, cmd, DataSet;
    var sum = $0;

   //Проводки операции резервирования УВ
   query =" with CorAccD as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияД
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if(IsDebet == true)
      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;
    query = query      + "                 ) ,"
          + "  CorAccC as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter "
          + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp "
          + "                   where cat.t_Code     = " + КатегорияК
          + "                     and accdoc.t_CatID = cat.t_ID "
          + "                     and temp.t_CatID    = accdoc.t_CatID "
          + "                     and temp.t_Number   = accdoc.t_TemplNum ";
    if( IsDebet == false)

      if(value1 !=NULL)
        query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
      end;
      if(value2 !=NULL)
        query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
      end;
      if(value3 !=NULL)
        query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
      end;
      if(value4 !=NULL)
        query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
      end;
    end;
    query = query      + "                 ) "
          + " select NVL(SUM(atrn.t_Sum_NatCur),0)  AS SumNat"
          + "   from CorAccD, CorAccC, dacctrn_dbt atrn, doprdocs_dbt oprdoc, doproper_dbt opr  "
          + "  where atrn.t_State            = 1 "    
          + "    and atrn.t_Chapter          = CorAccC.t_Chapter "
          + "    and atrn.t_Account_Payer    = CorAccD.t_Account "
          + "    and atrn.t_Account_Receiver = CorAccC.t_Account "
          + "    and atrn.t_FIID_Receiver    = CorAccC.t_Currency "
          + "    and atrn.t_Date_Carry BETWEEN ? AND ? "
          + "    and oprdoc.t_AccTrnID  = atrn.t_AccTrnID "
          + "    and oprdoc.t_ServDocKind = " + DL_RESERVE_DEALS
          + "    and opr.t_ID_Operation = oprdoc.t_ID_Operation "
          + "    and opr.t_DocKind = " + DL_VEKSELACCOUNTED;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_BegDate); 
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND DataSet.SumNat != V_UNDEF)
      sum = DataSet.SumNat;
    end;

    return sum ;

  END;

  PRIVATE MACRO GetSumFromPortfToPDO(FromPortfolio:integer)
    var query, cmd, DataSet;
    var NoteKind = 0, NoteKindNKD_P = 0, NoteKindNKD_A = 0, NoteKindD = 0;
    var sum = $0;

    query =   " select /*+ ordered */ NVL(SUM(RSB_FIInstr.ConvSum(wrt.t_Cost, fin.t_FaceValueFI, "+NATCUR+", ?)), 0) as SumNat "
            + "   from v_scwrthistex wrt,v_scwrthistex wrt1, dfininstr_dbt fin "
            + "  where wrt.t_ChangeDate <= ? "
            + "    and wrt.t_Portfolio = " + KINDPORT_PROMISSORY
            + "    and wrt1.t_SumID = wrt.t_SumID "
            + "    and decode(wrt1.t_Portfolio,?,1,0)=1 "
            + "    and case when wrt1.t_ChangeDate <= wrt.t_ChangeDate then 1 else 0 end = 1"
            + "    and decode(wrt.t_Instance,(select MAX(wrt2.t_Instance) "
            + "                            from v_scwrthistex wrt2 "
            + "                           where wrt2.t_SumID = wrt.t_SumID "
            + "                             and wrt2.t_ChangeDate <= ? "
            + "                         ),1,0)=1 "
            + "    and fin.t_FIID = wrt.t_FIID ";
/*
   query =   " select NVL(SUM(RSB_FIInstr.ConvSum(wrt.t_Cost, fin.t_FaceValueFI, "+NATCUR+", ?)), 0) as SumNat "
            + "   from v_scwrthistex wrt, dfininstr_dbt fin "
            + "  where wrt.t_ChangeDate <= ? "
            + "    and wrt.t_Portfolio = " + KINDPORT_PROMISSORY
            + "    and wrt.t_Instance = (select MAX(wrt2.t_Instance) "
            + "                            from v_scwrthistex wrt2 "
            + "                           where wrt2.t_SumID = wrt.t_SumID "
            + "                             and wrt2.t_ChangeDate <= ? "
            + "                         ) "
            + "    and Exists (select 1 "
            + "                  from v_scwrthistex wrt1 "
            + "                 where wrt1.t_SumID = wrt.t_SumID "
            + "                   and wrt1.t_Portfolio = ? "
            + "                   and wrt1.t_ChangeDate <= wrt.t_ChangeDate "
            + "               )"
            + "    and fin.t_FIID = wrt.t_FIID ";
*/


    if(m_DepartmentStr != "")
      query = query + " and wrt.t_Department IN ("+m_DepartmentStr+")";
    end;

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_EndDate);
    cmd.AddParam(m_EndDate);
    cmd.AddParam(FromPortfolio);
    cmd.AddParam(m_EndDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      sum = DataSet.SumNat;
    end;

    //добавить суммы по примечаниям
    if(FromPortfolio == KINDPORT_SSSD)
      NoteKind = NOTEKIND_AVOIR_SUMPDOFROMSSSD;
      NoteKindNKD_P = NOTEKIND_AVOIR_SUMPDO_NKD_P_SSSD;
      NoteKindNKD_A = NOTEKIND_AVOIR_SUMPDO_NKD_A_SSSD;
      NoteKindD = NOTEKIND_AVOIR_SUMPDO_DISC_SSSD;
    elif(FromPortfolio == KINDPORT_SSPU)
      NoteKind = NOTEKIND_AVOIR_SUMPDOFROMSSPU;
      NoteKindNKD_P = NOTEKIND_AVOIR_SUMPDO_NKD_P_SSPU;
      NoteKindNKD_A = NOTEKIND_AVOIR_SUMPDO_NKD_A_SSPU;
      NoteKindD = NOTEKIND_AVOIR_SUMPDO_DISC_SSPU;
    end;

    if(NoteKind > 0)
      query =   " select NVL(SUM(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?)), 0) as SumNat "
              + " , NVL(SUM(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?)), 0) as SumNatP"
              + " , NVL(SUM(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?)), 0) as SumNatA"
              + " , NVL(SUM(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?)), 0) as SumNatD"
              + "   from dfininstr_dbt fin "
              + "  where fin.t_FI_Kind = " + FIKIND_AVOIRISS
              + "    and RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_FI_Kind, fin.t_AvoirKind ) = " + AVOIRISSKIND_BOND
              + "    and Exists (select 1 "
              + "                  from v_scwrthistex wrt "
              + "                 where wrt.t_Portfolio = " + KINDPORT_PROMISSORY
              + "                   and wrt.t_ChangeDate <= ? ";
      if(m_DepartmentStr != "")
        query = query + "           and wrt.t_Department IN ("+m_DepartmentStr+")";
      end;

      query = query + "               ) ";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(NoteKind);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(NoteKindNKD_P);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(NoteKindNKD_A);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(NoteKindD);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      cmd.AddParam(m_EndDate);
      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        sum = sum + DataSet.SumNat + DataSet.SumNatP + DataSet.SumNatA + DataSet.SumNatD;
      end;
    end;

    return sum;
  END;

  PRIVATE MACRO LoadReservSumPDO(portfolio)
    var query, cmd, DataSet;

    if( ((m_ReservSum_SSPU == NULL) and (portfolio == KINDPORT_SSPU)) or ((m_ReservSum_SSSD == NULL) and (portfolio == KINDPORT_SSSD)) )
      if(portfolio == KINDPORT_SSPU)
        m_ReservSum_SSPU = $0;
        m_CorrEstReservSum_SSPU = $0;
      else
        m_ReservSum_SSSD = $0;
        m_CorrEstReservSum_SSSD = $0;
      end;

      query =   " select /*+ ordered */ NVL(SUM(wrt.t_ReservAmount),0) as ReservSum, NVL(SUM(wrt.t_IncomeReserv),0) as IncomeReservSum, NVL(SUM(wrt.t_CorrEstReserve),0) as CorrEstReservSum"
              + "   from v_scwrthistex wrt, v_scwrthistex wrt1 "
              + "  where wrt.t_ChangeDate <= ? "
              + "    and wrt.t_Portfolio = " + KINDPORT_PROMISSORY
              + "    and wrt1.t_SumID = wrt.t_SumID "
              + "    and decode(wrt1.t_Portfolio, ?,1,0)=1 "
              + "    and case when wrt1.t_ChangeDate <= wrt.t_ChangeDate then 1 else 0 end = 1 "
              + "    and decode(wrt.t_Instance ,(select MAX(wrt1.t_instance)"
              + "                            from v_scwrthistex wrt1 "
              + "                           where wrt1.t_SumID = wrt.t_SumID "
              + "                             and wrt1.t_ChangeDate <= ? "
              + "                         ),1,0)= 1" 
              ;
/*      query =   " select NVL(SUM(wrt.t_ReservAmount),0) as ReservSum, NVL(SUM(wrt.t_IncomeReserv),0) as IncomeReservSum, NVL(SUM(wrt.t_CorrEstReserve),0) as CorrEstReservSum"
              + "   from v_scwrthistex wrt "
              + "  where wrt.t_ChangeDate <= ? "
              + "    and wrt.t_Portfolio = " + KINDPORT_PROMISSORY
              + "    and wrt.t_Instance = (select MAX(wrt1.t_instance)"
              + "                            from v_scwrthistex wrt1 "
              + "                           where wrt1.t_SumID = wrt.t_SumID "
              + "                             and wrt1.t_ChangeDate <= ? "
              + "                         )" 
              + "    and Exists (select 1 "
              + "                  from v_scwrthistex wrt1 "
              + "                 where wrt1.t_SumID = wrt.t_SumID "
              + "                   and wrt1.t_Portfolio = ? "
              + "                   and wrt1.t_ChangeDate <= wrt.t_ChangeDate "
              + "               )"
              ;
*/
      if(m_DepartmentStr != "")
        query = query + " and wrt.t_Department IN ("+m_DepartmentStr+")";
      end;

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_EndDate);
      cmd.AddParam(portfolio);
      cmd.AddParam(m_EndDate);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        if(portfolio == KINDPORT_SSPU)
          m_ReservSum_SSPU        = DataSet.ReservSum + DataSet.IncomeReservSum;
          m_CorrEstReservSum_SSPU = DataSet.CorrEstReservSum;
        else
          m_ReservSum_SSSD        = DataSet.ReservSum + DataSet.IncomeReservSum;
          m_CorrEstReservSum_SSSD = DataSet.CorrEstReservSum;
        end;
      end;
    end;
  END;

  PRIVATE MACRO GetChangeSumEstReserve(Portfolio:integer, isPlus:bool, isInc:bool)
    var query, cmd, DataSet;
    var ChangeSum = $0;

    if(((Portfolio == KINDPORT_SSSD) and (m_PlusDeltaEstReserveInc_SSSD == NULL)) or ((Portfolio == KINDPORT_ASCB) and (m_PlusDeltaEstReserveInc_ASCB == NULL)))

      if(Portfolio == KINDPORT_SSSD)
        m_PlusDeltaEstReserveInc_SSSD  = $0;
        m_PlusDeltaEstReserve_SSSD     = $0;
        m_MinusDeltaEstReserveInc_SSSD = $0;
        m_MinusDeltaEstReserve_SSSD    = $0;
      else
        m_PlusDeltaEstReserveInc_ASCB  = $0;
        m_PlusDeltaEstReserve_ASCB     = $0;
        m_MinusDeltaEstReserveInc_ASCB = $0;
        m_MinusDeltaEstReserve_ASCB    = $0;
      end; 

      
      query =   " select NVL(SUM(f110.T_S385_16),0) as SUM_S385_16, "
              + "        NVL(SUM(f110.T_S175_16),0) as SUM_S175_16, "
              + "        NVL(SUM(f110.T_S386_17),0) as SUM_S386_17, "
              + "        NVL(SUM(f110.T_S176_17),0) as SUM_S176_17, "
              + "        NVL(SUM(f110.T_S_4_4),0)   as SUM_S_4_4,   "
              + "        NVL(SUM(f110.T_S_4_2),0)   as SUM_S_4_2    "
              + "   from dscf110_tmp f110 "
              + "  where f110.t_Portfolio = ? ";

      cmd = DL_RSDCommand(query);
      cmd.AddParam(Portfolio);        
              

      InitProgress(-1, "Подготовка данных", "Подготовка данных для раздела 2");
      DataSet = cmd.Execute();
      RemProgress();

      if(DataSet.moveNext())
        if(Portfolio == KINDPORT_SSSD)
          m_PlusDeltaEstReserveInc_SSSD  = DataSet.SUM_S_4_4;
          m_PlusDeltaEstReserve_SSSD     = DataSet.SUM_S385_16;
          m_MinusDeltaEstReserveInc_SSSD = DataSet.SUM_S_4_2;
          m_MinusDeltaEstReserve_SSSD    = DataSet.SUM_S175_16;
        else
          m_PlusDeltaEstReserveInc_ASCB  = DataSet.SUM_S_4_4;  
          m_PlusDeltaEstReserve_ASCB     = DataSet.SUM_S386_17;
          m_MinusDeltaEstReserveInc_ASCB = DataSet.SUM_S_4_2;  
          m_MinusDeltaEstReserve_ASCB    = DataSet.SUM_S176_17;
        end;
      end;
      
    end;

    if(isPlus)
      if(isInc)
        ChangeSum = IIF(Portfolio == KINDPORT_SSSD, m_PlusDeltaEstReserveInc_SSSD, m_PlusDeltaEstReserveInc_ASCB);
      else
        ChangeSum = IIF(Portfolio == KINDPORT_SSSD, m_PlusDeltaEstReserve_SSSD, m_PlusDeltaEstReserve_ASCB);
      end;
    else
      if(isInc)
        ChangeSum = IIF(Portfolio == KINDPORT_SSSD, m_MinusDeltaEstReserveInc_SSSD, m_MinusDeltaEstReserveInc_ASCB);
      else
        ChangeSum = IIF(Portfolio == KINDPORT_SSSD, m_MinusDeltaEstReserve_SSSD, m_MinusDeltaEstReserve_ASCB);
      end;
    end;

    return ChangeSum;
  END;

  PRIVATE MACRO GetSumDBO_(Категория, Баланс, dockind)
    var query, cmd, DataSet;
    var sum = $0;
    query =   "SELECT " ;
	
	if (Категория !=NULL)
      query = query  + "  " ;
	elif (Баланс !=NULL) 
      query = query  + " /*+ leading(temp,doc,acc)*/ " ;
    end;

    query =  query  + " ABS (SUM (rsb_account.restac (doc.t_Account, "
            + "                                     doc.t_Currency,  "
            + "                                     ?, "
            + "                                     doc.t_Chapter, "
            + "                                     NULL, "
            + "                                     0))) as SumNat "
            + "  FROM daccount_dbt acc, "
            + "       dmcaccdoc_dbt doc, "
            + "       dmctempl_dbt temp  "
            + " WHERE     acc.t_account = doc.t_account  "
            + "       AND acc.t_Chapter = 1  "
            ;
    if(Баланс !=NULL)
      query = query  + "       AND temp.t_balance IN ( "+ Баланс + ")";
    end;
      query = query  + "       AND doc.t_TemplNum = temp.t_Number  "
            + "       AND doc.t_catID = temp.t_catID  " ;
    if(Категория !=NULL)
      query = query  + "       AND doc.t_catID IN (SELECT CAT.T_ID  "
            + "                              FROM DMCCATEG_DBT CAT  "
            + "                             WHERE     CAT.T_CODE  IN (   " + Категория + ")" 
            + "                                   AND CAT.T_LEVELTYPE = 1)  " ;
    end;
    if(dockind !=NULL)
		if(Категория !=NULL)
		  query = query  + "       AND case when doc.t_dockind IN ( " + dockind + ") then 1 else 0 end = 1" ;
		else
		  query = query  + "       AND doc.t_dockind IN ( " + dockind + ")" ;
		end;
    end;
    query = query  +"AND EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                   + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_BANK + ","+ PTK_CENTRBANK + ")"
                   + "    AND doc.T_OWNER = Pto.T_PARTYID )";
    query = query  +"AND EXISTS (SELECT 1 FROM dsfcontr_dbt sf "
                   + "  WHERE     sf.t_servkind = " +  PTSK_STOCKDL
                   + " AND sf.t_ID IN (SELECT mp.t_SfContrID FROM ddlcontrmp_dbt mp "
                   + " WHERE mp.t_dlContrID = doc.t_docid)) ";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND DataSet.SumNat != V_UNDEF)
      sum = DataSet.SumNat;
    end;

    return sum ;
  END;

  PRIVATE MACRO GetSum_(Категория, Баланс, value1, value2, value3, value4,/* ВидРез, БэкОф, КатКотОД,*/ dockind, portfolioID, принадлежностьКА )
    var query, cmd, DataSet;
    var sum = $0;
    query =   "SELECT " ;
	
	if (Категория !=NULL)
      query = query  + "  " ;
	elif (Баланс !=NULL) 
      query = query  + " /*+ leading(temp,doc,acc)*/ " ;
    end;

    query =  query  +  " ABS (SUM (rsb_account.restac (doc.t_Account, "
            + "                                     doc.t_Currency,  "
            + "                                     ?, "
            + "                                     doc.t_Chapter, "
            + "                                     NULL, "
            + "                                     0))) as SumNat "
            + "  FROM daccount_dbt acc, "
            + "       dmcaccdoc_dbt doc, "
            + "       dmctempl_dbt temp  "
            + " WHERE     acc.t_account = doc.t_account  "
            + "       AND acc.t_Chapter = 1  "
            ;
    if(value1 !=NULL)
      query = query  + "       AND temp.t_value1 IN ( " + value1 + " )";
    end;
    if(value2 !=NULL)
      query = query  + "       AND temp.t_value2 IN ( " + value2 + " )";
    end;
    if(value3 !=NULL)
      query = query  + "       AND temp.t_value3 IN ( " + value3 + " )";
    end;

    if(value4 !=NULL)
      query = query  + "       AND temp.t_value4 IN ( " + value4 + " )";
    end;

    if(Баланс !=NULL)
      query = query  + "       AND temp.t_balance IN ( "+ Баланс + ")";
    end;
      query = query  + "       AND doc.t_TemplNum = temp.t_Number  "
            + "       AND doc.t_catID = temp.t_catID  " ;
    if(Категория !=NULL)
      query = query  + "       AND doc.t_catID IN (SELECT CAT.T_ID  "
            + "                              FROM DMCCATEG_DBT CAT  "
            + "                             WHERE     CAT.T_CODE  IN (   " + Категория + ")" 
            + "                                   AND CAT.T_LEVELTYPE = 1)  " ;
    end;
    if(dockind !=NULL)
		if(Категория !=NULL)
		  query = query  + "       AND case when doc.t_dockind IN ( " + dockind + ") then 1 else 0 end = 1" ;
		else
		  query = query  + "       AND doc.t_dockind IN ( " + dockind + ")" ;
		end;
    end;
    if((portfolioID !=NULL) AND(принадлежностьКА == NULL))      //портфель приходит для сделок покупок/продаж если нет принадлежности
      query = query  + " AND EXISTS  (SELECT 1 FROM ddl_tick_dbt tick "
            + "          WHERE     tick.t_DealID = doc.t_docid "
            + "          AND tick.t_portfolioID IN ( " + portfolioID + ") " ;
      query = query  + "  )" ; 
    end;

    if(принадлежностьКА != NULL)   // если есть принадлежность- то это РЕПО 

      query = query  + " AND EXISTS "
            + " (SELECT 1 "
            + "    FROM ddl_tick_dbt tick, ddl_leg_dbt leg "
            + "   WHERE     leg.t_id = doc.t_docid "
            + "         AND leg.t_legID = 0"
            + "         AND leg.t_legKind IN (0,2) "
            + "         AND tick.t_dealID = leg.t_Dealid "
            + "         AND rsb_secur.DealIsRepo (tick.t_DealID) = 1";
      query = query   + принадлежностьКА
           + "          AND tick.t_bofficekind = 101) ";
    end;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND DataSet.SumNat != V_UNDEF)
      sum = DataSet.SumNat;
    end;

    return sum ;
  END;

  PRIVATE MACRO ОстатокНаСчетеПоКУнаДату(Категория, BCID, ДатаОстатка )
    var query, cmd, DataSet;
    var rest = $0;
    query =   "SELECT ABS (ROUND(rsb_account.restac (doc.t_Account, "
            + "                                     doc.t_Currency,  "
            + "                                     ?, "
            + "                                     doc.t_Chapter, "
            + "                                     NULL, "
            + "                                     0),2)) as SumNat "
            + "  FROM daccount_dbt acc, "
            + "       dmcaccdoc_dbt doc, "
            + "       dmctempl_dbt temp  "
            + " WHERE     acc.t_account = doc.t_account  "
            + "       AND acc.t_Chapter = 1  "
            + "       AND doc.t_TemplNum = temp.t_Number  "
            + "       AND doc.t_catID = temp.t_catID  " 
            + "       AND doc.t_catID IN (SELECT CAT.T_ID  "
            + "                              FROM DMCCATEG_DBT CAT  "
            + "                             WHERE     CAT.T_CODE  IN (   " + Категория + ")" 
            + "                                   AND CAT.T_LEVELTYPE = 1)  " 
            + "       AND doc.t_docid = ?" ;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(ДатаОстатка); 
    cmd.AddParam(BCID); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() AND (DataSet.SumNat != V_UNDEF))
      rest = DataSet.SumNat;
    end;
    return rest;
  END;

  PRIVATE MACRO ЕстьПроводкаВДень(CatDebet, CatCredit, BCID, ДатаПроводки)
    var query, cmd, DataSet;
    var result = false;
    query = "WITH CorAccD " 
          + "     AS (SELECT DISTINCT accdoc.t_Account, " 
          + "                         accdoc.t_Currency, " 
          + "                         accdoc.t_Chapter, "
          + "                         accdoc.t_docid "
          + "           FROM dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp " 
          + "          WHERE     cat.t_Code IN ( " + CatDebet + " ) " 
          + "                AND accdoc.t_CatID = cat.t_ID " 
          + "                AND accdoc.t_DOCKIND = " + DL_VSBANNER
          + "                AND temp.t_CatID = accdoc.t_CatID " 
          + "                AND temp.t_Number = accdoc.t_TemplNum), " 
          + "     CorAccC "  
          + "     AS (SELECT DISTINCT accdoc.t_Account, " 
          + "                         accdoc.t_Currency, " 
          + "                         accdoc.t_Chapter, " 
          + "                         accdoc.t_docid " 
          + "           FROM dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp " 
          + "          WHERE     cat.t_Code IN (" + CatCredit + ") " 
          + "                AND accdoc.t_CatID = cat.t_ID " 
          + "                AND accdoc.t_DOCKIND = " + DL_VSBANNER
          + "                AND temp.t_CatID = accdoc.t_CatID " 
          + "                AND temp.t_Number = accdoc.t_TemplNum) " 
          + "SELECT COUNT(*) as CountTrn" 
          + "  FROM CorAccD, CorAccC, dacctrn_dbt atrn "
          + " WHERE     atrn.t_State = 1 "
          + "       AND atrn.t_Chapter = CorAccD.t_Chapter "
          + "       AND atrn.t_Account_Payer = CorAccD.t_Account "
          + "       AND atrn.t_Account_Receiver = CorAccC.t_Account "
          + "       AND atrn.t_FIID_Payer = CorAccD.t_Currency " 
          + "       AND CorAccD.T_DOCID = ? "
          + "       AND CorAccC.T_DOCID = ? "
          + "       AND atrn.t_Date_Carry = ? ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(BCID); 
    cmd.AddParam(BCID); 
    cmd.AddParam(ДатаПроводки); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() and (DataSet.CountTrn > 0))
      result = true;
    end;

    return result;
  END;

  PRIVATE MACRO CheckVA_Sell_Repay(PrevDate, CurDate, BCID)
    var query, cmd, DataSet;
    var result = false;
    query = "SELECT COUNT(*) as countStatus"
          + "  FROM DVSBNRBCK_DBT bck "
          + " WHERE     BCK.T_BCID = ? "
          + "       AND BCK.T_CHANGEDATE > ? "
          + "       AND BCK.T_CHANGEDATE <= ? "
          + "       AND BCK.T_OLDABCSTATUS <> BCK.T_NEWABCSTATUS "
          + "       AND (   BCK.T_NEWABCSTATUS = 200                         /* Погашение*/ "
          + "            OR (    BCK.T_NEWABCSTATUS = 0                /* Введен и продан*/ "
          + "                AND EXISTS "
          + "                       (SELECT * "
          + "                          FROM DVSBNRBCK_DBT bck_symb "
          + "                         WHERE     bck_symb.T_CHANGEDATE = BCK.T_CHANGEDATE "
          + "                               AND BCK_SYMB.T_NEWBCSTATE = 'Р'))) ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(BCID); 
    cmd.AddParam(PrevDate); 
    cmd.AddParam(CurDate); 
    DataSet = cmd.Execute();
    if(DataSet.moveNext() and (DataSet.countStatus > 0))
      result = true;
    end;

    return result;
  END;

  PRIVATE MACRO GetSum_PartTwo_CorrVeks(CatDebet, CatCredit, УчетПокупкиПогашения)
    var query, cmd, DataSet;
    var sum = $0;
    query = "WITH CorAccD " 
          + "     AS (SELECT DISTINCT accdoc.t_Account, " 
          + "                         accdoc.t_Currency, " 
          + "                         accdoc.t_Chapter, "
          + "                         accdoc.t_docid "
          + "           FROM dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp " 
          + "          WHERE     cat.t_Code IN ( " + CatDebet + " ) " 
          + "                AND accdoc.t_CatID = cat.t_ID " 
          + "                AND accdoc.t_DOCKIND = " + DL_VSBANNER
          + "                AND temp.t_CatID = accdoc.t_CatID " 
          + "                AND temp.t_Number = accdoc.t_TemplNum), " 
          + "     CorAccC " 
          + "     AS (SELECT DISTINCT accdoc.t_Account, " 
          + "                         accdoc.t_Currency, " 
          + "                         accdoc.t_Chapter, " 
          + "                         accdoc.t_docid " 
          + "           FROM dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt temp " 
          + "          WHERE     cat.t_Code IN (" + CatCredit + ") " 
          + "                AND accdoc.t_CatID = cat.t_ID " 
          + "                AND accdoc.t_DOCKIND = " + DL_VSBANNER
          + "                AND temp.t_CatID = accdoc.t_CatID " 
          + "                AND temp.t_Number = accdoc.t_TemplNum) " 
          + "SELECT DISTINCT ATRN.T_ACCTRNID, NVL(ATRN.T_SUM_NATCUR,0) as SumNat, CorAccD.t_docid as BCID" 
          + "  FROM CorAccD, CorAccC, dacctrn_dbt atrn "
          + " WHERE     atrn.t_State = 1 "
          + "       AND atrn.t_Chapter = CorAccD.t_Chapter "
          + "       AND atrn.t_Account_Payer = CorAccD.t_Account "
          + "       AND atrn.t_Account_Receiver = CorAccC.t_Account "
          + "       AND atrn.t_FIID_Payer = CorAccD.t_Currency " 
          + "       AND atrn.t_Date_Carry BETWEEN ? "
          + "                                 AND ? ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_BegDate); 
    cmd.AddParam(m_EndDate); 
    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      var КорОР_общ = DataSet.SumNat;
      var КорОР_пдд_тек = $0;
      var КорОР_пдд_old = $0;
      var Sum_delta = $0;
      var Sum_delta_sell_repay = $0;
      var PrevDate = date(0,0,0);
      var CurDate = date(0,0,0);
      var ПрервалисьРаньше = false;
      var queryReserv = "SELECT DISTINCT RESLNK.T_RESERVEDATE as RDate"
                      + "    FROM ddlreslnk_dbt reslnk "
                      + "   WHERE     RESLNK.T_PARENTID = ? "
                      + "         AND RESLNK.T_CHILDID <> 0 "
                      + "         AND RESLNK.T_RESERVESUBKIND = 5 " // VARES_SUBKIND_OR
                      + "         AND RESLNK.T_RESERVEDATE BETWEEN ? "
                      + "                                      AND ? "
                      + "ORDER BY RESLNK.T_RESERVEDATE ";
      var cmdReserv = DL_RSDCommand(queryReserv);
      cmdReserv.AddParam(DataSet.BCID); 
      cmdReserv.AddParam(m_BegDate); 
      cmdReserv.AddParam(m_EndDate); 
      var DSReserv = cmdReserv.Execute();
      while(DSReserv.moveNext())
        var Sum_влож = $0, Sum_пдд = $0;
        var Delta = 0;
        
        CurDate = DSReserv.RDate;
        if(PrevDate == date(0,0,0))
          PrevDate = CurDate;
        end;

        if(УчетПокупкиПогашения)
          if (CheckVA_Sell_Repay(PrevDate, CurDate, DataSet.BCID))
            ПрервалисьРаньше = true;
            break;
          end;
        end;

        Sum_влож = ОстатокНаСчетеПоКУнаДату("'Учтенные векселя'", DataSet.BCID, CurDate) + ОстатокНаСчетеПоКУнаДату("'КорСт_Увеличение, вексель'", DataSet.BCID, CurDate) -
                  ОстатокНаСчетеПоКУнаДату("'КорСт_Уменьшение, вексель'", DataSet.BCID, CurDate);
        Sum_пдд = ОстатокНаСчетеПоКУнаДату("'Начисл.ПДД, УВ'", DataSet.BCID, CurDate);
        КорОР_пдд_тек = КорОР_общ / (Sum_влож + Sum_пдд) * Sum_пдд;
        Delta = КорОР_пдд_тек - КорОР_пдд_old;
        Sum_delta_sell_repay = Sum_delta_sell_repay + Delta;

        if (ЕстьПроводкаВДень(CatDebet, CatCredit, DataSet.BCID, CurDate))
          Sum_delta = Sum_delta + Delta;
        end;
        КорОР_пдд_old = КорОР_пдд_тек;
        PrevDate = CurDate;
      end;

      if(УчетПокупкиПогашения and (ПрервалисьРаньше OR CheckVA_Sell_Repay(PrevDate, m_EndDate, DataSet.BCID)))
        sum = sum + Sum_delta_sell_repay;
      else
        sum = sum + Sum_delta;
      end;
    end;

    return sum ;
  END;


  PRIVATE MACRO GetSum_A_5_2()
    var sum = $0;
      sum = GetSum_("'Резерв, договор'","'32311','45715','47308','47425'", "9,16", null, "3, 9, 10", "5", "176")+
            GetSum_("'Резерв, договор'","'32403','45818'", "8", null, null, "5,7", "101,154,176") +
            GetSum_("'Резерв, договор'","'47425'", "10", null, null, "5,7", "101");
    return sum ;
  END;

  PRIVATE MACRO GetSum_A_5_3()
    var sum = $0;
    sum = GetSum_("'+Форвард, расчеты'","'47408'", "1", null, null, null,"101,141") +
          GetSum_("'+Расчеты'","'47423'", "5", "0,1", null, null,"101,117,151,176")  ; 
    return sum ;
  END;

  PRIVATE MACRO GetSum_A_5_4()
    var sum = $0;
    sum = GetSum_("'-Форвард, расчеты'","'47407'", "1", null, null, null,"101,141") ;
    return sum ;
  END;

  PRIVATE MACRO GetSum_A_5_5()
    var sum = $0;
    sum = GetSum_("'-КОР_Резерв, договор_проч'","'32313','47313','32408','45821','47466','32508','45921'", "21,22,23,25", null, null, null,"176")
        - GetSum_("'+КОР_Резерв, договор_проч'","'32312','47312','32407','45820','47465','32507','45920'", "21,22,23,25", null, null, null,"176")  // - ОР(+) + ОР(-)
           ;
    return sum ;
  END;

  PRIVATE MACRO GetSum_A_5_6()  //ПУ
    var sum = $0;

    sum = (GetSum_("'Треб. с н.с.'","'32401','32402','45801','45802','45803','45804','45805','45806','45807','45808','45809','45810','45811','45812','45813','45814','45815','45816','45817'", null, null, null, null,"101", "2,32") -
          GetSum_("'Резерв, договор'","'32403','45818'", "8", null, null, "5,7","101","1,32"))+
          GetSum_("'+Форвард, расчеты'","'47408'", "1", null, null, null,"101","1,32")-
          GetSum_("'-Форвард, расчеты'","'47407'", "1", null, null, null,"101","1,32")+
          GetSum_("'+Расчеты'","'47423'", "5,7", null, null, null,"101","1,32") -
          GetSum_("'Резерв, договор'","'47425'", "10", null, null, "5,7","101","1,32")
 ;
    return sum ;
  END;

  PRIVATE MACRO GetSum_A_5_7()     //СД
    var sum = $0;

    sum = (GetSum_("'Треб. с н.с.'","'32401','32402','45801','45802','45803','45804','45805','45806','45807','45808','45809','45810','45811','45812','45813','45814','45815','45816','45817'", null, null, null, null,"101", "2,32") -
          GetSum_("'Резерв, договор'","'32403','45818'", "8", null, null, "5,7","101","2,31"))+
          GetSum_("'+Форвард, расчеты'","'47408'", "1", null, null, null,"101","2,31")-
          GetSum_("'-Форвард, расчеты'","'47407'", "1", null, null, null,"101","2,31")+
          GetSum_("'+Расчеты'","'47423'", "5,7", null, null, null,"101","2,31") -
          GetSum_("'Резерв, договор'","'47425'", "10", null, null, "5,7","101","2,31")
 ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_5_9()     //АС_ЦБ
    var sum = $0;
    sum = (GetSum_("'Затраты, Репо'","'47440'", null, null, null, null,"176","5", " ") -
          GetSum_("'РасРасх, Репо'","'47442'", null, null, null, null,"176","5", " ")) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_1()     
    var sum = $0;
    var принадлежностКА ="AND EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                        + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_BANK + ","+ PTK_CENTRBANK + ")"
                        + "    AND tick.T_PARTYID = Pto.T_PARTYID )";



    sum = (GetSum_("'Затраты, Репо'","'47440'", null, null, null, null,"176", "5", принадлежностКА) -
          GetSum_("'РасРасх, Репо'","'47442'", null, null, null, null,"176", "5", принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_2()     
    var sum = $0;
    var принадлежностКА ="AND NOT EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                        + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_BANK + ","+ PTK_CENTRBANK + ")"
                        + "    AND tick.T_PARTYID = Pto.T_PARTYID )";

    sum = (GetSum_("'Затраты, Репо'","'47440'", null, null, null, null,"176","5", принадлежностКА) -
          GetSum_("'РасРасх, Репо'","'47442'", null, null, null, null,"176","5",принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_3()     
    var sum = $0;
    var принадлежностКА ="AND NOT EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                        + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_BANK + ","+ PTK_CENTRBANK + ")"
                        + "    AND tick.T_PARTYID = Pto.T_PARTYID )";

    sum = (GetSum_("'-Корр, ПРепо'","'47445'", null, null, null, null,"176","5", принадлежностКА) -
          GetSum_("'+Корр, ПРепо'","'47450'", null, null, null, null,"176","5",принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_5()     
    var sum = $0;
    var принадлежностКА ="AND NOT EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                        + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_BANK + ","+ PTK_CENTRBANK + ")"
                        + "    AND tick.T_PARTYID = Pto.T_PARTYID )"
                        + "AND NOT EXISTS (SELECT 1 FROM dparty_dbt Pt "
                        + "  WHERE     Pt.T_legalform = 2"
                        + "    AND tick.T_PARTYID = Pt.T_PARTYID )";

    sum = (GetSum_("'-% к погашению'","'47426'", null, null, null, null,"176","5", принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_5_1()     
    var sum = $0;
    var принадлежностКА = "AND EXISTS (SELECT 1 FROM dparty_dbt Pt "
                        + "  WHERE     Pt.T_legalform = 2"
                        + "    AND tick.T_PARTYID = Pt.T_PARTYID )";

    sum = (GetSum_("'-% к погашению'","'47426'", null, null, null, null,"176","5", принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_10()     
    var sum = $0;
    var принадлежностКА ="AND EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                        + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_CENTRBANK + ")"
                        + "    AND tick.T_PARTYID = Pto.T_PARTYID )";

    sum = (GetSum_("'-% к погашению'","'47426'", null, null, null, null,"176","5", принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_16_11()     
    var sum = $0;
    var принадлежностКА ="AND EXISTS (SELECT 1 FROM dpartyown_dbt Pto "
                        + "  WHERE     Pto.T_PARTYKIND IN ( " + PTK_CENTRBANK + ")"
                        + "    AND tick.T_PARTYID = Pto.T_PARTYID )";

    sum = (GetSum_("'-Корр, ПРепо'","'47445'", null, null, null, null,"176","5", принадлежностКА)-
           GetSum_("'+Корр, ПРепо'","'47450'", null, null, null, null,"176","5", принадлежностКА)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA474_18_1()     
    var sum = $0;

    sum = (GetSum_("'ЗпоСд, ОЭБ'","'47440'", "0", null, null, null,"4830",null)-
           GetSum_("'РасРасх, ОЭБ'","'47442'", "0", null, null, null,"4830",null)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA9_2()     
    var sum = $0;

    sum = (GetSum_("'Резерв, договор'","'47425'", "16", null, null, "5","176",null) +
           GetSum_("'Резерв, договор'","'47425'", "19", null, null, "5","176",null) +
           GetSum_("'РасРасх, ОЭБ'","'32403','45818'", "8", null, null, "5,7","101,154,176",null)) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA9_3()     
    var sum = $0;

    sum = (GetSum_("'+КОР_Резерв, договор_проч'","'47465'", "25", null, null, null,"176",null) -
           GetSum_("'-КОР_Резерв, договор_проч'","'47466'", "25", null, null, null,"176",null) +
           GetSum_("'+КОР_Резерв, договор_проч'","'32407','45820'", "22", null, null, null,"176",null) -
           GetSum_("'-КОР_Резерв, договор_проч'","'32408','45821'", "252", null, null, null,"176",null) ) ;
    return sum ;
  END;

  PRIVATE MACRO GetSumA12()     
    var sum = $0;

    sum = GetSumDBO_("'Брокерский счет ДБО'","'30601'","207")  ;       //207, 3001?
    return sum ;
  END;

  PRIVATE MACRO GetSumA18_4()     
    var sum = $0;
    sum = (GetSum_("'Размещ. ОЭБ','Премия, ОЭБ','Дисконт, ОЭБ'","'520ЛЛ'", null, null, null, null,"5,4830,4831",null) +
          GetSum_("'Размещ., суборд.ОЭБ','Премия, суборд.ОЭБ','Дисконт, суборд.ОЭБ'","'52901','52902'", null, null, null, null,"5,4830,4831",null) +
          GetSum_("'ОЭБ, к исполнению'","'52401'", null, null, null, null,"5,4830,4831",null) +
          GetSum_("'ОЭБ купон, к исполнению'","'52402'", null, null, null, null,"5,4830,4831",null) +
          GetSum_("'ОЭБ купон, к погашению'","'52407'", null, null, null, null,"5,4830,4831",null)) + 
         (GetSum_("'Наш вексель','Дисконт, СВексель'","'523ЛЛ'", null, null, null, null,"164",null) +                   //анкета векселя
          GetSum_("'СВексель к исполнению','Обяз%, СВексель к исп.','Дисконт, СВексель к исп.'","'52406'", null, null, null, null,"164",null) )
  ;

    return sum ;
  END;

  PRIVATE MACRO GetSumA18_5()     
    var sum = $0;
    sum = (GetSum_("'Обяз%, ОЭБ'","'52501'", null, null, null, null,"5,4830,4831",null) ) + 
         (GetSum_("'Обяз%,СВексель'","'52501'", null, null, null, null,"164",null))
  ;

    return sum ;
  END;

  PRIVATE MACRO GetSumS155_16()   //СССД_ЦБ  
    var sum = $0;
    sum = GetSum_PartTwo("'Резерв ц/б'","'+РС,ц/б'", true, "4,18", "2", "3" );   
    return sum ;

  END;

  PRIVATE MACRO GetSumS156_17()   //АС_ЦБ  
    var sum = $0;
    sum = GetSum_PartTwo("'Резерв ц/б'","'+РС,ц/б'", true, "4,18", "5", "3" );   
    return sum ;
  END;

  PRIVATE MACRO GetSumS375_16()   //СССД_ЦБ  
    var sum = $0;
    sum = GetSum_PartTwo("'-РС,ц/б'","'Резерв ц/б'", false, "4,18", "2", "3" );   
    return sum ;

  END;

  PRIVATE MACRO GetSumS376_17()   //АС_ЦБ  
    var sum = $0;
    sum = GetSum_PartTwo("'-РС,ц/б'","'Резерв ц/б'", false, "4,18", "5", "3" );   
    return sum ;
  END;

  PRIVATE MACRO GetSumS_4_1()    
    var sum = $0;
    sum = GetSum_PartTwo("'Резерв, договор'","'+РС,д/с%'", true, "15,16", null, null, "5" )
        + GetSum_PartTwo("'+КОР_Резерв, договор_проч'","'+КОР_РС,д/с%'", true, "23,25" )
        + GetSum_PartTwo("'-КОР_Резерв, договор_проч'","'+КОР_РС,д/с%'", true, "23,25" )
        // УВ
        + GetSum_PartTwo("'Резерв, вексель'","'+РС, вексель'", true, "12", null, "2")
        + GetSum_PartTwo_CorrVeks("'+Кор_Резерв, вексель', '-Кор_Резерв, вексель'", "'+КорРВП_%вексель'", true)
        ;   
    return sum ;
  END;

  PRIVATE MACRO GetSumS_4_3()    
    var sum = $0;
    sum = GetSum_PartTwo("'-РС,д/с%'","'Резерв, договор'", false, "15,16", null, null, "5" )
        + GetSum_PartTwo("'-КОР_РС,д/с%'","'+КОР_Резерв, договор_проч'", false, "23,25" )
        + GetSum_PartTwo("'-КОР_РС,д/с%'","'-КОР_Резерв, договор_проч'", false, "23,25" )
        // УВ
        + GetSum_PartTwo("'-РС, вексель'","'Резерв, вексель'", false, "12", null, "2" )
        + GetSum_PartTwo_CorrVeks("'-КорРВП_%вексель'", "'+Кор_Резерв, вексель', '-Кор_Резерв, вексель'", false)
        ;   
    return sum ;
  END;

  PRIVATE MACRO GetSumS_4_5()    
    var sum = $0;
    sum = GetSum_PartTwo("'Резерв, договор'","'+РС,ц/б'", true, "8,10,19", null, null, "5" )
        + GetSum_PartTwo("'Резерв ц/б'","'+РС,ц/б'", true, "4,18,19", "3,4" ) // ПКУ, ПДО
        + GetSum_PartTwo("'Резерв ц/б'","'+РС,ц/б'", true, "4,18,19", "2", "102" ) //Долевые СССД
//        + GetSum_PartTwo("'+Кор_Резерв, ЦБ'","'+КОР_РС, д/с'", true, "2", "102" )
        + GetSum_PartTwo("'+Кор_Резерв, ЦБ'","'+КОР_РС, д/с'", true, "4" )
//        + GetSum_PartTwo("'-Кор_Резерв, ЦБ'","'+КОР_РС, д/с'", true, "2", "102" )
        + GetSum_PartTwo("'-Кор_Резерв, ЦБ'","'+КОР_РС, д/с'", true, "4")
        // УВ
        + GetSum_PartTwoVAForReserv("'Резерв, договор'","'+РС, д/с'", true, "8,10", null, null, null)
        + GetSum_PartTwo("'РезервПросроч, вексель'","'+РС, д/с'", true)
        + GetSum_PartTwo("'-Кор_РезервПроср, вексель'","'+КОР_РС, д/с'", true)
        + GetSum_PartTwo("'+Кор_РезервПроср, вексель'","'+КОР_РС, д/с'", true)
        ;   
    return sum ;
  END;

  PRIVATE MACRO GetSumS_4_6()    
    var sum = $0;
    sum = GetSum_PartTwo("'-РС,ц/б'","'Резерв, договор'", false, "8,10,19", null, null, "5" )
        + GetSum_PartTwo("'-РС,ц/б'","'Резерв ц/б'", false, "4,18,19", "3,4") // ПКУ, ПДО 
        + GetSum_PartTwo("'-РС,ц/б'","'Резерв ц/б'", false, "4,18,19", "2", "102" ) //Долевые СССД
//        + GetSum_PartTwo("'-КОР_РС, д/с'","'+Кор_Резерв, ЦБ'", false, "2", "102" )
        + GetSum_PartTwo("'-КОР_РС, д/с'","'+Кор_Резерв, ЦБ'", false, "4" )
//        + GetSum_PartTwo("'-КОР_РС, д/с'","'-Кор_Резерв, ЦБ'", false, "2", "102" )
        + GetSum_PartTwo("'-КОР_РС, д/с'","'-Кор_Резерв, ЦБ'", false, "4" )
        // УВ
        + GetSum_PartTwoVAForReserv("'-РС, д/с'","'Резерв, договор'", false, "8,10", null, null, null)
        + GetSum_PartTwo("'-РС, д/с'", "'РезервПросроч, вексель'", true)
        + GetSum_PartTwo("'-КОР_РС, д/с'","'-Кор_РезервПроср, вексель'", true)
        + GetSum_PartTwo("'-КОР_РС, д/с'","'+Кор_РезервПроср, вексель'", true)
        ;   
    return sum ;
  END;

  PRIVATE MACRO GetReservSum(Portfolio):MONEY
    if( (m_ReservSum_SSPU == NULL) OR (m_ReservSum_SSSD == NULL))
      LoadReservSumPDO(Portfolio)
    end;

    return IIF(Portfolio == KINDPORT_SSPU ,m_ReservSum_SSPU,m_ReservSum_SSSD);
  END; 

  PRIVATE MACRO GetCorrEstReservSum(Portfolio):MONEY
    if((m_CorrEstReservSum_SSPU == NULL) OR (m_CorrEstReservSum_SSSD == NULL))
      LoadReservSumPDO(Portfolio)
    end;

    return IIF(Portfolio == KINDPORT_SSPU ,m_CorrEstReservSum_SSPU,m_CorrEstReservSum_SSSD);
  END;

  MACRO A1():MONEY
    if(m_A1 == NULL)
      m_A1 = GetSumFromPortfToPDO(KINDPORT_SSPU);
    end;
    
    return m_A1;
  END;

  MACRO A2():MONEY
    if(m_A2 == NULL)
      m_A2 = GetSumFromPortfToPDO(KINDPORT_SSSD);
    end;

    return m_A2;
  END;

  MACRO A3():MONEY
    if(m_A3 == NULL)
      m_A3 = GetReservSum(KINDPORT_SSPU);

    end;
    
    return m_A3;
  END;

  MACRO A4():MONEY
    if(m_A4 == NULL)
      m_A4 = GetReservSum(KINDPORT_SSSD);
    end;

    return m_A4;
  END;

  MACRO A5():MONEY
    
    if(m_A5 == NULL)
        m_A5 = GetCorrEstReservSum(KINDPORT_SSPU) ;
    end;

    return m_A5;
  END;

  MACRO A6():MONEY
    if(m_A6 == NULL)
        m_A6 = GetCorrEstReservSum(KINDPORT_SSSD) ;

    end;

    return m_A6;
  END;

  MACRO A7():MONEY
    if(m_A7 == NULL)
        m_A7 = GetSum_A_5_2() ;
    end;
    
    return m_A7;
  END;

  MACRO A8():MONEY
    if(m_A8 == NULL)
        m_A8 = GetSum_A_5_3() ;
    end;

    return m_A8;
  END;

  MACRO A9():MONEY
    if(m_A9 == NULL)
        m_A9 = GetSum_A_5_4() ;
    end;

    return m_A9;
  END;

  MACRO A10():MONEY
    if(m_A10 == NULL)
        m_A10 = GetSum_A_5_5() ;
    end;

    return m_A10;
  END;

  MACRO A11():MONEY
    if(m_A11 == NULL)
        m_A11 = GetSum_A_5_6() ;
    end;

    return m_A11;
  END;

  MACRO A12():MONEY
    if(m_A12 == NULL)
        m_A12 = GetSum_A_5_7() ;
    end;
    return m_A12;
  END;

  MACRO A13():MONEY
    if(m_A13 == NULL)
        m_A13 = GetSumA474_5_9() ;
    end;
    return m_A13;
  END;

  MACRO A14():MONEY
    if(m_A14 == NULL)
        m_A14 = GetSumA474_16_1() ;
    end;
    return m_A14;
  END;

  MACRO A15():MONEY
    if(m_A15 == NULL)
        m_A15 = GetSumA474_16_2() ;
    end;
    return m_A15;
  END;

  MACRO A16():MONEY
    if(m_A16 == NULL)
        m_A16 = GetSumA474_16_3() ;
    end;
    return m_A16;
  END;

  MACRO A17():MONEY
    if(m_A17 == NULL)
        m_A17 = GetSumA474_16_5() ;
    end;
    return m_A17;
  END;

  MACRO A18():MONEY
    if(m_A18 == NULL)
        m_A18 = GetSumA474_16_5_1() ;
    end;
    return m_A18;
  END;

  MACRO A19():MONEY
    if(m_A19 == NULL)
        m_A19 = GetSumA474_16_10() ;
    end;
    return m_A19;
  END;

  MACRO A20():MONEY
    if(m_A20 == NULL)
        m_A20 = GetSumA474_16_11() ;
    end;
    return m_A20;
  END;
        
  MACRO A21():MONEY
    if(m_A21 == NULL)
        m_A21 = GetSumA474_18_1() ;
    end;
    return m_A21;
  END;

  MACRO A22():MONEY
    if(m_A22 == NULL)
        m_A22 = GetSumA9_2() ;
    end;
    return m_A22;
  END;

  MACRO A23():MONEY
    if(m_A23 == NULL)
        m_A23 = GetSumA9_3() ;
    end;
    return m_A23;
  END;

  MACRO A24():MONEY
    if(m_A24 == NULL)
        m_A24 = GetSumA12() ;
    end;
    return m_A24;
  END;

  MACRO A25():MONEY
    if(m_A25 == NULL)
        m_A25 = GetSumA18_4() ;
    end;
    return m_A25;
  END;

  MACRO A26():MONEY
    if(m_A26 == NULL)
        m_A26 = GetSumA18_5() ;
    end;
    return m_A26;
  END;

  MACRO A27():MONEY
    if(m_A27 == NULL)
      m_A27 = abs(GetChangeSumEstReserve(KINDPORT_SSSD, false, false));
    end;
    
    return m_A27;
  END;

  MACRO A28():MONEY
    if(m_A28 == NULL)
      m_A28 = abs(GetChangeSumEstReserve(KINDPORT_ASCB, false, false));
    end;

    return m_A28;
  END;

  MACRO A29():MONEY
    if(m_A29 == NULL)
      m_A29 = abs(GetChangeSumEstReserve(KINDPORT_SSSD, false, true) + GetChangeSumEstReserve(KINDPORT_ASCB, false, true));
    end;

    return m_A29;
  END;

  MACRO A30():MONEY
    if(m_A30 == NULL)
      m_A30 = GetChangeSumEstReserve(KINDPORT_SSSD, true, false);
    end;

    return m_A30;
  END;

  MACRO A31():MONEY
    if(m_A31 == NULL)
      m_A31 = GetChangeSumEstReserve(KINDPORT_ASCB, true, false);
    end;

    return m_A31;
  END;

  MACRO A32():MONEY
    if(m_A32 == NULL)
      m_A32 = abs(GetChangeSumEstReserve(KINDPORT_SSSD, true, true) + GetChangeSumEstReserve(KINDPORT_ASCB, true, true));
    end;

    return m_A32;
  END;

  MACRO A33():MONEY
    if(m_A33 == NULL)
        m_A33 = GetSumS155_16() ;
    end;
    return m_A33;
  END;

  MACRO A34():MONEY
    if(m_A34 == NULL)
        m_A34 = GetSumS156_17() ;
    end;
    return m_A34;
  END;

  MACRO A35():MONEY
    if(m_A35 == NULL)
        m_A35 = GetSumS_4_1() ;
    end;
    return m_A35;
  END;

  MACRO A36():MONEY
    if(m_A36 == NULL)
        m_A36 = GetSumS375_16() ;
    end;
    return m_A36;
  END;

  MACRO A37():MONEY
    if(m_A37 == NULL)
        m_A37 = GetSumS376_17() ;
    end;
    return m_A37;
  END;

  MACRO A38():MONEY
    if(m_A38 == NULL)
        m_A38 = GetSumS_4_3() ;
    end;
    return m_A38;
  END;

  MACRO A39():MONEY
    if(m_A39 == NULL)
        m_A39 = GetSumS_4_5() ;
    end;
    return m_A39;
  END;

  MACRO A40():MONEY
    if(m_A40 == NULL)
        m_A40 = GetSumS_4_6() ;
    end;
    return m_A40;
  END;

  MACRO Prepare()
    A1();
    A2();
    A3();
    A4();
    A5();
    A6();

    LoadSFC110TMP(m_BegDate, m_EndDate, m_DepartmentStr);

    A27();
    A28();
    A29();
    A30();
    A31();
    A32();
  END;

  Clear();
  m_BegDate = BegDate;
  m_EndDate = EndDate;

  if((DepartmentList != NULL) and (DepartmentList.size > 0))
    var i = 1;
    m_DepartmentStr = string(DepartmentList[0]);
    while(i < DepartmentList.size)
      m_DepartmentStr = m_DepartmentStr + "," + DepartmentList[i];
      i = i + 1;
    end;
  end;

END;


/* ********************************************** */
/* Клас данных по 110 форме                       */
/* ********************************************** */
class C_110_Secur(BegDate:date, EndDate:date, DepartmentList:TArray)
  private var m_objData = null;
  var А50505_4   = $0,
      А50505_6_1 = $0,
      А50507_4   = $0,
      А50507_6_2 = $0,
      А505_4     = $0,
      А505_6_2   = $0,
      А5_2       = $0,
      А5_3       = $0,
      А5_4       = $0,
      А5_5       = $0,
      А5_6       = $0,
      А5_7       = $0,
      А474_5_9   = $0,
      А474_16_1  = $0,
      А474_16_2  = $0,
      А474_16_3  = $0,
      А474_16_5  = $0,
      А474_16_5_1= $0,
      А474_16_10 = $0,
      А474_16_11 = $0,
      А474_18_1  = $0,
      А9_2       = $0,
      А9_3       = $0,
      А12        = $0,
      А18_4      = $0,
      А18_5      = $0,
      S175_16    = $0,
      S176_17    = $0,
      S_4_2      = $0,
      S385_16    = $0,
      S386_17    = $0,
      S_4_4      = $0,
      S155_16    = $0,
      S156_17    = $0,
      S_4_1      = $0,
      S375_16    = $0,
      S376_17    = $0,
      S_4_3      = $0,
      S_4_5      = $0,
      S_4_6      = $0;

  macro Get()
    if (null == m_objData)
      return 1;
    else
      m_objData.Prepare();

      А50505_4   = m_objData.A1();
      А50505_6_1 = m_objData.A2();
      А50507_4   = m_objData.A3();
      А50507_6_2 = m_objData.A4();
      А505_4     = m_objData.A5();
      А505_6_2   = m_objData.A6();
      А5_2      = m_objData.A7();
      А5_3      = m_objData.A8();
      А5_4      = m_objData.A9();
      А5_5      = m_objData.A10();
      А5_6      = m_objData.A11();
      А5_7      = m_objData.A12();
      А474_5_9  = m_objData.A13();
      А474_16_1 = m_objData.A14();
      А474_16_2 = m_objData.A15();
      А474_16_3 = m_objData.A16();
      А474_16_5 = m_objData.A17();
      А474_16_5_1= m_objData.A18();
      А474_16_10= m_objData.A19();
      А474_16_11= m_objData.A20();
      А474_18_1 = m_objData.A21();
      А9_2      = m_objData.A22();
      А9_3      = m_objData.A23();
      А12       = m_objData.A24();
      А18_4     = m_objData.A25();
      А18_5     = m_objData.A26();
      S175_16    = m_objData.A27();
      S176_17    = m_objData.A28();
      S_4_2      = m_objData.A29();
      S385_16    = m_objData.A30();
      S386_17    = m_objData.A31();
      S_4_4      = m_objData.A32();
      S155_16    = m_objData.A33();
      S156_17    = m_objData.A34();
      S_4_1      = m_objData.A35();
      S375_16    = m_objData.A36();
      S376_17    = m_objData.A37();
      S_4_3      = m_objData.A38();
      S_4_5      = m_objData.A39();
      S_4_6      = m_objData.A40();
    end;

    return 0;
  end;

  m_objData = SP_F110_Data(BegDate, EndDate, DepartmentList);
end;

////////////////////////////////////////////////////////

/* ********************************************************** */
/* Клаcс данных проверочного отчета к 110 форме (1 раздел)    */
/* ********************************************************** */
class C_110_Secur_Protocol_Part1(BegDate:date, EndDate:date, Portfolio:integer, DepartmentList:TArray)
  private var m_BegDate = date(0,0,0), m_EndDate = date(0,0,0), m_DepartmentStr = "" , m_Portfolio = "";
  private var m_DataSet, m_cmd, m_sel, m_ds;
  private var m_DataSetFIID, m_cmdFIID;
  private var m_FIID;
  private var m_prevPortfolio, m_prevPortfolioCode, m_break, m_needPrintTotal;
  private var Sum_S385_16,
              Sum_S386_17,
              Sum_S175_16,
              Sum_S176_17,
              Sum_S_4_4,  
              Sum_S_4_2,
              Total_S385_16,
              Total_S386_17,
              Total_S175_16,
              Total_S176_17,
              Total_S_4_4,  
              Total_S_4_2;  
              
  var IsItogLine,
      IsLastLine,
      Date_,           //A1  Дата проводки
      PortfolioCode,        //A3  Портфель
      IssuerShortName,      //A4  Эмитент
      AvrKindName,          //A5  Тип ценной бумаги
      ISIN,                 //A6  ISIN
      FaceValueFI_ISO,      //A7  Валюта номинала
      FaceValue,            //A8  Номинал
      Amount,            //A9  Количество
      SumCost,              //A10 Сумма телo+премия
      SumNKDAmount,         //A10_1 Сумма НКД уплач.
      SumInterestIncome,    //A10_2 Сумма НКД начисл.
      SumDiscountIncome,    //A10_3 Сумма дисконта
      SumReservAmount,      //A12
      SumIncomeReserv,      //A12_1
      SumCorRestReserve,    //A19/A20
      SumCorrEstReserv_Prc ,//A14
      SumCorrEstReserv_Inv ,//A14_1
      SumInv,               //A15/A16 
      SumReserv,            //A17/A18

      AccountA3,
      AccountA3_1,
      AccountA3_2,
      AccountA3_3,
      AccountA11,
      AccountA11_1,
      AccountA13,

      Note10,
      Note10_1,
      Note10_2,
      Note10_3,

      TotalAmount,          //A9  Количество
      TotalSumCost,              //A10 Сумма телo+премия
      TotalSumReservAmount,      //A12
      TotalSumCorrEstReserv_Prc ,//A14
      TotalSumInv,               //A15/A16 
      TotalSumReserv,            //A17/A18
      TotalSumCorRestReserve;    //A19/A20
  
  private macro GetDataFIID()
    var queryFIID;
 
   var NoteKind = 0, NoteKindNKD_P = 0, NoteKindNKD_A = 0, NoteKindD = 0;

     if(m_Portfolio == KINDPORT_SSSD)
      NoteKind = NOTEKIND_AVOIR_SUMPDOFROMSSSD;
      NoteKindNKD_P = NOTEKIND_AVOIR_SUMPDO_NKD_P_SSSD;
      NoteKindNKD_A = NOTEKIND_AVOIR_SUMPDO_NKD_A_SSSD;
      NoteKindD = NOTEKIND_AVOIR_SUMPDO_DISC_SSSD;
    elif(m_Portfolio == KINDPORT_SSPU)
      NoteKind = NOTEKIND_AVOIR_SUMPDOFROMSSPU;
      NoteKindNKD_P = NOTEKIND_AVOIR_SUMPDO_NKD_P_SSPU;
      NoteKindNKD_A = NOTEKIND_AVOIR_SUMPDO_NKD_A_SSPU;
      NoteKindD = NOTEKIND_AVOIR_SUMPDO_DISC_SSPU;
    end;

   var AccCateg   = " SELECT DISTINCT "
                  + "      accdoc.t_Account  Account, cat.t_Code Code,accdoc.t_FIID, "
                  + "      (CASE "
                  + "         WHEN cat.t_Class1 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value1 "
                  + "         WHEN cat.t_Class2 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value2 "
                  + "         WHEN cat.t_Class3 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value3 "
                  + "         WHEN cat.t_Class4 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value4 "
                  + "         WHEN cat.t_Class5 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value5 "
                  + "         WHEN cat.t_Class6 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value6 "
                  + "         WHEN cat.t_Class7 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value7 "
                  + "         WHEN cat.t_Class8 = "+LLCLASS_KINDRESERV_KIND+" THEN tpl.t_Value8 "
                  + "         ELSE -1 "
                  + "       END) vidRes, "
                  + "      (CASE "
                  + "         WHEN cat.t_Class1 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value1 "         
                  + "         WHEN cat.t_Class2 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value2 "
                  + "         WHEN cat.t_Class3 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value3 "
                  + "         WHEN cat.t_Class4 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value4 "
                  + "         WHEN cat.t_Class5 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value5 "
                  + "         WHEN cat.t_Class6 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value6 "
                  + "         WHEN cat.t_Class7 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value7 "
                  + "         WHEN cat.t_Class8 = "+LLCLASS_KIND_ACC_PDD+" THEN tpl.t_Value8 "
                  + "           ELSE -1 "
                  + "         END) vidPDD "
                  + "   FROM dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
                  + "  WHERE     cat.t_Code IN ( 'Наш портфель ц/б', 'Уплаченный НКД', 'Начисл.ПДД, ц/б','Резерв ц/б','+Кор_Резерв, ЦБ','-Кор_Резерв, ЦБ') "
                  + "        AND accdoc.t_CatID = cat.t_ID "
                  + "        AND tpl.t_CatID = accdoc.t_CatID "
                  + "        AND tpl.t_Number = accdoc.t_TemplNum "
                  + "        AND accdoc.t_FIID = ?  "
                  + "        AND  (CASE "
                  + "           WHEN cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
                  + "           WHEN cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
                  + "           WHEN cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
                  + "           WHEN cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
                  + "           WHEN cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
                  + "           WHEN cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
                  + "           WHEN cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
                  + "           WHEN cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
                  + "           ELSE -1 "
                  + "         END) = 4 "
                  ;

    queryFIID = "with AccCateg as (" + AccCateg + ")"
          + "  SELECT REGEXP_SUBSTR( llv.t_Code, '\\w[^_]+' ) AS PortfolioCode, "
          + "        issuer.t_ShortName AS IssuerShortName, "
          + "        avr.t_ISIN AS ISIN, "
          + "        avrk.t_Name AS AvrKindName, "
          + "        cur.t_ISO_Number AS FaceValueFI_ISO, "
          + "        fin.t_FaceValue, "
          + "        fin.t_FIID, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code ='Наш портфель ц/б' ),CHR(1)) AS AccountA3, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code ='Уплаченный НКД' ),CHR(1)) AS AccountA3_1, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code ='Начисл.ПДД, ц/б' AND  AccCateg.vidPDD = 1),CHR(1)) AS AccountA3_2, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code ='Начисл.ПДД, ц/б' AND  AccCateg.vidPDD = 2),CHR(1)) AS AccountA3_3, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code ='Резерв ц/б' AND  AccCateg.vidRes = 4),CHR(1)) AS AccountA11, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code ='Резерв ц/б' AND  AccCateg.vidRes = 13),CHR(1)) AS AccountA11_1, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code = '+Кор_Резерв, ЦБ' ),CHR(1)) AS AccountA13P, "
          + "        NVL((SELECT AccCateg.Account FROM AccCateg WHERE AccCateg.Code = '-Кор_Резерв, ЦБ' ),CHR(1)) AS AccountA13M "
          + "      , NVL(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?), 0) as SumNat "
          + "      , NVL(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?), 0) as SumNatP"
          + "      , NVL(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?), 0) as SumNatA"
          + "      , NVL(RSB_FIInstr.ConvSum(NVL(rsb_struct.getMoney(rsi_rsb_kernel.GetNote("+OBJTYPE_AVOIRISS+", LPAD(fin.t_FIID, 10, '0'), ?, ?)), 0), fin.t_FaceValueFI, "+NATCUR+", ?), 0) as SumNatD"
          + "   FROM dfininstr_dbt fin, "
          + "        davoiriss_dbt avr, "
          + "        dparty_dbt issuer, "
          + "        dllvalues_dbt llv, "
          + "        davrkinds_dbt avrk, "
          + "        davrkinds_dbt avrk1, "
          + "        dfininstr_dbt cur "
          + "  WHERE fin.t_FIID = ? "
          + "        AND avr.t_FIID = fin.t_FIID "
          + "        AND avrk.t_FI_Kind = avrk1.t_FI_Kind "
          + "        AND avrk.t_AvoirKind = avrk1.t_root "
          + "        AND avrk1.t_FI_Kind = fin.t_FI_Kind "
          + "        AND avrk1.t_AvoirKind = fin.t_AvoirKind "
          + "        AND issuer.t_PartyID = fin.t_Issuer "
          + "        AND llv.t_List = " + OBJTYPE_KINDPORT
          + "        AND llv.t_Element = " + m_Portfolio
          + "        AND cur.t_FIID = fin.t_FaceValueFI "
          ;
    m_cmdFIID = DL_RSDCommand(queryFIID);
    m_cmdFIID.AddParam(m_FIID);
    m_cmdFIID.AddParam(NoteKind);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(NoteKindNKD_P);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(NoteKindNKD_A);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(NoteKindD);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(m_EndDate);
    m_cmdFIID.AddParam(m_FIID);
    m_DataSetFIID = m_cmdFIID.Execute();

    if(m_DataSetFIID.moveNext())
      PortfolioCode    = m_DataSetFIID.PortfolioCode;
      IssuerShortName  = m_DataSetFIID.IssuerShortName;
      AvrKindName      = m_DataSetFIID.AvrKindName;
      ISIN             = m_DataSetFIID.ISIN;
      FaceValueFI_ISO  = m_DataSetFIID.FaceValueFI_ISO;
      FaceValue        = m_DataSetFIID.FaceValue;
      m_prevPortfolioCode = m_DataSetFIID.PortfolioCode;
      AccountA3        = m_DataSetFIID.AccountA3;
      AccountA3_1      = m_DataSetFIID.AccountA3_1;
      AccountA3_2      = m_DataSetFIID.AccountA3_2;
      AccountA3_3      = m_DataSetFIID.AccountA3_3;
      AccountA11       = m_DataSetFIID.AccountA11;
      AccountA11_1     = m_DataSetFIID.AccountA11_1;
      SumCost          = SumCost + m_DataSetFIID.SumNat; 
      SumNKDAmount     = SumNKDAmount + m_DataSetFIID.SumNatP;
      SumInterestIncome= SumInterestIncome + m_DataSetFIID.SumNatA;
      SumDiscountIncome= SumDiscountIncome + m_DataSetFIID.SumNatD;
      if(SumCorRestReserve > 0)                    // для положительных- минус
        AccountA13 = m_DataSetFIID.AccountA13M;
      elif(SumCorRestReserve < 0)
        AccountA13 = m_DataSetFIID.AccountA13P;
      else
        if( m_DataSetFIID.AccountA13P == "")
          AccountA13 = m_DataSetFIID.AccountA13P;
        else
          AccountA13 = m_DataSetFIID.AccountA13M;
        end;
      end;

    end;
  end;

  private macro Prepare()
    var query;

    IsItogLine = false;
    IsLastLine = false;

    TotalAmount               = 0.0;
    TotalSumCost              = 0.0;
    TotalSumReservAmount      = 0.0;
    TotalSumCorrEstReserv_Prc = 0.0;
    TotalSumInv               = 0.0;
    TotalSumReserv            = 0.0;
    TotalSumCorRestReserve    = 0.0;

    query = " SELECT NVL(SUM(RSB_FIInstr.ConvSum(wrt.t_Cost, fin.t_FaceValueFI, "+NATCUR+", ?)), 0) AS COST, "
          + "        SUM(wrt.T_NKDAMOUNT) AS NKDAMOUNT, "
          + "        SUM(wrt.T_INTERESTINCOME) AS INTERESTINCOME, "
          + "        SUM(wrt.T_DISCOUNTINCOME) AS DISCOUNTINCOME, "
          + "        SUM(wrt.T_RESERVAMOUNT) AS RESERVAMOUNT, "
          + "        SUM(wrt.T_INCOMERESERV) AS INCOMERESERV, "
          + "        SUM(wrt.T_CORRESTRESERVE) AS CORRESTRESERVE, "
          + "        SUM(wrt.T_AMOUNT) AS Amount, "
          + "        wrt.t_FIID "
          + "   FROM v_scwrthistex wrt, dfininstr_dbt fin "
          + "  WHERE     wrt.t_ChangeDate <= ? "
          + "        AND wrt.t_Portfolio =  "+ KINDPORT_PROMISSORY
          + "        AND decode(wrt.t_Instance, "
          + "              (SELECT MAX (wrt2.t_Instance) "
          + "                 FROM v_scwrthistex wrt2 "
          + "                WHERE     wrt2.t_SumID = wrt.t_SumID "
          + "                      AND wrt2.t_ChangeDate <= ? ),1,0)=1"
          + "        AND EXISTS "
          + "              (SELECT 1 "
          + "                 FROM v_scwrthistex wrt1 "
          + "                WHERE     wrt1.t_SumID = wrt.t_SumID "
          + "                      AND decode(wrt1.t_Portfolio, " + m_Portfolio+",1,0)=1"
          + "                      AND wrt1.t_ChangeDate <= wrt.t_ChangeDate) "
          + "        AND fin.t_FIID = wrt.t_FIID "
          + "  group by wrt.t_FIID"
          ;
    if(m_DepartmentStr != "")
      query = query + " and wrt.t_Department IN ("+m_DepartmentStr+")";
    end;

    m_cmd = DL_RSDCommand(query);
    m_cmd.AddParam(m_EndDate);
    m_cmd.AddParam(m_EndDate);
    m_cmd.AddParam(m_EndDate);
    InitProgress(-1, "Подготовка данных", "Подготовка данных для проверочного отчета");
    m_DataSet = m_cmd.Execute();
    RemProgress();

  end;

  macro GetNext()
    var stat = true;
    var delta, delta_prc;

    if(m_break == true)
      RemProgress();
      return false;
    end;

    if(m_DataSet == NULL)
      Prepare();

      InitProgress(-1, "Формирование данных", "Формирование данных для проверочного отчета");
    end;

    if(IsItogLine == false) //если предыдущая строка не была итоговой
      stat = m_DataSet.moveNext();
    end; 
    if((not stat) and (IsItogLine == false))  //  итого по портфелям
      stat = true;
      m_break = true;
      
      IsItogLine       = true;
      IsLastLine       = false;

      if (m_prevPortfolioCode == null)
        var cmd = DL_RSDCommand("SELECT t_Code"
                              + "  FROM dllvalues_dbt"
                              + " WHERE t_List = " + OBJTYPE_KINDPORT
                              + "   AND t_Element = " + m_Portfolio);
        var dataset = cmd.Execute();
        if (dataset.MoveNext())
          Date_ = "Итого " + dataset.t_Code;
        else
          Date_ = "Итого";
        end;
      else
      Date_            = "Итого " + m_prevPortfolioCode;
      end;

      PortfolioCode    = "";
      IssuerShortName  = "";
      AvrKindName      = "";
      ISIN             = "";
      FaceValueFI_ISO  = "";
      FaceValue        = "";

      Amount            = TotalAmount;

      SumCost           = TotalSumCost;
      SumNKDAmount      = "";
      SumInterestIncome = "";
      SumDiscountIncome = "";
      SumReservAmount   = TotalSumReservAmount;
      SumIncomeReserv   = "";
      SumCorRestReserve = TotalSumCorRestReserve;
      SumCorrEstReserv_Prc = TotalSumCorrEstReserv_Prc;
      SumCorrEstReserv_Inv = "";
      SumInv            = TotalSumInv;      
      SumReserv         = TotalSumReserv;

      AccountA3         = "";
      AccountA3_1       = "";
      AccountA3_2       = "";
      AccountA3_3       = "";
      AccountA11        = "";
      AccountA11_1      = "";
      AccountA13        = "";

    else

      IsItogLine       = false;
      IsLastLine       = false;
      Date_            = date(m_EndDate);
    
      Amount            = m_DataSet.Amount;

      SumCost           = m_DataSet.Cost;
      SumNKDAmount      = m_DataSet.NKDAmount;
      SumInterestIncome = m_DataSet.InterestIncome;
      SumDiscountIncome = m_DataSet.DiscountIncome;
      SumReservAmount   = m_DataSet.ReservAmount;
      SumIncomeReserv   = m_DataSet.IncomeReserv;
      SumCorRestReserve = m_DataSet.CorRestReserve;
      SumInv            = SumCost+ SumNKDAmount + SumInterestIncome +SumDiscountIncome;
      SumReserv         = SumReservAmount + SumIncomeReserv;

      if( Not(SumInv == 0))
        SumCorrEstReserv_Prc = (SumCorRestReserve/SumInv) *(SumInterestIncome + SumDiscountIncome) ;
        SumCorrEstReserv_Inv = SumCorRestReserve-SumCorrEstReserv_Prc;
      else
        SumCorrEstReserv_Prc = 0;
        SumCorrEstReserv_Inv = 0;
      end;
      m_FIID = m_DataSet.FIID;
      GetDataFIID();

      TotalAmount               = TotalAmount + Amount;           
      TotalSumCost              = TotalSumCost + SumCost + SumNKDAmount + SumInterestIncome + SumDiscountIncome;          
      TotalSumReservAmount      = TotalSumReservAmount + SumReservAmount;    
      TotalSumCorrEstReserv_Prc = TotalSumCorrEstReserv_Prc + SumCorrEstReserv_Prc + SumCorrEstReserv_Inv;
      TotalSumInv               = TotalSumInv + SumInv;            
      TotalSumReserv            = TotalSumReserv + SumReserv;          
      TotalSumCorRestReserve    = TotalSumCorRestReserve + SumCorRestReserve;  

    end;
    
    m_prevPortfolio     = m_Portfolio;

    return stat;
  end;

  m_DataSet        = NULL;
  m_prevPortfolio  = -1;
  m_break          = false;
  m_needPrintTotal = false;

  m_BegDate = BegDate;
  m_EndDate = EndDate;
  m_Portfolio = portfolio;
  if((DepartmentList != NULL) and (DepartmentList.size > 0))
    var i = 1;
    m_DepartmentStr = string(DepartmentList[0]);
    while(i < DepartmentList.size)
      m_DepartmentStr = m_DepartmentStr + "," + DepartmentList[i];
      i = i + 1;
    end;
  end;

end;


////////////////////////////////////////////////////////////////////

/* ****************************************************** */
/* Клас данных проверочного отчета к 110 форме (2 раздел) */
/* ****************************************************** */
class C_110_Secur_Protocol(BegDate:date, EndDate:date, DepartmentList:TArray)
  private var m_BegDate = date(0,0,0), m_EndDate = date(0,0,0), m_DepartmentStr = "";
  private var m_DataSet, m_cmd, m_sel, m_ds;
  private var m_prevPortfolio, m_prevPortfolioCode, m_break, m_needPrintTotal;
  private var Sum_S385_16,
              Sum_S386_17,
              Sum_S175_16,
              Sum_S176_17,
              Sum_S_4_4,  
              Sum_S_4_2,
              Total_S385_16,
              Total_S386_17,
              Total_S175_16,
              Total_S176_17,
              Total_S_4_4,  
              Total_S_4_2;  
              
  var IsItogLine,
      IsLastLine,
      Date_Carry,           //A1  Дата проводки
      Numb_Document,        //A2  Номер м/о
      PortfolioCode,        //A3  Портфель
      IssuerShortName,      //A4  Эмитент
      AvrKindName,          //A5  Тип ценной бумаги
      ISIN,                 //A6  ISIN
      FaceValueFI_ISO,      //A7  Валюта номинала
      FaceValue,            //A8  Номинал
      SumAmount,            //A9  Количество
      SumCost,              //A10 Сумма телo+премия, руб.
      SumNKDAmount,         //A11 Сумма НКД уплач., руб.
      SumInterestIncome,    //A12 Сумма НКД начисл., руб.
      SumDiscountIncome,    //A13 Сумма дисконта, руб.
      SumOutlay,            //A14 Сумма затрат, руб.
      SumCorrValue,         //A15 Сумма корректировки СС, руб.
      SumCorrIntToEIR,      //A16 Сумма корректировки % до ЭПС, руб.
      Account_Payer,        //A17 Дебет
      Account_Receiver,     //A18 Кредит
      Carry_Sum,            //A19 Сумма проводки
      S385_16,              //A20 S385/16(СССД формирование)
      S386_17,              //A21 S386/17 (АС формирование)
      S175_16,              //A22 S175/16 (СССД восстановление)
      S176_17,              //A23 S176/17 (АС восстановление)
      S_4_4,                //A24 S/4.4(формирование)
      S_4_2;                //A25 S/4.2(восстановление)

  private macro Prepare()
    var query;

    IsItogLine = false;
    IsLastLine = false;

    Sum_S385_16 = 0.0;
    Sum_S386_17 = 0.0;
    Sum_S175_16 = 0.0;
    Sum_S176_17 = 0.0;
    Sum_S_4_4   = 0.0;
    Sum_S_4_2   = 0.0;

    Total_S385_16 = 0.0;
    Total_S386_17 = 0.0;
    Total_S175_16 = 0.0;
    Total_S176_17 = 0.0;
    Total_S_4_4   = 0.0;
    Total_S_4_2   = 0.0;

    query =   " select atrn.t_Date_Carry, atrn.t_Account_Payer, atrn.t_Account_Receiver, atrn.t_Numb_Document, f110.t_CarrySum as t_Sum_Natcur, "
            + "        f110.t_Amount, f110.t_NKDAmount, f110.t_Cost, f110.t_InterestIncome, f110.t_DiscountIncome, f110.t_Outlay, "
            + "        f110.t_CorrValue, f110.t_CorrIntToEIR, "
            + "        f110.t_S385_16, f110.t_S386_17, f110.t_S175_16, f110.t_S176_17, f110.t_S_4_4, f110.t_S_4_2, " 
            + "        f110.t_Portfolio, REGEXP_SUBSTR( llv.t_Code, '\\w[^_]+' ) as PortfolioCode, issuer.t_ShortName as IssuerShortName, avr.t_ISIN as ISIN, "
            + "        avrk.t_Name as AvrKindName, cur.t_ISO_Number as FaceValueFI_ISO, "
            + "        rsb_fiinstr.FI_GetNominalOnDate (fin.t_FIID, atrn.t_Date_Carry, 1) as FaceValue, "
            + "        f110.t_ID_Operation, f110.t_ID_Step, fin.t_FaceValueFI, f110.t_FIID "
            + "   from dscf110_tmp f110, dacctrn_dbt atrn, dfininstr_dbt fin, davoiriss_dbt avr, dparty_dbt issuer, dllvalues_dbt llv, davrkinds_dbt avrk, dfininstr_dbt cur "
            + "  where atrn.t_AccTrnID = f110.t_AccTrnID "
            + "    and fin.t_FIID = f110.t_FIID "
            + "    and avr.t_FIID = fin.t_FIID "
            + "    and avrk.t_FI_Kind = fin.t_FI_Kind "
            + "    and avrk.t_AvoirKind = fin.t_AvoirKind "
            + "    and issuer.t_PartyID = fin.t_Issuer "
            + "    and llv.t_List = " + OBJTYPE_KINDPORT
            + "    and llv.t_Element = f110.t_Portfolio "
            + "    and cur.t_FIID = fin.t_FaceValueFI "
            + " order by f110.t_Portfolio ASC, atrn.t_Date_Carry ASC, f110.t_FIID ASC ";


    m_cmd = DL_RSDCommand(query);

    InitProgress(-1, "Подготовка данных", "Подготовка данных для проверочного отчета");
    m_DataSet = m_cmd.Execute();
    RemProgress();

  end;

  private var entry : integer = 0;

  macro GetNext()
    var stat = true;
    var delta, delta_prc;

    if(m_break == true)
      RemProgress();
      return false;
    end;

    if(m_DataSet == NULL)
      Prepare();

      InitProgress(-1, "Формирование данных", "Формирование данных для проверочного отчета");
    end;

    if(IsItogLine == false) //если предыдущая строка не была итоговой
      stat = m_DataSet.moveNext();
    end; 
      
    if(m_needPrintTotal == true)
      stat = true;
      m_break = true;

      IsItogLine       = true;
      IsLastLine       = true;
      Date_Carry       = "Итого:";
      Numb_Document    = "";
      PortfolioCode    = "";
      IssuerShortName  = "";
      AvrKindName      = "";
      ISIN             = "";
      FaceValueFI_ISO  = "";
      FaceValue        = "";

      SumAmount         = "";
      SumCost           = "";
      SumNKDAmount      = "";
      SumInterestIncome = "";
      SumDiscountIncome = "";
      SumOutlay         = "";
      SumCorrValue      = "";
      SumCorrIntToEIR   = "";

      Account_Payer    = "";
      Account_Receiver = "";
      Carry_Sum        = "";

      S385_16 = Total_S385_16;
      S386_17 = Total_S386_17;
      S175_16 = Total_S175_16;
      S176_17 = Total_S176_17;
      S_4_4   = Total_S_4_4  ;
      S_4_2   = Total_S_4_2  ;

    elif ((not stat) or ((m_prevPortfolio != -1) and (m_prevPortfolio != m_DataSet.Portfolio)) or entry == 1)
      if ((not stat) or (entry == 1))
        m_needPrintTotal = true; //записи закончились, сразу не выходим, т.к. нужно напечатать итог, а при следующей итерации сразу выходим
      end;

      stat = true;
      
      IsItogLine       = true;
      IsLastLine       = false;

      if (m_prevPortfolioCode == null)
          entry = entry + 1;
          if (entry == 1)
            Date_Carry = "Итого СССД_ЦБ";
            m_needPrintTotal = false;
          elif (entry == 2)
            Date_Carry = "Итого АС_ЦБ";
            entry = 0;
          end;
      else
      Date_Carry       = "Итого " + m_prevPortfolioCode;
      end;

      Numb_Document    = "";
      PortfolioCode    = "";
      IssuerShortName  = "";
      AvrKindName      = "";
      ISIN             = "";
      FaceValueFI_ISO  = "";
      FaceValue        = "";

      SumAmount         = "";
      SumCost           = "";
      SumNKDAmount      = "";
      SumInterestIncome = "";
      SumDiscountIncome = "";
      SumOutlay         = "";
      SumCorrValue      = "";
      SumCorrIntToEIR   = "";

      Account_Payer    = "";
      Account_Receiver = "";
      Carry_Sum        = "";

      S385_16 = Sum_S385_16;
      S386_17 = Sum_S386_17;
      S175_16 = Sum_S175_16;
      S176_17 = Sum_S176_17;
      S_4_4   = Sum_S_4_4  ;
      S_4_2   = Sum_S_4_2  ;

      Sum_S385_16 = 0.0;
      Sum_S386_17 = 0.0;
      Sum_S175_16 = 0.0;
      Sum_S176_17 = 0.0;
      Sum_S_4_4   = 0.0;
      Sum_S_4_2   = 0.0;

    else
      IsItogLine       = false;
      IsLastLine       = false;
      Date_Carry       = date(m_DataSet.Date_Carry);
      Numb_Document    = m_DataSet.Numb_Document;
      PortfolioCode    = m_DataSet.PortfolioCode;
      IssuerShortName  = m_DataSet.IssuerShortName;
      AvrKindName      = m_DataSet.AvrKindName;
      ISIN             = m_DataSet.ISIN;
      FaceValueFI_ISO  = m_DataSet.FaceValueFI_ISO;
      FaceValue        = m_DataSet.FaceValue;
     
      SumAmount         = m_DataSet.Amount;
      SumCost           = m_DataSet.Cost;
      SumNKDAmount      = m_DataSet.NKDAmount;
      SumInterestIncome = m_DataSet.InterestIncome;
      SumDiscountIncome = m_DataSet.DiscountIncome;
      SumOutlay         = m_DataSet.Outlay;
      SumCorrValue      = m_DataSet.CorrValue;
      SumCorrIntToEIR   = m_DataSet.CorrIntToEIR; 

      Account_Payer    = m_DataSet.Account_Payer;
      Account_Receiver = m_DataSet.Account_Receiver;
      Carry_Sum        = m_DataSet.Sum_Natcur;

      S385_16 = m_DataSet.S385_16;
      S386_17 = m_DataSet.S386_17;
      S175_16 = m_DataSet.S175_16;
      S176_17 = m_DataSet.S176_17;
      S_4_4   = m_DataSet.S_4_4  ;
      S_4_2   = m_DataSet.S_4_2  ;

      Sum_S385_16 = Sum_S385_16 + S385_16;
      Sum_S386_17 = Sum_S386_17 + S386_17;
      Sum_S175_16 = Sum_S175_16 + S175_16;
      Sum_S176_17 = Sum_S176_17 + S176_17;
      Sum_S_4_4   = Sum_S_4_4   + S_4_4; 
      Sum_S_4_2   = Sum_S_4_2   + S_4_2;  

      Total_S385_16 = Total_S385_16 + S385_16;
      Total_S386_17 = Total_S386_17 + S386_17;
      Total_S175_16 = Total_S175_16 + S175_16;
      Total_S176_17 = Total_S176_17 + S176_17;
      Total_S_4_4   = Total_S_4_4   + S_4_4;  
      Total_S_4_2   = Total_S_4_2   + S_4_2;  
      
    end;
    
    m_prevPortfolio     = m_DataSet.Portfolio;
    m_prevPortfolioCode = m_DataSet.PortfolioCode;

    return stat;
  end;

  m_DataSet        = NULL;
  m_prevPortfolio  = -1;
  m_break          = false;
  m_needPrintTotal = false;

  m_BegDate = BegDate;
  m_EndDate = EndDate;

  if((DepartmentList != NULL) and (DepartmentList.size > 0))
    var i = 1;
    m_DepartmentStr = string(DepartmentList[0]);
    while(i < DepartmentList.size)
      m_DepartmentStr = m_DepartmentStr + "," + DepartmentList[i];
      i = i + 1;
    end;
  end;

end;

/* ********************************************** */
/* Клас данных справочной информации к 110 форме    */
/* ********************************************** */
class C_110_Secur_RefInf(BegDate:date, EndDate:date, DepartmentList:TArray)
  private var m_BegDate = date(0,0,0), m_EndDate = date(0,0,0), m_DepartmentStr = "";
  private var m_DataSet, m_cmd;
              
  var Date_Carry,           //A1 Дата проводки
      Numb_Document,        //A2 Номер м/о
      Account_Payer,        //A3 Дебет
      Account_Receiver,     //A4 Кредит
      Carry_Sum,            //A5 Сумма проводки
      Ground;               //A6 Назначение платежа 

  private macro Prepare()
    var query;

    query =   " with mCorAcc as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, "
            + "                         (case when cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
            + "                               when cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
            + "                               when cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
            + "                               when cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
            + "                               when cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
            + "                               when cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
            + "                               when cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
            + "                               when cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
            + "                               else -1 end) as PortfolioID "
            + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
            + "                   where cat.t_Code     = '-КорОР_ЦБ' "
            + "                     and accdoc.t_CatID = cat.t_ID "
            + "                     and tpl.t_CatID    = accdoc.t_CatID "
            + "                     and tpl.t_Number   = accdoc.t_TemplNum "
            + "                 ), "
            + "      pCorAcc as (select DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter, "
            + "                         (case when cat.t_Class1 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value1 "
            + "                               when cat.t_Class2 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value2 "
            + "                               when cat.t_Class3 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value3 "
            + "                               when cat.t_Class4 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value4 "
            + "                               when cat.t_Class5 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value5 "
            + "                               when cat.t_Class6 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value6 "
            + "                               when cat.t_Class7 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value7 "
            + "                               when cat.t_Class8 = "+LLCLASS_KINDPORT+" THEN tpl.t_Value8 "
            + "                               else -1 end) as PortfolioID "
            + "                    from dmcaccdoc_dbt accdoc, dmccateg_dbt cat, dmctempl_dbt tpl "
            + "                   where cat.t_Code     = '+КорОР_ЦБ' "
            + "                     and accdoc.t_CatID = cat.t_ID "
            + "                     and tpl.t_CatID    = accdoc.t_CatID "
            + "                     and tpl.t_Number   = accdoc.t_TemplNum "
            + "                 ) "
            + " select q.* "
            + "   from (select atrn.t_AccTrnID, "
            + "                atrn.t_Date_Carry, "
            + "                atrn.t_Sum_Natcur, "
            + "                atrn.t_Numb_Document, "
            + "                atrn.t_Account_Payer, "
            + "                atrn.t_Account_Receiver, "
            + "                atrn.t_Ground, "
            + "                mCorAcc.PortfolioID "
            + "           from mCorAcc, dacctrn_dbt atrn "
            + "          where mCorAcc.PortfolioID IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")" 
            + "            and atrn.t_State         = 1 "
            + "            and atrn.t_Chapter       = mCorAcc.t_Chapter "
            + "            and atrn.t_Account_Payer = mCorAcc.t_Account "
            + "            and atrn.t_FIID_Payer    = mCorAcc.t_Currency "
            + "            and atrn.t_Date_Carry BETWEEN ? AND ? "
            +IIF(m_DepartmentStr != "", " and atrn.t_Department IN ("+m_DepartmentStr+")", "")
            + "            and Not Exists(select 1 from dscf110_tmp f110 where f110.t_AccTrnID = atrn.t_AccTrnID) "
            + "         UNION "
            + "         select atrn.t_AccTrnID, "
            + "                atrn.t_Date_Carry, "
            + "                atrn.t_Sum_Natcur, "
            + "                atrn.t_Numb_Document, "
            + "                atrn.t_Account_Payer, "
            + "                atrn.t_Account_Receiver, "
            + "                atrn.t_Ground, "
            + "                mCorAcc.PortfolioID "
            + "           from mCorAcc, dacctrn_dbt atrn "
            + "          where mCorAcc.PortfolioID IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")" 
            + "            and atrn.t_State            = 1 "
            + "            and atrn.t_Chapter          = mCorAcc.t_Chapter "
            + "            and atrn.t_Account_Receiver = mCorAcc.t_Account "
            + "            and atrn.t_FIID_Receiver    = mCorAcc.t_Currency "
            + "            and atrn.t_Date_Carry BETWEEN ? AND ? "
            +IIF(m_DepartmentStr != "", " and atrn.t_Department IN ("+m_DepartmentStr+")", "")
            + "            and Not Exists(select 1 from dscf110_tmp f110 where f110.t_AccTrnID = atrn.t_AccTrnID) "
            + "         UNION "
            + "         select atrn.t_AccTrnID, "
            + "                atrn.t_Date_Carry, "
            + "                atrn.t_Sum_Natcur, "
            + "                atrn.t_Numb_Document, "
            + "                atrn.t_Account_Payer, "
            + "                atrn.t_Account_Receiver, "
            + "                atrn.t_Ground, "
            + "                pCorAcc.PortfolioID "
            + "           from pCorAcc, dacctrn_dbt atrn "
            + "          where pCorAcc.PortfolioID IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")" 
            + "            and atrn.t_State            = 1 "
            + "            and atrn.t_Chapter          = pCorAcc.t_Chapter "
            + "            and atrn.t_Account_Receiver = pCorAcc.t_Account "
            + "            and atrn.t_FIID_Receiver    = pCorAcc.t_Currency "
            + "            and atrn.t_Date_Carry BETWEEN ? AND ? "
            +IIF(m_DepartmentStr != "", " and atrn.t_Department IN ("+m_DepartmentStr+")", "")
            + "            and Not Exists(select 1 from dscf110_tmp f110 where f110.t_AccTrnID = atrn.t_AccTrnID) "
            + "         UNION "
            + "         select atrn.t_AccTrnID, "
            + "                atrn.t_Date_Carry, "
            + "                atrn.t_Sum_Natcur, "
            + "                atrn.t_Numb_Document, "
            + "                atrn.t_Account_Payer, "
            + "                atrn.t_Account_Receiver, "
            + "                atrn.t_Ground, "
            + "                pCorAcc.PortfolioID "
            + "           from pCorAcc, dacctrn_dbt atrn "
            + "          where pCorAcc.PortfolioID IN ("+KINDPORT_SSSD+","+KINDPORT_ASCB+")" 
            + "            and atrn.t_State         = 1 "
            + "            and atrn.t_Chapter       = pCorAcc.t_Chapter "
            + "            and atrn.t_Account_Payer = pCorAcc.t_Account "
            + "            and atrn.t_FIID_Payer    = pCorAcc.t_Currency "
            + "            and atrn.t_Date_Carry BETWEEN ? AND ? "
            +IIF(m_DepartmentStr != "", " and atrn.t_Department IN ("+m_DepartmentStr+")", "")
            + "            and Not Exists(select 1 from dscf110_tmp f110 where f110.t_AccTrnID = atrn.t_AccTrnID) "

            + "        ) q "
            + " order by q.t_Date_Carry ASC, q.t_AccTrnID ASC ";

   
    m_cmd = DL_RSDCommand(query);
    m_cmd.addParam(m_BegDate);
    m_cmd.addParam(m_EndDate);
    m_cmd.addParam(m_BegDate);
    m_cmd.addParam(m_EndDate);
    m_cmd.addParam(m_BegDate);
    m_cmd.addParam(m_EndDate);
    m_cmd.addParam(m_BegDate);
    m_cmd.addParam(m_EndDate);

    InitProgress(-1, "Подготовка данных", "Подготовка справочной информации");
    m_DataSet = m_cmd.Execute();
    RemProgress();

  end;

  macro GetNext()
    var stat = true;

    if(m_DataSet == NULL)
      Prepare();

      InitProgress(-1, "Формирование данных", "Формирование справочной информации");
    end;

    stat = m_DataSet.moveNext();
    if(stat)  
      Date_Carry       = date(m_DataSet.Date_Carry);
      Numb_Document    = m_DataSet.Numb_Document;
      Account_Payer    = m_DataSet.Account_Payer;
      Account_Receiver = m_DataSet.Account_Receiver;
      Carry_Sum        = m_DataSet.Sum_Natcur;
      Ground           = m_DataSet.Ground;
    else
      RemProgress();
    end;

    return stat;
  end;

  m_DataSet = NULL;

  m_BegDate = BegDate;
  m_EndDate = EndDate;

  if((DepartmentList != NULL) and (DepartmentList.size > 0))
    var i = 1;
    m_DepartmentStr = string(DepartmentList[0]);
    while(i < DepartmentList.size)
      m_DepartmentStr = m_DepartmentStr + "," + DepartmentList[i];
      i = i + 1;
    end;
  end;

end;