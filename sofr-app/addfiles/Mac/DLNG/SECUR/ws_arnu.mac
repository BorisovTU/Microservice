/*
$Name:             ws_arnu.mac
$Module:           АРНУ 
$Description:      WEB. АРНУ. Макрос настроек подсистемы
*/
/*
  ws_arnu.mac
  WEB. АРНУ. Макрос настроек подсистемы
  Avdahchenko D. V.
  22.10.2013
*/

import BankInter;
import "sp_carin.mac";
import "ws_common.mac";
import "spserv.mac";
import "spRepFun.mac";

class CScModuleSettings()
  var ModeDepositoryForTax:Bool; // БОЦБ в режиме хранилища данных для ведения налогового учета (нет операций)
  var ModeAvrKindIsEnabled:Bool; // Настройка ВОЗМОЖНОСТЬ ВЫБОРА ВИДА ЦБ активна
  var UseInnerCalc:Bool; // Вести внутренний учет
  var ModeOperationStepsIsEnabled:Bool; // Возможность отображать шаги экземпляра операции
  var DateBuildTaxReg;
end;

private const MacroName = "ws_arnu.mac";

// Сервис проверки и открытия нового операционного дня
macro TxSetNewOperDate(
  NewDate : Date // Дата нового операционного дня
) : Bool // Статус выполнения операции
  var opened : Bool = false;
  var stat : Integer = 0;

  InitError();

  if( ( ValType( NewDate ) != V_DATE )
   or ( NewDate == Date( 0, 0, 0 ) ) )
    RunError( "Не задан обязательный параметр функции: NewDate" );
  end;

  opened = IsOperDayOpened( NewDate );
  if( not opened )
    stat = OpenNewOperDay( NewDate, true );
    if( stat == 0 )
      opened = true;
    else
      RunError( GetErrMsg() );
    end;
  end;

  return opened;

OnError( err );
  WSRunError( MacroName, err, stat );
end;

// Получить настройки модуля
macro TxGetModuleSettings():CScModuleSettings
  var stat:Integer = 0;
  var settings = CScModuleSettings();

  InitError();

  settings.ModeDepositoryForTax = CheckTaxDepositoryMode();
  settings.ModeAvrKindIsEnabled = ВОЗМОЖНОСТЬ_ВЫБОРА_ВИДА_ЦБ();
  settings.UseInnerCalc = ВестиВнутреннийУчет();
  settings.ModeOperationStepsIsEnabled = CheckOperationStepsMode();
  settings.DateBuildTaxReg = Date(GetDateBuildTaxReg());

  return settings;

OnError( err );
  WSRunError( MacroName, err, stat );
end;

class CSettingsNU 
  var V1  : Integer;
  var V2  : Integer;
  var V3  : Integer;
  var V4  : Integer;
  var V5  : Integer;
  var V6  : Integer;
  var V9  : Bool;
  var V10 : Bool;
  var V11 : Bool;
  var V12 : Bool;
  var V13 : Bool;
  var V14 : Bool;
  var V15 : Integer;
  var V16 : Bool;
  var V17 : Bool;
  var V18 : Bool;
  var V19 : Integer;
  var V20 : Integer;
  var V21 : Integer;
  var V22 : Integer;
  var V23 : Bool;
  var RepKindAvr : Bool;
end;

macro TxGetSettingsNU
  var stat = -1;
  var Result = CSettingsNU();
  var ErrCode:Integer = 0;
  var tmp = 0;
                                                                       
  InitError();

  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V1",  V_INTEGER, Result.V1,  ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V2",  V_INTEGER, Result.V2,  ErrCode );
  GetRegistryvalue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V20", V_INTEGER, Result.V20, ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V3",  V_INTEGER, Result.V3,  ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V4",  V_INTEGER, Result.V4,  ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V5",  V_INTEGER, Result.V5,  ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V6",  V_INTEGER, Result.V6,  ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V9",  V_INTEGER, tmp, ErrCode );  
  Result.V9 = (tmp == 0);
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V10", V_INTEGER, tmp, ErrCode );
  Result.V10 = (tmp == 0);
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V11", V_INTEGER, tmp, ErrCode );
  Result.V11 = (tmp == 0);
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V12", V_INTEGER, tmp, ErrCode );
  Result.V12 = (tmp == 0);
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V13", V_INTEGER, tmp, ErrCode );
  Result.V13 = (tmp == 0);
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V14", V_INTEGER, tmp, ErrCode );
  Result.V14 = (tmp == 0);

  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V15", V_INTEGER, Result.V15, ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V16", V_BOOL, Result.V16, ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V17", V_BOOL, Result.V17, ErrCode );

  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V18", V_BOOL, Result.V18, ErrCode );
  GetRegistryvalue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, Result.V19, ErrCode );
  GetRegistryvalue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V21", V_INTEGER, Result.V21, ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V22", V_INTEGER, Result.V22, ErrCode );
  GetRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V23", V_BOOL, Result.V23, ErrCode );

  GetRegistryValue( "SECUR\\ОТЧЕТ ПО ВИДУ ЦБ", V_BOOL, Result.RepKindAvr, ErrCode );

  return Result;
end;

macro TxSetSettingsNU(Params):WebServiceResponse
  var stat = 0;
  var res = true;
  var tmp = 0;
  var ErrMsg = "";
  var OldParams = CSettingsNU();
  var ResponseBuilder:WebResponseBuilder = WebResponseBuilder();

  InitError();

  if( ValType( Params ) == V_UNDEF )
     stat = 1;
     RunError("Не задан обязательный параметр функции: Сохранение настроек налогового учета!");
  end;

  OldParams = TxGetSettingsNU;

  if(OldParams.V1 != Params.V1)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V1",  Params.V1 ))
      ErrMsg = "V1 ";
  end;
  end;
  if(OldParams.V2 != Params.V2)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V2",  Params.V2 ))
      ErrMsg = ErrMsg + "V2 ";
  end;
  end;
  if(OldParams.V3 != Params.V3)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V3",  Params.V3 ))
      ErrMsg = ErrMsg + "V3 ";
  end;
  end;
  if(OldParams.V4 != Params.V4)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V4",  Params.V4 ))
      ErrMsg = ErrMsg + "V4 ";
    end;
  end;
  if(OldParams.V5 != Params.V5)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V5",  Params.V5 ))
      ErrMsg = ErrMsg + "V5 ";
    end;
  end;
  if(OldParams.V6 != Params.V6)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V6",  Params.V6 ))
      ErrMsg = ErrMsg + "V6 ";
    end;
  end;
  if(OldParams.V9 != Params.V9)
    tmp = 1; 
    if(Params.V9) 
      tmp = 0; 
    end;
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V9",  tmp ))
      ErrMsg = ErrMsg + "V9 ";
  end;
  end;
  if(OldParams.V10 != Params.V10)
    tmp = 1; 
    if(Params.V10) 
      tmp = 0; 
    end;
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V10", tmp ))
      ErrMsg = ErrMsg + "V10 ";
  end;
  end;
  if(OldParams.V11 != Params.V11)
    tmp = 1; 
    if(Params.V11) 
      tmp = 0; 
    end;
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V11", tmp ))
      ErrMsg = ErrMsg + "V11 ";
  end;
  end;
  if(OldParams.V12 != Params.V12)
    tmp = 1; 
    if(Params.V12) 
      tmp = 0; 
    end;
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V12", tmp ))
      ErrMsg = ErrMsg + "V12 ";
    end;
  end;
  if(OldParams.V13 != Params.V13)
    tmp = 1; 
    if(Params.V13)
      tmp = 0; 
    end;
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V13", tmp ))
      ErrMsg = ErrMsg + "V13 ";
    end;
  end;
  if(OldParams.V14 != Params.V14)
    tmp = 1; 
    if(Params.V14)
      tmp = 0; 
    end;
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V14", tmp ))
      ErrMsg = ErrMsg + "V14 ";
    end;
  end;
  if(OldParams.V15 != Params.V15)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V15", Params.V15 ))
      ErrMsg = ErrMsg + "V15 ";
    end;
  end;
  if(OldParams.V16 != Params.V16)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V16", Params.V16 ))
      ErrMsg = ErrMsg + "V16 ";
    end;
  end;
  if(OldParams.V17 != Params.V17)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V17", Params.V17 ))
      ErrMsg = ErrMsg + "V17 ";
    end;
  end;
  if(OldParams.V18 != Params.V18)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V18", Params.V18 ))
      ErrMsg = ErrMsg + "V18 ";
    end;
  end;
  if(OldParams.V19 != Params.V19)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", Params.V19 ))
      ErrMsg = ErrMsg + "V19 ";
    end;
  end;
  if(OldParams.V20 != Params.V20)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V20", Params.V20 ))
      ErrMsg = ErrMsg + "V20 ";
    end;
  end;
  if(OldParams.V21 != Params.V21)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V21", Params.V21 ))
      ErrMsg = ErrMsg + "V21 ";
    end;
  end;
  if(OldParams.V22 != Params.V22)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V22", Params.V22 ))
      ErrMsg = ErrMsg + "V22 ";
    end;
  end;
  if(OldParams.V23 != Params.V23)
    if(NOT SetDefaultRegistryValue( "SECUR\\НАЛОГОВЫЙ УЧЕТ\\V23", Params.V23 ))
      ErrMsg = ErrMsg + "V23 ";
    end;
  end;
  if(OldParams.RepKindAvr != Params.RepKindAvr)
    if(NOT SetDefaultRegistryValue( "SECUR\\ОТЧЕТ ПО ВИДУ ЦБ",  Params.RepKindAvr ))
      ErrMsg = ErrMsg + "ОТЧЕТ_ПО_ВИДУ_ЦБ ";
    end;
  end;

  if(ErrMsg == "")
     ResponseBuilder.AddErrorEx(stat, MessageSeverity.RuntimeError, "Параметры успешно сохранены!");
  else
     stat = 1;
    ResponseBuilder.AddErrorEx(stat, MessageSeverity.RuntimeError, "Ошибка сохранения! Параметры: " + ErrMsg +".");
  end;

  return ResponseBuilder.Result;

OnError( err )
  WSRunError( "ws_arnu.mac", err, stat );
end;

//var do = TxSetNewOperDate( Date( 13, 9, 2013 ) );
//var set = TxGetModuleSettings();
