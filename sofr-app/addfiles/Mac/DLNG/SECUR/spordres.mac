/*
$Name:        spordres.mac
$Module:      Ценные бумаги
$Description: Печать отчетов сервисных операций (по F7 из скроллингов СО)
*/
import "scservop.mac", "spserv.mac", "reppercm.mac", "spRepFun.mac", "ws_file.mac";
import globals, "dlcalcor_report.mac";//Simanov

private record DlComm( dl_comm );/*документ формирования резерва*/
private record doc( acctrn );
private record ReservAccount( account );
private record InAccount( account );
private file   ObjLink( objlink ) key 1;

private var FD, ObjKind, ObjID, ObjErrTitle, FDoc, FDocFI, СуммаВалютнойПереоценкиВнебаланса = $0;

private macro IsReservAccount( Accounts:TArray, AccDoc:STRING )
   var i = 0;
   while( i < Accounts.Size )
      if( Accounts[i] == AccDoc )
         return true;
      end;
      i = i + 1;
   end;
   return false;
end;

macro GetReservAccByDoc( oproper, doc )
   var CatReserv, FIRoles  = TArray(), Accounts = TArray();

   if( DlComm.OperationKind == KINDRES_DEAL )
      CatReserv = "Резерв, договор";
      FIRoles[0] = FIROLE_RESERV_RSS;
      FIRoles[1] = null;
   elif( DlComm.OperationKind == KINDRES_REQ )
      CatReserv = "Резерв, договор";
      FIRoles[0] = FIROLE_BA;
      FIRoles[1] = FIROLE_BA_RESERV_REQ;
      FIRoles[2] = null;
   elif( DlComm.OperationKind == KINDRES_RCB )
      CatReserv = "Резерв ц/б";
      FIRoles[FIRoles.Size] = FIROLE_BA_PPR;
      FIRoles[FIRoles.Size] = FIROLE_PD_PPR;
      FIRoles[FIRoles.Size] = FIROLE_BA_PPR_BPP;
      FIRoles[FIRoles.Size] = FIROLE_BA_PUDP;
      FIRoles[FIRoles.Size] = FIROLE_PD_PUDP;
      FIRoles[FIRoles.Size] = FIROLE_BAINPROMISSORY;
      FIRoles[FIRoles.Size] = FIROLE_PD_PDO;
      FIRoles[FIRoles.Size] = FIROLE_BAINCONTR;
      FIRoles[FIRoles.Size] = FIROLE_PD_PKU;
      FIRoles[FIRoles.Size] = FIROLE_AVOIR_UC;
      FIRoles[FIRoles.Size] = null;
   else 
      return false;
   end;

   FD.FindNumberAccount( CatReserv, null, true, FIRoles, null, Accounts );

   if( IsReservAccount( Accounts, doc.Account_Payer ) )                                    
      if( not GetAccount( doc.Chapter, doc.FIID_Payer, doc.Account_Payer, ReservAccount, true) )
         return false;
      end;
      return true;
   end;

   if( IsReservAccount( Accounts, doc.Account_Receiver ) )                                    
      if( not GetAccount( doc.Chapter, doc.FIID_Receiver, doc.Account_Receiver, ReservAccount, true) )
         return false;
      end;
      return true;
   end;

   return false;
end;

private macro IsReserv2732(Acc, doc)
  var CatReserv, FIRoles  = TArray(), Accounts = TArray();
  if( DlComm.OperationKind == KINDRES_RCB )
    CatReserv = "Резерв ц/б";
    FIRoles[FIRoles.Size] = FIROLE_AVOIR_UC;
    FIRoles[FIRoles.Size] = null;

    FD.FindNumberAccount( CatReserv, null, true, FIRoles, null, Accounts );
    if( IsReservAccount( Accounts, Acc ) )
      return true;
    end;
  end;

  return false;
end;

private macro IsReservPDD(Acc, doc)
  var CatReserv, FIRoles  = TArray(), Accounts = TArray();
  if( DlComm.OperationKind == KINDRES_RCB )
    CatReserv = "Резерв ц/б";
    FIRoles[FIRoles.Size] = FIROLE_PD_PPR;
    FIRoles[FIRoles.Size] = FIROLE_PD_PUDP;
    FIRoles[FIRoles.Size] = FIROLE_PD_PDO;
    FIRoles[FIRoles.Size] = FIROLE_PD_PKU;

    FIRoles[FIRoles.Size] = null;

    FD.FindNumberAccount( CatReserv, null, true, FIRoles, null, Accounts );
    if( IsReservAccount( Accounts, Acc ) )
      return true;
    end;
  end;

  return false;
end;

private macro IsReservAvoir(Acc, doc)
  var CatReserv, FIRoles  = TArray(), Accounts = TArray();
  if( DlComm.OperationKind == KINDRES_RCB )
    CatReserv = "Резерв ц/б";
    FIRoles[FIRoles.Size] = FIROLE_BA_PPR;
    FIRoles[FIRoles.Size] = FIROLE_BA_PPR_BPP;
    FIRoles[FIRoles.Size] = FIROLE_BA_PUDP;
    FIRoles[FIRoles.Size] = FIROLE_BAINPROMISSORY;
    FIRoles[FIRoles.Size] = FIROLE_BAINCONTR;

    FIRoles[FIRoles.Size] = null;

    FD.FindNumberAccount( CatReserv, null, true, FIRoles, null, Accounts );
    if( IsReservAccount( Accounts, Acc ) )
      return true;
    end;
  end;

  return false;
end;


/*используем как для опции начисления ПДД, так и для операции переоценки*/
private macro ОВП(account)
  var Query = "", DataSet;

  Query = RSDCommand(" Select t_Type_Account From daccount_dbt Where t_account = ? ");

  Query.addParam( "", RSDBP_IN, account );
  Query.execute();

  DataSet = TRsbDataSet (Query);

  if (DataSet.MoveNext())
     if (Index(DataSet.Type_Account, "Щ") > 0)
        return true;
     end;
  end;

  Query = RSDCommand(" Select t_Type_Account From daccount_dbt Where t_account = ? ");

  Query.addParam( "", RSDBP_IN, account );
  Query.execute();

  DataSet = TRsbDataSet (Query);

  if (DataSet.MoveNext())
     if (Index(DataSet.Type_Account, "Щ") > 0)
        return true;
     end;
  end;

  return false;
end;

private macro ОтчетОперацииРезервирования( oproper, oprstep, DlComm )
   var RiskGrp, ResPc, BaseAcc = "", OldReserv= $0, MarketSum, CostRUR = $0, CFI, 
       BaseSum, dR, SinceDate, AttrID, NoteKind, CtKind, ExistsCourse = false, IsBival = false, ResKind = 0,
       Query = "", DataSet, КатегорияСчета = "";

   var DealChange = TRecHandler( "sptkchng" );
   var IsBack;
   var fininstr = TBfile( "fininstr", "R" );
   var Tick = TRecHandler( "dl_tick" );

   if( oproper.DocKind == DL_SECURITYDOC )

     if (DlComm.OperationKind == KINDRES_DEAL)

        if( ПолучитьПервичныйДокументСервОпер( oproper, Tick ) )
           msgbox("Ошибка при определении первичного документа сервисной операции");
           return false;
        end;

        FD = SPFirstDocDealReserv( Tick, DlComm.OperationKind );
     else
        if( oprstep.Kind_Action == 810 ) /*по второй части*/
           IsBack = true;
        else /*по первой части*/
           IsBack = false;
        end;
        FD = SPFirstDocDealReserv( FDoc, DlComm.OperationKind, IsBack );
     end;
   elif( oproper.DocKind == DLDOC_ISSUE )
     FD = SPFirstDocFIReserv( FDoc.rec.FIID, DlComm.OperationKind );

   elif( oproper.DocKind == DLDOC_PARTY )
     FD = SPFirstDocParty( DLDOC_PARTY, FDoc.rec.PartyID, DlComm.OperationKind );

   elif( oproper.DocKind == DL_NTGDOC )
     FD = SPFirstDocNtg( DL_NTGDOC, FDoc.rec.NettingID, DlComm.OperationKind );
   end;

   ClearRecord( doc );
   while( GetDocsByOperStep( doc, oproper.ID_Operation, oprstep.ID_Step ) )

     /*Определим счет резерва в проводке*/
     if( GetReservAccByDoc( oproper, doc ) == true )

       /*Остаток счета до операции*/
       OldReserv = ABS(GetRestAccount( ReservAccount, DlComm.CommDate-1));

       if( DlComm.OperationKind == KINDRES_DEAL ) /*По срочным сделкам*/
          NoteKind = NOTEKIND_SECDEAL_RSKDEAL;
          CtKind   = OBJGROUP_TICKGRPRISK;
       elif( DlComm.OperationKind == KINDRES_REQ ) /*РТ  Резерв по требованиям сделок*/ 
          if( (DlComm.Flag1 == SET_CHAR) AND
              ( IsOUTEXCHANGE( FD.Group ) OR IsBROKER( FD.Group ) ) AND
              (
                 ( (FD.pmwrtsum.rec.Buy_Sale == PM_WRITEOFF_SUM_SALE) AND /*требования - аванс или оплата*/
                   (
                      (DL_GetRQStateOnDate( FD.pm_avance.dlreq.rec.ID, DlComm.CommDate+1 ) == DLRQ_STATE_OVERDUE) OR 
                      (DL_GetRQStateOnDate( FD.pm_money.dlreq.rec.ID, DlComm.CommDate+1 ) == DLRQ_STATE_OVERDUE)
                   )
                 ) OR
                 (
                   (FD.pmwrtsum.rec.Buy_Sale == PM_WRITEOFF_SUM_BUY) AND /*требования - поставка*/
                   (DL_GetRQStateOnDate( FD.pm_avoir.dlreq.rec.ID, DlComm.CommDate+1 ) == DLRQ_STATE_OVERDUE)
                 )
              ) 
            ) /*По просроченным требованиям*/
             NoteKind = NOTEKIND_SECDEAL_RSKPERC;   /*Процент резерва по просроченным требованиям*/
             CtKind   = OBJGROUP_TICKGRPRISKREQ;    /*Группа риска по просроч.треб.*/
          else
             NoteKind = NOTEKIND_SECDEAL_RSKREQ; /*Процент резерва по требованиям*/
             CtKind   = OBJGROUP_TICKQUALITY;    /*Категория качества по требованиям сделки*/
          end;
       else
          NoteKind = NOTEKIND_RSK_PERCENT;
          CtKind   = OBJ_ACCOUNT_GROUP_RISK137;
       end;

       if(IsReserv2732(ReservAccount.Account, doc))
         ResKind = KINDRES_RCBUC;
         RiskGrp = "";
         ResPc = double(50);
       else
         if(IsReservPDD(ReservAccount.Account, doc))
           ResKind = KINDRES_RVPCB;
         elif(IsReservAvoir(ReservAccount.Account, doc))
           ResKind = KINDRES_RCB;
         end;

         /* группа и процент риска */
         if( not GetMainObjAttr( null, ObjKind, UniID(FDoc, ObjKind), CtKind, null, null, RiskGrp, DlComm.CommDate))
             MsgBox(ObjErrTitle +  " не найдена категория \n\""+ ИмяКатегории(ObjKind,CtKind) +"\" на дату " + string(DlComm.CommDate) );
             return false;
         end;
       
         ResPc = double( readNoteForObject( ObjKind, UniID( FDoc, ObjKind), NoteKind, DlComm.CommDate) );
         if( ResPc == 0 )
            Msgbox( ObjErrTitle + " не найдено примечание \n\"" + ИмяПримечания(ObjKind,NoteKind) + "\" на дату " + string(DlComm.CommDate) ); 
            return false;
         end;
       end;

       if( DlComm.OperationKind == KINDRES_DEAL )
          IsBack = FD.IsBack;
          IsBival = false;

          SP_GetDealParmsByDate( FD.tick, DlComm.CommDate, DealChange );

          /*Получим курс "ТСС" в валюте номинала*/
          if( SmartConvertSumDbl( MarketSum, double(DealChange.rec.OldPrincipal), DlComm.CommDate, 
                                  FD.fininstr.rec.FIID, NATCUR, false, 
                                  ПолучитьВидКурса(SP_RATETYPE_RightCost), SinceDate ) == false 
            )
             /*Нет курса бумаги к рублям, но возможно, что есть курс бумаги к валюте номинала*/
             if( SmartConvertSumDbl( MarketSum, double(DealChange.rec.OldPrincipal), DlComm.CommDate, 
                                     FD.fininstr.rec.FIID, FD.fininstr.rec.FaceValueFI, false, 
                                     ПолучитьВидКурса(SP_RATETYPE_RightCost), SinceDate ) == false 
               )
                /*Не нашли рыночный курс в национальной валюте на дату операции*/
                ExistsCourse = false;
             else
                /*курс "ТСС" нужен в нац. валюте */
                if( SmartConvertSumDbl( MarketSum, MarketSum, DlComm.CommDate, 
                                        FD.fininstr.rec.FaceValueFI, NATCUR, true ) == false 
                  )
                   ExistsCourse = false;
                else
                   ExistsCourse = true;
                end;
             end;
          else
             ExistsCourse = true;
          end;

          if(IsBack)
             CostRUR = DealChange.rec.OldCost2;
             CFI     = DealChange.rec.OldCFI2;
          else
             CostRUR = DealChange.rec.OldCost1;
             CFI     = DealChange.rec.OldCFI1;
          end;

          if( SmartConvertSum( CostRUR, CostRUR, DlComm.CommDate, CFI, NATCUR ) != true )
             MsgBox( "Ошибка при конвертации суммы сделки из "+ ПолучитьКодФинИн(CFI)+" в " + ПолучитьКодФинИн(NATCUR)); 
             return false;
          end;    

          if( 
              (ExistsCourse     == true      ) and 
              (DlComm.CommDate  == SinceDate ) and 
              (money(MarketSum) != $0        )
            )
             MarketSum = money(MarketSum);

          elif( 
                (ExistsCourse     == true      ) and 
                (DlComm.CommDate  != SinceDate ) and 
                (money(MarketSum) != $0        )
              )
             MsgBox( "Отсутствует курс вида \"ТСС\" для выпуска|\""+ПолучитьКодФинИн(FD.fininstr.rec.FIID)+"\" за дату операции." );
             return false;
          elif( 
                (ExistsCourse     == false     ) or 
                (money(MarketSum) == $0        )
              )
             fininstr.Clear();
             fininstr.rec.FIID = FD.dl_leg.rec.PFI;
             if(fininstr.GetEQ())
                if(
                    (fininstr.rec.FaceValueFI == NATCUR) OR
                    (CFI                      == NATCUR) OR 
                    (fininstr.rec.FaceValueFI == CFI)
                  )
                   MarketSum = CostRUR;
                else

                   IsBival = true;
                   MarketSum = GetFaceValue( FD.fininstr.rec.FIID, DlComm.CommDate );

                   if( SmartConvertSumDbl( MarketSum, double(MarketSum*DealChange.rec.OldPrincipal), DlComm.CommDate, FD.fininstr.rec.FaceValueFI, NATCUR ) != true )
                      MsgBox( "Ошибка при конвертации номинала ц/б из "+ ПолучитьКодФинИн(FD.fininstr.rec.FaceValueFI)+" в " + ПолучитьКодФинИн(NATCUR)); 
                      return false;
                   end;    

                   MarketSum = money(MarketSum);

                end;
             end;
          else 
             return true; /*резерв не нужен*/
          end;
       end; 

       AttrID = UniID( ReservAccount, OBJTYPE_ACCOUNT);

       Query = RSDCommand(  " Select t_ObjectID "
                          + "   From dobjlink_dbt "
                          + "  Where t_ObjectType = " + OBJTYPE_ACCOUNT
                          + "    and t_GroupID = " + OBJROLE_ACC_RESERV137
                          + "    and t_AttrType = " + OBJTYPE_ACCOUNT
                          + "    and t_AttrID = ? "
                          + "    and t_ValidToDate >= ? " 
                         );

       Query.addParam( "", RSDBP_IN, AttrID );
       Query.addParam( "", RSDBP_IN, DlComm.CommDate );
       Query.execute();

       DataSet = TRsbDataSet(Query);

       if(DataSet.MoveNext())
          if( RestoreFromUniID(DataSet.ObjectID, InAccount, OBJTYPE_ACCOUNT) == true )
             BaseAcc = InAccount.Account;
          end;
       end;

       if( doc.Account_Payer == ReservAccount.Account )
          dR = -doc.Sum_Payer;
       else
          dR = doc.Sum_Payer;
       end;

       if(IsReserv2732(ReservAccount.Account, doc))
         BaseSum = money( readNoteForObject( OBJTYPE_AVOIRISS, UniID( FD.fininstr, OBJTYPE_AVOIRISS), NOTEKIND_AVOIR_RESERV2732, DlComm.CommDate ) );
       else
         BaseSum = money(ABS(dR+OldReserv)/ResPc*100.);
       end;

       ScOpReportLineData[ScOpReportLineData.Size] = 
           SvOpReserve( ObjID, RiskGrp, ResPc, 
                        BaseSum, OldReserv, 
                        BaseAcc, ReservAccount.Account,
                        (oproper.DocKind == DL_NTGDOC), 
                        CostRUR, MarketSum, IsBival, $0, ResKind, abs(dR));
     end;
   end;
   return true;
end;

/* Сохраняем информацию о переоценке в массиве.
      Kind        -  вид проводки
      ID          -  ID объекта (бумаги или сделки)
      Code        -  Код объекта (бумаги или сделки)
      Amount      -  к-во ц/б
      Price       -  рыночная цена
      PriceCcy    -  валюта цены, в которой установлена ТСС
      BalCost     -  балансовая стоимость указанного к-ва ц/б на начало даты переоценки
      NewBalCost  -  новая балансовая стоимость
      DtAcc       -  Счет Дт проводки
      KtAcc       -  Счет Кт проводки
      Sum         -  Сумма проводки
      SumCcy      -  валюта номинала бумаги 
      Ground      -  Основание проводки
*/
private macro SaveOvervalueInfo( Kind, ID, Code, Amount, Price, PriceCcy, 
                                 BalCost, NewBalCost, 
                                 DtAcc, KtAcc, Sum, SumCcy, Ground )

   ScOpReportLineData[ScOpReportLineData.Size] =
      SvOpOvervalue( Kind, ID, Code, Amount, Price, PriceCcy,
                     BalCost, NewBalCost,
                     DtAcc, KtAcc, Sum, SumCcy, Ground );
end;

/* Сохраняем информацию об операции начисления дохода/расхода в массиве.

      Kind        -  вид. "По какой галочке операции" эта проводка.
      ID          -  ID бумаги или сделки, в зависимости от Kind
      Code        -  код бумаги или сделки, в зависимости от Kind
      Amount      -  к-во ц/б (или ставка РЕПО)
      Point       -  точность поля Amount
      OldIncome   -  старый доход
      NewIncome   -  новый доход
      Sum         -  Сумма проводки
      SumCCY      -  Валюта проводки
      DtAcc       -  Счет Дт проводки
      KtAcc       -  Счет Кт проводки
      Ground      -  Основание проводки */
private macro SaveIncomeInfo( Kind, ID, Code, Amount, Point,
                              OldIncome, NewIncome, Sum, SumCCY, DtAcc, KtAcc, Ground )

   ScOpReportLineData[ScOpReportLineData.Size] =
      SvOpIncome( Kind, ID, Code, Amount, Point, 
                     OldIncome, NewIncome, Sum, SumCCY, DtAcc, KtAcc, Ground );
end;

/* Сохраняем информацию об операции переоценки внебаланса в массиве.
      Deal        -  Код сделки
      FIID        -  ID бумаги
      Kind        -  Вид Т/О
      Summ_RD     -  Старая сумма Т/О
      Curr        -  Валюта
      Num         -  К-во ц/б
      Price       -  Цена
      DtAcc       -  Счет Дт проводки
      KtAcc       -  Счет Кт проводки
      Summa       -  Сумма проводки
*/
private macro SaveOvervalueRDInfo( Deal, FIID, Kind, Summ_RD, Summ_RD_NEW, Curr,
                                   Num, Price, DtAcc, KtAcc, Summa, SumNKD )

   ScOpReportLineData[ScOpReportLineData.Size] =
      SvOpOvervalue_RD( Deal, FIID, Kind, Summ_RD, Summ_RD_NEW, Curr,
                        Num, Price, DtAcc, KtAcc, Summa, SumNKD );
end;

/* Сохранение информации о проводке операции переоценки в массив.
      Carry             -  документ проводки
      FD                -  FD операции
      DlComm            -  сервисная операция
      CallFromOperStep  -  флаг, вызов печати из шага операции */
macro ОтчетОперацииПереоценкиПоПроводке( Carry, FD, DlComm, ID_Operation, ID_Step )

   record wrtsum(pmwrtsum);
   var OverAmount1, OverAmount2;

   macro GetMcaccdoc(Account, _CatID, _TemplNum, _Code)
      var cmd, RSD, CatID = -1, TemplNum = -1, Code = "";

      cmd = RSDCommand("Select accdoc.t_CatID CatID, accdoc.t_TemplNum TemplNum, categ.t_Code Code " +
                       "From dmcaccdoc_dbt accdoc, dmccateg_dbt categ Where " +
                                " accdoc.t_Account  = ? AND " +
                                " accdoc.t_DepartmentID = ? AND " + 
                                " accdoc.t_CatID    = categ.t_ID ");

      cmd.addParam("", RSDBP_IN, Account);
      cmd.addParam("", RSDBP_IN, DlComm.Division);
      cmd.execute();

      RSD = TRsbDataSet(cmd);

      if( RSD.MoveNext() )
         CatID = RSD.CatID;
         TemplNum = RSD.TemplNum;
         Code = RSD.Code;
      end;

      SetParm (1, CatID);
      SetParm (2, TemplNum);
      SetParm (3, Code);
   end;

   macro GetDealByMcaccdoc(Account)
      var cmd, RSD, DealID = -1;

      cmd = RSDCommand("Select distinct leg.t_DealID " +
                       "From dmcaccdoc_dbt accdoc, ddl_leg_dbt leg Where " +
                                " accdoc.t_Account  = ? AND " +
                                " accdoc.t_DepartmentID = ? AND " +
                                " accdoc.t_DocKind = 176 AND " + /*на момент написания, этот код только для РЕПО (две части)*/
                                " accdoc.t_DocID = leg.t_ID "
                      );

      cmd.addParam("", RSDBP_IN, Account);
      cmd.addParam("", RSDBP_IN, DlComm.Division);
      cmd.execute();

      RSD = TRsbDataSet(cmd);

      if( RSD.MoveNext() )
         DealID = RSD.DealID;
      end;

      return DealID;
   end;

   private macro ПолучитьКурсФИ( FD, Type, _Date, CursDate, err )
      var RateDef = TRecHandler("ratedef");
      var CourceDbl1 = 0.0;
      var CourceDbl2 = 0.0;
      var CourceDbl = 0.0;
      var sql, rsd;
      var CursDate1 = date(0,0,0);
      var CursDate2 = date(0,0,0);
   
      ClearRecord(RateDef.rec);
  
      SetParm(3, date(0,0,0));
      SetParm(4, true);  
   
      sql = RSDCommand(" SELECT * "
                     + "   FROM dratedef_dbt "
                     + "  WHERE t_OtherFI = ? "
                     + "    AND t_Type = ? "
                     + "  ORDER BY t_IsDominant DESC "); /* первым будет основной */
   
      sql.addParam( "", RSDBP_IN, FD.fininstr.rec.FIID );
      sql.addParam( "", RSDBP_IN, Type );
      sql.execute();
   
      rsd = TRsbDataSet(sql);
      if( rsd.MoveNext() )
        RateDef = rsd.GetRecord();
   
        if( (ConvSumDbl(CourceDbl1, 1.0, _Date, FD.fininstr.rec.FIID, RateDef.FIID, false, Type, CursDate1) == true) and
            (ConvSumCrossDbl(CourceDbl2, 1.0, _Date, RateDef.FIID, FD.fininstr.rec.FaceValueFI, false, 0, CursDate2) == true) )
          CourceDbl = CourceDbl1 * CourceDbl2;
          SetParm(3, CursDate1);
          SetParm(4, false);
        end;
      end;
  
      return CourceDbl;
   end;

   macro ПолучитьКурсПереоценки(FD, CourseKind, _Course)
      var Dbl_Course = 0.0, SinceDate, erFlag, Course = $0;

      /*Определим курс вида "Текущая справедливая стоимость".*/
      Dbl_Course = GetRateOnDate( DlComm.CommDate, FD.fininstr.rec.FIID, FD.fininstr.rec.FaceValueFI, false, ПолучитьВидКурса(CourseKind), erFlag, SinceDate );
      if( erFlag == true )
        Dbl_Course = ПолучитьКурсФИ( FD, ПолучитьВидКурса(CourseKind), DlComm.CommDate, SinceDate, erFlag );
      end;

      Course = ToMoney(Dbl_Course);

      SetParm(2, Course);
   end;

   /* Получаем значение настройки "Способ переоценки по текущей справедливой стоимости". 
   Если произошла ошибка, то вовзращаем 0. */
   macro GetOption_OvervalueKindTSS( )
      var
         ErrCode, OptionValue;

      GetRegistryValue( "SECUR\\СПОСОБ ПЕРЕОЦЕНКИ ПО ТСС", V_INTEGER,
                     OptionValue, ErrCode );

      if (ErrCode != 0)
         return SC_OVERVALUE_COURCE_TSS_MODE_GLOBAL;
      else
         return OptionValue;
      end;
   end;


   var CatID_Pay, TemplNum_Pay, Code_Pay, CatID_Rec, TemplNum_Rec, Code_Rec, 
       Account = "", DealID = -1, FD_Deal, select, RSD, instance, 
       Kind = -1, ID = -1, Code = "", Amount = 0, Price = 0.0, PriceCcy = "",
       OldCost = $0, NewCost = $0, SumCcy = "", Ground = "", 
       Course = 0.0, KindPort = -1, wrtcalc = TRecHandler( "pmwrtsum.dbt" ), wrtcalc2 = TRecHandler( "pmwrtsum.dbt" );

   if (DlComm.OperSubKind == SC_OVERVALUE_WRTOFF)
      Kind = OVERVALUE_WRTOFF;

      Ground = "Списание результатов переоценки на доходы или расходы";

      ID = FD.fininstr.rec.FIID;
      Code = GetFICode( ID );

      wrtcalc.Clear();
      if( WRT_Calc( DlComm.Division, FD.fininstr.rec.FIID, -1, 0, KINDPORT_SALE, DlComm.CommDate, wrtcalc, true, true ) == true )
         Amount = wrtcalc.rec.Amount;
      end;
   else
      /*Определим, что за переоценка "подкинула" нам проводку и куда ее выводить.
        Если хоть один из счетов проводки - по "Ц/б, ПВО", то это переоценка ПВО. По счету получаем сделку.
        Если "-Маржа, ц/б" или "+Маржа, ц/б", то это переоценка Т/О. По счету получаем сделку.
        Иначе - переоценка ц/б в ТП или ППР. По счету определяем портфель. И т.д. 
                Может быть от 1 до 3 проводок. Пока все обрабатываем одинаково.
      */
      GetMcaccdoc(Carry.Account_Payer,    CatID_Pay, TemplNum_Pay, Code_Pay);
      GetMcaccdoc(Carry.Account_Receiver, CatID_Rec, TemplNum_Rec, Code_Rec);

      /*Определим курс вида "Текущая справедливая стоимость".*/
      ПолучитьКурсПереоценки(FD, SP_RATETYPE_RightCost, Course);

      if( (Code_Pay == "Ц/б, ПВО") or (Code_Pay == "Ц/б, Корзина ПВО") or (Code_Rec == "Ц/б, ПВО") or (Code_Rec == "Ц/б, Корзина ПВО") )
         Kind = OVERVALUE_VO;

         Ground = "Переоценка ц/б, полученных по операциям на возвратной основе";

         if( (Code_Pay == "Ц/б, ПВО") or (Code_Pay == "Ц/б, Корзина ПВО") )
            Account = Carry.Account_Payer;
         elif( (Code_Rec == "Ц/б, ПВО") or (Code_Rec == "Ц/б, Корзина ПВО") )
            Account = Carry.Account_Receiver;
         end;

         /*Получим ID сделки через mcaccdoc. "Ц/б, ПВО" - по сделке.*/
         DealID = GetDealByMcaccdoc(Account);
         ID = DealID;

         if (DealID > 0)
            FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK, DealID );
            Code = FD_Deal.tick.rec.DealCode;

            if ( (FD_Deal.pmwrtsum.rec.ID_Operation == ID_Operation) and (FD_Deal.pmwrtsum.rec.ID_Step == ID_Step) )

                instance = FD_Deal.pmwrtsum.rec.Instance;
            else 
                select = RSDCommand( "SELECT b.t_instance as instance" +
                                          " FROM dpmwrtbc_dbt b " +
                                          " WHERE b.t_sumid = ? " +
                                          "   and b.t_ID_Operation = ?" +                                                 
                                          "   and b.t_ID_Step = ?" );

                select.addParam("", RSDBP_IN, FD_Deal.pmwrtsum.rec.SumID);
                select.addParam("", RSDBP_IN, ID_Operation);
                select.addParam("", RSDBP_IN, ID_Step);
                select.execute();

                RSD = TRsbDataSet(select);

                if ( RSD.MoveNext() )
                  instance = RSD.rec.instance;
                end;
            end;
           
            select = RSDCommand( "SELECT b.t_BalanceCost as BalanceCost," +
                                 "       b.t_Amount as Amount " +
                                     " FROM dpmwrtbc_dbt b " +
                                     " WHERE b.t_sumid = ? " +
                                     "   AND b.t_instance =" +
                                     "       (SELECT MAX (c.t_instance) "+
                                     "         FROM dpmwrtbc_dbt c "+
                                     "        WHERE c.t_sumid = b.t_sumid "+
                                     "          AND c.t_instance < ? ) " );

            select.addParam("", RSDBP_IN, FD_Deal.pmwrtsum.rec.SumID);
            select.addParam("", RSDBP_IN, instance);
            select.execute();

            RSD = TRsbDataSet(select);

            if ( RSD.MoveNext() )
              OldCost = RSD.rec.BalanceCost;
              Amount = RSD.rec.Amount;
            end;

            /*Вычисляется новая бал. стоимость */
            NewCost = ROUND(Amount * Course,2);

         end;

      elif( (Code_Pay == "-Маржа, ц/б") or (Code_Rec == "-Маржа, ц/б") or
            (Code_Pay == "+Маржа, ц/б") or (Code_Rec == "+Маржа, ц/б")
           )
         Kind = OVERVALUE_TO;

         Ground = "Переоценка требований/обязательств по возврату ц/б";

         /*Счета +-Маржа - не по сделкам, нужно брать другой счет из проводки.*/
         if( (Code_Pay == "-Маржа, ц/б") or (Code_Pay == "+Маржа, ц/б") )
            Account = Carry.Account_Receiver;
         elif( (Code_Rec == "-Маржа, ц/б") or (Code_Rec == "+Маржа, ц/б") )
            Account = Carry.Account_Payer;
         end;

         /*Получим ID сделки через mcaccdoc. Account - по сделке.*/
         DealID = GetDealByMcaccdoc(Account);
         ID = DealID;

         if (DealID > 0)
            FD_Deal = SPFirstDoc( LEG_KIND_DL_TICK_BACK, DealID );
            Code = FD_Deal.tick.rec.DealCode;

            /* Определяем курс ТССобяз вида из настройки "ТСС для переоценки обязательств". #122741 */ 
            if ( (GetOption_OvervalueKindTSS( ) == SC_OVERVALUE_COURCE_TSS_MODE_LOCAL) and  IsBuy(FD_Deal.Group) )
               ПолучитьКурсПереоценки(FD, RATETYPE_OVERVAL_RIGTH_COST, Course);
            end;     

            /*Получим лот на начало след. дня. Это то же, что на конец дня, когда была переоценка. 
              Переоценка - в конце дня, и достваемые поля она не изменяет.
            */
            if ( (FD_Deal.pmwrtsum.rec.ID_Operation == ID_Operation) and (FD_Deal.pmwrtsum.rec.ID_Step == ID_Step) )

                instance = FD_Deal.pmwrtsum.rec.Instance;
            else 
                select = RSDCommand( "SELECT b.t_instance as instance" +
                                          " FROM dpmwrtbc_dbt b " +
                                          " WHERE b.t_sumid = ? " +
                                          "   and b.t_ID_Operation = ?" +                                                 
                                          "   and b.t_ID_Step = ?" );

                select.addParam("", RSDBP_IN, FD_Deal.pmwrtsum.rec.SumID);
                select.addParam("", RSDBP_IN, ID_Operation);
                select.addParam("", RSDBP_IN, ID_Step);
                select.execute();

                RSD = TRsbDataSet(select);

                if ( RSD.MoveNext() )
                  instance = RSD.rec.instance;
                end;
            end;
           
            select = RSDCommand( "SELECT b.t_BalanceCostBD as BalanceCostBD," +
                                 "       b.t_AmountBD as AmountBD " +
                                     " FROM dpmwrtbc_dbt b " +
                                     " WHERE b.t_sumid = ? " +
                                     "   AND b.t_instance =" +
                                     "       (SELECT MAX (c.t_instance) "+
                                     "         FROM dpmwrtbc_dbt c "+
                                     "        WHERE c.t_sumid = b.t_sumid "+
                                     "          AND c.t_instance < ? ) " );

            select.addParam("", RSDBP_IN, FD_Deal.pmwrtsum.rec.SumID);
            select.addParam("", RSDBP_IN, instance);
            select.execute();

            RSD = TRsbDataSet(select);

            if ( RSD.MoveNext() )
              OldCost = RSD.rec.BalanceCostBD;
              Amount = RSD.rec.AmountBD;
            end;

              /*Вычисляется новая бал. стоимость */
            NewCost = ROUND(Amount * Course,2);
         end;

      else
         Kind = OVERVALUE_PAPERS;

         if ((Code_Pay == "-МаржаП, ц/б") or (Code_Rec == "-МаржаП, ц/б") or
             (Code_Pay == "+МаржаП, ц/б") or (Code_Rec == "+МаржаП, ц/б")
            )
            KindPort = KINDPORT_TRADE;
            Ground = "Переоценка ц/б в торговом портфеле";

         elif ((Code_Pay == "-ПО ДК") or (Code_Rec == "-ПО ДК") or
               (Code_Pay == "+ПО ДК") or (Code_Rec == "+ПО ДК")
              )
            KindPort = KINDPORT_SALE;
            Ground = "Переоценка ц/б в портфеле для продажи";
         end;

         ID = FD.fininstr.rec.FIID;
         Code = GetFICode( ID );

         wrtcalc.Clear();
         if( WRT_Calc( DlComm.Division, FD.fininstr.rec.FIID, -1, 0, KindPort, DlComm.CommDate, wrtcalc, true, true ) == true )
            
            wrtcalc2.Clear();
            if( WRT_Calc( DlComm.Division, FD.fininstr.rec.FIID, -1, 0, KindPort, DlComm.CommDate-1, wrtcalc2, true, true ) == true )
               /*Сумма б/с до операции*/

               SmartConvertSum(
                  OverAmount1, 
                  wrtcalc.rec.OverAmount, 
                  Date(DlComm.CommDate), 
                  NATCUR,
                  FD.fininstr.rec.FaceValueFI, 
                  true
               );

               SmartConvertSum( 
                  OverAmount2, 
                  wrtcalc2.rec.OverAmount, 
                  Date(DlComm.CommDate-1), 
                  NATCUR,
                  FD.fininstr.rec.FaceValueFI, 
                  true
               );

               OldCost = wrtcalc.rec.BalanceCost - OverAmount1 + OverAmount2;             
               
            end;

            /*Вычисляется новая бал. стоимость */
            NewCost = ROUND(wrtcalc.rec.Amount * Course,2);
            Amount = wrtcalc.rec.Amount;
         end;
      end;

      PriceCcy = GetFinInstrCcy( FD.fininstr.rec.FaceValueFI, true );
      SumCcy   = PriceCcy;
   end;

   /* Цена */
   Price = Course;

   /* Сохраняем информацию о переоценке в массиве, чтобы потом напечатать
      по ней отчет. */
   SaveOvervalueInfo(   Kind, ID, Code, Amount, Price, PriceCcy,
                        OldCost, NewCost, 
                        Carry.Account_Payer, Carry.Account_Receiver, Carry.sum_NatCur, SumCcy, Ground );
end;

/* Сохранение информации о проводке операции начисления дохода/расхода в массив.
      Carry             -  документ проводки
      FD                -  FD операции
      DlComm            -  сервисная операция
      oprstep           -  шаг */
macro ОтчетОперацииНачисленияДоходаПоПроводке( Carry, FD, DlComm, Kind, oprstep )

   record mccateg( mccateg );
   record mccateg2( mccateg );

   macro НайтиЗначениеПараметраДляДанногоКлассификатора( mccateg, mctempl, ClassID )
      if (mccateg.Class1 == ClassID)
         return mctempl.Value1;
      elif (mccateg.Class2 == ClassID)
         return mctempl.Value2;
      elif (mccateg.Class3 == ClassID)
         return mctempl.Value3;
      elif (mccateg.Class4 == ClassID)
         return mctempl.Value4;
      elif (mccateg.Class5 == ClassID)
         return mctempl.Value5;
      elif (mccateg.Class6 == ClassID)
         return mctempl.Value6;
      elif (mccateg.Class7 == ClassID)
         return mctempl.Value7;
      elif (mccateg.Class8 == ClassID)
         return mctempl.Value8;
      end;

      return -1;
   end;

   macro GetAction(Kind)
      if (Kind == INCOME_OWN_PAPERSPD)
         return PM_WRTSUM_UPDTMODE_INCPD;

      elif (Kind == INCOME_OWN_PAPERSDD)
         return PM_WRTSUM_UPDTMODE_INCDD;

      else
         return PM_WRTSUM_UPDTMODE_INCPDD;
      end;
   end;

   var ID = 0, Code = "", Amount = $0, Point = 0, OldIncome = $0, NewIncome = $0, DocKind, DocID, Query, DataSet;
   var TypePort = -1, TypeIsBpp = -1, TypeIncome = -1, cmd, WithoutAccept = -1, Delivered = -1;
   var BalanceCost = $0, DefDiff = $0, CorrIntToEIR = $0,
       InterestIncome = $0, DiscountIncome = $0, Bonus = $0,
       OldInterestIncome = $0, OldDiscountIncome = $0, OldBonus = $0, CCY = "";
   var mctempl = TBfile("mctempl", "R", 0);
   var FindComm = TRecHandler( "dlsum" );
   var rsd, DS;

   if ((Kind == INCOME_OWN_PAPERS) or (Kind == INCOME_OWN_PAPERSPD) or (Kind == INCOME_OWN_PAPERSDD))
      ID = FD.fininstr.rec.FIID;
      Code = GetFICode( ID );
      Amount = $0;
      Point = 0;
      CCY = GetFinInstrCcy( FD.fininstr.rec.FaceValueFI, true );

      /*Дебет в проводке - портфельный счет "Начисл.ПДД, ц/б". 
        Получим по нему параметры, для которых выполнилась эта проводка.
        Это нужно например для получения суммы ранее начисленного ДД или ПД.

        Если дебет - не этот счет, то искомые поля заполняем нулями.
      */
      if( MC_FindMCCATEG( "Начисл.ПДД, ц/б", mccateg ) == true )

         Query = RSDCommand("Select * From dmcaccdoc_dbt Where " +
                          " t_Chapter  = 1 AND " +
                          " t_Account  = ? AND " +
                          " t_Currency = ? AND " +
                          " t_DepartmentID = ? AND " +
                          " t_CatID   = ? ");

         Query.addParam( "", RSDBP_IN, Carry.Account_Payer );
         Query.addParam( "", RSDBP_IN, FD.fininstr.rec.FaceValueFI );
         Query.addParam( "", RSDBP_IN, DlComm.Division );
         Query.addParam( "", RSDBP_IN, mccateg.ID );
         Query.execute();

         DataSet = TRsbDataSet (Query);
         if (DataSet.MoveNext())

            mctempl.Clear();
            mctempl.rec.CatID = mccateg.ID;
            mctempl.rec.Number = DataSet.TemplNum;
            if (mctempl.GetEQ())
               TypePort   = НайтиЗначениеПараметраДляДанногоКлассификатора( mccateg, mctempl.rec, LLCLASS_KINDPORT );
               TypeIsBpp  = НайтиЗначениеПараметраДляДанногоКлассификатора( mccateg, mctempl.rec, LLCLASS_IS_AVOIR_BPP );
               TypeIncome = НайтиЗначениеПараметраДляДанногоКлассификатора( mccateg, mctempl.rec, LLCLASS_KIND_ACC_PDD );
               /*процентный - 1*/
               /*дисконтный - 2*/

               if (TypeIsBpp == 1) /*БПП*/
                  WithoutAccept = 1;
                  Delivered     = 0;
               else
                  WithoutAccept = 0;
                  Delivered     = 1;
               end;

               cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTGetServiceFinResult(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);\n end; ");

               cmd.addParam("p_ID_Operation",  RSDBP_IN,     oprstep.ID_Operation  );
               cmd.addParam("p_ID_Step",       RSDBP_IN,     oprstep.ID_Step );
               cmd.addParam("p_Action",        RSDBP_IN,     GetAction(Kind) );
               cmd.addParam("p_Party",         RSDBP_IN,     -1            );
               cmd.addParam("p_Contract",      RSDBP_IN,     0             );
               cmd.addParam("p_FIID",          RSDBP_IN,     ALLFININSTR   );
               cmd.addParam("p_Portfolio",     RSDBP_IN,     TypePort      );
               cmd.addParam("p_Delivered",     RSDBP_IN,     Delivered     );
               cmd.addParam("p_WithoutAccept", RSDBP_IN,     WithoutAccept );
               cmd.addParam("p_BalanceCost",            RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_InterestIncome",         RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_DiscountIncome",         RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_Bonus",                  RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_DefDiff",                RSDBP_OUT, V_DOUBLE );
               cmd.addParam("p_CorrIntToEIR",           RSDBP_OUT, V_DOUBLE );
               cmd.addParam("p_OldInterestIncome",      RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_OldDiscountIncome",      RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_OldBonus",               RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_Amount",                 RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_BonusAmount",            RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_DiscountAmount",         RSDBP_OUT,    V_DOUBLE   );
               cmd.addParam("p_InterestAmount",         RSDBP_OUT,    V_DOUBLE   );
               cmd.execute();

               BalanceCost            = cmd.value( 9);
               InterestIncome       = cmd.value(10);
               DiscountIncome       = cmd.value(11);
               Bonus                = cmd.value(12);
               DefDiff              = cmd.value(13);
               CorrIntToEIR         = cmd.value(14);
               OldInterestIncome    = cmd.value(15);
               OldDiscountIncome    = cmd.value(16);
               OldBonus             = cmd.value(17);
               Amount               = cmd.value(18);

               if (TypeIncome == 1) /*процентный - 1*/
                  OldIncome = OldInterestIncome;

                  if( (MC_FindMCCATEG( "Наш портфель ц/б", mccateg2 ) == true) or 
                      (MC_FindMCCATEG( "Премия, ц/б", mccateg2 ) == true)
                    )

                     Query = RSDCommand("Select * From dmcaccdoc_dbt Where " +
                                      " t_Chapter  = 1 AND " +
                                      " t_Account  = ? AND " +
                                      " t_Currency = ? AND " +
                                      " t_DepartmentID = ? AND " +
                                      " t_CatID   = ? ");

                     Query.addParam( "", RSDBP_IN, Carry.Account_Receiver );
                     Query.addParam( "", RSDBP_IN, FD.fininstr.rec.FaceValueFI );
                     Query.addParam( "", RSDBP_IN, DlComm.Division );
                     Query.addParam( "", RSDBP_IN, mccateg2.ID );
                     Query.execute();

                     DataSet = TRsbDataSet (Query);
                     if (DataSet.MoveNext())
                        OldIncome = OldBonus;
                     end;
                  end;

                  if( MC_FindMCCATEG( "Ц/б, БПП", mccateg2 ) == true )

                     Query = RSDCommand("Select distinct leg.t_DealID From dmcaccdoc_dbt accdoc, ddl_leg_dbt leg Where " +
                                      " accdoc.t_Chapter  = 1 AND " +
                                      " accdoc.t_Account  = ? AND " +
                                      " accdoc.t_Currency = ? AND " +
                                      " accdoc.t_DepartmentID = ? AND " +
                                      " accdoc.t_CatID   = ?  AND " +
                                      " accdoc.t_DocKind = 176 AND " + /*на момент написания, этот код только для РЕПО (две части)*/
                                      " accdoc.t_DocID = leg.t_ID "
                                       );

                     Query.addParam( "", RSDBP_IN, Carry.Account_Receiver );
                     Query.addParam( "", RSDBP_IN, FD.fininstr.rec.FaceValueFI );
                     Query.addParam( "", RSDBP_IN, DlComm.Division );
                     Query.addParam( "", RSDBP_IN, mccateg2.ID );
                     Query.execute();

                     DataSet = TRsbDataSet (Query);
                     if (DataSet.MoveNext())
                        rsd = RSDCommand( 
                                          "  SELECT NVL(SUM(ROUND(B.T_AMOUNT,2)), 0) Amount,             " + 
                                          "  NVL(SUM(ROUND(B.T_BONUS,2)), 0) OldBonus                    " +
                                          "    FROM V_SCWRTHIST A, DPMWRTBC_DBT B, DPMWRTSUM_DBT S, DPMWRTSUM_DBT Sd  " +
                                          "   WHERE A.T_ID_OPERATION = ?                            " +
                                          "     AND A.T_ID_STEP      = ?                            " +
                                          "     AND A.T_ACTION       = ?                            " +
                                          "     AND A.t_Portfolio    = ?                            " +
                                          "     AND B.T_SUMID        = A.T_SUMID                    " +
                                          "     AND B.T_INSTANCE     = A.T_INSTANCE - 1             " +
                                          "     AND A.T_SUMID        = S.T_SUMID                    " +
                                          "     AND S.T_PARENT       = Sd.T_SUMID                   " +
                                          "     AND A.T_STATE        = 3                            " +
                                          "     AND Sd.t_DealID      = ? "
                                         );

                        rsd.addParam( "", RSDBP_IN, oprstep.ID_Operation );
                        rsd.addParam( "", RSDBP_IN, oprstep.ID_Step      );
                        rsd.addParam( "", RSDBP_IN, GetAction(Kind)      );
                        rsd.addParam( "", RSDBP_IN, TypePort             );
                        rsd.addParam( "", RSDBP_IN, DataSet.DealID       );
                        rsd.execute();
                        DS = TRsbDataSet(rsd);
                        while( DS.movenext() )
                           Amount    = SQL_ConvTypeSum(DS.Amount);
                           OldIncome = SQL_ConvTypeSum(DS.OldBonus);
                        end;
                     end;
                  end;
               else
                  OldIncome = OldDiscountIncome;
               end;

               NewIncome = OldIncome + Carry.Sum_Payer;
            end;
         end;
      end;
   elif (Kind == INCOME_BACK_KA)
      ID = FD.tick.rec.DealID;
      Code = FD.tick.rec.DealCode;
      Amount = FD.dl_leg.rec.Principal;
      Point = 0;
      CCY = GetFinInstrCcy( FD.fininstr.rec.FaceValueFI, true );

      if( FindDLSUM( DL_SECURITYDOC, FD.tick.rec.DealID, 
                     IIF(Index( Carry.Ground, "купон" ) == 0, /*слова "купон" в основании нет*/
                         DLSUM_KIND_SUM_PARTIAL_INCOME_BACK, 
                         DLSUM_KIND_SUM_COUPON_INCOME_BACK
                        ),
                     DlComm.EndDate, FindComm ) == 0 ) 
         NewIncome = FindComm.rec.Sum;
         OldIncome = NewIncome - Carry.Sum_Payer;
      end;

   elif (Kind == INCOME_REPO)

      /*Ставку РЕПО берем из 2-й части.*/
      if (not FD.IsBack)
         FD = SPFirstDoc( LEG_KIND_DL_TICK_BACK, FD.tick.rec.DealID );
      end;

      ID = FD.tick.rec.DealID;
      Code = FD.tick.rec.DealCode;
      Amount = FD.dl_leg.rec.IncomeRate;
      Point = FD.dl_leg.rec.Point;
      CCY = GetFinInstrCcy( FD.GetPayFIID(), true );

      if( FindDLSUM( DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT, DlComm.EndDate, FindComm ) == 0 ) 
         NewIncome = FindComm.rec.Sum;
         OldIncome = NewIncome - Carry.Sum_Payer;
      end;
   end;

   /* Сохраняем информацию о переоценке в массиве, чтобы потом напечатать
      по ней отчет. Для проводок по переносу остатков со счетов переоценки
      на счета доходов/расходов сохраняем и печатаем только информацию о
      выпуске, счета, сумму и основание. */

   SaveIncomeInfo( Kind, ID, Code, Amount, Point, 
                   OldIncome, NewIncome, Carry.Sum_Payer, CCY, 
                   Carry.Account_Payer, Carry.Account_Receiver, Carry.Ground);
end;

/* Сохранение информации о проводке операции переоценки внебаланса в массив.
      Carry             -  документ проводки
      FD                -  FD операции
      DlComm            -  сервисная операция
      NDocs             -  число проводок
      DocNum            -  порядковый номер проводки по этому шагу. */
macro ОтчетОперацииПереоценкиВнебалансаПоПроводке( Carry, FD, DlComm, NDocs, DocNum )
   record forw(account);
   record forw_t(account); /*счет переоценки по обязательствам*/
   record forw_o(account); /*счет переоценки по требованиям*/
   record forw_r(account); /*счет переоценки с которого берем старый остаток при валютной переоценки*/
   var CatForvard = "";


   macro ПлатежБылОтложен( rq )  
     return ( (rq.rec.PaymStatus == PM_PROLONGATED) OR (rq.rec.PaymStatus == PM_REMOVE_PROLONGATED) );
   end;

   macro ПроверитьОтложенностьТребованияОбязательства( FD, IsReq )

      if( IsReq )
         if( FD.BuySale == DEAL_TYPE_BUY )/*покупка*/
            if( ПлатежБылОтложен(FD.pm_avoir) )
               return true;
            end;
         elif( FD.BuySale == DEAL_TYPE_SALE ) /*продажа*/
            if( ПлатежБылОтложен(FD.pm_money) )
               return true;
            end;         
         end;      
      else
         if( FD.BuySale == DEAL_TYPE_BUY )/*покупка*/
            if( ПлатежБылОтложен(FD.pm_money) )
               return true;
            end;         
         elif( FD.BuySale == DEAL_TYPE_SALE ) /*продажа*/
            if( ПлатежБылОтложен(FD.pm_avoir) )
               return true;
            end;
         end;      
      end;
      return false;  
   end;

   /*процедура для определения и актуализации переоцениваемого счета*/
   macro ОпределитьПереоцениваемыйСчет( FD, dat, Kind, typedeal ) 

      var FIRole;
	  CatForvard = "";
      /*переоценка требований*/
      if( Kind == "Т" )
         FIRole = FIROLE_FIREQ;
         if( ПроверитьОтложенностьТребованияОбязательства( FD, true ) )
            CatForvard = "+Форвард, ОИ";
         else 
            /*покупка СделкаПрочая*/ 
            if( typedeal == СделкаПрочая )
               CatForvard = "+Форвард, прочие";
            /*покупка СделкаНеРанееТретьегоДня*/ 
            elif( (typedeal == СделкаНеРанееТретьегоДня) OR (FD.IsBack == true)  )
               CatForvard = "+Форвард, дрейф";
            end;  
         end;

      /*переоценка обязательств*/
      elif( Kind == "О" )
         FIRole = FIROLE_FICOM;
         if( ПроверитьОтложенностьТребованияОбязательства( FD, false ) )
            CatForvard = "-Форвард, ОИ";
         else 
            /*продажа СделкаПрочая*/ 
            if( typedeal == СделкаПрочая )
               CatForvard = "-Форвард, прочие";
            /*продажа СделкаНеРанееТретьегоДня*/ 
            elif( (typedeal == СделкаНеРанееТретьегоДня) OR (FD.IsBack == true)  )
               CatForvard = "-Форвард, дрейф";
            end;  
         end;
      end;

      if (FD.IsExistAccount( CatForvard, null, true, FIRole, forw, NULL, DlComm.CommDate ))

         if( Kind == "Т" )
            copy( forw_t, forw ); 
         end;

         if( Kind == "О" )
            copy( forw_o, forw ); 
         end;
      end;
   end;


   var Query, DataSet, Kind = "", OldSum = $0, NewSum = $0, CurrOverval = false, Curr = "", OutRest = $0, Price = $0, err, PosDiffer, typedeal;
   var DlMarket = TBFile( "dlmarket.dbt", "R", 0 ), MarketID = null, CentrOffice = null;
   var ExistsCourse = false, SinceDate, SumNKD = $0;

   /* Сохраняем информацию о переоценке внебаланса в массиве, чтобы потом напечатать по ней отчет. 

   Алгоритм. Максимально 3 проводки на шаге. 
             Притом по флагу Flag2 их может быть либо 0 либо 2, 
             они находятся до проводок по Flag1.
   */
   typedeal  = FD.ВидСрочностиСделки();

   if (((DocNum == 1) OR 
        (DocNum == 2)
       ) AND (NDocs >= 2)
      )
      if( (DlComm.Flag2 == SET_CHAR) AND 
          (FD.dl_leg.rec.CFI != NATCUR) AND (FD.GetParametr(MC_TYPE_PARAMETR_PAYCURRENCY) == NATCUR) AND (FD.fininstr.rec.FaceValueFI == NATCUR)
      )        
         if (DocNum == 1)
            Kind = "Т";
         elif (DocNum == 2)
            Kind = "О";
         end;
         CurrOverval = true;
      end;

      ОпределитьПереоцениваемыйСчет( FD, DlComm.CommDate, "Т", typedeal );
      ОпределитьПереоцениваемыйСчет( FD, DlComm.CommDate, "О", typedeal );

      /*определим с какого счета берем старый остаток*/
      if( FD.BuySale == DEAL_TYPE_BUY ) 
         copy( forw_r, forw_o ); /*в покупках со счета обязательств*/
      else
         copy( forw_r, forw_t ); /*в продажах со счета требований*/
      end;  

   else
      /*Если попали сюда, то только по Flag1*/
      /*переоценка требований*/
      if( FD.BuySale == DEAL_TYPE_BUY )
         Kind = "Т";

      /*переоценка обязательств*/
      elif( FD.BuySale == DEAL_TYPE_SALE )
         Kind = "О";
      end;

      ОпределитьПереоцениваемыйСчет( FD, DlComm.CommDate, Kind, FD.ВидСрочностиСделки() );
      copy( forw_r, forw );

      if( (FD.BuySale == DEAL_TYPE_BUY) OR (FD.BuySale == DEAL_TYPE_SALE) )
        if( FD.tick.rec.MarketID > 0 )
           MarketID = FD.tick.rec.MarketID;

           if( FD.tick.rec.MarketSchemeID > 0 )
              DlMarket.Clear();                                     
              DlMarket.rec.ID = FD.tick.rec.MarketSchemeID;                     
              if( DlMarket.GetEQ() )                            
                 CentrOffice = DlMarket.rec.CentrOffice;
              end;                                                  
           end;
        end;

        /*Сумма НКД в валюте счета Форвард*/
        SmartConvertSumDbl(
                     SumNKD, MoneyToDouble(FD.dl_leg.rec.NKD),
                     FD.tick.rec.DealDate, FD.FaceFIID,
                     forw.Code_Currency, false,
                     ПолучитьВидКурса(SP_RATETYPE_MarketPrice), SinceDate, MarketID, CentrOffice);
       
        SumNKD = DoubleToMoney( SumNKD );
     end;
   end;

   if (forw_r.Account != "")
      if ((CatForvard == "+Форвард, прочие") OR (CatForvard == "-Форвард, прочие"))
        OldSum = FD.dl_leg.rec.TotalCost;
        if(DlComm.Flag2 == SET_CHAR)
          OldSum = OldSum + GetSumTrnOverFromDocs(FD.tick.rec.DealID, FD.tick.rec.BOfficeKind, DlComm.CommDate, false);
        end;
        if(DlComm.Flag1 == SET_CHAR)
          OldSum = OldSum + GetSumTrnOverFromDocs(FD.tick.rec.DealID, FD.tick.rec.BOfficeKind, DlComm.CommDate, true);
        end;
      else
        OldSum = ABS(ОстатокСчетаДоПроводки(forw_r, DlComm.CommDate, OutRest, Carry));
      end;
   end;

   /*Определим, положительна или отрицательна была разница при выполнении этой операции*/
   if( Kind == "Т" )
      if (forw.Account == Carry.Account_Payer)
         PosDiffer = true;
      elif (forw.Account == Carry.Account_Receiver)
         PosDiffer = false;
      end;
   elif( Kind == "О" ) 
      if (forw.Account == Carry.Account_Payer)
         PosDiffer = false;
      elif (forw.Account == Carry.Account_Receiver)
         PosDiffer = true;
      end;
   end;

   if(CurrOverval)
      if (PosDiffer)
         СуммаВалютнойПереоценкиВнебаланса = Carry.Sum_Payer;
      else
         СуммаВалютнойПереоценкиВнебаланса = -Carry.Sum_Payer;
      end;

      err = ConvSum(Price, $10000000000, DlComm.CommDate, FD.dl_leg.rec.CFI, NATCUR, 0);
      Price = Double(Price)/10000000000.0;
   else
      /*Если была валютная переоценка, то сделаем по аналогии с 
        "+ D делаем, чтобы учесть валютную переоценку" на шаге переоценки*/
      if (NDocs > 1)
         OldSum = OldSum + СуммаВалютнойПереоценкиВнебаланса;
      end;

      if (PosDiffer)
         Price = Money( (OldSum + Carry.Sum_Payer) / FD.dl_leg.rec.Principal );
      else
         Price = Money( (OldSum - Carry.Sum_Payer) / FD.dl_leg.rec.Principal );
      end;
   end;

   NewSum = ABS(ОстатокСчетаДоПроводки(forw_r, DlComm.CommDate, OutRest, Carry, true));

   SaveOvervalueRDInfo( FD.tick.rec.DealCode, FD.fininstr.rec.FIID, Kind, OldSum, NewSum, GetFICode(forw_r.Code_Currency, null, FICK_ISOSTRING),
                        FD.dl_leg.rec.Principal, Price, Carry.Account_Payer, Carry.Account_Receiver, Carry.Sum_Payer, SumNKD );
end;

/* Сохранение информации о операции переоценки в массиве. */
private macro ОтчетОперацииПереоценки( oproper, oprstep, DlComm )

   FD = SPFirstDocFIOvervalue( FDoc.rec.FIID, FDoc.rec.FIID );

   /* Перебираем проводки по операции переоценки. */
   ClearRecord( doc );
   while( GetDocsByOperStep( doc, oproper.ID_Operation, oprstep.ID_Step ) )
      if( (not ОВП (doc.Account_Payer)) AND (not ОВП (doc.Account_Receiver)) )
         ОтчетОперацииПереоценкиПоПроводке( doc, FD, DlComm, oproper.ID_Operation, oprstep.ID_Step );
      end;
   end;
   return true;
end;

/* Сохранение информации о операции начисления дохода/расхода в массиве. */
private macro ОтчетОперацииНачисленияДохода( oproper, oprstep, DlComm )
   var Kind = 0, ID_Step = 0, Query = "", DataSet;

   if ((oprstep.Symbol == "Н") or (oprstep.Symbol == "П") or (oprstep.Symbol == "Д"))

      if (oprstep.Symbol == "П")
         Kind = INCOME_OWN_PAPERSPD;

      elif (oprstep.Symbol == "Д")
         Kind = INCOME_OWN_PAPERSDD;

      else
         Kind = INCOME_OWN_PAPERS;
      end;

      FD = SPFirstDocFI( DLDOC_ISSUE, FDoc.rec.FIID, FDoc.rec.FIID, null, {OurBank}, null, null, null );

      /*Но тут 2 шага, и проводки привязаны к 2-му.*/
      Query = RSDCommand(" Select t_ID_Step From doprstep_dbt Where t_ID_Operation = ? "+ 
                                                   " and t_Previous_Step = ? ");

      Query.addParam( "", RSDBP_IN, oprstep.ID_Operation );
      Query.addParam( "", RSDBP_IN, oprstep.ID_Step );
      Query.execute();

      DataSet = TRsbDataSet (Query);

      if (DataSet.MoveNext())
         ID_Step = DataSet.ID_Step;
      end;

   elif (oprstep.Symbol == "К")
      Kind = INCOME_BACK_KA;
      FD = SPFirstDoc( LEG_KIND_DL_TICK, FDoc.rec.DealID );
      ID_Step = oprstep.ID_Step;

   elif (oprstep.Symbol == "Р")
      Kind = INCOME_REPO;
      FD = SPFirstDoc( LEG_KIND_DL_TICK, FDoc.rec.DealID );
      ID_Step = oprstep.ID_Step;
   end;

   if (Kind > 0)
      /* Перебираем проводки по операции начисления дохода/расхода. */
      ClearRecord( doc );

      while( GetDocsByOperStep( doc, oproper.ID_Operation, ID_Step ) )
         ОтчетОперацииНачисленияДоходаПоПроводке( doc, FD, DlComm, Kind, oprstep );
      end;
   end;
   return true;
end;

/* Сохранение информации о операции переоценки внебаланса в массиве. */
private macro ОтчетОперацииПереоценкиВнебаланса( oproper, oprstep, DlComm )
   var NDocs = 0, DocNum = 0;

   FD = SPFirstDoc( LEG_KIND_DL_TICK, FDoc.rec.DealID );

   /* Посчитаем число проводок по шагу. */
   ClearRecord( doc );

   while( GetDocsByOperStep( doc, oproper.ID_Operation, oprstep.ID_Step ) )
      NDocs = NDocs + 1;
   end;

   /* Перебираем проводки по шагу. */
   ClearRecord( doc );

   while( GetDocsByOperStep( doc, oproper.ID_Operation, oprstep.ID_Step ) )
      DocNum = DocNum + 1;
      ОтчетОперацииПереоценкиВнебалансаПоПроводке( doc, FD, DlComm, NDocs, DocNum );
   end;
   return true;
end;

/* если возвращает 0  - все нормально
                   -1 - ошибка
                   1  - ошибка при которой отчет не печатается
*/
macro ОтчетПоШагу( oproper, oprstep, DlComm )
  
  if( not (((DlComm.DocKind == DL_RESERVEDOC) and 
            (DlComm.OperationKind == KINDRES_DEAL)
           ) or 
           (DlComm.DocKind == DL_GET_INCOME) or 
           (DlComm.DocKind == DL_OVERVALUE)
          ) 
    )
     ScOpReportLineData.Size = 0;
  end;

  if( oproper.DocKind == DL_SECURITYDOC )
     FDoc = TRecHandler( "dl_tick" ); 
     ObjKind   = OBJTYPE_SECDEAL;
     if( ПолучитьПервичныйДокументСервОпер( oproper, FDoc ) )
        msgbox("Ошибка при определении первичного документа сервисной операции");
        return -1;
     end;
     ObjErrTitle = "Для сделки " + FDoc.rec.DealCode;
     ObjID       = FDoc.rec.DealID; 
  elif( oproper.DocKind == DLDOC_ISSUE )
     FDoc   = TRecHandler( "avoiriss" ); 
     FDocFI = TRecHandler( "fininstr" ); 
     ObjKind   = OBJTYPE_AVOIRISS;
     if( ПолучитьПервичныйДокументСервОпер( oproper, FDoc, FDocFI ) )
        msgbox("Ошибка при определении первичного документа сервисной операции");
        return -1;
     end;
     ObjErrTitle = "Для ц/б " + FDocFI.rec.FI_Code;
     ObjID       = FDoc.rec.FIID; 

  elif( oproper.DocKind == DLDOC_PARTY )
     FDoc = TRecHandler( "party" );
     ObjKind   = OBJTYPE_PARTY;
     if( ПолучитьПервичныйДокументСервОпер( oproper, FDoc ) )
        msgbox("Ошибка при определении первичного документа сервисной операции");
        return -1;
     end;                                  
     ObjErrTitle = "Для субъекта " + FDoc.rec.ShortName;
     ObjID       = FDoc.rec.PartyID; 

  elif( oproper.DocKind == DL_NTGDOC )
     FDoc = TRecHandler( "dl_nett" );
     ObjKind   = OBJTYPE_NETTING;
     if( ПолучитьПервичныйДокументСервОпер( oproper, FDoc ) )
        msgbox("Ошибка при определении первичного документа сервисной операции");
        return -1;
     end;                                              
     ObjErrTitle = "Для операции неттинга " + FDoc.rec.DealNumber;
     ObjID       = FDoc.rec.NettingID; 
  end;

  if( DlComm.DocKind == DL_RESERVEDOC )
     if( not ОтчетОперацииРезервирования( oproper, oprstep, DlComm ) )
        return -1;
     end;

  elif( DlComm.DocKind == DL_OVERVALUE )

     if( not ОтчетОперацииПереоценки( oproper, oprstep, DlComm ) )
        return -1;
     end;

  elif( DlComm.DocKind == DL_GET_INCOME )

     if( not ОтчетОперацииНачисленияДохода( oproper, oprstep, DlComm ) )
        return -1;
     end;

  elif( DlComm.DocKind == DL_OVERVALUE_RD )

     if( not ОтчетОперацииПереоценкиВнебаланса( oproper, oprstep, DlComm ) )
        return -1;
     end;

  else
     msgbox( "Отчет по данной сервисной операции не реализован !");
     return 1;
/*     exit(1);*/
  end;

  if( not (((DlComm.DocKind == DL_RESERVEDOC) and 
            (DlComm.OperationKind == KINDRES_DEAL)
           ) or 
           (DlComm.DocKind == DL_GET_INCOME) or
           (DlComm.DocKind == DL_OVERVALUE)
          ) 
    )
     ScOpPrintReportLine( oproper.DocKind, DlComm, FDoc );
  end;

  return 0;
end;

private macro SvOpReservLineRSS( Data:SvOpReserve, IsBival )
  var Reserv, ReservChange, StrLine = "", DealCode, Contractor;
  record LnFI(fininstr);
  file   LnDeal(dl_tick);
  record LnDl_leg(dl_leg);

  Reserv       = money(ABS(Data.BaseSum)*double(Data.ResPc)/100.);
  ReservChange = ABS(Reserv-Data.OldReserv);

  ClearRecord( LnDeal );
  LnDeal.DealID = Data.ObjID;
  GetEQ( LnDeal );
  FindDL_LEG( LEG_KIND_DL_TICK, LnDeal.DealID, 0, LnDl_leg );
  ПолучитьФинИн( LnDl_leg.PFI, LnFI );
  
  if (Data.IsBival == false)
     StrLine = 
"├──────────────────────────────┼───────────────┼────────────────────┼────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
              "│" + String(LnDeal.DealCode:30) + "│" + 
              String(LnFI.FI_Code:15)        + "│" +
              String(Data.MarketSum:20)        + "│" +
              String(Data.CostRUR:20)        + "│" +
              String(Data.ReservAcc:26)      + "│" +
              String(Data.RiskGrp:8)         + "│" +
              String(Data.ResPc:9)           + "│" +
              String(Data.BaseSum:20)        + "│" +
              String(Reserv:20)              + "│" +
              String(Data.OldReserv:20)      + "│" +
              String(ReservChange:20)        + "│" ;
  else
     StrLine = 
"├──────────────────────────────┼────────────────────┼────────────────────┼──────────────────────────┼────────┼─────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
              "│" + String(LnDeal.DealCode:30) + "│" + 
              String(Data.MarketSum:20)        + "│" +
              String(Data.CostRUR:20)        + "│" +
              String(Data.ReservAcc:26)      + "│" +
              String(Data.RiskGrp:8)         + "│" +
              String(Data.ResPc:9)           + "│" +
              String(Data.BaseSum:20)        + "│" +
              String(Reserv:20)              + "│" +
              String(Data.OldReserv:20)      + "│" +
              String(ReservChange:20)        + "│" ;
  end;

  SvOpPrintLine( StrLine );
end;

private macro SvOpIncomeLine( Data:SvOpIncome, NextLine, _NeedPrintNextLine )
  var StrLine = "", NeedPrintNextLine = true, DtAcc = "", KtAcc = "";

  /*Запрос 125660. Смысл NextLine такой. В операции начисления ПДД могут быть мультивалютные проводки. 
    Предполагаем, что валютная проводка по счету покрытия всегда раньше соотв. рублевой проводки.
    В ней в одном из счетов Type_Account содержит Щ. Если так, то подменяем в отчете счет ОВП на соотв. счет 
    из NextLine. Притом строку NextLine не печатаем, взведя NeedPrintNextLine = false.
  */

  if ((NextLine != null) and ОВП(Data.DtAcc))
     DtAcc = NextLine.DtAcc;
     NeedPrintNextLine = false;
  else
     DtAcc = Data.DtAcc;
  end;

  if ((NextLine != null) and ОВП(Data.KtAcc))
     KtAcc = NextLine.KtAcc;
     NeedPrintNextLine = false;
  else
     KtAcc = Data.KtAcc;
  end;

  StrLine = 
"├───────────────┼──────────────┼──────────────────┼──────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(ЧислоCЗаданнойТочностью(Data.Amount, Data.Point, ""):r:14)
                     +  "│" + String(Data.OldIncome:18)
                     +  "│" + String(Data.NewIncome:18)
                     +  "│" + String(Data.Sum:r:17) + " " + string(Data.SumCcy:3)
                     +  "│" + String(DtAcc:20)
                     +  "│" + String(KtAcc:20)
                     +  "│" + String(Data.Ground:60) + "│";

  SvOpPrintLine( StrLine );

  SetParm(2, NeedPrintNextLine);
end;

private macro SvOpACCEXPREVOEBLine(Data:SvOp_ACCEXPREVOEB)
  var StrLine = "";
  var CCY = "RUR";

  if((Data.SumCCY != NULL) and (Data.SumCCY != ""))
    CCY = Data.SumCCY;
  end;

  StrLine = "├───────────────┼──────────────┼─────────────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(NumPrec(Data.Amount, SetPrecisionByFractPart(Data.Amount, 6, 0) ):r:14)
                     +  "│" + String(Data.PrevSum:r:17) + " " + string(CCY:3)
                     +  "│" + String(Data.CurrSum:r:17) + " " + string(CCY:3)
                     +  "│" + String(Data.Sum:r:17) + " " + string(CCY:3)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:68) + "│";

  SvOpPrintLine(StrLine);
end;

private macro SvOpTPALine(Data:SvOp_TPA)
  var StrLine = "";
  var sumLine = trim(Data.Sum);
  
  if(StrIsNumber(substr(sumLine, StrLen(sumLine)-1))) //для прежних версий, где код валюты не хранился в сумме
    sumLine = String(money(sumLine):r:17) + " " + string("RUR":3);
  end;

  StrLine = "├───────────────┼──────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(NumPrec(Data.Amount, SetPrecisionByFractPart(Data.Amount, 6, 0) ):r:14)
                     +  "│" + String(Data.Type:r:21)
                     +  "│" + String(sumLine:r:21)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:68) + "│";

  SvOpPrintLine(StrLine);
end;

private macro SvOpCPALine(Data:SvOp_CPA)
  var StrLine = "";
  StrLine = "├─────────────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.PaymSum:r:21)
                     +  "│" + String(Data.Comiss:r:21)
                     +  "│" + String(Data.NDS:r:21)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:68) + "│";

  SvOpPrintLine(StrLine);
end;

private macro SvOpAJOEBLine( Data:SvOp_AJOEB )
  var StrLine = "";
  StrLine = "├───────────────┼──────────────┼─────────────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(NumPrec(Data.AmountSum, SetPrecisionByFractPart(Data.AmountSum, 6, 0) ):r:14)
                     +  "│" + String(Data.CurrCorrValueSum:r:17) + " " + string("RUR":3)
                     +  "│" + String(Data.PrevCorrValueSum:r:17) + " " + string("RUR":3)
                     +  "│" + String(Data.Sum:r:17) + " " + string("RUR":3)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:68) + "│";

  SvOpPrintLine(StrLine);
end;

private macro SvOpOvervalueLine( Data:SvOpOvervalue )
  var StrLine = "";

  if( (Data.Kind == OVERVALUE_WRTOFF) or (Data.Kind == OVERVALUE_RESTORE) )
     StrLine = 
"├───────────────┼──────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(NumPrec(Data.Num, SetPrecisionByFractPart(Data.Num, 6, 0) ):r:14)
                     +  "│" + String(Data.Sum:r:17) + " " + string("RUR":3)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:68) + "│";
  elif( Data.Kind == OVERVALUE_PFI )
     StrLine = 
"├───────────────┼──────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(NumPrec(Data.Num, SetPrecisionByFractPart(Data.Num, 6, 0) ):r:14)
                     +  "│" + String(Data.Price:r:21)
                     +  "│" + String(Data.Sum:r:21)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:68) + "│";
  else
     StrLine = 
"├───────────────┼──────────────┼─────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(NumPrec(Data.Num, SetPrecisionByFractPart(Data.Num, 6, 0) ):r:14)
                     +  "│" + String(NumPrec(Data.Price, 4):r:17) + " " + string(Data.PriceCcy:3)
                     +  "│" + String(Data.NewBalCost:r:17) + " " + string(Data.SumCcy:3)
                     +  "│" + String(Data.BalCost:r:17) + " " + string(Data.PriceCcy:3)
                     +  "│" + String(Data.Sum:r:17) + " " + string("RUR":3)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:60) + "│";
  end;

  SvOpPrintLine( StrLine );
end;

private macro SvOpAMORTHEDGCORRLine(Data:SvOp_AMORTHEDGCORR)
  var StrLine = "";
  var CCY = "RUR";

  if((Data.SumCCY != NULL) and (Data.SumCCY != ""))
    CCY = Data.SumCCY;
  end;

  StrLine = "├───────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────────────────────────────────────────────────────────────────────────────────┤\n" +
                        "│" + String(Data.Code:15)
                     +  "│" + String(Data.Sum:r:17) + " " + string(CCY:3)
                     +  "│" + String(Data.DtAcc:20)
                     +  "│" + String(Data.KtAcc:20)
                     +  "│" + String(Data.Ground:96) + "│";

  SvOpPrintLine(StrLine);
end;

private macro SvOpPrintHeadRSS( DlComm, IsBival, IsFirst )

  var Head = "\n\n";
  if (IsFirst == true)
     Head = Head +
"Вид резерва    : Резервы по срочным сделкам\n" + 
"Номер операции : " + DlComm.CommCode + "      Дата расчета: " + DlComm.CommDate + "\n";
  end;

  if( IsBival == false )
     Head = Head +
"Резервы по сделкам с ценными бумагами, имеющими рыночную стоимость\n" + 
"┌──────────────────────────────┬───────────────┬────────────────────┬────────────────────┬──────────────────────────┬────────┬─────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│      Номер сделки            │   Выпуск ц/б  │      Рыночная      │    Контрактная     │        Счет резерва      │  Кат.  │ Процент │ Расчетная база, " + {CCYNatCur} + "│   Расчетная сумма  │   Ранее созданный  │Сумма корректировки,│\n" +
"│                              │               │      стоимость     │     стоимость      │                          │качества│ резерва │                    │     резерва, " + string({CCYNatCur}:5) + " │     резерв, " + string({CCYNatCur}:5) + "  │          " + string({CCYNatCur}:5) + "     │";                 

  elif( IsBival == true )
     Head = Head +
"Резервы по бивалютным сделкам\n" + 
"┌──────────────────────────────┬────────────────────┬────────────────────┬──────────────────────────┬────────┬─────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┐\n" +
"│      Номер сделки            │ Сумма обязательств │  Сумма требований  │        Счет резерва      │  Кат.  │ Процент │ Расчетная база, " + {CCYNatCur} + "│   Расчетная сумма  │   Ранее созданный  │Сумма корректировки,│\n" +
"│                              │                    │                    │                          │качества│ резерва │                    │     резерва, " + string({CCYNatCur}:5) + " │     резерв, " + string({CCYNatCur}:5) + "  │          " + string({CCYNatCur}:5) + "     │";                 
  else
     msgbox("Данный режим печати протокола операции резервирования по срочным сделкам не поддерживается");
  end;          

  SvOpPrintLine( Head );

end;

private macro SvOpPrintHeadIncome( DlComm, Kind, IsFirst )

  var Head = "\n\n";

  if ((Kind == INCOME_OWN_PAPERS) or (Kind == INCOME_OWN_PAPERSPD) or (Kind == INCOME_OWN_PAPERSDD))
     if (Kind == INCOME_OWN_PAPERSPD)
     Head = Head +
   "                          НАЧИСЛЕНИЕ ПРОЦЕНТНОГО ДОХОДА ПО ВЛОЖЕНИЯМ В ЦЕННЫЕ БУМАГИ \n";

     elif (Kind == INCOME_OWN_PAPERSDD)
     Head = Head +
   "                          НАЧИСЛЕНИЕ ДИСКОНТНОГО ДОХОДА ПО ВЛОЖЕНИЯМ В ЦЕННЫЕ БУМАГИ \n";

     else
     Head = Head +
   "                          НАЧИСЛЕНИЕ ДОХОДА/РАСХОДА ПО ВЛОЖЕНИЯМ В ЦЕННЫЕ БУМАГИ \n";
     end;

     Head = Head +
   "                                                   Дата начисления: " + DlComm.EndDate + "\n" + 
   "┌───────────────┬──────────────┬──────────────────┬──────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │  Кол-во ц/б  │ Ранее начисленный│Сумма накопленного│        Сумма        │       Счет Дт      │       Счет Кт      │                         Основание                          │\n" +
   "│               │              │       доход      │ дохода (расхода) │     доначисления    │                    │                    │                                                            │";

  elif (Kind == INCOME_BACK_KA)
     Head = Head +
   "                                   НАЧИСЛЕНИЕ ДОХОДА, ПОДЛЕЖАЩЕГО ВОЗВРАТУ КОНТРАГЕНТУ \n" +
   "                                                   Дата начисления: " + DlComm.EndDate + "\n" + 
   "┌───────────────┬──────────────┬──────────────────┬──────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────┐\n" +
   "│    Сделка     │  Кол-во ц/б  │ Ранее начисленный│Сумма накопленного│        Сумма        │       Счет Дт      │       Счет Кт      │                         Основание                          │\n" +
   "│               │              │       доход      │ дохода (расхода) │     доначисления    │                    │                    │                                                            │";

  elif (Kind == INCOME_REPO)
     Head = Head +
   "                                      НАЧИСЛЕНИЕ ДОХОДА (РАСХОДА) ПО СДЕЛКАМ РЕПО \n" +
   "                                                   Дата начисления: " + DlComm.EndDate + "\n" + 
   "┌───────────────┬──────────────┬──────────────────┬──────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────┐\n" +
   "│    Сделка     │ Ставка РЕПО  │ Ранее начисленный│Сумма накопленного│        Сумма        │       Счет Дт      │       Счет Кт      │                         Основание                          │\n" +
   "│               │              │       доход      │ дохода (расхода) │     доначисления    │                    │                    │                                                            │";

  elif(Kind == INCOME_NULLFIWARNTS)
    Head = Head + "                          Список выпусков с нулевыми купонами/ЧП \n" +
                  "┌────────────────────┬─────────────────────────────────┬────────────────────┬────────────────┐\n"+
                  "│       Код ц/б      │        Наименование ц/б         │Есть нулевые купоны?│Есть нулевые ЧП?│";

  end;

  SvOpPrintLine( Head );

end;       

private macro SvOpPrintHeadACCEXPREVOEB( DlComm, Kind )

  var Head = "\n\n" +
   "                          НАЧИСЛЕНИЕ РАСХОДОВ ПО ПКД, ДИСКОНТУ, ОТСРОЧЕННОЙ РАЗНИЦЕ, ЗАТРАТАМ ПО ДОГОВОРУ И ПО СПИСАНИЮ ПРЕМИИ НА ДОХОДЫ ПО ВЫПУЩЕННЫМ БАНКОМ ОБЛИГАЦИЯМ \n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │  Кол-во ц/б  │        Ранее        │        Сумма        │        Сумма        │       Счет Дт      │       Счет Кт      │                         Основание                                  │\n" +
   "│               │              │     начисленные     │     накопленного    │       проводки      │                    │                    │                                                                    │\n" +
   "│               │              │       расходы       │       расхода       │                     │                    │                    │                                                                    │";

  SvOpPrintLine( Head );

end;

private macro SvOpPrintHeadTPA( DlComm, Kind )

  var Head = "\n\n" +
   "                          ПЕРЕЧИСЛЕНИЕ ДЕНЕЖНЫХ СРЕДСТВ ПЛАТЕЖНОМУ АГЕНТУ  ПО СОБСТВЕННЫМ ОБЛИГАЦИЯМ  \n" +
   "                          Платежный агент: " + GetPartyShortNameByID(DlComm.PartyID) + "\n" +
   "                          Дата перечисления: " + DlComm.CommDate + "\n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │  Кол-во ц/б  │     Тип выплаты     │        Сумма        │       Счет Дт      │       Счет Кт      │                         Основание                                  │\n" +
   "│               │              │                     │     перечисления    │                    │                    │                                                                    │\n" +
   "│               │              │                     │                     │                    │                    │                                                                    │";

  SvOpPrintLine( Head );

end;

private macro SvOpPrintHeadCPA(DlComm, Kind)

  var Head = "\n\n" +
   "                          ОПЛАТА КОМИССИИ ПЛАТЕЖНОМУ АГЕНТУ  \n" +
   "                          Платежный агент: " + GetPartyShortNameByID(DlComm.PartyID) + "\n" +
   "                          Дата оплаты комиссии: " + DlComm.CommDate + "\n" +
   "┌─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│     Сумма выплат    │    Сумма комиссии   │      В т.ч. НДС     │       Счет Дт      │       Счет Кт      │                         Основание                                  │\n" +
   "│      владельцам     │                     │                     │                    │                    │                                                                    │\n" +
   "│                     │                     │                     │                    │                    │                                                                    │";

  SvOpPrintLine( Head );

end;

private macro SvOpPrintHeadAJVOEB( DlComm, Kind )

  var Head = "\n\n" +
   "                          СПИСАНИЕ РЕЗУЛЬТАТОВ ПЕРЕОЦЕНКИ ЦЕННЫХ БУМАГ\n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │  Кол-во ц/б  │   Текущее значение  │ Предыдущее значение │       Сумма         │       Счет Дт      │       Счет Кт      │                         Основание                                  │\n" +
   "│               │              │  корректировки в %  │  корректировки в %  │   корректировки     │                    │                    │                                                                    │\n" +
   "│               │              │     до ЭПС (ПРк)    │     до ЭПС (ПРк)    │                     │                    │                    │                                                                    │";

  SvOpPrintLine( Head );

end;                                                                                                                                                                                      

private macro SvOpPrintHeadOvervalue( DlComm, Kind )

  var Head = "\n\n";

  if (Kind == OVERVALUE_WRTOFF )
     Head = Head +
   "                          СПИСАНИЕ РЕЗУЛЬТАТОВ ПЕРЕОЦЕНКИ ЦЕННЫХ БУМАГ\n" +
   "┌───────────────┬──────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │    Кол-во    │  Сумма списываемой  │       Счет Дт      │       Счет Кт      │                         Основание                                  │\n" +
   "│               │              │      переоценки     │                    │                    │                                                                    │";

  elif (Kind == OVERVALUE_RESTORE )
     Head = Head +
   "                          ВОССТАНОВЛЕНИЕ УБЫТКА ОТ ОБЕСЦЕНЕНИЯ ЦЕННЫХ БУМАГ\n" +
   "┌───────────────┬──────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │    Кол-во    │ Сумма восстановления│       Счет Дт      │       Счет Кт      │                                Основание                           │";

  elif (Kind == OVERVALUE_PAPERS)
     Head = Head +
   "                                          ПЕРЕОЦЕНКА ВЛОЖЕНИЙ В ЦЕННЫЕ БУМАГИ\n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │    Кол-во    │          ТСС        │   Стоимость по ТСС  │      Балансовая     │  Сумма переоценки   │       Счет Дт      │       Счет Кт      │                         Основание                          │\n" +
   "│               │              │                     │                     │       стоимость     │                     │                    │                    │                                                            │";

  elif (Kind == OVERVALUE_VO)
     Head = Head +
   "                                   ПЕРЕОЦЕНКА ЦЕННЫХ БУМАГ, ПОЛУЧЕННЫХ НА ВОЗВРАТНОЙ ОСНОВЕ\n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────┐\n" +
   "│    Сделка     │    Кол-во    │          ТСС        │   Стоимость по ТСС  │      Балансовая     │  Сумма переоценки   │       Счет Дт      │       Счет Кт      │                         Основание                          │\n" +
   "│               │              │                     │                     │       стоимость     │                     │                    │                    │                                                            │";

  elif (Kind == OVERVALUE_TO)
     Head = Head +
   "                                   ПЕРЕОЦЕНКА ТРЕБОВАНИЙ/ОБЯЗАТЕЛЬСТВ СДЕЛОК ПО ВОЗВРАТУ Ц/Б\n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────┐\n" +
   "│    Сделка     │    Кол-во    │          ТСС        │   Стоимость по ТСС  │      Балансовая     │  Сумма переоценки   │       Счет Дт      │       Счет Кт      │                         Основание                          │\n" +
   "│               │              │                     │                     │       стоимость     │                     │                    │                    │                                                            │";

  elif (Kind == OVERVALUE_PFI )
     Head = Head +
   "                          ПЕРЕОЦЕНКА СПРАВЕДЛИВОЙ СТОИМОСТИ ПФИ\n" +
   "┌───────────────┬──────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────┐\n" +
   "│    Сделка     │    Кол-во    │       СС ПФИ        │  Сумма переоценки   │       Счет Дт      │       Счет Кт      │                                Основание                           │";

  end;

  SvOpPrintLine( Head );

end;                                                                                                                                                                                      

private macro SvOpPrintHeadAMORTHEDGCORR( DlComm, Kind )

  var Head = "\n\n" +
   "                                                                 АМОРТИЗАЦИЯ КОРРЕКТИРОВОК ХЕДЖИРОВАНИЯ \n" +
   "┌───────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
   "│    Выпуск     │        Сумма        │       Счет Дт      │       Счет Кт      │                                          Основание                                             │\n" +
   "│               │       проводки      │                    │                    │                                                                                                │\n" +
   "│               │                     │                    │                    │                                                                                                │";

  SvOpPrintLine( Head );

end;                                                                                                                                                                                      

private macro SvOpPrintFootLineRSS( IsBival )
  var str = "";

  if (IsBival == false)
     str =
"└──────────────────────────────┴───────────────┴────────────────────┴────────────────────┴──────────────────────────┴────────┴─────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘";
  elif (IsBival == true)
     str =
"└──────────────────────────────┴────────────────────┴────────────────────┴──────────────────────────┴────────┴─────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘";
  else
     msgbox("Данный режим печати протокола операции резервирования по срочным сделкам не поддерживается");
  end;          

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineIncome( )
  var str = "";

  str = "└───────────────┴──────────────┴──────────────────┴──────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────┘";
  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineOvervalue(Kind)
  var str = "";

  if ( (Kind == OVERVALUE_WRTOFF) or (Kind == OVERVALUE_RESTORE) )
     str = "└───────────────┴──────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────┘";
  elif ( Kind == OVERVALUE_PFI )
     str = "└───────────────┴──────────────┴─────────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────┘";
  else
     str = "└───────────────┴──────────────┴─────────────────────┴─────────────────────┴─────────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────┘";
  end;

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineAJVOEB(Kind)
  var str = "";

  str = "└───────────────┴──────────────┴─────────────────────┴─────────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────┘\n";

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineACCEXPREVOEB(Kind)
  var str = "";

  str = "└───────────────┴──────────────┴─────────────────────┴─────────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────┘\n";

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineTPA(Kind)
  var str = "";

  str = "└───────────────┴──────────────┴─────────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────┘\n";

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineCPA(Kind)
  var str = "";

  str = "└─────────────────────┴─────────────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────┘\n";

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro SvOpPrintFootLineAMORTHEDGCORR(Kind)
  var str = "";

  str = "└───────────────┴─────────────────────┴────────────────────┴────────────────────┴────────────────────────────────────────────────────────────────────────────────────────────────┘\n";

  SvOpPrintLine( str );
  SvOpPrintLine( "" );
  SvOpPrintLine( "" );
end;

private macro printReportRSS(DlComm)

  var    i = 0, j = 0, temp, Contin, Prev_IsBival = null, IsFirst = false;

  /*Для РСС массив отсортируем - сначала обычные сделки, потом бивалютные*/

  while( i < ScOpReportLineData.Size )
     if (ScOpReportLineData[i].IsBival == true)
        j = i + 1;
        Contin = true;
        while( (j < ScOpReportLineData.Size) and (Contin == true))
           if (ScOpReportLineData[j].IsBival == false)

              temp = ScOpReportLineData[j];
              ScOpReportLineData[j] = ScOpReportLineData[i];
              ScOpReportLineData[i] = temp;

              Contin = false;
           end;
           j = j + 1;
        end;
     end;
     i = i + 1;
  end;

  i = 0;
  while( i < ScOpReportLineData.Size )

     if (i == 0)
        SvOpPrintHeadRSS(DlComm, ScOpReportLineData[i].IsBival, true);
     end;

     if ((ScOpReportLineData[i].IsBival != Prev_IsBival) and (Prev_IsBival != null))
        SvOpPrintFootLineRSS( Prev_IsBival );
        SvOpPrintHeadRSS(DlComm, ScOpReportLineData[i].IsBival, false);
     end;

     SvOpReservLineRSS( ScOpReportLineData[i] );

     if (i == ScOpReportLineData.Size - 1)
        SvOpPrintFootLineRSS( ScOpReportLineData[i].IsBival );
     end;

     Prev_IsBival = ScOpReportLineData[i].IsBival;

     i = i + 1;
  end;

  ScOpNumInsRecord = ScOpReportLineData.Size;

end;

private macro printReportIncome(DlComm)
  var i = 0, Prev_Kind = null, NeedPrintNextLine = true, NextLine;

  while( i < ScOpReportLineData.Size )

     if (i == 0)
        SvOpPrintHeadIncome(DlComm, ScOpReportLineData[i].Kind, true);
     end;

     if ((ScOpReportLineData[i].Kind != Prev_Kind) and (Prev_Kind != null))
        SvOpPrintFootLineIncome( );
        SvOpPrintHeadIncome(DlComm, ScOpReportLineData[i].Kind, false);
     end;

     if (NeedPrintNextLine)
        if (i<ScOpReportLineData.Size-1)
           NextLine = ScOpReportLineData[i+1];
        else
           NextLine = null;
        end;

        SvOpIncomeLine( ScOpReportLineData[i], NextLine, NeedPrintNextLine );
     else
        NeedPrintNextLine = true;
     end;

     if (i == ScOpReportLineData.Size - 1)
        SvOpPrintFootLineIncome( );
     end;

     Prev_Kind = ScOpReportLineData[i].Kind;

     i = i + 1;
  end;

  ScOpNumInsRecord = ScOpReportLineData.Size;

end;

private macro printReportOvervalue(DlComm)

  macro MakeOneReportTable(Kind)
     var i = 0, HeadPrinted = false;

     while( i < ScOpReportLineData.Size )
        if (ScOpReportLineData[i].Kind == Kind)
           if (not HeadPrinted)
              SvOpPrintHeadOvervalue(DlComm, Kind);
              HeadPrinted = true;
           end;

           SvOpOvervalueLine( ScOpReportLineData[i] );
        end;

        i = i + 1;
     end;

     if (HeadPrinted)
        SvOpPrintFootLineOvervalue(Kind);
     end;
  end;

  var i = 0;

  if ( (DlComm.OperSubKind == SC_OVERVALUE_WRTOFF) or (DlComm.OperSubKind == SC_OVERVALUE_RESTORE) )
     while( i < ScOpReportLineData.Size )
        if (i == 0)
           SvOpPrintHeadOvervalue(DlComm, ScOpReportLineData[i].Kind);
        end;

        SvOpOvervalueLine( ScOpReportLineData[i] );

        if (i == ScOpReportLineData.Size - 1)
           SvOpPrintFootLineOvervalue( iif(DlComm.OperSubKind == SC_OVERVALUE_WRTOFF,OVERVALUE_WRTOFF,OVERVALUE_RESTORE) );
        end;

        i = i + 1;
     end;
  else 

     /*ПЕРЕОЦЕНКА ВЛОЖЕНИЙ В ЦЕННЫЕ БУМАГИ*/
     MakeOneReportTable(OVERVALUE_PAPERS);

     /*ПЕРЕОЦЕНКА ЦЕННЫХ БУМАГ, ПОЛУЧЕННЫХ НА ВОЗВРАТНОЙ ОСНОВЕ*/
     MakeOneReportTable(OVERVALUE_VO);

     /*ПЕРЕОЦЕНКА ТРЕБОВАНИЙ/ОБЯЗАТЕЛЬСТВ СДЕЛОК ПО ВОЗВРАТУ Ц/Б*/
     MakeOneReportTable(OVERVALUE_TO);

     /*ПЕРЕОЦЕНКА СПРАВЕДЛИВОЙ СТОИМОСТИ ПФИ*/
     MakeOneReportTable(OVERVALUE_PFI);
  end;

  ScOpNumInsRecord = ScOpReportLineData.Size;
end;

macro printReportCalcCost(DlComm)
   var query, select, seldata, i = 0, TSS = 0;
   query =  " select rdef.T_OtherFI FIFrom, rdef.T_FIID FITo, rdef.T_Point TSS_Point                      " + 
            "            from dratedef_dbt rdef, dfininstr_dbt fin                                        " +
            "            where rdef.t_type = ? and ( EXISTS ( select rhist.t_rateid                       " +
            "                                                 from dratehist_dbt rhist                    " +
            "                                                 where rhist.t_SinceDate = ?                 " +
            "                                                       and rhist.t_rateid = rdef.t_rateid )  " +
            "                                        or rdef.t_SinceDate = ? )                            " +
            "            and fin.t_Fiid = rdef.T_OtherFI                                                  " +
            "            and fin.t_Fi_Kind = ?";

   if( DlComm.AvoirKind > 0 )
      query =  query + " and RSB_FIInstr.FI_AvrKindsEQ(?, ?, Fin.t_AvoirKind) = 1 ";
   end;

   select  = RSDCommand(query);
                       
   select.addParam("", RSDBP_IN, SP_RATETYPE_RightCost);
   select.addParam("", RSDBP_IN, DlComm.CommDate);
   select.addParam("", RSDBP_IN, DlComm.CommDate);
   select.addParam("", RSDBP_IN, FIKIND_AVOIRISS);

   if( DlComm.AvoirKind > 0 )
      select.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
      select.addParam("", RSDBP_IN, DlComm.AvoirKind);
   end;

   select.execute();

   seldata = TRsbDataSet(select);

   while( seldata.MoveNext() )

      if(i == 0 )
         SvOpPrintHeadCalcTSS( DlComm );
      end;

      if( ConvSumDbl( TSS, 1, Date(DlComm.CommDate), seldata.FIFrom, seldata.FITo, true, SP_RATETYPE_RightCost ) )
         SvOpCALCTSSLine( SvOpCALCTSS(seldata.FIFrom,TSS,seldata.FITo ) );
      end;

      i = i + 1;

   end;

   if(i > 0)
      SvOpCALCTSSFoot();
      SvOpPrintFoot( DlComm );
   else
      println( " Нет выполненных операций " );
   end;

end;

private macro printReportAjustValOEB_XML(DlComm,SvOpReportLineData_XML:AJUSTVALOEB_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeOneReportTable()
    var HeadPrinted = false;

    SvOpReportLineData_XML.SetReportNumber(0);

    while(SvOpReportLineData_XML.Next)
      if (not HeadPrinted)
        SvOpPrintHeadAJVOEB(DlComm);
        HeadPrinted = true;
      end;
      SvOpAJOEBLine( SvOpReportLineData_XML.GetReportLineData() );
    end;

    if (HeadPrinted)
      SvOpPrintFootLineAJVOEB();
      IsExistsData = true;
    end;
  end;

  MakeOneReportTable();

  return IsExistsData;
end;

private macro printReportACCEXPREVOEB_XML(DlComm,SvOpReportLineData_XML:ACCEXPREVOEB_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeOneReportTable()
    var HeadPrinted = false;

    SvOpReportLineData_XML.SetReportNumber(0);

    while(SvOpReportLineData_XML.Next)
      if (not HeadPrinted)
        SvOpPrintHeadACCEXPREVOEB(DlComm);
        HeadPrinted = true;
      end;
      SvOpACCEXPREVOEBLine(SvOpReportLineData_XML.GetReportLineData());
    end;

    if (HeadPrinted)
      SvOpPrintFootLineACCEXPREVOEB();
      IsExistsData = true;
    end;
  end;

  MakeOneReportTable();

  return IsExistsData;
end;

private macro printReportTPA_XML(DlComm,SvOpReportLineData_XML:TPA_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeOneReportTable()
    var HeadPrinted = false;

    SvOpReportLineData_XML.SetReportNumber(0);

    while(SvOpReportLineData_XML.Next)
      if (not HeadPrinted)
        SvOpPrintHeadTPA(DlComm);
        HeadPrinted = true;
      end;
      SvOpTPALine(SvOpReportLineData_XML.GetReportLineData());
    end;

    if (HeadPrinted)
      SvOpPrintFootLineTPA();
      IsExistsData = true;
    end;
  end;

  MakeOneReportTable();

  return IsExistsData;
end;

private macro printReportCPA_XML(DlComm,SvOpReportLineData_XML:CPA_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeOneReportTable()
    var HeadPrinted = false;

    SvOpReportLineData_XML.SetReportNumber(0);

    while(SvOpReportLineData_XML.Next)
      if (not HeadPrinted)
        SvOpPrintHeadCPA(DlComm);
        HeadPrinted = true;
      end;
      SvOpCPALine(SvOpReportLineData_XML.GetReportLineData());
    end;

    if (HeadPrinted)
      SvOpPrintFootLineCPA();
      IsExistsData = true;
    end;
  end;

  MakeOneReportTable();

  return IsExistsData;
end;

private macro printReportOvervalue_XML(DlComm,SvOpReportLineData_XML:OVERVALUE_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeOneReportTable(Kind)
     var i = 0, HeadPrinted = false;

     SvOpReportLineData_XML.SetReportNumber(Kind);

     while( SvOpReportLineData_XML.Next )
        if (SvOpReportLineData_XML.GetReportLineData().Kind == Kind)
           if (not HeadPrinted)
              SvOpPrintHeadOvervalue(DlComm, Kind);
              HeadPrinted = true;
           end;

           SvOpOvervalueLine( SvOpReportLineData_XML.GetReportLineData() );
        end;

        i = i + 1;
     end;

     if (HeadPrinted)
        SvOpPrintFootLineOvervalue(Kind);
        IsExistsData = true;
     end;
  end;


  if (DlComm.OperSubKind == SC_OVERVALUE_WRTOFF)
     MakeOneReportTable(OVERVALUE_WRTOFF);
  elif (DlComm.OperSubKind == SC_OVERVALUE_RESTORE)
     MakeOneReportTable(OVERVALUE_RESTORE);
  else 
     /*ПЕРЕОЦЕНКА ВЛОЖЕНИЙ В ЦЕННЫЕ БУМАГИ*/
     MakeOneReportTable(OVERVALUE_PAPERS);

     /*ПЕРЕОЦЕНКА ЦЕННЫХ БУМАГ, ПОЛУЧЕННЫХ НА ВОЗВРАТНОЙ ОСНОВЕ*/
     MakeOneReportTable(OVERVALUE_VO);

     /*ПЕРЕОЦЕНКА ТРЕБОВАНИЙ/ОБЯЗАТЕЛЬСТВ СДЕЛОК ПО ВОЗВРАТУ Ц/Б*/
     MakeOneReportTable(OVERVALUE_TO);

     /*ПЕРЕОЦЕНКА СПРАВЕДЛИВОЙ СТОИМОСТИ ПФИ*/
     MakeOneReportTable(OVERVALUE_PFI);
  end;

  return IsExistsData;
end;

private macro printReportIncome_XML(DlComm,SvOpReportLineData_XML:GET_INCOME_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeNullFiwarntsTable()
    var ReportLineData_XML;
    var NullFiwarntsData:CSC_NullFiwarnts;
    var HeadPrinted = false;
    var StrLine;   

    ReportLineData_XML = NULLFIWARNTS_LOG_FROM_XML(DlComm.DocKind, DlComm.DocumentID, LOG_TYPE_DATA, true);
    ReportLineData_XML.SetReportNumber(INCOME_NULLFIWARNTS);
    
    while( ReportLineData_XML.Next )
      NullFiwarntsData = ReportLineData_XML.GetReportLineData();

      if (not HeadPrinted)
         SvOpPrintHeadIncome(DlComm, INCOME_NULLFIWARNTS);
         HeadPrinted = true;
      end;

      StrLine = "├────────────────────┼─────────────────────────────────┼────────────────────┼────────────────┤\n" 
                  +  "│" + String(NullFiwarntsData.FI_Code:20:c)
                  +  "│" + String(NullFiwarntsData.FI_Name:33:c)
                  +  "│" + String(IIF(NullFiwarntsData.isNullCoup == 1, "Да", ""):20:c)
                  +  "│" + String(IIF(NullFiwarntsData.isNullPart == 1, "Да", ""):16:c) +  "│";

      SvOpPrintLine( StrLine );
    end;

    if(HeadPrinted)
      StrLine = "└────────────────────┴─────────────────────────────────┴────────────────────┴────────────────┘";
      SvOpPrintLine( StrLine );
      SvOpPrintLine( "" );
      SvOpPrintLine( "" );
    end;
  end;

  macro MakeRepoIncomeIn()
    var ReportLineData_XML;
    var RepoIncomeIn:CSC_RepoIncomeIN;
    var StrLine;   

    ReportLineData_XML = REPOINCOMEIN_LOG_FROM_XML(DlComm.DocKind, DlComm.DocumentID, LOG_TYPE_DATA, true);
    ReportLineData_XML.SetReportNumber(RepoIncomeIn_Kind);
    
    while( ReportLineData_XML.Next )
      RepoIncomeIn = ReportLineData_XML.GetReportLineData();

      StrLine = "По выпуску "+ String(RepoIncomeIn.FI_Code) + " " + String(RepoIncomeIn.FI_Name) + 
                " имеются сделки репо, по которым не выполнено погашение купона с датой погашения " + String(RepoIncomeIn.DrawingDate) +
                ".\n Повторите начисление ПДД по выпуску после обработки купона в репо.\n";

      SvOpPrintLine( StrLine );
    end;
  end;

  macro MakeOneReportTable(Kind)
     var i = 0, HeadPrinted = false;

     SvOpReportLineData_XML.SetReportNumber(Kind);

     while( SvOpReportLineData_XML.Next )
        if (SvOpReportLineData_XML.GetReportLineData().Kind == Kind)
           if (not HeadPrinted)
              SvOpPrintHeadIncome(DlComm, Kind);
              HeadPrinted = true;
           end;

           SvOpIncomeLine( SvOpReportLineData_XML.GetReportLineData() );/*ОВП тут проверять не надо*/
        end;

        i = i + 1;
     end;

     if (HeadPrinted)        
        SvOpPrintFootLineIncome();
        IsExistsData = true;
     end;
  end;

  MakeNullFiwarntsTable();
  MakeRepoIncomeIn();
  MakeOneReportTable(INCOME_OWN_PAPERSPD);
  MakeOneReportTable(INCOME_OWN_PAPERSDD);
  MakeOneReportTable(INCOME_BACK_KA);
  MakeOneReportTable(INCOME_REPO);
  MakeOneReportTable(INCOME_OWN_PAPERS);

  return IsExistsData;
end;

private macro printReportAMORTHEDGCORR_XML(DlComm,SvOpReportLineData_XML:AMORTHEDGCORR_LOG_FROM_XML)
  var IsExistsData = false;

  macro MakeOneReportTable()
    var HeadPrinted = false;

    SvOpReportLineData_XML.SetReportNumber(0);

    while(SvOpReportLineData_XML.Next)
      if (not HeadPrinted)
        SvOpPrintHeadAMORTHEDGCORR(DlComm);
        HeadPrinted = true;
      end;
      SvOpAMORTHEDGCORRLine(SvOpReportLineData_XML.GetReportLineData());
    end;

    if (HeadPrinted)
      SvOpPrintFootLineAMORTHEDGCORR();
      IsExistsData = true;
    end;
  end;

  MakeOneReportTable();

  return IsExistsData;
end;

macro PrintErrorByXML( DlComm )

  var ObjectName = "";
  var ErrData, stat = 0;
  var SvOpReportLineData_XML;

  SvOpReportLineData_XML = GetLogDataXML(DlComm.DocKind, DlComm.DocumentID, LOG_TYPE_ERROR, true);
  SvOpReportLineData_XML.SetReportNumber(0);
   
  stat = SvOpReportLineData_XML.Next();

  if(stat)
    if( (DlComm.DocKind == DL_OVERVALUE) or
        ((DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind==KINDRES_RCB)) or
        (DlComm.DocKind == DL_CALCTSS)
      )
       ObjectName = "Код ц/б";
    elif( DlComm.DocKind == 104 )
       ObjectName = "Договор";
    elif( (DlComm.DocKind == DL_OVERVALUE_RD) or
          (DlComm.DocKind == DL_OVERVALUE_NVPI) or
          ((DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind == KINDRES_REQ)) )
       ObjectName = "Сделка";
    elif( DlComm.DocKind == DL_GET_INCOME )
       ObjectName = "Объект";
    end;
     
    SvOpPrintLine( "\n\n Ошибки при выполнении сервисной операции:\n" );

    if( (DlComm.DocKind == DL_OVERVALUE) or
        ((DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind==KINDRES_RCB)) )                                                                                   
       SvOpPrintLine( "┌──────┬───────────────────┬──────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐");
       SvOpPrintLine( "│   №  │"+ string(ObjectName:19:c) + "│                 Наименование ц/б                 │                                         Код ошибки                                                                                                    │");
       SvOpPrintLine( "│ошибки│                   │                                                  │                                                                                                                                                       │");
       SvOpPrintLine( "├──────┼───────────────────┼──────────────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤");
    else
       SvOpPrintLine( "┌──────┬───────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐");
       SvOpPrintLine( "│   №  │"+ string(ObjectName:19:c) + "│                      Код ошибки                                                                                                                                                       │");
       SvOpPrintLine( "│ошибки│                   │                                                                                                                                                                                       │");
       SvOpPrintLine( "├──────┼───────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤");
    end;

    while( stat )
       ErrData = SvOpReportLineData_XML.GetReportLineData();
       var ObjCode = ErrData.ObjCode;

       if( (DlComm.DocKind == DL_OVERVALUE) or
           ((DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind==KINDRES_RCB)) )
          SvOpPrintLine( "│" +
                        string(ErrData.NumErr:6) + "│" +
                        string(ObjCode:19) + "│" +
                        string(ПолучитьИмяФинИн(ObjCode):50) + "│" +
                        string(ErrData.StrErr:151) + "│" );
       else
          if( DlComm.DocKind == DL_GET_INCOME )
             if( ErrData.ObjKind == DLDOC_ISSUE )
                ObjCode = "Ц/б " + ObjCode;
             elif( ErrData.ObjKind == DL_SECURITYDOC )
                ObjCode = "Сд. " + ObjCode;
             end;
          end;
          SvOpPrintLine( "│" +
                        string(ErrData.NumErr:6) + "│" +
                        string(ObjCode:19) + "│" +
                        string(ErrData.StrErr:183) + "│" );
       end;

       stat = SvOpReportLineData_XML.Next();
    end;
    if( (DlComm.DocKind == DL_OVERVALUE) or
        ((DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind==KINDRES_RCB)) )
       SvOpPrintLine( "└──────┴───────────────────┴──────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘");
    else
       SvOpPrintLine( "└──────┴───────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘");
    end;
  end;
   
end; 
  
/*печать отчета по данным xml*/
MACRO Print_MemOrderByXML( DlComm, OnlyLastReport:bool)
  var SvOpReportLineData_XML:variant;
  var IsExistsData = false;

  //протокол печатается уже после исполнения опреации и при этом всегда isOprMultiExec() == false, то можно отменить замену msgbox на другую ф-цию
  //т.к. даже использование ScOpInsertError в этом случае всё равно будет звать обычный msgbox
  ReplaceMacro ( "msgbox", NULL );

  SvOpReportLineData_XML = GetLogDataXML(DlComm.DocKind, DlComm.DocumentID, LOG_TYPE_DATA, OnlyLastReport);
  if( not SvOpReportLineData_XML  )
     SvOpPrintLine( "Не могу получить данные протокола по операции с кодом \""+DlComm.CommCode+"\"" );
     return;
  end;
  PrintErrorByXML( DlComm );
  if( DlComm.DocKind == SP_AJUSTVALOEB )
     IsExistsData = printReportAjustValOEB_XML(DlComm, SvOpReportLineData_XML);
  elif( DlComm.DocKind == SP_ACCEXPREVOEB )
     IsExistsData = printReportACCEXPREVOEB_XML(DlComm, SvOpReportLineData_XML);
  elif( DlComm.DocKind == SP_TRANSFERPA )
     IsExistsData = printReportTPA_XML(DlComm, SvOpReportLineData_XML);
  elif( DlComm.DocKind == SP_COMISSION_PA )
     IsExistsData = printReportCPA_XML(DlComm, SvOpReportLineData_XML);
  elif( DlComm.DocKind == DL_OVERVALUE )
     IsExistsData = printReportOvervalue_XML(DlComm, SvOpReportLineData_XML);
  elif( DlComm.DocKind == DL_GET_INCOME )
     IsExistsData = printReportIncome_XML(DlComm, SvOpReportLineData_XML);
  elif( DlComm.DocKind == SP_AMORTHEDGCORR )
     IsExistsData = printReportAMORTHEDGCORR_XML(DlComm, SvOpReportLineData_XML);
  else
     IsExistsData = SvOpPrintReportLine_XML( DlComm.DocKind, DlComm, SvOpReportLineData_XML );
  end;

  if( IsExistsData == false )
     SvOpPrintLine( "Нет выполненных операций" );
     return true;
  else
     ScOpNumInsRecord = 1;/*пока nfr*/
     SvOpPrintFoot( DlComm );
  end;

  return true;
END;

/* Печать отчета по сервисной операции. Вызывается по F7 из сервисной
   операции. */
MACRO Print_MemOrder( FirstDoc, _OnlyLastReport:bool )
   file   oper( oproper );
   var
      oprstep = TBFile( "oprstep", "R", 9 ),
      continue_cicle, CurNum = 0, PrintReport = 0;

  var  OnlyLastReport = false, ReqMsg = "";
  ///////////////////////////////

  SetBuff( DlComm, FirstDoc );

  if( _OnlyLastReport != null )
     OnlyLastReport = _OnlyLastReport;
  end;

  //Simanov. Отправить отчёт о начисленных резервах по почте
  if (DlComm.DocKind == DL_RESERVEDOC)
    var prm = CDLCalcORParm();
    prm.EndDate = DlComm.commdate/*{curdate}*/;
    prm.BySecur = true;
    prm.ByEmail = true;
    prm.IsShowReport = false;
    DL_CalcOR_Report(prm);
  end;

  if( ServOpByXML(DlComm.DocKind) == true )
     /*если нет данных в XML формате, попробуем по-старому вывести*/
     if( DL_IsExistsLogByOper(DlComm.DocKind,DlComm.DocumentID,OnlyLastReport) == false )                                                      
        if( DlComm.DocKind == DL_CALCTSS )
           ReqMsg = "Выполнить формирование протокола по существующим курсам справедливой стоимости на дату операции?";
        else
           ReqMsg = "Выполнить формирование протокола по проводкам?";
        end;
        if( MsgBoxEx( "Не найдены данные по протоколу сервисной операции с кодом " + DlComm.CommCode + ".|" +
                       ReqMsg,
                       MB_YES+MB_NO, IND_YES, 
                       "", "") == IND_NO )
           SvOpPrintLine( "Не найдены данные по протоколу сервисной операции с кодом " + DlComm.CommCode);
           return;
        end;
     else
        return Print_MemOrderByXML(DlComm,OnlyLastReport);
     end;
  end;

  //протокол печатается уже после исполнения опреации и при этом всегда isOprMultiExec() == false, то можно отменить замену msgbox на другую ф-цию
  //т.к. даже использование ScOpInsertError в этом случае всё равно будет звать обычный msgbox
  ReplaceMacro ( "msgbox", NULL );
  if(DlComm.DocKind == DL_CALCTSS)/*Процедура расчета ТСС*/
      printReportCalcCost(DlComm);
      return true;
  end;

  if( DlComm.DocKind == BofficeKindCOMM )
     /* Протокол обработки периодических комиссий. */
     RepProcessPeriodComm_Print(DlComm);
     return true;
  end;

  ScOpNumInsRecord = 0;
  ScOpLastServDocKind = -1;

  ScOpReportLineData.Size = 0;
   oprstep.Clear;
   oprstep.AddFilter(   "t_ServDocKind = " + string(DlComm.DocKind)
                        + " and t_ServDocID = " + string(DlComm.DocumentID) );

   InitProgress(  oprstep.NRecords, "Просмотр шагов операции ...",
                  "Отчет по сервисной операции <" + DlComm.CommCode + ">" );

   continue_cicle = true;
   while( continue_cicle and oprstep.Next )

     if( oprstep.rec.IsRemoveStep != "" )
        ClearRecord( oper );
        oper.ID_Operation = oprstep.rec.ID_Operation;
        if( not GetEQ(oper) )
           msgbox( "Не найдена операция по шагу" );
           continue_cicle = false;
        end;
        
        PrintReport = ОтчетПоШагу( oper, oprstep.rec, DlComm );
        if( PrintReport != 0 )
           continue_cicle = false;
        end;
     end;

     UseProgress( CurNum = CurNum + 1 );
   end;
   oprstep.DropFilter();

   if( (DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind == KINDRES_DEAL) )
      printReportRSS(DlComm);
   elif( DlComm.DocKind == DL_GET_INCOME )
      printReportIncome(DlComm);

   elif( DlComm.DocKind == DL_OVERVALUE )
      printReportOvervalue(DlComm);
   end;

  if( ScOpNumInsRecord == 0 )
     println( " Нет выполненных операций " );
  else
     SvOpPrintFoot( DlComm );
  end;

  RemProgress;

  if( (DlComm.DocKind == DL_RESERVEDOC) and (DlComm.OperationKind == KINDRES_DEAL) )
     return true;
  end;

  if( DlComm.DocKind == DL_GET_INCOME )
     return true;
  end;

  if( DlComm.DocKind == DL_OVERVALUE )
     return true;
  end;

  if ( PrintReport == 1 ) 
     exit(1); 
  end;
END;

MACRO WebPrintSvOpByXML( comm )
  var filename = string("..\\txtfile\\protocol_",{oper},".txt");

  SetOutPut(filename);
  if(Print_MemOrder(comm, false) == true)
    SetOutput (NULL,TRUE);
    var FC = CreateFileContainer(ConvertTxt2Html(filename));
    RemoveFile(filename);
    return FC;
  end;
END;
