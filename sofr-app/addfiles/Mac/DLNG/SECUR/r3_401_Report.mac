/** 
 @file  r3_401_Report.mac
 @brief Отчет "Расшифровка 401"

 Сделки ПФИ, кроме сделок с ценными бумагами

 # menu
 - ФИССиКО\Отчеты\Расшифровки\[401-3] Сделки ПФИ, кроме сделок по ценным бумагам. 

 # tag
 - functional_block:Отчетность_внутренняя
 - code_type:Report

 # changeLog 
 |date       |author         |tasks            |note                            
 |-----------|---------------|-----------------|--------------------------------------------    
 |2019.02.19 |Сагиян  С. Г.  |?                | Первоначальная реализация                 

*/

IMPORT "spCache.mac", "r3_401_form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "cb_sql.mac", "sprepfun.mac", "oralib", "MoCommon.mac","ws_txreportform.mac";

PRIVATE VAR   T_Dep:T_Dep_Collector;
PRIVATE VAR   OD1_Form;
PRIVATE VAR   OD1_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб
PRIVATE VAR   NFinRez;
PRIVATE VAR   NNDFL;
PRIVATE VAR ReportHeader = " \n";                                                                                                                                                                                                                                                                                                                            
PRIVATE VAR TableHeader = " \n"; 
                                                                                                                                    
PRIVATE CLASS (DL_CReportTemplate) SP_OD1_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  PRIVATE VAR F0_6, F0_9, F0_11; /*суммы строки "Итого"*/
  PRIVATE VAR m_TotalAmountPoint = 0;
  PRIVATE VAR v_account = "";
  var RS, RS1, RSACC_Tr, RSACC_ob;
  VAR RepDate, BeginDate, EndDate;
  var v_tr_fi, v_ob_fi, v_tr_acc, v_ob_acc, v_tr_amount, v_ob_amount;
  var v_rate_dol, v_date_dol;
  var v_plus_pfi, v_minus_pfi, v_oborot_plus, v_oborot_minus;

  VAR v_Acc;
  VAR l_ratedate, l_rateval;
  VAR ProgressValue = CTxProgressValue();

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
  
  /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END;
  
  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintLine( P1, P2, P3, P4, P5, P6, P7, P8, P9, P10, P11, P12, P13, P14, P15, P16, P17, P18, P19, P20, P21, P22 )

     this.PrintTableLine( 

          /*1 */     "DealNom",    P1  , null, 
          /*2 */     "DealKind",   P2  , null, 
          /*3 */     "DealType",   P3  , null, 
          /*4 */     "FiKind",     P4  , null, 
          /*5 */     "Contractor", P5  , null, 
          /*6 */     "ContrCou",   P6  , null, 
          /*7 */     "ContrType",  P7  , null, 
          /*8 */     "OpenDate",   P8  , null, 
          /*9 */     "CloseDate",  P9  , null,
          /*10*/     "TrAcc",      P10 , null,
          /*11*/     "TrVal",      P11 , null,
          /*12*/     "TrAmount",   P12 , null,
          /*13*/     "ObAcc",      P13 , null,
          /*14*/     "ObVal",      P14 , null,
          /*15*/     "ObAmount",   P15 , null,
          /*16*/     "PromSum1",   P16 , null,
          /*17*/     "PromSum2",   P17 , null,
          /*18*/     "BreakDate",  P18 , null,
          /*19*/     "PromSum3",   P19 , null,
          /*20*/     "Rate1",      P20 , null,
          /*21*/     "Rate2",      P21 , null,
          /*22*/     "Rate3",      P22 , null
       );      

  END;

  PRIVATE MACRO BeginReport()

     VAR AvrKindShowValue = "";
     this.SetActiveSheet( "Лист1" );    
     VAR cmd1, rs1, cmdacc, rsacc;

     cmd1 = RSDCommand ( " SELECT TO_CHAR (d, 'dd.mm.yyyy') begindate, "+
                         "       TO_CHAR (d + INTERVAL '1' MONTH - INTERVAL '1' DAY, 'dd.mm.yyyy') enddate "+
                         "  FROM (SELECT TO_DATE ('01.' || TO_CHAR (?, 'mm.yyyy'), 'dd.mm.yyyy') d FROM DUAL) ");
     cmd1.AddParam( "", RSDBP_IN, OD1_Form.GetFieldValue( PNFLD_OD1_DATE ) );                 
     RS1 = TRsbDataSet( cmd1 );
     RS1.MoveNext;
     BeginDate = RS1.BeginDate;
     EndDate = RS1.EndDate;                             

     this.PrintFormatString( ReportHeader, "H0_1"  , BeginDate + " - " + EndDate );
     this.RegisterTable( "MainTable", "",

          /*1 */     "DealNom",                     
          /*2 */     "DealKind",                      
          /*3 */     "DealType",                     
          /*4 */     "FiKind",                     
          /*5 */     "Contractor",      
          /*6 */     "ContrCou",                   
          /*7 */     "ContrType",                     
          /*8 */     "OpenDate",                    
          /*9 */     "CloseDate",       
          /*10*/     "TrAcc",                         
          /*11*/     "TrVal",                     
          /*12*/     "TrAmount",                    
          /*13*/     "ObAcc",                       
          /*14*/     "ObVal",                       
          /*15*/     "ObAmount",        
          /*16*/     "PromSum1",        
          /*17*/     "PromSum2",        
          /*18*/     "BreakDate",                    
          /*19*/     "PromSum3",        
          /*20*/     "Rate1",                    
          /*21*/     "Rate2",                    
          /*22*/     "Rate3"

       );      
  END;

  MACRO ПечататьПромежуточныеИтоги()
  END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     ПечататьПромежуточныеИтоги();
  END;

  PRIVATE MACRO DealNom
     return rs.dealcode;
  END;

  PRIVATE MACRO DealKind
     return "ПФИ";
  END;

  PRIVATE MACRO DealType
     return rs.dealtype;
  END;

  PRIVATE MACRO FiKind
     return rs.dealkind;
  END;

  PRIVATE MACRO Contractor
     return rs.Contractor;
  END;

  PRIVATE MACRO ContrCou
     return rs.ContrCou;
  END;

  PRIVATE MACRO ContrType
     VAR cmd1, rs1;
     cmd1 = RSDCommand("select 1 from dpartyown_dbt where t_partyid = ? and t_partykind = 2");
     cmd1.AddParam( "", RSDBP_IN, rs.ContrPartyID );                 
     RS1 = TRsbDataSet( cmd1 );
     if (RS1.MoveNext)
         return "Банк";
     else
         return "ЮЛ";
     end;
  END;

  PRIVATE MACRO FindAcc(v_dealid, nfitype, IsBuy, fi1, fi2, date_, KIND, EXECDATE)
     VAR cmd1, cmd2, fiRoleTrQuery = "", fiRoleObQuery = "";
     if (nfitype > 0)
       if (IsBuy)
         fiRoleTrQuery = " AND ACC1.T_FIROLE IN (5)";
       else
         fiRoleTrQuery = " AND ACC1.T_FIROLE IN (30)";
       end;
     end;

     cmd1 = RSDCommand(" SELECT acc1.t_account TrAcc, "+
                       "       acc1val.t_fi_code TrVal, "+
                       "       acc1val.t_fiid TrFi "+
                       "  FROM dmcaccdoc_dbt acc1, "+
                       "       dfininstr_dbt acc1val "+
                       " WHERE     acc1.t_docid = ? "+
                       "       AND acc1.t_dockind in (199, 4815) "+
                       "       AND ACC1.T_CATNUM in(1224, 5016, 1554, 317, 5021, 5059) "+
                       fiRoleTrQuery +
                       "       AND ACC1.T_CURRENCY = acc1val.t_fiid "+
                       "       AND rsb_account.restall(acc1.t_account, acc1.t_chapter, acc1.t_currency, ?) <> 0 "+
                       "       AND acc1.T_ACTIVATEDATE <= ? "+
                       "       AND (acc1.T_DISABLINGDATE >= ? or acc1.T_DISABLINGDATE = to_date('01.01.0001','DD.MM.YYYY'))");

     cmd1.AddParam( "", RSDBP_IN, v_dealid );                 
     cmd1.AddParam( "", RSDBP_IN, date_ );
     cmd1.AddParam( "", RSDBP_IN, date_ );
     cmd1.AddParam( "", RSDBP_IN, date_ );
     cmd1.AddParam( "", RSDBP_IN, date_ );
     cmd1.AddParam( "", RSDBP_IN, date_ );
     cmd1.AddParam( "", RSDBP_IN, date_ );

     RSACC_Tr = TRsbDataSet( cmd1 );
     RSACC_Tr.MoveNext;

     if (nfitype > 0)
       if (IsBuy)
         fiRoleObQuery = " AND ACC2.T_FIROLE IN (31)";
       else
         fiRoleObQuery = " AND ACC2.T_FIROLE IN (150)";
       end;
     end;

     cmd2 = RSDCommand(" SELECT acc2.t_account ObAcc, "+
                        "      acc2val.t_fi_code ObVal, "+
                       "       acc2val.t_fiid ObFi "+                      
                       "  FROM dmcaccdoc_dbt acc2, "+
                       "       dfininstr_dbt acc2val "+
                       " WHERE      acc2.t_docid = ? "+
                       "       AND acc2.t_dockind in (199, 4815, 1555, 318) "+ 
                       "       AND ACC2.T_CATNUM in(1225, 5019, 1554, 317, 5022, 5060) "+
                       fiRoleObQuery +
                       "       AND ACC2.T_CURRENCY = acc2val.t_fiid "+
                       "       AND rsb_account.restall(acc2.t_account, acc2.t_chapter, acc2.t_currency, ?) <> 0 "+
                       "       AND acc2.T_ACTIVATEDATE <= ? "+
                       "       AND (acc2.T_DISABLINGDATE >= ? or acc2.T_DISABLINGDATE = to_date('01.01.0001','DD.MM.YYYY'))");

     cmd2.AddParam( "", RSDBP_IN, v_dealid );                 
     cmd2.AddParam( "", RSDBP_IN, date_ );
     cmd2.AddParam( "", RSDBP_IN, date_ );
     cmd2.AddParam( "", RSDBP_IN, date_ );
     cmd2.AddParam( "", RSDBP_IN, date_ );
     cmd2.AddParam( "", RSDBP_IN, date_ );
     cmd2.AddParam( "", RSDBP_IN, date_ );

     RSACC_Ob = TRsbDataSet( cmd2 );
     RSACC_Ob.MoveNext;
  END;

  PRIVATE MACRO OpenDate
     return rs.OpenDate;
  END;

  PRIVATE MACRO CloseDate
     var Clop;
     if (rs.ExecDate2 != "01.01.0001")
         Clop = max(rs.PayDate2, rs.SuplDate2);
         if (Clop != "01.01.0001") 
             return Clop;
         else 
             return rs.ExecDate2;
         end;
     else 
         Clop = max(rs.PayDate1, rs.SuplDate1);
         if (Clop != "01.01.0001") 
             return Clop;
         else 
             return rs.ExecDate1;
         end;
     end;
  END;

  PRIVATE MACRO BreakDate
     return "";
  END;

  PRIVATE MACRO TrAmount
     return v_tr_amount;
  END;

  /**
   @brief  Счёт требований
   @return Возвращает счёт полученный в функции FindAcc, если остаток ненулевой 
  */
  PRIVATE MACRO TrAcc
    return IIF(TrAmount, RSACC_Tr.TrAcc, "");
  END;

  PRIVATE MACRO TrVal
     var tr;                      
     if (RSACC_Tr.TrVal == "959")    
         tr = "A98";    
         return tr;    
     else                         
         return RSACC_Tr.TrVal;  
     end;                         
  END;

  PRIVATE MACRO ObAmount
     return v_ob_amount;
  END;

  /**
   @brief  Счёт обязательств
   @return Возвращает счёт полученный в функции FindAcc, если остаток ненулевой 
  */
  PRIVATE MACRO ObAcc
    return IIF(ObAmount, RSACC_Ob.ObAcc, "");
  END;

  PRIVATE MACRO ObVal
     var tr;
     if (RSACC_Ob.Obval == "959")
         tr = "A98";
         return tr;
     else  
         return RSACC_Ob.Obval;  
     end;
  END;

  PRIVATE MACRO PromSum1
     return 0;
  END;

  PRIVATE MACRO PromSum2
     return 0;
  END;

  PRIVATE MACRO PromSum3
     return 0;
  END;

  PRIVATE MACRO Rate2
     return v_oborot_plus;
  END;

  PRIVATE MACRO Rate3
     return v_oborot_minus;
  END;

  PRIVATE MACRO GetRate(fi, rtype, ddate)
    VAR cmd1, rs1, cmd2, rs2, retValue = 0;
    var rec_rate = TRecHandler("ratedef.dbt");
    var err = ПолучитьКурс (rec_rate, fi, 0, rtype);
    if (not err)
        err = ПолучитьЗначениеКурса (rec_rate, Date(ddate));
        if (not err)
             ПолучитьСтрокуЗначенияКурса(rec_rate, 1, retValue);
             return retValue;
        end;
    end;      

     if (err)
         cmd2 = RSDCommand("select t_rate/power(10,t_point) RetVal from dratedef_dbt rh where t_otherfi = ? and t_type = ? and rh.t_sincedate <= ? ");

         cmd2.AddParam( "", RSDBP_IN, fi );                 
         cmd2.AddParam( "", RSDBP_IN, rtype );                 
         cmd2.AddParam( "", RSDBP_IN, ddate );                 
         RS2 = TRsbDataSet( cmd2 );
         if (RS2.MoveNext)
             retValue = rs2.RetVal;
             return retValue;        
         end;
         return 0;
     end;
  END;

  PRIVATE MACRO Rate1
     var loc;
     if (date(CloseDate) > date(EndDate))
         loc = EndDate;
     else 
         loc = CloseDate;
     end;

     if (v_date_dol == loc)
         return v_rate_dol;
     else
         v_rate_dol = GetRate(7, 7, loc);
         v_date_dol = loc;
         return v_rate_dol;
     end;
  END;

  MACRO OPT
     var AccBuf  = TRecHandler("account");
     v_tr_fi = "";
     v_tr_amount = 0;               
     v_ob_fi = "";
     v_ob_amount = 0;

     v_tr_fi = RSACC_Tr.TrVal;
     if( GetAccount( 4, RSACC_Tr.TrFi, RSACC_Tr.TrAcc, AccBuf, true ) == true )
        v_tr_amount = abs(DL_GetRestAccount( AccBuf.rec, Date(EndDate) ));   
     end;             
     v_ob_fi = RSACC_Ob.ObVal;
     if( GetAccount( 4, RSACC_Ob.Obfi, RSACC_Ob.ObAcc, AccBuf, true ) == true )
        v_ob_amount = abs(DL_GetRestAccount( AccBuf.rec, Date(EndDate) ));   
     end;
  END;

  /* ____________________*/
  MACRO GetAccPFI /*Справедливая стоимость ПФИ PDV 180919*/
     var query3, cmd3, rs3,dt;
     var AccBuf  = TRecHandler("account");
     //  обороты по проводкам..
     var dl_calendar_acc = 10002; //SVE 518285 05.11.2020 в какой-то момент дистрибутивная dl_calendar_acc перестала работать, объявил согласно описанию в интерах
     v_oborot_plus = 0;
     v_oborot_minus = 0;

     /*PNV - i-support 501493 !!!!!! Откуда брать корректные суммы, если то проводок нет, то в истории СС черт знает что?*/
     /*Для опционов берем суммы из проводок\остатков, для остальных - надеемся что в истории СС более корректные суммы, чем в проводках, т.к. они загружаются из внешнего файла*/
     /*PNV 508083*/
     if ( ( (RS.Kind == 22710) or (RS.Kind == 12715)) and (RS.nFIType == 0))
          v_oborot_plus = 0;
          v_oborot_minus = 0;
     else
        cmd3 = RSDCommand(" SELECT acc1.t_account PlusAcc, "+
                          "        acc2.t_account MinusAcc "+
                          "  FROM  dmcaccdoc_dbt acc1, "+
                          "        dmcaccdoc_dbt acc2  "+
                          " WHERE     acc1.t_docid = ? "+
                          "       AND acc2.t_docid = acc1.t_docid "+
                          "       AND acc1.t_dockind in (199, 4815) "+
                          "       AND acc2.t_dockind in (199, 4815) "+ 
                          "       AND ACC1.T_CATNUM = 1217 "+
                          "       AND ACC2.T_CATNUM = 1218 ");

        cmd3.AddParam( "", RSDBP_IN, rs.id );
                 
        rs3 = TRsbDataSet( cmd3 );
        if (rs3.movenext())
           if( GetAccount( null, null, rs3.PlusAcc, AccBuf, true ) == true )
              v_oborot_plus = abs(DL_GetRestAccount( AccBuf.rec, IIF(date(CloseDate) <= Date(EndDate), date(CloseDate), Date(EndDate)) ));   
           end;
           if( GetAccount( null, null, rs3.MinusAcc, AccBuf, true ) == true )
              v_oborot_minus = abs(DL_GetRestAccount( AccBuf.rec, IIF(date(CloseDate) <= Date(EndDate), date(CloseDate), Date(EndDate)) ));   
           end;
        end;
     end;                                     
  END; 
 
  /*__________________________*/            
  PRIVATE MACRO Create()
  
     VAR DataQuery, DataQuery1, DQ1, DQ2, TR1, TR2;
     VAR cmd, cmd1;
     VAR SUMM_SUM;
     var s0 = 0, s1 = 0, s2 = 0, s3 = 0, s4 = 0, s5 = 0, s6 = 0;
     var DataQueryTransfer;
       
     DataQuery = " SELECT /*+FIRST_ROWS*/ "+
                 "        t.t_code DealCode, "+
                 "         DVKindNA.t_szNameAlg AS DealKind, "+
                 "         DECODE (t.t_sector, CHR(88), 'Биржевая', 'Внебиржевая') DealType, "+ /*PNV 508083*/
                 "         Contractor.t_ShortName Contractor, "+
                 "         t.t_Contractor ContrPartyID, "+
                 "         DECODE (Contractor.t_legalform,  1, 'ЮЛ',  2, 'ФЛ') ContrForm, "+
                 "         TO_CHAR (t.t_date, 'dd.mm.yyyy') OpenDate, "+
                 "         TO_CHAR (nFI.t_ExecDate, 'dd.mm.yyyy') ExecDate1, "+
                 "         NVL (TO_CHAR (nFI_2.t_ExecDate, 'dd.mm.yyyy'), '01.01.0001') ExecDate2, "+
                 "         NVL (TO_CHAR (nFI_2.t_PayDate, 'dd.mm.yyyy'), '01.01.0001') PayDate2, "+
                 "         NVL (TO_CHAR (nFI_2.t_SuplDate, 'dd.mm.yyyy'), '01.01.0001') SuplDate2, "+
                 "         t.*, "+
                 "         /*nFI.t_Type*/-1 as nFIType, " /*PNV 508083*/
                 "         case when t.T_TYPE = 1 or (t.T_TYPE = 5 and nFI.T_TYPE = 0) or (t.T_TYPE = 6 and nFI.T_TYPE = 2) then 'X' else chr(0) end IsBuy, "
                 "         NVL (TO_CHAR (nFI.t_PayDate, 'dd.mm.yyyy'), '01.01.0001') PayDate1, "+
                 "         NVL (TO_CHAR (nFI.t_SuplDate, 'dd.mm.yyyy'), '01.01.0001') SuplDate1, "+
                 "         NVL (TO_CHAR (nFI.t_EXPIRYDATE, 'dd.mm.yyyy'), '01.01.0001') EXPIRYDATE, "+
                 "         Client.t_ShortName Client, "+
                 "         MarketKindNA.t_szNameAlg AS Market, "+
                 "         PeriodClsNA.t_szNameAlg AS Period, "+
                 "         nFI.t_FIID, "+
                 "         nFI.t_StdFIID, "+
                 "         nFI.t_Amount, "+
                 "         nFI.t_Price, "+
                 "         nFI.t_Point, "+
                 "         nFI.t_fiid fi1_fi, "+
                 "         nFI.t_pricefiid fi1_pricefi, "+
                 "         NVL (nFI.t_cost, 0) fi1_cost, "+
                 "         NVL (nFI.t_amount, 0) fi1_amount, "+
                 "         NVL (nFI_2.t_fiid, -1) fi2_fi, "+
                 "         NVL (nFI_2.t_cost, 0) fi2_cost, "+
                 "         NVL (nFI_2.t_amount, 0) fi2_amount, "+
                 "         NVL (nFI_2.t_pricefiid, -1) fi2_pricefi, "+
                 "         nFI.t_OpenDate, "+
                 "         GenAgr.t_Code, "+
                 "         (    SELECT DISTINCT t_codelat3 "+
                 "                FROM dcountry_dbt cou "+
                 "               WHERE     t_parentcountryid = 0 "+ 
                 "                     AND cou.t_codelat3 = contractor.t_nrcountry "+
                 "          CONNECT BY cou.t_countryid = PRIOR cou.t_parentcountryid) ContrCou, "+
                 "  (select t_fi_kind from dfininstr_dbt where t_fiid = nFI.t_fiid ) fi_kind "+
                 "    FROM ddvndeal_dbt t, "+
                 "         dparty_dbt Client, "+
                 "         dparty_dbt Contractor, "+
                 "         dnamealg_dbt DVKindNA, "+
                 "         ddl_genagr_dbt GenAgr, "+
                 "         dnamealg_dbt MarketKindNA, "+
                 "         ddvnfi_dbt nFI, "+
                 "         ddvnfi_dbt nFI_2, "+
                 "         dnamealg_dbt PeriodClsNA, "+
                 "         dfininstr_dbt fiin "+
                 "   WHERE     (   (nFI.t_ExecDate BETWEEN " + GetSQLDate( BeginDate ) + 
                 "                                     AND " + GetSQLDate( EndDate ) + ") "+
                 "              OR (nFI_2.t_ExecDate BETWEEN " + GetSQLDate( BeginDate ) + 
                 "                                       AND " + GetSQLDate( EndDate ) + ")) "+
                 "         AND (    Client.t_PartyID(+) = t.t_Client "+
                 "              AND Contractor.t_PartyID(+) = t.t_Contractor "+
                 "              AND DVKindNA.t_iTypeAlg(+) = 7010 "+
                 "              AND DVKindNA.t_iNumberAlg(+) = t.t_DVKind "+
                 "              AND fiin.t_fiid = nFI.t_fiid "+
                 "              AND MarketKindNA.t_iTypeAlg(+) = 7039 "+
                 "              AND MarketKindNA.t_iNumberAlg(+) = t.t_MarketKind "+
                 "              AND PeriodClsNA.t_iTypeAlg(+) = 7038 "+
                 "              AND PeriodClsNA.t_iNumberAlg(+) = t.t_PeriodCls "+
                 "              AND nFI.t_DealID(+) = t.t_ID "+
                 "              AND nFI.t_Type(+) = 0 "+
                 "              AND nFI_2.t_DealID(+) = t.t_ID "+
                 "              AND nFI_2.t_Type(+) = 2 "+
                 "              AND GenAgr.t_GenAgrID(+) = t.t_GenAgrID) "+
                 "         AND t.t_MarketKind <> 1 "+
                 "         AND t.t_client = -1 "+
                 "         AND t.t_state > 0 "+
                 "         AND Contractor.t_notresident = CHR (88) "+
                 "         AND t.t_ispfi = CHR (88) "+
                 "         AND fiin.t_fi_kind <> 2 "+
                 " ORDER BY t.t_code, "+
                 "          t.t_date, "+
                 "          t.t_time, "+
                 "          t.t_id ";


DataQueryTransfer = " SELECT /*+FIRST_ROWS*/ "+
                    "      t.t_code DealCode, "+
                    "       DVKindNA.t_szNameAlg AS DealKind, "+
                    "       DECODE (t.t_sector, CHR(88), 'Биржевая', 'Внебиржевая') DealType, "+   /*PNV 508083*/
                    "       Contractor.t_ShortName Contractor, "+
                    "       t.t_Contractor ContrPartyID, "+
                    "       DECODE (Contractor.t_legalform,  1, 'ЮЛ',  2, 'ФЛ') ContrForm, "+
                    "       TO_CHAR (t.t_date, 'dd.mm.yyyy') OpenDate, "+
                    "       TO_CHAR (nFI.t_ExecDate, 'dd.mm.yyyy') ExecDate1, "+
                    "       case when nFI.t_Type =2 then NVL (TO_CHAR (nFI.t_ExecDate, 'dd.mm.yyyy'), '01.01.0001') else TO_CHAR('01.01.0001') end ExecDate2, "+ /*pnv 504734*/
                    "       case when nFI.t_Type =2 then NVL (TO_CHAR (nFI.t_PayDate, 'dd.mm.yyyy'), '01.01.0001') else TO_CHAR('01.01.0001') end PayDate2, "+ /*pnv 504734*/
                    "       case when nFI.t_Type =2 then NVL (TO_CHAR (nFI.t_SuplDate, 'dd.mm.yyyy'), '01.01.0001') else TO_CHAR('01.01.0001') end SuplDate2, "+ /*pnv 504734*/
                    "       case when NVL((select count(1) from ddvnfi_dbt nFI2 where nFI2.t_DealID = t.t_ID), 0) = 2 and t.T_DVKIND in (3,4) then nFI.t_Type else -1 end nFIType, "+
                    "       case when t.T_TYPE = 1 or (t.T_TYPE = 5 and nFI.T_TYPE = 0) or (t.T_TYPE = 6 and nFI.T_TYPE = 2) then 'X' else chr(0) end IsBuy, "
                    "       t.*, "+
                    "       NVL (TO_CHAR (nFI.t_PayDate, 'dd.mm.yyyy'), '01.01.0001') PayDate1, "+
                    "       NVL (TO_CHAR (nFI.t_SuplDate, 'dd.mm.yyyy'), '01.01.0001') SuplDate1, "+
                    "       NVL (TO_CHAR (nFI.t_EXPIRYDATE, 'dd.mm.yyyy'), '01.01.0001') EXPIRYDATE, "+
                    "       Client.t_ShortName Client, "+
                    "       MarketKindNA.t_szNameAlg AS Market, "+
                    "       PeriodClsNA.t_szNameAlg AS Period, "+
                    "       nFI.t_FIID, "+
                    "       nFI.t_StdFIID, "+
                    "       nFI.t_Amount, "+
                    "       nFI.t_Price, "+
                    "       nFI.t_Point, "+
                    "       nFI.t_fiid fi1_fi, "+
                    "       nFI.t_pricefiid fi1_pricefi, "+
                    "       NVL (nFI.t_cost, 0) fi1_cost, "+
                    "       NVL (nFI.t_amount, 0) fi1_amount, "+
                    "       NVL (nFI.t_fiid, -1) fi2_fi, "+ /*pnv 504734*/
                    "       NVL (nFI.t_cost, 0) fi2_cost, "+ /*pnv 504734*/
                    "       NVL (nFI.t_amount, 0) fi2_amount, "+ /*pnv 504734*/
                    "       NVL (nFI.t_pricefiid, -1) fi2_pricefi, "+ /*pnv 504734*/
                    "       nFI.t_OpenDate, "+
                    "       GenAgr.t_Code, "+
                    "       (SELECT DISTINCT t_codelat3 "+
                    "              FROM dcountry_dbt cou "+
                    "             WHERE     t_parentcountryid = 0  "+
                    "                   AND cou.t_codelat3 = contractor.t_nrcountry "+
                    "        CONNECT BY cou.t_countryid = PRIOR cou.t_parentcountryid) ContrCou, "+
                    "  (select t_fi_kind from dfininstr_dbt where t_fiid = nFI.t_fiid ) fi_kind "+
                    "  FROM ddvndeal_dbt t, "+
                    "       dparty_dbt Client, "+
                    "       dparty_dbt Contractor, "+
                    "       dnamealg_dbt DVKindNA, "+
                    "       ddl_genagr_dbt GenAgr, "+
                    "       dnamealg_dbt MarketKindNA, "+
                    "       ddvnfi_dbt nFI, "+                    
                    "       dnamealg_dbt PeriodClsNA, "+
                    "       dfininstr_dbt fiin, "+
                    "       doproper_dbt oper "+
                    " WHERE     oper.t_dockind = t.t_dockind "+
                    "       AND oper.t_documentid = LPAD (t.t_id, 34, '0') "+
                    "       AND (    Client.t_PartyID(+) = t.t_Client "+
                    "            AND Contractor.t_PartyID(+) = t.t_Contractor "+
                    "            AND DVKindNA.t_iTypeAlg(+) = 7010 "+
                    "            AND DVKindNA.t_iNumberAlg(+) = t.t_DVKind "+
                    "            AND fiin.t_fiid = nFI.t_fiid "+
                    "            AND MarketKindNA.t_iTypeAlg (+) = 7039 "+
                    "            AND MarketKindNA.t_iNumberAlg(+) = t.t_MarketKind "+
                    "            AND PeriodClsNA.t_iTypeAlg(+) = 7038 "+
                    "            AND PeriodClsNA.t_iNumberAlg(+) = t.t_PeriodCls "+
                    "            AND nFI.t_DealID(+) = t.t_ID "+
                    "            AND nFI.t_Type(+) in (0, 2) "+ /*pnv 504734*/
                    "            AND GenAgr.t_GenAgrID(+) = t.t_GenAgrID) "+
                    "       AND t.t_MarketKind <> 1 "+
                    "       AND t.t_state > 0 "+
                    "       AND t.t_ispfi = CHR (88) "+
                    "       AND t_client = -1 "+
                    "       AND EXISTS "+
                    "              (SELECT 1 "+
                    "                 FROM ddvnfi_dbt "+
                    "                WHERE     t_dealid = t.t_id "+
                    "                      AND EXISTS "+
                    "                             (SELECT 1 "+
                    "                                FROM dfininstr_dbt "+
                    "                               WHERE     t_fiid = ddvnfi_dbt.t_fiid "+
                    "                                     AND t_fi_kind IN (1, 6, 3, 7))) "+ /*PNV 523103*/
                    "       AND t.t_dvkind IN (1 /*форвард*/, 2 /*опцион*/, 3 /*валютный своп*/, 4 /*процентный своп*/, 5 /*покупка/продаэа Т+3*/, 6 /*СВОП*/) "+
                    "       AND t_date <= " + GetSQLDate (EndDate) + " and ( oper.t_end_date = TO_DATE ('01010001', 'ddmmyyyy') "+
                    "                  OR oper.t_end_date > "  + GetSQLDate (EndDate) + ") "+
                    "       AND (   t_sector = 'X' "+
                    "            OR EXISTS "+
                    "                  (SELECT 1 "+
                    "                     FROM doprstep_dbt "+
                    "                    WHERE     t_kind_action = 110 "+
                    "                          AND t_id_operation = oper.t_id_operation "+
                    "                          AND t_isexecute = 'X' "+
                    "                          AND t_fact_date <= 1 + " + GetSQLDate (EndDate) + ")) " + 
                    "       AND CASE "+
                    "              WHEN t_dvkind IN (3, 6) "+
                    "              THEN "+
                    "                 GREATEST (nFI.t_execdate, nFI.t_supldate) "+ /*pnv 504734*/
                    "              ELSE "+
                    "                 (SELECT t_execdate "+
                    "                    FROM ddvnfi_dbt "+
                    "                   WHERE     t_dealid = t.t_id "+
                    "                         AND t_type = 0 "+
                    "                         AND t_opendate = CHR (0)) "+
                    "           END > "  + GetSQLDate (EndDate) + 
                    " ORDER BY t.t_id, NFI.T_ID "; /*pnv 504734*/

     ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
     ProgressValue.Maximum = ProgressValue.Maximum + SQL_GetNRecs( DataQueryTransfer );
     ProgressValue.Current = 0;    
     var ProgressIndicator = CreateProgressIndicator(m_IsWebService);
     
     if( m_IsWebService and (WebMenuItem != null) )
       var header = "Формирование отчета " + WebMenuItem.szNameItem;
       ProgressIndicator.Start(ProgressValue.Maximum, header, header);
     else
       ProgressIndicator.Start(ProgressValue.Maximum,"\"Сделки ПФИ, кроме сделок с ценными бумагами\"" , HTML_StSheetName);
     end;
     cmd = RSDCommand( DataQuery );
     RS = TRsbDataSet( cmd );

     while( RS.MoveNext() )
          /*PNV 504734*/
            if ( (RS.dvkind == 2) and (RS.CHANGEDATE < date(BeginDate)) and (RS.CHANGEDATE > date(RS.BeginDate))  )
                continue;
            end;
         /*PNV 504734*/
            if ((date(CloseDate) >= date(BeginDate)) and (date(CloseDate) <= date(EndDate)))
                 //OPT;
                 GetAccPFI;
                 FindAcc( RS.ID, RS.nFIType, RS.IsBuy, v_tr_fi, v_ob_fi, EndDate, RS.KIND, Date(RS.EXECDATE1) );
                 OPT;
                 s0 = s0 + trAmount;
                 s1 = s1 + ObAmount;
                 s2 = s2 + PromSum1;
                 s3 = s3 + PromSum2;
                 s4 = s4 + PromSum3;
                 s5 = s5 + rate2;
                 s6 = s6 + rate3;

                 m_IsDataExist = true;
                 PrintLine( /*1 */     DealNom,                     
                            /*2 */     DealKind,                      
                            /*3 */     DealType,                     
                            /*4 */     FiKind,                     
                            /*5 */     Contractor,      
                            /*6 */     ContrCou,                   
                            /*7 */     ContrType,                     
                            /*8 */     OpenDate,                    
                            /*9 */     CloseDate,       
                            /*10*/     TrAcc,                         
                            /*11*/     TrVal,                     
                            /*12*/     TrAmount,                    
                            /*13*/     ObAcc,                       
                            /*14*/     ObVal,                       
                            /*15*/     ObAmount,        
                            /*16*/     PromSum1,        
                            /*17*/     PromSum2,        
                            /*18*/     BreakDate,                    
                            /*19*/     PromSum3,
                            /*20*/     Rate1,                    
                            /*21*/     Rate2,                    
                            /*22*/     Rate3
                           );                              
            end;
            ProgressValue.Current = ProgressValue.Current + 1;
            ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;

     PrintLine( "","","","","","","","","","","","","","","","","","","","","","");
     PrintLine( "","","","","","","","","","","","","","","","","","","","","","");

     cmd = RSDCommand( DataQueryTransfer );
     RS = TRsbDataSet( cmd );
     while( RS.MoveNext() )
            FindAcc( RS.ID, RS.nFIType, RS.IsBuy, v_tr_fi, v_ob_fi, EndDate, RS.KIND, Date(RS.EXECDATE1) );
            GetAccPFI;
            OPT;
          /*pnv 504734*/
            if ( (RS.dvkind == 4) and (RS.kind == 22720) and (RS.nFIType == 2) ) /*проц.своп и 2 часть*/
                continue;
            end;
          /*pnv 504734*/
            s0 = s0 + trAmount;
            s1 = s1 + ObAmount;
            s2 = s2 + PromSum1;
            s3 = s3 + PromSum2;
            s4 = s4 + PromSum3;
            s5 = s5 + rate2;
            s6 = s6 + rate3;

            m_IsDataExist = true;
            PrintLine(   /*1 */     DealNom,                     
                         /*2 */     DealKind,                      
                         /*3 */     DealType,                     
                         /*4 */     FiKind,                     
                         /*5 */     Contractor,      
                         /*6 */     ContrCou,                   
                         /*7 */     ContrType,                     
                         /*8 */     OpenDate,                    
                         /*9 */     CloseDate,       
                         /*10*/     TrAcc,                         
                         /*11*/     TrVal,                     
                         /*12*/     TrAmount,                    
                         /*13*/     ObAcc,                       
                         /*14*/     ObVal,                       
                         /*15*/     ObAmount,        
                         /*16*/     PromSum1,        
                         /*17*/     PromSum2,        
                         /*18*/     BreakDate,                    
                         /*19*/     PromSum3,
                         /*20*/     Rate1,                    
                         /*21*/     Rate2,                    
                         /*22*/     Rate3
                     );                              

            ProgressValue.Current = ProgressValue.Current + 1;
            ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum);
     end;

     PrintLine( "", "", "", "", "", "", "", "", "", "", "", s0, "", "", s1, s2, s3, "", s4, "", s5, s6);
     ProgressIndicator.Stop();

  END;
  
  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  OD1_Form = DL_OD1_Panel();
  stat = OD1_Form.Run();

  if( stat )
      OD1_Report = SP_OD1_Report( null, "Report_401_3.xls", null, IsWebService, ReportHashCode );
      OD1_Report.Run();

      Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

  return FullReportFileNames;
END;
