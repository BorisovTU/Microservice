/*
$Name:        InvSh020.mac
$Module:      Ценные бумаги
$Description: Операция получения паев. Шаг актуализации счетов
*/
import InsCarryDoc, "sp_class.mac", "sp_car.mac";

macro ExecuteStep( doc, FDoc)

  record deal(dl_tick);
  var    FD, dat;

  SetBuff ( deal, FDoc );
  FD = SPFirstDoc( deal );
  dat = FD.DateArray[DATE_DEALDATE];

  if( not IsClientDeal(deal) ) /*собственные сделки */
     var Categ:string = "";
     if( FD.ТипПортфеля() == KINDPORT_CONTR )
        Categ = "Наш портфель ПКУ, ц/б";
     else
        Categ = "Наш портфель ц/б";
     end;

     if( (not FD.OpenAccount( Categ, null, null, GetFIRoleByPortfolio(FD.ТипПортфеля()), null, dat) ) OR
         (not FD.OpenAccount( "+НДС", null, null, null, null, dat )) OR
         (not FD.OpenAccount( "+Расчеты", null, null, null, null, dat )) 
       )
        return 1;
     end;
  else
     if( (not FD.OpenAccount( "+КВ, ц/б", null, null, null, null, dat ) ) OR
         (not FD.OpenAccount( "-НДС", null, null, null, null, dat ))
       )
        return 1;             
     end; 
  end; 

   /*статус лота меняем на инициализирован*/
  if(FD.tick.rec.ClientID == -1)
     if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_CREATE, dat, FD ) )
        msgbox("Ошибка при изменении статуса лота");
        return 1;
     end;  
  end;  

  /*статус лота меняем на запланирован*/
  if( not ОбновитьСтатусЧастиСделки( FD.dl_leg, DL_LEG_PLANE) )
     msgbox("Ошибка при изменении статуса лота");
     return 1;
  end;                   

  return 0; 
end;
