/*
$Name:              shrep_reg2014_report.mac
$Module:            АРНУ
$Description:       Отчет "Регистры коротких позиций 611,612,615"
*/

IMPORT "ShRep_Reg2014_Form.mac", "RegistrReport.mac", "ws_txreportform.mac";

/*Здесь можно через "," в апострофах указать код (FININSTR.FI_Code) ценных бумаг, которые будут исключаться из отчета.
  Например: 
    ИсключаемыеИзОтчетаЦБ = "'1','2','3'"
*/
PRIVATE CONST ИсключаемыеИзОтчетаЦБ = ""; 
PRIVATE CONST Строка_Итого          = 0,
              Строка_СтрокаДанных   = 1;

PRIVATE CONST SHEET_0611  = "0611";
PRIVATE CONST SHEET_0611s = "0611_Свод";
PRIVATE CONST SHEET_0612  = "0612";
PRIVATE CONST SHEET_0612s = "0612_Свод";
PRIVATE CONST SHEET_0615  = "0615";
PRIVATE CONST SHEET_0615s = "0615_Свод";

PRIVATE CONST BLUECOLOR = RGB(255,255,204);

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА = 26;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ = 27;

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_rshb = 13;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb = 14;

private const NoDataTxt = "ДАННЫХ НЕТ";

PRIVATE VAR   SecondStart = false; // признак второго старта по некотируемым, если галочка "некотируемые" не взведена

PRIVATE VAR   ShRepReg2014_Form;
PRIVATE VAR   ShRepReg2014_Report; 
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб
PRIVATE CONST ItogsLineName = "Всего:";

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

/*имена ячеек по столбцам*/
PRIVATE VAR  C_SumSvp  = "",
             C_CrSD    = "",        
             C_CrBD    = "",        
             C_SumBvp  = "",
             C_SumBrub = "",
             C_DifB    = "",
             C_ComS    = "",
             C_ComB    = "",
             C_NDSComS    = "",
             C_NDSComB    = "",
             C_SumBtax = "",
             C_AmortPozRub = "",
             C_AmortPozVN  = "",
             C_SumSRub = "",
             C_DifS    = "",
             C_RashAll =  "",
             C_TaxeAmort = "",
             C_TaxeNKD =  "",
             C_ProcRashRepRub = "",
             C_ProcRashRepRub1 = "",
             C_ProcRashRepRub2 = "",
             C_ProcRashAllRub = "",
             C_ProcRashPrevRub = "",
             C_FinRes  = "", 
             C_TaxeAll = "",
             C_Qnty    = "",
             C_SecCode = "",
             C_ISIN    = "",
             C_SecCode_2 = "",              
             C_NkdSvp    = "",
             C_NkdCloseVp= "",
             C_CoupVN    = "",
             C_CodeS     = "",
             C_NkdPrevVN = "",
             C_NomH01 = "",
             C_NomH02 = "";           
 
PRIVATE MACRO WhereCondBond()
  return " RSB_FIInstr.FI_AvrKindsEQ("+FIKIND_AVOIRISS+", "+AVOIRISSKIND_BOND+", FinInstr.t_AvoirKind) > 0 ";
END;

/*Процентной облигацией считается облигация, относящаяся к одной из следующих налоговых групп:*/
PRIVATE MACRO WhereCondPC()
  return WhereCondBond() + " AND Rsb_SCTX.TXIsPercentAvoir(av.t_TaxGroup) = 1 ";
END;

/*сделки с акциями, паями и депозитарными расписками*/
PRIVATE MACRO WhereCond611()
  return " FinInstr.t_AvoirKind IN (" + string(AVOIRISSKIND_EQUITY_SHARE)          + "," +
                                        string(AVOIRISSKIND_PREFERENCE_SHARE)      + "," +
                                        string(AVOIRISSKIND_PREFERENCE_CONV_SHARE) + "," +
                                        string(AVOIRISSKIND_DEPOSITORY_RECEIPT)    + "," +
                                        string(AVOIRISSKIND_INVESTMENT_SHARE) +
                                  ")"
END;

PRIVATE MACRO WhereCondNominalRUR()
  return " FinInstr.t_FaceValueFI = 0 ";
END;

PRIVATE MACRO GetNumTaxGroup(Name : string) : string
  var retval = "";
  var exec = RSDCommand( "select t_Element from dllvalues_dbt where t_List = 2903 and T_NAME = ? ");
      exec.addParam( "", RSDBP_IN, Name);
      exec.execute();

  var rs = TRsbDataSet( exec );
  if(rs.MoveNext())
    retval = string(SQL_ConvTypeInteger(rs.Element));
  end;
  return retval;
END;

private macro Oper_rshb():string
  var fio = GetPersnFIOByID(GetOperRecByID({oper}).PartyID);
  if(fio == "")
     return GetOperRecByID({oper}).Name;
  else
     return ConvetFIO_Report(fio);
  end;  
end;
 
PRIVATE CLASS ShortReg_611(Report:OBJECT) 
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;

  MACRO PaintStr()
    m_Report.SetCurrentLineFont( 8, true, false );
    m_Report.SetCellFont("N1_SumSrub", 8, true, false, null, null, DefaultBkGrColor );             
    m_Report.SetCellFont("N1_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
    m_Report.SetCellFont("N1_SumBtax", 8, true, false, null, null, DefaultBkGrColor ); 
    m_Report.SetCellFont("N1_RashAll", 8, true, false, null, null, DefaultBkGrColor );
    m_Report.SetCellFont("N1_DRS",8, true, false, null, null, BLUECOLOR );      
    m_Report.SetCellFont("N1_CrSD",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N1_CrSZ",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_Cr_Val_MrkSZ",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_DPS_DDS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_MinMrkt",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_Val_MarketS",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N1_MrktS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_DMrktS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_QuoteValueS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_RCS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_K_ControlS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_Control_CommentS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_ComS_Another",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_DRB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_CrBD",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_CrBZ",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_Cr_Val_MrktBZ",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_DPB_DDB",8, true, false, null, null, BLUECOLOR );
    m_Report.SetCellFont("N1_MaxMrkt",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_Val_MarketB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_MrktB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_DMrktB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N1_QuoteValueB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_RCB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_K_ControlB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_Control_CommentB",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N1_ComB_Another",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_DqualS",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_DqualB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_ContS",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_ContB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N1_SecType",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N1_TaxeAll",8, true, false, null, null, BLUECOLOR );             
    m_Report.SetCellFont("N1_FinRes", 8, true, false, null, null, BLUECOLOR ); 
  
  END;
  
  MACRO Where():STRING
     /*0611 отбираются сделки с акциями, паями и депозитарными расписками */
     return WhereCond611();
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );

     m_Report.PrintHeader_0611( "N1_", SHEET_0611, m_Report.GetNumSheet(), "" );
     m_Report.RegisterTable( "N1_MainTable", "N1_TableHeader",
                                 "N1_Dummy1",
                                 "N1_SecCode",
                                 "N1_SecName",
                                 "N1_CodeS",
                                 "N1_DZS",
                                 "N1_DDS",
                                 "N1_Qnty",
                                 "N1_VN",
                                 "N1_VPrS",
                                 "N1_PrSvp",
                                 "N1_SumSvp",
                                 "N1_SumSrub",
                                 "N1_DifS",
                                 "N1_CodeB",
                                 "N1_DZB",
                                 "N1_DDB",
                                 "N1_VPrB",
                                 "N1_PrBvp",
                                 "N1_SumBvp",
                                 "N1_SumBrub",
                                 "N1_DifB",
                                 "N1_SumBtax",
                                 "N1_ComS",
                                 "N1_ComB",
                                 "N1_NDSComS",
                                 "N1_NDSComB",
                                 "N1_RashAll",
                                 "N1_RFISSS",
                                 "N1_RFISSB",
                                 "N1_DRS",
                                 "N1_CrSD",
                                 "N1_CrSZ",
                                 "N1_Cr_Val_MrkSZ",
                                 "N1_DPS_DDS",
                                 "N1_MinMrkt",
                                 "N1_Val_MarketS",
                                 "N1_MrktS",
                                 "N1_DMrktS",
                                 "N1_QuoteValueS",
                                 "N1_RCS",
                                 "N1_K_ControlS",
                                 "N1_Control_CommentS",
                                 "N1_ComS_Another",
                                 "N1_DRB",
                                 "N1_CrBD",
                                 "N1_CrBZ",
                                 "N1_Cr_Val_MrktBZ",
                                 "N1_DPB_DDB",
                                 "N1_MaxMrkt",
                                 "N1_Val_MarketB",
                                 "N1_MrktB",
                                 "N1_DMrktB",
                                 "N1_QuoteValueB",
                                 "N1_RCB",
                                 "N1_K_ControlB",
                                 "N1_Control_CommentB",
                                 "N1_ComB_Another",
                                 "N1_DqualS",
                                 "N1_DqualB",
                                 "N1_ContS",
                                 "N1_ContB",
                                 "N1_SecType",
                                 "N1_TaxeAll",
                                 "N1_FinRes",
                                 "N1_ISIN"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                                "N1_Qnty",
                                "N1_SumSvp", 
                                "N1_SumSrub", 
                                "N1_DifS", 
                                "N1_SumBvp", 
                                "N1_SumBrub", 
                                "N1_DifB", 
                                "N1_SumBtax", 
                                "N1_ComS", 
                                "N1_ComB",
                                "N1_NDSComS", 
                                "N1_NDSComB",  
                                "N1_RashAll", 
                                "N1_DPS_DDS", 
                                "N1_DPB_DDB", 
                                "N1_TaxeAll", 
                                "N1_FinRes"     
                              ); 
                                 
     m_NoDataFlag = true;
     m_Report.SetCopyAutoSumRange("A7:BM7");
     
  END;

  macro EndReportNoData()
    this.PrintNoData();   
    m_Report.EndTable();
    m_Report.SetCopyAutoSumRange(null);
  end;

  macro EndReportWithData()
    m_Report.EndTable();
    m_Report.SetCopyAutoSumRange(null);
    m_Report.SetOnAutoFilter(SHEET_0611, "B13:BM13");
    m_Report.SetAutoSize();
  end;

  MACRO EndReport()
    if(m_NoDataFlag)
      EndReportNoData();
    else
      EndReportWithData();
    end;
  END;

   macro PrintNoData()
      m_Report.PrintTableLine( "N1_SecCode",  NoDataTxt, null );
   end;
  
/*
  MACRO ПечататьПромежуточныеИтоги()
     m_Report.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "F23",
                        "J23",     
                        "K23",        
                        "L23",        
                        "R23",     
                        "S23",        
                        "T23",     
                        "U23",        
                        "V23",     
                        "W23", 
                        "X23", 
                        "AE23",
                        "AS23",
                        "BH23",
                        "BI23"
                    );
  END;
*/
  MACRO Print()
     m_NoDataFlag = false;
     m_Report.SetCurrentStrNumber();
      
     m_Report.PrintTableLine(
    
          /* 1   */       "N1_SecCode",            m_Report.SecCode(),          null,                    
          /* 2   */       "N1_SecName",            m_Report.SecName(),          null,                    
          /* 3   */       "N1_CodeS",              m_Report.CodeS(),            null,                    
          /* 4   */       "N1_DZS",                m_Report.DZS(),              null,                    
          /* 5   */       "N1_DDS",                m_Report.DDS(),              null,                    
          /* 6   */       "N1_Qnty",               m_Report.printQnty(),         null,                   
          /* 7   */       "N1_VN",                 IIF(m_Report.AvoirKind() == AVOIRISSKIND_DEPOSITORY_RECEIPT,"", m_Report.VN()),   null,                   
          /* 8   */       "N1_VPrS",               m_Report.VPrSNumber(),       null,                                 
          /* 9   */       "N1_PrSvp",              m_Report.printPrSvp(),       null,
          /* 10  */       "N1_SumSvp",             m_Report.SumSvp(),           null,                                  
          /* 11  */       "N1_SumSrub",            m_Report.SumSrub(),          null,/*ф-ла*/                                  
          /* 12  */       "N1_DifS",               m_Report.DifS(),             null,                   
          /* 13  */       "N1_CodeB",              m_Report.CodeB(),            null,
          /* 14  */       "N1_DZB",                m_Report.DZB(),              null,
          /* 15  */       "N1_DDB",                m_Report.DDB(),              null,
          /* 16  */       "N1_VPrB",               m_Report.VPrBNumber(),       null,                                  
          /* 17  */       "N1_PrBvp",              m_Report.printPrBvp(),       null,
          /* 18  */       "N1_SumBvp",             m_Report.SumBvp(),           null,                       
          /* 19  */       "N1_SumBrub",            m_Report.SumBrub(),          null,/*ф-ла*/                                  
          /* 20  */       "N1_DifB",               m_Report.DifB(),             null,
          /* 21  */       "N1_SumBtax",            m_Report.SumBtax(),          null,
          /* 22  */       "N1_ComS",               m_Report.ComS(),             null,
          /* 23  */       "N1_ComB",               m_Report.ComB(),             null,
          /* 22.1  */     "N1_NDSComS",            m_Report.NDSComS(),          null,
          /* 23.2  */     "N1_NDSComB",            m_Report.NDSComB(),          null,
          /* 24  */       "N1_RashAll",            m_Report.RashAll(),          null,/*ф-ла*/                   
          /* 25  */       "N1_RFISSS",             m_Report.RFISSS(),           null,
          /* 26  */       "N1_RFISSB",             m_Report.RFISSB(),           null,
          /* S1  */       "N1_DRS",                m_Report.DRS(),              null,
          /* S2  */       "N1_CrSD",               m_Report.printCrSD_F(),      null,
          /* S3  */       "N1_CrSZ",               m_Report.printCrSZ_F(),       null,
          /* S4  */       "N1_Cr_Val_MrkSZ",       m_Report.printCr_Val_MrkSZ(),null,                  
          /* S5  */       "N1_DPS_DDS",            m_Report.DPS_DDS(),          null,
          /* S6  */       "N1_MinMrkt",            m_Report.printMinMrkt(),     null,
          /* S7  */       "N1_Val_MarketS",        m_Report.Val_MarketS(),      null,
          /* S8  */       "N1_MrktS",              m_Report.MrktS(),            null,
          /* S9  */       "N1_DMrktS",             m_Report.DMrktS(),           null,
          /* S10 */       "N1_QuoteValueS",        m_Report.printQuoteValueS(), null,         
          /* S11 */       "N1_RCS",                m_Report.RCS(),              null,
          /* S12 */       "N1_K_ControlS",         m_Report.K_ControlS(),       null,
          /* S13 */       "N1_Control_CommentS",   m_Report.Control_CommentS(), null,
          /* S14 */       "N1_ComS_Another",       m_Report.ComS_AnotherDU(),   null,
          /* B1  */       "N1_DRB",                m_Report.DRB(),              null,
          /* B2  */       "N1_CrBD",               m_Report.printCrBD_F(),      null,
          /* B3  */       "N1_CrBZ",               m_Report.printCrBZ_F(),       null,
          /* B4  */       "N1_Cr_Val_MrktBZ",      m_Report.printCr_Val_MrktBZ(),null,
          /* B5  */       "N1_DPB_DDB",            m_Report.DPB_DDB(),          null,
          /* B6  */       "N1_MaxMrkt",            m_Report.printMaxMrkt(),     null,
          /* B7  */       "N1_Val_MarketB",        m_Report.Val_MarketB(),      null,
          /* B8  */       "N1_MrktB",              m_Report.MrktB(),            null,   
          /* B9  */       "N1_DMrktB",             m_Report.DMrktB(),           null,
          /* B10 */       "N1_QuoteValueB",        m_Report.printQuoteValueB(), null,
          /* B11 */       "N1_RCB",                m_Report.RCB(),              null,
          /* B12 */       "N1_K_ControlB",         m_Report.K_ControlB(),       null,
          /* B13 */       "N1_Control_CommentB",   m_Report.Control_CommentB(), null,
          /* B14 */       "N1_ComB_Another",       m_Report.ComB_AnotherDU(),   null,
          /* Т1  */       "N1_DqualS",             m_Report.DqualS(),           null,
          /* Т2  */       "N1_DqualB",             m_Report.DqualB(),           null,
          /* Т3  */       "N1_ContS",              m_Report.ContS(),            null,
          /* Т4  */       "N1_ContB",              m_Report.ContB(),            null,
          /* Т5  */       "N1_SecType",            m_Report.SecType(),          null,
          /* Т6  */       "N1_TaxeAll",            m_Report.TaxeAll(),          null,/*ф-ла*/
          /* V1  */       "N1_FinRes",             m_Report.FinRes(),           null,/*ф-ла */ 
          /* R1  */       "N1_ISIN",               m_Report.ISIN(),             null
                 );
   END;
END;
 /*сводная вкладка 611*/
PRIVATE CLASS ShortReg_611_Cons( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()

     m_Report.SetActiveSheet( m_Report.GetNumSheet_cons() );

     m_Report.PrintHeader_cons( "N11_", "611", m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N11_MainTable", "N11_TableHeader",
                   /* a */   "N11_RegNum",    
                   /* b */   "N11_SecType",   
                   /* c */   "N11_SecCode",
                   /* 1 */   "N11_SecName",   
                   /* 2 */   "N11_FinRes",   
                   /* 3 */   "N11_DifB",      
                   /* 4 */   "N11_DifS",      
                   /* 5 */   "N11_ComS_ComB", 
                   /* 6 */   "N11_TaxeAll",  
                   /* 7 */   "N11_TaxeAll_2",
                   /* 8 */   "N11_TaxeAll_3",
                   /* 9 */   "N11_Qnty",      
                   /* 10*/   "N11_SumSrub",   
                   /* 11*/   "N11_RashAll",   
                   /* 12*/   "N11_SumSvp",    
                   /* 13*/   "N11_SumBvp",
                   /* d */   "N11_ISIN"
                           );


     m_Report.SetCellAutoSumma( ItogsLineName,
                                "N11_FinRes",   
                                "N11_DifB",      
                                "N11_DifS",      
                                "N11_ComS_ComB", 
                                "N11_TaxeAll",  
                                "N11_TaxeAll_2",
                                "N11_TaxeAll_3",
                                "N11_Qnty",      
                                "N11_SumSrub",   
                                "N11_RashAll",   
                                "N11_SumSvp",    
                                "N11_SumBvp"     
                              );

     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N11_RegNum",   "611",         null,
                              "N11_SecType",  IIF(StrUpr(m_Report.H0_9())=="ВСЕ","",GetNumTaxGroup(m_Report.H0_9())), null,
                              "N11_SecCode",  m_Report.GetCCons(), null,
                              "N11_SecName",  ItogsLineName, null );
     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N11_SecName",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     //this.ПечататьПромежуточныеИтоги();
     /*подошвы для сводной нет*/
  END;

/*
  MACRO ПечататьПромежуточныеИтоги()
     m_Report.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",     
                        "H22",     
                        "I22",     
                        "J22",     
                        "K22",        
                        "L22",        
                        "M22",     
                        "N22",        
                        "O22",     
                        "P22"
                    );
  END;
*/
  MACRO Print(TaxGroup,FI_Code:string,Name:string,ISIN:string)

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine( 
                             "N11_RegNum",      "611",                                                   null,
                             "N11_SecType",     TaxGroup,                                                null,
                             "N11_SecCode",     FI_Code,                                                 null,
                             "N11_SecName",     Name,                                                    null,
                             "N11_FinRes",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_FinRes),       null,                                               
                             "N11_DifB",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifB),         null,                                               
                             "N11_DifS",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifS),         null,                                               
                             "N11_ComS_ComB",   m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_ComS, NULL, NULL, C_ComB, NULL, NULL),null,                                              
                             "N11_TaxeAll",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeAll),      null,                                               
                             "N11_TaxeAll_2",   m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeAll),      null,
                             "N11_TaxeAll_3",   "",                                                      null,/*не заполняется пока*/                                               
                             "N11_Qnty",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Qnty),         null,                                               
                             "N11_SumSrub",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSrub),      null,                                               
                             "N11_RashAll",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_RashAll),      null,                                                
                             "N11_SumSvp",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSvp),       null,
                             "N11_SumBvp",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumBvp),       null,
                             "N11_ISIN",        ISIN,                                                    null
                            );
  end;

END;



PRIVATE CLASS ShortReg_612( Report:OBJECT )
  VAR m_Report = Report;

  MACRO QntyPrecision():INTEGER //  точность кол-ва
     return m_Report.SumPrecision;
  END;

  MACRO PaintStr()
    m_Report.SetCurrentLineFont( 8, true, false );
    m_Report.SetCellFont("N2_SumSrub", 8, true, false, null, null, DefaultBkGrColor );             
    m_Report.SetCellFont("N2_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
    m_Report.SetCellFont("N2_SumBtax", 8, true, false, null, null, DefaultBkGrColor ); 
    m_Report.SetCellFont("N2_RashAll", 8, true, false, null, null, DefaultBkGrColor );
    m_Report.SetCellFont("N2_ProcRashRepRub", 8, true, false, null, null, DefaultBkGrColor );
    m_Report.SetCellFont("N2_DRS",8, true, false, null, null, BLUECOLOR );      
    m_Report.SetCellFont("N2_CrSD",8, true, false, null, null, BLUECOLOR );    
    m_Report.SetCellFont("N2_SumSvp",8, true, false, null, null, BLUECOLOR );     
    m_Report.SetCellFont("N2_MinMrkt",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_Val_MarketS",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N2_MrktS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_DMrktS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_QuoteValueS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_RCS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_K_ControlS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_Control_CommentS",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_ComS_Another",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_DRB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_CrBD",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_SumBvp",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_MaxMrkt",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_Val_MarketB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_MrktB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_DMrktB",8, true, false, null, null, BLUECOLOR );                     
    m_Report.SetCellFont("N2_QuoteValueB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_RCB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_K_ControlB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_Control_CommentB",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N2_ComB_Another",8, true, false, null, null, BLUECOLOR );
    m_Report.SetCellFont("N2_LastCoupDate",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_DqualS",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_DqualB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_ContS",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_ContB",8, true, false, null, null, BLUECOLOR );                                          
    m_Report.SetCellFont("N2_SecType",8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N2_TaxeAll",8, true, false, null, null, BLUECOLOR );             
    m_Report.SetCellFont("N2_TaxeAmort", 8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N2_TaxeNKD", 8, true, false, null, null, BLUECOLOR ); 
    m_Report.SetCellFont("N2_FinRes", 8, true, false, null, null, BLUECOLOR );
    m_Report.SetCellFont("N2_PlusNom_IN", 8, true, false, null, null, BLUECOLOR );
    m_Report.SetCellFont("N2_MinusNom_IN", 8, true, false, null, null, BLUECOLOR );
  END;

  MACRO Where():STRING
     /*0612 отбираются сделки с процентными облигациями, номинированными в рублях */
     return WhereCondNominalRUR() + " AND " + WhereCondPC();
  END;

  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );

     m_Report.PrintHeader( "N2_", "612", m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable(  "N2_MainTable", "N2_TableHeader",  
                              "N2_SecCode",
                              "N2_SecName",
                              "N2_CodeS",
                              "N2_DZS",
                              "N2_DDS",
                              "N2_Qnty",
                              "N2_PrSnom",
                              "N2_SumSrub",
                              "N2_NkdSvp",
                              "N2_DifS",
                              "N2_CodeB",
                              "N2_DZB",
                              "N2_DDB",
                              "N2_PrBnom",
                              "N2_SumBrub",
                              "N2_NkdCloseVp",
                              "N2_DifB",
                              "N2_SumBtax",
                              "N2_ComS",
                              "N2_ComB",
                              "N2_NDSComS",
                              "N2_NDSComB",
                              "N2_AmortPozVN",
                              "N2_RashAll",
                              "N2_NkdPrevVN",
                              "N2_CoupPrevVN",
                              "N2_CoupVN",
                              "N2_ProcRashAllRub",
                              "N2_ProcRashPrevRub",
                              "N2_ProcRashRepRub",
                              "N2_ProcRashRepRub1",
                              "N2_ProcRashRepRub2",
                              "N2_Nom_DDS",
                              "N2_Nom_DDB",
                              "N2_RFISSS",
                              "N2_RFISSB",
                              "N2_DRS",
                              "N2_CrSD",
                              "N2_SumSvp",
                              "N2_MinMrkt",
                              "N2_Val_MarketS",
                              "N2_MrktS",
                              "N2_DMrktS",
                              "N2_QuoteValueS",
                              "N2_RCS",
                              "N2_K_ControlS",
                              "N2_Control_CommentS",
                              "N2_ComS_Another",
                              "N2_DRB",
                              "N2_CrBD",
                              "N2_SumBvp",
                              "N2_MaxMrkt",
                              "N2_Val_MarketB",
                              "N2_MrktB",
                              "N2_DMrktB",
                              "N2_QuoteValueB",
                              "N2_RCB",
                              "N2_K_ControlB",
                              "N2_Control_CommentB",
                              "N2_ComB_Another",
                              "N2_LastCoupDate",
                              "N2_DqualS",
                              "N2_DqualB",
                              "N2_ContS",
                              "N2_ContB",
                              "N2_SecType",
                              "N2_TaxeAll",
                              "N2_TaxeAmort",
                              "N2_TaxeNKD",
                              "N2_FinRes",
                              "N2_Nom_H01",
                              "N2_Nom_H02",
                              "N2_PlusNom_IN",
                              "N2_MinusNom_IN",
                              "N2_Nom_IN_Before",
                              "N2_ISIN"  
                              
                        );

    m_Report.SetCellAutoSumma( ItogsLineName,
                               "N2_Qnty",
                               "N2_SumSrub",       
                               "N2_NkdSvp",        
                               "N2_DifS",  
                               "N2_SumBrub",       
                               "N2_NkdCloseVp",
                               "N2_DifB",          
                               "N2_SumBtax",     
                               "N2_ComS",  
                               "N2_ComB",
                               "N2_NDSComS",  
                               "N2_NDSComB",
                               "N2_AmortPozVN",       
                               "N2_RashAll",                            
                               "N2_NkdPrevVN",
                               "N2_CoupPrevVN",
                               "N2_CoupVN",                    
                               "N2_ProcRashAllRub",   
                               "N2_ProcRashPrevRub", 
                               "N2_ProcRashRepRub",
                               "N2_ProcRashRepRub1",
                               "N2_ProcRashRepRub2",
                               "N2_TaxeAll",      
                               "N2_TaxeAmort",    
                               "N2_TaxeNKD",      
                               "N2_FinRes",
                               "N2_PlusNom_IN",
                               "N2_MinusNom_IN",
                               "N2_Nom_IN_Before"
                             );

     this.PaintStr();
     m_Report.PrintTableLine( "N2_SecCode",  ItogsLineName, null );
     this.PaintStr();
     m_Report.PrintTableLine( "N2_SecCode:l",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     //this.ПечататьПромежуточныеИтоги();
     m_Report.AddStandardFooter_Reg2014( "N2_" );
  END;

/*
  MACRO ПечататьПромежуточныеИтоги()
     m_Report.SetSubTotalEx1( НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА, НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                             "F23",
                             "H23",
                             "I23",
                             "J23",
                             "O23",
                             "P23",
                             "Q23",
                             "R23",
                             "S23",
                             "T23",
                             "U23",
                             "V23",
                             "W23",
                             "X23",
                             "Y23",
                             "Z23",
                             "AA23",
                             "AB23",
                             "AC23",
                             "AD23",
                             "BM23",
                             "BN23",
                             "BO23",
                             "BP23",
                             "BS23",
                             "BT23",
                             "BU23"
                           );
  END;
*/
  MACRO Print()

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(
                 /* 1 */  "N2_SecCode",             m_Report.SecCode(),         null,
                 /* 2 */  "N2_SecName",             m_Report.SecName(),         null,
                 /* 3 */  "N2_CodeS",               m_Report.CodeS(),           null,
                 /* 4 */  "N2_DZS",                 m_Report.DZS(),             null,
                 /* 5 */  "N2_DDS",                 m_Report.DDS(),             null,
                 /* 6 */  "N2_Qnty",                m_Report.printQnty(),       null,                   
                 /* 7 */  "N2_PrSnom",              m_Report.printPrSNom(),     null,
                 /* 8 */  "N2_SumSrub",             m_Report.SumSrub(),         null,/*ф-ла*/
                 /* 9 */  "N2_NkdSvp",              m_Report.NkdSvp(),          null,
                 /* 10 */ "N2_DifS",                m_Report.DifS(),            null,
                 /* 11 */ "N2_CodeB",               m_Report.CodeB(),           null,
                 /* 12 */ "N2_DZB",                 m_Report.DZB(),             null,
                 /* 13 */ "N2_DDB",                 m_Report.DDB(),             null,
                 /* 14 */ "N2_PrBnom",              m_Report.printPrBnom(),     null,  
                 /* 15 */ "N2_SumBrub",             m_Report.SumBrub(),         null,/*ф-ла*/
                 /* 16 */ "N2_NkdCloseVp",          m_Report.NkdCloseVp(),      null,
                 /* 17 */ "N2_DifB",                m_Report.DifB(),            null,
                 /* 18 */ "N2_SumBtax",             m_Report.SumBtax(),         null,/*ф-ла*/
                 /* 19 */ "N2_ComS",                m_Report.ComS(),            null,
                 /* 20 */ "N2_ComB",                m_Report.ComB(),            null,
                 /* 19.1 */ "N2_ComS",              m_Report.NDSComS(),         null,
                 /* 20.1 */ "N2_ComB",              m_Report.NDSComB(),         null,
                 /* 21 */ "N2_AmortPozVN",          m_Report.AmortPozVN(),      null,
                 /* 22 */ "N2_RashAll",             m_Report.RashAll(),         null,/*ф-ла*/
                 /* 23 */ "N2_NkdPrevVN",           m_Report.NkdPrevVN(),       null,
                 /* 24 */ "N2_CoupPrevVN",          IIF(m_Report.DDS() < m_Report.H0_1(),m_Report.CoupPrevVN(), ""),     null,
                 /* 25 */ "N2_CoupVN",              m_Report.CoupVN(),          null,
                 /* 26 */ "N2_ProcRashAllRub",      m_Report.ProcRashAllRub(),  null,
                 /* 27 */ "N2_ProcRashPrevRub",     m_Report.ProcRashPrevRub(), null,
                 /* 28 */ "N2_ProcRashRepRub",      m_Report.ProcRashRepRub(),  null,/*ф-ла*/
               /* 28.1 */ "N2_ProcRashRepRub1",     m_Report.ProcRashRepRub1(), null,
               /* 28.2 */ "N2_ProcRashRepRub2",     m_Report.ProcRashRepRub2(), null,
                 /* 29 */ "N2_Nom_DDS",             m_Report.printNomS(),       null,
                 /* 30 */ "N2_Nom_DDB",             m_Report.printNomBDU(),     null,
                 /* 31 */ "N2_RFISSS",              m_Report.RFISSS(),          null,
                 /* 32 */ "N2_RFISSB",              m_Report.RFISSB(),          null,
                 /* S1 */ "N2_DRS",                 m_Report.DRS(),             null,
                 /* S2 */ "N2_CrSD",                m_Report.printCrSD_F(),     null,
                 /* S3 */ "N2_SumSvp",              m_Report.SumSvp(),          null,
                 /* S4 */ "N2_MinMrkt",             m_Report.printMinMrkt(),    null,
                 /* S5 */ "N2_Val_MarketS",         m_Report.Val_MarketS(),     null,
                 /* S6 */ "N2_MrktS",               m_Report.MrktS(),           null,
                 /* S7 */ "N2_DMrktS",              m_Report.DMrktS(),          null,
                 /* S8 */ "N2_QuoteValueS",         m_Report.printQuoteValueS(),null,
                 /* S9 */ "N2_RCS",                 m_Report.RCS(),             null,
                 /* S10*/ "N2_K_ControlS",          m_Report.K_ControlS(),      null,
                 /* S11*/ "N2_Control_CommentS",    m_Report.Control_CommentS(),null,
                 /* S12*/ "N2_ComS_Another",        m_Report.ComS_AnotherDU(),  null,
                 /* B1*/  "N2_DRB",                 m_Report.DRB(),             null,
                 /* B2*/  "N2_CrBD",                m_Report.printCrBD_F(),     null,
                 /* B3*/  "N2_SumBvp",              m_Report.SumBvp(),          null,
                 /* B4*/  "N2_MaxMrkt",             m_Report.printMaxMrkt(),    null,
                 /* B5*/  "N2_Val_MarketB",         m_Report.Val_MarketB(),     null,
                 /* B6*/  "N2_MrktB",               m_Report.MrktB(),           null,
                 /* B7*/  "N2_DMrktB",              m_Report.DMrktB(),          null,
                 /* B8*/  "N2_QuoteValueB",         m_Report.printQuoteValueB(),null,
                 /* B9*/  "N2_RCB",                 m_Report.RCB(),             null,
                 /* B10*/ "N2_K_ControlB",          m_Report.K_ControlB(),      null,
                 /* B11*/ "N2_Control_CommentB",    m_Report.Control_CommentB(),null,
                 /* B12*/ "N2_ComB_Another",        m_Report.ComB_AnotherDU(),  null,
                 /* К1 */ "N2_LastCoupDate",        IIF(m_Report.CoupCount() > 0, m_Report.LastCoupDate(),""),         null,  
                 /* T1 */ "N2_DqualS",              m_Report.DqualS(),          null,
                 /* T2 */ "N2_DqualB",              m_Report.DqualB(),          null,
                 /* T3 */ "N2_ContS",               m_Report.ContS(),           null,
                 /* T4 */ "N2_ContB",               m_Report.ContB(),           null,
                 /* T5 */ "N2_SecType",             m_Report.SecType(),         null,
                 /* T6 */ "N2_TaxeAll",             m_Report.TaxeAll(),         null,/*ф-ла*/
                 /* T7 */ "N2_TaxeAmort",           m_Report.TaxeAmort(),       null,/*ф-ла*/
                 /* T8 */ "N2_TaxeNKD",             m_Report.TaxeNKD(),         null,/*ф-ла*/
                 /* V1 */ "N2_FinRes",              m_Report.FinRes(),          null, /*ф-ла*/ 
                 /* Т9 */ "N2_Nom_H01",             iif(m_Report.TaxGroup() == 15, m_Report.Nom_H01(), null),              null,
                 /* Т10*/ "N2_Nom_H02",             iif(m_Report.TaxGroup() == 15, m_Report.Nom_H02(), null),              null,
                 /* Т11*/ "N2_PlusNom_IN",          iif(m_Report.TaxGroup() == 15, m_Report.PlusNom_IN(), null),           null,/*ф-ла*/
                 /* Т12*/ "N2_MinusNom_IN",         iif(m_Report.TaxGroup() == 15, m_Report.MinusNom_IN(), null),          null,/*ф-ла*/
                 /* Т13*/ "N2_Nom_IN_Before",       iif(m_Report.TaxGroup() == 15, m_Report.Nom_IN_Before(), null),        null,
                 /* R1 */ "N2_ISIN",                m_Report.ISIN(),             null
                       );                                                                  
  END;
  
END;

/*сводная вкладка 612*/
PRIVATE CLASS ShortReg_612_Cons( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()

     m_Report.SetActiveSheet( m_Report.GetNumSheet_cons() );

     m_Report.RegisterTable( "N21_MainTable", "N21_TableHeader",
                   /* a  */  "N21_RegNum",    
                   /* b  */  "N21_SecType",   
                   /* c  */  "N21_SecCode",
                   /* 1  */  "N21_SecName",   
                   /* 2  */  "N21_FinRes",
                   /* 3  */  "N21_DifB",   
                   /* 4  */  "N21_DifS",          
                   /* 5  */  "N21_ComS_ComB",    
                   /* 6  */  "N21_TaxeAll",     
                   /* 7  */  "N21_TaxeAmort",    
                   /* 8  */  "N21_TaxeNKD",      
                   /* 9  */  "N21_Qnty",          
                   /* 10 */  "N21_SumSRub",    
                   /* 11 */  "N21_RashAll",       
                   /* 12 */  "N21_SumSvp",        
                   /* 13 */  "N21_SumBvp",
                   /* 14 */  "N21_SumBvp_2",
                   /* 15 */  "N21_ProcRashRepRub1",
                   /* 16 */  "N21_ProcRashRepRub2",
                   /* 17 */  "N21_NkdSvp",        
                   /* 18 */  "N21_NkdCloseVp",        
                   /* 19 */  "N21_AmortPozVN",    
                   /* 20 */  "N21_CoupVN", 
                   /* 21 */  "N21_ProcRashPrevRub",
                   /* d  */  "N21_ISIN"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                   /* 2  */  "N21_FinRes",
                   /* 3  */  "N21_DifB",   
                   /* 4  */  "N21_DifS",          
                   /* 5  */  "N21_ComS_ComB",    
                   /* 6  */  "N21_TaxeAll",     
                   /* 7  */  "N21_TaxeAmort",    
                   /* 8  */  "N21_TaxeNKD",      
                   /* 9  */  "N21_Qnty",          
                   /* 10 */  "N21_SumSRub",    
                   /* 11 */  "N21_RashAll",       
                   /* 12 */  "N21_SumSvp",        
                   /* 13 */  "N21_SumBvp",   
                   /* 14 */  "N21_SumBvp_2",     
                   /* 15 */  "N21_ProcRashRepRub1",
                   /* 16 */  "N21_ProcRashRepRub2",
                   /* 17 */  "N21_NkdSvp",        
                   /* 18 */  "N21_NkdCloseVp",        
                   /* 19 */  "N21_AmortPozVN",    
                   /* 20 */  "N21_CoupVN", 
                   /* 21 */  "N21_ProcRashPrevRub"          
                              );

     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N21_RegNum",   "612",         null,
                              "N21_SecType",  IIF(StrUpr(m_Report.H0_9())=="ВСЕ","",GetNumTaxGroup(m_Report.H0_9())), null,
                              "N21_SecCode",  m_Report.GetCCons(), null,
                              "N21_SecName",  ItogsLineName, null );
     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N21_SecName",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     //this.ПечататьПромежуточныеИтоги();
     /*подошвы для сводной нет*/
  END;
/*
  MACRO ПечататьПромежуточныеИтоги()
     m_Report.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",     
                        "H22",     
                        "I22",     
                        "J22",     
                        "K22",        
                        "L22",        
                        "M22",     
                        "N22",        
                        "O22",     
                        "P22",
                        "Q22",
                        "R22",
                        "S22",
                        "T22",
                        "U22",
                        "V22",
                        "W22",
                        "X22"
                    );
  END;
*/
  MACRO Print( TaxGroup, FI_Code:string, Name:string, ISIN:string )

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine( 
                             "N21_RegNum",          "612",                                                  null,
                             "N21_SecType",         TaxGroup,                                               null,
                             "N21_SecCode",         FI_Code,                                                null,
                             "N21_SecName",         Name,                                                   null,
                             "N21_FinRes",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_FinRes),      null,
                             "N21_DifB",            m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifB),        null,
                             "N21_DifS",            m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifS),        null,
                             "N21_ComS_ComB",       m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_ComS, NULL, NULL, C_ComB, NULL, NULL), null,
                             "N21_TaxeAll",         m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeAll),     null,
                             "N21_TaxeAmort",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeAmort),   null,
                             "N21_TaxeNKD",         m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeNKD),     null,
                             "N21_Qnty",            m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Qnty),        null,
                             "N21_SumSRub",         m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSRub),     null,
                             "N21_RashAll",         m_Report.ФормулаПоВсемСделкамДляВыпуска(C_RashAll),     null,
                             "N21_SumSvp",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSvp),      null,
                             "N21_SumBvp",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumBvp),      null,
                             "N21_SumBvp_2",        "",                                                     null,
                             "N21_ProcRashRepRub1", m_Report.ФормулаПоВсемСделкамДляВыпуска(C_ProcRashRepRub1), null,
                             "N21_ProcRashRepRub2", m_Report.ФормулаПоВсемСделкамДляВыпуска(C_ProcRashRepRub2), null,
                             "N21_NkdSvp",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdSvp),          null,
                             "N21_NkdCloseVp",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdCloseVp),      null,
                             "N21_AmortPozVN",      m_Report.ФормулаПоВсемСделкамДляВыпуска(C_AmortPozVN),      null,
                             "N21_CoupVN",          m_Report.ТекстФормулыПоВсемСделкамДляВыпуска(C_CoupVN),null,
                             "N21_ProcRashPrevRub", m_Report.ФормулаПоВсемСделкамДляВыпуска(C_ProcRashPrevRub), null,
                             "N21_ISIN",            ISIN,                                                   null
                            );
  end;
 
END;

PRIVATE CLASS ShortReg_615( Report:OBJECT )
  VAR m_Report = Report;
  var m_NoDataFlag:bool = true;

  MACRO QntyPrecision():INTEGER //  точность кол-ва
     return m_Report.SumPrecision;
  END;

 
  MACRO PaintStr()
     m_Report.SetCurrentLineFont( 8, true, false );
     m_Report.SetCellFont("N3_SumSrub", 8, true, false, null, null, DefaultBkGrColor );             
     m_Report.SetCellFont("N3_TaxeAll", 8, true, false, null, null, BLUECOLOR );         
     m_Report.SetCellFont("N3_TaxeAmort", 8, true, false, null, null, BLUECOLOR );     
     m_Report.SetCellFont("N3_SumBrub", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_SumBtax", 8, true, false, null, null, DefaultBkGrColor );
     m_Report.SetCellFont("N3_TaxeNKD", 8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N3_FinRes",  8, true, false, null, null, BLUECOLOR );
     m_Report.SetCellFont("N3_ProcRashRepRub", 8, true, false, null, null, DefaultBkGrColor );     
     m_Report.SetCellFont("N3_RashAll",    8, true, false, null, null, DefaultBkGrColor );    
     m_Report.SetCellFont("N3_DRS",8, true, false, null, null, BLUECOLOR );  
     m_Report.SetCellFont("N3_CrSD",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_DPS_DDS",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_MinMrkt",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_Val_MarketS",8, true, false, null, null, BLUECOLOR );  
     m_Report.SetCellFont("N3_MrktS",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_QuoteValueS",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_K_ControlS",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_Control_CommentS",8, true, false, null, null,BLUECOLOR  );                        
     m_Report.SetCellFont("N3_ComS_Another",8, true, false, null, null,BLUECOLOR  );                        
     m_Report.SetCellFont("N3_DRB",8, true, false, null, null, BLUECOLOR );                        
     m_Report.SetCellFont("N3_CrBD",8, true, false, null, null, BLUECOLOR );                        
     m_Report.SetCellFont("N3_DPB_DDB",8, true, false, null, null,BLUECOLOR  );                        
     m_Report.SetCellFont("N3_MaxMrkt",8, true, false, null, null,BLUECOLOR  );                        
     m_Report.SetCellFont("N3_Val_MarketB",8, true, false, null, null,BLUECOLOR  );                        
     m_Report.SetCellFont("N3_MrktB",8, true, false, null, null, BLUECOLOR );                        
     m_Report.SetCellFont("N3_DMrktB",8, true, false, null, null,BLUECOLOR  );                        
     m_Report.SetCellFont("N3_QuoteValueB",8, true, false, null, null,BLUECOLOR  ); 
     m_Report.SetCellFont("N3_RCB",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_K_ControlB",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_Control_CommentB",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_ComB_Another",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_LastCoupDate",  8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_DqualS",8, true, false, null, null, BLUECOLOR );             
     m_Report.SetCellFont("N3_DqualB",  8, true, false, null, null, BLUECOLOR );      
     m_Report.SetCellFont("N3_ContS",   8, true, false, null, null, BLUECOLOR );  
     m_Report.SetCellFont("N3_ContB",   8, true, false, null, null, BLUECOLOR );          
     m_Report.SetCellFont("N3_SecType",   8, true, false, null, null, BLUECOLOR );      
  END;

  MACRO Where():STRING
     /*615 - отбираются сделки с процентными облигациями, номинированными в иностранной валюте*/
     return " NOT ( " + WhereCondNominalRUR() + ") AND " + WhereCondPC();
  END;
    
  MACRO BeginReport()
     m_Report.SetActiveSheet( m_Report.GetNumSheet() );

     m_Report.PrintHeader_0615( "N3_", SHEET_0615, m_Report.GetNumSheet(), "" );

     m_Report.RegisterTable( "N3_MainTable", "N3_TableHeader",
                             "N3_Dummy1",                                                    
                             "N3_SecCode",
                             "N3_SecName",
                             "N3_CodeS",
                             "N3_DZS",
                             "N3_DDS",
                             "N3_Qnty",
                             "N3_VN",
                             "N3_VPrS",
                             "N3_PrSnom",
                             "N3_SumSvp",
                             "N3_SumSrub",
                             "N3_NkdSvp",
                             "N3_NkdSrub",
                             "N3_DifS",
                             "N3_CodeB",
                             "N3_DZB",
                             "N3_DDB",
                             "N3_VPrB",
                             "N3_PrBnom",
                             "N3_SumBvp",
                             "N3_SumBrub",
                             "N3_NkdCloseVp",
                             "N3_NkdCloseRub",
                             "N3_DifB",
                             "N3_SumBtax",
                             "N3_ComS",
                             "N3_ComB",
                             "N3_NDSComS",
                             "N3_NDSComB",
                             "N3_AmortPozVN",
                             "N3_AmortPozRub",
                             "N3_RashAll",
                             "N3_NkdPrevVN",
                             "N3_NkdPrevRub",
                             "N3_CoupPrevVN",
                             "N3_CoupPrevRub",
                             "N3_CoupVN",
                             "N3_CoupRub",
                             "N3_ProcRashAllRub",
                             "N3_ProcRashPrevRub",
                             "N3_ProcRashRepRub",
                             "N3_Nom_DDS",
                             "N3_Nom_DDB",
                             "N3_RFISSS",
                             "N3_RFISSB",
                             "N3_DRS",
                             "N3_CrSD",
                             "N3_DPS_DDS",
                             "N3_MinMrkt",
                             "N3_Val_MarketS",
                             "N3_MrktS",
                             "N3_DMrktS",
                             "N3_QuoteValueS",
                             "N3_RCS",
                             "N3_K_ControlS",
                             "N3_Control_CommentS",
                             "N3_ComS_Another",
                             "N3_DRB",
                             "N3_CrBD",
                             "N3_DPB_DDB",
                             "N3_MaxMrkt",
                             "N3_Val_MarketB",
                             "N3_MrktB",
                             "N3_DMrktB",
                             "N3_QuoteValueB",
                             "N3_RCB",
                             "N3_K_ControlB",
                             "N3_Control_CommentB",
                             "N3_ComB_Another",
                             "N3_LastCoupDate",
                             "N3_DqualS",
                             "N3_DqualB",
                             "N3_ContS",
                             "N3_ContB",
                             "N3_SecType",
                             "N3_TaxeAll",
                             "N3_TaxeAmort",
                             "N3_TaxeNKD",
                             "N3_FinRes",
                             "N3_ISIN");
                             
     m_Report.SetCellAutoSumma( ItogsLineName,
                             "N3_Qnty",
                             "N3_SumSvp",       
                             "N3_SumSrub",       
                             "N3_NkdSvp",        
                             "N3_NkdSrub",        
                             "N3_DifS",  
                             "N3_SumBvp",       
                             "N3_SumBrub",       
                             "N3_NkdCloseVp",        
                             "N3_NkdCloseRub",        
                             "N3_DifB",    
                             "N3_SumBtax",      
                             "N3_ComS",  
                             "N3_ComB",
                             "N3_NDSComS",  
                             "N3_NDSComB",
                             "N3_AmortPozVN",
                             "N3_AmortPozRub",
                             "N3_RashAll",
                             "N3_NkdPrevVN",
                             "N3_NkdPrevRub",
                             "N3_CoupPrevVN",
                             "N3_CoupPrevRub",
                             "N3_CoupVN",
                             "N3_CoupRub",
                             "N3_ProcRashAllRub",
                             "N3_ProcRashPrevRub",
                             "N3_ProcRashRepRub",
                             "N3_DPS_DDS", 
                             "N3_DPB_DDB",                             
                             "N3_TaxeAll",      
                             "N3_TaxeAmort",    
                             "N3_TaxeNKD",      
                             "N3_FinRes"
                              );

     m_NoDataFlag = true;
     m_Report.SetCopyAutoSumRange("A7:CC7");
  END;

  macro EndReportNoData()
    this.PrintNoData();
    m_Report.EndTable();
    m_Report.SetCopyAutoSumRange(null);
  end;

  macro EndReportWithData()
    m_Report.EndTable();
    m_Report.SetCopyAutoSumRange(null);
    m_Report.SetOnAutoFilter(SHEET_0615, "B13:CC13");
    m_Report.SetAutoSize();
  end;

  MACRO EndReport()
    if(m_NoDataFlag)
      EndReportNoData();
    else
      EndReportWithData();
    end;
  END;

   macro PrintNoData()
      m_Report.PrintTableLine( "N3_SecCode",  NoDataTxt, null );
   end;
/*
  MACRO ПечататьПромежуточныеИтоги()
     m_Report.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "F23",
                        "J23",
                        "K23",
                        "L23",
                        "M23",
                        "N23",
                        "T23",
                        "U23",
                        "V23",
                        "W23",
                        "X23",
                        "Y23",
                        "Z23",
                        "AA23",
                        "AB23",
                        "AC23",
                        "AD23",
                        "AE23",
                        "AF23",
                        "AG23",
                        "AH23",
                        "AI23",
                        "AJ23",
                        "AK23",
                        "AL23",
                        "AM23",
                        "AT23",
                        "BF23",
                        "BV23",
                        "BW23",
                        "BX23",
                        "BY23"
                       );
  END;
*/
  MACRO Print()
    m_NoDataFlag = false;

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine(

                   
                 /* 1 */  "N3_SecCode",            m_Report.SecCode(),             null,  
                 /* 2 */  "N3_SecName",            m_Report.SecName(),             null,  
                 /* 3 */  "N3_CodeS",              m_Report.CodeS(),               null,  
                 /* 4 */  "N3_DZS",                m_Report.DZS(),                 null,  
                 /* 5 */  "N3_DDS",                m_Report.DDS(),                 null,  
                 /* 6 */  "N3_Qnty",               m_Report.printQnty(),           null,
                 /* 7 */  "N3_VN",                 m_Report.VN(),                  null,  
                 /* 8 */  "N3_VPrS",               m_Report.VPrSNumber(),          null,  
                 /* 9 */  "N3_PrSnom",             m_Report.printPrSnom(),         null,  
                 /* 10 */ "N3_SumSvp",             m_Report.SumSvp(),              null,  
                 /* 11 */ "N3_SumSrub",            m_Report.SumSrub(),             null,/*ф-ла*/  
                 /* 12 */ "N3_NkdSvp",             m_Report.NkdSvp(),              null,  
                 /* 13 */ "N3_NkdSrub",            m_Report.NkdSrub(),             null,  
                 /* 14 */ "N3_DifS",               m_Report.DifS(),                null,  
                 /* 15 */ "N3_CodeB",              m_Report.CodeB(),               null, 
                 /* 16 */ "N3_DZB",                m_Report.DZB(),                 null,  
                 /* 17 */ "N3_DDB",                m_Report.DDB(),                 null, 
                 /* 18 */ "N3_VPrB",               m_Report.VPrBNumber(),          null, 
                 /* 19 */ "N3_PrBnom",             m_Report.printPrBnom(),         null,  
                 /* 20 */ "N3_SumBvp",             m_Report.SumBvp(),              null,  
                 /* 21 */ "N3_SumBrub",            m_Report.SumBrub(),             null,/*ф-ла*/  
                 /* 22 */ "N3_NkdCloseVp",         m_Report.NkdCloseVp(),          null,  
                 /* 23 */ "N3_NkdCloseRub",        m_Report.NkdCloseRub(),         null,  
                 /* 24 */ "N3_DifB",               m_Report.DifB(),                null,  
                 /* 25 */ "N3_SumBtax",            m_Report.SumBtax(),             null,  
                 /* 26 */ "N3_ComS",               m_Report.ComS(),                null,  
                 /* 27 */ "N3_ComB",               m_Report.ComB(),                null,
                 /* 26.1 */ "N3_ComS",             m_Report.NDSComS(),             null,  
                 /* 27.1 */ "N3_ComB",             m_Report.NDSComB(),             null,   
                 /* 28 */ "N3_AmortPozVN",         m_Report.AmortPozVN(),          null, 
                 /* 29 */ "N3_AmortPozRub",        m_Report.AmortPozRub(),         null,  
                 /* 30 */ "N3_RashAll",            m_Report.RashAll(),             null, /*ф-ла*/ 
                 /* 31 */ "N3_NkdPrevVN",          m_Report.NkdPrevVN(),           null,  
                 /* 32 */ "N3_NkdPrevRub",         m_Report.NkdPrevRub(),          null,  
                 /* 33 */ "N3_CoupPrevVN",         IIF(m_Report.DDS() < m_Report.H0_1(), m_Report.CoupPrevVN(),"" ),         null,  
                 /* 34 */ "N3_CoupPrevRub",        IIF(m_Report.DDS() < m_Report.H0_1(), m_Report.CoupPrevRub(),""),         null,  
                 /* 35 */ "N3_CoupVN",             m_Report.CoupVN(),              null,  
                 /* 36 */ "N3_CoupRub",            m_Report.CoupRub(),             null,  
                 /* 37 */ "N3_ProcRashAllRub",     m_Report.ProcRashAllRub(),      null,  
                 /* 38 */ "N3_ProcRashPrevRub",    m_Report.ProcRashPrevRub(),     null,  
                 /* 39 */ "N3_ProcRashRepRub",     m_Report.ProcRashRepRub(),      null, 
                 /* 40 */ "N3_Nom_DDS",            m_Report.printNomS(),           null,  
                 /* 41 */ "N3_Nom_DDB",            m_Report.printNomBDU(),         null,  
                 /* 42 */ "N3_RFISSS",             m_Report.RFISSS(),              null,  
                 /* 43 */ "N3_RFISSB",             m_Report.RFISSB(),              null,  
                 /* S1 */ "N3_DRS",                m_Report.DRS(),                 null,  
                 /* S2 */ "N3_CrSD",               m_Report.printCrSD_F(),         null,  
                 /* S3 */ "N3_DPS_DDS",            m_Report.DPS_DDS(),             null,  
                 /* S4 */ "N3_MinMrkt",            m_Report.printMinMrkt(),        null,  
                 /* S5 */ "N3_Val_MarketS",        m_Report.Val_MarketS(),         null,  
                 /* S6 */ "N3_MrktS",              m_Report.MrktS(),               null,  
                 /* S7 */ "N3_DMrktS",             m_Report.DMrktS(),              null,  
                 /* S8 */ "N3_QuoteValueS",        m_Report.printQuoteValueS(),    null,  
                 /* S9 */ "N3_RCS",                m_Report.RCS(),                 null,  
                 /* S10*/ "N3_K_ControlS",         m_Report.K_ControlS(),          null,  
                 /* S11*/ "N3_Control_CommentS",   m_Report.Control_CommentS(),    null,  
                 /* S12*/ "N3_ComS_Another",       m_Report.ComS_AnotherDU(),      null,  
                 /* B1 */ "N3_DRB",                m_Report.DRB(),                 null,  
                 /* B2 */ "N3_CrBD",               m_Report.printCrBD_F(),         null,  
                 /* B3 */ "N3_DPB_DDB",            m_Report.DPB_DDB(),             null,  
                 /* B4 */ "N3_MaxMrkt",            m_Report.printMaxMrkt(),        null,  
                 /* B5 */ "N3_Val_MarketB",        m_Report.Val_MarketB(),         null, 
                 /* B6 */ "N3_MrktB",              m_Report.MrktB(),               null,  
                 /* B7 */ "N3_DMrktB",             m_Report.DMrktB(),              null,  
                 /* B8 */ "N3_QuoteValueB",        m_Report.printQuoteValueB(),    null,  
                 /* B9 */ "N3_RCB",                m_Report.RCB(),                 null, 
                 /* B10*/ "N3_K_ControlB",         m_Report.K_ControlB(),          null, 
                 /* B11*/ "N3_Control_CommentB",   m_Report.Control_CommentB(),    null,  
                 /* B12*/ "N3_ComB_Another",       m_Report.ComB_AnotherDU(),      null,  
                 /* K1 */ "N3_LastCoupDate",       IIF(m_Report.CoupCount() > 0, m_Report.LastCoupDate(),""),         null,  
                 /* T1 */ "N3_DqualS",             m_Report.DqualS(),              null,  
                 /* T2 */ "N3_DqualB",             m_Report.DqualB(),              null,  
                 /* T3 */ "N3_ContS",              m_Report.ContS(),               null,  
                 /* T4 */ "N3_ContB",              m_Report.ContB(),               null,  
                 /* T5 */ "N3_SecType",            m_Report.SecType(),             null,  
                 /* T6 */ "N3_TaxeAll",            m_Report.TaxeAll(),             null,/*ф-ла*/ 
                 /* T7 */ "N3_TaxeAmort",          m_Report.TaxeAmort(),           null,/*ф-ла*/  
                 /* T8 */ "N3_TaxeNKD",            m_Report.TaxeNKD(),             null,/*ф-ла*/  
                 /* V1 */ "N3_FinRes",             m_Report.FinRes(),              null,/*ф-ла*/
                 /* R1 */ "N3_ISIN",               m_Report.ISIN(),                null  
                            );  

  END;      

END;

PRIVATE CLASS ShortReg_615_Cons( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()

     m_Report.SetActiveSheet( m_Report.GetNumSheet_cons() );

     m_Report.PrintHeader_cons( "N31_", "615", m_Report.GetNumSheet(), "" );

      m_Report.RegisterTable( "N31_MainTable", "N31_TableHeader",
                   /* a  */  "N31_RegNum",    
                   /* b  */  "N31_SecType",   
                   /* c  */  "N31_SecCode",
                   /* 1  */  "N31_SecName",   
                   /* 2  */  "N31_FinRes",
                   /* 3  */  "N31_DifB",   
                   /* 4  */  "N31_DifS",          
                   /* 5  */  "N31_ComS_ComB",    
                   /* 6  */  "N31_TaxeAll",     
                   /* 7  */  "N31_TaxeAmort",    
                   /* 8  */  "N31_TaxeNKD",      
                   /* 9  */  "N31_Qnty",          
                   /* 10 */  "N31_SumSRub",    
                   /* 11 */  "N31_RashAll",       
                   /* 12 */  "N31_SumSvp",        
                   /* 13 */  "N31_SumBvp",   
                   /* 14 */  "N31_ProcRashRepRub",     
                   /* 15 */  "N31_NkdSvp",   
                   /* 16 */  "N31_NkdCloseVp",        
                   /* 17 */  "N31_NkdBvp",        
                   /* 18 */  "N31_AmortPozVN",    
                   /* 19 */  "N31_CoupVN", 
                   /* 20 */  "N31_ProcRashPrevRub",
                   /* d  */  "N31_ISIN"
                           );

     m_Report.SetCellAutoSumma( ItogsLineName,
                   /* 2  */  "N31_FinRes",
                   /* 3  */  "N31_DifB",   
                   /* 4  */  "N31_DifS",          
                   /* 5  */  "N31_ComS_ComB",    
                   /* 6  */  "N31_TaxeAll",     
                   /* 7  */  "N31_TaxeAmort",    
                   /* 8  */  "N31_TaxeNKD",      
                   /* 9  */  "N31_Qnty",          
                   /* 10 */  "N31_SumSRub",    
                   /* 11 */  "N31_RashAll",       
                   /* 12 */  "N31_SumSvp",        
                   /* 13 */  "N31_SumBvp",   
                   /* 14 */  "N31_ProcRashRepRub",     
                   /* 15 */  "N31_NkdSvp",   
                   /* 16 */  "N31_NkdCloseVp",        
                   /* 17 */  "N31_NkdBvp",        
                   /* 18 */  "N31_AmortPozVN",    
                   /* 19 */  "N31_CoupVN", 
                   /* 20 */  "N31_ProcRashPrevRub"          
                               );

     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N31_RegNum",   "615",         null,
                              "N31_SecType",  IIF(StrUpr(m_Report.H0_9())=="ВСЕ","",GetNumTaxGroup(m_Report.H0_9())), null,
                              "N31_SecCode",  m_Report.GetCCons(), null,
                              "N31_SecName",  ItogsLineName, null );
     m_Report.SetCurrentLineFont( 8, true, false, FONTSTYLE_UNDERLINENO, DefaultFontColor, DefaultBkGrColor );
     m_Report.PrintTableLine( "N31_SecName",  "в том числе:", null );
  END;

  MACRO EndReport()
     m_Report.EndTable();
     //this.ПечататьПромежуточныеИтоги();
     /*подошвы для сводной нет*/
  END;
/*
  MACRO ПечататьПромежуточныеИтоги()
     m_Report.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",     
                        "H22",     
                        "I22",     
                        "J22",     
                        "K22",        
                        "L22",        
                        "M22",     
                        "N22",        
                        "O22",     
                        "P22",
                        "Q22",
                        "R22",
                        "S22",
                        "T22",
                        "U22",
                        "V22",
                        "W22"
                    );                                           
  END;
*/
  MACRO Print(TaxGroup,FI_Code:string,Name:string,ISIN:string)

     m_Report.SetCurrentStrNumber();

     m_Report.PrintTableLine( 
                             "N31_RegNum",        "615",                                                  null,
                             "N31_SecType",       TaxGroup,                                               null,
                             "N31_SecCode",       FI_Code,                                                null,
                             "N31_SecName",       Name,                                                   null,
                             "N31_FinRes",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_FinRes),      null,
                             "N31_DifB",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifB),        null,
                             "N31_DifS",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_DifS),        null,
                             "N31_ComS_ComB",     m_Report.ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(C_ComS, NULL, NULL, C_ComB, NULL, NULL), null,
                             "N31_TaxeAll",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeAll),     null,
                             "N31_TaxeAmort",     m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeAmort),   null,
                             "N31_TaxeNKD",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_TaxeNKD),     null,
                             "N31_Qnty",          m_Report.ФормулаПоВсемСделкамДляВыпуска(C_Qnty),        null,
                             "N31_SumSRub",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSRub),     null,
                             "N31_RashAll",       m_Report.ФормулаПоВсемСделкамДляВыпуска(C_RashAll),     null,
                             "N31_SumSvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumSvp),      null,
                             "N31_SumBvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_SumBvp),      null,
                             "N31_SumBvp_2",       "",                                                    null,
                             "N31_ProcRashRepRub",m_Report.ФормулаПоВсемСделкамДляВыпуска(C_ProcRashRepRub),   null,
                             "N31_NkdSvp",        m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NKDSvp), null,
                             "N31_NkdCloseVp",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_NkdCloseVp),      null,                              
                             "N31_AmortPozVN",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_AmortPozVn),  null,
                             "N31_CoupVN",        m_Report.ТекстФормулыПоВсемСделкамДляВыпуска(C_CoupVN), null,
                             "N31_ProcRashPrevRub",    m_Report.ФормулаПоВсемСделкамДляВыпуска(C_ProcRashPrevRub),   null,
                             "N31_ISIN",          ISIN,                                                   null
                            );
  end;
 
END;


PRIVATE CLASS (TX_RegistrReport) SP_ShortReg_Report_2014( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, FocreFormatRep:INTEGER, UseBigReportMode:BOOL  )
  PRIVATE VAR m_SHEET_1 = "", m_SHEET_2 = "";/*основная и сводная вкладки*/
  PRIVATE VAR m_RunByQuoted = false, m_RunByNoQuoted = false;
  PRIVATE VAR m_IsPrintByQuoted = false;
  PRIVATE VAR m_IsPrintByNoQuoted = false;
  PRIVATE VAR m_IsPrintByTech = false;
  PRIVATE VAR m_INN, m_KPP, m_H01, m_H02;
  PRIVATE VAR m_CurrStrNum = 0;
  PRIVATE VAR m_IsExistsData = false;
  PRIVATE VAR m_AmortPozVN,
              m_AmortPozRub,
              m_NkdCloseVp,
              m_NkdCloseRub,
              m_CrDB,
              m_NKDSvp = null,
              m_NkdBvp,
              m_CoupPrevRub,
              m_CoupPrevVN,
              m_NkdSrub,
              m_TaxDepositoryMode = CheckTaxDepositoryMode(),               
              m_Cr_Val_MrkSZ,
              m_Cr_Val_MrktBZ,
              m_CrSpezB,
              m_CrSpezS,
              m_ProcRashAllRub = $0.0;
  
  private var m_CopyAutoSumRange = null;

  MACRO IsDataExist()
     return m_IsExistsData();
  END;
  
  MACRO Fill_Cell_Name()
   if(m_ReportKind == SHREP_REG_0611)
     C_SumSvp  =  "K";
     C_CrSD    =  "AE";
     C_SumBvp  =  "S";
     C_CrBD    =  "AS";
     C_SumBrub =  "T";
     C_DifB    =  "U";
     C_ComS    =  "W";
     C_ComB    =  "X";
     C_NDSComS =  "Y";
     C_NDSComB =  "Z";
     C_SumBtax =  "V";
     C_SumSrub =  "L";
     C_DifS    =  "M";
     C_RashAll =  "AA";
     C_FinRes  =  "BL"; 
     C_TaxeAll =  "BK";
     C_Qnty    =  "G";
     C_SecCode =  "B";
     C_ISIN    =  "BM";
     C_SecCode_2 = "C";

   elif(m_ReportKind == SHREP_REG_0612)
     C_SumSvp          = "AM";
     C_CrSD            = "AL";
     C_SumBvp          = "AY";
     C_CrBD            = "AX";
     C_SumBrub         = "O";
     C_DifB            = "Q";
     C_ComS            = "S";
     C_ComB            = "T";
     C_NDSComS         = "U";
     C_NDSComB         = "V";
     C_SumBtax         = "R";
     C_SumSrub         = "H";
     C_DifS            = "J";
     C_RashAll         = "X";
     C_TaxeAmort       = "BP";
     C_TaxeNKD         = "BQ";
     C_FinRes          = "BR";
     C_TaxeAll         = "BO";
     C_Qnty            = "F";
     C_SecCode         = "A";
     C_SecCode_2       = "C";
     C_AmortPozVN      = "W";
     C_ProcRashRepRub  = "AD";
     C_ProcRashRepRub1 = "AE";
     C_ProcRashRepRub2 = "AF";
     C_ProcRashAllRub  = "AB";
     C_ProcRashPrevRub = "AC";
     C_NkdSvp          = "I";
     C_NkdCloseVp      = "P";
     C_CoupVN          = "AA";
     C_CodeS           = "C";
     C_NkdPrevVN       = "Y";
     C_NomH01          = "BS";
     C_NomH02          = "BT";
     C_ISIN            = "BX";

   elif(m_ReportKind == SHREP_REG_0615)
     C_CrSD         = "AV";
     C_CrBD         = "BH";
     C_DifB         = "Y";
     C_DifS         = "O";
     C_ComS         = "AA";
     C_ComB         = "AB";
     C_NDSComS      = "AC";
     C_NDSComB      = "AD";
     C_TaxeAll      = "BY";
     C_TaxeAmort    = "BZ";
     C_TaxeNKD      = "CA";
     C_Qnty         = "G";     
     C_RashAll      = "AG";
     C_SumSvp       = "K";
     C_SumBvp       = "U";     
     C_NkdSvp       = "M";      
     C_CoupVN       = "AL";     
     C_AmortPozRub  = "AF";
     C_AmortPozVN   = "AE";
     C_ProcRashRepRub = "AP";
     C_ProcRashAllRub = "AN";
     C_ProcRashPrevRub = "AO";
     C_SumBrub      = "V";
     C_SumBtax      = "Z";
     C_SumSrub      = "L";
     C_RashAll      = "AG";
     C_FinRes       = "CB"; 
     C_SecCode      = "B";
     C_SecCode_2    = "C";
     C_NkdCloseVp   = "W";
     C_ISIN         = "CC";
                 
   end;
  END;

  MACRO ClearCacheOneRecord()
    this.ClearCacheOneRecord();
    m_AmortPozVN  = null;
    m_AmortPozRub = null;
    m_CrDB        = null;
    m_NkdCloseVp  = null;
    m_NkdCloseRub = null;
    m_CoupPrevRub = null;
    m_CoupPrevVN  = null; 
    m_NkdSrub     = null;
    m_NkdPrevVN   = null; 
    m_NkdPrevRub  = null;
    m_CoupRub     = null;
    m_CoupVN      = null;
    m_CrSD        = null;
    m_ComB        = null;
    m_ComS        = null;
    m_NDSComB     = null;
    m_NDSComS     = null;
    m_NKDSvp      = null;
    m_NkdBvp      = null;
    m_Cr_Val_MrkSZ= null;
    m_Cr_Val_MrktBZ  = null;
    m_CrSpezB     = null;
    m_CrSpezS     = null;
    m_ProcRashAllRub = $0.0;

  END;

  /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
     return true;
  END;
  
  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  MACRO GetNumSheet()
     return m_SHEET_1;
  END;

  MACRO GetNumSheet_cons()
     return m_SHEET_2;
  END;

  MACRO AvoirKind()
    return m_RS.AvoirKind;
  END;
  /*Наименование нашего банка*/
  MACRO H0_A():STRING
     return ПолучитьКороткоеИмяСубъекта( {OurBank} );
  END;

  MACRO H0_B_INN()
     if( m_INN == null )
        SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), m_INN, m_KPP );
     end;
     return m_INN;
  END;

  MACRO H0_B_KPP()
     if( m_KPP == null )
        SplitFullINN( ПолучитьКодСубъекта({OurBank}, PTCK_INN), m_INN, m_KPP );
     end;
     return m_KPP;
  END;
   /*Начало отчетного периода */
  MACRO H0_1():DATE
     return date(m_H01);
  END;

  /*Отчетная дата, указанная в форме запуска отчета*/
  MACRO H0_2():DATE
     return date(m_H02);
  END;

  MACRO Дн():DATE // максимальная из двух дат: (<H0.1>; <DDB>+1)
     return MAX( this.H0_1(), this.DDB()+1 );
  END;
  /*Группа налогового учета*/
  MACRO H0_9():STRING
     var GroupName = "";
     ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_AVRGROUP_2014, @GroupName );
     return GroupName;
  END;

  MACRO SetCurrentStrNumber()
     m_CurrStrNum = this.НомерТекущейСтроки();
  END;

  /*Полчить адреса ячеек*/
  MACRO GetSumSvp():STRING
     return (C_SumSvp+string(m_CurrStrNum));
  END;

  MACRO GetCrSD():STRING
     return (C_CrSD+string(m_CurrStrNum));
  END;

  MACRO GetSumBvp():STRING
     return (C_SumBvp+string(m_CurrStrNum));
  END;

  MACRO GetCrBD():STRING
     return (C_CrBD+string(m_CurrStrNum));
  END;

  MACRO GetSumBrub():STRING
     return (C_SumBrub+string(m_CurrStrNum));
  END;

  MACRO GetDifB():STRING
     return (C_DifB+string(m_CurrStrNum));
  END;

  MACRO GetComS():STRING
     return (C_ComS+string(m_CurrStrNum));
  END;
   
  MACRO GetSumBtax():STRING
     return (C_SumBtax+string(m_CurrStrNum));
  END;

  MACRO GetNDSComS():STRING
     return (C_NDSComS+string(m_CurrStrNum));
  END;

  MACRO GetNDSComB():STRING
     return (C_NDSComB+string(m_CurrStrNum));
  END; 

  MACRO GetComB():STRING
     return (C_ComB+string(m_CurrStrNum));
  END; 

  MACRO GetAmortPozVN():STRING
     return (C_AmortPozVN+string(m_CurrStrNum));
  END;

  MACRO GetAmortPozRub():STRING
     return (C_AmortPozRub+string(m_CurrStrNum));
  END;

  MACRO GetSumSrub():STRING
     return (C_SumSrub+string(m_CurrStrNum));
  END;

  MACRO GetDifS():STRING
     return (C_DifS+string(m_CurrStrNum));
  END;
         
  MACRO GetRashAll():STRING
     return (C_RashAll+string(m_CurrStrNum));
  END;

  MACRO GetTaxeAmort():STRING
     return (C_TaxeAmort+string(m_CurrStrNum));
  END; 
   
  MACRO GetTaxeNKD():STRING
     return (C_TaxeNKD+string(m_CurrStrNum));
  END;

  MACRO GetProcRashRepRub():STRING
    return (C_ProcRashRepRub+string(m_CurrStrNum));
  END;

  MACRO GetProcRashRepRub1():STRING
    return (C_ProcRashRepRub1+string(m_CurrStrNum));
  END;

  MACRO GetProcRashRepRub2():STRING
    return (C_ProcRashRepRub2+string(m_CurrStrNum));
  END;

  MACRO GetProcRashAllRub():STRING
    return (C_ProcRashAllRub+string(m_CurrStrNum));
  END;

  MACRO GetProcRashPrevRub():STRING
    return (C_ProcRashPrevRub+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetQnty():STRING
    return (C_Qnty+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNomH01():STRING
     return (C_NomH01+string(m_CurrStrNum));
  END;

  /*получить адрес ячейки*/
  MACRO GetNomH02():STRING
     return (C_NomH02+string(m_CurrStrNum));
  END;
  /*END Полчить адреса ячеек*/

  MACRO ПечататьПромежуточныеИтоги_611()
       this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "F23",
                        "J23",
                        "K23",
                        "L23",
                        "R23",
                        "S23",
                        "T23",
                        "U23",
                        "V23",
                        "W23",
                        "X23",
                        "AE23",
                        "AS23",
                        "BH23",
                        "BI23"
                    );
  END;

  MACRO ПечататьПромежуточныеИтоги_611_Cons()
       this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",
                        "H22",
                        "I22",
                        "J22",
                        "K22",
                        "L22",
                        "M22",
                        "N22",
                        "O22",
                        "P22"
                    );
  END;

  MACRO ПечататьПромежуточныеИтоги_612()
     //m_Report.SetActiveSheet( m_Report.GetNumSheet() );
     this.SetSubTotalEx1( НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА, НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ + 2,
                             "F23",
                             "H23",
                             "I23",
                             "J23",
                             "O23",
                             "P23",
                             "Q23",
                             "R23",
                             "S23",
                             "T23",
                             "U23",
                             "V23",
                             "W23",
                             "X23",
                             "Y23",
                             "Z23",
                             "AA23",
                             "AB23",
                             "AC23",
                             "AD23",
                             "BM23",
                             "BN23",
                             "BO23",
                             "BP23",
                             "BS23",
                             "BT23",
                             "BU23"
                           );
  END;

  MACRO ПечататьПромежуточныеИтоги_612_Cons()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",
                        "H22",
                        "I22",
                        "J22",
                        "K22",
                        "L22",
                        "M22",
                        "N22",
                        "O22",
                        "P22",
                        "Q22",
                        "R22",
                        "S22",
                        "T22",
                        "U22",
                        "V22",
                        "W22",
                        "X22"
                    );
  END;

  MACRO ПечататьПромежуточныеИтоги_615()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "F23",
                        "J23",
                        "K23",
                        "L23",
                        "M23",
                        "N23",
                        "T23",
                        "U23",
                        "V23",
                        "W23",
                        "X23",
                        "Y23",
                        "Z23",
                        "AA23",
                        "AB23",
                        "AC23",
                        "AD23",
                        "AE23",
                        "AF23",
                        "AG23",
                        "AH23",
                        "AI23",
                        "AJ23",
                        "AK23",
                        "AL23",
                        "AM23",
                        "AT23",
                        "BF23",
                        "BV23",
                        "BW23",
                        "BX23",
                        "BY23"
                       );
  END;

  MACRO ПечататьПромежуточныеИтоги_615_Cons()
     this.SetSubTotalEx1(НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА,НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ,
                        "E22",
                        "F22",
                        "G22",
                        "H22",
                        "I22",
                        "J22",
                        "K22",
                        "L22",
                        "M22",
                        "N22",
                        "O22",
                        "P22",
                        "Q22",
                        "R22",
                        "S22",
                        "T22",
                        "U22",
                        "V22",
                        "W22"
                    );
  END;

  PRIVATE MACRO OnAfterFirstAutoFill()
  debugbreak;
     if  ( m_ObjTemplateXLS.SheetName() == SHEET_0611 )
        //this.ПечататьПромежуточныеИтоги_611();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0611s )
        this.ПечататьПромежуточныеИтоги_611_Cons();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0612 )
        this.ПечататьПромежуточныеИтоги_612();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0612s )
        this.ПечататьПромежуточныеИтоги_612_Cons();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0615 )
        //this.ПечататьПромежуточныеИтоги_615();
     elif( m_ObjTemplateXLS.SheetName() == SHEET_0615s )
        this.ПечататьПромежуточныеИтоги_615_Cons();
     end;
  END;

  /*Выпуск ц/б*/
  MACRO H0_11():STRING
     return ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_AVRNAME_2014 );   
  END;
  
  MACRO SumSrub()
    if (this.IsDUDealS() == 1)
      return 0;
    end;
    if (m_ReportKind == SHREP_REG_0615)
      var V19 = 0;
      GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
      if ((V19 == 1) and (this.CrSpezS() != 0.0))
        return F("(" + GetSumSvp() + "+L" + string(m_CurrStrNum) + ") *" + 
                 this.GetCrSD() + "-M" + string(m_CurrStrNum));
      end;
    end;
    return F(GetSumSvp()+"*"+GetCrSD()); 
  END;

  /*Сумма отклонения фактической выручки ниже рыночной (расчетной) цены, руб.*/
  MACRO DifS():money
    if( m_DifS == null)
      if(this.IsDUDealS() == 1)
        m_DifS = $0.0;
        return m_DifS;
      end;
      /*если заполнено примечание*/
      if (IsFilledNoteByDeal(this.DealSale().rec.DealID,
                             27/*Отклонение от рыночной цены*/))
        if( this.QS() != 0 )
          var Note:double = readNoteForObject(OBJTYPE_SECDEAL, 
                                              UniID(this.DealSale(),
                                              OBJTYPE_SECDEAL),
                                              27);
          m_DifS = Note/this.QS() * this.Qnty(); 
        end;
      else
        if ((MinMrkt() == 0) or (StrUpr(MrktS()) == "ФАКТ")
            or (StrUpr(MrktS()) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА")
            or (StrUpr(MrktS()) == "БИРЖЕВАЯ СДЕЛКА"))
          m_DifS = $0.0;
        else
          var V19 = 0;
          var SumSrub:money = $0.0;
          var SumMrkt:money = $0.0;

          GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
          if ((V19 == 1) and (m_ReportKind == SHREP_REG_0615))
            SumSrub = (SumSvp() + NkdSvp()) * CrSD() - NkdSrub;
          else 
            SumSrub = SumSvp() * CrSD();
          end;
        
          if (m_ReportKind == SHREP_REG_0611)
            SumMrkt = MinMrkt() * this.Cr_Val_MrkSZ() / CrSZ() * this.Qnty();
            if ((SumMrkt  - this.SumSvp()) > 0)
              m_DifS = (SumMrkt  - SumSvp()) * this.CrSD();
            else
              m_DifS = $0.0;
            end;
          elif (m_ReportKind == SHREP_REG_0612)
            SumMrkt = MinMrkt()* this.NomS() / 100 * this.Qnty();
            if (SumMrkt - SumSrub > 0)
              m_DifS = SumMrkt - SumSrub;
            else 
              m_DifS = $0.0;
            end;          
          elif (m_ReportKind == SHREP_REG_0615)
            if (this.VPrS() == NATCUR)
              SumMrkt = MinMrkt() * this.NomS() / 100 * this.Qnty() * GetRateOnDateCrossDbl(this.DZS(), m_RS.FaceValueFI, NATCUR, true);
              if (SumMrkt - SumSrub > 0)
                m_DifS = SumMrkt - SumSrub;
              else
                m_DifS = $0.0;
              end;
            else
              SumMrkt = MinMrkt() * this.NomS() / 100 * this.Qnty();
              if (V19 == 0)
                if ((SumMrkt  - SumSvp()) > 0)
                  m_DifS = (SumMrkt  - SumSvp()) * this.CrSD();
                else 
                  m_DifS = $0.0;
                end;
              elif ((V19 == 1) and (this.CrSpezS() != 0.0))
                if (SumMrkt * GetRateOnDateCrossDbl(this.DZS(), m_RS.FaceValueFI, NATCUR, true) - SumSrub > 0)
                  m_DifS = max(SumMrkt * GetRateOnDateCrossDbl(this.DDS(), m_RS.FaceValueFI, NATCUR, true) - SumSrub, 0);
                else 
                  m_DifS = $0.0;
                end;
              elif ((V19 == 1) and (this.CrSpezS() == 0.0))
                if ((SumMrkt  - SumSvp()) > 0)
                  m_DifS = (SumMrkt  - SumSvp()) * GetRateOnDateCrossDbl(this.DDS(), m_RS.FaceValueFI, NATCUR, true);
                else 
                  m_DifS = $0.0;
                end;
              end;
            end;
          end; 
        end;
      end;
    end;
    return m_DifS;
  END;

  MACRO SumBmain():MONEY
    if(m_RS.VirtualTypeBuy != TXVDEAL_REAL)  //виртуальная
      return m_RS.BuyAmount;
    else
      return LegBuy().rec.Cost;
    end;
  END;

  MACRO SumSmain():MONEY
    if(m_RS.VirtualTypeSale != TXVDEAL_REAL)  //виртуальная
      return m_RS.SaleAmount;
    else
      return LegSale().rec.Cost;
    end;
  END;

  MACRO NkdBvp():MONEY
     if( m_NkdBvp == NULL )
        m_NkdBvp = money(this.NKDBuy()*this.Qnty()/double(m_RS.BuyAmount));
     end;
     return m_NkdBvp;
  END;
  
   /*!Формула <SumBrub> = <SumBvp> * <CrBD> Стоимость приобретения*/
  MACRO SumBrub()
    if (m_ReportKind == SHREP_REG_0615)
      var V19 = 0;
      if(this.IsDUDealS() == 1)
        return 0;
      end;
      GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
      if ((V19 == 1) and (this.CrSpezB() != 0.0))
        return F("(" + GetSumBvp() + "+" + NkdBvp() + ") *" + GetCrBD()
                 + "-" + NkdBrub());
      end;
    end;
    return F(GetSumBvp()+"*"+GetCrBD());
  END;
  /*Сумма превышения стоимости приобретения над рыночной (расчетной) ценой, руб*/
  MACRO DifB():MONEY
    if (m_DifB == null)
      if(this.IsDUDealS() == 1)
        m_DifB = 0;
      /*если заполнено примечание*/
      elif (IsFilledNoteByDeal(this.DealBuy().rec.DealID,
                             27/*Отклонение от рыночной цены*/))
        if (this.QB() != 0)
           var Note:double = readNoteForObject( OBJTYPE_SECDEAL, UniID( this.DealBuy(), OBJTYPE_SECDEAL), 27/*Отклонение от рыночной цены*/);
           m_DifB = Note / this.QB() * this.Qnty();
        end;
      else
        if ((MaxMrkt() == 0) or (StrUpr(MrktB()) == "ФАКТ")
            or (StrUpr(MrktB()) == "НЕКОНТРОЛИРУЕМАЯ СДЕЛКА")
            or (StrUpr(MrktB()) == "БИРЖЕВАЯ СДЕЛКА"))
          m_DifB = $0.0;
        else
          var V19 = 0;
          var SumBrub:money = $0.0;
          var SumMrkt:money = $0.0;

          GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V19", V_INTEGER, V19, 0);
          if ((V19 == 1) and (m_ReportKind == SHREP_REG_0615))
            SumBrub = (SumBvp() + NkdBvp()) * CrBD() - NkdBrub();
          else 
            SumBrub = SumBvp() * CrBD();
          end;

          if (m_ReportKind == SHREP_REG_0611)
            SumMrkt = MaxMrkt() * this.Cr_Val_MrktBZ() / CrBZ() * this.Qnty(); 
            if ((SumBvp() - SumMrkt) > 0 )
              m_DifB = (SumBvp() - SumMrkt) * CrBD();
            else 
              m_DifB = $0.0;
            end;
          elif (m_ReportKind == SHREP_REG_0612)
            SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty();
            if ((SumBrub - SumMrkt) > 0) 
              m_DifB = SumBrub - SumMrkt();
            else 
              m_DifB = $0.0;
            end;        
          elif (m_ReportKind == SHREP_REG_0615)
            if (this.VPrB() == NATCUR)
              SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty() * GetRateOnDateCrossDbl(this.DZB(), m_RS.FaceValueFI, NATCUR, true);
              if ((SumBrub - SumMrkt) > 0) 
                m_DifB = SumBrub - SumMrkt;
              else 
                m_DifB = $0.0;
              end;        
            else
              SumMrkt = MaxMrkt() * this.NomB() / 100 * this.Qnty();
              if (V19 == 0)
                if ((SumBvp() - SumMrkt) > 0)
                  m_DifB = (SumBvp() - SumMrkt)* this.CrBD();
                else 
                  m_DifB = $0.0;
                end;
              elif ((V19 == 1) and (this.CrSpezB() != 0.0))
                if (SumBrub - SumMrkt * GetRateOnDateCrossDbl(this.DZB(), m_RS.FaceValueFI, NATCUR, true) > 0)
                  m_DifB = max(SumBrub - SumMrkt * GetRateOnDateCrossDbl(this.DDB(), m_RS.FaceValueFI, NATCUR, true), 0);
                else
                  m_DifB = $0.0;
                end;
              elif ((V19 == 1) and (this.CrSpezB() == 0.0))
                if ((SumBvp() - SumMrkt) > 0)
                  m_DifB = (SumBvp() - SumMrkt)* GetRateOnDateCrossDbl(this.DDB(), m_RS.FaceValueFI, NATCUR, true);
                else 
                  m_DifB = $0.0;
                end;
              end;
            end;
          end;
        end;
      end;
    end;
    return m_DifB;   
  END;

   /* Формула! <SumBtax>=<SumBrub>-<DifB> */
  MACRO SumBtax() // Стоимость приобретенных ценных бумаг, принимаемая для целей налогообложения
     return F(GetSumBrub()+"-"+GetDifB());
  END;

  MACRO ComS():MONEY //  Комиссия, уплаченная при реализации
    if( m_ComS == NULL )
      if(this.IsDUDealS() == 1)
        m_ComS = $0.0;
      else
        m_ComS = (m_RS.CommSale * (this.Qnty()/this.QS())) + this.ComS_Another();
      end;
    end;
    return m_ComS;
  END;

  MACRO ComB():MONEY //Комиссия, уплаченная при приобретении  
    if( m_ComB == NULL )
      if(this.IsDUDealS() == 1)
        return $0.0;
      end;
      m_ComB = (m_RS.CommBuy * Qnty()/this.QB()) + this.ComB_Another();        
    end;
    return m_ComB;
  END;

  MACRO ComS_AnotherDU():MONEY 
    if( m_ComS_Another == NULL )
      if(this.IsDUDealS() == 1)
        return m_RS.CommSale * (this.Qnty()/this.QS());
      end;
      m_ComS_Another = this.ComS_Another();       
    end;
    return m_ComS_Another;
  END;

  MACRO ComB_AnotherDU():MONEY  
    if( m_ComB_Another == NULL )
      if(this.IsDUDealS() == 1)
        return m_RS.CommBuy * (Qnty()/this.QB());
      end;
      m_ComB_Another = this.ComB_Another();        
    end;
    return m_ComB_Another;
  END;

  MACRO NDSComS():MONEY //  НДС на комиссию при реализации
    if( m_NDSComS == NULL )
      m_NDSComS = (m_RS.NDSComSale * (this.Qnty()/this.QS()));       
    end;
    return m_NDSComS;
  END;

  MACRO NDSComB():MONEY // НДС на комиссию при приобретении  
    if( m_NDSComB == NULL )
      m_NDSComB = (m_RS.NDSComBuy * Qnty()/this.QB());        
    end;
    return m_NDSComB;
  END;

  MACRO PrBvp():DOUBLE // Цена приобретения - в валюте
     if(this.IsDUDealS() == 1)
       return 0;
     end;
     return m_RS.BuyPrice;
  END;

  MACRO PrBNom():DOUBLE //  Цена приобретения, % от номинала
     if( m_PrBNom == NULL )
       if(this.IsDUDealS() == 1)
         m_PrBNom = 0;
       else 
         m_PrBNom = this.DealBuyPrice();
       end;
     end;
     return m_PrBNom;
  END;

  /*Сумма частичного погашения номинала за период от даты открытия до даты закрытия КП (по условиям выпуска), в валюте номинала*/
  MACRO AmortPozVN()
    if( m_AmortPozVN == null )
      m_AmortPozVN = GetPartialSumByPeriod( m_RS.FIID, this.Qnty(), this.DDS()+1, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), null, this.GetDrawingDate() );
    end;
    return m_AmortPozVN; 

  END;

  /*Сумма частичного погашения номинала за период от даты открытия до даты закрытия КП (по условиям выпуска), руб*/
  MACRO AmortPozRub()
    if( m_AmortPozRub == null )
      m_AmortPozRub = 0;
      m_AmortPozRub = GetPartialSumByPeriod_Rub( m_RS.FIID, this.Qnty(), this.DDS()+1, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), null, this.GetDrawingDate() );    
    end; 
    return m_AmortPozRub; 
  END;

  /*Расходы, связанные с закрытием короткой позиции*/
  MACRO RashAll()
    if(this.IsDUDealS() == 1)
      return F(0);
    elif( m_ReportKind == SHREP_REG_0611 )
      return  F(GetComS()+"+"+GetSumBtax()+"+"+GetComB());    
    elif( m_ReportKind == SHREP_REG_0612 )
      return  F(GetComS()+"+"+GetSumBtax()+"+"+GetComB() +"+"+ GetAmortPozVN());
    elif( m_ReportKind == SHREP_REG_0615 )  
      return  F(GetComS()+"+"+GetSumBtax()+"+"+GetComB() +"+"+ GetAmortPozRub());
    end;   
  END;

  /*Курс постановки на баланс (спец. Курс)*/
  MACRO CrSpezS():double
     if( m_CrSpezS == NULL )
        m_CrSpezS = ПолучитьКурсПостановкиНаБаланс(DealSale());
     end;
     return m_CrSpezS;
  END;

   /* Курс пересчета ст-ти реализации в рублевый эквивалент */
  MACRO CrSD(CourseDate):DOUBLE
    if(CourseDate == NULL)
       CourseDate = IIF(DPS() != ZeroDate, min(DPS(), DDS()), DDS());
    end;
      m_CrSD = CrSpezS();
      if (m_CrSD != $0.0)
        return m_CrSD;
      else
        if (VprS() == NATCUR)
          m_CrSD = 1.0;
        else
          m_CrSD = GetRateOnDateCrossDbl(CourseDate,
                                         VprS(),
                                         NATCUR,
                                         true);
        end;
      end;

    if (m_CrSD == NULL)
      m_CrSD = 0.0;
    end;

    return m_CrSD;
  END;
  
  /*Параметр Val_Market_New для сделок <CodeS>*/
  MACRO Val_MarketS()
    return SQL_ConvTypeStr(m_RS.SaleVal_Market);
  END;

  MACRO Cr_Val_MrkSZ() 
     if( m_Cr_Val_MrkSZ == null )
       m_Cr_Val_MrkSZ = 0.0;
       var ISO = IIF(StrIsNumber(Val_MarketS()), int(Val_MarketS()), Val_MarketS());
       if( ISO != "" )
          if( ISO == "%" )
            m_Cr_Val_MrkSZ = GetRateOnDateCrossDbl(this.DZS(), m_RS.FaceValueFI, NATCUR, true);
          else
            var fin = TRecHandler("fininstr.dbt");
            if( ПолучитьФинИнПоISO(ISO, fin) )
              m_Cr_Val_MrkSZ = GetRateOnDateCrossDbl(this.DZS(), fin.rec.FIID, NATCUR, true);
            else
              MsgBox("Не найден финансовый инструмент по коду ISO: " + ISO);
            end;
         end;
       end;
    end;
    return m_Cr_Val_MrkSZ; 
  END;

  MACRO printCr_Val_MrkSZ()
     return ВыводЧерезФормулу(this.Cr_Val_MrkSZ());
  END;

  /*Разница между датой поставки и датой платежа*/
  MACRO DPS_DDS()
    var  v_DPS_DDS = this.DPS();
     if( v_DPS_DDS==ZeroDate )
        return 0;
     end;

     return (v_DPS_DDS - this.DDS());
 
  END;

  MACRO QuoteValueS()
    if(this.IsDUDealS() == 1) return 0;
    end;
    return m_RS.SaleMarketQuoteValue;
  END;

  MACRO QuoteValueB()
    if(this.IsDUDealS() == 1) return 0;
    end;
    return m_RS.BuyMarketQuoteValue;
  END;

  /*Курс постановки на баланс (спец. Курс)*/
  MACRO CrSpezB():double
     if( m_CrSpezB == NULL )
        m_CrSpezB = ПолучитьКурсПостановкиНаБаланс(DealBuy());
     end;
     return m_CrSpezB;
  END;

  /* Курс пересчета ст-ти приобретения в рублевый эквивалент */
  MACRO CrBD():DOUBLE
    if (m_CrBD == NULL)
      m_CrBD = CrSpezB();
      if (m_CrBD != $0.0)
        return m_CrBD;
      else
        if (this.VprB() == NATCUR)
          m_CrBD = 1.0;
        else
          m_CrBD = GetRateOnDateCrossDbl(IIF(this.DPB() != ZeroDate,
                                             min(this.DPB(), this.DDB()),
                                         this.DDB()),
                                         this.VprB(),
                                         NATCUR,
                                         true);
        end;
      end;
    end;

    if (m_CrBD == NULL)
      m_CrBD = 0.0;
    end;

    return m_CrBD;
  END;

  /*Параметр Val_Market_New для сделок <CodeB>*/
  MACRO Val_MarketB()
    if(this.IsDUDealS() == 1) return "";
    end;
    return SQL_ConvTypeStr(m_RS.BuyVal_Market); 
  END;
 
  MACRO Cr_Val_MrktBZ()
    if( m_Cr_Val_MrktBZ == null)
      m_Cr_Val_MrktBZ = 0.0;
      var ISO = IIF(StrIsNumber(Val_MarketB()), int(Val_MarketB()), Val_MarketB());
      if( ISO != "" )
        if( ISO == "%" )
          m_Cr_Val_MrktBZ = GetRateOnDateCrossDbl(this.DZB(), m_RS.FaceValueFI, NATCUR, true);
        else
          var fin = TRecHandler("fininstr.dbt");
          if( ПолучитьФинИнПоISO(ISO, fin) )
            m_Cr_Val_MrktBZ = GetRateOnDateCrossDbl(this.DZB(), fin.rec.FIID, NATCUR, true);
          else
            MsgBox("Не найден финансовый инструмент по коду ISO: " + ISO);
          end;
        end;
      end;
   end;
   return m_Cr_Val_MrktBZ;
 
  END;

  MACRO printCr_Val_MrktBZ()
     return ВыводЧерезФормулу(this.Cr_Val_MrktBZ());
  END;

  /*Разница между датами пла-тежа и поставки*/
  MACRO DPB_DDB()
    var  v_DPB_DDB = this.DPB();
     if( v_DPB_DDB==ZeroDate )
        return 0;
     end;
     return (v_DPB_DDB - this.DDB()); 
  END;

  /*курс  ЦБ РФ валюты <VPrB> на дату <DDB>*/
  MACRO CrDB(CourseDate)
    if(CourseDate == NULL)
       CourseDate = DDB();
    end;
 
    if( m_CrDB == NULL )
      if((m_RS.FaceValueFI == NATCUR) and (FI_IsBond(m_RS.FIID)))
        m_CrDB = GetRateOnDateCrossDbl( CourseDate, this.VprB(), NATCUR, true );
      elif((m_RS.FaceValueFI != NATCUR) and (FI_IsBond(m_RS.FIID)))
        m_CrDB = GetRateOnDateCrossDbl( CourseDate, m_RS.FaceValueFI, NATCUR, true );
      else
        m_CrDB = GetRateOnDateCrossDbl( CourseDate, this.VprB(), NATCUR, true );
      end;
   end;
   if((m_CrDB == NULL) or (m_CrDB == 0.0))
     m_CrDB = NULL;
     return 1.0;
   end;
   return m_CrDB;

  END;

  MACRO Дн2():DATE // максимальная из двух дат: (<H0.1>; <DDS>+1)
     return MAX( this.H0_1(), this.DDS()+1 );
  END;

  MACRO DDS():DATE
    if(IsDUDealB() == 1)
      return SQL_ConvTypeDate(m_RS.ImportDUDate);
    end;
    return SQL_ConvTypeDate(m_RS.SaleDate);
  END;

  /*НКД, уплаченный при приобретении (на дату закрытия короткой позиции )в валюте сделки*/
  MACRO NkdCloseVp() 
    if(m_NkdCloseVp == null)
       if( ( m_ReportKind == SHREP_REG_0612 ) or (( m_ReportKind == SHREP_REG_0615 ) and (m_TaxDepositoryMode))) 
         m_NkdCloseVp = m_RS.NKDB * this.Qnty() / m_RS.BuyAmount;
       elif(( m_ReportKind == SHREP_REG_0615 ) and (not m_TaxDepositoryMode))
         if( this.VPrB() != NATCUR )
           m_NkdCloseVp = m_RS.NKDB * this.Qnty() / m_RS.BuyAmount;
         else
           if( SmartConvertSum( m_NkdCloseVp, m_RS.NKDB * this.Qnty() / m_RS.BuyAmount, iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), m_RS.FaceValueFI, NATCUR, true) == false )
             m_NkdCloseVp = $0.0;
           end;         
         end;                       
       end;
    end;
    return m_NkdCloseVp; 
  END;

  /*НКД, уплаченный при приобретении (на дату закрытия короткой позиции) в рублях*/
  MACRO NkdCloseRub()
   var ReGVal = 0;
   var CourseDate;

   GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V21", V_INTEGER, RegVal, NULL);
   if(RegVal == 0)
      CourseDate = DDB();
   elif(RegVal == 1)
      CourseDate = IIF(DDB() < DPB(), DDB(), DPB());
   elif(RegVal == 2)
      CourseDate = IIF(DDB() > DPB(), DDB(), DPB());
   end;

   if(this.IsDUDealB() == 1)
     CourseDate = this.ImportDUDate()
   end; 

   if(m_NkdCloseRub == NULL)
     if (this.VprB() == NATCUR)
       m_NkdCloseRub= this.NkdCloseVp();
     else
      m_NkdCloseRub = this.NkdCloseVp() * this.CrDB(CourseDate);
     end;
   end;
   return m_NkdCloseRub;
  END;
  
  MACRO CoupPrevVN()
   if( m_CoupPrevVN == NULL )
     m_CoupPrevVN = $0;
     if( this.DDS() < this.H0_1() )
       m_CoupPrevVN = GetCouponSumByPeriod( m_RS.FIID, this.Qnty(), this.DDS()+1, this.H0_1()-1 );
     end;
   end;
   return m_CoupPrevVN;

  END;
 
  MACRO CoupVN():MONEY //  Купонный доход, полученный от эмитента при погашении купонов в отчетном (налоговом) периоде, в валюте номинала
    if( m_CoupVN == NULL )
       m_CoupVN = GetCouponSumByPeriod( m_RS.FIID, this.Qnty(), this.Дн2(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), null, this.GetDrawingDate() );
    end;
    return m_CoupVN;
  END;

 

  MACRO CoupPrevRub():MONEY // Сумма купонов, выплаченных эмитентом до начала текущего отчетного (налогового) периода - в рублях
     if( m_CoupPrevRub == NULL )
        if( this.DDS() < this.H0_1() )
           m_CoupPrevRub = GetCouponSumByPeriod_Rub( m_RS.FIID, this.Qnty(), this.DDS()+1, this.H0_1()-1, m_RS.FaceValueFI );
        else
           m_CoupPrevRub = $0;
        end;
     end;
     return m_CoupPrevRub;
  END;

  MACRO CoupRub()
    if( m_CoupRub == NULL )
        if(m_ReportKind == SHREP_REG_0615)
           m_CoupRub = GetCouponSumByPeriod_Rub( m_RS.FIID, this.Qnty(), this.Дн2(), iif(this.IsDUDealB() == 1, this.ImportDUDate(), this.DDB()), m_RS.FaceValueFI );
        end;
     end;
     return m_CoupRub;  
  END;

  MACRO NkdSrub():MONEY // НКД полученный при реализации (погашении) - Сумма, руб.
    var RegVal = 0;
    var CourseDate;

    GetRegistryValue("SECUR\\НАЛОГОВЫЙ УЧЕТ\\V22", V_INTEGER, RegVal, NULL);
    if((RegVal == 0) OR (this.IsDUDealS == 1))
       CourseDate = DDS();
    elif(RegVal == 1)
       CourseDate = IIF(DDS() < DPS(), DDS(), DPS());
    elif(RegVal == 2)
       CourseDate = IIF(DDS() > DPS(), DDS(), DPS());
    end;

    if(m_NkdSrub == NULL)
      if(this.VPrS() == NATCUR)
        m_NkdSrub = this.NkdSvp()
      else 
        m_NkdSrub = this.NkdSvn() * this.CrSD(CourseDate);
      end;
    end;
    return m_NkdSrub;
  END;

  MACRO SaveFIIDForForm_cons(FIID:integer)
     var query, exec;
     query =   " INSERT INTO dspprtcst_tmp ( T_FIID ) VALUES (?) ";
     exec = RSDCommand(query);
     exec.addParam( "", RSDBP_IN, FIID );
     exec.execute();
  END;

  MACRO TaxeAmort()
   return F(GetSumSrub() + "+" + GetDifS() + "-" +  GetRashAll()); 
   
  END;
  /*Процентный расход по операции, связанной с открытием короткой позиции - всего, руб*/
  MACRO ProcRashAllRub()
    if( m_ProcRashAllRub == $0.0)
      if( m_ReportKind == SHREP_REG_0612 )
        m_ProcRashAllRub = this.NkdCloseVp()+this.CoupPrevVN()+ this.CoupVN() - this.NkdSvp();
      elif( m_ReportKind == SHREP_REG_0615 )
        m_ProcRashAllRub = this.NkdCloseRub() + this.CoupPrevRub() + this.CoupRub() - this.NkdSrub();
      end;
    end;
    return m_ProcRashAllRub;    
  END;
  
  MACRO TaxeNKD()
    return F(GetProcRashRepRub()+"*" +(-1)); 
  END;

  MACRO TaxeAll()
    if( m_ReportKind == SHREP_REG_0611 )
      return F(GetSumSrub() +"+"+ GetDifS()+"-" + GetRashAll());
    elif(( m_ReportKind == SHREP_REG_0612 ) or( m_ReportKind == SHREP_REG_0615))
      return F(GetTaxeAmort() + "+"+  GetTaxeNKD());
    end;
  END;
  
  MACRO CoupCount():INTEGER
    return GetCountCouponInPeriod(m_RS.t_FIID, this.Дн2(), this.DDB());
  END;

  MACRO LastCoupDate()
    return date(GetMaxCouponDrawingDateInPeriod(m_RS.t_FIID, this.Дн2(), this.DDB()));
  END;

  MACRO ProcRashRepRub()
    return F(GetProcRashAllRub() +  "-" + GetProcRashPrevRub());
  END;

  MACRO ProcRashRepRub_17( Preferential:bool ):money
     var RetVal = $0.0, RetVal_VP = $0.0;
     var i = 0;

     while( i < m_TaxPeriods.m_Periods.Size )
        if( m_TaxPeriods.m_Periods[i].Preferential == Preferential )

           // + (если D2 = <DDS>, то <NkdSvp>
           if( m_TaxPeriods.m_Periods[i].EndDate == this.DDS() )
              RetVal_VP = RetVal_VP + this.NkdSvp();
           else
              RetVal = RetVal + НКД(m_RS.t_FIID, 1, m_TaxPeriods.m_Periods[i].EndDate);
           end;

           // - (если D1 = <DDB>, то <NkdBvp>)
           if( m_TaxPeriods.m_Periods[i].BegDate == this.DDB() )
              RetVal_VP = RetVal_VP - this.NkdBvp();
           else
              RetVal = RetVal - НКД(m_RS.t_FIID, 1, m_TaxPeriods.m_Periods[i].BegDate);
           end;

           RetVal = RetVal + GetCouponSumByPeriod(m_RS.FIID, 1, m_TaxPeriods.m_Periods[i].BegDate+1, m_TaxPeriods.m_Periods[i].EndDate);

        end;
        i = i + 1;
     end;

     RetVal = RetVal * this.Qnty() + RetVal_VP;

     return RetVal;
  END;

  MACRO ProcRashRepRub1()
    var RetVal;

    if( (m_RS.TaxGroup == 1) or (m_RS.TaxGroup == 3) or (m_RS.TaxGroup == 5) or (m_RS.TaxGroup == 101) or (m_RS.TaxGroup == 7) or
        (m_RS.TaxGroup == 15) or (m_RS.TaxGroup == 21) or (m_RS.TaxGroup == 31) )
       RetVal = F(GetProcRashRepRub());
    elif( (m_RS.TaxGroup == 9) or (m_RS.TaxGroup == 18) or (m_RS.TaxGroup == 19) or (m_RS.TaxGroup == 29) or (m_RS.TaxGroup == 32) or
          (m_RS.TaxGroup == 33) or (m_RS.TaxGroup == 43) or (m_RS.TaxGroup == 109) or (m_RS.TaxGroup == 130) )
       RetVal = $0.0;
    elif( m_RS.TaxGroup == 17 )
       RetVal = ProcRashRepRub_17(true);
    else
       RetVal = $0.0;
    end;

    return RetVal;
  END;

  MACRO ProcRashRepRub2()
    var RetVal;

    if( (m_RS.TaxGroup == 1) or (m_RS.TaxGroup == 3) or (m_RS.TaxGroup == 5) or (m_RS.TaxGroup == 101) or (m_RS.TaxGroup == 7) or
        (m_RS.TaxGroup == 15) or (m_RS.TaxGroup == 21) or (m_RS.TaxGroup == 31) )
       RetVal = $0.0;
    elif( (m_RS.TaxGroup == 9) or (m_RS.TaxGroup == 18) or (m_RS.TaxGroup == 19) or (m_RS.TaxGroup == 29) or (m_RS.TaxGroup == 32) or
          (m_RS.TaxGroup == 33) or (m_RS.TaxGroup == 43) or (m_RS.TaxGroup == 109) or (m_RS.TaxGroup == 130) )
       RetVal = F(GetProcRashRepRub());
    elif( m_RS.TaxGroup == 17 )
       RetVal = ProcRashRepRub_17(false);
    else
       RetVal = $0.0;
    end;

    return RetVal;
  END;

  MACRO CrVnOnDate(on_date:DATE)
     var CrVnDs= NULL;
        if((m_RS.FaceValueFI == NATCUR) and (FI_IsBond(m_RS.FIID)))
          CrVnDs = GetRateOnDateCrossDbl( on_date, this.VN(), NATCUR, true );
        elif((m_RS.FaceValueFI != NATCUR) and (FI_IsBond(m_RS.FIID)))
          CrVnDs = GetRateOnDateCrossDbl( on_date, m_RS.FaceValueFI, NATCUR, true );
        else
          CrVnDs = GetRateOnDateCrossDbl( on_date, this.VN(), NATCUR, true );
        end;     

     if((CrVnDs == NULL) or (CrVnDs == 0.0))
       CrVnDs = NULL;
       return 1.0;
     end;

     return CrVnDs;
  
  END;

  MACRO ISIN()
    if (m_RS.ISIN != "")
       return "" + m_RS.ISIN;
    else 
       return "" + m_RS.LSIN;
    end;
  END;

  MACRO NkdPrevRub():MONEY //  Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода - Сумма, руб
     if( m_NkdPrevRub == NULL )
        SmartConvertSum( m_NkdPrevRub, this.NkdPrevVN(), this.H0_1()-1, m_RS.FaceValueFI, NATCUR, true );
     end;
     return m_NkdPrevRub;
  END;

  MACRO NKDSvp()
    if(m_NKDSvp == null)
      if( ( m_ReportKind == SHREP_REG_0612 ) or (( m_ReportKind == SHREP_REG_0615 ) and (m_TaxDepositoryMode)))
        m_NKDSvp = this.NKDSale()*this.Qnty()/this.QS();
      elif(( m_ReportKind == SHREP_REG_0615 ) and (not m_TaxDepositoryMode))
        if( this.VPrS() != NATCUR )
          m_NKDSvp = this.NKDSale()*this.Qnty()/this.QS();
        else
          if( SmartConvertSum( m_NKDSvp, this.NKDSale()*this.Qnty()/this.QS(), DDS(), m_RS.FaceValueFI, NATCUR, true) == false )
            m_NKDSvp = $0.0;
          end;           
        end;
      end;
    end;
    return m_NKDSvp;
  END;

  MACRO NKDSvn()
    if(m_NKDSvn == null )
      if( m_ReportKind == SHREP_REG_0615 )
        if( this.VPrSNumber()== this.VN())
          m_NKDSvn = this.NkdSvp();
        elif( this.VPrS()== NATCUR)
          m_NKDSvn = this.NkdSvp()/ CrVnOnDate(this.DDS());
        end;
      end;
    end;
    return m_NKDSvn;
  END;

  MACRO K()
    var RetVal = 1.0;
    if(this.CoupPrevVN() == 0)  
      RetVal = CrVnOnDate( this.H0_1()-1); 
    elif(this.CoupPrevVN() > 0)
      RetVal = CrVnOnDate( this.DDS()); 
    end;
    return RetVal;
  END;

  MACRO ProcRashPrevRub()
   var RetVal = $0.0;
    if(this.DDS() >= this.H0_1())
      RetVal = 0.0;
    elif (this.DDS() < this.H0_1())
      if( m_ReportKind == SHREP_REG_0612 )
        RetVal = this.NkdPrevVN() + this.CoupPrevVN() - this.NkdSvp();
      elif( m_ReportKind == SHREP_REG_0615 )
        RetVal =  this.NkdPrevRub() + this.CoupPrevRub() - this.NkdSvn() * this.K();
      end;
    end;
    return RetVal;
  END;   

  MACRO NkdPrevVN():MONEY // Процентный доход, учтенный для целей налогообложения в предыдущем налоговом периоде, но не полученный от эмитента на начало отчетного (налогового) периода  :
     if( m_NkdPrevVN == NULL )
        if( this.DDS() < this.H0_1() )
          m_NkdPrevVN = НКД( m_RS.t_FIID, this.Qnty(), this.H0_1()-1);
        else
          m_NkdPrevVN = $0;
        end;
     end;
     return m_NkdPrevVN;
  END;  

  MACRO FinRes()
    var RetVal = $0.0;
    if( m_ReportKind == SHREP_REG_0611)
      RetVal = F(GetSumSrub() + "-" + GetSumBrub());
    elif ( m_ReportKind == SHREP_REG_0612)
      RetVal = F(GetSumSrub() + "-"+ GetSumBrub()+ "-" + GetAmortPozVN() + "-" + GetProcRashRepRub());
    elif ( m_ReportKind == SHREP_REG_0615)
      RetVal = F(GetSumSrub()+ "-" + GetSumBrub()+ "-"+ GetAmortPozRub()+ "-" + GetProcRashRepRub());
    end;
    return RetVal;
  END;

  MACRO Nom_H01()
    return GetFaceValue( m_RS.t_FIID, this.DDB(), true, false );
  END;
      
  MACRO Nom_H02()
    return GetFaceValue( m_RS.t_FIID, MAX(this.H0_1(),this.DDS()), true, false );
  END;
      
  MACRO PlusNom_IN()
    return F(FormulaIF()+"("+GetNomH02()+">"+GetNomH01()+";("+GetNomH02()+"-"+GetNomH01()+")*"+GetQnty()+";"+"0)");
  END;
    
  MACRO MinusNom_IN() 
    return F(FormulaIF()+"("+GetNomH02()+"<"+GetNomH01()+";-("+GetNomH02()+"-"+GetNomH01()+")*"+GetQnty()+";"+"0)");
  END;

  MACRO Nom_IN_Before()
    if(this.DDS() < this.H0_1())
      return (GetFaceValue( m_RS.t_FIID, this.H0_1()-1, true, false ) - GetFaceValue( m_RS.t_FIID, this.DDS(), true, false )) * this.Qnty();
    end;

   return 0; 
  END;

  MACRO TaxGroup():INTEGER
    return m_RS.TaxGroup;
  END;

  PRIVATE MACRO GetFormulaSummREG_rshb()
    var i = 0, StrSumm = "", BeginRow, CellAddr;
    while( i < m_NumCellAutoSumm.Size )

        CellAddr = m_ReportTable.AddressDiapazon.GetCell( 0, NC( m_NumCellAutoSumm[i] ) );

        if( m_ReportTable.AddressDiapazon.GetNumbRow() > 0 )
          StrSumm = m_ReportTable.GetFormulaSummREG( CellAddr, null, m_ReportTable.bRowTable, m_ReportTable.bRowTable+m_ReportTable.AddressDiapazon.GetNumbRow()-1 );
        else
          StrSumm = "";
        end;

        if( m_FormulaSumm[i] == null ) /*для первой вкладки*/
          m_FormulaSumm[i] = "formula=";
        elif( substr(StrSumm, 1,1) == "=" )
          StrSet( StrSumm, 1, "+" );
        end;
        m_FormulaSumm[i] = m_FormulaSumm[i] + StrSumm;
        i = i + 1;
    end;
  END;

  /*По замечаниям ГПБ убрано наименование листа из формулы итогов*/
  MACRO GetFormulaSumm()
     if((m_CopyAutoSumRange == null) or (m_CopyAutoSumRange == ""))
        GetFormulaSummREG();
     else
        GetFormulaSummREG_rshb();
     end;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
     var ByQuoted = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_BYQUOTED_2014 );
     var ByNoQuoted = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_BYNOQUOTED_2014 );

     if (SecondStart)
        m_RunByQuoted = false;
        m_RunByNoQuoted = true;
     else
        if((ByQuoted == SET_CHAR) and (m_IsPrintByQuoted == false))
          m_IsPrintByQuoted = true;
          
          m_RunByQuoted = true;
          m_RunByNoQuoted = false;
        elif((ByNoQuoted == SET_CHAR) and (m_IsPrintByNoQuoted == false))
          m_IsPrintByNoQuoted = true;

          m_RunByQuoted = false;
          m_RunByNoQuoted = true;
        end;
     end;

     m_H01 = ShRepReg2014_Form.GetFieldValue(PNFLD_SHREP_REG_BEGINDATE_2014);
     m_H02 = ShRepReg2014_Form.GetFieldValue(PNFLD_SHREP_REG_ENDDATE_2014);
   END;
   
   PRIVATE MACRO SetAutoFilter()
 
      if( ExistsSheet( SHEET_0611s ) )
         m_ObjTemplateXLS.SetAutoFilter("A28:Q28", SHEET_0611s);
      end;
 
      if( ExistsSheet( SHEET_0612 ) )
         m_ObjTemplateXLS.SetAutoFilter("A28:BX28", SHEET_0612);
      end;
 
      if( ExistsSheet( SHEET_0612s ) )
         m_ObjTemplateXLS.SetAutoFilter("A28:Y28", SHEET_0612s);
      end;

      if( ExistsSheet( SHEET_0615s ) )
         m_ObjTemplateXLS.SetAutoFilter("A28:X28", SHEET_0615s);
      end;
   END;

  PRIVATE MACRO EndReport()
    EndReport();
     SetAutoFilter();
  END;

  MACRO GetRepTitle()
    var RepTitle = "";

    if(m_ReportKind == SHREP_REG_0611)
      RepTitle = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по акциям, паям и депозитарным распискам";
    elif(m_ReportKind == SHREP_REG_0612)
      RepTitle = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по купонным облигациям (номинированным в валюте РФ)";
    elif(m_ReportKind == SHREP_REG_0615)
      RepTitle = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по купонным облигациям (номинированным в иностранной валюте)";     
    end;
    return RepTitle;
  END;

  MACRO H0_13()
    var Quoted = "";

    if( m_RunByQuoted == true )
      Quoted = "Обращающиеся на Бирже";
    elif( m_RunByNoQuoted == true )
      Quoted = "Не обращающиеся на Бирже";      
    end;
    return Quoted;
  END;

  PRIVATE MACRO GetFromForm_YEAR()
     return ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_YEAR_2014 );
  END;

  PRIVATE MACRO GetFromForm_GROWTH()
     var y, y2;
     ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_GROWTH_2014, @y, @y2 );
     if(y2 == "X")
        return true;
     end;

     return false;
  END;

  PRIVATE MACRO GetFromForm_PERIOD()
     var y, y2;
     ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_PERIOD_2014, @y, @y2 );
     return y2;
  END;


   macro GetYear():string
     var y, y2;
     y2 = GetFromForm_YEAR();
     return string(y2);

   end;

   macro GetPeriodCode():string
      var code = "";
      var p, p2;
      var gr:bool = false;

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3)))
         code = "21";
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "31";
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "33";
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = "34";
      end;

      return code;
   end;

   macro GetPeriodTxt():string
      const ytxt = " ГОДА";
      const y2txt = " ГОД";
      const mtxt = " МЕСЯЦЕВ ";
      const m2txt = " МЕСЯЦА ";
      const qtxt = " КВАРТАЛ ";

      var code = "";
      var p, p2;
      var gr:bool = false;
      var y = GetYear();

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3))) // 1 кв
         code = "1"+qtxt+y+ytxt;
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "I ПОЛУГОДИЕ " + y + ytxt;
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "9" + mtxt + y + ytxt;
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = y + y2txt;
      elif((p2 == 1))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      elif(gr and (p2 > 1) and (p2 < 5))
         code = string(p2) + m2txt + y + ytxt;
      elif(gr and (p2 > 4) and (p2 < 12))
         code = string(p2) + mtxt + y + ytxt;
      elif((not gr) and (p2 > 13) and (p2 < 17))
         code = string(p2-12) + qtxt + y + ytxt;
      elif((not gr) and (p2 > 0) and (p2 < 13))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      end;

      return code;
   end;

   macro SetCopyAutoSumRange(r)
      m_CopyAutoSumRange = r;
   end;

  macro SetAutoSize() //Автоматическая ширина для столбцов
    if( m_ReportKind == SHREP_REG_0611) 
      m_ObjTemplateXLS.SetAutoFit("C:BM", SHEET_0611);             
    elif( m_ReportKind == SHREP_REG_0615)
      m_ObjTemplateXLS.SetAutoFit("C:CC", SHEET_0615);
    end;
  end;

  macro PrintLineAutoSumma_rshb()
    var Address;
    var i = 0, OldSheet;
  
    if((m_CopyAutoSumRange == null) or (m_CopyAutoSumRange == ""))
      return;
    end;

    if( not m_UseTemplate )
      return;
    end;

    if( m_ItogLineName != NULL ) // в первой строке таблицы
      OldSheet = m_ObjTemplateXLS.SheetName();
      m_ObjTemplateXLS.SheetChange( m_FirstSheetName );
    end;

    while( i < m_NumCellAutoSumm.Size )
      Address = CAddressDiapazon(m_CopyAutoSumRange).GetCell(0, NC( m_NumCellAutoSumm[i] ) );
      m_ObjTemplateXLS.SetValue_NameCell( Address, m_FormulaSumm[i] );
      i = i + 1;
    end;

    if( m_ItogLineName != NULL ) // в первой строке таблицы
      m_ObjTemplateXLS.SheetChange( OldSheet );
    end;

  end;

  macro PrintLineAutoSumma()
    if((m_CopyAutoSumRange == null) or (m_CopyAutoSumRange == ""))
        PrintLineAutoSumma();
    else
        PrintLineAutoSumma_rshb();
    end;
  end;

   MACRO SetOnAutoFilter(sheet, range)
     if( ExistsSheet( sheet ) )
         m_ObjTemplateXLS.SetAutoFilter(range, sheet);
     end;
   end;

   MACRO DeleteRows(sheet, range)
      if( ExistsSheet( sheet ) )
         m_ObjTemplateXLS.RemoveRow(range, sheet);
      end;
   end;

   macro GetCodeNU_0616_L():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "1-070000-ИАР-07-1/27";
     elif( m_RunByNoQuoted == true )
        Quoted = "1-070000-ИАР-07-1/35";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0616_N():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "1-070000-ИАР-07-1/28";
     elif( m_RunByNoQuoted == true )
        Quoted = "1-070000-ИАР-07-1/36";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0616_X():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "4-070000-ИАР-07-7/28";
     elif( m_RunByNoQuoted == true )
        Quoted = "4-070000-ИАР-07-7/36";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0616_AG():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "4-070000-ИАР-07-7/27";
     elif( m_RunByNoQuoted == true )
        Quoted = "4-070000-ИАР-07-7/35";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0616_AK():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "5-070300-ИАР-07-10/9";
     elif( m_RunByNoQuoted == true )
        Quoted = "5-070300-ИАР-07-10/12";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0616_AM():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "2-010301-ИАР-07-3/11";
     elif( m_RunByNoQuoted == true )
        Quoted = "2-010301-ИАР-07-3/14";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0616_AO():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "2-110000-ИАР-07-6/3";
     elif( m_RunByNoQuoted == true )
        Quoted = "2-110000-ИАР-07-6/6";
     end;
     return Quoted;
   end;

   macro GetAnRegister_0615():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "Аналитический регистр № АР-07-0615-Обр-Разные";
     elif( m_RunByNoQuoted == true )
        Quoted = "Аналитический регистр № АР-07-0615-неОбр-Разные";
     end;
     return Quoted;
   end;

   macro GetAnRegisterTxt_0615():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по купонным облигациям, в иностранной валюте (обращающиеся на ОРЦБ)";
     elif( m_RunByNoQuoted == true )
        Quoted = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по купонным облигациям, в иностранной валюте (не обращающиеся на ОРЦБ)";
     end;
     return Quoted;
   end;

   macro GetAnRegisterCode_0615():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "АР-07-0615-Обр-Разные";
     elif( m_RunByNoQuoted == true )
        Quoted = "АР-07-0615-неОбр-Разные";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0611_L():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "1-070000-ИАР-07-1/21";
     elif( m_RunByNoQuoted == true )
        Quoted = "1-070000-ИАР-07-1/29";
     end;
     return Quoted;
   end;

   macro GetCodeNU_0611_AA():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "4-070000-ИАР-07-7/21";
     elif( m_RunByNoQuoted == true )
        Quoted = "4-070000-ИАР-07-7/29";
     end;
     return Quoted;
   end;

   macro GetAnRegister_0611():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "Аналитический регистр № АР-07-0611-Обр-Разные";
     elif( m_RunByNoQuoted == true )
        Quoted = "Аналитический регистр № АР-07-0611-неОбр-Разные";
     end;
     return Quoted;
   end;

   macro GetAnRegisterTxt_0611():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по акциям, паям и депозитарным распискам (обращающиеся на ОРЦБ)";
     elif( m_RunByNoQuoted == true )
        Quoted = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по акциям, паям и депозитарным распискам (не обращающиеся на ОРЦБ)";
     end;
     return Quoted;
   end;

   macro GetAnRegisterCode_0611():string
     var Quoted = "";
     if( m_RunByQuoted == true )
        Quoted = "АР-07-0611-Обр-Разные";
     elif( m_RunByNoQuoted == true )
        Quoted = "АР-07-0611-неОбр-Разные";
     end;
     return Quoted;
   end;

   MACRO PrintHeader( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
     var Quoted = "", RepTitle = "", SubKind = 0;

     if( m_RunByQuoted == true )
        Quoted = "Обращающиеся на Бирже";
     elif( m_RunByNoQuoted == true )
        Quoted = "Не обращающиеся на Бирже";      
     end;
     
     if(m_ReportKind == SHREP_REG_0611)
       RepTitle = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по акциям, паям и депозитарным распискам";
     elif(m_ReportKind == SHREP_REG_0612)
       RepTitle = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по купонным облигациям (номинированным в валюте РФ)";
     elif(m_ReportKind == SHREP_REG_0615)
       RepTitle = "Доходы (расходы) по операциям, связанным с открытием (закрытием) коротких позиций по купонным облигациям (номинированным в иностранной валюте)";     
     end;
      
     PrintFormatString( "",
                       FldPref+"Today",           string(Date():f)+" "+string(Time()),
                       FldPref+"Oper",            string({oper}),
                       FldPref+"NameOper",        GetOperRecByID({oper}).Name,
                       FldPref+"H0.A:l",          this.H0_A(),
                       FldPref+"H0.B",            this.H0_B_INN(),
                       FldPref+"H0.C",            this.H0_B_KPP(),
                       FldPref+"H0.3",            H03,
                       FldPref+"H0.6",            RepTitle,
                       FldPref+"H0.1",            this.H0_1(),
                       FldPref+"H0.2",            this.H0_2(),
                       FldPref+"H0.9",            this.H0_9(),
                       FldPref+"H0.11",           this.H0_11(),
                       FldPref+"H0.13",           Quoted
                     );
  END;

  MACRO PrintHeader_0615( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
     PrintFormatString( "",
                       FldPref+"NameOper",         Oper_rshb(),//GetOperRecByID({oper}).Name,
                       FldPref+"H0_Year",          GetYear(),
                       FldPref+"H0_PeriodCode",    GetPeriodCode(),
                       FldPref+"H0_PeriodTxt",     GetPeriodTxt(),
                       FldPref+"H0_AnRegistr",     GetAnRegister_0615(),
                       FldPref+"H0_AnRegistrTxt",  GetAnRegisterTxt_0615(),
                       FldPref+"H0_AnRegistrCode", GetAnRegisterCode_0615(),
                       FldPref+"H0_CodeNU_L",      GetCodeNU_0616_L(),
                       FldPref+"H0_CodeNU_N",      GetCodeNU_0616_N(),
                       FldPref+"H0_CodeNU_X",      GetCodeNU_0616_X(),
                       FldPref+"H0_CodeNU_AG",     GetCodeNU_0616_AG(),
                       FldPref+"H0_CodeNU_AK",     GetCodeNU_0616_AK(),
                       FldPref+"H0_CodeNU_AM",     GetCodeNU_0616_AM(),
                       FldPref+"H0_CodeNU_AO",     GetCodeNU_0616_AO()
                     );
  END;

  MACRO PrintHeader_0611( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
     PrintFormatString( "",
                       FldPref+"NameOper",         Oper_rshb(),//GetOperRecByID({oper}).Name,
                       FldPref+"H0_Year",          GetYear(),
                       FldPref+"H0_PeriodCode",    GetPeriodCode(),
                       FldPref+"H0_PeriodTxt",     GetPeriodTxt(),
                       FldPref+"H0_AnRegistr",     GetAnRegister_0611(),
                       FldPref+"H0_AnRegistrTxt",  GetAnRegisterTxt_0611(),
                       FldPref+"H0_AnRegistrCode", GetAnRegisterCode_0611(),
                       FldPref+"H0_CodeNU_L",      GetCodeNU_0611_L(),
                       FldPref+"H0_CodeNU_AA",     GetCodeNU_0611_AA()
                     );
  END;

  MACRO PrintHeader_cons( FldPref:STRING, H03:STRING, ReportCode:STRING, ReportName:STRING )
    
    PrintFormatString( "",
                      FldPref+"ДатаСоставления", string(Date():f)+" "+string(Time()),
                      FldPref+"Oper",            string({oper}),
                      FldPref+"NameOper",        GetOperRecByID({oper}).Name,
                      FldPref+"H0_A:l",          this.H0_A(),
                      FldPref+"H0_B",            this.H0_B_INN(),
                      FldPref+"H0_C",            this.H0_B_KPP(),
                      FldPref+"H0_3",            H03,
                      FldPref+"H0_6",            GetRepTitle(),
                      FldPref+"H0_1",            this.H0_1(),
                      FldPref+"H0_2",            this.H0_2(),
                      FldPref+"H0_9",            this.H0_9(),
                      FldPref+"H0_11",           this.H0_11(),
                      FldPref+"H0_13",           this.H0_13()
                    );
  END;


  PRIVATE MACRO ExecuteReport611_615 ( ObjReport:OBJECT, PrintRep)
    VAR DataQuery, AvrFIID, AddWhere = "",
        AvrFIIDList = null,
        AvrFIIDCount : Integer = 0,
        AvrFIIDAddWhere : String = "",
   Rep_Name : String = "Регистры коротких позиций 2014",

        GNUList = null,
        GNUAddWhere : String = "",
        GNUCount : Integer = 0,
        AvrGroup;

    VAR ProgressValue = CTxProgressValue();
   
    /*ценные бумаги в соединенных сделках  должны удовлетворять условиям, заданным панели подготовки отчета*/
    if( not m_IsWebService )
       AvrFIIDList = TArray();
       AvrFIIDList[AvrFIIDList.Size] = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_AVRCODE_2014 );
    else
        AvrFIIDList = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_AVRCODE_2014 );
     end;
    if( ( ValType( AvrFIIDList ) != V_UNDEF ) and ( AvrFIIDList.Size > 0 ) )
       while( AvrFIIDCount < AvrFIIDList.Size )
          if( ( ValType( AvrFIIDList[AvrFIIDCount] ) == V_INTEGER )
          and ( AvrFIIDList[AvrFIIDCount] > 0 ) )
             if( AvrFIIDAddWhere == "" )
                AvrFIIDAddWhere = AvrFIIDAddWhere + " AND ( ";
             else
                AvrFIIDAddWhere = AvrFIIDAddWhere + " OR ";
             end;
             AvrFIIDAddWhere = AvrFIIDAddWhere + " TXLotSale.t_FIID = " + String( AvrFIIDList[AvrFIIDCount] ) + " ";
          end;
          AvrFIIDCount = AvrFIIDCount + 1;
       end;
       if( AvrFIIDAddWhere != "" )
          AvrFIIDAddWhere = AvrFIIDAddWhere + " ) ";
//          WasSetSecurity = true;
       end;
       AddWhere = AddWhere + AvrFIIDAddWhere;
    end;
     
    if( not m_IsWebService )
       GNUList = TArray();
       GNUList[GNUList.Size] = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_AVRGROUP_2014 );
    else
       GNUList = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_AVRGROUP_2014 );
    end;
    /*задана категория бумаги*/
    if( ( ValType( GNUList ) != V_UNDEF ) and ( GNUList.Size > 0 ) )
       while( GNUCount < GNUList.Size )
          if( ( ValType( GNUList[GNUCount] ) == V_INTEGER )
          and ( GNUList[GNUCount] > 0 ) )
           if( GNUAddWhere == "" )
                GNUAddWhere = GNUAddWhere + " AND ( ";
             else
                GNUAddWhere = GNUAddWhere + " OR ";
             end;
             GNUAddWhere = GNUAddWhere + " av.t_TaxGroup = " + String( GNUList[GNUCount] ) + " ";
          end;
          GNUCount = GNUCount + 1;
       end;
       if( GNUAddWhere != "" )
          GNUAddWhere = GNUAddWhere + " ) ";
       end;
       AddWhere = AddWhere + GNUAddWhere;
     end;
     
     if( (ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_EXCLUDE_2014 ) == "X") AND (ИсключаемыеИзОтчетаЦБ != "") )
        AddWhere = AddWhere + " AND FinInstr.t_FI_Code not in (" + ИсключаемыеИзОтчетаЦБ + ")";
     end;
     DataQuery = " With "   
                 + "   AtCor AS ( "
                 + "     SELECT  tick.t_DealID, NVL(obj24.Count24,0) Count24 "
                 + "       FROM ddl_tick_dbt tick "
                 + "       left  join "
                 + "         ( SELECT COUNT (1) Count24, objatcor.t_Object "
                 + "             FROM dobjatcor_dbt objatcor "
                 + "           WHERE objatcor.t_ObjectType = 101 "
                 + "             AND objatcor.t_GroupID = 24 "                         
                 + "             AND objatcor.t_AttrID = 2 "
                 + "           Group by objatcor.t_Object ) obj24 "
                 + "         on obj24.t_object = tick.t_DealID "
                 + " ) " +    


                 " SELECT TXLink.t_Date as Dlink, TXLink.t_Amount, TXLink.t_SaleID as SaleID, TXLink.t_BuyID as BuyID," +

                 Get_PartyName_Query( "DealSale", "PartyNameSale" ) + ", " +/*PartyNameSale*/
                 Get_PartyName_Query( "DealBuy",  "PartyNameBuy" )  + ", " +/*PartyNameBuy*/

                 " Rsb_SCTX.TXGetComissionsSum(DealSale.t_DealID, DealSale.t_BOfficeKind, TXLotSale.t_SALEDATE, 0) as CommSale, " +
                 " Rsb_SCTX.TXGetComissionsSum(DealBuy.t_DealID,  DealBuy.t_BOfficeKind,  TXLink.t_Date,   0) as CommBuy, " +
                 " Rsb_SCTX.TXGetNDSComSum(DealSale.t_DealID, DealSale.t_BOfficeKind, TXLotSale.t_SALEDATE, 0) as NDSComSale, " +
                 " Rsb_SCTX.TXGetNDSComSum(DealBuy.t_DealID,  DealBuy.t_BOfficeKind,  TXLink.t_Date,   0) as NDSComBuy, " +

                 IIF ( (m_ReportKind != SHREP_REG_0611),
                        "       Rsb_SCTX.TXGetBondKind(av.t_TaxGroup) TaxGroupType, ", ""
                     ) + 
                 "        FinInstr.t_FIID, FinInstr.t_FI_Code AS AvrCode, av.T_ISIN as ISIN, T_LSIN, FinInstr.t_Name AS AvrName, FinInstr.t_FaceValueFI AS FaceValueFI, FinInstr.t_DrawingDate, FinInstr.t_SumPrecision, FinInstr.t_Issued, av.t_TaxGroup, FinInstr.t_AvoirKind,"+
                 "        TXLotSale.t_DealID AS DealSaleID, TXLotSale.t_DEALDATE AS DealSaleDate, TXLotSale.t_SALEDATE AS SaleDate, TXLotSale.t_DEALCODETS AS DealSaleCodeTS, (CASE WHEN TXLotSale.t_VirtualType <> "+ TXVDEAL_REAL+" THEN TXLotSale.t_PriceFIID ELSE FinInstr.t_FaceValueFI END) AS SalePriceFIID,LegS.t_Price AS SalePrice, LegS.t_Principal AS SaleAmount,"+
                 "        TXLotBuy.t_DealID  AS DealBuyID,  TXLotBuy.t_DEALDATE AS  DealBuyDate,  TXLotBuy.t_BuyDATE   AS BuyDate,  TXLotBuy.t_DEALCODETS  AS DealBuyCodeTS, (CASE WHEN TXLotBuy.t_VirtualType <> "+ TXVDEAL_REAL+" THEN TXLotBuy.t_PriceFIID ELSE FinInstr.t_FaceValueFI END) AS BuyPriceFIID,LegB.t_Price AS BuyPrice, LegB.t_Principal AS BuyAmount,"+
                 "        TXLotSale.t_VirtualType SaleVirtualType, " +
                 "        TXLotBuy.t_VirtualType BuyVirtualType, " + 
                 "        Rsb_SCTX.ifMarket_NEW( TXLotSale.t_ID ) AS ifMarket_NEW, " + 
                 "        Rsb_SCTX.GetMarketPrice_New( TXLotSale.t_ID) AS SaleMarketPrice,"+
                 "        Rsb_SCTX.GetMarket_New(TXLotSale.t_ID) AS SaleMarket, "+
                 "        Rsb_SCTX.GetVal_Market_New(TXLotSale.t_ID) AS SaleVal_Market, " +
                 "        Rsb_SCTX.GetDateMarket_New(TXLotSale.t_ID) AS SaleDateMarket, "+
                 "        Rsb_SCTX.GetQuoteValue_New(TXLotSale.t_ID) AS SaleMarketQuoteValue, "+
                 "        Rsb_SCTX.GetMarketPrice_New(TXLotBuy.t_ID) AS BuyMarketPrice, " +
                 "        Rsb_SCTX.GetMarket_New(TXLotBuy.t_ID) AS BuyMarket, "+
                 "        Rsb_SCTX.GetVal_Market_New(TXLotBuy.t_ID) AS BuyVal_Market, " +
                 "        Rsb_SCTX.GetDateMarket_New(TXLotBuy.t_ID) AS BuyDateMarket, "+
                 "        TXLotBuy.t_VirtualType as VirtualTypeBuy, TXLotSale.t_VirtualType as VirtualTypeSale, "+
                 "        Rsb_SCTX.GetQuoteValue_New(TXLotBuy.t_ID) AS BuyMarketQuoteValue, "+
                 "        DataBuy.DealBuyGroup AS DealBuyGroup, DealBuy.t_Department AS DealBuyDepartment, "+
                 "        DataSale.DealSaleGroup AS DealSaleGroup, DealSale.t_Department AS DealSaleDepartment, "+
                 "        LegS.t_CFI as VprS, "  +
                 "        LegB.t_CFI AS VprB, " +
                 "        LegS.t_NKD as NKDSale, "+
                 "        LegB.t_NKD NKDBuy, "+
                 "        LegB.t_Price as DealBuyPrice, "+
                 "        LegS.t_Price as DealSalePrice, "+
                 "        CASE WHEN((DealBuy.t_Ofbu = chr(88)) AND (RSB_SECUR.GetMainObjAttrNoDate(101, LPAD (DealBuy.t_DealId, 34, '0'), 117) <> 0)) THEN 1 ELSE 0 end as IsDUDealB, " +
                 "        CASE WHEN(DealSale.t_DealType = 32742) THEN 1 ELSE 0 end as IsDUDealS, " +
                 "        rsb_sctx.GetInAvrWrtStartDate(DealBuy.t_DealId) as ImportDUDate, " +
                 "        DataSale.LegKindSale, DataBuy.LegKindBuy, LegB.t_NKD as NKDB,  DealSale.t_BOfficeKind  AS SBOfficeKind,  DealBuy.t_BOfficeKind AS BBOfficeKind, "  +
                 "        Rsb_SCTX.CheckObjAttrPresenceByNum(3,47,'1',lpad(case when DealSale.t_MarketID <> -1 and DealSale.t_PartyID = -1 then DealSale.t_MarketID else DealSale.t_PartyID end, 10, '0'),TXLotSale.t_DEALDATE) DepS, "
                 "        Rsb_SCTX.CheckObjAttrPresenceByNum(3,47,'1',lpad(case when DealBuy.t_MarketID <> -1 and DealBuy.t_PartyID = -1 then DealBuy.t_MarketID else DealBuy.t_PartyID end, 10, '0'),TXLotBuy.t_DEALDATE) DepB "

                 "   FROM DSCTXLNK_DBT  TXLink,"+
                 "        DSCTXLOT_DBT  TXLotSale," +
                 "        DSCTXLOT_DBT  TXCurLotSale," +
                 "        DSCTXLOT_DBT  TXLotBuy," +
                 "        DSCTXLOT_DBT  TXLotSource," +
                 "        DDL_TICK_DBT  DealSale," +
                 "        DDL_TICK_DBT  DealBuy," +
                 "        DFININSTR_DBT FinInstr, " + 
                 "        DAVOIRISS_DBT av, " + 
                 "        ddl_leg_dbt   LegS, " + 
                 "        ddl_leg_dbt   LegB, " +
                 "        AtCor, "
                 "        ( Select SaleOper.t_Kind_Operation, SaleOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(SaleOper.t_SysTypes) as DealSaleGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsBuy(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtIn(rsb_secur.get_OperationGroup(SaleOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindSale " +
                 "            From " +
                 "                 doprkoper_dbt SaleOper " + 
                 "        ) DataSale, " +

                 "        ( Select BuyOper.t_Kind_Operation, BuyOper.t_DocKind, " +
                 "                 rsb_secur.get_OperationGroup(BuyOper.t_SysTypes) as DealBuyGroup, " +
                 "                 (CASE WHEN " +
                 "                            ((Rsb_Secur.IsSale(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                          or (Rsb_Secur.IsAvrWrtOut(rsb_secur.get_OperationGroup(BuyOper.t_SysTypes))=1) " +
                 "                            ) " +
                 "                       THEN 2 " +
                 "                       ELSE 0 END " +
                 "                 ) as LegKindBuy " +
                 "            From " +
                 "                 doprkoper_dbt BuyOper " + 
                 "        ) DataBuy " +

                 "  WHERE TXLink.t_Type in (" + TXLNK_CLSREPO + ", " + TXLNK_CLSLOAN +") AND " +
                 "        ( ( ( TXLink.t_Date BETWEEN " + GetSQLDate( m_H01 ) + " AND " + GetSQLDate(m_H02) + " ) AND " +
                 "            ( TXLink.T_BEGDATE IS NULL OR " +
                 "              TXLink.T_BEGDATE = " + GetSQLDate( DATE(0,0,0) ) + 
                 "            ) " +
                 "          ) OR " +
                 "          ( TXLink.T_BEGDATE BETWEEN " + GetSQLDate( m_H01 ) + " AND " + GetSQLDate( m_H02 ) + 
                 "          ) " +
                 "        ) AND " +
                 "        ( TXLink.T_ENDDATE = to_date('01.01.0001', 'DD.MM.YYYY') OR TXLink.T_ENDDATE >= " + GetSQLDate( m_H02 ) + 
                 "        ) AND " +
                 "        TXLink.t_SaleID = TXCurLotSale.t_ID AND " +
                 "        TXLotSale.t_ID = TXCurLotSale.t_BegLotID AND "
                 "        TXLink.t_BuyID  = TXLotBuy.t_ID AND " +
                 "        TXLink.t_SourceID  = TXLotSource.t_ID AND " +
                 "        TXLotBuy.t_VirtualType = " + TXVDEAL_REAL + " AND " +
                 "        TXLotSale.t_DealID = DealSale.t_DealID(+) AND " +
                 "        TXLotBuy.t_DealID  = DealBuy.t_DealID(+) AND " +
                 "        FinInstr.t_FIID = TXLotSale.t_FIID AND " +
                 "        FinInstr.t_FIID = av.t_FIID AND " +
                 "        av.t_TaxGroup not in (35, 919, 943) AND " +
                 "        DataSale.t_Kind_Operation (+)= DealSale.t_DealType AND " +
                 "        DataSale.t_DocKind        (+)= DealSale.t_BOfficeKind AND " +
                 "        DataBuy.t_Kind_Operation  (+)= DealBuy.t_DealType AND " +
                 "        DataBuy.t_DocKind         (+)= DealBuy.t_BOfficeKind AND " +
                 "        LegS.t_DealID             = TXLotSale.t_DealID AND " +
                 "        LegS.t_LegKind            = DataSale.LegKindSale AND " +
                 "        LegS.t_LegID              = 0 AND " +
                 "        LegB.t_DealID             = TXLotBuy.t_DealID AND " +
                 "        LegB.t_LegKind            = DataBuy.LegKindBuy AND " +
                 "        LegB.t_LegID              = 0 AND " +
                 "        AtCor.t_DealID =  TXLotSale.t_DealID  AND " +
                 "        AtCor.Count24 = 0 AND " + 
                 "        TXLotBuy.t_BuyDate > TXLotSale.t_SaleDate " +
                          AddWhere + " AND " + ObjReport.Where() + 
                 "        order by av.t_TaxGroup, FinInstr.t_FI_Code, TXLotSale.t_SALEDATE, TXLotSale.t_DEALDATE, TXLotSale.t_DEALTIME, TXLotSale.t_DEALCODETS, TXLotBuy.t_BuyDATE, TXLotBuy.t_DEALDATE, TXLotBuy.t_DEALTIME, TXLotBuy.t_DEALCODETS ";
        ProgressValue.Maximum = SQL_GetNRecs( DataQuery );
        ProgressValue.Current = 0;        
       
       if(ProgressValue.Maximum > 0)          
         var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

         if( m_IsWebService and (WebMenuItem != null) )
           var header = "Формирование отчета " + WebMenuItem.szNameItem;
           ProgressIndicator.Start(ProgressValue.Maximum, header, header);
         else
           ProgressIndicator.Start(ProgressValue.Maximum, Rep_Name, Rep_Name);
         end;
        
         m_RS = TRsbDataSet( DataQuery );
        
         while( m_RS.MoveNext() )
           if( ( ( m_RunByQuoted == true ) and (m_RS.ifMarket_NEW == "X") ) or (( m_RunByNoQuoted == true ) and (m_RS.ifMarket_NEW != "X")) )
             ClearCacheOneRecord();

             // найдём льготные/нельготные периоды
             m_TaxPeriods.Clear();
             if( (m_RS.TaxGroup == 17) and (m_ReportKind == SHREP_REG_0612) )
                m_TaxPeriods.Init(m_RS.FIID, max(this.H0_1()-1, this.DDS()), this.DDB());
             end;

             ObjReport.Print();
             SaveFIIDForForm_cons(m_RS.FIID);
             m_IsExistsData = true;
             ProgressValue.Current = ProgressValue.Current + 1;
             ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // всего 3 парамера Update(index, count, text)
           end;
         end;
         ProgressIndicator.Stop();
       end;
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )

     VAR AddWhere = "";

     ExecuteReport();
      
     SQL_Truncate( "dspprtcst_tmp" );

     ObjReport.BeginReport();
     
     if((m_RunByQuoted == true) or (m_RunByNoQuoted == true) ) 
       ExecuteReport611_615 (ObjReport, true);
     end;

     ObjReport.EndReport();

     ReplaceFormulaAndCalculate();
     
  END;

  MACRO GetCCons()
     var CCons = "";

     if( m_RunByNoQuoted )
        CCons = "N";
     end;

     return CCons;
  END;

   macro headerEndLine()

      if( (m_ReportKind == SHREP_REG_0615) or (m_ReportKind == SHREP_REG_0611) )
         return НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_rshb;
      end;
      return НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
   end;

   macro sumBeginLine()

      if( (m_ReportKind == SHREP_REG_0615) or (m_ReportKind == SHREP_REG_0611) )
         return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb;
      end;
      return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
   end;

   /*можно использовать не один критерий отбора строк, а два (реально используется только в 212)
    Если критерий один - используется ф-ла СУММЕСЛИ, если больше одного - СУММПРОИЗВ (было бы проще использовать СУММЕСЛИМН, но мы пока работаем в режиме совместимости до 2007, а СУММЕСЛИМН появилась после 2007)
    Для вторго критерия задаем ColName_2 - имя столбца, WhereCond_2 - условие*/
  macro ТекстФормулыПоВсемСделкамДляВыпуска(CellName:string, ColName_2:string, WhereCond_2:string)
     VAR i = 0, j = 0, NumSheet1 = 0, NumSheet2 = 0, FormulaStr = "", BeginRow_1 = 0, BeginRow_2 = 0, SummBeginRow_1 = 0, SummBeginRow_2 = 0;
     VAR ЗаданВторойКритерий = false;
     
     if( (ColName_2 != null) and (WhereCond_2 != null) and (ColName_2 != "") and (WhereCond_2 != "") )
        ЗаданВторойКритерий = true;
     end;

     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) )
           NumSheet1 = i;
           break;
        end;
        i = i + 1;
     end;

     i = 0;
     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_2) )
           NumSheet2 = i;
           break;
        end;
        i = i + 1;
     end;

     i = NumSheet1;
     while( i < NumSheet2 )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) ) /*для первой вкладки*/
           BeginRow_1 = headerEndLine(); // НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_1 = sumBeginLine(); // НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_1 = 1;
           SummBeginRow_1 = 2;
        end;
        
        if( StrUpr(m_UsedSheet[m_UsedSheet.size-1]) == StrUpr(m_SHEET_2) )/*для первой(начиная с m_SHEET_2) вкладки*/
           BeginRow_2 = НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_2 = НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_2 = 1;
           SummBeginRow_2 = 2;
        end;

        if( FormulaStr != "" )
           FormulaStr = FormulaStr + "+";
        end;

        if( ЗаданВторойКритерий )                                                                                                                                                        
           FormulaStr = FormulaStr + FormulaSUMPRODUCT()+"(('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+"=$"+C_SecCode_2+"$"+(m_ReportTable.bRowTable + getCurrentRow())+")*('"+m_UsedSheet[i]+"'!$"+ColName_2+"$"+SummBeginRow_1+":$"+ColName_2+"$"+string(BeginRow_1+MAXROWSHEET)+WhereCond_2+");'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        else
           FormulaStr = FormulaStr + FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+C_SecCode_2+"$"+SummBeginRow_2+":$"+C_SecCode_2+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName+"$"+SummBeginRow_1+":$"+CellName+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        end;

        i = i + 1;
     end;

     return "formula=" + FormulaStr;
  end;                                                                  

  macro ТекстФормулыПоВсемСделкамДляВыпуска_Сумма(CellName_1:string, ColName_1:string, WhereCond_1:string, CellName_2:string, ColName_2:string, WhereCond_2:string)
     VAR FormulaStr1 = ТекстФормулыПоВсемСделкамДляВыпуска(CellName_1, ColName_1, WhereCond_1);
     VAR FormulaStr2 = "";
     VAR i = 0, j = 0, NumSheet1 = 0, NumSheet2 = 0, FormulaStr = "", BeginRow_1 = 0, BeginRow_2 = 0, SummBeginRow_1 = 0, SummBeginRow_2 = 0;
     VAR ЗаданВторойКритерий = false;

     if( (ColName_2 != null) and (WhereCond_2 != null) and (ColName_2 != "") and (WhereCond_2 != "") )
        ЗаданВторойКритерий = true;
     end;

     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) )
           NumSheet1 = i;
           break;
        end;
        i = i + 1;
     end;

     i = 0;
     while( i < m_UsedSheet.Size )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_2) )
           NumSheet2 = i;
           break;
        end;
        i = i + 1;
     end;

     i = NumSheet1;
     while( i < NumSheet2 )
        if( StrUpr(m_UsedSheet[i]) == StrUpr(m_SHEET_1) ) /*для первой вкладки*/
           BeginRow_1 = HeaderEndLine(); // НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_1 = SumBeginLine(); // НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_1 = 1;
           SummBeginRow_1 = 2;
        end;

        if( StrUpr(m_UsedSheet[m_UsedSheet.size-1]) == StrUpr(m_SHEET_2) )/*для первой(начиная с m_SHEET_2) вкладки*/
           BeginRow_2 = НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА;
           SummBeginRow_2 = НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ;
        else
           BeginRow_2 = 1;
           SummBeginRow_2 = 2;
        end;

        if( FormulaStr2 != "" )
           FormulaStr2 = FormulaStr2 + "+";
        end;

        if( ЗаданВторойКритерий )
           FormulaStr2 = FormulaStr2 + FormulaSUMPRODUCT()+"(('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+"=$"+C_SecCode_2+"$"+(m_ReportTable.bRowTable + getCurrentRow())+")*('"+m_UsedSheet[i]+"'!$"+ColName_2+"$"+SummBeginRow_1+":$"+ColName_2+"$"+string(BeginRow_1+MAXROWSHEET)+WhereCond_2+");'"+m_UsedSheet[i]+"'!$"+CellName_2+"$"+SummBeginRow_1+":$"+CellName_2+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        else
           FormulaStr2 = FormulaStr2 + FormulaSUMIF()+"('"+m_UsedSheet[i]+"'!$"+C_SecCode+"$"+SummBeginRow_1+":$"+C_SecCode+"$"+string(BeginRow_1+MAXROWSHEET)+";\"=\"&$"+C_SecCode_2+"$"+SummBeginRow_2+":$"+C_SecCode_2+"$"+string(BeginRow_2+MAXROWSHEET)+";'"+m_UsedSheet[i]+"'!$"+CellName_2+"$"+SummBeginRow_1+":$"+CellName_2+"$"+string(BeginRow_1+MAXROWSHEET)+")";
        end;

        i = i + 1;
     end;

     return FormulaStr1 + "+" + FormulaStr2;
  end;

  macro ФормулаПоВсемСделкамДляВыпуска(CellName:string)
     return ТекстФормулыПоВсемСделкамДляВыпуска(CellName);
  end;                                                                


  macro PrintForm_Cons(ObjReport:OBJECT)
     var exec, DataSet;
     exec = RSDCommand(" select fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, "+
                       "        (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) AS t_ISIN "+
                       "   from dspprtcst_tmp t, dfininstr_dbt fin, DAVOIRISS_DBT av "+
                       "  where fin.t_FIID = t.t_FIID "+
                       "    AND fin.t_FIID = av.t_FIID "+
                       "  group by fin.t_FI_Code, fin.t_Name, av.t_TaxGroup, "+
                       "           (case when av.t_ISIN IS null OR av.t_ISIN IN (chr(0), chr(1)) then (case when av.t_LSIN IS null OR av.t_LSIN IN (chr(0), chr(1)) then chr(0) else av.t_LSIN end) else av.t_ISIN end) "+
                       "  order by av.t_TaxGroup, fin.t_FI_Code");
     exec.execute();
     DataSet = TRsbDataSet(exec);

     while(DataSet.MoveNext()) 
        ObjReport.Print(DataSet.TaxGroup,DataSet.FI_Code,DataSet.Name, DataSet.ISIN);
     end;
  end;


 PRIVATE MACRO PrintConsolidated( ObjReport:OBJECT )
     ObjReport.BeginReport();
     this.PrintForm_Cons(ObjReport);
     ReplaceFormulaAndCalculate();
     ObjReport.EndReport(); 
  END;

  PRIVATE MACRO CreateReportByKind( Kind:INTEGER )
    m_ReportKind = Kind;

    Fill_Cell_Name();  
                                                        
    if( Kind == SHREP_REG_0611 )
       m_SHEET_1 = SHEET_0611;       
       m_SHEET_2 = SHEET_0611s;
       ExecuteReport( ShortReg_611(this) ); 
       PrintConsolidated( ShortReg_611_Cons(this) );
    elif( Kind == SHREP_REG_0612 )
       m_SHEET_1 = SHEET_0612;
       m_SHEET_2 = SHEET_0612s;
       ExecuteReport( ShortReg_612(this) );
       PrintConsolidated( ShortReg_612_Cons(this) );
    elif( Kind == SHREP_REG_0615 )
       m_SHEET_1 = SHEET_0615;
       m_SHEET_2 = SHEET_0615s;
       ExecuteReport( ShortReg_615(this) );
       PrintConsolidated( ShortReg_615_Cons(this) );
    end;

  END;

  PRIVATE MACRO CreateReportByAll()
    CreateReportByKind( SHREP_REG_0611 );
    CreateReportByKind( SHREP_REG_0612 );
    CreateReportByKind( SHREP_REG_0615 );
  END;

  PRIVATE MACRO Create()
     var SubKindList = null;
     var SubKindCount : Integer = 0;

     if( not m_IsWebService )
        SubKindList = TArray();
        SubKindList[SubKindList.Size] = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_SUBKIND_2014 );
     else
        SubKindList = ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_SUBKIND_2014 );
     end;
     
     if( ( ValType( SubKindList ) != V_UNDEF )
     and ( SubKindList.Size > 0 )
     and ( ValType( SubKindList[SubKindCount] ) == V_INTEGER )
     and ( SubKindList[SubKindCount] != SHREP_REG_ALL_2014 ) )
        while( SubKindCount < SubKindList.Size )
           CreateReportByKind( SubKindList[SubKindCount] );
           SubKindCount = SubKindCount + 1;
        end;
     else
        CreateReportByAll();
     end;

     if( (m_IsExistsData == false) and (m_IsWebService == false) )
        msgbox("Нет данных для формирования отчета.");
     end;
  END;
  

  initTX_RegistrReport( Form, TemplateName, true, false, null, UsePOI, UseBigReportMode, FocreFormatRep );
  SetRowFlushCount(2000);
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var NumCopy = 0;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;
 
  if( not IsWebService )
    ShRepReg2014_Form = SP_ShRepReg2014_Panel();
  else
    if( ValType(FormData) != V_UNDEF )
      ShRepReg2014_Form = WS_TX_ShRepReg2014_Panel( FormData );
    else
      stat = false;
    end;
  end;

   while( stat )
    if( not IsWebService )
    stat = ShRepReg2014_Form.Run();
    end;

    NumCopy = 0;
    SecondStart = false;

    if( stat )
      if( ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_BYQUOTED_2014 ) == SET_CHAR )
        NumCopy = NumCopy + 1;
      end;

      if( ShRepReg2014_Form.GetFieldValue( PNFLD_SHREP_REG_BYNOQUOTED_2014 ) == SET_CHAR )
        NumCopy = NumCopy + 1;
      end;  

      ShRepReg2014_Report = SP_ShortReg_Report_2014( null, "Report_ShRepReg2014.xlsx", false, IsWebService, ReportHashCode, POI_MODE, NULL, BIGREPORT_MODE);
      ShRepReg2014_Report.Run( NumCopy );

      if( IsWebService )
        Dl_CallInsertStat( ShRepReg2014_Report.PrintMode(), menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        if( ShRepReg2014_Report.IsDataExist() == true )
           FullReportFileNames = ShRepReg2014_Report.GetFullReportFileNames();
        end;
        stat = false;
      else
        Dl_CallInsertStat( ShRepReg2014_Report.PrintMode() );
      end;

      ShRepReg2014_Report = NULL;
    end; 
  end;

  return FullReportFileNames;
END;
