/*
$Name: nptxhold013.mac
$Module: Ценные бумаги
$Description: Зачет удержанного НДФЛ для операций удержания НДФЛ
*/

import InsCarryDoc, "sp_categ.mac", "sp_car.mac", RsbDataSet, "nptxstbfun.mac";

private macro Error( ErrStr:STRING ):INTEGER
  DL_NPTX_PutMsg( ErrStr );
  MsgBox( ErrStr );
  return 1;
end;

private macro RunAction(Oper)
  var nptxop_new = TRecHandler( "nptxop" );
  var RefID, TaxPeriod;
  var err = 0;

  nptxop_new.Clear();

  GenerateNumberByReference( OBJTYPE_NPTXNETTOP, 1 /*REFOBJ_NPTXNETTOP*/, @RefID, @nptxop_new.rec.Code );
      
  nptxop_new.rec.DocKind           = DL_NPTXNETTOP;
  nptxop_new.rec.OperDate          = Oper.rec.OperDate;
  nptxop_new.rec.Time              = time();
  nptxop_new.rec.Department        = {OperDprt};
  nptxop_new.rec.Oper              = Oper.rec.Oper;
  nptxop_new.rec.Status            = 0/*DL_TXOP_Prep*/;
  nptxop_new.rec.Recalc            = UNSET_CHAR;
  nptxop_new.rec.FIID              = ALLFININSTR;
  nptxop_new.rec.Client            = Oper.rec.Client;

  datesplit(Oper.rec.OperDate, null, null, TaxPeriod);

  nptxop_new.rec.PrevDate          = date(1,1,TaxPeriod);

  nptxop_new.rec.Kind_Operation    = 2046;//Зачет удержанного НДФЛ

  if ( not CreateNptxOpStep(nptxop_new, true))
    err = 1;
  end;

  if(not err)
    if( not InsertOprStatus(46081, 9)) //Запрос СНОБ
      return Error( "Ошибка при установке статуса вида \"Запрос СНОБ\" операции" );        
    end;
  end;

  return err;
end;

MACRO ExecuteStep( kind_oper, FDoc, DocKind, ID_Operation, ID_Step )

  VAR Oper = TRecHandler( "nptxop.dbt" );
  VAR Stat = 0;

  Oper.SetRecordAddr( FDoc );

  stat = DL_NPTX_PutMsg( "Расчет сумм" );
        
  if( not stat )
     stat = RunAction(Oper);
     DL_NPTX_SaveOperLog( Oper.rec.ID, 20 );
  end;

  return stat;
END;

