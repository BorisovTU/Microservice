/*
$Name:        settl043.mac
$Module:      Ценные бумаги
$Description: Операция Расчеты на ОРЦБ. Шаг - Перевод на другой клиринговый счет
*/
import "settl.mac";

/* Глобальные структуры с данными для переводов с одного клир счета на другой (то, что вводится в панели поплнения счета))*/
PRIVATE VAR TorgAccData = TRecHandler( "dl_comm.dbt");
PRIVATE VAR MarketSchemOther = TRecHandler( "dlmarket.dbt");
PRIVATE VAR MoneySourceBase:Integer; // Источник средств в первоначальной операции, при создании (не при изменении на шаге)

PRIVATE RECORD Account(account);

/*заполнение суммы "по умолчанию" в форме ввода параметров, вызываемой на данном шаге
  по умолчанию подставляется сумма в пределах остатка на ТЕКУЩЕМ клиринговом счете*/
PRIVATE MACRO CalcRestOnMarketAccounts()

  var FD = SPFirstDocDLCOMM( TorgAccData );
  var FiRole = null;

  GetSettlFiRoleByOperSubKind(MoneySourceBase,@FiRole);

  if( FD.IsExistAccount( "Клиринговый счет", null, true, FiRole, Account, null, FD.comm.rec.CommDate, TorgAccData.rec.Currency ) )
     TorgAccData.rec.hidden_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
  end; 

  if( FD.comm.rec.FIID > 0 )
    if( FD.IsExistAccount( "Клиринговый счет", null, true, FiRole, Account, null, FD.comm.rec.CommDate, TorgAccData.rec.FIID ) )
       TorgAccData.rec.Currency_sum = Abs( GetRestAccount( Account, FD.comm.rec.CommDate ) ); 
    end; 
  end;

END;

PRIVATE MACRO CheckRestOnClirAccounts()
  return ПроверитьОстаткиНаКлирСчетахСКотВыпПеревод(TorgAccData, null, null, MoneySourceBase);
end;

macro ExecuteStep( Doc, adr )

  if( not ПереводСредствСТекущНаДругойКлирСчет( Doc, TorgAccData, MarketSchemOther, MoneySourceBase) )
     return 1;
  end;

  return 0;
end;
