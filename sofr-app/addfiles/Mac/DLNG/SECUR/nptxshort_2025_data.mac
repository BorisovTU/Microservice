/*
$Name:        nptxshort_2025_data.mac
$Module:      Ценные бумаги
$Description: Класс подготовки данных для отчета "Краткая справка по расчету НДФЛ (2025)" 
*/
IMPORT "RegistrReport.mac", "NpTxRepoReg_Data.mac", "dv_categ.mac", "regdvinc_data.mac", "nptxstbfun.mac", "scsrvrepfun.mac";

PRIVATE CONST CL_STATE_RES    = "резидент",
              CL_STATE_NOTRES = "нерезидент";

PRIVATE CONST Max15 = $5000000; // предельное значение НОБ для расчета по основной ставке

PRIVATE VAR TXOBJ_BASEG_2_3_9 = TArray;

PRIVATE CONST POI_MODE = true;

PRIVATE CONST BG2 = 0,
              BG3 = 1,
              BG9 = 2;

PRIVATE VAR MaxBuyDateForRepl = date(01,03,2022);

PRIVATE VAR IsExistData;

PRIVATE CONST ItogsLineName = "Всего:";

PRIVATE CONST CALCTYPE_SEC  = 1;
PRIVATE CONST CALCTYPE_DEPO = 2;
PRIVATE CONST CALCTYPE_ONB  = 3;

private var gSQL = "";

private macro SqlHandler(str)
  gSQL = gSQL + str;
end;

private macro GetSystDateTime(SystDate:@date, SystTime:@time)
  var cmd = DL_RSDCommand("select sysdate dt from dual");
  var DataSet = cmd.execute();

  DataSet.moveNext();

  DtTmSplit(DataSet.dt, SystDate, SystTime);
end;

PRIVATE MACRO iifset(cond:bool, var1:@variant, var2:@variant, val)
  if (cond)
    return var1 = val;
  else
    return var2 = val;
  end;
END;


private macro ТочностьКЦБ(OnDate)
   var ErrCode, posValue = 2;

   GetTaxRegValue("COMMON\\НДФЛ\\ТОЧНОСТЬ_КЦБ_ДЛЯ_ИНВЕСТВЫЧЕТА", OnDate, @posValue, @ErrCode);

    if(ErrCode != 0)
      posValue = 2;
    end;

   return posValue;
end;

private macro NeedNKDB_TS(OnDate)
   var ErrCode, flag = false;

   GetTaxRegValue("COMMON\\НДФЛ\\УЧЕТ_NKDB_TS_В_ДОХ", OnDate, @flag, @ErrCode);

   return flag;
end;

CLASS (TX_RegistrReport) NPTXShort2025_Data(GUID)
  var m_PrSRub, m_AllSRub, m_AllSrub_l, m_ComBankS, m_ComExcS, m_PrBRub,
      m_AllBrub, m_AllBrub_l, m_MaterialB, m_TaxMaterialB, m_ComBankB, m_ComExcB, m_TaxFRlink, m_TaxTags,
      m_TaxFR_total, m_TaxFR_market, m_TaxFR_OTC, m_TaxFR_Open, m_ComDepo, m_CoupRubS,
      m_BaseMaterial, m_BaseSpecial, m_BaseSpecialDiv, m_BG, m_TaxRateGeneral, m_TaxDueNow, m_PS, m_PD,
      m_PG, m_SheetName, m_query, m_count, m_Qnty, m_FRrub, m_TaxLink, m_BaseBill, m_OtherIncome, m_Limit_618, m_Plusi, m_FR_Sec_3Y,
      m_TaxDueNow_15, m_CoupRub_DEPO, m_TaxFR_OTC_DEPO, m_TaxFR_OTC_ONB, m_TaxFR_market_DEPO, m_TaxFR_market_ONB, m_BaseG5_DEPO, m_ComDepo_DEPO, m_ComDepo_ONB, m_CoupRubS_DEPO,
      m_BG_DEPO, m_BP, m_PP, m_BP_DEPO, m_BaseG5, m_TaxBase_618, m_TaxBase_618_DEPO, m_Minus_618_DEPO, m_Minus_618_ONB, m_Minus_618, m_Limit_618_DEPO,
      m_TaxBase_13, m_TaxBase_13_DEPO, m_TaxBase_13_ONB, m_TaxBase_15, m_TaxBase_15_DEPO, m_TaxBase_15_ONB, m_PG_DEPO, m_PGd, m_PGd_DEPO,
      m_PP_DEPO, m_PPd, m_PPd_DEPO, m_TaxDueNow_sum, m_TaxDueNow_15_sum,
      m_Minus_619, m_Minus_619_DEPO, m_Minus_619_ONB, m_Minus_517, m_Minus_517_DEPO, m_Minus_517_ONB,
      m_TaxBase_18_ONB, m_TaxBase_20_ONB, m_TaxBase_22_ONB,
      m_TaxPaid, m_TaxPaid_DEPO, m_TaxPaid_ONB, m_TaxPaid_15, m_TaxPaid_15_DEPO, m_TaxPaid_15_ONB, m_TaxPaid_18_ONB, m_TaxPaid_20_ONB, m_TaxPaid_22_ONB,
      m_TaxFR_Lost, m_TaxFR_Lost_DEPO, m_TaxFR_Lost_ONB;
  var m_DlastNOB, m_PreliminaryCalc;
  var НОБ_ДЕПО, НОБ_ДЕПО_КБК1, НОБ_ДЕПО_КБК2, НОБ_ДЕПО_КБК3;
  var Налог_ДЕПО_КБК1, Налог_ДЕПО_КБК2, Налог_ДЕПО_КБК3; 
  var НОБ_СОФР, НОБ15_СОФР, Налог_СОФР, Налог15_СОФР;
  var Налог_КБК1, Налог_КБК2, Налог_КБК3;
  var m_Dsys;
  var m_BeginDate, m_ReportType, m_ByDepo, m_AvrKind, m_AvrFIID, m_NeedRealizList, m_NeedShortPosList, m_NeedRepoList, m_NeedLucreList, m_NeedPFIList, m_NeedBillList, m_NeedProtocolList, m_ByIIS, m_DlContrID;
  var m_Include_Tech;
  var m_ContractIDsStr = "", m_ContractNumber = "";
  var m_By_IIS = false, m_By_NotIIS = false;
  var m_TaxPeriod = 0;

  VAR m_CurrInvestorSheetName, m_CurrInvestor, m_CurrInvestorName, m_InvestorFIO, m_CurrIIS;
  
  VAR m_BaseG_2_3_9      = TArray,
      m_BaseG_2_3_9_DEPO = TArray;

  VAR m_GUID = GUID;

  PRIVATE MACRO LoadRepParam()
    var query, cmd, DataSet;

    query = "select * from dnptxshort_repparm_dbt where t_GUID = ?";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_GUID);
    DataSet = cmd.Execute();
    if(DataSet.moveNext())

      m_EndDate = date(DataSet.EndDate);
      datesplit(m_EndDate, NULL, NULL, m_TaxPeriod);
      m_BeginDate = date(1, 1, m_EndDate);
      
                         
      m_ReportType       = DataSet.RepType;
      m_ByDepo           = DataSet.ByDepo;
      m_AvrKind          = int(DataSet.AvrKind);
      m_AvrFIID          = int(DataSet.AvrFIID);
      m_NeedRealizList   = DataSet.NeedRealizList;
      m_NeedShortPosList = DataSet.NeedShortPosList;
      m_NeedRepoList     = DataSet.NeedRepoList;
      m_NeedLucreList    = DataSet.NeedLucreList;
      m_NeedPFIList      = DataSet.NeedPFIList;
      m_Include_Tech     = DataSet.Include_Tech;
      m_NeedBillList     = DataSet.NeedBillList;    
      m_NeedProtocolList = DataSet.NeedProtocolList;
      m_ByIIS            = IIF(DataSet.ByIIS == SET_CHAR, 1, 0);
      m_CurrInvestor     = int(DataSet.ClientID);
      m_DlContrID        = int(DataSet.DlContrID);

      return true;
    end;

    return false;
  END;

  MACRO H0_2()
    return m_EndDate;
  END;

  PRIVATE MACRO SaveErrorGenData(ErrorDesc:string) 
    var query, upd;
    query = "update dnptxshort_repparm_dbt set t_Status = 2, t_ErrorDesc = ? where t_GUID = ? AND t_Status = 0";
    upd = DL_RSDCommand(query);
    upd.AddParam(ErrorDesc);
    upd.AddParam(m_GUID);

    upd.ExecuteCMD();
  END;

  PRIVATE MACRO GetForDEPOCond(IsForDEPO:bool)
    var str = iif(IsForDEPO, "obj.t_OutSystCode = 'DEPO'", "obj.t_OutSystCode != 'DEPO'");

    if(m_ContractIDsStr != "")
      str = str + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
    end;

    return str;
  END;

  MACRO SaveTotalCalcField(FieldName:string, FieldValue:variant)
    var query, ins;
    var FieldValueStr = string(FieldValue);

    if(ValType(FieldValue) == V_DATE)
      FieldValueStr = string(FieldValue:f);
    end;

    if(FieldValue == NULL)
      FieldValueStr = "";
    end;

    query = "INSERT INTO DNPTXSHORT_TOTALCALC_DBT(T_GUID, T_FIELDNAME, T_FIELDTYPE, T_FIELDVALUE) VALUES(?,LOWER(?),?,?)";

    ins = DL_RSDCommand(query);

    ins.AddParam(m_GUID);
    ins.AddParam(FieldName);
    ins.AddParam(ValType(FieldValue));
    ins.AddParam(FieldValueStr);

    ins.ExecuteCMD();
  END;


  //РЕПО
  PRIVATE MACRO CreateRepoRep()
    var Sum_Qnty        = 0;
    var Sum_Tot1vp      = $0;
    var Sum_DohRub      = $0;
    var Sum_RashRub     = $0;
    var Sum_TaxPashRub  = $0;
    var Sum_Com         = $0;
    var Sum_CoupCalcVn  = $0;
    var Sum_AmortCalcVn = $0;
    var MaxSumPrecision = 0;
    var WasPrinted = false;
    var cnt = 0, i = 0;
    var RecSort = 0;
   
    var SheetName = "РЕПО";

    MACRO AddREPOLine(Itog,
                      SecCode:string,    
                      SecName:string,    
                      ContractS:string,  
                      CodeR:string,      
                      DZ:string,         
                      Qnty:string,       
                      Dir1:string,       
                      DD1:string,        
                      DP1:string,        
                      Tot1vp:string,     
                      Rate:string,       
                      Dir2:string,       
                      DD2:string,        
                      DP2:string,        
                      Deal2vp:string,    
                      Tot2vp:string,     
                      DohRub:string,     
                      RashRub:string,    
                      TaxPashRub:string, 
                      GenRub:string,     
                      Com:string,        
                      CoupCalcVn:string, 
                      AmortCalcVn:string,
                      SumPrecision
                     )
      var query, ins;
      
      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_REPO_DBT (  T_GUID "       
                                            + " , T_ITOG "       
                                            + " , T_SORT "       
                                            + " , T_SECCODE "    
                                            + " , T_SECNAME "    
                                            + " , T_CONTRACTS "  
                                            + " , T_CODER "      
                                            + " , T_DZ "         
                                            + " , T_QNTY "        
                                            + " , T_DIR1 "       
                                            + " , T_DD1 "        
                                            + " , T_DP1 "        
                                            + " , T_TOT1VP "     
                                            + " , T_RATE "       
                                            + " , T_DIR2 "       
                                            + " , T_DD2 "        
                                            + " , T_DP2 "        
                                            + " , T_DEAL2VP "    
                                            + " , T_TOT2VP "     
                                            + " , T_DOHRUB "     
                                            + " , T_RASHRUB "    
                                            + " , T_TAXPASHRUB " 
                                            + " , T_GENRUB "     
                                            + " , T_COM "        
                                            + " , T_COUPCALCVN " 
                                            + " , T_AMORTCALCVN "
                                            + " , T_SUMPRECISION "
                                            + ") "
                     + " VALUES(?,"+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")+",?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";

       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(SecCode);    
       ins.AddParam(SecName);    
       ins.AddParam(ContractS);  
       ins.AddParam(CodeR);      
       ins.AddParam(DZ);         
       ins.AddParam(Qnty);       
       ins.AddParam(Dir1);       
       ins.AddParam(DD1);        
       ins.AddParam(DP1);        
       ins.AddParam(Tot1vp);     
       ins.AddParam(Rate);       
       ins.AddParam(Dir2);       
       ins.AddParam(DD2);        
       ins.AddParam(DP2);        
       ins.AddParam(Deal2vp);    
       ins.AddParam(Tot2vp);     
       ins.AddParam(DohRub);     
       ins.AddParam(RashRub);    
       ins.AddParam(TaxPashRub); 
       ins.AddParam(GenRub);     
       ins.AddParam(Com);        
       ins.AddParam(CoupCalcVn); 
       ins.AddParam(AmortCalcVn);
       ins.AddParam(SumPrecision);       
       
       ins.ExecuteCMD();
    END;


    var RepData = NPTX_RepoReg_Data(m_TaxPeriod,
                                    date(m_BeginDate), 
                                    date(m_EndDate),
                                    m_CurrInvestor, 
                                    m_AvrFIID, 
                                    m_AvrKind, 
                                    0, 
                                    1/*REPOREG_DEALSTATUS_CLOSE*/,
                                    m_CurrIIS);
    cnt = RepData.GetCount();
    if(cnt > 0)

      InitProgress( cnt, m_CurrInvestorSheetName+". РЕПО. Подготовка данных", m_CurrInvestorSheetName+". РЕПО. Подготовка данных" );

      while(RepData.GetNext())
        if ( //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
             (m_Include_Tech == SET_CHAR) or 
             ((date(RepData.LastNoTechCalc()) > date(0,0,0)) and not((this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and (date(RepData.MaxPayRqFactDate()) > date(RepData.LastNoTechCalc())) ))
           )

          WasPrinted = true;
      
          AddREPOLine(UNSET_CHAR,
                      RepData.SecCode(),         
                      RepData.SecName(),         
                      RepData.ContractS(),       
                      RepData.CodeR(),           
                      RepData.DZ(),              
                      RepData.Qnty(),            
                      RepData.Dir1(),            
                      RepData.DD1(),             
                      RepData.DP1(),             
                      RepData.Tot1vp(),          
                      ЧислоCЗаданнойТочностью(RepData.Rate()*100.0,RepData.Point())+"%", 
                      RepData.Dir2(),            
                      RepData.DD2(),             
                      RepData.DP2(),             
                      RepData.Deal2vp(),         
                      RepData.Tot2vp(),          
                      RepData.DohRub(),          
                      RepData.RashRub(),         
                      RepData.TaxPashRub(),      
                      RepData.GenRub(),          
                      RepData.Com(),             
                      RepData.CoupCalcVn(),      
                      RepData.AmortCalcVn(),     
                      RepData.QntyPrecision()
                    ); 

          Sum_Qnty         = Sum_Qnty        + RepData.Qnty();
          Sum_Tot1vp       = Sum_Tot1vp      + RepData.Tot1vp();     
          Sum_DohRub       = Sum_DohRub      + RepData.DohRub();     
          Sum_RashRub      = Sum_RashRub     + RepData.RashRub();    
          Sum_TaxPashRub   = Sum_TaxPashRub  + RepData.TaxPashRub(); 
          Sum_Com          = Sum_Com         + RepData.Com();        
          Sum_CoupCalcVn   = Sum_CoupCalcVn  + RepData.CoupCalcVn(); 
          Sum_AmortCalcVn  = Sum_AmortCalcVn + RepData.AmortCalcVn();

          if(MaxSumPrecision < RepData.QntyPrecision())
            MaxSumPrecision = RepData.QntyPrecision();
          end;
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

      if(WasPrinted)
        AddREPOLine(SET_CHAR,
                    "",         
                    "",         
                    "",       
                    "",           
                    "",              
                    Sum_Qnty,            
                    "",            
                    "",             
                    "",             
                    Sum_Tot1vp,          
                    "", 
                    "",            
                    "",             
                    "",             
                    "",         
                    "",          
                    Sum_DohRub,          
                    Sum_RashRub,         
                    Sum_TaxPashRub,      
                    "",          
                    Sum_Com,             
                    Sum_CoupCalcVn,      
                    Sum_AmortCalcVn,     
                    MaxSumPrecision
                  );
      end;
    end;

    return WasPrinted;
  END; 

          

  //Короткие позиции
  PRIVATE MACRO CreateShortPosRep()
    var query, DataSet, cmd;
    var SheetName = "Короткие позиции";
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_DifS = $0;
    var Sum_ComBankS = $0;
    var Sum_ComExcS =  $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_MaterialB = $0;
    var Sum_TaxMaterialB = $0;
    var Sum_DifB  = $0;
    var Sum_ComBankB =  $0;
    var Sum_ComExcB = $0;
    var Sum_ComB = $0;
    var Sum_TaxFRlink =0.0;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddShortPosLine(Itog,
                          SecCode:string,    
                          SecName:string,    
                          Qnty:string,       
                          ContractS:string,  
                          CodeS:string,      
                          DZS:string,        
                          DPS:string,        
                          PrSrub:string,     
                          AllSrub:string,    
                          DifS:string,       
                          ComBankS:string,   
                          ComExcS:string,    
                          ComS:string,       
                          ContractB:string,  
                          CodeB:string,      
                          DZB:string,        
                          DPB:string,        
                          PrBrub:string,     
                          AllBrub:string,    
                          MaterialB:string,  
                          TaxMaterialB:string,
                          DifB:string,       
                          ComBankB:string,   
                          ComExcB:string,    
                          ComB:string,       
                          TaxFRlink:string,  
                          SecType:string,    
                          TaxTags:string,    
                          AA:string,
                          SPoint,
                          BPoint         
                         )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_SHORTPOS_DBT (  T_GUID "       
                                                + " , T_ITOG "       
                                                + " , T_SORT "       
                                                + " , T_SECCODE "    
                                                + " , T_SECNAME "    
                                                + " , T_QNTY "       
                                                + " , T_CONTRACTS "  
                                                + " , T_CODES "      
                                                + " , T_DZS "        
                                                + " , T_DPS "        
                                                + " , T_PRSRUB "     
                                                + " , T_ALLSRUB "    
                                                + " , T_DIFS "       
                                                + " , T_COMBANKS "   
                                                + " , T_COMEXCS "    
                                                + " , T_COMS "       
                                                + " , T_CONTRACTB "  
                                                + " , T_CODEB "      
                                                + " , T_DZB "        
                                                + " , T_DPB "        
                                                + " , T_PRBRUB "     
                                                + " , T_ALLBRUB "    
                                                + " , T_MATERIALB "  
                                                + " , T_TAXMATERIALB "
                                                + " , T_DIFB "       
                                                + " , T_COMBANKB "   
                                                + " , T_COMEXCB "    
                                                + " , T_COMB "       
                                                + " , T_TAXFRLINK "  
                                                + " , T_SECTYPE "    
                                                + " , T_TAXTAGS "    
                                                + " , T_AA "
                                                + " , T_SPOINT "
                                                + " , T_BPOINT "
                                                + ") "
                     + " VALUES(?,"+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")+",?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";

       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(SecCode);
       ins.AddParam(SecName);
       ins.AddParam(Qnty);
       ins.AddParam(ContractS);
       ins.AddParam(CodeS);
       ins.AddParam(DZS);
       ins.AddParam(DPS);
       ins.AddParam(PrSrub);
       ins.AddParam(AllSrub);
       ins.AddParam(DifS);
       ins.AddParam(ComBankS);
       ins.AddParam(ComExcS);
       ins.AddParam(ComS);
       ins.AddParam(ContractB);
       ins.AddParam(CodeB);
       ins.AddParam(DZB);
       ins.AddParam(DPB);
       ins.AddParam(PrBrub);
       ins.AddParam(AllBrub);
       ins.AddParam(MaterialB);
       ins.AddParam(TaxMaterialB);
       ins.AddParam(DifB);
       ins.AddParam(ComBankB);
       ins.AddParam(ComExcB);
       ins.AddParam(ComB);
       ins.AddParam(TaxFRlink);
       ins.AddParam(SecType);
       ins.AddParam(TaxTags);
       ins.AddParam(AA);
       ins.AddParam(SPoint);
       ins.AddParam(BPoint);
       
       ins.ExecuteCMD();
    END;


    this.SetCurrentLineFont( 8, false, false );

    cmd = DL_RSDCommand();

    query  =  " select lnk.t_ID as LinkID, "
            + "        lnk.t_Amount as Qnty, "
            + "        lnk.t_PrivAmount as PrivQnty, "
            + "        lnk.t_Type AS LnkType, "
            + "        lnk.t_Client as t_PartyID, "
            + "        lnk.t_Date as LnkDate, "
            + "        av.t_TaxGroup, "
            + "        FinInstr.t_FIID, "
            + "        FinInstr.t_FI_Code as AvrCode, "
            + "        FinInstr.t_Name as AvrName, "
            + "        FinInstr.t_FaceValueFI, " 
            + "        FinInstr.t_AvoirKind, "
            + "        FinInstr.t_DrawingDate, "
            + "        FinInstr.t_Issued, "
            + "        FinInstr.t_SumPrecision, "
            + "        DealSale.t_BOfficeKind  AS SBOfficeKind, "
 
            + "        NVL((select sf.t_Number "
            + "               from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
            + "              where mp.t_SfContrID = salelot.t_Contract and dlc.t_DlContrID = mp.t_DlContrID and sf.t_ID = dlc.t_SfContrID"
            + "            ), CHR(1)) as ContractS, "
            + "        RTRIM(DECODE(DealSale.t_DealCodeTS,CHR(1),DealSale.t_DealCode,DealSale.t_DealCodeTS)) AS DealSaleCodeTS, "/*выводится номер исходной сделки продажи, если в связи в позиции продажа - виртуальная сделка*/

            + "        salelot.t_DEALDATE AS DealSaleDate, "
            + "        salelot.t_DocKind as SaleDocKind, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then salelot_real.t_DealDate else salelot_real.t_SALEDATE end) AS SaleDate, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then LegS.t_Maturity when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then salelot.t_DealDate else salecdlrq.t_FactDate end) AS SalePayDate, "
            + "        (case when salebdlrq.t_FactDate = "+GetSQLDate(date(0,0,0))+" then salebdlrq.t_Amount else lnk.t_Amount end) as t_Amount, "
            + "        salelot.t_PriceFIID AS ValS, "
            + "        salelot.t_Price AS SalePrice, "
            + "        LegS.t_LegKind AS LegKindSale, "
            + "        LegS.t_Principal AS SPrincipal, "
            + "        LegS.t_Point As SPoint, "

            + "        (case when DealSale.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_PriceFIID else salecdlrq.t_FIID end) as VpS, "
            + "        DealSale.t_DealID as DealSaleID, " 


            + "        NVL((select sf.t_Number "
            + "               from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
            + "              where mp.t_SfContrID = buylot.t_Contract and dlc.t_DlContrID = mp.t_DlContrID and sf.t_ID = dlc.t_SfContrID"
            + "            ), CHR(1)) as ContractB, "
            + "        DealBuy.t_DealID as DealBuyID, "
            + "        buylot.t_DEALCODE AS DealBuyCodeTS, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_BuyDate else buylot.t_DealDate end) as DealBuyDate, "
            + "        buylot.t_BuyDate, "
            + "        buylot.t_Price as BuyPrice, "
            + "        buylot.t_PriceFIID as ValB, "
            + "        LegB.t_Principal AS BPrincipal, "
            + "        LegB.t_LegKind AS LegKindBuy, "
            + "        LegB.t_Point As BPoint, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_RETIREMENT+" then buylot.t_DealDate else buylot.t_BuyDate end) AS BuyDate, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then buylot.t_BuyDate else buycdlrq.t_FactDate end) as PayBuyDate, "
            + "        DealBuy.t_BOfficeKind AS BBOfficeKind, "

            + "        npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

            + "        (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end) as TaxGroupType, "          

            + "        to_char(NPTO.IfMarket(FinInstr.t_FIID,salelot.t_DEALDATE)) SIfMarket, "
            
            + "        to_char(DECODE(buylot.t_DEALCODETS,chr(1),chr(1),NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DEALDATE))) BIfMarket, "
            + "        rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind)) as SaleGroup, "
            + "        NPTX.IsVirtual(salelot.t_Type) SaleIsVirtual, "
            + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
            + "        DealSale.t_CouponNDFL, "
            + "        DealSale.t_Number_Partly, "
            + "        DealSale.t_Number_Coupon, "
            + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(FinInstr.t_FIID, salelot.t_DEALDATE ), 0.0) NominalAVROnS, "
            + "        buylot.t_Contract, "
            + "        RSB_SECUR.GetMainObjAttr(101, LPAD(DealSale.t_DealID, 34, '0'), 55, lnk.t_Date) as IsSaleRepl, "
            + "        (CASE WHEN RSB_SECUR.GetMainObjAttr(101, LPAD(DealBuy.t_DealID, 34, '0'), 55, lnk.t_Date) != 0 "
            + "                   AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind))) = 0 THEN 1 ELSE 0 END) as IsBuyRepl, "
            + "        (CASE WHEN RSB_SECUR.GetMainObjAttr(101, LPAD(DealSale.t_DealID, 34, '0'), 55, lnk.t_Date) != 0 AND buylot.t_BuyDate <= " + GetSQLDate(MaxBuyDateForRepl) + " THEN 1 ELSE 0 END) as IsSaleRepl_BuyBef01032024, "
            + "        (CASE WHEN RSB_SECUR.GetMainObjAttr(101, LPAD(DealBuy.t_DealID, 34, '0'), 55, lnk.t_Date) != 0 "
            + "                   AND EXISTS(SELECT 1 "
            + "                                FROM DNPTXOP1OPLNK_TMP tmp1 "
            + "                               WHERE tmp1.t_Parent_DocID = lnk.t_ID AND tmp1.t_Parent_DocID <> tmp1.t_DocID "
            + "                             )"
            + "                   AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind))) = 0 THEN 1 ELSE 0 END) as IsBuyRepl_BuyBef01032024, "
            + "        0 as IsRepayCoup, "
            + "        0 as IsBuyCoup, "
            + "        0 as NkdB_TS, "
            + "        0 as AllNkdB_TS, "
            + "        COALESCE((SELECT MAX (T_OPERDATE) "
            + "               FROM DNPTXOP_DBT txop "
            + "              WHERE     txop.t_client = lnk.t_Client "
            + "                    AND txop.t_dockind = " + DL_CALCNDFL
            + "                    AND txop.T_STATUS = " + DL_TXOP_Close
            + "                    AND txop.t_Recalc = CHR(0) "
            + "                    AND txop.T_OPERDATE BETWEEN ? /*1*/ AND ? /*2*/"
            + "                    AND NOT EXISTS "
            + "                               (SELECT 1 "
            + "                                  FROM dobjatcor_dbt objatcor "
            + "                                 WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
            + "                                       AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
            + "                                       AND objatcor.T_GROUPID = 1 "
            + "                                       AND objatcor.T_ATTRID = 1) "
            + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc "

            + "   from dnptxlnk_dbt  lnk, "
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_Type = " + NPTXLNK_CLPOS  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and lnk.t_date BETWEEN ? /*3*/ AND ? /*4*/ "
            + "    and lnk.t_Client = ? /*5*/ " 
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate(+) <= ? /*6*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + IIF(m_ContractIDsStr != "", " and buylot.t_Contract IN ("+m_ContractIDsStr+") ", "")
            + "    and 1 = ( case when DealSale.t_BOfficeKind <> "+DL_RETIREMENT+" and DealSale.t_BOfficeKind <> "+DL_AVRWRT+" and (salebdlrq.t_FactDate <= ? /*7*/) then 1"
            + "                   when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then 1 "
            + "                   when DealSale.t_BOfficeKind = "+DL_AVRWRT+" AND RSB_SECUR.GetMainObjAttr(101, LPAD(DealSale.t_DealID, 34, '0'), 55, lnk.t_Date) = 1 then 1 "
            + "                   else 0 end)"
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 ";

    cmd.AddParam(m_BeginDate);      /*1*/
    cmd.AddParam(m_EndDate);        /*2*/
    cmd.AddParam(m_BeginDate);      /*3*/
    cmd.AddParam(m_EndDate);        /*4*/
    cmd.AddParam(m_CurrInvestor);   /*5*/
    cmd.AddParam(m_EndDate);        /*6*/
    cmd.AddParam(m_EndDate);        /*7*/
    
    if((m_AvrFIID != null) AND (m_AvrFIID > 0 )) /*задана бумага*/
       query = query + " and lnk.t_FIID = ? ";
       cmd.AddParam(m_AvrFIID);
    else
       if((m_AvrKind != null) AND (m_AvrKind > 0 )) /*задан вид бумаги*/
         query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
         cmd.AddParam(m_AvrKind);
       end;
    end;

    cnt = cmd.GetCount(query);

    if(cnt > 0)
      query = "select q.* from ("+query+") q order by q.DealSaleDate ASC";

      m_Rs = cmd.Execute(query);

      InitProgress( cnt, m_CurrInvestorSheetName+". Короткие позиции. Подготовка данных", m_CurrInvestorSheetName+". Короткие позиции. Подготовка данных" );
      while(m_Rs.moveNext())
          
        this.ClearCacheOneRecord();

        if ( //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
             (m_Include_Tech == SET_CHAR) or ((date(m_Rs.t_LastNoTechCalc) > date(0,0,0)) and not((this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and ((date(m_Rs.LnkDate) > date(m_Rs.t_LastNoTechCalc))) ))
           )
          
          var v_IsRET_PARTLY = IsRET_PARTLY( Int(m_RS.SaleGroup) );
          var v_IsRET_COUPON = IsRET_COUPON( Int(m_RS.SaleGroup) );

          WasPrinted = true;
          
          AddShortPosLine( UNSET_CHAR,
                           this.SecCode(),                                                                                                       
                           this.SecName(),                                                                                                       
                           this.Qnty(),                                                                                                          
                           this.ContractS(),                                                                                                     
                           this.CodeS(),                                                                                                         
                           this.DZS(),                                                                                                           
                           this.DPS(),                                                                                                           
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.PrSrub()),       
                           this.AllSrub(),                                                                                                       
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DifS()),                                                              
                           this.ComBankS(),                                                                                                      
                           this.ComExcS(),                                                                                                       
                           IIF(v_IsRET_COUPON and(m_Rs.CouponNDFL != SET_CHAR), "", this.ComS()),                                                
                           this.ContractB(),                                                                                                     
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.CodeB()),                                                              
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DZB()),                                                                
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DPB()),                                                                
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", ЧислоCЗаданнойТочностью(this.PrBrub(),m_RS.BPoint)),                        
                           IIF(v_IsRET_COUPON, "", this.AllBrub()),                                                                              
                           IIF(v_IsRET_COUPON, "", this.MaterialB()),                                                                            
                           IIF(v_IsRET_COUPON, "", this.TaxMaterialB()),                                                                         
                           IIF(v_IsRET_COUPON, "", this.DifB()),                                                                                 
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComBankB()),                                                           
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComExcB()),                                                            
                           IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComB()),                                                               
                           this.TaxFRlink(),                                                                                                     
                           this.SecType(),                                                                                                       
                           this.TaxTags(),                                                                                                       
                           "",                                                                                                              
                           m_RS.SPoint,
                           m_RS.BPoint
                          );
         

          Sum_Qnty         = Sum_Qnty         + this.Qnty();
          Sum_AllSrub      = Sum_AllSrub      + this.AllSrub();
          Sum_DifS         = Sum_DifS         + this.DifS();
          Sum_ComBankS     = Sum_ComBankS     + this.ComBankS();
          Sum_ComExcS      = Sum_ComExcS      + this.ComExcS();
          Sum_ComS         = Sum_ComS         + this.ComS();
          Sum_AllBrub      = Sum_AllBrub      + this.AllBrub();
          Sum_MaterialB    = Sum_MaterialB    + this.MaterialB();
          Sum_TaxMaterialB = Sum_TaxMaterialB + this.TaxMaterialB();
          Sum_DifB         = Sum_DifB         + this.DifB();
          Sum_ComBankB     = Sum_ComBankB     + this.ComBankB();
          Sum_ComExcB      = Sum_ComExcB      + this.ComExcB();
          Sum_ComB         = Sum_ComB         + this.ComB();
          Sum_TaxFRlink    = Sum_TaxFRlink    + this.TaxFRlink();
        end;

        UseProgress(i = i + 1);

      end;
      RemProgress();

      if(WasPrinted)
        AddShortPosLine( SET_CHAR,
                         "",      
                         "",      
                         Sum_Qnty,         
                         "",    
                         "",        
                         "",          
                         "",          
                         "", 
                         Sum_AllSrub,      
                         Sum_DifS,    
                         Sum_ComBankS,     
                         Sum_ComExcS,      
                         Sum_ComS,         
                         "",    
                         "",        
                         "",          
                         "",          
                         "",       
                         Sum_AllBrub,      
                         Sum_MaterialB,    
                         Sum_TaxMaterialB, 
                         Sum_DifB,         
                         Sum_ComBankB,     
                         Sum_ComExcB,      
                         Sum_ComB,         
                         Sum_TaxFRlink,    
                         "",      
                         "",      
                         "",      
                         0,
                         0
                        );
      end;
    end;

    return WasPrinted;
  END;

  //Реализация
  PRIVATE MACRO CreateRealizRep()
    var query, DataSet, cmd, ins, del, upd;
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_DifS = $0;
    var Sum_ComBankS = $0;
    var Sum_ComExcS =  $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_MaterialB = $0;
    var Sum_TaxMaterialB = $0;
    var Sum_DifB  = $0;
    var Sum_ComBankB =  $0;
    var Sum_ComExcB = $0;
    var Sum_ComB = $0;
    var Sum_TaxFRlink =0.0;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddRealizLine(Itog,
                        SecCode:string,    
                        SecName:string,    
                        Qnty:string,       
                        ContractS:string,  
                        CodeS:string,      
                        DZS:string,        
                        DPS:string,        
                        PrSrub:string,     
                        AllSrub:string,    
                        DifS:string,       
                        ComBankS:string,   
                        ComExcS:string,    
                        ComS:string,       
                        ContractB:string,  
                        CodeB:string,      
                        DZB:string,        
                        DPB:string,        
                        PrBrub:string,     
                        AllBrub:string,    
                        MaterialB:string,  
                        TaxMaterialB:string,
                        DifB:string,       
                        ComBankB:string,   
                        ComExcB:string,    
                        ComB:string,       
                        TaxFRlink:string,  
                        SecType:string,    
                        TaxTags:string,    
                        AA:string,
                        SPoint,
                        BPoint         
                       )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_REALIZ_DBT (  T_GUID "       
                                              + " , T_ITOG "       
                                              + " , T_SORT "       
                                              + " , T_SECCODE "    
                                              + " , T_SECNAME "    
                                              + " , T_QNTY "       
                                              + " , T_CONTRACTS "  
                                              + " , T_CODES "      
                                              + " , T_DZS "        
                                              + " , T_DPS "        
                                              + " , T_PRSRUB "     
                                              + " , T_ALLSRUB "    
                                              + " , T_DIFS "       
                                              + " , T_COMBANKS "   
                                              + " , T_COMEXCS "    
                                              + " , T_COMS "       
                                              + " , T_CONTRACTB "  
                                              + " , T_CODEB "      
                                              + " , T_DZB "        
                                              + " , T_DPB "        
                                              + " , T_PRBRUB "     
                                              + " , T_ALLBRUB "    
                                              + " , T_MATERIALB "  
                                              + " , T_TAXMATERIALB "
                                              + " , T_DIFB "       
                                              + " , T_COMBANKB "   
                                              + " , T_COMEXCB "    
                                              + " , T_COMB "       
                                              + " , T_TAXFRLINK "  
                                              + " , T_SECTYPE "    
                                              + " , T_TAXTAGS "    
                                              + " , T_AA "
                                              + " , T_SPOINT "
                                              + " , T_BPOINT "
                                              + ") "
                     + " VALUES(?,"+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")+",?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";

       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(SecCode);
       ins.AddParam(SecName);
       ins.AddParam(Qnty);
       ins.AddParam(ContractS);
       ins.AddParam(CodeS);
       ins.AddParam(DZS);
       ins.AddParam(DPS);
       ins.AddParam(PrSrub);
       ins.AddParam(AllSrub);
       ins.AddParam(DifS);
       ins.AddParam(ComBankS);
       ins.AddParam(ComExcS);
       ins.AddParam(ComS);
       ins.AddParam(ContractB);
       ins.AddParam(CodeB);
       ins.AddParam(DZB);
       ins.AddParam(DPB);
       ins.AddParam(PrBrub);
       ins.AddParam(AllBrub);
       ins.AddParam(MaterialB);
       ins.AddParam(TaxMaterialB);
       ins.AddParam(DifB);
       ins.AddParam(ComBankB);
       ins.AddParam(ComExcB);
       ins.AddParam(ComB);
       ins.AddParam(TaxFRlink);
       ins.AddParam(SecType);
       ins.AddParam(TaxTags);
       ins.AddParam(AA);
       ins.AddParam(SPoint);
       ins.AddParam(BPoint);
       
       ins.ExecuteCMD();
    END;

    SQL_Execute("DELETE FROM DNPTXOP1OPLNK_TMP", "", false );
    SQL_Execute("DELETE FROM DNPTXSHSUM_TMP", "", false );

    query =   " INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT, T_AMOUNT1) "
            + " SELECT DISTINCT lnk.t_ID, lnk.t_ID, lnk.t_Amount, SUM(lnk.t_Amount) OVER(PARTITION BY lnk.t_ID, lnk.t_Date ORDER BY lnk.t_ID) "
            + "   from dnptxlnk_dbt  lnk, "
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_Type = " + NPTXLNK_DELIVER  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and lnk.t_date BETWEEN ? /*4*/ AND ? /*5*/ "
            + "    and lnk.t_Client = ? /*6*/ " 
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate(+) <= ? /*7*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + IIF(m_ContractIDsStr != "", " and buylot.t_Contract IN ("+m_ContractIDsStr+") ", "")
            + IIF(m_ContractIDsStr != "", " and buylot.t_Contract IN ("+m_ContractIDsStr+") ", "")
            + "    and 1 = ( case when DealSale.t_BOfficeKind <> "+DL_RETIREMENT+" and DealSale.t_BOfficeKind <> "+DL_AVRWRT+" and (salebdlrq.t_FactDate <= ? /*8*/) then 1"
            + "                   when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then 1 "
            + "                   when DealSale.t_BOfficeKind = "+DL_AVRWRT+" AND RSB_SECUR.GetMainObjAttr(101, LPAD(DealSale.t_DealID, 34, '0'), 55, lnk.t_Date) = 1 then 1 "
            + "                   else 0 end)"
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 ";

    ins = DL_RSDCommand(query);
    
    ins.AddParam(m_BeginDate);      /*4*/
    ins.AddParam(m_EndDate);        /*5*/
    ins.AddParam(m_CurrInvestor);   /*6*/
    ins.AddParam(m_EndDate);        /*7*/
    ins.AddParam(m_EndDate);        /*8*/

    ins.ExecuteCMD(query);


    //Добавим связи по погашениям прошлых налоговых периодов, по которым выплаты прошли в текущем налоговом периоде
    query =   " INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT, T_AMOUNT1) "
            + " SELECT DISTINCT S.t_ID, S.t_ID, S.T_AMOUNT, SUM(S.t_Amount) OVER(PARTITION BY S.t_ID, S.t_Date ORDER BY S.t_ID) " 
            + "   FROM dnptxlnk_dbt S, v_npx_dnptxlot LS "
            + "  WHERE S.t_Type = " + NPTXLNK_DELIVER
            + "    AND EXTRACT(YEAR FROM S.t_Date) < EXTRACT(YEAR FROM ?) "
            + "    AND S.t_Client = ? "
            + "    AND LS.t_ID    = S.t_SaleID "
            + "    AND LS.t_DocKind = " + DL_RETIREMENT
            + "    AND NVL((SELECT MAX(obj.t_Date) "
            + "              FROM dnptxobj_dbt obj "
            + "             WHERE obj.t_AnaliticKind1 = " + TXOBJ_KIND1020
            + "               AND obj.t_Analitic1 = LS.t_DocID "
            + "               AND obj.t_Kind = " + TXOBJ_MAIN
            + "               AND obj.t_Direction = " + TXOBJ_DIR_IN
            + IIF(m_Include_Tech != SET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical IS NULL) ", "") 
            + "            ), S.t_Date "
            + "           ) BETWEEN ? AND ? ";

    ins = DL_RSDCommand(query);
    
    ins.AddParam(m_BeginDate);
    ins.AddParam(m_CurrInvestor);  
    ins.AddParam(m_BeginDate);     
    ins.AddParam(m_EndDate);       
    
    ins.ExecuteCMD(query);

  SetOutHandler(@SqlHandler);
  gSQL = "";

[DECLARE
    v_OldWrtAmount   NUMBER;
    v_SaveOldWrtAmount   NUMBER;
    v_Amount         NUMBER;
    v_Amount2        NUMBER;
    v_RestPLnkAmount NUMBER;
    v_TotalAmount NUMBER := 0; 
 BEGIN 
    DELETE FROM DNPTXOP1OPLNK_TMP TMP
     WHERE TMP.T_DOCID = TMP.T_PARENT_DOCID
       AND EXISTS(SELECT 1 
                    FROM DNPTXLNK_DBT LNK, DNPTXLOT_DBT BUY, DNPTXLOT_DBT SALE
                   WHERE LNK.T_ID = TMP.T_DOCID
                     AND BUY.T_ID = LNK.T_BUYID
                     AND BUY.T_BUYDATE <= ? /*1*/
                     AND SALE.T_ID = LNK.T_SALEID
                     AND RSB_SECUR.GetMainObjAttr(101, LPAD(SALE.t_DocID, 34, '0'), 55, LNK.T_DATE) = 1
                 );
 
    FOR one_fi IN (SELECT DISTINCT S.T_FIID
                     FROM DNPTXOP1OPLNK_TMP TMP, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB, DDL_TICK_DBT TKB, V_NPX_DNPTXLOT LS, DDL_TICK_DBT TKS
                    WHERE S.T_ID = TMP.T_DOCID
                      AND LB.T_ID = S.T_BUYID
                      AND TKB.T_BOFFICEKIND = LB.T_DOCKIND
                      AND TKB.T_DEALID      = LB.T_DOCID
                      AND RSB_SECUR.GetMainObjAttr(101, LPAD(TKB.t_DealID, 34, '0'), 55, S.T_DATE) = 1
                      AND LS.T_ID = S.T_SALEID
                      AND TKS.T_BOFFICEKIND = LS.T_DOCKIND
                      AND TKS.T_DEALID      = LS.T_DOCID
                      AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TKS.t_DealType, TKS.t_BofficeKind))) = 0
                  )
    LOOP
      v_TotalAmount := 0;

      SELECT NVL(SUM(Q.T_AMOUNT), 0) INTO v_OldWrtAmount
        FROM (SELECT DISTINCT S2.*  
                FROM DNPTXOP1OPLNK_TMP TMP, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB, DDL_TICK_DBT TKB, DNPTXLNK_DBT S2
               WHERE S.T_ID = TMP.T_DOCID
                 AND S.T_FIID = one_fi.t_FIID
                 AND LB.T_ID = S.T_BUYID
                 AND TKB.T_BOFFICEKIND = LB.T_DOCKIND
                 AND TKB.T_DEALID      = LB.T_DOCID
                 AND RSB_SECUR.GetMainObjAttr(101, LPAD(TKB.t_DealID, 34, '0'), 55, S.T_DATE) = 1
                 AND S2.T_BUYID = S.T_BUYID
                 AND S2.T_DATE < ? /*2*/
             ) Q;

       v_SaveOldWrtAmount := v_OldWrtAmount;

       FOR one_parent_lnk IN (SELECT S.T_ID, S.T_AMOUNT, NVL(rsb_struct.getInt(rsi_rsb_kernel.GetNote(RSB_SECUR.OBJTYPE_SECDEAL, LPAD(TKB.T_DEALID, 34, '0'), 38/*Идентификатор связанной сделки замещения*/, S.T_DATE)), 0) AS SaleDealID
                               FROM DNPTXOP1OPLNK_TMP TMP, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB, DDL_TICK_DBT TKB, V_NPX_DNPTXLOT LS, DDL_TICK_DBT TKS
                              WHERE S.T_ID = TMP.T_DOCID
                                AND S.T_FIID = one_fi.T_FIID
                                AND LB.T_ID = S.T_BUYID
                                AND TKB.T_BOFFICEKIND = LB.T_DOCKIND
                                AND TKB.T_DEALID      = LB.T_DOCID
                                AND RSB_SECUR.GetMainObjAttr(101, LPAD(TKB.t_DealID, 34, '0'), 55, S.T_DATE) = 1
                                AND LS.T_ID = S.T_SALEID
                                AND TKS.T_BOFFICEKIND = LS.T_DOCKIND
                                AND TKS.T_DEALID      = LS.T_DOCID
                                AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(TKS.t_DealType, TKS.t_BofficeKind))) = 0
                              ORDER BY S.T_ID ASC
                           )
      LOOP
        v_RestPLnkAmount := one_parent_lnk.t_Amount;

        FOR one_lnk IN (SELECT Q1.*
                          FROM (SELECT Q.*, sum(Q.LnkAmount) OVER(ORDER BY Q.T_DEALDATE ASC, Q.T_DEALTIME ASC, Q.T_DOCID ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as TotalAmount
                                  FROM (SELECT S.T_ID, LB.T_DEALDATE, LB.T_DEALTIME, LB.T_DOCID, S.T_AMOUNT as LnkAmount
                                          FROM DDL_TICK_DBT TKS, V_NPX_DNPTXLOT LS, DNPTXLNK_DBT S, V_NPX_DNPTXLOT LB
                                         WHERE TKS.T_DEALID = one_parent_lnk.SaleDealID
                                           AND LS.T_DOCKIND = TKS.T_BOFFICEKIND
                                           AND LS.T_DOCID   = TKS.T_DEALID
                                           AND S.T_SALEID = LS.T_ID
                                           AND LB.T_ID = S.T_BUYID
                                           AND LB.T_BUYDATE <= ? /*3*/
                                       ) Q
                                 WHERE Q.LnkAmount > 0
                               ) Q1
                         WHERE Q1.TotalAmount > (v_OldWrtAmount + v_TotalAmount)
                        ORDER BY Q1.T_DEALDATE ASC, Q1.T_DEALTIME ASC, Q1.T_DOCID ASC
                       )
        LOOP

          v_Amount := LEAST(v_RestPLnkAmount, one_lnk.TotalAmount - (v_OldWrtAmount + v_TotalAmount));

          --Так как далее отбираемые объекты НДР по каждой связи создаются на всё количество (из родительской связи) проданных связью ц/б, то надо запомнить это значение, так как далее его сложно вычислить
          v_Amount2 := v_OldWrtAmount + v_TotalAmount - one_lnk.TotalAmount + one_lnk.LnkAmount + v_Amount; 

          
          INSERT INTO DNPTXOP1OPLNK_TMP (T_DOCID, T_PARENT_DOCID, T_AMOUNT, T_AMOUNT1, T_AMOUNT2) VALUES(one_lnk.t_ID, one_parent_lnk.t_ID, v_Amount, 0, v_Amount2);


          v_TotalAmount := v_TotalAmount + v_Amount;

          v_RestPLnkAmount := v_RestPLnkAmount - v_Amount;

          IF v_RestPLnkAmount = 0 THEN
            EXIT;
          END IF;
        END LOOP;

      END LOOP;

      UPDATE DNPTXOP1OPLNK_TMP T SET T.T_AMOUNT2 = (SELECT MAX(T1.T_AMOUNT2) FROM DNPTXOP1OPLNK_TMP T1 WHERE T.T_DOCID = T1.T_DOCID)
      WHERE EXISTS(SELECT 1 FROM DNPTXLNK_DBT S WHERE S.T_ID = T.T_PARENT_DOCID AND S.T_FIID = one_fi.t_FIID);

    END LOOP;
END;
];

    SetOutHandler(NULL);

    cmd = RSDCommand(gSQL);
    
    cmd.addParam("", RSDBP_IN,  date(MaxBuyDateForRepl)); /*1*/
    cmd.addParam("", RSDBP_IN,  date(m_BeginDate));       /*2*/
    cmd.addParam("", RSDBP_IN,  date(MaxBuyDateForRepl)); /*3*/
    cmd.execute();


    query =   " UPDATE DNPTXOP1OPLNK_TMP T "
            + "    SET T.T_AMOUNT1 = (SELECT SUM(T1.T_AMOUNT) "
            + "                        FROM DNPTXOP1OPLNK_TMP T1, DNPTXLNK_DBT LNK, DNPTXLNK_DBT PLNK "
            + "                       WHERE T1.T_DOCID = T.T_DOCID "
            + "                         AND LNK.T_ID = T.T_PARENT_DOCID "
            + "                         AND PLNK.T_ID = T1.T_PARENT_DOCID "
            + "                         AND LNK.T_DATE = PLNK.T_DATE) ";

    upd = DL_RSDCommand(query);
    upd.ExecuteCMD();


    if( (m_AvrFIID != null) AND (m_AvrFIID > 0 ) ) /*задана бумага*/
       query =   " DELETE FROM DNPTXOP1OPLNK_TMP tmp "
               + "   WHERE NOT(   Exists(select 1 from dnptxlnk_dbt lnk where lnk.t_ID = tmp.t_DocID and lnk.t_FIID = ?) "
               + "             OR Exists(select 1 from DNPTXOP1OPLNK_TMP tmp1, dnptxlnk_dbt lnk where tmp1.t_Parent_DocID = tmp.t_DocID and lnk.t_ID = tmp1.t_DocID and lnk.t_FIID = ?) "
               + "             OR Exists(select 1 from DNPTXOP1OPLNK_TMP tmp1, dnptxlnk_dbt lnk where tmp1.t_DocID = tmp.t_Parent_DocID and lnk.t_ID = tmp1.t_DocID and lnk.t_FIID = ?) "
               + "            )"; 
       
       del = DL_RSDCommand(query);
       
       del.AddParam(m_AvrFIID);
       del.AddParam(m_AvrFIID);
       del.AddParam(m_AvrFIID);

       del.ExecuteCMD();
    elif( (m_AvrKind != null) AND (m_AvrKind > 0 ) ) /*задан вид бумаги*/
       query =   " DELETE FROM DNPTXOP1OPLNK_TMP tmp "
             + "   WHERE NOT(   Exists(select 1 from dnptxlnk_dbt lnk, dfininstr_dbt fin where lnk.t_ID = tmp.t_DocID and fin.t_FIID = lnk.t_FIID and RSB_FIInstr.FI_AvrKindsEQ(2, ?, fin.t_AvoirKind) <> 1) "
             + "             OR Exists(select 1 from DNPTXOP1OPLNK_TMP tmp1, dnptxlnk_dbt lnk, dfininstr_dbt fin where tmp1.t_Parent_DocID = tmp.t_DocID and lnk.t_ID = tmp1.t_DocID and fin.t_FIID = lnk.t_FIID and RSB_FIInstr.FI_AvrKindsEQ(2, ?, fin.t_AvoirKind) <> 1) "
             + "             OR Exists(select 1 from DNPTXOP1OPLNK_TMP tmp1, dnptxlnk_dbt lnk, dfininstr_dbt fin where tmp1.t_DocID = tmp.t_Parent_DocID and lnk.t_ID = tmp1.t_DocID and fin.t_FIID = lnk.t_FIID and RSB_FIInstr.FI_AvrKindsEQ(2, ?, fin.t_AvoirKind) <> 1) "
             + "            )"; 
     
       del = DL_RSDCommand(query);
       
       del.AddParam(m_AvrKind);
       del.AddParam(m_AvrKind);
       del.AddParam(m_AvrKind);

       del.ExecuteCMD();
    end;

    cmd = DL_RSDCommand();

    query  =  " select lnk.t_ID as LinkID, "
            + "        tmp.t_Amount as Qnty, "
            + "        lnk.t_PrivAmount as PrivQnty, "
            + "        lnk.t_Type AS LnkType, "
            + "        lnk.t_Client as t_PartyID, "
            + "        lnk.t_Date as LnkDate, "
            + "        Plnk.t_ID as PLnkID, "
            + "        Plnk.t_Date as PLnkDate, "
            + "        av.t_TaxGroup, "
            + "        FinInstr.t_FIID, "
            + "        FinInstr.t_FI_Code as AvrCode, "
            + "        FinInstr.t_Name as AvrName, "
            + "        FinInstr.t_FaceValueFI, " 
            + "        FinInstr.t_AvoirKind, "
            + "        FinInstr.t_DrawingDate, "
            + "        FinInstr.t_Issued, "
            + "        FinInstr.t_SumPrecision, "
            + "        DealSale.t_BOfficeKind  AS SBOfficeKind, "
 
            + "        NVL((select sf.t_Number "
            + "               from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
            + "              where mp.t_SfContrID = salelot.t_Contract and dlc.t_DlContrID = mp.t_DlContrID and sf.t_ID = dlc.t_SfContrID "
            + "            ), CHR(1)) as ContractS, "
            + "        salelot.t_DEALCODE AS DealSaleCodeTS, "
            + "        salelot.t_DEALDATE AS DealSaleDate, "
            + "        salelot.t_DocKind as SaleDocKind, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then salelot.t_DealDate else salelot.t_SALEDATE end) AS SaleDate, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then LegS.t_Maturity when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then salelot.t_DealDate else salecdlrq.t_FactDate end) AS SalePayDate, "
            + "        (case when salebdlrq.t_FactDate = "+GetSQLDate(date(0,0,0))+" then salebdlrq.t_Amount else lnk.t_Amount end) as t_Amount, "
            + "        salelot.t_PriceFIID AS ValS, "
            + "        salelot.t_Price AS SalePrice, "
            + "        LegS.t_LegKind AS LegKindSale, "
            + "        LegS.t_Principal AS SPrincipal, "
            + "        LegS.t_Point As SPoint, "

            + "        (case when DealSale.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_PriceFIID else salecdlrq.t_FIID end) as VpS, "
            + "        DealSale.t_DealID as DealSaleID, " 

            + "        NVL((select sf.t_Number "
            + "               from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
            + "              where mp.t_SfContrID = buylot.t_Contract and dlc.t_DlContrID = mp.t_DlContrID and sf.t_ID = dlc.t_SfContrID"
            + "            ), CHR(1)) as ContractB, "
            + "        DealBuy.t_DealID as DealBuyID, "
            + "        buylot.t_DEALCODE AS DealBuyCodeTS, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_BuyDate else buylot.t_DealDate end) as DealBuyDate, "
            + "        buylot.t_BuyDate, "
            + "        buylot.t_Price as BuyPrice, "
            + "        buylot.t_PriceFIID as ValB, "
            + "        LegB.t_Principal AS BPrincipal, "
            + "        LegB.t_LegKind AS LegKindBuy, "
            + "        LegB.t_Point As BPoint, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_RETIREMENT+" then buylot.t_DealDate else buylot.t_BuyDate end) AS BuyDate, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then buylot.t_BuyDate else buycdlrq.t_FactDate end) as PayBuyDate, "
            + "        DealBuy.t_BOfficeKind AS BBOfficeKind, "

            + "        npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

            + "        (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end) as TaxGroupType, "          

            + "        to_char(NPTO.IfMarket(FinInstr.t_FIID,salelot.t_DEALDATE)) SIfMarket, "
            
            + "        to_char(DECODE(buylot.t_DEALCODETS,chr(1),chr(1),NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DEALDATE))) BIfMarket, "
            + "        rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind)) as SaleGroup, "
            + "        NPTX.IsVirtual(salelot.t_Type) SaleIsVirtual, "
            + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
            + "        DealSale.t_CouponNDFL, "
            + "        DealSale.t_Number_Partly, "
            + "        DealSale.t_Number_Coupon, "
            + "        buylot.t_Contract Contract, "
            + "        salelot.t_saleDate AS SaleDateOVVZ, "
            + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(FinInstr.t_FIID, salelot.t_DEALDATE ), 0.0) NominalAVROnS, "
            + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(FinInstr.t_FIID, buylot.t_DealDate ), 0.0) NominalAVROnB, "
            + "        NVL(rsb_fiinstr.ConvSum(1, FinInstr.t_FaceValueFI, " + string(NATCUR) + ", salelot.t_saleDate ), 0.0) SCourseNominal, " //??
            + "        NVL(rsb_fiinstr.ConvSum(1, FinInstr.t_FaceValueFI, " + string(NATCUR) + ", buylot.t_DealDate ), 0.0) BCourseNominal, "  //??
            + "        COALESCE((SELECT MAX (T_OPERDATE) "
            + "               FROM DNPTXOP_DBT txop "
            + "              WHERE     txop.t_client = lnk.t_Client "
            + "                    AND txop.t_dockind = " + DL_CALCNDFL
            + "                    AND txop.t_Recalc = CHR(0) "
            + "                    AND txop.T_STATUS = " + DL_TXOP_Close
            + "                    AND txop.T_OPERDATE BETWEEN ? /*1*/ AND ? /*2*/"
            + "                    AND NOT EXISTS "
            + "                               (SELECT 1 "
            + "                                  FROM dobjatcor_dbt objatcor "
            + "                                 WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
            + "                                       AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
            + "                                       AND objatcor.T_GROUPID = 1 "
            + "                                       AND objatcor.T_ATTRID = 1) "
            + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, "
            + "        RSB_SECUR.GetMainObjAttr(101, LPAD(DealSale.t_DealID, 34, '0'), 55, lnk.t_Date) as IsSaleRepl, "
            + "        (CASE WHEN RSB_SECUR.GetMainObjAttr(101, LPAD(DealBuy.t_DealID, 34, '0'), 55, lnk.t_Date) != 0 "
            + "                   AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind))) = 0 THEN 1 ELSE 0 END) as IsBuyRepl, "
            + "        (CASE WHEN RSB_SECUR.GetMainObjAttr(101, LPAD(DealSale.t_DealID, 34, '0'), 55, lnk.t_Date) != 0 AND buylot.t_BuyDate <= " + GetSQLDate(MaxBuyDateForRepl) + " THEN 1 ELSE 0 END) as IsSaleRepl_BuyBef01032024, "
            + "        (CASE WHEN RSB_SECUR.GetMainObjAttr(101, LPAD(DealBuy.t_DealID, 34, '0'), 55, lnk.t_Date) != 0 "
            + "                   AND EXISTS(SELECT 1 "
            + "                                FROM DNPTXOP1OPLNK_TMP tmp1 "
            + "                               WHERE tmp1.t_Parent_DocID = tmp.t_DocID AND tmp1.t_Parent_DocID <> tmp1.t_DocID "
            + "                             )"
            + "                   AND RSB_SECUR.IsAvrWrtOut(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind))) = 0 THEN 1 ELSE 0 END) as IsBuyRepl_BuyBef01032024, "
            + "        0 as IsRepayCoup, "
            + "        0 as IsBuyCoup, "
            + "        0 as NkdB_TS, "
            + "        0 as AllNkdB_TS "
  
            + "   from DNPTXOP1OPLNK_TMP tmp, dnptxlnk_dbt lnk, dnptxlnk_dbt Plnk,"
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_ID = tmp.t_DocID "
            + "    and Plnk.t_ID = tmp.t_Parent_DocID "  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate(+) <= ? /*7*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + IIF(m_ContractIDsStr != "", " and buylot.t_Contract IN ("+m_ContractIDsStr+") ", "")
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 ";

    cmd.AddParam(m_BeginDate);      /*1*/
    cmd.AddParam(m_EndDate);        /*2*/
    cmd.AddParam(m_EndDate);        /*7*/
    
    

    query = query + " UNION ALL "
                  + " SELECT 0 AS LinkID, "
                  + "        (select nvl(sum(T_Amount),0) "
                  + "           from dnptxts_dbt T " 
                  + "          where T.t_Type = " + NPTXTS_REST
                  + "            and T.t_Client = sf.t_PartyID " 
                  + "            and exists( "
                  + "                         select 1 "
                  + "                         from ddlcontrmp_dbt mp, dsfcontr_dbt sf_mp"
                  + "                         where mp.t_DlContrID = dlc.t_DlContrID "
                  + "                           and sf_mp.t_ID = mp.t_SfContrID "
                  + "                           and sf_mp.t_ServKind = " + PTSK_STOCKDL
                  + "                           and sf_mp.t_DateBegin <= rc.t_PaymentDate "
                  + "                           and (sf_mp.t_DateClose >= rc.t_PaymentDate or sf_mp.t_DateClose = " + GetSQLDate(date(0,0,0)) + ") "
                  + "                           and sf_mp.t_ID = T.t_Contract "
                  + "                      ) "
                  + "            and T.t_FIID = avr.t_FIID " 
                  + "            and T.t_BegDate <= rc.t_PaymentDate " 
                  + "            and (T.t_EndDate >= rc.t_PaymentDate or T.t_EndDate = TO_DATE('01-01-0001','DD-MM-YYYY') )"
                  + "        ) AS Qnty, "
                  + "    0 AS PrivQnty,  " 
                  + "    0 AS LnkType, "
                  + "    sf.t_PartyID, "
                  + "    "+GetSQLDate(date(0,0,0))+" as LnkDate, "
                  + "    0 as PLnkID, "
                  + "    "+GetSQLDate(date(0,0,0))+" as PLnkDate, "
                  + "    0 AS t_TaxGroup, FinInstr.t_FIID, "
                  + "    FinInstr.t_FI_Code AS AvrCode, FinInstr.t_Name AS AvrName, "
                  + "    FinInstr.t_FaceValueFI, FinInstr.t_AvoirKind, "
                  + "    FinInstr.t_DrawingDate, FinInstr.t_Issued, "
                  + "    FinInstr.t_SumPrecision,  0 AS SBOfficeKind,"

                  + "    rc.t_AgreementNumber as ContractS, "
                  + "    TO_CHAR(rc.t_CouponNumber) AS DealSaleCodeTS, "
                  + "    rc.t_PaymentDate AS DealSaleDate, "
                  + "    0 as SaleDocKind, "
                  + "    rc.t_PaymentDate AS SaleDate, "
                  + "    rc.t_PaymentDate AS SalePayDate, 0 AS Amount, "
                  + "    0 AS ValS,                        rc.t_IssuerSum AS SalePrice, "
                  + "    0 AS LegKindSale, 0 AS SPoint, "
                  + "    0 AS SPrincipal,    0 AS VpS, "
                  + "    0 AS DealSaleID, "

                  + "    CHR(1) as ContractB, "
                  + "    0 AS DealBuyID, "
                  + "    NULL AS DealBuyCodeTS,            NULL AS DealBuyDate, "
                  + "    NULL AS t_BuyDate,                0 AS BuyPrice, "
                  + "    0 AS ValB,                        "
                  + "    0 AS BPrincipal,                  0 AS LegKindBuy, 0 AS BPoint, "
                  + "    NULL AS BuyDate,                  0 AS VpB, "
                  + "    NULL AS PayBuyDate,               0 AS BBOfficeKind, "
                  + "    npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

                  + "    (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end)  AS TaxGroupType, "  
                  + "    TO_CHAR (NPTO.IfMarket (FinInstr.t_FIID, rc.t_PaymentDate)) SIfMarket, " 
                  + "    '' AS BIfMarket, "
                  + "    0 AS SaleGroup, "
                  + "    0 SaleIsVirtual, "
                  + "    0 BuyIsVirtual, "
                  + "    CHR(0), "
                  + "    CHR(1), "
                  + "    TO_CHAR(rc.t_CouponNumber) as t_Number_Coupon, "
                  + "    sf.t_ID Contract, "
                  + "    TO_DATE('01.01.0001','DD.MM.YYYY') SaleDateOVVZ, "
                  + "    1 AS NominalAVROnS, "
                  + "    1 AS NominalAVROnB, "
                  + "    0 AS SCourseNominal, " 
                  + "    0 AS BCourseNominal, " 
                  + " COALESCE((SELECT MAX (T_OPERDATE) "
                  + "    FROM DNPTXOP_DBT txop "
                  + "   WHERE     txop.t_client = sf.t_PartyID "
                  + "         AND txop.t_dockind = " + DL_CALCNDFL
                  + "         AND txop.t_Recalc = CHR(0) "
                  + "         AND txop.T_STATUS = " + DL_TXOP_Close
                  + "         AND txop.T_OPERDATE BETWEEN ? /*9*/ AND ? /*10*/"
                  + "         AND NOT EXISTS "
                  + "                    (SELECT 1 "
                  + "                       FROM dobjatcor_dbt objatcor "
                  + "                      WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
                  + "                            AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
                  + "                            AND objatcor.T_GROUPID = 1 "
                  + "                            AND objatcor.T_ATTRID = 1) "
                  + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, "
                  + "    0 as IsSaleRepl, "
                  + "    0 as IsBuyRepl, "
                  + "    0 as IsSaleRepl_BuyBef01032024, "
                  + "    0 as IsBuyRepl_BuyBef01032024, "
                  + "    1 as IsRepayCoup, "
                  + "    0 as IsBuyCoup, "
                  + "    0 as NkdB_TS, "
                  + "    (CASE WHEN rc.t_ID = rc1.t_ID THEN "
                  + "    NVL((select SUM(obj.t_Sum0)"
                  + "           from dnptxobj_dbt obj "
                  + "          where obj.t_Client = sf.t_PartyID "
                  + "            and obj.t_Kind = " + TXOBJ_NKDB_TS
                  + "            and obj.t_AnaliticKind2 = " + TXOBJ_KIND2030
                  + "            and obj.t_Analitic2 = rc.t_CouponNumber "
                  + "            and obj.t_AnaliticKind3 = " + TXOBJ_KIND3010
                  + "            and obj.t_Analitic3 = avr.t_FIID " + IIF(m_Include_Tech != SET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical IS NULL) ", "")
                  + "            and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020
                  + "            AND exists( "
                  + "                 select 1 "
                  + "                 from ddlcontrmp_dbt mp, dsfcontr_dbt sf_mp"
                  + "                 where mp.t_DlContrID = dlc.t_DlContrID "
                  + "                   AND sf_mp.t_ID = mp.t_SfContrID "
                  + "                   AND sf_mp.t_ServKind = " + PTSK_STOCKDL
                  + "                   AND sf_mp.t_DateBegin <= rc.t_PaymentDate "
                  + "                   AND (sf_mp.t_DateClose >= rc.t_PaymentDate or sf_mp.t_DateClose = " + GetSQLDate(date(0,0,0)) + ") "
                  + "                   AND sf_mp.t_ID = obj.t_Analitic6 "
                  + "              ) "
                  + "        ), 0) ELSE 0 END) as AllNkdB_TS "
                  + "   FROM dsfcontr_dbt sf, ddlcontr_dbt dlc, dcdrecords_dbt rc, dcdrecords_dbt rc1, davoiriss_dbt avr, dfininstr_dbt FinInstr "
                  + "  WHERE sf.t_PartyID = ? /*11*/ "
                  + "    AND dlc.t_SfContrID = sf.t_ID "
                  + "    AND rc.t_AgreementNumber = sf.t_Number "
                  + "    AND (rc.t_IsIIS = " + IIF(m_CurrIIS, "CHR(88)", "CHR(0)") + IIF(m_CurrIIS, "", " or rc.t_IsIIS is NULL") + ")"
                  + "    AND rc.t_CorporateActionType = 'INTR' "
                  + "    AND rc.t_AccountNumber LIKE '306%' "
                  + "    AND LOWER(rc.t_OperationStatus) = 'активна' "
                  + "    AND (rc.t_IsGetTax <> 'X' or rc.t_IsGetTax IS NULL) "
                  + "    AND rc.t_PaymentDate BETWEEN ? /*12*/ and ? /*13*/ "
                  + "    AND rc.t_PaymentDate <= NVL((SELECT MAX (T_OPERDATE) "
                  + "                                   FROM DNPTXOP_DBT txop "
                  + "                                  WHERE     txop.t_client = sf.t_PartyID "
                  + "                                        AND txop.t_dockind = " + DL_CALCNDFL
                  + "                                        AND txop.T_STATUS = " + DL_TXOP_Close
                  + "                                        AND txop.T_OPERDATE BETWEEN ? /*14*/ AND ? /*15*/"
                  + "                                        AND (   1 = " + IIF(m_Include_Tech == SET_CHAR, "1", "0")
                  + "                                             OR NOT EXISTS (SELECT 1 "
                  + "                                                              FROM dobjatcor_dbt objatcor "
                  + "                                                             WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
                  + "                                                               AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
                  + "                                                               AND objatcor.T_GROUPID = 1 "
                  + "                                                               AND objatcor.T_ATTRID = 1 "
                  + "                                                           )"
                  + "                                            ) "
                  + "                                 ), "+GetSQLDate(date(0,0,0))+") "
                  + "    AND rc.t_ID IN (SELECT MAX(CD1.T_ID) "
                  + "                      FROM DCDRECORDS_DBT CD1 "
                  + "                     WHERE CD1.t_RecordPaymentID = rc.t_RecordPaymentID "
                  + "                   ) "
                  + "    AND rc1.t_ID = (SELECT MAX(CD1.T_ID) "
                  + "                      FROM DCDRECORDS_DBT CD1 "
                  + "                     WHERE CD1.t_PartyID = rc.t_PartyID "
                  + "                       AND CD1.t_FIID = rc.t_FIID "
                  + "                       AND CD1.t_ContractID = rc.t_ContractID "
                  + "                       AND CD1.t_CouponNumber = rc.t_CouponNumber "
                  + "                       AND CD1.t_CorporateActionType = rc.t_CorporateActionType "
                  + "                   ) "
                  + "    AND exists( "
                  + "                 select 1 "
                  + "                 from ddlcontrmp_dbt mp, dsfcontr_dbt sf_mp"
                  + "                 where mp.t_DlContrID = dlc.t_DlContrID "
                  + "                   AND sf_mp.t_ID = mp.t_SfContrID "
                  + "                   AND sf_mp.t_ServKind = " + PTSK_STOCKDL
                  + "                   AND sf_mp.t_DateBegin <= rc.t_PaymentDate "
                  + "                   AND (sf_mp.t_DateClose >= rc.t_PaymentDate or sf_mp.t_DateClose = " + GetSQLDate(date(0,0,0)) + ") "
                  + "              ) "
                  + "    AND avr.t_ISIN = rc.t_IsinRegistrationNumber "
                  + "    AND FinInstr.t_FIID = avr.t_FIID ";

    cmd.AddParam(m_BeginDate);    //9
    cmd.AddParam(m_EndDate);      //10
    cmd.AddParam(m_CurrInvestor); //11
    cmd.AddParam(m_BeginDate);    //12
    cmd.AddParam(m_EndDate);      //13
    cmd.AddParam(m_BeginDate);    //14
    cmd.AddParam(m_EndDate);      //15

    if( (m_AvrFIID != null) AND (m_AvrFIID > 0 ) ) //задана бумага
      query = query + " and FinInstr.t_FIID = ? ";
      cmd.AddParam(m_AvrFIID);
    else
      if( (m_AvrKind != null) AND (m_AvrKind > 0 ) ) //задан вид бумаги
        query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
        cmd.AddParam(m_AvrKind);
      end;
    end;


    query = query + " UNION ALL "
                  + " SELECT 0 AS LinkID, "
                  + "        (select nvl(sum(T_Amount),0) "
                  + "           from dnptxts_dbt T " 
                  + "          where T.t_Type = " + NPTXTS_REST
                  + "            and T.t_Client = sf.t_PartyID " 
                  + "            and exists( "
                  + "                         select 1 "
                  + "                         from ddlcontrmp_dbt mp, dsfcontr_dbt sf_mp"
                  + "                         where mp.t_DlContrID = dlc.t_DlContrID "
                  + "                           and sf_mp.t_ID = mp.t_SfContrID "
                  + "                           and sf_mp.t_ServKind = " + PTSK_STOCKDL
                  + "                           and sf_mp.t_DateBegin <= rc.t_PaymentDate "
                  + "                           and (sf_mp.t_DateClose >= rc.t_PaymentDate or sf_mp.t_DateClose = " + GetSQLDate(date(0,0,0)) + ") "
                  + "                           and sf_mp.t_ID = T.t_Contract "
                  + "                      ) "
                  + "            and T.t_BuyID = lot.t_ID "
                  + "            and T.t_FIID = avr.t_FIID " 
                  + "            and T.t_BegDate <= rc.t_PaymentDate " 
                  + "            and (T.t_EndDate >= rc.t_PaymentDate or T.t_EndDate = TO_DATE('01-01-0001','DD-MM-YYYY') )"
                  + "        ) AS Qnty, "
                  + "    0 AS PrivQnty,  " 
                  + "    0 AS LnkType, "
                  + "    sf.t_PartyID, "
                  + "    "+GetSQLDate(date(0,0,0))+" as LnkDate, "
                  + "    0 as PLnkID, "
                  + "    "+GetSQLDate(date(0,0,0))+" as PLnkDate, "
                  + "    0 AS t_TaxGroup, FinInstr.t_FIID, "
                  + "    FinInstr.t_FI_Code AS AvrCode, FinInstr.t_Name AS AvrName, "
                  + "    FinInstr.t_FaceValueFI, FinInstr.t_AvoirKind, "
                  + "    FinInstr.t_DrawingDate, FinInstr.t_Issued, "
                  + "    FinInstr.t_SumPrecision,  0 AS SBOfficeKind,"

                  + "    rc.t_AgreementNumber as ContractS, "
                  + "    TO_CHAR(rc.t_CouponNumber) AS DealSaleCodeTS, "
                  + "    rc.t_PaymentDate AS DealSaleDate, "
                  + "    0 as SaleDocKind, "
                  + "    rc.t_PaymentDate AS SaleDate, "
                  + "    rc.t_PaymentDate AS SalePayDate, 0 AS Amount, "
                  + "    0 AS ValS, "
                  + "    0 AS SalePrice, "
                  + "    0 AS LegKindSale, "
                  + "    0 AS SPoint, "
                  + "    0 AS SPrincipal,    "
                  + "    0 AS VpS, "
                  + "    0 AS DealSaleID, "

                  + "    NVL((select sf.t_Number "
                  + "           from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
                  + "          where mp.t_SfContrID = lot.t_Contract and dlc.t_DlContrID = mp.t_DlContrID and sf.t_ID = dlc.t_SfContrID"
                  + "        ), CHR(1)) as ContractB, "
                  + "    DealBuy.t_DealID AS DealBuyID, "
                  + "    lot.t_DEALCODE AS DealBuyCodeTS, "
                  + "    DealBuy.t_DealDate AS DealBuyDate, "
                  + "    lot.t_BuyDate AS t_BuyDate, "      
                  + "    lot.t_Price AS BuyPrice, "
                  + "    lot.t_PriceFIID AS ValB, "
                  + "    LegB.t_Principal AS BPrincipal, "
                  + "    LegB.t_LegKind AS LegKindBuy, "
                  + "    LegB.t_Point As BPoint, "
                  + "    NULL AS BuyDate, "
                  + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(lot.t_Type) = 1 then lot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
                  + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then lot.t_BuyDate else buycdlrq.t_FactDate end) as PayBuyDate, "
                  + "    DealBuy.t_BofficeKind AS BBOfficeKind, "
                  + "    npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "
                  + "    (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end)  AS TaxGroupType, "  
                  + "    TO_CHAR (NPTO.IfMarket (FinInstr.t_FIID, rc.t_PaymentDate)) SIfMarket, " 
                  + "    '' AS BIfMarket, "
                  + "    0 AS SaleGroup, "
                  + "    0 SaleIsVirtual, "
                  + "    0 BuyIsVirtual, "
                  + "    CHR(0), "
                  + "    CHR(1), "
                  + "    TO_CHAR(rc.t_CouponNumber) as t_Number_Coupon, "
                  + "    sf.t_ID Contract, "
                  + "    TO_DATE('01.01.0001','DD.MM.YYYY') SaleDateOVVZ, "
                  + "    1 AS NominalAVROnS, "
                  + "    1 AS NominalAVROnB, "
                  + "    0 AS SCourseNominal, " 
                  + "    0 AS BCourseNominal, " 
                  + " COALESCE((SELECT MAX (T_OPERDATE) "
                  + "    FROM DNPTXOP_DBT txop "
                  + "   WHERE     txop.t_client = sf.t_PartyID "
                  + "         AND txop.t_dockind = " + DL_CALCNDFL
                  + "         AND txop.t_Recalc = CHR(0) "
                  + "         AND txop.T_STATUS = " + DL_TXOP_Close
                  + "         AND txop.T_OPERDATE BETWEEN ? /*16*/ AND ? /*17*/"
                  + "         AND NOT EXISTS "
                  + "                    (SELECT 1 "
                  + "                       FROM dobjatcor_dbt objatcor "
                  + "                      WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
                  + "                            AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
                  + "                            AND objatcor.T_GROUPID = 1 "
                  + "                            AND objatcor.T_ATTRID = 1) "
                  + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, "
                  + "    0 as IsSaleRepl, "
                  + "    0 as IsBuyRepl, "
                  + "    0 as IsSaleRepl_BuyBef01032024, "
                  + "    0 as IsBuyRepl_BuyBef01032024, "
                  + "    0 as IsRepayCoup, "
                  + "    1 as IsBuyCoup, "
                  + "    obj.t_Sum0 as NkdB_TS, "
                  + "    0 as AllNkdB_TS "
                  + "   FROM dsfcontr_dbt sf, ddlcontr_dbt dlc, dcdrecords_dbt rc, dnptxobj_dbt obj, ddl_tick_dbt DealBuy, ddl_leg_dbt LegB, dnptxlot_dbt lot, ddlrq_dbt buycdlrq, davoiriss_dbt avr, dfininstr_dbt FinInstr "
                  + "  WHERE sf.t_PartyID = ? /*18*/ "
                  + "    AND dlc.t_SfContrID = sf.t_ID "
                  + "    AND rc.t_AgreementNumber = sf.t_Number "
                  + "    AND (rc.t_IsIIS = " + IIF(m_CurrIIS, "CHR(88)", "CHR(0)") + IIF(m_CurrIIS, "", " or rc.t_IsIIS is NULL") + ")"
                  + IIF(m_Include_Tech != SET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical IS NULL) ", "") 
                  + "    AND rc.t_CorporateActionType = 'INTR' "
                  + "    AND rc.t_AccountNumber LIKE '306%' "
                  + "    AND LOWER(rc.t_OperationStatus) = 'активна' "
                  + "    AND (rc.t_IsGetTax <> 'X' or rc.t_IsGetTax IS NULL)"
                  + "    AND rc.t_PaymentDate BETWEEN ? /*19*/ and ? /*20*/ "
                  + "    AND rc.t_PaymentDate <= NVL((SELECT MAX (T_OPERDATE) "
                  + "                                   FROM DNPTXOP_DBT txop "
                  + "                                  WHERE     txop.t_client = sf.t_PartyID "
                  + "                                        AND txop.t_dockind = " + DL_CALCNDFL
                  + "                                        AND txop.T_STATUS = " + DL_TXOP_Close
                  + "                                        AND txop.T_OPERDATE BETWEEN ? /*21*/ AND ? /*22*/"
                  + "                                        AND (   1 = " + IIF(m_Include_Tech == SET_CHAR, "1", "0")
                  + "                                             OR NOT EXISTS (SELECT 1 "
                  + "                                                              FROM dobjatcor_dbt objatcor "
                  + "                                                             WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
                  + "                                                               AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
                  + "                                                               AND objatcor.T_GROUPID = 1 "
                  + "                                                               AND objatcor.T_ATTRID = 1 "
                  + "                                                           )"
                  + "                                            ) "
                  + "                                 ), "+GetSQLDate(date(0,0,0))+") "
                  + "    AND rc.t_ID IN (SELECT MAX(CD1.T_ID) "
                  + "                      FROM DCDRECORDS_DBT CD1 "
                  + "                     WHERE CD1.t_RecordPaymentID = rc.t_RecordPaymentID "
                  + "                   ) "
                  + "    AND exists( "
                  + "                 select 1 "
                  + "                 from ddlcontrmp_dbt mp, dsfcontr_dbt sf_mp "
                  + "                 where mp.t_DlContrID = dlc.t_DlContrID "
                  + "                   and sf_mp.t_ID = mp.t_SfContrID "
                  + "                   and sf_mp.t_ServKind = " + PTSK_STOCKDL
                  + "                   and sf_mp.t_DateBegin <= rc.t_PaymentDate "
                  + "                   and (sf_mp.t_DateClose >= rc.t_PaymentDate or sf_mp.t_DateClose = " + GetSQLDate(date(0,0,0)) + ") "
                  + "                   and sf_mp.t_ID = obj.t_Analitic6 "
                  + "              ) "
                  + "    AND avr.t_ISIN = rc.t_IsinRegistrationNumber "
                  + "    AND FinInstr.t_FIID = avr.t_FIID "
                  + "    AND obj.t_Client = sf.t_PartyID "
                  + "    AND obj.t_Kind = " + TXOBJ_NKDB_TS
                  + "    AND obj.t_AnaliticKind2 = " + TXOBJ_KIND2030
                  + "    AND obj.t_Analitic2 = rc.t_CouponNumber "
                  + "    AND obj.t_AnaliticKind3 = " + TXOBJ_KIND3010
                  + "    AND obj.t_Analitic3 = FinInstr.t_FIID "
                  + "    AND obj.t_AnaliticKind6 = " + TXOBJ_KIND6020
                  + "    AND DealBuy.t_DealID = obj.t_Analitic1 "
                  + "    AND LegB.t_DealID    = DealBuy.t_DealID " 
                  + "    AND LegB.t_LegKind   = (case when lot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
                  + "    AND LegB.t_LegID     = 0 "
                  + "    AND lot.t_DocKind = DealBuy.t_BOfficeKind "
                  + "    AND lot.t_DocID = DealBuy.t_DealID "
                  + "    AND buycdlrq.t_DocID(+) = lot.t_DocID "
                  + "    AND buycdlrq.t_DocKind(+) = lot.t_DocKind "
                  + "    AND buycdlrq.t_Type(+) = " + DLRQ_TYPE_PAYMENT
                  + "    AND buycdlrq.t_DealPart(+) = 1 ";

    cmd.AddParam(m_BeginDate);    //16
    cmd.AddParam(m_EndDate);      //17
    cmd.AddParam(m_CurrInvestor); //18
    cmd.AddParam(m_BeginDate);    //19
    cmd.AddParam(m_EndDate);      //20
    cmd.AddParam(m_BeginDate);    //21
    cmd.AddParam(m_EndDate);      //22

    if( (m_AvrFIID != null) AND (m_AvrFIID > 0 ) ) //задана бумага
      query = query + " and FinInstr.t_FIID = ? ";
      cmd.AddParam(m_AvrFIID);
    else
      if( (m_AvrKind != null) AND (m_AvrKind > 0 ) ) //задан вид бумаги
        query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
        cmd.AddParam(m_AvrKind);
      end;
    end;

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      query = "select q.* from ("+query+") q order by q.DealSaleDate ASC";

      m_Rs = cmd.Execute(query);

      InitProgress( cnt, m_CurrInvestorSheetName+". Реализация. Подготовка данных", m_CurrInvestorSheetName+". Реализация. Подготовка данных" );
      while(m_Rs.moveNext())
        this.ClearCacheOneRecord();

           //если дата покупки или дата продажи больше либо равна дате последнего технического расчёта, и фин. результат равен нулю, то пропускаем 
        if ( (m_Include_Tech == SET_CHAR) or 
             ( (date(m_Rs.t_LastNoTechCalc) > date(0,0,0)) and 
               (not (((this.DZS() >= SQL_ConvTypeDate(m_Rs.t_LastNoTechCalc)) or (this.DZB() >= SQL_ConvTypeDate(m_Rs.t_LastNoTechCalc))) and (this.TaxFRlink() == $0))) and
               //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
               (not( (this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and 
                     (date(m_Rs.LnkDate) != date(0,0,0)) and (date(m_Rs.LnkDate) > date(m_Rs.t_LastNoTechCalc)) 
                   )
               ) and
               (not (((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0)) and (date(m_Rs.DealSaleDate) >= SQL_ConvTypeDate(m_Rs.t_LastNoTechCalc))))
             )
           )

          var v_IsRET_PARTLY = IsRET_PARTLY( Int(m_RS.SaleGroup) );
          var v_IsRET_COUPON = IsRET_COUPON( Int(m_RS.SaleGroup) );

          WasPrinted = true;
          
          AddRealizLine( UNSET_CHAR,
                         this.SecCode(),                                                                                                       
                         this.SecName(),                                                                                                       
                         this.Qnty(),                                                                                                          
                         this.ContractS(),                                                                                                     
                         this.CodeS(),                                                                                                         
                         this.DZS():f,                                                                                                           
                         this.DPS():f,                                                                                                           
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.PrSrub()),       
                         this.AllSrub(),                                                                                                       
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DifS()),                                                              
                         this.ComBankS(),                                                                                                      
                         this.ComExcS(),                                                                                                       
                         IIF(v_IsRET_COUPON and(m_Rs.CouponNDFL != SET_CHAR), "", this.ComS()),                                                
                         this.ContractB(),                                                                                                     
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.CodeB()),                                                              
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DZB():f),                                                                
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.DPB():f),                                                                
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", ЧислоCЗаданнойТочностью(this.PrBrub(),m_RS.BPoint)),                        
                         IIF(v_IsRET_COUPON, "", this.AllBrub()),                                                                              
                         IIF(v_IsRET_COUPON, "", this.MaterialB()),                                                                            
                         IIF(v_IsRET_COUPON, "", this.TaxMaterialB()),                                                                         
                         IIF(v_IsRET_COUPON, "", this.DifB()),                                                                                 
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComBankB()),                                                           
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComExcB()),                                                            
                         IIF(v_IsRET_COUPON or v_IsRET_PARTLY, "", this.ComB()),                                                               
                         this.TaxFRlink(),                                                                                                     
                         this.SecType(),                                                                                                       
                         this.TaxTags(),                                                                                                       
                         "",                                                                                                              
                         m_RS.SPoint,
                         m_RS.BPoint
                        );
  
          Sum_Qnty         = Sum_Qnty         + this.Qnty();
          Sum_AllSrub      = Sum_AllSrub      + this.AllSrub();
          Sum_DifS         = Sum_DifS         + this.DifS();
          Sum_ComBankS     = Sum_ComBankS     + this.ComBankS();
          Sum_ComExcS      = Sum_ComExcS      + this.ComExcS();
          Sum_ComS         = Sum_ComS         + this.ComS();
          Sum_AllBrub      = Sum_AllBrub      + this.AllBrub();
          Sum_MaterialB    = Sum_MaterialB    + this.MaterialB();
          Sum_TaxMaterialB = Sum_TaxMaterialB + this.TaxMaterialB();
          Sum_DifB         = Sum_DifB         + this.DifB();
          Sum_ComBankB     = Sum_ComBankB     + this.ComBankB();
          Sum_ComExcB      = Sum_ComExcB      + this.ComExcB();
          Sum_ComB         = Sum_ComB         + this.ComB();
          Sum_TaxFRlink    = Sum_TaxFRlink    + this.TaxFRlink();
        end;
        
        UseProgress(i = i + 1);
        
      end;
      
      RemProgress();
      
      if(WasPrinted)
        AddRealizLine( SET_CHAR,
                       "",      
                       "",      
                       Sum_Qnty,         
                       "",    
                       "",        
                       "",          
                       "",          
                       "", 
                       Sum_AllSrub,      
                       Sum_DifS,    
                       Sum_ComBankS,     
                       Sum_ComExcS,      
                       Sum_ComS,         
                       "",    
                       "",        
                       "",          
                       "",          
                       "",       
                       Sum_AllBrub,      
                       Sum_MaterialB,    
                       Sum_TaxMaterialB, 
                       Sum_DifB,         
                       Sum_ComBankB,     
                       Sum_ComExcB,      
                       Sum_ComB,         
                       Sum_TaxFRlink,    
                       "",      
                       "",      
                       "",      
                       0,
                       0
                      );
        
      end;
      
    end;

    SQL_Execute("DELETE FROM DNPTXOP1OPLNK_TMP", "", false );

    return WasPrinted;
  END;

  MACRO GetFormulaSumFR(DataCount)
    return F("S" + string(12 + DataCount));
  END;

  MACRO CerateInvestDedRep()
    var query, DataSet, cmd;
    var cnt = 0, i = 0;
    var Sum_Qnty= $0;
    var Sum_AllSrub = $0;
    var Sum_ComS =  $0;
    var Sum_AllBrub = $0;
    var Sum_ComB = $0;
    var SumFR = $0;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddInvestLine(Itog,
                        SecCode:string,     
                        SecName:string,     
                        Qnty:string,        
                        ContractS:string,   
                        CodeS:string,       
                        DZS:string,         
                        DPS:string,         
                        PrSrub:string,      
                        AllSrub:string,     
                        ComS:string,        
                        ContractB:string,   
                        CodeB:string,       
                        DZB:string,         
                        DPB:string,         
                        PrBrub:string,      
                        AllBrub:string,     
                        ComB:string,        
                        Plusi:string,       
                        FR_Sec_3Y:string,   
                        TaxTagsYears:string
                       )
      var query, ins;
      
      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_INVEST_DBT (  T_GUID "       
                                              + " , T_ITOG "       
                                              + " , T_SORT "       
                                              + " , T_SECCODE "    
                                              + " , T_SECNAME "    
                                              + " , T_QNTY "       
                                              + " , T_CONTRACTS "  
                                              + " , T_CODES "      
                                              + " , T_DZS "        
                                              + " , T_DPS "        
                                              + " , T_PRSRUB "     
                                              + " , T_ALLSRUB "    
                                              + " , T_COMS "       
                                              + " , T_CONTRACTB "  
                                              + " , T_CODEB "      
                                              + " , T_DZB "        
                                              + " , T_DPB "        
                                              + " , T_PRBRUB "     
                                              + " , T_ALLBRUB "    
                                              + " , T_COMB "       
                                              + " , T_PLUSI "      
                                              + " , T_FR_SEC_3Y "  
                                              + " , T_TAXTAGSYEARS "
                                              + ") "
                     + " VALUES(?,"+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")+",?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?) ";

       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(SecCode);    
       ins.AddParam(SecName);    
       ins.AddParam(Qnty);       
       ins.AddParam(ContractS);  
       ins.AddParam(CodeS);      
       ins.AddParam(DZS);        
       ins.AddParam(DPS);        
       ins.AddParam(PrSrub);     
       ins.AddParam(AllSrub);    
       ins.AddParam(ComS);       
       ins.AddParam(ContractB);  
       ins.AddParam(CodeB);      
       ins.AddParam(DZB);        
       ins.AddParam(DPB);        
       ins.AddParam(PrBrub);     
       ins.AddParam(AllBrub);    
       ins.AddParam(ComB);       
       ins.AddParam(Plusi);      
       ins.AddParam(FR_Sec_3Y);  
       ins.AddParam(TaxTagsYears);
       
       ins.ExecuteCMD();
    END;


    cmd = DL_RSDCommand();

    query  =  " select lnk.t_ID as LinkID, "
            + "        lnk.t_Amount as Qnty, "
            + "        lnk.t_PrivAmount as PrivQnty, "
            + "        lnk.t_Type AS LnkType, "
            + "        lnk.t_Client as t_PartyID, "
            + "        lnk.t_Date as LnkDate, "
            + "        av.t_TaxGroup, "
            + "        FinInstr.t_FIID, "
            + "        FinInstr.t_FI_Code as AvrCode, "
            + "        FinInstr.t_Name as AvrName, "
            + "        FinInstr.t_FaceValueFI, " 
            + "        FinInstr.t_AvoirKind, "
            + "        FinInstr.t_DrawingDate, "
            + "        FinInstr.t_Issued, "
            + "        FinInstr.t_SumPrecision, "
            + "        DealSale.t_BOfficeKind  AS SBOfficeKind, "
 
            + "        salelot.t_DEALCODE AS DealSaleCodeTS, "
            + "        salelot.t_DEALDATE AS DealSaleDate, "
            + "        salelot.t_DocKind as SaleDocKind, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then salelot.t_DealDate else salelot.t_SALEDATE end) AS SaleDate, "
            + "        (case when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then LegS.t_Maturity when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then salelot.t_DealDate else salecdlrq.t_FactDate end) AS SalePayDate, "
            + "        (case when salebdlrq.t_FactDate = "+GetSQLDate(date(0,0,0))+" then salebdlrq.t_Amount else lnk.t_Amount end) as t_Amount, "
            + "        salelot.t_PriceFIID AS ValS, "
            + "        salelot.t_Price AS SalePrice, "
            + "        LegS.t_LegKind AS LegKindSale, "
            + "        LegS.t_Principal AS SPrincipal, "
            + "        LegS.t_Point As SPoint, "

            + "        (case when DealSale.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_PriceFIID else salecdlrq.t_FIID end) as VpS, "
            + "        DealSale.t_DealID as DealSaleID, " 

            + "        DealBuy.t_DealID as DealBuyID, "
            + "        buylot.t_DEALCODE AS DealBuyCodeTS, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_BuyDate else buylot.t_DealDate end) as DealBuyDate, "
            + "        buylot.t_BuyDate, "
            + "        buylot.t_Price as BuyPrice, "
            + "        buylot.t_PriceFIID as ValB, "
            + "        LegB.t_Principal AS BPrincipal, "
            + "        LegB.t_LegKind AS LegKindBuy, "
            + "        LegB.t_Point As BPoint, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_RETIREMENT+" then buylot.t_DealDate else buylot.t_BuyDate end) AS BuyDate, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" or NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_PriceFIID else buycdlrq.t_FIID end) as VpB, "
            + "        (case when DealBuy.t_BOfficeKind = "+DL_AVRWRT+" then buylot.t_BuyDate else buycdlrq.t_FactDate end) as PayBuyDate, "
            + "        DealBuy.t_BOfficeKind AS BBOfficeKind, "

            + "        npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) as TaxGroupNPTX, "

            + "        (case when npto.GetPaperTaxGroupNPTX(FinInstr.t_FIID) in (30, 40, 50) then "+BOND_FAVOUR+" else "+BOND_UNDEF+" end) as TaxGroupType, "          

            + "        to_char(NPTO.IfMarket(FinInstr.t_FIID,salelot.t_DEALDATE)) SIfMarket, "
            
            + "        to_char(DECODE(buylot.t_DEALCODETS,chr(1),chr(1),NPTO.IfMarket(FinInstr.t_FIID,buylot.t_DEALDATE))) BIfMarket, "
            + "        rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(DealSale.t_DealType, DealSale.t_BofficeKind)) as SaleGroup, "
            + "        NPTX.IsVirtual(salelot.t_Type) SaleIsVirtual, "
            + "        NPTX.IsVirtual(buylot.t_Type) BuyIsVirtual, "
            + "        DealSale.t_CouponNDFL, "
            + "        DealSale.t_Number_Partly, "
            + "        DealSale.t_Number_Coupon, "
            + "        buylot.t_Contract Contract, "
            + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(FinInstr.t_FIID, salelot.t_DEALDATE ), 0.0) NominalAVROnS, "
            + "        extract(year from saleddlrq.t_FactDate) as t_DeliveryYearSale, "
            + "        (CASE  WHEN DealBuy.t_BOfficeKind = 127 THEN EXTRACT (YEAR FROM buylot.t_BuyDate)  ELSE EXTRACT (YEAR FROM buyddlrq.t_FactDate) END) AS t_DeliveryYearBuy, "  
            + "        trunc(MONTHS_BETWEEN (saleddlrq.t_FactDate, (CASE  WHEN DealBuy.t_BOfficeKind = 127 THEN buylot.t_BuyDate ELSE buyddlrq.t_FactDate END) ) / 12) AS TaxTagsYears, "
            + "        0 as IsSaleRepl, "
            + "        0 as IsBuyRepl, "
            + "        0 as IsSaleRepl_BuyBef01032024, "
            + "        0 as IsBuyRepl_BuyBef01032024, "
            + "        0 as IsRepayCoup, "
            + "        0 as IsBuyCoup, "
            + "        0 as NkdB_TS, "
            + "        0 as AllNkdB_TS, "
            + "        COALESCE((SELECT MAX (T_OPERDATE) "
            + "           FROM DNPTXOP_DBT txop "
            + "          WHERE     txop.t_client = lnk.t_Client "
            + "                AND txop.t_dockind = " + DL_CALCNDFL
            + "                AND txop.t_Recalc = CHR(0) "
            + "                AND txop.T_STATUS = " + DL_TXOP_Close
            + "                AND txop.T_OPERDATE BETWEEN ? /*1*/ AND ? /*2*/"
            + "                AND NOT EXISTS "
            + "                           (SELECT 1 "
            + "                              FROM dobjatcor_dbt objatcor "
            + "                             WHERE objatcor.t_Object = LPAD (txop.t_id, 34, 0) "
            + "                                   AND objatcor.t_objecttype = " + OBJTYPE_NPTXCALC
            + "                                   AND objatcor.T_GROUPID = 1 "
            + "                                   AND objatcor.T_ATTRID = 1) "
            + "             ), "+GetSQLDate(date(0,0,0))+") AS t_LastNoTechCalc, "
            + "       NVL((SELECT sf.t_Number "
            + "              FROM ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
            + "             WHERE mp.t_SfContrID = buylot.t_Contract "
            + "               AND dlc.t_DlContrID = mp.t_DlContrID "
            + "               AND sf.t_ID = dlc.t_SfContrID "
            + "           ), CHR(1)) as ContractB, "
            + "       NVL((SELECT sf.t_Number "
            + "              FROM ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
            + "             WHERE mp.t_SfContrID = salelot.t_Contract "
            + "               AND dlc.t_DlContrID = mp.t_DlContrID "
            + "               AND sf.t_ID = dlc.t_SfContrID "
            + "           ), CHR(1)) as ContractS "

            + "   from dnptxlnk_dbt  lnk, "
            + "        dnptxlot_dbt  buylot, "
            + "        dnptxlot_dbt  salelot, "
            + "        DDL_TICK_DBT  DealSale," 
            + "        DDL_TICK_DBT  DealBuy," 
            + "        DFININSTR_DBT FinInstr, "  
            + "        DAVOIRISS_DBT av, " 
            + "        ddl_leg_dbt   LegS, "  
            + "        ddl_leg_dbt   LegB, " 
            + "        ddlrq_dbt   salebdlrq, "
            + "        ddlrq_dbt   salecdlrq, "// оплата продажи
            + "        ddlrq_dbt   buycdlrq, " // оплата покупки
            + "        ddlrq_dbt   saleddlrq, "
            + "        ddlrq_dbt   buyddlrq, "

            + "        dnptxlot_dbt buylot_real, "
            + "        dnptxlot_dbt salelot_real "
            
            + "  where lnk.t_Type = " + NPTXLNK_DELIVER  
            + "    and salelot_real.t_ID = (case when NPTX.IsVirtual(salelot.t_Type) = 1 then salelot.t_RealID else salelot.t_ID end ) " 
            + "    and buylot_real.t_ID = (case when NPTX.IsVirtual(buylot.t_Type) = 1 then buylot.t_RealID else buylot.t_ID end ) "    
            + "    and lnk.t_date BETWEEN ? /*3*/ AND ? /*4*/ "
            + "    and lnk.t_Client = ? /*5*/ " 
            + "    and salelot.t_Origin NOT IN ( " + string( NPTXLOTORIGIN_GO ) + "," + string ( NPTXLOTORIGIN_IN) +" ) "  
            + "    and salelot.t_ID = lnk.t_SaleID "
            + "    and buylot.t_ID = lnk.t_BuyID "
            + "    and salelot_real.t_DocID = DealSale.t_DealID " 
            + "    and buylot_real.t_DocID  = DealBuy.t_DealID "
            + "    and FinInstr.t_FIID = lnk.t_FIID " 
            + "    and av.t_FIID = lnk.t_FIID " 
            + "    and LegS.t_DealID    = DealSale.t_DealID " 
            + "    and LegS.t_LegKind   = (case when salelot.t_Kind = "+NPTXLOTS_BACKREPO+" then 2 else 0 end) " 
            + "    and LegS.t_LegID     = 0 " 
            + "    and LegB.t_DealID    = DealBuy.t_DealID " 
            + "    and LegB.t_LegKind   = (case when buylot.t_Kind = "+NPTXLOTS_REPO+" then 2 else 0 end) " 
            + "    and LegB.t_LegID     = 0 "
            + "    and salebdlrq.t_ID = salelot_real.t_RQID "
            + "    and salecdlrq.t_DocID(+) = salelot_real.t_DocID "
            + "    and salecdlrq.t_DocKind(+) = salelot_real.t_DocKind "
            + "    and salecdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and salecdlrq.t_Factdate <= ? /*6*/ " 
            + "    and salecdlrq.t_DealPart(+) =  1 " 
            + "    and RSI_NPTO.CheckContrIIS(buylot.t_Contract) = " + string(m_CurrIIS)
            + IIF(m_ContractIDsStr != "", " and buylot.t_Contract IN ("+m_ContractIDsStr+") ", "")
            + "    and 1 = ( case when DealSale.t_BOfficeKind <> "+DL_RETIREMENT+" and DealSale.t_BOfficeKind <> "+DL_AVRWRT+" and (salebdlrq.t_FactDate <= ? /*7*/) then 1"
            + "                   when DealSale.t_BOfficeKind = "+DL_RETIREMENT+" then 1 "
            + "                   when DealSale.t_BOfficeKind = "+DL_AVRWRT+" then 1 "
            + "                   else 0 end)"
            + "    and buycdlrq.t_DocID(+) = buylot_real.t_DocID "
            + "    and buycdlrq.t_DocKind(+) = buylot_real.t_DocKind "
            + "    and buycdlrq.t_Type(+) in (" + DLRQ_TYPE_PAYMENT + ") "
            + "    and buycdlrq.t_DealPart(+) = 1 "
            + "    and saleddlrq.t_DocID = salelot_real.t_DocID"
            + "    and saleddlrq.t_DocKind = salelot_real.t_DocKind"
            + "    and saleddlrq.t_Type = " + DLRQ_TYPE_DELIVERY
            + "    and buyddlrq.t_DealPart(+) = 1"
            + "    and buyddlrq.t_DocID = buylot_real.t_DocID"
            + "    and buyddlrq.t_DocKind = buylot_real.t_DocKind"
            + "    and buyddlrq.t_Type = " + DLRQ_TYPE_DELIVERY
            + "    and buyddlrq.t_DealPart(+) = 1"
            + "    and exists("
            + "                 select 1"
            + "                 from dnptxobj_dbt nptxobj"
            + "                 where nptxobj.t_AnaliticKind2 = " + TXOBJ_KIND2010
            + "                   and nptxobj.t_Analitic2 = lnk.t_ID"
            + "                   and nptxobj.t_Kind = " + TXOBJ_FR_SEC_3Y
            + IIF(m_Include_Tech != SET_CHAR, " and (nptxobj.t_Technical = CHR(0) or nptxobj.t_Technical IS NULL) ", "")
            + "              )";

    cmd.AddParam(m_BeginDate);      /*1*/
    cmd.AddParam(m_EndDate);        /*2*/
    cmd.AddParam(m_BeginDate);      /*3*/
    cmd.AddParam(m_EndDate);        /*4*/
    cmd.AddParam(m_CurrInvestor);   /*5*/
    cmd.AddParam(m_EndDate);        /*6*/
    cmd.AddParam(m_EndDate);        /*7*/
    
    
    if( (m_AvrFIID != null) AND (m_AvrFIID > 0 ) ) /*задана бумага*/
       query = query + " and lnk.t_FIID = ? ";
       cmd.AddParam(m_AvrFIID);
    else
       if( (m_AvrKind != null) AND (m_AvrKind > 0 ) ) /*задан вид бумаги*/
         query = query + " and RSB_FIInstr.FI_AvrKindsEQ(2, ?, FinInstr.t_AvoirKind) = 1 ";
         cmd.AddParam(m_AvrKind);
       end;
    end;

    cnt = cmd.GetCount(query);

    if(cnt > 0)

      query = "select q.* from ("+query+") q order by q.DealSaleDate ASC";

      m_Rs = cmd.Execute(query);

      InitProgress( cnt, m_CurrInvestorSheetName+". Инв. вычет. Подготовка данных", m_CurrInvestorSheetName+". Инв. вычет. Подготовка данных" );
      while(m_Rs.moveNext())
          
        this.ClearCacheOneRecord();

        if ( //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
             (m_Include_Tech == SET_CHAR) or ((date(m_Rs.t_LastNoTechCalc) > date(0,0,0)) and not((this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and ((date(m_Rs.LnkDate) > date(m_Rs.t_LastNoTechCalc))) ))
           )
        
          if(WasPrinted == false)
            SaveTotalCalcField("Index_618",     this.Index_618());
            SaveTotalCalcField("Limit_618",     this.Limit_618(CALCTYPE_SEC));
            SaveTotalCalcField("SumMinusG_618", this.MinusG_618(CALCTYPE_SEC) + this.MinusG_618(CALCTYPE_DEPO));
          end;

          WasPrinted = true;
          
          AddInvestLine( UNSET_CHAR,
                         this.SecCode(),     
                         this.SecName(),     
                         this.Qnty(),        
                         this.ContractS(),   
                         this.CodeS(),       
                         this.DZS(),         
                         this.DPS(),         
                         this.PrSrub(),      
                         this.AllSrub(),     
                         this.ComS(),        
                         this.ContractB(),   
                         this.CodeB(),       
                         this.DZB(),         
                         this.DPB(),         
                         this.PrBrub(),      
                         this.AllBrub(),     
                         this.ComB(),        
                         this.Plusi(),       
                         this.FR_Sec_3Y(),   
                         m_Rs.TaxTagsYears  
                       ); 

          Sum_Qnty         = Sum_Qnty         + this.Qnty();
          Sum_AllSrub      = Sum_AllSrub      + this.AllSrub();
          Sum_ComS         = Sum_ComS         + this.ComS();
          Sum_AllBrub      = Sum_AllBrub      + this.AllBrub();
          Sum_ComB         = Sum_ComB         + this.ComB();
          SumFR            = SumFR            + this.FR_Sec_3Y();
        end;

        UseProgress(i = i + 1);

      end;

      RemProgress();
      
      if(WasPrinted)
        SaveTotalCalcField("SumFR", SumFR);

        AddInvestLine( SET_CHAR,
                       "",     
                       "",     
                       Sum_Qnty,        
                       "",   
                       "",       
                       "",         
                       "",         
                       "",      
                       Sum_AllSrub,     
                       Sum_ComS,        
                       "",   
                       "",       
                       "",         
                       "",         
                       "",      
                       Sum_AllBrub,     
                       Sum_ComB,        
                       "",       
                       SumFR,   
                       ""  
                     );
      end;
    end;

    return WasPrinted;
  END;

  //Общая информация
  PRIVATE MACRO CreateTotalCalc()

    //m_TaxFR_total    = null;
    m_TaxFR_OTC      = null;
    m_TaxFR_market   = null;
    m_TaxFR_Open     = null;
    m_BaseMaterial   = null;
    m_BaseSpecial    = null;
    m_BaseSpecialDiv = null;
    m_BG             = null;
    m_TaxRateGeneral = null;
    m_ComDepo        = null;                                    
    m_CoupRubS       = null;
    m_PG             = null;
    m_TaxDueNow      = null; 
    m_OtherIncome    = null;
    m_BaseBill       = null;
    m_Limit_618      = null;
    m_BP             = null;
    m_PP             = null;
    m_BaseG5         = null;
    m_BaseG_2_3_9       = TArray;
    m_BaseG_2_3_9_DEPO  = TArray;
    m_TaxDueNow_15   = null;
    m_CoupRub_DEPO   = null;
    m_TaxFR_OTC_DEPO    = null;
    m_TaxFR_market_DEPO = null;
    m_BaseG5_DEPO       = null;
    m_ComDepo_DEPO      = null;
    m_CoupRubS_DEPO     = null;
    m_BG_DEPO           = null;
    m_BP_DEPO           = null;
    m_TaxBase_618       = null;
    m_TaxBase_618_DEPO  = null;
    m_Minus_618         = null;
    m_Minus_618_DEPO    = null;
    m_Limit_618_DEPO    = null;
    m_TaxBase_13        = null;
    m_TaxBase_13_DEPO   = null;
    m_TaxBase_15        = null;
    m_TaxBase_15_DEPO   = null;
    m_PG_DEPO           = null;
    m_PGd               = null;
    m_PGd_DEPO          = null;
    m_PP_DEPO           = null;
    m_PPd               = null;
    m_PPd_DEPO          = null;
    m_TaxDueNow_sum     = null;
    m_TaxDueNow_15_sum  = null;

    m_TaxFR_market_ONB  = null;
    m_TaxFR_OTC_ONB     = null;
    m_ComDepo_ONB       = null;
    m_Minus_618_ONB     = null;
    m_Minus_619         = null;
    m_Minus_619_DEPO    = null;
    m_Minus_619_ONB     = null;
    m_Minus_517         = null;
    m_Minus_517_DEPO    = null;
    m_Minus_517_ONB     = null;
    m_TaxBase_13_ONB    = null;
    m_TaxBase_15_ONB    = null;
    m_TaxBase_18_ONB    = null;
    m_TaxBase_20_ONB    = null;
    m_TaxBase_22_ONB    = null;

    m_TaxPaid           = null;
    m_TaxPaid_DEPO      = null;
    m_TaxPaid_ONB       = null;
    m_TaxPaid_15        = null;
    m_TaxPaid_15_DEPO   = null;
    m_TaxPaid_15_ONB    = null;
    m_TaxPaid_18_ONB    = null;
    m_TaxPaid_20_ONB    = null;
    m_TaxPaid_22_ONB    = null;

    m_TaxFR_OTC         = null;
    m_TaxFR_OTC_DEPO    = null;
    m_TaxFR_OTC_ONB     = null;

    НОБ_ДЕПО            = null;
    НОБ_ДЕПО_КБК1       = null;
    НОБ_ДЕПО_КБК2       = null;
    НОБ_ДЕПО_КБК3       = null;
    Налог_ДЕПО_КБК1     = null;
    Налог_ДЕПО_КБК2     = null;
    Налог_ДЕПО_КБК3     = null;
    НОБ_СОФР            = null;
    НОБ15_СОФР          = null;
    Налог_СОФР          = null;
    Налог15_СОФР        = null;
    Налог_КБК1          = null;
    Налог_КБК2          = null;
    Налог_КБК3          = null;

    m_DlastNOB          = null;
    m_PreliminaryCalc   = null;       

    m_Dsys = NULL;

    MACRO _F(str)
      return F(FormulaROUND() +"(" + str + "; 0)");
    END;
    
    
    SaveTotalCalcField("Dbeg",            date(m_BeginDate));      // за период с
    SaveTotalCalcField("Dend",            this.RepDend());         // по
    SaveTotalCalcField("Dsys",            this.Dsys());            // Дата формирования отчета
    SaveTotalCalcField("Client",          this.ClientName());      // Клиент
    SaveTotalCalcField("ClientStatus",    this.ClientStatus());    // Статус клиента
    SaveTotalCalcField("ReportType",      this.ReportTypeName());  // Тип отчета
    SaveTotalCalcField("DlastNOB",        this.DlastNOB():f);      // Дата последнего расчета НОБ 
    SaveTotalCalcField("PreliminaryCalc", this.PreliminaryCalc()); // текст "Прогнозное значение" или пусто
    
    var AmountSNOB = this.SNOB();
    SaveTotalCalcField("SNOBType",    "Сумма совокупной налогооблагаемой базы (СНОБ) (до 01.01.2025) на "+string(this.RepDend():f));
    SaveTotalCalcField("SNOBAmount",   AmountSNOB);            // СНОБ
    

    var AmountSNOB1 = this.SNOB1();
    SaveTotalCalcField("SNOBType1",    "Сумма совокупной налогооблагаемой базы (СНОБ 1)* (с 01.01.2025) на "+string(this.RepDend():f));
    SaveTotalCalcField("SNOBAmount1",  AmountSNOB1);            // СНОБ1

    var AmountSNOB2 = this.SNOB2();
    SaveTotalCalcField("SNOBType2",    "Сумма совокупной налогооблагаемой базы (СНОБ 2)** (с 01.01.2025) на "+string(this.RepDend():f));
    SaveTotalCalcField("SNOBAmount2",  AmountSNOB2);            // СНОБ2

    /*                    БО ЦБ и ПИ                           \/                        ДЕПО                                    \/                         ОНБ                               \/       Сумма                      */
    SaveTotalCalcField("TaxFR_Total",    this.TaxFR_Total(CALCTYPE_SEC));
    SaveTotalCalcField("TaxFR_market",   this.TaxFR_market(CALCTYPE_SEC));          
    SaveTotalCalcField("TaxFR_OTC",      this.TaxFR_OTC(CALCTYPE_SEC));             
    SaveTotalCalcField("TaxFR_Lost",     this.TaxFR_Lost(CALCTYPE_SEC));            
    SaveTotalCalcField("ComDepo",        this.ComDepo(CALCTYPE_SEC));               
    SaveTotalCalcField("CoupRub",        this.CoupRub(CALCTYPE_SEC));        SaveTotalCalcField("DepoCoupRub",        this.CoupRub(CALCTYPE_DEPO));            
    SaveTotalCalcField("TaxFR_Open",     this.TaxFR_Open());
    SaveTotalCalcField("RepoFactRub",    this.RepoFactRub());
    SaveTotalCalcField("RepoTaxRub",     this.RepoTaxRub());
    SaveTotalCalcField("RepoTaxRach",    this.RepoTaxRach());
    SaveTotalCalcField("DerivTaxRub",    this.DerivTaxRub());
    SaveTotalCalcField("BaseMaterial",   this.BaseMaterial()); 
                                                                                                                                                           SaveTotalCalcField("BaseBill",          this.BaseBill());
                                                                                                                                                           SaveTotalCalcField("OtherIncome",       this.OtherIncome());
    SaveTotalCalcField("TaxBase_618",    this.TaxBase_618(CALCTYPE_SEC));    SaveTotalCalcField("DepoTaxBase_618",    this.TaxBase_618(CALCTYPE_DEPO));
    SaveTotalCalcField("MinusG_618",     this.MinusG_618(CALCTYPE_SEC));     SaveTotalCalcField("DepoMinusG_618",     this.MinusG_618(CALCTYPE_DEPO));
    SaveTotalCalcField("MinusG_619",     this.MinusG_619(CALCTYPE_SEC));
    SaveTotalCalcField("MinusG_517",     this.MinusG_517(CALCTYPE_SEC));
    
    SaveTotalCalcField("TaxBaseAll",     this.TaxBaseAll(CALCTYPE_SEC));     SaveTotalCalcField("DepoTaxBaseAll",     this.TaxBaseAll(CALCTYPE_DEPO));     SaveTotalCalcField("OnbTaxBaseAll",     this.TaxBaseAll(CALCTYPE_ONB));
    SaveTotalCalcField("TaxBase_13",     this.TaxBase_13(CALCTYPE_SEC));     SaveTotalCalcField("DepoTaxBase_13",     this.TaxBase_13(CALCTYPE_DEPO));     SaveTotalCalcField("OnbTaxBase_13",     this.TaxBase_13(CALCTYPE_ONB));
    SaveTotalCalcField("TaxBase_15",     this.TaxBase_15(CALCTYPE_SEC));     SaveTotalCalcField("DepoTaxBase_15",     this.TaxBase_15(CALCTYPE_DEPO));     SaveTotalCalcField("OnbTaxBase_15",     this.TaxBase_15(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxBase_18",     this.TaxBase_18(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxBase_20",     this.TaxBase_20(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxBase_22",     this.TaxBase_22(CALCTYPE_ONB));

    SaveTotalCalcField("TaxDueYear",     this.TaxDueYear(CALCTYPE_SEC));     SaveTotalCalcField("DepoTaxDueYear",     this.TaxDueYear(CALCTYPE_DEPO));     SaveTotalCalcField("OnbTaxDueYear",     this.TaxDueYear(CALCTYPE_ONB));
    SaveTotalCalcField("TaxDueYear_13",  this.TaxDueYear_13(CALCTYPE_SEC));  SaveTotalCalcField("DepoTaxDueYear_13",  this.TaxDueYear_13(CALCTYPE_DEPO));  SaveTotalCalcField("OnbTaxDueYear_13",  this.TaxDueYear_13(CALCTYPE_ONB));
    SaveTotalCalcField("TaxDueYear_15",  this.TaxDueYear_15(CALCTYPE_SEC));  SaveTotalCalcField("DepoTaxDueYear_15",  this.TaxDueYear_15(CALCTYPE_DEPO));  SaveTotalCalcField("OnbTaxDueYear_15",  this.TaxDueYear_15(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxDueYear_18",  this.TaxDueYear_18(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxDueYear_20",  this.TaxDueYear_20(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxDueYear_22",  this.TaxDueYear_22(CALCTYPE_ONB));


    SaveTotalCalcField("TaxPaid_all",    this.TaxPaid_All(CALCTYPE_SEC));    SaveTotalCalcField("DepoTaxPaid_all",    this.TaxPaid_All(CALCTYPE_DEPO));    SaveTotalCalcField("OnbTaxPaid_all",    this.TaxPaid_All(CALCTYPE_ONB));
    SaveTotalCalcField("TaxPaid",        this.TaxPaid(CALCTYPE_SEC));        SaveTotalCalcField("DepoTaxPaid",        this.TaxPaid(CALCTYPE_DEPO));        SaveTotalCalcField("OnbTaxPaid",        this.TaxPaid(CALCTYPE_ONB));
    SaveTotalCalcField("TaxPaid_15",     this.TaxPaid_15(CALCTYPE_SEC));     SaveTotalCalcField("DepoTaxPaid_15",     this.TaxPaid_15(CALCTYPE_DEPO));     SaveTotalCalcField("OnbTaxPaid_15",     this.TaxPaid_15(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxPaid_18",     this.TaxPaid_18(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxPaid_20",     this.TaxPaid_20(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxPaid_22",     this.TaxPaid_22(CALCTYPE_ONB));


    SaveTotalCalcField("TaxDueNow1_all", this.TaxDueNow1_All(CALCTYPE_SEC)); SaveTotalCalcField("DepoTaxDueNow1_all", this.TaxDueNow1_All(CALCTYPE_DEPO)); SaveTotalCalcField("OnbTaxDueNow1_all", this.TaxDueNow1_All(CALCTYPE_ONB));
    SaveTotalCalcField("TaxDueNow1",     this.TaxDueNow1(CALCTYPE_SEC));     SaveTotalCalcField("DepoTaxDueNow1",     this.TaxDueNow1(CALCTYPE_DEPO));     SaveTotalCalcField("OnbTaxDueNow1",     this.TaxDueNow1(CALCTYPE_ONB));                                                           
    SaveTotalCalcField("TaxDueNow1_15",  this.TaxDueNow1_15(CALCTYPE_SEC));  SaveTotalCalcField("DepoTaxDueNow1_15",  this.TaxDueNow1_15(CALCTYPE_DEPO));  SaveTotalCalcField("OnbTaxDueNow1_15",  this.TaxDueNow1_15(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxDueNow1_18",  this.TaxDueNow1_18(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxDueNow1_20",  this.TaxDueNow1_20(CALCTYPE_ONB));
                                                                                                                                                           SaveTotalCalcField("OnbTaxDueNow1_22",  this.TaxDueNow1_22(CALCTYPE_ONB));
  
    
  END;
  

  PRIVATE MACRO CreateReportNPTXLucre()
    var cmd = NULL;
    var count = 0;

    var SumQnty     = 0.0;
    var SumMainBvp  = 0.0;
    var SumMainBrub = 0.0;
    var SumComB     = 0.0;
    var MaxSumPrecision = 0;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddLucreLine(Itog,
                       SecCode:string,   
                       SecName:string,   
                       VN:string,        
                       ContractB:string, 
                       CodeB:string,     
                       DZB:string,       
                       DDB:string,       
                       DPB:string,       
                       Qnty:string,      
                       PrBvp:string,     
                       ValB:string,      
                       VpB:string,       
                       CrBD:string,      
                       KZB:string,       
                       MainBvp:string,   
                       MainBrub:string,  
                       bMrktB:string,    
                       PriceMrktB:string,
                       MrktB:string,     
                       DMrktB:string,    
                       ComB:string,      
                       NomB:string,      
                       ContB:string,     
                       SecType:string,   
                       TaxRate:string,   
                       SumPrecision
                      )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_LUCRE_DBT (  T_GUID "       
                                             + " , T_ITOG "       
                                             + " , T_SORT "       
                                             + " , T_SECCODE "    
                                             + " , T_SECNAME "    
                                             + " , T_VN "         
                                             + " , T_CONTRACTB "  
                                             + " , T_CODEB "      
                                             + " , T_DZB "        
                                             + " , T_DDB "        
                                             + " , T_DPB "        
                                             + " , T_QNTY "       
                                             + " , T_PRBVP "      
                                             + " , T_VALB "       
                                             + " , T_VPB "        
                                             + " , T_CRBD "       
                                             + " , T_KZB "        
                                             + " , T_MAINBVP "    
                                             + " , T_MAINBRUB "   
                                             + " , T_BMRKTB "     
                                             + " , T_PRICEMRKTB " 
                                             + " , T_MRKTB "      
                                             + " , T_DMRKTB "     
                                             + " , T_COMB "       
                                             + " , T_NOMB "       
                                             + " , T_CONTB "      
                                             + " , T_SECTYPE "    
                                             + " , T_TAXRATE "    
                                             + " , T_SUMPRECISION "
                                             + ") "
                     + " VALUES(? "
                           + ", "+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ", ? "
                           + ") ";
                                  
       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(SecCode);     
       ins.AddParam(SecName);     
       ins.AddParam(VN);          
       ins.AddParam(ContractB);   
       ins.AddParam(CodeB);       
       ins.AddParam(DZB);         
       ins.AddParam(DDB);         
       ins.AddParam(DPB);         
       ins.AddParam(Qnty);        
       ins.AddParam(PrBvp);       
       ins.AddParam(ValB);        
       ins.AddParam(VpB);         
       ins.AddParam(CrBD);        
       ins.AddParam(KZB);         
       ins.AddParam(MainBvp);     
       ins.AddParam(MainBrub);    
       ins.AddParam(bMrktB);      
       ins.AddParam(PriceMrktB);  
       ins.AddParam(MrktB);       
       ins.AddParam(DMrktB);      
       ins.AddParam(ComB);        
       ins.AddParam(NomB);        
       ins.AddParam(ContB);       
       ins.AddParam(SecType);     
       ins.AddParam(TaxRate);     
       ins.AddParam(SumPrecision);
       
       ins.ExecuteCMD();
    END;

    if (m_CurrIIS == 0) //Для обычных ДБО (неИИС), лист формируется по данным всех договоров (ИИС + неИИС)
      cmd = CollectDataForNPTXLucreQuery(true, true, m_BeginDate, m_EndDate, m_AvrFIID, m_AvrKind, -1, m_CurrInvestor, NULL, @count, m_ContractIDsStr, true);
    else
      cmd = CollectDataForNPTXLucreQuery(true, true, m_BeginDate, m_EndDate, m_AvrFIID, m_AvrKind, -1, m_CurrInvestor, m_CurrIIS, @count, m_ContractIDsStr, true);
    end;
    
    m_RS = cmd.Execute();
    var i = 0;

    if(count > 0)

      InitProgress(count, m_CurrInvestorSheetName+". МатВыгода. Подготовка данных");

      while(m_RS.MoveNext())
        if ( (m_CurrIIS == 0) or ((m_CurrIIS == 1) and (m_ContractNumber != "") and (m_ContractNumber == this.ContractB())) ) //Если ИИС и задан Номер договора, то формируем только для него

          this.ClearCacheOneRecord();

          if ( //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
             (m_Include_Tech == SET_CHAR) or ((date(m_Rs.t_LastNoTechCalc) > date(0,0,0)) and not((this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and (date(m_RS.MaxPayRqFactDate) > date(m_RS.t_LastNoTechCalc)) ))
           )

            WasPrinted = true;

            if(m_RS.TypeBO != 0)
              FD = DVFirstDocNDeal( DL_DVNDEAL, m_Rs.DealBuyID );   
            end;
           
            AddLucreLine(UNSET_CHAR,
                         this.SecCode(),       
                         this.SecName(),       
                         this.VN(),            
                         this.ContractB(),     
                         this.CodeB(),         
                         this.DZB(),           
                         IIF((this.DDB() == date(0, 0, 0)) or (this.DDB() > this.RepDend()), "", this.DDB()),           
                         this.DPB(),           
                         this.Qnty(true),      
                         this.PrBvp(),         
                         this.ValBNumber(),    
                         this.VpBNumber(),     
                         this.CrBD(true),      
                         this.KZB(),           
                         this.MainBvp(true),   
                         this.MainBrub(true),  
                         this.bMrktB(),        
                         this.PriceMrktB(),    
                         this.MrktB(true),     
                         this.DMrktB(true),    
                         this.ComB(true),      
                         this.NomB(),          
                         this.ContB(),         
                         this.SecType(true),   
                         this.TaxRate(),       
                         this.QntyPrecision()
                        ); 

            SumQnty = SumQnty + this.Qnty(true);
            SumMainBvp = SumMainBvp + this.MainBvp(true);
            SumMainBrub = SumMainBrub + this.MainBrub(true);
            SumComB = SumComB + this.ComB(true);

            if(MaxSumPrecision < this.QntyPrecision())
              MaxSumPrecision = this.QntyPrecision();
            end;
          end;
          UseProgress(i = i + 1);
        end;
      end;

       RemProgress();

       if(WasPrinted)
         
         AddLucreLine(SET_CHAR,
                      "",           
                      "",           
                      "",           
                      "",           
                      "",           
                      "",           
                      "",           
                      "",           
                      SumQnty,      
                      "",           
                      "",           
                      "",           
                      "",           
                      "",           
                      SumMainBvp,   
                      SumMainBrub,  
                      "",           
                      "",           
                      "",           
                      "",           
                      SumComB,      
                      "",           
                      "",           
                      "",           
                      "",           
                      MaxSumPrecision
                     ); 

       end;
    end;

    return WasPrinted;
  END;

  // Биржевые производные инструменты
  MACRO CreateReportPFIExchange()
    var i = 0;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddPFIExchangeLine(Itog,
                             Client:string,     
                             ClientStatus:string,
                             SecCode:string,    
                             FICode:string,     
                             FIName:string,     
                             FIType:string,     
                             BaseType:string,   
                             BaseCode:string,   
                             BaseName:string,   
                             TradePlace:string, 
                             ContractS:string,  
                             Dpos:string,       
                             Qbuy:string,       
                             Qsell:string,      
                             Qlong:string,      
                             Material:string,   
                             VarPos:string,     
                             VarNeg:string,     
                             PremPos:string,    
                             PremNeg:string,    
                             Com:string,        
                             FR:string,         
                             bMarket:string,    
                             TaxRate:string    
                            )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_PFIEXCHANGE_DBT (  T_GUID "       
                                                   + " , T_ITOG "       
                                                   + " , T_SORT "       
                                                   + " , T_CLIENT "     
                                                   + " , T_CLIENTSTATUS "
                                                   + " , T_SECCODE "    
                                                   + " , T_FICODE "     
                                                   + " , T_FINAME "     
                                                   + " , T_FITYPE "     
                                                   + " , T_BASETYPE "   
                                                   + " , T_BASECODE "   
                                                   + " , T_BASENAME "   
                                                   + " , T_TRADEPLACE " 
                                                   + " , T_CONTRACTS "  
                                                   + " , T_DPOS "       
                                                   + " , T_QBUY "       
                                                   + " , T_QSELL "      
                                                   + " , T_QLONG "      
                                                   + " , T_MATERIAL "   
                                                   + " , T_VARPOS "     
                                                   + " , T_VARNEG "     
                                                   + " , T_PREMPOS "    
                                                   + " , T_PREMNEG "    
                                                   + " , T_COM "        
                                                   + " , T_FR "         
                                                   + " , T_BMARKET "    
                                                   + " , T_TAXRATE "    
                                                   + ") "
                           + " VALUES(? "
                                 + ", "+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ") ";
                                  
       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(Client);      
       ins.AddParam(ClientStatus);
       ins.AddParam(SecCode);     
       ins.AddParam(FICode);      
       ins.AddParam(FIName);      
       ins.AddParam(FIType);      
       ins.AddParam(BaseType);    
       ins.AddParam(BaseCode);    
       ins.AddParam(BaseName);    
       ins.AddParam(TradePlace);  
       ins.AddParam(ContractS);   
       ins.AddParam(Dpos);        
       ins.AddParam(Qbuy);        
       ins.AddParam(Qsell);       
       ins.AddParam(Qlong);       
       ins.AddParam(Material);    
       ins.AddParam(VarPos);      
       ins.AddParam(VarNeg);      
       ins.AddParam(PremPos);     
       ins.AddParam(PremNeg);     
       ins.AddParam(Com);         
       ins.AddParam(FR);          
       ins.AddParam(bMarket);     
       ins.AddParam(TaxRate);      
       
       ins.ExecuteCMD();
    END;


    var RepData = SP_DvTaxInc_Exchange_Data( m_CurrInvestor,
                                             m_BeginDate,
                                             m_EndDate
                                           );

    if(RepData.GetDataForRep() > 0)

      InitProgress( RepData.Nrec(), m_CurrInvestorSheetName+". ПИ бирж. Подготовка данных", m_CurrInvestorSheetName+". ПИ бирж. Подготовка данных" );

      while(RepData.moveNext())
        if ( //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
             (m_Include_Tech == SET_CHAR) or 
             ((date(RepData.LastNoTechCalc()) > date(0,0,0)) and not((this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and ((date(RepData.Dpos()) > date(RepData.LastNoTechCalc()))) ))
           )

          var Material = RepData.Material();
        
          WasPrinted = true;
          
          AddPFIExchangeLine( UNSET_CHAR,
                              RepData.Client(),       
                              RepData.ClientStatus(), 
                              RepData.SecCode(),      
                              RepData.FICode(),       
                              RepData.FIName(),       
                              RepData.FIType(),       
                              RepData.BaseType(),     
                              RepData.BaseCode(),     
                              RepData.BaseName(),     
                              RepData.TradePlace(),   
                              RepData.ContractS(),    
                              RepData.Dpos(),         
                              RepData.Qbuy(),         
                              RepData.Qsell(),        
                              RepData.Qlong(),        
                              IIF(Material == "", $0, Material),     
                              RepData.VarPos(),       
                              RepData.VarNeg(),       
                              RepData.PremPos(),      
                              RepData.PremNeg(),      
                              RepData.Com(),          
                              RepData.FR(),           
                              RepData.bMarket(),      
                              RepData.TaxRate()      
                            ); 
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();
      
    end;

    return WasPrinted;
  END;

  // Внебиржевые производные инструменты
  MACRO CreateReportPFIOutExchange()
    var i = 0, needprint = false, isPrintHead = false, isRegTable = false;
    var SheetName = "ПИ_внебирж.";
    var CurrSheetName = m_CurrInvestorSheetName + "_" + SheetName;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddPFIOutExchangeLine(Itog,
                                Client:string,           
                                ClientStatus:string,     
                                ContractS:string,        
                                DealDate:string,         
                                ContractN:string,        
                                ContractType:string,     
                                Direction:string,        
                                Contract:string,         
                                BaseType:string,         
                                FIType:string,           
                                ExpirationDate:string,   
                                Q:string,                
                                Contragent:string,       
                                ExpirationPriceCur:string,
                                PriceCurrency:string,    
                                MarketPrice:string,      
                                Material:string,         
                                VarPos:string,           
                                VarNeg:string,           
                                PremPos:string,          
                                PremNeg:string,          
                                Com:string,              
                                FR:string               
                               )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_PFIOUTEXCHANGE_DBT (  T_GUID "       
                                                      + " , T_ITOG "       
                                                      + " , T_SORT "       
                                                      + " , T_CLIENT "           
                                                      + " , T_CLIENTSTATUS "     
                                                      + " , T_CONTRACTS "        
                                                      + " , T_DEALDATE "         
                                                      + " , T_CONTRACTN "        
                                                      + " , T_CONTRACTTYPE "     
                                                      + " , T_DIRECTION "        
                                                      + " , T_CONTRACT "          
                                                      + " , T_BASETYPE "         
                                                      + " , T_FITYPE "           
                                                      + " , T_EXPIRATIONDATE "   
                                                      + " , T_Q "                
                                                      + " , T_CONTRAGENT "       
                                                      + " , T_EXPIRATIONPRICECUR "
                                                      + " , T_PRICECURRENCY "    
                                                      + " , T_MARKETPRICE "      
                                                      + " , T_MATERIAL "         
                                                      + " , T_VARPOS "           
                                                      + " , T_VARNEG "           
                                                      + " , T_PREMPOS "          
                                                      + " , T_PREMNEG "          
                                                      + " , T_COM "              
                                                      + " , T_FR "               
                                                      + ") "
                           + " VALUES(? "
                                 + ", "+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ") ";
                                  
       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(Client);            
       ins.AddParam(ClientStatus);      
       ins.AddParam(ContractS);         
       ins.AddParam(DealDate);          
       ins.AddParam(ContractN);         
       ins.AddParam(ContractType);      
       ins.AddParam(Direction);         
       ins.AddParam(Contract);          
       ins.AddParam(BaseType);          
       ins.AddParam(FIType);            
       ins.AddParam(ExpirationDate);    
       ins.AddParam(Q);                 
       ins.AddParam(Contragent);        
       ins.AddParam(ExpirationPriceCur);
       ins.AddParam(PriceCurrency);     
       ins.AddParam(MarketPrice);       
       ins.AddParam(Material);          
       ins.AddParam(VarPos);            
       ins.AddParam(VarNeg);            
       ins.AddParam(PremPos);           
       ins.AddParam(PremNeg);           
       ins.AddParam(Com);               
       ins.AddParam(FR);                 
       
       ins.ExecuteCMD();
    END;


    var RepData = SP_DvTaxInc_OutExchange_Data( m_CurrInvestor,
                                                m_BeginDate,
                                                m_EndDate
                                              );
    if(RepData.GetDataForRep() > 0)

      InitProgress( RepData.Nrec(), m_CurrInvestorSheetName+". ПИ внебирж. Подготовка данных", m_CurrInvestorSheetName+". ПИ внебирж. Подготовка данных" );

      while(RepData.moveNext(@needprint))
        if(needprint)
          
            if ( //Если тип операции "Вывод д/с", то дата связи или дата операции (для ПФИ) или максимальная из фактических дат оплаты ТО не должна превышать последнюю операцию расчета НОБ без признака "Технический"
               (m_Include_Tech == SET_CHAR) or 
               ((date(RepData.LastNoTechCalc()) > date(0,0,0)) and not((this.ReportType == DL_TXHOLD_OPTYPE_OUTMONEY) and ((date(RepData.DealDate()) > date(RepData.LastNoTechCalc()))) ))
             )

            var Material = RepData.Material();

            WasPrinted = true;
            
            AddPFIOutExchangeLine( UNSET_CHAR,
                                   RepData.Client(),             
                                   RepData.ClientStatus(),       
                                   RepData.ContractS(),          
                                   RepData.DealDate(),           
                                   RepData.ContractN(),          
                                   RepData.ContractType(),       
                                   RepData.Direction(),          
                                   RepData.Contract(),           
                                   RepData.BaseType(),           
                                   RepData.FIType(),             
                                   RepData.ExpirationDate(),     
                                   RepData.Q(),                  
                                   RepData.Contragent(),         
                                   RepData.ExpirationPriceCur(), 
                                   RepData.PriceCurrency(),      
                                   RepData.MarketPrice(),        
                                   IIF(Material == "", $0, Material),           
                                   RepData.VarPos(),             
                                   RepData.VarNeg(),             
                                   RepData.PremPos(),            
                                   RepData.PremNeg(),            
                                   RepData.Com(),                
                                   RepData.FR()                 
                                 );  
          end;
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();

    end;

    return WasPrinted;
  END;

  PRIVATE MACRO CreateReportBill()
    var query, cmd = NULL;
    var count = 0;
    var Cost = $0, CostFI = -1, Repayment = $0, Interest = $0, Discount = $0;
    var M = $0;
    var WasPrinted = false;
    var SumCost          = $0;
    var SumRepayment     = $0;
    var SumInterest      = $0;
    var SumDiscount      = $0;
    var SumTaxBaseAmount = $0;
    var RecSort = 0;

    MACRO AddBillLine(Itog,
                      DocNumber:string,
                      DOper:string,  
                      NBill:string,  
                      Cost:string,   
                      Repayment:string,
                      Interest:string,
                      Discount:string,
                      SumNOB:string 
                     )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_BILL_DBT (  T_GUID "       
                                            + " , T_ITOG "       
                                            + " , T_SORT "       
                                            + " , T_DOCNUMBER "
                                            + " , T_DOPER "   
                                            + " , T_NBILL "   
                                            + " , T_COST "    
                                            + " , T_REPAYMENT "
                                            + " , T_INTEREST "
                                            + " , T_DISCOUNT "
                                            + " , T_SUMNOB "  
                                            + ") "
                           + " VALUES(? "
                                 + ", "+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ") ";
                                  
       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(DocNumber);
       ins.AddParam(DOper);    
       ins.AddParam(NBill);    
       ins.AddParam(Cost);     
       ins.AddParam(Repayment);
       ins.AddParam(Interest); 
       ins.AddParam(Discount); 
       ins.AddParam(SumNOB);    
       
       ins.ExecuteCMD();
    END;


    
    cmd = DL_RSDCommand();
             
    query =   " select ord.t_OrderNumber, ord.t_SignDate, bnr.t_BCID, bnr.t_BCSeries, bnr.t_BCNumber, lnk.t_BCCost, lnk.t_BCCFI, "
            + "        leg.t_Principal, leg.t_ReceiptAmount, leg.t_CFI, lnk.t_TaxBaseAmount, "
            + "        (CASE WHEN leg.t_Formula IN ( " + VS_IN_DISCONT + "," + VS_IN_DISC_PC + " ) THEN 1 "
            + "              ELSE 0 END) AS IsDiscount, "
            + "        (CASE WHEN leg.t_Formula IN ( " + VS_IN_S_PC + "," + VS_IN_M_PC + "," + VS_IN_DISC_PC + " ) AND leg.t_Price > 0 THEN 1 "
            + "              ELSE 0 END) IsPercent "
            + "   from dvsordlnk_dbt lnk, ddl_order_dbt ord, dvsbanner_dbt bnr, ddl_leg_dbt leg "
            + "  where ord.t_Contractor = " + cmd.AddParam(m_CurrInvestor) 
            + "    and ord.t_SignDate between "+cmd.AddParam(m_BeginDate)+" and " + cmd.AddParam(m_EndDate)
            + "    and ord.t_DocKind = " + DL_VEKSELDRAWORDER
            + "    and ord.t_ContractStatus > 0 "
            + "    and lnk.t_ContractID = ord.t_ContractID "
            + "    and bnr.t_BCID = lnk.t_BCID "
            + "    and leg.t_DealID = bnr.t_BCID "
            + "    and leg.t_LegKind = " + LEG_KIND_VSBANNER
            + "    and leg.t_LegID = 0 "
            + " order by ord.t_SignDate ASC, lnk.t_BCID ASC ";
    
    
    var i = 0;
    count = cmd.GetCount(query);
    if(count > 0)

       InitProgress(count, m_CurrInvestorSheetName+". Векселя. Подготовка данных", m_CurrInvestorSheetName+". Векселя. Подготовка данных");

       var DataSet = cmd.Execute(query);

       while(DataSet.MoveNext())

          this.ClearCacheOneRecord();

          WasPrinted = true;

          DL_VS_GetLastBnrSalePrice(DataSet.BCID, date(DataSet.SignDate), @Cost, @CostFI);
          if(CostFI != NATCUR)
            SmartConvertSum(Cost, Cost, date(DataSet.SignDate), CostFI, NATCUR, true);
          end;

          Repayment = money(DataSet.BCCost);
          if(DataSet.BCCFI != NATCUR)
            SmartConvertSum(Repayment, Repayment, date(DataSet.SignDate), DataSet.BCCFI, NATCUR, true);
          end;

          Interest = $0;
          if(DataSet.IsPercent)
            if(DataSet.BCCost > DataSet.t_Principal )
              Interest = DataSet.BCCost - DataSet.Principal;
            end;

            if((Interest > 0) and (DataSet.CFI != NATCUR))
              SmartConvertSum(Interest, Interest, date(DataSet.SignDate), DataSet.CFI, NATCUR, true)
            end;
          end;

          Discount = $0;
          if(DataSet.IsDiscount)
            M = $0;
            if( DataSet.BCCost < DataSet.Principal )
              M = DataSet.BCCost;
            else
              M = DataSet.Principal;
            end;
            if(DataSet.ReceiptAmount < M)
              Discount = M - DataSet.ReceiptAmount;
            end;
            if((Discount > 0) and (DataSet.CFI != NATCUR))
              SmartConvertSum(Discount, Discount, date(DataSet.SignDate), DataSet.CFI, NATCUR, true)
            end;
          end;
        
          AddBillLine(UNSET_CHAR,
                      DataSet.OrderNumber,                   
                      date(DataSet.SignDate),                
                      DataSet.BCSeries+" "+DataSet.BCNumber, 
                      Cost,                                  
                      Repayment,                             
                      Interest,                              
                      Discount,                              
                      DataSet.TaxBaseAmount                 
                     );  

          SumCost          = SumCost          + Cost;
          SumRepayment     = SumRepayment     + Repayment;
          SumInterest      = SumInterest      + Interest;
          SumDiscount      = SumDiscount      + Discount;
          SumTaxBaseAmount = SumTaxBaseAmount + DataSet.TaxBaseAmount;
          
          UseProgress(i = i + 1);
       end;
       
       RemProgress();

       if(WasPrinted)
         AddBillLine(SET_CHAR,
                     "",    
                     "",             
                     "",             
                     SumCost,          
                     SumRepayment,     
                     SumInterest,      
                     SumDiscount,      
                     SumTaxBaseAmount 
                    );
       end;
    end;

    return WasPrinted;
  END;

  PRIVATE MACRO CreateProtocol()
    var query, cmd = NULL;
    var count = 0;
    var WasPrinted = false;
    var RecSort = 0;

    MACRO AddProtocolLine(Itog,
                          IncomeNDR:string,
                          IncomeCode:string,
                          IncomeName:string,
                          IncomeSum:string,
                          ExpenseNDR:string,
                          ExpenseCode:string,
                          ExpenseName:string,
                          ExpenseSum:string
                         )
      var query, ins;

      RecSort = RecSort + 1;
      
      query = "INSERT INTO DNPTXSHORT_PROTOCOL_DBT (  T_GUID "       
                                                + " , T_ITOG "       
                                                + " , T_SORT "       
                                                + " , T_INCOMENDR " 
                                                + " , T_INCOMECODE "
                                                + " , T_INCOMENAME "
                                                + " , T_INCOMESUM " 
                                                + " , T_EXPENSENDR "
                                                + " , T_EXPENSECODE "
                                                + " , T_EXPENSENAME "
                                                + " , T_EXPENSESUM "
                                                + ") "
                           + " VALUES(? "
                                 + ", "+IIF(Itog == SET_CHAR, "CHR(88)", "CHR(0)")
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ", ? "
                                 + ") ";
                                  
       ins = DL_RSDCommand(query);

       ins.AddParam(m_GUID);
       ins.AddParam(RecSort);
       ins.AddParam(IncomeNDR);  
       ins.AddParam(IncomeCode); 
       ins.AddParam(IncomeName); 
       ins.AddParam(IncomeSum); 
       ins.AddParam(ExpenseNDR); 
       ins.AddParam(ExpenseCode);
       ins.AddParam(ExpenseName);
       ins.AddParam(ExpenseSum);   
       
       ins.ExecuteCMD();
    END;
    
    cmd = DL_RSDCommand();
             
    query =   " with k as (select * from dnptxkind_dbt where t_Level in (5,6) and (t_Code like 'PlusG%' or t_Code like 'MinusG%') and t_Code not like '%1011_1%' and t_Code not like '%1011_2%' and t_Code not like '%1011_3%') "
            + " select q.*, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_IN+" then q.t_Code else CHR(1) end) as IncomeNDR, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_IN+" then (case when q.t_Code like 'PlusG%' then substr(q.t_Code, 7, 4) else substr(q.t_Code, 8, 3) end) else CHR(1) end) as IncomeCode, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_IN+" then q.t_Name else CHR(1) end) as IncomeName, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_IN+" then q.SumObjSum0 else 0 end) as IncomeSum, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_OUT+" then q.t_Code else CHR(1) end) as ExpenseNDR, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_OUT+" then (case when q.t_Code like 'PlusG%' then substr(q.t_Code, 7, 4) else substr(q.t_Code, 8, 3) end) else CHR(1) end) as ExpenseCode, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_OUT+" then q.t_Name else CHR(1) end) as ExpenseName, "
            + "        (case when q.t_Direction = "+TXOBJ_DIR_OUT+" then q.SumObjSum0 else 0 end) as ExpenseSum "
            + "   from (select obj.t_Kind, obj.t_Direction, k.t_Code, k.t_Name, SUM(obj.t_Sum0) as SumObjSum0 "
            + "           from k, dnptxobj_dbt obj "
            + "          where obj.t_Client = " + cmd.AddParam(m_CurrInvestor)
            + "            and obj.t_Kind = k.t_Element "
            + "            and obj.t_Date between "+cmd.AddParam(m_BeginDate)+" and " + cmd.AddParam(m_EndDate) 
            + IIF(m_Include_Tech != SET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical is null)", "");

    if(m_ByIIS)
      if(m_ContractIDsStr != "")
        query = query + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020
                      + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
      end;
    else
      query = query + " and rsi_npto.CheckContrIIS(obj.t_Analitic6) = 0 ";
    end;

    query = query + " group by obj.t_Kind, k.t_Code, k.t_Name, obj.t_Direction "
                  + " ) q "
                  + " order by q.t_Kind ASC";
    
    
    var i = 0;
    count = cmd.GetCount(query);
    if(count > 0)

       InitProgress(count, m_CurrInvestorSheetName+". Протокол. Подготовка данных");

       var DataSet = cmd.Execute(query);

       while(DataSet.MoveNext())

          this.ClearCacheOneRecord();

          WasPrinted = true;
          
          AddProtocolLine(UNSET_CHAR,
                          DataSet.IncomeNDR,    
                          DataSet.IncomeCode,   
                          DataSet.IncomeName,   
                          DataSet.IncomeSum,    
                          DataSet.ExpenseNDR,   
                          DataSet.ExpenseCode,  
                          DataSet.ExpenseName,  
                          DataSet.ExpenseSum   
                         ); 
          
          UseProgress(i = i + 1);
       end;
       
       RemProgress();

    end;

    return WasPrinted;
  END;


  MACRO TaxRate()
     if(m_TaxRate == NULL)
       m_TaxRate = DL_GetClientTaxRateGeneral(m_Rs.Investor, m_EndDate) * 100.0;
     end;
     return string(m_TaxRate, "%");
  END;

  MACRO ClientName()
    return m_CurrInvestorName + IIF(m_CurrIIS == 1, " ИИС", "") + IIF(m_ContractNumber != "", " "+m_ContractNumber, "");
  END; 

  MACRO ClientFIO()
    return m_InvestorFIO;
  END;

  MACRO ContrNumber()
    return m_ContractNumber;
  END;

  MACRO ClientStatus():string
     var v_ClientStatus = CL_STATE_RES;

     if(STB_IsResidentStatusRSI(m_CurrInvestor, m_EndDate) == 0)
       v_ClientStatus = CL_STATE_NOTRES;
     end;

     return v_ClientStatus;
  END;

  MACRO ReportType():integer
    return m_ReportType;
  END;

  MACRO ReportTypeName():string
    return DL_GetNameAlg( 7332, this.ReportType() );
  END;

  MACRO Dsys()
    if(m_Dsys == NULL)
      var SystDate, SystTime;

      GetSystDateTime(@SystDate, @SystTime);

      m_Dsys = SystDate;
    end;

    return m_Dsys;
  END;

  MACRO DlastNOB():DATE
    var query, cmd, DataSet;
    
    if(m_DlastNOB == NULL)
      m_DlastNOB = date(0,0,0);
      m_PreliminaryCalc = "";

      cmd = DL_RSDCommand();

      query =   " select op.t_OperDate, RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(op.t_ID, 34, '0'), 1, op.t_OperDate) as IsTech "
              + "   from dnptxop_dbt op "
              + "  where op.t_DocKind = " + DL_CALCNDFL
              + "    and op.t_Client = ? "
              + "    and op.t_OperDate between ? and ? "
              + "    and op.t_Recalc = CHR(0) "
              + "    and op.t_Status = " + DL_TXOP_Close;

      cmd.AddParam(m_CurrInvestor);
      cmd.AddParam(m_BeginDate);
      cmd.AddParam(m_EndDate);

      if(m_Include_Tech != SET_CHAR)
        query = query + " and RSB_SECUR.GetMainObjAttr(132 /*OBJTYPE_NPTXCALC*/, LPAD(op.t_ID, 34, '0'), 1, op.t_OperDate) <> 1 ";
      end;

      if((m_By_IIS == true) and (m_By_NotIIS == false))
        query = query + " and op.t_IIS = 'X' ";
      elif((m_By_IIS == false) and (m_By_NotIIS == true))
        query = query + " and op.t_IIS <> 'X' ";
      end;

      query = query + " order by op.t_OperDate DESC ";

      DataSet = cmd.Execute(query);
      if(DataSet.moveNext())
        m_DlastNOB = date(DataSet.OperDate);
        if(DataSet.IsTech == 1)
          m_PreliminaryCalc = "Прогнозное значение";
        end;
      end;
    end;
    
    return m_DlastNOB;
  END;

  MACRO PreliminaryCalc():STRING
    if(m_PreliminaryCalc == NULL)
      DlastNOB();
    end;

    return m_PreliminaryCalc;
  END;

  PRIVATE MACRO GetSumTechObj(Level:integer, TaxBaseKindStr:string, KindStr:string):money
    var query, cmd, DataSet;
    var SumTechObj = $0;

    if(KindStr == NULL)
      KindStr = "";
    end;

    query =   "with k as (select t_Element from dnptxkind_dbt where t_Level = ? and t_TaxBaseKind IN ("+TaxBaseKindStr+") "+IIF(KindStr != "", " and t_Element IN ("+KindStr+")", "")+")"
            + " select NVL(SUM(obj.t_Sum0), 0) as ObjSum "
            + "   from k, dnptxobj_dbt obj "
            + "  where obj.t_Client = ? "
            + "    and obj.t_Kind = k.t_Element "
            + "    and obj.t_Date between ? and ? "
            + "    and obj.t_Technical = 'X' ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(Level);
    cmd.AddParam(m_CurrInvestor);
    cmd.AddParam(m_BeginDate);
    cmd.AddParam(m_EndDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      SumTechObj = money(DataSet.ObjSum);
    end;

    return SumTechObj;
  END;

  MACRO SNOB():money
    var AmountSNOB = NULL;
    var StartProgressScaleDate = GetStartProgressScaleDate();

    if((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ() == true) and (m_EndDate >= GetStartSTBDate()) and ((m_EndDate < StartProgressScaleDate) or (StartProgressScaleDate == date(0,0,0)) ))
      var llv = TRecHandler("llvalues.dbt");
      var Request = c_GetAmountSNOBRequest();
      var Year;

      AmountSNOB = $0;
      
      datesplit(m_EndDate, null, null, Year);

      Request.GetAmountSNOBReq = c_GetAmountSNOBReq();
      Request.GetAmountSNOBReq.IsActivRecord      = true;
      Request.GetAmountSNOBReq.IsSNOB             = false;
      Request.GetAmountSNOBReq.ClientId           = c_IntegrationSymbolicIdentifierXType();
      Request.GetAmountSNOBReq.ClientId.ObjectID  = m_CurrInvestor;
      Request.GetAmountSNOBReq.TaxYear            = Year;

      var Resp = GetAmountSNOBReq(Request);
      
      var isOk = true;
      var errorDesc;
      if((Resp == NULL) or (ValType(Resp) != V_GENOBJ) or (ValType(Resp.GetAmount) == V_UNDEF) or (ValType(Resp.GetAmount.RecordInfoList) == V_UNDEF) or
         ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (Resp.ErrorList[0] != NULL) and (string(trim(Resp.ErrorList[0].ErrorCode)) != "0")) or
         ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 1) and (Resp.ErrorList[1] != NULL) and (string(trim(Resp.ErrorList[1].ErrorCode)) != "0"))
        )
        isOk = false;
        if((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (Resp.ErrorList[0] != NULL) and (string(trim(Resp.ErrorList[0].ErrorCode)) != "0"))
          msgbox("Ошибка " + string(trim(Resp.ErrorList[0].ErrorCode)) + ": " + string(trim(Resp.ErrorList[0].ErrorDesc)));
          errorDesc = string(trim(Resp.ErrorList[0].ErrorDesc));
        end;

        if((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 1) and (Resp.ErrorList[1] != NULL) and (string(trim(Resp.ErrorList[1].ErrorCode)) != "0"))
          msgbox("Ошибка " + string(trim(Resp.ErrorList[1].ErrorCode)) + ": " + string(trim(Resp.ErrorList[1].ErrorDesc)));
          errorDesc = string(trim(Resp.ErrorList[1].ErrorDesc));
        end;

        
        if((errorDesc != V_UNDEF) AND (errorDesc != StrFor(1)))
          if(strlen(trim(errorDesc)) > 0)
            SaveErrorGenData(errorDesc);
          end;
        end;
      end;

      if(isOk)
        if(Resp.GetAmount.RecordInfoList.Size > 0)
          var i = 0;

          var prevIncDate = date(0,0,0), prevIncTime = time(0,0,0), prevRate = 0;
          while(i < Resp.GetAmount.RecordInfoList.Size)

            var IncDate = date(Resp.GetAmount.RecordInfoList[i].IncomeRegionDateTime);
            var IncTime = time(Resp.GetAmount.RecordInfoList[i].IncomeRegionDateTime);
            var Rate    = int(Resp.GetAmount.RecordInfoList[i].NdflKeepRate);

            if(IncDate <= m_EndDate)
              if((IncDate > prevIncDate) or ((IncDate == prevIncDate) and (IncTime > prevIncTime)) or ((IncDate == prevIncDate) and (IncTime == prevIncTime) and (Rate > prevRate)))
                AmountSNOB = Resp.GetAmount.RecordInfoList[i].SNOBPayAmount;

                prevIncDate = IncDate; 
                prevIncTime = IncTime; 
                prevRate    = Rate;
              end;
            end;

            i = i + 1;
          end;
        end;
      end;

      if(m_Include_Tech == SET_CHAR)
        AmountSNOB = AmountSNOB + GetSumTechObj(7, "1,2,3,4,5,6,7,8,9");
      end;
    end;

   if ((ValType(AmountSNOB) == V_UNDEF) or (AmountSNOB == NULL)) 
       AmountSNOB = $0; 
    end; 

    return AmountSNOB;
  END;

  MACRO SNOB1():money
    var AmountSNOB1 = NULL;
    var StartProgressScaleDate = GetStartProgressScaleDate();

    if((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ() == true) and (m_EndDate >= GetStartSTBDate()) and ((m_EndDate >= StartProgressScaleDate) and (StartProgressScaleDate != date(0,0,0)) ))
      var llv = TRecHandler("llvalues.dbt");
      var Request = c_GetAmountSNOBRequest();
      var Year;

      AmountSNOB1 = $0;
      
      datesplit(m_EndDate, null, null, Year);

      Request.GetAmountSNOBReq = c_GetAmountSNOBReq();
      Request.GetAmountSNOBReq.IsActivRecord      = true;
      Request.GetAmountSNOBReq.IsSNOB             = false;
      Request.GetAmountSNOBReq.ClientId           = c_IntegrationSymbolicIdentifierXType();
      Request.GetAmountSNOBReq.ClientId.ObjectID  = m_CurrInvestor;
      Request.GetAmountSNOBReq.TaxYear            = Year;

      var TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_ONB;
      
      if(LL_FindLLVALUES(OBJTYPE_STB_TAXBASEKIND, TaxBaseKind, llv) == true )
        Request.GetAmountSNOBReq.TaxBaseType = c_IntegrationDictionaryRecordXType();    // Вид налоговой базы по НДФЛ, к которой относится событие        Необязательное
        Request.GetAmountSNOBReq.TaxBaseType.RecordCode = llv.rec.Flag;
      end;

      var Resp = GetAmountSNOBReq(Request);
      
      var isOk = true;
      var errorDesc;
      if((Resp == NULL) or (ValType(Resp) != V_GENOBJ) or (ValType(Resp.GetAmount) == V_UNDEF) or (ValType(Resp.GetAmount.RecordInfoList) == V_UNDEF) or
         ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (Resp.ErrorList[0] != NULL) and (string(trim(Resp.ErrorList[0].ErrorCode)) != "0")) or
         ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 1) and (Resp.ErrorList[1] != NULL) and (string(trim(Resp.ErrorList[1].ErrorCode)) != "0"))
        )
        isOk = false;
        if((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (Resp.ErrorList[0] != NULL) and (string(trim(Resp.ErrorList[0].ErrorCode)) != "0"))
          msgbox("Ошибка " + string(trim(Resp.ErrorList[0].ErrorCode)) + ": " + string(trim(Resp.ErrorList[0].ErrorDesc)));
          errorDesc = string(trim(Resp.ErrorList[0].ErrorDesc));
        end;

        if((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 1) and (Resp.ErrorList[1] != NULL) and (string(trim(Resp.ErrorList[1].ErrorCode)) != "0"))
          msgbox("Ошибка " + string(trim(Resp.ErrorList[1].ErrorCode)) + ": " + string(trim(Resp.ErrorList[1].ErrorDesc)));
          errorDesc = string(trim(Resp.ErrorList[1].ErrorDesc));
        end; 

        if((errorDesc != V_UNDEF) AND (errorDesc != StrFor(1)))
          if(strlen(trim(errorDesc)) > 0)
            SaveErrorGenData(errorDesc);
          end;
        end;
      end;

      if(isOk)
        if(Resp.GetAmount.RecordInfoList.Size > 0)
          var i = 0;

          var prevIncDate = date(0,0,0), prevIncTime = time(0,0,0), prevRate = 0;
          while(i < Resp.GetAmount.RecordInfoList.Size)

            var IncDate = date(Resp.GetAmount.RecordInfoList[i].IncomeRegionDateTime);
            var IncTime = time(Resp.GetAmount.RecordInfoList[i].IncomeRegionDateTime);
            var Rate    = int(Resp.GetAmount.RecordInfoList[i].NdflKeepRate);

            if(IncDate <= m_EndDate)
              if((IncDate > prevIncDate) or ((IncDate == prevIncDate) and (IncTime > prevIncTime)) or ((IncDate == prevIncDate) and (IncTime == prevIncTime) and (Rate > prevRate)))
                AmountSNOB1 = Resp.GetAmount.RecordInfoList[i].SNOBPayAmount;

                prevIncDate = IncDate; 
                prevIncTime = IncTime; 
                prevRate    = Rate;
              end;
            end;

            i = i + 1;
          end;
        end;
      end;

      if(m_Include_Tech == SET_CHAR)
        AmountSNOB1 = AmountSNOB1 + GetSumTechObj(5, "9", string(TXOBJ_PLUSG_4800));
      end;
    end;

    if ((ValType(AmountSNOB1) == V_UNDEF) or (AmountSNOB1 == NULL)) 
       AmountSNOB1 = $0; 
    end;

    return AmountSNOB1;
  END;

  MACRO SNOB2():money
    var AmountSNOB2 = NULL;
    var StartProgressScaleDate = GetStartProgressScaleDate();

    if((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ() == true) and (m_EndDate >= GetStartSTBDate()) and ((m_EndDate >= StartProgressScaleDate) and (StartProgressScaleDate != date(0,0,0)) ))
      var llv = TRecHandler("llvalues.dbt");
      var Request = c_GetAmountSNOBRequest();
      var Year;

      AmountSNOB2 = $0;
      
      datesplit(m_EndDate, null, null, Year);

      Request.GetAmountSNOBReq = c_GetAmountSNOBReq();
      Request.GetAmountSNOBReq.IsActivRecord      = true;
      Request.GetAmountSNOBReq.IsSNOB             = false;
      Request.GetAmountSNOBReq.ClientId           = c_IntegrationSymbolicIdentifierXType();
      Request.GetAmountSNOBReq.ClientId.ObjectID  = m_CurrInvestor;
      Request.GetAmountSNOBReq.TaxYear            = Year;

      var TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_BROK;
      
      if(LL_FindLLVALUES(OBJTYPE_STB_TAXBASEKIND, TaxBaseKind, llv) == true )
        Request.GetAmountSNOBReq.TaxBaseType = c_IntegrationDictionaryRecordXType();    // Вид налоговой базы по НДФЛ, к которой относится событие        Необязательное
        Request.GetAmountSNOBReq.TaxBaseType.RecordCode = llv.rec.Flag;
      end;

      var Resp = GetAmountSNOBReq(Request);
      
      var isOk = true;
      var errorDesc;
      if((Resp == NULL) or (ValType(Resp) != V_GENOBJ) or (ValType(Resp.GetAmount) == V_UNDEF) or (ValType(Resp.GetAmount.RecordInfoList) == V_UNDEF) or
         ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (Resp.ErrorList[0] != NULL) and (string(trim(Resp.ErrorList[0].ErrorCode)) != "0")) or
         ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 1) and (Resp.ErrorList[1] != NULL) and (string(trim(Resp.ErrorList[1].ErrorCode)) != "0"))
        )
        isOk = false;
        if((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (Resp.ErrorList[0] != NULL) and (string(trim(Resp.ErrorList[0].ErrorCode)) != "0"))
          msgbox("Ошибка " + string(trim(Resp.ErrorList[0].ErrorCode)) + ": " + string(trim(Resp.ErrorList[0].ErrorDesc)));
          errorDesc = string(trim(Resp.ErrorList[0].ErrorDesc));
        end;

        if((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 1) and (Resp.ErrorList[1] != NULL) and (string(trim(Resp.ErrorList[1].ErrorCode)) != "0"))
          msgbox("Ошибка " + string(trim(Resp.ErrorList[1].ErrorCode)) + ": " + string(trim(Resp.ErrorList[1].ErrorDesc)));
          errorDesc = string(trim(Resp.ErrorList[1].ErrorDesc));
        end;

        if((errorDesc != V_UNDEF) AND (errorDesc != StrFor(1)))
          if(strlen(trim(errorDesc)) > 0)
            SaveErrorGenData(errorDesc);
          end;
        end;
      end;

      if(isOk)
        if(Resp.GetAmount.RecordInfoList.Size > 0)
          var i = 0;

          var prevIncDate = date(0,0,0), prevIncTime = time(0,0,0), prevRate = 0;
          while(i < Resp.GetAmount.RecordInfoList.Size)

            var IncDate = date(Resp.GetAmount.RecordInfoList[i].IncomeRegionDateTime);
            var IncTime = time(Resp.GetAmount.RecordInfoList[i].IncomeRegionDateTime);
            var Rate    = int(Resp.GetAmount.RecordInfoList[i].NdflKeepRate);

            if(IncDate <= m_EndDate)
              if((IncDate > prevIncDate) or ((IncDate == prevIncDate) and (IncTime > prevIncTime)) or ((IncDate == prevIncDate) and (IncTime == prevIncTime) and (Rate > prevRate)))
                AmountSNOB2 = Resp.GetAmount.RecordInfoList[i].SNOBPayAmount;

                prevIncDate = IncDate; 
                prevIncTime = IncTime; 
                prevRate    = Rate;
              end;
            end;

            i = i + 1;
          end;
        end;
      end;

      if(m_Include_Tech == SET_CHAR)
        AmountSNOB2 = AmountSNOB2 + GetSumTechObj(7, "2,5");
      end;
    end;

    if ((ValType(AmountSNOB2) == V_UNDEF) or (AmountSNOB2 == NULL)) 
       AmountSNOB2 = $0; 
    end;

    return AmountSNOB2;
  END;

  MACRO TaxFR_Total(CalcType:integer):money
    return this.TaxFR_market(CalcType) + this.TaxFR_OTC(CalcType);
  END;

  /*Финансовый результат от купли - продажи и погашения обращающихся  ценных бумаг*/
  MACRO TaxFR_market(CalcType:integer):money
    var tmp_sum = NULL;
    var NkdB_TS = $0;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_TaxFR_market;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_TaxFR_market_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_TaxFR_market_ONB;
    end;
    
    if(tmp_sum == NULL)
      tmp_sum = $0;

      if(CalcType == CALCTYPE_SEC)
        if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
          var Query, DataSet, cmd;

          Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                       "                       THEN  N.t_Sum0 " +
                       "                       ELSE -N.t_Sum0 END " +
                       "                    ) " +
                       "               ), 0 " +
                       "           ) sum"    +
                       "  from dnptxobj_dbt N " +
                       " where N.t_Client =  ? " +
                       "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                       "   and N.t_Date >=  ? " + 
                       "   and N.t_Date <=  ? " + 
                       "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                       "   and N.t_Analitic5 NOT IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                       "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                       "   and N.t_Analitic4 = "+NPTX_FI_CIRCULATE +
                       "   and N.t_AnaliticKind4 = " + TXOBJ_KIND4010 +
                       IIF(m_Include_Tech != SET_CHAR, " and (N.t_Technical = CHR(0) or N.t_Technical IS NULL) ", "") + 
                       "   and N.t_OutSystCode != 'ДЕПО' ";

          if(CalcType == CALCTYPE_DEPO)
            Query = Query +
                       "   and N.t_OutSystCode = 'DEPO'";
          else
            Query = Query +
                       "   and N.t_OutSystCode != 'DEPO'";
          end;

          if(m_ContractIDsStr != "")
            Query = Query + " and N.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and N.t_Analitic6 IN ("+m_ContractIDsStr+") ";
          end;

          cmd = DL_RSDCommand(query);
          cmd.AddParam(m_CurrInvestor);
          cmd.AddParam(m_BeginDate);
          cmd.AddParam(m_EndDate);

          DataSet = cmd.Execute();       
          if( DataSet.MoveNext())
            tmp_sum = Round(DataSet.sum,2);
          end;

          if(NeedNKDB_TS(m_EndDate) == false)
            DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                     string(TXOBJ_NKDB_TS),
                                     m_BeginDate,
                                     m_EndDate,
                                     null,
                                     null,
                                     @NkdB_TS, null, m_CurrIIS, true,
                                     GetForDepoCond(false) + " and obj.t_AnaliticKind4 = " + TXOBJ_KIND4010 + " and obj.t_Analitic4 = " + NPTX_FI_CIRCULATE + " and obj.t_FromOutSyst <> 'X' ",
                                     NULL,
                                     NULL,
                                     IIF(m_Include_Tech != SET_CHAR, true, false)
                                    );

            tmp_sum = tmp_sum + NkdB_TS;
          end;
        end;
      end;
    end;

    if(CalcType == CALCTYPE_SEC)
      m_TaxFR_market = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxFR_market_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxFR_market_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;
  
  /*Финансовый результат от купли - продажи и погашения не обращающихся ценных бумаг*/
  MACRO TaxFR_OTC(CalcType:integer):money
    var tmp_sum = NULL;
    var NkdB_TS = $0;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_TaxFR_OTC;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_TaxFR_OTC_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_TaxFR_OTC_ONB;
    end;
    
    if(tmp_sum == NULL)
      tmp_sum = $0;

      if(CalcType == CALCTYPE_SEC)
        if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
          var Query, DataSet, cmd;

          Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                       "                       THEN  N.t_Sum0 " +
                       "                       ELSE -N.t_Sum0 END " +
                       "                    ) " +
                       "               ), 0 " +
                       "           ) sum"    +
                       "  from dnptxobj_dbt N " +
                       " where N.t_Client =  ? " +
                       "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                       "   and N.t_Date >=  ? " + 
                       "   and N.t_Date <=  ? " + 
                       "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                       "   and N.t_Analitic5 NOT IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                       "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                       "   and N.t_Analitic4 IN ("+NPTX_FI_NOCIRCULATE+", "+NPTX_FI_LOSTCIRCULATE+")" +
                       "   and N.t_AnaliticKind4 = " + TXOBJ_KIND4010 +
                       IIF(m_Include_Tech != SET_CHAR, " and (N.t_Technical = CHR(0) or N.t_Technical IS NULL) ", "") + 
                       "   and N.t_OutSystCode != 'ДЕПО' ";
                       

          if(CalcType == CALCTYPE_DEPO)
            Query = Query +
                       "   and N.t_OutSystCode = 'DEPO'";
          else
            Query = Query +
                       "   and N.t_OutSystCode != 'DEPO'";
          end;

          if(m_ContractIDsStr != "")
            Query = Query + " and N.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and N.t_Analitic6 IN ("+m_ContractIDsStr+") ";
          end;

          cmd = DL_RSDCommand(query);
          cmd.AddParam(m_CurrInvestor);
          cmd.AddParam(m_BeginDate);
          cmd.AddParam(m_EndDate);

          DataSet = cmd.Execute();       
          if( DataSet.MoveNext())
            tmp_sum = money(Round(DataSet.sum,2));
          end;

          if(NeedNKDB_TS(m_EndDate) == false)
            DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                     string(TXOBJ_NKDB_TS),
                                     m_BeginDate,
                                     m_EndDate,
                                     null,
                                     null,
                                     @NkdB_TS, null, m_CurrIIS, true,
                                     GetForDepoCond(false) + " and obj.t_AnaliticKind4 = " + TXOBJ_KIND4010 + " and obj.t_Analitic4 IN ("+NPTX_FI_NOCIRCULATE+", "+NPTX_FI_LOSTCIRCULATE+") and obj.t_FromOutSyst <> 'X' ",
                                     NULL,
                                     NULL,
                                     IIF(m_Include_Tech != SET_CHAR, true, false)
                                    );

            tmp_sum = tmp_sum + NkdB_TS;
          end;
        end;
      end;
    end;
    
    if(CalcType == CALCTYPE_SEC)
      m_TaxFR_OTC = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxFR_OTC_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxFR_OTC_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;

  /*Финансовый результат от купли - продажи и погашения потерявших обращаемость ценных бумаг*/
  MACRO TaxFR_Lost(CalcType:integer):money
    var tmp_sum = NULL;
    var NkdB_TS = $0;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_TaxFR_Lost;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_TaxFR_Lost_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_TaxFR_Lost_ONB;
    end;
    
    if(tmp_sum == NULL)
      tmp_sum = $0;

      if(CalcType == CALCTYPE_SEC)
        if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
          var Query, DataSet, cmd;

          Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                       "                       THEN  N.t_Sum0 " +
                       "                       ELSE -N.t_Sum0 END " +
                       "                    ) " +
                       "               ), 0 " +
                       "           ) sum"    +
                       "  from dnptxobj_dbt N " +
                       " where N.t_Client =  ? " +
                       "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                       "   and N.t_Date >=  ? " + 
                       "   and N.t_Date <=  ? " + 
                       "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                       "   and N.t_Analitic5 NOT IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                       "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                       "   and N.t_Analitic4 = "+NPTX_FI_LOSTCIRCULATE+
                       "   and N.t_AnaliticKind4 = " + TXOBJ_KIND4010 +
                       IIF(m_Include_Tech != SET_CHAR, " and (N.t_Technical = CHR(0) or N.t_Technical IS NULL) ", "") +
                       "   and N.t_OutSystCode != 'ДЕПО' ";
                       

          if(CalcType == CALCTYPE_DEPO)
            Query = Query +
                       "   and N.t_OutSystCode = 'DEPO'";
          else
            Query = Query +
                       "   and N.t_OutSystCode != 'DEPO'";
          end;

          if(m_ContractIDsStr != "")
            Query = Query + " and N.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and N.t_Analitic6 IN ("+m_ContractIDsStr+") ";
          end;

          cmd = DL_RSDCommand(query);
          cmd.AddParam(m_CurrInvestor);
          cmd.AddParam(m_BeginDate);
          cmd.AddParam(m_EndDate);

          DataSet = cmd.Execute();       
          if( DataSet.MoveNext())
            tmp_sum = money(Round(DataSet.sum,2));
          end;

          if(NeedNKDB_TS(m_EndDate) == false)
            DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                     string(TXOBJ_NKDB_TS),
                                     m_BeginDate,
                                     m_EndDate,
                                     null,
                                     null,
                                     @NkdB_TS, null, m_CurrIIS, true,
                                     GetForDepoCond(false) + " and obj.t_AnaliticKind4 = " + TXOBJ_KIND4010 + " and obj.t_Analitic4 = " + NPTX_FI_LOSTCIRCULATE + " and obj.t_FromOutSyst <> 'X' ",
                                     NULL,
                                     NULL,
                                     IIF(m_Include_Tech != SET_CHAR, true, false)
                                    );

            tmp_sum = tmp_sum + NkdB_TS;
          end;
        end;
      end;
    end;
    
    if(CalcType == CALCTYPE_SEC)
      m_TaxFR_Lost = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxFR_Lost_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxFR_Lost_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;

  /*Сумма расходов в виде комиссий, списанных за ведение счета депо*/
  MACRO ComDepo(CalcType:integer):money
    var SumGeneral = $0, SumPreviousYear = $0;
    var Year;
    var tmp_sum = NULL;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_ComDepo;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_ComDepo_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_ComDepo_ONB;
    end;

    DateSplit(m_BeginDate, NULL, NULL, Year);
    if( tmp_sum == NULL )
       tmp_sum = $0;
       if(CalcType == CALCTYPE_SEC)
         if( (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) )
            if(m_CurrIIS == 0)
                DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                         string(TXOBJ_GENERAL),
                                         m_BeginDate,
                                         m_EndDate,
                                         0,
                                         null,
                                         @SumGeneral,
                                         null,
                                         m_CurrIIS,
                                         true,
                                         GetForDepoCond(false),
                                         NULL,
                                         NULL,
                                         IIF(m_Include_Tech != SET_CHAR, true, false)
                                        );

                DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                         string(TXOBJ_PREVIOUSYEAR),
                                         NULL,
                                         date(1, 1, Year)-1,
                                         0,
                                         null,
                                         @SumPreviousYear,
                                         null,
                                         m_CurrIIS,
                                         true,
                                         GetForDepoCond(false),
                                         NULL,
                                         NULL,
                                         IIF(m_Include_Tech != SET_CHAR, true, false)
                                        );

                tmp_sum = SumGeneral + SumPreviousYear;
            else
                var BegDate = GetFirstDateIIS(m_CurrInvestor);

                DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                         string(TXOBJ_GENERAL_IIS),
                                         BegDate,
                                         m_EndDate,
                                         0,
                                         null,
                                         @tmp_sum,
                                         null,
                                         m_CurrIIS,
                                         true,
                                         GetForDepoCond(false),
                                         NULL,
                                         NULL,
                                         IIF(m_Include_Tech != SET_CHAR, true, false)
                                        );
            end;
         end;
       end;
     end;

    if(CalcType == CALCTYPE_SEC)
      m_ComDepo = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_ComDepo_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_ComDepo_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;

  PRIVATE MACRO ЗагрузитьЗначенияДЕПО_СОФР_2022()
    if(НОБ_СОФР == null)
      var Year = 0;

      datesplit(m_EndDate, null, null, Year);
      
      ПолучитьЗначенияДЕПО_СОФР_2022(m_CurrInvestor,
                                     IIF(this.ClientStatus() == CL_STATE_RES, true, false),
                                     Year,
                                     m_BeginDate,
                                     m_EndDate,
                                     0,
                                     @НОБ_СОФР, @НОБ15_СОФР,
                                     @Налог_СОФР, @Налог15_СОФР,
                                     @НОБ_ДЕПО, @НОБ_ДЕПО_КБК1, @НОБ_ДЕПО_КБК2, @НОБ_ДЕПО_КБК3,
                                     @Налог_ДЕПО_КБК1, @Налог_ДЕПО_КБК2, @Налог_ДЕПО_КБК3,
                                     @Налог_КБК1, @Налог_КБК2, @Налог_КБК3, true
                                    );
    end;
  END;

  /*Суммы, полученные при погашении купонов и частичных погашениях*/
  MACRO CoupRub(CalcType:integer):money
    var NkdB_TS = $0;

    if (CalcType == CALCTYPE_DEPO)
      if( m_CoupRubS_DEPO == NULL )
        m_CoupRubS_DEPO = $0;
        
        if(SET_CHAR == m_ByDepo)
          if((m_EndDate == date(31,12,2022)) and (m_CurrIIS == 0))
            ЗагрузитьЗначенияДЕПО_СОФР_2022();
            m_CoupRubS_DEPO = НОБ_ДЕПО + НОБ_ДЕПО_КБК3;
          else
            var query, cmd, DataSet;
            
            if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
              query =   " with sf_num as (select DISTINCT sf.t_Number "
                      + "                   from dsfcontr_dbt sf, ddlcontr_dbt dlc, ddlcontrmp_dbt mp "
                      + "                  where sf.t_PartyID = ? "
                      + "                    and dlc.t_SfContrID = sf.t_ID "
                      + "                    and dlc.t_IIS = " + IIF(m_CurrIIS, "CHR(88)", "CHR(0)")
                      + "                    and mp.t_DlContrID = dlc.t_DlContrID "
                      + IIF(m_ContractIDsStr != "", " and mp.t_SfContrID IN ("+m_ContractIDsStr+") ", "")
                      + "                ) "
                      + "     ,agreement_records as ( "
                      + "                 select rc.t_IssuerSum, "
                      + "                        rc.t_PaymentDate, "
                      + "                        rc.t_IsIIS, "
                      + "                        rc.t_OperationStatus, "
                      + "                        rc.t_IsGetTax, "
                      + "                        rc.t_TaxRate, "
                      + "                        count(case when lower(rc.t_operationstatus) = 'отменена' then 1 end) over(partition by rc.t_recordpaymentqtyid order by rc.t_id desc) is_canceled "
                      + "                   from dcdrecords_dbt rc "
                      + "                   join sf_num n on n.t_Number = rc.t_AgreementNumber "
                      + "                  where rc.t_corporateactiontype = 'INTR' "
                      + "                  ) "
                      + " select NVL(SUM(rc.t_IssuerSum), 0) as CoupSum "
                      + "   from agreement_records rc"
                      + "  where (rc.t_IsIIS = " + IIF(m_CurrIIS, "CHR(88)", "CHR(0)") + IIF(m_CurrIIS, "", " or rc.t_IsIIS is NULL") + ")"
                      + "    and LOWER(rc.t_OperationStatus) = 'активна' "
                      + "    and rc.t_IsGetTax = 'X' "
                      + "    and rc.t_TaxRate != 0 "
                      + "    and rc.is_canceled = 0 "
                      + "    and rc.t_PaymentDate BETWEEN ? and ? ";

              cmd = DL_RSDCommand(query);

              cmd.AddParam(m_CurrInvestor);
              cmd.AddParam(m_BeginDate);
              cmd.AddParam(m_EndDate);

              DataSet = cmd.Execute();
              if(DataSet.moveNext())
                m_CoupRubS_DEPO = money(DataSet.CoupSum);
              end;

              NkdB_TS = $0;

              DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                       string(TXOBJ_NKDB_TS),
                                       m_BeginDate,
                                       DlastNOB(),
                                       null,
                                       null,
                                       @NkdB_TS, null, m_CurrIIS, true,
                                       GetForDepoCond(true) + " and obj.t_Date <= " + GetSQLDate(DlastNOB()), //Доп. условие нужно, т.к. если DlastNOB нулевая, то ф-ция отбора её игнорирует, отбираются лишние НДР
                                       NULL,
                                       NULL,
                                       IIF(m_Include_Tech != SET_CHAR, true, false)
                                      );

              m_CoupRubS_DEPO = m_CoupRubS_DEPO - NkdB_TS;
            end;
          end;
        end;
      end;

      return m_CoupRubS_DEPO;
    elif(CalcType == CALCTYPE_SEC)
      if( m_CoupRubS == NULL )
         m_CoupRubS = $0;
         if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
           
           DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                    string(TXOBJ_PROCSEC_TS),
                                    m_BeginDate,
                                    DlastNOB(),
                                    null,
                                    null,
                                    @m_CoupRubS, null, m_CurrIIS, true,
                                    GetForDepoCond(false)+ " and obj.t_Date <= " + GetSQLDate(DlastNOB()),
                                    NULL,
                                    NULL,
                                    IIF(m_Include_Tech != SET_CHAR, true, false)
                                   );

           NkdB_TS = $0;

           DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                    string(TXOBJ_NKDB_TS),
                                    m_BeginDate,
                                    DlastNOB(),
                                    null,
                                    null,
                                    @NkdB_TS, null, m_CurrIIS, true,
                                    GetForDepoCond(false)+ " and obj.t_Date <= " + GetSQLDate(DlastNOB()),
                                    NULL,
                                    NULL,
                                    IIF(m_Include_Tech != SET_CHAR, true, false)
                                   );

           m_CoupRubS = m_CoupRubS - NkdB_TS;
         end;
       end;
 
      return m_CoupRubS;
    end;

    return $0;
  END;

  /*Сумма доходов от купли - продажи не обращающихся ценных бумаг*/
  MACRO TaxFR_Open():money
    
    if(m_TaxFR_Open == NULL)
      m_TaxFR_Open = $0;

      if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        var Query, DataSet, cmd;

        Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                     "                       THEN  N.t_Sum0 " +
                     "                       ELSE -N.t_Sum0 END " +
                     "                    ) " +
                     "               ), 0 " +
                     "           ) sum"    +
                     "  from dnptxobj_dbt N " +
                     " where N.t_Client =  ? " +
                     "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                     "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC_SHORT) + ", " + string(TXOBJ_PLUS_SEC_SHORT) + " ) " +
                     "   and N.t_Date >=  ? " + 
                     "   and N.t_Date <=  ? " +
                     IIF(m_Include_Tech != SET_CHAR, " and (N.t_Technical = CHR(0) or N.t_Technical IS NULL) ", ""); 

        cmd = DL_RSDCommand(query);
        cmd.AddParam(m_CurrInvestor);
        cmd.AddParam(m_BeginDate);
        cmd.AddParam(m_EndDate);

        DataSet = cmd.Execute();       
        if( DataSet.MoveNext())
          m_TaxFR_Open = DataSet.sum;
        end;
      end;
    end;
    
    return m_TaxFR_Open;
  END;

  private macro StrMaxFactDate2()
     return
     " (NVL( (SELECT max(dlrq.t_FactDate) " +
     "  FROM ddlrq_dbt dlrq " + 
     "  WHERE dlrq.t_DocKind    = tick.t_BOfficeKind " +
     "      AND dlrq.t_DocID = tick.t_DealID " +
     "      AND dlrq.t_Type    IN (" + DLRQ_TYPE_DELIVERY + "," + DLRQ_TYPE_PAYMENT + ") " +
     "      AND dlrq.t_DealPart    = " + LEG_KIND_DL_TICK_BACK + 
     "      AND dlrq.t_State = " + DLRQ_STATE_EXEC +
     "      AND dlrq.t_FactDate > TO_DATE('01-01-0001','DD-MM-YYYY') " +
     "      ), TO_DATE('01-01-0001','DD-MM-YYYY') ) " +
     " ) ";
  end;

  /*по сделкам РЕПО, у которых максимальная из дат: фактической поставки по 2 части и фактической оплаты по 2 части входит в период с <RepDbeg> по <RepDend>*/
  MACRO GetComRubSumByClientByCond():money
    
    var AddWhereCond = " Exists "+
                       " (select 1 "+
                       "    from dnptxobj_dbt obj_1 "+
                       "   where obj_1.t_Date between "+GetSQLDate(m_BeginDate)+ " and "+GetSQLDate(m_EndDate)+
                       "     and obj_1.t_AnaliticKind1 = obj.t_AnaliticKind1 " +
                       "     and obj_1.t_Analitic1 = obj.t_Analitic1 " +
                       IIF(m_Include_Tech != SET_CHAR, " and (obj_1.t_Technical = CHR(0) or obj_1.t_Technical IS NULL) ", "") +
                       "     and Exists(select 1 " +
                       "                  from ddl_tick_dbt Tick, doprkoper_dbt Opr " +
                       "                 where Tick.t_DealID = obj_1.t_Analitic1 " + 
                       "                   and Tick.t_BOfficeKind = " + DL_SECURITYDOC +
                       "                   and Opr.t_Kind_Operation = Tick.t_DealType " + 
                       "                   and Rsb_Secur.IsRepo(rsb_secur.get_OperationGroup(Opr.t_SysTypes)) = 1 "
                       "                   and ("+StrMaxFactDate2()+" between "+GetSQLDate(m_BeginDate)+" and "+GetSQLDate(m_EndDate)+") " +
                       "               )) ";
    if(m_ContractIDsStr != "")
      AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
    end;

    /*здесь дату НДР вида TXOBJ_COM не проверяем, т.к. по процентам НДР формируется в дату второй части, а комиссия чаще всего в дату первой*/
    return GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COM), m_BeginDate /* null*/, null, TXOBJ_DIR_OUT, m_CurrIIS, null, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
  END;

    /*Доходы по сделкам РЕПО/займа фактические*/
  MACRO RepoFactRub():money
    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      return GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCFACT), m_BeginDate, m_EndDate, TXOBJ_DIR_IN, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false)) -
             GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCFACT), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false)) - 
             GetComRubSumByClientByCond();
    end;
    return $0;
  END;

  /*Доходы по сделкам РЕПО/займа для налогообложения*/
  MACRO RepoTaxRub():money
    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      return GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCREPOTAX), m_BeginDate, m_EndDate, TXOBJ_DIR_IN, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false)) -
             GetRubSumByClient(m_CurrInvestor, string(TXOBJ_PROCREPOTAX), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false)) - 
             GetComRubSumByClientByCond();
    end;
    return $0;
  END;

  /*Сумма убытка по  РЕПО и коротким позициям в уменьшение НОБ по ц/б */
  MACRO RepoTaxRach():money

    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
        if (m_CurrIIS != 1)
           return  GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_222), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false))+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_223), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false))+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_214), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false));
        else
           return  GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_239), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false))+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_240), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false))+
                   GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MINUSG_214_IIS), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false));
        end;
    end;
    return $0;
  END;

  /*Доходы по сделкам с ПИ*/
  MACRO DerivTaxRub():money
    var DerivTaxRub = 0;

    if(this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE)
      var Query, DataSet, cmd;

      Query =      " select NVL(sum( (CASE WHEN N.t_Direction = " + string(TXOBJ_DIR_IN) + 
                   "                       THEN  N.t_Sum0 " +
                   "                       ELSE -N.t_Sum0 END " +
                   "                    ) " +
                   "               ), 0 " +
                   "           ) sum"    +
                   "  from dnptxobj_dbt N " +
                   " where N.t_Client = ? " +  
                   "   and N.t_Kind IN (" + string(TXOBJ_MINUS_SEC) + ", " + string(TXOBJ_PLUS_SEC) + " ) " +
                   "   and N.t_Date >= ? " + 
                   "   and N.t_Date <= ? " + 
                   "   and RSI_NPTO.CheckObjIIS (N.t_AnaliticKind6, N.t_Analitic6 ) = " + string(m_CurrIIS) +
                   "   and N.t_Analitic5 IN  (" + string(TXGROUP_90) + ", " + string(TXGROUP_80) + ") " +
                   "   and N.t_AnaliticKind5 = " + string(TXOBJ_KIND5010) +
                   IIF(m_Include_Tech != SET_CHAR, " and (N.t_Technical = CHR(0) or N.t_Technical IS NULL) ", "");

      cmd = DL_RSDCommand(Query);
      cmd.AddParam(m_CurrInvestor);
      cmd.AddParam(m_BeginDate);
      cmd.AddParam(m_EndDate);

      DataSet = cmd.Execute();       
      if( DataSet.MoveNext())
        DerivTaxRub = DataSet.sum;
      end; 
    end;
    return DerivTaxRub;
  END;

  MACRO BaseG_2_3_9(i:Integer, forDepo:bool):money
    var BaseG_2_3_9 = iif( forDEPO, m_BaseG_2_3_9_DEPO, m_BaseG_2_3_9);

    if( BaseG_2_3_9(i) == NULL )
      DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               string(TXOBJ_BASEG_2_3_9(i)),
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @BaseG_2_3_9(i),
                               null,
                               null,
                               true,
                               GetForDepoCond(forDepo),
                               NULL,
                               NULL,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );      
    end;

    return BaseG_2_3_9(i);
  END;

  MACRO BaseG5(forDEPO:bool):money
    var tmp_sum = iif(forDEPO, m_BaseG5_DEPO, m_BaseG5);

    if( tmp_sum == NULL )
      DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               string(IIF(this.ClientStatus() == CL_STATE_RES, TXOBJ_BASEG5, TXOBJ_BASEGENERAL_IIS)),
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @tmp_sum,
                               null,
                               null,
                               true,
                               GetForDepoCond(forDepo),
                               NULL,
                               NULL,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );      
    end;

    return iifset(forDEPO, @m_BaseG5_DEPO, @m_BaseG5, tmp_sum);
  END;

  MACRO BaseMaterial():money
    var BDate, EDate = m_EndDate;
    
    if( m_BaseMaterial == NULL )
       m_BaseMaterial = $0;

       BDate = date(1,1,m_TaxPeriod);

       if(m_CurrIIS == 1)
         var query, cmd;

         cmd = DL_RSDCommand();

         query =   " select 1 "
                 + "   from dnptxop_dbt "
                 + "  where t_Client = " + cmd.AddParam(m_CurrInvestor)
                 + "    and t_OperDate between "+cmd.AddParam(date(1,1,m_TaxPeriod))+" and "+cmd.AddParam(m_EndDate)
                 + "    and t_SubKind_Operation = " + DL_TXHOLD_OPTYPE_CLOSE
                 + "    and t_IIS = 'X' ";

         if(cmd.GetCount(query) > 0)
           cmd = DL_RSDCommand();

           query =   " select "
                   + "   from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
                   + "  where mp.t_SfContrID in ("+m_ContractIDsStr+") "
                   + "    and dlc.t_DlContrID = mp.t_DlContrID "
                   + "    and sf.t_ID = dlc.t_SfContrID "
                   + "    and sf.t_DateClose between "+cmd.AddParam(date(1,1,m_TaxPeriod))+" and "+cmd.AddParam(m_EndDate);

           if(cmd.GetCount(query) > 0)
             BDate = m_BeginDate;
           end;
         end;
       end;

       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(IIF(m_CurrIIS == 1, TXOBJ_BASEMATERIAL_IIS, TXOBJ_BASEMATERIAL)),
                                BDate,
                                EDate,
                                null,
                                null,
                                @m_BaseMaterial,
                                null,
                                null,
                                true,
                                NULL,
                                NULL,
                                NULL,
                                IIF(m_Include_Tech != SET_CHAR, true, false)
                               );
    end;

    return m_BaseMaterial;
  END;
  
  MACRO BG(forDEPO:bool):money
    var tmp_sum = iif(forDEPO, m_BG_DEPO, m_BG);
  
    if( tmp_sum == NULL )
       tmp_sum = $0;

       if( m_CurrIIS == 1 )
          if (this.ClientStatus() == CL_STATE_RES)
            tmp_sum = Min(this.BaseG5(forDEPO), Max15);
          else
            tmp_sum = this.BaseG5(forDEPO);
          end;
       else
          for( var i, 0, TXOBJ_BASEG_2_3_9.size-1)
            if (this.ClientStatus() == CL_STATE_RES)
              tmp_sum = tmp_sum + Min(this.BaseG_2_3_9(i, forDEPO), Max15);
            else
              tmp_sum = tmp_sum + this.BaseG_2_3_9(i, forDEPO);
            end;
          end;
       end;
    end;

    return iifset(forDEPO, @m_BG_DEPO, @m_BG, tmp_sum);
  END;

  MACRO BP(forDEPO):money
    var tmp_sum = iif(forDEPO, m_BP_DEPO, m_BP);

    if( tmp_sum == NULL )
       tmp_sum = $0;

       if (this.ClientStatus() == CL_STATE_RES)
         if( m_CurrIIS == 1 )
            tmp_sum = Max(this.BaseG5(forDEPO) - Max15, $0);
         else
            for( var i, 0, TXOBJ_BASEG_2_3_9.size-1 )
               tmp_sum = tmp_sum + Max(this.BaseG_2_3_9(i, forDEPO) - Max15, $0);
            end;
         end;
       end;
    end;

    return iifset(forDEPO, @m_BP_DEPO, @m_BP, tmp_sum);
  END;

  MACRO RG()
    if (this.ClientStatus() == CL_STATE_RES) 
      return NPTXGENTAXRATE_RESIDENT;
    else 
      var _stat = 1; 
      var _TaxRate;
      
      if (m_EndDate != NULL)
        _stat = ПолучитьЗначениеПримечанияНаДату(m_CurrInvestor, PARTY_NOTE_KIND_NPTX_RATE_NOTRES, m_EndDate, @_TaxRate);
      end;
      if (_stat != 0)
        _TaxRate = NPTXGENTAXRATE_NOTRESIDENT; //для нерезидента
      elif (_TaxRate!= NULL)
        _TaxRate = _TaxRate / 100; //Примечание вернёт целые проценты. Нам же нужен коэффициент
      end;
      
      return _TaxRate;
    end;
  END;

  /*Налоговая ставка - %*/
  MACRO TaxRateGeneral():STRING
    return string(this.RG()*100, "%");
  END;

  MACRO RS()
    if (this.ClientStatus() == "резидент") 
      return 0.09;
    else
      return 0.15;
    end;
  END;

  MACRO RP()
    return NPTXGENTAXRATE_RESIDENT_15;
  END;

  MACRO R18()
    return NPTXGENTAXRATE_RESIDENT_18;
  END;

  MACRO R20()
    return NPTXGENTAXRATE_RESIDENT_20;
  END;

  MACRO R22()
    return NPTXGENTAXRATE_RESIDENT_22;
  END;

  PRIVATE MACRO GetOutCurrencySum(ClientId, EndDate, BegDate ):money
    var OutSum = $0;
    var query, Select, DataSet;
    var Sum = $0;
    var dlrq = TRecHandler("dlrq.dbt");
    var rqacc = TRecHandler("dlrqacc.dbt");
    var AccountBuf = TRecHandler("account");

    Select = DL_RSDCommand();

    query =   "select NVL(SUM(acctrn.t_Sum_Natcur), 0) as SumOutSum "
            + "   from dnptxop_dbt S, doproper_dbt oproper, doprdocs_dbt oprdocs, dacctrn_dbt acctrn "
            + "  where S.t_DocKind = " + DL_WRTMONEY
            + "    and S.t_Client = ? " 
            + IIF(m_CurrIIS == 1, " and S.t_IIS = 'X' ", " and S.t_IIS <> 'X' ")
            + "    and S.t_Subkind_Operation = " + DL_NPTXOP_WRTKIND_WRTOFF;
  
    Select.addParam(ClientID );

    if(ValType(BegDate) == V_DATE)
      query = query + "    and S.t_OperDate >= ? "
                    + "    and S.t_OperDate <= ? ";

      Select.addParam(BegDate );
      Select.addParam(EndDate );
    else
      query = query + "    and S.t_OperDate = ? ";
      Select.addParam(EndDate );
    end;

    query = query + " and oproper.t_DocKind = S.t_DocKind "
                  + " and oproper.t_DocumentID = LPAD(S.t_ID, 34, '0') "
                  + " and oprdocs.t_ID_Operation = oproper.t_ID_Operation "
                  + " and oprdocs.t_DocKind = 1 " //Проводка
                  + " and acctrn.t_AccTrnID = oprdocs.t_AccTrnID "
                  + " and acctrn.t_Account_Payer LIKE '306%' ";

    DataSet = Select.execute(query);
    if(DataSet.moveNext())
      OutSum = money(DataSet.SumOutSum);
    end;

    return OutSum; 
  END; 

  MACRO BaseBill(CalcType:integer):money
    if (m_BaseBill == null)
      m_BaseBill = $0;
      
      DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               string(TXOBJ_PLUSG_2800),
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @m_BaseBill, null, m_CurrIIS, true,
                               NULL,
                               NULL,
                               NULL,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
    end;

    return m_BaseBill;    
  END;
  
  MACRO OtherIncome():money
    var OtherIncome_IN = $0, OtherIncome_OUT = $0;

    if( m_OtherIncome == null )
       m_OtherIncome = $0;

       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(TXOBJ_PLUSG_4800),
                                m_BeginDate,
                                m_EndDate,
                                TXOBJ_DIR_IN,
                                null,
                                @OtherIncome_IN,
                                null,
                                m_CurrIIS,
                                true,
                                NULL,
                                NULL,
                                NULL,
                                IIF(m_Include_Tech != SET_CHAR, true, false)
                               );
       DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                string(TXOBJ_PLUSG_4800),
                                m_BeginDate,
                                m_EndDate,
                                TXOBJ_DIR_OUT,
                                null,
                                @OtherIncome_OUT,
                                null,
                                m_CurrIIS,
                                true,
                                NULL,
                                NULL,
                                NULL,
                                IIF(m_Include_Tech != SET_CHAR, true, false)
                               );
       /*Доход суммируем с плюсом, расход с минусом*/
       m_OtherIncome = abs(OtherIncome_IN) - abs(OtherIncome_OUT);
    end;
    return m_OtherIncome;
  END;

  MACRO TaxBase_618(CalcType:integer):money // Общая НОБ без учета  инвестиционного вычета / налогового вычета на ДСГ
    var RetVal:money = $0;
    
    if(CalcType != CALCTYPE_ONB)
      var TaxBase = $0;
      
      if(m_EndDate >= GetStartSTBDate())
        TaxBase = this.TaxBase_13(CalcType) + this.TaxBase_15(CalcType);
      else
        TaxBase = this.BG(CalcType) + this.BP(CalcType);
      end;

      if(CalcType == CALCTYPE_DEPO)
        RetVal = TaxBase;
      else
        if(this.ReportType() == DL_TXHOLD_OPTYPE_LUCRE) 
           RetVal = TaxBase;
        elif(m_CurrIIS == 1 )
           RetVal = TaxBase + this.MinusG_619(CalcType) + this.MinusG_517(CalcType);
        else
           RetVal = TaxBase + this.MinusG_618(CalcType);
        end;
      end;
    end;

    return RetVal;
  END;

  MACRO Limit_618(CalcType:integer):money // Предельное значение инвестиционного вычета по ц/б в собственности более 3 лет
    var tmp_sum = iif(CalcType == CALCTYPE_DEPO, m_Limit_618_DEPO, m_Limit_618);
    
    if( tmp_sum == null )
       tmp_sum = $0;
       if(CalcType != CALCTYPE_DEPO)
         if( (this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) and (m_CurrIIS != 1) )
            DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                     string(TXOBJ_LIMIT_618),
                                     m_BeginDate,
                                     m_EndDate,
                                     null,
                                     null,
                                     @tmp_sum, null, m_CurrIIS, true,
                                     GetForDEPOCond(false),
                                     NULL,
                                     NULL,
                                     IIF(m_Include_Tech != SET_CHAR, true, false)
                                    );
         end;
      end;
    end;

    return iifset(CalcType == CALCTYPE_DEPO, @m_Limit_618_DEPO, @m_Limit_618, tmp_sum);
  END;

  MACRO MinusG_618(CalcType:integer):money // Учтенное в НОБ  значение льготы долгосрочного владения (ЛДВ) (618)
    var tmp_sum = NULL;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_Minus_618;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_Minus_618_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_Minus_618_ONB;
    end;

    if( tmp_sum == null )
      tmp_sum = $0;
      if(CalcType == CALCTYPE_SEC)
        if((this.ReportType() != DL_TXHOLD_OPTYPE_LUCRE) and (m_CurrIIS == 0))
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_MINUSG_618),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @tmp_sum, null, m_CurrIIS, true,
                                   GetForDEPOCond(false),
                                   NULL,
                                   NULL,
                                   IIF(m_Include_Tech != SET_CHAR, true, false)
                                  );
        end;
      end;
    end;

    if(CalcType == CALCTYPE_SEC)
      m_Minus_618 = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_Minus_618_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_Minus_618_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;

  MACRO MinusG_619(CalcType:integer):money // Инвестиционный налоговый вычет (619) (для ИИС)
    var tmp_sum = NULL;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_Minus_619;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_Minus_619_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_Minus_619_ONB;
    end;

    if( tmp_sum == null )
      tmp_sum = $0;
      if(CalcType == CALCTYPE_SEC)
        if(m_CurrIIS)
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_MINUSG_619),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @tmp_sum, null, m_CurrIIS, true,
                                   GetForDEPOCond(false),
                                   NULL,
                                   NULL,
                                   IIF(m_Include_Tech != SET_CHAR, true, false)
                                  );
        end;
      end;
    end;

    if(CalcType == CALCTYPE_SEC)
      m_Minus_619 = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_Minus_619_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_Minus_619_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;

  MACRO MinusG_517(CalcType:integer):money // Налоговый вычет (517) на долгосрочные сбережения граждан (ДСГ)
    var tmp_sum = NULL;
    
    if(CalcType == CALCTYPE_SEC)
      tmp_sum = m_Minus_517;
    elif(CalcType == CALCTYPE_DEPO)
      tmp_sum = m_Minus_517_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      tmp_sum = m_Minus_517_ONB;
    end;

    if( tmp_sum == null )
      tmp_sum = $0;
      if(CalcType == CALCTYPE_SEC)
        if(m_CurrIIS)
          DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                                   string(TXOBJ_MINUSG_517),
                                   m_BeginDate,
                                   m_EndDate,
                                   null,
                                   null,
                                   @tmp_sum, null, m_CurrIIS, true,
                                   GetForDEPOCond(false),
                                   NULL,
                                   NULL,
                                   IIF(m_Include_Tech != SET_CHAR, true, false)
                                  );
        end;
      end;
    end;

    if(CalcType == CALCTYPE_SEC)
      m_Minus_517 = tmp_sum;
    elif(CalcType == CALCTYPE_DEPO)
      m_Minus_517_DEPO = tmp_sum;
    elif(CalcType == CALCTYPE_ONB)
      m_Minus_517_ONB = tmp_sum;
    end;

    return tmp_sum;
  END;


  MACRO Index_618():money
    var sum1 = $0;
    var sum2 = $0;
    var query, cmd, DataSet;

    cmd = DL_RSDCOmmand();

    query =   " select NVL(SUM(obj.t_Sum0), 0) as AllSumi, NVL(SUM(obj.t_Sum0*obj.t_Holding_Period), 0) as Sumi"
            + "   from dnptxobj_dbt obj "
            + "  where obj.t_Client = " + cmd.AddParam(m_CurrInvestor)
            + "    and obj.t_Kind = " + TXOBJ_PLUSI
            + "    and obj.t_Date between "+cmd.AddParam(m_BeginDate)+" and "+cmd.AddParam(m_EndDate)
            + "    and RSI_NPTO.CheckObjIIS ( " + TXOBJ_KIND6020 + ", obj.t_Analitic6 ) = 0 "
            + "    and " + GetForDEPOCond(false)
            + IIF(m_Include_Tech == UNSET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical is null) ", "");

    DataSet = cmd.Execute(query);
    if(DataSet.moveNext())
      sum1 = DataSet.Sumi;
      sum2 = DataSet.AllSumi;
    end;

    if(sum2 != 0)
      return Round( (sum1 / sum2), ТочностьКЦБ(m_EndDate), 1);
    end;

    return 0;
  END;

  PRIVATE MACRO GetAmountSNOBfromStor(TaxBaseKind, CheckDate):money
     var llv = TRecHandler("llvalues.dbt");
     var Request = c_GetAmountSNOBRequest();
     var AmountSNOB = $0;

     if(CheckDate == NULL)
       CheckDate = m_EndDate;
     end;
     
     Request.GetAmountSNOBReq = c_GetAmountSNOBReq();
     Request.GetAmountSNOBReq.IsActivRecord      = true;
     Request.GetAmountSNOBReq.IsSNOB             = false;
     Request.GetAmountSNOBReq.ClientId           = c_IntegrationSymbolicIdentifierXType();
     Request.GetAmountSNOBReq.ClientId.ObjectID  = m_CurrInvestor;
     Request.GetAmountSNOBReq.TaxYear            = m_TaxPeriod;

     if((TaxBaseKind > 0) and (LL_FindLLVALUES(OBJTYPE_STB_TAXBASEKIND, TaxBaseKind, llv) == true) )
       Request.GetAmountSNOBReq.TaxBaseType = c_IntegrationDictionaryRecordXType();    // Вид налоговой базы по НДФЛ, к которой относится событие        Необязательное
       Request.GetAmountSNOBReq.TaxBaseType.RecordCode = llv.rec.Flag;
     end;

     var Resp = GetAmountSNOBReq(Request);
     
     var isOk = true;
     if((Resp == NULL) or (ValType(Resp) != V_GENOBJ) or (ValType(Resp.GetAmount) == V_UNDEF) or (ValType(Resp.GetAmount.RecordInfoList) == V_UNDEF) or
        ((ValType(Resp.ErrorList) != V_UNDEF) and (Resp.ErrorList.size > 0) and (string(trim(Resp.ErrorList[0].ErrorCode))) != "0")
       )
       isOk = false;
     end;

     if(isOk)
       if(Resp.GetAmount.RecordInfoList.Size > 0)
         var i = Resp.GetAmount.RecordInfoList.Size - 1;

         while(i >= 0)
           if((Resp.GetAmount.RecordInfoList[i].EventType.RecordCode == 1) and  //Тип события = Выплата дохода
              (date(Resp.GetAmount.RecordInfoList[i].IncomeDateTime) <= CheckDate))

             if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
               AmountSNOB = Resp.GetAmount.RecordInfoList[i].SNOBAmount;
             else
               AmountSNOB = Resp.GetAmount.RecordInfoList[i].SNOBPayAmount;
             end;
             break;
           end;
           i = i - 1;
         end;
       end;
     end;

     return money(AmountSNOB);
  END;

  PRIVATE MACRO GetTaxBaseDEPO(Rate:integer):money
    var query, cmd, DataSet;
    var TaxBase = $0;
    var TaxBaseKind = "";
    
    if(SET_CHAR == m_ByDepo)
      if(m_CurrIIS != 0)
        TaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_IIS);
      else
        TaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_BROK);
      end;

      query =   " select NVL(SUM(t_NobAmount), 0) as SumNobAmount "
              + "   from dnptxtbext_dbt "
              + "  where t_ClientID = ? "
              + IIF(TaxBaseKind != "", " and t_TaxBaseKind IN ("+TaxBaseKind+")", "")
              + "    and t_NdflCalcRate = ? "
              + "    and t_IncDate BETWEEN ? and ? ";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_CurrInvestor);
      cmd.AddParam(Rate);
      cmd.AddParam(m_BeginDate);
      cmd.AddParam(m_EndDate);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        TaxBase = money(DataSet.SumNobAmount);
      end;
    end;

    return money(TaxBase);
  END;

  PRIVATE MACRO GetCurrentPayment(TaxBaseKind:string, TaxRate:integer):money
    var query, cmd, DataSet;
    var CurrentPayment = $0;

    query =   " select NVL(SUM(t_TaxBaseCurrPay), 0) as SumTaxBaseCurrPay "
            + "   from dnptxtotalbase_dbt "
            + "  where t_ClientID = ? "
            + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
            + "    and t_Type = 1 " //Тип события = Выплата дохода
            + "    and t_TaxBaseKind IN ("+TaxBaseKind+")"
            + "    and t_RateCalcPITax = ? "
            + "    and t_IncDate BETWEEN ? and ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_CurrInvestor);
    cmd.AddParam(TaxRate);
    cmd.AddParam(m_BeginDate);
    cmd.AddParam(m_EndDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      CurrentPayment = money(DataSet.SumTaxBaseCurrPay);
    end;

    return money(CurrentPayment);
  END;

  PRIVATE MACRO ПолучитьНОБ_ПОНС(TaxBaseKind:integer, TaxRate:integer):money
    var НОБ_ПОНС = $0;
    var query, cmd, DataSet;
    var CheckDate = m_EndDate;
          
    if((m_Include_Tech != SET_CHAR) and (TaxBaseKind != NPTXTOTALBASE_TAXBASEKIND_IIS))
      НОБ_ПОНС = $0;
    else
      var СуммаНОБ = $0;
      var txobj_str = "";

      if(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_BROK)
        txobj_str = string(TXOBJ_BASEG2)+","+string(TXOBJ_BASEG3);
      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS)
        txobj_str = string(TXOBJ_BASEG5);

        query =   " select NVL(MAX(obj.t_Date), "+GetSQLDate(date(0,0,0))+") as MaxObjDate "
                + "   from dnptxobj_dbt obj "
                + "  where obj.t_Client = ? "
                + "    and obj.t_Kind IN ("+txobj_str+")"
                + "    and obj.t_Date <= ? "
                + "    and " + GetForDEPOCond(false)
                + IIF(m_Include_Tech == UNSET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical is null) ", "");

        cmd = DL_RSDCommand(query);

        cmd.AddParam(m_CurrInvestor);
        cmd.AddParam(m_EndDate);

        DataSet = cmd.Execute();
        if(DataSet.moveNext())
          CheckDate = date(DataSet.MaxObjDate);
        end;

      elif(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_ONB)
        txobj_str = string(TXOBJ_PLUSG_2800) + ", " + TXOBJ_PLUSG_4800;
      end;

      var СуммаСНОБ = GetAmountSNOBfromStor(TaxBaseKind, CheckDate);

      DL_GetNPTXOBJSumByClient(m_CurrInvestor,
                               txobj_str,
                               m_BeginDate,
                               m_EndDate,
                               null,
                               null,
                               @СуммаНОБ,
                               null,
                               null,
                               true,
                               GetForDepoCond(false) + IIF(TaxBaseKind == NPTXTOTALBASE_TAXBASEKIND_IIS, "", " and obj.t_Technical = 'X' "),  //Только технические
                               NULL,
                               NULL,
                               false  //Исключить технические = нет (т.е. включить технические)
                              );

      if(СуммаНОБ != 0)
        CreateTaxRatesBySNOB(m_CurrInvestor,
                             m_TaxPeriod,
                             TaxBaseKind,
                             СуммаНОБ,
                             СуммаСНОБ,
                             m_EndDate
                            );

        query = " select NVL(SUM(t_BaseSum),0) AllBaseSum from dnptxtaxbaseranges_tmp where t_TaxRate = ? order by t_range asc ";
        cmd = DL_RSDCommand(query);
        cmd.AddParam(TaxRate);

        DataSet = cmd.Execute();
        if(DataSet.moveNext())
          НОБ_ПОНС = money(DataSet.AllBaseSum);
        end;
      end;
    end;

    return money(НОБ_ПОНС);
  END;

  PRIVATE MACRO CalcTaxBase(CalcType:integer, TaxRate:integer):money
    var TaxBase = $0;
    var CurrentPayment = $0;
    var НОБ_ПОНС       = $0;

    if(CalcType == CALCTYPE_SEC)
      if(m_CurrIIS == 0)
        
        CurrentPayment = GetCurrentPayment(NPTXTOTALBASE_TAXBASEKIND_BROK, TaxRate);
        НОБ_ПОНС       = ПолучитьНОБ_ПОНС(NPTXTOTALBASE_TAXBASEKIND_BROK, TaxRate);
        
        TaxBase = CurrentPayment + НОБ_ПОНС;
      else

        НОБ_ПОНС       = ПолучитьНОБ_ПОНС(NPTXTOTALBASE_TAXBASEKIND_IIS, TaxRate);

        TaxBase = НОБ_ПОНС;
      end;
    elif(CalcType == CALCTYPE_DEPO)

      TaxBase = GetTaxBaseDEPO(TaxRate);

    elif(CalcType == CALCTYPE_ONB)
      if(m_CurrIIS == 0)
        CurrentPayment = GetCurrentPayment(NPTXTOTALBASE_TAXBASEKIND_ONB, TaxRate);
        НОБ_ПОНС       = ПолучитьНОБ_ПОНС(NPTXTOTALBASE_TAXBASEKIND_ONB, TaxRate);
      
        TaxBase = CurrentPayment + НОБ_ПОНС;
      end;
    end;

    return money(TaxBase);
  END;

  MACRO TaxBaseAll(CalcType:integer):money
    return this.TaxBase_13(CalcType) + this.TaxBase_15(CalcType) + this.TaxBase_18(CalcType) + this.TaxBase_20(CalcType) + this.TaxBase_22(CalcType);
  END;

  MACRO TaxBase_13(CalcType:integer):money
    var TaxBase_13 = NULL;
    var TaxRate = 100*IIF(this.ClientStatus() == CL_STATE_RES, NPTXGENTAXRATE_RESIDENT, NPTXGENTAXRATE_NOTRESIDENT);

    if(CalcType == CALCTYPE_SEC)
      TaxBase_13 = m_TaxBase_13;
    elif(CalcType == CALCTYPE_DEPO)
      TaxBase_13 = m_TaxBase_13_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      TaxBase_13 = m_TaxBase_13_ONB;
    end;

    if(TaxBase_13 == NULL)
      TaxBase_13 = CalcTaxBase(CalcType, TaxRate);
    end;

    if(CalcType == CALCTYPE_SEC)
      m_TaxBase_13 = TaxBase_13;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxBase_13_DEPO = TaxBase_13;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxBase_13_ONB = TaxBase_13;
    end;

    return TaxBase_13;
  END;

  MACRO TaxBase_15(CalcType:integer):money
    var TaxBase_15 = NULL;
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_15;

    if(CalcType == CALCTYPE_SEC)
      TaxBase_15 = m_TaxBase_15;
    elif(CalcType == CALCTYPE_DEPO)
      TaxBase_15 = m_TaxBase_15_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      TaxBase_15 = m_TaxBase_15_ONB;
    end;

    if(TaxBase_15 == NULL)
      TaxBase_15 = CalcTaxBase(CalcType, TaxRate);
    end;

    if(CalcType == CALCTYPE_SEC)
      m_TaxBase_15 = TaxBase_15;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxBase_15_DEPO = TaxBase_15;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxBase_15_ONB = TaxBase_15;
    end;

    return TaxBase_15;
  END;

  MACRO TaxBase_18(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_18;

    if(CalcType == CALCTYPE_ONB)

      if(m_TaxBase_18_ONB == NULL)
        m_TaxBase_18_ONB = CalcTaxBase(CalcType, TaxRate);
      end;
      
      return m_TaxBase_18_ONB;
    end;

    return $0;
  END;

  MACRO TaxBase_20(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_20;

    if(CalcType == CALCTYPE_ONB)

      if(m_TaxBase_20_ONB == NULL)
        m_TaxBase_20_ONB = CalcTaxBase(CalcType, TaxRate);
      end;
      
      return m_TaxBase_20_ONB;
    end;

    return $0;
  END;

  MACRO TaxBase_22(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_22;

    if(CalcType == CALCTYPE_ONB)

      if(m_TaxBase_22_ONB == NULL)
        m_TaxBase_22_ONB = CalcTaxBase(CalcType, TaxRate);
      end;
      
      return m_TaxBase_22_ONB;
    end;

    return $0;
  END;

  
  MACRO TaxDueYear_13(CalcType:integer):money
    return round(this.TaxBase_13(CalcType) * this.RG, 0);
  END;

  MACRO TaxDueYear_15(CalcType:integer):money
    return round(this.TaxBase_15(CalcType) * this.RP, 0);
  END;

  MACRO TaxDueYear_18(CalcType:integer):money
    return round(this.TaxBase_18(CalcType) * this.R18, 0);
  END;

  MACRO TaxDueYear_20(CalcType:integer):money
    return round(this.TaxBase_20(CalcType) * this.R20, 0);
  END;

  MACRO TaxDueYear_22(CalcType:integer):money
    return round(this.TaxBase_22(CalcType) * this.R22, 0);
  END;

  MACRO TaxDueYear(SecType:integer):money
    return this.TaxDueYear_13(SecType) + this.TaxDueYear_15(SecType) + this.TaxDueYear_18(SecType) + this.TaxDueYear_20(SecType) + this.TaxDueYear_22(SecType);
  END;

  PRIVATE MACRO GetTaxPaidBySNOB_DEPO(Rate:integer):money
    var query, cmd, DataSet;
    var TaxPaid = $0;
    var TaxBaseKind = "";

    if(SET_CHAR == m_ByDepo)
      if(m_CurrIIS != 0)
        TaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_IIS);
      else
        if(РАБОТА_В_РЕЖИМЕ_СНОБ() == true)
          TaxBaseKind = NPTXTOTALBASE_TAXBASEKIND_ONB+","+NPTXTOTALBASE_TAXBASEKIND_BROK+", 0";
        else
          TaxBaseKind = string(NPTXTOTALBASE_TAXBASEKIND_BROK);
        end;
      end;

      cmd = DL_RSDCommand();

      query =   " select NVL(SUM(t_NdflKeepAmount), 0) as SumNdflKeepAmount "
              + "   from dnptxtbext_dbt "
              + "  where t_ClientID = ? "
              + "    and t_TaxBaseKind IN ("+TaxBaseKind+")"
              + "    and t_NdflKeepRate = ? ";

      cmd.AddParam(m_CurrInvestor);
      cmd.AddParam(Rate);

      if(this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR)
        query = query + " and t_TaxPeriod = ? ";
        cmd.AddParam(m_TaxPeriod);
      else
        query = query + " and t_IncDate BETWEEN ? and ? "
                      + " and t_TaxPeriod = ? ";
      
        cmd.AddParam(m_BeginDate);
        cmd.AddParam(m_EndDate);
        cmd.AddParam(m_TaxPeriod);
      end;

      DataSet = cmd.Execute(query);
      if(DataSet.moveNext())
        TaxPaid = money(DataSet.SumNdflKeepAmount);
      end;

      if(this.ReportType() == DL_TXHOLD_OPTYPE_ENDYEAR)
        cmd = DL_RSDCommand();

        query =   " select NVL(SUM(t_HoldPITax), 0) as SumHoldPITax "
                + "   from dnptxtotalbase_dbt "
                + "  where t_ClientID = ? "
                + "    and t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                + "    and t_TaxBaseKind IN ("+TaxBaseKind+")"
                + "    and t_RateHoldPITax = ? "
                + "    and instr(UPPER(t_Description), UPPER('Диасофт')) <> 0"
                + "    and t_TaxPeriod = ? ";

        cmd.AddParam(m_CurrInvestor);
        cmd.AddParam(Rate);
        cmd.AddParam(m_TaxPeriod);

        DataSet = cmd.Execute(query);
        if(DataSet.moveNext())
          TaxPaid = TaxPaid + money(DataSet.SumHoldPITax);
        end;
      end;
    end;

    return money(TaxPaid);
  END;

  PRIVATE MACRO CalcTaxPaid(CalcType:integer, TaxRate:integer):money
    var TaxPaid = $0;

    if(CalcType == CALCTYPE_DEPO)
      TaxPaid = GetTaxPaidBySNOB_DEPO(TaxRate);
    else
      var strNPTXObjKinds = "";
      var strNPTXObjMatKinds = "";
      var strNPTXObjAnalitic2 = "";
      var query, cmd, DataSet;
    
      if(CalcType == CALCTYPE_SEC)
        if(m_CurrIIS)
          if(TaxRate == (100*IIF(this.ClientStatus() == CL_STATE_RES, NPTXGENTAXRATE_RESIDENT, NPTXGENTAXRATE_NOTRESIDENT)))
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_IIS);
            strNPTXObjMatKinds = string(TXOBJ_PAIDMATERIAL);
            strNPTXObjAnalitic2 = "201";
          else
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_15_IIS);
            strNPTXObjMatKinds = string(TXOBJ_PAIDMATERIAL);
            strNPTXObjAnalitic2 = "218,224";
          end;
        else
          if(TaxRate == (100*IIF(this.ClientStatus() == CL_STATE_RES, NPTXGENTAXRATE_RESIDENT, NPTXGENTAXRATE_NOTRESIDENT)))
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL);
            strNPTXObjMatKinds = string(TXOBJ_PAIDMATERIAL);
            strNPTXObjAnalitic2 = "201";
          else
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_15_2);
            strNPTXObjMatKinds = string(TXOBJ_PAIDMATERIAL);
            strNPTXObjAnalitic2 = "218,224";
          end;
        end;
      elif(CalcType == CALCTYPE_ONB)
        if(m_CurrIIS == 0)
          if(TaxRate == (100*IIF(this.ClientStatus() == CL_STATE_RES, NPTXGENTAXRATE_RESIDENT, NPTXGENTAXRATE_NOTRESIDENT)))
            strNPTXObjKinds = string(TXOBJ_PAIDBILL);
          elif(TaxRate == 100*NPTXGENTAXRATE_RESIDENT_15)
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_15_9);
          elif(TaxRate == 100*NPTXGENTAXRATE_RESIDENT_18)
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_18_9);
          elif(TaxRate == 100*NPTXGENTAXRATE_RESIDENT_20)
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_20_9);
          elif(TaxRate == 100*NPTXGENTAXRATE_RESIDENT_22)
            strNPTXObjKinds = string(TXOBJ_PAIDGENERAL_22_9);
          end;
        end;
      end;

      if(strNPTXObjKinds != "")

        cmd = DL_RSDCommand();
        
        query =   " select COALESCE(SUM(obj.t_Sum0), 0) as TaxPaidSum "
                + "   from dnptxobj_dbt obj "
                + "  where obj.t_Client = " + cmd.AddParam(m_CurrInvestor)
                + "    and obj.t_Kind IN ("+strNPTXObjKinds+")"
                + "    and obj.t_TaxPeriod = " + cmd.AddParam(m_TaxPeriod)
                + IIF(m_Include_Tech == UNSET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical is null) ", "")
                + "    and obj.t_OutSystCode != 'ДЕПО' "
                + "    and obj.t_OutSystCode != 'DEPO' ";

        if(m_EndDate != date(31,12,m_TaxPeriod))
          query = query + " and obj.t_Date between "+cmd.AddParam(m_BeginDate)+" and " + cmd.AddParam(m_EndDate)
        end;

        if ((strNPTXObjMatKinds != "") and (strNPTXObjAnalitic2 != ""))
          query = " select sum(TaxPaidSum) as TaxPaidSum "
                + "   from ( "
                + query
                + " union all "
                + " select COALESCE(SUM(obj.t_Sum0), 0) as TaxPaidSum "
                + "   from dnptxobj_dbt obj "
                + "  where obj.t_Client = " + cmd.AddParam(m_CurrInvestor)
                + "    and obj.t_Kind IN ("+strNPTXObjMatKinds+")"
                + "    and obj.t_analitic2 IN ("+strNPTXObjAnalitic2+")"
                + "    and obj.t_TaxPeriod = " + cmd.AddParam(m_TaxPeriod)
                + IIF(m_Include_Tech == UNSET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical is null) ", "")
                + "    and obj.t_OutSystCode != 'ДЕПО' "
                + "    and obj.t_OutSystCode != 'DEPO' ";

          if(m_EndDate != date(31,12,m_TaxPeriod))
            query = query + " and obj.t_Date between "+cmd.AddParam(m_BeginDate)+" and " + cmd.AddParam(m_EndDate)
          end;

          query = query + " ) subq ";
        end;

        DataSet = cmd.Execute(query);

        if(DataSet.moveNext())
          TaxPaid = money(DataSet.TaxPaidSum);
        end;
      end;
    end;

    return round(TaxPaid, 0);
  END;

  /*Сумма налога, удержанная налоговым агентом в течение года*/
  MACRO TaxPaid_All(CalcType:integer):money
    return this.TaxPaid(CalcType) + this.TaxPaid_15(CalcType) + this.TaxPaid_18(CalcType) + this.TaxPaid_20(CalcType) + this.TaxPaid_22(CalcType);
  END;


  MACRO TaxPaid(CalcType:integer):money
    var TaxRate = 100*IIF(this.ClientStatus() == CL_STATE_RES, NPTXGENTAXRATE_RESIDENT, NPTXGENTAXRATE_NOTRESIDENT);
    var TaxPaid = NULL;


    if(CalcType == CALCTYPE_SEC)
      TaxPaid = m_TaxPaid;
    elif(CalcType == CALCTYPE_DEPO)
      TaxPaid = m_TaxPaid_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      TaxPaid = m_TaxPaid_ONB;
    end;

    if(TaxPaid == NULL)
      TaxPaid = CalcTaxPaid(CalcType, TaxRate);
    end;

    if(CalcType == CALCTYPE_SEC)
      m_TaxPaid = TaxPaid;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxPaid_DEPO = TaxPaid;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxPaid_ONB = TaxPaid;
    end;

    return TaxPaid;
  END;

  MACRO TaxPaid_15(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_15;
    var TaxPaid_15 = NULL;

    if(CalcType == CALCTYPE_SEC)
      TaxPaid_15 = m_TaxPaid_15;
    elif(CalcType == CALCTYPE_DEPO)
      TaxPaid_15 = m_TaxPaid_15_DEPO;
    elif(CalcType == CALCTYPE_ONB)
      TaxPaid_15 = m_TaxPaid_15_ONB;
    end;

    if(TaxPaid_15 == NULL)
      TaxPaid_15 = CalcTaxPaid(CalcType, TaxRate);
    end;

    if(CalcType == CALCTYPE_SEC)
      m_TaxPaid_15 = TaxPaid_15;
    elif(CalcType == CALCTYPE_DEPO)
      m_TaxPaid_15_DEPO = TaxPaid_15;
    elif(CalcType == CALCTYPE_ONB)
      m_TaxPaid_15_ONB = TaxPaid_15;
    end;

    return TaxPaid_15;
  END;

  MACRO TaxPaid_18(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_18;

    if(CalcType == CALCTYPE_ONB)
      if(m_TaxPaid_18_ONB == NULL)
        m_TaxPaid_18_ONB = CalcTaxPaid(CalcType, TaxRate);
      end;

      return m_TaxPaid_18_ONB;
    end;

    return $0;
  END;

  MACRO TaxPaid_20(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_20;

    if(CalcType == CALCTYPE_ONB)
      if(m_TaxPaid_20_ONB == NULL)
        m_TaxPaid_20_ONB = CalcTaxPaid(CalcType, TaxRate);
      end;

      return m_TaxPaid_20_ONB;
    end;

    return $0;
  END;

  MACRO TaxPaid_22(CalcType:integer):money
    var TaxRate = 100*NPTXGENTAXRATE_RESIDENT_22;

    if(CalcType == CALCTYPE_ONB)
      if(m_TaxPaid_22_ONB == NULL)
        m_TaxPaid_22_ONB = CalcTaxPaid(CalcType, TaxRate);
      end;

      return m_TaxPaid_22_ONB;
    end;

    return $0;
  END;

  MACRO TaxDueNow1_all(CalcType:integer):money
    return this.TaxDueNow1(CalcType) + this.TaxDueNow1_15(CalcType) + this.TaxDueNow1_18(CalcType) + this.TaxDueNow1_20(CalcType) + this.TaxDueNow1_22(CalcType);
  END;

  MACRO TaxDueNow1(CalcType:integer):money
    return this.TaxDueYear_13(CalcType) - this.TaxPaid(CalcType);
  END;

  MACRO TaxDueNow1_15(CalcType:integer):money
    return this.TaxDueYear_15(CalcType) - this.TaxPaid_15(CalcType);
  END;

  MACRO TaxDueNow1_18(CalcType:integer):money
    return this.TaxDueYear_18(CalcType) - this.TaxPaid_18(CalcType);
  END;

  MACRO TaxDueNow1_20(CalcType:integer):money
    return this.TaxDueYear_20(CalcType) - this.TaxPaid_20(CalcType);
  END;

  MACRO TaxDueNow1_22(CalcType:integer):money
    return this.TaxDueYear_22(CalcType) - this.TaxPaid_22(CalcType);
  END;

  MACRO ClearData()
    var query, del;

    query = "DELETE FROM DNPTXSHORT_TOTALCALC_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_REALIZ_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_LUCRE_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_SHORTPOS_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_REPO_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_INVEST_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_PFIEXCHANGE_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_PFIOUTEXCHANGE_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_BILL_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

    query = "DELETE FROM DNPTXSHORT_PROTOCOL_DBT WHERE T_GUID = ?";
    del = DL_RSDCommand(query);
    del.AddParam(m_GUID);

    del.ExecuteCMD();

  END;


  //Старт
  MACRO Create()
    var query, DataSet, cmd;
    var stat = 0;
    var Year = 0;
    var cnt = 0, i = 0;

    if(LoadRepParam() == false)
      return 1;
    end;

    m_ContractIDsStr = "";

    if(m_DlContrID > 0)
      cmd = DL_RSDCommand();

      query =   " select mp.t_SfContrID, sf.t_Number "
              + "   from ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sf "
              + "  where mp.t_DlContrID = " + cmd.AddParam(m_DlContrID)
              + "    and dlc.t_DlContrID = mp.t_DlContrID "
              + "    and sf.t_ID = dlc.t_SfContrID ";

      DataSet = cmd.Execute(query);
      while(DataSet.moveNext())
        m_ContractIDsStr = m_ContractIDsStr + IIF(m_ContractIDsStr != "", ",", "") + string(int(DataSet.SfContrID));
        m_ContractNumber = DataSet.Number;
      end;
    end;

    cmd = DL_RSDCommand();

    query =   " SELECT q.InvestorName, q.Investor, q.InvestorFIO "
            + "   FROM ( SELECT pt.t_PartyID as Investor, "
            + "                 trim( pt.t_Name ) as InvestorName, "
            + "                 trim(persn.t_Name1) "
            + "                  || case when(persn.t_Name2 = CHR(1))then '' else SUBSTR (persn.t_Name2, 1, 1) end"
            + "                  || case when(persn.t_Name3 = CHR(1))then '' else SUBSTR (persn.t_Name3, 1, 1) end as InvestorFIO "
            + "            FROM dpersn_dbt persn, dparty_dbt pt "
            + "           WHERE pt.t_PartyID = " + cmd.AddParam(m_CurrInvestor)
            + "             AND persn.t_PersonID = pt.t_PartyID "
            + "        ) q "
            + " ORDER BY q.InvestorName, q.Investor ASC";
    
    cnt = cmd.GetCount(query);
    if(cnt > 0)
      InitProgress( cnt, "Краткая справка по расчету НДФЛ", "Краткая справка по расчету НДФЛ" );

      DataSet = cmd.Execute(query);
      stat = DataSet.moveNext();
      while(stat)

        m_CurrIIS = IIF(m_ByIIS, 1, 0);
        m_CurrInvestor = int(DataSet.Investor);
        m_CurrInvestorName = string(DataSet.InvestorName);
        m_InvestorFIO = string(DataSet.InvestorFIO);
        m_CurrInvestorSheetName = IIF(m_ByIIS, "ИИС", "")+m_InvestorFIO;

        TXOBJ_BASEG_2_3_9.size = 0;
        if(this.ClientStatus() == CL_STATE_RES)
          TXOBJ_BASEG_2_3_9(0) = TXOBJ_BASEG2;
          TXOBJ_BASEG_2_3_9(1) = TXOBJ_BASEG3;
          TXOBJ_BASEG_2_3_9(2) = TXOBJ_BASEG9;
        else
          TXOBJ_BASEG_2_3_9(0) = TXOBJ_BASEGENERAL;
          TXOBJ_BASEG_2_3_9(1) = TXOBJ_BASEBILL;
        end;
        
        DateSplit( this.RepDend(), null, null, Year );
        if ((m_CurrIIS == 1) and ((m_ReportType == DL_TXHOLD_OPTYPE_CLOSE) or (m_ReportType == DL_TXHOLD_OPTYPE_ENDYEAR)))
          m_BeginDate = GetFirstDateIIS(int(DataSet.Investor), m_DlContrID);
        else
          m_BeginDate = Date(1,1,Year);
        end;

        
        stat = DataSet.moveNext();

        //Общий расчет
        CreateTotalCalc();

        if(SET_CHAR == m_NeedRealizList)
          CreateRealizRep();
        end;

        if(SET_CHAR == m_NeedShortPosList)
          CreateShortPosRep();
        end;
        
        if(SET_CHAR == m_NeedRepoList)
          CreateRepoRep();
        end;

        if((m_ReportType == DL_TXHOLD_OPTYPE_ENDYEAR) or (m_ReportType == DL_TXHOLD_OPTYPE_CLOSE) or (m_ReportType == DL_TXHOLD_OPTYPE_OUTMONEY))
          CerateInvestDedRep();
        end;

        if(SET_CHAR == m_NeedLucreList)
          CreateReportNPTXLucre();
        end;

        if(SET_CHAR == m_NeedPFIList)
          CreateReportPFIExchange();
          CreateReportPFIOutExchange();
        end;

        if(SET_CHAR == m_NeedBillList)
          CreateReportBill();
        end;

        if(SET_CHAR == m_NeedProtocolList)
          CreateProtocol();
        end;

        UseProgress(i = i + 1);
      end;

      RemProgress();
    else
      SetActiveSheet( "Справка по расчету НДФЛ" );  
      PrintFormatString( NULL,"N1_NoRepData","Нет данных, удовлетворяющих параметрам отчета");
      CopyAllSheetInTotalBook( "Справка по расчету НДФЛ", false, "N1_NoRepData", 0 );
    end;

  END;

 
  MACRO ClearCacheOneRecord()
    this.ClearCacheOneRecord();
    m_DZS         = null;
    m_PrSRub      = null;
    m_AllSrub     = null;
    m_AllSrub_l   = null;
    m_DifS        = null;
    m_ComBankS    = null;
    m_ComExcS     = null;
    m_ComS        = null;      
    m_DZB         = null;    
    m_PrBrub      = null;
    m_AllBrub     = null;
    m_AllBrub_l   = null;
    m_MaterialB   = null;
    m_TaxMaterialB= null;
    m_Material    = null;
    m_DifB        = null;
    m_ComBankB    = null;
    m_ComExcB     = null;
    m_ComB        = null;
    m_TaxFRlink   = null;    
    m_TaxTags     = null;
    m_Qnty        = null;
    m_FRrub       = null;
    m_TaxLink     = null;
  END;

  /*Начало отчетного периода - 1 января года отчетной даты, указанной в форме запуска отчета*/
  MACRO RepDbeg()                                                                
    VAR Year;
    DateSplit( this.RepDend(), null, null, Year );
    return date(1,1,Year); 
  END;
 
  /*Окончание отчетного периода*/
  MACRO RepDend()
    return m_EndDate; 
  END;

  /*Количество, проданное в этой сделке продажи, из этой покупки*/
  MACRO Qnty(IsMaterial)
    if(m_Qnty == null)
      if(IsMaterial == NULL)
         IsMaterial = false;
      end;

      if(IsMaterial)
         m_Qnty = this.Qnty();
      else
         m_Qnty = m_RS.Qnty;
      end;
    end;
    return m_Qnty;
  END;

  MACRO ЭтоВиртПокупка()
     return (m_RS.BuyIsVirtual == 1);
  END;

  MACRO ЭтоВиртПродажа()
     return (m_RS.SaleIsVirtual == 1);
  END;

  MACRO ContractS()
    return m_RS.ContractS;
  END;

   /*Дата оплаты сделки продажи*/
  MACRO DPS()
    if(m_RS.IsRepayCoup != 0)
      return this.DZS();
    end;

    if( ЭтоВиртПродажа() )/*для виртуальных*/
       return SQL_ConvTypeDate(m_RS.SaleDate);
    end;
    return  SQL_ConvTypeDate(m_RS.SalePayDate);
  END;

  /*Цена сделки продажи*/
  MACRO PrSrub()

    if( IsRET_ISSUE( Int(m_RS.SaleGroup) ) )
       m_PrSRub = m_RS.NominalAVROnS;

       if(m_RS.FaceValueFI != NATCUR)
          SmartConvertSumDbl(m_PrSRub, m_PrSRub, this.DPS(), m_RS.FaceValueFI, NATCUR, false);
       end;

    elif( (IsRET_PARTLY( Int(m_RS.SaleGroup) )) or (IsRET_COUPON( Int(m_RS.SaleGroup) )) or (m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
       m_PrSRub = "";
    elif( ЭтоВиртПродажа() )/*для виртуальных берем из лота*/

       m_PrSRub = m_RS.SalePrice;

       if(m_RS.VpS != NATCUR)
          SmartConvertSumDbl(m_PrSRub, m_PrSRub, this.DPS(), m_RS.VpS, NATCUR, false);
       end;

    else

       if(m_RS.VpS == NATCUR)
          m_PrSRub = GetPriceByDlTickDlLeg(this.DealSale().rec, this.LegSale().rec, null, null, m_RS.SaleDate);
       else    
          SmartConvertSumDbl(m_PrSRub, GetPriceByDlTickDlLeg(this.DealSale().rec, this.LegSale().rec, null, null, m_RS.SaleDate), this.DPS(), m_RS.VpS, NATCUR, false);
       end;                                                                                     

    end;

    return m_PrSRub;
  END;

  private macro GetReplLnkParm(LnkID, PLnkDate:date, Code:string, WrtOpAmount:@variant, TakeAmount:@variant, TakeSum:@money)
    var query, cmd, DataSet;

    WrtOpAmount = 0;
    TakeAmount = 0;
    TakeSum    = 0;
    
    query =   " select T.t_Amount1 "
            + "   from DNPTXOP1OPLNK_TMP T, dnptxlnk_dbt PLnk "
            + "  where T.t_DocID = ? "
            + "    and PLnk.t_ID = T.t_Parent_DocID"
            + "    and PLnk.t_Date = ?";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(LnkID);
    cmd.AddParam(PLnkDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      WrtOpAmount = DataSet.Amount1;
    end;
    
    query =   " select NVL(SUM(T.t_Amount), 0) as TakeAmount, "
            + "        NVL(SUM(T.t_Sum), 0) as TakeSum "
            + "   from DNPTXSHSUM_TMP T, dnptxlnk_dbt PLnk"
            + "  where T.t_DocID = ? "
            + "    and T.t_Code = ? "
            + "    and PLnk.t_ID = T.t_Parent_DocID"
            + "    and PLnk.t_Date = ?";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(LnkID);
    cmd.AddParam(Code);
    cmd.AddParam(PLnkDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      TakeAmount = DataSet.TakeAmount;
      TakeSum    = DataSet.TakeSum;  
    end;
  end;

  private macro AddRepLnkParm(LnkID:integer, PLnkID:integer, Code:string, Amount:money, Sum:money)
    var query =   " INSERT INTO DNPTXSHSUM_TMP (T_DOCID, T_PARENT_DOCID, T_CODE, T_AMOUNT, T_SUM) VALUES(?,?,?,?,?)";

    var cmd = DL_RSDCommand(query);             

    cmd.AddParam(LnkID);
    cmd.AddParam(PLnkID);
    cmd.AddParam(Code);
    cmd.AddParam(Amount);
    cmd.AddParam(Sum);

    cmd.ExecuteCMD();
  end;

  /*Сумма сделки продажи включая НКД*/
  MACRO AllSrub()
    if (m_AllSrub == null)
       if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
         m_AllSrub = m_RS.SalePrice;
       elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
         var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                            " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

         if(m_ContractIDsStr != "")
           AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
         end;

         m_AllSrub = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MAINS_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
       elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
          if(m_RS.VpS == NATCUR)
            m_AllSRub = m_RS.SalePrice;
          else
            SmartConvertSumDbl(m_AllSRub, m_RS.SalePrice, this.DPS(), m_RS.VpS, NATCUR, false);
          end;
       elif(m_RS.LinkID >  0)
          var StartDate  = m_BeginDate;
          var FinishDate = m_EndDate;
          var WrtOpAmount = 0;
          var TakeAmount = 0;
          var TakeSum   = 0;

          if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
            StartDate = FinishDate = date(m_RS.PLnkDate);

            GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "AllSrub", @WrtOpAmount, @TakeAmount, @TakeSum);
          end;

          DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                                 string(TXOBJ_MAINS) + ", " + string(TXOBJ_NKDS) + ", "+ string(TXOBJ_MAINS_SHORT) + ", " + string(TXOBJ_NKDS_SHORT),
                                 StartDate, 
                                 FinishDate, 
                                 TXOBJ_DIR_ALL, 
                                 null, 
                                 @m_AllSrub, null, true,
                                 IIF(m_Include_Tech != SET_CHAR, true, false)
                                );
          
          if(m_RS.IsSaleRepl_BuyBef01032024)
            if((WrtOpAmount - TakeAmount) == m_RS.Qnty)
              m_AllSrub = m_AllSrub - TakeSum;
            else
              m_AllSrub = round(m_AllSrub*(TakeAmount + m_RS.Qnty)/WrtOpAmount,2) - TakeSum;
            end;

            if(GenPropID(m_RS,"PLnkID") != -1)
              AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "AllSrub", m_RS.Qnty, m_AllSrub);
            end;
          end;

       else
          if(m_RS.VpS == NATCUR)
            m_AllSRub = m_RS.SalePrice;
          else
            SmartConvertSumDbl(m_AllSRub, m_RS.SalePrice, this.DPS(), m_RS.VpS, NATCUR, false);
          end;
       end;
    end;
    return m_AllSRub;
  END;

  MACRO AllSrub_L()
    if (m_AllSrub_l == null)
      if(m_RS.LinkID >  0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                               string(TXOBJ_MAINS) + ", " + string(TXOBJ_MAINS_SHORT),
                               m_BeginDate,
                               m_EndDate,
                               TXOBJ_DIR_ALL,
                               null,
                               @m_AllSrub_l, null, true,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
      else
        if(m_RS.VpS == NATCUR)
          m_AllSrub_l = m_RS.SalePrice;
        else
          SmartConvertSumDbl(m_AllSrub_l, m_RS.SalePrice, this.DPS(), m_RS.VpS, NATCUR, false);
        end;
      end;
    end;
    return m_AllSrub_l;
  END;

  /*Сумма отклонения от рынка сделки продажи*/
  MACRO DifS()
    if( m_DifS == null )
      if( (IsRET_PARTLY( Int(m_RS.SaleGroup) )) or (IsRET_COUPON( Int(m_RS.SaleGroup) )) or (m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
         m_DifS = $0;
      else
         DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                                string(TXOBJ_DIFS)+","+string(TXOBJ_DIFS_SHORT), 
                                m_BeginDate, 
                                m_EndDate, 
                                TXOBJ_DIR_ALL, 
                                null, 
                                @m_DifS, null, true,
                                IIF(m_Include_Tech != SET_CHAR, true, false)
                               );
       end;
    end;
    return m_DifS;
  END;

  /*Комиссия банка для сделки продажи*/
  MACRO ComBankS()
    VAR pSum = $0, pNDS = $0; 
    if( m_ComBankS == null )/*если связь с виртуальной покупкой, то сумму комиссии по продаже не выводим*/ 
      m_ComBankS = $0;
      if((m_RS.IsRepayCoup == 0) and (m_RS.IsBuyCoup == 0))
        if(not ЭтоВиртПокупка())
          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.SBOfficeKind, m_RS.DealSaleID, null, date(0,0,0), m_EndDate, 1, 0,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                        null,null,null, false );
          if (m_RS.LinkID > 0)
            var WrtOpAmount = 0;
            var TakeAmount = 0;
            var TakeSum   = 0;

            if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
              GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "ComBankS", @WrtOpAmount, @TakeAmount, @TakeSum);
            end;
            
            if(m_RS.IsSaleRepl_BuyBef01032024)
              if((m_RS.SPrincipal - TakeAmount) == m_RS.Qnty)
                m_ComBankS = pSum - TakeSum;
              else
                m_ComBankS = round(pSum*(TakeAmount + m_RS.Qnty)/m_RS.SPrincipal,2) - TakeSum;
              end;

              if(GenPropID(m_RS,"PLnkID") != -1)
                AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "ComBankS", m_RS.Qnty, m_ComBankS);
              end;
            else
              m_ComBankS = pSum * m_RS.Qnty/m_RS.SPrincipal;
            end;
          else
            m_ComBankS = pSum;
          end;
        end;
      end;
    end;
     
    return m_ComBankS;
  END;

  /*Комиссия биржи сделки продажи*/
  MACRO ComExcS()
    VAR pSum = $0, pNDS = $0; 
    if( m_ComExcS == null )/*если связь с виртуальной покупкой, то сумму комиссии по продаже не выводим*/
      m_ComExcS = $0;
      if((m_RS.IsRepayCoup == 0) and (m_RS.IsBuyCoup == 0))
        if( not ЭтоВиртПокупка() )
          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.SBOfficeKind, m_RS.DealSaleID, null, date(0,0,0), m_EndDate, 0, 1,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                          null,null,null, false );

          if (m_RS.LinkID > 0) 
            var WrtOpAmount = 0;
            var TakeAmount = 0;
            var TakeSum   = 0;

            if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
              GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "ComExcS", @WrtOpAmount, @TakeAmount, @TakeSum);
            end;
            
            if(m_RS.IsSaleRepl_BuyBef01032024)
              if((m_RS.SPrincipal - TakeAmount) == m_RS.Qnty)
                m_ComExcS = pSum - TakeSum;
              else
                m_ComExcS = round(pSum*(TakeAmount + m_RS.Qnty)/m_RS.SPrincipal,2) - TakeSum;
              end;

              if(GenPropID(m_RS,"PLnkID") != -1)
                AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "ComExcS", m_RS.Qnty, m_ComExcS);
              end;
            else
              m_ComExcS = pSum * m_RS.Qnty/m_RS.SPrincipal;
            end;
            
          else
            m_ComExcS = pSum;
          end;
        end;
      end;
    end;
     
    return m_ComExcS;

  END;

  /*Всего комиссий сделки продажи*/
  MACRO ComS()
    var AddWhereCond = "";
    if( m_ComS == null )
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_ComS = $0;
      elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                       " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

        if(m_ContractIDsStr != "")
           AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
         end;

        m_ComS = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COMS_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        if( m_Rs.CouponNDFL == SET_CHAR )/*тут непонятно пока, т.к. в реализации на сегодня для операции погашения купонов TXOBJ_COMS_TS не рассчитывается*/
           AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1050+" and obj.t_Analitic1 = "+m_RS.Number_Coupon +
                          " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

           if(m_ContractIDsStr != "")
             AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
           end;

           m_ComS = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COMS_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
        else
           m_ComS = $0;
        end;
      elif(m_RS.IsSaleRepl_BuyBef01032024)
        m_ComS = this.ComExcS() + this.ComBankS();
      elif (m_RS.LinkID > 0)/*по связи с виртуальными покупками НДР по комиссиям по продажам создаваться не должны (поэтому дополнительные проверки на отбор комиссий не вводим)*/  
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_COMS) + ", " + string(TXOBJ_COMS_SHORT),
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_ComS, null, true,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
      else 
        m_ComS = this.ComExcS() + this.ComBankS();
      end; 
    end;
    return m_ComS;

  END;

  MACRO ContractB()
    return m_RS.ContractB;
  END;

  /*Дата оплаты сделки покупки*/
  MACRO DPB()
    if( ЭтоВиртПокупка() )/*для виртуальных*/
       return SQL_ConvTypeDate(m_RS.BuyDate);
    end;
    return SQL_ConvTypeDate(m_RS.PayBuyDate);
  END;

  /*Цена сделки покупки*/
  MACRO PrBrub()

    if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
      m_PrBRub = $0;
    elif( ЭтоВиртПокупка() )/*для виртуальных берем из лота*/

       m_PrBRub = m_RS.BuyPrice;

       if(m_RS.VpB != NATCUR)
          SmartConvertSumDbl(m_PrBRub, m_PrBRub, this.DPB(), m_RS.VpB, NATCUR, false);
       end;
    elif (m_RS.BBOfficeKind == DL_AVRWRT) 
          if( m_PrBRub == null ) 
              m_PrBRub = $0; 
              if( m_RS.LinkID > 0 )
                  if(m_RS.VpB == NATCUR)
                     m_PrBRub = GetPriceByDlTickDlLeg(this.DealBuy().rec, this.LegBuy().rec, null, null, m_RS.BuyDate); 
                 else    
                     SmartConvertSumDbl(m_PrBRub, GetPriceByDlTickDlLeg(this.DealBuy().rec, this.LegBuy().rec, null, null, m_RS.BuyDate), this.DPB(), m_RS.VpB, NATCUR, false);  
                 end;
              end;
          end;
          if (m_PrBRub == 0)  
              m_PrBRub = m_RS.BuyPrice;

              if(m_RS.VpB != NATCUR)
                 SmartConvertSumDbl(m_PrBRub, m_PrBRub, this.DPB(), m_RS.VpB, NATCUR, false);
              end;
          end;
    else

       if( m_PrBRub == null ) 
         m_PrBRub = $0; 
         if( m_RS.LinkID > 0 )
           if(m_RS.VpB == NATCUR)
              m_PrBRub = GetPriceByDlTickDlLeg(this.DealBuy().rec, this.LegBuy().rec, null, null, m_RS.BuyDate); 
           else    
              SmartConvertSumDbl(m_PrBRub, GetPriceByDlTickDlLeg(this.DealBuy().rec, this.LegBuy().rec, null, null, m_RS.BuyDate), this.DPB(), m_RS.VpB, NATCUR, false);  
           end;
         end;
       end;

    end;

    return m_PrBRub;
  END;
 
  /*Сумма сделки покупки включая НКД*/
  MACRO AllBrub()
    if(m_AllBrub == null)
      m_AllBrub = $0;
      if(m_RS.IsBuyCoup)
        m_AllBrub = m_RS.NkdB_TS;
      elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                           " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

        if(m_ContractIDsStr != "")
          AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
        end;

        m_AllBrub = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MAINB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_AllBrub = $0;
      elif(m_RS.LinkID > 0 )
        var StartDate  = m_BeginDate;
        var FinishDate = m_EndDate;
        var WrtOpAmount = 0;
        var TakeAmount = 0;
        var TakeSum   = 0;

        if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
          StartDate = FinishDate = date(m_RS.PLnkDate);

          GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "AllBrub", @WrtOpAmount, @TakeAmount, @TakeSum);
        end;

        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_MAINB) + ", " + string(TXOBJ_NKDB) + ", " + string(TXOBJ_MAINB_SHORT) + ", " + string(TXOBJ_NKDB_SHORT),
                               StartDate, 
                               FinishDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_AllBrub, null, true,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );

        if(m_RS.IsSaleRepl_BuyBef01032024)
        
          if((WrtOpAmount - TakeAmount) == m_RS.Qnty)
            m_AllBrub = m_AllBrub - TakeSum;
          else
            m_AllBrub = round(m_AllBrub*(TakeAmount + m_RS.Qnty)/WrtOpAmount, 2) - TakeSum;
          end;

          if(GenPropID(m_RS,"PLnkID") != -1)
            AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "AllBrub", m_RS.Qnty, m_AllBrub);
          end;
        end;
      end;
    end;
    return m_AllBRub;
  END;

  MACRO Plusi()
    DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                           string(TXOBJ_PLUSI),
                           m_BeginDate,
                           m_EndDate,
                           TXOBJ_DIR_ALL,
                           @m_Plusi, null, true, 
                           IIF(m_Include_Tech != SET_CHAR, true, false)
                          );
    return m_Plusi;
  END;

  MACRO FR_Sec_3Y()
    DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                           string(TXOBJ_FR_SEC_3Y),
                           m_BeginDate,
                           m_EndDate,
                           TXOBJ_DIR_ALL,
                           @m_FR_Sec_3Y, null, NULL, 
                           IIF(m_Include_Tech != SET_CHAR, true, false)
                          );
    return m_FR_Sec_3Y;
  END;

  MACRO AllBrub_L()
    if(m_AllBrub_l == null)
      m_AllBrub_l = $0;
      if(m_RS.LinkID > 0 )

        DL_GetNPTXOBJSumByLink(m_RS.LinkID,
                               string(TXOBJ_MAINB) + ", " + string(TXOBJ_MAINB_SHORT),
                               m_BeginDate,
                               m_EndDate,
                               TXOBJ_DIR_ALL,
                               null,
                               @m_AllBrub_l, null, true, 
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
      end;
    end;
    return m_AllBRub_l;
  END;

  /*Материальная выгода сделки покупки*/
  MACRO MaterialB()
    if(m_MaterialB == null )
      m_MaterialB = $0;
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_MaterialB = $0;
      elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                           " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

        if(m_ContractIDsStr != "")
          AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
        end;

        m_MaterialB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_MATERIALB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_MaterialB = $0;
      elif(m_RS.LinkID > 0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_MATERIALB), 
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_MaterialB, null, true,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
      end;
    end;
    return m_MaterialB;

  END;

  /*Налог на матвыгоду для сделки покупки*/
  MACRO TaxMaterialB()
    if(m_TaxMaterialB == null )
      m_TaxMaterialB = $0;
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_TaxMaterialB = $0;
      elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
        var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                           " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

        if(m_ContractIDsStr != "")
          AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
        end;

        m_TaxMaterialB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_TAXPM_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_TaxMaterialB = $0;
      elif(m_RS.LinkID > 0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_TAXPM_LINK), 
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_TaxMaterialB, null, true,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
      end;
    end;
    return m_TaxMaterialB;

  END;

  /*Сумма отклонения от рынка для сделки покупки*/
  MACRO DifB()
    if(m_DifB == null)
      m_DifB = $0;
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_DifB = $0;
      elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
         var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                            " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID;

         if(m_ContractIDsStr != "")
           AddWhereCond = AddWhereCond + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
         end;

         m_DifB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_DIFB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        m_DifB = $0;
      elif(m_RS.LinkID > 0)
        DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                               string(TXOBJ_DIFB)+","+string(TXOBJ_DIFB_SHORT), 
                               m_BeginDate, 
                               m_EndDate, 
                               TXOBJ_DIR_ALL, 
                               null, 
                               @m_DifB, null, true,
                               IIF(m_Include_Tech != SET_CHAR, true, false)
                              );
      end;

    end;
    return m_DifB;

  END;

  /*Комиссия банка для сделки покупки*/
  MACRO ComBankB()
    VAR pSum = $0, pNDS = $0;
    VAR Koef = 1, Koef1 = 1;
    if( m_ComBankB == null )/*по виртуальным покупкам не выводим*/
      m_ComBankB = $0;
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_ComBankB = $0;
      elif((m_RS.LinkID > 0 ) and (not ЭтоВиртПокупка()))
        if( (m_RS.AVOIRKIND == AVOIRISSKIND_BOND_OVVZ ) AND (m_RS.DealSaleDate >= date ("01.01.2019")) AND (m_RS.FaceValueFI!= natcur) )
          if ( m_RS.BCourseNominal != 0  )
            Koef = m_RS.SCourseNominal / m_RS.BCourseNominal;
          end;
          if ( (m_RS.BPrincipal * m_RS.NominalAVROnB) != 0 ) //
            Koef1 = ( m_RS.Qnty * m_RS.NominalAVROnS / (m_RS.BPrincipal * m_RS.NominalAVROnB) );
          end;

          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 1, 0,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                        Koef,Koef1, m_RS.SaleDateOVVZ, false); 

          m_ComBankB = pSum;
        else
          if(m_RS.BBOfficeKind == DL_AVRWRT)
            var query, cmd, DataSet;

            query =   " SELECT obj.t_Sum0 " 
                    + "   FROM dnptxobj_dbt obj "
                    + "  WHERE obj.t_AnaliticKind1 = " + TXOBJ_KIND1070
                    + "    AND obj.t_Analitic1 = ? "
                    + IIF(m_Include_Tech != SET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical IS NULL) ", "")
                    + "    AND obj.t_Kind = " + TXOBJ_COM;

            cmd = DL_RSDCommand(query);

            cmd.AddParam(m_RS.DealBuyID);
            DataSet = cmd.Execute();
            if(DataSet.moveNext())
              pSum = money(DataSet.Sum0);
            end;
          else

            SP_GetSumCom( pSum, pNDS, null, null, 
                          m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 1, 0,   
                          1, 0, 1, 1, null, 0, true, null, null, null,
                          null,null,null, false );
          end;
          
          var WrtOpAmount = 0;
          var TakeAmount = 0;
          var TakeSum   = 0;

          if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
            GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "ComBankB", @WrtOpAmount, @TakeAmount, @TakeSum);
          end;
          
          if(m_RS.IsSaleRepl_BuyBef01032024)
            if((m_RS.BPrincipal - TakeAmount) == m_RS.Qnty)
              m_ComBankB = pSum - TakeSum;
            else
              m_ComBankB = round(pSum*(TakeAmount + m_RS.Qnty)/m_RS.BPrincipal,2) - TakeSum;
            end;

            if(GenPropID(m_RS,"PLnkID") != -1)
              AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "ComBankB", m_RS.Qnty, m_ComBankB);
            end;
          else
            m_ComBankB = pSum*m_RS.Qnty/m_RS.BPrincipal;
          end;
        end
      end;
    end;
     
    return m_ComBankB;

  END;

  /*Комиссия биржи для сделки покупки*/
  MACRO ComExcB()
    VAR pSum = $0, pNDS = $0;
    VAR Koef = 1, Koef1 = 1;
    if( m_ComExcB == null )/*по виртуальным покупкам не выводим*/
      m_ComExcB = $0;
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_ComExcB = $0;
      elif((m_RS.LinkID > 0 ) and (not ЭтоВиртПокупка()))
        if( (m_RS.AVOIRKIND == AVOIRISSKIND_BOND_OVVZ ) AND (m_RS.DealSaleDate >= date ("01.01.2019")) AND (m_RS.FaceValueFI!= natcur) )
          if ( m_RS.BCourseNominal != 0  )
            Koef = m_RS.SCourseNominal / m_RS.BCourseNominal;
          end;
          if ( (m_RS.BPrincipal * m_RS.NominalAVROnB) != 0 ) //
            Koef1 = ( m_RS.Qnty * m_RS.NominalAVROnS / (m_RS.BPrincipal * m_RS.NominalAVROnB) );
          end;

          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 0, 1,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                        Koef, Koef1, m_RS.SaleDateOVVZ, false); 
          m_ComExcB = pSum;
        else
          SP_GetSumCom( pSum, pNDS, null, null, 
                        m_RS.BBOfficeKind, m_RS.DealBuyID, null, date(0,0,0), m_EndDate, 0, 1,   
                        1, 0, 1, 1, null, 0, true, null, null, null,
                        null,null,null, false );
        
          var WrtOpAmount = 0;
          var TakeAmount = 0;
          var TakeSum   = 0;

          if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
            GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "ComExcB", @WrtOpAmount, @TakeAmount, @TakeSum);
          end;
          
          if(m_RS.IsSaleRepl_BuyBef01032024)
            if((m_RS.BPrincipal - TakeAmount) == m_RS.Qnty)
              m_ComExcB = pSum - TakeSum;
            else
              m_ComExcB = round(pSum*(TakeAmount + m_RS.Qnty)/m_RS.BPrincipal,2) - TakeSum;
            end;

            if(GenPropID(m_RS,"PLnkID") != -1)
              AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "ComExcB", m_RS.Qnty, m_ComExcB);
            end;
          else
            m_ComExcB = pSum*m_RS.Qnty/m_RS.BPrincipal;
          end;
        end
      end;
    end;
     
    return m_ComExcB;

  END;

  /*Всего комиссий по сделке покупки*/
  MACRO ComB(IsMaterial)
    if(IsMaterial == NULL)
       IsMaterial = false;
    end;

    if( m_ComB == null )/*по связи с виртуальными покупками НДР по комиссиям по покупкам создаваться не должны (поэтому дополнительные проверки на отбор комиссий не вводим)*/  
      if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
        m_ComB = $0;
      elif(IsMaterial)
        m_ComB = m_RS.ComB;
      elif(m_RS.IsSaleRepl_BuyBef01032024)
        m_ComB = this.ComExcB() + this.ComBankB();
      else
        m_ComB = $0;
        if( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )
          m_ComB = $0;
          /*
          var AddWhereCond = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly+
                             " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID; 
          m_ComB = GetRubSumByClient(m_CurrInvestor, string(TXOBJ_COMB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_ALL, m_CurrIIS, true, AddWhereCond, IIF(m_Include_Tech != SET_CHAR, true, false));
          */
        elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
          m_ComB = $0;
        elif(m_RS.LinkID > 0)
          DL_GetNPTXOBJSumByLink(m_RS.LinkID,                        
                                 string(TXOBJ_COMB) + ", " +string(TXOBJ_COMB_SHORT),
                                 m_BeginDate, 
                                 m_EndDate, 
                                 TXOBJ_DIR_ALL, 
                                 null, 
                                 @m_ComB, null, true,
                                 IIF(m_Include_Tech != SET_CHAR, true, false)
                                );
        end;
      end;
    end;
    return m_ComB;
  END;

  MACRO FRrub():MONEY
    var FRrubIn = 0.0, FRrubOut = 0.0;
    if(m_FRrub == NULL)
      DL_GetNPTXOBJSumByLink(m_Rs.LinkID, string(TXOBJ_FR_LINK), NULL, NULL, TXOBJ_DIR_IN, NULL, @FRrubIn, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false));
      DL_GetNPTXOBJSumByLink(m_Rs.LinkID, string(TXOBJ_FR_LINK), NULL, NULL, TXOBJ_DIR_OUT, NULL, @FRrubOut, NULL, NULL, IIF(m_Include_Tech != SET_CHAR, true, false));
      m_FRrub = FRrubIn - FRrubOut;
    end;
    return m_FRrub;
  END;

  MACRO TaxLink():DOUBLE
    if( m_TaxLink == NULL )
       var StartDate  = m_BeginDate;
       var FinishDate = m_EndDate;
       var WrtOpAmount = 0;
       var TakeAmount = 0;
       var TakeSum   = 0;
       var q, sel, DataSet;

       if((m_RS.IsSaleRepl_BuyBef01032024) and (GenPropID(m_RS,"PLnkDate") != -1))
         StartDate = FinishDate = date(m_RS.PLnkDate);

         GetReplLnkParm(m_RS.LinkID, date(m_RS.PLnkDate), "TaxLink", @WrtOpAmount, @TakeAmount, @TakeSum);
       end;

       q =   " select NVL(SUM((case when obj.t_Direction = "+TXOBJ_DIR_OUT+" then -1 else 1 end)*obj.t_Sum0), 0) as TaxLink "
           + "   from dnptxobj_dbt obj "
           + "  where obj.t_Client = ? "
           + "    and obj.t_AnaliticKind2 = " + TXOBJ_KIND2010
           + "    and obj.t_Analitic2 = ? "
           + "    and obj.t_Date >= ? "
           + "    and obj.t_Date <= ? "
           + "    and obj.t_Kind = " + TXOBJ_TAX_LINK
           + IIF(m_Include_Tech != SET_CHAR, " and (obj.t_Technical = CHR(0) or obj.t_Technical IS NULL) ", "");

       sel = DL_RSDCommand(q);

       sel.AddParam(m_Rs.PartyID);
       sel.AddParam(m_Rs.LinkID);
       sel.AddParam(StartDate);
       sel.AddParam(FinishDate);

       DataSet = sel.Execute();
       if(DataSet.moveNext())
         m_TaxLink = DataSet.TaxLink;
       end;

       if(m_RS.IsSaleRepl_BuyBef01032024)
         
         if((WrtOpAmount - TakeAmount) == m_RS.Qnty)
           m_TaxLink = m_TaxLink - TakeSum;
         else
           m_TaxLink = round(m_TaxLink*(TakeAmount + m_RS.Qnty)/WrtOpAmount, 2) - TakeSum;//round(m_TaxLink*(TakeAmount + m_RS.Qnty)/WrtOpAmount - m_TaxLink*(TakeAmount)/WrtOpAmount, 2);
         end;

         if(GenPropID(m_RS,"PLnkID") != -1)
           AddRepLnkParm(m_RS.LinkID, m_RS.PLnkID, "TaxLink", m_RS.Qnty, m_TaxLink);
         end;
       end;
    end;
    return m_TaxLink;
  END;

  /*Сумма для налогообложения*/
  MACRO TaxFRlink():DOUBLE
    if( m_TaxFRlink == null )
      m_TaxFRlink = 0;
      if(m_RS.IsRepayCoup != 0)
        if(m_RS.TaxGroupNPTX != 50)
          m_TaxFRlink = this.AllSRub() - money(m_Rs.AllNkdB_TS);
        end;
      elif(m_RS.IsBuyCoup != 0)
        m_TaxFRlink = 0;
      elif( IsRET_PARTLY( Int(m_RS.SaleGroup) ) )

         var AddWhereCond_FR_TS = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly +
                                  " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID, 

             AddWhereCond_DIFB_TS = " obj.t_AnaliticKind1 = "+TXOBJ_KIND1060+" and obj.t_Analitic1 = "+m_RS.Number_Partly+
                                    " and obj.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj.t_Analitic3 = "+m_RS.FIID + 
                                    " and obj.t_AnaliticKind2 = "+TXOBJ_KIND2020+" and obj.t_Analitic2 in (select obj2.t_Analitic2 "+
                                                                                                        "    from dnptxobj_dbt obj2 "+
                                                                                                        "   where obj2.t_AnaliticKind2 = obj.t_AnaliticKind2 "+
                                                                                                        "     and obj2.t_Direction = "+string(TXOBJ_DIR_OUT)+
                                                                                                        "     and obj2.t_Client = obj.t_Client "+
                                                                                                        IIF(m_Include_Tech != SET_CHAR, " and (obj2.t_Technical = CHR(0) or obj2.t_Technical IS NULL) ", "") +
                                                                                                        "     and obj2.t_AnaliticKind3 = "+TXOBJ_KIND3010+" and obj2.t_Analitic3 = "+m_RS.FIID +
                                                                                                        "     and RSI_NPTO.CheckObjIIS ( " + TXOBJ_KIND6020 + ", obj2.t_Analitic6 )  = "+string(m_CurrIIS)+
                                                                                                        " )";
         if(m_ContractIDsStr != "")
           AddWhereCond_FR_TS = AddWhereCond_FR_TS + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
           AddWhereCond_DIFB_TS = AddWhereCond_DIFB_TS + " and obj.t_AnaliticKind6 = " + TXOBJ_KIND6020 + " and obj.t_Analitic6 IN ("+m_ContractIDsStr+") ";
         end;
         
         m_TaxFRlink =
            GetRubSumByClient(m_CurrInvestor, string(TXOBJ_FR_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_IN, m_CurrIIS, true, AddWhereCond_FR_TS, IIF(m_Include_Tech != SET_CHAR, true, false)) -
            GetRubSumByClient(m_CurrInvestor, string(TXOBJ_FR_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, true, AddWhereCond_FR_TS, IIF(m_Include_Tech != SET_CHAR, true, false)) - 
            GetRubSumByClient(m_CurrInvestor, string(TXOBJ_DIFB_TS), m_BeginDate, m_EndDate, TXOBJ_DIR_OUT, m_CurrIIS, true, AddWhereCond_DIFB_TS, IIF(m_Include_Tech != SET_CHAR, true, false));

      elif( IsRET_COUPON( Int(m_RS.SaleGroup) ) )
        if( (m_RS.TaxGroupNPTX == 40) and (m_RS.TaxGroupNPTX == 50) )
          m_TaxFRlink = $0;
        else
          m_TaxFRlink = AllSRub();
        end;
      elif(m_RS.LinkID > 0)
         if( (m_RS.TaxGroupNPTX == 50) and (m_RS.SaleDocKind == DL_RETIREMENT) )
            m_TaxFRlink = TaxLink() - DifB() - AllSrub_L();
         else
            if( FRrub() < 0 )
               m_TaxFRlink = TaxLink() + DifS() - DifB();
            else
               m_TaxFRlink = TaxLink();
            end;
         end;
      end;
    end;
    return m_TaxFRlink;
  END;

  /*Обращаемость ц/б*/
  MACRO SecType(IsLucre)
    if(IsLucre == NULL)
       IsLucre = false;
    end;

    if(IsLucre)
       return DL_GetNPTXSecType(m_Rs.FIID);
    else
       return  IIF(m_RS.SIfMarket == SET_CHAR, "да", "нет");
    end;
  END;

  MACRO Material():MONEY
    if(m_Material == NULL)
       m_Material = $0;
       DL_GetNPTXOBJSumByDeal(m_Rs.DealBuyID, string(TXOBJ_MATERIAL), NULL, this.RepDend(), TXOBJ_DIR_ALL, NULL, @m_Material, null, m_Rs.Investor, NULL, IIF(m_Include_Tech != SET_CHAR, true, false));  
    end;
    return m_Material;
  END;

  MACRO GetPrivQntyByTS()
    var v_PrivQnty = $0;
    var cmd = DL_RSDCommand("select nvl(sum(RSI_NPTX.GetPrivAmountByTS(T.t_ID,?,?)),0) PrivQnty "+
                            "  from dnptxlot_dbt LB, dnptxts_dbt T " +
                            " where LB.t_Kind = ? " +
                            "   and T.t_BuyID  = LB.t_ID " +
                            "   and T.t_Type = ? " +
                            "   and T.t_Client = ? " +
                            "   and T.t_Contract = ? " +
                            "   and RSI_NPTO.CheckContrIIS (T.t_Contract) = ? " +
                            IIF(m_ContractIDsStr != "", " and T.t_Contract IN ("+m_ContractIDsStr+") ", "")+
                            "   and T.t_Amount > 0 " +
                            "   and T.t_FIID = ? " +
                            "   and T.t_BegDate < ? " +
                            "   and (T.t_EndDate >= ? or T.t_EndDate = TO_DATE('01-01-0001','DD-MM-YYYY') )"
                           );

    cmd.AddParam(m_EndDate);
    cmd.AddParam(m_RS.DealSaleDate);
    cmd.AddParam(NPTXLOTS_BUY);
    cmd.AddParam(NPTXTS_REST);
    cmd.AddParam(m_CurrInvestor);
    cmd.AddParam(m_RS.Contract);
    cmd.AddParam(m_CurrIIS);
    cmd.AddParam(m_RS.FIID);
    cmd.AddParam(m_RS.DealSaleDate);
    cmd.AddParam(m_RS.DealSaleDate);
    
    var DataSet = cmd.Execute();

    if( DataSet.moveNext() )
       v_PrivQnty = SQL_ConvTypeSum(DataSet.PrivQnty);
    end;

    return v_PrivQnty;
  END;

  /*Особенности налогообложения*/
  MACRO TaxTags()
    var Group: Integer, v_PrivQnty = $0;
    Group = Int(m_RS.SaleGroup);
     
    if( m_TaxTags == NULL )

       m_TaxTags = "";

       if( m_RS.TaxGroupNPTX == 30 )
         m_TaxTags = "ипотечные";
       end;

       if( m_RS.PrivQnty > 0 )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "льготных ц/б - " + int(m_RS.PrivQnty);/*в отчете кол-во округляется до целого (значит, здесь тоже округляем)*/
       end;

       if(m_RS.IsSaleRepl)
         if(m_RS.IsSaleRepl_BuyBef01032024)
           if ( m_TaxTags != "" )
             m_TaxTags = m_TaxTags + ", ";
           end;
           m_TaxTags = m_TaxTags + "сделка замещения";
         else
           if ( m_TaxTags != "" )
             m_TaxTags = m_TaxTags + ", ";
           end;
           m_TaxTags = m_TaxTags + "сделка замещения. Покупка после 01.03.2022";
         end;
       end;

       if(m_RS.IsBuyRepl)
         if(m_RS.IsBuyRepl_BuyBef01032024)
           if ( m_TaxTags != "" )
             m_TaxTags = m_TaxTags + ", ";
           end;
           m_TaxTags = m_TaxTags + "продажа замещающей ц/б";
         else
           if ( m_TaxTags != "" )
             m_TaxTags = m_TaxTags + ", ";
           end;
           m_TaxTags = m_TaxTags + "продажа замещенной ц/б. Покупка после 01.03.2022";
         end;
       end;

       if( (m_RS.SIfMarket != m_RS.BIfMarket ) and (m_RS.LinkID > 0))
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "изменение обращаемости";
       end;
       if( IsRET_ISSUE( Group ) )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "погашение выпуска";
       elif( IsRET_COUPON( Group ) )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "погашение купона";
       elif( IsRET_PARTLY( Group ) )
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "частичное погашение";
       end;
                             
       if( IsRET_PARTLY( Group ) )
         v_PrivQnty = GetPrivQntyByTS();
         if( v_PrivQnty > $0 )
           if ( m_TaxTags != "" )
             m_TaxTags = m_TaxTags + ", ";
           end;
           m_TaxTags = m_TaxTags + "льготных ц/б - " + int(v_PrivQnty);/*в отчете кол-во округляется до целого (значит, здесь тоже округляем)*/
         end;
       end;

       if((m_RS.IsRepayCoup != 0) or (m_RS.IsBuyCoup != 0))
         if ( m_TaxTags != "" )
           m_TaxTags = m_TaxTags + ", ";
         end;
         m_TaxTags = m_TaxTags + "погашение купона";
       end;

    end;
    
    return m_TaxTags;
  END;

  initTX_RegistrReport( NULL, "", NULL, NULL, NULL, NULL, NULL );
END;


