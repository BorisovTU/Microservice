/* Операция конвертации ц/б. 
   Шаг списания */
import InsCarryDoc, "sp_car2.mac";

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step)

  record deal(dl_tick);
  var    FD, FD2, dat;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDoc( deal ); 
  FD2 = SPFirstDoc( deal, true );

  GetOprDate( FD.GetKindDate(DATE_CONVAVR_OUT), dat );
  if( dat > {curdate} )
     MsgBox ("Преждевременное выполнение шага запрещено.");
     return 1;
  end;

  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, dat, NULL ) != 0 )
     return 1;
  end; 

  if( not ПроводкаПоКатегориямВнутреннегоУчета( 58, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.FIID, 
                                                FD.GetRQ(DLRQ_TYPE_DELIVERY).rec.Amount
                                              ) )
      return 1;
  end;

  return 0;
end;
