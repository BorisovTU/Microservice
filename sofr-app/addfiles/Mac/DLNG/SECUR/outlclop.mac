/*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : outlclop.mac
  Programmer  : ˆ¢ ­îâ¨­ ..
  Ž¯¥à æ¨ï    : Žâç¥â " áå®¤ë ¡ ­ª  ¯® ®¯¥à æ¨ï¬ ª«¨¥­â®¢"
ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*/

IMPORT "outlclop_form.mac", "DLReport_h.mac", PtInter, "dlreport.mac", "sccomiss.mac";

PRIVATE CONST ItogsLineName = "ˆâ®£®:";                                                                                                                                                                                                                                                                                       

PRIVATE RECORD partyInc(party);

PRIVATE VAR ReportHeader =
"\n\n##############################  ###########################\n"+
"€­ «¨â¨ç¥áª¨© à¥£¨áâà ­ «®£®¢®£® ãç¥â  ü23\n"+
"\n áå®¤ë ¡ ­ª  ¯® ®¯¥à æ¨ï¬ ª«¨¥­â®¢\n"+
"\n§  ¯¥à¨®¤: #\n";

PRIVATE VAR TableHeader =
"ÚÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
"³   ³                              ³                   ³                   ³                        ³     ‘ã¬¬  à áå®¤®¢ ®âç.  ³ ‘ã¬¬  ¯®­¥á¥­­ëå   ³    ‘ã¬¬      ³    ‘ã¬¬       ³            ³\n"+
"³   ³                              ³                   ³                   ³  „ â  ®ª § ­¨ï ãá«ã£¨  ³          ¯¥à¨®¤          ³ à áå®¤®¢ (¢ àã¡.   ³ ª®àà¥ªâ¨à®¢ª¨³ ª®àà¥ªâ¨à®¢ª¨ ³ à¨¬¥ç ­¨¥ ³\n"+
"³ ü ³          ü ¤®£®¢®à           ³    Š®­âà £¥­â     ³    ‚¨¤ ¤®£®¢®à    ³                        ÃÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ íª¢. ¤«ï áã¬¬ ¢    ³              ³ ®¡ï§ â¥«ìáâ¢, ³            ³\n"+
"³¯/¯³                              ³                   ³                   ³                        ³           ³              ³ ¨­.¢ «.),          ³  (¤«ï áã¬¬ ¢ ³ ¢ëà ¦¥­­ëå ¢  ³            ³\n"+
"³   ³                              ³                   ³                   ³                        ³    ¢ «.   ³     àã¡.     ³  ®âà ¦¥­­ëå ¯®     ³   ¨­.¢ «îâ¥) ³ ¨­.¢ «.¯®     ³            ³\n"+
"³   ³                              ³                   ³                   ³                        ³           ³              ³ ¡ « ­áã ¡ ­ª  ­    ³              ³ ªãàáã ­       ³            ³\n"+
"³   ³                              ³                   ³                   ³                        ³           ³              ³  ¤¥­ì á¯¨á ­¨ï     ³              ³ ¯®á«.¤¥­ì     ³            ³\n"+
"³   ³                              ³                   ³                   ³                        ³           ³              ³     áà¥¤áâ¢        ³              ³ ®âç.¯¥à¨®¤    ³            ³\n"+
"³   ³                              ³                   ³                   ³                        ³           ³              ³                    ³              ³               ³            ³\n"+
"ÃÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄ´\n"+
"³ 1 ³              2               ³         3         ³         4         ³            5           ³     6     ³      7       ³         8          ³      9       ³      10       ³     11     ³\n"+
"ÃÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄ´";

PRIVATE CLASS CCommReg( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginReport()
     m_Report.PrintHeader();
     m_Report.RegisterTable("N1_MainTable", TableHeader,
                            "N1_ID", "N1_SfContr", "N1_Contr", "N1_ServKind", "N1_Period", "N1_Cur", "N1_Rur", 
                            "N1_Sum", "N1_SumCorr1", "N1_SumCorr2", "N1_Note"
                           );

     m_Report.SetCellAutoSumma( null, "N1_Cur", "N1_Rur","N1_Sum","N1_SumCorr1","N1_SumCorr2" );
  END;

  MACRO EndReport()
     m_Report.EndTable();
  END;

  MACRO Print(IsApp:STRING)
     VAR App = "";

        if( IsApp )
           App = ":a";
        end;

        m_Report.SetCurrentLineFont( 8, false, false );
        m_Report.PrintTableLine(
  /*1  */                         "N1_ID:c",             m_Report.ID(),      null ,
  /*2  */                         "N1_SfContr:c",        m_Report.SfContr(), null ,
  /*3  */                         "N1_Contr:c",          m_Report.Contr(), null ,
  /*4  */                         "N1_ServKind:c",       m_Report.ServKind(),  null ,
  /*5  */                         "N1_Period:c",         m_Report.IncumPeriod(), null ,
  /*6  */                         "N1_Cur:r"+App,          m_Report.Cur(),  null ,
  /*7  */                         "N1_Rur:r"+App,          m_Report.Rur(),  null ,
  /*8  */                         "N1_Sum:r"+App,          m_Report.Sum(),   null ,
  /*9  */                         "N1_SumCorr1:r"+App,     m_Report.SumCorr1(), null, 
  /*9  */                         "N1_SumCorr2:r"+App,     m_Report.SumCorr2(), null, 
                                  "N1_Note",             " ", null
                               );
  END;         
END;

PRIVATE CLASS (DL_CReportTemplate) SP_CommReg_Report

  PRIVATE VAR m_NumRow = 0;
  PRIVATE VAR Period,Year,OperID,BegDate,EndDate,DateBegin,DateClose;

  PRIVATE VAR PeriodName, WasFormLine = false, IsApp;

  PRIVATE VAR USD_Outl = $0, RUR_Outl = $0, PayOutlaySum = $0, Delta1 = $0, Delta2 = $0;

  PRIVATE VAR Summ = $0;

  PRIVATE VAR SfContrNum = 0, PartyID, ServKindSub, CommSum = $0;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport()
     Period      = m_Form.GetFieldValue( PNFLD_COMMREG_PERIOD);
     Year        = m_Form.GetFieldValue( PNFLD_COMMREG_YEAR);
     OperID      = m_Form.GetFieldValue( PNFLD_COMMREG_OPERNUM);
     IsApp       = m_Form.GetFieldValue( PNFLD_COMMREG_COMPRINTMETHOD);

     BegDate = Date(1, Period-2, Year);
     EndDate = DateAfterCalenMonths(BegDate, 3) - 1; 
     PeriodName   = PeriodName_GetByMonthYear(Period, Year);

  END;

  MACRO PrintHeader( )

     VAR INN = "", KPP = "";
     SplitFullINN( ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ ({OurBank}, PTCK_INN), INN, KPP );
     SetActiveSheet( "023" );
     PrintFormatString( ReportHeader,
                        "N1_H0_1:l" , ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ({OurBank}),
                        "N1_H0_2:l" , INN + "/" + KPP,
                        "N1_H0_3"   , PeriodName 
                      );
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )

      private  file sfcontr(sfcontr) key 3;

      macro ¥ç âì‘âà®ª¨()
         
         m_NumRow        = m_NumRow + 1;
         SfContrNum      = sfcontr.Number;/*­®¬¥à*/
         PartyID         = sfcontr.PartyID;/*ª®­âà £¥­â*/
         ServKindSub     = sfcontr.ServKindSub;
         DateBegin       = sfcontr.DateBegin;
         DateClose       = sfcontr.DateClose;

         ObjReport.Print(IsApp);
         WasFormLine = false;
      end;

      macro Žç¨áâ¨âì„ ­­ë¥®‘âà®ª¥()
         USD_Outl     = null;
         RUR_Outl     = null;
         PayOutlaySum = null;
         Delta1       = null;
         Delta2       = null;
      end;

      macro FormLine(dl_tick, sfbasobj, sfdefcom)
   
         var FormUSD_Outl = $0, FormRUR_Outl = $0, FormPayOutlaySum = $0, FormDelta1 = $0, FormDelta2 = $0;
         var SummInDatePay = $0, SummInDealDate = $0, SummInDateEnd = $0; 

   /*‘ã¬¬ë à áå®¤®¢ ®âç¥â­®£® ¯¥à¨®¤ */
         if(sfbasobj.FIID != NATCUR)
            FormUSD_Outl = sfbasobj.CommSum;
            SmartConvertSum( FormRUR_Outl, FormUSD_Outl, dl_tick.DealDate, sfbasobj.FIID, NATCUR, true );
         else
            FormRUR_Outl = sfbasobj.CommSum;
         end;
   /*Cã¬¬  ¯®­¥á¥­­ëå à áå®¤®¢*/
         if(sfdefcom.Status == 1)  /*Š®¬¨áá¨ï ®¯« ç¥­ */
            SmartConvertSum( FormPayOutlaySum, sfbasobj.CommSum, sfdefcom.DatePay, sfbasobj.FIID, NATCUR, true );
         end;
   /*‘ã¬¬  ª®àà¥ªâ¨à®¢ª¨ Dalta1*/
         if((sfdefcom.Status == 1) AND (sfbasobj.FIID != NATCUR))  /*Š®¬¨áá¨ï ®¯« ç¥­  ¨ ¢ ¨­®áâà ­­®© ¢ «îâ¥*/
            SmartConvertSum( SummInDatePay, sfbasobj.CommSum, sfdefcom.DatePay, sfbasobj.FIID, NATCUR, true );
            SmartConvertSum( SummInDealDate, sfbasobj.CommSum, dl_tick.DealDate, sfbasobj.FIID, NATCUR, true );
            FormDelta1 = SummInDatePay - SummInDealDate;
         end;

   /*‘ã¬¬  ª®àà¥ªâ¨à®¢ª¨ Dalta2*/
         if(sfbasobj.FIID != NATCUR)  /*Š®¬¨áá¨ï ¢ ¨­®áâà ­­®© ¢ «îâ¥*/
            SmartConvertSum( SummInDateEnd, sfbasobj.CommSum, EndDate, sfbasobj.FIID, NATCUR, true );
            SmartConvertSum( SummInDealDate, sfbasobj.CommSum, dl_tick.DealDate, sfbasobj.FIID, NATCUR, true );
            FormDelta2 = SummInDateEnd - SummInDealDate;
         end;


         USD_Outl     = USD_Outl     + FormUSD_Outl;
         RUR_Outl     = RUR_Outl     + FormRUR_Outl;
         PayOutlaySum = PayOutlaySum + FormPayOutlaySum;
         Delta1       = Delta1       + FormDelta1;
         Delta2       = Delta2       + FormDelta2;
     end;
 
     macro ¥à¥¡®àŠ®¬¨áá¨©(dl_tick)
        file sfbasobj(sfbasobj) key 1; 
        file sfdefcom(sfdefcom);
        record Comiss(sfcomiss);
        var Continue_cicle;

        ClearRecord(sfbasobj);
        sfbasobj.FeeType = SF_FEE_TYPE_PERIOD;
        sfbasobj.BaseObjectType = dl_tick.BofficeKind;
        sfbasobj.BaseObjectID =   dl_tick.DealID;
        Continue_cicle = GetGE(sfbasobj);
        while(Continue_cicle AND (sfbasobj.BaseObjectType == dl_tick.BofficeKind)
                  AND (sfbasobj.BaseObjectID ==   dl_tick.DealID))

           if( sfbasobj.AccountedInIncluded != 1 )
       /* Š®¬¨áá¨ï ¤®«¦­  ¡ëâì ®¯« ç¥­  ­ ¬¨.
          AccountedInIncluded == 1 -- ¯à¨§­ ª Š - ª®¬¨áá¨î ¯® á¤¥«ª¥ ®¯« ç¨¢ ¥â
          ª«¨¥­â */
         
       /* ©¤¥¬ ã¤¥à¦ ­­ãî ª®¬¨áá¨î*/
              ClearRecord(sfdefcom);
              sfdefcom.Id = sfbasobj.DefCommID;
              if(GetEQ(sfdefcom))
         /*®«ãç¨¬ ª®¬¨áá¨î*/
                 if(SfGetComiss(sfdefcom.FeeType, sfdefcom.CommNumber, Comiss) == true)
                    if((Comiss.ReceiverID != {OurBank}) AND (Comiss.ReceiverID != 0))   /*®«ãç â¥«¥¬ ¬ë ¡ëâì ­¥ ¤®«¦­ë*/
             /* ‚®â ®­  ­ ¬ ¨ ­ã¦­ */
                       FormLine(dl_tick, sfbasobj, sfdefcom);
                       WasFormLine = true;
                    end;
                 else
           /*à §ê¥§¤ ¡ §*/
                    RunError("¥ ­ ©¤¥­  ª®¬¨áá¨ï á ¯ à ¬¥âà ¬¨ FeeType = ", string(sfdefcom.FeeType), " CommNumber = ", string(sfdefcom.CommNumber));
                 end;
              else
                 Msgbox("¥ ­ ©¤¥­  à á¯à¥¤¥«¥­­ ï ª®¬¨áá¨ï ¯® á¤¥«ª¥ ", dl_tick.DealCode);
              end;
           end;
           Continue_cicle = Next(sfbasobj);
        end;
     end;

     macro ¥à¥¡®à‘¤¥«®ª()
        file dl_tick(dl_tick) key 6;
        var Continue_cicle, OK = true;

        ClearRecord(dl_tick);
        dl_tick.BofficeKind = DL_SECURITYDOC;
        dl_tick.ClientID     = sfcontr.partyID;
        dl_tick.DealDate     = BegDate; 

        Continue_cicle = GetGE(dl_tick);
        while( Continue_cicle AND (   (dl_tick.BofficeKind == DL_SECURITYDOC)   AND 
                                      (dl_tick.ClientID == sfcontr.partyID)     AND  
                                      (dl_tick.DealDate >= BegDate)        AND 
                                      (dl_tick.DealDate <= EndDate) ) 
             )
       /*¯à®¢¥à¨¬ ¤®£®¢®à ®¡á«ã¦¨¢ ­¨ï*/
        if(dl_tick.ClientContrID != sfcontr.ID)
           OK = false;
        end;
       /*¯à®¢¥à¨¬ ®¯¥à æ¨®­¨áâ */
        if((OperID != 0) AND (OperID != dl_tick.Oper))
           OK = false;
        end;
    
        if(OK == true)
           ¥à¥¡®àŠ®¬¨áá¨©(dl_tick);
        end;

        Continue_cicle = Next(dl_tick);
        OK = true;
        end;
     end;

     var continue_cicle, Num = 0, OK = true;

     ObjReport.BeginReport(); 

     InitProgress( NRecords(sfcontr), "Žâç¥â \" áå®¤ë ¡ ­ª  ¯® ®¯¥à æ¨ï¬ ª«¨¥­â®¢\"", 
                "à®á¬®âà ¤®£®¢®à®¢" );

     /*¥à¥¡¥à ¥¬ ¢á¥ à¥«¥¢ ­â­ë¥ ¤®£®¢®à */
     clearrecord(sfcontr);
     sfcontr.ServKind = PTSK_STOCKDL;
     sfcontr.ContractorID = {OurBank};
     continue_cicle = GetGE(sfcontr);

     while(continue_cicle AND (sfcontr.ServKind == PTSK_STOCKDL) AND 
          (sfcontr.ContractorID == {OurBank}) )
        
        if((sfcontr.DateBegin > EndDate) AND (sfcontr.DateClose == Date(0,0,0)))
           OK = false;
        end;

        if((sfcontr.DateClose != Date(0,0,0)) AND (sfcontr.DateClose < BegDate))
           OK = false;
        end;

        if(OK == true)

           ¥à¥¡®à‘¤¥«®ª();
           this.ClearCacheOneRecord();

           if( WasFormLine == true );
              ¥ç âì‘âà®ª¨();
              Žç¨áâ¨âì„ ­­ë¥®‘âà®ª¥();
           end;

        end;

        Num = Num + 1;
        UseProgress( Num );
        continue_cicle = Next(sfcontr);
        OK = true;
     end;

     RemProgress;

     SetCurrentLineFont( 8, true, false );
     PrintTableLine( "N1_ID",  ItogsLineName, null );

     ObjReport.EndReport();
     PrintFormatString( "#", "N1_„ â ‘®áâ ¢«¥­¨ï:l", {curdate});

     RemProgress;

  END;

  PRIVATE MACRO Create()
     ExecuteReport( CCommReg(this) );
  END;                       

  /*Šíè¨àã¥¬ë¥ ¤ ­­ë¥ ¤«ï 1 § ¯¨á¨ ®âç¥â  */
  PRIVATE VAR m_SfContr, m_Contr, m_ServKind, m_Period, m_Cur, m_Rur, m_Sum, m_SumCorr1, m_SumCorr2;

  MACRO ClearCacheOneRecord()
     m_SfContr  = null;
     m_Contr    = null;
     m_ServKind = null;
     m_Period   = null;
     m_Cur      = null;
     m_Rur      = null;
     m_Sum      = null;
     m_SumCorr1 = null; 
     m_SumCorr2 = null; 
 END;

  MACRO ID():INTEGER
     return m_NumRow;
  END;

  MACRO SfContr():STRING
     m_SfContr = SfContrNum;
     return m_SfContr;
  END;

  MACRO Contr():STRING
     if( ®«ãç¨âì‘ã¡ê¥ªâ  ( PartyID, partyInc ) != 0 ) 
         msgbox("¥ ¬®£ã ¯®«ãç¨âì  ­ª¥âã áã¡ê¥ªâ  á ID = " + string(PartyID));
         exit(1);
     end;
     m_Contr = partyInc.ShortName;
     return m_Contr;
  END;

  MACRO ServKind():STRING /*‚¨¤ à áå®¤ */
     file servksub(servksub);
     clearrecord(servksub);
     servksub.ServiceKind = PTSK_STOCKDL;
     servksub.ServiceKindSub = ServKindSub;
     if( GetEQ(servksub) == true)
       m_ServKind = "Š®¬¨áá¨¨ ¯® ¤®£®¢®àã: " + servksub.Definition;
     end;
     return m_ServKind;
  END;

  MACRO IncumPeriod():STRING

     var PeriodBeg:date, PeriodEnd:date;

     if((DateBegin <= BegDate) AND (DateClose > EndDate))
       m_Period = date_as_string(1, BegDate) + "-" + date_as_string(1, DateClose);
     elif((DateBegin > BegDate) AND (DateClose > BegDate) AND (DateClose <= EndDate))
       m_Period = date_as_string(1, DateBegin) + "-" + date_as_string(1, DateClose);
     elif((DateBegin > BegDate) AND (DateClose == Date(0,0,0)))
       m_Period = date_as_string(1, DateBegin) + "-" + date_as_string(1, EndDate);
     else
       m_Period = date_as_string(1, BegDate) + "-" + date_as_string(1, EndDate);
     end;
    
     return m_Period;
  END;

  MACRO Cur():MONEY
     m_Cur = USD_Outl;
     return m_Cur;
  END;

  MACRO Rur():MONEY
     m_Rur = RUR_Outl;
     return m_Rur;
  END;

  MACRO Sum():MONEY
     m_Sum = PayOutlaySum;
     return m_Sum;
  END;

  MACRO SumCorr1():MONEY
    m_SumCorr1 = Delta1;
    return m_SumCorr1;
  END;

  MACRO SumCorr2():MONEY
    m_SumCorr2 = Delta2;
    return m_SumCorr2;
  END;

  initDL_CReportTemplate( SP_COMMReg23_Panel(), "Report_TxBankOutReg.xls" );
END;

SP_CommReg_Report().Run( );
Exit(1);
