/*
$Name:        screpocalc.mac
$Module:      Ценные бумаги
$Description: Специфические функции для расчетов по РЕПО
*/
import InsCarryDoc, "sp_class.mac", "sp_car.mac", "sp_car2.mac", "spserv.mac", "dlrq.mac";

macro ВыполнитьПроверкиДат( CalcOperDate, CalcPlanDate )
   var sql, rsd;

   if( CalcOperDate > {curdate} )
      MsgBox ("Дата операции должна быть не больше текущей.");
      return false;
   end;

   if( CalcPlanDate > {curdate} )
      MsgBox ("Плановая дата должна быть не больше текущей.");
      return false;
   end;

   return true;
end;

private macro ПолучитьДатуПогашения( IsPartial, FIID, Number, _Date )
  file    fiw( fiwarnts );

  ClearRecord( fiw );
  fiw.IsPartial = IsPartial;
  fiw.FIID      = FIID;
  fiw.Number    = Number;
  if( GetEQ(fiw) )
     SetParm(3, fiw.DrawingDate);
     return true;
  else
     return false;
  end;
end;

private macro SavePortfolioSum(FD, dat, dlSumKind, sum)
   return СохранитьСуммуКомиссии(DL_SECURITYDOC, FD.tick.rec.DealID, dlSumKind, dat, sum, $0, FD.FaceFIID(), NULL, NULL, FD.CurPFI());
end;

/* для сохранения сумм доначисления при отказе 2ч ПРЕПО */
class (TArray) TDataPortfSumAdd
   class PortfSum( _Portfolio:integer, _BonusAdd:money, _InterestIncomeAdd:money, _DiscountIncomeAdd:money)
       var Portfolio           = _Portfolio,
           BonusAdd            = _BonusAdd, 
           InterestIncomeAdd   = _InterestIncomeAdd,
           DiscountIncomeAdd   = _DiscountIncomeAdd;
   end;
   /* Очистить массив. */
   macro ClearArray
      this.Size = 0;
   end;

 //  private macro SavePortfolioSum(FD, dat, dlSumKind, sum)
 //     return СохранитьСуммуКомиссии(DL_SECURITYDOC, FD.tick.rec.DealID, dlSumKind, dat, sum, $0, FD.FaceFIID(), NULL, NULL, FD.CurPFI());
 //  end;

   /* Добавить строчку в массив. */
   macro AddLine(_Portfolio:integer, _BonusAdd:money, _InterestIncomeAdd:money, _DiscountIncomeAdd:money)
      var
         Counter = 0;

      while( ( Counter < this.Size ) and 
             (this.(Counter).Portfolio != _Portfolio )
           )
         Counter = Counter + 1;
      end;

      if( this.Size > Counter )
         if( this.(Counter).Portfolio != _Portfolio )
            this.(Counter) = PortfSum(_Portfolio, _BonusAdd, _InterestIncomeAdd, _DiscountIncomeAdd);
         else
            this.(Counter).BonusAdd          = this.(Counter).BonusAdd           + _BonusAdd;
            this.(Counter).InterestIncomeAdd = this.(Counter).InterestIncomeAdd  + _InterestIncomeAdd;
            this.(Counter).DiscountIncomeAdd = this.(Counter).DiscountIncomeAdd  + _DiscountIncomeAdd;
         end;
      else
         this.(Counter) = PortfSum(_Portfolio, _BonusAdd, _InterestIncomeAdd, _DiscountIncomeAdd);
      end;
   end;

   // сохранить суммы
   macro SaveSum(FD, dat)
      var i = 0;
      while( i < this.Size )
         if (this(i).Portfolio == KINDPORT_TRADE) /* ТП, Торговый портфель */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_REJECT2_BONUSADD,            this(i).BonusAdd          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_REJECT2_INTERESTINCOMEADD,   this(i).InterestIncomeAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_REJECT2_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd ) )
               msgbox("Ошибка при сохранении сумм доначисления ПДД");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_SALE) /* ППР, Портфель ц/б для продажи */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_REJECT2_BONUSADD,            this(i).BonusAdd          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_REJECT2_INTERESTINCOMEADD,   this(i).InterestIncomeAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_REJECT2_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd ) )
               msgbox("Ошибка при сохранении сумм доначисления ПДД");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_RETIRE) /* ПУДП, Портфель ДО, удерживаемые до погашения */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_REJECT2_BONUSADD,            this(i).BonusAdd          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_REJECT2_INTERESTINCOMEADD,   this(i).InterestIncomeAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_REJECT2_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd ) )
               msgbox("Ошибка при сохранении сумм доначисления ПДД");
               return false;
            end;
         end;
         i = i + 1;
      end;

      return true;
   end;

   macro AddLine2(kind, sum)
      // KINDPORT_TRADE ТП,   Торговый портфель 
      if   (kind == DLSUM_KIND_TRADE_REJECT2_BONUSADD)
         AddLine(KINDPORT_TRADE, sum, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_REJECT2_INTERESTINCOMEADD)
         AddLine(KINDPORT_TRADE, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_TRADE_REJECT2_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, sum);
      // KINDPORT_SALE // ППР,  Портфель ц/б для продажи
      elif (kind == DLSUM_KIND_SALE_REJECT2_BONUSADD)
         AddLine(KINDPORT_SALE, sum, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_REJECT2_INTERESTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_SALE_REJECT2_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, sum);
      // KINDPORT_RETIRE // ПУДП, Портфель ДО, удерживаемые до погашения
      elif (kind == DLSUM_KIND_RETIRE_REJECT2_BONUSADD)
         AddLine(KINDPORT_RETIRE, sum, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_REJECT2_INTERESTINCOMEADD)
         AddLine(KINDPORT_RETIRE, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_REJECT2_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, sum);
      end;
   end;
end;

/* Для купона */
class (TArray) TDataPortfSumCoupon
   class PortfSum( _Portfolio:integer, _IncomeSum:money, _BonusAdd:money, _NKD:money, _InterestIncomeSum:money, 
                   _InterestIncomeAdd:money, _NotCarryInterestSum:money,  _DiscountIncomeAdd:money, _NewDiscountIncome:money, 
                   _AccountedDefDiffAdd:money, _NewAccountedDefDiff:money,   _CorrIntToEIRAdd:money, _NewCorrIntToEIR:money )
       var Portfolio           = _Portfolio,
           IncomeSum           = _IncomeSum, 
           BonusAdd            = _BonusAdd,
           NKD                 = _NKD,
           InterestIncomeSum   = _InterestIncomeSum,
           InterestIncomeAdd   = _InterestIncomeAdd,
           NotCarryInterestSum = _NotCarryInterestSum,
           DiscountIncomeAdd   = _DiscountIncomeAdd,
           NewDiscountIncome   = _NewDiscountIncome,
           AccountedDefDiffAdd = _AccountedDefDiffAdd,
           NewAccountedDefDiff = _NewAccountedDefDiff,
           CorrIntToEIRAdd     = _CorrIntToEIRAdd,
           NewCorrIntToEIR     = _NewCorrIntToEIR;
   end;
   /* Очистить массив. */
   macro ClearArray
      this.Size = 0;
   end;
   /* Добавить строчку в массив. */
   macro AddLine(_Portfolio:integer,_IncomeSum:money, _BonusAdd:money, _NKD:money, 
                 _InterestIncomeSum:money, _InterestIncomeAdd:money, _NotCarryInterestSum:money,  _DiscountIncomeAdd:money, _NewDiscountIncome:money, 
                 _AccountedDefDiffAdd:money, _NewAccountedDefDiff:money, _CorrIntToEIRAdd:money, _NewCorrIntToEIR:money )
      var
         Counter = 0;

      while( ( Counter < this.Size ) and 
             (this.(Counter).Portfolio != _Portfolio )
           )
         Counter = Counter + 1;
      end;

      if( this.Size > Counter )
         if( this.(Counter).Portfolio != _Portfolio )
            this.(Counter) = PortfSum(_Portfolio,_IncomeSum, _BonusAdd, _NKD, _InterestIncomeSum, _InterestIncomeAdd, _NotCarryInterestSum, _DiscountIncomeAdd, 
                                      _NewDiscountIncome, _AccountedDefDiffAdd, _NewAccountedDefDiff,   _CorrIntToEIRAdd, _NewCorrIntToEIR );
         else
            this.(Counter).IncomeSum           = this.(Counter).IncomeSum           + _IncomeSum;           
            this.(Counter).BonusAdd            = this.(Counter).BonusAdd            + _BonusAdd;            
            this.(Counter).NKD                 = this.(Counter).NKD                 + _NKD;                 
            this.(Counter).InterestIncomeSum   = this.(Counter).InterestIncomeSum   + _InterestIncomeSum;   
            this.(Counter).InterestIncomeAdd   = this.(Counter).InterestIncomeAdd   + _InterestIncomeAdd;   
            this.(Counter).NotCarryInterestSum = this.(Counter).NotCarryInterestSum + _NotCarryInterestSum; 
            this.(Counter).DiscountIncomeAdd   = this.(Counter).DiscountIncomeAdd   + _DiscountIncomeAdd;
            this.(Counter).NewDiscountIncome   = this.(Counter).NewDiscountIncome   + _NewDiscountIncome;
            this.(Counter).AccountedDefDiffAdd = this.(Counter).AccountedDefDiffAdd + _AccountedDefDiffAdd;
            this.(Counter).NewAccountedDefDiff = this.(Counter).NewAccountedDefDiff + _NewAccountedDefDiff;
            this.(Counter).CorrIntToEIRAdd     = this.(Counter).CorrIntToEIRAdd     + _CorrIntToEIRAdd;
            this.(Counter).NewCorrIntToEIR     = this.(Counter).NewCorrIntToEIR     + _NewCorrIntToEIR; 
         end;
      else
         this.(Counter) = PortfSum(_Portfolio,_IncomeSum, _BonusAdd, _NKD, _InterestIncomeSum, _InterestIncomeAdd, _NotCarryInterestSum, _DiscountIncomeAdd, 
                                      _NewDiscountIncome, _AccountedDefDiffAdd, _NewAccountedDefDiff,   _CorrIntToEIRAdd, _NewCorrIntToEIR );
      end;

   end;

   macro AddLine2(kind, sum)
      // KINDPORT_TRADE ССПУ_ЦБ, Ц/б, оцениваемые по СС через прибыль или убыток 
      if   (kind == DLSUM_KIND_TRADE_COUPON_INCOMESUM)
         AddLine(KINDPORT_TRADE, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_BONUSADD)
         AddLine(KINDPORT_TRADE, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_NKD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_INTERESTINCOMESUM)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_INTERESTINCOMEADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_NOTCARRYINTERESTSUM)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);

      elif (kind == DLSUM_KIND_SALE_COUPON_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_NEWDISCOUNTINCOME)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);

      elif (kind == DLSUM_KIND_TRADE_COUPON_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_NEWDISCOUNTINCOME)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);

      elif (kind == DLSUM_KIND_TRADE_COUPON_ACCOUNTEDDEFDIFFADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_NEWACCOUNTEDDEFDIFF)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0);
      elif (kind == /*DLSUM_KIND_TRADE_COUPON_CORRINTTOEIRADD*/2726)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_TRADE_COUPON_NEWCORRINTTOEIR)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum);
      // KINDPORT_SALE // СССД_ЦБ, Ц/б, оцениваемые по СС через прочий совокупный доход
      elif (kind == DLSUM_KIND_SALE_COUPON_INCOMESUM)
         AddLine(KINDPORT_SALE, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_BONUSADD)
         AddLine(KINDPORT_SALE, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_NKD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_INTERESTINCOMESUM)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_INTERESTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_NOTCARRYINTERESTSUM)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
/*
      elif (kind == DLSUM_KIND_SALE_COUPON_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_NEWDISCOUNTINCOME)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);
*/
      elif (kind == DLSUM_KIND_SALE_COUPON_ACCOUNTEDDEFDIFFADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_NEWACCOUNTEDDEFDIFF)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0);
      elif (kind == /*DLSUM_KIND_SALE_COUPON_CORRINTTOEIRADD*/2826)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_SALE_COUPON_NEWCORRINTTOEIR)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum);
      // KINDPORT_RETIRE // АС_ЦБ, Ц/б, оцениваемые по амортизированной стоимости
      elif (kind == DLSUM_KIND_RETIRE_COUPON_INCOMESUM)
         AddLine(KINDPORT_RETIRE, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_BONUSADD)
         AddLine(KINDPORT_RETIRE, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_NKD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_INTERESTINCOMESUM)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_INTERESTINCOMEADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_NOTCARRYINTERESTSUM)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_NEWDISCOUNTINCOME)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_ACCOUNTEDDEFDIFFADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_NEWACCOUNTEDDEFDIFF)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0);
      elif (kind == /*DLSUM_KIND_RETIRE_COUPON_CORRINTTOEIRADD*/2926)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_COUPON_NEWCORRINTTOEIR)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum);
      // KINDPORT_BACK // ПВО,  Портфель ц/б, полученные на возвратной основе
      elif (kind == DLSUM_KIND_OD_COUPON_INCOMESUM)
         AddLine(KINDPORT_BACK, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      end;
   end;

   macro SaveSum(FD, dat)
      var i = 0;
      while( i < this.Size )
         if (this(i).Portfolio == KINDPORT_TRADE) /* ССПУ_ЦБ, Ц/б, оцениваемые по СС через прибыль или убыток */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_INCOMESUM,           this(i).IncomeSum          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_BONUSADD,            this(i).BonusAdd           ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_NKD,                 this(i).NKD                ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_INTERESTINCOMESUM,   this(i).InterestIncomeSum  ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_INTERESTINCOMEADD,   this(i).InterestIncomeAdd  ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_NOTCARRYINTERESTSUM, this(i).NotCarryInterestSum ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_NEWDISCOUNTINCOME,   this(i).NewDiscountIncome   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_ACCOUNTEDDEFDIFFADD, this(i).AccountedDefDiffAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_NEWACCOUNTEDDEFDIFF, this(i).NewAccountedDefDiff ) or
                not SavePortfolioSum(FD, dat, /*DLSUM_KIND_TRADE_COUPON_CORRINTTOEIRADD*/2726,     this(i).CorrIntToEIRAdd     ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_NEWCORRINTTOEIR,     this(i).NewCorrIntToEIR   ) )
               msgbox("Ошибка при сохранении дохода по учету купона");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_SALE) /* СССД_ЦБ, Ц/б, оцениваемые по СС через прочий совокупный доход */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_INCOMESUM,           this(i).IncomeSum          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_BONUSADD,            this(i).BonusAdd           ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_NKD,                 this(i).NKD                ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_INTERESTINCOMESUM,   this(i).InterestIncomeSum  ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_INTERESTINCOMEADD,   this(i).InterestIncomeAdd  ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_NOTCARRYINTERESTSUM, this(i).NotCarryInterestSum ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_NEWDISCOUNTINCOME,   this(i).NewDiscountIncome   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_ACCOUNTEDDEFDIFFADD, this(i).AccountedDefDiffAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_NEWACCOUNTEDDEFDIFF, this(i).NewAccountedDefDiff ) or
                not SavePortfolioSum(FD, dat, /*DLSUM_KIND_SALE_COUPON_CORRINTTOEIRADD*/2826,     this(i).CorrIntToEIRAdd     ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_NEWCORRINTTOEIR,     this(i).NewCorrIntToEIR   ) )
               msgbox("Ошибка при сохранении дохода по учету купона");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_RETIRE) /* АС_ЦБ, Ц/б, оцениваемые по амортизированной стоимости */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_INCOMESUM,           this(i).IncomeSum          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_BONUSADD,            this(i).BonusAdd           ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_NKD,                 this(i).NKD                ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_INTERESTINCOMESUM,   this(i).InterestIncomeSum  ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_INTERESTINCOMEADD,   this(i).InterestIncomeAdd  ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_NOTCARRYINTERESTSUM, this(i).NotCarryInterestSum ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_NEWDISCOUNTINCOME,   this(i).NewDiscountIncome   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_ACCOUNTEDDEFDIFFADD, this(i).AccountedDefDiffAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_NEWACCOUNTEDDEFDIFF, this(i).NewAccountedDefDiff ) or
                not SavePortfolioSum(FD, dat, /*DLSUM_KIND_RETIRE_COUPON_CORRINTTOEIRADD*/2926,     this(i).CorrIntToEIRAdd     ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_NEWCORRINTTOEIR,     this(i).NewCorrIntToEIR   ) )
               msgbox("Ошибка при сохранении дохода по учету купона");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_BACK) /* ПВО,  Портфель ц/б, полученные на возвратной основе */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_OD_COUPON_INCOMESUM, this(i).IncomeSum) )
               msgbox("Ошибка при сохранении дохода по учету купона");
               return false;
            end;
         end;
         i = i + 1;
      end;
   end;
end;

/* для ЧП */
class (TArray) TDataPortfSumPartial
   class PortfSum( _Portfolio:integer, _IncomeSum:money, _DiscountIncomeSum:money, _DiscountIncomeAdd:money, _NotCarryDiscountSum:money, _Discount0_korr:money,
   _InterestIncomeAdd:money, _NewInterestIncome:money, _BonusAdd:money, _NewBonus:money, _DefDiffSum:money,
   _AccountedDefDiffAdd:money, _NewAccountedDefDiff:money, _DefDiff0_korr:money, _CorrIntToEIRAdd:money, _NewCorrIntToEIR:money )
       var Portfolio           = _Portfolio,
           IncomeSum           = _IncomeSum, 
           DiscountIncomeSum   = _DiscountIncomeSum,
           DiscountIncomeAdd   = _DiscountIncomeAdd,
           NotCarryDiscountSum = _NotCarryDiscountSum,
           Discount0_korr      = _Discount0_korr,
           InterestIncomeAdd   = _InterestIncomeAdd, 
           NewInterestIncome   = _NewInterestIncome, 
           BonusAdd            = _BonusAdd,
           NewBonus            = _NewBonus, 
           DefDiffSum          = _DefDiffSum, 
           AccountedDefDiffAdd = _AccountedDefDiffAdd, 
           NewAccountedDefDiff = _NewAccountedDefDiff, 
           DefDiff0_korr       = _DefDiff0_korr, 
           CorrIntToEIRAdd     = _CorrIntToEIRAdd, 
           NewCorrIntToEIR     = _NewCorrIntToEIR; 
   end;
   /* Очистить массив. */
   macro ClearArray
      this.Size = 0;
   end;
   /* Добавить строчку в массив. */
   macro AddLine(_Portfolio:integer, _IncomeSum:money, _DiscountIncomeSum:money, _DiscountIncomeAdd:money, _NotCarryDiscountSum:money, _Discount0_korr:money,
   _InterestIncomeAdd:money, _NewInterestIncome:money, _BonusAdd:money, _NewBonus:money, _DefDiffSum:money,
   _AccountedDefDiffAdd:money, _NewAccountedDefDiff:money, _DefDiff0_korr:money, _CorrIntToEIRAdd:money, _NewCorrIntToEIR:money )
      var
         Counter = 0;

      while( ( Counter < this.Size ) and 
             (this.(Counter).Portfolio != _Portfolio )
           )
         Counter = Counter + 1;
      end;

      if( this.Size > Counter )
         if( this.(Counter).Portfolio != _Portfolio )
            this.(Counter) = PortfSum(_Portfolio, _IncomeSum, _DiscountIncomeSum, _DiscountIncomeAdd, _NotCarryDiscountSum, _Discount0_korr,
                                      _InterestIncomeAdd, _NewInterestIncome, _BonusAdd, _NewBonus, _DefDiffSum,
                                      _AccountedDefDiffAdd, _NewAccountedDefDiff, _DefDiff0_korr, _CorrIntToEIRAdd, _NewCorrIntToEIR );
         else
            this.(Counter).IncomeSum           = this.(Counter).IncomeSum           + _IncomeSum;
            this.(Counter).DiscountIncomeSum   = this.(Counter).DiscountIncomeSum   + _DiscountIncomeSum;
            this.(Counter).DiscountIncomeAdd   = this.(Counter).DiscountIncomeAdd   + _DiscountIncomeAdd;
            this.(Counter).NotCarryDiscountSum = this.(Counter).NotCarryDiscountSum + _NotCarryDiscountSum;
            this.(Counter).Discount0_korr      = this.(Counter).Discount0_korr      + _Discount0_korr;
            this.(Counter).InterestIncomeAdd   = this.(Counter).InterestIncomeAdd   + _InterestIncomeAdd; 
            this.(Counter).NewInterestIncome   = this.(Counter).NewInterestIncome   + _NewInterestIncome; 
            this.(Counter).BonusAdd            = this.(Counter).BonusAdd            + _BonusAdd;
            this.(Counter).NewBonus            = this.(Counter).NewBonus            + _NewBonus; 
            this.(Counter).DefDiffSum          = this.(Counter).DefDiffSum          + _DefDiffSum; 
            this.(Counter).AccountedDefDiffAdd = this.(Counter).AccountedDefDiffAdd + _AccountedDefDiffAdd; 
            this.(Counter).NewAccountedDefDiff = this.(Counter).NewAccountedDefDiff + _NewAccountedDefDiff; 
            this.(Counter).DefDiff0_korr       = this.(Counter).DefDiff0_korr       + _DefDiff0_korr; 
            this.(Counter).CorrIntToEIRAdd     = this.(Counter).CorrIntToEIRAdd     + _CorrIntToEIRAdd; 
            this.(Counter).NewCorrIntToEIR     = this.(Counter).NewCorrIntToEIR     + _NewCorrIntToEIR; 
         end;
      else
         this.(Counter) = PortfSum(_Portfolio, _IncomeSum, _DiscountIncomeSum, _DiscountIncomeAdd, _NotCarryDiscountSum, _Discount0_korr,
                                      _InterestIncomeAdd, _NewInterestIncome, _BonusAdd, _NewBonus, _DefDiffSum,
                                      _AccountedDefDiffAdd, _NewAccountedDefDiff, _DefDiff0_korr, _CorrIntToEIRAdd, _NewCorrIntToEIR );
      end;
   end;
   // сохранить суммы
   macro SaveSum(FD, dat)
      var i = 0;
      while( i < this.Size )
         if (this(i).Portfolio == KINDPORT_TRADE) /* ССПУ_ЦБ, Ц/б, оцениваемые по СС через прибыль или убыток */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_INCOMESUM,           this(i).IncomeSum           ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_DISCOUNTINCOMESUM,   this(i).DiscountIncomeSum   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_NOTCARRYDISCOUNTSUM, this(i).NotCarryDiscountSum ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SUM_DISCOUNT0_KORR_TP,             this(i).Discount0_korr       ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_INTERESTINCOMEADD,   this.(i).InterestIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_NEWINTERESTINCOME,   this.(i).NewInterestIncome   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_BONUSADD,            this.(i).BonusAdd            ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_NEWBONUS,            this.(i).NewBonus            ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_DEFDIFFSUM,          this.(i).DefDiffSum          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_ACCOUNTEDDEFDIFFADD, this.(i).AccountedDefDiffAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_NEWACCOUNTEDDEFDIFF, this.(i).NewAccountedDefDiff ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_DEFDIFF0_KORR,       this(i).DefDiff0_korr        ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_PARTIAL_CORRINTTOEIRADD,     this(i).CorrIntToEIRAdd      ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_TRADE_COUPON_NEWCORRINTTOEIR,      this(i).NewCorrIntToEIR      ) )
               msgbox("Ошибка при сохранении дохода по учету ЧП");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_SALE) /* СССД_ЦБ, Ц/б, оцениваемые по СС через прочий совокупный доход */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_INCOMESUM,           this(i).IncomeSum           ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_DISCOUNTINCOMESUM,   this(i).DiscountIncomeSum   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_NOTCARRYDISCOUNTSUM, this(i).NotCarryDiscountSum ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SUM_DISCOUNT0_KORR_PPR,           this(i).Discount0_korr      ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_INTERESTINCOMEADD,   this.(i).InterestIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_NEWINTERESTINCOME,   this.(i).NewInterestIncome   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_BONUSADD,            this.(i).BonusAdd            ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_NEWBONUS,            this.(i).NewBonus            ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_DEFDIFFSUM,          this.(i).DefDiffSum          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_ACCOUNTEDDEFDIFFADD, this.(i).AccountedDefDiffAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_NEWACCOUNTEDDEFDIFF, this.(i).NewAccountedDefDiff ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_DEFDIFF0_KORR,       this(i).DefDiff0_korr        ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_PARTIAL_CORRINTTOEIRADD,     this(i).CorrIntToEIRAdd      ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SALE_COUPON_NEWCORRINTTOEIR,      this(i).NewCorrIntToEIR      ) ) 
               msgbox("Ошибка при сохранении дохода по учету ЧП");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_RETIRE) /* АС_ЦБ, Ц/б, оцениваемые по амортизированной стоимости */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_INCOMESUM,           this(i).IncomeSum           ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_DISCOUNTINCOMESUM,   this(i).DiscountIncomeSum   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_DISCOUNTINCOMEADD,   this(i).DiscountIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_NOTCARRYDISCOUNTSUM, this(i).NotCarryDiscountSum ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_SUM_DISCOUNT0_KORR_PUDP,            this(i).Discount0_korr      ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_INTERESTINCOMEADD,   this.(i).InterestIncomeAdd   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_NEWINTERESTINCOME,   this.(i).NewInterestIncome   ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_BONUSADD,            this.(i).BonusAdd            ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_NEWBONUS,            this.(i).NewBonus            ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_DEFDIFFSUM,          this.(i).DefDiffSum          ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_ACCOUNTEDDEFDIFFADD, this.(i).AccountedDefDiffAdd ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_NEWACCOUNTEDDEFDIFF, this.(i).NewAccountedDefDiff ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_DEFDIFF0_KORR,       this(i).DefDiff0_korr        ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_PARTIAL_CORRINTTOEIRADD,     this(i).CorrIntToEIRAdd      ) or
                not SavePortfolioSum(FD, dat, DLSUM_KIND_RETIRE_COUPON_NEWCORRINTTOEIR,      this(i).NewCorrIntToEIR      ) ) 
               msgbox("Ошибка при сохранении дохода по учету ЧП");
               return false;
            end;
         elif (this(i).Portfolio == KINDPORT_BACK) /* ПВО, Портфель ц/б, полученные на возвратной основе */
            if (not SavePortfolioSum(FD, dat, DLSUM_KIND_OD_PARTIAL_INCOMESUM, this(i).IncomeSum ) )
               msgbox("Ошибка при сохранении дохода по учету ЧП");
               return false;
            end;
         end;
         i = i + 1;
      end;

      return true;
   end;

   macro AddLine2(kind, sum)
      // KINDPORT_TRADE ССПУ_ЦБ, Ц/б, оцениваемые по СС через прибыль или убыток 
      if   (kind == DLSUM_KIND_TRADE_PARTIAL_INCOMESUM)
         AddLine(KINDPORT_TRADE, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_DISCOUNTINCOMESUM)
         AddLine(KINDPORT_TRADE, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_NOTCARRYDISCOUNTSUM)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_INTERESTINCOMEADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_NEWINTERESTINCOME)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_BONUSADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_NEWBONUS)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_DEFDIFFSUM)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_ACCOUNTEDDEFDIFFADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_NEWACCOUNTEDDEFDIFF)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_DEFDIFF0_KORR)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_CORRINTTOEIRADD)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_TRADE_PARTIAL_NEWCORRINTTOEIR)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum);
      // KINDPORT_SALE // СССД_ЦБ, Ц/б, оцениваемые по СС через прочий совокупный доход
      elif (kind == DLSUM_KIND_SALE_PARTIAL_INCOMESUM)
         AddLine(KINDPORT_SALE, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_DISCOUNTINCOMESUM)
         AddLine(KINDPORT_SALE, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_NOTCARRYDISCOUNTSUM)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_INTERESTINCOMEADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_NEWINTERESTINCOME)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_BONUSADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_NEWBONUS)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_DEFDIFFSUM)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_ACCOUNTEDDEFDIFFADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_NEWACCOUNTEDDEFDIFF)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_DEFDIFF0_KORR)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_CORRINTTOEIRADD)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_SALE_PARTIAL_NEWCORRINTTOEIR)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum);
      // KINDPORT_RETIRE // АС_ЦБ, Ц/б, оцениваемые по амортизированной стоимости
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_INCOMESUM)
         AddLine(KINDPORT_RETIRE, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_DISCOUNTINCOMESUM)
         AddLine(KINDPORT_RETIRE, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_DISCOUNTINCOMEADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_NOTCARRYDISCOUNTSUM)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_INTERESTINCOMEADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_NEWINTERESTINCOME)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_BONUSADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_NEWBONUS)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_DEFDIFFSUM)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_ACCOUNTEDDEFDIFFADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_NEWACCOUNTEDDEFDIFF)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_DEFDIFF0_KORR)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_CORRINTTOEIRADD)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum, $0.0);
      elif (kind == DLSUM_KIND_RETIRE_PARTIAL_NEWCORRINTTOEIR)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, sum);
      // KINDPORT_BACK // ПВО,  Портфель ц/б, полученные на возвратной основе
      elif (kind == DLSUM_KIND_OD_PARTIAL_INCOMESUM)
         AddLine(KINDPORT_BACK, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SUM_DISCOUNT0_KORR_TP)
         AddLine(KINDPORT_TRADE, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SUM_DISCOUNT0_KORR_PPR)
         AddLine(KINDPORT_SALE, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      elif (kind == DLSUM_KIND_SUM_DISCOUNT0_KORR_PUDP)
         AddLine(KINDPORT_RETIRE, $0.0, $0.0, $0.0, $0.0, sum, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0, $0.0);
      end;
   end;
end;

private macro ЗаполнитьТОПоКупонуЧП( FD:SPFirstDoc, dat:DATE, Summa:MONEY, SumFIID:INTEGER, Type:INTEGER, p_NeedKvit:bool,
                                     FactReceiverID:integer, IsConfirmed:string, TaxRateBuy:double, TaxSumBuy:money, TaxRateSell:double, TaxSumSell:money ):TRecHandler
  var DlRq = TRecHandler("dlrq");
  var tick = TRecHandler("dl_tick");
  var v_NeedKvit = iif((p_NeedKvit!=null),p_NeedKvit,false);
  
  DlRq.Clear();
  DlRq.rec.DocKind  = FD.tick.rec.BOfficeKind;
  DlRq.rec.DocID    = FD.tick.rec.DealID;
  DlRq.rec.DealPart = 2;
  
  if( IsSale(FD.Group) ) /* прямое РЕПО */
    DlRq.rec.Kind = DLRQ_KIND_REQUEST;
  else
    DlRq.rec.Kind = DLRQ_KIND_COMMIT;
  end;

  DlRq.rec.SubKind = DLRQ_SUBKIND_CURRENCY;
  DlRq.rec.Type    = Type;
  DlRq.rec.Amount  = Summa;
  DlRq.rec.FIID    = SumFIID;

  if( IsBasket(FD.Group) and (not IsExchange( FD.Group ) ) )
     DlRq.rec.Party = FD.tick.rec.PartyID;
  else
     if( FD.СделкаОРЦБ() )
       DlRq.rec.Party = FD.tick.rec.MarketID;
     else
       DlRq.rec.Party = FD.tick.rec.PartyID;
     end;
  end;

  DlRq.rec.RqAccID  = 0; /* заполнится автоматически */
  tick.Clear();
  copy(tick, FD.tick);
  FillPlaceRQ(tick, FD.dl_leg, DlRq);

  DlRq.rec.PlanDate = dat;

  if( v_NeedKvit )
     DlRq.rec.State    = DLRQ_STATE_PLAN;
  else
     DlRq.rec.State    = DLRQ_STATE_EXEC;
     DlRq.rec.FactDate = dat;
  end;

  if(FD.СделкаОРЦБ())
    DlRq.rec.Cliring  = SET_CHAR;
  end;

  if(IsLoan(FD.Group))
    DlRq.rec.Source = FD.GetRQ(DLRQ_TYPE_INCREPO, 2).rec.ID;
  else
    DlRq.rec.Source = FD.GetRQ(DLRQ_TYPE_PAYMENT, 2).rec.ID;
  end;

  DlRq.rec.FactReceiverID = IIF(ValType(FactReceiverID) == V_UNDEF, -1,         FactReceiverID);
  DlRq.rec.IsConfirmed    = IIF(ValType(IsConfirmed)    == V_UNDEF, UNSET_CHAR, IsConfirmed);   
  DlRq.rec.TaxRateBuy     = IIF(ValType(TaxRateBuy)     == V_UNDEF, 0.0,        TaxRateBuy);    
  DlRq.rec.TaxSumBuy      = IIF(ValType(TaxSumBuy)      == V_UNDEF, $0,         TaxSumBuy);     
  DlRq.rec.TaxRateSell    = IIF(ValType(TaxRateSell)    == V_UNDEF, 0.0,        TaxRateSell);   
  DlRq.rec.TaxSumSell     = IIF(ValType(TaxSumSell)     == V_UNDEF, $0,         TaxSumSell);    

  FD.SetRQ(DlRq);

  return DlRq;
end;

macro GetWrtOffAmountOR(FD, dat)
   var DataSelect;
   /* все списания продажами, ОР, и (ПР где ТО поставки 2ч ПР исполнено и его дата < даты учета купона) */

   var Select = RSDCommand(" SELECT NVL(Sum(lnk.t_Amount),0) Amount " +
                           "   FROM dpmwrtlnk_dbt lnk, dpmwrtsum_dbt sale, dpmwrtsum_dbt buy " +
                           "  WHERE (buy.t_SumID  = ? or buy.t_Source  = ?)" +
                           "    AND lnk.t_BuyID  = buy.t_SumID " +
                           "    AND lnk.t_SaleID = sale.t_SumID " +
                           "    AND ((sale.t_Kind = 10 ) OR " + //WRTSUM_KIND_S
                           "         (sale.t_Kind = 30 ) OR " + //WRTSUM_KIND_FS
                           "         (sale.t_Kind = 80 ) OR " + //WRTSUM_KIND_MS
                           "         (sale.t_Kind = 190 AND sale.t_DealID <> ?) " + //WRTSUM_KIND_RRWAS2
                           "        ) "
                          );

   Select.addParam("", RSDBP_IN, FD.pmwrtsum.rec.SumID);
   Select.addParam("", RSDBP_IN, FD.pmwrtsum.rec.SumID);
   Select.addParam("", RSDBP_IN, FD.tick.rec.DealID);

   Select.execute();

   DataSelect = TRsbDataSet(Select);
   if( DataSelect.MoveNext() )
      return money(DataSelect.Amount);
   else
      return $0;
   end;
end;

Private Macro  получить_колич_бумаг_корзина (FIID, DealID, Number)
  var query, cmd, DataSet;
    query = " SELECT NVL ( "+
            "   SUM ( CASE WHEN ens.t_kind =" + TICKENS_KIND_IN +
            "                          THEN ens.t_Principal "+
            "       ELSE (0 - ens.t_Principal) END), "+
            "   0)  amount "+
            "   FROM DDL_TICK_ENS_DBT ens "+
            "       WHERE     ens.t_fiid = ? "+
            "             AND ens.t_dealID = ? "+
            "             AND ens.t_date <= "+
            "                   (SELECT fw.t_listdate "+
            "                      FROM dfiwarnts_dbt fw "+
            "                     WHERE     fw.t_ispartial = CHR (0) "+
            "                           AND fw.t_fiid = ? "+
            "                           AND fw.t_number = ?) "
            ;
  cmd = DL_RSDCommand(query);
  cmd.AddParam(FIID);
  cmd.AddParam(DealID);
  cmd.AddParam(FIID);
  cmd.AddParam(Number);

  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    return DataSet.Amount
  else 
    return $0;
  end;

end;
macro ВыполнитьУчетДоходаКупонаНаЛоте( FD, FD2, dat, PlanDate, COUPON_SUM, CalcSumFIID, Number )
  VAR j = 0, DrawingDate;
  VAR CurSum              = $0,      // Распределяемая сумма купонного дохода по сделке
      CurAmount           = $0,      // Распределяемое количество по сделке
      Portfolio           = -1,      // Исходный портфель (из которого зачислен лот)
      IncomeSum           = $0,      // Сумма купонного дохода (сумма купона по 1 цб* кол-во ц/б)
      NKD                 = $0,      // Сумма уплаченного НКД (НКДупл)
      InterestIncomeSum   = $0,      // Начисленный ПД (ПДначисл)
      InterestIncomeAdd   = $0,      // Доначисленный ПД SдоначПД)
      NotCarryInterestSum = $0,      // Не отнесенный на доходы ПД  (ПДне_отн)            
      NewBalanceCost      = $0,      // Новая текущая стоимость 
      BonusAdd            = $0,      // Доначисленная премия (?(SдоначПр))
      NewBonus            = $0,      // Новая премия                      
      NewCost             = $0,      // Новая чистая стоимость            
      NewNotWrtBonus      = $0,      // Новая премия, не отнесённая на расходы
      DiscountIncomeAdd   = $0,      // Доначисленный дисконт
      NewDiscountIncome   = $0,      // Новый начисленный дисконт
      AccountedDefDiffAdd = $0,      // Доначисленная отсроченная разница
      NewAccountedDefDiff = $0,      // Новая начисленная отсроченная разница
      CorrIntToEIRAdd     = $0,      // Доначисленная корректировка % до ЭПС
      NewCorrIntToEIR     = $0;      // Новое значение корректировки % до ЭПС

  var PortfolioSum = TDataPortfSumCoupon(); /*сбор сумм лотов по портфелям*/
  var CurAmountBasket = 0;
  CurSum = COUPON_SUM;
  CurAmount = FD2.Principal(PlanDate);

  If(IsBasket(FD.Group))
    CurAmountBasket = получить_колич_бумаг_корзина(FD.CurPFI(), FD.tick.rec.DealID, Number);
    if( CurAmountBasket > 0)
      CurAmount = CurAmountBasket;
    end;
  end;

  if( FD.FaceFIID() != CalcSumFIID )
     if( SmartConvertSum(CurSum, CurSum, PlanDate, CalcSumFIID, FD.FaceFIID(), true) == false )
        return false;
     end;
  end;
   
  if( not IsClientDeal(FD.tick.rec) )
    while (FD2.pmwrtsum(j) != null)
      if (FD2.pmwrtsum(j).rec.State != PM_WRTSUM_FORM)
        if (IsSale(FD.Group))
          if (WRTCalcCouponIncome(FD2.pmwrtsum(j).rec.SumID,
                                  Number, /*номер купона*/
                                  PlanDate,
                                  CurSum,
                                  CurAmount,
                                  Portfolio,                
                                  IncomeSum,                
                                  NKD,        
                                  InterestIncomeSum,        
                                  InterestIncomeAdd,      
                                  NewBalanceCost,
                                  BonusAdd,
                                  NewBonus,
                                  NewCost,
                                  DiscountIncomeAdd,
                                  NewDiscountIncome,
                                  AccountedDefDiffAdd,
                                  NewAccountedDefDiff,
                                  CorrIntToEIRAdd,
                                  NewCorrIntToEIR
                                 ) == false)
            MsgBox("Ошибка при получении сумм по учету купона");
            return false;
          end;
          if (Portfolio != KINDPORT_BACK) // не из ПВО
            FD2.pmwrtsum(j).rec.BalanceCost = NewBalanceCost;                                   
            FD2.pmwrtsum(j).rec.Cost        = NewCost;                                          
            FD2.pmwrtsum(j).rec.Bonus       = NewBonus;
            FD2.pmwrtsum(j).rec.NotWrtBonus = NewNotWrtBonus;
            FD2.pmwrtsum(j).rec.DiscountIncome   = NewDiscountIncome;
            FD2.pmwrtsum(j).rec.AccountedDefDiff = NewAccountedDefDiff;
            FD2.pmwrtsum(j).rec.CorrIntToEIR     = NewCorrIntToEIR;
                                                                                             
            if (ПолучитьДатуПогашения( UNSET_CHAR, FD2.CurPFI(), Number, DrawingDate ))
              FD2.pmwrtsum(j).rec.DiscountDate     = DrawingDate;                                 
              FD2.pmwrtsum(j).rec.InterestDate     = DrawingDate;                                 
              FD2.pmwrtsum(j).rec.DefDiffDate      = DrawingDate;
              FD2.pmwrtsum(j).rec.BonusDate        = DrawingDate;
              FD2.pmwrtsum(j).rec.CorrIntToEIRDate = DrawingDate;
            else                                                                                
              FD2.pmwrtsum(j).rec.DiscountDate     = PlanDate;
              FD2.pmwrtsum(j).rec.InterestDate     = PlanDate;
              FD2.pmwrtsum(j).rec.DefDiffDate      = PlanDate;
              FD2.pmwrtsum(j).rec.BonusDate        = PlanDate;                                         
              FD2.pmwrtsum(j).rec.CorrIntToEIRDate = PlanDate;                                        
            end;                                                                                
          else
            FD2.pmwrtsum(j).rec.BalanceCost = NewBalanceCost;
          end;

          PortfolioSum.AddLine(Portfolio,IncomeSum,BonusAdd,NKD,InterestIncomeSum,InterestIncomeAdd,NotCarryInterestSum, DiscountIncomeAdd, NewDiscountIncome, 
                     AccountedDefDiffAdd, NewAccountedDefDiff, CorrIntToEIRAdd, NewCorrIntToEIR );

          if( not ОбновитьЛот( FD2.pmwrtsum(j), PM_WRTSUM_UPDTMODE_COUPON, PlanDate, FD2) )
            msgbox("Ошибка при обновлении лота"); 
            return false;
          end;
        else
          if((CurAmount > 0) and (FD2.pmwrtsum(j).rec.AmountBD > 0) and (FD2.pmwrtsum(j).rec.BalanceCostBD > 0))

            FD2.pmwrtsum(j).rec.BalanceCostBD = FD2.pmwrtsum(j).rec.BalanceCostBD - round(CurSum * FD2.pmwrtsum(j).rec.AmountBD / CurAmount, 2);

            if(FD2.pmwrtsum(j).rec.BalanceCostBD < 0)
              FD2.pmwrtsum(j).rec.BalanceCostBD = 0;
            end;

            if( not ОбновитьЛот( FD2.pmwrtsum(j), PM_WRTSUM_UPDTMODE_COUPON, PlanDate, FD2) )
              msgbox("Ошибка при обновлении лота"); 
              return false;
            end;
          end;
        end;
      end; 

      j = j + 1;
    end;

    if (IsSale(FD.Group))
      if ((CurSum != $0.) and (CurAmount != $0.))
        MsgBox("Ошибка при получении сумм к списанию по учету купона");
        return false;
      end; 
      /* сохранение сумм доходов */
      PortfolioSum.SaveSum(FD2, dat);
    end;
  end; 

  return true;
end;

/* аналог общей функции только RSI_GetRQACC вместо RSI_GetAnyRQACC */
private macro ПолучитьПлатежныеРеквизитыСубъектаПоСделке(DocKind, DocID, PartyID, SubKind, PayFIID, RqType, RqAccBuff:TBFile)
  var query, Select, DataSet;
  var err = 0;

  RqAccBuff.Clear();

  query =   "select rqacc.* "
          + "  from ddlrqacc_dbt rqacc "
          + " where rqacc.t_ID = RSI_DLRQ.RSI_GetRQACC(?, ?, ?, ?, ?, ?) ";

  Select = Dl_RSDCommand(query);
  Select.AddParam(DocKind);
  Select.AddParam(DocID);
  Select.AddParam(SubKind);
  Select.AddParam(PartyID);
  Select.AddParam(PayFIID);
  Select.AddParam(RqType);

  DataSet = Select.Execute();
  if(DataSet.moveNext())
    DataSet.GetRecord().CopyTo( RqAccBuff.rec );
  else
    err = 1;
  end;

  return err;
end;

private macro ВставитьПлатежныеРеквизиты( FD:SPFirstDoc, dat:DATE, SumFIID:INTEGER ):integer
  var rRqAcc = TBFile( "dlrqacc.dbt", "W", 0 );
  var rSA    = TRecHandler( "settacc.dbt" );

  var Party:integer = -1;
  if( IsBasket(FD.Group) and (not IsExchange( FD.Group ) ) )
     Party = FD.tick.rec.PartyID;
  else
     if( FD.СделкаОРЦБ() )
       Party = FD.tick.rec.MarketID;
     else
       Party = FD.tick.rec.PartyID;
     end;
  end;

  rRqAcc.Clear();
  if(ПолучитьПлатежныеРеквизитыСубъектаПоСделке(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, Party, DLRQ_SUBKIND_CURRENCY, SumFIID, DLRQ_TYPE_UNKNOWN, rRqAcc) != 0) /*нет подходящих платежных реквизитов*/
    rSA.Clear();
    if( (SP_GetPartySETTACC(Party, 0, SumFIID, FIKIND_CURRENCY, PTSK_STOCKDL, rSA, FD.tick.rec.DealType) == 0) and (rSA.rec.FIID == SumFIID) ) /*нашли и в нужной валюте*/
      /*создать новые платежные реквизиты*/
      rRqAcc.rec.ID               = 0;
      rRqAcc.rec.DocKind          = FD.tick.rec.BofficeKind;
      rRqAcc.rec.DocID            = FD.tick.rec.DealID;
      rRqAcc.rec.SubKind          = DLRQ_SUBKIND_CURRENCY;     
      rRqAcc.rec.Type             = DLRQ_TYPE_UNKNOWN;
      rRqAcc.rec.Party            = Party;
      rRqAcc.rec.FIID             = rSA.rec.FIID;
      rRqAcc.rec.BankID           = rSA.rec.BankID;
      rRqAcc.rec.Chapter          = rSA.rec.Chapter;
      rRqAcc.rec.Account          = rSA.rec.Account;
      rRqAcc.rec.BankCodeKind     = rSA.rec.BankCodeKind;
      rRqAcc.rec.BankCode         = rSA.rec.BankCode;
      rRqAcc.rec.BankName         = rSA.rec.BankName;
      rRqAcc.rec.BankCorrID       = rSA.rec.BankCorrID;
      rRqAcc.rec.BankCorrCodeKind = rSA.rec.BankCorrCodeKind;
      rRqAcc.rec.BankCorrCode     = rSA.rec.BankCorrCode;
      rRqAcc.rec.BankCorrName     = rSA.rec.BankCorrName;
      rRqAcc.rec.CorrAcc          = rSA.rec.CorrAcc;

      if( not rRqAcc.insert() )
        MsgBox("Ошибка вставки платежных реквизитов по сделке с ID = " + string(FD.tick.rec.DealID) );
        return 1;
      end;
    else
      MsgBox("Не найдена СПИ по валюте " + ПолучитьКодФинИн(SumFIID) + " для субъекта " + ПолучитьКодСубъекта(Party, PTCK_CONTR));
      return 1;
    end;
  end;

  return 0;
end;

macro ВыполнитьУчетКупонаВРепо( FD, FD2, dat, COUPON_SUM, CalcSumFIID, CalcWrtTime:time, ReturnIncomeKind:integer, p_NeedKvit:bool,
                                FactReceiverID:integer, IsConfirmed:string, TaxRateBuy:double, TaxSumBuy:money, TaxRateSell:double, TaxSumSell:money)
  var v_NeedKvit = iif(p_NeedKvit!=null,p_NeedKvit,false);
  var DlRq = ЗаполнитьТОПоКупонуЧП(FD2, dat, COUPON_SUM, CalcSumFIID, DLRQ_TYPE_PAYMREPOCOUP, v_NeedKvit, FactReceiverID, IsConfirmed, TaxRateBuy, TaxSumBuy, TaxRateSell, TaxSumSell );
  var RetVal = ВставитьПлатежныеРеквизиты(FD2, dat, CalcSumFIID);

  if( RetVal == 0 )

     var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
     GrDealPrm.Clear();
     GrDealPrm.rec.ReturnIncomeKind = ReturnIncomeKind;

     RetVal = DL_CreateDLRQ_GrDeal(DlRq, dat, DLRQ_ACTION_CREATE, DLGR_TEMPL_COUP, CalcWrtTime, FD.CurPFI(), GrDealPrm);
  end;

  return RetVal;
end;

macro ВыполнитьУчетДоходаЧПНаЛоте(FD, FD2, dat, PlanDate, COUPON_SUM, CalcSumFIID, Number)
  VAR j = 0, DrawingDate;
  VAR CurSum                    = $0, // Распределяемая сумма дохода ЧП по сделке
      CurAmount                 = $0, // Распределяемое количество по сделке
      Portfolio                 = -1, // Исходный портфель (из которого зачислен лот)
      IncomeSum                 = $0, // Сумма дохода по ЧП (полученная сумма ЧП  = сумма ЧП по 1 цб* кол-во ц/б)
      DiscountIncomeSum         = $0, // Доля дисконта Sдоля_дисконта)
      DiscountIncomeAdd         = $0, // Доначисленный ДД (SдоначДД)
      NotCarryDiscountSum       = $0, // Не отнесенный на доходы ДД  (ДДне_отн)
      NewCost                   = $0, // Новая чистая стоимость 
      NewBalanceCost            = $0, // Новая текущая стоимость 
      NewOutlay                 = $0, // Новые затраты
      NewDiscountIncome         = $0, // Новый ДД
      NewNotCarryDiscountIncome = $0, // Новый не отнесенный на доходы ДД
      Discount0_korr            = $0, // Коррекция дисконта
      NewDiscount0              = $0, // Новый начальный дисконт (занести в лот)
      InterestIncomeAdd         = $0, // Доначисленный ПД
      NewInterestIncome         = $0, // Новый ПД
      BonusAdd                  = $0, // Доначисленная премия
      NewBonus                  = $0, // Новая начисленная премия
      DefDiffSum                = $0, // Доля отсроченной разницы, приходящаяся на ЧП
      AccountedDefDiffAdd       = $0, // Доначисленная отсроченная разница
      NewAccountedDefDiff       = $0, // Новая начисленная отсроченная разница
      DefDiff0_korr             = $0, // Корректировка начальной отсроченной разницы
      NewDefDiff0               = $0, // Новая начальная отсроченная разница
      CorrIntToEIRAdd           = $0, // Доначисленная корректировка % до ЭПС
      NewCorrIntToEIR           = $0; // Новое значение корректировки % до ЭПС
  
  var PortfolioSum = TDataPortfSumPartial(); /*сбор сумм лотов по портфелям*/
  
  CurSum = COUPON_SUM;
  CurAmount = FD2.Principal(PlanDate);

  if( FD.FaceFIID() != CalcSumFIID )
     if( SmartConvertSum(CurSum, CurSum, PlanDate, CalcSumFIID, FD.FaceFIID(), true) == false )
        return false;
     end;
  end;

  if( not IsClientDeal(FD.tick.rec) )

    while (FD2.pmwrtsum(j) != null)
      if (FD2.pmwrtsum(j).rec.State != PM_WRTSUM_FORM)
        if (WRTCalcPartialIncome(FD2.pmwrtsum(j).rec.SumID,
                                 Number, /*номер ЧП*/
                                 PlanDate,
                                 CurSum,
                                 CurAmount,
                                 Portfolio,                
                                 IncomeSum,                
                                 DiscountIncomeSum,        
                                 DiscountIncomeAdd,        
                                 NewCost,                  
                                 NewBalanceCost,           
                                 NewOutlay,                
                                 NewDiscountIncome,        
                                 Discount0_korr,
                                 NewDiscount0,
                                 InterestIncomeAdd,
                                 NewInterestIncome,
                                 BonusAdd,
                                 NewBonus,
                                 DefDiffSum,
                                 AccountedDefDiffAdd,
                                 NewAccountedDefDiff,
                                 DefDiff0_korr,
                                 NewDefDiff0,
                                 CorrIntToEIRAdd,
                                 NewCorrIntToEIR
                                ) == false)
          MsgBox("Ошибка при получении сумм по учету ЧП");
          return false;
        else
          if (Portfolio != KINDPORT_BACK) // не из ПВО
            FD2.pmwrtsum(j).rec.Cost             = NewCost;
            FD2.pmwrtsum(j).rec.BalanceCost      = NewBalanceCost;
            FD2.pmwrtsum(j).rec.Outlay           = NewOutlay;
            FD2.pmwrtsum(j).rec.DiscountIncome   = NewDiscountIncome;
            FD2.pmwrtsum(j).rec.NotCarryDiscount = NewNotCarryDiscountIncome;
            FD2.pmwrtsum(j).rec.BegDiscount      = NewDiscount0;
            FD2.pmwrtsum(j).rec.Bonus            = NewBonus;
            FD2.pmwrtsum(j).rec.InterestIncome   = NewInterestIncome;
            FD2.pmwrtsum(j).rec.BegDefDiff       = NewDefDiff0;
            FD2.pmwrtsum(j).rec.AccountedDefDiff = NewAccountedDefDiff;
            FD2.pmwrtsum(j).rec.CorrIntToEIR     = NewCorrIntToEIR;

            if (ПолучитьДатуПогашения( SET_CHAR, FD2.CurPFI(), Number, DrawingDate ))
              FD2.pmwrtsum(j).rec.DiscountDate  = DrawingDate;
              FD2.pmwrtsum(j).rec.InterestDate     = DrawingDate;
              FD2.pmwrtsum(j).rec.DefDiffDate      = DrawingDate;
              FD2.pmwrtsum(j).rec.BonusDate        = DrawingDate;
              FD2.pmwrtsum(j).rec.CorrIntToEIRDate = DrawingDate;
            else
              FD2.pmwrtsum(j).rec.DiscountDate  = PlanDate;
              FD2.pmwrtsum(j).rec.InterestDate     = PlanDate;
              FD2.pmwrtsum(j).rec.DefDiffDate      = PlanDate;
              FD2.pmwrtsum(j).rec.BonusDate        = PlanDate;
              FD2.pmwrtsum(j).rec.CorrIntToEIRDate = PlanDate;
            end;
          else
            FD2.pmwrtsum(j).rec.BalanceCost = NewBalanceCost;
          end;

          PortfolioSum.AddLine(Portfolio, IncomeSum, DiscountIncomeSum, DiscountIncomeAdd, NotCarryDiscountSum, Discount0_korr,
                                 InterestIncomeAdd,
                                 NewInterestIncome,
                                 BonusAdd,
                                 NewBonus,
                                 DefDiffSum,
                                 AccountedDefDiffAdd,
                                 NewAccountedDefDiff,
                                 DefDiff0_korr,
                                 CorrIntToEIRAdd,
                                 NewCorrIntToEIR);

          if( not ОбновитьЛот( FD2.pmwrtsum(j), PM_WRTSUM_UPDTMODE_PARTIAL, PlanDate, FD2) )
            msgbox("Ошибка при обновлении лота"); 
            return false;
          end; 
        end;
      end;

      j = j + 1;
    end; 

    if ((CurSum != $0) and (CurAmount != $0))
      MsgBox("Ошибка при получении сумм к списанию по учету ЧП");
      return false;
    end; 
    /* сохранение сумм доходов */
    PortfolioSum.SaveSum(FD2, dat);
  end; 
  return true;
end;

macro ВыполнитьУчетЧПВРепо( FD, FD2, dat, COUPON_SUM, CalcSumFIID, CalcWrtTime:time, ReturnIncomeKind:integer, p_NeedKvit:bool  )
  var v_NeedKvit = iif(p_NeedKvit!=null,p_NeedKvit,false);
  var DlRq = ЗаполнитьТОПоКупонуЧП(FD2, dat, COUPON_SUM, CalcSumFIID, DLRQ_TYPE_PAYMREPOPART, v_NeedKvit);
  var RetVal = ВставитьПлатежныеРеквизиты(FD2, dat, CalcSumFIID);

  if( RetVal == 0 )

     var GrDealPrm = TRecHandler("dlgrdealprm.dbt");
     GrDealPrm.Clear();
     GrDealPrm.rec.ReturnIncomeKind = ReturnIncomeKind;

     RetVal = DL_CreateDLRQ_GrDeal(DlRq, dat, DLRQ_ACTION_CREATE, DLGR_TEMPL_PARTREP, CalcWrtTime, FD.CurPFI(), GrDealPrm);
  end;

  return RetVal;
end;

macro СоздатьКомпенсационныйПлатежТО( FD:SPFirstDoc, dat:DATE, Summa:MONEY, SumFIID:INTEGER, Increase:bool, CalcWrtTime:time, p_NeedKvit:bool )
  var RetVal:integer = 0;
  var DlRq = TRecHandler("dlrq");
  var tick = TRecHandler("dl_tick");
  var CatDeb = "", CatCred = "", 
      PayFIID = FD.GetRQ(DLRQ_TYPE_PAYMENT, 2).rec.FIID, PaySum;

  var PayerAccountBuff = TRecHandler("account");
  var ReceiverAccountBuff = TRecHandler("account");
  var v_NeedKvit = iif(p_NeedKvit!=null,p_NeedKvit,false);

  DlRq.Clear();
  DlRq.rec.DocKind  = FD.tick.rec.BOfficeKind;
  DlRq.rec.DocID    = FD.tick.rec.DealID;
  DlRq.rec.DealPart = 2;
  
  if( IsSale(FD.Group) ) /* прямое РЕПО */
     if( Increase )
        DlRq.rec.Kind = DLRQ_KIND_REQUEST;
     else
        DlRq.rec.Kind = DLRQ_KIND_COMMIT;
     end;
  else /* обратное РЕПО */
     if( Increase )
        DlRq.rec.Kind = DLRQ_KIND_COMMIT;
     else
        DlRq.rec.Kind = DLRQ_KIND_REQUEST;
     end;
  end;

  DlRq.rec.SubKind = DLRQ_SUBKIND_CURRENCY;
  DlRq.rec.Type    = DLRQ_TYPE_COMPPAYM;
  DlRq.rec.Amount  = Summa;
  DlRq.rec.FIID    = SumFIID;

  if( IsBasket(FD.Group) and (not IsExchange( FD.Group) ) )
     DlRq.rec.Party = FD.tick.rec.PartyID;
  else
     if( FD.СделкаОРЦБ() )
        DlRq.rec.Party = FD.tick.rec.MarketID;
     else
        DlRq.rec.Party = FD.tick.rec.PartyID;
     end;
  end;

  DlRq.rec.RqAccID  = 0; //заполнится автоматически
  tick.Clear();
  copy(tick,FD.tick);
  FillPlaceRQ(tick,FD.dl_leg,DlRq);

  DlRq.rec.PlanDate = dat;

  if( v_NeedKvit )
     DlRq.rec.State    = DLRQ_STATE_PLAN;
  else
     DlRq.rec.State    = DLRQ_STATE_EXEC;
     DlRq.rec.FactDate = dat;
  end;

  if(FD.СделкаОРЦБ())
    DlRq.rec.Cliring  = SET_CHAR;
  end;

  DlRq.rec.Source = FD.GetRQ(DLRQ_TYPE_PAYMENT, 2).rec.ID;

  FD.SetRQ(DlRq);/*для определения места хр в проводке внутренненего учета*/

  RetVal = ВставитьПлатежныеРеквизиты(FD, dat, SumFIID);

  if( RetVal == 0 )
     RetVal = DL_CreateDLRQ_GrDeal(DlRq, dat, DLRQ_ACTION_CREATE, DLGR_TEMPL_COMPPAYMENT, CalcWrtTime, FD.tick.rec.PFI);
  end;

  return RetVal;
end;

macro СоздатьКомпенсационноеТОПоЦБ( FD:SPFirstDoc, dat:DATE, CalcWrtTime:time, Summa:MONEY, SumFIID:INTEGER, Increase:bool, GrDealPrm:TRecHandler, Tick_ENS:TRecHandler )
  var DlRq = TRecHandler("dlrq");
  var tick = TRecHandler("dl_tick");
  var dl_leg;

  DlRq.Clear();
  DlRq.rec.DocKind = FD.tick.rec.BOfficeKind;
  DlRq.rec.DocID   = FD.tick.rec.DealID;

  if( (Increase == NULL) or (Increase == false) )
     DlRq.rec.DealPart = 2;
     DlRq.rec.Source   = FD.GetRQ(DLRQ_TYPE_DELIVERY, 2).rec.ID;
     dl_leg = FD.dl_leg;
  else
     DlRq.rec.DealPart = 1;
     if( FD.ExistsRQ(DLRQ_TYPE_DELIVERY, 1) )
        DlRq.rec.Source = FD.GetRQ(DLRQ_TYPE_DELIVERY, 1).rec.ID;
     end;
     var FD_1 = SPFirstDoc(FD.tick, false);
     dl_leg = FD_1.dl_leg;
  end;

  if( (Increase == NULL) or (Increase == false) ) /*уменьшение*/
     if( IsSale(FD.Group) ) /* прямое РЕПО */
        DlRq.rec.Kind = DLRQ_KIND_REQUEST;
     else
        DlRq.rec.Kind = DLRQ_KIND_COMMIT;
     end;
  else /* увеличение */
     if( IsSale(FD.Group) ) /* прямое РЕПО */
        DlRq.rec.Kind = DLRQ_KIND_COMMIT;
     else
        DlRq.rec.Kind = DLRQ_KIND_REQUEST;
     end;
  end;

  DlRq.rec.SubKind = DLRQ_SUBKIND_AVOIRISS;
  DlRq.rec.Type    = DLRQ_TYPE_COMPDELIVERY;
  DlRq.rec.Amount  = Summa;
  DlRq.rec.FIID    = SumFIID;

  if( IsBasket(FD.Group) and (not IsExchange( FD.Group ) ) )
     DlRq.rec.Party = FD.tick.rec.PartyID;
  else
     if( FD.СделкаОРЦБ() )
        DlRq.rec.Party = FD.tick.rec.MarketID;
     else
        DlRq.rec.Party = FD.tick.rec.PartyID;
     end;
  end;

  DlRq.rec.RqAccID  = 0; /* заполнится автоматически */
  tick.Clear();
  copy(tick, FD.tick);
  FillPlaceRQ(tick, dl_leg, DlRq);
  DlRq.rec.State    = DLRQ_STATE_EXEC;
  DlRq.rec.PlanDate = dat;
  DlRq.rec.FactDate = dat;

  return DL_CreateDLRQ_GrDeal(DlRq, dat, DLRQ_ACTION_CREATE, DLGR_TEMPL_COMPDELIVERY, CalcWrtTime, SumFIID, GrDealPrm, Tick_ENS);
end;
