/*
$Name:        sp_cars.mac
$Module:      Ценные бумаги
$Description: Процедуры для проводок в операциях продажи ценных бумаг
*/
IMPORT "sp_car.mac", "sp_catac.mac", "sp_carrl.mac", "sp_carcm.mac","insdpdr.mac", "scservop.mac";

MACRO WRT_GetSaleFinResult_EX( 
                                  SaleID               :INTEGER,// 1  Списываемый лот
                                  Portfolio            :INTEGER,// 2  Портфель. Если не задан - игнорируется.
                                  ParentLot            :INTEGER,// 3  Метод учета лота по 1 ч.: 0  - Все лоты, 1 - Кроме лота по 1 ч., 2 -Только лот по 1 ч
                                  CostBuy              :@MONEY, // 4  Списанная чистая стоимость ( (Счист))
                                  BalanceCostBuy       :@MONEY, // 5  Списанная текущая стоимость 
                                  NKDBuy               :@MONEY, // 6  НКД ( (НКД упл.))
                                  InterestIncomeBuy    :@MONEY, // 7  Списанный начисленный ПД 
                                  DiscountIncomeBuy    :@MONEY, // 8  писанный начисленный ДД 
                                  NotCarryInterestBuy  :@MONEY, // 9  Списанный не отнесенный на доходы ПД  (?ПДне_отн)
                                  NotCarryDiscountBuy  :@MONEY, // 10 Списанный не отнесенный на доходы ДД  (?ДДне_отн)
                                  InterestIncomeAdd    :@MONEY, // 11 Доначисленный ПД (?Sдонач.ПДi)
                                  DiscountIncomeAdd    :@MONEY, // 12 Доначисленный ДД (?Sдонач.ДДi)
                                  NotCarryInterestAdd  :@MONEY, // 13 Доначисленный не отнесенный на доходы ПД  (?ПДне_отн)
                                  NotCarryDiscountAdd  :@MONEY, // 14 Доначисленный не отнесенный на доходы ДД  (?ДДне_отн)
                                  InterestIncomeSum    :@MONEY, // 15 Суммарный начисленный ПД (?ПДначисл)
                                  DiscountIncomeSum    :@MONEY, // 16 Суммарный начисленный ДД (?ДДначисл)
                                  NotCarryInterestSum  :@MONEY, // 17 Суммарный не отнесенный на доходы ПД  (?ПДне_отн)
                                  NotCarryDiscountSum  :@MONEY, // 18 Суммарный не отнесенный на доходы ДД  (?ДДне_отн)
                                  BalanceCostSum       :@MONEY, // 19 Суммарная текущая стоимость ( (Стек))
                                  OutlayBuy            :@MONEY, // 20 Списанные затраты
                                  OverAmountBuy        :@MONEY, // 21 Списанная сумма переоценки (?ПО)
                                  OverAmountAdd        :@MONEY, // 22 Сумма доначисленной переоценки
                                  OverAmountSum        :@MONEY, // 23 Суммарная списываемая переоценка
                                  ReservAmountBuy      :@MONEY, // 24 Списанная сумма резерва (Сумма созданного резерва)
                                  ReservAmountAdd      :@MONEY, // 25 Доначисленный резерв
                                  ReservAmountSum      :@MONEY, // 26 Сумма списываемого резерва
                                  BalanceCostBD        :@MONEY, // 27 Списанная стоимость в ОД (Часть остатка счета "- ОД", пропорциональная количеству ц/б, проданно-му из ТП и ППР)
                                  CostSale             :@MONEY, // 28 Проданная чистая стоимость (в ЧП - Sчпл)
                                  NKDSale              :@MONEY, // 29 НКД полученный (в погашении купона - SКуп_л)
                                  Amount               :@MONEY, // 30 Списанное к-во
                                  IncomeReservBuy      :@MONEY, // 31 Списанная сумма резерва ПДД (Сумма созданного резерва)
                                  IncomeReservAdd      :@MONEY, // 32 Доначисленный резерв по ПДД
                                  IncomeReservSum      :@MONEY, // 33 Списываемая сумма резерва по ПДД
                                  BonusAdd             :@MONEY, // 34 Доначисленная премия (?(SдоначПрi))
                                  CostSum              :@MONEY, // 35 Суммарная списанная чистая стоимость (в продаже -  Счист, в ЧП  -  ( Счист))
                                  StartDate            :DATE,   // 36 Дата отбора лотов покупки. Если не задана, игнорируется
                                  AfterStartDate       :INTEGER,// 37 Признак отбора ц/б, купленных после даты отбора. 0 - нет, 1 - да
                                  BegBonus             :@MONEY, // 38 Начальная прамия (Премия0_2)
                                  OldBonus             :@MONEY, // 39 Премия начисленная до перемещения (S_Пр_начисл_1)
                                  BonusSum             :@MONEY, // 40 Суммарная начисленная премия 
                                  BonusRest            :@MONEY, // 41 Остаток премии ? (ост. премии)
                                  NotWrtBonus          :@MONEY, // 42 сумма списания премии, не списанной на расходы
                                  AccounttedDefDiffBuy :@MONEY, // 43 Списанная сумма отсроченной разницы
                                  AccounttedDefDiffAdd :@MONEY, // 44 Доначисленная отсроченная разница
                                  AccounttedDefDiffSum :@MONEY, // 45 Суммарная списанная отсроченная разница
                                  CorrValueBuy         :@MONEY, // 46 Списанная сумма корректировки СС
                                  CorrIntToEIRBuy      :@MONEY, // 47 Списанная сумма корректировки % до ЭПС
                                  CorrIntToEIRAdd      :@MONEY, // 48 Добавленная корректировка % до ЭСП
                                  CorrIntToEIRSum      :@MONEY, // 49 Суммарная списываемая корректировка % до ЭПС
                                  EstReserveBuy        :@MONEY, // 50 Списанная сумма отсроченного резерва
                                  EstReserveAdd        :@MONEY, // 51 Доначисленный оценочный резерв
                                  EstReserveSum        :@MONEY, // 52 Суммарный списываемый оценочный резерв
                                  CorrEstReserveBuy    :@MONEY, // 53 Списанная сумма корректировки отсроченного резерва
                                  CorrEstReserveAdd    :@MONEY, // 54 Доначисленная корректировка оценочного резерва
                                  CorrEstReserveSum    :@MONEY, // 55 Суммарная списываемая корректировка оценочного резерва
                                  HedgCorrSum          :@MONEY, // 56 Суммарная списываемая начисленная корректировка хеджирования
                                  AmortHedgCorrSum     :@MONEY  // 57 Суммарная списываемая корректировка хеджирования к амортизации

                                  )
   VAR cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTGetSaleFinResult_EX(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);\n end; ");

   cmd.addParam("p_Department",         RSDBP_IN, SaleID    );
   cmd.addParam("p_FIID",               RSDBP_IN, Portfolio );
   cmd.addParam("p_Party",              RSDBP_IN, ParentLot );

   cmd.addParam("CostBuy",              RSDBP_OUT, V_DOUBLE );
   cmd.addParam("BalanceCostBuy",       RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NKDBuy",               RSDBP_OUT, V_DOUBLE );
   cmd.addParam("InterestIncomeBuy",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("DiscountIncomeBuy",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotCarryInterestBuy",  RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotCarryDiscountBuy",  RSDBP_OUT, V_DOUBLE );
   cmd.addParam("InterestIncomeAdd",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("DiscountIncomeAdd",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotCarryInterestAdd",  RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotCarryDiscountAdd",  RSDBP_OUT, V_DOUBLE );
   cmd.addParam("InterestIncomeSum",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("DiscountIncomeSum",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotCarryInterestSum",  RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotCarryDiscountSum",  RSDBP_OUT, V_DOUBLE );
   cmd.addParam("BalanceCostSum",       RSDBP_OUT, V_DOUBLE );
   cmd.addParam("OutlayBuy",            RSDBP_OUT, V_DOUBLE );
   cmd.addParam("OverAmountBuy",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("OverAmountAdd",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("OverAmountSum",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("ReservAmountBuy",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("ReservAmountAdd",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("ReservAmountSum",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("BalanceCostBD",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CostSale",             RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NKDSale",              RSDBP_OUT, V_DOUBLE );
   cmd.addParam("Amount",               RSDBP_OUT, V_DOUBLE );
   cmd.addParam("IncomeReservBuy",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("IncomeReservAdd",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("IncomeReservSum",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("BonusAdd",             RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CostSum",              RSDBP_OUT, V_DOUBLE );
   cmd.addParam("StartDate",       RSDBP_IN, StartDate     );
   cmd.addParam("AfterStartDate",  RSDBP_IN, AfterStartDate);
   cmd.addParam("BegBonus",             RSDBP_OUT, V_DOUBLE );
   cmd.addParam("OldBonus",             RSDBP_OUT, V_DOUBLE );
   cmd.addParam("BonusSum",             RSDBP_OUT, V_DOUBLE );
   cmd.addParam("BonusRest",            RSDBP_OUT, V_DOUBLE );
   cmd.addParam("NotWrtBonus",          RSDBP_OUT, V_DOUBLE );
   cmd.addParam("AccounttedDefDiffBuy", RSDBP_OUT, V_DOUBLE );
   cmd.addParam("AccounttedDefDiffAdd", RSDBP_OUT, V_DOUBLE );
   cmd.addParam("AccounttedDefDiffSum", RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrValueBuy",         RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrIntToEIRBuy",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrIntToEIRAdd",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrIntToEIRSum",      RSDBP_OUT, V_DOUBLE );
   cmd.addParam("EstReserveBuy",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("EstReserveAdd",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("EstReserveSum",        RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrEstReserveBuy",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrEstReserveAdd",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("CorrEstReserveSum",    RSDBP_OUT, V_DOUBLE );
   cmd.addParam("HedgCorrSum",          RSDBP_OUT, V_DOUBLE );
   cmd.addParam("AmortHedgCorrSum",     RSDBP_OUT, V_DOUBLE );

   cmd.execute();

   CostBuy               = cmd.value(3);
   BalanceCostBuy        = cmd.value(4);
   NKDBuy                = cmd.value(5);
   InterestIncomeBuy     = cmd.value(6);
   DiscountIncomeBuy     = cmd.value(7);
   NotCarryInterestBuy   = cmd.value(8);
   NotCarryDiscountBuy   = cmd.value(9);
   InterestIncomeAdd     = cmd.value(10);
   DiscountIncomeAdd     = cmd.value(11);
   NotCarryInterestAdd   = cmd.value(12);
   NotCarryDiscountAdd   = cmd.value(13);
   InterestIncomeSum     = cmd.value(14);
   DiscountIncomeSum     = cmd.value(15);
   NotCarryInterestSum   = cmd.value(16);
   NotCarryDiscountSum   = cmd.value(17);
   BalanceCostSum        = cmd.value(18);
   OutlayBuy             = cmd.value(19);
   OverAmountBuy         = cmd.value(20);
   OverAmountAdd         = cmd.value(21);
   OverAmountSum         = cmd.value(22);
   ReservAmountBuy       = cmd.value(23);
   ReservAmountAdd       = cmd.value(24);
   ReservAmountSum       = cmd.value(25);
   BalanceCostBD         = cmd.value(26);
   CostSale              = cmd.value(27);
   NKDSale               = cmd.value(28);
   Amount                = cmd.value(29);
   IncomeReservBuy       = cmd.value(30);
   IncomeReservAdd       = cmd.value(31);
   IncomeReservSum       = cmd.value(32);
   BonusAdd              = cmd.value(33);
   CostSum               = cmd.value(34);
   BegBonus              = cmd.value(37);
   OldBonus              = cmd.value(38);
   BonusSum              = cmd.value(39);
   BonusRest             = cmd.value(40);
   NotWrtBonus           = cmd.value(41);
   AccounttedDefDiffBuy  = cmd.value(42);
   AccounttedDefDiffAdd  = cmd.value(43);
   AccounttedDefDiffSum  = cmd.value(44);
   CorrValueBuy          = cmd.value(45);
   CorrIntToEIRBuy       = cmd.value(46);
   CorrIntToEIRAdd       = cmd.value(47);
   CorrIntToEIRSum       = cmd.value(48);
   EstReserveBuy         = cmd.value(49);
   EstReserveAdd         = cmd.value(50);
   EstReserveSum         = cmd.value(51);
   CorrEstReserveBuy     = cmd.value(52);
   CorrEstReserveAdd     = cmd.value(53);
   CorrEstReserveSum     = cmd.value(54);
   HedgCorrSum           = cmd.value(55);
   AmortHedgCorrSum      = cmd.value(56);
   return true;
end;

/*
  Возвращает в валюте номинала
  _BalCost - балансовую стоимость
*/
MACRO УчетБалансовойСтоимостиБумагПриПродаже( FD, Doc, Dп, _BalCostConv, _chapter )
  
  var CatDeb:string = "", CatCred:string = "",
      FIRoleDeb:integer = NULL, FIRoleCred:integer = NULL,
      PayFIID = FD.GetPayFIID(), RetSumma, pmNKD,
      dS = $0, СуммаУчетаВБалансе_ВР = $0, СуммаСделкиНаДатуУчета_ВЦ = $0, СуммаСделкиНаДатуПоставки_ВР = $0, 
      Dу;  /* дата учета */

  var chapter:integer = 1;
  var Cred_FIID = NULL, CredSum = NULL;
  var CFIDeb = false, CFICred = false;
  var BaseSum = $0;

  if( _chapter != null )
     chapter = _chapter;
  end;

  if( FD.tick.rec.BofficeKind != DL_RETIREMENT ) 
    Dу = FD.DateArray[DATE_DEALBEGINEXEC];
  else 
    Dу = FD.DateArray[DATE_DEALSETAVOIRISS];
  end; 

  if( FD.Kind != DL_TRUSTDOC )
     if( not ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_DELIVERY)) ) 
        if( FD.IsOperLoan == true ) /*для займов*/
           CatDeb = "ОД";
        else
           CatDeb = "-Форвард, расчеты";
        end;
     else
        CatDeb = IIF(IsBasket(FD.Group), "Обяз. с н.с., корзина", "Обяз. с н.с.");
     end; 

     CatCred = "Реализация, ц/б";

     FIRoleDeb = FIRoleCred = NULL;

     Cred_FIID = NATCUR;

     if( FD.dl_leg.rec.CFI == PayFIID )
        CFIDeb = true;
     end;
    
     if( (not CFIDeb) and (FD.dl_leg.rec.CFI == Cred_FIID) )
        CFICred = true;
     end;

  /*сделки с ц/б ДУ*/
  else
     CatDeb    =  "-Расчеты, ДУ";
     FIRoleDeb =  FIROLE_FICOM;
     CatCred   =  "-Расчеты, ДУ";
     FIRoleCred=  FIROLE_BA;
     Cred_FIID = FD.FaceFIID;
  end;

  if( FD.ExistRqMoney == true )
     BaseSum = FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.Amount;
     if(FD.ExistAvance)
       BaseSum = BaseSum + FD.GetRQ(DLRQ_TYPE_AVANCE).rec.Amount;
     elif(FD.ExistDeposit)
       BaseSum = BaseSum + FD.GetRQ(DLRQ_TYPE_DEPOSIT).rec.Amount;
     end;

     /*отконвертить сумму базовых сумм платежей аванса/задатка и контрактива из ВЦ в ВР по курсу даты учета*/
     if( SmartConvertSum( СуммаУчетаВБалансе_ВР, BaseSum, Dу, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayFIID, true ) != true )
        return 1;
     end;    

     if( CFICred )
        CredSum = BaseSum;
     end;

     /*  Получаем сумму сделки на дату учета (сумма которая ставится на баланс).      */
     if( ПолучитьЦеновыеУсловияСделки( FD.tick, Dу-1, FD.IsBack, null, null, null, СуммаСделкиНаДатуУчета_ВЦ ) == false )
        return 1;
     end; 

     if( СуммаСделкиНаДатуУчета_ВЦ != FD.dl_leg.rec.TotalCost )

        /*был пересчет параметров сделки при изменении сроков уже после постановки сделки на баланс*/
        if( SmartConvertSum( СуммаСделкиНаДатуПоставки_ВР, FD.dl_leg.rec.TotalCost, Dп, FD.dl_leg.rec.CFI, PayFIID, true ) != true )
           return 1;
        end;    

        dS = СуммаУчетаВБалансе_ВР - СуммаСделкиНаДатуПоставки_ВР;
        СуммаУчетаВБалансе_ВР = СуммаСделкиНаДатуПоставки_ВР;

        if( CFICred )
           CredSum = FD.dl_leg.rec.TotalCost;
        end;

        if( dS > 0 )
           if(not ПроводкаПоКатегориямУчета( FD, 
                  CatDeb, "Прочие доходы",  /* Деб , КатегКредит*/
                  Dп,                    /* Дата */
                  chapter,                   /* Глава */
                  PayFIID,                  /* Валюта */
                  ABS(dS),                  /* Сумма дебет*/
                  Doc,                   /* Документ */
                  INPCARRY,              /* Result_Carry */
                  " 1",                  /* Kind_Oper */
                  FD.tick.rec.DealCode,  /* Numb_Document */
                  "Учет доходов от изменения сроков поставки после постановки сделки на баланс"           /* Ground */
                 ))
               return 1;
           end;
        elif( dS < 0 )
           if(not ПроводкаПоКатегориямУчета( FD, 
                  "Прочие расходы", CatDeb,   /* Деб , КатегКредит*/
                  Dп,                    /* Дата */
                  chapter,               /* Глава */
                  null,                  /* Валюта */
                  null,                  /* Сумма дебет*/
                  Doc,                   /* Документ */
                  INPCARRY,              /* Result_Carry */
                  " 1",                  /* Kind_Oper */
                  FD.tick.rec.DealCode,  /* Numb_Document */
                  "Учет расходов от изменения сроков поставки после постановки сделки на баланс",           /* Ground */
                  null, 
                  null, null,
                  NATCUR, PayFIID,
                  PayFIID, ABS(dS)
                 ))
               return 1;
           end;
        end;
     end;
  else
     RetSumma = FD.dl_leg.rec.TotalCost;
     if( FD.IsOperLoan == true ) /*для займов*/
        /*если в сделке не установлен признак возврата доходов или не было возврата доходов 
          по купонам, то dl_leg.TotalCost, иначе dl_leg.Cost*/
        pmNKD = Trechandler( "pmpaym.dbt" ); /* платеж НКД*/
        if( FindPayment( null, INi, 0, FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, true, pmNKD ) == 0 )
           RetSumma = FD.dl_leg.rec.Cost;
        else
           RetSumma = FD.dl_leg.rec.TotalCost;
        end;
     end;

     if( SmartConvertSum( СуммаУчетаВБалансе_ВР, RetSumma, Dп, FD.dl_leg.rec.CFI, PayFIID, true ) != true )
        return 1;
     end;    

     if( CFICred )
        CredSum = RetSumma;
     end;
    
  end;

  if( CFICred )
    СуммаУчетаВБалансе_ВР = null;
  end;

  if( FD.ВедетсяБалансУчетПоСделке() OR
      ( (FD.BuySale == DEAL_TYPE_SALE) AND ((GetOption_NotUse47407_08() != true) OR (FD.ВидСрочностиСделки() != СделкаToday)) 
      )
    )

     if(not ПроводкаПоКатегориямУчета( FD, 
            CatDeb, CatCred, /* Деб , КатегКредит*/
            Dп,                    /* Дата */
            chapter,               /* Глава */
            PayFIID,               /* Валюта */
            СуммаУчетаВБалансе_ВР,            /* Сумма */
            Doc,                   /* Документ */
            INPCARRY,              /* Result_Carry */
            " 1",                  /* Kind_Oper */
            FD.tick.rec.DealCode,  /* Numb_Document */
            "Исполнение обязательств по поставке ц/б", /* Ground */
            null, FIRoleDeb, FIRoleCred,
            PayFIID, Cred_FIID,
            Cred_FIID, CredSum
           ))
         return 1;
     end;
  end;

  return 0; 
END;

private record acnt_ov_negative(account);
private record acnt_ov_positive(account);
private record acnt_dk_negative(account);
private record acnt_dk_positive(account);

private macro CarryError( deal, Acc1, Acc2 )
   if( SC_GetCarryError() != "" )
      SayErrorBuySale( deal, SC_GetCarryError() );
   else
      SayErrorBuySale( deal, "Ошибка при выполении проводки по категориям \"" + Acc1 + "\" - \"" + Acc2 + "\"");
   end;
   return false;
end;

/* Делаем проводки по оплате ц/б (без просрочки) при продаже.
   Платеж по контрактиву должен быть актуализирован, счет контрагента заполнен.
   Если по собственной сделке ведется балансовый учет, то делаем проводку
   на счёт категории "+Форвард, расчеты", иначе на счет категории
   "Реализация, ц/б". Если клиентская сделка, то делаем проводку на счет
   клиента.
   Возвращаем false в случае ошибки.
      FD          -  SPFirstDoc по сделке
      ChangeDate  -  дата изменения
      Doc         -  документ */
macro СделатьПроводкиПоОплате_БезПросрочки_ПриПродаже( FD, ChangeDate, Doc )

   if( ОбработатьТОПоОплате( FD, ChangeDate, Doc ) != 0 )
      return false;
   end;

   return true;
end;

PRIVATE MACRO УчетРЕПО_ДляПогашений( FD:SPFirstDoc, CarDate:DATE, Doc:VARIANT, IsRetCoupon:BOOL ):BOOL
  var cmd, DS, Sum = $0, CatCredit = "", FiRoleCredit;
  var WrtRetAcc = TRecHandler( "account" ); 

  if( IsClientDeal(FD.tick.rec) )
     return true;
  end;

  if( not FD.OpenAccount( СчетСписанияСредствЗаПогашение( FD ), null, null, null, WrtRetAcc, CarDate ) )
     return false;
  end;

  cmd = RSDCommand( "SELECT Link.t_CostSale CostSale, Link.t_NKDSaleAmount NKDSaleAmount, deal.t_Flag5, deal.t_DealID "+
                    "  FROM DPMWRTLNK_DBT Link, DPMWRTSUM_DBT LotBuy, DDL_TICK_DBT Deal "+
                    " WHERE     Link.T_SALEID      = ? "+
                    "       AND LotBuy.T_SUMID     = Link.T_BUYID  "+
                    "       AND LotBuy.t_Portfolio = 6 /*ПВО*/ "+
                    "       AND LotBuy.t_DealID > 0 " +
                    "       AND LotBuy.t_DocKind = 29 /*DLDOC_PAYMENT*/ " +
                    "       AND deal.t_DealID = LotBuy.t_DealID " 
        );
  cmd.addParam( "", RSDBP_IN, FD.pmwrtsum.rec.SumID );
  cmd.execute();
  DS = TRsbDataSet(cmd);
  while( DS.movenext() )
     if (IsRetCoupon)
        Sum = SQL_ConvTypeSum(DS.NKDSaleAmount);
     else
        Sum = SQL_ConvTypeSum(DS.CostSale);
     end;

     if( DS.Flag5 == "X" )
        CatCredit = "+Расчеты";
        FiRoleCredit = FIROLE_EMIT_INC_TR;
     else
        CatCredit = "+%ДЦ/б";
        FiRoleCredit = null;
     end;

     if (Sum != 0)
        if(not ПроводкаПоКатегориямУчета( 
               SPFirstDoc( LEG_KIND_DL_TICK, DS.DealID ), /*Из SPFirstDoc только к/агент нужен, поэтому часть сделки не важна*/
               WrtRetAcc, CatCredit,    /* КатегДеб , КатегКредит*/
               CarDate,                     /* Дата */
               1,                           /* Глава */
               FD.FaceFIID(),               /* Валюта */
               Sum,                         /* Сумма  */
               Doc,                         /* Документ */
               INPCARRY,                    /* Result_Carry */
               " 1",                        /* Kind_Oper */
               "",                          /* Numb_Document */
               IIF(IsRetCoupon,"Купоны","ЧП") + " по ц/б, полученным без первоначального признания по договорам займа и РЕПО.",
               null, 
               null, 
               FiRoleCredit
              ) 
          )
             return false;
        end;
     end;
  end;

  return true;
END;
/*
MACRO ПроводкиЧастичногоПогашения( FD:SPFirstDoc, CarDate:DATE, Doc:VARIANT ):BOOL

   record ReceiverAccount(account); 
   var PayerAccountBuff = TRecHandler( "account" );
   VAR i = 0, Groups = TArray(), AccCredit, FIIDCredit, AccDebet = "";

   VAR СумПрод = $0, ALL_NotCarryDiscountSum = $0, ALL_Amount = $0, Amount = $0,
       CostBuy             = $0, // Списанная чистая стоимость (Счист)
       BalanceCostBuy      = $0, // Списанная текущая стоимость 
       NKDBuy              = $0, // НКД ( S(НКД упл.))
       InterestIncomeBuy   = $0, // Списанный начисленный ПД 
       DiscountIncomeBuy   = $0, // Cписанный начисленный ДД 
       NotCarryInterestBuy = $0, // Списанный не отнесенный на доходы ПД  
       NotCarryDiscountBuy = $0, // Списанный не отнесенный на доходы ДД  
       InterestIncomeAdd   = $0, // Доначисленный ПД S(Sдонач.ПДi)
       DiscountIncomeAdd   = $0, // Доначисленный ДД S(Sдонач.ДДi)
       NotCarryInterestAdd = $0, // Доначисленный не отнесенный на доходы ПД  
       NotCarryDiscountAdd = $0, // Доначисленный не отнесенный на доходы ДД  
       InterestIncomeSum   = $0, // Суммарный начисленный ПД S(ПДначисл)
       DiscountIncomeSum   = $0, // Суммарный начисленный ДД S(ДДначисл)
       NotCarryInterestSum = $0, // Суммарный не отнесенный на доходы ПД  S(ПДне_отн)
       NotCarryDiscountSum = $0, // Суммарный не отнесенный на доходы ДД  S(ДДне_отн)
       BalanceCostSum      = $0, // Суммарная текущая стоимость ( (Стек))
       OutlayBuy           = $0, // Списанные затраты
       OverAmountBuy       = $0, // Списанная сумма переоценки S(ПО)
       BalanceCostBD       = $0,
       CostSale            = $0, 
       CostSum             = $0;

   if( IsClientDeal(FD.tick.rec) )

      if( not GetAccount( 1, FD.pm_money.rec.PayFIID, FD.pm_money.rec.ReceiverAccount, ReceiverAccount ) ) 
         return false;
      end;

      AccDebet = СчетСписанияСредствЗаПогашение( FD );
      if( AccDebet == "Корсчет" )
         if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
            Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
            return false;
         end;
      end;

      var summa = $0, currency = NATCUR;
      if( FD.FaceFIID() != FD.GetPayFIID())
        if( not SmartConvertSum( summa, FD.dl_leg.rec.Cost, CarDate, FD.FaceFIID, FD.GetPayFIID(), true))
           return false;
        end;
        currency = FD.GetPayFIID();
      else
          summa = FD.dl_leg.rec.Cost;
          currency = FD.FaceFIID();
      end;

      if(not ПроводкаПоКатегориямУчета( FD, 
             IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), ReceiverAccount,/* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             currency,                    /* Валюта */
             summa,                       /* Сумма*/
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             "Частичное погашение для клиента"
            ) 
        )
          return false;
      end;

      return true;
   end;

   ПолучитьГруппыСписания( FD, Groups );

   if( FI_IsResponsible( FD.GetBaseFIID(), CarDate) )
      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;
   else
      AccCredit  = "%НДоход, ц/б";
      FIIDCredit = FD.FaceFIID();
   end;

   while( i < Groups.Size )
      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                               @CostBuy            ,
                               @BalanceCostBuy     ,
                               @NKDBuy             ,
                               @InterestIncomeBuy  ,
                               @DiscountIncomeBuy  ,
                               @NotCarryInterestBuy,
                               @NotCarryDiscountBuy,
                               @InterestIncomeAdd  ,
                               @DiscountIncomeAdd  ,
                               @NotCarryInterestAdd,
                               @NotCarryDiscountAdd,
                               @InterestIncomeSum  ,
                               @DiscountIncomeSum  ,
                               @NotCarryInterestSum,
                               @NotCarryDiscountSum,
                               @BalanceCostSum     ,
                               @OutlayBuy          ,
                               @OverAmountBuy      ,
                               null                ,
                               @BalanceCostBD      ,
                               @CostSale           ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @CostSum            
                             ) != true )
         return false;
      end;                                                                 
      
      ALL_NotCarryDiscountSum = ALL_NotCarryDiscountSum  + NotCarryDiscountSum;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ТП*/
          (Groups[i] == KINDPORT_SALE) OR  /*ППР*/
          (Groups[i] == KINDPORT_RETIRE)   /*ПУДП*/
        )
         if( DiscountIncomeAdd != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "Начисл.ПДД, ц/б", AccCredit,/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),            /* Валюта */
                   DiscountIncomeAdd,           /* Сумма  Sдонач.ДДi*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Доначисление дисконтного дохода",
                   null,
                   GetFIRoleByPortfolio( Groups[i], true ), null,
                   FD.FaceFIID(), FIIDCredit
                  ) 
              )
                return false;
            end;
         end;

      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным до даты составления списка*/
   i = 0;
   while( i < Groups.Size )
      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                               @CostBuy            ,
                               @BalanceCostBuy     ,
                               @NKDBuy             ,
                               @InterestIncomeBuy  ,
                               @DiscountIncomeBuy  ,
                               @NotCarryInterestBuy,
                               @NotCarryDiscountBuy,
                               @InterestIncomeAdd  ,
                               @DiscountIncomeAdd  ,
                               @NotCarryInterestAdd,
                               @NotCarryDiscountAdd,
                               @InterestIncomeSum  ,
                               @DiscountIncomeSum  ,
                               @NotCarryInterestSum,
                               @NotCarryDiscountSum,
                               @BalanceCostSum     ,
                               @OutlayBuy          ,
                               @OverAmountBuy      ,
                               null                ,
                               @BalanceCostBD      ,
                               @CostSale           ,
                               NULL                ,
                               @Amount             ,
                               NULL                ,
                               NULL                ,
                               @CostSum            ,
                               FD.dl_leg.rec.Start ,
                               0
                             ) != true )
         return false;
      end;                                                                 

      ALL_Amount = ALL_Amount + Amount;
      
      if( (Groups[i] == KINDPORT_TRADE) OR /*ТП*/
          (Groups[i] == KINDPORT_SALE) OR  /*ППР*/
          (Groups[i] == KINDPORT_RETIRE)   /*ПУДП*/
        )
         if( DiscountIncomeSum != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   СчетСписанияСредствЗаПогашение( FD ), "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   DiscountIncomeSum,           /* Сумма  ДДначисл*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание начисленного дисконтного дохода",
                   null,
                   null,
                   GetFIRoleByPortfolio( Groups[i], true )
                  ) 
              )
                return false;
            end;
         end;

         if( CostSum != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   СчетСписанияСредствЗаПогашение( FD ), "Наш портфель ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   CostSum,                     /* Сумма  ДДначисл*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание погашенной части балансовой стоимости",
                   null,
                   null,
                   GetFIRoleByPortfolio( Groups[i] )
                  ) 
              )
                return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным после даты составления списка*/
   i = 0;
   while( i < Groups.Size )
      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                               @CostBuy            ,
                               @BalanceCostBuy     ,
                               @NKDBuy             ,
                               @InterestIncomeBuy  ,
                               @DiscountIncomeBuy  ,
                               @NotCarryInterestBuy,
                               @NotCarryDiscountBuy,
                               @InterestIncomeAdd  ,
                               @DiscountIncomeAdd  ,
                               @NotCarryInterestAdd,
                               @NotCarryDiscountAdd,
                               @InterestIncomeSum  ,
                               @DiscountIncomeSum  ,
                               @NotCarryInterestSum,
                               @NotCarryDiscountSum,
                               @BalanceCostSum     ,
                               @OutlayBuy          ,
                               @OverAmountBuy      ,
                               null                ,
                               @BalanceCostBD      ,
                               @CostSale           ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               NULL                ,
                               @CostSum            ,
                               FD.dl_leg.rec.Start ,
                               1
                             ) != true )
         return false;
      end;                                                                 
      
      if( (Groups[i] == KINDPORT_TRADE) OR /*ТП*/
          (Groups[i] == KINDPORT_SALE) OR  /*ППР*/
          (Groups[i] == KINDPORT_RETIRE)   /*ПУДП*/
        )
         if( DiscountIncomeSum != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   DiscountIncomeSum,           /* Сумма  ДДначисл*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание начисленного дисконтного дохода по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i], true ),
                   FD.GetPayFIID(), FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         end;

         if( CostSum != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", "Наш портфель ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   CostSum,                     /* Сумма  ДДначисл*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание погашенной части балансовой стоимости по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i] ),
                   FD.GetPayFIID(), FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   /*В ТЗ проводки 2, а здесь - одна - все учтено в сумме ALL_NotCarryDiscountSum*/
   if( ALL_NotCarryDiscountSum != 0 )
      if(not ПроводкаПоКатегориямУчета( FD, 
             "%НДоход, ц/б", "+%ДЦ/б",    /* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             ALL_NotCarryDiscountSum,     /* Сумма  SДДне_отнi*/
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             "Отнесение на доходы ДД",
             null, null, null, 
             FD.FaceFIID(), NATCUR
            ) 
        )
          return false;
      end;
   end;

   if( FD.dl_leg.rec.Start != FD.tick.rec.DealDate )
      СумПрод   = FD.dl_leg.rec.Cost - ALL_Amount * FD.dl_leg.rec.Cost / FD.dl_leg.rec.Principal;
   end;
   if( СумПрод != 0 )

       AccDebet = СчетСписанияСредствЗаПогашение( FD );
       if( AccDebet == "Корсчет" )
          if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
             Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
             return false;
          end; 
       end;

       if(not ПроводкаПоКатегориямУчета( FD, 
              IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), "+%ДЦ/б",/* КатегДеб , КатегКредит*/
              CarDate,                     /* Дата */
              1,                           /* Глава */
              FD.FaceFIID(),               /* Валюта */
              СумПрод,                     /* Сумма  ДДначисл*/
              Doc,                         /* Документ */
              INPCARRY,                    /* Result_Carry */
              " 1",                        /* Kind_Oper */
              "",                          /* Numb_Document */
              "Списание дохода по ц/б, купленным до даты составления перечня и проданным между датой составления перечня и датой погашения"
             ) 
         )
           return false;
       end;
   end;

   if( УчетРЕПО_ДляПогашений( FD, CarDate, Doc, false ) != true )
      return false;
   end;

   return true; 
END;
*/
/*RealizSumm  -  сумма ПД и НКДУпл, кот. прошла(или могла пройти) по счету "Реализация, ц/б" 
  в проводках погашения посл. купона (нужна для расчета ФР)*/
/*
MACRO ПроводкиПогашенияКупона( FD:SPFirstDoc, CarDate:DATE, Doc:VARIANT, RealizSumm:@money ):BOOL

   var ReceiverAccount = TRecHandler( "account" );
   var PayerAccountBuff = TRecHandler( "account" );

   VAR i = 0, Groups = TArray(), AccCredit, FIIDCredit, AccDebet = "";

   VAR СумПрод = $0, ALL_NotCarryInterestSum = $0, ALL_Amount = $0,
       CostBuy             = $0, // Списанная чистая стоимость (Счист)
       BalanceCostBuy      = $0, // Списанная текущая стоимость 
       NKDBuy              = $0, // НКД ( S(НКД упл.))
       InterestIncomeBuy   = $0, // Списанный начисленный ПД 
       DiscountIncomeBuy   = $0, // Cписанный начисленный ДД 
       NotCarryInterestBuy = $0, // Списанный не отнесенный на доходы ПД  
       NotCarryDiscountBuy = $0, // Списанный не отнесенный на доходы ДД  
       InterestIncomeAdd   = $0, // Доначисленный ПД S(Sдонач.ПДi)
       DiscountIncomeAdd   = $0, // Доначисленный ДД S(Sдонач.ДДi)
       NotCarryInterestAdd = $0, // Доначисленный не отнесенный на доходы ПД  
       NotCarryDiscountAdd = $0, // Доначисленный не отнесенный на доходы ДД  
       InterestIncomeSum   = $0, // Суммарный начисленный ПД S(ПДначисл)
       DiscountIncomeSum   = $0, // Суммарный начисленный ДД S(ДДначисл)
       NotCarryInterestSum = $0, // Суммарный не отнесенный на доходы ПД  S(ПДне_отн)
       NotCarryDiscountSum = $0, // Суммарный не отнесенный на доходы ДД  S(ДДне_отн)
       BalanceCostSum      = $0, // Суммарная текущая стоимость ( (Стек))
       OutlayBuy           = $0, // Списанные затраты
       OverAmountBuy       = $0, // Списанная сумма переоценки S(ПО)
       BalanceCostBD       = $0,
       CostSale            = $0,
       NKDSale             = $0,
       Amount              = $0,
       BonusAdd            = $0;

   RealizSumm = $0;

   if( IsClientDeal(FD.tick.rec) )


      if(ПолучитьСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.ClientID, DLRQ_SUBKIND_CURRENCY, FD.GetPayFIID(), ReceiverAccount) != 0)
        return false;
      end;

      AccDebet = СчетСписанияСредствЗаПогашение( FD );
      if( AccDebet == "Корсчет" )
         if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
            Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
            return false;
         end; 
      end;

      var summa = $0, currency = NATCUR;
      if( FD.NKDFIID() != FD.GetPayFIID())
        if( not SmartConvertSum( summa, FD.dl_leg.rec.NKD, CarDate, FD.NKDFIID(), FD.GetPayFIID(), true))
           return false;
        end;
        currency = FD.GetPayFIID();
      else
          summa = FD.dl_leg.rec.NKD;
        currency = FD.NKDFIID();
      end;

      if(not ПроводкаПоКатегориямУчета( FD, 
             IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), ReceiverAccount,/* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             currency,                    /* Валюта */ 
             summa,                       /* Сумма */
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             "Погашение купона по ц/б, принадлежащим клиенту"
            ) 
        )
          return false;
      end;

      return true;
   end;

   ПолучитьГруппыСписания( FD, Groups );

   if( FI_IsResponsible( FD.GetBaseFIID(), CarDate) )
      AccCredit  = "+%ДЦ/б";
      FIIDCredit = NATCUR;
   else
      AccCredit  = "%НДоход, ц/б";
      FIIDCredit = FD.FaceFIID();
   end;

   while( i < Groups.Size )

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   @Amount            ,
                                   NULL               ,
                                   @BonusAdd          ,
                                   NULL               
                                 ) != true )
         return false;
      end;
      ALL_NotCarryInterestSum = ALL_NotCarryInterestSum  + NotCarryInterestSum;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ТП*/
          (Groups[i] == KINDPORT_SALE) OR  /*ППР*/
          (Groups[i] == KINDPORT_RETIRE)   /*ПУДП*/
        )
         if (InterestIncomeAdd - BonusAdd < $0)
            msgbox("Сумма доначисленной премии превышает сумму купонного дохода");
            return false;
         end;

         if( (InterestIncomeAdd - BonusAdd) != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "Начисл.ПДД, ц/б", AccCredit,/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),            /* Валюта */
                   InterestIncomeAdd - BonusAdd,/* Сумма  Sдонач.ДДi*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Доначисление процентного дохода",
                   null,
                   GetFIRoleByPortfolio( Groups[i], false, true ), null,
                   FD.FaceFIID(), FIIDCredit
                  ) 
              )
                return false;
            end;
         end;

         if( BonusAdd != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "Начисл.ПДД, ц/б", IIF(CheckBonusIndividualAccount(), "Премия, ц/б", "Наш портфель ц/б"),/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),            /* Валюта */
                   BonusAdd,                    /* Сумма  Sдонач.ДДi*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Доначисление премии",
                   null,
                   GetFIRoleByPortfolio( Groups[i], false, true ),
                   IIF(CheckBonusIndividualAccount(), 
                       GetFIRoleByPortfolio( Groups[i], false, false, false, false, true), 
                       GetFIRoleByPortfolio( Groups[i])
                      )
                  ) 
              )
                return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным до даты составления списка*/
   i = 0;
   while( i < Groups.Size )

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   @Amount            ,
                                   NULL               ,
                                   @BonusAdd          ,
                                   NULL               ,
                                   FD.dl_leg.rec.Start ,
                                   0
                                 ) != true )
         return false;
      end;

      ALL_Amount = ALL_Amount + Amount;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ТП*/
          (Groups[i] == KINDPORT_SALE) OR  /*ППР*/
          (Groups[i] == KINDPORT_RETIRE)   /*ПУДП*/
        )
         if( InterestIncomeSum != 0 )
            if( IsRET_ISSUE(FD.Group) and CheckLastRetOver61210() ) // в погашении ц/б можно задать только последний купон
               if(not ПроводкаПоКатегориямУчета( FD, 
                      "Реализация, ц/б", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      FD.FaceFIID(),               /* Валюта */
                      InterestIncomeSum,           /* Сумма  ДДначисл*/
                      Doc,                         /* Документ */
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Списание начисленного ПД",
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i], false, true )
                     ) 
                 )
                   return false;
               end;
            else
               if(not ПроводкаПоКатегориямУчета( FD, 
                      СчетСписанияСредствЗаПогашение( FD ), "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      FD.FaceFIID(),               /* Валюта */
                      InterestIncomeSum,           /* Сумма  ДДначисл*/
                      Doc,                         /* Документ */
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Списание начисленного ПД",
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i], false, true )
                     ) 
                 )
                   return false;
               end;
            end;
            /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
            if( SmartConvertSum( InterestIncomeSum, InterestIncomeSum, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
               return false;
            end;                      
            RealizSumm = RealizSumm + InterestIncomeSum;
         end;

         if( NKDBuy != 0 )
            // последний купон гасится совместно с выпуском и Настройка "Погашение последнего купона через 61210"=ДА
            if (IsRET_ISSUE(FD.Group) and CheckLastRetOver61210()) // в погашении ц/б можно задать только последний купон
               if(not ПроводкаПоКатегориямУчета( FD, 
                      "Реализация, ц/б", IIF(ОтдельныйУчетУплНКД(),"Уплаченный НКД","Наш портфель ц/б"),/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      FD.FaceFIID(),               /* Валюта */
                      NKDBuy,                      /* Сумма  ДДначисл*/
                      Doc,                         /* Документ */
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Списание уплаченного НКД",
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i] ),
                      NATCUR, FD.FaceFIID
                     ) 
                 )
                   return false;
               end;
            else
               if(not ПроводкаПоКатегориямУчета( FD, 
                      СчетСписанияСредствЗаПогашение( FD ), IIF(ОтдельныйУчетУплНКД(),"Уплаченный НКД","Наш портфель ц/б"),/* КатегДеб , КатегКредит*/
                      CarDate,                     /* Дата */
                      1,                           /* Глава */
                      FD.FaceFIID(),               /* Валюта */
                      NKDBuy,                      /* Сумма  ДДначисл*/
                      Doc,                         /* Документ */
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      "",                          /* Numb_Document */
                      "Списание уплаченного НКД",
                      null,
                      null,
                      GetFIRoleByPortfolio( Groups[i] )
                     ) 
                 )
                   return false;
               end;
            end;
            /*для ФР собираем сконвертированные данные из ВН в НацВ, округленные до копеек*/
            if( SmartConvertSum( NKDBuy, NKDBuy, CarDate, FD.FaceFIID(), NATCUR, true ) == false )
               return false;
            end;                      
            RealizSumm = RealizSumm + NKDBuy;
         end;
      end;

      i = i + 1;
   end;

   /*Проводки по ц/б, купленным после даты составления списка*/
   i = 0;
   while( i < Groups.Size )

      if( WRT_GetSaleFinResult_EX( FD.pmwrtsum.rec.SumID, Groups[i], 0,
                                   @CostBuy            ,
                                   @BalanceCostBuy     ,
                                   @NKDBuy             ,
                                   @InterestIncomeBuy  ,
                                   @DiscountIncomeBuy  ,
                                   @NotCarryInterestBuy,
                                   @NotCarryDiscountBuy,
                                   @InterestIncomeAdd  ,
                                   @DiscountIncomeAdd  ,
                                   @NotCarryInterestAdd,
                                   @NotCarryDiscountAdd,
                                   @InterestIncomeSum  ,
                                   @DiscountIncomeSum  ,
                                   @NotCarryInterestSum,
                                   @NotCarryDiscountSum,
                                   @BalanceCostSum     ,
                                   @OutlayBuy          ,
                                   @OverAmountBuy      ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   NULL               ,
                                   @BonusAdd          ,
                                   NULL               ,
                                   FD.dl_leg.rec.Start ,
                                   1
                                 ) != true )
         return false;
      end;

      if( (Groups[i] == KINDPORT_TRADE) OR /*ТП*/
          (Groups[i] == KINDPORT_SALE) OR  /*ППР*/
          (Groups[i] == KINDPORT_RETIRE)   /*ПУДП*/
        )
         if( InterestIncomeSum != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", "Начисл.ПДД, ц/б",/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   InterestIncomeSum,           /* Сумма  ДДначисл*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание начисленного ПД по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i], false, true ),
                   FD.GetPayFIID(), FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         end;

         if( NKDBuy != 0 )
            if(not ПроводкаПоКатегориямУчета( FD, 
                   "+Расчеты", IIF(ОтдельныйУчетУплНКД(),"Уплаченный НКД","Наш портфель ц/б"),/* КатегДеб , КатегКредит*/
                   CarDate,                     /* Дата */
                   1,                           /* Глава */
                   FD.FaceFIID(),               /* Валюта */
                   NKDBuy,                      /* Сумма  ДДначисл*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   "",                          /* Numb_Document */
                   "Списание уплаченного НКД по ц/б, купленным после даты составления перечня",
                   null,
                   FIROLE_BA,
                   GetFIRoleByPortfolio( Groups[i] ),
                   FD.GetPayFIID(), FD.FaceFIID()
                  ) 
              )
                return false;
            end;
         end;
      end;

      i = i + 1;
   end;

   if( ALL_NotCarryInterestSum != 0 )
      if(not ПроводкаПоКатегориямУчета( FD, 
             "%НДоход, ц/б", "+%ДЦ/б",    /* КатегДеб , КатегКредит*/
             CarDate,                     /* Дата */
             1,                           /* Глава */
             FD.FaceFIID(),               /* Валюта */
             ALL_NotCarryInterestSum,     /* Сумма  SДДне_отнi*/
             Doc,                         /* Документ */
             INPCARRY,                    /* Result_Carry */
             " 1",                        /* Kind_Oper */
             "",                          /* Numb_Document */
             "Отнесение на доходы полученного ПД",
             null, null, null, 
             FD.FaceFIID(), NATCUR
            ) 
        )
          return false;
      end;
   end;

   if( FD.dl_leg.rec.Start != FD.tick.rec.DealDate )
      СумПрод   = FD.dl_leg.rec.NKD - 
                  ALL_Amount * FD.dl_leg.rec.NKD / FD.dl_leg.rec.Principal;
   end;
   if( СумПрод != 0 )

       AccDebet = СчетСписанияСредствЗаПогашение( FD );
       if( AccDebet == "Корсчет" )
          if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, FD.tick.rec.DealID, FD.tick.rec.PartyID, FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, PayerAccountBuff) != 0)
             Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(FD.tick.rec.PartyID) );
             return false;
          end; 
       end;

       if(not ПроводкаПоКатегориямУчета( FD, 
              IIF((AccDebet == "Корсчет"),PayerAccountBuff,AccDebet), "+%ДЦ/б",/* КатегДеб , КатегКредит*/
              CarDate,                     /* Дата */
              1,                           /* Глава */
              FD.NKDFIID(),                /* Валюта */
              СумПрод,                     /* Сумма  ДДначисл*/
              Doc,                         /* Документ */
              INPCARRY,                    /* Result_Carry */
              " 1",                        /* Kind_Oper */
              "",                          /* Numb_Document */
              "Списание дохода по ц/б, купленным до даты составления перечня и проданным между датой составления перечня и датой погашения"
             ) 
         )
           return false;
       end;
   end;

   if( УчетРЕПО_ДляПогашений( FD, CarDate, Doc, true ) != true )
      return false;
   end;

   return true; 
END;
*/
MACRO ВыполнитьСписаниеПереоценки( FD, Group:INTEGER, OverAmount:MONEY, CarDate:DATE ):BOOL
  VAR Sпол_ост = $0, Sотр_ост = $0;

  VAR sum_dk_negative = $0, sum_dk_positive = $0;
  
  if( (OverAmount == null) OR (OverAmount == 0) )
     return true;
  end;

  var МинусПереоценкаЦБ:string = IIF(ПарностьСчетовПереоценки(), "-Переоценка, ц/б СССД_ЦБ", "-Переоценка, ц/б");
  var ПлюсПереоценкаЦБ:string  = IIF(ПарностьСчетовПереоценки(), "+Переоценка, ц/б СССД_ЦБ", "+Переоценка, ц/б");
  var МинусПОДК:string = "-ПО ДК 2014";
  var ПлюсПОДК:string  = "+ПО ДК 2014";

  /*остаток на счете категории "-Переоценка"*/
  if( FD.IsExistAccount( МинусПереоценкаЦБ, null, true, GetFIRoleByPortfolio( Group ), acnt_ov_negative, MC_PAIRACCMODE_MANUAL, CarDate ))
     Sотр_ост = GetRestAccount( acnt_ov_negative, CarDate );
  end;

  /*остаток на счете категории "+Переоценка"*/
  if( FD.IsExistAccount( ПлюсПереоценкаЦБ, null, true, GetFIRoleByPortfolio( Group ), acnt_ov_positive, MC_PAIRACCMODE_MANUAL, CarDate ) )
     Sпол_ост = ABS( GetRestAccount( acnt_ov_positive, CarDate ) );
  end;

  if( OverAmount > 0 )
     if(not ПроводкаПоКатегориямУчета( FD, 
                                       "Реализация, ц/б", ПлюсПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                       CarDate,                     /* Дата */
                                       1,                           /* Глава */
                                       NATCUR,                      /* Валюта */
                                       ABS( Min(OverAmount,Sпол_ост) ), /* Сумма  */
                                       Doc,                         /* Документ */
                                       INPCARRY,                    /* Result_Carry */
                                       " 1",                        /* Kind_Oper */
                                       "",                          /* Numb_Document */
                                       "Списание положительной переоценки",
                                       null,
                                       null,
                                       GetFIRoleByPortfolio( Group ),
                                       null, null, null, null, null, null, null, null, null, null, null, null,
                                       null, MC_PAIRACCMODE_MANUAL
                                     )
       )
         return false;
     end;
     
     if(FD.IsExistAccount( ПлюсПОДК, null, true, null, acnt_dk_positive, MC_PAIRACCMODE_MANUAL, CarDate ))

        sum_dk_positive = GetRestAccount( acnt_dk_positive, CarDate );
        if( sum_dk_positive != 0 )
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             acnt_dk_positive, "+Маржа, ц/б",/* КатегДеб , КатегКредит*/
                                             CarDate,                     /* Дата */
                                             1,                           /* Глава */
                                             NATCUR,                      /* Валюта */
                                             ABS( Min(OverAmount,Sпол_ост) ),           /* Сумма  */
                                             Doc,                         /* Документ */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             "Списание положительной переоценки",
                                             null,
                                             null, GetFIRoleByPortfolio(Group)
                                           )
             )
               return false;
           end;
        end;
     end;

     if( OverAmount > Sпол_ост )
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "Реализация, ц/б", МинусПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                          CarDate,                     /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          OverAmount-Sпол_ост ,     /* Сумма  */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          "",                          /* Numb_Document */
                                          "Списание положительной переоценки",
                                          null,
                                          null,
                                          GetFIRoleByPortfolio( Group ),
                                          null, null, null, null, null, null, null, null, null, null, null, null,
                                          null, MC_PAIRACCMODE_MANUAL
                                        )
          )
            return false;
        end;

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          МинусПОДК, "+Маржа, ц/б",/* КатегДеб , КатегКредит*/
                                          CarDate,                     /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          OverAmount-Sпол_ост,      /* Сумма  */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          "",                          /* Numb_Document */
                                          "Списание положительной переоценки",
                                          null,
                                          null, GetFIRoleByPortfolio(Group),
                                          null, null, null, null, null, null, null, null, null, null, null, null,
                                          MC_PAIRACCMODE_MANUAL, null
                                        )
          )
            return false;
        end;
     end;

  elif( OverAmount < 0 )

     if(not ПроводкаПоКатегориямУчета( FD, 
                                       МинусПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                       CarDate,                     /* Дата */
                                       1,                           /* Глава */
                                       NATCUR,                      /* Валюта */
                                       Min( Abs(OverAmount), Sотр_ост ),/* Сумма  */
                                       Doc,                         /* Документ */
                                       INPCARRY,                    /* Result_Carry */
                                       " 1",                        /* Kind_Oper */
                                       "",                          /* Numb_Document */
                                       "Списание отрицательной переоценки",
                                       null,
                                       GetFIRoleByPortfolio( Group ),
                                       null, null, null, null, null, null, null, null, null, null, null, null, null,
                                       MC_PAIRACCMODE_MANUAL, null
                                     )
       )
         return false;
     end;
     
     if(FD.IsExistAccount( МинусПОДК, null, true, null, acnt_dk_negative, MC_PAIRACCMODE_MANUAL, CarDate ))
        sum_dk_negative = GetRestAccount( acnt_dk_negative, CarDate );
        if( sum_dk_negative != 0 )
           if(not ПроводкаПоКатегориямУчета( FD, 
                                             "-Маржа, ц/б", acnt_dk_negative,/* КатегДеб , КатегКредит*/
                                             CarDate,                     /* Дата */
                                             1,                           /* Глава */
                                             NATCUR,                      /* Валюта */
                                             Min( Abs(OverAmount), Sотр_ост ),           /* Сумма */
                                             Doc,                         /* Документ */
                                             INPCARRY,                    /* Result_Carry */
                                             " 1",                        /* Kind_Oper */
                                             "",                          /* Numb_Document */
                                             "Списание отрицательной переоценки",
                                             null,
                                             GetFIRoleByPortfolio(Group)
                                           )
             )
               return false;
           end;
        end;
     end;

     if( abs(OverAmount) > Sотр_ост )
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          ПлюсПереоценкаЦБ, "Реализация, ц/б",/* КатегДеб , КатегКредит*/
                                          CarDate,                     /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          abs(OverAmount)- Sотр_ост,/* Сумма  */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          "",                          /* Numb_Document */
                                          "Списание отрицательной переоценки",
                                          null,
                                          GetFIRoleByPortfolio( Group ),
                                          null, null, null, null, null, null, null, null, null, null, null, null, null,
                                          MC_PAIRACCMODE_MANUAL, null
                                        )
          )
            return false;
        end;

        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "-Маржа, ц/б", ПлюсПОДК,     /* КатегДеб , КатегКредит*/
                                          CarDate,                     /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          abs(OverAmount)- Sотр_ост,/* Сумма */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          "",                          /* Numb_Document */
                                          "Списание отрицательной переоценки",
                                          null,
                                          GetFIRoleByPortfolio(Group), null,
                                          null, null, null, null, null, null, null, null, null, null, null, null,
                                          null, MC_PAIRACCMODE_MANUAL
                                        ) 
          )
            return false;
        end;
     end;

  end;

  return true;
END;

MACRO ВыполнитьСписаниеПереоценкиТП( FD, Group:INTEGER, OverAmount:MONEY, CarDate:DATE ):BOOL
  VAR Sпол_ост = $0, Sотр_ост = $0;

  if( (OverAmount == null) OR (OverAmount == 0) )
     return true;
  end;

  var МинусПереоценкаЦБ:string = "-Переоценка, ц/б ССПУ_ЦБ";
  var ПлюсПереоценкаЦБ:string  = "+Переоценка, ц/б ССПУ_ЦБ";

  /*остаток на счете категории "-Переоценка"*/
  if( FD.IsExistAccount( МинусПереоценкаЦБ, null, true, GetFIRoleByPortfolio( Group ), acnt_ov_negative, MC_PAIRACCMODE_MANUAL, CarDate ))
     Sотр_ост = GetRestAccount( acnt_ov_negative, CarDate );
  end;

  /*остаток на счете категории "+Переоценка"*/
  if( FD.IsExistAccount( ПлюсПереоценкаЦБ, null, true, GetFIRoleByPortfolio( Group ), acnt_ov_positive, MC_PAIRACCMODE_MANUAL, CarDate ) )
     Sпол_ост = ABS( GetRestAccount( acnt_ov_positive, CarDate ) );
  end;

  if( OverAmount > 0 )
     if(not ПроводкаПоКатегориямУчета( FD, 
                                       "-МаржаП, ц/б", ПлюсПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                       CarDate,                     /* Дата */
                                       1,                           /* Глава */
                                       NATCUR,                      /* Валюта */
                                       ABS( Min(OverAmount,Sпол_ост) ), /* Сумма  */
                                       Doc,                         /* Документ */
                                       INPCARRY,                    /* Result_Carry */
                                       " 1",                        /* Kind_Oper */
                                       "",                          /* Numb_Document */
                                       "Списание положительной переоценки",
                                       null,
                                       null,
                                       GetFIRoleByPortfolio( Group ),
                                       null, null, null, null, null, null, null, null, null, null, null, null,
                                       null, MC_PAIRACCMODE_MANUAL
                                     )
       )
         return false;
     end;
     
     if( OverAmount > Sпол_ост )
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          "-МаржаП, ц/б", МинусПереоценкаЦБ,/* КатегДеб , КатегКредит*/
                                          CarDate,                     /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          OverAmount-Sпол_ост,         /* Сумма  */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          "",                          /* Numb_Document */
                                          "Списание положительной переоценки",
                                          null,
                                          null,
                                          GetFIRoleByPortfolio( Group ),
                                          null, null, null, null, null, null, null, null, null, null, null, null,
                                          null, MC_PAIRACCMODE_MANUAL
                                        )
          )
            return false;
        end;
     end;

  elif( OverAmount < 0 )

     if(not ПроводкаПоКатегориямУчета( FD, 
                                       МинусПереоценкаЦБ, "+МаржаП, ц/б",/* КатегДеб , КатегКредит*/
                                       CarDate,                     /* Дата */
                                       1,                           /* Глава */
                                       NATCUR,                      /* Валюта */
                                       Min( Abs(OverAmount), Sотр_ост ),/* Сумма  */
                                       Doc,                         /* Документ */
                                       INPCARRY,                    /* Result_Carry */
                                       " 1",                        /* Kind_Oper */
                                       "",                          /* Numb_Document */
                                       "Списание отрицательной переоценки",
                                       null,
                                       GetFIRoleByPortfolio( Group ),
                                       null, null, null, null, null, null, null, null, null, null, null, null, null,
                                       MC_PAIRACCMODE_MANUAL, null

                                     ) 
       )
         return false;
     end;
     
     if( abs(OverAmount) > Sотр_ост )
        if(not ПроводкаПоКатегориямУчета( FD, 
                                          ПлюсПереоценкаЦБ, "+МаржаП, ц/б",/* КатегДеб , КатегКредит*/
                                          CarDate,                     /* Дата */
                                          1,                           /* Глава */
                                          NATCUR,                      /* Валюта */
                                          abs(OverAmount)- Sотр_ост,   /* Сумма  */
                                          Doc,                         /* Документ */
                                          INPCARRY,                    /* Result_Carry */
                                          " 1",                        /* Kind_Oper */
                                          "",                          /* Numb_Document */
                                          "Списание отрицательной переоценки",
                                          null,
                                          GetFIRoleByPortfolio( Group ),
                                          null, null, null, null, null, null, null, null, null, null, null, null, null,
                                          MC_PAIRACCMODE_MANUAL, null
                                        )
          )
            return false;
        end;
     end;

  end;

  return true;
END;

private record CredCatAcc(account);
private record DebCatAcc(account);
private record CredCatAccBD(account);
private record DebCatAccBD(account);

MACRO СписаниеСебестоимостиПриПродаже( FD:SPFirstDoc, CarDate:DATE, Doc:VARIANT, IsCompensWrt:BOOL ):BOOL
   VAR dlsum = TRecHandler( "DLSUM" );
   VAR i = 0, Groups = TArray(), AccCredit, FIIDCredit, PartNum = 0, 
       FR = $0, CommSum = $0, CommSumFIID;
   VAR RSD, SQLQuery, FD_buy, RatePVO, FIRole;
   VAR DebCat, CredCat, DebCatBD, CarFIID, CarFIID2, CarSumm, CarSumm_od = $0, Capter, CarSummBD, TotalCost = $0, 
       Amount = $0, PreoutlayNotPVO;

   VAR ALL_CostBuy             = $0, CostBuy             = $0, // Списанная чистая стоимость (Счист)
       ALL_BalanceCostBuy      = $0, BalanceCostBuy      = $0, // Списанная текущая стоимость 
       ALL_NKDBuy              = $0, NKDBuy              = $0, // НКД ( S(НКД упл.))
       ALL_InterestIncomeBuy   = $0, InterestIncomeBuy   = $0, // Списанный начисленный ПД 
       ALL_DiscountIncomeBuy   = $0, DiscountIncomeBuy   = $0, // Cписанный начисленный ДД 
       ALL_NotCarryInterestBuy = $0, NotCarryInterestBuy = $0, // Списанный не отнесенный на доходы ПД  
       ALL_NotCarryDiscountBuy = $0, NotCarryDiscountBuy = $0, // Списанный не отнесенный на доходы ДД  
       ALL_InterestIncomeAdd   = $0, InterestIncomeAdd   = $0, // Доначисленный ПД S(Sдонач.ПДi)
       ALL_DiscountIncomeAdd   = $0, DiscountIncomeAdd   = $0, // Доначисленный ДД S(Sдонач.ДДi)
       ALL_NotCarryInterestAdd = $0, NotCarryInterestAdd = $0, // Доначисленный не отнесенный на доходы ПД  
       ALL_NotCarryDiscountAdd = $0, NotCarryDiscountAdd = $0, // Доначисленный не отнесенный на доходы ДД  
       ALL_InterestIncomeSum   = $0, InterestIncomeSum   = $0, // Суммарный начисленный ПД S(ПДначисл)
       ALL_DiscountIncomeSum   = $0, DiscountIncomeSum   = $0, // Суммарный начисленный ДД S(ДДначисл)
       ALL_NotCarryInterestSum = $0, NotCarryInterestSum = $0, // Суммарный не отнесенный на доходы ПД  S(ПДне_отн)
       ALL_NotCarryDiscountSum = $0, NotCarryDiscountSum = $0, // Суммарный не отнесенный на доходы ДД  S(ДДне_отн)
       ALL_BalanceCostSum      = $0, BalanceCostSum      = $0, // Суммарная текущая стоимость ( (Стек))
       ALL_BalanceCostBD       = $0,                           // Списанная стоимость в ОД (Часть остатка счета "- ОД", пропорциональная количеству ц/б, проданно-му из ТП и ППР)
       ALL_OutlayBuy           = $0, OutlayBuy           = $0, // Списанные затраты
       ALL_OverAmountBuyPPR    = $0, OverAmountBuy       = $0, // Списанная сумма переоценки S(ПО)
       ReservAmountBuy     = $0, // Списанная сумма резерва (Сумма созданного резерва)
       ALL_AmountNotPVO        = $0, ALL_Amount          = $0,
       IncomeReservBuy         = $0, 
       BonusAdd                = $0,
       ALL_CostSum             = $0, CostSum             = $0;

   VAR BalanceCostBD = $0, CostSale = $0, SСпво = $0, SСакт = $0, BonusRest = $0, NKDRest = $0;


   return true; 
END;

/*Если NoDocsByPmPc = true - не будет проводки по платежу по процентам*/
macro ВыполнитьПроводкиПроцентовВРепо(FD, Doc, dat, NoDocsByPmPc, WasExecRQ:@BOOL)

   var CatDebet = "", CatCredit = "", ground, IsOverdue = false, In, Sum = $0, SumPC = $0, R = $0, PT_IsResp = false;
   var DebFIID, CredFIID, CatDebPM = "", CatCredPM = "", groundPM = "";
   var Sпред_вб_вр = $0, Sпред_вб_вц = $0, Sпред_вр = $0, Sпред_вц = $0, Sum_б = $0, Sum_вб = $0;
   var PayerAccountBuffPC = TRecHandler( "account" );
   var ReceiverAccountBuffPC = TRecHandler( "account" );
   var FIRole = FIROLE_CA;

   WasExecRQ = false;

   if( ТОБылоПросрочено(FD.GetRQ(DLRQ_TYPE_INCREPO) ) )
      IsOverdue = true;
   end;

   if( not IsClientDeal(FD.tick.rec) )
      R = FD.dl_leg.rec.IncomeRate;

      PT_IsResp = true;


      Sпред_вб_вр = ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_NOTCARRY_PERCENT);
      Sпред_вб_вц = ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_NOTCARRY_PERCENT_CFI);
      Sпред_вр    = ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT);
      Sпред_вц    = ПолучитьПоследнююСумму(DL_SECURITYDOC, FD.tick.rec.DealID, DLSUM_KIND_SUM_TO_PERCENT_CFI);

      /*Появилась определенность в получении дохода (при изменении категории качества субъекта)*/
      if( ((R > 0.0) and IsBUY(FD.Group)) or 
          ((R < 0.0) and IsSALE(FD.Group))
        ) 
         if (PT_IsResp and (Sпред_вб_вр > $0))
            CatDebet  = "ВнебалСчетКорресп"; 
            DebFIID   = NATCUR;

            if( IsOverdue )
               CatCredit = "Задолж.%с н.с (внебаланс)";
            else
               CatCredit = "Задолж.% (внебаланс)";
            end;
            CredFIID  = FD.GetPayFIID();

            if(not ПроводкаПоКатегориямУчета( FD, 
                   CatDebet, CatCredit,         /* КатегДеб , КатегКредит*/
                   ScOprServDoc.CommDate,         /* Дата */
                   3,                           /* Глава */
                   FD.GetPayFIID(),             /* Валюта */
                   Sпред_вб_вр,                 /* Сумма  - превышение суммы плано-вых процентов (за срок с До1ф до До2ф) над суммой начисленных процентов*/
                   Doc,                         /* Документ */
                   INPCARRY,                    /* Result_Carry */
                   " 1",                        /* Kind_Oper */
                   ScOprServDoc.CommCode,         /* Numb_Document */
                   "Списание суммы процентов, начисленной на внебалансе",
                   null,
                   FIRole, null,
                   DebFIID, CredFIID
                  ) 
              )
                return 1;
            end;

            if (not FD.СделкаОРЦБ())
               if( IsOverdue )
                  CatDebet = "+% с н.с.";
               else
                  CatDebet = "+% к погашению";
               end;
               DebFIID  = FD.GetPayFIID();

               CatCredit = "+%Пкр";
               CredFIID   = NATCUR;

               if(not ПроводкаПоКатегориямУчета( FD, 
                      CatDebet, CatCredit,         /* КатегДеб , КатегКредит*/
                      ScOprServDoc.CommDate,         /* Дата */
                      1,                           /* Глава */
                      FD.GetPayFIID(),             /* Валюта */
                      Sпред_вб_вр,                 /* Сумма  - превышение суммы плано-вых процентов (за срок с До1ф до До2ф) над суммой начисленных процентов*/
                      Doc,                         /* Документ */
                      INPCARRY,                    /* Result_Carry */
                      " 1",                        /* Kind_Oper */
                      ScOprServDoc.CommCode,         /* Numb_Document */
                      "Учет начисленной суммы процентов в балансе и на доходах",
                      null,
                      null, null,
                      DebFIID, CredFIID
                     ) 
                 )
                   return 1;
               end;
            end;
         end;
      end;

       SumPC = FD.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount;

      if((((FD.dl_leg.rec.IncomeRate < 0.0) and IsSALE(FD.Group)) or
          ((FD.dl_leg.rec.IncomeRate > 0.0) and IsBUY(FD.Group))
         ) and (not PT_IsResp)
        )

         /*Нет определенности в получении процентов*/
         ground = "Доначисление процентов на внебалансе";

         if (IsOverdue)
            CatDebet = "Задолж.%с н.с (внебаланс)";
         else
            CatDebet = "Задолж.% (внебаланс)";
         end;
         DebFIID  = FD.GetPayFIID();

         CatCredit = "ВнебалСчетКорресп";
         CredFIID   = NATCUR;

         if( SmartConvertSum( Sum, SumPC - Sпред_вб_вц, dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false ) != true )
            return false;
         end;    

         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDebet, CatCredit,         /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                3,                           /* Глава */
                FD.GetPayFIID(),             /* Валюта */
                Sum,                         /* Сумма  - превышение суммы плано-вых процентов (за срок с До1ф до До2ф) над суммой начисленных процентов*/
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null, FIRole,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;
      else
         ground = "Доначисление процентов";
         /*
         Если Прямое репо и Ставка > 0 или Обратное РЕПО и Ставка < 0  
         */
         if(((FD.dl_leg.rec.IncomeRate > 0.0) and IsSALE(FD.Group)) or
            ((FD.dl_leg.rec.IncomeRate < 0.0) and IsBUY(FD.Group))
           )
            CatDebet  = "-%Пкр"; 
            DebFIID   = NATCUR;
            if( IsOverdue )
               CatCredit = "-% с н.с.";
            else
               CatCredit = "-% к погашению";
            end;
            CredFIID  = FD.GetPayFIID();
         else

            ground = "Доначисление процентов в балансе";

            if( IsOverdue )
               CatDebet = "+% с н.с.";
            else
               CatDebet = "+% к погашению";
            end;
            DebFIID  = FD.GetPayFIID();

            CatCredit = "+%Пкр";
            CredFIID   = NATCUR;
         end;

         /*Сумма в балансе*/
         if( SmartConvertSum( Sum, SumPC - (Sпред_вц - Sпред_вб_вц), dat, FD.dl_leg.rec.CFI, FD.GetPayFIID(), false ) != true )
            return false;
         end;    

         if(not ПроводкаПоКатегориямУчета( FD, 
                CatDebet, CatCredit,         /* КатегДеб , КатегКредит*/
                dat,                         /* Дата */
                1,                           /* Глава */
                FD.GetPayFIID(),             /* Валюта */
                Sum,                         /* Сумма  - превышение суммы плано-вых процентов (за срок с До1ф до До2ф) над суммой начисленных процентов*/
                Doc,                         /* Документ */
                INPCARRY,                    /* Result_Carry */
                " 1",                        /* Kind_Oper */
                "",                          /* Numb_Document */
                ground,
                null,
                null, null,
                DebFIID, CredFIID
               ) 
           )
             return false;
         end;

      end;

   end;

   if (NoDocsByPmPc)
      return true;
   end;

   if (FD.dl_leg.rec.IncomeRate > 0.0)
      if (IsOverdue == false)
         ground = "Выплата процентов без просрочки";
      else
         ground = "Выплата просроченных процентов";
      end;
   else
      if (IsOverdue == false)
         ground = "Получение процентов без просрочки";
      else
         ground = "Получение просроченных процентов";
      end;
   end;


   if ((( FD.BuySale == DEAL_TYPE_BUY  ) and (FD.dl_leg.rec.IncomeRate > 0.0)) or
       (( FD.BuySale == DEAL_TYPE_SALE ) and (FD.dl_leg.rec.IncomeRate < 0.0))
      )
      In = false;
   else
      In = true;
   end;

   if(ПолучитьСчетаТОПоПроцентам( FD.GetRQ(DLRQ_TYPE_INCREPO), FD, dat, In, PayerAccountBuffPC, ReceiverAccountBuffPC ) != 0)
     return false;
   end;
      
   if( IsClientDeal(FD.tick.rec) )

      if( not In )                                                                
         ground = "Выплата процентов по сделке № "+string(FD.tick.rec.DealCode);                                
      else                                                                          
         ground = "Получение процентов по сделке №"+string(FD.tick.rec.DealCode);                               
      end;                                                                          
       
      if( ОбработатьДенежноеТО( FD.GetRQ(DLRQ_TYPE_INCREPO), PayerAccountBuffPC, ReceiverAccountBuffPC, FD, dat, Doc, ground ) != 0 )
         return false;
      end;                                                                                                                 
      WasExecRQ = true;
                                                                                                                                        
   elif( IsBUY(FD.Group) or (IsSALE(FD.Group) and IsEXCHANGE(FD.Group)) )
      
      if( (IsSALE(FD.Group) and (FD.dl_leg.rec.IncomeRate > 0.0)) or
          (IsBUY(FD.Group)  and (FD.dl_leg.rec.IncomeRate < 0.0)) 
        )

         if( ОбработатьДенежноеТО( FD.GetRQ(DLRQ_TYPE_INCREPO), PayerAccountBuffPC, ReceiverAccountBuffPC, FD, dat, Doc, ground ) != 0 )
           return false;
         end;
         WasExecRQ = true;
      else

         if( (((R > 0.0) and IsBUY(FD.Group)) or 
              ((R < 0.0) and IsSALE(FD.Group))
             ) and (not PT_IsResp)
           ) 
            /*Ненадежное, значит доначисляли на внебаланс, начислено на балансе - (сумма 2011 минус сумма 2021), 
              а на внебалансе = (сумма процентов по сделке минус (сумма 2011 минус сумма 2021) )*/
            Sum_б  = Sпред_вц - Sпред_вб_вц;
            Sum_вб = FD.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount - (Sпред_вц - Sпред_вб_вц);
         else
            /*Надежное, значит доначисляли на баланс, начислено на внебалансе - сумма 2021, 
              а на балансе = (сумма процентов по сделке минус сумма 2021)*/
            Sum_б  = FD.GetRQ(DLRQ_TYPE_INCREPO).rec.Amount - Sпред_вб_вц;
            Sum_вб = Sпред_вб_вц;
         end;

         if(not ПроводкаПоКатегориямУчета( FD, 
               PayerAccountBuffPC, ReceiverAccountBuffPC,/* КатегДеб , КатегКредит*/
               dat,                  /* Дата */
               1,                   /* Глава */
               FD.GetRQ(DLRQ_TYPE_INCREPO).rec.FIID,  /* Валюта */
               Sum_б,                /* Сумма  */
               Doc,                  /* Документ */
               INPCARRY,             /* Result_Carry */
               " 1",                 /* Kind_Oper */
               "",                   /* Numb_Document */
               "Проценты на балансе по сделке № " + string(FD.tick.rec.DealCode), null,null,null,
               PayerAccountBuffPC.rec.Code_Currency, ReceiverAccountBuffPC.rec.Code_Currency     /* валюты счетов: Дт - Кт */ 
              ) )
            return false;
         end;

      end;

   end;

   return true;
end;


