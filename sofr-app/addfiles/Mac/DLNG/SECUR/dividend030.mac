/*
$Name:         dividend030.mac
$Module:       Ценные бумаги
$Description:  Операция возврата дивидендов
*/
/*  Оплата получателю   */

import InsCarryDoc, "sp_class.mac", "sp_car2.mac", "spservsql.mac", "SPQICheckOper.mac", "nutxfun.mac",  "nptxcalcfun.mac", nptxcalcfun;

private macro FindPartyByID ( id: Integer, _party ): bool
    return ПолучитьСубъекта(id, _party) == 0;
end;   

private macro _convertCurr(outVal:@money, inVal:money, ondate:date, fromCurr, toCurr ): bool
    var stat: bool = true;
    if (fromCurr != toCurr)
        stat = ConvSumDbl( outVal, inVal, onDate, fromCurr, toCurr, true, 7 /*ЦБ РФ*/ );
        SetParm(0, outVal); // передаем по ссылке
    end;
    return stat;
end;

PRIVATE MACRO ОбращаемостьБумагиНаДату( FIID:integer, CheckDate:date ):bool  // НЕ РАБОТАЕТ УДАЛИТЬ!!!!!!!!!!

  var RetVal:bool = false;

  var Select = " SELECT Rsb_SCTX.IsSPGetRate(?, -1, Rsb_Common.GetRegIntValue('SECUR\\ВИД КУРСА СРЕДНЕВЗВЕШЕННАЯ ЦЕНА', 0), ?, ?-add_months(?,-3)-1) as RetVal " +
               "   FROM DUAL ";

  var Query = DL_RSDCommand(Select);
  Query.addParam(FIID);
  Query.addParam(CheckDate);
  Query.addParam(CheckDate);
  Query.addParam(CheckDate);

  var DataSet = Query.execute();

  if( DataSet.MoveNext() )
     RetVal = IIF((int(DataSet.RetVal)) == 0, true, false);
  end;

  return RetVal;
END;

private macro ISS_ifmarket(pfi: integer, _date: date) : bool
    var cmd = DL_RSDCommand("select NPTO.IfMarket(?, ?) ifMarket from dual;");
    cmd.addParam(pfi);
    cmd.addParam(_date);

    var rs = cmd.execute();

    if ( rs.MoveNext() )
        return rs.ifMarket == "X";
    end;
    return false;
end;


//macro ExecuteStep( Doc, FDoc ) 
MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )  
    record deal(dl_tick);
    SetBuff( deal, FDoc ); 
     
    VAR FD = SPFirstDoc( deal ),
        AccountDt = TrecHandler( "account.dbt"),
        AccountCt = TrecHandler( "account.dbt"),
        AccountIncome = TrecHandler( "account.dbt");

    record reciepient_party(party);  // получатель PartyID
    record payer_party(party);       // плательщик ClientID
    record benef_party(party);       // (BenefCode) Фактический получатель
    var amount  = 0.0;
    var leg = FD.dl_leg.rec;
    var tick = FD.tick.rec;
    var rq_money = TRecHandler("dlrq.dbt");
        rq_money = FD.GetRQ(DLRQ_TYPE_PAYMENT);

    if(УстановитьСтатусТО(rq_money, DLRQ_STATE_EXEC, deal.DealDate) != 0)
       return 1;
    end;

    if( not InsertOprStatus( 1511, 3) )
        msgbox( "Ошибка при установке статуса <Документооборот> операции" );
        return 1;
    end;
     
    var DivDeal = leg.Cost,
        TaxPay13  = leg.ReturnIncome,
        TaxPay15  = leg.PayerIncrTax,
        TaxGet13  = leg.ReceiptAmount,
        TaxGet15  = leg.ReceiverIncrTax;
    var TaxPay = TaxPay13 + TaxPay15;
    var TaxGet = TaxGet13 + TaxGet15;
            
    // Конввертация значения DivDeal(CurDeal) в CurGet
    if( _convertCurr(DivDeal, DivDeal, deal.dealDate, FD.tick.rec.CurDeal, FD.tick.rec.CurGet) == false )
        return 1;
    end;
    // Конввертация значения TaxPay(CurPay) в CurGet
    if( _convertCurr(TaxPay, TaxPay, deal.dealDate, FD.tick.rec.CurPay, FD.tick.rec.CurGet) == false )
        return 1;
    end;
    if( _convertCurr(TaxPay13, TaxPay13, deal.dealDate, FD.tick.rec.CurPay, FD.tick.rec.CurGet) == false )
        return 1;
    end;
    if( _convertCurr(TaxPay15, TaxPay15, deal.dealDate, FD.tick.rec.CurPay, FD.tick.rec.CurGet) == false )
        return 1;
    end;
     
    if ( FindPartyByID(deal.PartyID, reciepient_party) )
             
        if ( (deal.ClientID != -1) and ({OurBank} != deal.ClientID) )  // OurBank=No  
        
          if(ПолучитьДенежныйСчетСубъектаПоСделке(FD.tick.rec.BOfficeKind, 
                                                  FD.tick.rec.DealID, 
                                                  deal.ClientID,  //FD.tick.rec.PartyID, 
                                                  FD.GetRQ(DLRQ_TYPE_PAYMENT).rec.FIID, 
                                                  AccountCt) != 0)
             Msgbox( "Не заполнены платежные реквизиты субъекта с ID = " +string(deal.ClientID) );
             return 1;
          end;

          if(FindPartyByID(deal.ClientID, payer_party))
                                                 // Оа
            // статусы (юрли-цо/физлицо) плательщика и полу-чателя совпадают
            if ( reciepient_party.LegalForm == payer_party.LegalForm  )
                amount = DivDeal - max(TaxPay, TaxGet);
            // статусы (юрли-цо/физлицо) плательщика и получателя отличаются                // Оа
            elif ( reciepient_party.LegalForm != payer_party.LegalForm  )
                amount = DivDeal - TaxPay - TaxGet;
            end;
          end;
        else // OurBank = Yes   
            amount = DivDeal - max(TaxPay, TaxGet);
        end;    
    end;
                               
    if( not FD.OpenAccount( "-Расчеты", null, true, null, AccountIncome, deal.dealDate,  FD.tick.rec.CurGet) ) 
        MsgBox( "Ошибка при определении счета по категории <"+"-Расчеты"+">." );
        return 1;
    end; 
    if((AccountIncome.rec.Account != "") and (AccountCt.rec.Account != ""))
      if(not ПроводкаПоКатегориямУчета( 
             FD, 
             AccountIncome, AccountCt,
             deal.dealDate,                 /* Дата */
             1,                             /* Глава */
             FD.tick.rec.CurGet,//NATCUR,   /* Валюта суммы проводки */
             amount,                        /* Сумма проводки*/   
             Doc,                           /* Документ */
             INPCARRY,                      /* Result_Carry */
             " 1",                          /* Kind_Oper */
             deal.DealCode,                 /* Numb_Document */
             "Оплата контрагенту",          /* Ground */
             null,null,null//,
             ,AccountIncome.rec.code_currency, AccountCt.rec.code_currency
              ) 
          )
              MsgBox( "Ошибка при выполнении проводки" );
              return 1;
          end;
    end;

    if ( ПолучитьСубъекта(tick.FactReceiverID, benef_party) != 0 )
        MsgBox("Фактический получатель не найден ID" + tick.FactReceiverID);
        return 1;
    end;

    if(  (DL_UseNUTX() == true) and (reciepient_party.LegalForm == legal_form_jur) and (IsNeresidentForNUTX(reciepient_party.PartyID, deal.dealDate) == true))
        var TaxGroup = GetTaxGroupNUTX(deal.PFI, deal.dealDate);
        if(0 != DL_NUTX_InsertTaxObjectOnStep( deal.dealDate         // Дата НДР
                                           ,reciepient_party.PartyID //Клиент
                                           ,deal.FactReceiverID   // Фактический получатель дохода
                                           ,NUTXOBJ_DIR_IN        // Направление
                                           ,4                     // Уровень
                                           ,""                    // Признак "Пользовательский"
                                           ,NUTXOBJ_PLUS_01       // Вид НДР
                                           ,DivDeal               // Сумма дохода/расхода
                                           ,FD.tick.rec.CurGet    // Валюта дохода/расхода
                                           ,TXOBJ_KIND1100        // Вид аналитики 1
                                           ,deal.DealID           // Аналитика 1
                                           ,0                     // Вид аналитики 2
                                           ,-1                    // Аналитика 2
                                           ,TXOBJ_KIND3010        // Вид аналитики 3
                                           ,deal.PFI              // Аналитика 3
                                           ,0                     // Вид аналитики 4
                                           ,-1                    // Аналитика 4
                                           ,TXOBJ_KIND5010        // Вид аналитики 5
                                           ,TaxGroup              // Аналитика 5
                                           ,0                 
                                           ,-1
                                           ,"Дивиденды" )         // Комментарий
        )
            MsgBox( "Ошибка при создании объекта НДР" );
            return 1;
        end;

        if(IsInstNeresForNUTX(deal.FactReceiverID, deal.dealDate) == true)
            if(0 != DL_NUTX_InsertTaxObjectOnStep( deal.dealDate          // Дата НДР
                                              ,reciepient_party.PartyID //Клиент
                                              ,deal.FactReceiverID   // Фактический получатель дохода
                                              ,NUTXOBJ_DIR_OUT       // Направление
                                              ,5                     // Уровень
                                              ,""                    // Признак "Пользовательский"
                                              ,NUTXOBJ_DUETAX        // Вид НДР
                                              ,TaxGet                // Сумма дохода/расхода
                                              ,FD.tick.rec.CurGet    // Валюта дохода/расхода
                                              ,TXOBJ_KIND1100        // Вид аналитики 1
                                              ,deal.DealID           // Аналитика 1
                                              ,0                     // Вид аналитики 2
                                              ,-1                    // Аналитика 2
                                              ,TXOBJ_KIND3010        // Вид аналитики 3
                                              ,deal.PFI              // Аналитика 3
                                              ,0                     // Вид аналитики 4
                                              ,-1                    // Аналитика 4
                                              ,TXOBJ_KIND5010        // Вид аналитики 5
                                              ,TaxGroup              // Аналитика 5
                                              ,0                 
                                              ,-1
                                              ,"Налог, подлежащий уплате" )  // Комментарий
            )
                MsgBox( "Ошибка при создании объекта НДР" );
                return 1;
            end;

            var Sum = $0;
            var CatCred = "";
            if(deal.taxHandle == SET_CHAR)  
                SP_GetTaxAmountInRetDivid(FD.tick.rec.ClientID, FD.tick.rec.PartyID, FD.tick.rec.FactReceiverID,
                                    DivDeal, TaxPay13, TaxGet13, TaxPay15, TaxGet15,
                                    @Sum, @CatCred);
            end;
        
            if((payer_party.PartyID > 0) and (payer_party.LegalForm == legal_form_jur))
                //Sum = Sum + leg.ReceiptAmount;
                Sum = Sum + TaxGet;
            end;

            if(Sum > 0)
                if (0 != DL_NUTX_InsertTaxObjectOnStep( deal.dealDate          // Дата НДР
                                                    ,reciepient_party.PartyID //Клиент
                                                    ,tick.FactReceiverID   // Фактический получатель дохода
                                                    ,NUTXOBJ_DIR_OUT       // Направление
                                                    ,6                     // Уровень
                                                    ,""                    // Признак "Пользовательский"
                                                    ,NUTXOBJ_PAIDTAX       // Вид НДР
                                                    ,Sum                   // Сумма дохода/расхода
                                                    ,FD.tick.rec.CurGet//NATCUR                // Валюта дохода/расхода
                                                    ,TXOBJ_KIND1100        // Вид аналитики 1
                                                    ,deal.DealID           // Аналитика 1
                                                    ,0                     // Вид аналитики 2
                                                    ,-1                    // Аналитика 2
                                                    ,TXOBJ_KIND3010        // Вид аналитики 3
                                                    ,deal.PFI              // Аналитика 3
                                                    ,0                     // Вид аналитики 4
                                                    ,-1                    // Аналитика 4
                                                    ,TXOBJ_KIND5010        // Вид аналитики 5
                                                    ,TaxGroup              // Аналитика 5
                                                    ,0                 
                                                    ,-1
                                                    ,"Удержанный налог" )  // Комментарий
                )
                    MsgBox( "Ошибка при создании объекта НДР" );
                    return 1;
                end;
            end;
        end;
    end;

//*------------------------------------------------------------------------------------------------------------------------------
    // В операции для всех фактических получателей - физ.лиц (поле BenefCode), если установлен флаг TaxHandle, то формируются НДРы
//*-------------------------------------------------------------------------------------------------------------------------------
    var stat = 0;
    if ( (deal.taxHandle == SET_CHAR) and (benef_party.LegalForm == 2) )
 

        ClearGTT_DNPTXOBJ_TMP();
    
        stat = CreateDividendTaxObjects(ID_Operation, ID_Step, FD.tick, FD.dl_leg, DivDeal );

        if ( 0 == stat )
            stat = DL_NPTX_StartInsertTaxObject(ID_Operation, ID_Step); 
        end;
    end;

    return stat;
end;  
