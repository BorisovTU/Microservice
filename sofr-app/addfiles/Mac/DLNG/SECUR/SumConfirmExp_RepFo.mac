/**
 @file 		SumConfirmExp_RepFo.mac
 @brief 	Отчет "Суммы подтвержденных расходов"

 # tag
 - functional_block: Отчетность_внутренняя
 - code_type: Report
 - code_type:GUI

 #menu 
  - БО ЦБ\ Внутренний учет \ Отчеты \ Поручения и операции клиентов \ Суммы подтвержденных расходов

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |02.05.2025 |Велигжанин А.В.|DEF-88733                                       |Переделано в функцию SumConfirmExpReportRunFuncObj()

*/
import "SumConfirmExp_Print.mac", "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "dldlngfun.mac", "scsrvrepfun.mac", "FuncObj.mac";
import "CbLogger2.mac";

PRIVATE CONST PRINT_FUNCID = 5037;
PRIVATE CONST FUNOBJECTTYPE = 4601;

class MassPrintDLParm(_GUID, _PackNum, _RepDate, _LaunchMode)
   var GUID          = _GUID       ;
   var PackNum       = _PackNum    ;
   var RepDate       = _RepDate    ;
   var LaunchMode    = _LaunchMode ;
end;

PRIVATE MACRO MakeXmlDate(dt) // 2003-02-01Z
  var y, m, d;
  DateSplit(dt, d, m, y);
  return string(y:o:4, "-", m:o:2, "-", d:o:2, "Z");
end;


// Сколько выполнено с ошибкой
PRIVATE MACRO GetFaultTaskCount(GUID)
    var cmd, rs;
    var resCount = 0;

    cmd = RSDCommand( " SELECT count(1)                                  " +
                      " FROM DFUNCOBJ_DBT                                " +                                                                               
                      " WHERE T_OBJECTTYPE = ?                           " +
                      "   AND T_STATE IN (?,?)                           " +
                      "   AND T_OBJECTID IN ( SELECT T_FUNCOBJECTID      " +
                      "                       FROM DPRINTFUNCOBJ_DBT     " +
                      "                          WHERE T_GUID = ?  )     " );

    cmd.addParam( "", RSDBP_IN, FUNOBJECTTYPE                 );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_REPEAT_ERROR    );  // T_STATE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_FATAL_ERROR     );  // T_STATE
    cmd.addParam( "", RSDBP_IN, GUID                          );  // T_GUID        
   

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = int(rs.value(0));
    end;

    cmd = RSDCommand( "SELECT COUNT(DISTINCT hist.T_ID)                           " +
                      "FROM DFUNCOBJ_HIST_DBT hist,DFUNCOBJ_HISTPARM_DBT histparm " +
                      "WHERE hist.T_OBJECTTYPE = ?                                " +
                      "AND hist.T_ID = histparm.T_HISTID                          " +
                      "AND histparm.T_STATE IN (?,?)                              " +
                      "AND hist.T_OBJECTID IN ( SELECT T_FUNCOBJECTID             " +
                      "                           FROM DPRINTFUNCOBJ_DBT          " +
                      "                          WHERE T_GUID = ?        )        " );

    cmd.addParam( "", RSDBP_IN, FUNOBJECTTYPE                 );  // T_OBJECTTYPE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_REPEAT_ERROR    );  // T_STATE
    cmd.addParam( "", RSDBP_IN, FUNCOBJ_STATE_FATAL_ERROR     );  // T_STATE
    cmd.addParam( "", RSDBP_IN, GUID                          );  // T_GUID        
  

    rs = RsdRecordset( cmd );
    if( rs and rs.moveNext() )
      resCount = resCount + int(rs.value(0));
    end;

    return resCount;
END;

// Сколько выполнено успешно
PRIVATE MACRO GetSuccessTaskCount(GUID)
  var exec, DataSet;  
  var CountExec = 0;

  exec = DL_RSDCommand( "SELECT COUNT(hist.T_ID) CountExec                          " +
                        "FROM DFUNCOBJ_HIST_DBT hist, DFUNCOBJ_HISTPARM_DBT histparm " +
                        "WHERE hist.T_OBJECTTYPE = ?                                " +
                        "AND hist.T_ID = histparm.T_HISTID                          " +
                        "AND histparm.T_STATE = ?                                   " +
                        "AND hist.T_OBJECTID IN ( SELECT T_FUNCOBJECTID             " +
                        "                           FROM DPRINTFUNCOBJ_DBT          " +
                        "                          WHERE T_GUID = ?        )        " );

  exec.addParam( FUNOBJECTTYPE         );  // T_OBJECTTYPE
  exec.addParam( FUNCOBJ_STATE_PROCESS );  // T_STATE
  exec.addParam( GUID                  );  // T_GUID        
 
  DataSet = exec.Execute();

  if(DataSet.moveNext())
     CountExec = int(DataSet.CountExec);
  end;

  return CountExec;
END;


/**
 @brief 		Печать отчета через FuncObj
 @param[in]  p_GUID
 @param[in]  p_RepDate
 @param[in]  p_LaunchMode
 @param[in]  p_ClientID
 @param[in]  p_DlContrID
 @param[in]  p_FIID
*/
MACRO SumConfirmExpReportRunFuncObj(p_GUID, p_RepDate, p_LaunchMode, p_ClientID, p_DlContrID, p_FIID)
  var sql, exec, query, cmd, DataSet;  

/* Удалить, реализовано в SQL-запросе
  cmd = DL_RSDCommand("SELECT DISTINCT T_PackNum AS PackNum FROM DMASEXEC_DBT WHERE T_GUID = ? ORDER BY T_PackNum");
  cmd.addParam(GUID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
     var objParm = MassPrintDLParm(GUID, DataSet.PackNum, Form.RepDate, Form.LaunchMode );
     var strParm = "";
     ConvertToXML(objParm, NULL, @strParm);
     println(strParm);
  end;
*/
  cmd = RSDCommand( "INSERT INTO DPRINTFUNCOBJ_DBT (T_GUID, T_PACKNUM, T_FUNCOBJECTID) " +
                    " SELECT DISTINCT T_GUID, T_PACKNUM, 0 FROM DMASEXEC_DBT WHERE T_GUID = ?");
  cmd.addParam( "", RSDBP_IN, p_GUID );
  cmd.Execute();


  var  StrRepDate =  MakeXmlDate(p_RepDate);
  cmd = RSDCommand( " INSERT INTO dfuncobj_dbt (T_OBJECTTYPE, T_OBJECTID, T_FUNCID, T_CREATEDATE, T_PARAM, T_STATE, T_ERRORCODE, T_ERRORTEXT, T_ERRORDATETIME, T_EXECCOUNT, T_MODULE, T_PRIORITY, T_VERSION, T_SESSIONID, T_OPER, T_DATA) " +
                    " SELECT DISTINCT ?, pfo.T_FUNCOBJECTID, ?, ?, TO_CHAR(me.T_PACKNUM), ?, ?, ?, NULL, ?, ?, ?, ?, ?, ?, " +
                    " '<?xml version=''1.0'' encoding=''UTF-8''?><methodResponse xmlns=\"http://www.softlab.ru/xml-rpc/schema\" xmlns:n0=\"http://www.softlab.ru/xml-rpc/schema\" n0:reqId=\"{A44828BE-0E07-400D-8EFA-8E83AFFFC8FE}\" n0:logicalId=\"\"><params><param>" +
                    " <value><struct><member><name>GUID</name><value><string>'||TO_CHAR(me.T_GUID)||'</string></value></member><member><name>PackNum</name><value><integer>'||TO_CHAR(me.T_PACKNUM)||'</integer></value></member> " +
                    "<member><name>RepDate</name><value><date>" +StrRepDate+ "</date></value></member><member><name>LaunchMode</name><value><integer>"+p_LaunchMode+"</integer></value></member>" +
                    "</struct></value></param></params></methodResponse>' " +
                    "   FROM DMASEXEC_DBT me, DPRINTFUNCOBJ_DBT pfo " +
                    "  WHERE me.T_GUID = ? " +
                    "    AND pfo.T_GUID = me.T_GUID " +
                    "    AND pfo.T_PACKNUM = me.T_PACKNUM " +
                    "  ORDER BY me.T_PACKNUM ");

  cmd.addParam( "", RSDBP_IN, FUNOBJECTTYPE                 );  // T_OBJECTTYPE,   
  cmd.addParam( "", RSDBP_IN, PRINT_FUNCID                  );  // T_FUNCID,     
  cmd.addParam( "", RSDBP_IN, {curdate}                     );  // T_CREATEDATE,   
  cmd.addParam( "", RSDBP_IN, 0                             );  // T_STATE,        
  cmd.addParam( "", RSDBP_IN, 0                             );  // T_ERRORCODE,    
  cmd.addParam( "", RSDBP_IN, ""                            );  // T_ERRORTEXT,
  // cmd.addParam( "", RSDBP_IN, NULL                       );  // T_ERRORDATETIME,
  cmd.addParam( "", RSDBP_IN, 0                             );  // T_EXECCOUNT,    
  cmd.addParam( "", RSDBP_IN, 0                             );  // T_MODULE,       
  cmd.addParam( "", RSDBP_IN, 151                            );  // T_PRIORITY,     
  cmd.addParam( "", RSDBP_IN, 0                             );  // T_VERSION,      
  cmd.addParam( "", RSDBP_IN, 0                             );  // T_SESSIONID,    
  cmd.addParam( "", RSDBP_IN, {oper}                        );  // T_OPER,         
//    cmd.addParam( "", RSDBP_IN,                             );  // T_DATA
  cmd.addParam( "", RSDBP_IN, p_GUID );          

  cmd.Execute();

  var stat = 0;
  var IsExit = false;
  
  var CountPack = 0;
  var CountExec = 0;
  var CountFault = 0;

  exec = DL_RSDCommand("SELECT COUNT(1) CountPack FROM DPRINTFUNCOBJ_DBT WHERE T_GUID = ?");
  exec.addParam(p_GUID);
  DataSet = exec.Execute();
  if(DataSet.moveNext())
     CountPack = int(DataSet.CountPack);
  end;

  InitProgress(CountPack, "Идет подготовка данных для отчета", "Подготовка данных для отчета");

  while((CountPack > 0) AND (CountFault == 0) AND (stat == 0) AND (IsExit == false) AND (CountExec < CountPack))
    Delay(5000);
    CountFault = GetFaultTaskCount(p_GUID);
    CountExec = GetSuccessTaskCount(p_GUID);
    UseProgress(CountExec);                                                  
  end;

  var logger = LoggerFactory().NewItLog("SumConfirmExp_Report.mac").WithElapsedTime().GetLogger();


/* // Удалить, для теста без funcobj
  var i = 1;
  cmd = DL_RSDCommand("SELECT DISTINCT T_PackNum AS PackNum FROM DMASEXEC_DBT WHERE T_GUID = ? ORDER BY T_PackNum");
  cmd.addParam(GUID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())

     var objParm = MassPrintDLParm(GUID, DataSet.PackNum, Form.RepDate, Form.LaunchMode);
     var DataXml = "";
     ConvertToXML(objParm, NULL, @DataXml);

     PrintStartFunc(FUNOBJECTTYPE, i, String(DataSet.PackNum), GUID, -1, DataXml);
     i = i + 1;

     break;
  end;
*/
  RemProgress(); 

  if(CountFault != 0)
    MsgBox("Ошибка формирования отчета ");
  end;

  cmd = DL_RSDCommand("SELECT DISTINCT fof.T_FILEID AS FileID, fof.T_FILENAME AS FileName, fof.T_PACKNUM FROM DPRINTFUNCOBJFILES_DBT fof, DPRINTFUNCOBJ_DBT fo WHERE fo.T_GUID = ? AND fof.T_GUID = ? AND fo.T_PACKNUM = fof.T_PACKNUM ORDER BY fof.T_PACKNUM");
  cmd.addParam(p_GUID);
  cmd.addParam(p_GUID);

  DataSet = cmd.Execute();
  var IsEmptyList = true; 

  logger.Debug("Формирование отчета, GUID: "+p_GUID);

  while(DataSet.moveNext())
    logger.Debug("Формирование отчета, FileID: "+string(DataSet.FileID));
    var FullFileName = GetTxtDir() + "\\" + DataSet.FileName;
    if(CB_MovePrintFuncObjFiles(DataSet.FileID, FullFileName) == 0)
      logger.Debug("CB_MovePrintFuncObjFiles: "+string(DataSet.FileID));
      var _fileName, fileExt;
      var filePath = IIF(not IsStandAlone(), "$","") + SplitFile(FullFileName, _fileName, fileExt);
      SC_ShowFile(filePath, _fileName+fileExt, true);
    else
      MsgBox("Ошибка копирования файла ", FullFileName);
    end;
    IsEmptyList = true;
  end;

  if(IsEmptyList)
    MsgBox("Не сформировано ни одного файла для печати");
  end;

END; // SumConfirmExpReportRunFuncObj
