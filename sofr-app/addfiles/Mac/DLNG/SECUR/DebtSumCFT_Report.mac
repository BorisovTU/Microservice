/**                                                                                                             
 @file  DebtSumCFT_Report.mac                                                                                           
 @brief Формирование отчета "Отчет по клиентам с задолженностью для ЦФТ"  

 #menu 
  - БО ЦБ\Отчеты\РСХБ\Отчет по клиентам с задолженностью для ЦФТ                                                                                                                                                                                                                          
                                                                                                                
 # tag                                                                                                          
 - functional_block:Отчетность_Внутренняя                                                                             
 - code_type:Report                                                                                                
                                                                                                                
 # changeLog                                                                                                    
 |date       |author         |tasks               |note                                                         
 |-----------|---------------|--------------------|-------------------------------------------------------------
 |2025.03.28 |Жиц М.В.       |BOSS-2183           |Создание макроса отчета                                                                                                                                                 
*/ 
import SFInter, "dldlngfun.mac";

/**
 @brief Класс отчета Реестр договоров по инвестиционному консультированию
 @param[in] Parm класс параметров отчета
*/                    
PRIVATE CLASS (DL_CReportTemplate) DL_DebtSumCFT_Report(RepDate:date)
  var m_RepDate = RepDate;

  /**
   @brief Переопределение функции задания способа печати: всегда в Excel
  */                    
  private macro PrintMode():integer
    return DL_OUTREPORT_EXCEL;
  end;

  /**
   @brief Переопределение функции создания главной страницы
   @param[in] NumCopy номер страницы
  */                    
  private macro BeginReport()
    SetActiveSheet("Лист1");
  end;

  /**
   @brief Печать шапки отчета
  */                    
  private macro PrintReportHead()
    PrintFormatString("", "N1_RepName", "Отчет по клиентам с задолженностью для ЦФТ за " + string(m_RepDate:f));
    PrintFormatString("", "N1_SysDate", string(Date():f) + " " + Time());

    RegisterTable( "N1_MainTable", "", 
                   "N1_ClntName", 
                   "N1_CFT_ID", 
                   "N1_DBONum", 
                   "N1_DebtVal", 
                   "N1_Acc306", 
                   "N1_RestAcc306", 
                   "N1_Acc306Vneb", 
                   "N1_RestAcc306Vneb", 
                   "N1_Acc458", 
                   "N1_RestAcc458", 
                   "N1_Acc458Vneb", 
                   "N1_RestAcc458Vneb", 
                   "N1_Acc47423", 
                   "N1_DebtSum0303", 
                   "N1_DebtSumBrokerFix", 
                   "N1_DebtSumInvest",
                   "N1_AccVUAct",
                   "N1_RestAccVUAct",
                   "N1_AccVUPass",
                   "N1_RestAccVUPass",
                   "N1_AccVUActVneb",
                   "N1_RestAccVUActVneb",
                   "N1_AccVUPassVneb",
                   "N1_RestAccVUPassVneb"
                 );
  end;

  /**
   @brief Печать строки отчета
   @param[in] dataSet структура параметров из запроса в рамках одного ДБО
  */                    
  private macro PrintLine(dataSet) 
    PrintTableLine( "N1_ClntName", dataSet.ClntName, null,
                    "N1_CFT_ID", dataSet.CFT_ID, null,
                    "N1_DBONum", dataSet.DBONum, null,
                    "N1_DebtVal", dataSet.DebtVal, null,  
                    "N1_Acc306", dataSet.Acc306, null,
                    "N1_RestAcc306", dataSet.RestAcc306, null,
                    "N1_Acc306Vneb", dataSet.Acc306Vneb, null,
                    "N1_RestAcc306Vneb", dataSet.RestAcc306Vneb, null, 
                    "N1_Acc458", dataSet.Acc458, null,
                    "N1_RestAcc458", dataSet.RestAcc458, null,
                    "N1_Acc458Vneb", dataSet.Acc458Vneb, null,
                    "N1_RestAcc458Vneb", dataSet.RestAcc458Vneb, null,
                    "N1_Acc47423", dataSet.Acc47423, null,
                    "N1_DebtSum0303", dataSet.DebtSum0303, null,
                    "N1_DebtSumBrokerFix", dataSet.DebtSumBrokerFix, null,
                    "N1_DebtSumInvest", dataSet.DebtSumInvest, null,
                    "N1_AccVUAct", dataSet.AccVUAct, null,
                    "N1_RestAccVUAct", dataSet.RestAccVUAct, null,
                    "N1_AccVUPass", dataSet.AccVUPass, null,
                    "N1_RestAccVUPass", dataSet.RestAccVUPass, null,
                    "N1_AccVUActVneb", dataSet.AccVUActVneb, null,
                    "N1_RestAccVUActVneb", dataSet.RestAccVUActVneb, null,
                    "N1_AccVUPassVneb", dataSet.AccVUPassVneb, null,
                    "N1_RestAccVUPassVneb", dataSet.RestAccVUPassVneb, null
                  );
  end;      

  /**
   @brief Сбор данных и циклическая печать отчета
  */                    
  private macro Create()
    var query, cmd, dataSet;
    var cnt = 0, i = 0;

    query = " WITH dt AS (SELECT ? t_RepDate FROM dual) " +                                                             
            " SELECT ClientID, ClntName, CFT_ID, DBONum, DebtVal, Acc306, Acc306Vneb, Acc47423, Acc458, Acc458Vneb, AccVUAct, AccVUActVneb, AccVUPass, AccVUPassVneb, " + 
            "        (SELECT RSB_ACCOUNT.Restac(Acc306, Currency, t_RepDate, 1, 0) FROM dual) as RestAcc306, " +
            "        (SELECT RSB_ACCOUNT.Restac(Acc306Vneb, Currency, t_RepDate, 1, 0) FROM dual) as RestAcc306Vneb, " +
            "        (SELECT RSB_ACCOUNT.Restac(Acc458, Currency, t_RepDate, 1, 0) FROM dual) as RestAcc458, " +
            "        (SELECT RSB_ACCOUNT.Restac(Acc458Vneb, Currency, t_RepDate, 1, 0) FROM dual) as RestAcc458Vneb, " +
            "        (SELECT RSB_ACCOUNT.Restac(AccVUAct, Currency, t_RepDate, 21, 0) FROM dual) as RestAccVUAct, " +
            "        (SELECT RSB_ACCOUNT.Restac(AccVUActVneb, Currency, t_RepDate, 21, 0) FROM dual) as RestAccVUActVneb, " +
            "        (SELECT RSB_ACCOUNT.Restac(AccVUPass, Currency, t_RepDate, 21, 0) FROM dual) as RestAccVUPass, " +
            "        (SELECT RSB_ACCOUNT.Restac(AccVUPassVneb, Currency, t_RepDate, 21, 0) FROM dual) as RestAccVUPassVneb, " +
            "        DebtSum0303, DebtSumBrokerFix, DebtSumInvest " + 
            "   FROM (SELECT q.ClientID, q.Currency, pt.t_Name AS ClntName, c.t_Code AS CFT_ID, sf_root.t_Number AS DBONum, dt.t_RepDate, fin.t_CCY AS DebtVal, " + 
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'ДС клиента, ц/б' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND mp.t_MarketID = 2 /*ММВБ*/ " +
            "                        AND sf.t_ServKind = 1 " +
            "                        AND sf.t_ServKindSub = 8 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS Acc306, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'ДС клиента, ц/б' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND sf.t_ServKindSub = 9 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS Acc306Vneb, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = '+РасчетыКомисс1' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND mp.t_MarketID = 2 /*ММВБ*/ " +
            "                        AND sf.t_ServKind = 1 " +
            "                        AND sf.t_ServKindSub = 8 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS Acc47423, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'Треб. с н.с. брок' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND mp.t_MarketID = 2 /*ММВБ*/ " +
            "                        AND sf.t_ServKind = 1 " +
            "                        AND sf.t_ServKindSub = 8 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS Acc458, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'Треб. с н.с. брок' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND sf.t_ServKindSub = 9 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS Acc458Vneb, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'ДС Клиента, ВУ' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND mp.t_MarketID = 2 /*ММВБ*/ " +
            "                        AND sf.t_ServKind = 1 " +
            "                        AND sf.t_ServKindSub = 8 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS AccVUAct, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'ДС Клиента, ВУ' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND sf.t_ServKindSub = 9 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS AccVUActVneb, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'ДС, Расч. с клиентом, ВУ' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND mp.t_MarketID = 2 /*ММВБ*/ " +
            "                        AND sf.t_ServKind = 1 " +
            "                        AND sf.t_ServKindSub = 8 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS AccVUPass, " +
            "                NVL((SELECT /*+index(mc DMCACCDOC_DBT_USR5)*/ mc.t_Account " +
            "                       FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp, dsfcontr_dbt sf, daccount_dbt acc " +
            "                      WHERE mc.t_IsCommon = 'X' " +
            "                        AND mc.t_CatID = cat.t_ID " +
            "                        AND cat.t_LevelType = 1 " +
            "                        AND cat.t_Code = 'ДС, Расч. с клиентом, ВУ' " +
            "                        AND acc.t_Account = mc.t_Account " +
            "                        AND acc.t_Chapter = mc.t_Chapter " +
            "                        AND acc.t_Code_Currency = mc.t_Currency " +
            "                        AND acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') " +
            "                        AND mc.t_Owner = q.ClientID " +
            "                        AND mc.t_ClientContrID = mp.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mc.t_Currency = q.Currency " +
            "                        AND sf.t_ID = mp.t_SfContrID " +
            "                        AND sf.t_ServKindSub = 9 " +
            "                        AND ROWNUM = 1), '') " +
            "                  AS AccVUPassVneb, " +
            "                NVL((SELECT SUM(u.t_ReqSum - u.t_Payed_Tr) " +
            "                       FROM u_compay_dbt u " +
            "                      WHERE u.t_CalcID = (SELECT MAX(t_CalcID) FROM u_compay_dbt) " +
            "                        AND u.t_SysDate IS NOT NULL " +
            "                        AND u.t_ClientID = q.ClientID " +
            "                        AND u.t_DlContrID = q.t_DlContrID " +
            "                        AND u.t_FIID = q.Currency), 0) " +
            "                  AS DebtSum0303, " +
            "                NVL((SELECT SUM(sfdef.t_Sum) " +
            "                       FROM dsfcomiss_dbt com, dsfdef_dbt sfdef, ddlcontrmp_dbt mp " +
            "                      WHERE com.t_Code = 'БрокерФикс' " +                                                                           
            "                        AND sfdef.t_FeeType = 1 " +                                                                                
            "                        AND sfdef.t_CommNumber = com.t_Number " +                                                                   
            "                        AND sfdef.t_Status = 10 " + 
            "                        AND sfdef.t_FIID_Sum = q.Currency " +                                                                                                                                                              
            "                        AND mp.t_SfContrID = sfdef.t_SfContrID " +
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND sfdef.t_DatePeriodEnd <= dt.t_RepDate), 0) " +
            "                  AS DebtSumBrokerFix, " +
            "                NVL((SELECT SUM(sfdef.t_Sum) " +
            "                       FROM dsfcomiss_dbt com, dsfdef_dbt sfdef, ddlcontrmp_dbt mp " +
            "                      WHERE com.t_Code = 'ИнвестСоветник' " +                                                                           
            "                        AND sfdef.t_FeeType = 1 " +                                                                                
            "                        AND sfdef.t_CommNumber = com.t_Number " +                                                                   
            "                        AND sfdef.t_Status = 10 " +  
            "                        AND sfdef.t_FIID_Sum = q.Currency " +                                                                              
            "                        AND mp.t_DlContrID = q.t_DlContrID " +
            "                        AND mp.t_SfContrID = sfdef.t_SfContrID " +
            "                        AND sfdef.t_PlanPayDate <= dt.t_RepDate), 0) " +
            "                  AS DebtSumInvest " +                          
            "           FROM (SELECT DISTINCT sf.t_PartyID AS ClientID, mp.t_DlContrID, sfdef.t_FIID_Sum AS Currency " +
            "                   FROM dt, dsfcomiss_dbt com, dsfdef_dbt sfdef, dsfcontr_dbt sf, ddlcontrmp_dbt mp " +
            "                  WHERE com.t_Code = 'БрокерФикс' " +                                                                           
            "                    AND sfdef.t_FeeType = 1 " +                                                                                
            "                    AND sfdef.t_CommNumber = com.t_Number " +                                                                   
            "                    AND sfdef.t_Status = 10 " +                                                                                 
            "                    AND sfdef.t_SfContrID = sf.t_ID " +
            "                    AND mp.t_SfContrID = sf.t_ID " +
            "                    AND sfdef.t_DatePeriodEnd <= dt.t_RepDate " +
            "                  UNION " +     
            "                 SELECT DISTINCT sf.t_PartyID AS ClientID, mp.t_DlContrID, sfdef.t_FIID_Sum AS Currency " +
            "                   FROM dt, dsfcomiss_dbt com, dsfdef_dbt sfdef, dsfcontr_dbt sf, ddlcontrmp_dbt mp " +
            "                  WHERE com.t_Code = 'ИнвестСоветник' " +                                                                           
            "                    AND sfdef.t_FeeType = 1 " +                                                                                
            "                    AND sfdef.t_CommNumber = com.t_Number " +                                                                   
            "                    AND sfdef.t_Status = 10 " +                                                                                 
            "                    AND sfdef.t_SfContrID = sf.t_ID " +
            "                    AND mp.t_SfContrID = sf.t_ID " +
            "                    AND sfdef.t_PlanPayDate <= dt.t_RepDate " +
            "                  UNION " +     
            "                 SELECT DISTINCT u.t_ClientID AS ClientID, u.t_DlContrID, u.t_FIID AS Currency " +
            "                   FROM u_compay_dbt u " +
            "                  WHERE u.t_CalcID = (SELECT MAX(t_CalcID) FROM u_compay_dbt) " +
            "                    AND u.t_SysDate IS NOT NULL " +
            "                    AND (u.t_ReqSum - u.t_Payed_Tr) <> 0 " +
            "                  UNION " +     
            "                 SELECT DISTINCT all458.t_Owner AS ClientID, all458.t_DlContrID, all458.t_Currency AS Currency " +
            "                   FROM (SELECT DISTINCT mc.t_Owner, mp.t_DlContrID, mc.t_Account, mc.t_Chapter, mc.t_Currency " +
            "                           FROM dmcaccdoc_dbt mc, dmccateg_dbt cat, ddlcontrmp_dbt mp " +
            "                          WHERE mc.t_IsCommon = 'X' " +
            "                            AND mc.t_CatID = cat.t_ID " +
            "                            AND cat.t_LevelType = 1 " +
            "                            AND cat.t_Code = 'Треб. с н.с. брок' " +
            "                            AND mp.t_SfContrID = mc.t_ClientContrID " +
            "                        ) all458, dt " +
            "                  WHERE RSB_ACCOUNT.RESTAC(all458.t_Account, all458.t_Currency, dt.t_RepDate, all458.t_Chapter, 0) <> 0 " +
            "                ) q, dt, dparty_dbt pt, dobjcode_dbt c, ddlcontr_dbt dl, dsfcontr_dbt sf_root, dfininstr_dbt fin " +
            "          WHERE pt.t_PartyID = q.ClientID " +
            "            AND c.t_ObjectType = " + OBJTYPE_PARTY +
            "            AND c.t_CodeKind = 101 /*Код ЦФТ*/ " +
            "            AND c.t_State = 0 " +
            "            AND c.t_ObjectID = pt.t_PartyID " +
            "            AND dl.t_DlContrID = q.t_DlContrID " +
            "            AND sf_root.t_ID = dl.t_SfContrID " +
            "            AND fin.t_FIID = q.Currency) " +
            "  ORDER BY ClientID, DBONum, Currency ";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(m_RepDate);

    InitProgress(-1, "Отчет \"Отчет по клиентам с задолженностью для ЦФТ\"", "Отбор данных");    
    cnt = cmd.GetCount();
    RemProgress;
            
    if(cnt > 0)
      InitProgress(cnt, "Отчет \"Отчет по клиентам с задолженностью для ЦФТ\"", "Формирование отчета");
      
      dataSet = cmd.Execute();
      PrintReportHead();

      while(dataSet.MoveNext())
        PrintLine(dataSet);
        i = i + 1;
        UseProgress(i);
      end;

      RemProgress;
      EndTable();
    end;
    
  OnError(e)
    msgbox(cmd.GetErrorString(e));
    RemProgress;
  end;

  macro EndReport()
  end;

  initDL_CReportTemplate(null, "Report_DebtSumCFT.xlsx");  
END;

/**
 @brief Вызов панели и самого формирования отчета "Отчет по клиентам с задолженностью для ЦФТ"
*/                    
MACRO ReportRunEx()
  var report = DL_DebtSumCFT_Report(Date());      
  report.Run();
END;

ReportRunEx();
Exit(1);
