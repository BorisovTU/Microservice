/* Операция займа
   Шаг учета затрат */
import InsCarryDoc, "sp_class.mac", "scservop.mac", "sp_carcm.mac";

macro ExecuteStep( Doc, FDoc )

   record deal(dl_tick);
   var    FD, dat,
          pmwrtsum_2 = TRecHandler( "pmwrtsum.dbt" ); /* лот выбытия*/
  
   SetBuff( deal, FDoc );
   FD = SPFirstDoc ( deal );
   dat = FD.DateArray[DATE_DEALSETAVOIRISS];

   /*только для offline, проверим что периодические комиссии посчитали - оплаченность здесь не проверяем*/
   if( FD.GetModeWriteOff( true ) != "X" ) 
      if (not FD.ПроверитьПериодическиеКомиссии(FD.pmwrtsum.rec,true))
         return SayErrorBuySale( deal,"Обработаны не все периодические комиссии" );
      end;
   end;

  /*Установить на лот возврата статус "Запланирован"*/
   if( not ПолучитьЛотПоСделке( FD.tick.rec, PM_WRITEOFF_SUM_SALE, pmwrtsum_2, true, null, true ) )
      return 1;
   end;                   

//   if( not ОбновитьЛот( pmwrtsum_2, PM_WRTSUM_UPDTMODE_STATE, dat, DL_LEG_PLANE ) )
//      msgbox("Ошибка при изменении статуса лота выбытия");
//      return 1;
//   end;                   

   if( ОбработатьЛот( FD, FD.pmwrtsum, dat, DL_LEG_PAY ) == false )
      return SayErrorBuySale( deal,"Ошибка при обновлении лота" );
   end; 

   return 0;
end;
