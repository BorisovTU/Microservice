/** 
 @file RegNDFL.mac
 @brief Отчет "Регистр НДФЛ"
  
 Отчет "Регистр НДФЛ"

 #menu
 - БО ЦБ\Отчеты\Отчеты для НДФЛ\Регистр НДФЛ

 # tag 
 - functional_block:Налоги_Отчеты
 - code_type:Report
 - BIQ-11355


 # changeLog 
 |date       |author         |tasks            |note                            
 |-----------|---------------|-----------------|--------------------------------
 |2024.08.15 |Фаршатов Г. К. |CCBO-9764        | Реализация отчета             
 |           |               |                 |                   

*/
import "RegNDFL_form.mac";
import "spRepFun.mac", "RepPersonalIncomeTax.mac", dp_util, "nptxcalcfun.mac", "xls_parser.mac";

PRIVATE CONST NPTXTOTALBASE = "DNPTXTOTALBASE_DBT";
PRIVATE CONST NPTXSLICEBASE = "DNPTXSLICEBASE_DBT";
PRIVATE CONST NPTXOBJ       = "DNPTXOBJ_DBT";
PRIVATE CONST NPTXSLICEOBJ  = "DNPTXSLICEOBJ_DBT";
PRIVATE CONST POI_MODE = true;

private var MSGArr = TArray();
private var form = RegNDFL_Panel();

/**
 @brief Класс объекта НДР за месяц
 @param[in] _month Месяц
 @param[in] _sum Сумма
*/
private class c_NRDMonth(_month, _sum)
  var Month = _month;
  var Sum   = _sum;
  var isUse = false;
END;

/**
 @brief Класс объекта кода НДР
 @param[in] _kind Тип кода
 @param[in] _code Код
 @param[in] _codeNum Номер Кода
 @param[in] _arr Массив обьектов c_NRDMonth
*/
private class c_CodeNRDMonth(_kind, _code, _codeNum, _arr)
  var Kind = _kind;
  var Code = _code;
  var CodeNum = _codeNum;
  var ArrSumMount = _arr;

  /**
   @brief Получить объект c_NRDMonth соответствующего месяца
   @param[in] Month Месяц
   @param[in] addNew Добавлять новый объект c_NRDMonth если не найден
   @return Объект c_NRDMonth соответствующего месяца
  */
  macro GetNDRForMonth(Month, addNew)
    var i = 0;
    if(valType(addNew) !=  V_BOOL) addNew = false; end;

    while(i < ArrSumMount.Size)
      if(ArrSumMount[i].Month == Month)
        return ArrSumMount[i];
      end;
        i = i + 1;
    end;
    
    if(addNew)
      ArrSumMount[ArrSumMount.Size] = c_NRDMonth(Month ,$0.0);
      return ArrSumMount[ArrSumMount.Size-1];
    end;
      
    return c_NRDMonth(-1 ,$0.0);
  end;
END;

/**
 @brief Класс объекта НОБ со связью кодов
 @param[in] _plus Плюсовой код c_CodeNRDMonth
 @param[in] _arrMinus Массив минусовых кодов
 @param[in] _sum Сумма
*/
private class c_CodesForMonthNOB(_plus, _arrMinus, _sum)
   var Plus = _plus;
   var ArrMinus = _arrMinus;
   var Sum = _sum;
END;

/**
 @brief Класс объекта НОБ с кодами по месяц
 @param[in] _arrCodes Массив c_CodesForMonthNOB для месяца
 @param[in] _month Месяц
*/
private class c_MonthsNOB(_arrCodes, _month)
  var ArrCodes = _arrCodes;
  var Month = _month;
   
  /**
   @brief Получить объект c_CodesForMonthNOB соответствующего кода
   @param[in] _code Код НДР
   @return Объект c_CodesForMonthNOB соответствующего кода
  */
  macro GetNOBByCode(_code)
    var i = 0;

    while(i < ArrCodes.Size)
      if(ArrCodes[i].Plus.CodeNum == _code)
        return ArrCodes[i];
      end;
      i = i + 1;
    end;
      
    return c_CodesForMonthNOB(c_CodeNRDMonth(-1, "", "", TArray()), TArray(), $0);
  end;
END;

/**
 @brief Класс объекта для протокола сверки
 @param[in] _num Номер регистра
 @param[in] _partyID ИД в СИ
 @param[in] _KPP КПП
 @param[in] _OKTMO ОКТМО
 @param[in] _FIO ФИО
 @param[in] _rate Ставка
 @param[in] _KBK КБК
 @param[in] _baseSum налоговая база
 @param[in] _calculated налог исчисленный
 @param[in] _paid налог удержанный
 @param[in] _due сумма неудержанного налога
 @param[in] _residenceStatus Статус резидента 
*/
private class c_compare_obj(_num, _partyID, _KPP, _OKTMO, _FIO, _rate, _KBK, _baseSum, _calculated, _paid, _due, _residenceStatus, _INN)
  var Num     = _num,
      PartyID = _partyID,
      KPP     = _KPP,
      OKTMO   = _OKTMO,
      FIO     = _FIO,
      Rate    = _rate,
      KBK     = _KBK,
      BaseSum = _baseSum,
      Calculated = _calculated,
      Paid    = _paid,
      Due     = _due,
      INN     = _INN,
      ResidenceStatus = _residenceStatus;
END;

/**
 @brief Фукнция сортировки по сумме 
 @param[in] left Левый элемент 
 @param[in] right Правый элемент
 @param[in] data Данные объекта
 @return Результат сравнения сумм
*/
private macro SortBySum(left:Variant, right:Variant, data:Variant)
  return IIF(left.Sum > right.Sum, -1, (IIF(left.Sum < right.Sum, 1, 0)));
END;

/**
 @brief Фукнция сортировки по месяцу 
 @param[in] left Левый элемент 
 @param[in] right Правый элемент
 @param[in] data Данные объекта
 @return Результат сравнения месяца
*/
private macro SortByMonth(left:Variant, right:Variant, data:Variant)
  return IIF(left.Month < right.Month, -1, (IIF(left.Month < right.Month, 1, 0)));
END;

/**
 @brief Преобразование относительного пути в абсолютный
 @param[in] p_path Путь для преобразования
 @return Абсолютный путь
*/
private macro processPath( p_path )
   var l_str, l_p, l_path = "";

   p_path = trim( p_path );

   if( substr( p_path, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
      p_path = substr( p_path, 3 );

      l_str  = getCWD(false);    
      l_p    = strbrk( l_str, "\\" );
      while( l_p != 0 )
         l_path = l_path + substr( l_str, 1, l_p - 1 ) + "\\";
         l_str  = substr( l_str, l_p + 1 );
         l_p    = strbrk( l_str, "\\" );
      end;
      return ( substr( l_path, 1, strlen( l_path ) - 1 ) + p_path );

   elif( substr( p_path, 1, 1 ) == "." ) /* ссылка на текущий каталог */
      return ( getCWD + substr( p_path, 2 ) );
   end;

  return p_path;
END;

/**
 @brief Получить полный путь к файлу
 @param[in] relativePath путь к файлу
 @param[in] isRemote Флаг терминала
 @return Полный путь к файлу
*/
macro GetFullPath(relativePath:string, isRemote:bool)
   var Path = "";

   if(isRemote)
      if( substr( relativePath, 1, 2 ) == ".." ) /* ссылка на вышестоящий каталог */
         relativePath = substr(relativePath, 3 );
      end;

      if( substr( relativePath, 1, 1 ) == "\\" ) /* ссылка на вышестоящий каталог */
         relativePath = substr(relativePath, 2 );
      end;

      Path = GetCurDir(true) + "\\" + relativePath + "\\"; 
   else
      Path = processPath(relativePath) + "\\";
 
      if( substr( relativePath, 1, 1 ) == "\\" )
         Path = GetCurDir(true) + Path;
      end;
   end;

   return Path;
END;

/**
 @brief Удалить элемент массива по индексу
 @param[in, out] arr Массив 
 @param[in] index Индекс 
*/
private macro DeleteFromArr(Arr:@TArray, index)
  var i = index;
  while(i < Arr.Size - 1)
    Arr[i] = Arr[i + 1];
    i = i + 1;
  end;
  Arr.Size = Arr.Size - 1;
END;

private class CollapseStruct(_Idx, _Code, _Sum, _SubIdx)
  var Idx = _Idx;
  var Code = _Code;
  var SubIdx = _SubIdx;
  var Sum = _Sum;
  var IsMinus = ValType(_SubIdx) != V_UNDEF;
end;

private class MinusMoveStruct(_PlusSum, _PlusCode, _Idx, _MinusCodes)
  var PlusSum = _PlusSum;
  var PlusCode = _PlusCode;
  var Idx = _Idx;
  var MinusCodes = TArray ();
  var i = -1;
  while ((i = i + 1) < _MinusCodes.size)
    if (_MinusCodes[i] and _MinusCodes[i].IsShow)
      MinusCodes[MinusCodes.size] = CollapseStruct(_Idx, _MinusCodes[i].MSCode, _MinusCodes[i].MSnnn, i);
    end;
  end;

  macro SortMinus()
    MinusCodes.sort(@SortBySum);
  end;

  macro GetMinus()
    var MSnnn = $0;
    var j = -1;
    while((j=j+1) < MinusCodes.Size)
      MSnnn = MSnnn + MinusCodes[j].Sum;
    end;
    return MSnnn;
  end;

  macro GetOD()
    return PlusSum - GetMinus();
  end;

  SortMinus();
end;

private macro CheckForPosCollapseStruct(struct)
  return (struct != NULL) and (struct.Sum > $0);
end;

private macro MakeSortedPLusByCodeAndSum(NPTXCodeParmArr, Code)
  var i = -1;
  var retArr = TArray();
  while ((i=i+1) < NPTXCodeParmArr.Size)
    if ((NPTXCodeParmArr[i].PSCode != NULL) and (NPTXCodeParmArr[i].PSCode == Code))
      retArr[retArr.size] = CollapseStruct(i, Code, NPTXCodeParmArr[i].PSnnn);
    end;
  end;
  retArr.Sort(@SortBySum);
  return filter(retArr, @CheckForPosCollapseStruct);
end;

private macro MakeSortedMinusByCodeAndSum(NPTXCodeParmArr, Code)
  var i = -1, j = -1;
  var retArr = TArray();
  while ((i=i+1) < NPTXCodeParmArr.Size)
    j = -1;
    while ((j=j+1) < NPTXCodeParmArr[i].MinusCodes.Size)
      if ((NPTXCodeParmArr[i].MinusCodes[j] != NULL) and (NPTXCodeParmArr[i].MinusCodes[j].MSCode != NULL) and (NPTXCodeParmArr[i].MinusCodes[j].MSCode == Code))
        retArr[retArr.size] = CollapseStruct(i, Code, NPTXCodeParmArr[i].MinusCodes[j].MSnnn, j);
      end;
    end;
  end;
  retArr.Sort(@SortBySum);
  return filter(retArr, @CheckForPosCollapseStruct);
end;

private macro MakeSortedCodesByNobkind(NPTXCodeParmArr, NOBKind)
  var i = -1;
  var retArr = TArray();
  i = NPTXCodeParmArr.Size;
  while ((i=i-1) >= 0)
    if ((NPTXCodeParmArr[i].NOBKind != NULL) and (NPTXCodeParmArr[i].NOBKind == NOBKind))
      retArr[retArr.size] = CollapseStruct(i, NPTXCodeParmArr[i].PSCode, 0);
    end;
  end;
  return retArr;
end;

private macro MakeCopyNPTXCodeParmArr(NPTXCodeParmArr)
  var copyArr = TArray();
  //делаем полную копию NPTXCodeParmArr по значениям
  var i = -1;
  var j = -1;
  while ((i=i+1) < NPTXCodeParmArr.Size)
    copyArr[i] = NPTXPlusCodeParm(
       NPTXCodeParmArr[i].Month,
       NPTXCodeParmArr[i].PSCode,
       NPTXCodeParmArr[i].PSnnn,
       NPTXCodeParmArr[i].ЧНБ,
       NPTXCodeParmArr[i].NOBKind,
       NULL,
       NPTXCodeParmArr[i].IsShow);
    if (NPTXCodeParmArr[i].MinusCodes != NULL)
      j = -1;
      while ((j=j+1) < NPTXCodeParmArr[i].MinusCodes.size)
        copyArr[i].MinusCodes[j] = 
        NPTXMinusCodeParm(
           NPTXCodeParmArr[i].MinusCodes[j].MSCode,
           NPTXCodeParmArr[i].MinusCodes[j].MSnnn,
           NPTXCodeParmArr[i].MinusCodes[j].IsShow);
      end;
    end;
  end;
  return copyArr;
end;

CLASS NPTXPayerInfo(_ClientID:integer, _ClientINN:string, _LastName:string, _FirstName:string, _MiddleName:string, _ResidenceStatus:string, _DateBirth:Date,
                    _ResidenceCountry:string, _DocumentType:string, _DocumentNumber:string, _ArrCodeParm:TArray)
  var ClientID         = _ClientID;
  var ClientINN        = _ClientINN;
  var LastName         = _LastName;
  var FirstName        = _FirstName;
  var MiddleName       = _MiddleName;
  var ResidenceStatus  = _ResidenceStatus;
  var DateBirth        = _DateBirth;
  var ResidenceCountry  = _ResidenceCountry;
  var DocumentType     = _DocumentType;
  var DocumentNumber   = _DocumentNumber;
  var ArrCodeParm      = TArray();
  var Income15         = TArray();
  var RateIndex = -1;

  private var i = 0;
  private var j = 0;
  private var j1 = 0;
  private var k = 0;
  while(i < _ArrCodeParm.Size)
    j = 0;
    j1 = 0;
    RateIndex = -1;
    while(j < _ArrCodeParm[i].NPTXCodeParmArr.Size)
      RateIndex = AddInArrCodeParms(ArrCodeParm, _ArrCodeParm[i].NPTXCodeParmArr[j].Month, _ArrCodeParm[i].NPTXCodeParmArr[j].PScode,
                                    _ArrCodeParm[i].NPTXCodeParmArr[j].PSnnn, NULL/*_ArrCodeParm[i].NPTXCodeParmArr[j].MSCode*/,
                                    _ArrCodeParm[i].NPTXCodeParmArr[j].GetMinusSum(), 0.0, 0.0, 0.0, 0.0, 0.0, _ArrCodeParm[i].Rate,
                                    _ArrCodeParm[i].NPTXCodeParmArr[j].ЧНБ, 0.0, 0.0, 0.0, _ArrCodeParm[i].IsHighRate, 0.0, _ArrCodeParm[i].DepoMinus, _ArrCodeParm[i].NPTXCodeParmArr[j].IsShow, NULL, 
                                    ((_ArrCodeParm[i].NPTXCodeParmArr[j].PScode == NULL) AND (_ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes.Size > 0)),_ArrCodeParm[i].RateType, _ArrCodeParm[i].NPTXCodeParmArr[j].NOBKind);

      if(RateIndex >= 0)
        k = 0;
        while(k < _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes.Size)
          ArrCodeParm[RateIndex].NPTXCodeParmArr[j1].MinusCodes[ArrCodeParm[RateIndex].NPTXCodeParmArr[j1].MinusCodes.Size] = NPTXMinusCodeParm(
              _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].MSCode, _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].MSnnn, _ArrCodeParm[i].NPTXCodeParmArr[j].MinusCodes[k].IsShow);
          k = k + 1;
        end;
            
        j1 = j1 + 1;
      end;
      j = j + 1;
    end;

    if(j == 0)
      ArrCodeParm[ArrCodeParm.Size] = NPTXRateParm(0, NULL, _ArrCodeParm[i].PlusSum, NULL, _ArrCodeParm[i].MinusSum, _ArrCodeParm[i].TaxBaseSum, _ArrCodeParm[i].TaxCalculated,
                                                   _ArrCodeParm[i].TaxPaid, _ArrCodeParm[i].TaxToReturnDue, _ArrCodeParm[i].TaxDue, _ArrCodeParm[i].Rate, 0.0,
                                                   _ArrCodeParm[i].DivPlus, _ArrCodeParm[i].TaxCalculatedDiv, _ArrCodeParm[i].TaxOver,
                                                   _ArrCodeParm[i].IsHighRate, _ArrCodeParm[i].Znp, _ArrCodeParm[i].DepoMinus);
    else
      if(RateIndex >= 0)
        ArrCodeParm[RateIndex].TaxBaseSum = _ArrCodeParm[i].TaxBaseSum;
        ArrCodeParm[RateIndex].TaxCalculated = _ArrCodeParm[i].TaxCalculated;
        ArrCodeParm[RateIndex].TaxPaid = _ArrCodeParm[i].TaxPaid;
        ArrCodeParm[RateIndex].TaxToReturnDue = _ArrCodeParm[i].TaxToReturnDue;
        ArrCodeParm[RateIndex].TaxDue = _ArrCodeParm[i].TaxDue;
        ArrCodeParm[RateIndex].DivPlus = _ArrCodeParm[i].DivPlus;
        ArrCodeParm[RateIndex].TaxCalculatedDiv = _ArrCodeParm[i].TaxCalculatedDiv;
        ArrCodeParm[RateIndex].TaxOver = _ArrCodeParm[i].TaxOver;
        ArrCodeParm[RateIndex].Znp = _ArrCodeParm[i].Znp;
        ArrCodeParm[RateIndex].DepoMinus = _ArrCodeParm[i].DepoMinus;
        ArrCodeParm[RateIndex].MinusSum = _ArrCodeParm[i].MinusSum;
        ArrCodeParm[RateIndex].PlusSum = _ArrCodeParm[i].PlusSum;

        if (_ArrCodeParm[RateIndex].Income15.size > 0)
          ArrCodeParm[RateIndex].Income15 = _ArrCodeParm[i].Income15;
        end;
      end;
    end;
    i = i + 1;
  end;
END;

private class PrmCode(_kind, _code, _codeNum)
  var Kind    = _kind;
  var Code    = _code;
  var CodeNum = _codeNum;
end; 

CLASS (NPTXRepCalc_NPTXPIT6) NPTXRepCalc_NPTXPIT6_NEW_2_REG(_Investor ,_BeginDate, _EndDate, _isSlice, _SliceID, _ClientTable)
  m_PersnIdcMain = TBFile("persnidc.dbt");
  m_ArrCodeParms = TArray();
  private var m_cmd;
  private var isSlice = _isSlice;
  private var TABLE_TOTALBASE = NPTXTOTALBASE;
  private var TABLE_NPTXOBJ = NPTXOBJ;
  private var m_SliceID = _SliceID ;
  var m_PayerInfo = NULL;
  var ArrPrmCode = TArray();
  m_count = 0;

  if(isSlice)
    TABLE_TOTALBASE = NPTXSLICEBASE;
    TABLE_NPTXOBJ = NPTXSLICEOBJ;
  end;

  MACRO ClearData()
    m_Pg = NULL;
    m_Pm = NULL;
    m_Ps = NULL;
    m_Pp = NULL;
    m_PersnIdcMain.Clear();
    m_TaxCalculated = $0.0;
    m_PlusSum = $0.0;
    m_MinusSum = $0.0;
    m_ResidenceStatus = -1;

    var i = 0;
    while(i < m_ArrCodeParms.Size)
      m_ArrCodeParms[i].NPTXCodeParmArr.Size = 0;
      i = i + 1;
    end;
    m_ArrCodeParms.Size = 0;

    m_MinusG_618 = null;
    m_MinusG_619 = null;
  END;

  private macro GetSum(ClientID:Integer,
                       StrKind:String,
                       MinDate:Date,
                       MaxDate:Date,
                       SumVal:@Variant,
                       IIS:Integer,
                       AddWhereCond:String,
                       ContrNumbers:@String,
                       NPTXCodeParmArr:@TArray,
                       FromOuter:bool,
                       nobkind)
    var IsMinus = false, IsPlus = false, IsExistsPlus = false, IsShow = true;

    FromOuter = IIF((ValType(FromOuter) != V_BOOL), false, FromOuter);
    SumVal = 0.0;

    if(isSlice == false)
      AddWhereCond = AddWhereCond +
        IIF(AddWhereCond != "", " AND ( ", " ( ");

      AddWhereCond = AddWhereCond +
            " NOT EXISTS (SELECT "
                          + " 1 "
                      + " FROM "
                          + " dnptxobdc_dbt dc "
                         + " ,doproper_dbt opr "
                      + " WHERE "
                          + " dc.t_ObjID = obj.t_ObjID "
                      + " AND opr.t_ID_Operation = dc.t_DocID "
                      + " AND opr.t_DocKind = " + SP_DEPOPER_DEPOACNT + ") "
          + " AND NOT EXISTS (SELECT "
                          + " 1 "
                      + " FROM "
                          + " ddppmobj_dbt dp "
                      + " WHERE "
                          + " dp.t_ObjID = obj.t_ObjID "
                      + " AND dp.t_ObjKind = " + OBJTYPE_NPTXOBJ + ") "
          + " AND NOT EXISTS (SELECT "
                          + " 1 "
                      + " FROM "
                          + " dnptxobdc_dbt dc "
                         + " ,doproper_dbt opr "
                      + " WHERE "
                          + " dc.t_ObjID = obj.t_ObjID "
                      + " AND opr.t_ID_Operation = dc.t_DocID "
                      + " AND opr.t_DocKind IN (" + DL_VEKSELDRAWORDER + ", " + DL_VSBARTERORDER + ", " + DL_VSINTERCHANGE + ")) ";

      AddWhereCond = AddWhereCond + " OR ";

      AddWhereCond = AddWhereCond +
            " EXISTS (SELECT "
                      + " 1 "
                  + " FROM "
                      + " dnptxobdc_dbt dc "
                     + " ,doproper_dbt opr "
                  + " WHERE "
                      + " dc.t_ObjID = obj.t_ObjID "
                  + " AND opr.t_ID_Operation = dc.t_DocID "
                  + " AND opr.t_DocKind IN (" + DL_VEKSELDRAWORDER + ", " + DL_VSBARTERORDER + ", " + DL_VSINTERCHANGE + ")) ";

      AddWhereCond = AddWhereCond +                  " ) ";
    end;

    var ObjQuery =  " select nvl(sum(q.t_S), 0) t_S, "
                      "        chr(0) as t_ContrNum, " +
                      "        q.t_Kind, " +
                      "        extract(month from q.t_Date) as t_Month " +
                      " from ( ";
    if((IIS == NULL) or (IIS == 0))
      ObjQuery = ObjQuery + "   select obj.t_Sum as t_S, " +
                            "             obj.t_Kind, " +
                            "             obj.t_Date " +
                            "   from " + TABLE_NPTXOBJ + " obj " +
                            "   where obj.t_Kind in(" + StrKind + ") " +
                            IIF(MinDate != date(0, 0, 0), "  and obj.t_Date >= " + GetSQLDate(MinDate), "") +
                            "     and obj.t_Date <= " + GetSQLDate(MaxDate) +
                            IIF(ClientID > 0, "  and obj.t_Client = " + string(ClientID), "") +
                            IIF(AddWhereCond != "", "  and " + AddWhereCond, "") +
                            "     and obj.t_FromOutSyst " + IIF(FromOuter,"=","<>") +" chr(88) " +
                            "     and RSI_NPTO.CheckObjIIS(obj.t_AnaliticKind6, t_Analitic6) <> 1 " +
                            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
                            "     and ( " +
                            "                ROUND(obj.t_Sum0,2) >= 0.01 " +
                            "                or ROUND(obj.t_Sum0,2) <= -0.01 " +
                            "         ) ";
    end;
    
    if((IIS == NULL) or (IIS == 1))
      if(IIS == NULL)
        ObjQuery = ObjQuery + " UNION ALL ";
      end;

      var ObjDate = Date(0, 0, 0);

      var CloseContrQuery = " select ( " +
                            "           case " +
                            "              when q.t_FirstIISDate is not NULL" +
                            "              then q.t_FirstIISDate " +
                            "              else q.t_DateBegin " +
                            "           end " +
                            "        ) as t_FirstIISDate, " +
                            "        q.t_DateClose " +
                            " from (" +
                               //Определение даты первого договора ИИС для ДО
                            "         select RSI_NPTO.GetDateFromNoteText(" + string(OBJTYPE_SFCONTR) + ", sfcontr.t_ID, 3) as t_FirstIISDate, " +
                            "                sfcontr.t_DateBegin, " +
                            "                nptxop.t_OperDate as t_DateClose " +
                            "         from dnptxop_dbt nptxop, " +
                            "              dnptxobdc_dbt obdc, " +
                            "              " + TABLE_NPTXOBJ + " obj, " +
                            "              dsfcontr_dbt sfcontr " +
                            "         where " + IIF(MinDate != Date(0, 0, 0), " nptxop.t_OperDate >= " + GetSQLDate(MinDate) + " and ", "") +
                            "               nptxop.t_OperDate <= " + GetSQLDate(MaxDate) +
                            "           and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                            "           and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                            "           and nptxop.t_Client = " + string(ClientID) +
                            "           and nptxop.t_Status > 0 " +
                            "           and obdc.t_DocID = nptxop.t_ID " +
                            "           and obj.t_ObjID = obdc.t_ObjID " +
                            "           and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
                            "           and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                            "           and sfcontr.t_ID = obj.t_Analitic6 " +
                            IIF(MinDate != NULL, " and sfcontr.t_DateClose >= " + GetSQLDate(MinDate), "") +
                            "           and sfcontr.t_DateClose <= " + GetSQLDate(MaxDate) +
                            "           and not exists( " +
                            "                            select 1 " +
                            "                            from ddlcontrmp_dbt dlcontrmp " +
                            "                            where dlcontrmp.t_SfContrID = sfcontr.t_ID " +
                            "                         ) " +
                            //Определение даты первого договора ИИС для ДБО
                            "         union " +
                            "         select ( " +
                            "                   case " +
                            "                      when dlcontr.t_IISTransfer = chr(88) " +
                            "                      then dlcontr.t_IISLastOpenDate " +
                            "                      else sfcontr.t_DateBegin " +
                            "                   end " +
                            "                ) as t_FirstIISDate, " +
                            "                to_date('01.01.0001', 'dd.mm.yyyy') as t_DateBegin," +
                            "                nptxop.t_OperDate as t_DateClose " +
                            "         from ddlcontr_dbt dlcontr, " +
                            "              dsfcontr_dbt subcontr, " +
                            "              ddlcontrmp_dbt dlcontrmp, " +
                            "              dsfcontr_dbt sfcontr, " +
                            "              dnptxop_dbt nptxop, " +
                            "              dnptxobdc_dbt obdc, " +
                            "              " + TABLE_NPTXOBJ + " obj " +
                            "         where " + IIF(MinDate != Date(0, 0, 0), " nptxop.t_OperDate >= " + GetSQLDate(MinDate) + " and ", "") +
                            "               nptxop.t_OperDate <= " + GetSQLDate(MaxDate) +
                            "           and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                            "           and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                            "           and nptxop.t_Client = " + string(ClientID) +
                            "           and obdc.t_DocID = nptxop.t_ID " +
                            "           and obj.t_ObjID = obdc.t_ObjID " +
                            "           and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
                            "           and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                            "           and subcontr.t_ID = obj.t_Analitic6 " +
                            "           and " + IIF(MinDate != Date(0, 0, 0), " subcontr.t_DateClose >= " + GetSQLDate(MinDate) + " and ", "") +
                            "                  subcontr.t_DateClose <= " + GetSQLDate(MaxDate) +
                            "           and dlcontrmp.t_SfContrID = subcontr.t_ID " +
                            "           and dlcontr.t_DlContrID = dlcontrmp.t_DlContrID " +
                            "           and sfcontr.t_ID = dlcontr.t_SfContrID " +
                            "      ) q " +
                            " where ROWNUM = 1 " +
                            " order by q.t_FirstIISDate ";

      var CloseContrSleect = DL_RSDCommand(CloseContrQuery);
      var CloseContrDS = CloseContrSleect.Execute();
      if(CloseContrDS.MoveNext)
        MinDate = Date(CloseContrDS.FirstIISDate);
        ObjDate = CloseContrDS.DateClose;
      end;

      ObjQuery = ObjQuery + " select obj.t_Sum as t_S, " +
                            "        obj.t_Kind, " +
                            IIF(ObjDate != Date(0, 0, 0), GetSQLDate(ObjDate), " obj.t_Date") + " as t_Date " +
                            " from " + TABLE_NPTXOBJ + " obj " +
                            " where obj.t_Kind in (" + StrKind + ") " +
                            IIF(ClientID > 0, " and obj.t_Client = " + string(ClientID), "") +
                            IIF(MinDate != Date(0, 0, 0), " and obj.t_Date >= " + GetSQLDate(MinDate), "") +
                            "   and obj.t_Date <= " + GetSQLDate(MaxDate) +
                            IIF(AddWhereCond != "", " and " + AddWhereCond, "") +
                            "   and obj.t_FromOutSyst " + IIF(FromOuter, "=", "<>") + " chr(88) " +
                            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
                            "   and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                            "   and exists ( " +
                            "                 select 1 " +
                            "                 from dnptxop_dbt nptxop " +
                            "                 where nptxop.t_Client = " + string(ClientID) +
                            "                   and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                            "                   and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                            "                   and nptxop.t_OperDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) +
                            "                   and nptxop.t_Status > 0 " +
                            "              ) " +
                            "   and ( " +
                            "          ROUND(obj.t_Sum0,2) >= 0.01 " +
                            "          or ROUND(obj.t_Sum0,2) <= -0.01 " +
                            "       ) ";
    end;

    ObjQuery = ObjQuery + " ) q " +
               " group by extract(month from q.t_Date), q.t_Kind";

    var ObjCmd = DL_RSDCommand(ObjQuery);
    var groupInd = -1;

    var ObjDS = ObjCmd.Execute();
    while(ObjDS.MoveNext())
      var MSCode;
      var MSnnn = 0;
      var PSCode;
      var PSnnn = 0;
      IsMinus = IsPlus = false;
      IsShow = true;
      SumVal = SumVal + ExtRound(ObjDS.S);

      if(ObjDS.Kind == TXOBJ_MINUS9_218)
        MScode = "218";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUS9_219)
        MScode = "219";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUS9_234)
        MScode = "234";
        Msnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUS15_601)
        MScode = "601";
        MSnnn = ExtRound(ObJDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_201)
        Mscode = "201";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_202)
        Mscode = "202";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_203)
        Mscode = "203";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_206)
        Mscode = "206";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_207)
        Mscode = "207";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_205)
        Mscode = "205";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_208)
        Mscode = "208";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_209)
        Mscode = "209";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_210)
        Mscode = "210";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_201)
        Mscode = "201";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_211)
        Mscode = "211";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_222)
        Mscode = "222";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_213)
        Mscode = "213";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif((ObjDS.Kind == TXOBJ_MINUSG_214) or (ObjDS.Kind == TXOBJ_MINUSG_214_IIS))
        Mscode = "214";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_220)
        Mscode = "220";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_223)
        Mscode = "223";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_224)
        Mscode = "224";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif((ObjDS.Kind == TXOBJ_MINUSG_218))
        Mscode = "218";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif((ObjDS.Kind == TXOBJ_MINUSG_219))
        Mscode = "219";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_618)
        Mscode = "618";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
        IsShow = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_601)
        Mscode = "601";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_225)
        Mscode = "225";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_226)
        Mscode = "226";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_227)
        Mscode = "227";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_228)
        Mscode = "228";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_229)
        Mscode = "229";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_230)
        Mscode = "230";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_231)
        Mscode = "231";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_235)
        Mscode = "235";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_239)
        Mscode = "239";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_240)
        Mscode = "240";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_236)
        Mscode = "236";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
      elif(ObjDS.Kind == TXOBJ_MINUSG_619)
        Mscode = "619";
        MSnnn = ExtRound(ObjDS.S);
        IsMinus = true;
        IsShow = true;
      end;

      //если значение кода слишком мало, не работаем с кодом
      if (IsMinus and (MSnnn == 0))
        IsMinus = false;
      end;

      var i;
      var j;

      //если имеем дело с минусом, то ищем идентификатор групп, 
      //проверяя значения каждой группы, пока не найдём нужную
      if (IsMinus)
        i = -1;
        while ((i = i + 1) < GetCodeGroupsValue().size)
         if (find(GetCodeGroupsValue()[i],MSCode) != -1)
          groupInd = i;
          break;
         end;
        end;
      end;
      
      //ищем в определении по минусам
      
      if((NPTXCodeParmArr != NULL) and IsMinus)
        i = 0;
        j = 0;
        while(i < NPTXCodeParmArr.Size())
          if(NPTXCodeParmArr[i].Month == ObjDS.Month)
            /*NPTXCodeParmArr[i].MScode = NPTXCode.MScode;
            NPTXCodeParmArr[i].MSnnn = NPTXCode.MSnnn;*/
            j = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
            if(j >= 0)
              NPTXCodeParmArr[i].MinusCodes[j].MSnnn = NPTXCodeParmArr[i].MinusCodes[j].MSnnn + MSnnn;
              IsExistsPlus = true;
              break;
            else
              //если код дохода ещё не задан, и вычетов ещё нет
              //если код дохода задан и равен той группе, которую нашли среди кодов вычетов ранее
              //если код дохода не задан и вычеты есть, но принадлежат нужной группе (достаточно проверить первый, т.к. все прочие будут добавляться также)
              //в любых других случаях пропускаем, что смещает данный код в другой элемент массива
              if(((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size == 0)) or
                ((NPTXCodeParmArr[i].PScode != NULL) and (groupInd != -1) and (NPTXCodeParmArr[i].PScode == GetCodeGroups()[groupInd].Key)) or
                ((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size > 0) and (groupInd != -1) and (find(GetCodeGroups()[groupInd].Value,NPTXCodeParmArr[i].MinusCodes[0].MSCode) >= 0))) 
                NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, MSnnn, IsShow);
                IsExistsPlus = true;

                //Делаем сортировку, если кодов вычетов, больше чем один (т.е. больше чем тот что только что добавили)
                if (NPTXCodeParmArr[i].MinusCodes.Size > 1)
                  //в сортировку передаём массив групп в их очередерности и по ним узнаем порядок того или иного элемента
                  NPTXCodeParmArr[i].MinusCodes.Sort(@SortMinusCodeByGrp, GetCodeGroups()[groupInd].Value);
                end;
                
                break;
              end;
            end;
          end;
          i = i + 1;
        end;
        
        //Если дохода с соответствующим кодом не было в соответствующем месяце, но был в другом
        if(not IsExistsPlus)
          i = 0;
          j = 0;
          while(i < NPTXCodeParmArr.Size())
            /*NPTXCodeParmArr[i].MScode = NPTXCode.MScode;
            NPTXCodeParmArr[i].MSnnn = NPTXCode.MSnnn;*/
            j = NPTXCodeParmArr[i].IndexOfMinusCode(MSCode);
            if(j >= 0)
              NPTXCodeParmArr[i].MinusCodes[j].MSnnn = NPTXCodeParmArr[i].MinusCodes[j].MSnnn + MSnnn;
              IsExistsPlus = true;
              break;
            else
              //если код дохода ещё не задан, и вычетов ещё нет
              //если код дохода задан и равен той группе, которую нашли среди кодов вычетов ранее
              //если код дохода не задан и вычеты есть, но принадлежат нужной группе (достаточно проверить первый, т.к. все прочие будут добавляться также)
              //в любых других случаях пропускаем, что смещает данный код в другой элемент массива
              if(((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size == 0)) or
                ((NPTXCodeParmArr[i].PScode != NULL) and (groupInd != -1) and (NPTXCodeParmArr[i].PScode == GetCodeGroups()[groupInd].Key)) or
                ((NPTXCodeParmArr[i].PScode == NULL) and (NPTXCodeParmArr[i].MinusCodes.Size > 0) and (groupInd != -1) and (find(GetCodeGroups()[groupInd].Value,NPTXCodeParmArr[i].MinusCodes[0].MSCode) >= 0))) 
                NPTXCodeParmArr[i].MinusCodes[NPTXCodeParmArr[i].MinusCodes.Size] = NPTXMinusCodeParm(MSCode, MSnnn, IsShow);
                IsExistsPlus = true;

                //Делаем сортировку, если кодов вычетов, больше чем один (т.е. больше чем тот что только что добавили)
                if (NPTXCodeParmArr[i].MinusCodes.Size > 1)
                  //в сортировку передаём массив групп в их очередерности и по ним узнаем порядок того или иного элемента
                  NPTXCodeParmArr[i].MinusCodes.Sort(@SortMinusCodeByGrp, GetCodeGroups()[groupInd].Value);
                end;
              
                break;
              end;
            end;

            i = i + 1;
          end;
        end;
      end;

      if((ObjDS.Kind == TXOBJ_PLUS9_1110) or (ObjDS.Kind == TXOBJ_PLUS9_1110_IIS))
        PScode = "1110";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif((ObjDS.Kind == TXOBJ_PLUS15_1010) or (ObjDS.Kind == TXOBJ_PLUSG_1010))
        PScode = "1010";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUS35_3023)
        PScode = "3023";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif((ObjDS.Kind == TXOBJ_PLUSG_1011) or (ObjDS.Kind == TXOBJ_PLUSG_1011_IIS))
        PScode = "1011";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1530)
        PScode = "1530";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1531)
        PScode = "1531";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1536)
        PScode = "1536";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1532)
        PScode = "1532";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1533)
        PScode = "1533";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1535)
        PScode = "1535";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1537)
        PScode = "1537";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1539)
        PScode = "1539";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1110)
        PScode = "1110";
        PSnnn = ExtRound(ObjDS.S);;
        IsPlus = true;
      elif((ObjDS.Kind == TXOBJ_PLUSG_2640) or (ObjDS.Kind == TXOBJ_PLUSG_2640_IIS))
        PScode = "2640";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif((ObjDS.Kind == TXOBJ_PLUSG_2641) or (ObjDS.Kind == TXOBJ_PLUSG_2641_IIS))
        PScode = "2641";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_2800)
        PScode = "2800";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1544)
        PScode = "1544";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1545)
        PScode = "1545";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1549)
        PScode = "1549";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1546)
        PScode = "1546";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1547)
        PScode = "1547";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1548)
        PScode = "1548";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1551)
        PScode = "1551";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_PLUSG_1553)
        PScode = "1553";
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      elif(ObjDS.Kind == TXOBJ_BASEG1_13)
        PSCode = NULL;
        PSnnn = ExtRound(ObjDS.S);
        IsPlus = true;
      end;

      //если значение кода слишком мало, не работаем с кодом
      if (IsPlus and (PSnnn == 0))
        IsPlus = false;
      end;

      //если имеем дело с минусом, то ищем идентификатор групп, 
      //проверяя значения каждой группы, пока не найдём нужную
      if (IsPlus)
        groupInd = DL_FindKeyPairInArr(GetCodeGroups(),PSCode);
      end;

      if((NPTXCodeParmArr != NULL) and IsPlus)
        i = 0;
        while(i < NPTXCodeParmArr.Size())
          //проставляем код дохода в существующий элемент массива только
          //если совпал месяц среди существующих, и код дохода пуст
          //а также если вычетов нет, либо группа не была найдена, или если среди существующих вычетов вычеты нужной группы
          if((NPTXCodeParmArr[i].Month == ObjDS.Month) and (NPTXCodeParmArr[i].PScode == NULL))
            if ((NPTXCodeParmArr[i].MinusCodes.Size == 0) or (groupInd == -1) or (find(GetCodeGroups()[groupInd].Value,NPTXCodeParmArr[i].MinusCodes[0].MSCode) >= 0))
              NPTXCodeParmArr[i].PScode = PScode;
              NPTXCodeParmArr[i].PSnnn = PSnnn;
              IsExistsPlus = true;
              break;
            end;
          end;
          i = i + 1;
        end;
      end;

      if((NPTXCodeParmArr != NULL) and (not IsExistsPlus) and (IsPlus or IsMinus))
        //NPTXCode.Month = ObjDS.Month;
        NPTXCodeParmArr[NPTXCodeParmArr.Size] = NPTXPlusCodeParm(ObjDS.Month, PSCode, PSnnn, 0, nobkind, NULL, IsShow);
        if(IsMinus)
          NPTXCodeParmArr[NPTXCodeParmArr.Size - 1].MinusCodes[0] = NPTXMinusCodeParm(MSCode, MSnnn, IsShow);
        end;
      elif(IsExistsPlus)
        IsExistsPlus = false;
      end;

      if((ContrNumbers != NULL) and (Index(ContrNumbers, ObjDS.ContrNum) == 0) and (ObjDS.ContrNum != ""))
        ContrNumbers = ContrNumbers + IIF(ContrNumbers != "", ", ", "") + ObjDS.ContrNum;
      end;
    end;
  end;
  
  PRIVATE MACRO getPrmCode(Kind:@Integer, Code:@String, CodeNum)

    private macro loadPrmCodes()
      var query = " SELECT t_Element, t_Code, REGEXP_SUBSTR (t_Code, '[[:digit:]]+') AS CodeNum " +
                  "   FROM dnptxkind_dbt " +
                  "  WHERE (t_Code LIKE 'MinusG%') OR (t_Level IN (5) AND t_Code LIKE 'PlusG%') ";

      var cmd = DL_RSDCommand(query);

      var DataSet = cmd.Execute();
      while(DataSet.MoveNext())
        ArrPrmCode[ArrPrmCode.size] = PrmCode(DataSet.Element, DataSet.Code, DataSet.CodeNum);
      end;
    end;

    private macro getPrmCodeByCodeNum(_CodeNum)
      var i = 0;
      while(i < ArrPrmCode.Size)
        if(ArrPrmCode[i].CodeNum == _CodeNum)
          return ArrPrmCode[i];
        end;
        i = i + 1;
      end;
    end;

    if(ArrPrmCode.size == 0)
      loadPrmCodes();
    end;

    var objPrmCode = getPrmCodeByCodeNum(CodeNum);
    
    Kind = objPrmCode.Kind;
    Code = objPrmCode.Code;
  END;

  MACRO Init(Investor, BeginDate, EndDate, IsConsiderCB, IsConsiderDepo, IsConsiderVS, ClientTable)
    m_RepDate = m_EndDate = EndDate;
    m_Investor = Investor;
    m_CurrSign = 0;
  
    if(IsConsiderCB != null)
      m_IsConsiderCB = IsConsiderCB;
    end;
  
    if(IsConsiderDEPO != null)
      m_IsConsiderDEPO = IsConsiderDEPO;
    end;
  
    if(IsConsiderVS != null)
      m_IsConsiderVS = IsConsiderVS;
    end;

    DateSplit(m_RepDate, null, null, m_CurrYear);
  
    m_BeginDate = BeginDate;

    m_query = " SELECT /* parallel(4) enable_parallel_dml */ "
            + " pt.t_PartyID "
            + " ,pt.t_NotResident "
            + " ,persn.t_Name1 AS Name1 "
            + " ,persn.t_Name2 AS Name2 "
            + " ,persn.t_Name3 AS Name3 "
            + " ,persn.t_Born AS BirthDate "
            + " ,persn.t_BirsPlase "
            + " ,NVL((CASE "
                  + " WHEN pt.t_NRCountry <> CHR(1) "
                  + " THEN "
                     + " (SELECT "
                        + " cn.t_CodeNum3 "
                      + " FROM "
                        + " dcountry_dbt cn "
                      + " WHERE "
                        + " cn.t_CodeLat3 = pt.t_NRCountry) "
                  + " ELSE "
                     + " CHR(1) "
                + " END), CHR(1)) AS t_Citizenship "
            + " ,NVL((CASE "
                  + " WHEN pt.t_NotResident = 'X' "
                    + " OR (pt.t_NRCountry <> CHR(1) "
                   +  " AND pt.t_NRCountry <> 'RUS') "
                  + " THEN "
                     + " (SELECT "
                        + " cn.t_CodeNum3 "
                      + " FROM "
                        + " dadress_dbt adr "
                        + " ,dcountry_dbt cn "
                      + " WHERE "
                        + " adr.t_PartyID = pt.t_PartyID "
                      + " AND adr.t_Type = " + PTADDR_REAL + " "
                      + " AND adr.t_Country <> CHR(1) "
                      + " AND cn.t_CodeLat3 = adr.t_Country) "
                  + " ELSE "
                     + " CHR(1) "
                + " END), CHR(1)) AS t_ResidenceCountry "
            + " ,NVL((CASE "
                  + " WHEN pt.t_NotResident = 'X' "
                    + " OR (pt.t_NRCountry <> CHR(1) "
                    + " AND pt.t_NRCountry <> 'RUS') "
                  + " THEN "
                     + " (SELECT "
                        + " adr.t_Adress "
                      + " FROM "
                        + " dadress_dbt adr "
                      + " WHERE "
                        + " adr.t_PartyID = pt.t_PartyID "
                      + " AND adr.t_Type = " + PTADDR_REAL + ") "
                  + " ELSE "
                     + " CHR(1) "
                + " END), CHR(1)) AS t_ResidenceAdress "
            + " ,NVL((SELECT "
                  + " objcode.t_Code "
                + " FROM "
                  + " dobjcode_dbt objcode "
                + " WHERE "
                  + " objcode.t_ObjectType = " + OBJTYPE_PARTY + " "
                + " AND objcode.t_CodeKind = " + PTCK_INN + " "
                + " AND objcode.t_ObjectID = pt.t_PartyID "
                + " AND objcode.t_State = 0), CHR(1)) AS t_ClientINN "
            + " ,COUNT(1) OVER () AS COUNT "
            + " , ("
                + "CASE "
                + "WHEN EXISTS(SELECT 1 "
                        + "FROM DSFCONTR_DBT sfcontr "
                        + "WHERE sfcontr.T_PARTYID = pt.t_PartyID "
                        + "  AND sfcontr.T_SERVKIND = 7 "
                        + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_RepDate)
                        + "  AND ( "
                        + "      sfcontr.T_DATECLOSE >= " + GetSQLDate(m_RepDate)
                        + "    OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy') "
                        + "    ) "
                        + ") "
            + "     AND NOT EXISTS(SELECT 1 "
                          + "FROM DSFCONTR_DBT sfcontr, DDLCONTR_DBT dlcontr "
                          + "WHERE sfcontr.T_PARTYID = pt.t_PartyID"
                          + "  AND dlcontr.t_SfContrID = sfcontr.t_ID "
                          + "  AND sfcontr.T_DATEBEGIN <= " + GetSQLDate(m_RepDate)
                          + "  AND ( "
                          + "      sfcontr.T_DATECLOSE >= " + GetSQLDate(m_RepDate)
                          + "    OR sfcontr.T_DATECLOSE = to_date('01.01.0001', 'dd.mm.yyyy')"
                          + "    ) "
                          + ") "
                + "THEN 1 "
                + "ELSE 0 "
                + "END "
            + "  ) as t_IsDepoClient"
            + " ,max(q.t_OperDate) as t_MaxOperDate "
          + " FROM "
            + " dparty_dbt pt "
            + " inner join dpersn_dbt persn "
            + " on persn.t_PersonID = pt.t_PartyID "
            + " inner join "
            + " ( "
            + "   select nptxop.t_OperDate, nptxop.t_Client as t_ClientID "
            + "   from dnptxop_dbt nptxop "
            + "   where nptxop.t_OperDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate)
            + "    and nptxop.t_Status > 0 "
            + "    and ( "
            + "         ( "
            + "           nptxop.t_DocKind = " + string(DL_WRTMONEY)
            + "           and nptxop.t_SubKind_Operation = " + string(DL_NPTXOP_WRTKIND_WRTOFF)
            + "         ) "
            + "       or ( "
            + "           nptxop.t_DocKind = " + string(DL_CALCNDFL)
            + "           and nptxop.t_SubKind_Operation in( " + string(DL_TXBASECALC_OPTYPE_ENDYEAR) + ", "
                                                  + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS)
                                             + ") "
            + "         ) "
            + "       ) "
            + "   union "
            + "   select tick.t_DealDate as t_OperDate, tick.t_ClientID "
            + "   from ddl_tick_dbt tick "
            + "   where tick.t_DealDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) /*6, 7*/
            + "    and tick.t_DealStatus > 0 "
            + "    and ( "
            + "         ( "
            + "           tick.t_BOfficeKind = " + string(DL_AVRWRT)
            + "           and tick.t_DealType = 2010 "
            + "         ) "
            + "       or ( "
            + "           tick.t_BOfficeKind = " + string(DL_RETIREMENT_OWN)
            + "           and tick.t_DealType = 2052 "
            + "         ) "
            + "       ) "
            + "    union "
            + "    select dl_order.t_SignDate as t_OperDate, dl_order.t_Contractor as t_ClientID "
            + "    from ddl_order_dbt dl_order "
            + "    where dl_order.t_SignDate between " + GetSQLDate(m_BeginDate) + " and " + GetSQLDate(m_EndDate) /*11, 12*/
            + "      and dl_order.t_DocKind = " + string(DL_VEKSELDRAWORDER)
            + "      and dl_order.t_Kind_Operation = " + string(VSOP_REPAY)
            + "      and dl_order.t_ContractStatus > 0 "
            + " ) q "
            + " on q.t_ClientID = pt.t_PartyID "
          + " WHERE "
            + " pt.t_LegalForm = " + legal_form_phys + " "
          + " AND (1 = " + IIF(m_IsConsiderCB, 1, 0) + " "
          + " AND (EXISTS (SELECT "
                     + " 1 "
                  + " FROM "
                     + " dnptxop_dbt txop "
                  + " WHERE "
                     + " txop.t_DocKind = " + DL_CALCNDFL + " "
                  + " AND txop.t_OperDate BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + " AND txop.t_Client = pt.t_PartyID "
                  + "   AND EXISTS "
                  + "   (SELECT 1 "
                  + "   FROM dnptxobdc_dbt dc, " + TABLE_NPTXOBJ + " txobj "
                  + "  WHERE dc.t_docid =  txop.t_id  "
                  + "  AND dc.t_objid = txobj.t_objid "
                  + "  AND txobj.t_level >= 5 "
                          +    IIF(isSlice, " and txobj.t_sliceID = " + m_SliceID + " ", " ")
                  + "  AND txobj.t_kind IN "
                  + "      (SELECT DISTINCT "
                  + "           kind.t_element "
                  + "        FROM dnptxkind_dbt kind "
                  + "       WHERE LOWER (t_code) LIKE "
                  + "             ('plus%')) "
                  + "  AND txobj.t_Sum > 0 "
                  + " )) "
                  + " OR EXISTS  "
                  + "      (SELECT 1  "
                  + "        FROM " + TABLE_NPTXOBJ + " obj  "
                  + "       WHERE    obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                            TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                            TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                  + "                        )"
                  + "           AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + "           AND obj.t_Client = pt.t_PartyID  "
                  + "           AND obj.t_User <> 'X'  "
                          +            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                  + "           AND EXISTS  "
                  + "                (SELECT 1  "
                  + "                  FROM dnptxobdc_dbt odc,  "
                  + "                      dnptxop_dbt  txop  "
                  + "                  WHERE    odc.t_ObjID =  "
                  + "                        obj.t_ObjID  "
                  + "                      AND txop.t_ID =  "
                  + "                        odc.t_DocID  "
                  + "                      AND txop.t_DocKind = "+string(DL_CALCNDFL)+")  "
                  + "           AND obj.t_FromOutSyst <> 'X')  "
                  + " OR EXISTS  "
                  + "      (SELECT 1  "
                  + "        FROM " + TABLE_NPTXOBJ + " obj  "
                  + "       WHERE    obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                            TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                            TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                  + "                        )"
                  + "           AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + "           AND obj.t_Client = pt.t_PartyID  "
                  + "           AND obj.t_User = 'X'  "
                          +            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                  + "           AND obj.t_FromOutSyst <> 'X')  "
                  + " OR EXISTS  "
                  + "      (SELECT 1  "
                  + "        FROM " + TABLE_NPTXOBJ + " obj  "
                  + "       WHERE    obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                            TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                            TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                  + "                        )"
                  + "           AND obj.t_Client = pt.t_PartyID  "
                  + "           AND obj.t_User <> 'X'  "
                          +            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") 
                  + "           AND EXISTS  "
                  + "                (SELECT 1  "
                  + "                  FROM dnptxobdc_dbt odc,  "
                  + "                      dnptxop_dbt  txop  "
                  + "                  WHERE    odc.t_ObjID =  "
                  + "                        obj.t_ObjID  "
                  + "                      AND txop.t_ID =  "
                  + "                        odc.t_DocID  "
                  + "                      AND txop.t_DocKind = "+string(DL_HOLDNDFL)
                  + "                      AND txop.t_PrevDate =  " + GetSQLDate(m_BeginDate) + " )"
                  + "           AND obj.t_FromOutSyst <> 'X')  "
                  + " OR EXISTS  "
                  + "      (SELECT 1  "
                  + "        FROM " + TABLE_NPTXOBJ + " obj  "
                  + "       WHERE    obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                            TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS+","+
                                            TXOBJ_PAIDGENERAL_15_1+","+TXOBJ_PAIDGENERAL_15_2 + "," + TXOBJ_PAIDGENERAL_15_9 + "," + TXOBJ_PAIDGENERAL_15_1_0 + ","+TXOBJ_PAIDGENERAL_15_IIS
                  + "                        )"
                  + "           AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + "           AND obj.t_Client = pt.t_PartyID  "
                  + "           AND obj.t_User <> 'X'  "
                          +            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") 
                  + "           AND EXISTS  "
                  + "                (SELECT 1  "
                  + "                  FROM dnptxobdc_dbt odc,  "
                  + "                      dnptxop_dbt  txop  "
                  + "                  WHERE    odc.t_ObjID =  "
                  + "                        obj.t_ObjID  "
                  + "                      AND txop.t_ID =  "
                  + "                        odc.t_DocID  "
                  + "                      AND txop.t_DocKind = "+string(DL_WRTMONEY)+")  "
                  + "           AND obj.t_FromOutSyst <> 'X')  "
                  + " OR EXISTS  "
                  + "      (SELECT 1  "
                  + "        FROM " + TABLE_NPTXOBJ + " obj  "
                  + "       WHERE    obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                            TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS
                  + "                        )"
                  + "           AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + "           AND obj.t_Client = pt.t_PartyID  "
                  + "           AND obj.t_User <> 'X'  "
                          +            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") 
                  + "           AND obj.t_AnaliticKind1 = 1020  "
                  + "           AND EXISTS  "
                  + "                (SELECT 1  "
                  + "                  FROM ddl_tick_dbt dl_tick  "
                  + "                  WHERE    dl_tick.t_DealID =  "
                  + "                        obj.t_Analitic1  "
                  + "                      AND dl_tick.t_BOfficeKind =  "
                  + "                        "+string(DL_RETIREMENT_OWN)+")  "
                  + "           AND obj.t_FromOutSyst <> 'X')  "
                  + " OR EXISTS  "
                  + "      (SELECT 1  "
                  + "        FROM " + TABLE_NPTXOBJ + " obj  "
                  + "       WHERE    obj.t_Kind IN ("+TXOBJ_PAIDGENERAL+","+TXOBJ_PAIDGENERAL_0 + "," + TXOBJ_PAIDMATERIAL + "," + 
                                            TXOBJ_PAIDBILL + "," + TXOBJ_DIVPAY_SEC + "," + TXOBJ_DIVPAY_SEC_0 + ","+TXOBJ_PAIDGENERAL_IIS
                  + "                        )"
                  + "           AND obj.t_date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + "           AND obj.t_Client = pt.t_PartyID  "
                          +            IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") 
                  + "           AND (EXISTS  "
                  + "                 (SELECT 1  "
                  + "                   FROM dnptxobdc_dbt dc,  "
                  + "                      doproper_dbt opr  "
                  + "                  WHERE    dc.t_ObjID =  "
                  + "                         obj.t_ObjID  "
                  + "                      AND opr.t_ID_Operation =  "
                  + "                         dc.t_DocID  "
                  + "                      AND opr.t_DocKind IN ("+string(DL_VEKSELDRAWORDER)+", "+string(DL_VSBARTERORDER)+", "+string(DL_VSINTERCHANGE)+"))))  "
              + " ) "
          + "  OR  ("
              + " EXISTS (SELECT "
                      + " 1 "
                   + " FROM "
                      + " " + TABLE_NPTXOBJ + " txobj "
                   + " WHERE "
                      + " ("
                        + " ("
                          + " pt.t_NotResident = 'X' "
                          + " and txobj.t_Kind IN ("
                                          + TXOBJ_BASEMATERIAL + ", "
                                          + TXOBJ_BASEMATERIAL_IIS + ", "
                                          + TXOBJ_BASEGENERAL + ", "
                                          + TXOBJ_BASEGENERAL_IIS + ", "
                                          + TXOBJ_BASESPECIAL + ", "
                                          + TXOBJ_BASESPECIAL_IIS
                                        + ") "
                        + " )"
                        + " or txobj.t_Kind IN ("
                                       + TXOBJ_BASESPECIAL + ", "
                                       + TXOBJ_BASESPECIAL_IIS + ", "
                                       + TXOBJ_BASEG1 + ", "
                                       + TXOBJ_BASEG2 + ", "
                                       + TXOBJ_BASEG3 + ", "
                                       + TXOBJ_BASEG4 + ", "
                                       + TXOBJ_BASEG5 + ", "
                                       + TXOBJ_BASEG6 + ", "
                                       + TXOBJ_BASEG7 + ", "
                                       + TXOBJ_BASEG8 + ", "
                                       + TXOBJ_BASEG9
                        + "              )"
                      + " )"
                   + " AND (txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                    + " OR txobj.t_Analitickind6 = 0) "
                   + " AND txobj.t_Client = pt.t_PartyID "
                   + " AND txobj.t_FromOutSyst <> 'X'"
                            +  IIF(isSlice, " and txobj.t_sliceID = " + m_SliceID + " ", " ") 
                   + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                   + " AND txobj.t_Sum > 0) "
              + ") "
           + " OR 1 = " + IIF(m_IsConsiderDEPO, 1, 0) + " "
           + " AND EXISTS (SELECT "
                      + " 1 "
                   + " FROM "
                      + " " + TABLE_NPTXOBJ + " txobj "
                   + " WHERE "
                      + " ("
                        + " ("
                          + " pt.t_NotResident = 'X'"
                          + " and txobj.t_Kind IN ("
                                          + TXOBJ_BASEMATERIAL + ", "
                                          + TXOBJ_BASEMATERIAL_IIS + ", "
                                          + TXOBJ_BASEGENERAL + ", "
                                          + TXOBJ_BASEGENERAL_IIS + ", "
                                          + TXOBJ_BASESPECIAL + ", "
                                          + TXOBJ_BASESPECIAL_IIS
                                          + IIF(m_EndDate < Date(1, 1, 2021), ", " + TXOBJ_BASESPECIAL_DIV, "")
                                        + ") "
                        + " )"
                        + " or txobj.t_Kind IN ("
                                        + TXOBJ_BASESPECIAL + ", "
                                        + TXOBJ_BASESPECIAL_IIS + ", "
                                        + TXOBJ_BASEG1 + ", "
                                        + TXOBJ_BASEG2 + ", "
                                        + TXOBJ_BASEG3 + ", "
                                        + TXOBJ_BASEG4 + ", "
                                        + TXOBJ_BASEG5 + ", "
                                        + TXOBJ_BASEG6 + ", "
                                        + TXOBJ_BASEG7 + ", "
                                        + TXOBJ_BASEG8 + ", "
                                        + TXOBJ_BASEG9
                          + "           )"
                   + " )"
                   + " AND (txobj.t_Analitickind6 = " + TXOBJ_KIND6020 + " "
                    + " OR txobj.t_Analitickind6 = 0) "
                   + " AND txobj.t_Client = pt.t_PartyID "
                   + " AND txobj.t_FromOutSyst <> 'X'"
                            +  IIF(isSlice, " and txobj.t_sliceID = " + m_SliceID + " ", " ") 
                   + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                   + " AND txobj.t_Sum > 0) "
           + " OR 1 = " + IIF(m_IsConsiderVS, 1, 0) + " "
          + " AND EXISTS (SELECT "
                     + " 1 "
                  + " FROM "
                     + " " + TABLE_NPTXOBJ + " txobj "
                  + " WHERE "
                     + " txobj.t_Kind IN (" + TXOBJ_BASEBILL + ") "
                  + " AND txobj.t_Client = pt.t_PartyID "
                  + " AND txobj.t_FromOutSyst <> 'X'"
                          +  IIF(isSlice, " and txobj.t_sliceID = " + m_SliceID + " ", " ") 
                  + " AND txobj.t_Date BETWEEN " + GetSQLDate(m_BeginDate) + " AND " + GetSQLDate(m_RepDate)
                  + " AND txobj.t_Sum > 0) "
           + IIF(m_RepDate == date(31,12,2022), "OR Exists(SELECT 1 FROM DNPTXDIAS_DBT ds WHERE ds.t_ClientID = pt.t_PartyID AND ds.t_IIS <> 'X') ", "")
          +") "
          + IIF( ValType(ClientTable) ==  V_STRING, " AND pt.t_PartyID in (Select tcl.t_PartyID from " + ClientTable + " tcl ) ", " ")
          + " AND (1 = " + IIF(((ValType(Investor) != V_GENOBJ) and (Investor > 0)) or ((ValType(Investor) == V_GENOBJ) and (Investor[0] > 0)), 0, 1) + IIF(ValType(Investor) != V_GENOBJ, " OR pt.t_PartyID = " + Investor, " OR pt.t_PartyID in (");
          if((ValType(Investor) == V_GENOBJ) and (Investor[0] > 0))
            m_query = m_query + Investor[0];
            var i = 1;
            while(i < Investor.Size())
              m_query = m_query + ", " + Investor[i];
              i = i + 1;
            end;
            m_query = m_query + ")";
          end;
          m_query = m_query + ") "
          + " GROUP BY "
            + " pt.t_PartyID "
            + " ,pt.t_NotResident "
            + " ,persn.t_Name1 "
            + " ,persn.t_Name2 "
            + " ,persn.t_Name3 "
            + " ,persn.t_Born "
            + " ,persn.t_BirsPlase "
            + " ,pt.t_NRCountry "
          + " ORDER BY "
            + " persn.t_Name1 ASC "
            + " ,persn.t_Name2 ASC "
            + " ,persn.t_Name3 ASC ";

    m_cmd = DL_RSDCommand(m_query);
    m_count = m_cmd.GetCount();
  END;

  MACRO Count():Integer
    return m_count;
  END;

  PRIVATE MACRO RecalcNOB(PayerInfo, RateIndex, RateVal)
    var NOBSum = $0;
    var i = -1;
    var bufSum = $0;
    PayerInfo.ArrCodeParm[RateIndex].PlusSum = $0;
    PayerInfo.ArrCodeParm[RateIndex].MinusSum = $0;
    PayerInfo.ArrCodeParm[RateIndex].TaxBaseSum = $0;
    while ((i=i+1) < PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr.size)
     NOBSum = NOBSum + (ExtRound(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn) - PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum(NULL, true));
     PayerInfo.ArrCodeParm[RateIndex].PlusSum = PayerInfo.ArrCodeParm[RateIndex].PlusSum + ExtRound(PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].PSnnn);
     PayerInfo.ArrCodeParm[RateIndex].MinusSum = PayerInfo.ArrCodeParm[RateIndex].MinusSum + PayerInfo.ArrCodeParm[RateIndex].NPTXCodeParmArr[i].GetMinusSum(NULL, true);
    end;
    if ((PayerInfo.ArrCodeParm[RateIndex].TaxPaid != $0) and (PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue != 0))
     bufSum = PayerInfo.ArrCodeParm[RateIndex].TaxPaid - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue;
     PayerInfo.ArrCodeParm[RateIndex].TaxPaid = IIF(bufSum > $0, ABS(bufSum), $0);
     PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue = IIF(bufSum < $0, ABS(bufSum), $0);
    end;
    PayerInfo.ArrCodeParm[RateIndex].TaxBaseSum = NOBSum;
    PayerInfo.ArrCodeParm[RateIndex].TaxCalculated = ExtRound(NOBSum) * RateVal / 100.0;
    PayerInfo.ArrCodeParm[RateIndex].TaxDue = ExtRound(PayerInfo.ArrCodeParm[RateIndex].TaxCalculated,0) 
           + ExtRound(-PayerInfo.ArrCodeParm[RateIndex].TaxPaid - PayerInfo.ArrCodeParm[RateIndex].TaxToReturnDue,0);
    if(PayerInfo.ArrCodeParm[RateIndex].TaxDue >= 0)
     PayerInfo.ArrCodeParm[RateIndex].TaxOver = 0;
    else
     PayerInfo.ArrCodeParm[RateIndex].TaxOver = -PayerInfo.ArrCodeParm[RateIndex].TaxDue;
     PayerInfo.ArrCodeParm[RateIndex].TaxDue = 0;
    end;
    
  END;

  MACRO CalcNPTXPIT2General(PayerInfo:@NPTXPayerInfo, PlusSumPrm:@MONEY, TaxBasePrm:@MONEY, PlusSumHighPrm:@MONEY, TaxBaseHighPrm:@MONEY)
    var PlusSum = $0, MinusSum = $0, PlusSum15 = $0, MinusSum15 = $0, TaxBase15 = $0;
    var indexTotal = IndexOfRate(PayerInfo.ArrCodeParm, 13, false);
    var indexHigh = IndexOfRate(PayerInfo.ArrCodeParm, 15, true);
    var i = 0, j = 0, k = 0, l = 0, j2 = 0;
    var codeBufPlusSums = TArray();
    var codeBufMinusSums = TArray();
    var codeBuf = TArray();
    var odBuf = Tarray();
    var sortedArr = TArray();
    var bufIdx = -1;
    var totalRecBuf = null;
    var MSnnn = $0, OD = $0, calcOD = $0, bufOD = $0;
    var minusFind = false;
    var OD2 = $0;
    var D15 = $0;
    var NOBSum = $0;
    var mnsSum = $0;
    var fromIndex, toIndex;

    //проверка на отрицательные суммы и "схлопывание"
    if (indexTotal >= 0)
      i = -1;
      while ((i=i+1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.Size)
       totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
       if (totalRecBuf.PSnnn < 0.0)
        codeBuf[codeBuf.size] = CollapseStruct(i, totalRecBuf.PSCode, totalRecBuf.PSnnn);
       end;

       j=-1;
       while ((j=j+1) < totalRecBuf.MinusCodes.Size)
        if (totalRecBuf.MinusCodes[j].MSnnn < 0.0)
          codeBuf[codeBuf.size] = CollapseStruct(i, totalRecBuf.MinusCodes[j].MSCode, totalRecBuf.MinusCodes[j].MSnnn, j);
        end;
       end;
      end;
    end;
    
    MACRO MaxOperDate()
      return Date(m_RS.MaxOperDate);
    END;

    if (indexTotal >= 0)
      i = -1;
      while ((i = i + 1) < codeBuf.size)
       if (not codeBuf[i].IsMinus)
        sortedArr = MakeSortedPlusByCodeAndSum(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr, codeBuf[i].Code);
       else
        sortedArr = MakeSortedMinusByCodeAndSum(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr, codeBuf[i].Code);
       end;
       j = -1;
       while ((j=j+1) < sortedArr.size)
        codeBuf[i].Sum = codeBuf[i].Sum + sortedArr[j].Sum;
        if (ExtRound(codeBuf[i].Sum) >= $0)
          if (not codeBuf[i].IsMinus)
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = codeBuf[i].Sum;
           //если он вдруг нулевой, то его "стираем"
           if (ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn) == 0)
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL;
           end;
          else
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx].MSnnn = codeBuf[i].Sum;
           //если он вдруг нулевой, то его "стираем"
           if (ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx].MSnnn) == $0)
            //пока делаем просто null чтобы не сбить индексы
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx] = NULL;
           end;
          end;

          while ((j=j-1) >= 0)
           if (not codeBuf[i].IsMinus)
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = 0.0;
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL; 
           else
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes[sortedArr[j].SubIdx] = NULL;
           end;
          end;
          if (not codeBuf[i].IsMinus)
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].PSnnn = 0.0;
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].PSCode = NULL; 
          else
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[codeBuf[i].Idx].MinusCodes[codeBuf[i].SubIdx] = NULL;
          end;
          DeleteFromArr(@codeBuf,i);
          i=i-1;
          break;
        end;
       end;
      end;

      //подчищаем null значения в minuscodes
      i = -1;
      while ((i = i + 1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.size)
       if (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes != NULL)
        PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes = filter(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes);
       end;
      end;
    end;

    var oldArr;
    //проверка на отрицательный ОД (остаток доходов, т.е. доход минус вычеты), и перенос излишних вычетов в предыдущие (или следующие) месяцы
    if (indexTotal >= 0)
      //делаем полную копию NPTXCodeParmArr по значениям
      oldArr = MakeCopyNPTXCodeParmArr(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr);

      i = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.Size;
      while ((i=i-1) >= 0)
       totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i];
       if (not totalRecBuf.IsShow)
        continue;
       end;

       MSnnn = totalRecBuf.GetMinusSum(true);

       if (ExtRound(totalRecBuf.PSnnn - MSnnn) < $0)
        var psCode = totalRecBuf.PSCode;
        if (psCode == NULL)
          k = -1;
          while ((k = k + 1) < GetCodeGroupsValue().size)
           if (find(GetCodeGroupsValue()[k],totalRecBuf.MinusCodes[0].MSCode) != -1)
            psCode = GetCodeGroups()[k].Key;
            break;
           end;
          end;
        end;
        odBuf[odBuf.size] = MinusMoveStruct(totalRecBuf.PSnnn, psCode, i, totalRecBuf.MinusCodes);
       end;
      end;

      i = -1;
      while ((i=i+1) < odBuf.size)
       //j2 = 0;
       j=odBuf[i].Idx;
       while (((j=j-1) >= 0) and (j != odBuf[i].Idx))
        totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j];
        if ((totalRecBuf.PSCode != NULL) and (totalRecBuf.PSCode == odBuf[i].PlusCode))
          MSnnn = totalRecBuf.GetMinusSum(true);

          OD2 = totalRecBuf.PSnnn - MSnnn;

          j2 = -1;

          while (((j2=j2+1) < odBuf[i].MinusCodes.size) and (ExtRound(OD2) > 0))
           mnsSum = min(min(odBuf[i].MinusCodes[j2].Sum,ABS(odBuf[i].GetOD())),OD2);
           if (mnsSum <= $0)
            continue;
           end;
           
           OD2 = OD2 - mnsSum;
           odBuf[i].MinusCodes[j2].Sum = ExtRound(odBuf[i].MinusCodes[j2].Sum - mnsSum);
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn
            = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn - mnsSum;

           if (ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx].MSnnn) == $0)
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[odBuf[i].MinusCodes[j2].SubIdx] = NULL;
           end;
           
           l = -1;
           minusFind = false;
           while(((l=l+1) < totalRecBuf.MinusCodes.Size) )
            //ищем что среди кодов вычетов, нет вычета который мы запомнили
            if (totalRecBuf.MinusCodes[l].MSCode == odBuf[i].MinusCodes[j2].Code)
              minusFind = true;
              PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[l].MSnnn = 
               PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[l].MSnnn + mnsSum;
              break;
            end;
           end;
           if (not minusFind)
            PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes[PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[j].MinusCodes.size] = 
                              NPTXMinusCodeParm(odBuf[i].MinusCodes[j2].Code, mnsSum, true);
           end;
          end;
        end;

        if (ExtRound(odBuf[i].GetOD()) >= $0)
          break;
        end;

        //закольцовываем
        if (j == 0)
          j = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.size;
        end;
       end;
      end;

      //подчищаем null значения в minuscodes
      i = -1;
      while ((i = i + 1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.size)
       if (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes != NULL)
        PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes = filter(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes);
       end;
      end;

    end;

    var wasNotReDef = false;
    var needRecalcNob = false;

    i = -1;
    while ((i = i + 1) < odBuf.size)
      OD = odBuf[i].GetOD();
      if (OD < -0.5)
       wasNotReDef = true;
       MsgBox("По клиенту с PartyID = " + PayerInfo.ClientID + " (" + PayerInfo.LastName + " " + PayerInfo.FirstName + " " +  PayerInfo.MiddleName + 
          "), не распределено превышение расходов над доходами на сумму "+string(ABS(odBuf[i].GetOD())));
      elif ((OD < 0.0) and (OD >= -0.5))
       j=-1;
       while(((j=j+1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes.size) and (ExtRound(OD) < 0.0))
        mnsSum = min(ABS(OD),PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn);
        PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn = 
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[odBuf[i].Idx].MinusCodes[j].MSnnn - mnsSum;
        OD=OD+mnsSum;
        needRecalcNob = true;
       end;
      end;
    end;
    if (wasNotReDef)
      MsgBox("По клиенту с PartyID = " + PayerInfo.ClientID + " (" + PayerInfo.LastName + " " + PayerInfo.FirstName + " " +  PayerInfo.MiddleName + ") вычеты возвращены в исходное состояние");
      PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr = oldArr;
    end;
    
    if (indexTotal >= 0)
      ////идём сверху вниз
      i = -1;
      while ((i=i+1) < PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr.Size)
       if ( ((PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes == NULL) 
         OR (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[i].MinusCodes.Size == 0)) and (totalRecBuf.PSCode == NULL))
        DeleteFromArr(@PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr,i);
        i = i - 1;
       end;
      end;
    end;

    if((indexTotal >= 0) and (indexHigh >= 0))
      if (   (ExtRound(PayerInfo.ArrCodeParm[indexHigh].PlusSum) == $0) 
        and (ExtRound(PayerInfo.ArrCodeParm[indexHigh].MinusSum) == $0) 
        and (ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxBaseSum) == $0) 
        and (ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxCalculated) == $0))

       //требование из ТЗ по переносу оплаченных сумм из ставки 15% в ставку 13% в случае если по ставке 15% суммы доходов и расходов, а также исчисленного налога - нулевые

       PayerInfo.ArrCodeParm[indexTotal].TaxPaid = PayerInfo.ArrCodeParm[indexTotal].TaxPaid + PayerInfo.ArrCodeParm[indexHigh].TaxPaid;
       PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue = PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue + PayerInfo.ArrCodeParm[indexHigh].TaxToReturnDue;
       PayerInfo.ArrCodeParm[indexTotal].TaxDue = PayerInfo.ArrCodeParm[indexTotal].TaxCalculated - PayerInfo.ArrCodeParm[indexTotal].TaxPaid + PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue;
       if(PayerInfo.ArrCodeParm[indexTotal].TaxDue >= 0)
         PayerInfo.ArrCodeParm[indexTotal].TaxOver = 0;
       else
         PayerInfo.ArrCodeParm[indexTotal].TaxOver = ABS(PayerInfo.ArrCodeParm[indexTotal].TaxDue);
         PayerInfo.ArrCodeParm[indexTotal].TaxDue = 0;
       end;
       DeleteFromArr(@PayerInfo.ArrCodeParm,indexHigh);
       indexHigh = -1;
       needRecalcNob = true;
      end;
    end;

    if((indexTotal >= 0) and (indexHigh >= 0) and ((ExtRound(PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue) > $0) or (ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxToReturnDue) > $0)))
      //переброс удержанного отрицательного налога
      if ((Abs(ExtRound(PayerInfo.ArrCodeParm[indexHigh].TaxToReturnDue)) * (-1)) < (Abs(ExtRound(PayerInfo.ArrCodeParm[indexTotal].TaxToReturnDue)) * (-1)))
       fromIndex = indexHigh;
       toIndex = indexTotal;
      else
       fromIndex = indexTotal;
       toIndex = indexHigh;
      end;
      PayerInfo.ArrCodeParm[toIndex].TaxToReturnDue = PayerInfo.ArrCodeParm[toIndex].TaxToReturnDue + PayerInfo.ArrCodeParm[fromIndex].TaxToReturnDue;
      PayerInfo.ArrCodeParm[fromIndex].TaxToReturnDue = 0.0;
      needRecalcNob = true;
    end;

    if ((indexTotal >= 0) and (PayerInfo.ArrCodeParm[indexTotal].Income15.size > 0) and true)
      i = -1;
      while ((i = i + 1) < PayerInfo.ArrCodeParm[indexTotal].Income15.size)
       sortedArr = MakeSortedCodesByNobkind(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr, PayerInfo.ArrCodeParm[indexTotal].Income15[i].Key);
       j = -1;
       D15 = 1;
       while ((j = j + 1) < sortedArr.size)
        totalRecBuf = PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx];
        OD = totalRecBuf.PSnnn - totalRecBuf.GetMinusSum();
        D15 = min(PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value, OD);
        if (D15 > $0)
          PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn = 
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn - D15;
          PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value = PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value - D15;

          AddInArrCodeParms(PayerInfo.ArrCodeParm, totalRecBuf.Month, totalRecBuf.PSCode, D15, NULL, NULL, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, true);
          if ((ExtRound(PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSnnn) == $0) and 
            ((PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes == NULL) or 
             (PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].MinusCodes.size == 0))
            )
           PayerInfo.ArrCodeParm[indexTotal].NPTXCodeParmArr[sortedArr[j].Idx].PSCode = NULL;
          end;
          if (PayerInfo.ArrCodeParm[indexTotal].Income15[i].Value <= $0)
           break;
          end;
        end;
       end;
      end;

      needRecalcNob = true;
    end;

    if (needRecalcNob)
      if (indexTotal >= 0)
       RecalcNOB(PayerInfo, indexTotal, 13.0);
       indexHigh = IndexOfRate(PayerInfo.ArrCodeParm, 15, true);
       if (indexHigh >= 0)
        RecalcNOB(PayerInfo, indexHigh, 15.0);
       end;
      end;
    end;
  END;


  MACRO Next():BOOL
      if(m_RS == NULL)
         m_RS = m_cmd.Execute();
      end;
      var flag = m_RS.MoveNext();
      if(flag)
        ClearData();
        CalcData(INFORATE_TOTAL);
        Refresh_TaxDivValArray();
        CalcData(INFORATE9_NOTRES_DIV);
        m_PayerInfo = NPTXPayerInfo(this.ClientID, this.ClientINN(), this.LastName(),
                                                                            this.FirstName(), this.MiddleName(), this.ResidenceStatus(),
                                                                            this.DateBirth(), this.Citizenship(),
                                                                            this.DocumentType(), this.DocumentNumber(),
                                                                            m_ArrCodeParms);
        var PlusSum = 0, TaxBase = 0, PlusSumHigh = 0, TaxBaseHigh = 0;
        CalcNPTXPIT2General(@m_PayerInfo, @PlusSum, @TaxBase, @PlusSumHigh, @TaxBaseHigh);
      end;
      
      return flag;
  END;

  MACRO parseCodeForReg(RateMain, Rate15)
    var i = 0;
    var ArrCode = m_PayerInfo.ArrCodeParm;

    while(i < ArrCode.Size)
      var iM = 0;
      while(iM < ArrCode[i].NPTXCodeParmArr.size)
        var ArrCodeMinus = Tarray();
        var ArrCodePlus = Tarray();
        var iCM = 0;
        var sum = $0.0;
        var KindP = 0, CodeP = "";
    if((ArrCode[i].NPTXCodeParmArr[iM].PSnnn != 0) or (ArrCode[i].NPTXCodeParmArr[iM].MinusCodes.size != 0))
        while(iCM < ArrCode[i].NPTXCodeParmArr[iM].MinusCodes.size)
          if(ArrCode[i].NPTXCodeParmArr[iM].MinusCodes[iCM].isShow)
            var ArrSumMount = TArray();
            var KindM = 0, CodeM = "";
            ArrSumMount[ArrSumMount.size] = c_NRDMonth(ArrCode[i].NPTXCodeParmArr[iM].Month , ArrCode[i].NPTXCodeParmArr[iM].MinusCodes[iCM].MSnnn);
            getPrmCode(@KindM, @CodeM, ArrCode[i].NPTXCodeParmArr[iM].MinusCodes[iCM].MSCODE);
            ArrCodeMinus[ArrCodeMinus.size] = c_CodeNRDMonth(KindM, CodeM, ArrCode[i].NPTXCodeParmArr[iM].MinusCodes[iCM].MSCODE, ArrSumMount); // c_CodeNRDMonth(TXOBJ_MINUSG_619, "TXOBJ_MINUSG_619", "619", MinusArr);
            sum = sum - ArrCode[i].NPTXCodeParmArr[iM].MinusCodes[iCM].MSnnn;
          end;
          iCM = iCM + 1;
        end;
        
        ArrCodePlus[ArrCodePlus.size] = c_NRDMonth(ArrCode[i].NPTXCodeParmArr[iM].Month , ArrCode[i].NPTXCodeParmArr[iM].PSnnn);
        getPrmCode(@KindM, @CodeM, ArrCode[i].NPTXCodeParmArr[iM].PSCode);
        
        sum = sum + ArrCode[i].NPTXCodeParmArr[iM].PSnnn;
        if(ArrCode[i].IsHighRate == SET_CHAR)
          Rate15[Rate15.size] = c_MonthsNOB(c_CodesForMonthNOB(c_CodeNRDMonth(KindM, CodeM, ArrCode[i].NPTXCodeParmArr[iM].PSCode, ArrCodePlus), ArrCodeMinus, sum), ArrCode[i].NPTXCodeParmArr[iM].Month);
        else
          RateMain[RateMain.size] = c_MonthsNOB(c_CodesForMonthNOB(c_CodeNRDMonth(KindM, CodeM, ArrCode[i].NPTXCodeParmArr[iM].PSCode, ArrCodePlus), ArrCodeMinus, sum), ArrCode[i].NPTXCodeParmArr[iM].Month);
        end;
    end;
        iM = iM + 1;
      end;
      i = i + 1;
    end;
  END;

  MACRO getDataClient()
    var queryClient =  
                  "  select " +
                  "    pt.t_PartyID as PartyID, " +
                  "    RowNum as Num, " +
                  "   " + GetSQLDate(m_BeginDate) + " as DateT1, " +
                  "   " + GetSQLDate(m_EndDate) + " as DateT2, " +
                  "   (select papr.t_CodeDocum from dpaprkind_dbt papr where papr.t_PaperKind = pers.t_PaperKind ) as DocumentType, " +
                  "   (select papr.t_Name from dpaprkind_dbt papr where papr.t_PaperKind = pers.t_PaperKind ) as DocumentName, " +
                  "    pers.T_PAPERSERIES || ' ' || pers.T_PaperNumber as DocumentNumber,  " +
                  "    ad.t_Country as Country, " +
                  "    ad.t_PostIndex as MailIndex, " +
                  "    ad.t_RegionNum as RegionCode, " +
                  "    ad.t_Province as District, " +
                  "    ad.t_District as City, " +
                  "    ad.t_Place as Town, " +
                  "    ad.t_Street as Street, " +
                  "    ad.t_House as House, " +
                  "    ad.t_NumCorps as Building, " +
                  "    ad.t_Flat as Appartment, " +
                  "    RSI_NPTX.RESIDENCESTATUS(pt.t_PartyID, " + GetSQLDate(m_EndDate) + ") as ResidenceStatus, " +
                  "    persn.t_Name1 AS Name1 , " +
                  "    persn.t_Name2 AS Name2 , " +
                  "    persn.t_Name3 AS Name3 , " +
                  "    pt.t_Name AS ClientFIO , " +
                  "    persn.t_Born AS BirthDate , " +
                  "    persn.t_BirsPlase , " +
                  "    NVL((CASE WHEN pt.t_NotResident = 'X'  " +
                  "                 OR (pt.t_NRCountry <> CHR(1)  " +
                  "                AND pt.t_NRCountry <> 'RUS')  " +
                  "               THEN  " +
                  "                 (SELECT  " +
                  "                   adr.t_Adress  " +
                  "                  FROM  " +
                  "                   dadress_dbt adr  " +
                  "                  WHERE  " +
                  "                  adr.t_PartyID = pt.t_PartyID  " +
                  "                  AND adr.t_Type = 2 /* PTADDR_REAL */ )  " +
                  "              ELSE  " +
                  "                 CHR(1)  " +
                  "             END), CHR(1)) AS t_ResidenceAdress , " +
                  "    NVL((CASE   " +
                  "                 WHEN pt.t_NotResident = 'X'   " +
                  "                   OR (pt.t_NRCountry <> CHR(1)   " +
                  "                   AND pt.t_NRCountry <> 'RUS')   " +
                  "                 THEN   " +
                  "                   (SELECT   " +
                  "                      cn.t_CodeNum3   " +
                  "                    FROM   " +
                  "                      dadress_dbt adr   " +
                  "                     ,dcountry_dbt cn   " +
                  "                    WHERE   " +
                  "                      adr.t_PartyID = pt.t_PartyID   " +
                  "                    AND adr.t_Type =   2 /* PTADDR_REAL */     " +  
                  "                    AND adr.t_Country <> CHR(1)   " +
                  "                    AND cn.t_CodeLat3 = adr.t_Country)   " +
                  "                 ELSE   " +
                  "                   CHR(1)   " +
                  "               END), CHR(1)) AS t_ResidenceCountry  , " +
                  "             NVL(RSB_SECUR.SC_GetObjCodeOnDate(3 /* OBJTYPE_PARTY */ , 16 /* PTCK_INN */, persn.t_PersonID), CHR(1)) AS t_ClientINN, " +
                  "             NVL(RSB_SECUR.SC_GetObjCodeOnDate(3 /* OBJTYPE_PARTY */ , 63 /* PTCK_SNILS */, persn.t_PersonID), CHR(1)) AS t_SNILS, " +
                  "             NVL((CASE   " +
                  "                 WHEN pt.t_NRCountry <> CHR(1)   " +
                  "                 THEN   " +
                  "                   (SELECT   " +
                  "                      cn.t_CodeNum3   " +
                  "                    FROM   " +
                  "                      dcountry_dbt cn   " +
                  "                    WHERE   " +
                  "                      cn.t_CodeLat3 = pt.t_NRCountry)   " +
                  "                 ELSE   " +
                  "                   CHR(1)   " +
                  "               END), CHR(1)) AS t_Citizenship   " +
                  "  from dparty_dbt pt " +
                  "                 left join dpersn_dbt persn on persn.t_PersonID = pt.T_PARTYID " +
                  "                 left join dpersnidc_dbt pers on pers.T_PERSONID = pt.t_PartyID and t_IsMain = 'X' " +
                  "                 left join dadress_dbt ad on ad.t_PartyID = pt.t_PartyID and t_Type = 1 /*PTADDR_LEGAL*/ and t_Country = 'RUS' "
                  "   where pt.T_PARTYID = ? ";
                  
    var cmd = DL_RSDCommand(queryClient);
        cmd.AddParam(this.ClientID);

    var DataSet = cmd.Execute();
    if(DataSet.MoveNext())
      return DataSet;
    end;
  END;

  MACRO LoadClientInTmpTable():bool
    var query = " insert into DNPTX6CLIENT_TMP "
              + " ( "
              + " t_PartyID             " 
              + " ) "
              + " select t_partyid from ( "
              + m_query + " ) ";

    var cmd = RsdCommand(query);
        cmd.execute();
    return true;
  OnError()   
    return false;
  END;

  MACRO MoveNext():BOOL
      return Next();
  END;

  SQL_Truncate("dnptx6calc1_tmp");

  Init(_Investor, _BeginDate, _EndDate, true, false, true, _ClientTable);

  m_TaxAgentParm = TaxAgentParm();
  m_TaxAgentParm.Load();
END;

/**
 @brief Класс отчета регистра НДФЛ
 @param[in] _Investor Инвестор
 @param[in] _Report_date_end Дата окончания отчета
 @param[in] _Report_date_begin Дата начала отчета
 @param[in] _Folder Путь к папке для сохранения
 @param[in] _LoadFileRadio Флаг необходимости загрузки клиентов из файла 
 @param[in] _LoadFile Файл с клиентами для загрузки
 @param[in] _Clients Массив клиентов
 @param[in] _Oper Исполнитель
 @param[in] _Source Источник данных
 @param[in] _SourceNum Номер среза (если формировать по срезу)
 @param[in] _NeedCompare Необходимость формировать объект сверки
*/
private class (DL_CReportTemplate) RegNDFL_Report (_Investor, _Report_date_end, _Report_date_begin, 
                                                   _Folder, _LoadFileRadio, _LoadFile, _Clients, _Oper, 
                                                   _Source, _SourceNum, _NeedCompare)
  private var rep;
  private var sheet_name = "RegNDFL";
  private var Rate13 = TArray();
  private var Rate15 = TArray();
  private var m_TaxAgentParm = TaxAgentParm();
  private var TABLE_TOTALBASE = NPTXTOTALBASE;
  private var TABLE_NPTXOBJ = NPTXOBJ;
  private var isSlice = false;
  private var m_SliceID = -1;
  private var KBKmain = "";
  private var KBK15 = "";
  private var pInvestor = _Investor, 
              pReport_date_end = _Report_date_end, 
              pReport_date_begin = _Report_date_begin, 
              pFolder = _Folder, 
              pLoad_file_radio = _LoadFileRadio, 
              pLoadFile = _LoadFile, 
              pClients = _Clients, 
              pOper = _Oper, 
              pSource = _Source, 
              pSourceNum = _SourceNum,
              pNeedCompare = _NeedCompare;
  private var КБК1 = "18210102010011000110";
  private var КБК2 = "18210102070011000110";
  private var КБК3 = "18210102080011000110";
  
  var CompareObjList = TArray();
  var TaxCalculatedSum = $0;
  var TaxCalculated15Sum = $0;
  var TaxPaidSum = $0;
  var TaxPaid15Sum = $0;
  var TaxTransmittedSum = $0;
  var TaxTransmitted15Sum = $0;
  var TaxDueSum = $0;
  var TaxDue15Sum = $0;
  var TaxToReturnDueSum = $0;
  var TaxToReturnDue15Sum = $0;
  var TotalPercentSum = TArray;
  var IsBefore2022 = false;
  var Before2022NPTXObj = NULL;

  /**
   @brief Класс для хранения сумм по ставкам
 */
  class PercentSum
    var Percent : Integer;
    var TaxCalculatedSum : Money;
    var TaxPaidSum : Money;
    var TaxTransmittedSum : Money;
    var TaxDueSum : Money;
    var TaxToReturnDueSum : Money;
  end;

  /**
   @brief Очитка глобальных переменных клиента
  */
  private macro clearGlobal()
    TaxCalculatedSum = $0;
    TaxCalculated15Sum = $0;
    TaxPaidSum = $0;
    TaxPaid15Sum = $0;
    TaxTransmittedSum = $0;
    TaxTransmitted15Sum = $0;
    TaxDueSum = $0;
    TaxDue15Sum = $0;
    TaxToReturnDueSum = $0;
    TaxToReturnDue15Sum = $0;
    TotalPercentSum = TArray;
  END;


  /**
   @brief Получить полный путь к файлу
   @param[in] LoadFile путь к файлу
   @param[out] ClientsArr Массив клиентов
  */
  private macro LoadClientsFromFile(LoadFile, ClientsArr:@TArray)
    var objExcel = CExcelPoi();

    ClientsArr.size = 0;
    
      if(objExcel.open(LoadFile))
        var iLastRow = objExcel.GetLastRowNum()+1;

        InitProgress(iLastRow, "Ждите, выполняется обработка клиентов..", "Выполняется обработка клиентов");
        var curr_row = 1;

        while(curr_row <= iLastRow)

        var PartyID = trim(string(objExcel.CellValue("A"+string(curr_row))));

        if((PartyID == "") or (PartyID == NULL) or (PartyID == "Undefined"))
          break;
        end;

        PartyID = int(StrSubSt(PartyID," ",""));

        ClientsArr[ClientsArr.size] = PartyID;

        UseProgress(curr_row = curr_row + 1);
        end;

        RemProgress();
      end;

    objExcel = null;

  OnError(er)
    MsgBox(er.Message);

    if(objExcel)
    if(objExcel.Book)
      objExcel.Book.Close();
    end;

    objExcel = null;
    end;
  END;

  /**
     @brief Вставить всех клиентов, у которых есть объекты НДР за указанный период в таблицу DNPTX6CLIENT_TMP для дальнейшего использования
     @param [in] BeginDate Дата начала
     @param [in] EndDate Дата окончания
  */
  private macro InsertAllClientsToNPTX6CLIENT(BeginDate:DATE, EndDate:DATE)
    var Year = 0;
    datesplit(EndDate, null, null, Year);

    var queryInsertAll = "INSERT INTO DNPTX6CLIENT_TMP " +
                         "with k as (select t_Element, t_Code, t_TaxBaseKind from dnptxkind_dbt where t_Level in (5) and t_Code like 'PlusG%') " +
                         "SELECT persn.t_PersonID " +
                         "FROM dpersn_dbt persn " +
                         "WHERE exists( " +
                         "               SELECT " + IIF(isSlice, " ", "/*+ index(obj, DNPTXOBJ_DBT_IDX3) */") + " 1 " +
                         "               FROM k, " + TABLE_NPTXOBJ + " obj " +
                         "               WHERE obj.t_Client = persn.t_PersonID " +
                         "                 and obj.t_Date between ? and ? and obj.t_Kind = k.t_Element " +
                                     IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") + 
                         "            ) " +
                         "      or exists( select 1 from " + TABLE_TOTALBASE + " tb " +
                         "                  where tb.t_ClientID = persn.t_PersonID and (tb.t_IncDate between ? and ? or tb.t_TaxPeriod = ?) " +
                                                  IIF(isSlice, " and tb.t_sliceID = " + m_SliceID + " ", " ") + 
                         " ) ";

    var cmdInsertAll = DL_RSDCommand(queryInsertAll);
        cmdInsertAll.AddParam(BeginDate);
        cmdInsertAll.AddParam(EndDate);
        cmdInsertAll.AddParam(BeginDate);
        cmdInsertAll.AddParam(EndDate);
        cmdInsertAll.AddParam(Year);
        cmdInsertAll.ExecuteCMD();
  END;

  /**
   @brief Проверить массив объектов c_CodeNRDMonth на наличие отрицательных сумм
   @param[in] arr Массив объектов c_CodeNRDMonth
   @return true если есть отрицательные суммы
   @return false если нет отрицательных сумм
  */
  private macro hasNegativeSum(arr:@TArray)
    var i = 0;
    while( i < arr.size)
      if(arr[i].Sum < $0.0) return true; end;
      i = i + 1;
    end;
    return false;
  END;

  /**
   @brief Получить КПП и ИНН банка
   @return КПП и ИНН банка
  */
  macro OurInnAndKPP()
    return m_TaxAgentParm.OurInnAndKPP();
  END;

  /**
   @brief Получить ИНН банка
   @return ИНН банка
  */
  macro OurINN()
    var INN = "", KPP = "";
    SplitFullINN(this.OurInnAndKPP(), INN, KPP);
    return INN;
  END;

  /**
   @brief Получить КПП банка
   @return КПП банка
  */
  macro OurKPP()
    var INN = "", KPP = "";
    PRIVATE RECORD OurBankRec("party.dbt");
    
    SplitFullINN(this.OurInnAndKPP(), INN, KPP);

    if(ПолучитьСубъекта({OurBank}, OurBankRec) == 0)
      var str = String(ReadNoteForObject(OBJTYPE_PARTY, UniID(OurBankRec, OBJTYPE_PARTY), 79, pReport_date_end));
      var SlashIndex = Index(str, "/");
      if(SlashIndex > 0)
        return SubStr(str, 1, SlashIndex-1);
      end;

      return str;
    else
      MSGArr[MSGArr.size] = " \";\" \";\"Ошибка получения субъекта " + {OurBank} + " ";
      return KPP;
    end;

    return KPP;
  END;

  /**
   @brief Получить код налогового органа банка
   @return Код налогового органа
  */
  macro OurFNScode()
    return m_TaxAgentParm.OurFNScode();
  END;
  
  /**
   @brief Получить наименование банка
   @return Наименование банка
  */
  macro OurName()
    return m_TaxAgentParm.OurName();
  END;

  /**
   @brief Получить код ОКТМО банка
   @return Код ОКТМО
  */
  macro OurOKTMO()
    return m_TaxAgentParm.OurOKTMO();
  END;

  /**
   @brief Формат печати
   @return DL_OUTREPORT_EXCEL
  */
  private macro PrintMode():integer
    return DL_OUTREPORT_EXCEL;
  END;

  /**
   @brief Добавить суммы по ставке в массив
   @param[in] Percent Ставка
   @param[in] TaxCalculatedSum Общая сумма налога
   @param[in] TaxPaidSum Удержанная сумма налога
   @param[in] TaxTransmittedSum Сумма переданая на взыскание в налоговый орган
   @param[in] TaxDueSum Сумма долга по налогу за налогоплательщиком
   @param[in] TaxToReturnDueSum Сумма долга по налогу за налоговым агентом
  */
  private macro AddPercentSumToArray(Percent, TaxCalculatedSum, TaxPaidSum, TaxTransmittedSum, TaxDueSum, TaxToReturnDueSum)
    var peSum : PercentSum;
    peSum.Percent = Percent;
    peSum.TaxCalculatedSum = TaxCalculatedSum;
    peSum.TaxPaidSum = TaxPaidSum;
    peSum.TaxTransmittedSum = TaxTransmittedSum;
    peSum.TaxDueSum = TaxDueSum;
    peSum.TaxToReturnDueSum = TaxToReturnDueSum;
    TotalPercentSum[TotalPercentSum.size] = peSum;
  END;

  /**
   @brief Получение названия файла
  */
  private macro GetCurrName()
    var Name = substr(string(rep.Name1), 1, 20) + substr(string(rep.Name2), 1, 1) + substr(string(rep.Name3), 1, 1);
    var NameFile = "";

    NameFile = Name + "_" + OurKPP();
    NameFile = NameFile + "_" + OurOKTMO();
    NameFile = NameFile + "_СОФР_" + rep.PartyID;
    NameFile = NameFile + "_регистр по НДФЛ с " + SQL_ConvTypeDate(rep.DateT1) + " по " + SQL_ConvTypeDate(rep.DateT2);

    return NameFile;
  END;
  
  /**
   @brief Получение названия листа
  */
  private macro GetSheetName()
    var NameSheet =  OurKPP() + "_" + OurOKTMO();
    return NameSheet;
  END;

  /**
   @brief Вставка клиентов в темп таблицу
   @param[in] arr Массив клиентов
  */
  private macro insertClientsInTmp (arr)
    var queryInsert = "INSERT INTO DNPTX6CLIENT_TMP ( " +
                      "                                t_PartyID " +
                      "                             ) " +
                      "                      VALUES ( " +
                      "                                ? " +
                      "                             ) ";

    var i = 0;
    while( i < arr.size)
      var cmdInsert = DL_RSDCommand(queryInsert);
      cmdInsert.AddParam(arr[i]);
      cmdInsert.ExecuteCMD();
      i = i + 1;
    end;
  END;

  /**
   @brief Получить идентификатор среза для периода
   @param[in] pBegDate дата начала периода
   @param[in] pEndDate дата конца периода
   @param[in] pNum Номер среза
   @return Идентификатор среза
  */
  private macro getSliceID (pBegDate, pEndDate, pNum)
    var query = "select t_sliceID from DNPTXSLICE_DBT where T_DATEFROM = ? and T_DATETO = ? and t_SliceNum = ? ";
    var cmd = DL_RSDCommand(query);
        cmd.AddParam(pBegDate);
        cmd.AddParam(pEndDate);
        cmd.AddParam(pNum);

    var DataSet = cmd.Execute();
    if(DataSet.MoveNext())
      return DataSet.SliceID;
    end;
    return -1;
  END;

  /**
   @brief Добавить ошибки по клиентам в протокол
  */
  private macro addClientErr()
    var query = "select c.t_partyid from DNPTX6CLIENT_TMP c " +
                " where c.t_partyid not in (select base.t_ClientID from DNPTXSLICEBASE_DBT base " +
                "                            where base.t_sliceId = ?) and  " +
                "       c.t_partyid not in (select obj.t_Client from dnptxsliceobj_dbt obj " +
                "                            where obj.t_sliceId = ?)";

    var cmd = DL_RSDCommand(query);
        cmd.AddParam(m_SliceID);
        cmd.AddParam(m_SliceID);

    var DataSet = cmd.Execute();
    while(DataSet.MoveNext())
      MSGArr[MSGArr.size] = " \";\" \";\"По клиенту с ID = " + DataSet.PartyID + " отсутствуют данные в срезе";
    end;
  END;

  private macro GetSum(ClientID:Integer,
                       StrKind:String,
                       MinDate:Date,
                       MaxDate:Date,
                       SumVal:@Variant,
                       IIS:Integer,
                       AddWhereCond:String,
                       ArrMonth:@TArray)
    var FromOuter = false;
    SumVal = 0.0;
    var Year = 0;
    datesplit(MaxDate, null, null, Year);

    if(isSlice == false)
      AddWhereCond = AddWhereCond +
      IIF(AddWhereCond != "", " AND ( ", " ( ");

      AddWhereCond = AddWhereCond +
        " NOT EXISTS (SELECT "
                  + " 1 "
               + " FROM "
                  + " dnptxobdc_dbt dc "
                 + " ,doproper_dbt opr "
               + " WHERE "
                  + " dc.t_ObjID = obj.t_ObjID "
               + " AND opr.t_ID_Operation = dc.t_DocID "
               + " AND opr.t_DocKind = " + SP_DEPOPER_DEPOACNT + ") "
      + " AND NOT EXISTS (SELECT "
                  + " 1 "
               + " FROM "
                  + " ddppmobj_dbt dp "
               + " WHERE "
                  + " dp.t_ObjID = obj.t_ObjID "
               + " AND dp.t_ObjKind = " + OBJTYPE_NPTXOBJ + ") "
      + " AND NOT EXISTS (SELECT "
                  + " 1 "
               + " FROM "
                  + " dnptxobdc_dbt dc "
                 + " ,doproper_dbt opr "
               + " WHERE "
                  + " dc.t_ObjID = obj.t_ObjID "
               + " AND opr.t_ID_Operation = dc.t_DocID "
               + " AND opr.t_DocKind IN (" + DL_VEKSELDRAWORDER + ", " + DL_VSBARTERORDER + ", " + DL_VSINTERCHANGE + ")) ";

      AddWhereCond = AddWhereCond + " OR ";

      AddWhereCond = AddWhereCond +
        " EXISTS (SELECT "
               + " 1 "
            + " FROM "
               + " dnptxobdc_dbt dc "
              + " ,doproper_dbt opr "
            + " WHERE "
               + " dc.t_ObjID = obj.t_ObjID "
            + " AND opr.t_ID_Operation = dc.t_DocID "
            + " AND opr.t_DocKind IN (" + DL_VEKSELDRAWORDER + ", " + DL_VSBARTERORDER + ", " + DL_VSINTERCHANGE + ")) ";

      AddWhereCond = AddWhereCond +            " ) ";
    end;

    var ObjQuery =  " select nvl(sum(q.t_S), 0) t_S, "
               "      chr(0) as t_ContrNum, " +
               "      q.t_Kind, " +
               "      extract(month from q.t_Date) as t_Month " +
               " from ( ";

    if((IIS == NULL) or (IIS == 0))
      ObjQuery = ObjQuery + "  select obj.t_Sum as t_S, " +
                     "         obj.t_Kind, " +
                     "         CASE WHEN EXTRACT(YEAR FROM obj.t_Date) > "+Year+" THEN TO_DATE('3112"+Year+"','ddmmyyyy') else obj.t_Date end as t_Date " +
                     "  from " + TABLE_NPTXOBJ + " obj " +
                     "  where obj.t_Kind in(" + StrKind + ") " +
                     "    and obj.t_TaxPeriod = "+Year+" "+
                     IIF(ClientID > 0, "  and obj.t_Client = " + string(ClientID), "") +
                     IIF(AddWhereCond != "", "  and " + AddWhereCond, "") +
                     "    and obj.t_FromOutSyst " + IIF(FromOuter,"=","<>") +" chr(88) " +
                                  IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") + 
                     "    and RSI_NPTO.CheckObjIIS(obj.t_AnaliticKind6, t_Analitic6) <> 1 " +
                     "    and ( " +
                     "           ROUND(obj.t_Sum0,2) >= 0.01 " +
                     "           or ROUND(obj.t_Sum0,2) <= -0.01 " +
                     "      ) ";
    end;

    if((IIS == NULL) or (IIS == 1))
      if(IIS == NULL)
        ObjQuery = ObjQuery + " UNION ALL ";
      end;

      var ObjDate = Date(0, 0, 0);

      var CloseContrQuery = " select ( " +
                     "        case " +
                     "          when q.t_FirstIISDate is not NULL" +
                     "          then q.t_FirstIISDate " +
                     "          else q.t_DateBegin " +
                     "        end " +
                     "      ) as t_FirstIISDate, " +
                     "      q.t_DateClose " +
                     " from (" +
                     //Определение даты первого договора ИИС для ДО
                     "      select RSI_NPTO.GetDateFromNoteText(" + string(OBJTYPE_SFCONTR) + ", sfcontr.t_ID, 3) as t_FirstIISDate, " +
                     "           sfcontr.t_DateBegin, " +
                     "           nptxop.t_OperDate as t_DateClose " +
                     "      from dnptxop_dbt nptxop, " +
                     "          dnptxobdc_dbt obdc, " +
                     "          " + TABLE_NPTXOBJ + " obj, " +
                     "          dsfcontr_dbt sfcontr " +
                     "      where " + IIF(MinDate != Date(0, 0, 0), " nptxop.t_OperDate >= " + GetSQLDate(MinDate) + " and ", "") +
                     "          nptxop.t_OperDate <= " + GetSQLDate(MaxDate) +
                     "        and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                     "        and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                     "        and nptxop.t_Client = " + string(ClientID) +
                     "        and nptxop.t_Status > 0 " +
                     "        and obdc.t_DocID = nptxop.t_ID " +
                     "        and obj.t_ObjID = obdc.t_ObjID " +
                     "        and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                                      IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") + 
                     "        and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                     "        and sfcontr.t_ID = obj.t_Analitic6 " +
                     IIF(MinDate != NULL, " and sfcontr.t_DateClose >= " + GetSQLDate(MinDate), "") +
                     "        and sfcontr.t_DateClose <= " + GetSQLDate(MaxDate) +
                     "        and not exists( " +
                     "                   select 1 " +
                     "                   from ddlcontrmp_dbt dlcontrmp " +
                     "                   where dlcontrmp.t_SfContrID = sfcontr.t_ID " +
                     "                 ) " +
                     //Определение даты первого договора ИИС для ДБО
                     "      union " +
                     "      select ( " +
                     "             case " +
                     "               when dlcontr.t_IISTransfer = chr(88) " +
                     "               then dlcontr.t_IISLastOpenDate " +
                     "               else sfcontr.t_DateBegin " +
                     "             end " +
                     "           ) as t_FirstIISDate, " +
                     "           to_date('01.01.0001', 'dd.mm.yyyy') as t_DateBegin," +
                     "           nptxop.t_OperDate as t_DateClose " +
                     "      from ddlcontr_dbt dlcontr, " +
                     "          dsfcontr_dbt subcontr, " +
                     "          ddlcontrmp_dbt dlcontrmp, " +
                     "          dsfcontr_dbt sfcontr, " +
                     "          dnptxop_dbt nptxop, " +
                     "          dnptxobdc_dbt obdc, " +
                     "          " + TABLE_NPTXOBJ + " obj " +
                     "      where " + IIF(MinDate != Date(0, 0, 0), " nptxop.t_OperDate >= " + GetSQLDate(MinDate) + " and ", "") +
                     "          nptxop.t_OperDate <= " + GetSQLDate(MaxDate) +
                     "        and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                     "        and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                     "        and nptxop.t_Client = " + string(ClientID) +
                     "        and obdc.t_DocID = nptxop.t_ID " +
                     "        and obj.t_ObjID = obdc.t_ObjID " +
                     "        and obj.t_AnaliticKind6 = " + string(TXOBJ_KIND6020) +
                                      IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") + 
                     "        and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                     "        and subcontr.t_ID = obj.t_Analitic6 " +
                     "        and " + IIF(MinDate != Date(0, 0, 0), " subcontr.t_DateClose >= " + GetSQLDate(MinDate) + " and ", "") +
                     "            subcontr.t_DateClose <= " + GetSQLDate(MaxDate) +
                     "        and dlcontrmp.t_SfContrID = subcontr.t_ID " +
                     "        and dlcontr.t_DlContrID = dlcontrmp.t_DlContrID " +
                     "        and sfcontr.t_ID = dlcontr.t_SfContrID " +
                     "    ) q " +
                     " where ROWNUM = 1 " +
                     " order by q.t_FirstIISDate ";

      var CloseContrSleect = DL_RSDCommand(CloseContrQuery);
      var CloseContrDS = CloseContrSleect.Execute();
      if(CloseContrDS.MoveNext)
        MinDate = Date(CloseContrDS.FirstIISDate);
        ObjDate = CloseContrDS.DateClose;
      end;

      ObjQuery = ObjQuery + " select obj.t_Sum as t_S, " +
                       "      obj.t_Kind, " +
                       IIF(ObjDate != Date(0, 0, 0), GetSQLDate(ObjDate), " CASE WHEN EXTRACT(YEAR FROM obj.t_Date) > "+Year+" THEN TO_DATE('3112"+Year+"','ddmmyyyy') else obj.t_Date end ") + " as t_Date " +
                       " from " + TABLE_NPTXOBJ + " obj " +
                       " where obj.t_Kind in (" + StrKind + ") " +
                       IIF(ClientID > 0, " and obj.t_Client = " + string(ClientID), "") +
                       "  and obj.t_TaxPeriod = "+Year+" " +
                       IIF(AddWhereCond != "", " and " + AddWhereCond, "") +
                       "  and obj.t_FromOutSyst " + IIF(FromOuter, "=", "<>") + " chr(88) " +
                                    IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") + 
                       "  and rsi_npto.CheckObjIIS(obj.t_AnaliticKind6, obj.t_Analitic6) = 1 " +
                       "  and exists ( " +
                       "            select 1 " +
                       "            from dnptxop_dbt nptxop " +
                       "            where nptxop.t_Client = " + string(ClientID) +
                       "             and nptxop.t_DocKind = " + string(DL_CALCNDFL) +
                       "             and nptxop.t_SubKind_Operation = " + string(DL_TXBASECALC_OPTYPE_CLOSE_IIS) +
                       "             and nptxop.t_OperDate between " + GetSQLDate(MinDate) + " and " + GetSQLDate(MaxDate) +
                       "             and nptxop.t_Status > 0 " +
                       "          ) " +
                       "  and ( " +
                       "       ROUND(obj.t_Sum0,2) >= 0.01 " +
                       "       or ROUND(obj.t_Sum0,2) <= -0.01 " +
                       "     ) ";
    end;

    ObjQuery = ObjQuery + " ) q " +
             " group by extract(month from q.t_Date), q.t_Kind";

    var ObjCmd = DL_RSDCommand(ObjQuery);
    var groupInd = -1;
    var ObjDS = ObjCmd.Execute();

    while(ObjDS.MoveNext())
      var MSCode;
      var MSnnn = 0;
      var PSCode;
      var PSnnn = 0;
      SumVal = SumVal + ExtRound(ObjDS.S);
      ArrMonth[ArrMonth.size] = c_NRDMonth(ObjDS.Month, ObjDS.S);
    end;
  END;

  /**
   @brief Получить сумму массива до индекса
   @param[in] Arr Массив
   @param[in] index Индекс
   @return Сумма массива до индекса
  */
  private macro GetSumForMonthWithPrev(Arr, index)
    var i = 1;
    var sum = $0.0;
    while(i < Arr.Size)
      sum = sum + Arr[i];
      if(i == index)
        break;
      end;
      i = i + 1;
    end;
    return sum;
   END;

  /**
   @brief Получить сумму массива
   @param[in] Arr Массив
   @return Сумма массива
  */
  private macro getSumArr(Arr)
    var i = 1;
    var sum = $0.0;
    while (i < Arr.size)
      sum = sum + Arr[i];
      i = i + 1;
    end; 
    return sum;
  end;

  /**
   @brief Получение проинициализированного массива сумм
   @return Массив нулевых сумм с 1 по 12 элемент
   Получение проинициализированного массива нулевых сумм с 1 по 12 элемент
  */
  private macro initArrCodeLine()
    var ArrCodeLine = TArray;
    var i = 1;
    while (i <= 12)
      ArrCodeLine[i] = $0;
      i = i + 1;
    end; 
    return ArrCodeLine;
  end;

  /**
   @brief Проверка наличия элемента с кодом CodeNum в массиве
   @param[in] Arr Массив объектов c_CodeNRDMonth
   @param[in] CodeNum Номер кода
   @return Если найдено: индекс найденного элемента
   @return Если не найдено: -1
  */
  private macro hasCode(Arr, CodeNum)
    var i = 0;
    while (i < Arr.size)
      if(Arr[i].CodeNum == CodeNum)
        return i;
      end;
      i = i + 1;
    end; 
    return -1;
  end;

  /**
   @brief Получить c_NRDMonth с масимальной суммой за месяц
   @param[in] Arr Массив объектов c_CodeNRDMonth
   @param[in] Month Месяц
   @param[out] Id Идентификатор найденой записи
   @return c_NRDMonth с масимальной суммой за месяц
  */
  private macro GetNDRMaxSum(Arr:@TArray, Month, Id:@Integer)
    var i = 0;
    var maxNDR = @Arr[i].GetNDRForMonth(Month);
    Id = i;

    while(i < Arr.Size)
      if( Arr[i].GetNDRForMonth(Month).Sum > maxNDR.Sum ) 
          Id = i;
          maxNDR = @Arr[i].GetNDRForMonth(Month);
      end;

      i = i + 1;
    end;
      
    return maxNDR;
  END;

  /**
   @brief Получить идентификатор объекта c_CodeNRDMonth в массиве по номеру кода 
   @param[in] Arr Массив c_CodeNRDMonth
   @param[in] CodeNum Номер кода
   @return Идентификатор объекта c_CodeNRDMonth в массиве
  */
  PRIVATE MACRO GetIdByCodeNum(Arr:@TArray, CodeNum)
    var i = 0;
    while(i < Arr.Size)
      if( Arr[i].CodeNum == CodeNum ) 
        return i;
      end;
      i = i + 1;
    end;
      
    return -1;
  END;

  /**
   @brief Получить массив c_CodeNRDMonth за месяц без нулевых сумм
   @param[in] Month Месяц
   @param[in] Arr Массив c_CodeNRDMonth 
   @return Массив c_CodeNRDMonth за месяц без нулевых сумм
  */
  private macro GetArrForMonthNotNull(Month, Arr:@TArray)
    var i = 0;
    var ArrForMonth = TArray();
    while(i < Arr.Size)
      if(Arr[i].GetNDRForMonth(Month).Sum != $0.0) 
        ArrForMonth[ArrForMonth.size] = c_CodeNRDMonth(Arr[i].kind, Arr[i].Code, Arr[i].CodeNum, TArray( Arr[i].ArrSumMount ));
      end;
      i = i + 1;
    end;
    return ArrForMonth;
  END;

  /**
   @brief Убрать отрицательные суммы по коду
   @param[in] Arr Массив c_NRDMonth 
  */
  private macro SliceNegativeSumCode(arr:@TArray)
    var i = arr.size - 1;
    
    arr.sort(@SortBySum);
    
    while (i >= 0 )
      var newSum = arr[i].Sum + arr[0].Sum;
      if(newSum > 0) 
        arr[0].Sum = newSum;
        DeleteFromArr(arr, i);
        i = i - 1;
      if(hasNegativeSum(arr) == false) BREAK; end;
      elif(newSum == 0)
        DeleteFromArr(arr, i);
        DeleteFromArr(arr, 0);
        i = i - 2;
      else
        arr[i].Sum = newSum;
        DeleteFromArr(arr, 0);
        i = i - 1;
        if(hasNegativeSum(arr) == false) BREAK; end;
      end;
    end;
  END;

  /**
   @brief Убрать отрицательные суммы 
   @param[in] Arr Массив c_CodeNRDMonth 
  */
  private macro SliceNegativeSum(arr:@TArray)
    var i = 0;
      
    while( i < arr.size)
      if(hasNegativeSum(arr[i].ArrSumMount))
        SliceNegativeSumCode(arr[i].ArrSumMount);
        if(arr[i].ArrSumMount.size == 0) 
          DeleteFromArr(arr, i)
        end;
      end;
      i = i + 1;
    end;
  END;

  /**
   @brief Найти массив кодов с положительной суммой
   @param[in] ArrMonthNOB Массив c_MonthsNOB 
   @param[in] CodeNum Номер кода
   @param[in] Num Начальный индекс
   @param[out] Month Найденный месяц
   @return NULL если не найдено
   @return Массив кодов если найдено
  */
  private macro FindMonthNOBPositiveForCode(ArrMonthNOB:@TArray, CodeNum, Num, Month:@Integer)
    var i = Num - 1;
    var iCode = 0;
      
    while(i != Num)
        
      iCode = 0;
      while(iCode < ArrMonthNOB[i].ArrCodes.size)
        if( (ArrMonthNOB[i].ArrCodes[iCode].Sum > 0) and (ArrMonthNOB[i].ArrCodes[iCode].Plus.CodeNum == CodeNum))
          Month = ArrMonthNOB[i].Month;
          return ArrMonthNOB[i].ArrCodes[iCode];
        end;
        iCode = iCode + 1;
      end;
        
      i = i - 1;
      if(i <= -1)
        i = ArrMonthNOB.size - 1;
      end;

    end;
    return NULL;
  END;

  /**
   @brief Удалить все месяца кроме переданного
   @param[in, out] Arr Массив c_CodeNRDMonth 
   @param[in] Month Месяц
  */
  private macro CutAllMonthExceptOne(Arr:@TArray, Month)
    var i = 0;
    var mounth = 0;

    while(i < Arr.Size)
      mounth = 0;
      while(mounth < Arr[i].ArrSumMount.Size)
        if( Arr[i].ArrSumMount[mounth].Month != Month)
          DeleteFromArr(@Arr[i].ArrSumMount, mounth);
        else
          mounth = mounth + 1;
        end;
      end;
      i = i + 1;
    end;
  END;

  /**
   @brief Получить массив вычета НДР по коду дохода
   @param[in] Kind Код НДР дохода
   @param[in] ArrMinus Массив кодов вычета c_CodeNRDMonth 
   @param[in] Month Месяц
   @note см. Таблица 11 чтз_форма_6-НДФЛ_2024
   @return Массив вычета НДР по коду дохода
  */
  private macro GetMinusForPlus(Kind, ArrMinus, Month)
    var MinusKindArr = TArray();
    var MinusForPlusArr = TArray();
      
    if(Kind == TXOBJ_PLUSG_1530)
      MinusKindArr[MinusKindArr.size] = 201;
      MinusKindArr[MinusKindArr.size] = 218;
      MinusKindArr[MinusKindArr.size] = 222;
      MinusKindArr[MinusKindArr.size] = 208;
      MinusKindArr[MinusKindArr.size] = 618;
    elif(Kind == TXOBJ_PLUSG_1531)
      MinusKindArr[MinusKindArr.size] = 202;
      MinusKindArr[MinusKindArr.size] = 219;
      MinusKindArr[MinusKindArr.size] = 223;
    elif(Kind == TXOBJ_PLUSG_1532)
      MinusKindArr[MinusKindArr.size] = 205;
      MinusKindArr[MinusKindArr.size] = 206;
      MinusKindArr[MinusKindArr.size] = 209;
      MinusKindArr[MinusKindArr.size] = 220;
    elif(Kind == TXOBJ_PLUSG_1533)
      MinusKindArr[MinusKindArr.size] = 220;
    elif(Kind == TXOBJ_PLUSG_1535)
      MinusKindArr[MinusKindArr.size] = 207;
      MinusKindArr[MinusKindArr.size] = 210;
    elif(Kind == TXOBJ_PLUSG_1536)
      MinusKindArr[MinusKindArr.size] = 203;
      MinusKindArr[MinusKindArr.size] = 224;
    elif(Kind == TXOBJ_PLUSG_1537)
      MinusKindArr[MinusKindArr.size] = 211;
    elif(Kind == TXOBJ_PLUSG_1539)
      MinusKindArr[MinusKindArr.size] = 213;
    elif(Kind == TXOBJ_PLUSG_1544)
      MinusKindArr[MinusKindArr.size] = 225;
      MinusKindArr[MinusKindArr.size] = 233;
      MinusKindArr[MinusKindArr.size] = 239;
      MinusKindArr[MinusKindArr.size] = 251;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1545)
      MinusKindArr[MinusKindArr.size] = 226;
      MinusKindArr[MinusKindArr.size] = 234;
      MinusKindArr[MinusKindArr.size] = 240;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1546)
      MinusKindArr[MinusKindArr.size] = 228;
      MinusKindArr[MinusKindArr.size] = 250;
      MinusKindArr[MinusKindArr.size] = 252;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1547)
      MinusKindArr[MinusKindArr.size] = 235;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1548)
      MinusKindArr[MinusKindArr.size] = 229;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1549)
      MinusKindArr[MinusKindArr.size] = 227;
      MinusKindArr[MinusKindArr.size] = 236;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1551)
      MinusKindArr[MinusKindArr.size] = 230;
      MinusKindArr[MinusKindArr.size] = 619;
    elif(Kind == TXOBJ_PLUSG_1553)
      MinusKindArr[MinusKindArr.size] = 231;
      MinusKindArr[MinusKindArr.size] = 619;
    end;
 
    var iNDR = -1;
    var iKind = -1;
    while((iNDR = iNDR + 1) < ArrMinus.size)
      iKind = -1;
      while((iKind = iKind + 1) < MinusKindArr.size)
        if(ArrMinus[iNDR].CodeNum == MinusKindArr[iKind])
          if(ArrMinus[iNDR].GetNDRForMonth(Month).Sum > 0)
            MinusForPlusArr[MinusForPlusArr.size] = c_CodeNRDMonth(ArrMinus[iNDR].kind, ArrMinus[iNDR].Code, ArrMinus[iNDR].CodeNum, TArray());
            ArrMinus[iNDR].GetNDRForMonth(Month).isUse = true;
            MinusForPlusArr[MinusForPlusArr.size-1].ArrSumMount[0] = c_NRDMonth(Month, ArrMinus[iNDR].GetNDRForMonth(Month).Sum);
          end;
        end;
      end;
    end;

    return MinusForPlusArr;
  END;

  /**
   @brief Получить параметры дохода НДР по виду вычета
   @param[in] Kind Вид НДР вычета
   @param[out] KindPlus Вид дохода
   @param[out] CodePlus Код дохода
   @param[out] CodeNumPlus Номер кода дохода
   @note Код дохода берется любой из соответствующих
   Необходимо для вставки кодов вычетов у которых нет соответствующих доходов
  */
  PRIVATE MACRO GetPlusNullNDRForMinus(Kind, KindPlus:@Integer, CodePlus:@String, CodeNumPlus:@String);

    if( (Kind == TXOBJ_MINUSG_201) or
        (Kind == TXOBJ_MINUSG_218) or
        (Kind == TXOBJ_MINUSG_222) or
        (Kind == TXOBJ_MINUSG_208) or
        (Kind == TXOBJ_MINUSG_618)
      )
      CodePlus = "TXOBJ_PLUSG_1530";
      CodeNumPlus = "1530";
      KindPlus = TXOBJ_PLUSG_1530;
    elif( (Kind == TXOBJ_MINUSG_202) or
          (Kind == TXOBJ_MINUSG_219) or
          (Kind == TXOBJ_MINUSG_223)
        )
      CodePlus = "TXOBJ_PLUSG_1531";
      CodeNumPlus = "1531";
      KindPlus = TXOBJ_PLUSG_1531;
    elif( (Kind == TXOBJ_MINUSG_205) or
          (Kind == TXOBJ_MINUSG_206) or
          (Kind == TXOBJ_MINUSG_209) or
          (Kind == TXOBJ_MINUSG_220)
        )
      CodePlus = "TXOBJ_PLUSG_1532";
      CodeNumPlus = "1532";
      KindPlus = TXOBJ_PLUSG_1532;
    elif(Kind == TXOBJ_MINUSG_220)
      CodePlus = "TXOBJ_PLUSG_1533";
      CodeNumPlus = "1533";
      KindPlus = TXOBJ_PLUSG_1533;
    elif( (Kind == TXOBJ_MINUSG_207) or
          (Kind == TXOBJ_MINUSG_210)
        )
      CodePlus = "TXOBJ_PLUSG_1535";
      CodeNumPlus = "1535";
      KindPlus = TXOBJ_PLUSG_1535;
    elif( (Kind == TXOBJ_MINUSG_203) or
          (Kind == TXOBJ_MINUSG_224)
        )
      CodePlus = "TXOBJ_PLUSG_1536";
      CodeNumPlus = "1536";
      KindPlus = TXOBJ_PLUSG_1536;
    elif(Kind == TXOBJ_MINUSG_211)
      CodePlus = "TXOBJ_PLUSG_1537";
      CodeNumPlus = "1537";
      KindPlus = TXOBJ_PLUSG_1537;
    elif(Kind == TXOBJ_MINUSG_213)
      CodePlus = "TXOBJ_PLUSG_1539";
      CodeNumPlus = "1539";
      KindPlus = TXOBJ_PLUSG_1539;
    elif( (Kind == TXOBJ_MINUSG_225) or 
          (Kind == TXOBJ_MINUSG_233) or 
          (Kind == TXOBJ_MINUSG_239) or 
          (Kind == TXOBJ_MINUSG_251)
        )
      CodePlus = "TXOBJ_PLUSG_1544";
      CodeNumPlus = "1544";
      KindPlus = TXOBJ_PLUSG_1544;
    elif( (Kind == TXOBJ_MINUSG_226) or 
          (Kind == TXOBJ_MINUSG_234) or 
          (Kind == TXOBJ_MINUSG_240) 
        )
      CodePlus = "TXOBJ_PLUSG_1545";
      CodeNumPlus = "1545";
      KindPlus = TXOBJ_PLUSG_1545;
    elif( (Kind == TXOBJ_MINUSG_228) or 
          (Kind == TXOBJ_MINUSG_250) or 
          (Kind == TXOBJ_MINUSG_252) 
        )
      CodePlus = "TXOBJ_PLUSG_1546";
      CodeNumPlus = "1546";
      KindPlus = TXOBJ_PLUSG_1546;
    elif(Kind == TXOBJ_MINUSG_235)
      CodePlus = "TXOBJ_PLUSG_1547";
      CodeNumPlus = "1547";
      KindPlus = TXOBJ_PLUSG_1547;
    elif(Kind == TXOBJ_MINUSG_229)
      CodePlus = "TXOBJ_PLUSG_1548";
      CodeNumPlus = "1548";
      KindPlus = TXOBJ_PLUSG_1548;
    elif( (Kind == TXOBJ_MINUSG_227) or 
          (Kind == TXOBJ_MINUSG_236) 
        )
      CodePlus = "TXOBJ_PLUSG_1549";
      CodeNumPlus = "1549";
      KindPlus = TXOBJ_PLUSG_1549;
    elif(Kind == TXOBJ_MINUSG_230)
      CodePlus = "TXOBJ_PLUSG_1551";
      CodeNumPlus = "1551";
      KindPlus = TXOBJ_PLUSG_1551;
    elif(Kind == TXOBJ_MINUSG_231)
      CodePlus = "TXOBJ_PLUSG_1553";
      CodeNumPlus = "1553";
      KindPlus = TXOBJ_PLUSG_1553;
    end;
  END;

  /**
   @brief Добавить 619 вычет к коду
   @param[in, out] sum Сумма
   @param[in, out] NOBCode Объект НОБ
   @param[in] mounth месяц
  */
  private macro addMinus619ToNOB(sum:@Money, NOBCode, mounth)
    var MinusArr = TArray();
    if(sum - NOBCode.sum > 0)
      MinusArr = TArray();
      MinusArr[MinusArr.size] = c_NRDMonth( mounth, NOBCode.sum);
      NOBCode.ArrMinus[NOBCode.ArrMinus.size] = c_CodeNRDMonth(TXOBJ_MINUSG_619, "TXOBJ_MINUSG_619", "619", MinusArr);
      sum = sum - NOBCode.sum;
      NOBCode.sum = $0.0;
    else
      MinusArr = TArray();
      MinusArr[MinusArr.size] = c_NRDMonth(mounth, sum);
      NOBCode.ArrMinus[NOBCode.ArrMinus.size] = c_CodeNRDMonth(TXOBJ_MINUSG_619, "TXOBJ_MINUSG_619", "619", MinusArr);
      NOBCode.sum = NOBCode.sum - sum;
      sum = $0.0;
    end;
  END;

  /**
   @brief Добавить 619 вычеты
   @param[in, out] ArrMonthNOB Массив объектов c_MonthsNOB
   @param[in] Minus619 c_CodeNRDMonth 619 вычетов
  */
  private macro add619(ArrMonthNOB, Minus619)
    var MonthNOB;
    var NOBCode;
    var sum = $0.0;

    for(MonthNOB, ArrMonthNOB)
      sum = Minus619.GetNDRForMonth(MonthNOB.Month).sum;
      if(sum > 0)
        if(MonthNOB.GetNOBByCode(1544).sum > 0)
          NOBCode = MonthNOB.GetNOBByCode(1544);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1545).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1545);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1546).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1546);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1547).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1547);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1548).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1548);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1549).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1549);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1551).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1551);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        elif( (MonthNOB.GetNOBByCode(1553).sum > 0) and (sum > 0))
          NOBCode = MonthNOB.GetNOBByCode(1553);
          addMinus619ToNOB(@sum, NOBCode, MonthNOB.Month);
        end;
      end;
    end;
  END;

  /**
   @brief Парсинг кодов по месяцам
   @param[in] ArrPlus Массив объектов c_CodeNRDMonth доходов
   @param[in] ArrMinus Массив объектов c_CodeNRDMonth вычетов
   @param[in] Arr619 Массив объектов c_CodeNRDMonth 619 вычетов
   @note см. чтз_форма_6-НДФЛ_2024 3.4.3 Пример 2
   @return Объект кодов, распределенных по месяцам
  */
  PRIVATE MACRO ParsArrSum(ArrPlus, ArrMinus, Minus619)
    var mounth = 1;
    var ArrMinusForPlus = TArray();
    var ArrPlusForMonth = TArray();
    var ArrMonthNOB = TArray();
    var isChange = false;
    var iMinusArr = 0;
    var Sum = $0.0;
    var PlusForMonth;
    var MinusForPlus;
    var arrCodesForMonth = TArray();
    var KindPlus = 0;
    var CodePlus = "";
    var CodeNumPlus = "";

    while(mounth <= 12)
      ArrPlusForMonth = GetArrForMonthNotNull(mounth, ArrPlus);
      CutAllMonthExceptOne(ArrPlusForMonth, mounth);
      arrCodesForMonth = TArray();
      for(PlusForMonth, ArrPlusForMonth)
        Sum = $0.0;
        ArrMinusForPlus = GetMinusForPlus(PlusForMonth.Kind, ArrMinus, mounth);//связываем коды от дохода к вычету
        
        for(MinusForPlus, ArrMinusForPlus)
          Sum = Sum - MinusForPlus.GetNDRForMonth(mounth).Sum;
        end;
          
        Sum = Sum + PlusForMonth.GetNDRForMonth(mounth).Sum;
        arrCodesForMonth[arrCodesForMonth.size] = c_CodesForMonthNOB(PlusForMonth, ArrMinusForPlus, Sum);
      end;

      iMinusArr = 0;
      while(iMinusArr < ArrMinus.size)
        if( (ArrMinus[iMinusArr].GetNDRForMonth(mounth).Sum > 0) and (ArrMinus[iMinusArr].GetNDRForMonth(mounth).isUse == false) )
                                                                              //обрабатываем коды вычета, не использованные ранее 
          ArrPlusForMonth = TArray();
          GetPlusNullNDRForMinus(ArrMinus[iMinusArr].Kind, @KindPlus, @CodePlus, @CodeNumPlus);
              //для учета кода вычета необходим код дохода, если ранее он не найден получаем любой подходящий (выводится он не будет)
          ArrPlusForMonth[ArrPlusForMonth.size] = c_CodeNRDMonth(KindPlus, CodePlus, CodeNumPlus, TArray());
          ArrPlusForMonth[ArrPlusForMonth.size-1].ArrSumMount[0] = c_NRDMonth(mounth, $0);
          ArrMinusForPlus = GetMinusForPlus(KindPlus, ArrMinus, mounth);
          arrCodesForMonth[arrCodesForMonth.size] = c_CodesForMonthNOB(ArrPlusForMonth[ArrPlusForMonth.size-1], ArrMinusForPlus, - ArrMinus[iMinusArr].GetNDRForMonth(mounth).Sum);
        end;
        iMinusArr = iMinusArr + 1;
      end;

      if(arrCodesForMonth.size > 0)
          ArrMonthNOB[ArrMonthNOB.size] = c_MonthsNOB(arrCodesForMonth, mounth);
      end;
        
      mounth = mounth + 1;
    end;

    ArrMonthNOB.sort(@SortByMonth);
    mounth = ArrMonthNOB.size;
    while((mounth = mounth - 1) > 0)
      var Codes;
      for(Codes, ArrMonthNOB[mounth].ArrCodes)
        if(Codes.Sum < $0.0)
          var MonthGR2 = -1;
          var GR2 = FindMonthNOBPositiveForCode(@ArrMonthNOB, Codes.Plus.CodeNum, mounth, @MonthGR2);
          
          if(GR2 == NULL) CONTINUE; end;
          if(Codes.ArrMinus.size == 0) CONTINUE; end;
          var IdArrMinus = -1;
          var NDRNegative = GetNDRMaxSum(Codes.ArrMinus, ArrMonthNOB[mounth].Month, @IdArrMinus);
          var SumChange =  Min(Min(NDRNegative.Sum, GR2.Sum), Abs(Codes.Sum) );
          var IdMinusCode = GetIdByCodeNum(ArrMinus, Codes.ArrMinus[IdArrMinus].CodeNum);
          
          ArrMinus[IdMinusCode].GetNDRForMonth(MonthGR2, true).Sum = ArrMinus[IdMinusCode].GetNDRForMonth(MonthGR2).Sum  + SumChange;
          ArrMinus[IdMinusCode].GetNDRForMonth(ArrMonthNOB[mounth].Month).Sum = ArrMinus[IdMinusCode].GetNDRForMonth(ArrMonthNOB[mounth].Month).Sum - SumChange;
            
          isChange = true;
        end;
      end;
    end;
      
    if(isChange)
      ArrMonthNOB = ParsArrSum(ArrPlus, ArrMinus, Minus619);
    end;

    add619(ArrMonthNOB, Minus619);

    return ArrMonthNOB;
  END;

  /**
   @brief Парсинг кодов по ставкам
   @param[in] ArrNOB Массив объектов c_MonthsNOB
   @param[in] NOB_13 НОБ по основной ставке
   @param[in] ArrPlus Массив объектов c_CodeNRDMonth доходов
   @param[out] RateMain Массив кодов по основной ставке
   @param[out] Rate15 Массив кодов по ставке 15
  */
  private macro ParsByRate(ArrNOB, NOB_13, ArrPlus, RateMain, Rate15)
    var S_code = $0;
    var S_sum = $0;
    var S_13code = $0;
    var NOB;
    var Code = 0;
    var EndMainNob = false;

    for(NOB, ArrNOB)
      for(Code, ArrPlus)
        var NOBCode = NOB.GetNOBByCode(Code.CodeNum);
          
        if((NOBCode.Plus.Kind > 0))
          S_sum = S_sum + NOBCode.Sum;
        
          if( (S_sum < NOB_13) or (NOB_13 < 0))
            RateMain[RateMain.size] = c_MonthsNOB(c_CodesForMonthNOB(NOBCode.Plus,NOBCode.ArrMinus,NOBCode.Sum), NOB.Month);
          elif(EndMainNob == false)
            S_code = NOBCode.Plus.GetNDRForMonth(NOB.Month).Sum;
            S_13code = S_code - (S_sum - NOB_13);
            
            NOBCode.Plus.GetNDRForMonth(NOB.Month).Sum = S_13code; 
            NOBCode.Sum = NOBCode.Sum - (S_code - S_13code); 

            var  NRDMonthOne = TArray(); 
            NRDMonthOne[0] = c_NRDMonth(NOB.Month, S_13code);
            RateMain[RateMain.size] = c_MonthsNOB(c_CodesForMonthNOB(c_CodeNRDMonth(NOBCode.Plus.Kind, NOBCode.Plus.Code, NOBCode.Plus.CodeNum, NRDMonthOne ),NOBCode.ArrMinus,NOBCode.Sum), NOB.Month);
            
            NOBCode.Plus.GetNDRForMonth(NOB.Month).Sum = S_code - S_13code;
            NOBCode.Sum = S_code - S_13code;
            NOBCode.ArrMinus = TArray();
          
            EndMainNob = true;
          end;
          if(EndMainNob)
            Rate15[Rate15.size] = c_MonthsNOB(c_CodesForMonthNOB(NOBCode.Plus,NOBCode.ArrMinus,NOBCode.Sum), NOB.Month);
          end;
        end;
      end;
    end;
  END;

  /**
   @brief Получение кодов доходов/вычетов
   @param[in] ClientID Идентификатор клиента
   @param[in] BeginDate Дата начала отбора
   @param[in] EndDate Дата окончания отбора
   @param[in] Rate13Sum НОБ основной ставке
   @param[in] Rate15Sum НОБ по ставке 15
   @param[out] Rate13 Массив кодов по основной ставке
   @param[out] Rate15 Массив кодов по ставке 15
  */
  private macro CollectAllArrCodeParm(ClientID, BeginDate, EndDate, Rate13Sum, Rate15Sum, Rate13:@TArray, Rate15:@TArray)
    var queryPlus, cmdPlus, DataSetPlus;
    var queryMinus, cmdMinus, DataSetMinus;
    var ArrPlus = TArray();
    var ArrMinus = TArray();
    var Minus619 = c_CodeNRDMonth(TXOBJ_MINUSG_619, "TXOBJ_MINUSG_619", "619", TArray());

    //Формируем суммы доходов и вычетов в единую таблицу (массив)
    queryPlus =    " with k as (select t_Element, t_Code, t_TaxBaseKind from dnptxkind_dbt where t_Level in (5) and t_Code like 'PlusG%'), "
                 + "      m as (select t_Element, t_Code, t_TaxBaseKind from dnptxkind_dbt where t_Code like 'MinusG%')"
                 + " select q.ObjMonth, q.t_Kind as PlusKind, q.t_Code as PlusCode, NVL(SUM(q.t_Sum0), 0) as PlusSum, regexp_substr(q.t_Code, '[[:digit:]]+') as PlusCodeNum "
                 + "   from (select " + IIF(isSlice, " ", "/*+ index(obj, DNPTXOBJ_DBT_IDX3) */") + " Extract(month from obj.t_Date) as ObjMonth, obj.t_Sum0, k.t_Code, "
                 + "                (case when obj.t_Kind IN ("+TXOBJ_PLUSG_3023+","+TXOBJ_PLUSG_1011_1+","+TXOBJ_PLUSG_1011_2+","+TXOBJ_PLUSG_1011_3+","+TXOBJ_PLUSG_1011_1_IIS+","+TXOBJ_PLUSG_1011_2_IIS+","+TXOBJ_PLUSG_1011_3_IIS+") "
                 + "                           and Exists(select " + IIF(isSlice, " ", "/*+ index(objM, DNPTXOBJ_DBT_IDX3) */") + " 1 "
                 + "                                        from m, " + TABLE_NPTXOBJ + " objM "
                 + "                                       where objM.t_Client = obj.t_Client "
                 + "                                         and objM.t_Date between ? and ? "
                 + "                                         and objM.t_Kind = m.t_Element "
                 +                                           IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                 + "                                         and (objM.t_Technical = CHR(0) or objM.t_Technical is null) "
                 + "                                         and m.t_TaxBaseKind = k.t_TaxBaseKind "
                 + "                                         and NPTO.CheckContrIIS(obj.t_Analitic6) = NPTO.CheckContrIIS(objM.t_Analitic6) "
                 + "                                      ) then (case when obj.t_Kind = "+TXOBJ_PLUSG_3023  +" then "+TXOBJ_PLUSG_1530
                 + "                                                   when obj.t_Kind = "+TXOBJ_PLUSG_1011_1+" then "+TXOBJ_PLUSG_1530
                 + "                                                   when obj.t_Kind = "+TXOBJ_PLUSG_1011_2+" then "+TXOBJ_PLUSG_1536
                 + "                                                   when obj.t_Kind = "+TXOBJ_PLUSG_1011_3+" then "+TXOBJ_PLUSG_1531
                 + "                                                   when obj.t_Kind = "+TXOBJ_PLUSG_1011_1_IIS+" then "+TXOBJ_PLUSG_1544
                 + "                                                   when obj.t_Kind = "+TXOBJ_PLUSG_1011_2_IIS+" then "+TXOBJ_PLUSG_1549
                 + "                                                   when obj.t_Kind = "+TXOBJ_PLUSG_1011_3_IIS+" then "+TXOBJ_PLUSG_1545
                 + "                                                   else 0 end) "
                 + "                      else obj.t_Kind end) as t_Kind "
                 + "           from k, " + TABLE_NPTXOBJ + " obj "
                 + "          where obj.t_Client = ? "
                 + "            and obj.t_Date between ? and ? "
                 + "            and obj.t_Kind = k.t_Element "
                 +              IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                 + "            and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                 + "            and 1 = (case when obj.t_Kind = " + TXOBJ_PLUSG_1011 + " and obj.t_Sum0 = NVL((select SUM(obj1.t_Sum0) "
                 + "                                                                                  from " + TABLE_NPTXOBJ + " obj1 "
                 + "                                                                                 where obj1.t_Client = obj.t_Client "
                 + "                                                                                   and obj1.t_Date = obj.t_Date " 
                 + "                                                                                   and obj1.t_Kind IN ("+TXOBJ_PLUSG_1011_1+","+TXOBJ_PLUSG_1011_2+","+TXOBJ_PLUSG_1011_3+")"
                 + "                                                                                   and obj1.t_AnaliticKind6 = obj.t_AnaliticKind6 "   
                 + "                                                                                   and obj1.t_Analitic6 = obj.t_Analitic6 "   
                 +                                                                                     IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                 + "                                                                               ),0) then 0 "
                 + "                          else 1 end) "
                 + "            and 1 = (case when obj.t_Kind = " + TXOBJ_PLUSG_1011_IIS + " and obj.t_Sum0 = NVL((select SUM(obj1.t_Sum0) "
                 + "                                                                                      from " + TABLE_NPTXOBJ + " obj1 "
                 + "                                                                                     where obj1.t_Client = obj.t_Client "
                 + "                                                                                       and obj1.t_Date = obj.t_Date "
                 + "                                                                                       and obj1.t_Kind IN ("+TXOBJ_PLUSG_1011_1_IIS+","+TXOBJ_PLUSG_1011_2_IIS+","+TXOBJ_PLUSG_1011_3_IIS+")"
                 + "                                                                                       and obj1.t_AnaliticKind6 = obj.t_AnaliticKind6 "
                 + "                                                                                       and obj1.t_Analitic6 = obj.t_Analitic6 "
                 +                                                                                         IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                 + "                                                                                   ), 0) then 0 "
                 + "                          else 1 end) "
                 + "        ) q " 
                 + "  group by q.ObjMonth, q.t_Kind, q.t_Code "
                 + "  order by q.t_Code ASC, q.ObjMonth ASC";

    cmdPlus = DL_RSDCommand(queryPlus);

    cmdPlus.AddParam(BeginDate);
    cmdPlus.AddParam(EndDate);
    cmdPlus.AddParam(ClientID);
    cmdPlus.AddParam(BeginDate);
    cmdPlus.AddParam(EndDate);

    DataSetPlus = cmdPlus.Execute();
    var prevObjMonth = 0;
    var ArrPlusM = TArray();
    var prevVal = NULL;

    while(DataSetPlus.moveNext())
      if((prevVal != NULL) and (prevVal.Kind != DataSetPlus.PlusKind))
         ArrPlus[ArrPlus.size] = prevVal;
         ArrPlusM = TArray();
      end;
      ArrPlusM[ArrPlusM.size] = c_NRDMonth(DataSetPlus.ObjMonth, DataSetPlus.PlusSum);
      prevVal = c_CodeNRDMonth(DataSetPlus.PlusKind, DataSetPlus.PlusCode, DataSetPlus.PlusCodeNum, ArrPlusM);
    end;
    ArrPlus[ArrPlus.size] = c_CodeNRDMonth(DataSetPlus.PlusKind, DataSetPlus.PlusCode, DataSetPlus.PlusCodeNum, ArrPlusM);
     
    SliceNegativeSum(ArrPlus);
     
    queryMinus =   "with k as (select t_Element, t_Code, t_TaxBaseKind from dnptxkind_dbt where t_Code like 'MinusG%')"
                 + " select q.ObjMonth, q.t_Kind as MinusKind, q.t_Code as MinusCode, NVL(SUM(q.t_Sum0), 0) as MinusSum, regexp_substr(q.t_Code, '[[:digit:]]+') as MinusCodeNum "
                 + "   from (select " + IIF(isSlice, " ", "/*+ index(obj, DNPTXOBJ_DBT_IDX3) */") + " Extract(month from obj.t_Date) as ObjMonth, obj.t_ObjID, obj.t_Sum0, obj.t_Kind, k.t_Code "
                 + "           from k, " + TABLE_NPTXOBJ + " obj "
                 + "          where obj.t_Client = ? "
                 + "            and obj.t_Date between ? and ? "
                 + "            and obj.t_Kind = k.t_Element "
                 +              IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ")
                 + "            and (obj.t_Technical = CHR(0) or obj.t_Technical is null) "
                 + "        ) q " 
                 + "  group by q.ObjMonth, q.t_Kind, q.t_Code "
                 + "  order by q.t_Code ASC, q.ObjMonth ASC ";

    cmdMinus = DL_RSDCommand(queryMinus);

    cmdMinus.AddParam(ClientID);
    cmdMinus.AddParam(BeginDate);
    cmdMinus.AddParam(EndDate);
         
    DataSetMinus = cmdMinus.Execute();
    prevObjMonth = 0;
    prevVal = NULL;
    var ArrMinusM = TArray();

    while(DataSetMinus.moveNext())
      if((prevVal != NULL) and (prevVal.Kind != DataSetMinus.MinusKind))
        if(prevVal.CodeNum == 619)
          Minus619 = prevVal;
        else
          ArrMinus[ArrMinus.size] = prevVal;
        end;
        
        ArrMinusM = TArray();
      end;
      ArrMinusM[ArrMinusM.size] = c_NRDMonth(DataSetMinus.ObjMonth, DataSetMinus.MinusSum);
      prevVal = c_CodeNRDMonth(DataSetMinus.MinusKind, DataSetMinus.MinusCode, DataSetMinus.MinusCodeNum, ArrMinusM);
    end;
    
    if(DataSetMinus.MinusCodeNum == 619)
      Minus619 = c_CodeNRDMonth(DataSetMinus.MinusKind, DataSetMinus.MinusCode, DataSetMinus.MinusCodeNum, ArrMinusM);
    else
      ArrMinus[ArrMinus.size] = c_CodeNRDMonth(DataSetMinus.MinusKind, DataSetMinus.MinusCode, DataSetMinus.MinusCodeNum, ArrMinusM);
    end;
    
    SliceNegativeSum(ArrMinus);

    var ArrMonthNOB = ParsArrSum(ArrPlus, ArrMinus, Minus619);

    if(Rate15Sum > $0)
      ParsByRate(ArrMonthNOB, Rate13Sum, ArrPlus, Rate13, Rate15);
    else
      ParsByRate(ArrMonthNOB, -1, ArrPlus, Rate13, Rate15);
    end;
  END;

  /**
   @brief Печать строки отчета
   @param[in] arr Массив сумм за месяц
   @param[in] title Префикс полей шаблона
   @param[in] calcItog Рассчитывать итоговую строку 
   @param[in] name Наименование 
   @param[in] specialItog Итоговая сумма
  */
  private macro printLine(arr, title, calcItog, name, specialItog)
    var itog = iif(calcItog, abs(getSumArr(arr)), arr[12]);
  
    PrintFormatString( NULL, title+"_1" , arr[1],
                             title+"_2" , arr[2],
                             title+"_3" , arr[3],
                             title+"_4" , arr[4],
                             title+"_5" , arr[5],
                             title+"_6" , arr[6],
                             title+"_7" , arr[7],
                             title+"_8" , arr[8],
                             title+"_9" , arr[9],
                             title+"_10" , arr[10],
                             title+"_11" , arr[11],
                             title+"_12" , arr[12],
                             title+"_itog" , iif(valType(specialItog) != V_UNDEF, specialItog, itog));

    if(name != NULL)
      PrintFormatString( NULL, title+"_title" , name)
    end;

    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, title, 0, sheet_name, true);
  END;

  /**
   @brief Печать заголовка отчета
  */
  private macro R1_2()
    var NUMBER = MkStr("0", 6 - StrLen(Trim (String(int(rep.Num))))) + String(int(rep.Num));
    PrintFormatString(NULL, "N1_R1_R2");
    PrintFormatString(NULL,
                      "N1_T1",              rep.DateT1,
                      "N1_T2",              rep.DateT2,
                      "N1_NUMBER",          NUMBER,
                      "N1_1_1",             "7725114488",
                      "N1_1_2",             OurKPP(),
                      "N1_1_3",             OurFNScode(),
                      "N1_1_4",             OurName(),
                      "N1_1_5",             OurOKTMO(),
                      "N1_2_1",             rep.ClientINN,
                      "N1_2_2",             rep.SNILS,
                      "N1_2_3",             rep.ClientFIO,
                      "N1_2_4",             rep.DocumentType,
                      "N1_2_5",             rep.DocumentNumber,
                      "N1_2_6",             rep.BirthDate,
                      "N1_2_7",             rep.Citizenship,
                      "N1_2_8",             rep.Country,
                      "N1_2_9",             rep.MailIndex,
                      "N1_2_10",            rep.RegionCode,
                      "N1_2_11",            rep.District,
                      "N1_2_12",            rep.City,
                      "N1_2_13",            rep.Town,
                      "N1_2_14",            rep.Street,
                      "N1_2_15",            rep.House,
                      "N1_2_16",            rep.Building,
                      "N1_2_17",            rep.Appartment,
                      "N1_2_18",            rep.ResidenceStatus,
                      "N1_2_19",            "");

    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R1_R2", 0, sheet_name, true);
  END;

  /**
   @brief Печать 3-го раздела отчета
  */
  private macro R3 ()
    var BaseTotal = initArrCodeLine();
    var PlusS = initArrCodeLine();
    var MinusS = initArrCodeLine();
    var NP = initArrCodeLine();
    var TaxCalculated = initArrCodeLine();
    var TaxPaid = initArrCodeLine();
    var TaxDue = initArrCodeLine();
    var TaxToReturnDue = initArrCodeLine();
    var TaxTransmited = initArrCodeLine();
    var TaxReturn = initArrCodeLine();
    var i = 0;
    var ArrCodePlusAll = TArray();
    var ArrCodeMinusAll = TArray();
    var ArrCodeLine = TArray();
    var idCodeInArr = -1;
    var rate = iif(rep.ResidenceStatus == 1, 0.13, 0.3 );
    var queryBase, cmdBase, DataBase;
    var Year;
    var ZeroArr = initArrCodeLine();
    var mergePos = 0;
    
    datesplit(SQL_ConvTypeDate(rep.DateT2), null, null, Year);
    
    TaxCalculatedSum = $0;
    TaxPaidSum = $0;
    TaxTransmittedSum = $0;
    TaxDueSum = $0;
    TaxToReturnDueSum = $0;

    PrintFormatString(NULL, "N1_R3");
    PrintFormatString(NULL,"N1_3_1",  $0);    
    PrintFormatString( NULL, "N1_3_3", $0 );
    PrintFormatString( NULL, "N1_3_2", $0 );
    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R3", 0, sheet_name, true);

    i = 0;
    while (i < Rate13.size)
      if(Rate13[i].ArrCodes.Plus.ArrSumMount[0].Sum > $0)
        idCodeInArr = hasCode(ArrCodePlusAll, Rate13[i].ArrCodes.Plus.CodeNum);
        if(idCodeInArr >= 0)
          ArrCodePlusAll[idCodeInArr].ArrSumMount[Rate13[i].Month] = Rate13[i].ArrCodes.Plus.ArrSumMount[0].Sum;
        else
          ArrCodeLine = initArrCodeLine();
          ArrCodeLine[Rate13[i].Month] = Rate13[i].ArrCodes.Plus.ArrSumMount[0].Sum;
          ArrCodePlusAll[ArrCodePlusAll.size] = c_CodeNRDMonth(Rate13[i].ArrCodes.Plus.Kind, Rate13[i].ArrCodes.Plus.Code, Rate13[i].ArrCodes.Plus.CodeNum, ArrCodeLine)
        end;
      end;
      
      var iCodeMinus = 0;
      while ( iCodeMinus < Rate13[i].ArrCodes.ArrMinus.size)
        if(Rate13[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum > $0)
          idCodeInArr = hasCode(ArrCodeMinusAll, Rate13[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum);
          if(idCodeInArr >= 0)
            ArrCodeMinusAll[idCodeInArr].ArrSumMount[Rate13[i].Month] = Rate13[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
          else
            ArrCodeLine = initArrCodeLine();
            ArrCodeLine[Rate13[i].Month] = Rate13[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
            ArrCodeMinusAll[ArrCodeMinusAll.size] = c_CodeNRDMonth(Rate13[i].ArrCodes.ArrMinus[iCodeMinus].Kind, Rate13[i].ArrCodes.ArrMinus[iCodeMinus].Code, 
                                                                   Rate13[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum, ArrCodeLine)
          end;
       end;
       iCodeMinus = iCodeMinus + 1;
      end;
      i = i + 1;
    end;
    
    i = 0;
    while(i < ArrCodePlusAll.size)
      PlusS[1] = PlusS[1] + ArrCodePlusAll[i].ArrSumMount[1];
      PlusS[2] = PlusS[2] + ArrCodePlusAll[i].ArrSumMount[2];
      PlusS[3] = PlusS[3] + ArrCodePlusAll[i].ArrSumMount[3];
      PlusS[4] = PlusS[4] + ArrCodePlusAll[i].ArrSumMount[4];
      PlusS[5] = PlusS[5] + ArrCodePlusAll[i].ArrSumMount[5];
      PlusS[6] = PlusS[6] + ArrCodePlusAll[i].ArrSumMount[6];
      PlusS[7] = PlusS[7] + ArrCodePlusAll[i].ArrSumMount[7];
      PlusS[8] = PlusS[8] + ArrCodePlusAll[i].ArrSumMount[8];
      PlusS[9] = PlusS[9] + ArrCodePlusAll[i].ArrSumMount[9];
      PlusS[10] = PlusS[10] + ArrCodePlusAll[i].ArrSumMount[10];
      PlusS[11] = PlusS[11] + ArrCodePlusAll[i].ArrSumMount[11];
      PlusS[12] = PlusS[12] + ArrCodePlusAll[i].ArrSumMount[12];
      
      printLine(ArrCodePlusAll[i].ArrSumMount, "N1_CodePlus", true, ArrCodePlusAll[i].CodeNum);
    
      i = i + 1;
    end;

    if(i == 0) 
      printLine(ZeroArr, "N1_CodePlus", true, "<код дохода>");
    end;

    i = 0;
    var numRowMinus = 0;
    mergePos = GetLastPosition(sheet_name) + 2;
    while(i < ArrCodeMinusAll.size)
      MinusS[1] = MinusS[1] + ArrCodeMinusAll[i].ArrSumMount[1];
      MinusS[2] = MinusS[2] + ArrCodeMinusAll[i].ArrSumMount[2];
      MinusS[3] = MinusS[3] + ArrCodeMinusAll[i].ArrSumMount[3];
      MinusS[4] = MinusS[4] + ArrCodeMinusAll[i].ArrSumMount[4];
      MinusS[5] = MinusS[5] + ArrCodeMinusAll[i].ArrSumMount[5];
      MinusS[6] = MinusS[6] + ArrCodeMinusAll[i].ArrSumMount[6];
      MinusS[7] = MinusS[7] + ArrCodeMinusAll[i].ArrSumMount[7];
      MinusS[8] = MinusS[8] + ArrCodeMinusAll[i].ArrSumMount[8];
      MinusS[9] = MinusS[9] + ArrCodeMinusAll[i].ArrSumMount[9];
      MinusS[10] = MinusS[10] + ArrCodeMinusAll[i].ArrSumMount[10];
      MinusS[11] = MinusS[11] + ArrCodeMinusAll[i].ArrSumMount[11];
      MinusS[12] = MinusS[12] + ArrCodeMinusAll[i].ArrSumMount[12];

      printLine(ArrCodeMinusAll[i].ArrSumMount, "N1_CodeMinus", true, ArrCodeMinusAll[i].CodeNum);
      i = i + 1;
      numRowMinus = numRowMinus + 1;
    end;

    if(i == 0) 
      printLine(ZeroArr, "N1_CodeMinus", true, "Код");
      numRowMinus = numRowMinus + 1;
    end;

    if(numRowMinus > 0)
      m_ObjTemplateXLS.SetMergeTotal( "B" + mergePos + ":S" + (GetLastPosition(sheet_name) + 1) );
    end;

    i = 1;
    var TaxCalculatedTotal =$0.0;
    while (i <= 12)
      BaseTotal[i] = PlusS[i] - MinusS[i] + iif(i == 1, 0, BaseTotal[i-1]);
      TaxCalculated[i] = Round((BaseTotal[i] * rate), 0) - TaxCalculatedTotal;
      TaxCalculatedTotal = TaxCalculatedTotal + TaxCalculated[i];
      i = i + 1;
    end;

    if(IsBefore2022)
      var ArrNDR = Tarray();
      var ArrNDR3BaseG1 = initArrCodeLine();
      var ArrNDR3BaseSpecial = initArrCodeLine();
      var SumP = $0.0;

      GetSum(rep.PartyID, "" + TXOBJ_PAIDMATERIAL
                       + "," + TXOBJ_PAIDGENERAL
                       + "," + TXOBJ_PAIDSPECIAL
                       + "," + TXOBJ_PAIDMATERIAL_IIS
                       + "," + TXOBJ_PAIDGENERAL_IIS
                       + "," + TXOBJ_PAIDSPECIAL_IIS
                       + "," + TXOBJ_PAIDBILL
                       + "," + TXOBJ_DIVPAY_SEC, SQL_ConvTypeDate(rep.DateT1), SQL_ConvTypeDate(rep.DateT2), @SumP, NULL, "", ArrNDR);

      //GetSum(rep.PartyID, "" + TXOBJ_BASEG1_13, SQL_ConvTypeDate(rep.DateT1), SQL_ConvTypeDate(rep.DateT2), @SumP, NULL, "", ArrNDR3BaseG1);
      //GetSum(rep.PartyID, "" + TXOBJ_BASESPECIAL_DIV, SQL_ConvTypeDate(rep.DateT1), SQL_ConvTypeDate(rep.DateT2), @SumP, NULL, "", ArrNDR3BaseSpecial);

      i = 0;
      while (i < ArrNDR.size)
        TaxPaid[ArrNDR[i].Month] = TaxPaid[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum > $0, ABS(ArrNDR[i].Sum), $0);
        TaxReturn[ArrNDR[i].Month] = TaxReturn[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum < $0, ABS(ArrNDR[i].Sum), $0);

        i = i + 1;
      end;

      i = 1;
      while (i <= 12)
        TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] > 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0);
        TaxToReturnDue[i] = Abs(iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] < 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0));
        i = i + 1;
      end;
    else
      queryBase =     " select tb.T_HOLDPITAX, tb.T_INCDATE, "
                  + "        tb.t_Type, EXTRACT (MONTH FROM tb.T_INCDATE) as t_MONTH, "
                  + "        EXTRACT (YEAR FROM tb.T_INCDATE) as t_Year "
                  + "   from " + TABLE_TOTALBASE + " tb "
                  + "  where tb.t_ClientID = ? "
                  + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                  + "    and tb.t_Type IN (1,2,3) "
                  + "    and tb.t_RateHoldPITax <> " + int(NPTXGENTAXRATE_RESIDENT_15*100)
                  + "    and tb.t_TaxPeriod = ? ";
      if(isSlice)
        queryBase = queryBase + " and t_sliceID = " + m_SliceID + " ";
      end;

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
       
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        if(DataBase.HOLDPITAX > 0) 
            if(DataBase.Year == Year)
              TaxPaid[DataBase.MONTH] = TaxPaid[DataBase.MONTH] + Round(DataBase.HOLDPITAX, 0);
            else
              TaxPaid[12] = TaxPaid[12] + Round(DataBase.HOLDPITAX, 0);
            end;
        end;
        
        if(DataBase.HOLDPITAX < 0)
            if(DataBase.Year == Year)
              TaxReturn[DataBase.MONTH] = TaxReturn[DataBase.MONTH] + Abs(ExtRound(DataBase.HOLDPITAX));
            else
              TaxReturn[12] = TaxReturn[12] + Abs(ExtRound(DataBase.HOLDPITAX));
            end;
        end;
      end;
      
      i = 1;
      while (i <= 12)
        TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] > 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0);
        TaxToReturnDue[i] = Abs(iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] < 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0));
        i = i + 1;
      end;
    end;

    PrintLine(ZeroArr, "N1_CodeMinus2181");
    PrintLine(ZeroArr, "N1_CodeMinus2182");
    PrintLine(ZeroArr, "N1_CodeMinus2183");
    PrintLine(ZeroArr, "N1_CodeMinus2184");
    PrintLine(ZeroArr, "N1_CodeMinus2185");
    PrintLine(ZeroArr, "N1_CodeMinus2186");
    m_ObjTemplateXLS.SetMergeTotal( "B" + (GetLastPosition(sheet_name)-5) + ":S" + (GetLastPosition(sheet_name)+1) );

    printLine(BaseTotal, "N1_NB");
    printLine(TaxCalculated, "N1_NI", true);
    PrintLine(ZeroArr, "N1_3NP");
    PrintLine(ZeroArr, "N1_OG");
    printLine(TaxPaid, "N1_NU", true);
    printLine(TaxDue, "N1_NP", true, NULL, iif(getSumArr(TaxDue) - getSumArr(TaxToReturnDue) > 0, getSumArr(TaxDue) - getSumArr(TaxToReturnDue), $0));
    printLine(TaxToReturnDue, "N1_NA", true, NULL, iif(getSumArr(TaxToReturnDue) - getSumArr(TaxDue) > 0, getSumArr(TaxToReturnDue) - getSumArr(TaxDue), $0));
    printLine(TaxTransmited, "N1_TT", true);
    printLine(TaxReturn, "N1_TR", true);

    TaxCalculatedSum = abs(getSumArr(TaxCalculated));
    TaxPaidSum = abs(getSumArr(TaxPaid));
    TaxTransmittedSum = abs(getSumArr(TaxTransmited));
    TaxDueSum = abs(iif(getSumArr(TaxDue) - getSumArr(TaxToReturnDue) > 0, getSumArr(TaxDue) - getSumArr(TaxToReturnDue), $0));
    TaxToReturnDueSum = abs(iif(getSumArr(TaxToReturnDue) - getSumArr(TaxDue) > 0, getSumArr(TaxToReturnDue) - getSumArr(TaxDue), $0));

    if(pNeedCompare)
      CompareObjList[CompareObjList.size] = c_compare_obj(rep.Num, rep.PartyID, OurKPP(), OurOKTMO(), rep.ClientFIO, rate*100, 
                                                          KBKmain, BaseTotal[12], TaxCalculatedSum, TaxPaidSum, TaxDueSum, rep.ResidenceStatus, rep.ClientINN);
    end;
  END;

  /**
   @brief Печать 4-го раздела отчета
  */
  private macro R4 ()
    var BaseTotal = initArrCodeLine();
    var PlusS = initArrCodeLine();
    var MinusS = initArrCodeLine();
    var NP = initArrCodeLine();
    var TaxCalculated = initArrCodeLine();
    var TaxPaid = initArrCodeLine();
    var TaxDue = initArrCodeLine();
    var TaxToReturnDue = initArrCodeLine();
    var TaxTransmited = initArrCodeLine();
    var TaxReturn = initArrCodeLine();
    var ArrCodePlusAll = TArray();
    var ArrCodeMinusAll = TArray();
    var ArrCodeLine = TArray();
    var i = 0;
    var idCodeInArr = -1;
    var rate = NPTXGENTAXRATE_RESIDENT_15;
    var queryBase, cmdBase, DataBase;
    var Year = 0;
    var ZeroArr = initArrCodeLine();
    var mergePos = 0;
    
    datesplit(SQL_ConvTypeDate(rep.DateT2), null, null, Year);
    
    TaxCalculated15Sum = $0;
    TaxPaid15Sum = $0;
    TaxTransmitted15Sum = $0;
    TaxDue15Sum = $0;
    TaxToReturnDue15Sum = $0;
    
    PrintFormatString( NULL, "N1_R4");
    PrintFormatString( NULL, "N1_4_1", $0);    
    PrintFormatString( NULL, "N1_4_3", $0);
    PrintFormatString( NULL, "N1_4_2", $0);

    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R4", 0, sheet_name, true);

    i = 0;
    while (i < Rate15.size)
      if(Rate15[i].ArrCodes.Plus.ArrSumMount[0].Sum > $0)
        idCodeInArr = hasCode(ArrCodePlusAll, Rate15[i].ArrCodes.Plus.CodeNum);
        if(idCodeInArr >= 0)
          ArrCodePlusAll[idCodeInArr].ArrSumMount[Rate15[i].Month] = Rate15[i].ArrCodes.Plus.ArrSumMount[0].Sum;
        else
          ArrCodeLine = initArrCodeLine();
          ArrCodeLine[Rate15[i].Month] = Rate15[i].ArrCodes.Plus.ArrSumMount[0].Sum;
          ArrCodePlusAll[ArrCodePlusAll.size] = c_CodeNRDMonth(Rate15[i].ArrCodes.Plus.Kind, Rate15[i].ArrCodes.Plus.Code, Rate15[i].ArrCodes.Plus.CodeNum, ArrCodeLine)
        end;
      end;
      
      var iCodeMinus = 0;
      while ( iCodeMinus < Rate15[i].ArrCodes.ArrMinus.size)
        if(Rate15[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum > $0)
          idCodeInArr = hasCode(ArrCodeMinusAll, Rate15[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum);
          if(idCodeInArr >= 0)
            ArrCodeMinusAll[idCodeInArr].ArrSumMount[Rate15[i].Month] = Rate15[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
          else
            ArrCodeLine = initArrCodeLine();
            ArrCodeLine[Rate15[i].Month] = Rate15[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
            ArrCodeMinusAll[ArrCodeMinusAll.size] = c_CodeNRDMonth(Rate15[i].ArrCodes.ArrMinus[iCodeMinus].Kind, Rate15[i].ArrCodes.ArrMinus[iCodeMinus].Code, Rate15[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum, ArrCodeLine)
          end;
        end;
        iCodeMinus = iCodeMinus + 1;
      end;
      i = i + 1;
    end;
    
    i = 0;
    while(i < ArrCodePlusAll.size)
      PlusS[1] = PlusS[1] + ArrCodePlusAll[i].ArrSumMount[1];
      PlusS[2] = PlusS[2] + ArrCodePlusAll[i].ArrSumMount[2];
      PlusS[3] = PlusS[3] + ArrCodePlusAll[i].ArrSumMount[3];
      PlusS[4] = PlusS[4] + ArrCodePlusAll[i].ArrSumMount[4];
      PlusS[5] = PlusS[5] + ArrCodePlusAll[i].ArrSumMount[5];
      PlusS[6] = PlusS[6] + ArrCodePlusAll[i].ArrSumMount[6];
      PlusS[7] = PlusS[7] + ArrCodePlusAll[i].ArrSumMount[7];
      PlusS[8] = PlusS[8] + ArrCodePlusAll[i].ArrSumMount[8];
      PlusS[9] = PlusS[9] + ArrCodePlusAll[i].ArrSumMount[9];
      PlusS[10] = PlusS[10] + ArrCodePlusAll[i].ArrSumMount[10];
      PlusS[11] = PlusS[11] + ArrCodePlusAll[i].ArrSumMount[11];
      PlusS[12] = PlusS[12] + ArrCodePlusAll[i].ArrSumMount[12];
      
      printLine(ArrCodePlusAll[i].ArrSumMount, "N1_CodePlus15", true, ArrCodePlusAll[i].CodeNum);
      i = i + 1;
    end;

    if(i == 0) 
      printLine(ZeroArr, "N1_CodePlus15", true, "<код дохода>");
    end;

    i = 0;
    var numRowMinus = 0;
    mergePos = GetLastPosition(sheet_name) + 2;
    while(i < ArrCodeMinusAll.size)
      MinusS[1] = MinusS[1] + ArrCodeMinusAll[i].ArrSumMount[1];
      MinusS[2] = MinusS[2] + ArrCodeMinusAll[i].ArrSumMount[2];
      MinusS[3] = MinusS[3] + ArrCodeMinusAll[i].ArrSumMount[3];
      MinusS[4] = MinusS[4] + ArrCodeMinusAll[i].ArrSumMount[4];
      MinusS[5] = MinusS[5] + ArrCodeMinusAll[i].ArrSumMount[5];
      MinusS[6] = MinusS[6] + ArrCodeMinusAll[i].ArrSumMount[6];
      MinusS[7] = MinusS[7] + ArrCodeMinusAll[i].ArrSumMount[7];
      MinusS[8] = MinusS[8] + ArrCodeMinusAll[i].ArrSumMount[8];
      MinusS[9] = MinusS[9] + ArrCodeMinusAll[i].ArrSumMount[9];
      MinusS[10] = MinusS[10] + ArrCodeMinusAll[i].ArrSumMount[10];
      MinusS[11] = MinusS[11] + ArrCodeMinusAll[i].ArrSumMount[11];
      MinusS[12] = MinusS[12] + ArrCodeMinusAll[i].ArrSumMount[12];

      printLine(ArrCodeMinusAll[i].ArrSumMount, "N1_CodeMinus15", true, ArrCodeMinusAll[i].CodeNum);
      i = i + 1;
      numRowMinus = numRowMinus + 1;
    end;

    if(i == 0) 
      printLine(ZeroArr, "N1_CodeMinus15", true, "Код");
      numRowMinus = numRowMinus + 1;
    end;

    if(numRowMinus > 0)
      m_ObjTemplateXLS.SetMergeTotal( "B" + mergePos + ":S" + (GetLastPosition(sheet_name) + 1) );
    end;

    i = 1;
    var TaxCalculatedTotal =$0.0;
    while (i <= 12)
      BaseTotal[i] = PlusS[i] - MinusS[i] + iif(i == 1, 0, BaseTotal[i-1]);
      TaxCalculated[i] = Round((BaseTotal[i] * rate), 0) - TaxCalculatedTotal;
      TaxCalculatedTotal = TaxCalculatedTotal + TaxCalculated[i];
      i = i + 1;
    end;


    if(IsBefore2022)
      var ArrNDR = Tarray();
      var ArrNDR3BaseG1 = initArrCodeLine();
      var ArrNDR3BaseSpecial = initArrCodeLine();
      var SumP = $0.0;

      GetSum(rep.PartyID, "" + TXOBJ_PAIDGENERAL_15_1
                       + "," + TXOBJ_PAIDGENERAL_15_2
                       + "," + TXOBJ_PAIDGENERAL_15_9
                       + "," + TXOBJ_PAIDGENERAL_15_IIS, SQL_ConvTypeDate(rep.DateT1), SQL_ConvTypeDate(rep.DateT2), @SumP, NULL, "", ArrNDR);
                            
      //GetSum(rep.PartyID, "" + TXOBJ_BASEG1_15, SQL_ConvTypeDate(rep.DateT1), SQL_ConvTypeDate(rep.DateT2), @SumP, NULL, "", ArrNDR3BaseG1);
      //GetSum(rep.PartyID, "" + TXOBJ_BASESPECIAL_DIV_15, SQL_ConvTypeDate(rep.DateT1), SQL_ConvTypeDate(rep.DateT2), @SumP, NULL, "", ArrNDR3BaseSpecial);

      i = 0;
      while (i < ArrNDR.size)
        TaxPaid[ArrNDR[i].Month] = TaxPaid[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum > $0, ABS(ArrNDR[i].Sum), $0);
        TaxReturn[ArrNDR[i].Month] = TaxReturn[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum < $0, ABS(ArrNDR[i].Sum), $0);

        i = i + 1;
      end;

      i = 1;
      while (i <= 12)
        TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] > 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0);
        TaxToReturnDue[i] = Abs(iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] < 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0));
        i = i + 1;
      end;
    else
      queryBase =     " select tb.T_HOLDPITAX, tb.T_INCDATE, "
                  + "        tb.t_Type, EXTRACT (MONTH FROM tb.T_INCDATE) as t_MONTH, "
                  + "        EXTRACT (YEAR FROM tb.T_INCDATE) as t_Year "
                  + "   from " + TABLE_TOTALBASE + " tb "
                  + "  where tb.t_ClientID = ? "
                  + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                  + "    and tb.t_Type IN (1,2,3) "
                  + "    and tb.t_RateHoldPITax = " + int(NPTXGENTAXRATE_RESIDENT_15*100)
                  + "    and tb.t_TaxPeriod = ? ";

      if(isSlice)
        queryBase = queryBase + " and t_sliceID = " + m_SliceID + " ";
      end;

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
       
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        if(DataBase.HOLDPITAX > 0)
            if(DataBase.Year == Year)
              TaxPaid[DataBase.MONTH] = TaxPaid[DataBase.MONTH] + Round(DataBase.HOLDPITAX, 0);
            else
              TaxPaid[12] = TaxPaid[12] + Round(DataBase.HOLDPITAX, 0);
            end;
        end;
        
        if(DataBase.HOLDPITAX < 0)
            if(DataBase.Year == Year)
              TaxReturn[DataBase.MONTH] = TaxReturn[DataBase.MONTH] + Abs(ExtRound(DataBase.HOLDPITAX));
            else
              TaxReturn[12] = TaxReturn[12] + Abs(ExtRound(DataBase.HOLDPITAX));
            end;
        end;
      end;

      i = 1;
      while (i <= 12)
        TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] > 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0);
        TaxToReturnDue[i] = Abs(iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] < 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0));
        i = i + 1;
      end;
    end;

    TaxCalculated15Sum = abs(getSumArr(TaxCalculated));
    TaxPaid15Sum = abs(getSumArr(TaxPaid));
    TaxTransmitted15Sum = abs(getSumArr(TaxTransmited));
    TaxDue15Sum = abs(iif(getSumArr(TaxDue) - getSumArr(TaxToReturnDue) > 0, getSumArr(TaxDue) - getSumArr(TaxToReturnDue), $0));
    TaxToReturnDue15Sum = abs(iif(getSumArr(TaxToReturnDue) - getSumArr(TaxDue) > 0, getSumArr(TaxToReturnDue) - getSumArr(TaxDue), $0));

    printLine(BaseTotal, "N1_NB15");
    printLine(TaxCalculated, "N1_NI15", true);
    PrintLine(ZeroArr, "N1_3NP15");
    PrintLine(ZeroArr, "N1_OG15");
    printLine(TaxPaid, "N1_NU15", true);
    printLine(TaxDue, "N1_NP15", true, NULL, iif((getSumArr(TaxDue) - getSumArr(TaxToReturnDue)) > 0, getSumArr(TaxDue) - getSumArr(TaxToReturnDue), $0));
    printLine(TaxToReturnDue, "N1_NA15", true, NULL, iif((getSumArr(TaxToReturnDue) - getSumArr(TaxDue)) > 0, getSumArr(TaxToReturnDue) - getSumArr(TaxDue), $0));
    printLine(TaxTransmited, "N1_TT15", true);
    printLine(TaxReturn, "N1_TR15", true);
    
    if(pNeedCompare)
      CompareObjList[CompareObjList.size] = c_compare_obj(rep.Num, rep.PartyID, OurKPP(), OurOKTMO(), rep.ClientFIO, rate*100, 
                                                          KBK15, BaseTotal[12], TaxCalculated15Sum, TaxPaid15Sum, TaxDue15Sum, rep.ResidenceStatus, rep.ClientINN);
    end;
  END;

  /**
   @brief Печать 5-го раздела отчета
  */
  private macro R5 ()
    var i = 1, ZeroArr = initArrCodeLine();
    
    PrintFormatString(NULL, "N1_R5");

    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R5", 0, sheet_name, true);

    PrintLine(ZeroArr, "N1_CodePlus35", true, "<код дохода>");
    PrintLine(ZeroArr, "N1_CodeMinus217");
    PrintLine(ZeroArr, "N1_Base35");
    PrintLine(ZeroArr, "N1_TaxCalculated35");
    PrintLine(ZeroArr, "N1_TaxPaid35");
    PrintLine(ZeroArr, "N1_TaxDue35");
    PrintLine(ZeroArr, "N1_TaxToReturnDue35");
    PrintLine(ZeroArr, "N1_TaxTransmitted35");
    PrintLine(ZeroArr, "N1_TaxToReturnDue352");
  END;

  /**
   @brief Печать 6-го раздела отчета
  */
  private macro R6 ()
    PrintFormatString(NULL, "N1_R6");
    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R6", 0, sheet_name, true);

    TotalPercentSum.size = 0;
    AddPercentSumToArray(13, 
                         iif(rep.ResidenceStatus() == 1, TaxCalculatedSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxPaidSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxDueSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxDueSum, $0),
                         iif(rep.ResidenceStatus() == 1, TaxToReturnDueSum, $0));

    AddPercentSumToArray(30, 
                         iif(rep.ResidenceStatus() != 1, TaxCalculatedSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxPaidSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxDueSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxDueSum, $0),
                         iif(rep.ResidenceStatus() != 1, TaxToReturnDueSum, $0));

    AddPercentSumToArray(15, 
                         TaxCalculated15Sum,
                         TaxPaid15Sum,
                         TaxDue15Sum,
                         TaxDue15Sum,
                         TaxToReturnDue15Sum);

    AddPercentSumToArray(35, 
                         $0,
                         $0,
                         $0,
                         $0,
                         $0);

    AddPercentSumToArray(9, 
                         $0,
                         $0,
                         $0,
                         $0,
                         $0);
                         
    TArray_QSort(TotalPercentSum, "Percent", 1);
    var i = 0;
    var TotalTaxCalculatedSum = $0;
    var TotalTaxPaidSum = $0;
    var TotalTaxTransmittedSum = $0;
    var TotalTaxDueSum = $0;
    var TotalTaxToReturnDueSum = $0;
    var cell = "N1_R6_1";
    var year;
    datesplit(SQL_ConvTypeDate(rep.DateT2), null, null, Year);
    
    while (i < TotalPercentSum.size)
      PrintFormatString(NULL,
                        cell + "_0", "По ставке " + TotalPercentSum[i].Percent + "%",
                        cell + "_1", abs(TotalPercentSum[i].TaxCalculatedSum),
                        cell + "_2", abs(TotalPercentSum[i].TaxPaidSum),
                        cell + "_3", IIF(SQL_ConvTypeDate(rep.DateT2) == date(31,12,year), abs(TotalPercentSum[i].TaxDueSum), $0.0),
                        cell + "_4", abs(TotalPercentSum[i].TaxDueSum),
                        cell + "_5", abs(TotalPercentSum[i].TaxToReturnDueSum)
                );
      TotalTaxCalculatedSum  = TotalTaxCalculatedSum + TotalPercentSum[i].TaxCalculatedSum;
      TotalTaxPaidSum = TotalTaxPaidSum + TotalPercentSum[i].TaxPaidSum;
      if(SQL_ConvTypeDate(rep.DateT2) == date(31,12,year))
        TotalTaxTransmittedSum = TotalTaxTransmittedSum + TotalPercentSum[i].TaxDueSum;
      else
        TotalTaxTransmittedSum = $0.0;
      end;
      TotalTaxDueSum = TotalTaxDueSum + TotalPercentSum[i].TaxDueSum;
      TotalTaxToReturnDueSum = TotalTaxToReturnDueSum + TotalPercentSum[i].TaxToReturnDueSum;
      m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, cell, 0, sheet_name, true);
      i = i + 1;
    end;

    cell = "N1_R6_2";
    PrintFormatString(NULL,
                       cell + "_1", abs(TotalTaxCalculatedSum),
                       cell + "_2", abs(TotalTaxPaidSum),
                       cell + "_3", abs(TotalTaxTransmittedSum),
                       cell + "_4", abs(TotalTaxDueSum),
                       cell + "_5", abs(TotalTaxToReturnDueSum)
                );
    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, cell, 0, sheet_name, true);
  END;

  /**
   @brief Печать 7-го раздела отчета
  */
  private macro R7 (Param)
    var queryBase, cmdBase, DataBase; 
    var Year = 0;
    
    datesplit(SQL_ConvTypeDate(rep.DateT2), null, null, Year);

    PrintFormatString(NULL, "N1_R7");
    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R7", 0, sheet_name, true);

    if(IsBefore2022)
      queryBase =  " SELECT * " +
         " FROM (  SELECT t_date AS datePaid " +
         "           FROM "+TABLE_NPTXOBJ+" obj " +
         "          WHERE obj.t_client = ?  " +
         "            AND (obj.t_FromOutSyst <> 'X' or obj.t_Technical is NULL)   " +
         IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
         "            AND obj.t_TaxPeriod = ? "+
         "            AND obj.t_kind in ( " + TXOBJ_PAIDMATERIAL
                                 + "," + TXOBJ_PAIDGENERAL
                                 + "," + TXOBJ_PAIDSPECIAL
                                 + "," + TXOBJ_PAIDMATERIAL_IIS
                                 + "," + TXOBJ_PAIDGENERAL_IIS
                                 + "," + TXOBJ_PAIDSPECIAL_IIS
                                 + "," + TXOBJ_PAIDBILL
                                 + "," + TXOBJ_DIVPAY_SEC + " ) " +
         "       GROUP BY t_date) q1 " +
         "   FULL JOIN " +
         "      (  SELECT t_date AS datePlusG " +
         "           FROM "+TABLE_NPTXOBJ+" obj " +
         "          WHERE     obj.t_kind IN (SELECT t_Element " +
         "                                 FROM dnptxkind_dbt " +
         "                                WHERE t_Level IN (5) AND t_Code LIKE 'PlusG%') " +
         "                AND obj.t_client = ? " +
         "                AND obj.t_Date >= ? " +
         IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
         "                AND obj.t_Date <= ? "+
         "                AND (obj.t_Technical <> 'X' or obj.t_Technical is NULL) " +
         "                AND (obj.t_FromOutSyst <> 'X' or obj.t_Technical is NULL) " +
         "                AND (obj.t_User <> 'X' or obj.t_Technical is NULL) " +
         "       GROUP BY t_date) q2 " +
         "   ON q1.datePaid = q2.datePlusG " +
         " ORDER BY q2.datePlusG, q1.datePaid ";

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(SQL_ConvTypeDate(rep.DateT1));
      cmdBase.AddParam(SQL_ConvTypeDate(rep.DateT2));
     
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        PrintFormatString(NULL,
                          "N1_TaxPay_1", DataBase.datePlusG,
                          "N1_TaxPay_2", DataBase.datePaid);
        m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay", 0, sheet_name, true);
      end;

    else

      queryBase =      " select * "
                     + "   from " + TABLE_TOTALBASE + " tb "
                     + "  where tb.t_ClientID = ? "
                     + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                     + "    and tb.t_Type IN (1,2) "
                     + "    and tb.t_RateHoldPITax <> " + int(NPTXGENTAXRATE_RESIDENT_15*100)
                     + "    and tb.t_TaxPeriod = ? ";

      if(isSlice)
        queryBase = queryBase + " and t_sliceID = " + m_SliceID + " ";
      end;

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
     
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        if( (DataBase.Type == 1) and (DataBase.t_TaxBaseCurrPay > 0))
          if(DataBase.HOLDPITAX > 0)
            PrintFormatString(NULL,
                              "N1_TaxPay_1", DataBase.INCDATE,
                              "N1_TaxPay_2", DataBase.INCDATE);
            m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay", 0, sheet_name, true);
          elif(DataBase.HOLDPITAX == 0)
            PrintFormatString(NULL,
                              "N1_TaxPay_1", DataBase.INCDATE,
                              "N1_TaxPay_2", "");
            m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay", 0, sheet_name, true);
          end;
        elif( (DataBase.Type == 2) or ((DataBase.Type == 1) and (DataBase.t_TaxBaseCurrPay == 0)))
          if(DataBase.HOLDPITAX > 0)
            PrintFormatString(NULL,
                              "N1_TaxPay_1", "",
                              "N1_TaxPay_2", DataBase.INCDATE);
            m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay", 0, sheet_name, true);
          end;
        end;
      end;
    end;
  END;

  /**
   @brief Печать 8-го раздела отчета
  */
  private macro R8 (Param)
    var queryBase, cmdBase, DataBase; 
    var Year = 0;
    
    datesplit(SQL_ConvTypeDate(rep.DateT2), null, null, Year);

    PrintFormatString(NULL, "N1_R8");
    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_R8", 0, sheet_name, true);


    if(IsBefore2022)
      queryBase =  " SELECT objPlus.t_date as datePlusG, obj.t_date as datePaid " +
                   "   FROM "+TABLE_NPTXOBJ+" obj " +
                   "          LEFT JOIN " +
                   "             (  SELECT t_date " +
                   "                  FROM "+TABLE_NPTXOBJ+" objPlus " +
                   "                 WHERE     objPlus.t_client = ? " +
                   "                       AND objPlus.t_kind IN (SELECT t_Element " +
                   "                                                FROM dnptxkind_dbt " +
                   "                                               WHERE t_Level IN (5) AND t_Code LIKE 'PlusG%') " +
                   "                       AND (objPlus.t_Technical <> 'X' or objPlus.t_Technical is NULL) " +
                   "                       AND objPlus.t_Date >= ? " +
                                           IIF(isSlice, " and objPlus.t_sliceID = " + m_SliceID + " ", " ") +
                   "                       AND objPlus.t_Date <= ? "+
                   "                       AND (objPlus.t_FromOutSyst <> 'X' or objPlus.t_Technical is NULL) " +
                   "                       AND (objPlus.t_User <> 'X' or objPlus.t_Technical is NULL) " +
                   "              GROUP BY t_date) objPlus " +
                   "          ON objPlus.t_date = obj.t_date " +
                   "    WHERE obj.t_client = ? AND (obj.t_FromOutSyst <> 'X' or obj.t_Technical is NULL) " +
                   IIF(isSlice, " and obj.t_sliceID = " + m_SliceID + " ", " ") +
                   "      AND obj.t_TaxPeriod = ? "+
                   "      AND obj.t_kind IN (" + TXOBJ_PAIDGENERAL_15_1
                                         + "," + TXOBJ_PAIDGENERAL_15_2
                                         + "," + TXOBJ_PAIDGENERAL_15_9
                                         + "," + TXOBJ_PAIDGENERAL_15_IIS +
                   " ) ";

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(SQL_ConvTypeDate(rep.DateT1));
      cmdBase.AddParam(SQL_ConvTypeDate(rep.DateT2));
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);

      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        PrintFormatString(NULL,
                          "N1_TaxPay_1", DataBase.datePlusG,
                          "N1_TaxPay_2", DataBase.datePaid);
        m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay", 0, sheet_name, true);
      end;

    else
      queryBase =      " select * "
                     + "   from " + TABLE_TOTALBASE + " tb "
                     + "  where tb.t_ClientID = ? "
                     + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                     + "    and tb.t_Type IN (1,2) "
                     + "    and tb.t_RateHoldPITax = " + int(NPTXGENTAXRATE_RESIDENT_15*100)
                     + "    and tb.t_TaxPeriod = ? ";

      if(isSlice)
        queryBase = queryBase + " and t_sliceID = " + m_SliceID + " ";
      end;

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
     
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        if( (DataBase.Type == 1) and (DataBase.t_TaxBaseCurrPay > 0))
          if(DataBase.HOLDPITAX > 0)
            PrintFormatString(NULL,
                              "N1_TaxPay15_1", DataBase.INCDATE,
                              "N1_TaxPay15_2", DataBase.INCDATE);
            m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay15", 0, sheet_name, true);
          elif(DataBase.HOLDPITAX == 0)
            PrintFormatString(NULL,
                              "N1_TaxPay15_1", DataBase.INCDATE,
                              "N1_TaxPay15_2", "");
            m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay15", 0, sheet_name, true);
          end;
        elif( (DataBase.Type == 2) or ((DataBase.Type == 1) and (DataBase.t_TaxBaseCurrPay == 0)))
          if(DataBase.HOLDPITAX > 0)
            PrintFormatString(NULL,
                              "N1_TaxPay15_1", "",
                              "N1_TaxPay15_2", DataBase.INCDATE);
            m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_TaxPay15", 0, sheet_name, true);
          end;
        end;
      end;
    end;
  END;

  /**
   @brief Печать подписи
  */
  private macro Sign (Param)
    PrintFormatString(NULL, "N1_Sign");
    PrintFormatString( NULL, "N1_OPER", pOper);    
    m_ObjTemplateXLS.CopyAllSheetInTotalBook(sheet_name, false, "N1_Sign", 0, sheet_name, true);
  END;

  /**
   @brief Создание отчета
  */
  private macro Create()
    var investor          = pInvestor;
    var report_date_end   = pReport_date_end;
    var report_date_begin = pReport_date_begin;
    var folder            = pFolder;
    var LoadFileRadio     = pLoad_file_radio;
    var LoadFile          = pLoadFile;
    var Clients           = pClients;
    var Source            = pSource;
    var SourceNum         = pSourceNum;
    var cmdClient, queryClient, DataSetClient;
    var count = 0, num_ready = 0;
    var clientsFileNameArr = TArray();

    isSlice = iif((Source == DL_SLICE), true, false);

    if(isSlice)
      m_SliceID = getSliceID (report_date_begin, report_date_end, SourceNum) ;
      TABLE_TOTALBASE = NPTXSLICEBASE;
      TABLE_NPTXOBJ = NPTXSLICEOBJ;
    end;

    if(report_date_end <= date(31,12,2022))
      IsBefore2022 =  true;
    end;
    m_TaxAgentParm.Load();

    SQL_Execute("DELETE FROM DNPTX6CLIENT_TMP");

    if((LoadFileRadio == SET_CHAR) and (LoadFile != ""))
      Clients = TArray();
      LoadClientsFromFile(LoadFile, @Clients);
      if(IsBefore2022)
        Before2022NPTXObj = NPTXRepCalc_NPTXPIT6_NEW_2_REG(Clients ,report_date_begin, report_date_end, isSlice, m_SliceID);
        Before2022NPTXObj.LoadClientInTmpTable();
      else
        insertClientsInTmp (Clients);
      end;
    elif((ValType(Clients) == V_GENOBJ) and (Clients.Size > 0))
      if(IsBefore2022)
        Before2022NPTXObj = NPTXRepCalc_NPTXPIT6_NEW_2_REG(Clients ,report_date_begin, report_date_end, isSlice, m_SliceID);
        Before2022NPTXObj.LoadClientInTmpTable();
      else
        insertClientsInTmp (Clients);
      end;
    else
      if(IsBefore2022)
        Before2022NPTXObj = NPTXRepCalc_NPTXPIT6_NEW_2_REG(0 ,report_date_begin, report_date_end, isSlice, m_SliceID);
        Before2022NPTXObj.LoadClientInTmpTable();
      else
        InsertAllClientsToNPTX6CLIENT(report_date_begin, report_date_end);
      end;
    end;
    
    if(isSlice and (ValType(Clients) == V_GENOBJ))
      addClientErr();
    end;

    setisshowAppl(false);

    queryClient =  
                  "  select /* parallel(4) enable_parallel_dml */ " +
                  "    rep.t_PartyID as PartyID, " +
                  "    RowNum as Num, " +
                  "   " + GetSQLDate(report_date_begin) + " as DateT1, " +
                  "   " + GetSQLDate(report_date_end) + " as DateT2, " +
                  "   (select papr.t_CodeDocum from dpaprkind_dbt papr where papr.t_PaperKind = pers.t_PaperKind ) as DocumentType, " +
                  "   (select papr.t_Name from dpaprkind_dbt papr where papr.t_PaperKind = pers.t_PaperKind ) as DocumentName, " +
                  "    pers.T_PAPERSERIES || ' ' || pers.T_PaperNumber as DocumentNumber,  " +
                  "    ad.t_Country as Country, " +
                  "    ad.t_PostIndex as MailIndex, " +
                  "    ad.t_RegionNum as RegionCode, " +
                  "    ad.t_Province as District, " +
                  "    ad.t_District as City, " +
                  "    ad.t_Place as Town, " +
                  "    ad.t_Street as Street, " +
                  "    ad.t_House as House, " +
                  "    ad.t_NumCorps as Building, " +
                  "    ad.t_Flat as Appartment, " +
                  "    RSI_NPTX.RESIDENCESTATUS(rep.t_PartyID, " + GetSQLDate(report_date_end) + ") as ResidenceStatus, " +
                  "    persn.t_Name1 AS Name1 , " +
                  "    persn.t_Name2 AS Name2 , " +
                  "    persn.t_Name3 AS Name3 , " +
                  "    pt.t_Name AS ClientFIO , " +
                  "    persn.t_Born AS BirthDate , " +
                  "    persn.t_BirsPlase , " +
                  "    NVL((CASE WHEN pt.t_NotResident = 'X'  " +
                  "                 OR (pt.t_NRCountry <> CHR(1)  " +
                  "                AND pt.t_NRCountry <> 'RUS')  " +
                  "               THEN  " +
                  "                 (SELECT  " +
                  "                   adr.t_Adress  " +
                  "                  FROM  " +
                  "                   dadress_dbt adr  " +
                  "                  WHERE  " +
                  "                  adr.t_PartyID = pt.t_PartyID  " +
                  "                  AND adr.t_Type = 2 /* PTADDR_REAL */ )  " +
                  "              ELSE  " +
                  "                 CHR(1)  " +
                  "             END), CHR(1)) AS t_ResidenceAdress , " +
                  "    NVL((CASE   " +
                  "                 WHEN pt.t_NotResident = 'X'   " +
                  "                   OR (pt.t_NRCountry <> CHR(1)   " +
                  "                   AND pt.t_NRCountry <> 'RUS')   " +
                  "                 THEN   " +
                  "                   (SELECT   " +
                  "                      cn.t_CodeNum3   " +
                  "                    FROM   " +
                  "                      dadress_dbt adr   " +
                  "                     ,dcountry_dbt cn   " +
                  "                    WHERE   " +
                  "                      adr.t_PartyID = pt.t_PartyID   " +
                  "                    AND adr.t_Type =   2 /* PTADDR_REAL */     " +  
                  "                    AND adr.t_Country <> CHR(1)   " +
                  "                    AND cn.t_CodeLat3 = adr.t_Country)   " +
                  "                 ELSE   " +
                  "                   CHR(1)   " +
                  "               END), CHR(1)) AS t_ResidenceCountry  , " +
                  "             NVL(RSB_SECUR.SC_GetObjCodeOnDate(3 /* OBJTYPE_PARTY */ , 16 /* PTCK_INN */, persn.t_PersonID), CHR(1)) AS t_ClientINN, " +
                  "             NVL(RSB_SECUR.SC_GetObjCodeOnDate(3 /* OBJTYPE_PARTY */ , 63 /* PTCK_SNILS */, persn.t_PersonID), CHR(1)) AS t_SNILS, " +
                  "             NVL((CASE   " +
                  "                 WHEN pt.t_NRCountry <> CHR(1)   " +
                  "                 THEN   " +
                  "                   (SELECT   " +
                  "                      cn.t_CodeNum3   " +
                  "                    FROM   " +
                  "                      dcountry_dbt cn   " +
                  "                    WHERE   " +
                  "                      cn.t_CodeLat3 = pt.t_NRCountry)   " +
                  "                 ELSE   " +
                  "                   CHR(1)   " +
                  "               END), CHR(1)) AS t_Citizenship   " +
                  "  from DNPTX6CLIENT_TMP rep  left join dparty_dbt pt on  pt.T_PARTYID = rep.T_PARTYID " +
                  "                 left join dpersn_dbt persn on persn.t_PersonID = rep.T_PARTYID " +
                  "                 left join dpersnidc_dbt pers on pers.T_PERSONID = rep.t_PartyID and t_IsMain = 'X' " +
                  "                 left join dadress_dbt ad on ad.t_PartyID = rep.t_PartyID and t_Type = 1 /*PTADDR_LEGAL*/ and t_Country = 'RUS' ";
  
    cmdClient = DL_RSDCommand("Select * from DNPTX6CLIENT_TMP");
  
    InitProgress(cmdClient.GetCount(), "Регистр НДФЛ", "Регистр НДФЛ");
  
    if(cmdClient.GetCount() > 0)
      MSGArr[MSGArr.size] = " \";\"Поиск клиентов, удовлетворяющих условиям отбора\";\"Найдены";
    else
      MSGArr[MSGArr.size] = " \";\"Поиск клиентов, удовлетворяющих условиям отбора\";\"Не найдены";
    end;
  
    cmdClient = DL_RSDCommand(queryClient);
    DataSetClient = cmdClient.Execute();
    
    var RepObj;

    if(IsBefore2022)
      RepObj = Before2022NPTXObj;
    else
      RepObj = DataSetClient;
    end;
    
    while (RepObj.MoveNext())
      var Year = 0;
      var queryKBK, cmdKBK, DataKBK;
      var НОБ_15 = $0.0;
      var НОБ_Осн = $0.0;
      var isErrClient = false;
      var hasData = false;
      
      clearGlobal();
      if(IsBefore2022)
        rep = Before2022NPTXObj.getDataClient();
      else
        rep = DataSetClient;
      end;
      CreateTotalBook();
      Rate13 = TArray();
      Rate15 = TArray();
      sheet_name = GetSheetName();
      datesplit(SQL_ConvTypeDate(rep.DateT2), null, null, Year);
      UseNewSheetInTotalBook();
      
      if(IsBefore2022)
        Before2022NPTXObj.parseCodeForReg(Rate13, Rate15);
        KBKmain = "18210102010011000110";
        KBK15   = "18210102080011000110";
      else
        queryKBK =    " select tb.t_BCCHoldPITax, tb.t_RateHoldPITax, "
                 + "        NVL(SUM(tb.t_TaxBaseCurrPay), 0) as TaxBase "
                 + "   from " + TABLE_TOTALBASE + " tb "
                 + "  where tb.t_ClientID = ? "
                 + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                 + "    and tb.t_Type IN (1,2,3) "
                 + "    and ((tb.t_IncDate between ? and ?) or (tb.t_TaxPeriod = ? and EXTRACT(YEAR FROM tb.t_IncDate) <> ?) "
                 + "    and ? = TO_DATE('31.12.'||TO_CHAR(tb.t_TaxPeriod),'DD.MM.YYYY'))";

        if(isSlice)
         queryKBK = queryKBK + " and t_sliceID = " + m_SliceID + " ";
        end;

        queryKBK = queryKBK + " group by tb.t_BCCHoldPITax, tb.t_RateHoldPITax "
                       + " order by tb.t_BCCHoldPITax ASC, tb.t_RateHoldPITax ASC ";

        cmdKBK = DL_RSDCommand(queryKBK);
        cmdKBK.AddParam(rep.PartyID);
        cmdKBK.AddParam(rep.DateT1);
        cmdKBK.AddParam(rep.DateT2);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(rep.DateT2);
       
        DataKBK = cmdKBK.Execute();

        while(DataKBK.moveNext())
         hasData = true;

         if( ((DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT_15*100)) or (DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT*100))) and (rep.ResidenceStatus == 0))
           isErrClient = true;
         elif( (DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_NOTRESIDENT*100)) and (rep.ResidenceStatus == 1))
           isErrClient = true;
         end;

         if(DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT_15*100))
           НОБ_15 = НОБ_15 + ExtRound(DataKBK.TaxBase);
           KBK15  = DataKBK.BCCHoldPITax;
         else
           НОБ_Осн = НОБ_Осн + ExtRound(DataKBK.TaxBase);
           KBKmain = DataKBK.BCCHoldPITax;
         end;
        end;

        if (isErrClient and ((НОБ_Осн + НОБ_15) == 0))
         MSGArr[MSGArr.size] = " \";\" \";\"Ошибка. По клиенту " + rep.ClientFIO + " c ИД " + rep.PartyID + " не пересчитана НОБ при смене резидентства";
         UseProgress(num_ready = num_ready + 1);
         CONTINUE;
        end;

        if(hasData == false)
          MSGArr[MSGArr.size] = " \";\" \";\"Ошибка. По клиенту " + rep.ClientFIO + " c ИД " + rep.PartyID + " не найдены данные НОБ";
          UseProgress(num_ready = num_ready + 1);
         CONTINUE;
        end;

        CollectAllArrCodeParm(rep.PartyID, rep.DateT1, rep.DateT2, НОБ_Осн, НОБ_15, Rate13, Rate15);
      end;

      R1_2();
      R3();
      R4();
      R5();
      R6();
      R7();
      R8();
      Sign();

      if((ValType(CLients) == V_GENOBJ) and (CLients.Size == 1))
        clientsFileNameArr[clientsFileNameArr.size] = GetCurrName();
        SaveSubTotalBook(GetCurrName(), true);
      else
        clientsFileNameArr[clientsFileNameArr.size] = GetCurrName();
        SaveSubTotalBook(GetCurrName(), false);
      end;

      MSGArr[MSGArr.size] = " \";\"Формирование Регистра по клиенту "+ rep.ClientFIO +" с "+ rep.ClientINN +"\";\"Выполнено";

      UseProgress(num_ready = num_ready + 1);
    end;
  
    RemProgress();

    var fileArr = GetFullReportFileNames();
    var fileNum = 0;
    InitProgress(fileArr.size, "Копирование файлов в директорию", "Копирование файлов в директорию");
    while( fileNum < fileArr.size)
      CopyFile( "$" + fileArr(fileNum), "$" + folder + "\\" + clientsFileNameArr[fileNum] + ".xlsx");
      fileNum = fileNum + 1;
      UseProgress(fileNum);
    end;
    RemProgress();
  END;

  initDL_CReportTemplate(NULL, "Report_RegNDFL.xlsx", NULL, NULL, NULL, POI_MODE);
END;

/**
 @brief Класс регистра НДФЛ по срезу
 @param[in] _Investor Инвестор
 @param[in] _Report_date_end Дата окончания отчета
 @param[in] _Report_date_begin Дата начала отчета
 @param[in] _Folder Путь к папке для сохранения
 @param[in] _LoadFileRadio Флаг необходимости загрузки клиентов из файла 
 @param[in] _LoadFile Файл с клиентами для загрузки
 @param[in] _Clients Массив клиентов
 @param[in] _Oper Исполнитель
 @param[in] _Source Источник данных
 @param[in] _SourceNum Номер среза (если формировать по срезу)
 @param[in] _listMainObj Объекты сверки с основного отчета
 Класс необходимый для формирования данных для сверки
*/
private class (RegNDFL_Report) RegNDFL_Report_Data_slice (investor, report_date_end, report_date_begin, 
                                                          folder, loadFileRadio, loadFile, clients, oper, 
                                                          source, sourceNum, _listMainObj)
  var listMainObj = _listMainObj;

  /**
   @brief Получить следующий номер среза для периода
   @param[in] pBegDate дата начала периода
   @param[in] pEndDate дата конца периода
   @return Номер среза
  */
  private macro GetSliceNum(pBegDate, pEndDate):INTEGER
    var query = "select NVL(max(T_SLICENUM), -1) as t_SliceNum from DNPTXSLICE_DBT where T_DATEFROM = ? and T_DATETO = ? ";
    var cmd = DL_RSDCommand(query);
        cmd.AddParam(pBegDate);
        cmd.AddParam(pEndDate);

    var DataSet = cmd.Execute();
    if(DataSet.MoveNext())
      return DataSet.SliceNum;
    end;
    return "";
  END;

  private macro GetRepObjFromListByClient (ListObj, ClientID)
    for(rep, listMainObj)
      if(rep.PartyID == ClientID)
        return rep;
      end;  
    end;
    return NULL;
  END;

  /**
   @brief Формирование данных 3-го раздела отчета
  */
  private macro R3 ()
    var BaseTotal = initArrCodeLine();
    var PlusS = initArrCodeLine();
    var MinusS = initArrCodeLine();
    var NP = initArrCodeLine();
    var TaxCalculated = initArrCodeLine();
    var TaxPaid = initArrCodeLine();
    var TaxDue = initArrCodeLine();
    var TaxToReturnDue = initArrCodeLine();
    var TaxTransmited = initArrCodeLine();
    var TaxReturn = initArrCodeLine();
    var i = 0;
    var ArrCodePlusAll = TArray();
    var ArrCodeMinusAll = TArray();
    var ArrCodeLine = TArray();
    var idCodeInArr = -1;
    var rate = iif(rep.ResidenceStatus == 1, 0.13, 0.3 );
    var queryBase, cmdBase, DataBase;
    var Year = 0;
    
    datesplit(pReport_date_end, null, null, Year);
    
    TaxCalculatedSum = $0;
    TaxPaidSum = $0;
    TaxTransmittedSum = $0;
    TaxDueSum = $0;
    TaxToReturnDueSum = $0;

    if(Rate13.size <= 0) 
      if(pNeedCompare)
        CompareObjList[CompareObjList.size] = c_compare_obj(rep.Num, rep.PartyID, OurKPP(), OurOKTMO(), rep.FIO, rate*100, 
                                                            KBKmain, $0, TaxCalculatedSum, TaxPaidSum, TaxDueSum);
      end;
    end;

    i = 0;
    while (i < Rate13.size)
      if(Rate13[i].ArrCodes.Plus.ArrSumMount[0].Sum > $0)
        idCodeInArr = hasCode(ArrCodePlusAll, Rate13[i].ArrCodes.Plus.CodeNum);
        if(idCodeInArr >= 0)
          ArrCodePlusAll[idCodeInArr].ArrSumMount[Rate13[i].Month] = Rate13[i].ArrCodes.Plus.ArrSumMount[0].Sum;
        else
          ArrCodeLine = initArrCodeLine();
          ArrCodeLine[Rate13[i].Month] = Rate13[i].ArrCodes.Plus.ArrSumMount[0].Sum;
          ArrCodePlusAll[ArrCodePlusAll.size] = c_CodeNRDMonth(Rate13[i].ArrCodes.Plus.Kind, Rate13[i].ArrCodes.Plus.Code, Rate13[i].ArrCodes.Plus.CodeNum, ArrCodeLine)
        end;
      end;
      
      var iCodeMinus = 0;
      while ( iCodeMinus < Rate13[i].ArrCodes.ArrMinus.size)
        if(Rate13[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum > $0)
          idCodeInArr = hasCode(ArrCodeMinusAll, Rate13[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum);
          if(idCodeInArr >= 0)
            ArrCodeMinusAll[idCodeInArr].ArrSumMount[Rate13[i].Month] = Rate13[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
          else
            ArrCodeLine = initArrCodeLine();
            ArrCodeLine[Rate13[i].Month] = Rate13[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
            ArrCodeMinusAll[ArrCodeMinusAll.size] = c_CodeNRDMonth(Rate13[i].ArrCodes.ArrMinus[iCodeMinus].Kind, Rate13[i].ArrCodes.ArrMinus[iCodeMinus].Code, 
                                                                   Rate13[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum, ArrCodeLine)
          end;
        end;
        iCodeMinus = iCodeMinus + 1;
      end;
      i = i + 1;
    end;
    
    i = 0;
    while(i < ArrCodePlusAll.size)
      PlusS[1] = PlusS[1] + ArrCodePlusAll[i].ArrSumMount[1];
      PlusS[2] = PlusS[2] + ArrCodePlusAll[i].ArrSumMount[2];
      PlusS[3] = PlusS[3] + ArrCodePlusAll[i].ArrSumMount[3];
      PlusS[4] = PlusS[4] + ArrCodePlusAll[i].ArrSumMount[4];
      PlusS[5] = PlusS[5] + ArrCodePlusAll[i].ArrSumMount[5];
      PlusS[6] = PlusS[6] + ArrCodePlusAll[i].ArrSumMount[6];
      PlusS[7] = PlusS[7] + ArrCodePlusAll[i].ArrSumMount[7];
      PlusS[8] = PlusS[8] + ArrCodePlusAll[i].ArrSumMount[8];
      PlusS[9] = PlusS[9] + ArrCodePlusAll[i].ArrSumMount[9];
      PlusS[10] = PlusS[10] + ArrCodePlusAll[i].ArrSumMount[10];
      PlusS[11] = PlusS[11] + ArrCodePlusAll[i].ArrSumMount[11];
      PlusS[12] = PlusS[12] + ArrCodePlusAll[i].ArrSumMount[12];

      i = i + 1;
    end;

    i = 0;
    while(i < ArrCodeMinusAll.size)
      MinusS[1] = MinusS[1] + ArrCodeMinusAll[i].ArrSumMount[1];
      MinusS[2] = MinusS[2] + ArrCodeMinusAll[i].ArrSumMount[2];
      MinusS[3] = MinusS[3] + ArrCodeMinusAll[i].ArrSumMount[3];
      MinusS[4] = MinusS[4] + ArrCodeMinusAll[i].ArrSumMount[4];
      MinusS[5] = MinusS[5] + ArrCodeMinusAll[i].ArrSumMount[5];
      MinusS[6] = MinusS[6] + ArrCodeMinusAll[i].ArrSumMount[6];
      MinusS[7] = MinusS[7] + ArrCodeMinusAll[i].ArrSumMount[7];
      MinusS[8] = MinusS[8] + ArrCodeMinusAll[i].ArrSumMount[8];
      MinusS[9] = MinusS[9] + ArrCodeMinusAll[i].ArrSumMount[9];
      MinusS[10] = MinusS[10] + ArrCodeMinusAll[i].ArrSumMount[10];
      MinusS[11] = MinusS[11] + ArrCodeMinusAll[i].ArrSumMount[11];
      MinusS[12] = MinusS[12] + ArrCodeMinusAll[i].ArrSumMount[12];

      i = i + 1;
    end;

    i = 1;
    var TaxCalculatedTotal =$0.0;
    while (i <= 12)
      BaseTotal[i] = PlusS[i] - MinusS[i] + iif(i == 1, 0, BaseTotal[i-1]);
      TaxCalculated[i] = Round((BaseTotal[i] * rate), 0) - TaxCalculatedTotal;
      TaxCalculatedTotal = TaxCalculatedTotal + TaxCalculated[i];
      i = i + 1;
    end;
    if(IsBefore2022)
      var ArrNDR = Tarray();
      var ArrNDR3BaseG1 = initArrCodeLine();
      var ArrNDR3BaseSpecial = initArrCodeLine();
      var SumP = $0.0;

      GetSum(rep.PartyID, "" + TXOBJ_PAIDMATERIAL
                       + "," + TXOBJ_PAIDGENERAL
                       + "," + TXOBJ_PAIDSPECIAL
                       + "," + TXOBJ_PAIDMATERIAL_IIS
                       + "," + TXOBJ_PAIDGENERAL_IIS
                       + "," + TXOBJ_PAIDSPECIAL_IIS
                       + "," + TXOBJ_PAIDBILL
                       + "," + TXOBJ_DIVPAY_SEC, pReport_date_begin, pReport_date_end, @SumP, NULL, "", ArrNDR);

      GetSum(rep.PartyID, "" + TXOBJ_BASEG1_13, pReport_date_begin, pReport_date_end, @SumP, NULL, "", ArrNDR3BaseG1);
      GetSum(rep.PartyID, "" + TXOBJ_BASESPECIAL_DIV, pReport_date_begin, pReport_date_end, @SumP, NULL, "", ArrNDR3BaseSpecial);

      i = 0;
      while (i < ArrNDR.size)
        TaxPaid[ArrNDR[i].Month] = TaxPaid[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum > $0, ABS(ArrNDR[i].Sum), $0);
        TaxToReturnDue[ArrNDR[i].Month] = TaxToReturnDue[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum < $0, ABS(ArrNDR[i].Sum), $0);
        
        if(TaxPaid[ArrNDR[i].Month] <= TaxCalculated[ArrNDR[i].Month])
          TaxDue[ArrNDR[i].Month] = ExtRound(TaxCalculated[ArrNDR[i].Month], 0) - ExtRound(TaxPaid[ArrNDR[i].Month] + ArrNDR3BaseG1[ArrNDR[i].Month] - ArrNDR3BaseSpecial[ArrNDR[i].Month], 0 ) 
                                             - ExtRound(TaxToReturnDue[ArrNDR[i].Month], 0);
          TaxReturn[ArrNDR[i].Month] = $0.0;                     
        else
          TaxDue[ArrNDR[i].Month] = $0.0;
          TaxReturn[ArrNDR[i].Month] = ExtRound(TaxPaid[ArrNDR[i].Month], 0) - ExtRound(TaxCalculated[ArrNDR[i].Month], 0) + ExtRound(TaxToReturnDue[ArrNDR[i].Month], 0);
        end;

        i = i + 1;
      end;
    else
      queryBase =   " select tb.T_HOLDPITAX, tb.T_INCDATE, "
                  + "        tb.t_Type, EXTRACT (MONTH FROM tb.T_INCDATE) as t_MONTH, "
                  + "        EXTRACT (YEAR FROM tb.T_INCDATE) as t_Year "
                  + "   from " + TABLE_TOTALBASE + " tb "
                  + "  where tb.t_ClientID = ? "
                  + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                  + "    and tb.t_Type IN (1,2,3) "
                  + "    and tb.t_RateHoldPITax <> " + int(NPTXGENTAXRATE_RESIDENT_15*100)
                  + "    and tb.t_TaxPeriod = ? ";
      if(isSlice)
        queryBase = queryBase + " and t_sliceID = " + m_SliceID + " ";
      end;

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
       
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        if(DataBase.HOLDPITAX > 0) 
            if(DataBase.Year == Year)
              TaxPaid[DataBase.MONTH] = TaxPaid[DataBase.MONTH] + Round(DataBase.HOLDPITAX, 0);
            else
              TaxPaid[12] = TaxPaid[12] + Round(DataBase.HOLDPITAX, 0);
            end;
        end;
        
        if(DataBase.HOLDPITAX < 0)
            if(DataBase.Year == Year)
              TaxReturn[DataBase.MONTH] = TaxReturn[DataBase.MONTH] + Abs(ExtRound(DataBase.HOLDPITAX));
            else
              TaxReturn[12] = TaxReturn[12] + Abs(ExtRound(DataBase.HOLDPITAX));
            end;
        end;
      end;
      
      i = 1;
      while (i <= 12)
        TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] > 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0);
        TaxToReturnDue[i] = Abs(iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] < 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0));
        i = i + 1;
      end;
    end;
    
    TaxCalculatedSum = abs(getSumArr(TaxCalculated));
    TaxPaidSum = abs(getSumArr(TaxPaid));
    TaxTransmittedSum = abs(getSumArr(TaxTransmited));
    TaxDueSum = abs(iif(getSumArr(TaxDue) - getSumArr(TaxToReturnDue) > 0, getSumArr(TaxDue) - getSumArr(TaxToReturnDue), $0));
    TaxToReturnDueSum = abs(iif(getSumArr(TaxToReturnDue) - getSumArr(TaxDue) > 0, getSumArr(TaxToReturnDue) - getSumArr(TaxDue), $0));

    if(pNeedCompare)
      CompareObjList[CompareObjList.size] = c_compare_obj(rep.Num, rep.PartyID, OurKPP(), OurOKTMO(), rep.FIO, rate*100, 
                                                          KBKmain, BaseTotal[12], TaxCalculatedSum, TaxPaidSum, TaxDueSum);
    end;
  END;

  /**
   @brief Формирование данных 4-го раздела отчета
  */
  private macro R4 ()
   var BaseTotal = initArrCodeLine();
    var PlusS = initArrCodeLine();
    var MinusS = initArrCodeLine();
    var NP = initArrCodeLine();
    var TaxCalculated = initArrCodeLine();
    var TaxPaid = initArrCodeLine();
    var TaxDue = initArrCodeLine();
    var TaxToReturnDue = initArrCodeLine();
    var TaxTransmited = initArrCodeLine();
    var TaxReturn = initArrCodeLine();
    var ArrCodePlusAll = TArray();
    var ArrCodeMinusAll = TArray();
    var ArrCodeLine = TArray();
    var i = 0;
    var idCodeInArr = -1;
    var rate = NPTXGENTAXRATE_RESIDENT_15;
    var queryBase, cmdBase, DataBase;
    var Year = 0;
     
    datesplit(pReport_date_end, null, null, Year);
    TaxCalculated15Sum = $0.0;
    TaxPaid15Sum = $0.0;
    TaxTransmitted15Sum = $0.0;
    TaxDue15Sum = $0.0;
    TaxToReturnDue15Sum = $0.0;

    if(Rate15.size <= 0) 
      if(pNeedCompare)
        CompareObjList[CompareObjList.size] = c_compare_obj(rep.Num, rep.PartyID, OurKPP(), OurOKTMO(), rep.FIO, rate*100, 
                                                            KBK15, $0, TaxCalculated15Sum, TaxPaid15Sum, TaxDue15Sum);
      end;
    end;

    i = 0;
    while (i < Rate15.size)
      if(Rate15[i].ArrCodes.Plus.ArrSumMount[0].Sum > $0)
        idCodeInArr = hasCode(ArrCodePlusAll, Rate15[i].ArrCodes.Plus.CodeNum);
        if(idCodeInArr >= 0)
          ArrCodePlusAll[idCodeInArr].ArrSumMount[Rate15[i].Month] = Rate15[i].ArrCodes.Plus.ArrSumMount[0].Sum;
        else
          ArrCodeLine = initArrCodeLine();
          ArrCodeLine[Rate15[i].Month] = Rate15[i].ArrCodes.Plus.ArrSumMount[0].Sum;
          ArrCodePlusAll[ArrCodePlusAll.size] = c_CodeNRDMonth(Rate15[i].ArrCodes.Plus.Kind, Rate15[i].ArrCodes.Plus.Code, Rate15[i].ArrCodes.Plus.CodeNum, ArrCodeLine)
        end;
      end;
      
      var iCodeMinus = 0;
      while ( iCodeMinus < Rate15[i].ArrCodes.ArrMinus.size)
        if(Rate15[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum > $0)
          idCodeInArr = hasCode(ArrCodeMinusAll, Rate15[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum);
          if(idCodeInArr >= 0)
            ArrCodeMinusAll[idCodeInArr].ArrSumMount[Rate15[i].Month] = Rate15[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
          else
            ArrCodeLine = initArrCodeLine();
            ArrCodeLine[Rate15[i].Month] = Rate15[i].ArrCodes.ArrMinus[iCodeMinus].ArrSumMount[0].Sum;
            ArrCodeMinusAll[ArrCodeMinusAll.size] = c_CodeNRDMonth(Rate15[i].ArrCodes.ArrMinus[iCodeMinus].Kind, Rate15[i].ArrCodes.ArrMinus[iCodeMinus].Code, 
                                                                   Rate15[i].ArrCodes.ArrMinus[iCodeMinus].CodeNum, ArrCodeLine)
          end;
        end;
        iCodeMinus = iCodeMinus + 1;
      end;
      i = i + 1;
    end;
    
    i = 0;
    while(i < ArrCodePlusAll.size)
      PlusS[1] = PlusS[1] + ArrCodePlusAll[i].ArrSumMount[1];
      PlusS[2] = PlusS[2] + ArrCodePlusAll[i].ArrSumMount[2];
      PlusS[3] = PlusS[3] + ArrCodePlusAll[i].ArrSumMount[3];
      PlusS[4] = PlusS[4] + ArrCodePlusAll[i].ArrSumMount[4];
      PlusS[5] = PlusS[5] + ArrCodePlusAll[i].ArrSumMount[5];
      PlusS[6] = PlusS[6] + ArrCodePlusAll[i].ArrSumMount[6];
      PlusS[7] = PlusS[7] + ArrCodePlusAll[i].ArrSumMount[7];
      PlusS[8] = PlusS[8] + ArrCodePlusAll[i].ArrSumMount[8];
      PlusS[9] = PlusS[9] + ArrCodePlusAll[i].ArrSumMount[9];
      PlusS[10] = PlusS[10] + ArrCodePlusAll[i].ArrSumMount[10];
      PlusS[11] = PlusS[11] + ArrCodePlusAll[i].ArrSumMount[11];
      PlusS[12] = PlusS[12] + ArrCodePlusAll[i].ArrSumMount[12];

      i = i + 1;
    end;
    
    i = 0;
    while(i < ArrCodeMinusAll.size)
      MinusS[1] = MinusS[1] + ArrCodeMinusAll[i].ArrSumMount[1];
      MinusS[2] = MinusS[2] + ArrCodeMinusAll[i].ArrSumMount[2];
      MinusS[3] = MinusS[3] + ArrCodeMinusAll[i].ArrSumMount[3];
      MinusS[4] = MinusS[4] + ArrCodeMinusAll[i].ArrSumMount[4];
      MinusS[5] = MinusS[5] + ArrCodeMinusAll[i].ArrSumMount[5];
      MinusS[6] = MinusS[6] + ArrCodeMinusAll[i].ArrSumMount[6];
      MinusS[7] = MinusS[7] + ArrCodeMinusAll[i].ArrSumMount[7];
      MinusS[8] = MinusS[8] + ArrCodeMinusAll[i].ArrSumMount[8];
      MinusS[9] = MinusS[9] + ArrCodeMinusAll[i].ArrSumMount[9];
      MinusS[10] = MinusS[10] + ArrCodeMinusAll[i].ArrSumMount[10];
      MinusS[11] = MinusS[11] + ArrCodeMinusAll[i].ArrSumMount[11];
      MinusS[12] = MinusS[12] + ArrCodeMinusAll[i].ArrSumMount[12];

      i = i + 1;
    end;

    i = 1;
    var TaxCalculatedTotal =$0.0;
    while (i <= 12)
      BaseTotal[i] = PlusS[i] - MinusS[i] + iif(i == 1, 0, BaseTotal[i-1]);
      TaxCalculated[i] = Round((BaseTotal[i] * rate), 0) - TaxCalculatedTotal;
      TaxCalculatedTotal = TaxCalculatedTotal + TaxCalculated[i];
      i = i + 1;
    end;
    if(IsBefore2022)
      var ArrNDR = Tarray();
      var ArrNDR3BaseG1 = initArrCodeLine();
      var ArrNDR3BaseSpecial = initArrCodeLine();
      var SumP = $0.0;

      GetSum(rep.PartyID, "" + TXOBJ_PAIDGENERAL_15_1
                       + "," + TXOBJ_PAIDGENERAL_15_2
                       + "," + TXOBJ_PAIDGENERAL_15_9
                       + "," + TXOBJ_PAIDGENERAL_15_IIS, pReport_date_begin, pReport_date_end, @SumP, NULL, "", ArrNDR);

      GetSum(rep.PartyID, "" + TXOBJ_BASEG1_15, pReport_date_begin, pReport_date_end, @SumP, NULL, "", ArrNDR3BaseG1);
      GetSum(rep.PartyID, "" + TXOBJ_BASESPECIAL_DIV_15, pReport_date_begin, pReport_date_end, @SumP, NULL, "", ArrNDR3BaseSpecial);

      i = 0;
      while (i < ArrNDR.size)
        TaxPaid[ArrNDR[i].Month] = TaxPaid[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum > $0, ABS(ArrNDR[i].Sum), $0);
        TaxToReturnDue[ArrNDR[i].Month] = TaxToReturnDue[ArrNDR[i].Month] + IIF(ArrNDR[i].Sum < $0, ABS(ArrNDR[i].Sum), $0);
        
        if(TaxPaid[ArrNDR[i].Month] <= TaxCalculated[ArrNDR[i].Month])
          TaxDue[ArrNDR[i].Month] = ExtRound(TaxCalculated[ArrNDR[i].Month], 0) - ExtRound(TaxPaid[ArrNDR[i].Month] + ArrNDR3BaseG1[ArrNDR[i].Month] - ArrNDR3BaseSpecial[ArrNDR[i].Month], 0 ) 
                                             - ExtRound(TaxToReturnDue[ArrNDR[i].Month], 0);
          TaxReturn[ArrNDR[i].Month] = $0.0;
        else
          TaxDue[ArrNDR[i].Month] = $0.0;
          TaxReturn[ArrNDR[i].Month] = ExtRound(TaxPaid[ArrNDR[i].Month], 0) - ExtRound(TaxCalculated[ArrNDR[i].Month], 0) + ExtRound(TaxToReturnDue[ArrNDR[i].Month], 0);
        end;

        i = i + 1;
      end;
    else
      queryBase =     " select tb.T_HOLDPITAX, tb.T_INCDATE, "
                  + "        tb.t_Type, EXTRACT (MONTH FROM tb.T_INCDATE) as t_MONTH, "
                  + "        EXTRACT (YEAR FROM tb.T_INCDATE) as t_Year "
                  + "   from " + TABLE_TOTALBASE + " tb "
                  + "  where tb.t_ClientID = ? "
                  + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                  + "    and tb.t_Type IN (1,2,3) "
                  + "    and tb.t_RateHoldPITax = " + int(NPTXGENTAXRATE_RESIDENT_15*100)
                  + "    and tb.t_TaxPeriod = ? ";

      if(isSlice)
        queryBase = queryBase + " and t_sliceID = " + m_SliceID + " ";
      end;

      cmdBase = DL_RSDCommand(queryBase);
      cmdBase.AddParam(rep.PartyID);
      cmdBase.AddParam(Year);
       
      DataBase = cmdBase.Execute();

      while(DataBase.moveNext())
        if(DataBase.HOLDPITAX > 0)
            if(DataBase.Year == Year)
              TaxPaid[DataBase.MONTH] = TaxPaid[DataBase.MONTH] + Round(DataBase.HOLDPITAX, 0);
            else
              TaxPaid[12] = TaxPaid[12] + Round(DataBase.HOLDPITAX, 0);
            end;
        end;
        
        if(DataBase.HOLDPITAX < 0)
            if(DataBase.Year == Year)
              TaxReturn[DataBase.MONTH] = TaxReturn[DataBase.MONTH] + Abs(ExtRound(DataBase.HOLDPITAX));
            else
              TaxReturn[12] = TaxReturn[12] + Abs(ExtRound(DataBase.HOLDPITAX));
            end;
        end;
      end;

      i = 1;
      while (i <= 12)
        TaxDue[i] = iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] > 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0);
        TaxToReturnDue[i] = Abs(iif(TaxCalculated[i] - TaxPaid[i] + TaxReturn[i] < 0, TaxCalculated[i] - TaxPaid[i] + TaxReturn[i], $0));
        i = i + 1;
      end;
    end;


    TaxCalculated15Sum = abs(getSumArr(TaxCalculated));
    TaxPaid15Sum = abs(getSumArr(TaxPaid));
    TaxTransmitted15Sum = abs(getSumArr(TaxTransmited));
    TaxDue15Sum = abs(iif(getSumArr(TaxDue) - getSumArr(TaxToReturnDue) > 0, getSumArr(TaxDue) - getSumArr(TaxToReturnDue), $0));
    TaxToReturnDue15Sum = abs(iif(getSumArr(TaxToReturnDue) - getSumArr(TaxDue) > 0, getSumArr(TaxToReturnDue) - getSumArr(TaxDue), $0));

    if(pNeedCompare)
      CompareObjList[CompareObjList.size] = c_compare_obj(rep.Num, rep.PartyID, OurKPP(), OurOKTMO(), rep.FIO, rate*100, 
                                                          KBK15, BaseTotal[12], TaxCalculated15Sum, TaxPaid15Sum, TaxDue15Sum);
    end;
  END;

  /**
   @brief Формирование данных
  */
  private macro Create()
    var investor          = pInvestor;
    var report_date_end   = pReport_date_end;
    var report_date_begin = pReport_date_begin;
    var folder            = pFolder;
    var LoadFileRadio     = pLoad_file_radio;
    var LoadFile          = pLoadFile;
    var Clients           = pClients;
    var Source            = pSource;
    var SourceNum         = pSourceNum;
    var count = 0, num_ready = 0;
    var isErrClient = false;
    var hasData = false;

    m_TaxAgentParm = TaxAgentParm();
    m_TaxAgentParm.Load();

    isSlice = iif((Source == DL_SLICE), true, false);
    
    if(isSlice)
      m_SliceID = getSliceID (report_date_begin, report_date_end, SourceNum) ;
      TABLE_TOTALBASE = NPTXSLICEBASE;
      TABLE_NPTXOBJ = NPTXSLICEOBJ;
    end;

    if(report_date_end <= date(31,12,2022))
      IsBefore2022 =  true;
      Before2022NPTXObj = NPTXRepCalc_NPTXPIT6_NEW_2_REG(0 ,report_date_begin, report_date_end, isSlice, m_SliceID, "DNPTX6CLIENT_TMP");
    end;

    setisshowAppl(false);

    InitProgress(listMainObj.size, "Регистр НДФЛ данные для сверки", "Регистр НДФЛ данные для сверки");

    var prevPartyId = 0;
    if(IsBefore2022)
      while(Before2022NPTXObj.Next())
        rep = GetRepObjFromListByClient(listMainObj, Before2022NPTXObj.ClientID());
        if(ValType(rep) != V_GENOBJ)
          MSGArr[MSGArr.size] = "Ошибка. По клиенту c ИД " + Before2022NPTXObj.ClientID() + " не удалось сформировать данные для сверки";
          CONTINUE;
        end;
        
        Rate13 = TArray();
        Rate15 = TArray();
        Before2022NPTXObj.parseCodeForReg(Rate13, Rate15);

        R3();
        R4();

        UseProgress(num_ready = num_ready + 1);
      end;
    else
      for(rep, listMainObj)
        Rate13 = TArray();
        Rate15 = TArray();
        hasData = false;

        if(rep.PartyID == prevPartyId)
          CONTINUE;
        else
          prevPartyId = rep.PartyID;
        end;

        var Year = 0;
        datesplit(report_date_end, null, null, Year);
        var queryKBK, cmdKBK, DataKBK;
        var НОБ_15 = $0.0;
        var НОБ_Осн = $0.0;
       
        queryKBK =  " select tb.t_BCCHoldPITax, tb.t_RateHoldPITax, "
                  + "        NVL(SUM(tb.t_TaxBaseCurrPay), 0) as TaxBase "
                  + "   from " + TABLE_TOTALBASE + " tb "
                  + "  where tb.t_ClientID = ? "
                  + "    and tb.t_StorState = " + NPTXTOTALBASE_STORSTATE_ACTIVE
                  + "    and tb.t_Type IN (1,2,3) "
                  + "    and ((tb.t_IncDate between ? and ?) or (tb.t_TaxPeriod = ? and EXTRACT(YEAR FROM tb.t_IncDate) <> ?) "
                  + "    and ? = TO_DATE('31.12.'||TO_CHAR(tb.t_TaxPeriod),'DD.MM.YYYY'))";

        if(isSlice)
          queryKBK = queryKBK + " and t_sliceID = " + m_SliceID + " ";
        end;

        queryKBK = queryKBK + " group by tb.t_BCCHoldPITax, tb.t_RateHoldPITax "
                       + " order by tb.t_BCCHoldPITax ASC, tb.t_RateHoldPITax ASC ";

        cmdKBK = DL_RSDCommand(queryKBK);
        cmdKBK.AddParam(rep.PartyID);
        cmdKBK.AddParam(report_date_begin);
        cmdKBK.AddParam(report_date_end);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(Year);
        cmdKBK.AddParam(report_date_end);
       
        DataKBK = cmdKBK.Execute();

        while(DataKBK.moveNext())
            hasData = true;
            if( ((DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT_15*100)) or (DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT*100))) and (rep.ResidenceStatus == 0))
              isErrClient = true;
            elif( (DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_NOTRESIDENT*100)) and (rep.ResidenceStatus == 1))
              isErrClient = true;
            end;
          
            if(DataKBK.RateHoldPITax == int(NPTXGENTAXRATE_RESIDENT_15*100))
              НОБ_15 = НОБ_15 + ExtRound(DataKBK.TaxBase);
              KBK15 = DataKBK.BCCHoldPITax;
            else
              НОБ_Осн = НОБ_Осн + ExtRound(DataKBK.TaxBase);
              KBKmain = DataKBK.BCCHoldPITax;
          end;
        end;

        if (isErrClient and ((НОБ_Осн + НОБ_15) == 0))
            UseProgress(num_ready = num_ready + 1);
            CONTINUE;
        end;

        if(hasData == false)
            UseProgress(num_ready = num_ready + 1);
            CONTINUE;
        end;

        CollectAllArrCodeParm(rep.PartyID, report_date_begin, report_date_end, НОБ_Осн, НОБ_15, Rate13, Rate15);

        R3();
        R4();

        UseProgress(num_ready = num_ready + 1);
      end;
    end;
    RemProgress();
  END;

  initRegNDFL_Report(investor, report_date_end, report_date_begin, 
                     "", loadFileRadio, loadFile, clients, oper, 
                     DL_SLICE, GetSliceNum(report_date_begin, report_date_end), true);
  
END;

/**
 @brief Класс протокола сверки
 @param[in] _CompareObjListMain Массив объектов сверки основного отчета c_compare_obj
 @param[in] _CompareObjListSlice Массив объектов сверки среза c_compare_obj
*/
private class (DL_CReportTemplate) RegNDFL_Report_Compare (_CompareObjListMain:TArray, _CompareObjListSlice:TArray)
  private var CompareObjListMain  = _CompareObjListMain;
  private var CompareObjListSlice = _CompareObjListSlice;
  private var SHEET_1 = "Список регистров с ошибками";
  private var SHEET_2 = "Протокол результатов сверки";
  private var CountStringTable1 = 0;
  private var CountStringTable2 = 0;
  private var hasData = false;

  /**
   @brief Получить номер следующей строки таблицы 1
   @return Номер следующей строки таблицы 1
  */
  private macro nextStringTable1()
    CountStringTable1 = CountStringTable1 + 1;
    return CountStringTable1;
  END;

  /**
   @brief Получить номер следующей строки таблицы 2
   @return Номер следующей строки таблицы 2
  */
  private macro nextStringTable2()
    CountStringTable2 = CountStringTable2 + 1;
    return CountStringTable2;
  END;

  /**
   @brief Формат печати
   @return DL_OUTREPORT_EXCEL
  */
  macro PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;
  
  /**
   @brief Начало отчета
  */
  private macro BeginReport()
    CreateTotalBook();
  END;

  /**
   @brief Конец отчета
  */
  private macro EndReport()
    if (hasData)
      SaveTotalBook();
    else
      setisshowAppl(false);
    end;
  END;

  /**
   @brief Печать строки 1 таблицы
   @param[in] reg Объект сравнения регистра c_compare_obj
  */
  private macro PrintLineTable1(reg)
    PrintTableLine( "N1_Num",          nextStringTable1(), null,
                    "N1_Reg_num",      reg.Num,            null,
                    "N1_FIO",          reg.FIO,            null,
                    "N1_ID_SOFR",      reg.PartyID,        null,
                    "N1_KPP",          reg.KPP,            null,
                    "N1_OKTMO",        reg.OKTMO,          null
                   );
  END;

  /**
   @brief Печать строки 2 таблицы
   @param[in] reg Объект сравнения регистра c_compare_obj
   @param[in] PrmName Наименование параметра
   @param[in] PrmMain Показатель параметра с регистра
   @param[in] PrmSlice Показатель параметра среза
  */
  private macro PrintLineTable2(reg, PrmName, PrmMain, PrmSlice)
    PrintTableLine( "N2_Num",           nextStringTable2(),         null,
                    "N2_Reg_num",       reg.Num,         null,
                    "N2_FIO",           reg.FIO,         null,
                    "N2_ID_SOFR",       reg.PartyID,         null,
                    "N2_KPP",           reg.KPP,         null,
                    "N2_OKTMO",         reg.OKTMO,         null,
                    "N2_Rate",          reg.Rate,         null,
                    "N2_KBK",           reg.KBK,         null,
                    "N2_NamePrm",       PrmName,         null,
                    "N2_Prm6NDFL",      PrmSlice,         null,
                    "N2_PrmReg",        PrmMain,         null,
                    "N2_PlanRes",       "РАВЕНСТВО",         null,
                    "N2_FactRes",       (PrmSlice - PrmMain),         null
                   );
  END;

  /**
   @brief Получить объект для сравнения
   @param[in] obj Объект сравнения регистра c_compare_obj
  */
  private macro getCompareObjByMain(obj)
    var SliceObj;
    for(SliceObj, CompareObjListSlice)
      if( (obj.PartyId == SliceObj.PartyId) and 
          (obj.Rate == SliceObj.Rate) and 
          (obj.KBK == SliceObj.KBK)
        )
        return SliceObj;
      end;
    end;
    return NULL;
  END;

  /**
   @brief Печать таблицы 1
  */
  private macro printRegList()
    var compareObjMain;
    var prevObj = NULL;
    var num_ready = 0;
    SetActiveSheet( SHEET_1 );
    
    PrintFormatString(NULL, "N1_Header");
    
    CopyAllSheetInTotalBook( SHEET_1, false, "N1_Header", 0, SHEET_1 );
    
    RegisterTable( "N1_TableLine", "",
                   "N1_Num", "N2_Reg_num", "N1_FIO", "N1_ID_SOFR", "N1_KPP", "N1_OKTMO"
                  );
    
    InitProgress(CompareObjListMain.size, "Регистр НДФЛ 1 лист сверки", "Регистр НДФЛ 1 лист сверки");

    var wasMsg = false;
    for (compareObjMain ,CompareObjListMain)
      if( (prevObj != NULL) and (compareObjMain.PartyID != prevObj.PartyID) )
        if(wasMsg == false) 
          MSGArr[MSGArr.size] = " \";\"Выявление расхождений по клиенту "+ prevObj.FIO +" с "+ prevObj.INN +"\";\"Расхождения не выявлены"; 
        end;
        prevObj = compareObjMain;
        wasMsg = false;
      end;
      
      var compareObjSlice = getCompareObjByMain(compareObjMain);
      
      if(compareObjSlice == NULL) CONTINUE; end;
      
      if( (compareObjMain.BaseSum != compareObjSlice.BaseSum) or
          (compareObjMain.Calculated != compareObjSlice.Calculated) or
          (compareObjMain.Paid != compareObjSlice.Paid) or
          (compareObjMain.Due != compareObjSlice.Due)
        )
        hasData = true;
        if(wasMsg == false) 
          MSGArr[MSGArr.size] = " \";\"Выявление расхождений по клиенту "+ compareObjMain.FIO +" с "+ compareObjMain.INN +"\";\"Расхождения выявлены";
          wasMsg = true;
          PrintLineTable1(compareObjMain);
        end;
      end;

      if(prevObj == NULL)
        prevObj = c_compare_obj(compareObjMain.Num, compareObjMain.PartyID, compareObjMain.KPP, compareObjMain.OKTMO, compareObjMain.FIO, compareObjMain.Rate, 
                                compareObjMain.KBK, compareObjMain.BaseSum, compareObjMain.Calculated, compareObjMain.Paid, compareObjMain.Due, "", compareObjMain.INN);
      end;
      UseProgress(num_ready = num_ready + 1);
    end;
    
    if( (wasMsg == false) and (CompareObjListMain.size > 0) )
      MSGArr[MSGArr.size] = "\" \";\"Выявление расхождений по клиенту "+ CompareObjListMain[CompareObjListMain.size-1].FIO +" с "+ CompareObjListMain[CompareObjListMain.size-1].INN +"\";\"Расхождения не выявлены\""; 
    end;
    
    EndTable();
    CopyAllSheetInTotalBook( SHEET_1, false, GetTableRange(), 0, SHEET_1 );
    RemProgress();
  END;

  /**
   @brief Печать таблицы 2
  */
  private macro printResCompare()
    var compareObjMain;
    var num_ready = 0;

    SetActiveSheet( SHEET_2 );
    
    PrintFormatString(NULL, "N2_Header");
    
    CopyAllSheetInTotalBook( SHEET_2, false, "N2_Header", 0, SHEET_2 );
    
    RegisterTable( "N2_TableLine", "",
                   "N2_Num", "N2_Reg_num", "N2_FIO", "N2_ID_SOFR", "N2_KPP", "N2_OKTMO", "N2_Rate", "N2_KBK", "N2_NamePrm", "N2_Prm6NDFL", "N2_PrmReg", "N2_PlanRes", "N2_FactRes"
                  );
    
    InitProgress(CompareObjListMain.size, "Регистр НДФЛ 2 лист сверки", "Регистр НДФЛ 2 лист сверки");

    for (compareObjMain ,CompareObjListMain)
      var compareObjSlice = getCompareObjByMain(compareObjMain);
      
      if(compareObjSlice == NULL) CONTINUE; end;
      
      if(compareObjMain.BaseSum != compareObjSlice.BaseSum)
        PrintLineTable2(compareObjMain, "налоговая база", compareObjMain.BaseSum, compareObjSlice.BaseSum);
      end;
      
      if(compareObjMain.Calculated != compareObjSlice.Calculated)
        PrintLineTable2(compareObjMain, "налог исчисленный", compareObjMain.Calculated, compareObjSlice.Calculated);
      end;
      
      if(compareObjMain.Paid != compareObjSlice.Paid)
        PrintLineTable2(compareObjMain, "налог удержанный", compareObjMain.Paid, compareObjSlice.Paid);
      end;
      
      if(compareObjMain.Due != compareObjSlice.Due)
        PrintLineTable2(compareObjMain, "сумма неудержанного налога", compareObjMain.Due, compareObjSlice.Due);
      end;

      UseProgress(num_ready = num_ready + 1);
    end;
    
    EndTable();
    CopyAllSheetInTotalBook( SHEET_2, false, GetTableRange(), 0, SHEET_2 );
    RemProgress();
  END;

  /**
   @brief Создать отчет
  */
  private macro Create()
    printRegList();
    if (hasData)
      printResCompare();
    end;
  END;

  initDL_CReportTemplate(NULL, "Report_RegNDFL_Compare.xlsx", NULL, NULL, NULL, POI_MODE);
END;

/**
 @brief Сформировать протокол
*/
private macro makeProtocol()
  if(MSGArr.size > 0)
    var csvFile = C_CSVFile ();
    var Rep = CTemplateXLS(NULL, NULL, NULL, NULL, NULL, NULL, true, false);
    if(Rep.UsePoi())
        Rep.SetXLSXFormat();
    end;
  
    Rep.CreateTotalBook();
    Rep.openTemplate("regndfl_template.xlsx",true);
    Rep.SheetChange(1);
    
    if (Rep.UseBigReport ())
          csvFile.SetLimitRow (FLUSH_COUNT_XLSX);
    end;
    var csvTable = Rep.RegisterTable ("templateTable", "templateHeader", true);
  
    if (Rep.UseBigReport ())
        csvFile.SetLimitRow (FLUSH_COUNT_XLSX);
    end;
  
    Rep.SetValue_NameCell ("templateTitle", "Формирование отчета <Регистр НДФЛ> (BIQ-11355)", "");
    Rep.SetValue_NameCell ("templateDate", "Дата выполнения: "+ {curdate}, "");
    Rep.SetValue_NameCell ("templateTime", "Время выполнения: "+ time(), "");

    Rep.CopyAllSheetInTotalBook (null, false, "templateHeader", 0, "template");
    var fName = csvFile.CreateFullFileName (GetFullPath("$TxtFile\\tipi") + "REGNDFL_" + UserNumber + "_csv.txt");
    csvFile.FileOpen (fName, true);
    
    var i = 0;
    while (i < MSGArr.size)
      csvFile.AddCell(MSGArr[i]);
      csvFile.AddRow ();
      i = i + 1;
    end;
    csvFile.FileClose();
    csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
    csvTable.EndTable();
    Rep.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "template");
    Rep.Close();
    Rep.SaveTotalBook("REGNDFL_" + UserNumber+".xlsx");
  end;
end;


while (form.Run())
  var investor          = form.GetFieldValue(PNFLD_REGNDFL_INVESTORCODE);
  var report_date_end   = date(form.GetFieldValue(PNFLD_REGNDFL_ENDDATE));
  var report_date_begin = date(form.GetFieldValue(PNFLD_REGNDFL_BEGINDATE));
  var folder            = form.GetFieldValue(PNFLD_REGNDFL_DIRECTORY);
  var loadFileRadio     = Form.GetFieldValue(PNFLD_REGNDFL_IS_CLIENT_LIST);
  var loadFile          = Form.GetFieldValue(PNFLD_REGNDFL_CLIENT_LIST_FILE);
  var clients           = Form.GetFieldValue(PNFLD_REGNDFL_INVESTORCODE);
  var oper              = Form.GetFieldValue(PNFLD_REGNDFL_OPER);
  var source            = Form.GetFieldValue(PNFLD_REGNDFL_SOURCE);
  var sourceNum         = Form.GetFieldValue(PNFLD_REGNDFL_SOURCENUM);
  var compare           = Form.GetFieldValue(PNFLD_REGNDFL_COMPARE);

  MSGArr.size = 0;

  var regMain = RegNDFL_Report(investor, report_date_end, report_date_begin, 
                 folder, loadFileRadio, loadFile, clients, oper, 
                 source, sourceNum, (compare == DL_COMPARE));
  regMain.Run();

  if(compare == DL_COMPARE)
    var regSlice = RegNDFL_Report_Data_slice (investor, report_date_end, report_date_begin, 
                                                          folder, loadFileRadio, loadFile, clients, oper, 
                                                          source, sourceNum, regMain.CompareObjList);
    regSlice.run();
    RegNDFL_Report_Compare (regMain.CompareObjList, regSlice.CompareObjList).run();
  end;

  makeProtocol();
end;

exit(1);
