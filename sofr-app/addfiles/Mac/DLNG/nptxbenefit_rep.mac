/*
$Name:        nptxbenefit_rep.mac
$Module:      Ценные бумаги
$Description: Печать протокола изменения записи настроечной таблицы "Виды льготируемых доходов"
*/

IMPORT "DlReport_h.mac", globals, ActiveX, oralib, "global_utils_intgr.mac";
import "dlquery.mac";
import "dlutils.mac", "scsrvrepfun.mac";


PRIVATE CLASS (DL_CReportTemplate) NptxBenefitChProtocol_Report(BenefitID)
  var m_BenefitID = BenefitID;

  PRIVATE MACRO BeginReport()
    SetIsShowAppl(false); //Всегда не показываем отчет на экран
  END;

  MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO Create()
    var query, cmd, DataSet;
    var cnt, i;
    var BenefitType = "";

    query = "select t_BenefitType from dnptxbenefits_dbt where t_BenefitID = ?";
    cmd = DL_RSDCOmmand(query);
    cmd.AddParam(m_BenefitID);
    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      BenefitType = DataSet.BenefitType;
    end;

    SetActiveSheet("Льгота");

    RegisterTable( "N1_MainTable", NULL,
                   "N1_Num",        
                   "N1_ChangeDate",    
                   "N1_Oper",  
                   "N1_BenefitType_Old",       
                   "N1_BenefitType_New",       
                   "N1_BegDateBenefit_Old",    
                   "N1_BegDateBenefit_New",    
                   "N1_EndDateBenefit_Old",    
                   "N1_EndDateBenefit_New",    
                   "N1_BenefitPriority_Old",   
                   "N1_BenefitPriority_New",   
                   "N1_BenefitGroup_Old",      
                   "N1_BenefitGroup_New",      
                   "N1_Law_Old",       
                   "N1_Law_New"
                 );


    query =   " select ch.*, p.t_Name as UserName "
          + "   from dnptxbenefitsch_dbt ch, dperson_dbt p "
          + "  where ch.t_BenefitID = ? "
          + "    and p.t_Oper = ch.t_Oper "
          + " order by ch.t_ID ASC ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_BenefitID);

    cnt = cmd.GetCount();
    if(cnt > 0)
      InitProgress(cnt, "Печать протокола", "Печать протокола");

      i = 0;
      DataSet = cmd.Execute();
      while(DataSet.moveNext())

        PrintTableLine("N1_Num",                  int(i+1),           null,
                       "N1_ChangeDate",           string(date(DataSet.ChangeDate):f) + " " + string(time(DataSet.ChangeTime)),   null,
                       "N1_Oper",                 string(string(DataSet.Oper) + " "+DataSet.UserName), null,
                       "N1_BenefitType_Old",      DataSet.BenefitType_Old,     null,
                       "N1_BenefitType_New",      DataSet.BenefitType_New,     null,
                       "N1_BegDateBenefit_Old",   date(DataSet.BegDateBenefit_Old),  null,
                       "N1_BegDateBenefit_New",   date(DataSet.BegDateBenefit_New),  null,
                       "N1_EndDateBenefit_Old",   date(DataSet.EndDateBenefit_Old),  null,
                       "N1_EndDateBenefit_New",   date(DataSet.EndDateBenefit_New),  null,
                       "N1_BenefitPriority_Old",  DataSet.BenefitPriority_Old, null,
                       "N1_BenefitPriority_New",  DataSet.BenefitPriority_New, null,
                       "N1_BenefitGroup_Old",     DataSet.BenefitGroup_Old,    null,
                       "N1_BenefitGroup_New",     DataSet.BenefitGroup_New,    null,
                       "N1_Law_Old",              DataSet.Law_Old,             null,
                       "N1_Law_New",              DataSet.Law_New,             null

                      );

        UseProgress(i = i + 1);
      end;

      RemProgress();
    end;

    EndTable();
    
    SetActiveSheet("Условия");

    PrintFormatString( NULL, "N2_BenefitType", BenefitType);

    RegisterTable( "N2_MainTable", NULL,
                   "N2_Num",
                   "N2_CondID",      
                   "N2_ChangeDate",    
                   "N2_Oper",  
                   "N2_Action",
                   "N2_DealObject_Old",        
                   "N2_DealObject_New",        
                   "N2_DealType_Old",  
                   "N2_DealType_New",  
                   "N2_ResidentStatus_Old",    
                   "N2_ResidentStatus_New",    
                   "N2_OwnerPeriod_Old",       
                   "N2_OwnerPeriod_New",      
                   "N2_IssuerCountryCond_Old", 
                   "N2_IssuerCountryCond_New", 
                   "N2_IssuerCountry_Old",     
                   "N2_IssuerCountry_New",     
                   "N2_BenefitSignOnFi_Old",   
                   "N2_BenefitSignOnFi_New",   
                   "N2_Circulate_Old", 
                   "N2_Circulate_New", 
                   "N2_BenefitSignOnIssuer_Old",       
                   "N2_BenefitSignOnIssuer_New",
                   "N2_BenefitSignOnClient_Old",       
                   "N2_BenefitSignOnClient_New",       
                   "N2_DealDate_Old",  
                   "N2_DealDate_New",  
                   "N2_SpecialCondition_Old",  
                   "N2_SpecialCondition_New"
                 );

    query = " select ch.t_ID, ch.t_CondID, ch.t_Action, ch.t_ChangeDate, ch.t_ChangeTime, ch.t_Oper, p.t_Name as UserName, "
          + "        rsi_nptxbenefit.PumpDealObjectBeneCond(ch.t_DealObject_Old) as DealObject_Old, "
          + "        rsi_nptxbenefit.PumpDealObjectBeneCond(ch.t_DealObject_New) as DealObject_New, "
          + "        rsi_nptxbenefit.PumpDealTypeBeneCond(ch.t_KindDealType_Old, ch.t_DealType_Old) as DealType_Old, "
          + "        rsi_nptxbenefit.PumpDealTypeBeneCond(ch.t_KindDealType_New, ch.t_DealType_New) as DealType_New, "
          + "        rsi_nptxbenefit.PumpResidentStatusBeneCond(ch.t_ResidentStatus_Old) as ResidentStatus_Old, "
          + "        rsi_nptxbenefit.PumpResidentStatusBeneCond(ch.t_ResidentStatus_New) as ResidentStatus_New, "
          + "        rsi_nptxbenefit.PumpOwnerPeriodBeneCond(ch.t_OwnerPeriodSign_Old, ch.t_OwnerPeriod_Old) as OwnerPeriod_Old, "
          + "        rsi_nptxbenefit.PumpOwnerPeriodBeneCond(ch.t_OwnerPeriodSign_New, ch.t_OwnerPeriod_New) as OwnerPeriod_New, "
          + "        rsi_nptxbenefit.PumpIssuerCountryCondBeneCond(ch.t_IsExcept_Old) as IssuerCountryCond_Old, "
          + "        rsi_nptxbenefit.PumpIssuerCountryCondBeneCond(ch.t_IsExcept_New) as IssuerCountryCond_New, "
          + "        rsi_nptxbenefit.PumpIssuerCountryBeneCond(ch.t_IssuerCountry_Old) as IssuerCountry_Old, "
          + "        rsi_nptxbenefit.PumpIssuerCountryBeneCond(ch.t_IssuerCountry_New) as IssuerCountry_New, "
          + "        rsi_nptxbenefit.PumpBenefitSignOnFiBeneCond(ch.t_BenefitSignOnFi_Old) as BenefitSignOnFi_Old, "
          + "        rsi_nptxbenefit.PumpBenefitSignOnFiBeneCond(ch.t_BenefitSignOnFi_New) as BenefitSignOnFi_New, "
          + "        rsi_nptxbenefit.PumpCirculateBeneCond(ch.t_Circulate_Old) as Circulate_Old, "
          + "        rsi_nptxbenefit.PumpCirculateBeneCond(ch.t_Circulate_New) as Circulate_New, "
          + "        rsi_nptxbenefit.PumpBenefitSignOnIssuerBeneCond(ch.t_BenefitSignOnIssuer_Old) as BenefitSignOnIssuer_Old, "
          + "        rsi_nptxbenefit.PumpBenefitSignOnIssuerBeneCond(ch.t_BenefitSignOnIssuer_New) as BenefitSignOnIssuer_New, "
          + "        rsi_nptxbenefit.PumpBenefitSignOnClientBeneCond(ch.t_BenefitSignOnClient_Old) as BenefitSignOnClient_Old, "
          + "        rsi_nptxbenefit.PumpBenefitSignOnClientBeneCond(ch.t_BenefitSignOnClient_New) as BenefitSignOnClient_New, "
          + "        rsi_nptxbenefit.PumpDealDateBeneCond(ch.t_DealDateSign_Old, ch.t_DealDate_Old) as DealDate_Old, "
          + "        rsi_nptxbenefit.PumpDealDateBeneCond(ch.t_DealDateSign_New, ch.t_DealDate_New) as DealDate_New, "
          + "        rsi_nptxbenefit.PumpSpecialConditionBeneCond(ch.t_SpecialCondition_Old) as SpecialCondition_Old, "
          + "        rsi_nptxbenefit.PumpSpecialConditionBeneCond(ch.t_SpecialCondition_New) as SpecialCondition_New "
          + "   from dnptxbenefitsconditionsch_dbt ch, dperson_dbt p "
          + "  where ch.t_BenefitID = ? "
          + "    and p.t_Oper = ch.t_Oper "
          + " order by ch.t_CondID ASC, ch.t_ID ASC ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_BenefitID);

    cnt = cmd.GetCount();
    if(cnt > 0)
      InitProgress(cnt, "Печать условий", "Печать условий");

      i = 0;
      DataSet = cmd.Execute();
      while(DataSet.moveNext())

        PrintTableLine("N2_Num",                      int(i+1),   null,
                       "N2_CondID",                   DataSet.CondID, null,
                       "N2_ChangeDate",               string(date(DataSet.ChangeDate):f) + " " + string(time(DataSet.ChangeTime)), null,
                       "N2_Oper",                     string(string(DataSet.Oper) + " "+DataSet.UserName),     null,
                       "N2_Action",                   IIF(DataSet.Action == 3, "Удаление", IIF(DataSet.Action == 1, "Создание", "Изменение")), null,
                       "N2_DealObject_Old",           IIF(DataSet.Action == 1, "", DataSet.DealObject_Old),              null,
                       "N2_DealObject_New",           IIF(DataSet.Action == 3, "", DataSet.DealObject_New),              null,
                       "N2_DealType_Old",             IIF(DataSet.Action == 1, "", DataSet.DealType_Old),                null,
                       "N2_DealType_New",             IIF(DataSet.Action == 3, "", DataSet.DealType_New),                null,
                       "N2_ResidentStatus_Old",       IIF(DataSet.Action == 1, "", DataSet.ResidentStatus_Old),          null,
                       "N2_ResidentStatus_New",       IIF(DataSet.Action == 3, "", DataSet.ResidentStatus_New),          null,
                       "N2_OwnerPeriod_Old",          IIF(DataSet.Action == 1, "", DataSet.OwnerPeriod_Old),             null,
                       "N2_OwnerPeriod_New",          IIF(DataSet.Action == 3, "", DataSet.OwnerPeriod_New),             null,
                       "N2_IssuerCountryCond_Old",    IIF(DataSet.Action == 1, "", DataSet.IssuerCountryCond_Old),       null,
                       "N2_IssuerCountryCond_New",    IIF(DataSet.Action == 3, "", DataSet.IssuerCountryCond_New),       null,
                       "N2_IssuerCountry_Old",        IIF(DataSet.Action == 1, "", DataSet.IssuerCountry_Old),           null,
                       "N2_IssuerCountry_New",        IIF(DataSet.Action == 3, "", DataSet.IssuerCountry_New),           null,
                       "N2_BenefitSignOnFi_Old",      IIF(DataSet.Action == 1, "", DataSet.BenefitSignOnFi_Old),         null,
                       "N2_BenefitSignOnFi_New",      IIF(DataSet.Action == 3, "", DataSet.BenefitSignOnFi_New),         null,
                       "N2_Circulate_Old",            IIF(DataSet.Action == 1, "", DataSet.Circulate_Old),               null,
                       "N2_Circulate_New",            IIF(DataSet.Action == 3, "", DataSet.Circulate_New),               null,
                       "N2_BenefitSignOnIssuer_Old",  IIF(DataSet.Action == 1, "", DataSet.BenefitSignOnIssuer_Old),     null,
                       "N2_BenefitSignOnIssuer_New",  IIF(DataSet.Action == 3, "", DataSet.BenefitSignOnIssuer_New),     null,
                       "N2_BenefitSignOnClient_Old",  IIF(DataSet.Action == 1, "", DataSet.BenefitSignOnClient_Old),     null,
                       "N2_BenefitSignOnClient_New",  IIF(DataSet.Action == 3, "", DataSet.BenefitSignOnClient_New),     null,
                       "N2_DealDate_Old",             IIF(DataSet.Action == 1, "", DataSet.DealDate_Old),                null,
                       "N2_DealDate_New",             IIF(DataSet.Action == 3, "", DataSet.DealDate_New),                null,
                       "N2_SpecialCondition_Old",     IIF(DataSet.Action == 1, "", DataSet.SpecialCondition_Old),        null,
                       "N2_SpecialCondition_New",     IIF(DataSet.Action == 3, "", DataSet.SpecialCondition_New),        null
                       
                      );

        UseProgress(i = i + 1);
      end;

      RemProgress();
    end;

    EndTable();  
  END;

  MACRO Run()
    Run();
    
    for (var fileName, GetFullReportFileNames())
      return fileName;
    end;

    return "";
  END;

  initDL_CReportTemplate( NULL, "Report_NptxBenefitCh.xlsx", true, null, null, true, true );
  SetRowFlushCount(2000);  
END;

MACRO PrintReportNptxBenefitCh(p_BenefitID)
  var RepObj = NptxBenefitChProtocol_Report(p_BenefitID);
  var SaveTo = "";
  var day, mon, year;
  var hour, min, sec;
          
  var FullFileNameXLSX = RepObj.Run();

  RepObj = NULL;
  
  DateSplit(date(), day, mon, year);
  TimeSplit(time(), hour, min, sec);

  SaveTo = SaveTo + "\\" + "Протокол изменения записей в настроечной таблице Виды льгот и условия применения (для расчета НОБ) на " + string(day:o:2)+string(mon:o:2)+string(year)+"_"+string(hour:f:2)+string(min:f:2)+string(sec:f:2)+ ".xlsx";

  if(not isStandAlone())
    FullFileNameXLSX = "$"+FullFileNameXLSX;
    SaveTo = "$"+SaveTo;
  end;
  
  if(FullFileNameXLSX != "")
    var FileName, FileExt;
    var ToFileName, ToFileExt;
    
    var FromDir = SplitFile(FullFileNameXLSX, FileName, FileExt);
    var ToDir = SplitFile(SaveTo, ToFileName, ToFileExt);
    
    if(not RenameFile(FullFileNameXLSX, FromDir+ToFileName+FileExt))
      msgbox("Ошибка при переименовании файла протокола");
    else
      if((ToDir != "") and (ToDir != FromDir))
        if(SC_CopyFile(FromDir, ToDir, ToFileName+FileExt, ToFileName+FileExt) != 0)
          msgbox("Ошибка при сохранении файла протокола");
        end;
      end;

      if((GetDialogFlag() != 0) and (SP_IsShedulerRunning() == false))
        SC_ShowFile(ToDir, ToFileName+FileExt);
      end;
    end;
  end;

  return 0;
END;
