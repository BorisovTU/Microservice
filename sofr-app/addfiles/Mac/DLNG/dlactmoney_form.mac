/*
$Name:             dlactmoney_form.mac
$Module:           Ядро Securities
$Description:      Отчет " Акты сверки наличия денежных средств " - форма ввода данных (общая для БОЦБ, УВ и ПИ)
*/

import "DlRepForm_h.mac", "globals.mac", "dlmisc.mac";

Private MACRO SetCurrBeginDate():DATE
  VAR Month, Year;
  DateSplit( {curdate}, null, null, Year);
  DateSplit( {curdate}, null, Month, null);
  return GetDateAfterWorkDays(DATE( 1, Month, Year ),0);
end;

CONST
      PNFLD_INACC_ACT_MODULE_BO           = 0,   
      PNFLD_INACC_ACT_MODULE_VA           = 1,  
      PNFLD_INACC_ACT_MODULE_DV           = 2,
      PNFLD_INACC_ACT_MODULE_DV_DER       = 3,
      PNFLD_INACC_ACT_MODULE_DV_CUR       = 4,
      PNFLD_INACC_ACT_BEGINDATE           = 5,    
      PNFLD_INACC_ACT_FINISHDATE          = 6,
      PNFLD_INACC_ACT_FOR_EVERY_DATE      = 7,    
      PNFLD_INACC_ACT_ACCVALUE            = 8,   
      PNFLD_INACC_ACT_PASSIVACC           = 9,   
      PNFLD_INACC_ACT_CLIENT_CODE         = 10, 
      PNFLD_INACC_ACT_CLIENT_NAME         = 11,   
      PNFLD_INACC_ACT_CLIENT_CONTR        = 12,    
      PNFLD_INACC_ACT_ACTIVACC            = 13,
      PNFLD_INACC_ACT_BROKERMONEY         = 14,   
      PNFLD_INACC_ACT_BROKER              = 15,   
      PNFLD_INACC_ACT_MARKETMONEY         = 16,   
      PNFLD_INACC_ACT_MARKET              = 17,   
      PNFLD_INACC_ACT_WITH_APP            = 18,  
      PNFLD_INACC_ACT_TO_EXEL             = 19,   
      PNFLD_INACC_ACT_DEPARTMENT          = 20,   
      PNFLD_INACC_ACT_DEPARTMENT_NAME     = 21;   

CLASS DlActMoneyFormData()
  VAR 
  DepartmentID,
  BegDate,
  EndDate,
  ForEveryDate,
  IsUseBO,
  IsUseVA,
  IsUseDV,
  IsUseDVDer,
  IsUseDVCur,
  AccValue,
  PassivAcc,
  ClientCode,
  ClientContr,
  ActivAcc,
  BrokerMoney,
  Broker,
  MarketMoney,
  Market,
  IsUseApp,
  IsExportToExel,
  lastParam;


  IsUseBO = ""; // KS 20.01.2010 I-Sup 503437 Если галки переинициализировать нельзя, то простите
  IsUseVA = "X";
  if(VA_NeedInnerAcc() == false)
    IsUseVA = "";
  end;
  IsUseDV = "X";
  IsUseDVDer = "X";
  IsUseDVCur = "X";
  ForEveryDate = "";
  AccValue = -1;
  PassivAcc = "X";
  ClientCode = -1;
  ClientContr = -1;
  ActivAcc = "";
  BrokerMoney = "";
  Broker = -1;
  MarketMoney = "";
  Market = -1;
  IsUseApp = "X";
  IsExportToExel = "X";
  DepartmentID = {OperDprt};
  BegDate = {curdate};//SetCurrBeginDate();
  EndDate = {curdate};

END;

VAR DlActMoneyRepFormData = DlActMoneyFormData();

PRIVATE CONST

  H_ACCVALUE        = 100,
  H_ACTIVACC        = 101,
  H_BROKERMONEY     = 102,
  H_BROKER          = 103,
  H_MARKETMONEY     = 104,
  H_MARKET          = 105;

PRIVATE CONST SelCodeKind = 1;

PRIVATE MACRO DL_ListCalcCenter( FldShowValue:@VARIANT, FldRealValue:@VARIANT, X:INTEGER, Y:INTEGER ):BOOL
  VAR Choice,Select;

  Select = "select distinct prt.t_Name, " +
           "       partcode.t_Code, prt.t_PartyID " + 
           "  from dpartcode_dbt partcode, dparty_dbt prt, dpartyown_dbt prtown " +
           " where prtown.t_PartyKind = 46 " +/*РЦ ОРЦБ*/
           "   and prtown.t_PartyID = partcode.t_PartyID " +
           "   and prt.t_PartyID = partcode.t_PartyID " +
           "   and partcode.t_CodeKind = 1";


  Choice = DL_Scroll(Select,
                     "Список РЦ ОРЦБ", X, Y,
                     "t_Code","Код","t_Name","Наименование"
                    );

  if( Choice != NULL )
     FldRealValue = Choice.Value("t_PartyID"); 
     FldShowValue = Choice.Value("t_Code");
  end;

  return (Choice != NULL);
END;

/*Переключатель*/
PRIVATE MACRO DLUSR_FldProc_CheckBox( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
           pThis.SetLinkedValue( DL_PNFLD_CLIENT_STOCKDL_CODE, -1); 
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_CheckBoxD( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) /*инициализация по умолчанию*/
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( Key == KEY_SPACE )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
           EnableFields(pThis.Data(), PNFLD_INACC_ACT_MODULE_DV_DER);
           EnableFields(pThis.Data(), PNFLD_INACC_ACT_MODULE_DV_CUR);
        else
           FldShowValue = FldRealValue = "";
           pThis.SetLinkedValue( DL_PNFLD_BY_DERIV_DER, UNSET_CHAR); 
           pThis.SetLinkedValue( DL_PNFLD_BY_DERIV_CUR, UNSET_CHAR); 
           DisableFields(pThis.Data(), PNFLD_INACC_ACT_MODULE_DV_DER);
           DisableFields(pThis.Data(), PNFLD_INACC_ACT_MODULE_DV_CUR);
        end;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_CheckBox1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     if( (pThis.GetFieldValue( PNFLD_INACC_ACT_MODULE_BO ) == "X") or (pThis.GetFieldValue( PNFLD_INACC_ACT_MODULE_DV ) == "X") )
        FldRealValue = FldShowValue;
     end;
  elif( Cmd == DLG_KEY )
     if( (Key == KEY_SPACE) AND
         ((pThis.GetFieldValue( PNFLD_INACC_ACT_MODULE_BO ) == "X") or (pThis.GetFieldValue( PNFLD_INACC_ACT_MODULE_DV ) == "X"))  
       )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        else
           FldShowValue = FldRealValue = "";
        end;
     end;
  end;
END;

PRIVATE MACRO DLUSR_FldProc_CheckBox2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( (Key == KEY_SPACE) AND
         (pThis.GetFieldValue( PNFLD_INACC_ACT_ACTIVACC ) == "X" )  
       )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        elif( pThis.GetFieldValue( PNFLD_INACC_ACT_MARKETMONEY ) == "X" )
           FldShowValue = FldRealValue = "";
        else
           return CM_IGNORE;
        end;
     end;
  end;
END;

PRIVATE MACRO DLUSR_FldProc_CheckBox3( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null ) 
        FldRealValue = "";
     end;
     FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
     FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
     if( (Key == KEY_SPACE) AND
         (pThis.GetFieldValue( PNFLD_INACC_ACT_ACTIVACC ) == "X" )  
       )
        if( FldRealValue != "X" )
           FldShowValue = FldRealValue = "X";
        elif( pThis.GetFieldValue( PNFLD_INACC_ACT_BROKERMONEY ) == "X" )
           FldShowValue = FldRealValue = "";
        else
           return CM_IGNORE;
        end;
     end;
  end;
END;

PRIVATE MACRO DLUSR_FldProc_Broker( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Party     = TRecHandler("party.dbt");
  var partcode = TBFile( "partcode.dbt",  "R", 0 );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )          
        FldRealValue = -1;
        FldShowValue = STR_ALLVALUE;
     end;
     if( FldRealValue <= 0 )                           
        FldShowValue = STR_ALLVALUE;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     if( (pThis.GetFieldValue( PNFLD_INACC_ACT_BROKERMONEY ) == "X") and (pThis.GetFieldValue( PNFLD_INACC_ACT_ACTIVACC ) == "X") )
       Party = TRecHandler("party.dbt");
       if( ListPT( Party, SelCodeKind, "", 31/*PTLIST_BROKER*/, PTCK_ALL) == true ) 
          FldRealValue = Party.rec.PartyID;
          partcode.Clear();
          partcode.rec.PartyID  = Party.rec.PartyID;
          partcode.rec.CodeKind = SelCodeKind;
          if(partcode.GetEQ())
             FldShowValue = partcode.rec.Code;
          end;
       end;
     else
        return CM_IGNORE;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO DLUSR_FldProc_Market( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )          
        FldRealValue = -1;
        FldShowValue = STR_ALLVALUE;
     end;
     if( FldRealValue <= 0 )                           
        FldShowValue = STR_ALLVALUE;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
     if( (pThis.GetFieldValue( PNFLD_INACC_ACT_MARKETMONEY ) == "X") and (pThis.GetFieldValue( PNFLD_INACC_ACT_ACTIVACC ) == "X") )
        DL_ListCalcCenter( @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY() );
     else
        return CM_IGNORE;
     end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
    FldRealValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;
                    
CLASS (DL_CPanel) DL_ActMoney_Panel()

  PRIVATE MACRO Init()

     AddFieldProc( 0, PNFLD_INACC_ACT_MODULE_BO,           DL_PNFLD_EMISS_AVR,           @DLUSR_FldProc_CheckBox,   DlActMoneyRepFormData.IsUseBO);
     AddFieldProc( 0, PNFLD_INACC_ACT_MODULE_VA,           DL_PNFLD_NOT_EMISS_AVR,       @DLUSR_FldProc_CheckBox,   DlActMoneyRepFormData.IsUseVA);                 
     AddFieldProc( 0, PNFLD_INACC_ACT_MODULE_DV,           DL_PNFLD_BY_DERIV,            @DLUSR_FldProc_CheckBoxD,  DlActMoneyRepFormData.IsUseDV);
     AddFieldProc( 0, PNFLD_INACC_ACT_MODULE_DV_DER,       DL_PNFLD_BY_DERIV_DER,        @DLUSR_FldProc_CheckBox,   DlActMoneyRepFormData.IsUseDVDer);
     AddFieldProc( 0, PNFLD_INACC_ACT_MODULE_DV_CUR,       DL_PNFLD_BY_DERIV_CUR,        @DLUSR_FldProc_CheckBox,   DlActMoneyRepFormData.IsUseDVCur);
     AddFieldProc( 0, PNFLD_INACC_ACT_BEGINDATE,           DL_PNFLD_BEGINDATE,           @DL_FldProc_BeginDate,     DlActMoneyRepFormData.BegDate);
     AddFieldProc( 0, PNFLD_INACC_ACT_FINISHDATE,          DL_PNFLD_ENDDATE,             @DL_FldProc_EndDate,       DlActMoneyRepFormData.EndDate );                 
     AddFieldProc( 0, PNFLD_INACC_ACT_FOR_EVERY_DATE,      DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,      DlActMoneyRepFormData.ForEveryDate );                 

     AddFieldProc( 0, PNFLD_INACC_ACT_ACCVALUE,            H_ACCVALUE,                   @DL_FldProc_FI,            DlActMoneyRepFormData.AccValue);

     AddFieldProc( 0, PNFLD_INACC_ACT_PASSIVACC,           DL_PNFLD_IS_CLIENT,           @DL_FldProc_CheckBox,      DlActMoneyRepFormData.PassivAcc);
     AddFieldProc( 0, PNFLD_INACC_ACT_CLIENT_CODE,         DL_PNFLD_CLIENT_STOCKDL_CODE, @DL_FldProc_Client_BO_Dep, DlActMoneyRepFormData.ClientCode);
     AddFieldProc( 0, PNFLD_INACC_ACT_CLIENT_NAME,         DL_PNFLD_CLIENT_STOCKDL_NAME, @Default,                  "");
     AddFieldProc( 0, PNFLD_INACC_ACT_CLIENT_CONTR,        DL_PNFLD_CONTRACT_OFBU,       @DL_FldProc_Contract_BO_Dep,DlActMoneyRepFormData.ClientContr);

     AddFieldProc( 0, PNFLD_INACC_ACT_ACTIVACC,            H_ACTIVACC,                   @DLUSR_FldProc_CheckBox1,  DlActMoneyRepFormData.ActivAcc);
     AddFieldProc( 0, PNFLD_INACC_ACT_BROKERMONEY,         H_BROKERMONEY,                @DLUSR_FldProc_CheckBox2,  DlActMoneyRepFormData.BrokerMoney);
     AddFieldProc( 0, PNFLD_INACC_ACT_BROKER,              H_BROKER,                     @DLUSR_FldProc_Broker,     DlActMoneyRepFormData.Broker);
     AddFieldProc( 0, PNFLD_INACC_ACT_MARKETMONEY,         H_MARKETMONEY,                @DLUSR_FldProc_CheckBox3,  DlActMoneyRepFormData.MarketMoney);
     AddFieldProc( 0, PNFLD_INACC_ACT_MARKET,              H_MARKET,                     @DLUSR_FldProc_Market,     DlActMoneyRepFormData.Market);
                                                                                         
     AddFieldProc( 0, PNFLD_INACC_ACT_WITH_APP,            DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,      DlActMoneyRepFormData.IsUseApp);
     AddFieldProc( 0, PNFLD_INACC_ACT_TO_EXEL,             DL_PNFLD_CHECKBOX,            @DL_FldProc_CheckBox,      DlActMoneyRepFormData.IsExportToExel);
     AddFieldProc( 0, PNFLD_INACC_ACT_DEPARTMENT,          DL_PNFLD_DEPARTCODE,          @DL_FldProc_Department_Cl_BO, DlActMoneyRepFormData.DepartmentID);
     AddFieldProc( 0, PNFLD_INACC_ACT_DEPARTMENT_NAME,     DL_PNFLD_DEPARTMENT,          @Default,                  "");

     if(VA_NeedInnerAcc() == false)
       DisableFields( This.Data(), PNFLD_INACC_ACT_MODULE_VA ); 
     end;
    /* Отключение полей */
     DisableFields( This.Data(), PNFLD_INACC_ACT_ACTIVACC ); 
     DisableFields( This.Data(), PNFLD_INACC_ACT_BROKERMONEY ); 
     DisableFields( This.Data(), PNFLD_INACC_ACT_BROKER ); 
     DisableFields( This.Data(), PNFLD_INACC_ACT_MARKETMONEY ); 
     DisableFields( This.Data(), PNFLD_INACC_ACT_MARKET ); 


  END;

  PRIVATE MACRO Check():BOOL
      if( (This.GetFieldValue(PNFLD_INACC_ACT_MODULE_DV) == SET_CHAR) AND (This.GetFieldValue(PNFLD_INACC_ACT_MODULE_DV_DER) == UNSET_CHAR ) AND (This.GetFieldValue(PNFLD_INACC_ACT_MODULE_DV_CUR) == UNSET_CHAR ))
        MsgBox("Для модуля \"ФИССиКО\" необходимо установить рынок");
        return false;
      end;

     return true;
  END;
  
  initDL_CPanel( "dlrep.lbr", "ACTMONEY" );
 
END;
