/*
$Name:        od07.mac
$Module:      Ценные бумаги
$Description: Таблица ОД_7: Таблица ОД-7 Реестр валютно-процентных сделок СВОП, форвардов и опционов, которые были открыты в течение отчетного периода, и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505
$Programmer:  Кротов А.
*/
import od07_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) od07_Report
  var m_BeginDate, m_EndDate;

  /*Создание отчета*/
  PRIVATE MACRO Create()

/*Точка входа*/
    var cnt;
    var m_cmd;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    if(m_Form.GetFieldValue(PNFLD_PERIOD) < 13)
      /*Задан месяц*/
      m_BeginDate = date(1, m_Form.GetFieldValue(PNFLD_PERIOD), FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 1) - 1;
    else 
      /*Задан квартал*/
      m_BeginDate = date(1, (m_Form.GetFieldValue(PNFLD_PERIOD) - 12 - 1) * 3 + 1, FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 3) - 1;
    end;

/*Лист "Таблица ОД-7"*/
    SetActiveSheet("Таблица ОД-7");
    PrintFormatString("", "reportname", "Таблица ОД-7 Реестр валютно-процентных сделок СВОП, форвардов и опционов, которые были открыты c " + m_BeginDate + " по " + m_EndDate + ", и изменение справедливой стоимости которых было отражено на символах 25101-25105, 25201-25205, 25401-25405, 25501-25505, 45101-45105, 45201-45205, 45401-45405, 45501-45505");
    RegisterTable( "row1_0", "",
             /* 1*/ "row1_1", 
             /* 2*/ "row1_2", 
             /* 3*/ "row1_3", 
             /* 4*/ "row1_4", 
             /* 5*/ "row1_5", 
             /* 6*/ "row1_6", 
             /* 7*/ "row1_7", 
             /* 8*/ "row1_8", 
             /* 9*/ "row1_9", 
             /*10*/ "row1_10", 
             /*11*/ "row1_11", 
             /*12*/ "row1_12", 
             /*13*/ "row1_13", 
             /*14*/ "row1_14", 
             /*15*/ "row1_15", 
             /*16*/ "row1_16", 
             /*17*/ "row1_17", 
             /*18*/ "row1_18", 
             /*19*/ "row1_19", 
             /*20*/ "row1_20", 
             /*21*/ "row1_21", 
             /*22*/ "row1_22", 
             /*23*/ "row1_23", 
             /*24*/ "row1_24");
    this.AutoFilter(6, "A", "X");
    StartCaptureOutput();
    [
      select count(1) over() t_cnt, 
             dvndeal.fi_kind fi_kind,
             dvndeal.t_id t_id,   
             dvndeal.t_code t_code,
             nvl(contragent.t_shortname,chr(1)) t_contragentname,
             case when t_contractorisbank > 0 then nvl(contragent.t_shortname,chr(1)) else chr(1) end t_contragentbank, 
             case when contragent.t_notresident is null then '-' when contragent.t_notresident = chr(88) then 'N' else 'R' end t_isresident,
             dvndeal.t_dealtype t_dealtype,
             dvndeal.t_date t_date, 
             dvndeal.t_execdate t_execdate,
             dvndeal.t_execdate - dvndeal.t_date t_days, 
             fininstrT.t_codeinaccount t_ccyT,
             t_amountT,
             case when t_fiidT = 0 then t_amountT
                  when fininstrT.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(t_amountT,t_fiidT,0,edt),2)
                  else 0 
             end t_amountTRUR,
             case when t_fiidT = 0 then 1
                  when fininstrT.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(1,t_fiidT,0,edt),4)
                  else 0 
             end t_amountTCurRUR,
             fininstrO.t_codeinaccount t_ccyO,
             t_amountO,
             case when t_fiidO = 0 then t_amountO
                  when fininstrO.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(t_amountO,t_fiidO,0,edt),2)
                  else 0 
             end t_amountORUR,
             case when t_fiidO = 0 then 1
                  when fininstrO.t_fi_kind in(1,6) then round(rsi_rsb_fiinstr.convsum(1,t_fiidO,0,edt),4)
                  else 0 
             end t_amountOCurRUR,
             case when t_ispfi = chr(88) then 'Да' else 'Нет' end t_ispfi,
             dvnfrval.t_fairvalue t_fairvalue,
             case when t_contractorisbank = 0 then 'Клиенты' when t_marketkind = 0 then 'Внебиржа' else 'Биржа' end t_dealclass
      from (select bdt, edt, typ, fi_kind,
                   t_id, t_state,  
                   case when t_code != chr(1) then t_code else t_extcode end t_code, 
                   t_contractor,
                   t_dealtype,
                   t_date,t_execdate,
                   t_ispfi, t_marketkind,
                   t_fiidT,
                   t_amountT,
                   t_fiidO,
                   t_amountO,
                   nvl((select t_id 
                        from (select t_id 
                              from ddvnfrval_dbt 
                              where t_dealid = dvndeal.t_id and t_date <= edt
                              order by t_date desc, t_id desc)
                        where rownum = 1),0) t_dvnfrvalid,
                   (select count(1) cnt 
                    from dpartyown_dbt partyown 
                    where partyown.t_partyid = t_contractor and 
                          partyown.t_partykind = 2/*Банком*/) t_contractorisbank
            from(--Процентный СВОП (только валюта)
                 select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fiid != fininstrO.t_fiid then 'продажа'||' '|| fininstrO.t_ccy||' за '||fininstrT.t_ccy else chr(1) end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate, dvnfiO.t_execdate, dvnfiO.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,
                        -- Требования
                        fininstrT.t_fiid t_fiidT,
                        dvnfiT.t_amount t_amountT,
                        -- Обязательста
                        fininstrO.t_fiid t_fiidO,
                        dvnfiO.t_amount t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'P'/*Процентный СВОП*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 2 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind = 1
                 join ddvnfi_dbt dvnfiO on dvnfiO.t_dealid = dvndeal.t_id and 
                                           dvnfiO.t_type = 0
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiO.t_fiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind = 199/*Внебиржевая сделка с ПИ*/ and 
                       dvndeal.t_date <= edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi = chr(88) and
                       typ in (0,1)
                 union all
                 -- Опцион/Форвард (любой актив за валюту)
                 select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,
                        -- Требования
                        case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        -- Обязательста
                        case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, '[O|U]'/*Опцион/Форвард*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 ((fininstrT.t_fi_kind in (1,6) and typ in (0,1)) or (fininstrT.t_fi_kind in (2) and typ in (0,2)))
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind = 199/*Внебиржевая сделка с ПИ*/ and 
                       dvndeal.t_date <= edt and 
                       dvndeal.t_ispfi = chr(88) and
                       dvndeal.t_state >= 1
                 union all
                 -- Валютный СВОП - первая нога (валюта и драгметалл)
                 select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type = 5 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,
                        -- Требования
                        case when dvndeal.t_type != 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        -- Обязательста
                        case when dvndeal.t_type != 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'S'/*Валютный СВОП*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind in (199/*Внебиржевая сделка с ПИ*/, 4813/*Конверсионная сделка ФИССиКО*/) and 
                       dvndeal.t_date <= edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi = chr(88) and
                       typ in (0,1)
                 union all
                 -- Валютный ПФИ - вторая нога (валюта и драгметалл)
                 select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type != 5 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,
                        -- Требования
                        case when dvndeal.t_type = 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type = 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        -- Обязательста
                        case when dvndeal.t_type = 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type = 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'S'/*Валютный СВОП*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 2 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind in (199/*Внебиржевая сделка с ПИ*/, 4813/*Конверсионная сделка ФИССиКО*/) and 
                       dvndeal.t_date <= edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi = chr(88) and
                       typ in (0,1)
                 union all
                 -- Покупка/продажа конверсионной операцией (валюта за драгметалл, драгметалл за валюту и валюта за валюту)
                 select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,
                        -- Требования
                        case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        -- Обязательста
                        case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'D'/*Покупка/продажа*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 fininstrT.t_fi_kind in (1,6)
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind in (1,6)  
                 where dvndeal.t_dockind = 4813/*Конверсионная сделка ФИССиКО*/ and 
                       dvndeal.t_date <= edt and 
                       dvndeal.t_state >= 1 and
                       dvndeal.t_ispfi = chr(88) and
                       typ in (0,1)
                 union all
                 -- Покупка/продажа сделкой Т+ (любой актив за валюту)
                 select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                        -- Сделка
                        dvndeal.t_id, dvndeal.t_state,  
                        dvndeal.t_extcode, dvndeal.t_code, 
                        dvndeal.t_contractor,
                        case when fininstrT.t_fi_kind in (1,6) then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| fininstrT.t_ccy||' за '||fininstrO.t_ccy else '-' end t_dealtype,
                        dvndeal.t_date, greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                        dvndeal.t_ispfi, dvndeal.t_marketkind,
                        -- Требования
                        case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                        case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                        -- Обязательста
                        case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                        case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                 from ddvndeal_dbt dvndeal 
                 join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                 join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                regexp_like(oprkoper.t_systypes, 'D'/*Покупка/продажа*/)
                 join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                           dvnfiT.t_type = 0 
                 join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                 ((fininstrT.t_fi_kind in (1,6) and typ in (0,1)) or (fininstrT.t_fi_kind in (2) and typ in (0,2)))
                 join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                 fininstrO.t_fi_kind = 1  
                 where dvndeal.t_dockind = 4815/*Сделка Т+3*/ and 
                       dvndeal.t_date <= edt and 
                       dvndeal.t_ispfi = chr(88) and
                       dvndeal.t_state >= 1) dvndeal
            where dvndeal.t_state = 1 or t_execdate >= bdt) dvndeal
      join ddvnfrval_dbt dvnfrval on dvndeal.t_dvnfrvalid > 0 and dvnfrval.t_id = dvndeal.t_dvnfrvalid
      join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvndeal.t_fiidT  
      join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvndeal.t_fiidO  
      left join dparty_dbt contragent on contragent.t_partyid = dvndeal.t_contractor
      order by dvndeal.t_date, dvndeal.t_code 
    ];
    m_cmd = RsdCommand(EndCaptureOutput());
    m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
    m_cmd.AddParam("edt", RSDBP_IN, m_EndDate);
    if(m_Form.GetFieldValue(PNFLD_CURRENCY) == "X")
      if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
        m_cmd.AddParam("typ", RSDBP_IN, 0);
      else
        m_cmd.AddParam("typ", RSDBP_IN, 1);
      end;
    else
      m_cmd.AddParam("typ", RSDBP_IN, 2);
    end;

    m_cmd.Execute();
    m_RS = TRsbDataSet(m_cmd);
    cnt = 0;
    while(m_RS.movenext)
      if(cnt == 0)
        InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование таблицы \"ОД_7\"");
      end;
      cnt = cnt + 1;
      /*Выводим строку отчета*/
      PrintTableLine(
            /* 1*/ "row1_1", "", null, 
            /* 2*/ "row1_2", m_RS.value("t_code"), null, 
            /* 3*/ "row1_3", m_RS.value("t_contragentname"), null, 
            /* 4*/ "row1_4", "", null, 
            /* 5*/ "row1_5", m_RS.value("t_contragentbank"), null, 
            /* 6*/ "row1_6", m_RS.value("t_isresident"), null, 
            /* 7*/ "row1_7", m_RS.value("t_dealtype"), null, 
            /* 8*/ "row1_8", date(m_RS.value("t_date")), null, 
            /* 9*/ "row1_9", date(m_RS.value("t_execdate")), null, 
            /*10*/ "row1_10", m_RS.value("t_days"), null, 
            /*11*/ "row1_11", m_RS.value("t_ccyT"), null, 
            /*12*/ "row1_12", m_RS.value("t_amountT"), null, 
            /*13*/ "row1_13", m_RS.value("t_amountTRUR"), null, 
            /*14*/ "row1_14", m_RS.value("t_amountTCurRUR"), null, 
            /*15*/ "row1_15", m_RS.value("t_ccyO"), null, 
            /*16*/ "row1_16", m_RS.value("t_amountO"), null, 
            /*17*/ "row1_17", m_RS.value("t_amountORUR"), null, 
            /*18*/ "row1_18", m_RS.value("t_amountOCurRUR"), null, 
            /*19*/ "row1_19", m_RS.value("t_ispfi"), null, 
            /*20*/ "row1_20", "-", null, 
            /*21*/ "row1_21", "-", null, 
            /*22*/ "row1_22", m_RS.value("t_fairvalue"), null, 
            /*23*/ "row1_23", "", null, 
            /*24*/ "row1_24", m_RS.value("t_dealclass"), null);
      UseProgress(cnt);
    end;
    if(cnt > 0)
      RemProgress();
    end;
    EndTable();
  END;
  
  initTX_RegistrReport(od07_Panel(), "od07.xlsx");

END;

/*Точка входа*/
var r = od07_Report();
r.InitReport("ОД07", null);
r.Run();

exit(1);
