/*   Расчетная Операция ВУ          
   Шаг - Выполнение перевода
*/
import "dl_class.mac", "dl_car.mac", InsCarryDoc, FiInter, DealsInter, "spserv.mac", "sp_categ";
import rsd;

private Macro GetSectorNum(Id)
  var cmd= ("select * from dptoffice_dbt where t_partyid = /*887*/4 and t_officeid = :id");
  cmd = rsdcommand (cmd);
  cmd.addParam(":id"  , RSDBP_IN, id);
  
  var rs = rsdrecordset (cmd);
  If (rs.movenext())
     return rs.value("t_officecode");
  end;

End;

macro GetAccounts (id, sector, fiid, kind, way, acc, DogId)
  var ret=0, val="", account="", sectorcode = "";
  sectorcode = GetSectorNum(sector);
/*
  if   (sector ==2) val="Основной рынок"; ret =1;
  elif (sector ==8) val="Срочный рынок";  ret =15;
  elif (sector ==9) val="Валютный рынок"; ret =2;
  else msgboxex (sector); ret = 0; return false;
  end;
*/
  var tp ="";
  if (kind == 2)
    tp =" Внебиржевой ";
    ret =1;
  else
    tp =" Биржевой ";
    if   (sectorcode ==2)
       val="Основной рынок"; 
       ret =1;
    elif (sectorcode ==8)
       val="Срочный рынок";
       ret =15;
    elif (sectorcode ==9)
        val="Валютный рынок";
        ret =2;
    else 
       msgboxex (sectorcode); ret = 0; return false;
    end;
  end;

  

  /*отберем договора в состве ДБО*/
  var cmd= ("select rmp.t_sfcontrid, contr.t_servkind, contr.t_servkindsub "+
            "  from ddlcontrmp_dbt rmp, dsfcontr_dbt contr "+
            " where rmp.t_dlcontrid in (select a.t_dlcontrid FROM ddlcontrmp_dbt a where a.t_sfcontrid = :id) ");
  if (kind==2 /*банк*/)
     cmd= cmd+(" and contr.t_servkindsub = 9"); /*внебиржа*/
  else
     cmd= cmd+(" and contr.t_servkindsub = 8");
  end;
  cmd= cmd+("  and contr.t_servkind = :ret "+ 
            "  and contr.t_id = rmp.t_sfcontrid ");
  cmd = rsdcommand (cmd);
  cmd.addParam(":id"  , RSDBP_IN, id);
  cmd.addParam(":ret" , RSDBP_IN, ret);

  var rs = rsdrecordset (cmd);
  while (rs.movenext)
    /*вытащим счета*/
    cmd= ("select stacc.t_account "+       
          "  from dsfssi_dbt ssin, dsettacc_dbt stacc, dsfcontr_dbt contr "+                                                                                          
          " where contr.t_id = :id "+                                                                                                                         
          "   and ssin.t_fiid = :fiid "+                                                                                                      
          "   and ssin.t_objectid = lpad(contr.t_id, 10,'0') "+                                                                                                      
          "   and stacc.t_settaccid = ssin.t_setaccid ");
    if (kind==2 /*банк*/)
      cmd = cmd+(" and contr.t_servkindsub = 9"); /*внебиржа*/
    else
      cmd = cmd+(" and contr.t_servkindsub = 8");
    end;
    cmd = cmd+("  and contr.t_servkind = :ret");
    cmd = rsdcommand (cmd);
    cmd.addParam(":id"  , RSDBP_IN, rs.value (0));
    cmd.addParam(":fiid"  , RSDBP_IN, fiid);
    cmd.addParam(":ret" , RSDBP_IN, ret);
    var sql = rsdrecordset (cmd);

    if (sql.movenext)
      account = sql.value(0);
//      msgboxex ("для сектора : "+val+" счет "+sql.value(0)+" "+tp+ way);
      setparm (5, sql.value(0));
      setparm (6, rs.value (0));
      return true;
    end;
  end;
  msgboxex ("для сектора : "+val+" /"+ tp + " не найден субдоговор / счет");
  return false;
end;


macro ExecuteStep( Doc, adr, DocKind, ID_Operation, ID_Step )

  record debacc(account);
  record Kredacc(account);

  record debacc21(account);
  record Kredacc21(account);
  record dl_acc( dl_acc );
  record pm_avoir(pmpaym);

  Var  DebProp  = TRecHandler( "pmprop.dbt" ),
       KredProp = TRecHandler( "pmprop.dbt" );
  var    FD, Purpose, In = true;
  var sql, cmd1, DogIdCt, DogIdDeb, AccountVU, Ground;

  SetBuff ( dl_acc, adr );
  FD = DLFirstDocDL_ACC( dl_acc );
  
  If(dl_acc.FIKind == FIKIND_AVOIRISS)
     Purpose = BAi;
  elIf(dl_acc.FIKind == FIKIND_CURRENCY)
     Purpose = CAi;
  end;
  /*-- Левченко */
  var cmd, rs;

  if ((dl_acc.opertype != 1) and (dl_acc.opertype != 47) and (dl_acc.fikind == 1))
    cmd = rsdcommand ("select t.t_element, t.t_name FROM dllvalues_dbt t WHERE t.t_element = :id and t.t_list=1006");
    cmd.addParam(":id", RSDBP_IN, dl_acc.opertype);
    rs = rsdrecordset (cmd);
    if (rs.movenext)
      msgbox ("Запрещено использование операции " +rs.value (0)+" "+rs.value (1));
      return 1;
    end;
  end;
  if (dl_acc.fikind == 2)
    msgbox ("Запрещен перевод РОВУ по ценным бумагам");
    return 1;
  end;

  var dt="-", kt="-";

  if (not GetAccounts (dl_acc.clientcontr, dl_acc.oldcentroffice, dl_acc.fiid, dl_acc.oldplacekind, " Дебет ", dt, DogIdDeb))
    return 1;
  end;

  if (not GetAccounts (dl_acc.clientcontr, dl_acc.newcentroffice, dl_acc.fiid, dl_acc.newplacekind, " Кредит ",kt, DogIdCt))
    return 1;
  end;


  /*-- Левченко */



  if( dl_acc.OperType < 1000 )/*вид операции НЕ пользовательский (Для пользовательских видов РО проводки не формируются)*/
/*  
     if( not ПроводкаПоКатегориямВнутреннегоУчета( dl_acc.OperType, 
                                                   FD, 
                                                   Doc, 
                                                   dl_acc.ValueDate, 
                                                   dl_acc.FIID,  
                                                   dl_acc.Sum
                                                 ) )
        return 1;
     end;
*/
/*BPV*/
   sql = "select * from dsfcontr_dbt where t_id in ( select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt  where t_sfcontrid = "+DogIdCt+")) ";
   if (dl_acc.newplacekind == 46 /*РЦ Биржи*/)
      if ( dl_acc.newcentroffice == 8 )/*срочный рынок*/
         sql = sql + " and t_servkind = 15";
      elif ( dl_acc.newcentroffice == 2 )/*основной рынок*/
         sql = sql + " and t_servkind = 1 and t_servkindsub = 8";
      else
         MsgBox("Сектор рынка может быть указан только Срочный рынок или Основной сектор");
      end;
   elif(dl_acc.newplacekind == 2 /*Банк*/)
         sql = sql + " and t_servkind = 1 and t_servkindsub = 9";
   else
      MsgBox("Вид субъекта может быть Банк или РЦ Биржи");
   end;
   var contr = TrsbDataSet(sql);
   if(contr.movenext())

   var FD_Contr = SPFirstDocContract( DL_STOCKCONTR, contr.ID );
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_FIID, dl_acc.FIID );

               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, dl_acc.ValueDate, null, dl_acc.FIID ) )
                  if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, null, null, DebAcc, dl_acc.ValueDate, dl_acc.FIID ) )
                     return false;
                  end;
               end;
      ClearRecord( KredAcc );
      if( not FD_Contr.IsExistAccount( "ДС, Расч. с клиентом, ВУ", null, true, null, KredAcc21, dl_acc.ValueDate, null, dl_acc.FIID ) )
         if( not FD_Contr.OpenAccount( "ДС, Расч. с клиентом, ВУ", null, null, null, KredAcc21, dl_acc.ValueDate, dl_acc.FIID ) )
            return false;
   end;
      end;
   end;
/*BPV*/
   if( not FD.OpenAccount( "ДС Клиента, ВУ", null, null, FIROLE_SRCA, KredAcc, null, dl_acc.FIID ) )
            return false;
      end;

   if( not FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", null, null, FIROLE_SRCA, DebAcc21, null, dl_acc.FIID ) )
         return false;
   end;

   //Ground = FD.ВУ_ОснованиеПроводки(dl_acc.OperType);
   Ground = "Перевод средств по поручению клиента № "+dl_acc.code+" от "+string(dl_acc.ValueDate:f)
            +" по Соглашению об оказании брокерских услуг № "+ StrSubst(StrSubst(StrSubst(FD_contr.Contr.rec.Number,"_в",""),"_ф",""),"_с","") +" от "+string(FD_contr.Contr.rec.DateBegin:f)+". НДС не облагается.";


        var acctrn1:RsbAccTransaction = RsbAccTransaction(); 
        
        acctrn1.Chapter         = 1;
        acctrn1.Date_Carry      = dl_acc.ValueDate;
        acctrn1.ResultCarry     = INPCARRY;
        acctrn1.Kind_Oper       = " 1";
        acctrn1.Ground          = Ground;
        acctrn1.Department      = 1;
        acctrn1.AccountPayer    = dt;
        acctrn1.AccountReceiver = kt;
        acctrn1.FIIDPayer       = dl_acc.FIID;
        acctrn1.FIIDReceiver    = dl_acc.FIID;
        acctrn1.SumPayer        = dl_acc.Sum;
        acctrn1.SumReceiver     = dl_acc.Sum;
        acctrn1.UserField2      = "1";/*Не выгружать проводку*/
        acctrn1.Number_Pack  = 11;

        if ((acctrn1.FIIDPayer == 0) and (acctrn1.FIIDReceiver == 0))
          acctrn1.FIID = 0; /* нац. валюта */
          acctrn1.Sum = acctrn1.SumPayer;
        end;

        if( not acctrn1.Carry )
          return false;
        end;


        if( not ЮзерПроводкаПоКатегориямУчета( FD,
                                    DebAcc, 
                                    KredAcc,
                                    dl_acc.ValueDate,
                                    21,
                                    dl_acc.FIID,
                                    dl_acc.Sum,
                                    "",
                                    Ground,
                                    null, 
                                    null,
                                    dl_acc.FIID,dl_acc.FIID,
                                    true, 
                                    dl_acc.OperType
                                  ))
       return false;
    end;

        if( not ЮзерПроводкаПоКатегориямУчета( FD,
                                    DebAcc21, 
                                    KredAcc21,
                                    dl_acc.ValueDate,
                                    21,
                                    dl_acc.FIID,
                                    dl_acc.Sum,
                                    "",
                                    Ground,
                                    null, 
                                    null,
                                    dl_acc.FIID,dl_acc.FIID,
                                    true, 
                                    dl_acc.OperType
                                  ))
          return false;
        end;
  end;




/* пишем заглушки для ДУ*/
  if( GetIdentProgram() == CodeFor("А") )
     InstLoadModule("tsid260.mac");
     if( ExecMacro2( "ExecuteStepOrder", dl_acc, ID_Operation, ID_Step ) != 0 )
        MsgBox("Пользователь прервал выполнение шага операции");
        return 1;
     end;
  end;

  if( not InsertOprStatus( 1592, 4) )   
     msgbox( "Ошибка при установке статуса операции" );
     return 1;
  end;


  return 0;
end;
