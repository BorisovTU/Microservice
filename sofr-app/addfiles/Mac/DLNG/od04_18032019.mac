/*
$Name:        od04.mac
$Module:      Ценные бумаги
$Description: Таблица ОД_4: Cделки c иностранной валютой, драгоценными металлами, ценными бумагами и иными базисными активами, отражаемые по главе Г баланса, по состоянию на отчетную дату, а также производные финансовые инструменты, не отраженные по Главе Г
$Programmer:  Кротов А.
*/
import od04_panel, ReportUser;
import captureoutput;


PRIVATE CLASS (TX_ReportUser) od04_Report
  var m_BeginDate, m_EndDate;

  /*Создание отчета*/
  PRIVATE MACRO Create()

    /*Счет по маске*/
    macro AccountMask(acc)
      if(strlen(acc) <= 1)
        return "-";
      elif(strlen(acc) != 20)
        return acc;
      else
        return substr(acc,1,5) + "-" + substr(acc,6,3) + "-" + substr(acc,9,1) + "-" + substr(acc,10,4) + "-" + substr(acc,14);
      end;
    end;

    /*Балансовый счет*/
    macro AccountBal(acc)
      if(strlen(acc) < 5)
        return "-";
      else
        return substr(acc,1,5);
      end;
    end;

    /*Валюта счета*/
    macro AccountCur(acc)
      if(strlen(acc) < 8)
        return "-";
      else
        return substr(acc,6,3);
      end;
    end;

/*Точка входа*/
    var cnt;
    var m_cmd, m_RS_perc, m_cmd_perc, m_que_perc;

    /*Отключаем все индикаторы*/
    if(m_UseTemplate)
      m_ObjTemplateXLS.SetFlagShowIndicator(false);
    else
      __BUG_Global_m_ObjTemplateXLS.SetFlagShowIndicator(false);
    end;
    m_ProgressIndicator = CreateProgressIndicator(true);

    /*Даты отчета*/
    if(m_Form.GetFieldValue(PNFLD_PERIOD) < 13)
      /*Задан месяц*/
      m_BeginDate = date(1, m_Form.GetFieldValue(PNFLD_PERIOD), FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 1) - 1;
    else 
      /*Задан квартал*/
      m_BeginDate = date(1, (m_Form.GetFieldValue(PNFLD_PERIOD) - 12 - 1) * 3 + 1, FormData.Year);
      m_EndDate = DateAfterCalenMonths(m_BeginDate, 3) - 1;
    end;

/*Лист "МСФО08"*/
    SetActiveSheet("Реестр ПФИ на отчетную дату");
    PrintFormatString("", "reportname", "Таблица ОД_4 ""Cделки c иностранной валютой, драгоценными металлами, ценными бумагами и иными базисными активами, отражаемые по главе Г баланса, по состоянию на " + string(date(m_EndDate+1):f) + ", а также производные финансовые инструменты, не отраженные по Главе Г""");
    var curUSD = $0;
    convsum(curUSD, $100, m_EndDate, 7, 0);
    curUSD = double(curUSD) / 100;
    PrintFormatString("", "reportcur", curUSD);
    RegisterTable( "row1_0", "",
             /* 1*/ "row1_1", 
             /* 2*/ "row1_2", 
             /* 3*/ "row1_3", 
             /* 4*/ "row1_4", 
             /* 5*/ "row1_5", 
             /* 6*/ "row1_6", 
             /* 7*/ "row1_7", 
             /* 8*/ "row1_8", 
             /* 9*/ "row1_9", 
             /*10*/ "row1_10", 
             /*11*/ "row1_11", 
             /*12*/ "row1_12", 
             /*13*/ "row1_13", 
             /*14*/ "row1_14", 
             /*15*/ "row1_15", 
             /*16*/ "row1_16", 
             /*17*/ "row1_17", 
             /*18*/ "row1_18", 
             /*19*/ "row1_19", 
             /*20*/ "row1_20", 
             /*21*/ "row1_21", 
             /*22*/ "row1_22", 
             /*23*/ "row1_23", 
             /*24*/ "row1_24", 
             /*25*/ "row1_25", 
             /*26*/ "row1_26", 
             /*27*/ "row1_27", 
             /*28*/ "row1_28", 
             /*29*/ "row1_29", 
             /*30*/ "row1_30", 
             /*31*/ "row1_31", 
             /*32*/ "row1_32", 
             /*33*/ "row1_33", 
             /*34*/ "row1_34", 
             /*35*/ "row1_35", 
             /*36*/ "row1_36", 
             /*37*/ "row1_37", 
             /*38*/ "row1_38", 
             /*39*/ "row1_39", 
             /*40*/ "row1_40");
    this.AutoFilter(6, "B", "AO");
    StartCaptureOutput();
    [
      select case when t_demandaccount = chr(1) then '-'
                  else t_demandaccount
             end t_demandaccount,
             t_demandsum, 
             case when t_demandsum > 0 and t_demandfiid > 0 then round(rsi_rsb_fiinstr.convsum(t_demandsum,t_demandfiid,0,edt),2) 
                  else t_demandsum 
             end t_demandsumRUR,  
             case when t_demandsum > 0 then case when t_demandfiid > 0 then round(rsi_rsb_fiinstr.convsum(1,t_demandfiid,0,edt),4) else 1 end
                  else 0 
             end t_demandrate,  
             case when t_liabilityaccount = chr(1) then '-'
                  else t_liabilityaccount
             end t_liabilityaccount, 
             t_liabilitysum, 
             case when t_liabilitysum > 0 and t_liabilityfiid > 0 then round(rsi_rsb_fiinstr.convsum(t_liabilitysum,t_liabilityfiid,0,edt),2) 
                  else t_liabilitysum 
             end t_liabilitysumRUR,  
             case when t_liabilitysum > 0 then case when t_liabilityfiid > 0 then round(rsi_rsb_fiinstr.convsum(1,t_liabilityfiid,0,edt),4) else 1 end 
                  else 0 
             end t_liabilityrate,  
             t_type
      from (select t_begdate, t_enddate, 
                   sum(t_demandsum) t_demandsum, sum(t_liabilitysum) t_liabilitysum, 
                   max(t_demandaccount) t_demandaccount, max(t_liabilityaccount) t_liabilityaccount, 
                   max(t_demandfiid) t_demandfiid, max(t_liabilityfiid) t_liabilityfiid, 
                   'ПРОЦЕНТНЫЙ ПЕРИОД ('||to_char(row_number() over(order by t_begdate), 'fm999')||' '||t_rate||')' t_type
            from (select dvnpmgr.t_begdate, 
                         dvnpmgr.t_enddate, 
                         dvnpmgr.t_demandsum, 
                         dvnpmgr.t_liabilitysum, 
                         case when dvnpmgr.t_demandsum > 0 then dvnpmgr.t_demandaccount 
                              else chr(1) 
                         end t_demandaccount, 
                         case when dvnpmgr.t_liabilitysum > 0 then dvnpmgr.t_liabilityaccount 
                              else chr(1) end t_liabilityaccount, 
                         case when dvnpmgr.t_demandsum > 0 then dvnfi.t_fiid 
                              else -1 
                         end t_demandfiid, 
                         case when dvnpmgr.t_liabilitysum > 0 then dvnfi.t_fiid 
                              else -1 
                         end t_liabilityfiid, 
                         case when dvnfi.t_rateid > 0 then 'плав' 
                              else 'фикс' 
                         end t_rate
                  from ddvnpmgr_dbt dvnpmgr
                  join (select :dialid dialid, :bdt bdt, :edt edt from dual) on 1=1
                  join ddvnfi_dbt dvnfi on dvnfi.t_dealid = dvnpmgr.t_dealid and
                                           dvnpmgr.t_side = decode(dvnfi.t_type,0,1,2)
                  where dvnpmgr.t_dealid in (:dialid))
            group by t_begdate, t_enddate, t_rate)
      join (select :bdt bdt, :edt edt from dual) on t_enddate >= bdt 
      order by t_begdate    
    ];
    m_que_perc = EndCaptureOutput();
    StartCaptureOutput();
    [
     select count(1) over() t_cnt,
            t_id, t_code, t_extcode, t_contragentname, t_dealkind, t_dealtype, t_exectype, t_dealdate, t_execdate, t_rate, 
            t_definition, t_ficodeT, t_ficodeO,
            t_accountT, t_accountTfiid, t_amountT, case when fi_kind = 1 or t_accountT = chr(1) then t_amountTRUR else t_accountTrestRUR end t_amountTRUR, t_ratefiidT, 
            t_accountO, t_accountOfiid, t_amountO, case when fi_kind = 1 or t_accountO = chr(1) then t_amountORUR else t_accountOrestRUR end t_amountORUR, t_ratefiidO, 
            t_isresident, t_isnetting, t_genagr, t_account453, t_account454,
            t_restaccount453, 
            t_restaccount454 
    from (select fi_kind,
                 t_id, t_code, t_extcode, t_contragentname, t_dealkind, t_dealtype, t_exectype, t_dealdate, t_execdate, t_rate, 
                 t_definition, t_ficodeT, t_ficodeO,
                 t_accountT, t_accountTfiid, t_amountT, t_amountTRUR, t_accountTrest, case when t_accountTfiid = 0 then t_accountTrest else abs(round(rsi_rsb_fiinstr.convsum(t_accountTrest, t_accountTfiid, 0, edt), 2)) end t_accountTrestRUR, t_ratefiidT, 
                 t_accountO, t_accountOfiid, t_amountO, t_amountORUR, t_accountOrest, case when t_accountOfiid = 0 then t_accountOrest else abs(round(rsi_rsb_fiinstr.convsum(t_accountOrest, t_accountOfiid, 0, edt), 2)) end t_accountOrestRUR, t_ratefiidO, 
                 t_isresident, t_isnetting, t_genagr, t_account453, t_account454,
                 t_restaccount453, 
                 t_restaccount454 
          from (select edt, fi_kind,
                      t_id, t_code, t_extcode, t_contragentname, t_dealkind, t_dealtype, t_exectype, t_dealdate, t_execdate, t_rate, 
                      t_definition, t_ficodeT, t_ficodeO,
                      t_accountT, t_accountTfiid, t_amountT, t_amountTRUR, abs(rsb_account.restall(t_accountT, 4, t_accountTfiid, edt)) t_accountTrest, t_ratefiidT, 
                      t_accountO, t_accountOfiid, t_amountO, t_amountORUR, abs(rsb_account.restall(t_accountO, 4, t_accountOfiid, edt)) t_accountOrest, t_ratefiidO, 
                      t_isresident, t_isnetting, t_genagr, t_account453, t_account454,
                      case when t_account453 != chr(1) then abs(rsb_account.restall(t_account453, 1, 0, edt)) else 0 end t_restaccount453, 
                      case when t_account454 != chr(1) then abs(rsb_account.restall(t_account454, 1, 0, edt)) else 0 end t_restaccount454 
               from(select bdt,
                           edt,
                           case when dvndeal.fi_kind in (1,6) then 1 else 2 end fi_kind,
                           dvndeal.t_id t_id, 
                           dvndeal.t_code t_code,
                           dvndeal.t_extcode t_extcode,
                           nvl(contragent.t_shortname,chr(1)) t_contragentname,
                           case when dvndeal.fi_kind in (1,6) then case when dvndeal.t_dealtype in ('O','U','S','D') then case when dvndeal.t_type = 1 then 'покупка' else 'продажа' end ||' '|| dvndeal.t_ccyT||' за '||dvndeal.t_ccyO else '-' end
                                else case when dvndeal.t_ispfi = chr(88) then 'ПФИ' else 'срочная' end
                           end t_dealkind,
                           case when dvndeal.fi_kind in (1,6) then
                                     case when dvndeal.t_dealtype = 'P' then case when dvndeal.t_fiidT = dvndeal.t_fiidO then 'ПРОЦЕНТНЫЙ СВОП' else 'ВАЛЮТНО-ПРОЦЕНТНЫЙ СВОП' end
                                          when dvndeal.t_dealtype = 'O' then 'OPTION' 
                                          when dvndeal.t_dealtype = 'U' then case when dvndeal.t_ispfi = chr(88) then 'FORWARD PFI' else 'FORWARD' end
                                          when dvndeal.t_dealtype = 'S' then case when dvndeal.t_ispfi = chr(88) then 'SWAP PFI' else 'SWAP' end 
                                          when dvndeal.t_dealtype = 'D' then case when dvndeal.t_periodcls = 0 then 'TODAY' 
                                                                                  when dvndeal.t_periodcls = 1 then 'TOMORROW' 
                                                                                  when dvndeal.t_periodcls = 2 then 'SPOT' 
                                                                                  else 'T+'||to_char(nvl(dvndeal.t_periodcls,0),'fm99999')
                                                                             end 
                                          else '-' 
                                     end
                                else case when dvndeal.t_type = 1 then 'BUY' else 'SALE' end
                           end t_dealtype, 
                           case when dvndeal.t_exectypeT = 1 or dvndeal.t_dockind = 4813/*Конверсионная сделка ФИССиКО*/ then 'ПОСТАВОЧНАЯ' 
                                else 'БЕСПОСТАВОЧНАЯ' 
                           end t_exectype,
                           dvndeal.t_date t_dealdate,
                           dvndeal.t_execdate t_execdate,
                           case when dvndeal.fi_kind in (1,6) and dvndeal.t_dealtype in ('O','U','S','D') then dvndeal.t_priceT 
                                else 0 
                           end t_rate,
                           case when fininstrT.t_fi_kind = 2 then fininstrT.t_definition
                                when fininstrO.t_fi_kind = 2 then fininstrO.t_definition
                                else '-'
                           end t_definition, 
                           case when fininstrT.t_fi_kind = 2 then fininstrO.t_ccy
                                when fininstrO.t_fi_kind = 2 then fininstrT.t_ccy
                                else fininstrT.t_codeinaccount
                           end t_ficodeT, 
                           case when fininstrT.t_fi_kind = 2 then fininstrT.t_definition
                                when fininstrO.t_fi_kind = 2 then fininstrO.t_definition
                                else fininstrO.t_codeinaccount
                           end t_ficodeO, 
                           (select nvl(max(mcaccdoc.t_account),chr(0)) 
                            from dmcaccdoc_dbt mcaccdoc
                            where mcaccdoc.t_dockind = dvndeal.t_dockind and
                                  mcaccdoc.t_docid = dvndeal.t_id and
                                  mcaccdoc.t_catid in (460,477,616) and
                                  ((fininstrT.t_fi_kind != 2 and mcaccdoc.t_currency = dvndeal.t_fiidT) or (fininstrT.t_fi_kind = 2 and mcaccdoc.t_currency = fininstrT.t_facevaluefi)) and
                                  mcaccdoc.t_chapter = 4 and
                                  mcaccdoc.t_activatedate <= edt and
                                  (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate > edt)) t_accountT,
                           case when fininstrT.t_fi_kind != 2 then dvndeal.t_fiidT else fininstrT.t_facevaluefi end t_accountTfiid,
                           case when dvndeal.fi_kind in (1,6) or fininstrT.t_fi_kind = 2 then dvndeal.t_amountT 
                                  else  dvndeal.t_amountO  
                           end t_amountT,
                           case when dvndeal.t_fiidT = 0 then dvndeal.t_amountT
                                when fininstrT.t_fi_kind = 2 then case when fininstrT.t_facevaluefi = 0 then  round(dvndeal.t_amountT * fininstrT.t_facevalue, 2)  else round(rsi_rsb_fiinstr.convsum(dvndeal.t_amountT * fininstrT.t_facevalue,fininstrT.t_facevaluefi,0,edt),2) end
                                else round(rsi_rsb_fiinstr.convsum(dvndeal.t_amountT,dvndeal.t_fiidT,0,edt),2) 
                           end t_amountTRUR,
                           case when dvndeal.fi_kind in (1,6) then
                           case when dvndeal.t_fiidT = 0 then 1
                                else round(rsi_rsb_fiinstr.convsum(1,dvndeal.t_fiidT,0,edt),4)
                           end else 0 end t_ratefiidT,
                           (select nvl(max(mcaccdoc.t_account),chr(0)) 
                            from dmcaccdoc_dbt mcaccdoc
                            where mcaccdoc.t_dockind = dvndeal.t_dockind and
                                  mcaccdoc.t_docid = dvndeal.t_id and
                                  mcaccdoc.t_catid in (461,476,617) and
                                  ((fininstrO.t_fi_kind != 2 and mcaccdoc.t_currency = dvndeal.t_fiidO) or (fininstrO.t_fi_kind = 2 and mcaccdoc.t_currency = fininstrO.t_facevaluefi)) and
                                  mcaccdoc.t_chapter = 4 and
                                  mcaccdoc.t_activatedate <= edt and 
                                  (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate > edt)) t_accountO,
                           case when fininstrO.t_fi_kind != 2 then dvndeal.t_fiidO else fininstrO.t_facevaluefi end t_accountOfiid,
                           case when dvndeal.fi_kind in (1,6) or fininstrO.t_fi_kind = 2 then dvndeal.t_amountO 
                                else  dvndeal.t_amountT  
                           end t_amountO,
                           case when dvndeal.t_fiidO = 0 then dvndeal.t_amountO
                                when fininstrO.t_fi_kind = 2 then case when fininstrO.t_facevaluefi = 0 then round(dvndeal.t_amountO * fininstrO.t_facevalue, 2) else round(rsi_rsb_fiinstr.convsum(dvndeal.t_amountO * fininstrO.t_facevalue,fininstrO.t_facevaluefi,0,edt),2) end
                                else round(rsi_rsb_fiinstr.convsum(dvndeal.t_amountO,dvndeal.t_fiidO,0,edt),2) 
                           end t_amountORUR,
                           case when dvndeal.fi_kind in (1,6) then
                           case when dvndeal.t_fiidO = 0 then 1
                                else round(rsi_rsb_fiinstr.convsum(1,dvndeal.t_fiidO,0,edt),4)
                           end else 0 end t_ratefiidO,
                           case when contragent.t_notresident is null then '-' when contragent.t_notresident = chr(88) then 'N' 
                                else 'Y' 
                           end t_isresident,
                           case when dvndeal.t_netting = chr(88) then 'Y' 
                                else 'N' 
                           end t_isnetting,
                           case when dvndeal.fi_kind in (1,6) then  
                                     case when dl_genagr.t_code is null then '-' 
                                          else dl_genagr.t_code||' от '||to_char(dl_genagr.t_start,'dd.mm.yyyy') 
                                     end 
                                else case when dvndeal.t_marketkind = 0 then 'ВНЕБИРЖА' else 'БИРЖА' end
                           end t_genagr,
                          (select nvl(max(mcaccdoc.t_account),chr(0)) 
                           from dmcaccdoc_dbt mcaccdoc
                           where mcaccdoc.t_dockind = dvndeal.t_dockind and
                                 mcaccdoc.t_docid = dvndeal.t_id and
                                 mcaccdoc.t_catid = 453 and
                                 mcaccdoc.t_currency = 0 and
                                 mcaccdoc.t_chapter = 1 and
                                 mcaccdoc.t_activatedate <= edt and
                                 (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate > edt)) t_account453,
                          (select nvl(max(mcaccdoc.t_account),chr(0)) 
                           from dmcaccdoc_dbt mcaccdoc
                           where mcaccdoc.t_dockind = dvndeal.t_dockind and
                                 mcaccdoc.t_docid = dvndeal.t_id and
                                 mcaccdoc.t_catid = 454 and
                                 mcaccdoc.t_currency = 0 and
                                 mcaccdoc.t_chapter = 1 and
                                 mcaccdoc.t_activatedate <= edt and
                                 (mcaccdoc.t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') or mcaccdoc.t_disablingdate > edt)) t_account454
                    from(--Процентный СВОП (только валюта)
                         select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                                -- Сделка
                                dvndeal.t_id, dvndeal.t_extcode, dvndeal.t_code, dvndeal.t_contractor, dvndeal.t_netting, dvndeal.t_date, dvndeal.t_dockind, 
                                dvndeal.t_type, 'P' t_dealtype, dvndeal.t_ispfi, dvndeal.t_genagrid, dvndeal.t_periodcls, dvndeal.t_marketkind,
                                greatest(dvnfiT.t_execdate, dvnfiT.t_paydate, dvnfiO.t_execdate, dvnfiO.t_paydate) t_execdate,
                                -- Требования
                                dvnfiT.t_exectype t_exectypeT,
                                fininstrT.t_fiid t_fiidT,
                                fininstrT.t_ccy t_ccyT, 
                                dvnfiT.t_amount t_amountT,
                                dvnfiT.t_price t_priceT,
                                -- Обязательста
                                fininstrO.t_fiid t_fiidO,
                                fininstrO.t_ccy t_ccyO, 
                                dvnfiO.t_amount t_amountO 
                         from ddvndeal_dbt dvndeal 
                         join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                        regexp_like(oprkoper.t_systypes, 'P'/*Процентный СВОП*/)
                         join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                                   dvnfiT.t_type = 2 
                         join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                         fininstrT.t_fi_kind = 1
                         join ddvnfi_dbt dvnfiO on dvnfiO.t_dealid = dvndeal.t_id and 
                                                   dvnfiO.t_type = 0
                         join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiO.t_fiid and 
                                                         fininstrO.t_fi_kind = 1  
                         where dvndeal.t_dockind = 199/*Внебиржевая сделка с ПИ*/ and 
                               dvndeal.t_date <= edt and 
                               dvndeal.t_state >= 1 and
                               typ in (0,1)
                         union all
                         -- Опцион/Форвард (любой актив за валюту)
                         select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                                -- Сделка
                                dvndeal.t_id, dvndeal.t_code, dvndeal.t_extcode, dvndeal.t_contractor, dvndeal.t_netting, dvndeal.t_date, dvndeal.t_dockind, 
                                dvndeal.t_type, case when regexp_like(oprkoper.t_systypes, 'O') then 'O' else 'U' end t_dealtype, dvndeal.t_ispfi, dvndeal.t_genagrid, dvndeal.t_periodcls, dvndeal.t_marketkind,
                                greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                                -- Требования
                                dvnfiT.t_exectype t_exectypeT,
                                case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                                fininstrT.t_ccy t_ccyT, 
                                case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                                dvnfiT.t_price t_priceT,
                                -- Обязательста
                                case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                                fininstrO.t_ccy t_ccyO, 
                                case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                         from ddvndeal_dbt dvndeal 
                         join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                        regexp_like(oprkoper.t_systypes, '[O|U]'/*Опцион/Форвард*/)
                         join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                                   dvnfiT.t_type = 0 
                         join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                         ((fininstrT.t_fi_kind in (1,6) and typ in (0,1)) or (fininstrT.t_fi_kind in (2) and typ in (0,2)))
                         join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                         fininstrO.t_fi_kind = 1  
                         where dvndeal.t_dockind = 199/*Внебиржевая сделка с ПИ*/ and 
                               dvndeal.t_date <= edt and 
                               dvndeal.t_state >= 1
                         union all
                         -- Валютный СВОП - первая нога (валюта и драгметалл)
                         select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                                -- Сделка
                                dvndeal.t_id, dvndeal.t_extcode, dvndeal.t_code, dvndeal.t_contractor, dvndeal.t_netting, dvndeal.t_date, dvndeal.t_dockind, 
                                case when dvndeal.t_type = 5 then 1 else dvndeal.t_type end t_type , 'S' t_dealtype, dvndeal.t_ispfi, dvndeal.t_genagrid, dvndeal.t_periodcls, dvndeal.t_marketkind,
                                greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                                -- Требования
                                dvnfiT.t_exectype t_exectypeT,
                                case when dvndeal.t_type != 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                                fininstrT.t_ccy t_ccyT, 
                                case when dvndeal.t_type != 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                                dvnfiT.t_price t_priceT,
                                -- Обязательста
                                case when dvndeal.t_type != 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                                fininstrO.t_ccy t_ccyO, 
                                case when dvndeal.t_type != 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                         from ddvndeal_dbt dvndeal 
                         join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                        regexp_like(oprkoper.t_systypes, 'S'/*Валютный СВОП*/)
                         join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                                   dvnfiT.t_type = 0 
                         join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                         fininstrT.t_fi_kind in (1,6)
                         join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                         fininstrO.t_fi_kind = 1  
                         where dvndeal.t_dockind in (199/*Внебиржевая сделка с ПИ*/, 4813/*Конверсионная сделка ФИССиКО*/) and 
                               dvndeal.t_date <= edt and 
                               dvndeal.t_state >= 1 and
                               typ in (0,1)
                         union all
                         -- Валютный ПФИ - вторая нога (валюта и драгметалл)
                         select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                                -- Сделка
                                dvndeal.t_id, dvndeal.t_extcode, dvndeal.t_code, dvndeal.t_contractor, dvndeal.t_netting, dvndeal.t_date, dvndeal.t_dockind, 
                                case when dvndeal.t_type != 5 then 1 else dvndeal.t_type end t_type, 'S' t_dealtype, dvndeal.t_ispfi, dvndeal.t_genagrid, dvndeal.t_periodcls, dvndeal.t_marketkind,
                                greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                                -- Требования
                                dvnfiT.t_exectype t_exectypeT,
                                case when dvndeal.t_type = 5 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                                fininstrT.t_ccy t_ccyT, 
                                case when dvndeal.t_type = 5 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                                dvnfiT.t_price t_priceT,
                                -- Обязательста
                                case when dvndeal.t_type = 5 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                                fininstrO.t_ccy t_ccyO, 
                                case when dvndeal.t_type = 5 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                         from ddvndeal_dbt dvndeal 
                         join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                        regexp_like(oprkoper.t_systypes, 'S'/*Валютный СВОП*/)
                         join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                                   dvnfiT.t_type = 2 
                         join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                         fininstrT.t_fi_kind in (1,6)
                         join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                         fininstrO.t_fi_kind = 1  
                         where dvndeal.t_dockind in (199/*Внебиржевая сделка с ПИ*/, 4813/*Конверсионная сделка ФИССиКО*/) and 
                               dvndeal.t_date <= edt and 
                               dvndeal.t_state >= 1 and
                               typ in (0,1)
                         union all
                         -- Покупка/продажа конверсионной операцией (валюта за драгметалл, драгметалл за валюту и валюта за валюту)
                         select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                                -- Сделка
                                dvndeal.t_id, dvndeal.t_code, dvndeal.t_extcode, dvndeal.t_contractor, dvndeal.t_netting, dvndeal.t_date, dvndeal.t_dockind, 
                                dvndeal.t_type, 'D' t_dealtype, dvndeal.t_ispfi, dvndeal.t_genagrid, dvndeal.t_periodcls, dvndeal.t_marketkind,
                                greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                                -- Требования
                                dvnfiT.t_exectype t_exectypeT,
                                case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                                fininstrT.t_ccy t_ccyT, 
                                case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                                dvnfiT.t_price t_priceT,
                                -- Обязательста
                                case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                                fininstrO.t_ccy t_ccyO, 
                                case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                         from ddvndeal_dbt dvndeal 
                         join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                        regexp_like(oprkoper.t_systypes, 'D'/*Покупка/продажа*/)
                         join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                                   dvnfiT.t_type = 0 
                         join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                         fininstrT.t_fi_kind in (1,6)
                         join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                         fininstrO.t_fi_kind in (1,6)  
                         where dvndeal.t_dockind = 4813/*Конверсионная сделка ФИССиКО*/ and 
                               dvndeal.t_date <= edt and 
                               dvndeal.t_state >= 1 and
                               typ in (0,1)
                         union all
                         -- Покупка/продажа сделкой Т+ (любой актив за валюту)
                         select bdt, edt, typ, fininstrT.t_fi_kind fi_kind,
                                -- Сделка
                                dvndeal.t_id, dvndeal.t_code, dvndeal.t_extcode, dvndeal.t_contractor, dvndeal.t_netting, dvndeal.t_date, dvndeal.t_dockind, 
                                dvndeal.t_type, 'D' t_dealtype, dvndeal.t_ispfi, dvndeal.t_genagrid, dvndeal.t_periodcls, dvndeal.t_marketkind,
                                greatest(dvnfiT.t_execdate, dvnfiT.t_paydate) t_execdate,
                                -- Требования
                                dvnfiT.t_exectype t_exectypeT,
                                case when dvndeal.t_type != 1 then fininstrO.t_fiid else fininstrT.t_fiid end t_fiidT,
                                fininstrT.t_ccy t_ccyT, 
                                case when dvndeal.t_type != 1 then dvnfiT.t_cost else dvnfiT.t_amount end t_amountT,
                                dvnfiT.t_price t_priceT,
                                -- Обязательста
                                case when dvndeal.t_type != 1 then fininstrT.t_fiid else fininstrO.t_fiid end t_fiidO,
                                fininstrO.t_ccy t_ccyO, 
                                case when dvndeal.t_type != 1 then dvnfiT.t_amount else dvnfiT.t_cost end t_amountO 
                         from ddvndeal_dbt dvndeal 
                         join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                         join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dvndeal.t_kind and 
                                                        regexp_like(oprkoper.t_systypes, 'D'/*Покупка/продажа*/)
                         join ddvnfi_dbt dvnfiT on dvnfiT.t_dealid = dvndeal.t_id and 
                                                   dvnfiT.t_type = 0 
                         join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvnfiT.t_fiid and 
                                                         ((fininstrT.t_fi_kind in (1,6) and typ in (0,1)) or (fininstrT.t_fi_kind in (2) and typ in (0,2)))
                         join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvnfiT.t_pricefiid and 
                                                         fininstrO.t_fi_kind = 1  
                         where dvndeal.t_dockind = 4815/*Сделка Т+3*/ and 
                               dvndeal.t_date <= edt and 
                               dvndeal.t_state >= 1
                         union all
                         -- Сделки покупки/продажи БОЦБ
                         select bdt, edt, typ, 2 fi_kind,
                                -- Сделка
                                dl_tick.t_dealid t_id,
                                dl_tick.t_dealcode t_code,
                                dl_tick.t_dealcodets t_extcode,
                                dl_tick.t_partyid t_contractor,
                                case when dl_tick.t_netting = 0 then chr(0) else chr(88) end t_netting,
                                dl_tick.t_dealdate t_date,
                                dl_tick.t_bofficekind t_dockind, 
                                case when deal.t_dealtype = 'B' then 1 else 2 end t_type,
                                deal.t_dealtype,
                                chr(0) t_ispfi,
                                -1 t_genagrid,
                                0 t_periodcls,
                                deal.t_marketkind,
                                deal.t_execdate,
                                -- Требования
                                1 t_exectypeT,
                                case when deal.t_dealtype = 'B' then dl_leg.t_pfi else dl_leg.t_cfi end t_fiidT,
                                chr(0) t_ccyT, 
                                case when deal.t_dealtype = 'B' then dl_leg.t_principal else dl_leg.t_totalcost end t_amountT,
                                0 t_priceT,
                                -- Обязательста
                                case when deal.t_dealtype = 'S' then dl_leg.t_pfi else dl_leg.t_cfi end t_fiidO,
                                chr(0) t_ccyO, 
                                case when deal.t_dealtype = 'S' then dl_leg.t_principal else dl_leg.t_totalcost end t_amountO
                         from (select bdt, edt, typ, 
                                      dl_tick.t_dealid, 
                                      rsb_brkrep_u.GetExecDate(dl_tick.t_bofficekind, dl_tick.t_dealid, 1) t_execdate,
                                      case when regexp_like(oprkoper.t_systypes, 'B') then 'B' else 'S' end t_dealtype,
                                      case when regexp_like(oprkoper.t_systypes, 'X') then 1 else 0 end t_marketkind
                               from ddl_tick_dbt dl_tick
                               join (select :bdt bdt, :edt edt, :typ typ from dual) on 1=1
                               join doprkoper_dbt oprkoper on oprkoper.t_kind_operation = dl_tick.t_dealtype and regexp_like(oprkoper.t_systypes, '[B|S]'/*Покупка/Продажа*/)
                               where dl_tick.t_bofficekind = 101 and
                                     dl_tick.t_clientid = -1 and
                                     dl_tick.t_dealdate <= edt and
                                     typ in (0,2)) deal
                         join ddl_tick_dbt dl_tick on dl_tick.t_dealid = deal.t_dealid
                         join ddl_leg_dbt dl_leg on dl_leg.t_dealid = deal.t_dealid
                         where deal.t_execdate > edt) dvndeal
                    join dfininstr_dbt fininstrT on fininstrT.t_fiid = dvndeal.t_fiidT  
                    join dfininstr_dbt fininstrO on fininstrO.t_fiid = dvndeal.t_fiidO  
                    left join dparty_dbt contragent on contragent.t_partyid = dvndeal.t_contractor
                    left join ddl_genagr_dbt dl_genagr on dvndeal.fi_kind in (0,6) and 
                                                          dl_genagr.t_genagrid = dvndeal.t_genagrid
                    where dvndeal.t_execdate > edt)))
      order by fi_kind, t_dealtype, t_code
    ];
    m_cmd = RsdCommand(EndCaptureOutput());
    m_cmd.AddParam("bdt", RSDBP_IN, m_BeginDate);
    m_cmd.AddParam("edt", RSDBP_IN, m_EndDate);
    if(m_Form.GetFieldValue(PNFLD_CURRENCY) == "X")
      if(m_Form.GetFieldValue(PNFLD_SECURITY) == "X")
        m_cmd.AddParam("typ", RSDBP_IN, 0);
      else
        m_cmd.AddParam("typ", RSDBP_IN, 1);
      end;
    else
      m_cmd.AddParam("typ", RSDBP_IN, 2);
    end;

    m_cmd.Execute();
    m_RS = TRsbDataSet(m_cmd);
    cnt = 0;
    var Account, RestAccount;
    while(m_RS.movenext)
      if(cnt == 0)
        InitProgress(int(m_RS.value("t_cnt")), "Ждите...", "Формирование таблицы \"ОД_4\"");
      end;
      cnt = cnt + 1;
      /*Счет ПФИ*/
      if((m_RS.value("t_account453") != "") and (m_RS.value("t_restaccount453") != 0))
        Account = m_RS.value("t_account453");
        RestAccount = m_RS.value("t_restaccount453");
      elif((m_RS.value("t_account454") != "") and (m_RS.value("t_restaccount454") != 0))
        Account = m_RS.value("t_account454");
        RestAccount = m_RS.value("t_restaccount454");
      else
        Account = null;
        RestAccount = null;
      end;
      /*Выводим строку отчета*/
      PrintTableLine(
            /* 1*/ "row1_1", m_RS.value("t_code"), null, 
            /* 2*/ "row1_2", m_RS.value("t_extcode"), null, 
            /* 3*/ "row1_3", m_RS.value("t_contragentname"), null, 
            /* 4*/ "row1_4", m_RS.value("t_dealkind"), null, 
            /* 5*/ "row1_5", m_RS.value("t_dealtype"), null, 
            /* 6*/ "row1_6", m_RS.value("t_exectype"), null, 
            /* 7*/ "row1_7", date(m_RS.value("t_dealdate")), null, 
            /* 8*/ "row1_8", date(m_RS.value("t_execdate")), null, 
            /* 9*/ "row1_9", m_RS.value("t_rate"), 4, 
            /*10*/ "row1_10", AccountMask(m_RS.value("t_accountT")), null, 
            /*11*/ "row1_11", AccountBal(m_RS.value("t_accountT")), null, 
            /*12*/ "row1_12", m_RS.value("t_ficodeT"), null, 
            /*13*/ "row1_13", m_RS.value("t_definition"), null, 
            /*14*/ "row1_14", m_RS.value("t_amountT"), 2, 
            /*15*/ "row1_15", m_RS.value("t_amountTRUR"), 2, 
            /*16*/ "row1_16", m_RS.value("t_ratefiidT"), 4, 
            /*17*/ "row1_17", "-", null, 
            /*18*/ "row1_18", "", null, 
            /*19*/ "row1_19", AccountMask(m_RS.value("t_accountO")), null, 
            /*20*/ "row1_20", AccountBal(m_RS.value("t_accountO")), null, 
            /*21*/ "row1_21", m_RS.value("t_ficodeO"), null, 
            /*22*/ "row1_22", m_RS.value("t_amountO"), 2, 
            /*23*/ "row1_23", m_RS.value("t_amountORUR"), 2, 
            /*24*/ "row1_24", "-", null, 
            /*25*/ "row1_25", m_RS.value("t_ratefiidO"), 4, 
            /*26*/ "row1_26", "", null, 
            /*27*/ "row1_27", AccountMask(Account), null, 
            /*28*/ "row1_28", AccountCur(Account), null, 
            /*29*/ "row1_29", RestAccount, 2, 
            /*30*/ "row1_30", "", null, 
            /*31*/ "row1_31", "", null, 
            /*32*/ "row1_32", "", null, 
            /*33*/ "row1_33", m_RS.value("t_isresident"), null, 
            /*34*/ "row1_34", "", null, 
            /*35*/ "row1_35", "", null, 
            /*36*/ "row1_36", "", null, 
            /*37*/ "row1_37", "", null, 
            /*38*/ "row1_38", m_RS.value("t_isnetting"), null, 
            /*39*/ "row1_39", "", null, 
            /*40*/ "row1_40", m_RS.value("t_genagr"), null);
      /*Процентые периоды для процентных свопов*/
      if((m_RS.value("t_dealtype") == "ПРОЦЕНТНЫЙ СВОП") or (m_RS.value("t_dealtype") == "ВАЛЮТНО-ПРОЦЕНТНЫЙ СВОП"))
        m_cmd_perc = RsdCommand(m_que_perc);
        m_cmd_perc.AddParam("dialid", RSDBP_IN, m_RS.value("t_id"));
        m_cmd_perc.AddParam("bdt", RSDBP_IN, m_BeginDate);
        m_cmd_perc.AddParam("edt", RSDBP_IN, m_EndDate);
        m_cmd_perc.Execute();
        m_RS_perc = TRsbDataSet(m_cmd_perc);
        while(m_RS_perc.movenext)
        /*Выводим строку отчета*/
        PrintTableLine(
              /* 1*/ "row1_1", m_RS.value("t_code"), null, 
              /* 2*/ "row1_2", m_RS.value("t_extcode"), null, 
              /* 3*/ "row1_3", m_RS.value("t_contragentname"), null, 
              /* 4*/ "row1_4", "-", null, 
              /* 5*/ "row1_5", m_RS_perc.value("t_type"), null, 
              /* 6*/ "row1_6", "-", null, 
              /* 7*/ "row1_7", "-", null, 
              /* 8*/ "row1_8", "-", null, 
              /* 9*/ "row1_9", "-", null, 
              /*10*/ "row1_10", m_RS_perc.value("t_demandaccount"), null, 
              /*11*/ "row1_11", AccountBal(m_RS_perc.value("t_demandaccount")), null, 
              /*12*/ "row1_12", AccountCur(m_RS_perc.value("t_demandaccount")), null, 
              /*13*/ "row1_13", "-", null, 
              /*14*/ "row1_14", m_RS_perc.value("t_demandsum"), null, 
              /*15*/ "row1_15", m_RS_perc.value("t_demandsumRUR"), null, 
              /*16*/ "row1_16", m_RS_perc.value("t_demandrate"), null, 
              /*17*/ "row1_17", "-", null, 
              /*18*/ "row1_18", "-", null, 
              /*19*/ "row1_19", m_RS_perc.value("t_liabilityaccount"), null, 
              /*20*/ "row1_20", AccountBal(m_RS_perc.value("t_liabilityaccount")), null, 
              /*21*/ "row1_21", AccountCur(m_RS_perc.value("t_liabilityaccount")), null, 
              /*22*/ "row1_22", m_RS_perc.value("t_liabilitysum"), null, 
              /*23*/ "row1_23", m_RS_perc.value("t_liabilitysumRUR"), null, 
              /*24*/ "row1_24", "-", null, 
              /*25*/ "row1_25", m_RS_perc.value("t_liabilityrate"), null, 
              /*26*/ "row1_26", "-", null, 
              /*27*/ "row1_27", "", null, 
              /*28*/ "row1_28", "-", null, 
              /*29*/ "row1_29", "-", 2, 
              /*30*/ "row1_30", "", null, 
              /*31*/ "row1_31", "", null, 
              /*32*/ "row1_32", "", null, 
              /*33*/ "row1_33", m_RS.value("t_isresident"), null, 
              /*34*/ "row1_34", "", null, 
              /*35*/ "row1_35", "", null, 
              /*36*/ "row1_36", "", null, 
              /*37*/ "row1_37", "", null, 
              /*38*/ "row1_38", m_RS.value("t_isnetting"), null, 
              /*39*/ "row1_39", "", null, 
              /*40*/ "row1_40", m_RS.value("t_genagr"), null);
        end;
      end;
      UseProgress(cnt);
    end;
    if(cnt > 0)
      RemProgress();
    end;
    EndTable();
  END;
  
  initTX_RegistrReport(od04_Panel(), "od04.xlsx");

END;

/*Точка входа*/
var r = od04_Report();
r.InitReport("ОД04", null);
r.Run();

exit(1);
