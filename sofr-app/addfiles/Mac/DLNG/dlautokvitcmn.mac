/*
$Name:             dlautokvitcmn.mac
$Module:           
$Description:      Ä¢‚Æ™¢®‚Æ¢™† Ø´†‚•¶•©. é°È®• ‰„≠™Ê®®
*/

import BankInter, dlquery, likepy, vslib;

CONST STAT_DATES_NOT_MATCH = 8742;

class KvitSuccess
  var PlanID       :integer; // ID Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var DealCode     :string;  // çÆ¨•‡ ·§•´™®, ™ ™Æ‚Æ‡Æ© Æ‚≠Æ·®‚·Ô Ø´†≠Æ¢Î© Ø´†‚•¶
  var PlanDate     :date;    // Ñ†‚† Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var PlanAmount   :money;   // ë„¨¨† Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var PlanCurrency :string;  // ñ®‰‡Æ¢Æ© ™Æ§ ¢†´Ó‚Î Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var FactID       :integer; // ID ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var FactDate     :date;    // Ñ†‚† ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var FactAmount   :money;   // ë„¨¨† ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var FactCurrency :string;  // ñ®‰‡Æ¢Æ© ™Æ§ ¢†´Ó‚Î ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var Amount       :money;   // ë™¢®‚Æ¢†≠≠†Ô ·„¨¨† Ø´†≠Æ¢Æ£Æ ® ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶•©
  //Simanov
  var Payer        :string;  // è´†‚•´ÏÈ®™
  var FactGround   :string;  // é·≠Æ¢†≠®• ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
END;

class KvitFail
  var PlanID       :integer; // ID Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var DealCode     :string;  // çÆ¨•‡ ·§•´™®, ™ ™Æ‚Æ‡Æ© Æ‚≠Æ·®‚·Ô Ø´†≠Æ¢Î© Ø´†‚•¶
  var PlanDate     :date;    // Ñ†‚† Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var PlanAmount   :money;   // ë„¨¨† Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var PlanCurrency :string;  // ñ®‰‡Æ¢Æ© ™Æ§ ¢†´Ó‚Î Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var Notice       :string;  // è‡®¨•Á†≠®•
END;

class NoKvitPair
  var PlanID       :integer; // ID Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var DealCode     :string;  // çÆ¨•‡ ·§•´™®, ™ ™Æ‚Æ‡Æ© Æ‚≠Æ·®‚·Ô Ø´†≠Æ¢Î© Ø´†‚•¶
  var PlanDate     :date;    // Ñ†‚† Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var PlanAmount   :money;   // ë„¨¨† Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var PlanCurrency :string;  // ñ®‰‡Æ¢Æ© ™Æ§ ¢†´Ó‚Î Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†
  var FactID       :integer; // ID ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var FactDate     :date;    // Ñ†‚† ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var FactAmount   :money;   // ë„¨¨† ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var FactCurrency :string;  // ñ®‰‡Æ¢Æ© ™Æ§ ¢†´Ó‚Î ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†
  var Notice       :string;  // è‡®¨•Á†≠®•
END;

class KvitResData(p1, p2, p3, p4)
  var KvitSuccessArray = TArray();
  var KvitFailArray = TArray();
  var NoKvitPairArray = TArray();
  var KvitNoContracorArray = TArray(); //Simanov
  if (p1)
    KvitSuccessArray = p1;
  end;
  if (p2)
    KvitFailArray = p2;
  end;
  if (p3)
    NoKvitPairArray = p3;
  end;
  if (p4)
    KvitNoContracorArray = p4;
  end;
end;

//Simanov
MACRO KvitPrintHeaderSuccessNoContractor()
[1.ë™¢®‚Æ¢†≠≠Î• Ø´†‚•¶® ÅÖá ™Æ≠‚‡†£•≠‚†];
[⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
[≥                                   è†‡†¨•‚‡Î Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†                                                    ≥           è†‡†¨•‚‡Î ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†                                                                                                                                     ≥  ë™¢®‚Æ¢†≠≠†Ô  ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥                ≥];
[≥  ID Ø´†‚.  ≥       ¸ ·§•´™®       ≥             äÆ≠‚‡†£•≠‚           ≥     Ñ†‚†     ≥       ë„¨¨†       ≥ Ç†´Ó‚† ≥  ID Ø´†‚.  ≥     Ñ†‚†     ≥     ë„¨¨†     ≥ Ç†´Ó‚† ≥                                                        é·≠Æ¢†≠®•                                                        ≥     ·„¨¨†      ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;

//Simanov
MACRO KvitPrintMainNoContractor(obj)
[≥ ########## ≥ #################### ≥ ################################ ≥ ############ ≥ ################# ≥ ###### ≥ ########## ≥ ############ ≥ ############# ≥ ###### ≥ ####################################################################################################################### ≥ ############## ≥]
(   obj.PlanID:l,
    obj.DealCode:l:w,
    obj.Payer:l:w,
    obj.PlanDate:c:f,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.FactID:c:f,
    obj.FactDate:c,
    obj.FactAmount:r,
    obj.FactCurrency:c,
    obj.FactGround:l,
    obj.Amount:r);
END;

MACRO KvitPrintDelimNoContractor()                            
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;                                            
                                                
MACRO KvitPrintEndNoContractor()                     
[¿ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
END;

MACRO KvitPrintHeaderSuccess()
[2.ë™¢®‚Æ¢†≠≠Î• Ø´†‚•¶®];
[⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
[≥                         è†‡†¨•‚‡Î Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†                           ≥           è†‡†¨•‚‡Î ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†           ≥  ë™¢®‚Æ¢†≠≠†Ô  ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¥                ≥];
[≥  ID Ø´†‚.  ≥       ¸ ·§•´™®       ≥     Ñ†‚†     ≥       ë„¨¨†       ≥ Ç†´Ó‚† ≥  ID Ø´†‚.  ≥     Ñ†‚†     ≥     ë„¨¨†     ≥ Ç†´Ó‚† ≥     ·„¨¨†      ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;

MACRO KvitPrintMainSuccess(obj)
[≥ ########## ≥ #################### ≥ ############ ≥ ################# ≥ ###### ≥ ########## ≥ ############ ≥ ############# ≥ ###### ≥ ############## ≥]
(   obj.PlanID:l,
    obj.DealCode:l:w,
    obj.PlanDate:c:f,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.FactID:c:f,
    obj.FactDate:c,
    obj.FactAmount:r,
    obj.FactCurrency:c,
    obj.Amount:r);
END;

MACRO KvitPrintDelimSuccess()                            
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;                                            
                                                
MACRO KvitPrintEndSuccess()                     
[¿ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
END;

MACRO KvitPrintHeaderFail()
[3.ç•·™¢®‚Æ¢†≠≠Î• Ø´†‚•¶®];
[⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
[≥                         è†‡†¨•‚‡Î  Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†                          ≥                             è‡®¨•Á†≠®•                              ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¥                                                                     ≥];
[≥  ID Ø´†‚.  ≥       ¸ ·§•´™®       ≥     Ñ†‚†     ≥       ë„¨¨†       ≥ Ç†´Ó‚† ≥                                                                     ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;

MACRO KvitPrintMainFail(obj)
[≥ ########## ≥ #################### ≥ ############ ≥ ################# ≥ ###### ≥ ################################################################### ≥]
(   obj.PlanID:l,
    obj.DealCode:l:w,
    obj.PlanDate:c:f,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.Notice:l);                                                                                                                       
END;                                                               

MACRO KvitPrintDelimFail()
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;                                                         
                                                
MACRO KvitPrintEndFail()                        
[¿ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
END;                                                               

MACRO NoKvitPairPrintHeader()
[4.ç•·™¢®‚Æ¢†≠≠Î• Ø†‡Î Ø´†‚•¶•©];
[⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø];
[≥                         è†‡†¨•‚‡Î Ø´†≠Æ¢Æ£Æ Ø´†‚•¶†                           ≥           è†‡†¨•‚‡Î ‰†™‚®Á•·™Æ£Æ Ø´†‚•¶†           ≥   è‡®¨•Á†≠®•   ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¥                ≥];
[≥  ID Ø´†‚.  ≥       ¸ ·§•´™®       ≥     Ñ†‚†     ≥       ë„¨¨†       ≥ Ç†´Ó‚† ≥  ID Ø´†‚.  ≥     Ñ†‚†     ≥     ë„¨¨†     ≥ Ç†´Ó‚† ≥                ≥];
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;

MACRO NoKvitPairPrintMain(obj)
[≥ ########## ≥ #################### ≥ ############ ≥ ################# ≥ ###### ≥ ########## ≥ ############ ≥ ############# ≥ ###### ≥ ############## ≥]
(   obj.PlanID:l,
    obj.DealCode:l:w,
    obj.PlanDate:c:f,
    obj.PlanAmount:r,
    obj.PlanCurrency:c,
    obj.FactID:c:f,
    obj.FactDate:c,
    obj.FactAmount:r,
    obj.FactCurrency:c,
    obj.Notice:l:w);
END;

MACRO NoKvitPairPrintDelim()                            
[√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥];
END;                                            
                                                
MACRO NoKvitPairPrintEnd()                     
[¿ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ];
END;

MACRO GetKvitBackOfficeName()
  var cmd = DL_RSDCommand("SELECT * FROM dtypeac_dbt WHERE t_inumtype = 32 AND t_type_account = ?");
  cmd.AddParam(StrFor(GetIdentProgram())); 
  var dataSet = cmd.Execute();

  if(dataSet.MoveNext())
    return dataSet.name_type;
  end;

  return "";
end;

macro KvitFillData(tableName:string, docKindArr:TArray)
  var KvitSuccessArray = TArray();
  var KvitFailArray = TArray();
  var NoKvitPairArray = TArray();
  var KvitNoContracorArray = TArray(); //Simanov
  var cmd, rs, i, rlMsg;
  var SqlQuery = "SELECT k.t_planpaymid          AS PlanID,            "
               + "       case when k.t_dockind in (199,4813,4815) then nvl((select ndeal.t_code from ddvndeal_dbt ndeal where ndeal.t_ID = k.t_dealid),' ') "
               + "            when k.t_dockind = 140 then nvl((select nett.t_dealnumber from ddl_nett_dbt nett where nett.t_NettingId = k.t_dealid),' ') "
               + "            when k.t_dockind = 4627 then nvl((SELECT CSA.T_CODE FROM DDVCSAPM_DBT csapm, DDVCSA_DBT csa, DOPROPER_DBT opr  WHERE "
               + " csapm.T_CSAID = csa.T_CSAID AND csapm.T_DIRECTION = 0 AND opr.t_DocumentID = csa.t_CSAID AND opr.t_dockind = 4626 AND opr.t_kind_operation = 2795 AND csapm.t_PMID = k.t_dealid),' ') "
               + "            when k.t_dockind in ("+join(makeArray(DL_VSBARTERORDER,DL_VEKSELORDER,DL_VSINTERCHANGE,DL_VSSALE),",")+") "
               + "            then nvl((select ord.T_ORDERNUMBER from DDL_ORDER_DBT ord where ord.T_CONTRACTID = k.t_dealid and ord.T_DOCKIND = k.T_DOCKIND),' ') "
               + "            else nvl((select tick.t_dealcode from ddl_tick_dbt tick where tick.t_DealId = k.t_dealid and tick.t_BOfficeKind = k.t_dockind),' ') "
               + "            end                AS DealCode,                               "
               + "       (select t_shortname from dparty_dbt where t_partyid = p_p.t_payer) AS PayerName, " //Simanov
               + "       (select t_ground from dpmrmprop_dbt where t_paymentid = p_f.t_paymentid) AS FactGround, " //Simanov
               + "       p_p.t_valuedate         AS PlanDate,                               "
               + "       p_p.T_AMOUNT            AS PlanAmount,                             "
               + "       NVL(fi_p.t_ccy, ' ')    AS PlanCurrency,                           "
               + "       k.t_factpaymid          AS FactID,                                 "
               + "       p_f.t_valuedate         AS FactDate,                               "
               + "       p_f.T_AMOUNT            AS FactAmount,                             "
               + "       NVL(fi_f.t_ccy, ' ')    AS FactCurrency,                           "
               + "       k.t_kvitamount          AS Amount,                                 "
               + "       k.t_auto                AS Auto,                                   "
               + "       k.t_stat                AS Stat,                                   "
               + "       DECODE(msg.t_contents,chr(1),'',NVL(msg.t_contents,'')) AS Notice, "
               + "       k.t_msg                 AS RealMsg                                 "
               + "  FROM "+tableName+" k,                                                   "
               + "       dpmpaym_dbt p_p,                                                   "
               + "       dpmpaym_dbt p_f,                                                   "
               + "       dfininstr_dbt fi_p,                                                "
               + "       dfininstr_dbt fi_f,                                                "
               + "       dbank_msg msg                                                      "
               + " WHERE k.t_planpaymid = p_p.t_paymentid                                   "
               + "   AND p_f.t_paymentid(+) = k.t_factpaymid                                "
               + "   AND fi_p.t_fiid(+) = p_p.t_fiid                                        "
               + "   AND fi_f.t_fiid(+) = p_f.t_fiid                                        "
               + "   AND msg.t_number(+)    = k.t_stat                                      ";
  if (docKindArr.size > 0)
    SqlQuery = SqlQuery + "   AND k.t_dockind in (" + join(docKindArr,",") + ") ";
  end;

  cmd = DL_RSDCommand(SqlQuery);

  rs = cmd.Execute();

  while(rs.MoveNext())
     if( (rs.Auto != SET_CHAR) OR ( (valtype(rs.Stat) != V_UNDEF) and (rs.Stat > 0)) ) //Simanov. ÅÎ´† ÆË®°™†  (UNDEFINED > INTEGER)
        if( (valtype(rs.Stat) != V_UNDEF) and (rs.Stat > 0) )
           i = NoKvitPairArray.size;
           
           NoKvitPairArray[i] = NoKvitPair();
           
           NoKvitPairArray[i].PlanID       = rs.PlanID;
           NoKvitPairArray[i].DealCode     = rs.DealCode;
           NoKvitPairArray[i].PlanDate     = rs.PlanDate;
           NoKvitPairArray[i].PlanAmount   = rs.PlanAmount;
           NoKvitPairArray[i].PlanCurrency = rs.PlanCurrency;
           NoKvitPairArray[i].FactID       = rs.FactID;
           NoKvitPairArray[i].FactDate     = rs.FactDate;
           NoKvitPairArray[i].FactAmount   = rs.FactAmount;
           NoKvitPairArray[i].FactCurrency = rs.FactCurrency;
           NoKvitPairArray[i].Notice       = rs.Notice;
        else
           i = KvitFailArray.size;
           
           if (rs.RealMsg)
             rlMsg = trim(string(rs.RealMsg));
           else
             rlMsg = "ç• ≠†©§•≠ ‰†™‚®Á•·™®© Ø´†‚•¶ §´Ô †¢‚Æ™¢®‚Æ¢™®"; //Simanov
           end;
           
           KvitFailArray[i] = KvitFail();
           
           KvitFailArray[i].PlanID       = rs.PlanID;
           KvitFailArray[i].DealCode     = rs.DealCode;
           KvitFailArray[i].PlanDate     = rs.PlanDate;
           KvitFailArray[i].PlanAmount   = rs.PlanAmount;
           KvitFailArray[i].PlanCurrency = rs.PlanCurrency;
           if (StrLen(rlMsg) > 0)
             KvitFailArray[i].Notice     = rlMsg;
           else
             KvitFailArray[i].Notice     = rs.Notice;
           end;
        end;
     else
        i = KvitSuccessArray.size;
       
        KvitSuccessArray[i] = KvitSuccess();
       
        KvitSuccessArray[i].PlanID       = rs.PlanID;
        KvitSuccessArray[i].DealCode     = rs.DealCode;
        KvitSuccessArray[i].PlanDate     = rs.PlanDate;
        KvitSuccessArray[i].PlanAmount   = rs.PlanAmount;
        KvitSuccessArray[i].PlanCurrency = rs.PlanCurrency;
        KvitSuccessArray[i].FactID       = rs.FactID;
        KvitSuccessArray[i].FactDate     = rs.FactDate;
        KvitSuccessArray[i].FactAmount   = rs.FactAmount;
        KvitSuccessArray[i].FactCurrency = rs.FactCurrency;
        KvitSuccessArray[i].Amount       = rs.Amount;

        //Simanov
        if (rs.RealMsg == "no_contractor")
          KvitSuccessArray[i].Payer        = rs.PayerName;
          KvitSuccessArray[i].FactGround   = rs.FactGround;
          KvitNoContracorArray[KvitNoContracorArray.size] = KvitSuccessArray[i];
        end;
     end;
  end;

  return KvitResData(KvitSuccessArray,KvitFailArray,NoKvitPairArray,KvitNoContracorArray);
end;

//è‡Æ¢•‡™† ß†ØÆ´≠•≠≠Æ·‚® ¢ÂÆ§ÔÈ•© ·Â•¨Î ‡†·ÁÒ‚Æ¢
macro CheckInCoreSchemeSubReq(PaymentIdField)
 return "  "
       +" (SELECT DECODE (COUNT (*),1, MAX (inPaymProp.t_CORSCHEM),-1)  "
       +"    FROM dpmprop_dbt inPaymProp  "
       +"   WHERE inPaymProp.t_paymentid =   " + PaymentIdField
       +"         AND  (       inPaymProp.t_GROUP = 1  "
       +"             AND EXISTS  "
       +"                    (SELECT 1  "
       +"                       FROM dpmprop_dbt propOne  "
       +"                      WHERE     propOne.t_paymentid =  "
       +"                                   inPaymProp.t_paymentid " 
       +"                            AND propOne.t_GROUP = 1  "
       +"                            AND propOne.t_IsSender = 'X'  "
       +"                            AND NOT (EXISTS  "
       +"                                        (SELECT 1  "
       +"                                           FROM dpmprop_dbt propTwo  "
       +"                                          WHERE     propTwo.t_paymentid =  "
       +"                                                       inPaymProp.t_paymentid  "
       +"                                                AND propTwo.t_DEBETCREDIT <>  "
       +"                                                       propOne.t_DEBETCREDIT  "
       +"                                                AND propTwo.t_GROUP =  "
       +"                                                       1)))  "
       +"          OR     inPaymProp.t_IsSender = 'X'  "
       +"             AND EXISTS  "
       +"                    (SELECT 1  "
       +"                       FROM dpmprop_dbt propOneTwo  "
       +"                      WHERE     propOneTwo.t_paymentid =  "
       +"                                   inPaymProp.t_paymentid  "
       +"                            AND propOneTwo.t_GROUP = 1  "
       +"                            AND EXISTS  "
       +"                                   (SELECT 1  "
       +"                                      FROM dpmprop_dbt propTwoTwo  "
       +"                                     WHERE     propTwoTwo.t_paymentid =  "
       +"                                                  inPaymProp.t_paymentid  "
       +"                                           AND propTwoTwo.t_DEBETCREDIT <>  "
       +"                                                  propOneTwo.t_DEBETCREDIT  "
       +"                                           AND propTwoTwo.t_GROUP =  "
       +"                                                  1))))  "
       +" <> -1";
end;