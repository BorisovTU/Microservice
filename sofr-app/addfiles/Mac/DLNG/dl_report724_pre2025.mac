/*
$Name:        dl_report724.mac
$Module:      Ценные бумаги
$Description: Отчет "Сведения об осуществлении брокерской,
              депозитарной деятельности и деятельности по управлению ценными бумагами" (ф. 724)
*/
import "DLReport_h.mac", "dl_report724_form.mac", "bnk_dttmfrmt.mac", "scsrvrepfun.mac", "it_utils.mac";

PRIVATE VAR Form724;
PRIVATE VAR Report724;

PRIVATE CONST PARALLEL_LEVEL = 12;
PRIVATE CONST PARTITION_COUNT = 10;
PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST USEBIGREPORTMODE = TRUE;

PRIVATE VAR INFO_NAME = TArray;
INFO_NAME[0] = "Razdel_2_IndKody_2024";
INFO_NAME[1] = "Razdel_6_7_StoimostCB_2024";
INFO_NAME[2] = "Razdel_4_StoimostDS_2024";
INFO_NAME[3] = "Razdel_8_StoimostPFI_2024";
INFO_NAME[4] = "Razdel_2_DvizhenieDS_2024";
INFO_NAME[5] = "Razdel_2_DvizhenieCB_2024";
INFO_NAME[6] = "Razdel_9_TO_2024";
INFO_NAME[7] = "Razdel_2_3_Dogovory_2024";
INFO_NAME[8] = "Razdel_11_StoimostMetall_2024";
INFO_NAME[9] = "Klienty_Razdel 3_2024";

PRIVATE CONST CHAPTER_ALL = 0,
              CHAPTER_1_3 = 1,
              CHAPTER_4   = 2,
              CHAPTER_6   = 3,
              CHAPTER_7   = 4,
              CHAPTER_8   = 5,
              CHAPTER_9   = 6, 
              CHAPTER_11  = 7; 

PRIVATE CONST DETAIL_CLIENT_INFO = 1,
              DETAIL_COST_AVR    = 2,
              DETAIL_COST_CASH   = 3,
              DETAIL_COST_PFI    = 4,
              DETAIL_MOVE_CASH   = 5,
              DETAIL_MOVE_AVR    = 6,
              DETAIL_RQ          = 7,
              DETAIL_OC_CONTR    = 8,
              DETAIL_COST_METALL = 9,
              DETAIL_CLIENTS     = 10;
PRIVATE CONST
   RCB_XML_PK_MONTHLY   = 4,
   RCB_XML_PK_QUARTERLY = 5;
   
PRIVATE MACRO GetSessionID():Integer
  var id:Integer = -1;
  var sql = "SELECT SYS_CONTEXT('USERENV','SESSIONID') SessionID FROM DUAL";
  var cmd = DL_RSDCommand(sql);
  var ds = cmd.execute();
  if( ds.MoveNext() )
     id = int(ds.SessionID);
  end;
  return id;
END;

CLASS F724DeltaXML(OKUD:String, ReportKind:String, EndDate:Date, Periodicity:Integer)
  var jvm;
  var m_XmlReport;
  var m_OKUD = OKUD;
  var m_EndDate = EndDate;
  var m_FileName = "";
  var m_Protocol;
  var m_DepCode;
  
  private macro CreateSignersNode(NodeName:String, Post:String, FIO:String, Phone:String, Fax:String, Email:String)
    var attributes = jvm.createJavaObject("java.util.ArrayList");

    var PostAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Должность", Post);
    attributes.add(PostAttr);
    var FIOAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ФИО", FIO);
    attributes.add(FIOAttr);

    if(NodeName == "Исполнитель")
      var PhoneAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Телефон", Phone);
      attributes.add(PhoneAttr);
      var FaxAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Факс", Fax);
      attributes.add(FaxAttr);
      var EmailAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЭлПочта", Email);
      attributes.add(EmailAttr);
    end;

    m_XmlReport.addLine(NodeName, attributes, "");
  end;
  
  macro PrintInfo()
    var registrationNumber = ПолучитьКодСубъекта({OurBank}, PTCK_BANKREGNUM);
    var BIC = ПолучитьКодСубъекта({OurBank}, PTCK_BIC);
    var party = TRecHandler("party.dbt");
    var OKATO;
    var OKPO;
    var OGRN = ПолучитьКодСубъекта({OurBank}, PTCK_OGRN);
    var Name;
    var PostalAdress;
    var adress = TRecHandler("adress.dbt");
    var leaderPost:String = "", leaderName:String = "";
    var executorPost:String = "", executorName:String = "", executorPhone:String = "", executorFax:String = "", executorEmail:String = "";
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    ПолучитьСубъекта({OurBank}, party);
    OKPO = IIF(party.rec.OKPO != NULL, party.rec.OKPO, "");
    Name = party.rec.ShortName;

    GetMainObjAttr(NULL,
                   OBJTYPE_PARTY,
                   UniID(party, OBJTYPE_PARTY),
                   RCB_OBJGROUP_PT_OKATO, // 12
                   NULL,
                   NULL,
                   OKATO,
                   m_EndDate
                  );

    if(OKATO == NULL)
       var OkatoQuery = "select adress.t_OKATO " +
                        "from dadress_dbt adress " +
                        "where adress.t_Type = 1 " +
                        "  and adress.t_PartyID = " + string({OurBank});
 
       var OkatoSelect = DL_RSDCommand(OkatoQuery);
       var OkatoDS = OkatoSelect.Execute();
       if(OkatoDS.MoveNext())
          OKATO = OkatoDS.OKATO;
       end;
    end;

    OKATO = IIF(OKATO != NULL, OKATO, "00");

    if(найтиЮридическийАдресСубъекта({OurBank}, adress) or
       найтиПочтовыйАдресСубъекта({OurBank}, adress) or
       найтиАдресСубъекта({OurBank}, PTADDR_REAL, adress)
      )
       PostalAdress = adress.rec.Adress;
    end;

    var leaderQuery = "select off.t_Post, " +
                      "       party.t_Name " +
                      "from dofficer_dbt off, dparty_dbt party " +
                      "where off.t_IsFirstPerson = 'X' " +
                      "  and off.t_PartyID = " + string({OurBank}) +
                      "  and party.t_PartyID = off.t_PersonID ";

    var leaderSelect = DL_RSDCommand(leaderQuery);
    var leaderDS = leaderSelect.Execute();

    if(leaderDS.MoveNext())
       leaderPost = leaderDS.Post;
       leaderName = leaderDS.Name;
    else
       leaderPost = leaderName = "";
    end;


    var executorQuery = "select off.t_Post, " +
                        "       persn.t_Name1 || ' ' || persn.t_Name2 || ' ' || persn.t_Name3 as t_Name, " +
                        "       off.t_PhoneNumber as t_Phone,                                            " +
                        "       nvl( " +
                        "             ( " +
                        "                select q_Fax.t_Value " +
                        "                from ( " +
                        "                        select Fax.t_Value " +
                        "                        from dcontact_dbt Fax " +
                        "                        where Fax.t_PartyID = person.t_PartyID " +
                        "                          and Fax.t_ContactKind = 3 " +
                        "                        order by Fax.t_IsMain DESC " +
                        "                     ) q_Fax " +
                        "                where ROWNUM = 1 " +
                        "             ), chr(1) " +
                        "          ) as t_Fax, " +
                        "       nvl( " +
                        "             ( " +
                        "                select q_Email.t_Value " +
                        "                from ( " +
                        "                        select Email.t_Value " +
                        "                        from dcontact_dbt Email " +
                        "                        where Email.t_PartyID = person.t_PartyID " +
                        "                          and Email.t_ContactKind = 5 " +
                        "                          and Email.t_ContactType = 8 " +
                        "                        order by Email.t_IsMain DESC " +
                        "                     ) q_Email " +
                        "                where ROWNUM = 1 " +
                        "             ), chr(1) " +
                        "          ) as t_Email " +
                        "from dofficer_dbt off, dpersOn_dbt persOn, dpersn_dbt persn " +
                        "where persOn.t_Oper = " + string({Oper}) +
                        "  and off.t_PartyID = " + string({OurBank}) +
                        "  and off.t_PersonID = persOn.t_PartyID " +
                        "  and persn.t_PersonID = persOn.t_PartyID ";

    var executorCmd = DL_RSDCommand(executorQuery);
    var executorDS = executorCmd.Execute();
    if(executorDS.MoveNext())
      executorPost = executorDS.Post;
      executorName = executorDS.Name;
      executorPhone = executorDS.Phone;
      executorFax = executorDS.Fax;
      executorEmail = executorDS.Email;
    end;
    var day, month, year, valdate;
    dateSplit(date({CurDate}), day, month, year);
    valdate = string(year:4:o) + "-" + string(month:2:o) + "-" + string(day:2:o);


    var KindOrgAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ВидОрг", "КО");
    attributes.add(KindOrgAttr);
    var RegNumAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодОрг", registrationNumber);
    attributes.add(RegNumAttr);
    //var DepCodeAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодТУ", m_DepCode);
    //attributes.add(DepCodeAttr);
    var BICAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "БИК", BIC);
    attributes.add(BICAttr);
    var OKATOAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКАТО", OKATO);
    attributes.add(OKATOAttr);
    var OKPOAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКПО", OKPO);
    attributes.add(OKPOAttr);
    var OGRNAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОГРН", OGRN);
    attributes.add(OGRNAttr);
    var ShNameAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СокрНаимен", Name);
    attributes.add(ShNameAttr);
    var AdressAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Адрес", PostalAdress);
    attributes.add(AdressAttr);
    var SignDateAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаПодписания", valdate);
    attributes.add(SignDateAttr);

    m_XmlReport.beginPart("Составитель", attributes);
      CreateSignersNode("Руководитель", leaderPost, leaderName, "", "", "");
      CreateSignersNode("Исполнитель", executorPost, executorName, executorPhone, executorFax, executorEmail);
    m_XmlReport.finishPart();

    m_Protocol = m_XmlReport.getProtocol();
  end; 

  macro BeginData724(HasData:BOOL)
    var IdAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Ид", "1");

    var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    Attributes.add(IdAttribute);

    m_XmlReport.beginPart("Данные724", Attributes); //<Данные724 Ид = "">
  end;
  
  private macro Delta_Fld( Val:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL ) 
      VAR vt = ValType(Val);
      if( vt == V_DATE )
        if( Val == DATE(0,0,0) )
          ValStr = "0";
        else
          ValStr = YYYY_MM_DD(Val:f);
        end;
      elif( vt == V_STRING )
        ValStr = StrSubst( Val, "\"", "''" );
        //ValStr = StrSubst( ValStr, "-", "0" );
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        ValStr = trim(string(Val:18:0));
      else
        ValStr = string(Val);
      end;
    else
      ValStr="";
    end;

    return ValStr;
  end;
  
  macro BeginSubPart11()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Подраздел1.1", attributes); //<Подраздел1.1>
  end;
  
  macro PrintLineSubPart11(ClientGroup, ActKind, Type, Qual, Status, OKSM, OKATO)

    var SubPart11LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A111Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    SubPart11LineAttributes.add(A111Attribute);
  
    var A112Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ВидДеят", Delta_Fld(ActKind));
    SubPart11LineAttributes.add(A112Attribute);
  
    var A113Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипКлиент", Delta_Fld(Type));
    SubPart11LineAttributes.add(A113Attribute);
  
    var A114Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КвалИнвестор", Delta_Fld(Qual));
    SubPart11LineAttributes.add(A114Attribute);
  
    var A115Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтатусКл", Delta_Fld(Status));
    SubPart11LineAttributes.add(A115Attribute);
  
    var A116Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодСтр", Delta_Fld(OKSM));
    SubPart11LineAttributes.add(A116Attribute);
  
    // if (OKATO != "")
    var A117Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКАТО", Delta_Fld(OKATO));
    SubPart11LineAttributes.add(A117Attribute);
    // end;


    m_XmlReport.addLine("ГруппаКлиент", SubPart11LineAttributes, "");
  end;
  
  macro EndSubPart11()
    m_XmlReport.finishPart(); //</Подраздел1.1>
  end;
  
  macro BeginSubPart12()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Подраздел1.2", attributes); //<Подраздел1.2>
  end;
  
  macro PrintLineSubPart12(ContrGroup, IIS, UseCurr, Contractor)

    var SubPart12LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A121Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    SubPart12LineAttributes.add(A121Attribute);
	
	var A122Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризИИС", Delta_Fld(IIS));
    SubPart12LineAttributes.add(A122Attribute);
	
	var A123Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризИспДенСр", Delta_Fld(UseCurr));
    SubPart12LineAttributes.add(A123Attribute);
	
	var A124Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КонтрагентДог", Delta_Fld(Contractor));
    SubPart12LineAttributes.add(A124Attribute);

    m_XmlReport.addLine("ГруппаДоговор", SubPart12LineAttributes, "");
  end;
  
  macro EndSubPart12()
    m_XmlReport.finishPart(); //</Подраздел1.2>
  end;
  
  macro BeginPart2()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел2", attributes); //<Раздел2>
  end;
  
  macro PrintLinePart2(ClientGroup, ContrGroup, StrategyId, CurrIn, AvrIn, OthersIn, CurrOut, AvrOut, OthersOut, ContrCount, ContrBeginCount, ContrEndCount)

    var Part2LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A21Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part2LineAttributes.add(A21Attribute);
	
	var A22Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part2LineAttributes.add(A22Attribute);
	
	//var A23Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part2LineAttributes.add(A23Attribute);
	
	var A24Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоступДС", Delta_Fld(CurrIn));
    Part2LineAttributes.add(A24Attribute);
	
	var A25Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоступЦБ", Delta_Fld(AvrIn));
    Part2LineAttributes.add(A25Attribute);
	
	var A26Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоступИныхАкт", Delta_Fld(OthersIn));
    Part2LineAttributes.add(A26Attribute);
	
	var A27Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИзъятДС", Delta_Fld(CurrOut));
    Part2LineAttributes.add(A27Attribute);
	
	var A28Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИзъятЦБ", Delta_Fld(AvrOut));
    Part2LineAttributes.add(A28Attribute);
	
	var A29Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИзъятИныхАкт", Delta_Fld(OthersOut));
    Part2LineAttributes.add(A29Attribute);
	
	var A210Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолДогКонецПер", Delta_Fld(ContrCount));
    Part2LineAttributes.add(A210Attribute);
	
	var A211Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолДогЗаклОтчПер", Delta_Fld(ContrBeginCount));
    Part2LineAttributes.add(A211Attribute);
	
	var A212Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолДогПрекрОтчПер", Delta_Fld(ContrEndCount));
    Part2LineAttributes.add(A212Attribute);

    m_XmlReport.addLine("СведПостИзъят", Part2LineAttributes, "");
  end;
  
  macro EndPart2()
    m_XmlReport.finishPart(); //</Раздел2>
  end;
  
  macro BeginPart3()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел3", attributes); //<Раздел3>
  end;
  
  macro PrintLinePart3(ClientGroup, AccountSize, PortfolioVolume, PortfolioVolumeIIS, ClientCount, ClientIISCount, ClientContrBeginCount, ClientContrEndCount)

    var Part3LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A31Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part3LineAttributes.add(A31Attribute);
	
	var A32Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РазмерСч", Delta_Fld(AccountSize));
    Part3LineAttributes.add(A32Attribute);
	
	var A33Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СовОбПортфГр", Delta_Fld(PortfolioVolume));
    Part3LineAttributes.add(A33Attribute);
	
	var A34Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СовОбПортфИСС", Delta_Fld(PortfolioVolumeIIS));
    Part3LineAttributes.add(A34Attribute);
	
	var A35Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиентГр", Delta_Fld(ClientCount));
    Part3LineAttributes.add(A35Attribute);
	
	var A36Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиентИИС", Delta_Fld(ClientIISCount));
    Part3LineAttributes.add(A36Attribute);
	
	var A37Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлЗаключДог", Delta_Fld(ClientContrBeginCount));
    Part3LineAttributes.add(A37Attribute);
	
	var A38Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлРасторгДог", Delta_Fld(ClientContrEndCount));
    Part3LineAttributes.add(A38Attribute);

    m_XmlReport.addLine("СведКонц", Part3LineAttributes, "");
  end;
  
  macro EndPart3()
    m_XmlReport.finishPart(); //</Раздел3>
  end;
  
  macro BeginPart4()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел4", attributes); //<Раздел4>
  end;
  
  macro PrintLinePart4(ClientGroup, ContrGroup, StrategyId, CostCur, CodeCur, CostRur, NameBroker, INNBroker, TINBroker)

    var Part4LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A41Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part4LineAttributes.add(A41Attribute);
	
	var A42Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part4LineAttributes.add(A42Attribute);
	
	//var A43Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part4LineAttributes.add(A43Attribute);
	
	var A44Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценЕдВал", Delta_Fld(CostCur));
    Part4LineAttributes.add(A44Attribute);
	
	var A45Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодВал", Delta_Fld(CodeCur));
    Part4LineAttributes.add(A45Attribute);
	
	var A46Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценРуб", Delta_Fld(CostRur));
    Part4LineAttributes.add(A46Attribute);
	
	if (Delta_Fld(NameBroker) != "")
	  var A47Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимБрокер", Delta_Fld(NameBroker));
      Part4LineAttributes.add(A47Attribute);
	end;
	
	if (Delta_Fld(INNBroker) != "")
	  var A48Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИННброкер", Delta_Fld(INNBroker));
      Part4LineAttributes.add(A48Attribute);
	end;
	
	if (Delta_Fld(TINBroker) != "")
	  var A49Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "TINброкер", Delta_Fld(TINBroker));
      Part4LineAttributes.add(A49Attribute);
	end;

    m_XmlReport.addLine("ПортфДС", Part4LineAttributes, "");
  end;
  
  macro EndPart4()
    m_XmlReport.finishPart(); //</Раздел4>
  end;
  
  macro BeginPart6()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел6", attributes); //<Раздел6>
  end;
  
  macro PrintLinePart6(ClientGroup, ContrGroup, StrategyId, Issuer, LSIN, ISIN, Amount, CostRub)

    var Part6LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A61Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part6LineAttributes.add(A61Attribute);
	
	var A62Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part6LineAttributes.add(A62Attribute);
	
	//var A63Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part6LineAttributes.add(A63Attribute);
	
	var A64Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимЭм", Delta_Fld(Issuer));
    Part6LineAttributes.add(A64Attribute);
	
	if (Delta_Fld(LSIN) != "")
	  var A65Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РегНомВыпускЦБ", Delta_Fld(LSIN));
      Part6LineAttributes.add(A65Attribute);
	end;
	
	if (Delta_Fld(ISIN) != "")
	  var A66Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ISIN", Delta_Fld(ISIN));
      Part6LineAttributes.add(A66Attribute);
	end;
	
	var A67Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолЦБ", Delta_Fld(Amount));
    Part6LineAttributes.add(A67Attribute);
	
	var A68Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценРуб", Delta_Fld(CostRub));
    Part6LineAttributes.add(A68Attribute);

    m_XmlReport.addLine("ПортфЦБ", Part6LineAttributes, "");
  end;
  
  macro EndPart6()
    m_XmlReport.finishPart(); //</Раздел6>
  end;

  macro BeginPart7()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел7", attributes); //<Раздел6>
  end;
  
  macro PrintLinePart7(ClientGroup, ContrGroup, StrategyId, Name, CostRub)

    var Part7LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A71Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part7LineAttributes.add(A71Attribute);
	
    var A72Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part7LineAttributes.add(A72Attribute);
	
    //var A73Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part7LineAttributes.add(A73Attribute);
	
    var A74Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимИнИмущ", Delta_Fld(Name));
    Part7LineAttributes.add(A74Attribute);
	
    var A75Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценРуб", Delta_Fld(CostRub));
    Part7LineAttributes.add(A75Attribute);

    m_XmlReport.addLine("ПортфИнИмущ", Part7LineAttributes, "");
  end;
  
  macro EndPart7()
    m_XmlReport.finishPart(); //</Раздел6>
  end;

  
  macro BeginPart8()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел8", attributes); //<Раздел8>
  end;
  
  macro PrintLinePart8(ClientGroup, ContrGroup, StrategyId, ExtCode, ExtName, PfiName, Amount, Dir, CostPFI, Guaranty, CostPFI_FO)

    var Part8LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A81Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part8LineAttributes.add(A81Attribute);
	
	var A82Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part8LineAttributes.add(A82Attribute);
	
	//var A83Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part8LineAttributes.add(A83Attribute);
    if (Delta_Fld(ExtCode) != "")	
      var A84Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодОргТорг", Delta_Fld(ExtCode));
      Part8LineAttributes.add(A84Attribute);
    end;

    if (Delta_Fld(ExtName) != "")	
      var A85Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимОргТорг", Delta_Fld(ExtName));
      Part8LineAttributes.add(A85Attribute);
    end;
	
	var A86Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимПФИ", Delta_Fld(PfiName));
    Part8LineAttributes.add(A86Attribute);
	
	var A87Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолПФИ", Delta_Fld(Amount));
    Part8LineAttributes.add(A87Attribute);
	
	var A88Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НапрСделки", Delta_Fld(Dir));
    Part8LineAttributes.add(A88Attribute);
	
	var A89Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимПФИ", Delta_Fld(CostPFI));
    Part8LineAttributes.add(A89Attribute);
	
	var A810Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РазмерГарОбесп", Delta_Fld(Guaranty));
    Part8LineAttributes.add(A810Attribute);
	
	var A811Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РазмерФактОбяз", Delta_Fld(CostPFI_FO));
    Part8LineAttributes.add(A811Attribute);

    m_XmlReport.addLine("ПортфПФИ", Part8LineAttributes, "");
  end;
  
  macro EndPart8()
    m_XmlReport.finishPart(); //</Раздел8>
  end;
  
  macro BeginPart9()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел9", attributes); //<Раздел9>
  end;
  
  macro PrintLinePart9(ClientGroup, ContrGroup, StrategyId, KindTO, SubKind, KindRepo, ShortName, LastName, FirstName, PatrName, INN, TIN, CostRub)

    var Part9LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A91Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part9LineAttributes.add(A91Attribute);
	
	var A92Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part9LineAttributes.add(A92Attribute);
	
	//var A93Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part9LineAttributes.add(A93Attribute);
	
	var A94Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризТреб", Delta_Fld(KindTO));
    Part9LineAttributes.add(A94Attribute);
	
	var A95Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипТреб", Delta_Fld(SubKind));
    Part9LineAttributes.add(A95Attribute);
	
	if (Delta_Fld(KindRepo) != "")
	  var A96Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипСделки", Delta_Fld(KindRepo));
      Part9LineAttributes.add(A96Attribute);
	end;
	
	var A97Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимКонтраг", Delta_Fld(ShortName));
    Part9LineAttributes.add(A97Attribute);
	
	if (Delta_Fld(LastName) != "")
	  var A98Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Фамилия", Delta_Fld(LastName));
      Part9LineAttributes.add(A98Attribute);
	end;
	
	if (Delta_Fld(FirstName) != "")
	  var A99Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Имя", Delta_Fld(FirstName));
      Part9LineAttributes.add(A99Attribute);
	end;
	
	if (Delta_Fld(PatrName) != "")
	  var A910Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Отчество", Delta_Fld(PatrName));
      Part9LineAttributes.add(A910Attribute);
	end;
	
	if (Delta_Fld(INN) != "")
	  var A911Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИННконтрагент", Delta_Fld(INN));
      Part9LineAttributes.add(A911Attribute);
	end;
	
	if (Delta_Fld(TIN) != "")
	  var A912Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "TINконтрагент", Delta_Fld(TIN));
      Part9LineAttributes.add(A912Attribute);
	end;
	
	var A913Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценРуб", Delta_Fld(CostRub));
    Part9LineAttributes.add(A913Attribute);

    m_XmlReport.addLine("ПортТребОбяз", Part9LineAttributes, "");
  end;
  
  macro EndPart9()
    m_XmlReport.finishPart(); //</Раздел9>
  end;
  
  macro BeginPart11()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел11", attributes); //<Раздел11>
  end;
  
  macro PrintLinePart11(ClientGroup, ContrGroup, StrategyId, MetCode, CostRub)

    var Part11LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A11_1Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрКлиент", Delta_Fld(ClientGroup));
    Part11LineAttributes.add(A11_1Attribute);
	
	var A11_2Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_ГрДоговор", Delta_Fld(ContrGroup));
    Part11LineAttributes.add(A11_2Attribute);
	
	//var A11_3Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИД_Стратегия", Delta_Fld(StrategyId));
    //Part11LineAttributes.add(A11_3Attribute);
	
	var A11_4Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодДрагМет", Delta_Fld(MetCode));
    Part11LineAttributes.add(A11_4Attribute);
	
	var A11_5Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценРуб", Delta_Fld(CostRub));
    Part11LineAttributes.add(A11_5Attribute);

    m_XmlReport.addLine("ПортфДрагМет", Part11LineAttributes, "");
  end;
  
  macro EndPart11()
    m_XmlReport.finishPart(); //</Раздел11>
  end;
  
  macro BeginPart12()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел12", attributes); //<Раздел12>
  end;
  
  macro PrintLinePart12(ActKind, Type, Qual, IIS, TypeStr, NameStr, CountClient, Cost, In, Out)

    var Part12LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A12_1Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ВидДеят", Delta_Fld(ActKind));
    Part12LineAttributes.add(A12_1Attribute);
	
	var A12_2Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипКлиент", Delta_Fld(Type));
    Part12LineAttributes.add(A12_2Attribute);
	
	var A12_3Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КвалИнвестор", Delta_Fld(Qual));
    Part12LineAttributes.add(A12_3Attribute);
	
	var A12_4Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризИИС", Delta_Fld(IIS));
    Part12LineAttributes.add(A12_4Attribute);
	
	var A12_5Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипСтратег", Delta_Fld(TypeStr));
    Part12LineAttributes.add(A12_5Attribute);
	
	var A12_6Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НазваниеСтратег", Delta_Fld(NameStr));
    Part12LineAttributes.add(A12_6Attribute);
	
	var A12_7Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиент", Delta_Fld(CountClient));
    Part12LineAttributes.add(A12_7Attribute);
	
	var A12_8Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтоимОценРуб", Delta_Fld(Cost));
    Part12LineAttributes.add(A12_8Attribute);
	
	var A12_9Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Поступления", Delta_Fld(In));
    Part12LineAttributes.add(A12_9Attribute);
	
	var A12_10Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Изъятия", Delta_Fld(Out));
    Part12LineAttributes.add(A12_10Attribute);

    m_XmlReport.addLine("КратСвед", Part12LineAttributes, "");
  end;
  
  macro EndPart12()
    m_XmlReport.finishPart(); //</Раздел12>
  end;
  
  macro EndData724()
    m_XmlReport.finishPart(); //</Данные724>
  end;
  
  macro NoData()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrCode = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодНепредоставления", "1");

    attributes.add(attrCode);
    m_XmlReport.addLine("НетДанных", attributes, "");
  end;
  
  macro PrintProtocol()
    m_Protocol = m_XmlReport.getProtocol();
    var attributesNotes = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrStatusNotes = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "0");
    attributesNotes.add(attrStatusNotes);
    var attributesErrors = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrStatusErrors = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "1");
    attributesErrors.add(attrStatusErrors);
    var attributesFails = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrStatusFails = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "2");
    attributesFails.add(attrStatusFails);

    var Notes = m_Protocol.getNotesText();
    var Errors = m_Protocol.getErrorsText();
    var Fails = m_Protocol.getFailsText();

    if((Notes != "") or (Errors != "") or (Fails != ""))
      m_XmlReport.beginPart("ПротоколКонтроля");
      if(Notes != "")
        m_XmlReport.addLine("Сообщение", attributesNotes, Notes);
      end;
      if(Errors != "")
        m_XmlReport.addLine("Сообщение", attributesErrors, Errors);
      end;
      if(Fails != "")
        m_XmlReport.addLine("Сообщение", attributesFails, Fails);
      end;
      m_XmlReport.finishPart();
    end;
  end;
  
  macro GetFileName():String
    return m_FileName;
  end;

  macro CreateXMLFile()
    return m_xmlReport.export(m_FileName);
  end;
  
  var DepCodeQuery = "select dp_dep.t_Name " +
                     "from ddp_dep_dbt dp_dep " +
                     "where dp_dep.t_Code = " + string({OperDprt});

  var DepCodeSelect = DL_RSDCommand(DepCodeQuery);
  var DepCodeDS = DepCodeSelect.Execute();
  if(DepCodeDS.MoveNext())
     m_DepCode = DepCodeDS.Name;
  else
     m_DepCode = "";
  end;

  private var dd;
  private var mm;
  DateSplit(m_EndDate, dd, mm, NULL);

  var len = strlen(m_DepCode);

  var DepCode = m_DepCode;
  if(len < 4)
     var i = len;
     while(i < 4)
        DepCode = "0" + DepCode;
        i = i + 1;
     end;
  elif(len > 4)
     DepCode = SubStr(DepCode, 1, 4);
  end;

  m_FileName = m_OKUD + "_" + string(dd:o:2) + string(mm:o:2) + DepCode + ".xml";

  jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
  m_XmlReport = jvm.createJavaObject("XMLReportExporter.XMLReport", "<init>", "1.0.4.5", m_OKUD, m_OKUD, ReportKind, String(m_EndDate : f), Periodicity);
  m_Protocol = m_XmlReport.getProtocol();
END;


PRIVATE CLASS (DL_CReportTemplate) DlReport724( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
  var m_BegDate, m_EndDate, m_IsSecur:integer, m_IsDV:integer, m_IsRep12:integer, m_Detail:integer, m_Chapter:integer;
  PRIVATE VAR m_InDelta = false;
  PRIVATE VAR m_DeltaReport;
  PRIVATE VAR m_CSVFileDir = IT_GetPatchTxtFile(false)+"\\";

  macro GetBegEndDateByPeriod():Date
     var NumQuartal, Month,
         Year = Form724.GetFieldValue(PNFLD_FORM724_YEAR),
         Period = Form724.GetFieldValue(PNFLD_FORM724_PERIOD);

     if(Period < 13)   /*Задан месяц*/
       m_BegDate = Date(1, Period, Year);
       m_EndDate = DateAfterCalenMonths(m_BegDate, 1) - 1;
     else                   /*Задан квартал*/
       NumQuartal = Period - 12;
       Month = (NumQuartal - 1) * 3 + 1;
       m_BegDate = Date(1, Month, Year);
       m_EndDate = DateAfterCalenMonths(m_BegDate, 3) - 1;
     end;
  end;

  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO GetPeriodicity():Integer
   var Period = Form724.GetFieldValue(PNFLD_FORM724_PERIOD);

   if(Period < 13)   /*Задан месяц*/
      return RCB_XML_PK_MONTHLY;
   else              /*Задан квартал*/
      return RCB_XML_PK_QUARTERLY;
   end;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
    GetBegEndDateByPeriod();
    m_IsSecur = iif(Form724.GetFieldValue(PNFLD_FORM724_ISSECUR) == SET_CHAR,1,0);
    m_IsDV    = iif(Form724.GetFieldValue(PNFLD_FORM724_ISDV) == SET_CHAR,1,0);
    m_InDelta = iif(Form724.GetFieldValue(PNFLD_FORM724_DELTA) == SET_CHAR,true,false);
    m_Detail  = iif(Form724.GetFieldValue(PNFLD_FORM724_DETAIL) == SET_CHAR,1,0);
    m_Chapter = Form724.GetFieldValue(PNFLD_FORM724_CHAPTER);
    if (m_Chapter != 0)
      m_InDelta = false;
    end;

    m_IsRep12 = 0;

    if(m_InDelta)
      m_DeltaReport = F724DeltaXML("0409724", "КО", m_EndDate, GetPeriodicity());
    end;

    SetActiveSheet( "Заголовок" );
    PrintFormatString( NULL,
                       "N0_H1",  "по состоянию на " + DDpMMpYYYY(m_EndDate + 1),
                       "N0_H2",  string(GetPartyFullNameByID({OurBank})),
                       "N0_H3",  string(GetPartyAddress({OurBank}, false, false, PTADDR_REAL))
                     );
    CopyAllSheetInTotalBook( "Заголовок", false, "N0_HEADER", 0, "Заголовок" );
  END;
  
  PRIVATE MACRO ImportCSV(XLSfile,SheetName,BogyLine )
    var csvFile = (m_CSVFileDir+"Rep724_"+BogyLine+".csv") ;
    var XLStable;
	
    BegAction(10, "Импорт "+csvFile+" в XLS ");    
 
    csvFile = IT_StoreClobBuferANSI(csvFile, "CSV", true, 30);
    XLSfile.SheetChange( SheetName );
    XLStable  = XLSfile.RegisterTable(BogyLine);
    XLSfile.SetValue_NameCell(BogyLine);
    XLStable.FillTabelFromCSV(csvFile);
    XLStable.EndTable();
    RemoveFile (csvFile);
    EndAction();

    var Rsd = RsdCommand(" begin it_rsl_string.clear; end; ");
    Rsd.execute();
  END;

  PRIVATE MACRO PrintDetail( ObjReport:OBJECT, SessionID, ListNum )
      var Count = 0, Query, Select, rs, Sheet, RSD, RecCnt = 0;
      var StartContr = 0, EndContr = 0, OpenContr = 0, ClosedContr = 0, PrevAccount = "", INN = "";
      var day, mon, year;
      var hour, min, sec;

      DateSplit(date(), day, mon, year);
      TimeSplit(time(), hour, min, sec);
      
      var Dt;
      var XLSFileDir = "..\\txtfile\\", XLSfile = null;
      var CreateOnTerm = (not isStandAlone());

      var FileName = "Report_724_" + INFO_NAME[ListNum-1];


      XLSfile = CTemplateSXLSX(NULL);
      XLSfile.OpenTemplate(FileName + ".xlsx", false);//имя шаблона
      XLSfile.SetXLSXFormat();
      //var XLSfileName = XLSfile.ReportFileName_xls ;
      var XLSfileName = FileName + "_" + string(day:o:2)+string(mon:o:2)+string(year)+"_"+string(hour:f:2)+string(min:f:2);

      if (ListNum == DETAIL_CLIENT_INFO)  
        
        InitProgress(-1, "Формирование файла расшифровки 'Данные о клиентах и договорах'", "Формирование файла расшифровки 'Данные о клиентах и договорах'" );
                                                                                                                              
        Query = "declare  NumStr integer := 1; begin  it_rsl_string.clear; "+
              " for rs in (" +
              "select distinct cl.t_client_groupid, cr.t_contr_groupid, cl.t_clientcode, cl.t_name, cl.t_code_oksm,                                                      " +
              "            (case when t_type_fl = 1 then 'ЮР' else 'ФИЗ' end) t_type_fl, (case when t_type_fl = 3  then 'ИП' else chr(1) end) t_isst,                      " +
              "            (case when t_ki = 1 then 'КВАЛ' else 'НЕКВАЛ' end) t_ki, (case when t_activeclient = 1 then 'Активный' else 'Неактивный' end) t_activeclient,   " +
              "            t_code_okato, pcontr.t_number, pcontr.t_datebegin,                                                                                              " +
              "            (case when pcontr.t_dateclose > ? then TO_DATE('01.01.0001', 'DD.MM.YYYY') else pcontr.t_dateclose end) t_dateclose,                            " +
              "            (case when cr.t_iis = 1 then chr(88) else chr(0) end) t_iis,                                                                                    " +
              "            (case when t_bankrole = 1 then 'Да' else 'Нет' end) t_bankrole,                                                                                 " +
              "            cl.t_partyid,                                                                                                                                   " +
              "            (SELECT Attr.t_NumInList                                                                                                                        " +
              "              FROM dobjatcor_dbt AtCor, dobjattr_dbt Attr, DDLCONTRMP_DBT mp                                                                                " +
              "             WHERE mp.T_SFCONTRID = t_sf_id                                                                                                                 " +
              "               AND AtCor.t_ObjectType = 207                                                                                                                 " +
              "               AND AtCor.t_GroupID    = 199 /*ОКВЭД для 724 ф*/                                                                                             " +
              "               AND AtCor.t_Object     = LPAD(mp.T_DLCONTRID , 34, '0' )                                                                                     " +
              "               AND AtCor.t_ValidFromDate  = ( SELECT MAX(t.T_ValidFromDate)                                                                                 " +
              "                                                FROM DOBJATCOR_DBT t                                                                                        " +
              "                                               WHERE t.T_ObjectType = AtCor.T_ObjectType                                                                    " +
              "                                                 AND t.T_GroupID    = AtCor.T_GroupID                                                                       " +
              "                                                 AND t.t_Object     = AtCor.t_Object                                                                        " +
              "                                                 AND t.T_ValidFromDate <= ?                                                                                 " +
              "                                                 AND (t.T_ValidToDate >= ? OR t.T_ValidToDate = TO_DATE('01.01.0001', 'DD.MM.YYYY'))                        " +
              "                                            )                                                                                                               " +
              "               AND (AtCor.T_ValidToDate >= ? OR AtCor.T_ValidToDate = TO_DATE('01.01.0001', 'DD.MM.YYYY'))                                                  " +
              "               AND Attr.t_AttrID      = AtCor.t_AttrID                                                                                                      " +
              "               AND Attr.t_ObjectType  = AtCor.t_ObjectType                                                                                                  " +
              "               AND Attr.t_GroupID     = AtCor.t_GroupID                                                                                                     " +
              "               AND ROWNUM = 1) t_okved                                                                                                                      " +
              "   from d724contr_dbt cr, d724client_dbt cl, dsfcontr_dbt pcontr                                                                                            " +
              "  where cr.t_sessionid = ?                                                                                                                                  " +
              "    and cr.t_Sessionid = cl.t_sessionid                                                                                                                     " +
              "    and cl.t_partyid = cr.t_party                                                                                                                           " +
              "    and pcontr.t_id = cr.t_parent_sf_id " +
              " order by cl.t_client_groupid, cr.t_contr_groupid, cl.t_clientcode, pcontr.t_number " +
              " ) loop        "+
              "     it_rsl_string.append_varchar(it_rsl_string.GetCell(rs.t_Client_GroupID) ||"+             
              "                   it_rsl_string.GetCell(rs.t_Contr_GroupID) || "+ 
              "                   it_rsl_string.GetCell(rs.t_ClientCode) || "+      
              "                   it_rsl_string.GetCell(rs.t_Name) || "+    
              "                   it_rsl_string.GetCell(rs.t_Code_OKSM) || "+    
              "                   it_rsl_string.GetCell(rs.t_Type_FL) || "+            
              "                   it_rsl_string.GetCell(rs.t_IsST) || "+    
              "                   it_rsl_string.GetCell(rs.t_KI) || "+          
              "                   it_rsl_string.GetCell(rs.t_ActiveClient) || "+         
              "                   it_rsl_string.GetCell(rs.t_Code_OKSM) || "+         
              "                   it_rsl_string.GetCell(case when rs.T_CODE_OKATO = '0' then '00' else rs.T_CODE_OKATO end) || "+         
              "                   it_rsl_string.GetCell(rs.t_Number) || "+        
              "                   it_rsl_string.GetCell(rs.t_DateBegin) || "+       
              "                   it_rsl_string.GetCell(case when rs.t_DateClose = TO_DATE('01.01.0001', 'DD.MM.YYYY') then '' else rs.t_DateClose end) || "+      
              "                   it_rsl_string.GetCell(rs.t_IIS) || "+       
              "                   it_rsl_string.GetCell(rs.t_BankRole) || "+     
              "                   it_rsl_string.GetCell(rs.t_OKVED, true)); "+   
              "  NumStr:= NumStr+1 ; end loop;    "+
              " end; " ;   
             
        Select = RSDCommand(Query);
        Select.AddParam("",RSDBP_IN,m_EndDate);
        Select.AddParam("",RSDBP_IN,m_EndDate);
        Select.AddParam("",RSDBP_IN,m_EndDate);
        Select.AddParam("",RSDBP_IN,m_EndDate);
        Select.AddParam("",RSDBP_IN,SessionID);
        Select.execute();

        RemProgress();
        ImportCSV(XLSfile,"Данные о клиентах и договорах","T1_MainTable_1");


        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок данных о клиентах и договорах " + XLSFileDir + XLSfile.ReportFileName_xls);
      
      elif (ListNum == DETAIL_COST_AVR)
        InitProgress(-1, "Формирование файла расшифровки 'Стоимость цб клиентов'", "Формирование файла расшифровки 'Стоимость цб клиентов'" ); 
        Rsd = RsdCommand("begin "
                       + "  rsb_dl724rep_2024.prepare_cost_avr_detail(p_sessionid => ?, "
                       + "                                       p_date      => ?); "
                       + "end;");
        Rsd.addParam("", RSDBP_IN, SessionID);                 
        Rsd.addParam("", RSDBP_IN, m_EndDate);
        Rsd.execute();
        RemProgress();
        ImportCSV(XLSfile,"Стоимость цб клиентов","T2_MainTable_2");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок стоимости ЦБ клиентов " + XLSFileDir + XLSfile.ReportFileName_xls);

      elif (ListNum == DETAIL_CLIENTS)
        InitProgress(-1, "Формирование файла расшифровки 'Данные о старых и новых клиентах в отчетном периоде'", "Формирование файла расшифровки 'Данные о старых и новых клиентах в отчетном периоде'" ); 
        Rsd = RsdCommand("begin "
                       + "  rsb_dl724rep_2024.prepare_clients_detail(p_sessionid => ?, "
                       + "                                       p_date     => ?); "
                       + "end;");
        Rsd.addParam("", RSDBP_IN, SessionID);                 
        Rsd.addParam("", RSDBP_IN, m_EndDate);
        Rsd.execute();
        RemProgress();
        ImportCSV(XLSfile,"Старые и новые клиенты","T8_MainTable_8");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок о старых и новых клиентах в отчетном периоде " + XLSFileDir + XLSfile.ReportFileName_xls);

        

      elif (ListNum == DETAIL_COST_CASH)

      InitProgress(-1, "Формирование файла расшифровки 'Стоимость ДС клиентов'", "Формирование файла расшифровки 'Стоимость ДС клиентов'" );

      Query = "declare  NumStr integer := 1; PrevAcc varchar2(25) := ''; PrevClGroup varchar2(100) := ''; PrevCrGroup varchar2(100) := ''; PrevAmountFIID number := 0; begin  it_rsl_string.clear; "+
            " for rs in (" +
            "select /*+ leading(rest, cl, cr, r3, fin) */ rest.t_client_groupid, rest.t_contr_groupid, cl.t_clientcode, cl.t_name, cl.t_code_oksm,  " +   
            "      (select t_number from dsfcontr_dbt where t_id=rest.t_contrid) t_contr_num,               " +
            "      (select t_number from dsfcontr_dbt where t_id=cr.t_parent_sf_id) t_parent_contr_num,       " +
            "      rest.t_account, rest.t_amount_fiid, fin.t_ccy, rest.t_amount_rur, r3.t_acckind             " +
            " from d724accrest_dbt rest                                                                 " +
            " left join d724client_dbt cl on cl.t_sessionid = rest.t_sessionid  and cl.t_partyid = rest.t_partyid  " +
            " left join d724contr_dbt cr on cr.t_sessionid =  cl.t_sessionid and cr.t_sf_id = rest.t_contrid       " +
            " left join d724r3client_group r3 on r3.t_sessionid = rest.t_Sessionid and r3.t_client_groupid = rest.t_client_groupid and r3.t_partyid = rest.t_partyid " +
            " left join dfininstr_dbt fin on fin.t_fiid = rest.t_fiid                                          " +
             " where rest.t_sessionid=? and rest.T_FI_KIND = 1                                                 " +
             " order by rest.t_client_groupid, rest.t_contr_groupid, fin.t_ccy, rest.t_account, cr.t_sf_number " +
             " ) loop        "+
             "  if (PrevAcc = '' or PrevAcc != rs.t_Account or PrevClGroup != rs.t_Client_GroupID or PrevCrGroup != rs.t_Contr_GroupID or PrevAmountFIID != rs.t_Amount_FIID) then " +
             "     it_rsl_string.append_varchar(it_rsl_string.GetCell(rs.t_Client_GroupID) ||"+             
             "                   it_rsl_string.GetCell(rs.t_Contr_GroupID) || "+ 
             "                   it_rsl_string.GetCell(rs.t_ClientCode) || "+      
             "                   it_rsl_string.GetCell(rs.t_Name) || "+    
             "                   it_rsl_string.GetCell(rs.t_Parent_Contr_Num) || "+
             "                   it_rsl_string.GetCell(rs.t_Contr_Num) || "+            
             "                   it_rsl_string.GetCell(rs.t_Account) || "+    
             "                   it_rsl_string.GetCell(rs.t_Amount_FIID) || "+          
             "                   it_rsl_string.GetCell(rs.t_CCY) || "+         
             "                   it_rsl_string.GetCell(rs.t_Amount_RUR) || "+         
             "                   it_rsl_string.GetCell(rs.t_AccKind, true)); "+  
             " end if; PrevAcc := rs.t_Account; PrevClGroup := rs.t_Client_GroupID; PrevCrGroup := rs.t_Contr_GroupID; PrevAmountFIID := rs.t_Amount_FIID; " +			 
             "  NumStr:= NumStr+1 ; end loop;    "+
             " end; " ;

        Select = RSDCommand(Query);
        Select.AddParam("", RSDBP_IN, SessionID);
        Select.execute();

 
        RemProgress();
        ImportCSV(XLSfile, "Стоимость ДС клиентов", "T3_MainTable_3");


        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок стоимости ДС клиентов " + XLSFileDir + XLSfile.ReportFileName_xls);

      elif (ListNum == DETAIL_COST_PFI)

        Query = "select /*+ leading(pfi, cl, cr, r3) */ pfi.t_client_groupid, pfi.t_contr_groupid, cl.t_clientcode, cl.t_name, cl.t_code_oksm,                                            " + 
                 "     (select t_number from dsfcontr_dbt where t_id=pfi.t_contrid) t_contr_num,                                                          " +
                 "     (select t_number from dsfcontr_dbt where t_id=cr.t_parent_sf_id) t_parent_contr_num,                                               " +
                 "  cmp.t_mpcode, pfi.t_ExtCode, pfi.t_ExtName, pfi.t_PFIName, pfi.t_Amount,  pfi.t_Dir, pfi.t_CostPFI, pfi.t_Guaranty, pfi.t_CostPFI_FO, r3.t_AccKind " +
                 " from d724pfi_dbt pfi                                                                                                                   " +
                 " join d724client_dbt cl on cl.t_sessionid = pfi.t_sessionid  and cl.t_partyid = pfi.t_partyid                                           " +
                 " join d724r3client_group r3 on r3.t_sessionid = pfi.t_Sessionid and r3.t_client_groupid = pfi.t_client_groupid and r3.t_partyid =pfi.t_partyid " +
                 " join d724contr_dbt cr on cr.t_sessionid =  cl.t_sessionid and cr.t_sf_id = pfi.t_contrid                                               " +
                 " left join ddlcontrmp_dbt cmp on cmp.t_sfcontrid = pfi.t_contrid                                                                        " +
                " where pfi.t_sessionid=?                                                                                                                 " +
                " order by pfi.t_client_groupid, pfi.t_contr_groupid, cr.t_sf_number ";

        Select = DL_RSDCommand(Query);
        Select.AddParam(SessionID);
        Count = Select.GetCount();
	  
      if(Count > 0 )
        InitProgress(Count, "Формирование файла расшифровки 'Стоимость ПФИ клиентов'", "Формирование файла расшифровки 'Стоимость ПФИ клиентов'" );
        rs = Select.execute();
        while( rs.MoveNext() )
            Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?,true)); "+           
                                    "  end; ");

            Rsd.addParam("",RSDBP_IN,rs.Client_GroupID);                 
            Rsd.addParam("",RSDBP_IN,rs.Contr_GroupID);
            Rsd.addParam("",RSDBP_IN,rs.ClientCode);             
            Rsd.addParam("",RSDBP_IN,rs.Name);      
            Rsd.addParam("",RSDBP_IN,rs.Parent_Contr_Num);         
            Rsd.addParam("",RSDBP_IN,rs.Contr_Num);        
            Rsd.addParam("",RSDBP_IN,rs.mpcode);           
            Rsd.addParam("",RSDBP_IN,rs.ExtCode);         
            Rsd.addParam("",RSDBP_IN,rs.ExtName); 
            Rsd.addParam("",RSDBP_IN,rs.PfiName);
            Rsd.addParam("",RSDBP_IN,rs.Amount);        
            Rsd.addParam("",RSDBP_IN,IIF(rs.Dir > 0, rs.Dir, ""));           
            Rsd.addParam("",RSDBP_IN,rs.CostPFI);         
            Rsd.addParam("",RSDBP_IN,rs.Guaranty); 
            Rsd.addParam("",RSDBP_IN,rs.CostPFI_FO);
            Rsd.addParam("",RSDBP_IN,rs.AccKind);            

            Rsd.execute();

            UseProgress(RecCnt = RecCnt + 1);

        end;
        RemProgress();
        ImportCSV(XLSfile,"Стоимость ПФИ клиентов","T4_MainTable_4");

      end;
         XLSfile.SaveAsTemplate(XLSfileName,false);
         msgbox("Сформирован файл расшифровок стоимости ПФИ клиентов " + XLSFileDir + XLSfile.ReportFileName_xls);


      elif (ListNum == DETAIL_MOVE_CASH)

        Query = "select /*+  leading(money, cl, contr, fininstr)  */  MONEY.T_CONTR_GROUPID, MONEY.T_CLIENT_GROUPID, CL.T_NAME, CL.T_CLIENTCODE, MONEY.T_CODE, " +
                      "(case when money.t_wrtin = chr(88) then 'Зачисление' else 'Списание' end) t_typeoper, MONEY.T_DATE,  FININSTR.T_CCY, " +
                      "(select t_number from dsfcontr_dbt where t_id=MONEY.t_contrid) t_contr_num, " +
                      "(select t_number from dsfcontr_dbt where t_id=contr.t_parent_sf_id) t_parent_contr_num, " +
                      "MONEY.T_SUM, MONEY.T_SUMRUB " +
                "from D724WRTMONEY_DBT MONEY " +
                "join D724CLIENT_DBT CL on CL.T_SESSIONID = MONEY.T_SESSIONID AND CL.T_PARTYID = MONEY.T_PARTYID " +
                "join D724CONTR_DBT CONTR on CONTR.T_SESSIONID = MONEY.T_SESSIONID AND CONTR.T_SF_ID = MONEY.T_CONTRID " +
                "join DFININSTR_DBT FININSTR on FININSTR.T_FIID = MONEY.T_FIID " +
               "where MONEY.T_SESSIONID = ?" +
              " order by MONEY.T_CONTR_GROUPID, MONEY.T_CLIENT_GROUPID, contr.t_sf_number, money.t_code             ";

        Select = DL_RSDCommand(Query);
        Select.AddParam(SessionID);
        Count = Select.GetCount();
	  
        if(Count > 0 )
          InitProgress(Count, "Формирование файла расшифровки 'Движение ДС'", "Формирование файла расшифровки 'Движение ДС'" );
          rs = Select.execute();
          while( rs.MoveNext() )
            Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+ 
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?,true)); "+             
                                    "  end; ");

             Rsd.addParam("",RSDBP_IN,rs.Client_GroupID);                   
             Rsd.addParam("",RSDBP_IN,rs.Contr_GroupID);
             Rsd.addParam("",RSDBP_IN,rs.ClientCode);               
             Rsd.addParam("",RSDBP_IN,rs.Name);      
             Rsd.addParam("",RSDBP_IN,rs.Parent_Contr_Num);         
             Rsd.addParam("",RSDBP_IN,rs.Contr_Num);        
             Rsd.addParam("",RSDBP_IN,rs.Code);             
             Rsd.addParam("",RSDBP_IN,rs.TypeOper);         
             Rsd.addParam("",RSDBP_IN,date(rs.Date)); 
             Rsd.addParam("",RSDBP_IN,rs.CCY);
             Rsd.addParam("",RSDBP_IN,rs.Sum);        
             Rsd.addParam("",RSDBP_IN,rs.SumRub);             

             Rsd.execute();

             UseProgress(RecCnt = RecCnt + 1);

        end;
        RemProgress();
        ImportCSV(XLSfile,"Движение ДС","T5_MainTable_5");
      end;

         XLSfile.SaveAsTemplate(XLSfileName,false);
         msgbox("Сформирован файл расшифровок движения ДС " + XLSFileDir + XLSfile.ReportFileName_xls);


      elif (ListNum == DETAIL_MOVE_AVR)

       Query = "select /*+  leading(wavr, cl, contr)  */  WAVR.T_CONTR_GROUPID, WAVR.T_CLIENT_GROUPID, CL.T_CLIENTCODE, CL.T_NAME, WAVR.T_CODE, "
                    "(case when WAVR.t_wrtin = chr(88) then 'Зачисление' else 'Списание' end) t_typeoper, WAVR.T_DATE, "
                    "(select t_number from dsfcontr_dbt where t_id=WAVR.t_contrid) t_contr_num, "
                    "(select t_number from dsfcontr_dbt where t_id=contr.t_parent_sf_id) t_parent_contr_num, "
                    "FININSTR.T_NAME T_FINNAME, FACEFIN.T_CCY T_FACECCY, AVR.T_ISIN, "
                    "(select t_name from dobjattr_dbt where t_objecttype=12 and t_groupid=1 and t_attrid=RSB_SECUR.GetMainObjAttr (12, LPAD (WAVR.T_FIID, 10, '0'), 1,WAVR.T_DATE)) t_type_fiid, "
                    "WAVR.T_QNTY, WAVR.T_RATE, WAVR.T_COSTNRUR, WAVR.T_TOTALCOST, PRICEFIN.T_CCY, "
                    "WAVR.T_NKDNRUR, WAVR.T_NKD, WAVR.T_COSTNRUR - WAVR.T_NKDNRur T_COSTNRURNNKD, WAVR.T_TOTALCOST - WAVR.T_NKD T_TOTALCOSTNNKD "
               "from D724WRTAVR_DBT WAVR "
               "join D724CLIENT_DBT CL on CL.T_SESSIONID = WAVR.T_SESSIONID AND CL.T_PARTYID = WAVR.T_PARTYID "
               "join D724CONTR_DBT CONTR on CONTR.T_SESSIONID = WAVR.T_SESSIONID AND CONTR.T_SF_ID = WAVR.T_CONTRID  "
               "left join DFININSTR_DBT PRICEFIN on PRICEFIN.T_FIID = WAVR.T_PRICEFIID "
               "join DFININSTR_DBT FININSTR on FININSTR.T_FIID = WAVR.T_FIID "
               "join DAVOIRISS_DBT AVR on AVR.T_FIID = WAVR.T_FIID "
               "join DFININSTR_DBT FACEFIN on FACEFIN.T_FIID = FININSTR.T_FACEVALUEFI "
              "where WAVR.T_SESSIONID = ?";
      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
        InitProgress(Count, "Формирование файла расшифровки 'Движение цб'", "Формирование файла расшифровки 'Движение цб'" );
        rs = Select.execute();
        while( rs.MoveNext() )
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                            " it_rsl_string.GetCell(?)|| "+           
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?)|| "+          
                            " it_rsl_string.GetCell(?)|| "+       
                            " it_rsl_string.GetCell(?)|| "+            
                            " it_rsl_string.GetCell(?)|| "+         
                            " it_rsl_string.GetCell(?)|| "+       
                            " it_rsl_string.GetCell(?)|| "+           
                            " it_rsl_string.GetCell(?)|| "+           
                            " it_rsl_string.GetCell(?)|| "+         
                            " it_rsl_string.GetCell(?)|| "+             
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?,true)); "+             
                            "  end; ");

          Rsd.addParam("",RSDBP_IN,rs.Client_GroupID);               
          Rsd.addParam("",RSDBP_IN,rs.Contr_GroupID);
          Rsd.addParam("",RSDBP_IN,rs.ClientCode);           
          Rsd.addParam("",RSDBP_IN,rs.Name);      
          Rsd.addParam("",RSDBP_IN,rs.Parent_Contr_Num);         
          Rsd.addParam("",RSDBP_IN,rs.Contr_Num);        
          Rsd.addParam("",RSDBP_IN,rs.Code);      
          Rsd.addParam("",RSDBP_IN,rs.TypeOper);           
          Rsd.addParam("",RSDBP_IN,date(rs.Date));           
          Rsd.addParam("",RSDBP_IN,rs.FinName);         
          Rsd.addParam("",RSDBP_IN,rs.FaceCCY);             
          Rsd.addParam("",RSDBP_IN,rs.ISIN);         
          Rsd.addParam("",RSDBP_IN,rs.Type_FIID); 
          Rsd.addParam("",RSDBP_IN,rs.QNTY);
          Rsd.addParam("",RSDBP_IN,rs.Rate);             
          Rsd.addParam("",RSDBP_IN,rs.CostNRur);         
          Rsd.addParam("",RSDBP_IN,rs.TotalCost);
          Rsd.addParam("",RSDBP_IN,rs.CCY);
          Rsd.addParam("",RSDBP_IN,rs.NKDNRur);
          Rsd.addParam("",RSDBP_IN,rs.NKD);
          Rsd.addParam("",RSDBP_IN,rs.CostNRurNNKD);
          Rsd.addParam("",RSDBP_IN,rs.TotalCostNNKD);
          
          Rsd.execute();

          UseProgress(RecCnt = RecCnt + 1);

        end;
        RemProgress();
        ImportCSV(XLSfile,"Движение цб","T6_MainTable_6");
      end;

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок движения ЦБ " + XLSFileDir + XLSfile.ReportFileName_xls);


      elif (ListNum == DETAIL_RQ)

        Query =" select /*+  leading(ar, cl, cr, r3, pt, ps)  */ ar.t_client_groupid, ar.t_contr_groupid, cl.t_clientcode, cl.t_name, cl.t_code_oksm, r3.t_AccKind,  " +
             "       (select t_number from dsfcontr_dbt where t_id=ar.t_contrid) t_contr_num,                       " +
             "       (select t_number from dsfcontr_dbt where t_id=cr.t_parent_sf_id) t_parent_contr_num,               " +
             "       ar.t_DealCodeTS, ar.t_DealCode, ar.t_Kind, ar.t_SubKind, ar.t_KindREPO, ar.t_Value, ar.t_ValueNRur,    " +
             "       pt.t_ShortName, t_Name1 LastName, t_Name2 FirstName, t_Name3 PatrName,                         " + 
             "       (CASE pt.t_NotResident                                                         " +
             "             WHEN CHR(88)                                                             " +
             "           THEN rsb_secur.SC_GetObjCodeOnDate (3, 62, pt.t_PartyId, ? )                            " +
             "             ELSE rsb_secur.SC_GetObjCodeOnDate (3, 16, pt.t_PartyId, ? )                             " +
             "        END) INN,                                                                 " +
             "        (CASE pt.t_NotResident                                                        " +
             "          WHEN CHR(88)                                                            " +
             "           THEN rsb_secur.SC_GetObjCodeOnDate (3, 33, pt.t_PartyId, ? )                            " +
             "           ELSE ''                                                              " +
             "         END) TIN                                                                 " +
             "  from d724arrear_dbt ar                                                            " + 
             "  join d724client_dbt cl on cl.t_sessionid = ar.t_sessionid  and cl.t_partyid = ar.t_partyid              " +
             "  join d724contr_dbt cr on cr.t_sessionid =  cl.t_sessionid and cr.t_sf_id = ar.t_contrid                 " +
             "  join d724r3client_group r3 on r3.t_sessionid = ar.t_Sessionid and r3.t_client_groupid = ar.t_client_groupid and r3.t_partyid = ar.t_partyid " +
             "  join dparty_dbt pt on pt.t_partyid = ar.t_contractorid                                          " +
             "  left join dpersn_dbt ps on ps.t_personid = ar.t_contractorid                                  " +
             " where ar.t_sessionid=?                                                             " +
             " order by ar.t_client_groupid, ar.t_contr_groupid, cr.t_sf_number";                         
        Select = DL_RSDCommand(Query);
        Select.AddParam(m_EndDate);
        Select.AddParam(m_EndDate);
        Select.AddParam(m_EndDate);
        Select.AddParam(SessionID);
        Count = Select.GetCount();
	  
        if(Count > 0 )
          InitProgress(Count, "Формирование файла расшифровки 'ТО по незавершенным сделкам'", "Формирование файла расшифровки 'ТО по незавершенным сделкам'" );
          rs = Select.execute();
          while( rs.MoveNext() )
            INN = rs.INN;
            SplitFullINN( INN, INN, null );

            Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                            " it_rsl_string.GetCell(?)|| "+           
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?)|| "+          
                            " it_rsl_string.GetCell(?)|| "+       
                            " it_rsl_string.GetCell(?)|| "+            
                            " it_rsl_string.GetCell(?)|| "+         
                            " it_rsl_string.GetCell(?)|| "+       
                            " it_rsl_string.GetCell(?)|| "+           
                            " it_rsl_string.GetCell(?)|| "+           
                            " it_rsl_string.GetCell(?)|| "+         
                            " it_rsl_string.GetCell(?)|| "+             
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+ 
                            " it_rsl_string.GetCell(?)|| "+
                            " it_rsl_string.GetCell(?,true)); "+             
                            "  end; ");

           Rsd.addParam("",RSDBP_IN,rs.Client_GroupID);                
           Rsd.addParam("",RSDBP_IN,rs.Contr_GroupID);
           Rsd.addParam("",RSDBP_IN,rs.ClientCode);            
           Rsd.addParam("",RSDBP_IN,rs.Name);      
           Rsd.addParam("",RSDBP_IN,rs.Parent_Contr_Num);         
           Rsd.addParam("",RSDBP_IN,rs.Contr_Num);        
           Rsd.addParam("",RSDBP_IN,rs.DealCodeTS);      
           Rsd.addParam("",RSDBP_IN,rs.DealCode);            
           Rsd.addParam("",RSDBP_IN,rs.Kind);            
           Rsd.addParam("",RSDBP_IN,rs.SubKind);         
           Rsd.addParam("",RSDBP_IN,IIF(rs.KINDREPO == 0, "", rs.KINDREPO));              
           Rsd.addParam("",RSDBP_IN,rs.ShortName);         
           Rsd.addParam("",RSDBP_IN,rs.LastName);
           Rsd.addParam("",RSDBP_IN,rs.FirstName);  
           Rsd.addParam("",RSDBP_IN,rs.PatrName);              
           Rsd.addParam("",RSDBP_IN,IIF(INN == "Undefined", "", INN));         
           Rsd.addParam("",RSDBP_IN,rs.TIN);
           Rsd.addParam("",RSDBP_IN,rs.ValueNRur);
           Rsd.addParam("",RSDBP_IN,rs.Value);
           Rsd.addParam("",RSDBP_IN,rs.AccKind);

           Rsd.execute();

           UseProgress(RecCnt = RecCnt + 1);

          end;
          RemProgress();
          ImportCSV(XLSfile,"ТО по незавершенным сделкам","T7_MainTable_7");
        end;

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок ТО по незавершенным сделкам " + XLSFileDir + XLSfile.ReportFileName_xls);

      elif (ListNum == DETAIL_OC_CONTR)
        Query = " SELECT CR.*, "                                                                    
             "        (SELECT COUNT(DISTINCT CONTR1.T_PARENT_SF_ID)                                     " +
             "              FROM D724CONTR_DBT CONTR1                                                   " +
             "             WHERE CONTR1.T_SESSIONID   = CR.T_SESSIONID                                  " +
             "           AND CONTR1.T_CONTR_GROUPID = CR.T_CONTR_GROUPID                                " +
             "           AND CONTR1.T_PARTY = CR.T_PARTYID                                              " +
             "           AND CONTR1.T_PSF_BEG < ?                                                       " +
             "        ) t_CountContrByStart,                                                            " +
             "       (SELECT COUNT(DISTINCT CONTR1.T_PARENT_SF_ID)                                      " +
             "             FROM D724CONTR_DBT CONTR1                                                    " +
             "         WHERE CONTR1.T_SESSIONID   = CR.T_SESSIONID                                      " +
             "              AND CONTR1.T_CONTR_GROUPID = CR.T_CONTR_GROUPID                             " +
             "              AND CONTR1.T_PARTY = CR.T_PARTYID                                           " +
             "              AND (CONTR1.T_PSF_END > ? or CONTR1.T_PSF_END = TO_DATE('01.01.0001','DD.MM.YYYY'))   " +
             "        ) t_CountContrByEnd,                                                              " +
             "       (SELECT COUNT(DISTINCT CONTR1.T_PARENT_SF_ID)                                      " +
             "             FROM D724CONTR_DBT CONTR1                                                    " +
             "         WHERE CONTR1.T_SESSIONID   = CR.T_SESSIONID                                      " +
             "              AND CONTR1.T_CONTR_GROUPID = CR.T_CONTR_GROUPID                             " +
             "              AND CONTR1.T_PARTY = CR.T_PARTYID                                           " +
             "             AND (CONTR1.T_PSF_BEG BETWEEN ? AND ? )                                      " +
             "        ) t_CountContrStartByPeriod,                                                      " +
             "       (SELECT COUNT(DISTINCT CONTR1.T_PARENT_SF_ID)                                      " +
             "         FROM D724CONTR_DBT CONTR1                                                        " +
             "        WHERE CONTR1.T_SESSIONID   = CR.T_SESSIONID                                       " +
             "             AND CONTR1.T_CONTR_GROUPID = CR.T_CONTR_GROUPID                              " +
             "             AND CONTR1.T_PARTY = CR.T_PARTYID                                            " +
             "             AND (CONTR1.T_PSF_END BETWEEN ? AND ? )                                      " +
             "        ) t_CountContrEndByPeriod                                                         " +
             " FROM (                                                                                   " +
             "   SELECT /* use_hash(cl,cr) */ cl.t_client_groupid, cr.t_contr_groupid, cl.t_clientcode, cl.t_name, cl.t_partyid, cl.t_sessionid " +
             "    FROM d724client_dbt cl                                                         " +
             "    JOIN d724contr_dbt cr on cr.t_sessionid = ? and cr.t_party = cl.t_partyid      " +
             "   WHERE cl.t_sessionid = ?                                                        " +
             "GROUP BY cl.t_client_groupid, cr.t_contr_groupid, cl.t_clientcode, cl.t_name, cl.t_partyid, cl.t_sessionid  "
             " ) CR";                          
        Select = DL_RSDCommand(Query);
        Select.AddParam(m_BegDate);
        Select.AddParam(m_EndDate);
        Select.AddParam(m_BegDate);
        Select.AddParam(m_EndDate);
        Select.AddParam(m_BegDate);
        Select.AddParam(m_EndDate);
        Select.AddParam(SessionID);
        Select.AddParam(SessionID);
        Count = Select.GetCount();
	  
        if(Count > 0 )
          InitProgress(Count, "Формирование файла расшифровки 'Открытие и закрытие договоров'", "Формирование файла расшифровки 'Открытие и закрытие договоров'" );
          rs = Select.execute();
          while( rs.MoveNext() )
            Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                    " it_rsl_string.GetCell(?)|| "+            
                                    " it_rsl_string.GetCell(?)|| "+
                                    " it_rsl_string.GetCell(?)|| "+           
                                    " it_rsl_string.GetCell(?)|| "+       
                                    " it_rsl_string.GetCell(?)|| "+             
                                    " it_rsl_string.GetCell(?)|| "+         
                                    " it_rsl_string.GetCell(?)|| "+       
                                    " it_rsl_string.GetCell(?,true)); "+              
                                    "  end; ");

            Rsd.addParam("",RSDBP_IN,rs.Client_GroupID);                
            Rsd.addParam("",RSDBP_IN,rs.Contr_GroupID);
            Rsd.addParam("",RSDBP_IN,rs.ClientCode);            
            Rsd.addParam("",RSDBP_IN,rs.Name);      
            Rsd.addParam("",RSDBP_IN,rs.CountContrByStart);         
            Rsd.addParam("",RSDBP_IN,rs.CountContrStartByPeriod);      
            Rsd.addParam("",RSDBP_IN,rs.CountContrEndByPeriod);
            Rsd.addParam("",RSDBP_IN,rs.CountContrByEnd);             
            Rsd.execute();

            StartContr  = StartContr + rs.CountContrByStart;
            OpenContr   = OpenContr + rs.CountContrStartByPeriod;
            ClosedContr = ClosedContr + rs.CountContrEndByPeriod;
            EndContr    = EndContr + rs.CountContrByEnd;
            UseProgress(RecCnt = RecCnt + 1);
          end;
          
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell('')|| "+            
                                  " it_rsl_string.GetCell('')|| "+
                                  " it_rsl_string.GetCell('')|| "+           
                                  " it_rsl_string.GetCell('Итого:')|| "+       
                                  " it_rsl_string.GetCell(?)|| "+             
                                  " it_rsl_string.GetCell(?)|| "+         
                                  " it_rsl_string.GetCell(?)|| "+       
                                  " it_rsl_string.GetCell(?,true)); "+              
                                  "  end; ");

          Rsd.addParam("",RSDBP_IN,StartContr);         
          Rsd.addParam("",RSDBP_IN,OpenContr);      
          Rsd.addParam("",RSDBP_IN,ClosedContr);
          Rsd.addParam("",RSDBP_IN,EndContr);              
          Rsd.execute();

          RemProgress();
          ImportCSV(XLSfile,"Открытие и закрытие договоров","T8_MainTable_8");
        end;

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок по данным об открытии и закрытии договоров в отчетном периоде " + XLSFileDir + XLSfile.ReportFileName_xls);

      elif (ListNum == DETAIL_COST_METALL)
        InitProgress(-1, "Формирование файла расшифровки 'Стоимость ДМ клиентов'", "Формирование файла расшифровки 'Стоимость ДМ клиентов'" );
        Query = "select d.t_contr_groupid, "
              + "       d.t_client_groupid, "
              + "       d.t_clientcode, "
              + "       d.t_name, "
              + "       ps.t_number t_parent_number, "
              + "       s.t_number t_sf_number, "
              + "       d.t_account, "
              + "       d.t_rest, "
              + "       f.t_iso_number, "
              + "       d.t_rest_rub, "
              + "       r3.t_acckind "
              + "  from d724_metall_details d "
              + "  join dsfcontr_dbt s on s.t_id = d.t_sf_id "
              + "  join dsfcontr_dbt ps on ps.t_id = d.t_parent_sf_id "
              + "  join dfininstr_dbt f on f.t_fiid = d.t_fiid "
              + "  join d724r3client_group r3 on r3.t_sessionid = ? and r3.t_client_groupid = d.t_client_groupid and r3.t_partyid = d.t_partyid "
              + " where d.t_rest != 0 "
              + " order by d.t_client_groupid, d.t_contr_groupid, d.t_account, s.t_number "
              ;
        Select = DL_RSDCommand(Query);
        Select.AddParam(SessionID);
        rs = Select.execute();

        while ( rs.MoveNext() )
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?,true)); "+
                           " end; ");

          Rsd.addParam("", RSDBP_IN, rs.client_groupid);
          Rsd.addParam("", RSDBP_IN, rs.contr_groupid);
          Rsd.addParam("", RSDBP_IN, rs.clientcode);
          Rsd.addParam("", RSDBP_IN, rs.name);
          Rsd.addParam("", RSDBP_IN, rs.parent_number);
          Rsd.addParam("", RSDBP_IN, rs.sf_number);
          Rsd.addParam("", RSDBP_IN, rs.account);
          Rsd.addParam("", RSDBP_IN, rs.rest);
          Rsd.addParam("", RSDBP_IN, rs.iso_number);
          Rsd.addParam("", RSDBP_IN, rs.rest_rub);
          Rsd.addParam("", RSDBP_IN, rs.acckind);
          Rsd.execute();

          UseProgress(RecCnt = RecCnt + 1);
        end;

        RemProgress();

        ImportCSV(XLSfile,"Стоимость ДМ клиентов","T11_MAINTABLE");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок по данным об открытии и закрытии договоров в отчетном периоде " + XLSFileDir + XLSfile.ReportFileName_xls);
      end;

      XLSfile.Close ;
      if (XLSfile.Application) XLSfile.Application.Quit; end;
      XLSfile = null;

  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )

    var SessionID = GetSessionID();
    var Query, Select, rs, Query2, Select2, rs2;
    var Code = "", AvrName = "", Group_Contr = 0;
    var ShortName = "", INN = "", TIN = "", LastName  = "", FirstName = "", PatrName  = "";
    var TYPE_FL = "", KI = "", IIS = "";
    var m_IsDataExist = false, Count = 0;
    var Chapter6_7DetailDone = false;

    InitProgress(4, "Подготовка данных для печати ф.724", "Подготовка данных для печати ф.724" );

    var cmd = RsdCommand("{call rsb_dl724rep_2024.ClearTables(?)}");
    cmd.addParam( "pSessionId", RSDBP_IN, SessionID );
    cmd.execute();

    //Заполнение таблицы договоров

    cmd = RsdCommand("{call rsb_dl724rep_2024.FillTableContr(?,?,?,?,?,?)}");
    cmd.addParam( "pSessionId", RSDBP_IN, SessionID );
    cmd.addParam( "pBegDate",   RSDBP_IN, m_BegDate );
    cmd.addParam( "pEndDate",   RSDBP_IN, m_EndDate );
    cmd.addParam( "pIsSecur",   RSDBP_IN, m_IsSecur );
    cmd.addParam( "pIsDV",      RSDBP_IN, m_IsDV    );
    cmd.addParam( "pIsRep12",   RSDBP_IN, m_IsRep12 );
    cmd.execute();   
    UseProgress(1);

    //Заполнение таблицы клиентов
    cmd = RsdCommand("{call rsb_dl724rep_2024.FillTableClient(?,?,?,?,?,?)}");
    cmd.addParam( "pSessionId", RSDBP_IN, SessionID );
    cmd.addParam( "pBegDate",   RSDBP_IN, m_BegDate );
    cmd.addParam( "pEndDate",   RSDBP_IN, m_EndDate );
    cmd.addParam( "pIsSecur",   RSDBP_IN, m_IsSecur );
    cmd.addParam( "pIsDV",      RSDBP_IN, m_IsDV    );
    cmd.addParam( "pIsRep12",   RSDBP_IN, m_IsRep12 );
    cmd.execute();  
    UseProgress(2);

    // Заполнение таблиц данных для отчёта - по сделкам, счетам, и т.д.
    // Лучше, разбить этот вызов на ~10 частей и сделать прогресс-бар
    cmd = RSDCommand("{CALL rsb_dl724rep_2024.CreateAllData(?,?,?,?,?,?)}");
    cmd.addParam( "", RSDBP_IN, m_BegDate );
    cmd.addParam( "", RSDBP_IN, m_EndDate );
    cmd.addParam( "", RSDBP_IN, m_Chapter );
    cmd.addParam( "", RSDBP_IN, SessionID );
    cmd.addParam( "", RSDBP_IN, PARALLEL_LEVEL );
    cmd.addParam( "", RSDBP_IN, m_IsRep12 );
    cmd.execute();
    UseProgress(3);

    cmd = RSDCommand("{CALL rsb_dl724rep_2024.FillTableR3CLIENT_GROUP(?,?,?,?)}");
    cmd.addParam( "", RSDBP_IN, m_BegDate );
    cmd.addParam( "", RSDBP_IN, m_EndDate );
    cmd.addParam( "", RSDBP_IN, SessionID );
    cmd.addParam( "", RSDBP_IN, PARALLEL_LEVEL );
    cmd.execute();

    UseProgress(4);
    RemProgress();

    if (m_IsRep12 != 1)

      InitProgress(9, "Печать ф.724", "Печать ф.724" );
      	  
      if(m_InDelta)
        m_DeltaReport.PrintInfo();
        m_DeltaReport.BeginData724(true);
      end;

      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1_3))

      SetActiveSheet( "Раздел 1" );

  //1.1
      CopyAllSheetInTotalBook( "Раздел 1", false, "N1_HEADER_1_1", 0, "Раздел 1" );
      CopyAllSheetInTotalBook( "Раздел 1", false, "N1_TABLEHEADER_1_1", 1, "Раздел 1" );

      RegisterTable("N1_MainTable_1_1", "", "N1_A1_1_ClientGroup", "N1_A1_1_ActKind", "N1_A1_1_Type", 
                    "N1_A1_1_Qual", "N1_A1_1_Status", "N1_A1_1_OKSM", "N1_A1_1_OKATO");

      Query = "select CL.T_TYPE_FL, CL.T_KI, CL.T_ACTIVECLIENT, CL.T_CODE_OKSM, CL.T_CODE_OKATO, " +
              "  (select CL1.T_CLIENT_GROUPID " +
              "      from D724CLIENT_DBT CL1 " +
              "     WHERE CL1.T_SESSIONID   = ? " +
              "       AND CL1.T_TYPE_FL     = CL.T_TYPE_FL      " +    
              "       AND CL1.T_KI          = CL.T_KI           " +
              "       AND CL1.T_ACTIVECLIENT= CL.T_ACTIVECLIENT " +
              "       AND CL1.T_CODE_OKSM   = CL.T_CODE_OKSM    " +
              "       AND CL1.T_CODE_OKATO  = CL.T_CODE_OKATO   " +
              "       AND ROWNUM = 1 " +
              "   ) ClientGroupID " +
              "  from D724CLIENT_DBT CL " +
              " where CL.T_SESSIONID = ? " +
              " group by CL.T_TYPE_FL, CL.T_KI, CL.T_ACTIVECLIENT, CL.T_CODE_OKSM, CL.T_CODE_OKATO " +
              " order by CL.T_TYPE_FL, CL.T_KI, CL.T_ACTIVECLIENT, CL.T_CODE_OKSM, CL.T_CODE_OKATO ";
      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
	if(m_InDelta)
          m_DeltaReport.BeginSubPart11(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )
          PrintTableLine("N1_A1_1_ClientGroup", rs.ClientGroupID, null, 
                         "N1_A1_1_ActKind", "1", null, 
                         "N1_A1_1_Type", rs.T_TYPE_FL, null, 
                         "N1_A1_1_Qual", rs.T_KI, null, 
                         "N1_A1_1_Status", rs.T_ACTIVECLIENT, null, 
                         "N1_A1_1_OKSM", rs.T_CODE_OKSM, null, 
                         "N1_A1_1_OKATO", IIF(rs.T_CODE_OKATO == "0", "00", rs.T_CODE_OKATO), null);
		  if(m_InDelta)
            m_DeltaReport.PrintLineSubPart11(rs.ClientGroupID, "1", rs.T_TYPE_FL, rs.T_KI, rs.T_ACTIVECLIENT, rs.T_CODE_OKSM, IIF(rs.T_CODE_OKATO == "0", "00", rs.T_CODE_OKATO)); 
          end;
        end;
        m_IsDataExist = true;
	if(m_InDelta)
          m_DeltaReport.EndSubPart11();
        end;
      end;

      EndTable();
      CopyAllSheetInTotalBook("Раздел 1", false, GetTableRange(), 0, "Раздел 1");      
      UseProgress(1);
      Count = 0;

  //1.2
      CopyAllSheetInTotalBook( "Раздел 1", false, "N1_HEADER_1_2", 1, "Раздел 1" );
      CopyAllSheetInTotalBook( "Раздел 1", false, "N1_TABLEHEADER_1_2", 1, "Раздел 1" );

      RegisterTable("N1_MainTable_1_2", "", "N1_A1_2_ContrGroup", "N1_A1_2_IIS", 
                    "N1_A1_2_UseCurr", "N1_A1_2_Contractor");

      Query = "select CONTR.T_IIS, CONTR.T_BANKROLE, CONTR.T_GROUP_CONTR, " +
              "  (select CONTR1.T_CONTR_GROUPID " +
              "      from D724CONTR_DBT CONTR1 " +
              "     WHERE CONTR1.T_SESSIONID   = ? " +
              "       AND CONTR1.T_IIS         = CONTR.T_IIS         " +    
              "       AND CONTR1.T_BANKROLE    = CONTR.T_BANKROLE    " +    
              "       AND CONTR1.T_GROUP_CONTR = CONTR.T_GROUP_CONTR " +
              "       AND ROWNUM = 1 " +
              "   ) ContrGroupID " +
              "  from D724CONTR_DBT CONTR " +
              " where CONTR.T_SESSIONID = ? " +
              " group by CONTR.T_IIS, CONTR.T_BANKROLE, CONTR.T_GROUP_CONTR " +
              " order by CONTR.T_IIS, CONTR.T_BANKROLE, CONTR.T_GROUP_CONTR ";
      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
	if(m_InDelta)
          m_DeltaReport.BeginSubPart12(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )

          Group_Contr = int(rs.T_GROUP_CONTR);
          if ((Group_Contr == 91) or (Group_Contr == 92))
            Group_Contr = 9;
          end;

          PrintTableLine("N1_A1_2_ContrGroup", rs.ContrGroupID, null, 
                         "N1_A1_2_IIS", rs.T_IIS, null, 
                         "N1_A1_2_UseCurr", rs.T_BANKROLE, null, 
                         "N1_A1_2_Contractor", Group_Contr, null);
	  if(m_InDelta)
            m_DeltaReport.PrintLineSubPart12(rs.ContrGroupID, rs.T_IIS, rs.T_BANKROLE, Group_Contr); 
          end;				 
        end;
        if(m_InDelta)
          m_DeltaReport.EndSubPart12();
        end;
	  m_IsDataExist = true;
      end;

      EndTable();
      CopyAllSheetInTotalBook("Раздел 1", false, GetTableRange(), 0, "Раздел 1");      
      UseProgress(2);     
      Count = 0;


  //2
      SetActiveSheet( "Раздел 2" );
      CopyAllSheetInTotalBook( "Раздел 2", false, "N2_HEADER_2", 1, "Раздел 2" );
      CopyAllSheetInTotalBook( "Раздел 2", false, "N2_TABLEHEADER_2", 1, "Раздел 2" );

      RegisterTable("N2_MainTable_2", "", "N2_A2_ClientGroup", "N2_A2_ContrGroup", 
                    "N2_A2_StrategyId", "N2_A2_CurrIn", "N2_A2_AvrIn", "N2_A2_OthersIn",
                    "N2_A2_CurrOut", "N2_A2_AvrOut", "N2_A2_OthersOut", "N2_A2_ContrCount",
                    "N2_A2_ContrBeginCount", "N2_A2_ContrEndCount");


      Query = "select /*+ use_hash(cl,contr)*/ "
            + "       cl.t_client_groupid, "
            + "       contr.t_contr_groupid "
            + "  from d724client_dbt  cl "
            + "  join d724contr_dbt contr on contr.T_PARTY = cl.T_PARTYID "
            + "                          and contr.T_SESSIONID = cl.T_SESSIONID "
            + " where cl.T_SESSIONID = ? "
            + " group by cl.t_client_groupid, "
            + "          contr.t_contr_groupid ";
      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Count = Select.GetCount();

      Query = "with wrtmoney as ( "
            + "       select w.t_client_groupid, "
            + "              w.t_contr_groupid, "
            + "              sum(case when w.t_wrtin = chr(88) then w.t_sumrub end) CurrIn, "
            + "              sum(case when w.t_wrtin = chr(0)  then w.t_sumrub end) CurrOut "
            + "         from d724wrtmoney_dbt w "
            + "        where w.t_sessionid = ? " //1
            + "        group by w.t_client_groupid, "
            + "                 w.t_contr_groupid "
            + "     ) "
            + "    ,wrtavr as ( "
            + "       select a.t_client_groupid, "
            + "              a.t_contr_groupid, "
            + "              sum(case when a.t_wrtin = chr(88) and a.t_isavr = chr(88) then a.t_totalcost end) AvrIn, "
            + "              sum(case when a.t_wrtin = chr(0)  and a.t_isavr = chr(88) then a.t_totalcost end) AvrOut, "
            + "              sum(case when a.t_wrtin = chr(88) and a.t_isavr = chr(0)  then a.t_totalcost end) NotAvrIn, "
            + "              sum(case when a.t_wrtin = chr(0)  and a.t_isavr = chr(0)  then a.t_totalcost end) NotAvrOut "
            + "         from d724wrtavr_dbt a "
            + "        where a.t_sessionid = ? " //2
            + "        group by a.t_client_groupid, "
            + "                 a.t_contr_groupid "
            + "    ) "
            + "select /*+ use_hash(cl,contr)*/ "
            + "       cl.t_client_groupid, "
            + "       contr.t_contr_groupid, "
            + "       count(distinct case when parent_sf.T_DATECLOSE > ? or parent_sf.T_DATECLOSE = TO_DATE('01.01.0001','DD.MM.YYYY') " //3
            + "                           then contr.t_parent_sf_id "
            + "             end) CountContrByEnd, "
            + "       count(distinct case when parent_sf.T_DATEBEGIN BETWEEN ? AND ? " //4, 5
            + "                           then contr.t_parent_sf_id "
            + "             end) CountContrStartByPeriod, "
            + "       count(distinct case when parent_sf.T_DATECLOSE BETWEEN ? AND ? " //6, 7
            + "                           then contr.t_parent_sf_id "
            + "             end) CountContrEndByPeriod, "
            + "       nvl(wrt.CurrIn, 0) CurrIn, "
            + "       nvl(wrt.CurrOut, 0) CurrOut, "
            + "       nvl(avr.AvrIn, 0) AvrIn, "
            + "       nvl(avr.AvrOut, 0) AvrOut, "
            + "       nvl(avr.NotAvrIn, 0) NotAvrIn, "
            + "       nvl(avr.NotAvrOut, 0) NotAvrOut "
            + "  from d724client_dbt  cl "
            + "  join d724contr_dbt contr on contr.T_PARTY = cl.T_PARTYID "
            + "                          and contr.T_SESSIONID = cl.T_SESSIONID "
            + "  join dsfcontr_dbt parent_sf on parent_sf.t_id = contr.t_parent_sf_id "
            + "  left join wrtmoney wrt on wrt.t_client_groupid = cl.t_client_groupid "
            + "                        and wrt.t_contr_groupid = contr.t_contr_groupid "
            + "  left join wrtavr avr on avr.t_client_groupid = cl.t_client_groupid "
            + "                      and avr.t_contr_groupid = contr.t_contr_groupid "
            + " where cl.T_SESSIONID = ? " //8
            + " group by cl.t_client_groupid, "
            + "          contr.t_contr_groupid, "
            + "          wrt.CurrIn, "
            + "          wrt.CurrOut, "
            + "          avr.AvrIn, "
            + "          avr.AvrOut, "
            + "          avr.NotAvrIn, "
            + "          avr.NotAvrOut "
            + "order by cl.t_client_groupid, contr.t_contr_groupid ";

      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID); //1
      Select.AddParam(SessionID); //2
      Select.AddParam(m_EndDate); //3
      Select.AddParam(m_BegDate); //4
      Select.AddParam(m_EndDate); //5
      Select.AddParam(m_BegDate); //6
      Select.AddParam(m_EndDate); //7
      Select.AddParam(SessionID); //8
	  
      if(Count > 0 )
        if(m_InDelta)
          m_DeltaReport.BeginPart2(); 
        end;
	  
        rs = Select.execute();
        while( rs.MoveNext() )

          PrintTableLine("N2_A2_ClientGroup", rs.CLIENT_GROUPID, null, 
                         "N2_A2_ContrGroup", rs.CONTR_GROUPID, null, 
                         "N2_A2_StrategyId", "", null, 
                         "N2_A2_CurrIn", rs.CurrIn, null, 
                         "N2_A2_AvrIn", rs.AvrIn, null, 
                         "N2_A2_OthersIn", rs.NotAvrIn, null, 
                         "N2_A2_CurrOut", rs.CurrOut, null, 
                         "N2_A2_AvrOut", rs.AvrOut, null, 
                         "N2_A2_OthersOut", rs.NotAvrOut, null, 
                         "N2_A2_ContrCount", rs.CountContrByEnd, null, 
                         "N2_A2_ContrBeginCount", rs.CountContrStartByPeriod, null, 
                         "N2_A2_ContrEndCount", rs.CountContrEndByPeriod, null);
	         if(m_InDelta)
            m_DeltaReport.PrintLinePart2(rs.CLIENT_GROUPID, rs.CONTR_GROUPID, "", rs.CurrIn, rs.AvrIn, rs.NotAvrIn, rs.CurrOut, rs.AvrOut, rs.NotAvrOut, rs.CountContrByEnd, rs.CountContrStartByPeriod, rs.CountContrEndByPeriod); 
          end;
        end;
        if(m_InDelta)
          m_DeltaReport.EndPart2();
        end;
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_CLIENT_INFO);
          PrintDetail(ObjReport, SessionID, DETAIL_MOVE_CASH);
          PrintDetail(ObjReport, SessionID, DETAIL_MOVE_AVR);
        end;
        m_IsDataExist = true;
      end;

      EndTable();
      CopyAllSheetInTotalBook("Раздел 2", false, GetTableRange(), 0, "Раздел 2");      
      UseProgress(3);
      Count = 0;

  //3
      SetActiveSheet( "Раздел 3" );
      CopyAllSheetInTotalBook( "Раздел 3", false, "N3_HEADER_3", 1, "Раздел 3" );
      CopyAllSheetInTotalBook( "Раздел 3", false, "N3_TABLEHEADER_3", 1, "Раздел 3" );

      RegisterTable("N3_MainTable_3", "", "N3_A3_ClientGroup", "N3_A3_AccountSize", 
                    "N3_A3_PortfolioVolume", "N3_A3_PortfolioVolumeIIS", "N3_A3_ClientCount",
                    "N3_A3_ClientIISCount", "N3_A3_ClientContrBeginCount", "N3_A3_ClientContrEndCount");

      Query = " select * from " + 
              "   ( " +
              "    (select 0 as IsIIS, " +
              "            t_Client_GroupID, " + 
              "            t_AccKind as AccKind, " +
              "            sum(t_AccAmount) as AccAmount, " +
              "            sum(CountClient) as CountClient, " +
              "            sum(CountClientBegContr) as CountClientBegContr, " +
              "            sum(CountClientEndContr) as CountClientEndContr " +
              "       from D724R3CLIENT_GROUP " +
              "      where T_SESSIONID = ? " +
              "      group by t_Client_GroupID, t_AccKind " +
              "    ) " +
              "    union all " +
              "    (select 1 as IsIIS, " +
              "            t_Client_GroupID, " + 
              "            t_AccKindIIS as AccKind, " +
              "            sum(t_AccAmountIIS) as AccAmount, " +
              "            sum(CountClientIIS) as CountClient, " +
              "            0 as CountClientBegContr, " +
              "            0 as CountClientEndContr " +
              "       from D724R3CLIENT_GROUP " +
              "      where T_SESSIONID = ? " +
              "        and CountClientIIS > 0 " +
              "      group by t_Client_GroupID, t_AccKindIIS " +
              "     ) " +
              "    ) " +   
              "  order by t_Client_GroupID, AccKind, IsIIS ";
      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
        if(m_InDelta)
          m_DeltaReport.BeginPart3(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )
          if(rs.IsIIS == 0)
            PrintTableLine("N3_A3_ClientGroup", rs.Client_GroupID, null, 
                           "N3_A3_AccountSize", rs.AccKind, null, 
                           "N3_A3_PortfolioVolume", rs.AccAmount, null, 
                           "N3_A3_PortfolioVolumeIIS", 0, null, 
                           "N3_A3_ClientCount", int(rs.CountClient), null, 
                           "N3_A3_ClientIISCount", 0, null, 
                           "N3_A3_ClientContrBeginCount", int(rs.CountClientBegContr), null, 
                           "N3_A3_ClientContrEndCount", int(rs.CountClientEndContr), null);

            if(m_InDelta)
              m_DeltaReport.PrintLinePart3(rs.Client_GroupID, rs.AccKind, rs.AccAmount, 0, int(rs.CountClient), 0, int(rs.CountClientBegContr), int(rs.CountClientEndContr));
            end;			   
          else
            PrintTableLine("N3_A3_ClientGroup", rs.Client_GroupID, null, 
                           "N3_A3_AccountSize", rs.AccKind, null, 
                           "N3_A3_PortfolioVolume", 0, null, 
                           "N3_A3_PortfolioVolumeIIS", rs.AccAmount, null, 
                           "N3_A3_ClientCount", 0, null, 
                           "N3_A3_ClientIISCount", int(rs.CountClient), null, 
                           "N3_A3_ClientContrBeginCount", 0, null, 
                           "N3_A3_ClientContrEndCount", 0, null);

            if(m_InDelta)
              m_DeltaReport.PrintLinePart3(rs.Client_GroupID, rs.AccKind, 0, rs.AccAmount, 0, int(rs.CountClient), 0, 0);
            end;			   
          end;
        end;
        if(m_InDelta)
          m_DeltaReport.EndPart3();
        end;
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_OC_CONTR);
          PrintDetail(ObjReport, SessionID, DETAIL_CLIENTS);

        end;
        m_IsDataExist = true;
      end;

      EndTable();
      CopyAllSheetInTotalBook("Раздел 3", false, GetTableRange(), 0, "Раздел 3");

      end;
      
      UseProgress(4);
      Count = 0;



  //4
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_4)) 

      SetActiveSheet( "Раздел 4" );
      CopyAllSheetInTotalBook( "Раздел 4", false, "N4_HEADER_4", 1, "Раздел 4" );
      CopyAllSheetInTotalBook( "Раздел 4", false, "N4_TABLEHEADER_4", 1, "Раздел 4" );

      RegisterTable("N4_MainTable_4", "", "N4_A4_ClientGroup", "N4_A4_ContrGroup", 
                    "N4_A4_StrategyId", "N4_A4_CostCur", "N4_A4_CodeCur", "N4_A4_CostRur",
                    "N4_A4_NameBroker", "N4_A4_INNBroker", "N4_A4_TINBroker");
			  
      Query = "select T_CLIENT_GROUPID, T_CONTR_GROUPID, T_FIID, " +
              "       NVL(SUM(T_AMOUNT_FIID), 0) CostCur, " +
              "       NVL(SUM(T_AMOUNT_RUR), 0) CostRur "  +
              "  from (" +
              "   select distinct Rest.T_CLIENT_GROUPID, Rest.T_CONTR_GROUPID, Rest.T_FIID, Rest.T_ACCOUNT, Rest.T_CHAPTER, Rest.T_AMOUNT_FIID, Rest.T_AMOUNT_RUR " +
              "     from D724ACCREST_DBT Rest " +
              "    where Rest.T_SESSIONID = ? " + 
              "      and Rest.T_FI_KIND = 1 )" + //FIKIND_CURRENCY = 1
              " group by T_CLIENT_GROUPID, T_CONTR_GROUPID, T_FIID " +
              " order by T_CLIENT_GROUPID, T_CONTR_GROUPID, T_FIID ";

      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
	if(m_InDelta)
          m_DeltaReport.BeginPart4(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )

          if (int(rs.FIID) > 0)
            Query2 = "SELECT t_fi_Code Code " +
                     "  FROM dfininstr_dbt " +
                     " WHERE t_FIID = ? ";
            Select2 = DL_RSDCommand(Query2);
            Select2.AddParam(int(rs.FIID));

            rs2 = Select2.execute();
            if( rs2.MoveNext() )
               Code = rs2.Code;
            else 
               Code = "000";
            end;
          else 
             Code = "643";
          end;

          PrintTableLine("N4_A4_ClientGroup", rs.CLIENT_GROUPID, null, 
                         "N4_A4_ContrGroup", rs.CONTR_GROUPID, null, 
                         "N4_A4_StrategyId", "", null, 
                         "N4_A4_CostCur", rs.CostCur, null, 
                         "N4_A4_CodeCur", Code, null, 
                         "N4_A4_CostRur", rs.CostRur, null, 
                         "N4_A4_NameBroker", "", null, 
                         "N4_A4_INNBroker", "", null, 
                         "N4_A4_TINBroker", "", null);
          if(m_InDelta)
            m_DeltaReport.PrintLinePart4(rs.CLIENT_GROUPID, rs.CONTR_GROUPID, "", rs.CostCur, Code, rs.CostRur, "", "", ""); 
          end;			 
        end;
	if(m_InDelta)
          m_DeltaReport.EndPart4();
        end;
	  m_IsDataExist = true;
	end;

      EndTable();
      CopyAllSheetInTotalBook("Раздел 4", false, GetTableRange(), 0, "Раздел 4");
      end;
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1_3) or (m_Chapter == CHAPTER_4))
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_COST_CASH);
        end;
      end;
      
      UseProgress(5);
      Count = 0;


  //6
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_6))

      SetActiveSheet( "Раздел 6" );
      CopyAllSheetInTotalBook( "Раздел 6", false, "N6_HEADER_6", 1, "Раздел 6" );
      CopyAllSheetInTotalBook( "Раздел 6", false, "N6_TABLEHEADER_6", 1, "Раздел 6" );

      RegisterTable("N6_MainTable_6", "", "N6_A6_ClientGroup", "N6_A6_ContrGroup", "N6_A6_StrategyId", 
                    "N6_A6_Issuer", "N6_A6_LSIN", "N6_A6_ISIN", "N6_A6_Amount", "N6_A6_CostRub");


      Query = "select Rest.T_CONTR_GROUPID, Rest.T_CLIENT_GROUPID, Rest.t_FIID, Rest.t_IssuerName, Rest.t_ISIN, Rest.t_LSIN, " +
              "       replace(it_xml.number_to_char(round(sum(Rest.T_QNTY),5),-12), '.', ',') T_QNTYSTR, " +
              "       sum(Rest.T_TOTALCOST) TOTALCOST " +
              "  from D724FIREST_DBT Rest " +
              " where Rest.T_SESSIONID = ?  and Rest.t_IsNotAvr != chr(88) " +
              " group by Rest.T_CONTR_GROUPID, Rest.T_CLIENT_GROUPID, Rest.t_FIID, Rest.t_IssuerName, Rest.t_ISIN, Rest.t_LSIN " +
              " order by Rest.T_CONTR_GROUPID, Rest.T_CLIENT_GROUPID, Rest.t_FIID, Rest.t_IssuerName, Rest.t_ISIN, Rest.t_LSIN ";

      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
	if(m_InDelta)
          m_DeltaReport.BeginPart6(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )

          PrintTableLine("N6_A6_ClientGroup", rs.CLIENT_GROUPID, null, 
                         "N6_A6_ContrGroup", rs.CONTR_GROUPID, null, 
                         "N6_A6_StrategyId", "", null, 
                         "N6_A6_Issuer", rs.IssuerName, null, 
                         "N6_A6_LSIN", rs.Lsin, null, 
                         "N6_A6_ISIN", rs.Isin, null, 
                         "N6_A6_Amount", rs.QNTYSTR, null, 
                         "N6_A6_CostRub", rs.TOTALCOST, null);
	  if(m_InDelta)
            m_DeltaReport.PrintLinePart6(rs.CLIENT_GROUPID, rs.CONTR_GROUPID, "", rs.IssuerName, rs.Lsin, rs.Isin, Replace(rs.QNTYSTR, ",", "."), rs.TOTALCOST); 
          end;			 
      end;
        if(m_InDelta)
          m_DeltaReport.EndPart6();
        end;
        	  m_IsDataExist = true;
      end;
      EndTable();
      CopyAllSheetInTotalBook("Раздел 6", false, GetTableRange(), 0, "Раздел 6");
      end;
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1_3) or (m_Chapter == CHAPTER_6))
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_COST_AVR);
          Chapter6_7DetailDone = true;
        end;
      end;

      
      UseProgress(6);
      Count = 0;

  //7

      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_7))

      SetActiveSheet( "Раздел 7" );
      CopyAllSheetInTotalBook( "Раздел 7", false, "N7_HEADER_7", 1, "Раздел 7" );
      CopyAllSheetInTotalBook( "Раздел 7", false, "N7_TABLEHEADER_7", 1, "Раздел 7" );

      RegisterTable("N7_MainTable_7", "", "N7_A7_ClientGroup", "N7_A7_ContrGroup", "N7_A7_StrategyId", 
                    "N7_A7_Name", "N7_A7_CostRub");


      Query = "select Rest.T_CONTR_GROUPID, Rest.T_CLIENT_GROUPID, Rest.t_FIID, " +
              "       sum(Rest.T_TOTALCOST) TOTALCOST " +
              "  from D724FIREST_DBT Rest " +
              " where Rest.T_SESSIONID = ? and Rest.t_IsNotAvr = chr(88) " +
              " group by Rest.T_CONTR_GROUPID, Rest.T_CLIENT_GROUPID, Rest.t_FIID " +
              " order by Rest.T_CONTR_GROUPID, Rest.T_CLIENT_GROUPID, Rest.t_FIID ";

      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
	if(m_InDelta)
          m_DeltaReport.BeginPart7(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )
          Query2 = "select (a.t_isin || ' ' || fin.t_name) t_name " +
                   "  from dfininstr_dbt fin, davoiriss_dbt a " +
                   " where fin.t_fiid = ?  " +
                   "   and fin.t_fiid = a.t_fiid ";
          Select2 = DL_RSDCommand(Query2);
          Select2.AddParam(int(rs.FIID));

          rs2 = Select2.execute();
          if( rs2.MoveNext() )
             AvrName = rs2.Name;       
          else 
             AvrName = "";
          end;

          PrintTableLine("N7_A7_ClientGroup", rs.CLIENT_GROUPID, null, 
                         "N7_A7_ContrGroup", rs.CONTR_GROUPID, null, 
                         "N7_A7_StrategyId", "", null, 
                         "N7_A7_Name", AvrName, null, 
                         "N7_A7_CostRub", rs.TOTALCOST, null);
	  if(m_InDelta)
            m_DeltaReport.PrintLinePart7(rs.CLIENT_GROUPID, rs.CONTR_GROUPID, "", AvrName, rs.TOTALCOST); 
          end;			 
      end;
        if(m_InDelta)
          m_DeltaReport.EndPart7();
        end;
        	  m_IsDataExist = true;
      end;
      EndTable();
      CopyAllSheetInTotalBook("Раздел 7", false, GetTableRange(), 0, "Раздел 7");
      end;
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1_3) or (m_Chapter == CHAPTER_7))
        if (m_Detail and (not Chapter6_7DetailDone))
          PrintDetail(ObjReport, SessionID, 2);
          Chapter6_7DetailDone = true;
        end;
      end;
       
      UseProgress(7);
      Count = 0;

  //8
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_8))
      SetActiveSheet( "Раздел 8" );
      CopyAllSheetInTotalBook( "Раздел 8", false, "N8_HEADER_8", 1, "Раздел 8" );
      CopyAllSheetInTotalBook( "Раздел 8", false, "N8_TABLEHEADER_8", 1, "Раздел 8" );

      RegisterTable("N8_MainTable_8", "", "N8_A8_ClientGroup", "N8_A8_ContrGroup", "N8_A8_StrategyId", 
                    "N8_A8_ExtCode", "N8_A8_ExtName", "N8_A8_PfiName", "N8_A8_Amount", 
                    "N8_A8_Dir", "N8_A8_CostPFI", "N8_A8_Guaranty", "N8_A8_CostPFI_FO");

      Query = "select T_CONTR_GROUPID, T_CLIENT_GROUPID, T_PFINAME, T_DIR, T_EXTCODE, T_EXTNAME, sum(T_AMOUNT) AMOUNT, " +
              "       sum(T_COSTPFI) COSTPFI, sum(T_GUARANTY) GUARANTY, sum(T_COSTPFI_FO) COSTPFI_FO " +
              "  from D724PFI_DBT " +
              " where T_SESSIONID = ? " +
              " group by T_CONTR_GROUPID, T_CLIENT_GROUPID, T_PFINAME, T_DIR, T_EXTCODE, T_EXTNAME " +
              " order by T_CONTR_GROUPID, T_CLIENT_GROUPID, T_PFINAME, T_DIR, T_EXTCODE, T_EXTNAME ";

      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);
      Count = Select.GetCount();
	  
      if(Count > 0 )
	if(m_InDelta)
          m_DeltaReport.BeginPart8(); 
        end;
        rs = Select.execute();
        while( rs.MoveNext() )

          PrintTableLine("N8_A8_ClientGroup", rs.CLIENT_GROUPID, null, 
                         "N8_A8_ContrGroup", rs.CONTR_GROUPID, null, 
                         "N8_A8_StrategyId", "", null, 
                         "N8_A8_ExtCode", rs.ExtCode, null, 
                         "N8_A8_ExtName", rs.ExtName, null, 
                         "N8_A8_PfiName", rs.PfiName, null, 
                         "N8_A8_Amount", rs.Amount, null, 
                         "N8_A8_Dir", IIF(rs.Dir > 0, rs.Dir, ""), null,
                         "N8_A8_CostPFI", rs.CostPFI, null,
                         "N8_A8_Guaranty", rs.Guaranty, null,
                         "N8_A8_CostPFI_FO", rs.CostPFI_FO, null);
	 if(m_InDelta)
            m_DeltaReport.PrintLinePart8(rs.CLIENT_GROUPID, rs.CONTR_GROUPID, "", rs.ExtCode, rs.ExtName, rs.PfiName, rs.Amount, IIF(rs.Dir > 0, rs.Dir, ""), rs.CostPFI, rs.Guaranty, rs.CostPFI_FO); 
          end;
        end;
	 if(m_InDelta)
          m_DeltaReport.EndPart8();
        end;
	  m_IsDataExist = true;
        end;

      EndTable();
      CopyAllSheetInTotalBook("Раздел 8", false, GetTableRange(), 0, "Раздел 8");
      end;
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1_3) or (m_Chapter == CHAPTER_8))
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_COST_PFI);
        end;
      end;
      
      UseProgress(8);
      Count = 0;

  //9
      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_9))
        SetActiveSheet( "Раздел 9" );
        CopyAllSheetInTotalBook( "Раздел 9", false, "N9_HEADER_9", 1, "Раздел 9" );
        CopyAllSheetInTotalBook( "Раздел 9", false, "N9_TABLEHEADER_9", 1, "Раздел 9" );

        RegisterTable("N9_MainTable_9", "", "N9_A9_ClientGroup", "N9_A9_ContrGroup", "N9_A9_StrategyId", 
                      "N9_A9_KindTO", "N9_A9_SubKind", "N9_A9_KindRepo", "N9_A9_ShortName", "N9_A9_LastName",
                      "N9_A9_FirstName", "N9_A9_PatrName", "N9_A9_INN", "N9_A9_TIN", "N9_A9_CostRub");


        Query = "select T_CONTR_GROUPID, T_CLIENT_GROUPID, T_KIND, T_SUBKIND, T_KINDREPO, T_CONTRACTORID, " +
                "       sum(T_VALUE) CostRub " +
                "  from D724ARREAR_DBT " +
                " where T_SESSIONID = ? " +
                " group by T_CONTR_GROUPID, T_CLIENT_GROUPID, T_KIND, T_SUBKIND, T_KINDREPO, T_CONTRACTORID " +
                " order by T_CONTR_GROUPID, T_CLIENT_GROUPID, T_KIND, T_SUBKIND, T_KINDREPO, T_CONTRACTORID ";

        Select = DL_RSDCommand(Query);
        Select.AddParam(SessionID);
        Count = Select.GetCount();
    
        if(Count > 0 )
          if(m_InDelta)
            m_DeltaReport.BeginPart9(); 
          end;
          rs = Select.execute();
          while( rs.MoveNext() )
            Query2 = "select pt.t_ShortName, " +
                     "       (CASE t_NotResident " +
                     "           WHEN CHR(88) " +
                     "               THEN rsb_secur.SC_GetObjCodeOnDate (3, 62, pt.t_PartyId, ? ) " +
                     "           ELSE rsb_secur.SC_GetObjCodeOnDate (3, 16, pt.t_PartyId, ? ) " +
                     "       END) " +
                     "         INN, " +
                     "       (CASE t_NotResident " +
                     "           WHEN CHR(88) " +
                     "               THEN rsb_secur.SC_GetObjCodeOnDate (3, 33, pt.t_PartyId, ? ) " +
                     "           ELSE '' " +
                     "       END) " +
                     "         TIN " +
                     "  from dparty_dbt pt " +
                     " where pt.t_PartyId = ? ";

            Select2 = DL_RSDCommand(Query2);
            Select2.AddParam(m_EndDate); 
            Select2.AddParam(m_EndDate); 
            Select2.AddParam(m_EndDate); 
            Select2.AddParam(int(rs.CONTRACTORID));

            rs2 = Select2.execute();
            if( rs2.MoveNext() )
              ShortName = rs2.ShortName;
              INN = rs2.INN;
              TIN = rs2.TIN;

              SplitFullINN(INN, INN, null );
            else 
              ShortName = "";
              INN = "";
              TIN = "";
            end;

            Query2 = "select t_Name1 LastName, t_Name2 FirstName, t_Name3 PatrName " +
                     "  from dpersn_dbt " +
                     " where t_PersonID = ? ";

            Select2 = DL_RSDCommand(Query2);
            Select2.AddParam(int(rs.CONTRACTORID));

            rs2 = Select2.execute();
            if( rs2.MoveNext() )
              LastName  = rs2.LastName;
              FirstName = rs2.FirstName;
              PatrName  = rs2.PatrName;
            else 
              LastName  = "";
              FirstName = "";
              PatrName  = "";
            end;

            PrintTableLine("N9_A9_ClientGroup", rs.CLIENT_GROUPID, null, 
                           "N9_A9_ContrGroup", rs.CONTR_GROUPID, null, 
                           "N9_A9_StrategyId", "", null, 
                           "N9_A9_KindTO", rs.KIND, null, 
                           "N9_A9_SubKind", rs.SUBKIND, null, 
                           "N9_A9_KindRepo", IIF(rs.KINDREPO == 0, "", rs.KINDREPO), null, 
                           "N9_A9_ShortName", ShortName, null, 
                           "N9_A9_LastName", LastName, null, 
                           "N9_A9_FirstName", FirstName, null, 
                           "N9_A9_PatrName", PatrName, null, 
                           "N9_A9_INN", IIF(INN == "Undefined", "", INN), null, 
                           "N9_A9_TIN", TIN, null, 
                           "N9_A9_CostRub", rs.CostRub, null);
	          if(m_InDelta)
              m_DeltaReport.PrintLinePart9(rs.CLIENT_GROUPID, rs.CONTR_GROUPID, "", rs.KIND, rs.SUBKIND, IIF(rs.KINDREPO == 0, "", rs.KINDREPO), ShortName, LastName, FirstName, PatrName, INN, TIN, rs.CostRub);
            end;			 
          end;
	        if(m_InDelta)
            m_DeltaReport.EndPart9();
          end;
          m_IsDataExist = true;
        end;

        EndTable();
        CopyAllSheetInTotalBook("Раздел 9", false, GetTableRange(), 0, "Раздел 9");  
      end; //9

      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_11))
        SetActiveSheet( "Раздел 11" );
        CopyAllSheetInTotalBook( "Раздел 11", false, "N11_HEADER_11", 1, "Раздел 11" );
        CopyAllSheetInTotalBook( "Раздел 11", false, "N11_TABLEHEADER_11", 1, "Раздел 11" );

        RegisterTable("N11_MainTable_11", "",
                      "N11_A11_ClientGroup", "N11_A11_ContrGroup", "N11_A11_StrategyId", "N11_A11_MetCode", "N11_A11_CostRub");

        Query = "select * from ( "
              + "  select d.t_contr_groupid, "
              + "         d.t_client_groupid, "
              + "         f.t_iso_number, "
              + "         nvl(sum(d.t_rest_rub), 0) t_rest_rub "
              + "    from d724_metall_details d "
              + "    join dfininstr_dbt f on f.t_fiid = d.t_fiid "
              + "   group by d.t_contr_groupid, "
              + "            d.t_client_groupid, "
              + "            f.t_iso_number "
              + " ) "
              + " where t_rest_rub != 0 "
              + " order by t_contr_groupid, "
              + "          t_client_groupid, "
              + "          t_iso_number ";

        Select = DL_RSDCommand(Query);

        rs = Select.execute();

        if(m_InDelta)
          m_DeltaReport.BeginPart11(); 
        end;
        while ( rs.MoveNext() )
          PrintTableLine("N11_A11_ClientGroup", rs.client_groupid, null,
                         "N11_A11_ContrGroup",  rs.contr_groupid,  null,
                         "N11_A11_StrategyId",  "",                null,
                         "N11_A11_MetCode",     rs.iso_number,     null,
                         "N11_A11_CostRub",     rs.rest_rub,       null);
          m_IsDataExist = true;

          if(m_InDelta)
            m_DeltaReport.PrintLinePart11(rs.client_groupid, rs.contr_groupid, "", rs.iso_number, rs.rest_rub);
          end;
        end;

        if(m_InDelta)
          m_DeltaReport.EndPart11();
        end;
        EndTable();
        CopyAllSheetInTotalBook("Раздел 11", false, GetTableRange(), 0, "Раздел 11");
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_COST_METALL);
        end;
      end; //11

      if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1_3) or (m_Chapter == CHAPTER_9))
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, DETAIL_RQ);
        end;
      end;

   
      RemProgress();
      Count = 0;

	  
      if(m_InDelta)
        m_DeltaReport.EndData724();
      end;
	  
      if((m_InDelta) and (not m_IsDataExist))
        m_DeltaReport.NoData();
      end;

      if(m_InDelta)
        m_DeltaReport.PrintProtocol();
      end;
      
    end;

    if(m_InDelta)
      if(m_DeltaReport.CreateXMLFile())
        msgbox("Создан файл ..\\txtfile\\" + m_DeltaReport.GetFileName());
      else
        msgbox("Ошибка выгрузки в Delta");
      end;
	  var delta_file_name_term = "$" + SC_GetFullPath(true) + m_DeltaReport.GetFileName();
      if(ExistFile(delta_file_name_term))
        RemoveFile(delta_file_name_term);
      end;
      if (not copyFile(m_DeltaReport.GetFileName(),delta_file_name_term,true,"Копирование на терминал"))
        msgbox("Ошибка при копировании " + m_DeltaReport.GetFileName() + " на терминал");
      else
        RemoveFile(m_DeltaReport.GetFileName());
      end;
    end; 

    var ProtocolSelect = DL_RSDCommand("SELECT DISTINCT t_Message FROM DARNUREPERR_DBT WHERE t_SessionID = ?");
    ProtocolSelect.AddParam(SessionID);
    var ProtocolDS = ProtocolSelect.execute();
    while(ProtocolDS.MoveNext())
      msgbox(ProtocolDS.Message);
    end;
//    sql_execute("DELETE FROM DARNUREPERR_DBT WHERE t_SessionID = " + string(SessionID));


    //cmd = RsdCommand("{call rsb_dl724rep_2024.ClearTables(?)}");
    //cmd.addParam( "pSessionId", RSDBP_IN, SessionID );
    //cmd.execute();
    msgbox("Номер сессии: " + SessionID);

  END;

  MACRO Create()
    SetXLSXFormat();
    ExecuteReport();
  END;

  MACRO EndReport()
    SaveTotalbook();
  END;

  macro GetAuditMsg(panel:DL_CPanel):String
    var msg:string = "";
    var period:string = "";
    var deals1:string = "";
    var deals2:string = "";

    period = PeriodName_GetMonthsAndQuart(
                panel.GetFieldValue(PNFLD_FORM724_PERIOD),
                panel.GetFieldValue(PNFLD_FORM724_YEAR));

    deals1 = IIF(panel.GetFieldValue(PNFLD_FORM724_ISSECUR) == "X",
                 "Модуля \"Бэк-офис ценных бумаг\"\n",
                 "");

    deals2 = IIF(panel.GetFieldValue(PNFLD_FORM724_ISDV) == "X",
                 "Модуля \"ФИСС и КО\"\n",
                 "");

    msg =
    "Отчет:              Сведения об осуществлении брокерской деятельности и деятельности по управлению ценными бумагами (ф.724)\n\n" +
    "Отчет за:           " + period + "\n" +
    "По договорам:\n"  +
    deals1 + deals2 + 
    "\n----------------------------------------\n";

    return msg;
  end;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, USEBIGREPORTMODE );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)

  var stat = true;
  var FullReportFileNames = TArray();

  if( not IsWebService )
    Form724 = DLReport724_Form();
  end;

  while( stat )
    if( not IsWebService )
      stat = Form724.Run();
    end;

    if( stat )
      Report724 = DlReport724( null, "Report_724_2024.xlsx", null, IsWebService, ReportHashCode, POI_MODE, USEBIGREPORTMODE );
      Report724.Run(null, Report724.GetAuditMsg(Form724));

      if( IsWebService )
        Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = Report724.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
      end;
    end;
  end;

  return FullReportFileNames;
END;

ReportRunEx(false);
