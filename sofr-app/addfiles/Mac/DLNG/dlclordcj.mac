/**
 @file 		mac\dlng\dlclordcj.mac
 @brief 	Отчет "Журнал регистрации поручений клиента" Общий для БО, ПИ и УВ

 # tag
 - functional_block: Отчетность_внутренняя
 - code_type: Report
 - code_type:GUI

 #menu 
  - БО ЦБ\ Внутренний учет \ Отчеты \ Поручения и операции клиентов \ Журнал регистрации поручений клиентов

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |19.05.2025 |Велигжанин А.В.|DEF-90095                                       |Вернул шаблон xls, так как шаблон xlsx работает неверно

*/
IMPORT SFInter, DealsInter, "dlmisc.mac", DVInter, "dlclordcj_Form.mac", "or_rep_h.mac", "cblogger.mac", "spRepFn2.mac";

private record sfcontr(sfcontr);
private var Data, m_Form = DL_ClOrdRegRep_Panel();

PRIVATE CONST POI_MODE = TRUE;  //DEF-37340

private const
   SECDEAL    = 1, /*Поручения клиентов на сделки/операции*/
   DLACCVAL   = 2, /*Поручения клиентов по денежным средствам*/
   DLACCSC    = 3, /*Поручения клиентов по ценным бумагам*/
   SECDEAL_DV = 4, /* Golovkin Поручения клиентов на сделки/операции срочного рынка*/ 
   SECDEAL_CM = 5; /* KS Поручения клиентов на сделки/операции валютного рынка*/ 
    

private var NameOrder = Tarray();

NameOrder[SECDEAL]    = "Журнал регистрации поручений(требований) клиентов № 5";
NameOrder[DLACCVAL]   = "Поручения клиентов по денежным средствам";
NameOrder[DLACCSC]    = "Поручения клиентов по ценным бумагам";
NameOrder[SECDEAL_DV] = "Журнал регистрации поручений(требований) клиентов № 4";
NameOrder[SECDEAL_CM] = "Журнал регистрации поручений(требований) клиентов № 6";

PRIVATE CONST Registry_METHODAPPLIC_PDOC = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\TRADER_CODE_PREFIX_PDOC"; 
PRIVATE CONST Registry_METHODAPPLIC_VMES = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\TRADER_CODE_PREFIX_VMES"; 
var PREFIX_PDOC ="",PREFIX_VMES="" ;

private MACRO fixdate(par);
  var s = trim(string(par));
  if (strlen(s)<10)
    s = "0" + s;
  end;
  return s;
end;

class ClOrdRegRepData( _ReportKind, _DealID, _DocNum, _DocDate, _DocTime, _ClientID, _ContrID, _Oper, _OperType, _DealChangeInfo, _Status, _Amount, _Price, _PriceName, _FICode, _MethodApplic, _DealTypeName, _DealCode, _FIID, _point)
  var DocTime        = _DocTime,
      DocDate        = _DocDate, 
      DocNum         = _DocNum, 
      ReportKind     = _ReportKind,/*вид отчета*/
      DealID         = _DealID,
      OperType       = _OperType,/*Вид операции*/
      /*параметры проводок, для сделок это все вынимается из самих сделок*/
      ClientID       = _ClientID,
      ContrID        = _ContrID,
      Oper           = _Oper,
      DealChangeInfo = _DealChangeInfo, /*Изменения по сделке*/
      Status         = _Status, // Информация об исполнении поручения
      Amount         = _Amount,
      Price          = _Price,
      PriceName      = _PriceName,
      FICode         = _FICode,
      MethodApplic   = _MethodApplic,
      DealTypeName   = _DealTypeName,
      DealCode       = _DealCode,
      FIID           = _FIID,
      point          = _point;
end;

/* Структура с исходными данными */
class ClOrdRegData( _ClientID:integer, _IsFormID:integer, _FormSubID:integer, _IsVidID:integer, _VidSubID:integer, _NoResident:bool, 
                    _BO:bool, _DV:bool, _VA:bool, _CM:bool, _ContrID:integer, _OrdDeal:bool, _PlaceExec:integer, _SourceFIkind:integer, _IsPFIKind:string, _PFIKind:integer,
                    _OrdVal:bool, _OrdSec:bool, _dateMin:date, _dateMax:date, _IsToExcel:bool  )
  var ClientID         = _ClientID,
      IsForm           = _IsFormID,
      FormSub          = _FormSubID,
      IsVid            = _IsVidID,
      VidSub           = _VidSubID,
      NoResident       = _NoResident,
      BO               = _BO,
      DV               = _DV,
      VA               = _VA,
      CM               = _CM,
      ContrID          = _ContrID,
      OrdDeal          = _OrdDeal,
      PlaceExec        = _PlaceExec,
      SourceFIkind     = _SourceFIkind,
      IsPFIKind        = _IsPFIKind,
      PFIKind          = _PFIKind,
      OrdVal           = _OrdVal,
      OrdSec           = _OrdSec,
      dateMin          = _dateMin,
      dateMax          = _dateMax,
      IsToExcel        = _IsToExcel,
      ReportData       = TArray(),
      ArrCntOrdByDeals = TArray(), /* Массив с количеством поручений по сделкам. */
      CurDate;
end;

macro GetStatusReq( reqid:integer ):string
  var RetVal:string = "";
  var Req = TRecHandler("dl_req.dbt");

  var sqlQuery = "", sqlData;

  sqlQuery = RSDCommand( " select req.*           " +
                         "   from ddl_req_dbt req " +
                         "  where  req.t_ID = ?   ");

  sqlQuery.addParam("", RSDBP_IN, reqid);
  sqlQuery.execute();

  sqlData = TRsbDataSet(sqlQuery);
  if( sqlData.MoveNext() )
     sqlData.GetRecord().CopyTo(Req.rec);
     RetVal = DL_GetNameAlg(ALG_DL_REQ_ORDERSTATUS, DL_GetOrderStatus(Req));
  end;

  return RetVal;
end;

macro cmpData( key, elem )
  /*Golovkin сортируем данные по виду отчета и времени*/
  if(key.ReportKind > elem.ReportKind)
     return 1;
  end;
  if(key.ReportKind < elem.ReportKind)
     return -1;
  end;
  if(key.ReportKind = elem.ReportKind)
     if( key.DocTime > elem.DocTime )
        return 1;
     end;
     if( key.DocTime < elem.DocTime )
        return -1;
     end;
     if( key.DocTime == elem.DocTime )
       // KS 18.06.2019 по просьюе Радионовой сортировка по DealCode
       if ((Valtype(key.DealCode)!=0)and(Valtype(elem.DealCode)!=0))
         if( key.DealCode > elem.DealCode )
            return 1;
         end;
         if( key.DealCode < elem.DealCode )
            return -1;
         end;
       end;

       // Golovkin 20.08.2019 ID : 493172 сортировка по номеру поручения
       if ((Valtype(key.DocNum)!=0)and(Valtype(elem.DocNum)!=0))
         if( key.DocNum > elem.DocNum )
            return 1;
         end;
         if( key.DocNum < elem.DocNum )
            return -1;
         end;
       end;
     end;
  end;
  return 0;
end;

PRIVATE MACRO GetDataFromFormFields()
  Data = ClOrdRegData( m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ClientCode ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ISFORM ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_FORMSUB ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ISVID ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_VIDSUB ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_NORESIDENT ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_IsBO ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_IsDV ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_IsVA ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_IsCM ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_Contr ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_Deal ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_PLACEEXEC ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_SOURCEFIKIND ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_CH_PFIKIND ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_PFIKIND ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_Val ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_ORDER_Sec ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_BegDate ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_EndDate ),
                       m_Form.GetFieldValue( PNFLD_DLCLORDCJ_IsExportToExel ) );
END;

PRIVATE VAR TableHeader =
                "┌──────────┬─────────┬─────────────┬─────────────────────┬────────────────────┬───────────────┬──────────┬──────────────────────┬──────────────────────┬──────────────┬─────────────┬────────────────┬─────────────────────────┬─────────────────────┐\n"+
                "│   Дата   │  Время  │   Способ    │          №          │      Клиент        │       №       │   Дата   │    Информация об     │      Вид операции    │  Количество  │    Цена     │  Валюта цены   │  Отметки об изменениях  │   Уполномоченный    │\n"+
                "│поручения │ приема  │   подачи    │      поручения      │                    │    договора   │ договора │ исполнении поручения │                      │              │             │                │                         │ сотрудник брокера / │\n"+
                "│          │поручения│             │                     │                    │               │          │                      │                      │              │             │                │                         │    Наименование     │\n"+
                "│          │         │             │                     │                    │               │          │                      │                      │              │             │                │                         │ электронной системы │\n"+
                "├──────────┼─────────┼─────────────┼─────────────────────┼────────────────────┼───────────────┼──────────┼──────────────────────┼──────────────────────┼──────────────┼─────────────┼────────────────┼─────────────────────────┼─────────────────────┤";

PRIVATE VAR ReportHeader =
"                           Журнал регистрации поручений клиентов\n" +
"                                      за ##########\n";
 
 
 
 MACRO ConvertToISO():string

    var code;
    getparm(0,code)  ;
    if((valtype(code)==v_integer)and (code==0))
        return 640;
    elif ((valtype(code)==V_STRING)and (code=="RUR"))
        var sql = RSDCommand( " select t_isocode " +
                              "   from disocur_dbt " +
                              "  where t_numbercode    = 643"  );
        sql.execute();
        var DataSet = TRsbDataSet(sql);
        if( DataSet.MoveNext() )
            return  DataSet.isocode;
        end;
    else
        return code;
    end;
end;

PRIVATE CLASS CTransCentr( Report:OBJECT )
  VAR m_Report = Report;
  
  MACRO BeginRepTab()
    
     m_Report.PrintFormatString( "\n#\n",
                                "N1_A1" , m_Report.RepName());  

     LogIt("BeginRepTab: "+m_Report.m_SheetName);
     m_Report.CopyAllSheetInTotalBook( null, false, "N1_TableHeader", 1, m_Report.m_SheetName, true );

     m_Report.RegisterTable( "N1_MainTable", NULL,
                             "N1_A2_1",
                             "N1_T1",
                             "N1_M1",
                             "N1_A2",
                             "N1_A3",  
                             "N1_A4",  
                             "N1_A3_1", 
                             "N1_A9", 
                             "N1_A5",
                             "N1_Fl",
                             "N1_N1",
                             "N1_S1",
                             "N1_S2",
                             "N1_A6",
                             "N1_A7");      
  END;

  MACRO ПечататьСтрокуТаблицы()

        m_Report.PrintTableLine( "N1_A2_1",  fixdate(m_Report.OrderDate()), null,
                                 "N1_T1",  m_Report.OrderTime(),         null,
                                 "N1_M1",  m_Report.OrderDeliveryKind(), null,
                                 "N1_A2",  m_Report.OrderNum(),          null,
                                 "N1_A3",  m_Report.ClientName(),        null,
                                 "N1_A4",  m_Report.ContrNum(),          null,
                                 "N1_D3_1",  m_Report.ContrDate(),         null,
                                 "N1_A9",  m_Report.Status(),            null,
                                 "N1_A5",  m_Report.OperType(),          null,
                                 "N1_Fl",  m_Report.FICode(),            null,
                                 "N1_N1",  m_Report.Amount(),            null,
                                 "N1_S1",  m_Report.Price(),             null,
                                 "N1_S2",  ConvertToISO(m_Report.PriceName()),         null,
                                 "N1_A6",  m_Report.DealChanges(),       null,
                                 "N1_A7",  m_Report.Oper(),              null
                               );
  END;

  /*Golovkin для отчета Поручения клиентов на сделки с ц/б*/
  MACRO BeginRepTab_BO()
    
     m_Report.PrintFormatString( "\n#\n", "N1_C1" , m_Report.RepName());

     LogIt("BeginRepTab_BO: "+m_Report.m_SheetName);
     m_Report.CopyAllSheetInTotalBook( null, false, "N1_TableHeader3", 1, m_Report.m_SheetName, true );

     m_Report.RegisterTable( "N1_MainTable3", NULL,
                             "N1_C2",
                             "N1_C3",
                             "N1_C4",
                             "N1_C5",
                             "N1_C6",  
                             "N1_C7",  
                             "N1_C8", 
                             "N1_C9");      
  END;

  MACRO ПечататьСтрокуТаблицы_BO()
        m_Report.PrintTableLine( "N1_C2",  m_Report.OrderNum(),                    null,
                                 "N1_C3",  fixdate(m_Report.OrderDate()),          null,
                                 "N1_C4",  m_Report.OrderTime(),                   null,
                                 "N1_C5",  m_Report.ClientName(),                  null,
                                 "N1_C6",  m_Report.ContrNum()+" от "+m_Report.ContrDate(),null,
                                 "N1_C7",  m_Report.OrderDeliverySystem(),         null,
                                 "N1_C8",  m_Report.Status(),                      null,
                                 "N1_C9",  m_Report.OrderDeliveryKind(),           null
                               );
  END;

  /*Golovkin для отчета Поручения клиентов на срочном рынке*/
  MACRO BeginRepTab_DV()
    
     m_Report.PrintFormatString( "\n#\n", "N1_B1" , m_Report.RepName());

     LogIt("BeginRepTab_DV: "+m_Report.m_SheetName);
     m_Report.CopyAllSheetInTotalBook( null, false, "N1_TableHeader2", 1, m_Report.m_SheetName, true );

     m_Report.RegisterTable( "N1_MainTable2", NULL,
                             "N1_B2",
                             "N1_B3",
                             "N1_B4",
                             "N1_B5",
                             "N1_B6",  
                             "N1_B7",  
                             "N1_B7_2",  
                             "N1_B8", 
                             "N1_B9",
                             "N1_B10",
                             "N1_B11",
                             "N1_B12");      
  END;

  MACRO ПечататьСтрокуТаблицы_DV()
        m_Report.PrintTableLine( "N1_B2",  m_Report.OrderNum()+" ",                null,
                                 "N1_B3",  fixdate(m_Report.OrderDate()),          null,
                                 "N1_B4",  m_Report.OrderTime(),                   null,
                                 "N1_B5",  m_Report.ClientName(),                  null,
                                 "N1_B6",  m_Report.Oper(),                        null,
                                 "N1_B7",  m_Report.OrderDeliveryKind(),           null,
                                 "N1_B7_2",m_Report.OrderDeliverySystem(),         null,// KS 25.06.2019
                                 "N1_B8",  m_Report.DealCode()+" ",                null,
                                 "N1_B9",  m_Report.ContrNumDV(),                  null,
                                 "N1_B10", m_Report.Price(),                       m_Report.Point(),
                                 "N1_B11", m_Report.Amount(),                      null,
                                 "N1_B12", m_Report.DealTypeName(),                null
                               );
  END;



  /*KS для отчета Поручения клиентов на валютном рынке*/
  MACRO BeginRepTab_CM()
    
     m_Report.PrintFormatString( "\n#\n", "N1_D" , m_Report.RepName());

     LogIt("BeginRepTab_CM: "+m_Report.m_SheetName);
     m_Report.CopyAllSheetInTotalBook( null, false, "N1_TableHeader4", 1, m_Report.m_SheetName, true );

     m_Report.RegisterTable( "N1_MainTable4", NULL,
                             "N1_D2",
                             "N1_D3",
                             "N1_D4",
                             "N1_D5",
                             "N1_D6",  
                             "N1_D7",  
                             "N1_D7_2",  
                             "N1_D8", 
                             "N1_D9",
                             "N1_D10",
                             "N1_D11",
                             "N1_D12",
                             "N1_D13");
  END;

  MACRO ПечататьСтрокуТаблицы_CM()
        m_Report.PrintTableLine( "N1_D2",  m_Report.OrderNum(),                    null,
                                 "N1_D3",  fixdate(m_Report.OrderDate()),          null,
                                 "N1_D4",  m_Report.OrderTime(),                   null,
                                 "N1_D5",  m_Report.ClientName(),                  null,
                                 "N1_D6",  m_Report.Oper(),                        null,
                                 "N1_D7",  m_Report.OrderDeliveryKind(),           null,
                                 "N1_D7_2",m_Report.OrderDeliverySystem(),         null,
                                 "N1_D8",  m_Report.DealCode(),                    null,
                                 "N1_D9",  m_Report.ContrNumDV(),                  null,
                                 "N1_D10", m_Report.Price(),                       m_Report.Point(),
                                 "N1_D11", m_Report.Amount(),                      null,
                                 "N1_D12", m_Report.DealTypeName(),                null,
                                 "N1_D13", m_Report.Status(),                      null
                               );
  END;

  MACRO PrintRepFooter() 
     LogIt("PrintRepFooter() "+m_Report.m_SheetName);
     m_Report.AddStandardFooter( "N1_" );
     m_Report.CopyAllSheetInTotalBook( null, false, "N1_Footer", 1, m_Report.GetLastSheetName(), true );
  END;


  MACRO EndReportTab()
      m_Report.EndTable();
      LogIt("EndReportTab() "+m_Report.m_SheetName);
      m_Report.CopyAllSheetInTotalBook( null, false, m_Report.GetTableRange(), 0, m_Report.m_SheetName, true );      
  END;
END;

PRIVATE CLASS (DL_CReportTemplate) DL_ClOrdRegRep_Tmp
  PRIVATE VAR IsExistsData = false;
  PRIVATE VAR IsFirstUse = true;

  /* DEF-44748, при выводе данных за полгода (или больше) записи могут
     не поместиться на одну вкладку Excel,
     поэтому, во избежание ошибок, нужно отслеживать кол-во записей, 
     которое отображается на вкладке, и добавлять вкладки по необходимости.
     Велигжанин А.В.
  */
  PRIVATE VAR m_SheetLen = 0; /* счетчик записей на вкладке */
  VAR m_SheetName: string = "ЖУРНАЛ РЕГИСТРАЦИИ ПОРУЧЕНИЙ КЛ"; /* наименование текущей вкладки */
  VAR m_SheetInd = 0; /* индекс вкладки */

  PRIVATE MACRO isOnlyBO()
    return (( Data.BO == "X" ) and
            ( Data.VA != "X" ) and
            ( Data.DV != "X" ) and
            ( Data.CM != "X" )) or
           ((Data.ClientID == -1) and // KS непонятно ведёт себя Data.VA - устанавливается, когда сбрасывают клиента. TODO - SetServKind в dlclordcj_form.mac
            ( Data.BO == "X" ) and
            ( Data.CM != "X" ) and
            ( Data.DV != "X" ));
  end;

  PRIVATE MACRO isOnlyDV()
    return (( Data.BO != "X" ) and
            ( Data.VA != "X" ) and
            ( Data.DV == "X" ) and
            ( Data.CM != "X" )) or
           ((Data.ClientID == -1) and // KS непонятно ведёт себя Data.VA - устанавливается, когда сбрасывают клиента. TODO - SetServKind в dlclordcj_form.mac
            ( Data.BO != "X" ) and
            ( Data.CM != "X" ) and
            ( Data.DV == "X" ));
  end;

  PRIVATE MACRO isOnlyCM()
    return (( Data.BO != "X" ) and
            ( Data.VA != "X" ) and
            ( Data.DV != "X" ) and
            ( Data.CM == "X" ));
  end;

  PRIVATE MACRO isOnlyOne()
    return ((isOnlyBO()) or (isOnlyDV()) or (isOnlyCM()));
  end;

  PRIVATE MACRO PrintMode():INTEGER 
     if( Data.IsToExcel == "X" )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end; 
  END;

  PRIVATE MACRO BeginReport()
     Dl_CallInsertStat(PrintMode());
     CreateTotalBook();
     SetActiveSheet( "ЖУРНАЛ РЕГИСТРАЦИИ ПОРУЧЕНИЙ КЛ" );
  END;

  PRIVATE MACRO PrintRepHeader()
     var PastePos;

     if (isOnlyOne())
       PrintFormatString( ReportHeader, "N1_D1", fixdate(Data.dateMin) + " - " + fixdate(Data.dateMax) );
     else
       PrintFormatString( ReportHeader, "N1_D1", Data.CurDate );
     end;

     if( IsFirstUse )
        PastePos = 0;/*отступ сверху не нужен*/
        IsFirstUse = false;
     else
        PastePos = 2;
     end;

     LogIt("PrintRepHeader() "+m_SheetName);
     CopyAllSheetInTotalBook( null, false, "N1_RepHeader", PastePos, m_SheetName, true );
  END;

  PRIVATE MACRO EndReport();
     SaveTotalBook();
  END;         

  PRIVATE MACRO ПолучитьПорученияПИ(ServKinds)
     var sqlQuery = "", sqlQueryOrder, DV_Orders;
     var ReqStatus:string = "";

     if( ((Data.PlaceExec <= 0) or (Data.PlaceExec == DLCLORDCJ_PLACEEXEC_EXCHANGE)) and
         (Data.PFIKind != DLCLORDCJ_PFIKIND_FORWARD)
       )
         
       sqlQuery = sqlQuery + "SELECT Req.t_Client ClientID, " +
                             "       Req.t_ClientContr ContrID, " +
                             "       SpGround.T_REGISTRDATE OrderDate," +
                             "       SpGround.T_REGISTRTIME OrderTime," + 
                             "       Req.t_Codets OrderNum, " +                    
                             "       (SELECT replace(utl_raw.cast_to_varchar2(n.t_text),'/tr','tr') FROM dnotetext_dbt n where n.t_objecttype = 149 and n.t_notekind = 102 and n.t_documentid = lpad(Req.t_Id,34,'0') and n.t_ValidToDate = to_date('31.12.9999','dd.mm.yyyy')) Oper, "
                             "       NVL(DVDeal.t_Amount, Req.t_Amount) Amount," +
                             "       (CASE WHEN Req.T_PRICETYPE = 2 THEN (Req.T_PRICE * RSB_FIInstr.FI_GetNominalOnDate(Req.t_FIID, Req.t_Date) / 100) "+
                             "             ELSE Req.T_PRICE "+
                             "         END) Price, " +  
                             "       (CASE WHEN DVDeal.t_Type IS NOT NULL THEN DECODE(DVDeal.t_Type, 'B', 'Покупка', 'S', 'Продажа', '') " +          
                             "             ELSE (SELECT t_sznamealg FROM dnamealg_dbt WHERE t_itypealg = 3168 and t_inumberalg = Req.t_Direction) " +
                             "         END) DealTypeName, " + 
                             "       NVL(DVDeal.t_ExtCode, '') DealCode, " +
                             "       Req.t_FIID, " +
                             "       Req.t_MethodApplic, " +
                             "       NVL(DVDeal.t_point, 4) Point, " +
                             "       SfContr.T_ServKind, " +
                             "       Req.t_ID " +
                             "  FROM ddl_req_dbt Req " + 
                             " INNER JOIN dparty_dbt Pty " +
                             "    ON Pty.t_PartyID = Req.t_Client " +
                             " INNER JOIN dsfcontr_dbt SfContr " +
                             "    ON SfContr.t_ID = Req.t_ClientContr AND SfContr.T_ServKind IN " + ServKinds + 
                             " INNER JOIN dspgrdoc_dbt SpGrReq " + 
                             "    ON SpGrReq.t_SourceDocKind = Req.t_Kind AND SpGrReq.t_SourceDocID = Req.t_ID " + 
                             " INNER JOIN dspground_dbt SpGround " +
                             "    ON SpGround.T_SpGroundID = SpGrReq.T_SpGroundID AND SpGround.t_Kind = 251 AND SpGround.t_RegistrDate = ? " + 
                             "  LEFT JOIN dspgrdoc_dbt SpGrDoc " +
                             "    ON SpGround.T_SpGroundID = SpGrDoc.T_SpGroundID AND SpGrReq.t_SourceDocID <> SpGrDoc.t_SourceDocID AND SpGrReq.t_SourceDocKind <> SpGrDoc.t_SourceDocKind " +
                             "  LEFT JOIN ddvdeal_dbt DVDeal " +
                             "    ON SpGrDoc.t_SourceDocID = DVDeal.t_ID AND SpGrDoc.t_SourceDocKind = " + DL_DVDEAL + " and DVDeal.T_IsTrust <> 'X' " +
                             " WHERE Req.t_Client <> -1 " +
                             "   AND Req.t_SourceKind = " + DL_DVDEAL;  

        if(Data.ClientID > -1)
          sqlQuery = sqlQuery + " AND Req.t_Client = ? ";
        end;

        if(Data.ContrID > 0)
          sqlQuery = sqlQuery + " AND Req.t_ClientContr = ? ";
        end;

        if( Data.SourceFIkind > 0 )
          sqlQuery = sqlQuery + " AND EXISTS (select 1 from dfininstr_dbt BaseFI " +
                                "              where BaseFI.T_FIID = ( case when NVL((select BaseFinFut.t_FI_KIND from dfininstr_dbt BaseFinFut " +
                                 "                                                     where BaseFinFut.t_FIID = ContrFI.T_FACEVALUEFI),0) = " + FIKIND_DERIVATIVE +
                                 "                                          then NVL((select BaseFIN.t_FACEVALUEFI from dfininstr_dbt BaseFIN " +
                                 "                                                     where BaseFIN.t_FIID = ContrFI.T_FACEVALUEFI),-1) " +
                                 "                                          else ContrFI.T_FACEVALUEFI end ) " +
                                 "               and ? = ( case when BaseFI.T_FI_KIND = " + FIKIND_INDEX +
                                 "                              then (case when BaseFI.T_FACEVALUEFI = -1 then BaseFI.T_FI_KIND " +
                                 "                                         else Nvl((select BaseFI2.T_FI_KIND " +
                                 "                                                     from dfininstr_dbt BaseFI2 " +
                                 "                                                    where BaseFI2.T_FIID = BaseFI.T_FACEVALUEFI),0) " +
                                 "                                     end) " +
                                 "                              else BaseFI.T_FI_KIND end )) ";
        end;

        if( (Data.IsForm > 0) and (Data.FormSub != 0) )
          if(Data.IsForm == 1)
            sqlQuery = sqlQuery + " AND Pty.T_LEGALFORM = " + String (Data.FormSub);
          end;
          if(Data.IsForm == 2)            
            sqlQuery = sqlQuery + " AND Pty.T_LEGALFORM != " + String (Data.FormSub);
          end;
        end;
       
        if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
          if(Data.IsVid == 1)                           
            sqlQuery = sqlQuery + " AND EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID) ";
          end;
          if(Data.IsVid == 2)             
            sqlQuery = sqlQuery + " AND NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID) ";
          end;
        end;
      
        if(Data.NoResident)
          sqlQuery = sqlQuery + " AND Pty.T_NOTRESIDENT = 'X' ";
        end;

        if( Data.IsPFIKind == "X" )
          sqlQuery = sqlQuery + " AND Req.t_PFIKind > 0 ";
        end;
      
        if( Data.PFIKind > 0 )
          if( Data.PFIKind == DLCLORDCJ_PFIKIND_OPTION )
            sqlQuery = sqlQuery + " AND Req.t_PFIKind IN (2, 3) ";
          elif( Data.PFIKind == DLCLORDCJ_PFIKIND_FUTURES )
            sqlQuery = sqlQuery + " AND Req.t_PFIKind = 1 ";
          end;
        end;
     end;

     if( ((Data.PlaceExec <= 0) or (Data.PlaceExec == DLCLORDCJ_PLACEEXEC_OUTEXCHANGE)) and
         (Data.PFIKind != DLCLORDCJ_PFIKIND_FUTURES)
       )

        if( sqlQuery != "" )
           sqlQuery = sqlQuery + " union all ";
        end;
        //SVE 513835 06.08.2020 данные для полей цена/количество необходимо брать из самой сделки, а не заявки-поручения так как по одной заявке может быть сформировано больше одной сделки
       sqlQuery = sqlQuery + "SELECT Req.t_Client ClientID, " +
                             "       Req.t_ClientContr ContrID, " +
                             "       SpGround.T_REGISTRDATE OrderDate," +
                             "       SpGround.T_REGISTRTIME OrderTime," + 
                             "       Req.t_Codets OrderNum, " +                    
                             "       (SELECT replace(utl_raw.cast_to_varchar2(n.t_text),'/tr','tr') FROM dnotetext_dbt n where n.t_objecttype = 149 and n.t_notekind = 102 and n.t_documentid = lpad(Req.t_Id,34,'0') and n.t_ValidToDate = to_date('31.12.9999','dd.mm.yyyy')) Oper, "
                             "       NVL(nfi.t_Amount, Req.t_Amount) Amount," +
                             "       (CASE WHEN Req.T_PRICETYPE = 2 THEN (Req.T_PRICE * RSB_FIInstr.FI_GetNominalOnDate(Req.t_FIID, Req.t_Date) / 100) "+
                             "             ELSE Req.T_PRICE "+
                             "         END) Price, " +   
                             "       (CASE WHEN DVDeal.t_Type IS NOT NULL THEN (SELECT t_sznamealg FROM dnamealg_dbt WHERE t_itypealg = 7004 and t_inumberalg = DVDeal.t_Type) " +          
                             "             ELSE (SELECT t_sznamealg FROM dnamealg_dbt WHERE t_itypealg = 3168 and t_inumberalg = Req.t_Direction) " +
                             "         END) DealTypeName, " + 
                             "       NVL(decode(SfContr.T_ServKind, " + PTSK_CM + ", DVDeal.t_Code, DVDeal.t_ExtCode), '') DealCode, " +
                             "       Req.t_FIID, " +
                             "       Req.t_MethodApplic, " +
                             "       decode(SfContr.T_ServKind, " + PTSK_CM + ", 4, 0) Point, " +
                             "       SfContr.T_ServKind, " +
                             "       Req.t_ID " +
                             "  FROM ddl_req_dbt Req " + 
                             " INNER JOIN dparty_dbt Pty " +
                             "    ON Pty.t_PartyID = Req.t_Client " +
                             " INNER JOIN dsfcontr_dbt SfContr " +
                             "    ON SfContr.t_ID = Req.t_ClientContr AND SfContr.T_ServKind IN " + ServKinds + 
                             " INNER JOIN dspgrdoc_dbt SpGrReq " + 
                             "    ON SpGrReq.t_SourceDocKind = Req.t_Kind AND SpGrReq.t_SourceDocID = Req.t_ID " + 
                             " INNER JOIN dspground_dbt SpGround " +
                             "    ON SpGround.T_SpGroundID = SpGrReq.T_SpGroundID AND SpGround.t_Kind = 251 AND SpGround.t_RegistrDate = ? " + 
                             "  LEFT JOIN dspgrdoc_dbt SpGrDoc " +
                             "    ON SpGround.T_SpGroundID = SpGrDoc.T_SpGroundID AND SpGrReq.t_SourceDocID <> SpGrDoc.t_SourceDocID AND SpGrReq.t_SourceDocKind <> SpGrDoc.t_SourceDocKind " +
                             "  LEFT JOIN ddvndeal_dbt DVDeal " +
                             "    ON SpGrDoc.t_SourceDocID = DVDeal.t_ID AND SpGrDoc.t_SourceDocKind = DVDeal.t_DocKind and DVDeal.T_IsTrust <> 'X' " +
                             "  LEFT JOIN ddvnfi_dbt nfi " +
                             "    ON nfi.t_DealID = DVDeal.t_ID AND nfi.t_Type = 0 " + 
                             " WHERE Req.t_Client <> -1 " +
                             "   AND Req.t_SourceKind IN (" + DL_DVNDEAL + "," + DL_DVDEALT3 + "," + DL_DVFXDEAL + ") ";  

       if(Data.ClientID > -1)
         sqlQuery = sqlQuery + " AND Req.t_Client = ? ";
       end;

       if(Data.ContrID > 0)
         sqlQuery = sqlQuery + " AND Req.t_ClientContr = ? ";
       end;

       if( (Data.IsForm > 0) and (Data.FormSub != 0) )
         if(Data.IsForm == 1)
           sqlQuery = sqlQuery + " AND Pty.T_LEGALFORM = " + String (Data.FormSub) ;
         end;
         if(Data.IsForm == 2)            
           sqlQuery = sqlQuery + " AND Pty.T_LEGALFORM != " + String (Data.FormSub);
         end;
       end;
      
       if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
         if(Data.IsVid == 1)
           sqlQuery = sqlQuery + " AND EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + String(Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID) ";
         end;
         if(Data.IsVid == 2)          
           sqlQuery = sqlQuery + " AND NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + String(Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID) ";
         end;
       end;
      
       if(Data.NoResident)
         sqlQuery = sqlQuery + " AND Pty.T_NOTRESIDENT = 'X' "; 
       end;

       if( Data.IsPFIKind == "X" )
         sqlQuery = sqlQuery + " AND Req.t_PFIKind > 0 ";
       end;

       if( Data.PFIKind > 0 )
         if( Data.PFIKind == DLCLORDCJ_PFIKIND_OPTION )
           sqlQuery = sqlQuery + " AND Req.t_PFIKind IN (2, 3) ";
         elif( Data.PFIKind == DLCLORDCJ_PFIKIND_FORWARD )
           sqlQuery = sqlQuery + " AND Req.t_PFIKind = 4 ";
         end;
       end;

       if( Data.SourceFIkind > 0 )
          sqlQuery = sqlQuery + " AND EXISTS (select 1 from dfininstr_dbt BaseFI " +
                                "              where BaseFI.t_fiid = Req.t_FIID " +
                                "                and ? = ( case when BaseFI.T_FI_KIND = " + FIKIND_INDEX +
                                "                               then (case when BaseFI.T_FACEVALUEFI = -1 then BaseFI.T_FI_KIND " +
                                "                                          else Nvl((select BaseFI2.T_FI_KIND " +
                                "                                                      from dfininstr_dbt BaseFI2 " +
                                "                                                     where BaseFI2.T_FIID = BaseFI.T_FACEVALUEFI),0) " +
                                "                                      end) " +
                                "                               else BaseFI.T_FI_KIND end )) ";
       end;
     end;

     sqlQuery = sqlQuery + " ORDER BY T_ServKind, OrderTime, ClientID, ContrID;";

     sqlQueryOrder = RSDCommand(sqlQuery);

     if( (Data.PlaceExec <= 0) or (Data.PlaceExec == DLCLORDCJ_PLACEEXEC_EXCHANGE) )
       sqlQueryOrder.addParam("", RSDBP_IN, Data.CurDate);
       if(Data.ClientID > -1)
         sqlQueryOrder.addParam("", RSDBP_IN, Data.ClientID);
       end;
       if(Data.ContrID > 0)
         sqlQueryOrder.addParam("", RSDBP_IN, Data.ContrID);
       end;
       if( Data.SourceFIkind > 0 )
         sqlQueryOrder.addParam("", RSDBP_IN, Data.SourceFIkind);
       end;
     end;

     if( (Data.PlaceExec <= 0) or (Data.PlaceExec == DLCLORDCJ_PLACEEXEC_OUTEXCHANGE) )
       sqlQueryOrder.addParam("", RSDBP_IN, Data.CurDate);
       if(Data.ClientID > -1)
         sqlQueryOrder.addParam("", RSDBP_IN, Data.ClientID);
       end;
       if(Data.ContrID > 0)
         sqlQueryOrder.addParam("", RSDBP_IN, Data.ContrID);
       end;
       if( Data.SourceFIkind > 0 )
         sqlQueryOrder.addParam("", RSDBP_IN, Data.SourceFIkind);
       end;
     end;

     LogIt("ПолучитьПорученияПИ(), ServKinds = "+string(ServKinds)+", Date = "+string(Data.CurDate));

     sqlQueryOrder.execute();

     DV_Orders = TRsbDataSet(sqlQueryOrder);

     LogIt("Анализ дата-сета");

     while( DV_Orders.MoveNext() )
       if(DV_Orders.ServKind == PTSK_CM)
         ReqStatus = GetStatusReq(DV_Orders.ID);
     
         if( ReqStatus == "Отклонено" ) 
           ReqStatus = "Отменено";
         end;
       else
         ReqStatus = ""; //Не будем тратить время на получение статуса, т.к. он все равно не выводится
       end; 
    
       Data.ReportData[Data.ReportData.Size] = ClOrdRegRepData( IIF(DV_Orders.ServKind == PTSK_CM, SECDEAL_CM, SECDEAL_DV), null, DV_Orders.OrderNum, SQL_ConvTypeDate(DV_Orders.OrderDate), 
                                                                SQL_ConvTypeTime(DV_Orders.OrderTime), DV_Orders.ClientID, DV_Orders.ContrID, 
                                                                DV_Orders.Oper, "", "", ReqStatus, DV_Orders.Amount, DV_Orders.Price, "", "", 
                                                                DV_Orders.MethodApplic, DV_Orders.DealTypeName, DV_Orders.DealCode, DV_Orders.FIID, DV_Orders.Point );
     end;
   
     LogIt("Анализ дата-сета завершен");

  end;

  /*
   отбор поручений по РОВУ: ищем по ссылке ddl_acc.Ground подтверждающий документ (Поручение клиента на операцию), 
   и среди поручений, введенных по ALT-D
  */
  PRIVATE MACRO ПолучитьПорученияРОВУ( KindReport:integer )
     var sqlQuery, sqlSelect, InnerData;

     sqlQuery = "select * from ( " +
                "select acc.t_Client ClientID, acc.t_Oper, lvalues.T_NAME OperationName, acc.t_ClientContr ContrID, " +
                "       ground.T_RegistrDate OrderDate, Ground.T_REGISTRTIME OrderTime, Ground.T_XLD OrderNum, " +
                "        acc.t_Sum Amount, "+
                "        0 Price, " +              
                "       (CASE (acc.t_fikind) "+
                "             WHEN 1 THEN (SELECT f.T_CCY from dfininstr_dbt f where f.t_fiid = acc.t_fiid) "+
                "             ELSE        (SELECT f1.T_CCY from dfininstr_dbt f1 where f1.t_fiid = (SELECT f0.t_facevaluefi FROM dfininstr_dbt f0 WHERE f0.t_fiid = acc.t_fiid)) "+
                "        END) PriceName, "+        
                 "       (SELECT f2.T_FI_CODE from dfininstr_dbt f2 where f2.t_fiid = acc.t_fiid) FICode " +                
                "  from ddl_acc_dbt acc, dllvalues_dbt lvalues, dspground_dbt ground " +
                "  , dparty_dbt Pty, dspgrdoc_dbt SpGrDoc, dspgrdoc_dbt SpGrReq " +
                " WHERE acc.t_Department = ? " +
                "   and acc.t_Client = Pty.T_PARTYID  " +
                "   AND acc.t_Client > 0 " +
                "   AND acc.t_Client = (case when ? = -1 then acc.t_Client else ? end) " +
                "   AND acc.t_ClientContr = (case when ? = -1 then acc.t_ClientContr else ? end) " +
                "   AND acc.t_ValueDate = ? " +
                "   AND acc.t_DocState in(1,2) "+
                "   AND SpGrReq.T_SOURCEDOCKIND = acc.T_DOCKIND  " +
                "   AND SpGrReq.T_SOURCEDOCID   = acc.T_ID   "+
                "   AND SpGrReq.T_SOURCEDOCID   <> SpGrDoc.T_SOURCEDOCID     " +
                "   AND SpGrReq.T_SOURCEDOCKIND <> SpGrDoc.T_SOURCEDOCKIND   " +  
                "   AND SpGrDoc.T_SOURCEDOCKIND = " + DL_DVFXDEAL + 
                "   AND SpGrDoc.T_SOURCEDOCID = acc.t_ID " +
                "   AND Ground.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID " +
                "   AND Ground.T_SPGROUNDID = SpGrReq.T_SPGROUNDID " ;
                

     if( KindReport == DLACCVAL )/*по ДС*/
        sqlQuery = sqlQuery + 
                "   AND acc.t_Opertype in(1,2,3,4,5,6,7,47)";
     else /*по ЦБ*/
        sqlQuery = sqlQuery + 
                "   AND acc.t_Opertype in(50,51,52,53,54,59,60)"; 
     end;
 
     if( (Data.IsForm > 0) and (Data.FormSub != 0) )
       if(Data.IsForm == 1)
         sqlQuery = sqlQuery + " and Pty.T_LEGALFORM = " + String (Data.FormSub);
       end;
       if(Data.IsForm == 2)            
         sqlQuery = sqlQuery + " and Pty.T_LEGALFORM != " + String (Data.FormSub);
       end;
     end;
    
     if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
       if(Data.IsVid == 1)
         sqlQuery = sqlQuery + " and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID) ";
       end;
       if(Data.IsVid == 2)             
         sqlQuery = sqlQuery + " and NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID) ";
       end;
     end;

     if(Data.NoResident)
       sqlQuery = sqlQuery + " and Pty.T_NOTRESIDENT = 'X' ";
     end;

     if( Data.BO AND (Data.DV or Data.CM) AND Data.VA )
        sqlQuery = sqlQuery + 
                "   AND (acc.t_BOffice = 5 or acc.t_BOffice = 7 or acc.t_BOffice = 8) ";
     elif( Data.BO )
        sqlQuery = sqlQuery + 
                "   AND acc.t_BOffice = 5 ";
     elif( Data.VA )
        sqlQuery = sqlQuery + 
                "   AND acc.t_BOffice = 7 ";
     elif(Data.DV or Data.CM)
        sqlQuery = sqlQuery + 
                "   AND acc.t_BOffice = 8 ";
     end;
                                                         
     sqlQuery = sqlQuery + 
                  " AND ground.T_spgroundid = acc.t_ground " +
                  " AND  ground.T_KIND = 251 " +
                  " AND lvalues.T_LIST = 1006 " +
                  " AND lvalues.T_ELEMENT = acc.t_Opertype " +
                  " UNION ALL " +
                  " select acc.t_Client ClientID, acc.t_Oper, lvalues.T_NAME OperationName, acc.t_ClientContr ContrID, " +
                  "        ground.T_RegistrDate OrderDate, Ground.T_REGISTRTIME OrderTime, Ground.T_XLD OrderNum, " +
                  "        acc.t_Sum Amount, "+
                  "        0 Price, " +               
                "       (CASE (acc.t_fikind) "+
                "             WHEN 1 THEN (SELECT f.T_CCY from dfininstr_dbt f where f.t_fiid = acc.t_fiid) "+
                "             ELSE        (SELECT f1.T_CCY from dfininstr_dbt f1 where f1.t_fiid = (SELECT f0.t_facevaluefi FROM dfininstr_dbt f0 WHERE f0.t_fiid = acc.t_fiid)) "+
                  "        END) PriceName, "+      
                  "       (SELECT f2.T_FI_CODE from dfininstr_dbt f2 where f2.t_fiid = acc.t_fiid) FICode " +
                  "   from ddl_acc_dbt acc, dllvalues_dbt lvalues, dspground_dbt ground, dspgrdoc_dbt grdoc, dspgrdoc_dbt SpGrReq " +
                  "  , dparty_dbt Pty " +
                  "  WHERE acc.t_Department = ? " +
                  "   and acc.t_Client = Pty.T_PARTYID  " +
  
                  "    AND acc.t_Client > 0 " +
                  "    AND acc.t_Client = (case when ? = -1 then acc.t_Client else ? end) " +
                  "    AND acc.t_ClientContr = (case when ? = -1 then acc.t_ClientContr else ? end) " +
                  "    AND acc.t_ValueDate = ? " +
                  "    AND acc.t_DocState in(1,2) "+
                  "    AND SpGrReq.t_SourceDocID <> grdoc.t_SourceDocID "+
                  "    AND SpGrReq.t_SourceDocKind <> grdoc.t_SourceDocKind"+
                  "    AND SpGrReq.t_SourceDocKind = acc.T_DOCKIND"+
                  "    AND SpGrReq.t_SourceDocID = acc.T_ID";
     if( KindReport == DLACCVAL )/*по ДС*/
        sqlQuery = sqlQuery +" AND acc.t_Opertype in(1,2,3,4,5,6,7,47)";
     else /*по ЦБ*/
        sqlQuery = sqlQuery +" AND acc.t_Opertype in(50,51,52,53,54,59,60)"; 
     end;
 
     if( (Data.IsForm > 0) and (Data.FormSub != 0) )
       if(Data.IsForm == 1)
         sqlQuery = sqlQuery + "    and  Pty.T_LEGALFORM = " + String (Data.FormSub) ;
       end;
       if(Data.IsForm == 2)               
         sqlQuery = sqlQuery + "    and  Pty.T_LEGALFORM !=   " + String (Data.FormSub);
       end;
     end;
    
     if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
       if(Data.IsVid == 1)
         sqlQuery = sqlQuery + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID)  " ;
       end;
       if(Data.IsVid == 2)             
         sqlQuery = sqlQuery + "    and   NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID) " ;
       end;
     end;

     if(Data.NoResident)
       sqlQuery = sqlQuery + " and  Pty.T_NOTRESIDENT = 'X'  "; 
     end;

 
     if( Data.BO AND (Data.DV or Data.CM) AND Data.VA )
        sqlQuery = sqlQuery +" AND (acc.t_BOffice = 5 or acc.t_BOffice = 7 or acc.t_BOffice = 8) ";
     elif( Data.BO )
        sqlQuery = sqlQuery +" AND acc.t_BOffice = 5 ";
     elif( Data.VA )
        sqlQuery = sqlQuery +" AND acc.t_BOffice = 7 ";
     elif(Data.DV or Data.CM)
        sqlQuery = sqlQuery +" AND acc.t_BOffice = 8 ";
     end;

     sqlQuery = sqlQuery +  
                   "   AND lvalues.T_LIST = 1006 " +
                   "   AND lvalues.T_ELEMENT = acc.t_Opertype " +
                   "   AND grdoc.t_sourcedocid = acc.t_id " +
                   "   AND grdoc.t_sourcedockind = acc.t_DocKind " +
                   "   AND ground.T_spgroundid = grdoc.t_spgroundid " +
                   "   AND ground.T_spgroundid = SpGrReq.t_spgroundid"
                   "   AND ground.T_spgroundid != acc.t_ground " + /*чтобы не отбирать непривязанный граунд, отобранный выше*/
                   "   AND  ground.T_KIND = 251 ";
                  
           // Alt-D
     if ( KindReport == DLACCSC )
       sqlQuery = sqlQuery +
           " union all " +
               " SELECT " +
               "   tick.t_ClientID ClientID, " +
               "   tick.t_Oper, " +
               "   opkop.t_Name OperationName, " + 
               "   tick.t_ClientContrID ContrID, " +
               "   ground.t_RegistrDate OrderDate, " +
               "   ground.t_RegistrTime OrderTime, " +               
               "   ground.t_XLD OrderNum, " +    
               "   rq.t_Amount Amount, " +
               "   sum.t_Sum Price, " +
               "   (select f.t_CCY from dfininstr_dbt f where f.t_FIID = sum.t_Currency) PriceName, " +
                   "   (SELECT f2.T_FI_CODE from dfininstr_dbt f2 where f2.t_fiid = rq.t_fiid) FICode " +      
               " FROM " +
               "   ddl_tick_dbt tick, " +
               "   dspground_dbt ground, " +
               "   dspgrdoc_dbt grdoc, " +
               "   ddlrq_dbt rq, " +
               "   ddlsum_dbt sum, " +
               "   dllvalues_dbt lvalues, " +
               "   doprkoper_dbt opkop, " +
               "   dparty_dbt party " +
               " WHERE " +
               "    tick.t_Department = ? and " +
               "    party.t_PartyID = tick.t_ClientID and " +
               "    tick.t_DealType in (2010, 2011) and " +
               "    opkop.t_Kind_Operation = tick.t_DealType and " +
               "    lvalues.t_List = 1050 and " +
               "    lvalues.t_Element = 251 and " +
                   "    lvalues.t_Element = ground.t_Kind and " +
               "    grdoc.t_SpGroundID = ground.t_SpGroundID and " +
               "    tick.t_ClientID > 0 and " +
               "    tick.t_ClientID = (case when ? = -1 then tick.t_ClientID else ? end) and " +
               "    tick.t_ClientID != -1 and " +
               "    tick.t_ClientContrID = (case when ? = -1 then tick.t_ClientContrID else ? end) and " +
               "    rq.t_State in (1, 2) and " +
               "    rq.t_DocID = tick.t_DealID and " +
               "    tick.t_DealID = grdoc.t_SourceDocID and " +
               "    sum.t_DocID = tick.t_DealID and " +
               "    sum.t_Kind = 1220 and " +
               "    sum.t_DocKind = grdoc.t_SourceDocKind and " +
               "    ground.t_RegistrDate = ? ";
            //"  "
               
        if( (Data.IsForm > 0) and (Data.FormSub != 0) )
         if(Data.IsForm == 1)
           sqlQuery = sqlQuery + " and party.T_LEGALFORM = " + String (Data.FormSub);
         end;
         if(Data.IsForm == 2)          
           sqlQuery = sqlQuery + " and party.T_LEGALFORM != " + String (Data.FormSub);
         end;
       end;
    
       if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
         if(Data.IsVid == 1)
           sqlQuery = sqlQuery + " and EXISTS (select 1 from dpartyown_dbt pto where pto.t_PartyKind =" + String (Data.VidSub) +" and party.t_PartyID = pto.t_PartyID) ";
         end;
         if(Data.IsVid == 2)           
           sqlQuery = sqlQuery + " and NOT EXISTS (select 1 from dpartyown_dbt pto where pto.t_PartyKind =" + String (Data.VidSub)+ " and party.t_PartyID = pto.t_PartyID) ";
         end;
       end;
    
        if(Data.NoResident)
         sqlQuery = sqlQuery + " and party.T_NOTRESIDENT = 'X' ";
       end;
     end;
     
     //вручную введённые сделки, где документом по ALT+D является поручение клиента на операцию 
     if ( Data.BO and (KindReport == DLACCSC) ) // Golovkin попадали сделки по ц/б, когда не было отмечено Поручения на сделки
        sqlQuery = sqlQuery +
               " union all " +
               " SELECT " +
               "   tick.t_ClientID ClientID, " +
               "   tick.t_Oper, " +
               "   opkop.t_Name OperationName, " + 
               "   tick.t_ClientContrID ContrID, " +
               "   ground.t_RegistrDate OrderDate, " +
               "   ground.t_RegistrTime OrderTime, " +               
               "   ground.t_XLD OrderNum, " +    

               "   leg.t_Principal Amount, " +
               "   leg.t_Price Price, " +
               "   (select f.t_CCY from dfininstr_dbt f where f.t_FIID = leg.t_Cfi) PriceName, " +
                   "   (SELECT f2.T_FI_CODE from dfininstr_dbt f2 where f2.t_fiid = leg.t_Pfi) FICode " +      
               " FROM " +
               "   ddl_tick_dbt tick, " +
               "   dspground_dbt ground, " +
               "   dspgrdoc_dbt grdoc, " +
               "   ddl_leg_dbt leg, " +
               "   dllvalues_dbt lvalues, " +
               "   doprkoper_dbt opkop, " +
               "   dparty_dbt party " +
               " WHERE " +
               "    tick.t_Department = ? and " +
               "    party.t_PartyID = tick.t_ClientID and " +
               //"    tick.t_DealType in (2010, 2011) and " +
               "    opkop.t_Kind_Operation = tick.t_DealType and " +
               "    lvalues.t_List = 1050 and " +
               "    lvalues.t_Element = 251 and " +
                   "    lvalues.t_Element = ground.t_Kind and " +
               "    grdoc.t_SpGroundID = ground.t_SpGroundID and " +
               "    tick.t_ClientID > 0 and " +
               "    tick.t_ClientID = (case when ? = -1 then tick.t_ClientID else ? end) and " +
               "    tick.t_ClientID != -1 and " +
               "    tick.t_ClientContrID = (case when ? = -1 then tick.t_ClientContrID else ? end) and " +
               //"    rq.t_State in (1, 2) and " +
               "    leg.t_DealID = tick.t_DealID and " +
               "    tick.t_DealID = grdoc.t_SourceDocID and " +
                   "    tick.t_BofficeKind = grdoc.t_SourceDocKind and " +
               "    ground.t_RegistrDate = ? "
               // Golovkin тут по идее должны отбираться сделки без заявок. С заявками отбираются в scclordj.mac
               "    AND NOT EXISTS(SELECT 1 FROM dspgrdoc_dbt grreq, ddl_req_dbt Req WHERE grreq.t_SourceDocKind = Req.T_KIND AND grreq.t_SourceDocID = Req.T_ID AND grreq.t_SPGroundID = ground.t_SPGroundID) ";
     end; 
           
     sqlQuery = sqlQuery + ") ord order by ord.OrderTime, ord.ClientID, ord.ContrID";

     sqlSelect = RSDCommand(sqlQuery);

     sqlSelect.addParam("", RSDBP_IN, {OperDprt});
     sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
     sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
     sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
     sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
     sqlSelect.addParam("", RSDBP_IN, string(Data.CurDate));
    
     sqlSelect.addParam("", RSDBP_IN, {OperDprt});
     sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
     sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
     sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
     sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
     sqlSelect.addParam("", RSDBP_IN, string(Data.CurDate));
    
     if ( KindReport == DLACCSC )
       sqlSelect.addParam("", RSDBP_IN, {OperDprt});
       sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
       sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
       sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
       sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
       sqlSelect.addParam("", RSDBP_IN, string(Data.CurDate));
     end;
     if ( Data.BO and (KindReport == DLACCSC) )     
       sqlSelect.addParam("", RSDBP_IN, {OperDprt});
       sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
       sqlSelect.addParam("", RSDBP_IN, Data.ClientID);
       sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
       sqlSelect.addParam("", RSDBP_IN, Data.ContrID);
       sqlSelect.addParam("", RSDBP_IN, string(Data.CurDate));
     end;

     sqlSelect.execute();

     InnerData = TRsbDataSet(sqlSelect);
     while( InnerData.MoveNext() )

        Data.ReportData[Data.ReportData.Size] = ClOrdRegRepData( KindReport, null, InnerData.OrderNum, 
                                                                 SQL_ConvTypeDate(InnerData.OrderDate), SQL_ConvTypeTime(InnerData.OrderTime),
                                                                 InnerData.ClientID, InnerData.ContrID, InnerData.Oper, 
                                                                 InnerData.OperationName, "", "Исполнено",InnerData.Amount, /*IIF(InnerData.Price==0," ",*/InnerData.Price/*)*/, InnerData.PriceName, 
                                                                 InnerData.FICode, -1 );
     end;

  END;

  PRIVATE VAR m_RepKind, m_StrNum, m_RepKindLast;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT, datecount, finalDate )

    VAR Num = 0, PrintRepForDate = false;
    Data.ReportData.Size = 0;
    LogIt("Начало получения данных за "+string(Data.CurDate));

    if( Data.OrdDeal == "X" )

       if( Data.BO == "X" )
	  LogIt("Exec scclordj.mac за "+string(Data.CurDate)+" (фондовый дилинг)");
          ExecMacroFile("scclordj.mac", "RunReport", Data);
	  LogIt("Exec completed, Data.ReportData.Size = "+string(Data.ReportData.Size));
       end;

       if( Data.VA == "X" )
	  LogIt("Exec vaclordj.mac за "+string(Data.CurDate));
          ExecMacroFile("vaclordj.mac", "RunReport", Data);
	  LogIt("Exec completed, Data.ReportData.Size = "+string(Data.ReportData.Size));
       end;

       if ((Data.DV == "X" ) or (Data.CM == "X"))
          var ServKinds: STRING;
          if ((Data.DV == "X" ) and (Data.CM == "X"))
            ServKinds = "(" + PTSK_DV + "," + PTSK_CM + ")";
          elif (Data.DV == "X" )
            ServKinds = "(" + PTSK_DV + ")";
          elif (Data.CM == "X" )
            ServKinds = "(" + PTSK_CM + ")";
          end;
          ПолучитьПорученияПИ(ServKinds);
       end;

       if( Data.ReportData.Size > 0 )
          /*Сортируем по времени поручения*/
	  LogIt("Сортировка данных за "+string(Data.CurDate)+", Data.ReportData.Size = "+string(Data.ReportData.Size));
          qsort(Data.ReportData, "cmpData", 1);
	  LogIt("Сортировка завершена");
       end;

    end;

    if( Data.OrdVal == "X" )
       LogIt("ПолучитьПорученияРОВУ за "+string(Data.CurDate));
       ПолучитьПорученияРОВУ(DLACCVAL);
       LogIt("ПорученияРОВУ получены, Data.ReportData.Size = "+string(Data.ReportData.Size));
    end;

    /*12.12.2019 RAS:501190*/
    /*if( Data.OrdSec == "X" )
       ПолучитьПорученияРОВУ(DLACCSC);
    end;*/

    LogIt("Получены данные за "+string(Data.CurDate));
    LogIt("-----------------------------");

    if( Data.ReportData.Size > 0 )
       InitProgress( Data.ReportData.Size, "Журнал регистрации поручений клиентов", "Просмотр данных по договорам клиента" );

     /*  if((ValType(ObjReport.m_report.GetCurrentRow()) == v_undef) or
          (not isOnlyOne()))
         PrintRepHeader();
       end;  */
       m_StrNum = 0;

       LogIt("Начало обработки данных за "+string(Data.CurDate));

       if(m_SheetLen + Data.ReportData.Size + 5 < MAX_ROWSHEET_XLSX - 1000) 
      	  LogIt("Можно вывести на текущей вкладке ");
       else                   
          m_SheetInd = m_SheetInd + 1;
          m_SheetName = "Продолжение "+string(m_SheetInd);
  	  LogIt("Нужно добавить вкладку: "+m_SheetName);
          UseNewSheetInTotalBook();
          m_SheetLen = 0;
       end;  

       while( m_StrNum < Data.ReportData.Size )

          if( m_RepKind != Data.ReportData[m_StrNum].ReportKind )
             
             if ((valtype(m_RepKind ) != v_undef) or  (m_RepKind != 0))    /*GAA:498875*/
             end; /**/
             m_RepKind = Data.ReportData[m_StrNum].ReportKind;
             if((PrintRepForDate) or ((m_RepKindLast != 0) and (m_RepKindLast != m_RepKind)))
       		LogIt("EndReportTab started, m_StrNum = "+string(m_StrNum)+", m_SheetLen = "+string(m_SheetLen));
                ObjReport.EndReportTab();
       		LogIt("EndReportTab completed");
             end;
       	     LogIt("m_RepKindLast="+string(m_RepKindLast)+", m_RepKind="+string(m_RepKind));
             if (m_RepKindLast != m_RepKind)
                if(m_RepKind == SECDEAL)
                  ObjReport.BeginRepTab_BO();
                elif(m_RepKind == SECDEAL_DV)
                  ObjReport.BeginRepTab_DV();
                elif(m_RepKind == SECDEAL_CM)
                  ObjReport.BeginRepTab_CM(); /*KS 20.01.2020 I-Sup 503436*/
                else
                  ObjReport.BeginRepTab();
                end;
                m_SheetLen = m_SheetLen + 5;
                m_RepKindLast = m_RepKind;
             end;
             PrintRepForDate = true;
          end;

          if(Data.ReportData[m_StrNum].ReportKind == SECDEAL)
             ObjReport.ПечататьСтрокуТаблицы_BO();
          elif(Data.ReportData[m_StrNum].ReportKind == SECDEAL_DV)
             ObjReport.ПечататьСтрокуТаблицы_DV();
          elif(Data.ReportData[m_StrNum].ReportKind == SECDEAL_CM)
             ObjReport.ПечататьСтрокуТаблицы_CM();
          else
             ObjReport.ПечататьСтрокуТаблицы();
          end;

          IsExistsData = true;

          UseProgress( Num = Num + 1 );

          if(mod(Num, 1000) == 0) 
	     LogIt("Обработано "+string(Num)+" записей (из "+string(Data.ReportData.Size)+")");
          end;

          m_StrNum = m_StrNum +1;
       end;

       m_SheetLen = m_SheetLen + Data.ReportData.Size;

       LogIt("Обработаны все записи за "+string(Data.CurDate)+" ("+string(Data.ReportData.Size)+")");
       LogIt("PrintRepForDate=  "+string(PrintRepForDate)+", finalDate="+string(finalDate)+", isOnlyOne()="+string(isOnlyOne()));

       Data.ReportData.Size = 0;
        

       if( PrintRepForDate )
         if(finalDate)
            LogIt("EndReportTab started ");
            ObjReport.EndReportTab();/*12.12.2019 RAS:501190*/
       	    LogIt("EndReportTab completed");
            ObjReport.PrintRepFooter();    
         end;
       end;

       m_RepKind = 0;

       LogIt("Удаление прогресс-бара");
       RemProgress();
       LogIt("-----------------------------");
    elif((finalDate) and
         (ValType(ObjReport.m_report.GetCurrentRow()) != v_undef))
      LogIt("EndReportTab started 1");
      ObjReport.EndReportTab();
      LogIt("EndReportTab completed");
      ObjReport.PrintRepFooter();
    end;
  END;

  PRIVATE MACRO Create() 
     var datecount = 0;

     if( ((Data.BO != "X") and (Data.DV != "X") and (Data.VA != "X") and (Data.CM != "X")) OR
         ((Data.OrdDeal != "X") and (Data.OrdVal != "X") and (Data.OrdSec != "X"))
       )
          PrintFormatString( "#","N1_NoRepData","Не выборан ни один из видов обслуживания и/или ни один из признаков отбора поручений в отчет");
          CopyAllSheetInTotalBook( null, false, "N1_NoRepData", 0, m_SheetName, true );
          return;
     end;

     InitProgress(  Data.dateMax - Data.dateMin + 1,
                     "Отчет \"Журнал регистрации поручений клиента\"", 
                     "Просмотр данных за интервал дат" );
     IsExistsData = false;
     IsFirstUse = true;
     Data.CurDate = Date(Data.dateMin);

/*     LogIt("Test add sheet");
     if(AddSheet("Sheet 1") == true) 
        LogIt("Sheet added");
     else 
        LogIt("Sheet not added");
     end;*/

     m_RepKindLast = 0;
     while( Data.CurDate <= Data.dateMax )
        ExecuteReport(CTransCentr(this), datecount, Data.CurDate == Data.dateMax);
        Data.CurDate = Data.CurDate + 1;
        UseProgress( datecount = datecount + 1 );
     end;

     RemProgress();

     if(not IsExistsData)
        PrintFormatString( "#","N1_NoRepData","Нет данных, удовлетворяющих параметрам отчета");
        CopyAllSheetInTotalBook( null, false, "N1_NoRepData", 0, m_SheetName, true );
     end;
  END;

  MACRO RepName():STRING
     if (m_RepKind == SECDEAL_CM)
       return NameOrder[m_RepKind] + 
              iif(isOnlyCM,
                  iif(Data.dateMin == Data.dateMax, " за " + fixdate(Data.dateMin), " c " + fixdate(Data.dateMin) + " по " + fixdate(Data.dateMax)),
                  " за " + fixdate(Data.CurDate));
     else
       return NameOrder[m_RepKind];
     end;
  END;


  MACRO OrderDate():DATE
     return Data.ReportData[m_StrNum].DocDate;
  END;

  MACRO OrderTime():TIME
     return Data.ReportData[m_StrNum].DocTime;
  END;

  MACRO OrderNum():STRING
     return Data.ReportData[m_StrNum].DocNum;
  END;

  MACRO DealTypeName():STRING
     return Data.ReportData[m_StrNum].DealTypeName;
  END;

  MACRO DealCode():STRING
     if(ValType(Data.ReportData[m_StrNum].DealCode) != V_UNDEF)
        return Data.ReportData[m_StrNum].DealCode;
     end;
     return "";
  END;

  // Golovkin 08.04.2019
  macro getClientMpCode()
    var sqlQuery = RSDCommand(" SELECT t_mpcode                 " +
                              "   FROM ddlcontrmp_dbt           " +
                              "  WHERE t_sfcontrid = :sfcontrid ");

    sqlQuery.addParam("", RSDBP_IN, Data.ReportData[m_StrNum].ContrID);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.mpcode;
    end;

    return "";
  end;

  // KS 24.04.2019
  macro getClientShortCode()

    var sqlQuery = RSDCommand(" select t_code                      " +
                              "   from ddlobjcode_dbt objcode        " +
                              "  where objcode.t_ObjectType = 207  " +
                              "    and objcode.t_CodeKind = 1      " +
                              "    and objcode.t_ObjectID = (SELECT t_dlcontrid                " +
                              "                                FROM ddlcontrmp_dbt             " +
                              "                               WHERE t_sfcontrid = :sfcontrid) ");
    
    sqlQuery.addParam("", RSDBP_IN, Data.ReportData[m_StrNum].ContrID);
    sqlQuery.execute();
    
    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.code;
    end;

    return "";
  end;

  macro getContrName()
    var sqlQuery = RSDCommand(" SELECT T_NAME                                                          " +
                              "   FROM DSFCONTR_DBT                                                    " +
                              "  WHERE T_ID = (SELECT t_sfcontrid                                      " +
                              "                  FROM ddlcontr_dbt                                     " +
                              "                 WHERE t_dlcontrid = (SELECT t_dlcontrid                " +
                              "                                        FROM ddlcontrmp_dbt             " +
                              "                                       WHERE t_sfcontrid = :sfcontrid)) ");

    sqlQuery.addParam("", RSDBP_IN, Data.ReportData[m_StrNum].ContrID);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.name;
    end;

    return "";
  end;

  MACRO ClientName():STRING
     Var pt = TRecHandler ("party");
     var m_Client = Data.ReportData[m_StrNum].ClientID;
     var m_mp_code = getClientMpCode(); // Golovkin 08.04.2019
     var m_short_code = getClientShortCode(); // KS 24.04.2019
     var m_client_name = "";

     if( m_Client > 0 )
       if( not ПолучитьСубъекта(m_Client,pt) )
          if(pt.rec.LegalForm == 2/*PTLEFG_PERSN*/) // Golovkin 08.04.2019
              //m_client_name = pt.rec.ShortName;
              m_client_name = pt.rec.Name;
          else
              m_client_name = getContrName();
          end;

          if(m_short_code != "")
              m_client_name = m_client_name + "_" + m_short_code; // KS 24.04.2019 Нужен ещё и короткий код для всех отчетов
          end;

          if(m_mp_code != "")
              m_client_name = m_client_name + "/" + m_mp_code; // Golovkin 08.04.2019
          end;

          return m_client_name;
        end;
     end;
     return "";
  END;

  // Golovkin 08.04.2019
  macro getDBOContrId()
    var sqlQuery = RSDCommand(" SELECT t_sfcontrid                                     " +
                              "   FROM ddlcontr_dbt                                    " +
                              "  WHERE t_dlcontrid = (SELECT t_dlcontrid               " +
                              "                         FROM ddlcontrmp_dbt            " +
                              "                        WHERE t_sfcontrid = :sfcontrid) ");

    sqlQuery.addParam("", RSDBP_IN, Data.ReportData[m_StrNum].ContrID);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return int(sqlData.sfcontrid);
    end;

    return Data.ReportData[m_StrNum].ContrID;
  end;

  MACRO ContrNum():STRING
     
     // Golovkin 08.04.2019
     //if( SfGetContr( Data.ReportData[m_StrNum].ContrID, sfcontr) == true )
     if( SfGetContr( getDBOContrId(), sfcontr) == true )
         return sfcontr.Number;
     else
        return "";
     end;
  END;

  MACRO ContrNumDV():STRING
     
    var sqlQuery = RSDCommand(" select t_code             " +
                              "   from dobjcode_dbt o     " +
                              "  where o.t_objecttype = 9 " +
                              "    and o.t_codekind = 11  " +
                              "    and o.t_objectid = ? ");

    sqlQuery.addParam("", RSDBP_IN, Data.ReportData[m_StrNum].FIID);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.code;
    end;

    return "";
  END;


  MACRO ContrDate():DATE
     var m_ContrDate = Date(0,0,0);
     if( SfGetContr( Data.ReportData[m_StrNum].ContrID, sfcontr) == true )
        m_ContrDate = SQL_ConvTypeDate(sfcontr.DateConc);
     end;
     return m_ContrDate;
  END;

  MACRO Status():STRING
    return Data.ReportData[m_StrNum].Status;
  END;

  MACRO OperType():STRING
    if( (this.Status() == "Исполнено") or (this.Status() == "Частично исполнено") )
       return Data.ReportData[m_StrNum].OperType;
    else
       return "";
    end;
  END;

  MACRO Amount():DOUBLE
    return Data.ReportData[m_StrNum].Amount;
  end;
  
  MACRO Price():DOUBLE
    return Data.ReportData[m_StrNum].Price;
  end;
  
  MACRO PriceName():STRING
    return Data.ReportData[m_StrNum].PriceName;
  end;
  
  MACRO FICode():STRING
    return Data.ReportData[m_StrNum].FICode;
  end;
  
  MACRO DealChanges():STRING
     return Data.ReportData[m_StrNum].DealChangeInfo;
  END;
  
  macro getTraderCode(p_OPER)
    macro getCode(p_Code,p_pref)
      p_Code = StrLwr(p_Code);
      var pref = SubStr(p_Code,1,StrLen(p_pref));
      var Code = SubStr(p_Code,StrLen(p_pref)+1);
      if ((pref == p_pref) and StrIsNumber(Trim(Code)))
        return Code;
      end;
      return StrFor(0);
    end;
    var TRADER_CODE ; 
    TRADER_CODE = getCode(p_OPER,"tr");
    if (TRADER_CODE != StrFor(0))
      return TRADER_CODE ;
    end;
    var err = false ;
    if (strlen(PREFIX_PDOC) == 0)
       GetRegistryValue(Registry_METHODAPPLIC_PDOC, V_STRING, PREFIX_PDOC, err);
    end ;
    if ((not err) and (strlen(PREFIX_PDOC) > 0) )
      TRADER_CODE = getCode(p_OPER,PREFIX_PDOC);
      if (TRADER_CODE != StrFor(0))
        return TRADER_CODE ;
      end;
    end;
    err = false ;
    if (strlen(PREFIX_VMES) == 0) 
       GetRegistryValue(Registry_METHODAPPLIC_VMES, V_STRING, PREFIX_VMES, err);
    end ;
    if ((not err) and (strlen(PREFIX_VMES) > 0) )
     TRADER_CODE = getCode(p_OPER,PREFIX_VMES);
      if (TRADER_CODE != StrFor(0))
        return TRADER_CODE ;
      end;
    end;
    return StrFor(0) ;
  end;
  
  // Golovkin 10.04.2019
  macro getTraderName()
    var  TRADER_CODE = getTraderCode(Data.ReportData[m_StrNum].Oper) ; 
    if (TRADER_CODE != StrFor(0))
      var sqlQuery = RSDCommand("select t_name  from DPARTY_DBT " +
                                " where T_PARTYID = (select T_PARTYID " +
                                       " from (select T_OBJECTID T_PARTYID " +
                                           "  from DOBJCODE_DBT where T_OBJECTTYPE = 3 and T_CODEKIND = 104 " +
                                              "  and T_BANKDATE <= ? AND trim(T_CODE) = ? " +
                                            "  order by T_BANKDATE desc) "+
                                       " where rownum < 2) " );

      sqlQuery.addParam("", RSDBP_IN, Data.ReportData[m_StrNum].DocDate);
      sqlQuery.addParam("", RSDBP_IN, TRADER_CODE);
      
      sqlQuery.execute();

      var sqlData = TRsbDataSet(sqlQuery);

      if(sqlData.movenext)
          return sqlData.name;
      end;
    end;
    return "";
  end;

  MACRO Oper():STRING
      var
         person = TBFile( "person" ), m_Oper = Data.ReportData[m_StrNum].Oper;

      if((Data.ReportData[m_StrNum].ReportKind == SECDEAL) or
         (Data.ReportData[m_StrNum].ReportKind == SECDEAL_DV) or
         (Data.ReportData[m_StrNum].ReportKind == SECDEAL_CM))
         return getTraderName();
      end;

      If(Data.ReportData[m_StrNum].Oper == 0)
         return "";
      end;
      person.Clear();
      person.rec.Oper = m_Oper;
      if( not person.GetEQ )
         person.Clear();
         msgbox("Не могу получить данные об операционисте (Oper = " + String(m_Oper));
      end;

      return person.rec.Name;
  END;

  MACRO OrderDeliveryKind():string
     if(Data.ReportData[m_StrNum].MethodApplic == DL_REQ_METHODAPPLIC_EDOC)
        return "Электронный";
     elif(Data.ReportData[m_StrNum].MethodApplic == DL_REQ_METHODAPPLIC_PDOC)
        return "Бумажный";
     elif(Data.ReportData[m_StrNum].MethodApplic == DL_REQ_METHODAPPLIC_VMES)
        return "Голосовой";
     elif(Data.ReportData[m_StrNum].MethodApplic == DL_REQ_METHODAPPLIC_OTHER)
        return "Иной";
     else
        var Op = Oper();
        if ((ValType(Op)!=0)and(Op!=""))
          var err, PREFIX_PDOC ="",PREFIX_VMES="";
          GetRegistryValue(Registry_METHODAPPLIC_PDOC, V_STRING, PREFIX_PDOC, err);
          if (not err)
            GetRegistryValue(Registry_METHODAPPLIC_VMES, V_STRING, PREFIX_VMES, err);
          end;
          if ((not err) and (strlen(PREFIX_PDOC) > 0) and (strlen(PREFIX_VMES) > 0) 
              and  (  ((SubStr(Op,1,strlen(PREFIX_PDOC)) == PREFIX_PDOC) and StrIsNumber(Trim(SubStr(Op,strlen(PREFIX_PDOC)+1))))
                     or ((SubStr(Op,1,strlen(PREFIX_VMES)) == PREFIX_VMES) and StrIsNumber(Trim(SubStr(Op,strlen(PREFIX_VMES)+1)))) ))

            if (SubStr(Op,1,strlen(PREFIX_PDOC)) == PREFIX_PDOC)
                return "Бумажный";
             else
                return "Голосовой";
             end;
          else
           return "Голосовой";
          end;
        end;
        return "Электронный";
     end;
  END;

  MACRO OrderDeliverySystem():string
     var Op = Oper();
     if ((ValType(Op)!=0)and(Op!=""))
       return Op; // Для всех 

      /*17.01.2020 RAS:503433*/
       if( Data.ReportData[m_StrNum].ReportKind == SECDEAL )
         return Op;
       elif( (Data.ReportData[m_StrNum].ReportKind == SECDEAL_DV ) or (Data.ReportData[m_StrNum].ReportKind == SECDEAL_CM ) )
         return " ";
       end;
     /*---------------------*/
     end;
     return "ИТС QUIK";
  END;

  MACRO Point():DOUBLE
    return Data.ReportData[m_StrNum].Point;
  end;

  macro GetLastSheetName():string
     var sheetName = m_ObjTemplateXLS.GetSheetNameTotalBook(m_ObjTemplateXLS.SheetCountTotalBook());
     if( sheetName != "")
        return sheetName;
     end;
     return m_SheetName;
  end;

//  initDL_CReportTemplate( null, "Report_dlclordcj_usr.xlsx", true, false, null, POI_MODE, true );  // DEF-37340
  initDL_CReportTemplate( null, "Report_dlclordcj_usr.xls", true, false, null, POI_MODE, true );  // DEF-90095 возвращен шаблон xls, так как xlsx работает неверно
END;

macro MakeReports()

  var stat = 0;

  /* DEF-44748 Логгирование в ..\txtfile 
     Если логгирование включено, то параметр функции LogIt() будет направляться в лог файл.
     Если выключено, функции LogIt() ничего не сделают (и не помешают основному коду)
     Если логгирование нужно, раскомментируйте InitCbLog(1)
     Велигжанин А.В.
  */
//  InitCbLog(1); 
  
  while(stat == 0)
     if (not m_Form.Run())
        return ;
     end;
     GetDataFromFormFields();
     DL_ClOrdRegRep_Tmp().Run();
     // DEF-67273, после первого вызова сбрасываем флаг первой инициализации, 
     //            чтобы флаги для видов обслуживания не выставлялись автоматом, 
     //            а были такими же, как были выставлены в панели 
     RepFormData.FirstInit = false;  
  end;

end;

MakeReports();
exit(1);