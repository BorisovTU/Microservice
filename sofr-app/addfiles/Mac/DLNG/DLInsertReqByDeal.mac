/*
$Name:        DLInsertReqByDeal.mac
$Module:      Ядро Securities
$Description: Генерация заявок-поручений по сделкам
*/
Import "dv_fun.mac";

macro DLStartInsertReqByDeal():integer

  var HeadPR  = "┌────────────────────────┬────────────────────────────────────────────────────────────────────┐\n"+
                "│      Код сделки        │                              Сообщение                             │\n"+
                "├────────────────────────┼────────────────────────────────────────────────────────────────────┤";
                                                                                                            
  var FootPR  = "└────────────────────────┴────────────────────────────────────────────────────────────────────┘\n";
  var DelimPR = "├────────────────────────┼────────────────────────────────────────────────────────────────────┤";
  var ReportFileName, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода для протокола*/

  ReportFileName = GetTxtFileName("протокол");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  println(HeadPR);

  var stat = 0;
  var cmd, DataSet, cmd2, DataSet2, exec;
  var mes = "";
  var MarketID:integer = -1;
  var ClntRep = TRecHandler("spground.dbt");
  var Request = TRecHandler("dl_req.dbt");
  var FI      = TRecHandler("fininstr.dbt");
  var DV      = TRecHandler("fideriv.dbt");

  cmd = RSDCommand( " select Deal.* " +
                    "   from ddvdeal_dbt Deal " +
                    "  where Deal.t_State in(?, ?) " +
                    "    and Deal.t_Client > 0 " +
                    "    and Deal.t_Type in('B', 'S', 'D', 'G') " +
                    "    and not exists( select * " +
                    "                      from dspground_dbt spgr, dspgrdoc_dbt spgrdocreq, dspgrdoc_dbt spgrdocdeal " +
                    "                     where spgrdocdeal.t_SourceDocID   = Deal.t_ID " +
                    "                       and spgrdocdeal.t_SourceDocKind = ? " +
                    "                       and spgr.t_SPgroundID = spgrdocdeal.t_SPGroundID " +
                    "                       and spgr.t_SPgroundID = spgrdocreq.t_SPGroundID " +
                    "                       and spgrdocreq.t_SourceDocID   != spgrdocdeal.t_SourceDocID " +
                    "                       and spgrdocreq.t_SourceDocKind != spgrdocdeal.t_SourceDocKind " +
                    "                  ) "
                  );
  cmd.addParam("", RSDBP_IN, DVDEAL_PREP);
  cmd.addParam("", RSDBP_IN, DVDEAL_OPEN);
  cmd.addParam("", RSDBP_IN, DL_DVDEAL);
  cmd.execute();

  DataSet = TRsbDataSet(cmd);
  while( DataSet.moveNext() )

     if( ПолучитьПИ(DataSet.FIID, @FI, @DV) )

        ClntRep.Clear();
        Request.Clear();

        Request.rec.SourceKind   = DL_DVDEAL;
        Request.rec.IsExchange   = "X";
        Request.rec.MarketID     = FI.Issuer;
        Request.rec.MarketKind   = DV_MARKETKIND_DERIV;
        Request.rec.MethodApplic = DL_REQ_METHODAPPLIC_EDOC;

        if( FI.AvoirKind == DERIVATIVE_FUTURES )
           Request.rec.PFIKind = DL_REQ_PFIKIND_FUTURES;
        elif( FI.AvoirKind == DERIVATIVE_OPTION )
           if( DV.OptionType == DVTYPE_CALL )
              Request.rec.PFIKind = DL_REQ_PFIKIND_OPTIONCALL;
           else
              Request.rec.PFIKind = DL_REQ_PFIKIND_OPTIONPUT;
           end;
        end;

        Request.rec.Kind     = 350/*DOCKIND_REQ_CLIENT_DEAL*/;
        Request.rec.Date     = DataSet.Date;
        Request.rec.Time     = DataSet.Time;
        Request.rec.Party    = FI.Issuer;
        Request.rec.Client   = DataSet.Client;
        Request.rec.ClientContr = DataSet.ClientContr;
        Request.rec.RepoRate = 0.0;
        if( (DataSet.Type == "B") or (DataSet.Type == "D") )
           Request.rec.Direction = DL_REQ_DIRECTION_B;
        elif( (DataSet.Type == "S") or (DataSet.Type == "G") )
           Request.rec.Direction = DL_REQ_DIRECTION_S;
        end;
        Request.rec.FIID       = DataSet.FIID;
        Request.rec.Amount     = DataSet.Amount;
        Request.rec.Price      = DataSet.Price;
        Request.rec.PriceType  = -1; /*не заполняется*/
        Request.rec.PriceFIID  = -1; /*не заполняется*/
        Request.rec.CurrencyID = -1; /*не заполняется*/
        Request.rec.Status     = REQ_MADE_DEAL;
      
        ClntRep.rec.Kind        = 251/*DOCKIND_ORD_CLIENTOP*/;
        ClntRep.rec.MethodApplic= Request.rec.MethodApplic;
        ClntRep.rec.Party       = Request.rec.Client;
        DL_СкорректироватьДатуЗаявки(Request.rec.Date, Request.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
        ClntRep.rec.XLD         = DL_СформироватьНомерЗаявки(Request.rec.Party, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
        ClntRep.rec.SignedDate  = ClntRep.rec.RegistrDate;
        ClntRep.rec.SignedTime  = ClntRep.rec.RegistrTime;
        ClntRep.rec.DocLog      = LLCLASS_KINDDOC_DERIV;
        ClntRep.rec.Direction   = 1/*ENTERING*/;
        ClntRep.rec.AltXLD      = ClntRep.rec.XLD;
        ClntRep.rec.Division    = SelfDivision;
        ClntRep.rec.Receptionist= {oper};
        ClntRep.rec.BackOffice  = "Ю";
        ClntRep.rec.Department  = {OperDprt};
        ClntRep.rec.IsMakeAuto  = SET_CHAR;

        Request.rec.CodeTS = Request.rec.Code = ClntRep.rec.XLD;

        ClntRep.rec.Comment = "Поручение клиента на сделку по заявке " + Request.rec.CodeTS;

        stat = DV_InsertReqSpgroundSpgrdoc(DataSet.ID, DL_DVDEAL, DataSet.Client, ClntRep, Request);

        mes = "";
        if( stat == 0 )
           mes = "Заявка и поручение вставлены";
        else
           mes = GetErrMsg();
           if( strlen(mes) == 0 )
              mes = "Ошибка при вставке заявки/поручения";
           end;
        end;

        println("│ " + String(DataSet.Code:22) + " │ " + String(mes:67) + "│");
        println( DelimPR );
     else
        println("│ " + String(DataSet.Code:22) + " │ Не найден производный инструмент                                   │");
        println( DelimPR );
     end;

  end;

  cmd = RSDCommand( " select NDeal.*, nfi.t_FIID, nfi.t_Amount, nfi.t_Price " +
                    "   from ddvndeal_dbt NDeal, ddvnfi_dbt nfi " +
                    "  where NDeal.t_State in(?, ?) " +
                    "    and NDeal.t_Client > 0 " +
                    "    and nfi.t_DealID = NDeal.T_ID " +
                    "    and nfi.t_Type = case when NDeal.t_Forvard = 'X' then 1 else 0 end " +
                    "    and not exists( select * " +
                    "                      from dspground_dbt spgr, dspgrdoc_dbt spgrdocreq, dspgrdoc_dbt spgrdocdeal " +
                    "                     where spgrdocdeal.t_SourceDocID   = NDeal.t_ID " +
                    "                       and spgrdocdeal.t_SourceDocKind in(?, ?) " +
                    "                       and spgr.t_SPgroundID = spgrdocdeal.t_SPGroundID " +
                    "                       and spgr.t_SPgroundID = spgrdocreq.t_SPGroundID " +
                    "                       and spgrdocreq.t_SourceDocID   != spgrdocdeal.t_SourceDocID " +
                    "                       and spgrdocreq.t_SourceDocKind != spgrdocdeal.t_SourceDocKind " +
                    "                  ) "
                  );

  cmd.addParam("", RSDBP_IN, DVDEAL_PREP);
  cmd.addParam("", RSDBP_IN, DVDEAL_OPEN);
  cmd.addParam("", RSDBP_IN, DL_DVNDEAL);
  cmd.addParam("", RSDBP_IN, DL_DVDEALT3);
  cmd.execute();

  DataSet = TRsbDataSet(cmd);
  while( DataSet.moveNext() )

     MarketID = -1;
     ClntRep.Clear();
     Request.Clear();

     Request.rec.SourceKind = DataSet.DocKind;
     Request.rec.SourceID   = DataSet.ID;

     if( (DataSet.Sector = SET_CHAR) and ВидСубъекта(DataSet.Contractor, PTK_MARKETPLASE) )
        MarketID = DataSet.Contractor;
        Request.rec.IsExchange = "X";
        Request.rec.MarketID   = DataSet.MarketID;
     else
        Request.rec.IsExchange = "";
        Request.rec.MarketID   = -1;
     end;
     Request.rec.MarketKind = DataSet.MarketKind;

     Request.rec.MethodApplic = DL_REQ_METHODAPPLIC_EDOC;

     Request.rec.PFIKind = -1;
     if( Request.rec.SourceKind == DL_DVNDEAL )
        if( DataSet.DVKind == DV_FORWARD )
           Request.rec.PFIKind = DL_REQ_PFIKIND_FORVARD;
        elif( (DataSet.DVKind == DV_OPTION) and (DataSet.OptionType == DVTYPE_PUT) )
           Request.rec.PFIKind = DL_REQ_PFIKIND_OPTIONPUT;
        elif( (DataSet.DVKind == DV_OPTION) and (DataSet.OptionType == DVTYPE_CALL) )
           Request.rec.PFIKind = DL_REQ_PFIKIND_OPTIONCALL;
        elif( DataSet.DVKind == DV_CURSWAP )
           Request.rec.PFIKind = DL_REQ_PFIKIND_CURSWAP;
        elif( DataSet.DVKind == DV_PCTSWAP )
           Request.rec.PFIKind = DL_REQ_PFIKIND_PCTSWAP;
        end;
     end;

     Request.rec.Kind     = 350/*DOCKIND_REQ_CLIENT_DEAL*/;
     Request.rec.Date     = DataSet.Date;
     Request.rec.Time     = DataSet.Time;
     Request.rec.Party    = DataSet.Contractor;
     Request.rec.Client   = DataSet.Client;
     Request.rec.ClientContr = DataSet.ClientContr;
     Request.rec.RepoRate = 0.0;

     if( (DataSet.DVKind == DV_CURSWAP) or (DataSet.DVKind == DV_PCTSWAP) )
        if( DataSet.Type == ALG_DV_SB )
           Request.rec.Direction = DL_REQ_DIRECTION_SB;
        else
           Request.rec.Direction = DL_REQ_DIRECTION_BS;
        end;
     else
        if( DataSet.Type == ALG_DV_SALE )
           Request.rec.Direction = DL_REQ_DIRECTION_S;
        else
           Request.rec.Direction = DL_REQ_DIRECTION_B;
        end;
     end;

     Request.rec.FIID       = DataSet.FIID;
     Request.rec.Amount     = DataSet.Amount;
     Request.rec.Price      = DataSet.Price;
     Request.rec.PriceType  = -1; /*не заполняется*/
     Request.rec.PriceFIID  = -1; /*не заполняется*/
     Request.rec.CurrencyID = -1; /*не заполняется*/
     Request.rec.Status     = REQ_MADE_DEAL;
     Request.rec.Forvard    = DataSet.Forvard;

     ClntRep.rec.Kind        = 251/*DOCKIND_ORD_CLIENTOP*/;
     ClntRep.rec.MethodApplic= Request.rec.MethodApplic;
     ClntRep.rec.Party       = Request.rec.Client;
     DL_СкорректироватьДатуЗаявки(Request.rec.Date, Request.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
     ClntRep.rec.XLD         = DL_СформироватьНомерЗаявки(MarketID, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
     ClntRep.rec.SignedDate  = ClntRep.rec.RegistrDate;
     ClntRep.rec.SignedTime  = ClntRep.rec.RegistrTime;
     ClntRep.rec.DocLog      = LLCLASS_KINDDOC_DERIV;
     ClntRep.rec.Direction   = 1/*ENTERING*/;
     ClntRep.rec.AltXLD      = ClntRep.rec.XLD;
     ClntRep.rec.Division    = SelfDivision;
     ClntRep.rec.Receptionist= {oper};
     ClntRep.rec.BackOffice  = "Ю";
     ClntRep.rec.Department  = {OperDprt};
     ClntRep.rec.IsMakeAuto  = SET_CHAR;

     Request.rec.CodeTS = Request.rec.Code = ClntRep.rec.XLD;

     ClntRep.rec.Comment = "Поручение клиента на сделку по заявке " + Request.rec.CodeTS;

     stat = DV_InsertReqSpgroundSpgrdoc(DataSet.ID, Request.rec.SourceKind, DataSet.Client, ClntRep, Request);

     mes = "";
     if( stat == 0 )
        mes = "Заявка и поручение вставлены";
     else
        mes = GetErrMsg();
        if( strlen(mes) == 0 )
           mes = "Ошибка при вставке заявки/поручения";
        end;
     end;

     println("│ " + String(DataSet.Code:22) + " │ " + String(mes:67) + "│");
     println( DelimPR );

  end;

  cmd = RSDCommand( " select tick.*, leg.t_FIID, leg.t_Amount, leg.t_Price, " +
                    "        Rsb_Secur.IsDVFXSWAP(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_Kind, tick.t_DocKind), tick.t_DocKind)) IsDVFXSWAP " +
                    "   from ddvndeal_dbt tick, ddvnfi_dbt leg " +
                    "  where tick.t_State in(?, ?) " +
                    "    and tick.t_Client > 0 " +
                    "    and tick.t_DocKind = ? " +
                    "    and leg.t_Type = ? " +
                    "    and leg.t_DealID  = tick.t_ID " +
                    "    and not exists( select * " +
                    "                      from dspground_dbt spgr, dspgrdoc_dbt spgrdocreq, dspgrdoc_dbt spgrdocdeal " +
                    "                     where spgrdocdeal.t_SourceDocID   = tick.t_ID " +
                    "                       and spgrdocdeal.t_SourceDocKind = tick.t_DocKind " +
                    "                       and spgr.t_SPgroundID = spgrdocdeal.t_SPGroundID " +
                    "                       and spgr.t_SPgroundID = spgrdocreq.t_SPGroundID " +
                    "                       and spgrdocreq.t_SourceDocID   != spgrdocdeal.t_SourceDocID " +
                    "                       and spgrdocreq.t_SourceDocKind != spgrdocdeal.t_SourceDocKind " +
                    "                  ) "
                  );
  cmd.addParam("", RSDBP_IN, DVDEAL_PREP);
  cmd.addParam("", RSDBP_IN, DVDEAL_OPEN);
  cmd.addParam("", RSDBP_IN, DL_DVFXDEAL);
  cmd.addParam("", RSDBP_IN, DV_NFIType_BaseActiv);
  cmd.execute();

  DataSet = TRsbDataSet(cmd);
  while( DataSet.moveNext() )

     MarketID = -1;
     ClntRep.Clear();
     Request.Clear();

     Request.rec.SourceKind = DL_DVFXDEAL;
     Request.rec.SourceID   = DataSet.ID;

     if( (DataSet.Sector = SET_CHAR) and ВидСубъекта(DataSet.Contractor, PTK_MARKETPLASE) )
        MarketID = DataSet.Contractor;
        Request.rec.IsExchange = "X";
        Request.rec.MarketID   = DataSet.MarketID;
     else
        Request.rec.IsExchange = "";
        Request.rec.MarketID   = -1;
     end;

     Request.rec.MarketKind = DV_MARKETKIND_STOCK;

     Request.rec.MethodApplic = DL_REQ_METHODAPPLIC_EDOC;
     Request.rec.PFIKind  = -1;
     Request.rec.Kind     = 350/*DOCKIND_REQ_CLIENT_DEAL*/;
     Request.rec.Date     = DataSet.Date;
     Request.rec.Time     = DataSet.Time;
     Request.rec.Party    = DataSet.Contractor;
     Request.rec.Client   = DataSet.Client;
     Request.rec.ClientContr = DataSet.ClientContr;
     Request.rec.RepoRate = 0.0;

     if( DataSet.IsDVFXSWAP == 1 )
        if( DataSet.Type == ALG_DV_SB );
           Request.rec.Direction = DL_REQ_DIRECTION_SB;
        else
           Request.rec.Direction = DL_REQ_DIRECTION_BS;
        end;
     else
        if( DataSet.Type == ALG_DV_SALE );
           Request.rec.Direction = DL_REQ_DIRECTION_S;
        else
           Request.rec.Direction = DL_REQ_DIRECTION_B;
        end;
     end;

     Request.rec.FIID       = DataSet.FIID;
     Request.rec.Amount     = DataSet.Amount;
     Request.rec.Price      = DataSet.Price;
     Request.rec.PriceType  = -1; /*не заполняется*/
     Request.rec.PriceFIID  = -1; /*не заполняется*/
     Request.rec.CurrencyID = -1; /*не заполняется*/
     Request.rec.Status     = REQ_MADE_DEAL;
     Request.rec.Forvard    = "";

     ClntRep.rec.Kind        = 251/*DOCKIND_ORD_CLIENTOP*/;
     ClntRep.rec.MethodApplic= Request.rec.MethodApplic;
     ClntRep.rec.Party       = Request.rec.Client;
     DL_СкорректироватьДатуЗаявки(Request.rec.Date, Request.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
     ClntRep.rec.XLD         = DL_СформироватьНомерЗаявки(MarketID, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
     ClntRep.rec.SignedDate  = ClntRep.rec.RegistrDate;
     ClntRep.rec.SignedTime  = ClntRep.rec.RegistrTime;
     ClntRep.rec.DocLog      = LLCLASS_KINDDOC_DERIV;
     ClntRep.rec.Direction   = 1/*ENTERING*/;
     ClntRep.rec.AltXLD      = ClntRep.rec.XLD;
     ClntRep.rec.Division    = SelfDivision;
     ClntRep.rec.Receptionist= {oper};
     ClntRep.rec.BackOffice  = "Ю";
     ClntRep.rec.Department  = {OperDprt};
     ClntRep.rec.IsMakeAuto  = SET_CHAR;

     Request.rec.CodeTS = Request.rec.Code = ClntRep.rec.XLD;

     ClntRep.rec.Comment = "Поручение клиента на сделку по заявке " + Request.rec.CodeTS;

     stat = DV_InsertReqSpgroundSpgrdoc(DataSet.ID, Request.rec.SourceKind, DataSet.Client, ClntRep, Request);

     mes = "";
     if( stat == 0 )
        mes = "Заявка и поручение вставлены";
     else
        mes = GetErrMsg();
        if( strlen(mes) == 0 )
           mes = "Ошибка при вставке заявки/поручения";
        end;
     end;

     println("│ " + String(DataSet.Code:22) + " │ " + String(mes:67) + "│");
     println( DelimPR );

  end;

  println(FootPR);

  SetOutput(NULL, true);
  close(ReportOutFile);
  ViewFile(ReportOutFile);

  return stat;

OnError( er )
  MsgBox("Ошибка при выполнении процедуры вставки заявок");
  return 1;
end;

DLStartInsertReqByDeal();
