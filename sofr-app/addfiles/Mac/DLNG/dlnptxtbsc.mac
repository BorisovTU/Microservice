/*
 $Name: dlnptxtbsc.mac 
 $Module: ?
 $Description: Макрос спроллинга записей СНОБ
*/

IMPORT DealsInter, SPInter, PTInter, globals;
IMPORT RsbDataSet, "dlquery.mac";
import bnk_common;

import "sp_categ.mac";
import "nptxstbfun.mac";

/* Уже заполненные структуры, все изменения отразятся в базах */
PRIVATE VAR Документ         = TRecHandler( "nptxtotalbase" );
PRIVATE VAR СтарыйДокумент   = TRecHandler( "nptxtotalbase" ); /* заполняется при редактировании */

/* Макрофункция инициализации нового актива 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ()
  return 0;
END;

PRIVATE MACRO Проверить_Документ( Режим:integer )
  return 0;
END;

/* Установка подсказки для скролингов из макроса */
PRIVATE MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string
  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t dnptxtotalbase_dbt_idx0)*/";
  return DefaultHint;
END;

/* Вызывается по CTRL+Z из скроллинга */
PRIVATE MACRO Функция_Пользователя()
  return 0;
END;

//Печать протокола записи СНОБ
//TBID - идентифкатор записи СНОБ
PRIVATE MACRO ПечатьПротоколЗаписиСНОБ(TBID:integer)
  macro MakeReportFileName() : string
    var day, mon, year;
    DateSplit({curdate}, day, mon, year);

    var hour, min, sec;
    TimeSplit(Time(), hour, min, sec);

    var filename = "Протокол_СНОБ_"+string(TBID)+"_"
                 + string(year:4:o) + string(mon:2:o) + string(day:2:o) + "_"
                 + string(hour:2:o) + string(min:2:o) + string(sec:2:o);

    return MergeFile(Bnk_GetTxtFileDir(), filename, "txt");
  end;
  
  
  var query, cmd, DataSet;
  FILE output_file() txt write;
  var  filename = MakeReportFileName();

  if (not Open(output_file, filename))
    msgbox("Ошибка при открытии файла отчета|" + filename);
    break;
  end;
  SetOutput(filename);

  println("Протокол записи СНОБ с ID="+TBID);
  println();

  query =   " select * "
          + "   from dnptxtbmes_dbt "
          + "  where t_TBID = ? "
          + " order by t_Date ASC, t_Time ASC, t_ID ASC";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(TBID);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
[########################### ###########################################################################]
(string(string(date(DataSet.Date):f)+" "+string(time(DataSet.Time))):l, DataSet.Message:l:w);    
  end;

  SetOutput(null, true);
  Close(output_file);
  ViewFile(output_file);
END;

//Запросить ID в хран. СНОБ
PRIVATE MACRO GetIdSNOB(ClientID:integer, IncDate:date, IncTime:time, TBID:integer):string
  var SNOBId = ExecGetIdSNOB_STB(ClientID, IncDate, IncTime, TBID);
  return SNOBId;
END;

//Отменить событие в СОФР
//StorID - идентифкатор записи СНОБ
PRIVATE MACRO ОтменитьСобытиеСОФР(StorID:String):integer
  var stat = ExecSinglCancelStorSTB(StorID, true /*skipChek21*/, false /*showSucsessMess*/);
  return stat;
END;

//Отменить в хран. СНОБ
//StorID - идентифкатор записи СНОБ
PRIVATE MACRO ОтменитьВХранСНОБ(StorID:String):integer
  var stat = ExecSinglCancelStorSTB(StorID, false /*skipChek21*/, true /*showSucsessMess*/);
  return stat;
END;

//Подтвердить событие в СОФР
//StorID - идентифкатор записи СНОБ
PRIVATE MACRO ПодтвердитьСобытиеСОФР(StorID:String):integer
  var stat = ExecSinglCancelStorSTB(StorID, true /*skipChek21*/, false /*showSucsessMess*/);
  return stat;
END;


