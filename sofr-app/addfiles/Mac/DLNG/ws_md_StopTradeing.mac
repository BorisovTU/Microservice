/*
$Name:         ws_md_StopTradeing.mac
$Module:       Монитор дилера
$Description:  Запуск планировщика для остановки режима торгов
*/

import RsbDataSet, secinter, "dl_xml.mac", "dllog_xml.mac";
import  XmlRpcInter, ServiceAction, FIInter, BankInter, globals, lib_str, "ws_md_ReutSettings.mac";
import "ws_md.mac";


private macro ShedWriteLog(StrErr)
  if(IsShedulerRunning())
    WriteShedulerLog(StrErr);
  end;
end;

macro StopTrading()

  var stat:integer = 0;
  var begin_transaction:bool = false;

  InitError();

  if( not IsStopTrade() )

    RslDefCon.BeginTrans();
    begin_transaction = true;

    var HistRec = Tbfile("rktradehist", "W", 0);
    HistRec.Clear();
    HistRec.rec.Id = 0;
    HistRec.rec.Sysdate = date();
    HistRec.rec.ChangeTime = Time();
    HistRec.rec.BankDate = {curdate};
    HistRec.rec.Oper = {Oper};
    HistRec.rec.State = SHOUTDOWN;
    HistRec.rec.SessionId = "";

    if( not HistRec.Insert() )
      stat = 1;
    end;

    if( stat != 0 )
       ShedWriteLog("Ошибка добавления записи в таблицу drktradehist_dbt");
       RslDefCon.RollbackTrans();
    else
       RslDefCon.CommitTrans();
       begin_transaction = false;
       ShedWriteLog("Выполнена остановка торгов");
    end; 
 
  else
    ShedWriteLog("В текущий момент торги уже остановлены");
  end;

OnError( err )
  if( begin_transaction )
     ShedWriteLog("Ошибка транзакции сохранения");
     RslDefCon.RollbackTrans();
  end;

end;

StopTrading();
