/*
$Name:             dl_kvit.mac
$Module:           Ядро Dealing
$Description:      Предобработка панели квитовки
*/

/*
BackOffice - бэк-офис
DocKind    - вид документа (заполняется, если панель вызывается для конкретного документа)
DocID      - номер документа (заполняется, если панель вызывается для конкретного документа)
PaymentID  - номер платежа (заполняется, если квитуется конкретный платеж)

Возвращаемое значение - если 0, то запускается панель квитовки
*/
import funk;

PRIVATE MACRO Подготовка(BackOffice, DocKind, DocID, PaymentID)
  private var rs,rs2,rs5,que,{curdate},da;

   if ( BackOffice == 158 )  //фиссико
      da=substr(string({curdate}),1,10);   
      if ( substr(da,1,1) == " ")
        da="0"+substr(da,2);
      end;
      que="select t_paymentid,t_fiid from dpmpaym_dbt where to_char(t_valuedate,'dd.mm.yyyy') ='"+da+"' and t_dockind=322 and t_baseamount != t_amount  and t_paymstatus < 32000";
//      que="select t_paymentid,t_fiid from dpmpaym_dbt where to_char(t_valuedate,'dd.mm.yyyy') ='"+da+"' and t_dockind=322 and t_futurepayeramount != t_futurereceiveramount   and t_paymstatus < 32000";

      rs = LnGetRecordSet(que);
      if(rs != null)
        while(rs.moveNext())
          que="select t_account from dcorschem_dbt where t_fiid="+rs.value(1)+" and substr(t_account,1,3)  !='303' ";
          rs5 = LnGetRecordSet(que);
          if(rs5 != null)
             if (rs5.moveNext) 
	          que="update dpmpaym_dbt set t_futurepayeraccount='"+rs5.value(0)+"',t_baseamount=t_amount,  t_payamount=t_amount, t_futurepayeramount=t_amount, t_futurereceiveramount=t_amount,  t_basefiid=t_fiid, t_payfiid=t_fiid, t_fiid_futurerecacc=t_fiid, t_fiid_futurepayacc=t_fiid  where t_paymentid="+rs.value(0); 
        	  rs2 = LnGetRecordSet(que);
             end;
          end;

        end;
      end;

   end;


   RETURN 0;
END;
