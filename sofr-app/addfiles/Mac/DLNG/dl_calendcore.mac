/*
$Name:        dl_calendcore.mac
$Module:      Дилинг
$Description: Основное по календарям
*/

import dl_calendtls;

var DLFDocBuf = 0;
var DLOprStepBuf = 0;

/*В итоге не получилось пойти по пути этого класса, но оставлю на будущее
class DL_CalendOperDateInserter(docKind, autoExecute, shiftDate)

  private var m_AutoExecute = true;
  private var m_DocKind = 0;
  private var m_DocId = 0;
  private var m_IdOp = 0;
  private var m_IdStep = 0;
  private var m_IsCallFromStep = false;
  private var m_ShiftDate = true;

  PRIVATE MACRO Init(_docKind):INTEGER
    SQL_Truncate( "doprsetdates_tmp" );

    m_IsCallFromStep = DL_CheckCallFromStep();

    if (m_IsCallFromStep)
      DL_GetCalendCurOperStepData(m_DocKind, m_IdOp, m_IdStep, m_DocId);
    end;

    if (ValType(_docKind) == V_INTEGER)
      m_DocKind = _docKind;
    end;

    return 0;
  ONERROR
    return 1;
  END;

  MACRO Execute( ):INTEGER
    if (m_IsCallFromStep)
      SQL_Execute( "DECLARE "+
                   " v_Error INTEGER; "+
                   "BEGIN "+
                   " v_Error := RSI_RsbOperation.procMassSetOprDates( true ); "+
                   " IF( v_Error != 0 ) THEN "+
                   "   RAISE_APPLICATION_ERROR( -20101, 'Error procMassSetOprDates' ); "+
                   " END IF; "+
                   "END; " );
    end;

    return 0;
  OnError
    return 1;
  END;

  macro InsertStepSimpleDate(DateNumber:integer, DateVal:date)
    var locDateVal = DateVal;
    var dateKindId = DL_GetDateKindIdByKindNumb(DateNumber, m_DocKind);
    if (m_IsCallFromStep)
      if (m_ShiftDate)
        
      end;


      SQL_Execute(
        RsdCommand( " INSERT INTO doprsetdates_tmp( t_ID_Operation, t_ID_Step, t_DateKindID, t_DateNew ) " +
                    " VALUES ("+m_IdOp+", "+m_IdStep+", "+dateKindId+", "+GetSQLDate(DateVal)+") ")
      );
    end;
  end;

  MACRO InsertStepFromDS( DateNumber:integer, FldDateName:STRING, SqlSourceExpr: string )
    if (m_IsCallFromStep)
      SQL_Execute(
        RsdCommand( " INSERT INTO doprsetdates_tmp( t_ID_Operation, t_ID_Step, t_DateKindID, t_DateNew ) " +
                    " SELECT "+m_IdOp+", "+m_IdStep+", "+DL_GetDateKindIdByKindNumb(DateNumber, m_DocKind)+", "+FldDateName+" FROM ("+SqlSourceExpr+")");
      );
  END;

  macro Destructor()
    Execute();
  end;

  if (ValType(autoExecute) == V_BOOL)
    m_AutoExecute = autoExecute;
  end;

  if (ValType(shiftDate) == V_BOOL)
    m_ShiftDate = shiftDate;
  end;

  if (Init(docKind))
    RunError("Ошибка инициализации объекта вставки опер. дат");
  end;

end;
*/

macro DV_Calend_GetCorrectDate(FD,DateKind,SetDate,StartDate:@date)
  var retDate = SetDate;
  if (retDate == date(0,0,0))
    return retDate;
  end;
  var calendId = DL_GetDefaultCalendar();
  var partNumber = 1;
  var isEarly = false;
  var noSettlCalend = 0;
  if ((not IsEqClass("DVFirstDocFXDeal",FD)) and (not IsEqClass("DVFirstDocNDeal",FD)))
    return retDate;
  end;
  if (not DL_Calend_DV_DateDefineIsOff(FD.Kind, DateKind))
    calendId = FD.ПолучитьКалендСвязанный();
    DL_CalendInit(retDate,calendId);
    if ((FD.ПолучитьКалендТип() == DL_CALLNK_OUTMARKET) and DL_Calend_DV_DateDefineIsPayment(FD.Kind, DateKind, @partNumber) and DL_Calend_DV_AddCheck(FD, DateKind))
      noSettlCalend = FD.ПолучитьКалендСвязанный(DL_CALLNK_OUTMRKTDAY_NOSETTL);
      if (not IsWorkday(FD.ДатаСделки(),noSettlCalend))
        noSettlCalend = 0;
      end;
      retDate = DL_GetDateWorkDayForPayStep(SetDate, calendId, IIF(DL_Calend_DV_DateDefineIsReq(FD.Kind, DateKind, @partNumber),
          FD.ПлатежТреб.rec.Fiid,FD.ПлатежОб.rec.Fiid), DL_Calend_DV_DateDefineIsObl(FD.Kind, DateKind, @partNumber), @isEarly,
          DL_Calend_DV_IsEarlyOnlyObl(DateKind, FD), noSettlCalend);
      if (isEarly)
        FD.УстановитьКалендРанРасч(DateKind);
        DL_DropBalanceDateEQMinTODate(DateKind);
      end;
    else
      retDate = DL_GetBankDateAfterWorkDayByCalendar(SetDate,0,calendId);
    end;
    if (ValType(StartDate)==V_DATE)
      StartDate = FD.ДатаСделки();
    end;
  end;
  return retDate;
OnError(er)
  return retDate;
end;

macro SP_Calend_GetCorrectDate(FD,DateKind,SetDate,StartDate:@date)
  var retDate = SetDate;
  var calendId = DL_GetDefaultCalendar();
  if (retDate == date(0,0,0))
    return retDate;
  end;
  if (not IsEqClass("SPFirstDoc",FD))
    return retDate;
  end;
  if (not DL_Calend_SP_DateDefineIsOff(FD.tick.rec.BofficeKind, DateKind))
    calendId = FD.ПолучитьКалендСвязанный();
    DL_CalendInit(retDate,calendId);
    if (ValType(StartDate)==V_DATE)
      StartDate = FD.tick.rec.DealDate;
    end;
    retDate = DL_GetBankDateAfterWorkDayByCalendar(SetDate,0,calendId);
  end;
  
  return retDate;
OnError(er)
  return retDate;
end;

macro DL_CalendDefineOprDate(FD,DateKind,SetDate)
  var bufDate = SetDate, startDate = date(0,0,0);

  if ((ValType(SetDate) == V_UNDEF) or (SetDate == NULL) or (SetDate == date(0,0,0)))
    return;
  end;

  if (IsEqClass("DVFirstDocFXDeal",FD) or
      IsEqClass("DVFirstDocNDeal",FD) or
      IsEqClass("SPFirstDoc",FD))
    if (IsEqClass("DVFirstDocFXDeal",FD) or
        IsEqClass("DVFirstDocNDeal",FD))
      bufDate = DV_Calend_GetCorrectDate(FD,DateKind,bufDate,@startDate);
    elif(IsEqClass("SPFirstDoc",FD))
      bufDate = SP_Calend_GetCorrectDate(FD,DateKind,bufDate,@startDate)
    end;
    if ((startDate != date(0,0,0)) and (bufDate < startDate))
      bufDate = SetDate;//если полученная дата меньше даты сделки, то смещения не делаем
    end;
  end;

  DefineOprDate(DateKind, bufDate);
end;