/*
$Name:        dl_report725.mac
$Module:      Ценные бумаги
$Description: Отчет "Сведения о маржинальных сделках клиентов" (ф. 725)
*/
import "DLReport_h.mac", "dl_report725_form.mac", "bnk_dttmfrmt.mac", "scsrvrepfun.mac", "it_utils.mac";

PRIVATE VAR Form725;
PRIVATE VAR Report725;

PRIVATE CONST PARALLEL_LEVEL = 12;
PRIVATE CONST PARTITION_COUNT = 10;
PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

FILE ReportLogFile() txt write;

PRIVATE CONST CHAPTER_9_AS_AMOUNT_CR_DATE = date(01,01,2026);

PRIVATE VAR INFO_NAME = TArray;
INFO_NAME[0] = "";
INFO_NAME[1] = "Chapter1_Detail";
INFO_NAME[2] = "Chapter2_Detail";
INFO_NAME[3] = "Chapter3_Detail";
INFO_NAME[4] = "Chapter4_Detail";
INFO_NAME[5] = "Chapter5_Detail";


PRIVATE VAR INFO_LISTNAME = TArray;
INFO_LISTNAME[0] = "";
INFO_LISTNAME[1] = "Расшифровка раздела 1";
INFO_LISTNAME[2] = "Расшифровка раздела 2";
INFO_LISTNAME[3] = "Расшифровка раздела 3";
INFO_LISTNAME[4] = "Расшифровка раздела 4";
INFO_LISTNAME[5] = "Расшифровка раздела 5";

PRIVATE CONST CHAPTER_ALL = 0,
              CHAPTER_1   = 1,
              CHAPTER_2   = 2,
              CHAPTER_3   = 3,
              CHAPTER_4   = 4,
              CHAPTER_5   = 5; 

PRIVATE CONST
   RCB_XML_PK_MONTHLY   = 4,
   RCB_XML_PK_QUARTERLY = 5;
   
PRIVATE MACRO GetSessionID():Integer
  var id:Integer = -1;
  var sql = "SELECT SYS_CONTEXT('USERENV','SESSIONID') SessionID FROM DUAL";
  var cmd = DL_RSDCommand(sql);
  var ds = cmd.execute();
  if( ds.MoveNext() )
     id = int(ds.SessionID);
  end;
  return id;
END;

PRIVATE MACRO IT_Log(Msg:String, SessionID)
  var text = "pSessionID="+SessionID+" "+Msg;
  var sql = "begin it_log.log(:1, it_log.C_MSG_TYPE__MSG); end;";
  var cmd = RSDCommand(sql);
  cmd.AddParam("",RSDBP_IN,text);
  cmd.execute;
END;

PRIVATE CLASS (DL_CReportTemplate) DlReport725( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReport:BOOL )
  var m_BegDate, m_EndDate, m_IsSecur:integer, m_IsDV:integer, m_IsRep12:integer, m_Detail:integer, m_Chapter:integer;
  PRIVATE VAR m_InDelta = false;
  PRIVATE VAR m_DeltaReport;
  PRIVATE VAR m_CSVFileDir = IT_GetPatchTxtFile(false)+"\\";

  macro GetBegEndDateByPeriod():Date
     m_BegDate = Form725.GetFieldValue(PNFLD_FORM725_BEGINDATE);
     m_EndDate = Form725.GetFieldValue(PNFLD_FORM725_ENDDATE);
  end;

  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO PrintHeaderList(IsEmpty:string)
    SetActiveSheet( "Заголовок" );
    PrintFormatString( NULL,
                       "N0_H1",  "по состоянию на " + DDpMMpYYYY(m_EndDate + 1),
                       "N0_H2",  string(GetPartyFullNameByID({OurBank})),
                       "N0_H3",  string(GetPartyAddress({OurBank}, false, false, PTADDR_REAL)),
                       "N0_A0",  "Признак отчета с нулевыми показателями [      "+IsEmpty+"      ]"
                     );
    CopyAllSheetInTotalBook( "Заголовок", false, "N0_HEADER", 0, "Заголовок" );
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
    GetBegEndDateByPeriod();
    m_InDelta = iif(Form725.GetFieldValue(PNFLD_Form725_DELTA) == SET_CHAR,true,false);
    m_Detail  = iif(Form725.GetFieldValue(PNFLD_Form725_DETAIL) == SET_CHAR,1,0);
    m_Chapter = Form725.GetFieldValue(PNFLD_Form725_CHAPTER);
  END;
  
  PRIVATE MACRO ImportCSV(XLSfile,SheetName,BogyLine )
    var csvFile = (m_CSVFileDir+"Rep725_"+BogyLine+".csv") ;
    var XLStable;
	
    BegAction(10, "Импорт "+csvFile+" в XLS ");    
    // Для ускорения загрузки разбивка на несколько файлов пока убрана. На лист загружается один большой файл. 
    var files = IT_StoreClobBuferANSI(csvFile, "CSV");
    XLSfile.SheetChange( SheetName );
    XLStable  = XLSfile.RegisterTable(BogyLine);
    XLSfile.SetValue_NameCell(BogyLine);
    XLStable.FillTableFromCSVLight(csvFile);
    XLStable.EndTable();
    RemoveFile (csvFile);
    EndAction();

    var Rsd = RsdCommand(" begin it_rsl_string.clear; end; ");
    Rsd.execute();
  END;

  PRIVATE MACRO PrintDetail( ObjReport:OBJECT, SessionID, ListNum )
      var Count = 0, Query, Select, rs, Sheet, RSD, RecCnt = 0;
      var StartContr = 0, EndContr = 0, OpenContr = 0, ClosedContr = 0, PrevAccount = "", INN = "", TIN = "", NUM = "";
      var day, mon, year;
      var hour, min, sec;

      DateSplit(date(), day, mon, year);
      TimeSplit(time(), hour, min, sec);

      IT_Log("Формирование расшифровки '" + INFO_LISTNAME[ListNum] + "'", SessionID);
      
      var Dt;
      var XLSFileDir = "..\\txtfile\\", XLSfile = null;
      var CreateOnTerm = (not isStandAlone());

      var FileName = "Report_725_" + INFO_NAME[ListNum];

      XLSfile = CTemplateLightSXLSX();
      XLSfile.OpenTemplate(FileName + ".xlsx", false);//имя шаблона
      XLSfile.SetXLSXFormat();
      var XLSfileName = FileName + "_" + string(day:o:2)+string(mon:o:2)+string(year)+"_"+string(hour:f:2)+string(min:f:2);

      if(ListNum == CHAPTER_1)
        Count = 0;
        InitProgress(-1, "Формирование файла расшифровки для раздела 1", "Формирование файла расшифровки для раздела 1" );

        Query = "select t.*, count(1) over() as cnt " +
                "  from dclientportfolio_dbt t " +
                " where t.t_sessionid = ? ";
        Select = DL_RSDCommand(Query);
        Select.AddParam(SessionID);

        rs = Select.execute();
        while( rs.MoveNext() )
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?,true)); "+
                           " end; ");

          Rsd.addParam("", RSDBP_IN, rs.partyid);
          Rsd.addParam("", RSDBP_IN, rs.contractid);
          Rsd.addParam("", RSDBP_IN, rs.clientcode);
          Rsd.addParam("", RSDBP_IN, rs.firmid);
          Rsd.addParam("", RSDBP_IN, rs.clientname);
          Rsd.addParam("", RSDBP_IN, rs.clienttype);
          Rsd.addParam("", RSDBP_IN, rs.isresident);
          Rsd.addParam("", RSDBP_IN, rs.risklevel);
          Rsd.addParam("", RSDBP_IN, rs.isqualinvestor);
          Rsd.addParam("", RSDBP_IN, rs.rcvstatus);
          Rsd.addParam("", RSDBP_IN, rs.cohort);
          Rsd.addParam("", RSDBP_IN, rs.initmargin);
          Rsd.addParam("", RSDBP_IN, rs.rcv1);
          Rsd.addParam("", RSDBP_IN, rs.rcv2);
          Rsd.addParam("", RSDBP_IN, rs.portfoliovalue);
          Rsd.addParam("", RSDBP_IN, rs.clientcounter);
          Rsd.addParam("", RSDBP_IN, rs.rubposition);
          Rsd.addParam("", RSDBP_IN, rs.curposition);
          Rsd.addParam("", RSDBP_IN, rs.secposition);
          Rsd.addParam("", RSDBP_IN, rs.futuresposition);
          Rsd.addParam("", RSDBP_IN, rs.optionposition);
          Rsd.addParam("", RSDBP_IN, rs.precmetposition);
          Rsd.addParam("", RSDBP_IN, rs.nonqualassecposition);
          Rsd.addParam("", RSDBP_IN, rs.curinitmargin);
          Rsd.addParam("", RSDBP_IN, rs.secinitmargin);
          Rsd.addParam("", RSDBP_IN, rs.futuresinitmargin);
          Rsd.addParam("", RSDBP_IN, rs.optioninitmargin);
          Rsd.addParam("", RSDBP_IN, rs.precmetinitmargin); 
          Rsd.addParam("", RSDBP_IN, rs.nonqualassecinitmargin);
  
          Rsd.execute();

          UseProgress(Count = Count + 1);
        end;
        
        RemProgress();

        if(Count)
          IT_Log("Сформирован CSV для расшифровки '" + INFO_LISTNAME[ListNum] + "'", SessionID);
          ImportCSV(XLSfile,INFO_LISTNAME[ListNum],"T1_MAINTABLE");

          XLSfile.SaveAsTemplate(XLSfileName,false);
          msgbox("Сформирован файл расшифровок по данным раздела 1 " + XLSFileDir + XLSfile.ReportFileName_xls);
        end;
      elif(ListNum == CHAPTER_2)
        InitProgress(-1, "Формирование файла расшифровки для раздела 2", "Формирование файла расшифровки для раздела 2" );

        while ( RecCnt < 10 ) 
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?,true)); "+
                           " end; ");

          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2); 
  
          Rsd.execute();

          UseProgress(RecCnt = RecCnt + 1);
        end;
        
        RemProgress();

        IT_Log("Сформирован CSV для расшифровки '" + INFO_LISTNAME[ListNum] + "'", SessionID);
        ImportCSV(XLSfile,INFO_LISTNAME[ListNum],"T2_MAINTABLE");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок по данным раздела 2 " + XLSFileDir + XLSfile.ReportFileName_xls);
      elif(ListNum == CHAPTER_3)
        InitProgress(-1, "Формирование файла расшифровки для раздела 3", "Формирование файла расшифровки для раздела 3" );

        while ( RecCnt < 10 ) 
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?,true)); "+
                           " end; ");

          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
  
          Rsd.execute();

          UseProgress(RecCnt = RecCnt + 1);
        end;
        
        RemProgress();

        IT_Log("Сформирован CSV для расшифровки '" + INFO_LISTNAME[ListNum] + "'", SessionID);
        ImportCSV(XLSfile,INFO_LISTNAME[ListNum],"T3_MAINTABLE");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок по данным раздела 3 " + XLSFileDir + XLSfile.ReportFileName_xls);
      elif(ListNum == CHAPTER_4)
        InitProgress(-1, "Формирование файла расшифровки для раздела 4", "Формирование файла расшифровки для раздела 4" );

        while ( RecCnt < 10 ) 
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?,true)); "+
                           " end; ");

          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
  
          Rsd.execute();

          UseProgress(RecCnt = RecCnt + 1);
        end;
        
        RemProgress();

        IT_Log("Сформирован CSV для расшифровки '" + INFO_LISTNAME[ListNum] + "'", SessionID);
        ImportCSV(XLSfile,INFO_LISTNAME[ListNum],"T4_MAINTABLE");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок по данным раздела 4 " + XLSFileDir + XLSfile.ReportFileName_xls);
      elif(ListNum == CHAPTER_5)
        InitProgress(-1, "Формирование файла расшифровки для раздела 5", "Формирование файла расшифровки для раздела 5" );

        while ( RecCnt < 10 ) 
          Rsd = RsdCommand(" begin  it_rsl_string.append_varchar("+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?)|| "+
                                  " it_rsl_string.GetCell(?,true)); "+
                           " end; ");

          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 3);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 1);
          Rsd.addParam("", RSDBP_IN, 2);
          Rsd.addParam("", RSDBP_IN, 3);
  
          Rsd.execute();

          UseProgress(RecCnt = RecCnt + 1);
        end;
        
        RemProgress();

        IT_Log("Сформирован CSV для расшифровки '" + INFO_LISTNAME[ListNum] + "'", SessionID);
        ImportCSV(XLSfile,INFO_LISTNAME[ListNum],"T5_MAINTABLE");

        XLSfile.SaveAsTemplate(XLSfileName,false);
        msgbox("Сформирован файл расшифровок по данным раздела 5 " + XLSFileDir + XLSfile.ReportFileName_xls);
      end;

      IT_Log("Сформирована расшифровка '" + INFO_LISTNAME[ListNum-1] + "'", SessionID);

      XLSfile.Close ;
      if (XLSfile.Application) XLSfile.Application.Quit; end;
      XLSfile = null;

  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )

    var SessionID = GetSessionID();
    var Query, Select, rs, Query2, Select2, rs2;
    var Code = "", AvrName = "", Group_Contr = 0;
    var ShortName = "", INN = "", TIN = "", NUM = "", LastName  = "", FirstName = "", PatrName  = "";
    var TYPE_FL = "", KI = "", IIS = "";
    var m_IsDataExist = false, Count = 0;
    var firstRow = true;

    var cmd = RsdCommand("DELETE FROM ITT_LOG WHERE CREATE_SYSDATE BETWEEN TRUNC(SYSDATE)-1 and TRUNC(SYSDATE)+1 AND MSG LIKE 'pSessionID="+SessionID+"%'");
    cmd.execute();

    IT_Log("Запуск формирования отчета за период " + string(m_BegDate) + "-" + string(m_EndDate), SessionID);

    InitProgress(6, "Печать ф.725", "Печать ф.725" );

    if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_1))
      firstRow = true;
      Count = 1;
      IT_Log("Заполнение раздела 1 отчета", SessionID);

      InitProgress(1, "Очистка временных таблиц", "Очистка временных таблиц" );

      cmd = RsdCommand("{call RSB_DL725REP.ClearTables(?,?)}");
      cmd.addParam( "pSessionId", RSDBP_IN, SessionID );
      cmd.addParam( "pPart",      RSDBP_IN, 1 );
      cmd.execute();

      UseProgress(1);
      RemProgress();

      InitProgress(1, "Заполнение временных таблиц", "Заполнение временных таблиц" );

      cmd = RsdCommand("{call RSB_DL725REP.FillTables_Part1(?,?,?)}");
      cmd.addParam( "pSessionId", RSDBP_IN, SessionID );
      cmd.addParam( "pBegDate",   RSDBP_IN, m_BegDate );
      cmd.addParam( "pEndDate",   RSDBP_IN, m_EndDate );
      cmd.execute();

      UseProgress(1);
      RemProgress();
      InitProgress(1, "Заполнение раздела 1", "Заполнение раздела 1" );

      Query = "select t.*, count(1) over() as cnt " +
              "  from dpart1form725_dbt t " +
              " where t.t_sessionid = ? ";
      Select = DL_RSDCommand(Query);
      Select.AddParam(SessionID);

      rs = Select.execute();
      while( rs.MoveNext() )
        if(firstRow)
          if(not m_IsDataExist)
            m_IsDataExist = true;
            PrintHeaderList(UNSET_CHAR);
          end;

          firstRow = false;
          SetActiveSheet( "Раздел 1" );
          CopyAllSheetInTotalBook( "Раздел 1", false, "N1_HEADER", 0, "Раздел 1" );
          CopyAllSheetInTotalBook( "Раздел 1", false, "N1_TABLEHEADER", 1, "Раздел 1" );

          RegisterTable("N1_MAINTABLE", "", "N1_A1_Num", "N1_A2_ClientType", "N1_A3_Residental", "N1_A4_RiskLevel", "N1_A5_Qualification", "N1_A6_NPRStatus", "N1_A7_MarginMethod",
                        "N1_A8_QuantityGroup", "N1_A9_ClientsAmount", "A1_A10_PortfolioAmount", "N1_A11_NPR1", "N1_A12_NPR2", "N1_A13_PortfolioCost", "N1_A14_LongCostRub",
                        "N1_A15_LongCostCur", "N1_A16_LongCostCb", "N1_A17_LongCostFut", "N1_A18_LongCostOpt" , "N1_A19_LongCostOther", "N1_A20_ShortCostRub", "N1_A21_ShortCostCur",
                        "N1_A22_ShortCostCb", "N1_A23_ShortCostFut", "N1_A24_ShortCostOpt", "N1_A25_ShortCostOther", "N1_A26_LongIntCost", "N1_A27_ShortIntCost", "N1_A28_InitMargin",
                        "N1_A29_InitMarginRub", "N1_A30_InitMarginCb", "N1_A31_InitMarginFut", "N1_A32_InitMarginOpt", "N1_A33_InitMarginOther", "N1_A34_InternalMargin", "N1_A35_MarketMargin"
                       );
        end;

        PrintTableLine("N1_A1_Num", Count, null, 
                       "N1_A2_ClientType", rs.A12, null, 
                       "N1_A3_Residental", rs.A13, null, 
                       "N1_A4_RiskLevel", rs.A14, null, 
                       "N1_A5_Qualification", rs.A15, null, 
                       "N1_A6_NPRStatus", rs.A16, null, 
                       "N1_A7_MarginMethod", rs.A17, null, 
                       "N1_A8_QuantityGroup", rs.A18, null, 
                       "N1_A9_ClientsAmount", rs.A19, null,
                       "A1_A10_PortfolioAmount", rs.A110, null, 
                       "N1_A11_NPR1", rs.A111, null, 
                       "N1_A12_NPR2", rs.A112, null, 
                       "N1_A13_PortfolioCost", rs.A113, null, 
                       "N1_A14_LongCostRub", rs.A114, null, 
                       "N1_A15_LongCostCur", rs.A115, null, 
                       "N1_A16_LongCostCb", rs.A116, null, 
                       "N1_A17_LongCostFut", rs.A117, null,
                       "N1_A18_LongCostOpt", rs.A118, null, 
                       "N1_A19_LongCostOther", rs.A119, null, 
                       "N1_A20_ShortCostRub", rs.A120, null, 
                       "N1_A21_ShortCostCur", rs.A121, null, 
                       "N1_A22_ShortCostCb", rs.A122, null, 
                       "N1_A23_ShortCostFut", rs.A123, null, 
                       "N1_A24_ShortCostOpt", rs.A124, null, 
                       "N1_A25_ShortCostOther", rs.A125, null,
                       "N1_A26_LongIntCost", rs.A126, null, 
                       "N1_A27_ShortIntCost", rs.A127, null, 
                       "N1_A28_InitMargin", rs.A128, null, 
                       "N1_A29_InitMarginRub", rs.A129, null, 
                       "N1_A30_InitMarginCb", rs.A130, null, 
                       "N1_A31_InitMarginFut", rs.A131, null, 
                       "N1_A32_InitMarginOpt", rs.A132, null, 
                       "N1_A33_InitMarginOther", rs.A133, null,
                       "N1_A34_InternalMargin", rs.A134, null,
                       "N1_A35_MarketMargin", rs.A135, null                        
                       );
        Count = Count + 1;
      end;

      if(not firstRow)
        EndTable();
        IT_Log("Сформирован CSV для раздела 1 отчета", SessionID);
        CopyAllSheetInTotalBook("Раздел 1", false, GetTableRange(), 0, "Раздел 1");

        if (m_Detail)
          PrintDetail(ObjReport, SessionID, CHAPTER_1);
        end;
      else
        msgbox("Нет данных для отражения в 1 разделе");     
      end;

      UseProgress(1);
      RemProgress();

      IT_Log("Заполнен раздел 1 отчета", SessionID); 
      UseProgress(1);
    end;

    if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_2))
      firstRow = true;
      Count = 1;
      IT_Log("Заполнение раздела 2 отчета", SessionID);

      if(false)//Для отладки, пока не реализовано
        if(firstRow)
          if(not m_IsDataExist)
            m_IsDataExist = true;
            PrintHeaderList (UNSET_CHAR);
          end;

          firstRow = false;
          SetActiveSheet( "Раздел 2" );
          CopyAllSheetInTotalBook( "Раздел 2", false, "N2_HEADER", 0, "Раздел 2" );
          CopyAllSheetInTotalBook( "Раздел 2", false, "N2_TABLEHEADER", 1, "Раздел 2" );

          RegisterTable("N2_MAINTABLE", "", "N2_A1_Num", "N2_A2_ClientType", "N2_A3_Residental", "N2_A4_RiskLevel", "N2_A5_Qualification", "N2_A6_ControlTime", "N2_A7_NRP2Group",
                        "N2_A8_MarketDate","N2_A9_ClientsAmount", "N2_A10_PortfolioAmount", "N2_A11_NPR1", "N2_A12_NPR2", "N2_A13_PortfolioCost", "N2_A14_InitMargin"
                       );
        end;

        PrintTableLine("N2_A1_Num", Count, null, 
                       "N2_A2_ClientType", 2, null, 
                       "N2_A3_Residental", 3, null, 
                       "N2_A4_RiskLevel", 1, null, 
                       "N2_A5_Qualification", 2, null,
                       "N2_A6_ControlTime", 7, null, 
                       "N2_A7_NRP2Group", 3, null, 
                       "N2_A8_MarketDate", 1, null, 
                       "N2_A9_ClientsAmount", 2, null, 
                       "N2_A10_PortfolioAmount", 3, null,
                       "N2_A11_NPR1", 1, null, 
                       "N2_A12_NPR2", 2, null, 
                       "N2_A13_PortfolioCost", 3, null, 
                       "N2_A14_InitMargin", 1, null                        
                      );
        Count = Count + 1;
      end;

      if(not firstRow)
        EndTable();
        IT_Log("Сформирован CSV для раздела 2 отчета", SessionID);
        CopyAllSheetInTotalBook("Раздел 2", false, GetTableRange(), 0, "Раздел 2");

        if (m_Detail)
          PrintDetail(ObjReport, SessionID, CHAPTER_2);
        end;
      else
        msgbox("Нет данных для отражения во 2 разделе"); 
      end;

      IT_Log("Заполнен раздел 2 отчета", SessionID); 
      UseProgress(2);
    end;

    if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_3))
      firstRow = true;
      Count = 1;
      IT_Log("Заполнение раздела 3 отчета", SessionID);

      if(false)//Для отладки, пока не реализовано
        if(firstRow)
          if(not m_IsDataExist)
            m_IsDataExist = true;               
            PrintHeaderList (UNSET_CHAR);
          end;

          firstRow = false;
          SetActiveSheet( "Раздел 3" );
          CopyAllSheetInTotalBook( "Раздел 3", false, "N3_HEADER", 0, "Раздел 3" );
          CopyAllSheetInTotalBook( "Раздел 3", false, "N3_TABLEHEADER", 1, "Раздел 3" );

          RegisterTable("N3_MAINTABLE", "", "N3_A1_Num", "N3_A2_ClientType", "N3_A3_Residental", "N3_A4_RiskLevel", "N3_A5_Qualification", "N3_A6_NPRStatus", "N3_A7_MarketDate",
                        "N3_A8_ClientsAmount","N3_A9_PortfolioAmount", "N3_A10_NPR1", "N3_A11_NPR2", "N3_A12_PortfolioCost", "N3_A13_ShortCostCur", "N3_A14_ShortCostCb",
                        "N3_A15_ShortCostOther", "N3_A16_InitMargin"
                       );
        end;

        PrintTableLine("N3_A1_Num", Count, null, 
                       "N3_A2_ClientType", 2, null, 
                       "N3_A3_Residental", 3, null, 
                       "N3_A4_RiskLevel", 1, null, 
                       "N3_A5_Qualification", 2, null,
                       "N3_A6_NPRStatus", 7, null, 
                       "N3_A7_MarketDate", 3, null, 
                       "N3_A8_ClientsAmount", 1, null, 
                       "N3_A9_PortfolioAmount", 2, null, 
                       "N3_A10_NPR1", 3, null,
                       "N3_A11_NPR2", 1, null, 
                       "N3_A12_PortfolioCost", 2, null, 
                       "N3_A13_ShortCostCur", 3, null,
                       "N3_A14_ShortCostCb", 2, null, 
                       "N3_A15_ShortCostOther", 3, null,  
                       "N3_A16_InitMargin", 1, null                        
                       );
        Count = Count + 1;
      end;

      if(not firstRow)
        EndTable();
        IT_Log("Сформирован CSV для раздела 3 отчета", SessionID);
        CopyAllSheetInTotalBook("Раздел 3", false, GetTableRange(), 0, "Раздел 3");

        if (m_Detail)
          PrintDetail(ObjReport, SessionID, CHAPTER_3);
        end;
      else
        msgbox("Нет данных для отражения в 3 разделе"); 
      end;

      IT_Log("Заполнен раздел 3 отчета", SessionID); 
      UseProgress(3);
    end;

    if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_4))
      firstRow = true;
      Count = 1;
      IT_Log("Заполнение раздела 4 отчета", SessionID);

      if(false)//Для отладки, пока не реализовано
        if(firstRow)
          if(not m_IsDataExist)
            m_IsDataExist = true;
            PrintHeaderList (UNSET_CHAR);
          end;

          firstRow = false;
          SetActiveSheet( "Раздел 4" );
          CopyAllSheetInTotalBook( "Раздел 4", false, "N4_HEADER", 0, "Раздел 4" );
          CopyAllSheetInTotalBook( "Раздел 4", false, "N4_TABLEHEADER", 1, "Раздел 4" );

          RegisterTable("N4_MAINTABLE", "", "N4_A1_Num", "N4_A2_ClientType", "N4_A3_Residental", "N4_A4_RiskLevel", "N4_A5_Qualification", "N4_A6_ActiveType", "N4_A7_ActiveCode",
                        "N4_A8_ActiveAmount", "N4_A9_ShortCost"
                       );
        end;

        PrintTableLine("N4_A1_Num", Count, null, 
                       "N4_A2_ClientType", 2, null, 
                       "N4_A3_Residental", 3, null, 
                       "N4_A4_RiskLevel", 1, null, 
                       "N4_A5_Qualification", 2, null,
                       "N4_A6_ActiveType", 7, null, 
                       "N4_A7_ActiveCode", 3, null, 
                       "N4_A8_ActiveAmount", 1, null, 
                       "N4_A9_ShortCost", 2, null                        
                     );
        Count = Count + 1;
      end;

      if(not firstRow)
        EndTable();
        IT_Log("Сформирован CSV для раздела 4 отчета", SessionID);
        CopyAllSheetInTotalBook("Раздел 4", false, GetTableRange(), 0, "Раздел 4");

        if (m_Detail)
          PrintDetail(ObjReport, SessionID, CHAPTER_4);
        end;
      else
        msgbox("Нет данных для отражения в 4 разделе"); 
      end
;
      IT_Log("Заполнен раздел 4 отчета", SessionID); 
      UseProgress(4);

      // Раздел 4.1
      IT_Log("Заполнение подраздела 4.1 отчета", SessionID);
      firstRow = true;
      Count = 1;

      if(false)//Для отладки, пока не реализовано
        if(firstRow)
          if(not m_IsDataExist)
            m_IsDataExist = true;
            PrintHeaderList (UNSET_CHAR);
          end;

          firstRow = false;
          SetActiveSheet( "Раздел 4.1" );
          CopyAllSheetInTotalBook( "Раздел 4.1", false, "N4_1_HEADER", 0, "Раздел 4.1" );
          CopyAllSheetInTotalBook( "Раздел 4.1", false, "N4_1_TABLEHEADER", 1, "Раздел 4.1" );

          RegisterTable("N4_1_MAINTABLE", "", "N4_1_A1_Num", "N4_1_A2_ActiveCode", "N4_1_A3_AvrType", "N4_1_A4_LSIN", "N4_1_A5_ISIN", "N4_1_A6_CFI", "N4_1_A7_CurCode",
                        "N4_1_A8_NomCost", "N4_1_A9_EmitName", "N4_1_A10_EmitINN", "N4_1_A11_EmitOGRN", "N4_1_A12_EmitCountry"
                       );
        end;

        PrintTableLine("N4_1_A1_Num", Count, null, 
                       "N4_1_A2_ActiveCode", 2, null, 
                       "N4_1_A3_AvrType", 3, null, 
                       "N4_1_A4_LSIN", 1, null, 
                       "N4_1_A5_ISIN", 2, null,
                       "N4_1_A6_CFI", 7, null, 
                       "N4_1_A7_CurCode", 3, null, 
                       "N4_1_A8_NomCost", 1, null,
                       "N4_1_A9_EmitName", 7, null, 
                       "N4_1_A10_EmitINN", 3, null, 
                       "N4_1_A11_EmitOGRN", 1, null, 
                       "N4_1_A12_EmitCountry", 2, null                        
                       );
        Count = Count + 1;
      end;

      if(not firstRow)
        EndTable();
        IT_Log("Сформирован CSV для подраздела 4.1 отчета", SessionID);
        CopyAllSheetInTotalBook("Раздел 4.1", false, GetTableRange(), 0, "Раздел 4.1");
      else
        msgbox("Нет данных для отражения в подразделе 4.1"); 
      end;

      IT_Log("Заполнен подраздел 4.1 отчета", SessionID); 
      UseProgress(5);
    end;

    if ((m_Chapter == CHAPTER_ALL) or (m_Chapter == CHAPTER_5))
      firstRow = true;
      Count = 1;
      IT_Log("Заполнение раздела 5 отчета", SessionID);

      if(false)//Для отладки, пока не реализовано
        if(firstRow)
          if(not m_IsDataExist)
            m_IsDataExist = true;
            PrintHeaderList (UNSET_CHAR);
          end;

          firstRow = false;
          SetActiveSheet( "Раздел 5" );
          CopyAllSheetInTotalBook( "Раздел 5", false, "N5_HEADER", 0, "Раздел 5" );
          CopyAllSheetInTotalBook( "Раздел 5", false, "N5_TABLEHEADER", 1, "Раздел 5" );

          RegisterTable("N5_MAINTABLE", "", "N5_A1_Num", "N5_A2_ClientType", "N5_A3_Residental", "N5_A4_RiskLevel", "N5_A5_Qualification", "N5_A6_CloseGroup", "N5_A7_MarketDate",
                        "N5_A8_ClientsAmount","N5_A9_PortfolioAmount", "N5_A10_CloseAmount", "N5_A11_CloseBuyCb", "N5_A12_CloseSellCb", "N5_A13_CloseBuyCur", "N5_A14_CloseSellCur",
                        "N5_A15_CloseBuyFut", "N5_A16_CloseSellFut", "N5_A17_CloseBuyOpt", "N5_A18_CloseSellOpt", "N5_A19_CloseBuyOther", "N5_A20_CloseSellOther"
                       );
        end;

        PrintTableLine("N5_A1_Num", Count, null, 
                       "N5_A2_ClientType", 2, null, 
                       "N5_A3_Residental", 3, null, 
                       "N5_A4_RiskLevel", 1, null, 
                       "N5_A5_Qualification", 2, null,
                       "N5_A6_CloseGroup", 7, null, 
                       "N5_A7_MarketDate", 3, null, 
                       "N5_A8_ClientsAmount", 1, null, 
                       "N5_A9_PortfolioAmount", 2, null, 
                       "N5_A10_CloseAmount", 3, null,
                       "N5_A11_CloseBuyCb", 1, null, 
                       "N5_A12_CloseSellCb", 2, null, 
                       "N5_A13_CloseBuyCur", 3, null,
                       "N5_A14_CloseSellCur", 2, null, 
                       "N5_A15_CloseBuyFut", 3, null,  
                       "N5_A16_CloseSellFut", 1, null,
                       "N5_A17_CloseBuyOpt", 3, null,
                       "N5_A18_CloseSellOpt", 2, null, 
                       "N5_A19_CloseBuyOther", 3, null,  
                       "N5_A20_CloseSellOther", 1, null                        
                       );
        Count = Count + 1;
      end;

      if(not firstRow)
        EndTable();
        IT_Log("Сформирован CSV для раздела 5 отчета", SessionID);
        CopyAllSheetInTotalBook("Раздел 5", false, GetTableRange(), 0, "Раздел 5");
        if (m_Detail)
          PrintDetail(ObjReport, SessionID, CHAPTER_5);
        end;;
      else
        msgbox("Нет данных для отражения в 5 разделе"); 
      end;

      IT_Log("Заполнен раздел 5 отчета", SessionID); 
      UseProgress(6);
    end;

    if(not m_IsDataExist)
      PrintHeaderList(SET_CHAR);
    end;

    RemProgress();
                                                                                                                                                                                   
    var ProtocolSelect = DL_RSDCommand("SELECT DISTINCT t_Message FROM DARNUREPERR_DBT WHERE t_SessionID = ?");
    ProtocolSelect.AddParam(SessionID);
    var ProtocolDS = ProtocolSelect.execute();
    while(ProtocolDS.MoveNext())
      msgbox(ProtocolDS.Message);
    end;

    IT_Log("Отчет сформирован", SessionID);

    var LogFileName = GetTxtFileName( "rep725_log_" + SessionID );
    if( Open( ReportLogFile, LogFileName ) == false )
       var errtext = "";
       var errcode = status( errtext );
       MsgBox( "Ошибка при открытии файла логов|"+ LogFileName +"|(" + errcode + ") " + errtext);
       break;
    end;

    SetOutput( LogFileName );
    Query = "select create_sysdate, SUBSTR(msg, INSTR(msg, ' ') + 1) msg from itt_log where create_sysdate between TRUNC(SYSDATE)-1 and TRUNC(SYSDATE)+1 and msg like 'pSessionID="+SessionID+"%' order by id_log asc";
    Select = DL_RSDCommand(Query);
    rs = Select.execute();
    while ( rs.MoveNext() )
       println(string(date(rs.create_sysdate))+" "+string(time(rs.create_sysdate))+" "+rs.msg);
    end;
    SetOutput( NULL, true );
    close( ReportLogFile );

    var log_file_name_term = "$" + SC_GetFullPath(true) + LogFileName;
    if(ExistFile(log_file_name_term))
       RemoveFile(log_file_name_term);
    end;
    if (not copyFile(LogFileName,log_file_name_term,true,"Копирование на терминал"))
       msgbox("Ошибка при копировании " + LogFileName + " на терминал");
    else
       msgbox("Сформирован файл с информацией о времени формирования отчета " + LogFileName);
    end;

    msgbox("Номер сессии: " + SessionID);

  END;

  MACRO Create()
    SetXLSXFormat();
    ExecuteReport();
  END;

  MACRO EndReport()
    SaveTotalbook();
  END;

  macro GetAuditMsg(panel:DL_CPanel):String
    var msg:string = "";
    var period:string = "";
    var deals1:string = "";
    var deals2:string = "";

    period = PeriodName_GetMonthsAndQuart(
                panel.GetFieldValue(PNFLD_Form725_MONTH),
                panel.GetFieldValue(PNFLD_Form725_YEAR));


    msg =
    "Отчет:              Сведения об осуществлении брокерской деятельности и деятельности по управлению ценными бумагами (ф.725)\n\n" +
    "Отчет за:           " + period + "\n" +
    "\n----------------------------------------\n";

    return msg;
  end;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReport );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)

  var stat = true;
  var FullReportFileNames = TArray();

  if( not IsWebService )
    Form725 = DLReport725_Form();
  end;

  while( stat )
    if( not IsWebService )
      stat = Form725.Run();
    end;

    if( stat )
      Report725 = DlReport725( null, "Report_725.xlsx", null, IsWebService, ReportHashCode, POI_MODE, BIGREPORT_MODE );
      Report725.Run(null, Report725.GetAuditMsg(Form725));

      if( IsWebService )
        Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = Report725.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
      end;
    end;
  end;

  return FullReportFileNames;
END;

ReportRunEx(false);