/*
$Name:         dl_report_Over4742.mac
$Module:       ФИССиКО
$Description:  Отчет "Проверка переоценки по счетам 47421/47424"
*/

IMPORT "DLReport_h.mac", "dl_Report_OVER4742_Form.mac", "dl_report_log.mac", oralib, "dv_categ.mac", "scsrvrepfun.mac";

PRIVATE VAR ReportHeader =
" ##########################################                                                                            \n" + 
"                                                                                                                       \n" +
"                          ############################################################################                 \n";

PRIVATE VAR TableHeader = 
"┌────────────────────────────────┬──────────────────────────────┬──────────────────────────────────┬────────────────────────────────┬─────────────────────────┐\n"+
"│        Дата проверки           │          Номер сделки        │   Сумма начисленной переоценки   │   Сумма списанной переоценки   │     Сумма расхождения   │\n"+
"│                                │                              │              (руб.)              │             (руб.)             │          (руб.)         │\n"+
"├────────────────────────────────┼──────────────────────────────┼──────────────────────────────────┼────────────────────────────────┼─────────────────────────┤";

PRIVATE VAR ReportExecutor = 
" ##################################################################################\n";

PRIVATE VAR
  m_Date:DATE,
  m_DepartmentID:INTEGER,
  m_FiKind:INTEGER,
  m_FIID:INTEGER,
  IsApostr:STRING,
  IsExcel:STRING;

PRIVATE VAR Report_OVER4742_Form;

PRIVATE CONST DV_FORWARD_MET_FX = 9;

PRIVATE MACRO Операционист()
  var RS = TRsbDataSet("SELECT person.t_Name " +
                       "  FROM dperson_dbt person " +
                       " WHERE person.t_Oper = " + string({oper})
                       );

  if( RS.MoveNext() )
    return RS.Name;
  end;
  return "";
END;


PRIVATE MACRO РАЗНОВАЛЮТ()
    const RegPath = "ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\УЧЕТ_РАЗНОВАЛЮТ_БАНКНОТ_СДЕЛОК";
    var DiffCur = "", err;
    GetRegistryValue( RegPath, V_BOOL, DiffCur, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( DiffCur == "X" )
            return 1;
        else
            return 0;
        end;
    end;
end;

PRIVATE CLASS ProtocolRow(Text,Status)
  var B2 = Text, B3 = Status;
END;

PRIVATE CLASS ( DL_CReportTemplate ) DL_Report_OVER4742( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
    Var CurDate = date(), CurTime = time(), m_CurrSheetName = "";
    var CurLog = DL_ReportLog(ReportBIQ8582_Over4742, CurDate, CurTime, m_Date);
    var ErrorCount = 0;
    var ProtocolRows = TArray();
    
    PRIVATE MACRO CheckProtocolRow(IsEnd)
      var writeInFile = false;
      var i;
      if((ProtocolRows.size >= 500) OR IsEnd)
        writeInFile = true;
       end;

      if (writeInFile)
        CurLog.AddLogBatch(ProtocolRows);
        ProtocolRows =  TArray();
        ProtocolRows.size = 0;
      end;
    END;
    
    PRIVATE MACRO AddInProtocol(Text, Status)
      ProtocolRows[ProtocolRows.size] = ProtocolRow(Text, Status);
    end;
    
    PRIVATE MACRO PrintMode():INTEGER
        if (IsExcel == SET_CHAR)
          return DL_OUTREPORT_EXCEL;
        end;
        return DL_OUTREPORT_STD;
    END;

    PRIVATE MACRO PrintLine(A1, A2, A3, A4, A5)
      PrintTableLine( "N1_A1",  A1, null,
                      "N1_A2",  A2, null,
                      "N1_A3",  A3, null,
                      "N1_A4",  A4, null,
                      "N1_A5",  A5, null);
    END;

    PRIVATE MACRO DigitIsApp(digit)
      if( IsExcel == UNSET_CHAR)
         if(IsApostr == SET_CHAR)
            if(ValType(digit) != V_UNDEF)
              return string(digit:a);
            end;
         else
            return string(digit);
         end;
      else
         return digit;
      end;
    end;

    PRIVATE MACRO ЕстьСчетИОстаток()
        return "SELECT SUM (rsb_account.restac (q.t_Account, " +
                        "                                     q.t_Currency, " +
                        "                                     ?, " +
                        "                                     q.t_Chapter, 0," +
                        "                                 " + NATCUR + ")) " +
                        "            rests" +
                        "  FROM (SELECT DISTINCT accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                        "          FROM DMCACCDOC_DBT accdoc " +
                        "         WHERE     accdoc.t_catid IN (SELECT cat.t_id " +
                        "                                        FROM DMCCATEG_DBT cat " +
                        "                                       WHERE cat.t_code IN ('+Форвард, прочие', '-Форвард, прочие','+Форвард, прочие0', '-Форвард, прочие0')) " +
                        "               AND accdoc.t_docid = dvn.t_id " +
                        "               AND accdoc.t_dockind = dvn.t_dockind " +
                        " AND ACCDOC.T_ACTIVATEDATE <= ? " +
                        "               AND ACCDOC.T_ACTIVATEDATE >= dvn.t_date) q";
    end;
    
    private macro ОтборПроводкиСписания()
       return "SELECT NVL (trn.T_SUM_NATCUR, 0) trnsum, NVL(TRN.T_ACCOUNT_PAYER,'') NumAcc" + 
                            "  FROM dacctrn_dbt   trn,  " + 
                            "       DOPRDOCS_DBT  oprd, " +  
                            "       DOPROPER_DBT  opro  " + 
 
                            " WHERE     OPRO.T_DOCKIND = 4813  " + 
                            "       AND OPRO.T_DOCUMENTID = LPAD(dvn.t_id,34,'0')  " + 
                            "       AND oprd.T_ID_OPERATION = OPRO.T_ID_OPERATION  " + 
                            "       AND TRN.T_ACCTRNID = oprd.t_acctrnid  " + 
                            "       AND TRN.T_STATE = 1 " + 
                            "       AND TRN.T_DATE_CARRY = ? " + 
                            "       AND ( EXISTS  " + 
                            "               (SELECT *  " + 
                            "                  FROM dmcaccdoc_dbt doc_d  " + 
                            "                 WHERE     doc_d.t_account = TRN.T_ACCOUNT_PAYER  " + 
                            "                       AND doc_d.t_catid IN  " + 
                            "       (SELECT cat_d.T_ID  " + 
                            "          FROM dmccateg_dbt cat_d  " + 
                            "         WHERE cat_d.t_code IN  " + 
                            
                            "                   ('-Переоц.,поставка ИВ и ДМ',  " + 
                            "                    '+Переоц.,поставка ИВ и ДМ',  " + 
                            "                    '-Переоц.,поставка0',  " + 
                            "                    '+Переоц.,поставка0') " + 
                            "       )   )  " + 
                            "       AND EXISTS  " + 
                            "               (SELECT *  " + 
                            "                  FROM dmcaccdoc_dbt doc_c  " + 
                            "                 WHERE     doc_c.t_account = TRN.T_ACCOUNT_RECEIVER  " + 
                            "                       AND doc_c.t_catid IN  " +
                            "       (SELECT cat_c.T_ID  " + 
                            "          FROM dmccateg_dbt cat_c  " + 
                            "         WHERE cat_c.t_code IN  " + 
                            
                            "                   ('-Форвард, расчеты', " +  
                            "                    '+Форвард, расчеты', " +
                            "                    '-Форвард, расчеты0', " +
                            "                    '+Форвард, расчеты0', " +
                            "                    '-Форвард, расчеты0Б', " +
                            "                    '+Форвард, расчеты0Б', " +
                            "                    '-Форвард, расчетыДМ', " +
                            "                    '+Форвард, расчетыДМ', " +
                            "                    'Выбытие ДМ') " +
                            "       )  )  " +
                            "       OR EXISTS  " + 
                            "               (SELECT *  " + 
                            "                  FROM dmcaccdoc_dbt doc_d  " + 
                            "                 WHERE     doc_d.t_account = TRN.T_ACCOUNT_RECEIVER   " + 
                            "                       AND doc_d.t_catid IN  " + 
                            "       (SELECT cat_d.T_ID  " + 
                            "          FROM dmccateg_dbt cat_d  " + 
                            "         WHERE cat_d.t_code IN  " + 
                            
                            "                   ('-Переоц.,поставка ИВ и ДМ',  " + 
                            "                    '+Переоц.,поставка ИВ и ДМ',  " + 
                            "                    '-Переоц.,поставка0',  " + 
                            "                    '+Переоц.,поставка0') " + 
                            "       )   )  " + 
                            "       AND EXISTS  " + 
                            "               (SELECT *  " + 
                            "                  FROM dmcaccdoc_dbt doc_c  " + 
                            "                 WHERE     doc_c.t_account = TRN.T_ACCOUNT_PAYER  " + 
                            "                       AND doc_c.t_catid IN  " +
                            "       (SELECT cat_c.T_ID  " + 
                            "          FROM dmccateg_dbt cat_c  " + 
                            "         WHERE cat_c.t_code IN  " + 
                            
                            "                   ('-Форвард, расчеты', " +  
                            "                    '+Форвард, расчеты', " +
                            "                    '-Форвард, расчеты0', " +
                            "                    '+Форвард, расчеты0', " +
                            "                    '-Форвард, расчеты0Б', " +
                            "                    '+Форвард, расчеты0Б', " +
                            "                    '-Форвард, расчетыДМ', " +
                            "                    '+Форвард, расчетыДМ', " +
                            "                    'Выбытие ДМ') " +
                            "       )  ) ) " +
                            "      AND ROWNUM = 1  ";
   end;

    PRIVATE MACRO UpdateOrInsert(CurRec, A5, IsUpdate:@bool)
      var Query = "", cmd;
      if(IsUpdate)
        Query = "UPDATE DDL_REPORT_OVER4742_TMP SET T_REST_CALC = ?, T_REST_WRITTEN = ?, T_DIVERG = ? WHERE T_DEALID = ? AND T_DOCKIND = ?";
        cmd = RSDCommand(Query);
        cmd.AddParam("", RSDBP_IN, CurRec.REST_CALC);
        cmd.AddParam("", RSDBP_IN, CurRec.REST_WRITTEN);
        cmd.AddParam("", RSDBP_IN, A5);
        cmd.AddParam("", RSDBP_IN, CurRec.DealID);
        cmd.AddParam("", RSDBP_IN, CurRec.DocKind);
        cmd.execute();
        IsUpdate = false;
      else
        Query = "INSERT INTO DDL_REPORT_OVER4742_TMP (T_DEALID, " +
                            "           T_DOCKIND, " +
                            "           T_DEALCODE, " +
                            "           T_REST_CALC, " +
                            "           T_REST_WRITTEN, " +
                            "           T_DIVERG, T_NUMACC, T_EXIST_ACC) " +
                "VALUES (?,?,?,?,?,?,?,?)";
        cmd = RSDCommand(Query);  
        cmd.AddParam("", RSDBP_IN, CurRec.DealID);
        cmd.AddParam("", RSDBP_IN, CurRec.DocKind);
        cmd.AddParam("", RSDBP_IN, CurRec.DealCode);
        cmd.AddParam("", RSDBP_IN, CurRec.REST_CALC);
        cmd.AddParam("", RSDBP_IN, CurRec.REST_WRITTEN);
        cmd.AddParam("", RSDBP_IN, A5);
        cmd.AddParam("", RSDBP_IN, CurRec.NUMACC);
        cmd.AddParam("", RSDBP_IN, CurRec.EXIST_ACC);
        cmd.execute();
      end;
    END;

    PRIVATE MACRO GetDateAndPrint(progress)
      var m_DataQuery_ins = "";
      var m_DataQuery_exec;
      var m_RS, m_DataQuery = "";
      var m_Recs = 0;
      var FD;
      var Sпер_D1 = 0, SБА = 0, Rофиц_БА = 0, Rсделки = 0, Rофиц_КА = 0;
      var ОстПереоц = 0;
      var НомерСчета:string = "";
      var СуммаПроводки = 0;
      var IsUpdate = true;
      var m_DataQuery_print, m_RS_print;
      var IsExistDeals = true;

      execSQL("truncate table DDL_REPORT_OVER4742_TMP");
      
      m_DataQuery_ins = "INSERT INTO DDL_REPORT_OVER4742_TMP (T_DEALID, " +
                        "                                     T_DOCKIND, " +
                        "                                     T_DEALCODE, " +
                        "                                     T_REST_CALC, " +
                        "                                     T_REST_WRITTEN, " +
                        "                                     T_DIVERG, T_NUMACC, T_EXIST_ACC) " + 
                        " with recurs as (select distinct t_account from dmcaccdoc_dbt doc_d " +
                            "    where doc_d.t_catid in (select cat.T_ID " +
                            "                    from dmccateg_dbt cat " +
                            "                   where cat.t_code in " +
                             "                   ('-Переоц.,поставка ИВ и ДМ',  " + 
                            "                    '+Переоц.,поставка ИВ и ДМ',  " + 
                            "                    '-Переоц.,поставка0',  " + 
                            "                    '+Переоц.,поставка0') " + 
                                                        "  ))," +
                        " forvd as  (select distinct t_account from dmcaccdoc_dbt doc_d " +
                            "    where doc_d.t_catid in (select cat.T_ID " +
                            "                    from dmccateg_dbt cat " +
                            "                   where cat.t_code in " +
                            "                   ('-Форвард, расчеты', " +  
                            "                    '+Форвард, расчеты', " +
                            "                    '-Форвард, расчеты0', " +
                            "                    '+Форвард, расчеты0', " +
                            "                    '-Форвард, расчеты0Б', " +
                            "                    '+Форвард, расчеты0Б', " +
                            "                    '-Форвард, расчетыДМ', " +
                            "                    '+Форвард, расчетыДМ', " +
                            "                    'Выбытие ДМ') " +
                                                        "  ))," +
                       " trn as (select /*+ materialize */ * from dacctrn_dbt " +
                            " where T_DATE_CARRY = ? and T_STATE = 1 " +
                            "   and (T_ACCOUNT_PAYER in (select * from  recurs ) " +
                            "   and T_ACCOUNT_RECEIVER in (select * from forvd ) " +
                            "   or T_ACCOUNT_PAYER in (select * from  forvd ) " +
                            "   and T_ACCOUNT_RECEIVER in (select * from recurs )) ) " + 
                        "         SELECT dvn.t_id DEALID, " +
                        "                dvn.t_dockind DOCKIND, " +
                        "                dvn.t_code DEALCODE, " +
                        "                nvl((SELECT q_ovr.acc_sum FROM (select ovr.t_accum_sum acc_sum from ddvoverreg_dbt ovr where ovr.T_DOCKIND = dvn.t_dockind AND ovr.T_DOCID = dvn.t_id AND ovr.T_DATE <= ? ORDER BY ovr.T_DATE DESC) q_ovr WHERe ROWNUM = 1), 0) REST_CALC, " +
                        "                NVL(acctrn.trnsum,0) REST_WRITTEN, " +
                        "                0, " + 
                        "                NVL(acctrn.numacc,'') NUMACC,  " +
                        "                NVL ((" + ЕстьСчетИОстаток + "),0) EXIST_ACC  " +
                        "     FROM ddvndeal_dbt dvn OUTER APPLY ( select NVL(trn.T_SUM_NATCUR, 0) trnsum, NVL(TRN.T_ACCOUNT_PAYER, '') NumAcc " + // ОтборПроводкиСписания()
                                                                " from DOPROPER_DBT opro, DOPRDOCS_DBT oprd , trn " + 
                                                                "  where OPRO.T_DOCKIND = 4813 " + 
                                                                "    and OPRO.T_DOCUMENTID = LPAD(dvn.t_id, 34, '0') " + 
                                                                "    and oprd.T_ID_OPERATION = OPRO.T_ID_OPERATION " + 
                                                                "    and TRN.T_ACCTRNID = oprd.t_acctrnid " + 
                                                                "    and ROWNUM = 1) acctrn, ddvnfi_dbt DVNFI  " +
                        "    WHERE     DVN.T_CLIENT = -1 " +
                        "          AND dvn.t_date <= ? " +
                        "          AND DVNFI.T_DEALID = DVN.T_ID "
                        "          AND (DVN.T_STATE = 2 "
                        "                AND (CASE " +
                        "                     WHEN     DVNFI.T_SUPLDATE = " +
                        "                              TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                        "                          AND DVNFI.T_PAYDATE = " +
                        "                              TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                        "                     THEN " +
                        "                              DVNFI.T_EXECDATE " +
                        "                     WHEN     DVNFI.T_EXECDATE >= DVNFI.T_SUPLDATE " +
                        "                          AND DVNFI.T_EXECDATE >= DVNFI.T_PAYDATE " +
                        "                     THEN " +
                        "                              DVNFI.T_EXECDATE " +
                        "                     WHEN     DVNFI.T_SUPLDATE >= DVNFI.T_PAYDATE " +
                        "                     THEN " +
                        "                              DVNFI.T_SUPLDATE " +
                        "                     ELSE " +
                        "                               DVNFI.T_PAYDATE " +
                        "                     END) BETWEEN ? AND ? " +
                        "              OR DVN.T_STATE = 1)"
                        "          AND dvn.t_dockind = " + DL_DVFXDEAL +
                        "          AND dvn.t_dvkind IN ( " + DV_FORWARD_FX + ", " + DV_BANKNOTE_FX+ ", " + DV_FORWARD_MET_FX + ") " +
                        "          AND DVN.T_PERIODCLS != 0 " +
                        "          AND (       dvn.t_dvkind = " + DV_BANKNOTE_FX  +
                        "                  AND EXISTS " +
                        "                         (SELECT * " +
                        "                            FROM ddvnfi_dbt dvnfi_1 " +
                        "                           WHERE     dvnfi_1.T_DEALID = DVN.T_ID " +
                        "                                 AND dvnfi_1.t_fiid != dvnfi_1.T_PRICEFIID) " +
                        "                  AND 1 = ? " +
                        "               OR dvn.t_dvkind != " + DV_BANKNOTE_FX + ") " +
                        "          AND ( ? > 0 AND DVN.T_DEPARTMENT = ? OR ? < 0 )" +
                        "          AND EXISTS " +
                        "                 (SELECT fin.* " +
                        "                    FROM dfininstr_dbt fin " +
                        "                   WHERE     fin.t_fiid = dvnfi.t_fiid " +
                        "                         AND (       ? > -1 " +
                        "                                 AND (fin.t_fiid = ? AND ? > -1 OR ? <= -1) " +
                        "                                 AND fin.t_fi_kind = ? " +
                        "                              OR ? <= -1 AND fin.t_fi_kind IN ( " + FIKIND_CURRENCY + ", " + FIKIND_METAL + " )))";

      m_DataQuery_exec = RSDCommand(m_DataQuery_ins);
      
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date - 1);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, РАЗНОВАЛЮТ());
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_FiKind);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_FIID);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_FIID);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_FIID);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_FiKind);
      m_DataQuery_exec.AddParam( "", RSDBP_IN, m_FiKind);
      m_DataQuery_exec.execute();

      m_DataQuery = "SELECT * FROM DDL_REPORT_OVER4742_TMP";
    
      m_RS = TRsbDataSet( m_DataQuery, RSDVAL_CLIENT, RSDVAL_STATIC  );
      while(m_RS.MoveNext())
        if(not IsExistDeals)
          AddInProtocol("Поиск сделок с переоценкой по счетам 47421/47424", "найдены");
          IsExistDeals = true;
        end;
        Sпер_D1 = 0; SБА = 0; Rофиц_БА = 0; Rсделки = 0; Rофиц_КА = 0; ОстПереоц = 0; IsUpdate = true; НомерСчета = "";
        FD = DVFirstDocFXDeal(m_Rs.DocKind, m_Rs.DealID);
        if (FD.ВалютаКонтрАктива() == NATCUR)
          var cost = $0;
          SБА = FD.nFI.rec.Amount;
          Rофиц_БА = GetRateOnDate( m_Date, FD.ВалютаБазовогоАктива(), NATCUR, false, 0, NULL, NULL);
          Rсделки = FD.nFI.rec.Price;
          cost = SБА * Rсделки;
          if (FD.IsDealMet())
            cost = cost - IIF((FD.nFI.rec.VatSum >= $0), FD.nFI.rec.VatSum, $0);
          end;
          Sпер_D1 = round(SБА * Rофиц_БА,2) - round(cost,2);
        else
          SБА = FD.nFI.rec.Amount;
          Rофиц_БА = GetRateOnDate( m_Date, FD.ВалютаБазовогоАктива(), NATCUR, false, 0, NULL, NULL);
          Rофиц_КА = GetRateOnDate( m_Date, FD.ВалютаКонтрАктива(), NATCUR, false, 0, NULL, NULL);
          Sпер_D1 = round(SБА * Rофиц_БА,2) - round(SБА * Rофиц_КА,2);
        end;
        
        СуммаПроводки = m_RS.REST_WRITTEN;
        НомерСчета = IIF(valType(m_RS.NUMACC) != V_UNDEF,m_RS.NUMACC, "");
        
        AddInProtocol("Определение параметра Sпер_D1 по сделке " + m_Rs.DealCode, IIF(Sпер_D1 != 0, "выполнено", "не выполнено"));
        if ((FD.Deal.rec.Date <= m_Date) and m_RS.EXIST_ACC != 0/*ЕстьСчетИОстаток(m_RS.DealID, m_Rs.DocKind, FD.Deal.rec.Date)*/)
          ОстПереоц = abs(m_RS.T_REST_CALC);
          if(abs(Sпер_D1) == ОстПереоц)
            ErrorCount = ErrorCount + 1;
          else
            UpdateOrInsert(m_RS, abs(Sпер_D1) - ОстПереоц, @IsUpdate);
            ErrorCount = ErrorCount + 1;
          end;
          AddInProtocol("Сверка накопленной переоценки Sпер_D1 с данными регистра переоценки по сделке", IIF(ОстПереоц != 0, "выполнено", "не выполнено"));
        end;

        if ((abs(Sпер_D1) != СуммаПроводки) and (НомерСчета != ""))
          UpdateOrInsert(m_RS, abs(Sпер_D1) - СуммаПроводки, @IsUpdate);
          ErrorCount = ErrorCount + 1;
        end;
        if(НомерСчета != "")
          AddInProtocol("Проверка списанной переоценки на счет " + НомерСчета, IIF(СуммаПроводки != 0, "выполнено", "не выполнено"));
        end;

        UseProgress(progress = progress + 1);
        CheckProtocolRow(false);
      end;
      RemProgress();
      if(not IsExistDeals)
        AddInProtocol("Поиск сделок с переоценкой по счетам 47421/47424", "не найдено");
      end;
      CheckProtocolRow(true);
      m_DataQuery_print = RSDCommand("SELECT * FROM DDL_REPORT_OVER4742_TMP WHERE NOT (T_DIVERG = 0 AND T_EXIST_ACC = 0 ) ORDER BY T_DIVERG DESC, T_DEALCODE");
      m_RS_print = TRsbDataSet( m_DataQuery_print );

      while(m_RS_print.MoveNext())
        PrintLine(/*1*/m_Date,
                  /*2*/m_RS_print.DealCode,
                  /*3*/DigitIsApp(m_RS_print.REST_CALC),
                  /*4*/DigitIsApp(m_RS_print.REST_WRITTEN),
                  /*5*/DigitIsApp(m_RS_print.DIVERG)
          );
      end;

      CurLog.EndLoggingTable();
     
      if(ErrorCount > 0)
        CurLog.ErrorHistoryRec();
      end;

      CurLog.EndLogging();

    END;

    PRIVATE MACRO BeginReport( NumCopy:INTEGER )
      m_CurrSheetName = "Отчет";

      Dl_CallInsertStat( PrintMode() );

      SetActiveSheet (m_CurrSheetName);
      CreateTotalBook();

    END;

    PRIVATE MACRO Create( NumCopy:INTEGER )
        var progress = 0;
        ErrorCount = 0;
        CurLog.BeginLogging();

        PrintFormatString(ReportHeader,
                     "N1_DateTime", " Переоценка 47421/47424 _ " + ZeroInFirst(CurDate, true) + " " + ZeroInFirst(CurTime, false),
                     "N1_HeaderTitle",   " Отчет проверки отражения переоценки по счетам 47421/47424 за дату " + ZeroInFirst(m_Date, true));
        CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_Header", 0, m_CurrSheetName);
        InitProgress( -1, "Идет формирование отчета", "Формирование отчета Переоценка 47421/47424 за " + ZeroInFirst(m_Date, true));
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_TableHeader", 0, m_CurrSheetName, true );
        RegisterTable(  "N1_TableData", TableHeader,
                        "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A5");
        GetDateAndPrint(progress);

        EndTable();
        CopyAllSheetInTotalBook( m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true );

        PrintFormatString(ReportExecutor,
                     "N1_Executor", "Исполнитель " + Операционист());
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_Executor", 0, m_CurrSheetName, true );
    END;

    PRIVATE MACRO CReport_Show( NumCopy:INTEGER )
      SetLastTotalBookName("Report_Over4742_" + 
                ПолучитьДатуВСтроке(m_Date) + "_" + StrSubst(StrSubst(string(date()),".",""), " ", "") + StrSubst(string(time()),":",""));
      CReport_Show(NumCopy);
    end;

    PRIVATE MACRO EndReport( NumCopy:INTEGER )
      SaveTotalBook();
    END;

    initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );
END;

MACRO RunReport()

  var stat = true;

  Report_OVER4742_Form = DL_Report_OVER4742_Form();
   
  while(stat)
    stat = Report_OVER4742_Form.Run();
   
     // Проверяем можем ли мы делать отчет по предоставленным данным
    if (not stat)
      break;
    else
      m_Date          = Report_OVER4742_Form.GetFieldValue( PNFLD_OVER4742_DATE );
      m_DepartmentID  = Report_OVER4742_Form.GetFieldValue( PNFLD_OVER4742_DEPARTCODE );
      m_FiKind        = OVER4742RepFormData.FIKind;
      m_FIID          = OVER4742RepFormData.FI;
      IsApostr        = Report_OVER4742_Form.GetFieldValue( PNFLD_OVER4742_ISAPOSTR );
      IsExcel         = Report_OVER4742_Form.GetFieldValue( PNFLD_OVER4742_EXCEL );
    end;
   
    if( stat )
      var namefiles;
      var i = 0;  
      var Report_OVER4742 = DL_Report_OVER4742( null, "Report_Over4742.xlsx", null, null, null, true );  
      Report_OVER4742.setisshowAppl(false);	  
      Report_OVER4742.Run();
      namefiles = Report_OVER4742.GetFullReportFileNames();
      Report_OVER4742 = NULL;
      for(i, namefiles)       
        СохранениеКонтрольныхОтчетов(i, ПолучитьДатуВСтроке(m_Date));
        ВыгрузкаКонтрольныхОтчетов(i);
        if(IsExcel == SET_CHAR)
          //CDAOMSExcel(i,true).Show();
          var fileName, fileExt;
          var filePath = SplitFile(i, fileName, fileExt);

          if( not isStandAlone() )
            filePath = "$" + filePath;
          end;

          SC_ShowFile(filePath, fileName+fileExt, true);
        end;
      end;
    end;
  end;

END;

RunReport();
exit(1); 