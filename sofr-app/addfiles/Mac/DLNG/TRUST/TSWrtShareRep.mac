/********************************************************************************************
 DESCRIPTION  :   é‚ÁÒ‚ "ëØ®·†≠®• Ø†•¢"
 PROGRAMMED BY:   Shalygo S.M.
 CREATION DATE:   16.04.2010
********************************************************************************************/
import "DlRepForm_h.mac", "dlwreps.mac", "tsutil.mac", "tstotal.mac", "tscateg.mac";

PRIVATE CONST PNFLD_WRT_SHARE_QUANTITY = 0,
              PNFLD_WRT_SHARE_EXCEL    = 1;

PRIVATE CONST H_QUANTITY = 100;

CLASS TSWrtShareFormData()
  VAR QuantityShare:money = $0.0,
      IsExcel:string      = "X";
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    if( FldRealValue == null )
      FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) TS_WrtShare_Panel( Point_:integer )

  private var Point = Point_;
  private var TSWrtShareRepFormData:TSWrtShareFormData;

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_WRT_SHARE_QUANTITY, H_QUANTITY,        @Default,             TSWrtShareRepFormData.QuantityShare );
     AddFieldProc( 0, PNFLD_WRT_SHARE_EXCEL,    DL_PNFLD_CHECKBOX, @DL_FldProc_CheckBox, TSWrtShareRepFormData.IsExcel       );
     DL_RslSetFldPoint( Data(), PNFLD_WRT_SHARE_QUANTITY, Point );
  END;

  MACRO GetFormFields()
     TSWrtShareRepFormData.QuantityShare = GetFieldValue( PNFLD_WRT_SHARE_QUANTITY );
     TSWrtShareRepFormData.IsExcel       = GetFieldValue( PNFLD_WRT_SHARE_EXCEL    );
  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  MACRO ReturnFormFields():TSWrtShareFormData
     GetFormFields();
     return TSWrtShareRepFormData;
  END;

  initDL_CPanel( "trust.lbr", "PWRTSHAR" );
END;



PRIVATE CLASS (DL_CReportTemplate) TS_WrtShare_Report( Data_:TSWrtShareFormData, OrderFD_:TS_OrderFD, OrderFD_OFBU_:TS_OrderFD )

  private var Data:TSWrtShareFormData = Data_;
  private var OrderFD:TS_OrderFD      = OrderFD_;
  private var OrderFD_OFBU:TS_OrderFD = OrderFD_OFBU_;

private var N1_Header = "                            #";
private var N1_HeadTable = " #";
private var TableHeader1 =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
"≥    Ñ†‚† ¢Î¢Æ§†    ≥ äÆ´®Á•·‚¢Æ ¢Î¢Æ§®¨ÎÂ ≥       ä„‡· Ø†Ô      ≥ ë‚Æ®¨Æ·‚Ï ¢Î¢Æ§®¨ÎÂ ≥\n"+
"≥                   ≥        Ø†•¢          ≥                     ≥         Ø†•¢        ≥\n"+                       
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";
private var TableHeader2 =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
"≥   Ñ†‚† ¢≠•·•≠®Ô   ≥ äÆ´®Á•·‚¢Æ ¢≠•·•≠≠ÎÂ ≥       ä„‡· Ø†Ô      ≥ ë‚Æ®¨Æ·‚Ï ¢≠•·•≠≠ÎÂ ≥    é·‚†‚Æ™ Ø†•¢     ≥  é·‚†‚Æ™ ·‚Æ®¨Æ·‚®  ≥\n"+
"≥                   ≥        Ø†•¢          ≥                     ≥         Ø†•¢        ≥                     ≥ Ø†•¢ ØÆ·´• ·Ø®·†≠®Ô ≥\n"+                       
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

  PRIVATE MACRO PrintMode():INTEGER
     if( Data.IsExcel == "X" )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
     CreateTotalBook();
     SetActiveSheet( "ëØ®·†≠®• Ø†•¢" );
  END;

  PRIVATE MACRO EndReport();
     SaveTotalBook();
  END;

  PRIVATE MACRO PrintTable1()

     var ëçè:money = $0.0;
     if(Data.QuantityShare > 0)
        ëçè = OrderFD.ëçè({curdate});
     end;

     PrintFormatString( N1_HeadTable, "N1_H2" , "ÇÎ¢Æ§ Ø†•¢ ®ß „Ø‡†¢´•≠®Ô:" );
     CopyAllSheetInTotalBook( null, false, "N1_HeadTable1", 0 );
     RegisterTable( "N1_MainTable1", TableHeader1,
                    "N1_D1",
                    "N1_A1",
                    "N1_A2",
                    "N1_A3");
     PrintTableLine( "N1_D1", TS_IIF( (Data.QuantityShare > 0), {curdate}, ""),                null,
                     "N1_A1", Data.QuantityShare,                                              OrderFD_OFBU.Order().rec.DP_AmountPrecision,
                     "N1_A2", TS_IIF( (Data.QuantityShare > 0), ëçè, ""),                      OrderFD_OFBU.Order().rec.DP_NominalPrecision,
                     "N1_A3", TS_IIF( (Data.QuantityShare > 0), Data.QuantityShare * ëçè, ""), null);
     EndTable();
     CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );

  END;

  PRIVATE MACRO PrintTable2()

     var query, DataSet;
     var RestQuantity = Data.QuantityShare;
     var FirstLine = true;
     var ëçè:money = $0.0;

     query = RSDCommand( " SELECT t_Amount, t_BalanceCost, " +
                         "        t_Date " +
                         "   FROM DPMWRTSUM_DBT            " +
                         "  WHERE t_FIID       = 0         " +
                         "    AND t_Party      = ?         " +
                         "    AND t_Contract   = ?         " +
                         "    AND t_State      = ?         " +
                         "    AND t_IsFree     = 'X'       " +
                         "    AND t_Date      <= ?         " +
                         "    AND t_Buy_Sale   = ?         " +
                         " ORDER BY t_Date ASC, t_Time ASC " );

     query.addParam( "", RSDBP_IN, OrderFD.Order().rec.Trustor   );
     query.addParam( "", RSDBP_IN, OrderFD.Order().rec.SFContrID );
     query.addParam( "", RSDBP_IN, PM_WRTSUM_FORM );
     query.addParam( "", RSDBP_IN, {curdate} );
     query.addParam( "", RSDBP_IN, PM_WRITEOFF_SUM_BUY );
     query.execute();
     DataSet = TRSBDataSet(query);

     while( DataSet.MoveNext() )

        if( FirstLine == true )
           PrintFormatString( N1_HeadTable, "N1_H3" , "è•‡•§†Á† Ø†•¢ ¢ „Ø‡†¢´•≠®•:" );
           CopyAllSheetInTotalBook( null, false, "N1_HeadTable2", 1 );
           RegisterTable( "N1_MainTable2", TableHeader2,
                          "N1_D2",
                          "N1_A4",
                          "N1_A5",
                          "N1_A6",
                          "N1_A7",
                          "N1_A8");
           FirstLine = false;
        end;

        ëçè = OrderFD.ëçè( SQL_ConvTypeDate(DataSet.rec.Date) );

        PrintTableLine( "N1_D2", SQL_ConvTypeDate(DataSet.rec.Date),                                  null,
                        "N1_A4", SQL_ConvTypeSum(DataSet.rec.Amount),                                 OrderFD_OFBU.Order().rec.DP_AmountPrecision,
                        "N1_A5", ëçè,                                                                 OrderFD_OFBU.Order().rec.DP_NominalPrecision,
                        "N1_A6", SQL_ConvTypeSum(DataSet.rec.BalanceCost),                            null,
                        "N1_A7", max( 0.0, SQL_ConvTypeSum(DataSet.rec.Amount) - RestQuantity),       OrderFD_OFBU.Order().rec.DP_AmountPrecision,
                        "N1_A8", max( 0.0, SQL_ConvTypeSum(DataSet.rec.Amount) - RestQuantity) * ëçè, null);

        RestQuantity = max( 0.0, RestQuantity - SQL_ConvTypeSum(DataSet.rec.Amount) );

     end;

     if( FirstLine == false )
        EndTable();
        CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
     end;

  END;

  PRIVATE MACRO ÇÎØ„·‚®‚Ïé‚ÁÒ‚()
     PrintFormatString( N1_Header, "N1_H1" , ("ëØ®·†≠®• Ø†•¢ ØÆ §Æ£Æ¢Æ‡„ " + OrderFD.Name() + " ¸ " + OrderFD.Number()) );
     CopyAllSheetInTotalBook( null, false, "N1_Header", 0 );
     PrintTable1();
     PrintTable2();
  END;

  PRIVATE MACRO Create() 
     ÇÎØ„·‚®‚Ïé‚ÁÒ‚();
  END;

  initDL_CReportTemplate( null, "Report_TSWrtShare.xls" );
END;

MACRO PrintReport( ID, DocKind ):bool

  var RetVal:bool = true;

  macro SayError()
     MsgBox("é‚ÁÒ‚ \"ëØ®·†≠®• Ø†•¢\" ‰Æ‡¨®‡„•‚·Ô ‚Æ´Ï™Æ ØÆ Ñè Ø†•¢Æ£Æ éîÅì.");
     RetVal = false;
  end;

  if( DocKind == TS_DOC_DPOFBU )
  
     var OrderFD      = TS_OrderFD( DocKind, ID );
     var OrderFD_OFBU = TS_OrderFD( TS_DOC_OFBU, OrderFD.Order().rec.OFBU );

     if( OrderFD_OFBU.Order().rec.DP_ShareCalc == TS_CALCPART_NOMINAL )

        var m_Form = TS_WrtShare_Panel( OrderFD_OFBU.Order().rec.DP_AmountPrecision );

        while( m_Form.Run() )
           TS_WrtShare_Report( m_Form.ReturnFormFields(), OrderFD, OrderFD_OFBU ).Run();
        end;

     else
        SayError();
     end;
  else
     SayError();
  end;

  return RetVal;
END;
