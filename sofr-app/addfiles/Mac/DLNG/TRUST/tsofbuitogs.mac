/* Подведение итогов ДУ ОФБУ.
   Выполняется при вставке цепочки из сервисной операции подведения итогов*/
IMPORT InsCarryDoc, TSInter, "tscomiss.mac", "tstrans.mac", "tsutil.mac", "tstotal.mac", "tscalcitogs.mac", "tsfunc.mac";

PRIVATE VAR ServOp = TRecHandler( "tssrvop.dbt" ); /*Сервисная операция, из которой выполняется расчет*/

PRIVATE VAR DlDoc; /*Документ проводки шага*/
PRIVATE VAR OrderFD:TS_OrderFD; /*Договор ДП, для которого происходит расчет*/
PRIVATE VAR OFBUFD:TS_OrderFD; /*Договор ОФБУ, для которого происходит расчет*/
PRIVATE VAR ID_Operation;
PRIVATE VAR ID_Step;
PRIVATE VAR ДатаСписания;
PRIVATE VAR ДатаОперации;
PRIVATE VAR UseNDFL;
PRIVATE VAR MngPlan = TRecHandler( "tsmngpln.dbt" );
PRIVATE VAR CalcCom = DataCalcCom();
/* нужен глобализм чтоб избавиться от ошибки округления*/
PRIVATE VAR СумПУ = $0;

PRIVATE MACRO Exception( RslErrObj ):INTEGER
  RemProgress();
  MsgBox( RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message);
  return 1;
END;

PRIVATE MACRO InitGlobal( Order:VARIANT ):BOOL
  OrderFD = TS_OrderFD( 0, Order );
  if( OrderFD.Order.rec.OFBU > 0 )
     OFBUFD = TS_OrderFD( 0, OrderFD.Order.rec.OFBU );
  end;

  if( OrderFD.Kind == TS_DOC_OFBU )
     MngPlan = OrderFD.MngPlan(ServOp.rec.OperDate);
  else
     MngPlan = OFBUFD.MngPlan(ServOp.rec.OperDate);
  end;

  if( not MngPlan )
     return false;
  end;
  UseNDFL = TS_IsPayerNPTaxAllCheck( OrderFD.Order.rec.Trustor, ServOp.rec.OperDate );
  return true;
END;

PRIVATE MACRO ПервоеЧислоГода(EndCalcDate)
   VAR Year;
   DateSplit(EndCalcDate, null, null, Year);
   return date(1, 1, Year);
END;


PRIVATE MACRO SaveItogsInBD( Itog:INTEGER, ЗначениеИтога ):BOOL
   if( OrderFD.SaveItog( Itog, ЗначениеИтога, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, TS_DOC_CALCITOGS_OFBU, ServOp.rec.ID, ДатаСписания ) != 0 )
      return false;
   end;
   return true;
END;

PRIVATE MACRO SaveAllItogsInBD(Itogs):BOOL
   if( (not SaveItogsInBD(ДУ_ПУ,       Itogs.rec.A23_1))  OR
       (not SaveItogsInBD(ДУ_ПУ_ф,     Itogs.rec.A23_2))  OR
       (not SaveItogsInBD(ДУ_Купр,     Itogs.rec.A30))    OR
       (not SaveItogsInBD(ДУ_Кусп,     Itogs.rec.A32_1))  OR
       (not SaveItogsInBD(ДУ_Кусп_ф,   Itogs.rec.A32_2))  OR
       (not SaveItogsInBD(ДУ_Пвыв_н,   Itogs.rec.A35_1))  OR
       (not SaveItogsInBD(ДУ_Пвыв_н_ф, Itogs.rec.A35_2))  OR
       (not SaveItogsInBD(ДУ_Пвыв_к,   Itogs.rec.A36_1))  OR
       (not SaveItogsInBD(ДУ_Пвыв_к_ф, Itogs.rec.A36_2))  OR
       (not SaveItogsInBD(ДУ_Пвыв_в,   Itogs.rec.A37_1))  OR
       (not SaveItogsInBD(ДУ_Пвыв_в_ф, Itogs.rec.A37_2))  OR
       (not SaveItogsInBD(ДУ_Нкуд,     Itogs.rec.A38_1) ) OR
       (not SaveItogsInBD(ДУ_Нкуд_ф,   Itogs.rec.A38_2) ) OR
       (not SaveItogsInBD(ДУ_ПУост,    Itogs.rec.A40) )
     )
      return false;
   end;
   return true;
END;


MACRO ПересчитатьСуммуИтоговОФБУ( _ServOp:TRecHandler, OFBU:INTEGER ):INTEGER
  VAR RS, cmd;
  cmd = RSDCommand( " UPDATE DTSCALCITOGS_TMP " +
                    "    SET ( t_A9, t_A23_1, t_A23_2, t_A30, t_A31, t_A32_1, t_A32_2, t_A35_1, t_A35_2, t_A36_1, t_A36_2, t_A37_1, t_A37_2, t_A38_1, t_A38_2 ) = " +
                    "        ( SELECT SUM(t.t_A9), SUM(t.t_A23_1), SUM(t.t_A23_2), SUM(t.t_A30), SUM(t.t_A31), SUM(t.t_A32_1), SUM(t.t_A32_2), " +
                    "                 SUM(t.t_A35_1), SUM(t.t_A35_2), SUM(t.t_A36_1), SUM(t.t_A36_2), SUM(t.t_A37_1), SUM(t.t_A37_2), SUM(t.t_A38_1), SUM(t.t_A38_2) " + 
                    "            FROM DTSCALCITOGS_TMP t " + 
                    "           WHERE t_Sort = 0 ) " +
                    "  WHERE     t_OrderID = ? " +
                    "        AND t_Sort = ? " );

  cmd.addParam( "", RSDBP_IN, OFBU );
  cmd.addParam( "", RSDBP_IN, 1 );

  cmd.execute();

  return 0;
END;

/*Вызывается 
   - из панели "Итоги расчетного периода" при изменении суммы в одном из полей
   - при расчете итогов по договору
*/
MACRO ПересчитатьСуммуИтогов( _ServOp:TRecHandler, Itog:VARIANT /*TRecHandler или TBFile*/, ItogOld:TRecHandler, isFinalDP:Bool ):INTEGER

  VAR IsFullCalc = false, ИзмПУ = false, ИзмКусп = false, ИзмПвыв = false, ИзмНДФЛ = false;
  VAR Ксрвзв = $0;
  VAR DP = $0, ПФ = $0, ДсрвзвФ = $0, Пвыв = $0, Дсрвзв = $0, Дсрвзв1 = $0, Дсрвзв2 = $0, ПУ = $0, ПУ1 = $0, ПУ2 = $0, Сум_в_н = $0, Кдв1 = $0, Кдв2 = $0;
  VAR ПУР = $0, ПУР1 = $0, ПУР2 = $0, Купр = $0, Купр1 = $0, Купр2 = $0, Нкуд = $0, Кусп = $0, Кусп1 = $0, Кусп2 = $0;
  VAR Купр1_prev, Купр2_prev, Купр_prev;
  VAR EndCalcDateComiss = GetEndCalcDateComiss(_ServOp.rec.EndDate);
  ServOp  = _ServOp;

  if( ItogOld != NULL )
     if( not InitGlobal(Itog.rec.OrderID) )
        return 1;
     end;

     if( Itog.rec.A23_2 != ItogOld.rec.A23_2 )
        ИзмПУ = true;
     end;

     if( Itog.rec.A32_2 != ItogOld.rec.A32_2 )
        ИзмКусп = true;
     end;

     if( (Itog.rec.A35_2 != ItogOld.rec.A35_2) or
         (Itog.rec.A36_2 != ItogOld.rec.A36_2) or
         (Itog.rec.A37_2 != ItogOld.rec.A37_2)
       )
        ИзмПвыв = true;
     end;

     if( Itog.rec.A38_2 != ItogOld.rec.A38_2 )
        ИзмНДФЛ = true;
     end;
  else /*полный расчет итогов*/
     IsFullCalc = true;
  end;

  if( IsFullCalc )
     /*Дсрвзв для ДП*/
     Дсрвзв = Itog.rec.A9;
     if( OrderFD.БылаПролонгация( Itog.rec.A8_1, Itog.rec.A8_2 ) )
        Дсрвзв1 = round(Дсрвзв * ( OrderFD.Valid(Itog.rec.A8_1).rec.EndDate - ServOp.rec.BegDate + 1 ) / (ServOp.rec.EndDate - ServOp.rec.BegDate + 1), 2);
        Дсрвзв2 = Дсрвзв - Дсрвзв1;
     end;

     /*Дсрвзв для ОФБУ*/
     ДсрвзвФ = СрВзКапиталОФБУ(OFBUFD.Order().rec.ID);

     /*ПФ для ОФБУ*/
     ПФ = OFBUFD.СуммаПрибылиПоФонду( EndCalcDateComiss );

     /*ПУ для ДП*/
     if( ДсрвзвФ != $0 )
        if( isFinalDP )
           ПУ = ПФ - СумПУ;
        else   
           ПУ = round(ПФ * Дсрвзв / ДсрвзвФ);
        end;
        СумПУ = СумПУ + ПУ;

        if( Дсрвзв1 != $0 )
           ПУ1 = round(ПФ * Дсрвзв1 / ДсрвзвФ);
           ПУ2 = ПУ - ПУ1;
        end;

        Itog.rec.A23_1 = ПУ;
     end;
     Itog.rec.A23_2 = Itog.rec.A23_1;

     /* Купр */
     if( OrderFD.БылаПролонгация( Itog.rec.A8_1, Itog.rec.A8_2 ) )
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                            NULL, NULL, NULL, 
                            OrderFD.Valid(Itog.rec.A8_1).rec.EndDate - 1, @Купр1_prev ) != 0 )
           return 1;
        end;
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                            NULL, NULL, NULL, 
                                OrderFD.Valid(Itog.rec.A8_1).rec.EndDate, @Купр1 ) != 0 )
           return 1;
        end;
        Купр1 = Купр1 - Купр1_prev;
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                            NULL, NULL, NULL, 
                            Itog.rec.A8_2 - 1, @Купр2_prev ) != 0 )
           return 1;
        end;
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                                NULL, NULL, NULL, 
                                Itog.rec.A8_2, @Купр2 ) != 0 )
           return 1;
        end;
        Купр2 = Купр2 - Купр2_prev;
        Купр = Купр1 + Купр2;
     else
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                                NULL, NULL, NULL, 
                                Itog.rec.A8_2 - 1, @Купр_prev ) != 0 )
           return 1;
        end;
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                                NULL, NULL, NULL, 
                                Itog.rec.A8_2, @Купр ) != 0 )
           return 1;
        end;
        Купр = Купр - Купр_prev;
     end;

     Itog.rec.A30 = Купр;
     Itog.rec.A31 = round( OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss, Itog.rec.A8_1 ) );

     /*Расчет базовой суммы для комиссии за успех*/
     /* Дистрибутивная комиссия за успех не взимается */
     /*Кусп = max (0, (   ПУ - БП -   Кдв)) * Тусп / 100, где*/
     /* увеличение Итога Н_Кдв с датой значения = началу РП */
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, Itog.rec.A8_1, NULL, NULL, Itog.rec.A8_1, @Кдв1 ) != 0 )
        return 1;
     end;

     /* увеличение Итога Н_Кдв с датой значения = концу РП */
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, Itog.rec.A8_2, NULL, NULL, Itog.rec.A8_2, @Кдв2 ) != 0 )
        return 1;
     end;

     DP = max(0, ( ПУ - Itog.rec.A31 /*БП*/ - ( Кдв2 - Кдв1 ) ) );

     if( ДатаПоследнегоИзмененияИтога( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, TS_TOTAL_SUMMA_IN ) < EndCalcDateComiss )
        if( РасчетКомиссииБанкаЗаУспех( OrderFD, ServOp.rec.ID, EndCalcDateComiss, TS_ComissSum( DP, NATCUR ), ОкончаниеПериодаКом, @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
           MsgBox( "Ошибка при расчете комиссии за успех." );
           return 1;
        end;
        Itog.rec.CalcDateS  = EndCalcDateComiss;
        Itog.rec.IDComS     = CalcCom.ConCom_S.rec.ID;
        Itog.rec.BeginDateS = CalcCom.sfdefcom_parm_S.rec.DateBegin;
        Itog.rec.EndDateS   = CalcCom.sfdefcom_parm_S.rec.DateEnd;
        Кусп                = CalcCom.sfdefcom_parm_S.rec.CommSum;
     end;
     if( OrderFD.БылаПролонгация( Itog.rec.A8_1, Itog.rec.A8_2 ) )
        Кусп1 = round(Кусп * ( OrderFD.Valid(Itog.rec.A8_1).rec.EndDate - Itog.rec.A8_1 + 1 ) / Itog.rec.A7);
        Кусп2 = Кусп - Кусп1;
     end;
     Itog.rec.A32_1 = Кусп;
     Itog.rec.A32_2 = Itog.rec.A32_1; /*фактическое значение Кусп*/

     /* ПУР */
     ПУР = ПУ - Купр - Кусп;
     if( (Купр1 + Купр2) > 0 )
        ПУР1 = ПУ1 - Купр1 - Кусп1;
        ПУР2 = ПУ2 - Купр2 - Кусп2;
     END;

     Пвыв = max(0, ПУР);

     if( UseNDFL )
        if( ЭтоКапитализация(MngPlan.rec.Flag3) OR
            ЭтоВыплата(MngPlan.rec.Flag3)
          )
           Нкуд = РассчитатьНкуд( OrderFD, EndCalcDateComiss, Пвыв );
           Пвыв = Пвыв - Нкуд;
        end;
        Itog.rec.A38_1 = Нкуд;
        Itog.rec.A38_2 = Itog.rec.A38_1;
     end;
  else
     if( ИзмПУ or ИзмКусп )
        ПУ = Itog.rec.A23_2;
        Кусп = Itog.rec.A32_2;

        if( OrderFD.БылаПролонгация( Itog.rec.A8_1, Itog.rec.A8_2 ) )
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                               NULL, NULL, NULL, 
                               OrderFD.Valid(Itog.rec.A8_1).rec.EndDate - 1, @Купр1_prev ) != 0 )
              return 1;
           end;
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                               NULL, NULL, NULL, 
                                   OrderFD.Valid(Itog.rec.A8_1).rec.EndDate, @Купр1 ) != 0 )
              return 1;
           end;
           Купр1 = Купр1 - Купр1_prev;
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                               NULL, NULL, NULL, 
                               Itog.rec.A8_2 - 1, @Купр2_prev ) != 0 )
              return 1;
           end;
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, 
                               NULL, NULL, NULL, 
                               Itog.rec.A8_2, @Купр2 ) != 0 )
              return 1;
           end;
           Купр2 = Купр2 - Купр2_prev;
           Купр = Купр1 + Купр2;

           Кусп1 = round(Кусп * ( OrderFD.Valid(Itog.rec.A8_1).rec.EndDate - Itog.rec.A8_1 + 1 ) / Itog.rec.A7);
           Кусп2 = Кусп - Кусп1;
        end;

        /* ПУР */
        ПУР = ПУ - Купр - Кусп;
        if( (Купр1 + Купр2) > 0 )
           ПУР1 = ПУ1 - Купр1 - Кусп1;
           ПУР2 = ПУ2 - Купр2 - Кусп2;
        END;

        Пвыв = max(0, ПУР);

        if( UseNDFL )
           if( ЭтоКапитализация(MngPlan.rec.Flag3) OR
               ЭтоВыплата(MngPlan.rec.Flag3)
             )
              Нкуд = Itog.rec.A38_2;
              Пвыв = Пвыв - Нкуд;
           end;
        end;
     end;
  end;

  if( ИзмНДФЛ )
     Сум_в_н = Itog.rec.A36_2 + Itog.rec.A37_2;
     if( Сум_в_н > 0 )
        Itog.rec.A36_2 = round(Itog.rec.A36_2 - Itog.rec.A38_2 * Itog.rec.A36_2 / Сум_в_н);
        Itog.rec.A37_2 = round(Itog.rec.A37_2 - Itog.rec.A38_2 * Itog.rec.A37_2 / Сум_в_н);
     end;
  end;

  if( IsFullCalc or ИзмПУ )

     if( ЭтоКапитализация(MngPlan.rec.Flag3) )/*капитализация*/
        Itog.rec.A35_2 = 0;
        Itog.rec.A36_2 = Пвыв;
        Itog.rec.A37_2 = 0;
        if( IsFullCalc )
           Itog.rec.A35_1 = Itog.rec.A35_2;
           Itog.rec.A36_1 = Itog.rec.A36_2;
           Itog.rec.A37_1 = Itog.rec.A37_2;
        end;
     end;
     if( ЭтоВыплата(MngPlan.rec.Flag3) ) /*выплата*/
        Itog.rec.A35_2 = 0;
        Itog.rec.A36_2 = 0;
        Itog.rec.A37_2 = Пвыв;
        if( IsFullCalc )
           Itog.rec.A35_1 = Itog.rec.A35_2;
           Itog.rec.A36_1 = Itog.rec.A36_2;
           Itog.rec.A37_1 = Itog.rec.A37_2;
        end;
     end;

     if( ЭтоНачисление(MngPlan.rec.Flag3) )/*начисление*/

        if( ( not TS_ExistProfitReq( Itog.rec.OrderID ) ) AND 
             ЭтоКапитализация(MngPlan.rec.OnApplOnly)
          )
           Itog.rec.A35_2 = 0;
           Itog.rec.A36_2 = Пвыв;
           Itog.rec.A37_2 = 0;
           if( IsFullCalc )
              Itog.rec.A35_1 = Itog.rec.A35_2;
              Itog.rec.A36_1 = Itog.rec.A36_2;
              Itog.rec.A37_1 = Itog.rec.A37_2;
           end;
        else
           Itog.rec.A35_2 = Пвыв;
           Itog.rec.A36_2 = 0;
           Itog.rec.A37_2 = 0;
           if( IsFullCalc )
              Itog.rec.A35_1 = Itog.rec.A35_2;
              Itog.rec.A36_1 = Itog.rec.A36_2;
              Itog.rec.A37_1 = Itog.rec.A37_2;
           end;
        end;
     end;
  end;

  /* = ПУiф - Куспi/ф - Купр - Пвыв_вi/ф - Пвыв_кi/ф - Пвыв_нi/ф - Нкудi /ф */
  Itog.rec.A40 = Itog.rec.A23_2 - Itog.rec.A30 - Itog.rec.A32_2 - Itog.rec.A35_2 - Itog.rec.A36_2 - Itog.rec.A37_2 - Itog.rec.A38_2;

  return 0;
OnError( RslErrObj )
  return Exception( RslErrObj );
END;

MACRO РассчитатьИтоги( _ServOp:MEMADDR )
  VAR cmd, fCalcItogs, RecCount = 0, MaxRecCount = 0;

  ServOp.SetRecordAddr( _ServOp );

  InitProgress( -1, "Операция подведения итогов ДУ", "Отбор договоров для операции");
  cmd = RsdCommand(RslDefCon, "begin\n TrustAPI.SelectOrdersForCalcItog(?);\n end; ");
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, ServOp.rec.ID ); 
  cmd.execute();
  RemProgress();

  MaxRecCount = SQL_GetNRecs( "SELECT * FROM DTSCALCITOGS_TMP" );
  InitProgress( MaxRecCount, "Выполнение ...", "Расчет средневзвешенного капитала фонда" );
  fCalcItogs = TBfile( "TSCALCITOGS.TMP", "W", 0 );
  while( fCalcItogs.Next() )
     if( fCalcItogs.rec.Sort == 0 )
        /* Для ДП ОФБУ */
        if( not InitGlobal(fCalcItogs.rec.OrderID) )
           return 1;
        end;

        var ДатаПервичногоВнесения = OrderFD.ДатаПервичногоВнесения();
        var ДатаПолногоВывода      = OrderFD.ДатаПолногоВывода();

        if( (ДатаПервичногоВнесения == Date(0,0,0)) OR (ДатаПервичногоВнесения >= ServOp.rec.EndDate) OR
            ((ДатаПолногоВывода != Date(0,0,0)) AND (ДатаПолногоВывода <= ServOp.rec.BegDate))
          )
           /*удаляем ненужные договора которые окончились до начала периода или начинаются после периода*/
           fCalcItogs.Delete();
        else
           fCalcItogs.rec.A8_1 = ДНпр_Условие1(OrderFD, ServOp.rec.BegDate);
           fCalcItogs.rec.A8_2 = ДОпр_Условие2(OrderFD, ServOp.rec.EndDate);
           fCalcItogs.rec.CalcDateM = ДОпр_Условие2(OrderFD, ServOp.rec.EndDate+1); /*Итог CalcDateM используем не по назначению, а просто как не занятый*/
           fCalcItogs.rec.A7 = fCalcItogs.rec.A8_2 - fCalcItogs.rec.A8_1 + 1;
           fCalcItogs.rec.A9= OrderFD.СредневзвешенныйКапиталЗаПериод( ServOp.rec.BegDate, ServOp.rec.EndDate, false, false );

           if( not fCalcItogs.update() )
              runerror( "ошибка при обновлении записи в DTSCALCITOGS_TMP" );
           end;
        end;
     else
        /* Для ОФБУ как сумма по всем ДП */
        if( ПересчитатьСуммуИтоговОФБУ( ServOp, fCalcItogs.rec.OrderID ) != 0 )
           return 1;
        end;
     end;
     UseProgress( RecCount = RecCount + 1 );
  end;
  RemProgress();

  RecCount = 0; MaxRecCount = 0;
  MaxRecCount = SQL_GetNRecs( "SELECT * FROM DTSCALCITOGS_TMP" );
  InitProgress( MaxRecCount, "Выполнение ...", "Операция подведения итогов ДУ" );
  fCalcItogs = TBfile( "TSCALCITOGS.TMP", "W", 0 );
  while( fCalcItogs.Next() )
     if( fCalcItogs.rec.Sort == 0 )
        /* Для ДП ОФБУ */
        if( not InitGlobal(fCalcItogs.rec.OrderID) )
           return 1;
        end;

        if( ПересчитатьСуммуИтогов( ServOp, fCalcItogs, NULL, (RecCount == (MaxRecCount - 2)) ) == 0 )
           if( not fCalcItogs.update() )
              runerror( "ошибка при обновлении записи в DTSCALCITOGS_TMP" );
           end;
        else 
           return 1;
        end;
     else
        /* Для ОФБУ как сумма по всем ДП */
        if( ПересчитатьСуммуИтоговОФБУ( ServOp, fCalcItogs.rec.OrderID ) != 0 )
           return 1;
        end;
     end;
     UseProgress( RecCount = RecCount + 1 );
  end;
  RemProgress();

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

PRIVATE MACRO ОплатитьКомиссию( Summa:MONEY, Name:STRING, NumItog:INTEGER, КУС:STRING, Ground:STRING, FIRole:INTEGER ):BOOL

  return true;
END;

PRIVATE MACRO ВыполнятьСвертку()
  var dd, mm, yyyy;
  var cmd, DataSet, rez = false;
  DateSplit(ServOp.rec.EndDate, dd, mm, yyyy);

  if((MngPlan.rec.CloseAccount == TS_CLOSE_ACCOUNT_MONTH) and (LastDay(mm, yyyy) == dd))
     rez = true;
  end;
  if((rez == false) and (MngPlan.rec.CloseAccount == TS_CLOSE_ACCOUNT_QUARTER) and ((LastDay(mm, yyyy) == dd) and ((mm == 3) OR (mm == 6) OR (mm == 9) OR (mm == 12))))
     rez = true;
  end;
  if((rez == false) and (MngPlan.rec.CloseAccount == TS_CLOSE_ACCOUNT_CALCPERIOD))
     rez = true;
  end;

  return rez;
END;

MACRO ВыполнитьПодведениеИтогов( _DlDoc:MEMADDR, FDoc:MEMADDR, _ID_Operation:INTEGER, _ID_Step:INTEGER )
  VAR Itogs = TRecHandler( "TSCALCITOGS.TMP" );
  VAR Дсрвзв1 = $0, Кусп1 = $0, ПУ1 = $0, Р_ПУ = $0, Р_ПУ1 = $0, Р_ПУ2 = $0, Дх = $0;
  VAR ПрибыльДУ = TRecHandler("account.dbt" );
  VAR РасчетыДУ18 = TRecHandler("account.dbt" );
  VAR РасчетыДУ68 = TRecHandler("account.dbt" );
  VAR КапиталДУ = TRecHandler("account.dbt" );
  VAR ДСДУ = TRecHandler("account.dbt" );

  if( TS_RunFromServiceOper( ServOp ) != true )
     MsgBox( "Шаг \"Подведение итогов ДУ\" должен выполняться только из соответствующей сервисной операции." );
     return 1;
  end;

  DlDoc        = _DlDoc;
  ID_Operation = _ID_Operation;
  ID_Step      = _ID_Step;
  ДатаСписания = ServOp.rec.EndDate;
  ДатаОперации = ServOp.rec.OperDate;
  if( not InitGlobal( FDoc ) )
     return 1;
  end;

  if( not TS_GetRecHandler( Itogs, " SELECT * FROM DTSCALCITOGS_TMP WHERE t_OrderID = "+ string(OrderFD.ID) ) )
     MsgBox( "Для договора \"" + OrderFD.Code() + "\" не были рассчитаны итоги.");
     return 1;
  end;

  CalcCom.sfdefcom_parm_S.rec.CommSum   = Itogs.rec.A32_2;
  CalcCom.sfdefcom_parm_S.rec.DateEnd   = Itogs.rec.EndDateS;
  CalcCom.sfdefcom_parm_S.rec.DateBegin = Itogs.rec.BeginDateS;
  FindSfConCom_ByID(Itogs.rec.IDComS, CalcCom.ConCom_S);
  if( СохранитьПериодическуюКомиссию( OrderFD, Itogs.rec.CalcDateS, CalcCom.ConCom_S, CalcCom.sfdefcom_parm_S ) != 0 )
     return 1;
  end;

  if( TS_UpdateCalcItogDate( OrderFD.ID, ДатаСписания ) != 0 )
     MsgBox( "Ошибка при обновлении даты расчета в договоре ДУ." );
     return 1;
  end;

  if( OrderFD.Kind == TS_DOC_OFBU )
     if( СвернутьСчета( OrderFD, DlDoc, ДатаОперации ) != 0 )
        return 1;
     end;
  end;

  /*1.   Совокупная прибыль фонда.*/
  /*6.   Совокупная прибыль учредителя*/
  /*Если зовется для ОФБУ то ПФ, если для ДП то ПУ*/
  if( (OrderFD.Kind == TS_DOC_OFBU) or
      not OrderFD.БылаПролонгация( Itogs.rec.A8_1, Itogs.rec.A8_2 )
    )
     if( OrderFD.SaveItog( ДУ_ИТОГ_ПУ, Itogs.rec.A23_2, NATCUR, ДатаСписания, "98", null, TS_IIF((Itogs.rec.A23_2 < 0), TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, TS_IIF((OrderFD.Kind == TS_DOC_OFBU), ДатаОперации, Itogs.rec.A8_2)) )
        MsgBox( "Ошибка при сохранении итога \"ПУ(ПФ)\"" );
        return 1;
     end;
  else
     ПУ1 = round(Itogs.rec.A23_2 * ( OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate - Itogs.rec.A8_1 + 1 ) / Itogs.rec.A7);
     if( OrderFD.SaveItog( ДУ_ИТОГ_ПУ, ПУ1, NATCUR, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate, "97", null, TS_IIF((ПУ1 < 0), TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate ) )
        MsgBox( "Ошибка при сохранении итога \"ПУ(ПФ)\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_ПУ, Itogs.rec.A23_2 - ПУ1, NATCUR, ДатаСписания, "98", null, TS_IIF((Itogs.rec.A23_2 - ПУ1 < 0), TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"ПУ(ПФ)\"" );
        return 1;
     end;
  end;

  Дх = Itogs.rec.A32_2 + Itogs.rec.A35_2 + Itogs.rec.A36_2 + Itogs.rec.A37_2 + Itogs.rec.A38_2;

  if( (OrderFD.Kind == TS_DOC_DPOFBU) AND
      (Дх > 0)
    )
     if( not OFBUFD.OpenAccount( null, "Прибыль ДУ", null, null, null, ПрибыльДУ, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  ПрибыльДУ, "-Расчеты, ДУ", /* AccDeb , AccCred*/
                                                  ДатаОперации,              /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  Дх,                        /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Начисление прибыли для выплаты учредителю по договору " + OrderFD.Number, /* Ground */
                                                  null,
                                                  FIROLE_TRUSTOR
                                                 ) 
       )
         return 1;
     end;
  end;

  /*2.   Средневзвешенный капитал фонда
    3.   Средневзвешенная доля учредителя.
  */
  /*Если зовется для ОФБУ то ДлФ, если для ДП то ДлУ*/
  if( (OrderFD.Kind == TS_DOC_OFBU) or
      not OrderFD.БылаПролонгация( Itogs.rec.A8_1, Itogs.rec.A8_2 )
    )
     if( OrderFD.SaveItog( ДУ_ИТОГ_ДлУ, Itogs.rec.A9, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, TS_IIF((OrderFD.Kind == TS_DOC_OFBU), ДатаОперации, ServOp.rec.EndDate)) )
        MsgBox( "Ошибка при сохранении итога \"ДлУ(ДлФ)\"" );
        return 1;
     end;
  else
     Дсрвзв1 = round(Itogs.rec.A9 * ( OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate - Itogs.rec.A8_1 + 1 ) / (ServOp.rec.EndDate - ServOp.rec.BegDate + 1), 2);
     if( OrderFD.SaveItog( ДУ_ИТОГ_ДлУ, Дсрвзв1, NATCUR, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate ) )
        MsgBox( "Ошибка при сохранении итога \"ДлУ(ДлФ)\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_ДлУ, Itogs.rec.A9, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, ServOp.rec.EndDate ) )
        MsgBox( "Ошибка при сохранении итога \"ДлУ(ДлФ)\"" );
        return 1;
     end;
  end;
  /*4.   Базовая прибыль*/
  if( OrderFD.SaveItog( ДУ_БП, Itogs.rec.A31, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2  ) )
     MsgBox( "Ошибка при сохранении итога \"БП\"" );
     return 1;
  end;
  /*5.   Комиссия за успех*/
  if( OrderFD.Kind == TS_DOC_DPOFBU )
     if( not OrderFD.БылаПролонгация( Itogs.rec.A8_1, Itogs.rec.A8_2 ) )
        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Кусп, Itogs.rec.A32_2, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) ) 
           MsgBox( "Ошибка при сохранении итога \"Н_Кусп\"" );
           return 1;
        end;
     else
        Кусп1 = round(Itogs.rec.A32_2 * ( OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate - Itogs.rec.A8_1 + 1 ) / Itogs.rec.A7);
        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Кусп, Кусп1, NATCUR, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Кусп\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Кусп, Itogs.rec.A32_2 - Кусп1, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Кусп\"" );
           return 1;
        end;
     end;

     if( Itogs.rec.A32_2 > 0 )
        if( TS_CreateDemandTrust( NULL, ID_Operation, 
                                  TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Кусп" ),
                                  TS_DEMAND_ROLE_OBLIGATION, 
                                  "2" /*КВТО = оплата*/, 
                                  "62"/*КУС  = Оплата комиссии за успех*/,  
                                  ДатаОперации, 
                                  Itogs.rec.A32_2, 
                                  NATCUR,  
                                  РКЦ(),
                                  OrderFD.ID, NATCUR,
                                  NULL, NULL,
                                  ID_Step, TS_DOC_CALCITOGS_OFBU, ServOp.rec.ID ) == false )
           return 1;
        end;

        if( not OFBUFD.OpenAccount( null, "-Расчеты, ДУ", null, null, FIROLE_COM_MANAG, РасчетыДУ18, ДатаОперации) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null, 
                                                     "-Расчеты, ДУ", РасчетыДУ18,     /* AccDeb , AccCred*/
                                                     ДатаОперации,    /* Дата */
                                                     2,                              /* Глава */
                                                     NATCUR,                         /* Валюта */
                                                     Itogs.rec.A32_2,                /* Сумма */
                                                     DlDoc,                          /* Документ */
                                                     OrderFD.Number,                 /* Numb_Document */
                                                     "Начисление комиссии за успех", /* Ground */
                                                     FIROLE_TRUSTOR,
                                                     FIROLE_COM_MANAG
                                                    ) 
          )
            return 1;
        end;
     end;
  end;

  /*7.   Распределенная прибыль*/
  if( OrderFD.Kind == TS_DOC_DPOFBU )
     if( not OrderFD.БылаПролонгация( Itogs.rec.A8_1, Itogs.rec.A8_2 ) )
        Р_ПУ = Itogs.rec.A23_2 - Itogs.rec.A32_2 - Itogs.rec.A30;
        if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, Р_ПУ, NATCUR, ДатаСписания, "98", null, TS_IIF((Р_ПУ < 0), TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
           return 1;
        end;
     else
        Р_ПУ1 = round((Itogs.rec.A23_2 - Itogs.rec.A32_2 - Itogs.rec.A30) * ( OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate - Itogs.rec.A8_1 + 1) / Itogs.rec.A7);
        if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, Р_ПУ1, NATCUR, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate, "97", null, TS_IIF((Р_ПУ1 < 0), TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, OrderFD.Valid(Itogs.rec.A8_1).rec.EndDate ) )
           MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
           return 1;
        end;
        Р_ПУ2 = Itogs.rec.A23_2 - Itogs.rec.A32_2 - Itogs.rec.A30 - Р_ПУ1;
        if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, Р_ПУ2, NATCUR, ДатаСписания, "98", null, TS_IIF((Р_ПУ2 < 0), TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
           return 1;
        end;
     end;
  end;

  /*8.   Начисленный доход и распределенная прибыль*/
  if( OrderFD.Kind == TS_DOC_DPOFBU )
     var DeltaDx:money = $0.0;

     if( Itogs.rec.A35_2/*Пвыв_н_ф*/ > 0 )
        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs.rec.A35_2, NATCUR, ДатаСписания, "98", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, Itogs.rec.A35_2, NATCUR, ДатаСписания, "82", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
           return 1;
        end;

        if( TS_CreateDemandTrust( NULL, ID_Operation, 
                                  TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Дх" ),
                                  TS_DEMAND_ROLE_OBLIGATION, 
                                  "2" /*КВТО = оплата*/, 
                                  "83"/*КУС  = Оплата комиссии за успех*/,  
                                  ДатаОперации, 
                                  Itogs.rec.A35_2, 
                                  NATCUR,  
                                  РКЦ(),
                                  OrderFD.ID, NATCUR,
                                  NULL, NULL,
                                  ID_Step, TS_DOC_CALCITOGS_OFBU, ServOp.rec.ID ) == false )
           return 1;
        end;
     end;

     if( Itogs.rec.A36_2/*Пвыв_к_ф*/ > 0 )
        DeltaDx = -Itogs.rec.A36_2 + Itogs.rec.A38_2;
        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, DeltaDx, NATCUR, ДатаСписания, "96", null, TS_IIF(DeltaDx < 0, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, (Itogs.rec.A36_2 + Itogs.rec.A38_2), NATCUR, ДатаСписания, "96", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_СК, Itogs.rec.A36_2, NATCUR, ДатаСписания, "96", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.CalcDateM ) )
           MsgBox( "Ошибка при сохранении итога \"СК\"" );
           return 1;
        end;

        if( not OrderFD.OpenAccount( null, "Капитал ДУ", null, null, FIROLE_TRUSTOR, КапиталДУ, ДатаОперации) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                     "-Расчеты, ДУ", КапиталДУ,     /* AccDeb , AccCred*/
                                                     ДатаОперации,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Itogs.rec.A36_2,           /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Капитализация прибыли по договору " + OrderFD.Number, /* Ground */
                                                     FIROLE_TRUSTOR,
                                                     FIROLE_TRUSTOR
                                                    ) 
          )
            return 1;
        end;
     end;

     if( Itogs.rec.A37_2/*Пвыв_в_ф*/ > 0 )
        DeltaDx = -Itogs.rec.A37_2 + Itogs.rec.A38_2;
        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, DeltaDx, NATCUR, ДатаСписания, "83", null, TS_IIF(DeltaDx < 0, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_IN), TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, (Itogs.rec.A37_2 + Itogs.rec.A38_2), NATCUR, ДатаСписания, "83", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
           return 1;
        end;

        if( not OFBUFD.OpenAccount( null, "ДС ДУ", null, null, null, ДСДУ, ДатаОперации) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                     "-Расчеты, ДУ", ДСДУ,     /* AccDeb , AccCred*/
                                                     ДатаОперации,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Itogs.rec.A37_2,           /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Выплата прибыли по договору " + OrderFD.Number, /* Ground */
                                                     FIROLE_TRUSTOR,
                                                     null
                                                    ) 
          )
            return 1;
        end;
     end;

     if( Itogs.rec.A38_2/*Нкуд_ф*/ > 0 )
        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs.rec.A38_2, NATCUR, ДатаСписания, "60", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Налог, Itogs.rec.A38_2, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Налог\"" );
           return 1;
        end;

        if( TS_CreateDemandTrust( NULL, ID_Operation, 
                                  TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Налог" ),
                                  TS_DEMAND_ROLE_OBLIGATION, 
                                  "2" /*КВТО = оплата*/, 
                                  "60"/*КУС  = Оплата налога на доходы физ.лиц*/,  
                                  ДатаОперации, 
                                  Itogs.rec.A38_2, 
                                  NATCUR,  
                                  РКЦ(),
                                  OrderFD.ID, NATCUR,
                                  NULL, NULL,
                                  ID_Step, TS_DOC_CALCITOGS_OFBU, ServOp.rec.ID ) == false )
           return 1;
        end;

        if( not OFBUFD.OpenAccount( null, "-Расчеты, ДУ", null, null, FIROLE_NALOG, РасчетыДУ68, ДатаОперации) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                     "-Расчеты, ДУ", РасчетыДУ68,     /* AccDeb , AccCred*/
                                                     ДатаОперации,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Itogs.rec.A38_2,           /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Взимание налога на доходы физ.лиц", /* Ground */
                                                     FIROLE_TRUSTOR,
                                                     FIROLE_NALOG
                                                    ) 
          )
            return 1;
        end;
     end;
  else
     if( Itogs.rec.A36_2 > 0 )
        if( OrderFD.SaveItog( ДУ_ИТОГ_СК, Itogs.rec.A36_2, NATCUR, ДатаСписания, "96", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, ДатаСписания+1 ) )
           MsgBox( "Ошибка при сохранении итога \"СК\"" );
           return 1;
        end;
     end;
  end;

  if( TS_UpdateCalcItogDate( OrderFD.ID, ДатаСписания ) != 0 )
     MsgBox( "Ошибка при обновлении даты расчета в договоре ДУ." );
     return 1;
  end;

  SaveAllItogsInBD(Itogs);

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;
