/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style SoftLab

  File Name   : trvas020.mac
  Programmer  : Nikonorov Evgeny
  Операция    : Продажа векселей в ДУ
  Шаг         : 20 - Настройка операции
└───────────────────────────────────────────────────────────────────────────*/

import InsCarryDoc, globals, trvafd, vasale, trvautl;


MACRO OpenBnrAcc(bnr, leg, tick, numOrd, lnk)
  
  var fd = TS_VABnrFD(DL_VSBANNER, bnr.rec.BCID, DL_VATRUST, tick);
  var FindAcc = TRecHandler("account.dbt" );
  var stat = 0;
  
  if( not fd.ПолучитьСчет("Портфель ДУ", null, false, null, FindAcc, tick.DealDate, fd.GetLeg().rec.PFI) )
    stat = 1;
  end;

  return stat;
END;


macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  var fd;
  record tick(dl_tick);
  var FindAcc1 = TRecHandler("account.dbt" );
  var FindAcc2 = TRecHandler("account.dbt" );
  var SupplyDate, PayDate;
  var prm;
  var stat = 0;
  var Event = "31";
  
  SetBuff( tick, FDoc );
  fd = TS_VATickFD( tick );
  
  //актуализация счетов

  GetOprDate( DATE_SALE_SUPPLY, SupplyDate ); /* Dп (Дата поставки) */
  GetOprDate( DATE_SALE_PAY, PayDate ); /* Dо (Дата оплаты) */
  
  FindAcc1.Clear();
  FindAcc2.Clear();
  
  if( PayDate > SupplyDate )
    if( not fd.ПолучитьСчет( "-Расчеты, ДУ", null, false, null, FindAcc1, tick.DealDate) )
        stat = 1;
    end; 
  else
    if( not fd.ПолучитьСчет( "+Расчеты, ДУ", null, false, null, FindAcc2, tick.DealDate) )
        stat = 1;
    end;
  end;
  
  if(not stat)
    stat = VA_ForEachBanner(tick, @OpenBnrAcc, VSORDLNK_K_ALL, null, "BL");
  end;

  if(not stat)
    if( ДУ_УВ_СоздатьТО_Оплата( fd, TS_DEMAND_ROLE_REQUEST/*Требование*/, ID_Operation, PayDate, Event, CAi, ID_Step ) != 0 )
       stat = 1;
    end;
  end;

  if(not stat)
    prm = TS_VABnrParm(TS_DEMAND_ROLE_OBLIGATION/*обязательство*/, ID_Operation, SupplyDate, Event, ID_Step);
    stat = VA_ForEachBanner(tick, @ДУ_УВ_СоздатьТО_ПоставкаВекс, VSORDLNK_K_ALL, prm, "BL");
  end; 


  return stat;

end;
