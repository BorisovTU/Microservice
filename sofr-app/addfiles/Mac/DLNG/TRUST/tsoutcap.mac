/* Шаг "Списание активов"*/
IMPORT InsCarryDoc, TSInter, "tstrans.mac", "dl_car.mac", "tstotal.mac", "tscalcitogs.mac";

PRIVATE VAR Request = TRecHandler( "tsiorqst.dbt" ), /*Заполняется программой при выполнении шага*/
            MngPlan = TRecHandler( "tsmngpln.dbt" ),
            AccProfit  = TRecHandler( "account" ),
            AccLoss    = TRecHandler( "account" ),
            MainAccCap    = TRecHandler( "account" ),
            MainAccCapDop = TRecHandler( "account" ),
            Itogs = TArray(),
            DlDoc:MEMADDR,
            ID_Operation:INTEGER,
            ID_Step:INTEGER,
            recAsset:Object,
            ReqFD:TS_RequestFD,
            OrderFD:TS_OrderFD,
            AssetFD:TS_ReqAssetFD,
            ДатаУменьшенияКапитала:DATE, 
            ДатаСписания:DATE;

PRIVATE MACRO CheckDate():BOOL
  VAR ErrStr = "";
  if( ДатаСписания > {curdate} )
     ErrStr = "Дата списания средств больше текущей даты.";
  elif( ДатаСписания == Date(0,0,0) )
     ErrStr =  "Не задана дата списания средств.";
  elif( ДатаУменьшенияКапитала == Date(0,0,0) )
     ErrStr = "Не задана дата уменьшения капитала.";
  else
     return true;
  end;

  MsgBox( ErrStr + "|Необходимо отредактировать дату в форме заявления на вывод капитала." );
  return false;
END;

PRIVATE MACRO ОплатитьКомиссию( Summa:MONEY, Name:STRING, NumItog:INTEGER, КУС:STRING, Ground:STRING, FIRole:INTEGER ):BOOL
  if( Summa != 0 )

     if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                  "Расходы ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                  ДатаСписания,              /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  Summa,                     /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  Ground,                    /* Ground */
                                                  FIRole,
                                                  FIRole
                                                 ) 
       )
         return false;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation, 
                               TS_DemandUserMark_ReqItog( TS_DEMAND_ROLE_OBLIGATION, Request.rec.ID, Name ),
                               TS_DEMAND_ROLE_OBLIGATION, 
                               "1" /*КВТО = Расчеты с учредителем*/, 
                               КУС/*КУС  = Передача имущества в управление*/,  
                               ДатаСписания, 
                               Summa, 
                               NATCUR,  
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_DECLAR_OUT, Request.rec.ID ) == false )
        return false;
     end;

     if( OrderFD.SaveItog( NumItog, Summa, NATCUR, ДатаСписания, "86", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ReqFD.Kind, ReqFD.Id ) )
        MsgBox( "Ошибка при сохранении итога \""+Name+"\"" );
        return false;
     end;
  end;
  return true;
END;

PRIVATE MACRO ПроводкиУменьшенияКапитала():BOOL
  VAR AccRest, Summa;

  AccRest = TS_GetRestAccountByRecord( MainAccCap, ДатаСписания );
  if( abs(AccRest) >= Itogs[ДУ_Sкап_ф] )
     Summa = Itogs[ДУ_Sкап_ф];
  else
     Summa = abs(AccRest);
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                               MainAccCap, "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                               ДатаСписания,    /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               Summa,                    /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Уменьшение капитала учредителя", /* Ground */
                                               ReqFD.РольФИ(),
                                               FIROLE_BANKROLL
                                              ) 
    )
      return false;
  end;

  if( (MainAccCapDop.rec.Account != "") AND (Summa <= Itogs[ДУ_Sкап_ф]) ) // попробовать списать то, что осталось с дополнительного счета 
     if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                  MainAccCapDop, "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                  ДатаСписания,    /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  Itogs[ДУ_Sкап_ф]-Summa,    /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Уменьшение капитала учредителя", /* Ground */
                                                  NULL,
                                                  FIROLE_BANKROLL
                                                 ) 
       )
         return false;
     end;
  end;
  return true;
END;

PRIVATE MACRO ПроводкиНачисленияПрибыли_ЧВ():BOOL
  VAR AccRest, Пбух_акт, Summa = Itogs[ДУ_Пвыв_в_ф];

  /*Начисление  прибыли для выплаты учредителю*/
  if( Summa > 0 )
     AccRest = TS_GetRestAccountByRecord( AccProfit, ДатаСписания );
     Пбух_акт = OrderFD.СуммаБухгалтерскойПрибыли(ДатаСписания);
     if( (Summa > AccRest) and (Пбух_акт >= Summa))
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "+Расчеты, ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление  прибыли для выплаты учредителю", /* Ground */
                                                     FIROLE_AVANCE,
                                                     FIROLE_BANKROLL
                                                    ) 
          )
            return false;
        end;
     else
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление  прибыли для выплаты учредителю", /* Ground */
                                                     NULL,
                                                     FIROLE_BANKROLL
                                                    ) 
          )
            return false;
        end;
     end;
  end;

  /*Капитализация прибыли учредителя*/
  Summa = Itogs[ДУ_Пвыв_к_ф];
  if( Summa > 0 )
     AccRest = TS_GetRestAccountByRecord( AccProfit, ДатаСписания );
     Пбух_акт = OrderFD.СуммаБухгалтерскойПрибыли(ДатаСписания);
     if((Summa > AccRest) and (Пбух_акт >= Summa))
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "+Расчеты, ДУ", MainAccCap,     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Капитализация прибыли учредителя", /* Ground */
                                                     FIROLE_AVANCE
                                                    ) 
          )
            return false;
        end;
     else
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "Прибыль ДУ", MainAccCap,     /* AccDeb , AccCred*/
                                                  ДатаСписания,    /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                     "Капитализация прибыли учредителя" /* Ground */
                                                 ) 
       )
         return false;
     end;
     end;
  end;
  return true;
END;

PRIVATE MACRO ПроводкиСписанияКапитала():BOOL
  VAR AccRest = TS_GetRestAccountByRecord( MainAccCap, ДатаСписания );
  if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                               MainAccCap, "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                               ДатаСписания,    /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               abs(AccRest),              /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Списание капитала учредителя", /* Ground */
                                               null,
                                               FIROLE_BANKROLL
                                              ) 
    )
      return false;
  end;

  if( MainAccCapDop.rec.Account != "" )
     AccRest = TS_GetRestAccountByRecord( MainAccCapDop, ДатаСписания );
     if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                  MainAccCapDop, "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                  ДатаСписания,    /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  abs(AccRest),              /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Списание капитала учредителя", /* Ground */
                                                  null,
                                                  FIROLE_BANKROLL
                                                 ) 
       )
         return false;
     end;
  end;

  return true;
END;

PRIVATE MACRO ПроводкиНачисленияПрибыли_ПВ():BOOL
  VAR AccRest = TS_GetRestAccountByRecord( AccProfit, ДатаСписания );

  if( AccRest > 0 )
     if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                  "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                  ДатаСписания,    /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  AccRest,                    /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Начисление прибыли для выплаты учредителю", /* Ground */
                                                  NULL,
                                                  FIROLE_BANKROLL
                                                 ) 
       )
         return false;
     end;
  end;
  return true;
END;

PRIVATE MACRO ПроводкиНачисленияНДФЛ_ПВ():BOOL
  VAR AccRest, Summa = Itogs[ДУ_Нкуд_ф];

  if( Summa > 0 )

     AccRest = TS_GetRestAccountByRecord( AccProfit, ДатаСписания );
     if( Summa > AccRest )
        if( AccRest > 0 )
           if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                        "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                        ДатаСписания,    /* Дата */
                                                        2,                         /* Глава */
                                                        NATCUR,                    /* Валюта */
                                                        AccRest,                   /* Сумма */
                                                        DlDoc,                     /* Документ */
                                                        OrderFD.Number,            /* Numb_Document */
                                                        "Начисление налога на доходы физ.лиц", /* Ground */
                                                        NULL,
                                                        FIROLE_NALOG
                                                       ) 
             )
               return false;
           end;
           Summa = Summa - AccRest;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "Убыток ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     abs(Summa),                   /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление налога на доходы физ.лиц", /* Ground */
                                                     NULL,
                                                     FIROLE_NALOG
                                                    ) 
          )
            return false;
        end;
     elif( Summa <= AccRest )
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление налога на доходы физ.лиц", /* Ground */
                                                     NULL,
                                                     FIROLE_NALOG
                                                    ) 
          )
            return false;
        end;
     end;
  end;

  return true;
END;

PRIVATE MACRO ПроводкиСписанияУбытка():BOOL
  VAR Summa, Sкомп = Itogs[ДУ_Пбух] - Itogs[ДУ_Нкуд_ф],
      AccRest = TS_GetRestAccountByRecord( AccLoss, ДатаСписания );

  if( AccRest > 0 )
     AccRest = TS_GetRestAccountByRecord( MainAccCap, ДатаСписания );
     if( abs(AccRest) >= Sкомп )
        Summa = Sкомп;
     else
        Summa = abs(AccRest);
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                  MainAccCap, "Убыток ДУ",     /* AccDeb , AccCred*/
                                                  ДатаСписания,    /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  Summa,                    /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Списание убытка за счет капитала учредителя" /* Ground */
                                                 ) 
       )
         return false;
     end;

     if( (MainAccCapDop.rec.Account != "") AND (Summa <= Sкомп) ) // попробовать списать то, что осталось с дополнительного счета 
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     MainAccCapDop, "Убыток ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Sкомп-Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Списание убытка за счет капитала учредителя" /* Ground */
                                                    ) 
          )
            return false;
        end;
     end;
  end;

  return true;
END;

PRIVATE MACRO ПроводкиСписанияАктивов_ДС():BOOL
   if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                                "-Расчеты, ДУ", "ДС ДУ",       /* AccDeb , AccCred*/
                                                ДатаСписания,              /* Дата */
                                                2,                         /* Глава */
                                                NATCUR,                    /* Валюта */
                                                Itogs[ДУ_Sвыпл],      /* Сумма */
                                                DlDoc,                     /* Документ */
                                                OrderFD.Number,            /* Numb_Document */
                                                "Вывод денежных средств",  /* Ground */
                                                FIROLE_BANKROLL,
                                                FIROLE_BANKROLL
                                               ) 
     )
       return false;
   end;
   return true;
END;

PRIVATE MACRO ПроводкиСписанияАктивов_ЭЦБ_Портф( FI_RolePortf:INTEGER, FI_RolePD:INTEGER, FI_RoleDD:INTEGER,
                                                 Стек:MONEY, 
                                                 ПДначисл:MONEY, ДДначисл:MONEY, НКДупл:MONEY, 
                                                 ПДне_отн:MONEY, ДДне_отн:MONEY
                                               ):BOOL

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "-Расчеты, ДУ", "ПортфельЭцб ДУ",       /* AccDeb , AccCred*/
                                               ДатаСписания,            /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               (Стек-ПДначисл-ДДначисл-НКДупл),                     /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Списание стоимости ценных бумаг",  /* Ground */
                                               FIROLE_BANKROLL,
                                               FI_RolePortf
                                              ) 
    )
      return false;
  end;

  if(FI_IsBond(recAsset.rec.FIID) == true)
     if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                                  "-Расчеты, ДУ", "ПортфельЭцб ДУ",       /* AccDeb , AccCred*/
                                                  ДатаСписания,            /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  (НКДупл+ПДначисл),                     /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Списание начисленного процентного купонного дохода по облигациям",  /* Ground */
                                                  FIROLE_BANKROLL,
                                                  FI_RolePD
                                                 ) 
       )
         return false;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                                  "-Расчеты, ДУ", "ПортфельЭцб ДУ",       /* AccDeb , AccCred*/
                                                  ДатаСписания,            /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  ДДначисл,                     /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Списание начисленного дисконтного дохода по облигациям",  /* Ground */
                                                  FIROLE_BANKROLL,
                                                  FI_RoleDD
                                                 ) 
       )
         return false;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                                  "ПДДЭцб ДУ", "ДоходыЭцб ДУ",       /* AccDeb , AccCred*/
                                                  ДатаСписания,            /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  ПДне_отн,                     /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Отнесение на доходы начисленного процентного (купонного) дохода по ценным бумагам, по которым отсутствует определенность в получении дохода",  /* Ground */
                                                  FI_RolePD,
                                                  FI_RolePD
                                                 ) 
       )
         return false;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                                  "ПДДЭцб ДУ", "ДоходыЭцб ДУ",       /* AccDeb , AccCred*/
                                                  ДатаСписания,            /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  ДДне_отн,                     /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number,            /* Numb_Document */
                                                  "Отнесение на доходы начисленного дисконтного  дохода по ценным бумагам, по которым отсутствует определенность в получении дохода",  /* Ground */
                                                  FI_RoleDD,
                                                  FI_RoleDD
                                                 ) 
       )
         return false;
     end;
  end;

  return true;
END;

PRIVATE MACRO ПроводкиСписанияАктивов_ЭЦБ():BOOL
  VAR ТП_Стек, ТП_ПДначисл, ТП_ДДначисл, ТП_НКДупл, ТП_ПДне_отн, ТП_ДДне_отн, 
      ППР_Стек, ППР_ПДначисл, ППР_ДДначисл, ППР_НКДупл, ППР_ПДне_отн, ППР_ДДне_отн;

  if( not AssetFD.ПолучитьСуммыСписанияЭЦБ( @ТП_Стек, @ТП_ПДначисл, @ТП_ДДначисл, @ТП_НКДупл, @ТП_ПДне_отн, @ТП_ДДне_отн,
                                            @ППР_Стек, @ППР_ПДначисл, @ППР_ДДначисл, @ППР_НКДупл, @ППР_ПДне_отн, @ППР_ДДне_отн
                                          ) 
    )
     return false;
  end;

  if( not ПроводкиСписанияАктивов_ЭЦБ_Портф( FIROLE_BA_TP, FIROLE_PD_TP, FIROLE_DD_TP,
                                             @ТП_Стек, @ТП_ПДначисл, @ТП_ДДначисл, @ТП_НКДупл, @ТП_ПДне_отн, @ТП_ДДне_отн ) 
    )
     return false;
  end;

  if( not ПроводкиСписанияАктивов_ЭЦБ_Портф( FIROLE_BA_PPR, FIROLE_PD_PPR, FIROLE_DD_PPR,
                                             @ППР_Стек, @ППР_ПДначисл, @ППР_ДДначисл, @ППР_НКДупл, @ППР_ПДне_отн, @ППР_ДДне_отн ) 
    )
     return false;
  end;

  return true;
END;

PRIVATE MACRO ПроводкиСписанияАктивов_НЭЦБ():BOOL
  VAR Стек, ПДначисл, ДДначисл, НКДупл, ПДне_отн, ДДне_отн;

  if( not AssetFD.ПолучитьСуммыСписанияНЦБ( @Стек, @ПДначисл, @ДДначисл, @ПДне_отн, @ДДне_отн, ДатаСписания ) )
     return false;
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "-Расчеты, ДУ", "Портфель ДУ",       /* AccDeb , AccCred*/
                                               ДатаСписания,            /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               Стек,                     /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Списание стоимости покупки векселей",  /* Ground */
                                               FIROLE_BANKROLL,
                                               FIROLE_SECURITIES
                                              ) 
    )
      return false;
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "-Расчеты, ДУ", "Портфель ДУ",       /* AccDeb , AccCred*/
                                               ДатаСписания,            /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               ПДначисл,                     /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Списание начисленного процентного дохода ",  /* Ground */
                                               FIROLE_BANKROLL,
                                               FIROLE_PERCENT
                                              ) 
    )
      return false;
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "-Расчеты, ДУ", "Портфель ДУ",       /* AccDeb , AccCred*/
                                               ДатаСписания,            /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               ДДначисл,                     /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Списание начисленного дисконтного дохода",  /* Ground */
                                               FIROLE_BANKROLL,
                                               FIROLE_DISCOUNT
                                              ) 
    )
      return false;
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "ПДД ДУ", "Доходы ДУ",       /* AccDeb , AccCred*/
                                               ДатаСписания,            /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               ПДне_отн,                     /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Отнесение на доходы начисленного процентного дохода по ценным бумагам, по которым отсутствует определенность в получении дохода",  /* Ground */
                                               FIROLE_PERCENT,
                                               FIROLE_PERCENT
                                              ) 
    )
      return false;
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "ПДД ДУ", "Доходы ДУ",       /* AccDeb , AccCred*/
                                               ДатаСписания,            /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               ДДне_отн,                     /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               "Списание начисленного дисконтного  дохода по ценным бумагам, по которым отсутствует определенность в получении дохода",  /* Ground */
                                               FIROLE_DISCOUNT,
                                               FIROLE_DISCOUNT
                                              ) 
    )
      return false;
  end;

  return true;
END;

PRIVATE MACRO ПроводкиНачисленияНДФЛ_ЧВ():BOOL
  VAR AccRest, Пбух_акт, Summa = Itogs[ДУ_Нкуд_ф];

  if( Summa > 0 )
     AccRest = TS_GetRestAccountByRecord( AccProfit, ДатаСписания );
     Пбух_акт = OrderFD.СуммаБухгалтерскойПрибыли(ДатаСписания);
     if( (Summa > AccRest) and (Пбух_акт >= Summa))
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "+Расчеты, ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление налога на доходы физ.лиц", /* Ground */
                                                     FIROLE_AVANCE,
                                                     FIROLE_NALOG
                                                    ) 
          )
            return false;
        end;
     else
        if( not ПроводкаПоКатегориямУчетаПоДоговору( ReqFD, null, null, 
                                                     "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаСписания,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Summa,                    /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление налога на доходы физ.лиц", /* Ground */
                                                     NULL,
                                                     FIROLE_NALOG
                                                    ) 
          )
            return false;
        end;
     end;
  end;

  return true;
END;

PRIVATE MACRO ВыполнитьВыводКапитала():BOOL
  VAR IsFULL = (Request.rec.Type == TS_KINDDECLAR_FULL);
  VAR Num = 1, NumAssets = 0, NumAssetsCur = 0;

  UseProgress( Num = Num + 1 );
  if( OrderFD.OpenAccount( null, "Прибыль ДУ", null, false, null, AccProfit, ДатаСписания) == false )
      return false;
  end;

  if( OrderFD.OpenAccount( null, "Убыток ДУ", null, false, null, AccLoss, ДатаСписания) == false )
      return false;
  end;

  if( ReqFD.OpenAccount( null, "Капитал ДУ", null, false, ReqFD.РольФИ(), MainAccCap, ДатаСписания) == false )
      return false;
  end;

  if( not ReqFD.IsExistAccount( null, "Капитал ДУ", null, true, TS_IIF( ReqFD.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY, FIROLE_SECURITIES, FIROLE_BANKROLL ), MainAccCapDop, ДатаСписания) )
     MainAccCapDop.Clear(); // нет доп. счета
  end;

  if( IsFULL == false )
     UseProgress( Num = Num + 1 );
     if( not ПроводкиУменьшенияКапитала() )
        return false;
     end;
  end;

  UseProgress( Num = Num + 1 );
  if( not ОплатитьКомиссию( Itogs[ДУ_Кдв_ф], "Кдв", ДУ_ИТОГ_Н_Кдв, "63", "Начисление комиссии за досрочный вывод капитала", FIROLE_COM_OUT ) )
     return false;
  end;
  UseProgress( Num = Num + 1 );
  if( not ОплатитьКомиссию( Itogs[ДУ_Купр_ф], "Купр", ДУ_ИТОГ_Н_Купр, "61", "Начисление комиссии за управление", FIROLE_COM_MANAG ) )
     return false;
  end;
  UseProgress( Num = Num + 1 );
  if( not ОплатитьКомиссию( Itogs[ДУ_Кусп_ф], "Кусп", ДУ_ИТОГ_Н_Кусп, "62", "Начисление комиссии за успех", FIROLE_COM_SUCCESS ) )
     return false;
  end;

  UseProgress( Num = Num + 1 );
  if( Itogs[ДУ_Нкуд_ф] != 0 )
     if( TS_CreateDemandTrust( NULL, ID_Operation, 
                               TS_DemandUserMark_ReqItog( TS_DEMAND_ROLE_OBLIGATION, Request.rec.ID, "Н_Налог" ),
                               TS_DEMAND_ROLE_OBLIGATION, 
                               "2" /*КВТО = оплата*/, 
                               "60"/*КУС  =  Оплата налога на доходы физ.лиц*/,  
                               ДатаСписания, 
                               Itogs[ДУ_Нкуд_ф],
                               NATCUR,  
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_DECLAR_OUT, Request.rec.ID ) == false )
        return false;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Налог, Itogs[ДУ_Нкуд_ф], NATCUR, ДатаСписания, "86", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ReqFD.Kind, ReqFD.Id ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Налог\"" );
        return 1;
     end;
  end;

  /*Пвыв_в/ф*/
  if( Itogs[ДУ_Пвыв_в_ф] != 0 )

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_в_ф], NATCUR, ДатаСписания, "86", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ReqFD.Kind, ReqFD.Id ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_в_ф], NATCUR, ДатаСписания, "95", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ReqFD.Kind, ReqFD.Id ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;
     end;

  /*Пвыв_к/ф */
  if( Itogs[ДУ_Пвыв_к_ф] != 0 )

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_к_ф], NATCUR, ДатаСписания, "86", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ReqFD.Kind, ReqFD.Id ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_к_ф], NATCUR, ДатаСписания, "96", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ReqFD.Kind, ReqFD.Id ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;
  end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_СК, Itogs[ДУ_СКост], NATCUR, ДатаУменьшенияКапитала, "86", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_ALL, ReqFD.Kind, ReqFD.Id ) )
        MsgBox( "Ошибка при сохранении итога \"СК\"" );
        return 1;
     end;

  UseProgress( Num = Num + 1 );

  if( IsFULL == false )
     if( not ПроводкиНачисленияПрибыли_ЧВ() )
        return false;
     end;
  else

     if( СвернутьСчета( OrderFD, DlDoc, ДатаСписания ) != 0 )
        return false;
     end;

     UseProgress( Num = Num + 1 );
     if( not ПроводкиНачисленияНДФЛ_ПВ() )
        return false;
     end;

     UseProgress( Num = Num + 1 );
     if( not ПроводкиНачисленияПрибыли_ПВ() )
        return false;
     end;

     UseProgress( Num = Num + 1 );
     if( not ПроводкиСписанияУбытка() )
        return false;
     end;

     UseProgress( Num = Num + 1 );
     if( not ПроводкиСписанияКапитала() )
        return false;
     end;
  end;

  UseProgress( Num = Num + 1 );
  recAsset = ReqFD.MoveFirstAsset( @NumAssets );
  InitProgress( NumAssets, "Выполнение вывода капитала", "Списание активов" );

  while( recAsset != NULL )
     AssetFD = TS_ReqAssetFD( recAsset, 0, OrderFD, ReqFD );

     if( Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY )
        if( not ПроводкиСписанияАктивов_ДС() )
           return false;
        end;

     elif( Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_EMISSIVE )
        if( not ПроводкиСписанияАктивов_ЭЦБ() )
           return false;
        end;

        if( not AssetFD.FormSecurLot() )
           return false;
        end;

     elif( Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_NOEMISSIVE )
        if( not ПроводкиСписанияАктивов_НЭЦБ() )
           return false;
        end;

        if( not ИзменитьУчтенныйВексель( recAsset.rec.VSBannerID, ДатаСписания, "abcstatus", VABANNER_STATUS_INPUT) )
           return false;
        end;
     end;

     if( not ПроводкаПоКатегориямВнутреннегоУчета( TS_IIF( Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY , 91, 93),
                                                   AssetFD, 
                                                   DlDoc, 
                                                   ДатаСписания, 
                                                   recAsset.rec.FIID,  
                                                   TS_IIF( Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY, Itogs[ДУ_Sвыпл], AssetFD.КоличествоАктива() )
                                                 ) )
        return false;
     end;

     /* для всех, кроме денег создается на шаге регистрации */
     if( Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY )
        if( TS_CreateDemandTrust( NULL, ID_Operation, 
                                  TS_DemandUserMark_Req( TS_DEMAND_ROLE_OBLIGATION, Request.rec.ID, recAsset.rec.ID ),
                                  TS_DEMAND_ROLE_OBLIGATION, 
                                  "1" /*КВТО = Расчеты с учредителем*/, 
                                  "86"/*КУС  = Вывод имущества из управления*/,  
                                  ДатаСписания, 
                                  Itogs[ДУ_Sвыпл], 
                                  recAsset.rec.FIID,
                                  AssetFD.DepositaryID(),
                                  OrderFD.ID, recAsset.rec.FIID, recAsset.rec.ID,
                                  TS_ACTIVE_KIND_EMISSIVE,
                                  ID_Step, TS_DOC_DECLAR_OUT, Request.rec.ID
                                ) == false )
           return 1;
        end;
     end;

     if( TS_ExecuteDemandByMark( TS_BofficeKind(), ID_Operation, TS_DemandUserMark_Req( TS_DEMAND_ROLE_OBLIGATION, Request.rec.ID, recAsset.rec.ID ), ДатаСписания, true ) != 0 )
        return false;
     end;

     AssetFD.Payment().ValueDate = ДатаСписания;
     AssetFD.Payment().Actuate();
     if( ИсполнитьПлатеж( AssetFD.Payment(), (РАБОТА_С_РАСЧЕТНЫМ_БАНКОМ() == true) ) )
        return false;
     end;
           
     recAsset = ReqFD.MoveNextAsset();
     UseProgress( NumAssetsCur = NumAssetsCur + 1 );
  end;
  RemProgress();

  if( IsFULL == false )
     UseProgress( Num = Num + 1 );
     if( not ПроводкиНачисленияНДФЛ_ЧВ() )
        return false;
     end;
  end;

  return true;
END;

MACRO ExecuteStep( _DlDoc, _FDoc, _DocKind, _ID_Operation, _ID_Step )

  DlDoc                  = _DlDoc;
  ID_Operation           = _ID_Operation;
  ID_Step                = _ID_Step;
  ДатаСписания           = Request.rec.FactTransferDate;
  ДатаУменьшенияКапитала = Request.rec.CapitalDate; 
  OrderFD = TS_OrderFD( 0, Request.rec.OrderID );
  ReqFD   = TS_RequestFD( Request, null, OrderFD );

  if( not CheckDate() )
     return 1;
  end;

  MngPlan = OrderFD.MngPlan( ДатаСписания );
  if( MngPlan == NULL )
     return 1;
  end;

  var CalcCom = DataCalcCom();
  if( not TS_CalculateItogsOut( Itogs, Request, ДатаУменьшенияКапитала-1, ID_Operation, ID_Step, CalcCom ) )
     return 1;
  end;

  CalcCom.sfdefcom_parm_M.rec.CommSum = Itogs[ДУ_Купр_ф];
  if( СохранитьПериодическуюКомиссию( OrderFD, CalcCom.CalcDateM, CalcCom.ConCom_M, CalcCom.sfdefcom_parm_M ) != 0 )
     return 1;
  end;
  CalcCom.sfdefcom_parm_S.rec.CommSum = Itogs[ДУ_Кусп_ф];
  if( СохранитьПериодическуюКомиссию( OrderFD, CalcCom.CalcDateS, CalcCom.ConCom_S, CalcCom.sfdefcom_parm_S ) != 0 )
     return 1;
  end;
  CalcCom.sfdefcom_parm_P.rec.CommSum = Itogs[ДУ_Кдв_ф];
  if( СохранитьПериодическуюКомиссию( OrderFD, CalcCom.CalcDateP, CalcCom.ConCom_P, CalcCom.sfdefcom_parm_P ) != 0 )
     return 1;
  end;

  InitProgress( -1, "Выполнение вывода капитала", "Выполнение вывода капитала" );
  if( not ВыполнитьВыводКапитала() )
     RemProgress();
     RemProgress();
     return 1;
  end;
  RemProgress();

  return 0;
END;

