/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : trvaprdec.mac
  Programmer  : Nikonorov Evgeny
  Comment     : Печать распоряжений по УВ в ДУ
└───────────────────────────────────────────────────────────────────────────*/
import vaprdec, adress;
import "tsrepsign.mac";

PRIVATE MACRO ПолучитьСрокПлатежаПоВекселюДляПечати(bnr, leg)
  var ll = TRecHandler("llvalues.dbt");
  var FormName = "";
  var TotalFormName = "";

  if(LL_FindLLVALUES( 1132, bnr.rec.BCTermFormula, ll ))
    FormName = ll.rec.Name;

    if(bnr.rec.BCTermFormula == VS_TERMF_FIXEDDAY) //на определенный день
      TotalFormName = /*FormName + " - " + */string(leg.rec.Maturity)/*+"г."*/;
    elif(bnr.rec.BCTermFormula == VS_TERMF_INATIME) //во столько-то времени от составления 
      TotalFormName = FormName + " - " + string(leg.rec.diff) + " дней";
    elif(bnr.rec.BCTermFormula == VS_TERMF_ATSIGHT) //по предъявлении
      if((leg.rec.Maturity < leg.rec.Start) AND (leg.rec.Expiry < leg.rec.Start))
        TotalFormName = FormName; // просто по предъявлении
      else
        if((leg.rec.Expiry < leg.rec.Start) and (leg.rec.Maturity >= leg.rec.Start))
          if(bnr.rec.BCTermFormat == 17) //не ранее дней
            TotalFormName = FormName + ", но не ранее срока "+string(leg.rec.Duration:0:0)+" дней от составления";            
          else
            TotalFormName = FormName + ", но не ранее "+string(leg.rec.Maturity)+"г.";            
          end;
        elif((leg.rec.Expiry >= leg.rec.Start) and (leg.rec.Maturity < leg.rec.Start))
          TotalFormName = FormName + ", но не позднее "+string(leg.rec.Expiry)+"г.";
        else
          if(bnr.rec.BCTermFormat == 17) //не ранее дней
            TotalFormName = FormName + ", но не ранее срока "+string(leg.rec.Duration:0:0)+" дней от составления и не позднее "+string(leg.rec.Expiry)+"г."; 
          else
            TotalFormName = FormName + ", но не ранее "+string(leg.rec.Maturity)+"г. и не позднее "+string(leg.rec.Expiry)+"г."; 
          end;  
        end;
      end;
    elif(bnr.rec.BCTermFormula == VS_TERMF_DURING) //во столько-то времени от предъявления
      TotalFormName = FormName + " - "+string(leg.rec.diff)+" дней";
    end;
  end;

  return TotalFormName;
END;

PRIVATE MACRO НомерЗаТекДень( SpGroundID, Kind, RegistrDate:Date ):integer
  var ds, rsd, NRec = 0;

  rsd = RSDCommand(
    " select t.rnum " +
    "   from (select rownum rnum, t_spgroundid " +
    "           from dspground_dbt " +            
    "          where t_kind = ? " +               
    "            and t_doclog = ? " +             
    "            and t_registrdate = ? " +        
    "         order by t_spgroundid) t " +
    "  where t.t_spgroundid = ? "         
  );

  rsd.addParam("", RSDBP_IN, Kind);
  rsd.addParam("", RSDBP_IN, 591);
  rsd.addParam("", RSDBP_IN, RegistrDate);
  rsd.addParam("", RSDBP_IN, SpGroundID);

  rsd.execute();
  ds = TRsbDataSet( rsd );
  while( ds.MoveNext() )
     NRec = SQL_ConvType(ds.rnum);
    end;

  if( NRec )
     return NRec;
  end;

  return 1;

END;

/****************************************************************************/
/* Распоряжение в депозитарий прием                                         */
/****************************************************************************/

MACRO ДУУВ_СформироватьРаспоряжениеВДепозитарийПрием(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_OFENRL.dot";
  var TempFile;

  record party("party");
  record address ( adress );
  file persn("person");
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var ourBankName = "";
  var issuerShortName = "";
  var ourAddr = "", ourTel = "", oper = "";
  var txt_veks = "";
  var veksCount = 0;
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var accounts = null;
  var Contr = null;
  var ContrDU = null;
  var NumOfDay:string = "1";
  var Ground;

  var ReportData = TS_ReportData();
    
  println(Шаблон);

  /*Имя выходного файла*/
  var d, m;
  DateSplit( date(ДатаШага), d, m, null );
  d = LeadZero(string(d), 2);
  m = LeadZero(string(m), 2);

  var Kind = 203;
  query =   "select gr.t_SPGroundID "
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(Kind)
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);

  Ground = TRsbDataSet(query);
  stat = Ground.MoveNext();
  if( stat )
     NumOfDay = string(НомерЗаТекДень(SQL_ConvTypeInteger(Ground.SpGroundID), Kind,  ДатаШага));
  end;
  NumOfDay = LeadZero( NumOfDay, 5);
    
  var DocName = "Поручение на инвентарную операцию_2" + d + m + NumOfDay;
  var innerNumber = "2";
  innerNumber = innerNumber + d + m + NumOfDay;

  [#.rtf]( DocName );

  [~our_bank];
  println(ReportData.OurBankShort);

  [~our_addr];
  println(ReportData.OurAddr());

  [~our_tel];
  println(ReportData.OurPhone());

  [~number];
  println( innerNumber );

  [~delivery_day];
  println(string(date(ДатаШага):f));

  [~our_bank_dup1];
  println(ReportData.OurBankShort);

  [~oper];
  println(ReportData.OperName());

  query =    "select acntAR.t_Name AS ActAccName, acntAR.t_BriefCode AS ActAccNum," 
           +       " acntPR.t_Name AS PasAccName, acntPR.t_BriefCode AS PasAccNum, paym2.t_Amount AS Amount" 
           + " from dpmpaym_dbt paym, dpmpaym_dbt paym2, dspdrprop_dbt dprop, dspdrmove_dbt dmov, ddepoacnt_dbt acntA,  ddepoacnt_dbt acntP, ddepoacnt_dbt acntAR,  ddepoacnt_dbt acntPR " 
           + " where"  
           +     " paym.t_DocumentID = " + Dl_Tick.DealID     //Идентификатор сделки 
           + " AND paym.t_DocKind = " + Dl_Tick.BOfficeKind   //Вид сделки
           + " AND paym.t_Purpose = " + BAi                   //Платеж по базовому активу (h\cbpmbfe.h)
           + " AND paym.t_PaymentID = dprop.t_PaymentID" 
           + " AND dprop.t_DraftID = dmov.t_DraftID" 
           + " AND dmov.t_PaymentID = paym2.t_PaymentID"
           + " AND paym2.t_PayerDpNode = acntA.t_AutoKey"
           + " AND paym2.t_ReceiverDpNode = acntP.t_AutoKey"
           + " AND acntPR.t_AutoKey = acntP.t_Root "
           + " AND acntAR.t_AutoKey = acntA.t_Root ";


  accounts = TRsbDataSet(query);
  stat = accounts.MoveNext();

  [~Active_Acc_Name];
  println(TS_IIF(stat, accounts.ActAccName, "" ));

  [~Active_Acc_Number];
  println(TS_IIF(stat, accounts.ActAccNum, "" ));

  [~total_debet];
  if(stat)
    println(accounts.Amount:0:0);
  else
    println("");
  end;

  [~Passive_Acc_Name];
  println(TS_IIF(stat, accounts.PasAccName, ""));

  [~Passive_Acc_Number];
  println(TS_IIF(stat, accounts.PasAccNum, ""));

  [~total_credit];
  if(stat)
    println(accounts.Amount:0:0);
  else
    println("");
  end;

  query =   "select ban.t_Issuer AS Issuer, ban.t_BcSeries AS BcSeries, ban.t_BcNumber AS BcNumber, leg.t_Principal AS Principal"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND lnk.t_LinkKind = " + VSORDLNK_K_BUY       //Покупка (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER    // Ценовые условия векселя (h\dlbfe.h)
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );

  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(3);              // идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            // Номер размножаемого ряда
  println(3);

  stat = veksel.MoveFirst();
  while(stat)

    N = N + 1;

    println("~N" + N);
    println(N);

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~issuer_name" + N);
    if( not ПолучитьСубъекта(veksel.Issuer, party) )
      issuerShortName = party.ShortName;
    else
      issuerShortName = "";
    end;
    println(Trim(issuerShortName));

    println("~face_value" + N);
    println(veksel.Principal:a);

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    N =1;
    println("~N" + N);
    println("");

    println("~ser" + N);
    println("-");

    println("~nbr" + N);
    println("");

    println("~issuer_name" + N);
    println("");

    println("~face_value" + N);
    println("");
  end;

  [~total_number];
  println(veksCount);

  [~total_number_text];  /*       1,      2, 3, 4,  5...  род-жен., точность*/                 
  txt_veks = NumToStr(veksCount, "штука", "штуки", "штук", false,     0);
  println(StrUpr(txt_veks, 1)); 

  [~Dok_A];
  println("");

  [~contract_N_DU1];
  println("");

  [~Dok_D];
  println( "Договор купли-продажи №" );

  query =   "select gr.t_XLD AS ContractN, gr.t_RegistrDate AS ContractDate"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(26)
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);

  Contr = TRsbDataSet(query);
  stat = Contr.MoveNext();
  
  [~Contract_N];
  println(TS_IIF(stat, Contr.ContractN, "" ));

  [~Contract_date];
  println(TS_IIF(stat, string(date(contr.ContractDate):f), "" ));

  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder);
  query =   "select t_XLD AS ContractNDU"
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt};
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~contract_N_DU2];
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));
  
  [~oper_dup1];
  println(ReportData.OperName());

  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

/****************************************************************************/
/* Распоряжение в депозитарий снятие                                        */
/****************************************************************************/

MACRO ДУУВ_СформироватьРаспоряжениеВДепозитарийСнятие(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_OFREPAY.dot";
  var TempFile;
  record party("party");
  record address ( adress );
  file persn("person");
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var issuerShortName = "";
  var txt_veks = "";
  var contractType = "";
  var veksCount = 0;
  var N = 0;
  var totalSum = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var accounts = null;
  var Contr = null;
  var ContrDU = null;
  var advRepay = null;
  var NumOfDay:string = "1";
  var Ground;

  var ReportData = TS_ReportData();

  println(Шаблон);

  /*Имя выходного файла*/
  var d, m;
  DateSplit( date(ДатаШага), d, m, null );
  d = LeadZero(string(d), 2);
  m = LeadZero(string(m), 2);

  var Kind = 204;
  query =   "select gr.t_SPGroundID "
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(Kind)
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);

  Ground = TRsbDataSet(query);
  stat = Ground.MoveNext();
  if( stat )
     NumOfDay = string(НомерЗаТекДень(SQL_ConvTypeInteger(Ground.SpGroundID), Kind, ДатаШага));
  end;
  NumOfDay = LeadZero( NumOfDay, 5);
    
  var DocName = "Поручение на инвентарную операцию_2" + d + m + NumOfDay;
  var innerNumber = "2";
  innerNumber = innerNumber + d + m + NumOfDay;

  [#.rtf]( DocName );

  //здесь будет заполнение шаблона данными
   [~our_bank];
  println(ReportData.OurBankShort);
 
  [~our_addr];
  println(ReportData.OurAddr());

  [~our_tel];
  println(ReportData.OurPhone());

  [~number];
  println( innerNumber );

  [~delivery_day];
  println(string(date(ДатаШага):f));

  [~our_bank_dup1];
  println(ReportData.OurBankShort);

  [~oper];
  println(ReportData.OperName());

  query =    "select acntAR.t_Name AS ActAccName, acntAR.t_BriefCode AS ActAccNum," 
           +       " acntPR.t_Name AS PasAccName, acntPR.t_BriefCode AS PasAccNum, paym2.t_Amount AS Amount" 
           + " from dpmpaym_dbt paym, dpmpaym_dbt paym2, dspdrprop_dbt dprop, dspdrmove_dbt dmov, ddepoacnt_dbt acntA,  ddepoacnt_dbt acntP, ddepoacnt_dbt acntAR,  ddepoacnt_dbt acntPR" 
           + " where"  
           +     " paym.t_DocumentID = " + Dl_Tick.DealID     //Идентификатор сделки 
           + " AND paym.t_DocKind = " + Dl_Tick.BOfficeKind   //Вид сделки
           + " AND paym.t_Purpose = " + BAi                   //Платеж по базовому активу (h\cbpmbfe.h)
           + " AND paym.t_PaymentID = dprop.t_PaymentID" 
           + " AND dprop.t_DraftID = dmov.t_DraftID" 
           + " AND dmov.t_PaymentID = paym2.t_PaymentID"
           + " AND paym2.t_ReceiverDpNode = acntA.t_AutoKey"
           + " AND paym2.t_PayerDpNode = acntP.t_AutoKey"
           + " AND acntPR.t_AutoKey = acntP.t_Root "
           + " AND acntAR.t_AutoKey = acntA.t_Root ";                 

  accounts = TRsbDataSet(query);
  stat = accounts.MoveNext();
  
  [~Active_Acc_Name];
  println(TS_IIF(stat, accounts.ActAccName, ""));

  [~Active_Acc_Number];
  println(TS_IIF(stat, accounts.ActAccNum, ""));

  [~total_debet];
  if(stat)
    println(accounts.Amount:0:0);
  else
    println("");
  end;

  [~Passive_Acc_Name];
  println(TS_IIF(stat, accounts.PasAccName, ""));

  [~Passive_Acc_Number];
  println(TS_IIF(stat, accounts.PasAccNum, ""));

  [~total_credit];
  if(stat)
    println(accounts.Amount:0:0);
  else
    println("");
  end;

  query =   "select ban.t_Issuer AS Issuer, ban.t_BcSeries AS BcSeries, ban.t_BcNumber AS BcNumber, leg.t_Principal AS Principal"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND "
         +   "(lnk.t_LinkKind = " + VSORDLNK_K_SALE         //Продажа     == Эмиссия (h\dlbfe.h)
         +          " OR "
         +    "lnk.t_LinkKind = " + VSORDLNK_K_DRAW + ")"   //Погашение   == Покупка (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER    // Ценовые условия векселя (h\dlbfe.h)
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );

  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(3);              // идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            // Номер размножаемого ряда
  println(3);

  stat = veksel.MoveFirst();
  while(stat)

    N = N + 1;

    println("~N" + N);
    println(N);

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~issuer_name" + N);
    if( not ПолучитьСубъекта(veksel.Issuer, party) )
      issuerShortName = party.ShortName;
    else
      issuerShortName = "";
    end;
    println(Trim(issuerShortName));

    println("~face_value" + N);
    println(veksel.Principal:a);

    stat = veksel.MoveNext();
  end;
  
  //если выборка в veksel пуста
  if(N == 0)
    N =1;
    println("~N" + N);
    println("");

    println("~ser" + N);
    println("-");

    println("~nbr" + N);
    println("");

    println("~issuer_name" + N);
    println("");

    println("~face_value" + N);
    println("");
  end;

  [~total_number];
  println(veksCount);

  [~total_number_text];  /*       1,      2, 3, 4,  5...  род-жен., точность*/                 
  txt_veks = NumToStr(veksCount, "штука", "штуки", "штук", false,     0);
  println(StrUpr(txt_veks, 1)); 

  [~Dok_A];
  println("");

  [~contract_N_DU1];
  println("");

  [~Dok_D];
  if(Dl_Tick.BOfficeKind == DL_VATRUST)     //Сделка покупки/продажи
    contractType = "Договор купли-продажи";
  elif(Dl_Tick.BOfficeKind == DL_VATRREPAY) //Погашение           
    query =   "select gr.t_XLD AS ContractN"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(335) /*DOCKIND_TRUST_AGREEADVREPAY - СОГЛАШЕНИЕ О ДОСРОЧНОМ ВЫКУПЕ*/
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591); /*LLCLASS_KINDDOC_TSBSORDER*/

    advRepay = TRsbDataSet(query);
    stat = advRepay.MoveNext();

    if(stat) 
      contractType = "Соглашение о досрочном выкупе";
    else
      query =   "select gr.t_XLD AS ContractN"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(102) /*DOCKIND_DECL_REPAY - ЗАЯВЛЕНИЕ НА ПОГАШЕНИЕ*/
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591); /*LLCLASS_KINDDOC_TSBSORDER*/

      advRepay = TRsbDataSet(query);
      stat = advRepay.MoveNext();
      if(stat)
       contractType = "Заявление на погашение векселей";
      else
       contractType = ""; 
      end;
    end
  end;
  
  println(contractType);

  query =   "select gr.t_XLD AS ContractN, gr.t_RegistrDate AS ContractDate"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(26)
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);

  Contr = TRsbDataSet(query);
  stat = Contr.MoveNext();
  
  [~Contract_N];
  println(TS_IIF(stat, Contr.ContractN, "" ));

  [~Contract_date];
  println(TS_IIF(stat, "от " + string(date(contr.ContractDate):f), "" ));

  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder);
  query =   "select t_XLD AS ContractNDU"
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt};
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~contract_N_DU2];
  println(TS_IIF(stat, "Клиент №" + ContrDU.ContractNDU, "" ));
  
  [~oper_dup1];
  println(ReportData.OperName());

  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

MACRO TSVA_GetPlanRepDateDet(bnrBCTermFormula, bnrBCPresentationDate, legStart, legDuration, legDiff, bnrissueDate)
VAR prd = Z_DATE;
if((bnrBCTermFormula == VS_TERMF_INATIME))
    prd = date(legStart) + int(legDuration);
elif((bnrBCTermFormula == VS_TERMF_FIXEDDAY))
    prd = date(bnrIssueDate)
elif(bnrBCTermFormula == VS_TERMF_DURING)
    prd = date(bnrBCPresentationDate) + legDiff;
end;
return prd;
END;

MACRO TSVA_GetPlanRepDate(bnr, leg)
    return TSVA_GetPlanRepDateDet(bnr.rec.BCTermFormula, bnr.rec.BCPresentationDate,
        leg.rec.Start, leg.rec.Duration, leg.rec.Diff, bnr.rec.issueDate);
END;

/****************************************************************************/
/* Анкета неэмиссионной цб                                                  */
/****************************************************************************/

MACRO ДУУВ_СформироватьАнкетаНеэмиссионнойЦБ(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_OFISCB.dot";
  var TempFile;
  record party("party");
  record address ( adress );
  file persn("person");
  var ourBankName = "";
  var issuerShortName = "";
  var oper = "";
  var cond = "";
  var rate:variant;
  var pay_date:variant;
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var fd = null;
  var step = null;
  var Bnr= null, leg = null;
  
  query =   "select  t_IsExecute AS Executed"
         + " from doprstep_dbt"
         + " where t_ID_Operation = " + ID_Operation
         +   " AND t_ID_Step = " + ID_Step;

  step = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  step.MoveNext();

  if(step.Executed == "X") //Шаг выполнен
    cond = " 1 <= "; 
  else
    cond = " 0 = "; //Ни одной записи
  end;

  query =   "select ban.t_BCID AS BCID, ban.t_Issuer AS Issuer, ban.t_BcSeries AS BcSeries, ban.t_BcNumber AS BcNumber," 
         +        " leg.t_Principal AS Principal, leg.t_Start AS IssueDate, leg.t_Price AS Rate, ban.t_IssuePlace, ban.t_PaymentPlace"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND lnk.t_LinkKind = " + VSORDLNK_K_BUY       //Покупка (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER    // Ценовые условия векселя (h\dlbfe.h)
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         +   " AND " + cond + "( select count(*) "
         +              " from dvsbnrbck_dbt bck"  
         +              " where bck.t_BCID = ban.t_BCID"
         +                " AND bck.t_OldAbcStatus = " + VABANNER_STATUS_INPUT    // введен
         +                " AND bck.t_NewAbcStatus = " + VABANNER_STATUS_ACCOUNT  // учтен
         +              ")"
         + " Order By BcSeries, BcNumber";
  
  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  stat = veksel.MoveLast();

  if(stat) //Если выборка не пуста
    println(Шаблон);
    println("OFISCB_"+GenFileName());
    [~KillBm];

    ClearRecord(persn); 
    persn.Oper = {oper};
    if( getEQ(persn) )
      oper = persn.Name;
    else
      oper = "";
    end;

  while(stat)
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);
    
    if(N > 0)
      [~NewGroup];
    end;

    println("~issuer_name1" );
    if( not ПолучитьСубъекта(veksel.Issuer, party) )
      issuerShortName = party.ShortName;
    else
      issuerShortName = "";
    end;
    println(Trim(issuerShortName));

    println("~face_value1");
    println(veksel.Principal);

    println("~issue_date1");
    println(string(date(veksel.IssueDate):f));

    println("~issue_place1");
    println(string(veksel.IssuePlace));

    println("~ser1");
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr1");
    println(Trim(veksel.BcNumber));

    println("~pay_date1");
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
 
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));
      
    println("~rate1");
    if(veksel.Rate != 0.0)   
      rate = veksel.Rate / 10000 + string("%");
    else
      rate = "-";
    end;
    println(rate:0:4);

    println("~payment_place1");
    println(string(veksel.PaymentPlace)); 

    [~oper_day1];
    println(string(date(DL_Tick.DealDate):f));

    [~oper1];
    println(oper);

    stat = veksel.MovePrev();
    N = N + 1;
  end;

  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);
  end;

  RETURN 1;    
END;

/****************************************************************************/
/* Мемориальный ордер по приему ценностей                                   */
/****************************************************************************/

MACRO ДУУВ_СформироватьМемордерПриемЦенностей(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_MOEN.dot";
  var TempFile;

  record party("party");
  var ourBankName = "";
  var issuerShortName = "";
  var veksCount = 0;
  var N = 0;
  var stat = false;
  var totalSum = 0;
  var query;
  var veksel;

  println(Шаблон);
  println("MOEN_"+GenFileName());

  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankName = party.ShortName;
  else
    ourBankName = "";
  end;  
  
  [~our_bank];
  println(ourBankName);

  [~oper_day];
  println(string(date(dl_tick.DealDate):f));

  [~delivery_day];
  println(string(date(ДатаШага):f));

  [~our_bank_dup1];
  println(ourBankName);
  
  query =   "select ban.t_Issuer AS Issuer, ban.t_BcSeries AS BcSeries, ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND lnk.t_LinkKind = " + VSORDLNK_K_BUY       //Покупка (h\dlbfe.h)
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );

  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              // идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            // Номер размножаемого ряда
  println(15);

  stat = veksel.MoveFirst();
  while(stat)

    N = N + 1;

    println("~issuer_name" + N);
    if( not ПолучитьСубъекта(veksel.Issuer, party) )
      issuerShortName = party.ShortName;
    else
      issuerShortName = "";
    end;
    println(Trim(issuerShortName):l);

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~sum" + N);
    println(veksel.BcCost:a);
    totalSum = totalSum + veksel.BcCost;  

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    N =1;
    println("~issuer_name" + N);
    println("");

    println("~ser" + N);
    println("-");

    println("~nbr" + N);
    println("");

    println("~sum" + N);
    println("");
  end;

  [~t_n];
  println(veksCount);

  [~total_sum];
  println(totalSum:a);

  [~total_sum_text];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));


  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;


/****************************************************************************/
/* Мемориальный ордер по выдаче ценностей                                   */
/****************************************************************************/


MACRO ДУУВ_СформироватьМемордерВыдачаЦенностей(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_MORP.dot";
  var TempFile;

  record party("party");
  var ourBankName = "";
  var issuerShortName = "";
  var veksCount = 0;
  var N = 0;
  var stat = false;
  var totalSum = 0;
  var query;
  var veksel;

  println(Шаблон);
  println("MORP_"+GenFileName());

  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankName = party.ShortName;
  else
    ourBankName = "";
  end;  
  
  [~our_bank];
  println(ourBankName);

  [~oper_day];
  println(string(date(dl_tick.DealDate):f));

  [~delivery_day];
  println(string(date(ДатаШага):f));

  [~our_bank_dup1];
  println(ourBankName);
  
  query =   "select ban.t_Issuer AS Issuer, ban.t_BcSeries AS BcSeries, ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND "
         +   "(lnk.t_LinkKind = " + VSORDLNK_K_SALE         //Продажа     == Эмиссия (h\dlbfe.h)
         +          " OR "
         +    "lnk.t_LinkKind = " + VSORDLNK_K_DRAW + ")"   //Погашение   == Покупка (h\dlbfe.h)
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );

  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              // идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            // Номер размножаемого ряда
  println(15);

  stat = veksel.MoveFirst();
  while(stat)

    N = N + 1;

    println("~issuer_name" + N);
    if( not ПолучитьСубъекта(veksel.Issuer, party) )
      issuerShortName = party.ShortName;
    else
      issuerShortName = "";
    end;
    println(Trim(issuerShortName));

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~sum" + N);
    println(veksel.BcCost:a);
    totalSum = totalSum + veksel.BcCost;  

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    N =1;
    println("~issuer_name" + N);
    println("");

    println("~ser" + N);
    println("-");

    println("~nbr" + N);
    println("");

    println("~sum" + N);
    println("");
  end;

  [~t_n];
  println(veksCount);

  [~total_sum];
  println(totalSum:a);

  [~total_sum_text];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

/****************************************************************************/
/* Акт приемки-передачи продажа                                             */
/****************************************************************************/

MACRO ДУУВ_СформироватьАктПриемаПередачиПродажа(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_ACTRP.dot";
  var TempFile;
  record party("party");
  record address ( adress );
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var tbfParty = TBfile("party.dbt");
  var tbfPtOfc = TBfile("ptoffice.dbt");
  var ourBankFullName = "";
  var bankCity = "";
  var issuerFullName = "";
  var txtVeks = "";
  var DepartDU = 0;
  var DepartDURp = "";
  var veksCount = 0;
  var totalSum = 0; 
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var fd = null;
  var rate:variant;
  var payDate:variant;
  var err;
  var Bnr= null, Leg=null;
  var Contr = null;
  var ContrDU = null;
  var Ofc = null;
  var ourOfc = null;
  var du_ofbu_text= "учредителя доверительного управления по договору";

  println(Шаблон);
  println("ACTRP_"+GenFileName());

  if((CB_GetTSContrBySfContr( dl_tick.ClientContrID, TSOrder )) and ((TS_OrderFD(0,TSOrder.rec.ID).Order().rec.DocKind == TS_DOC_DPOFBU) or (TS_OrderFD(0,TSOrder.rec.ID).Order().rec.DocKind == TS_DOC_OFBU)))
    du_ofbu_text = "учредителей общего фонда банковского управления";     
  end;

  [~DU_OFBU];
  println(du_ofbu_text);


  //>>Полное наименование нашего банка
  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankFullName = party.Name;
  else
    ourBankFullName = "";
  end;  
  [~OurBankFull];                                                               
  println(ourBankFullName);

  //>>Город из адреса нашего банка
  if(НайтиЮридическийАдресСубъекта(party.PartyID, address))
    bankCity = adress.District;
  else
    bankCity = "";
  end;
  [~City];
  println(bankCity);

  //>>Дата операции
  [~OperDate];
  println(string(date(Dl_Tick.DealDate):f)); 

  //>>Номер и Дата открытия договора ДУ
  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder); 
  query =   "select t_XLD AS ContractNDU, t_BeginningDate as ContractDateDU" 
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt}; 
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~ContractNmbDU];
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));

  [~ContractDateDU];
  println(TS_IIF(stat, string(date(ContrDU.ContractDateDU):f), "" ));

  //>>Должность (в родительном падеже) представителя Нашего Банка
  GetRegistryValue( "ДОВЕРИТЕЛЬНОЕ УПРАВЛЕНИЕ\\ОТДЕЛ ДОВЕРИТЕЛЬНОГО УПРАВЛЕНИЯ", V_INTEGER, DepartDU, err );
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS OurRepresFio, ofc.t_Post AS OurRepresPost "
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + {ourbank}
         +  "   AND ofc.t_IsFirstOfficePerson = 'X'"
         +  "   AND ofc.t_OfficeID = " + DepartDU; //Отдел ДУ   

  ourOfc = TRsbDataSet(query);
  stat = ourOfc.MoveNext();

  
  [~OurRepresPos]; /*--закладка идет не по порядку--Должность представителя нашего банка - начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresPost, ""));

  
  [~OurRepres]; /*--закладка идет не по порядку--ФИО нашего представителя - начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = ourOfc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;

  [~OurRepresPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" )); /*50 - Должность в родит. падеже*/

  //>>ФИО начальника отдела ДУ нашего банка в родит. падеже  
  [~OurRepres_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" )); /*49 - Полное наименование в родит. падеже - ФИО*/

  //Данные (в родит. падеже) о документе, на основании которого действует представитель нашего банка 
  [~OurRepresDoc_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 51), "" )); /*51 - Документ-основание представителя по договору в родит. падеже - ФИО*/


  //>>Наименование подразделения (Отдела ДУ) - в родительном падеже
  tbfPtOfc.rec.PartyID = {ourbank};
  tbfPtOfc.rec.OfficeID = DepartDU;
  stat = tbfPtOfc.GetEQ();
  if(stat)
    DepartDURp = readNoteForObject(/*OBJTYPE_SUBDIVISION*/10, UniID(tbfPtOfc, /*OBJTYPE_SUBDIVISION*/10), 1); /*1 - Наименование в родит. падеже*/
    if(DepartDURp == "")
      DepartDURp = "Управления доверительных операций";
    end;
  else
    DepartDURp = "Управления доверительных операций";
  end;

  [~DU_department_rp];
  println(DepartDURp);

  [~DU_department_rp_dup2];  /*--закладка идет не по порядку--*/
  println(DepartDURp);

  //>>Полное наименование нашего банка в родительном падеже 
  [~OurBankFull_rp];
  tbfParty.rec.PartyID = {ourbank};
  stat = tbfParty.GetEQ();
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже*/
  
  //>>Полное наименование контрагента
  if( not ПолучитьСубъекта(Dl_Tick.PartyID, party) )
    issuerFullName = party.Name;
  else
    issuerFullName = "";
  end;  
  [~IssuerFull];
  println(issuerFullName);

  //>>Должность и ФИО (в родительном падеже) представителя КОНТРАГЕНТА 
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS IsuuerRepresFio, ofc.t_Post AS IssuerRepresPost"
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + DL_Tick.PartyID
         +  "   AND ofc.t_IsFirstPerson = 'X'";   

  Ofc = TRsbDataSet(query);
  stat = Ofc.MoveNext();

  [~IssuerRepresPos];/*--закладка идет не по порядку--Должность представителя контрагента */
  println(TS_IIF(stat, Ofc.IssuerRepresPost, ""));

  [~IssuerRepres];/*--закладка идет не по порядку--ФИО представителя контрагента*/
  println(TS_IIF(stat, Ofc.IsuuerRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = Ofc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;
                                                               
  [~IssuerReprPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" ) );/*50 - Должность в родит. падеже*/

  [~IssuerRepr_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже - ФИО*/

  //Тело отчета (по одной строке для каждого векселя операции)
  query =   "select ban.t_BCID AS BCID, ban.t_Issuer AS Issuer, party.t_ShortName AS IssShortName , ban.t_BcSeries AS BcSeries," 
         +        " ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost," 
         +        " leg.t_Principal AS Principal, leg.t_Start AS IssueDate, leg.t_Price AS Rate"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg, dparty_dbt party"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND lnk.t_LinkKind = " + VSORDLNK_K_SALE       //Продажа (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER     //Ценовые условия векселя (h\dlbfe.h)
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         +   " AND ban.t_Issuer = party.t_PartyID"
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              //идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            //Номер размножаемого ряда
  println(2);

  stat = veksel.MoveFirst();
  while(stat)
    N = N + 1;
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);

    println("~N" + N);
    println(N);
    
    println("~IssuerShort" + N );
    println(Trim(veksel.IssShortName));

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~IssueDate" + N);
    println(string(date(veksel.IssueDate):f));

    println("~FaceValue" + N);
    println(veksel.Principal);

    println("~rate" + N);
    if(veksel.Rate != 0.0)   
      rate = veksel.Rate / 10000;
    else
      rate = "-";
    end;
    println(rate:0:4);

    println("~PayDate" + N);
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));

    totalSum = totalSum + veksel.Principal;

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    println("~N1");
    println(N);
    
    println("~IssuerShort1");
    println("");

    println("~ser1");
    println("-");

    println("~nbr1");
    println("");

    println("~IssueDate1");
    println("");

    println("~FaceValue1");
    println("");

    println("~rate1");
    println("-");

    println("~PayDate1");
    println("");
  end;

  //>>Количество векселей сделки (цифрами)
  [~total_number];
  println(veksCount);

  //>>Количество векселей  сделки (прописью)
  [~total_number_text];  /*       1,      2, 3, 4,  5...  род-муж., точность*/                 
  txtVeks = NumToStr(veksCount, "вексель", "векселя", "векселей", true,     0);
  println(txtVeks); 

  //>>Сумма сделки, в рублях, с точностью до копеек, цифрами
  [~total_amount];
  println(totalSum:a);

  //>>Сумма сделки, в рублях, с точностью до копеек, прописью
  [~total_amont_rub_text];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  //>>№ и Дата документа "Договор купли-продажи" из документов сделки
  query =   "select gr.t_XLD AS ContractN, gr.t_RegistrDate AS ContractDate"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(26)          //DOCKIND_BUYSALEREPORT - Договор-купли продажи
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);      //LLCLASS_KINDDOC_TSBSORDER - Договор-купли продажи

  Contr = TRsbDataSet(query);
  stat = Contr.MoveNext();
  
  [~ContractN];
  println(TS_IIF(stat, Contr.ContractN, "" ));

  [~ContractDate];
  println(TS_IIF(stat, string(date(contr.ContractDate):f), "" ));



  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

/****************************************************************************/
/* Акт приемки-передачи продажа                                             */
/****************************************************************************/

MACRO ДУУВ_СформироватьАктПриемаПередачиПокупка(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_ACTBUY.dot";
  var TempFile;

  record party("party");
  record address ( adress );
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var tbfParty = TBfile("party.dbt");
  var tbfPtOfc = TBfile("ptoffice.dbt");
  var ourBankFullName = "";
  var bankCity = "";
  var issuerFullName = "";
  var txtVeks = "";
  var DepartDU = 0;
  var DepartDURp = "";
  var veksCount = 0;
  var totalSum = 0;
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var fd = null;
  var rate:variant;
  var payDate:variant;
  var err;
  var Bnr= null, leg = null;
  var Contr = null;
  var ContrDU = null;
  var Ofc = null;
  var ourOfc = null;
  var du_ofbu_text  = "учредителя доверительного управления";

  println(Шаблон);
  println("ACTBUY_"+GenFileName());

  if((CB_GetTSContrBySfContr( dl_tick.ClientContrID, TSOrder )) and ((TS_OrderFD(0,TSOrder.rec.ID).Order().rec.DocKind == TS_DOC_DPOFBU) or (TS_OrderFD(0,TSOrder.rec.ID).Order().rec.DocKind == TS_DOC_OFBU)))
    du_ofbu_text = "учредителей общего фонда банковского управления";     
  end;

  [~DU_OFBU];
  println(du_ofbu_text);

  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankFullName = party.Name;
  else
    ourBankFullName = "";
  end;  
  [~OurBankFull];                                                               
  println(ourBankFullName);
  
  if(НайтиЮридическийАдресСубъекта(party.PartyID, address))
    bankCity = adress.District;
  else
    bankCity = "";
  end;
  [~City];
  println(bankCity);

  [~OperDate];
  println(string(date(Dl_Tick.DealDate):f));

  //Полное наименование контрагента
  if( not ПолучитьСубъекта(Dl_Tick.PartyID, party) )
    issuerFullName = party.Name;
  else
    issuerFullName = "";
  end;  
  [~IssuerFull];
  println(issuerFullName);

  //Должность и ФИО (в родительном падеже) представителя КОНТРАГЕНТА 
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS IsuuerRepresFio, ofc.t_Post AS IssuerRepresPost"
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + DL_Tick.PartyID
         +  "   AND ofc.t_IsFirstPerson = 'X'";   

  Ofc = TRsbDataSet(query);
  stat = Ofc.MoveNext();

  [~IssuerRepresPos];/*--закладка идет не по порядку--Должность представителя контрагента */
  println(TS_IIF(stat, Ofc.IssuerRepresPost, ""));

  [~IssuerRepres];/*--закладка идет не по порядку--ФИО представителя контрагента*/
  println(TS_IIF(stat, Ofc.IsuuerRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = Ofc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;
                                                               
  [~IssuerReprPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" ) );/*50 - Должность в родит. падеже*/

  [~IssuerRepr_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже - ФИО*/

  
  //Номер и Дата открытия договора ДУ
  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder); 
  query =   "select t_XLD AS ContractNDU, t_BeginningDate as ContractDateDU" 
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt}; 
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~ContractNmbDU ];
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));

  [~ContractDateDU ];
  println(TS_IIF(stat, string(date(ContrDU.ContractDateDU):f), "" ));


  
  //Должность (в родительном падеже) представителя Нашего Банка
  GetRegistryValue( "ДОВЕРИТЕЛЬНОЕ УПРАВЛЕНИЕ\\ОТДЕЛ ДОВЕРИТЕЛЬНОГО УПРАВЛЕНИЯ", V_INTEGER, DepartDU, err );
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS OurRepresFio, ofc.t_Post AS OurRepresPost "
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + {ourbank}
         +  "   AND ofc.t_IsFirstOfficePerson = 'X'"
         +  "   AND ofc.t_OfficeID = " + DepartDU; //Отдел ДУ   

  ourOfc = TRsbDataSet(query);
  stat = ourOfc.MoveNext();

  
  [~OurRepresPos]; /*--закладка идет не по порядку--Должность представителя нашего банка - начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresPost, ""));

  
  [~OurRepres]; /*--закладка идет не по порядку--ФИО нашего представителя - начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = ourOfc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;

  [~OurRepresPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" )); /*50 - Должность в родит. падеже*/

  //ФИО начальника отдела ДУ нашего банка в родит. падеже  
  [~OurRepres_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" )); /*49 - Полное наименование в родит. падеже - ФИО*/

  //Данные (в родит. падеже) о документе, на основании которого действует представитель нашего банка 
  [~OurRepresDoc_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 51), "" )); /*51 - Документ-основание представителя по договору в родит. падеже - ФИО*/


  //Наименование подразделения (Отдела ДУ) - в родительном падеже
  tbfPtOfc.rec.PartyID = {ourbank};
  tbfPtOfc.rec.OfficeID = DepartDU;
  stat = tbfPtOfc.GetEQ();
  if(stat)
    DepartDURp = readNoteForObject(/*OBJTYPE_SUBDIVISION*/10, UniID(tbfPtOfc, /*OBJTYPE_SUBDIVISION*/10), 1); /*1 - Наименование в родит. падеже*/
    if(DepartDURp == "")
      DepartDURp = "Управления доверительных операций";
    end;
  else
    DepartDURp = "Управления доверительных операций";
  end;

  [~DU_department_rp];
  println(DepartDURp);
  
  [~DU_department_rp_dup2];  /*--закладка идет не по порядку--*/
  println(DepartDURp);


  //Полное наименование нашего банка в родительном падеже 
  [~OurBankFull_rp];
  tbfParty.rec.PartyID = {ourbank};
  stat = tbfParty.GetEQ();
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже*/
  

  //Тело отчета (по одной строке для каждого векселя операции)
  query =   "select ban.t_BCID AS BCID, ban.t_Issuer AS Issuer, party.t_ShortName AS IssShortName , ban.t_BcSeries AS BcSeries," 
         +        " ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost," 
         +        " leg.t_Principal AS Principal, leg.t_Start AS IssueDate, leg.t_Price AS Rate"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg, dparty_dbt party"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND lnk.t_LinkKind = " + VSORDLNK_K_BUY       //Покупка (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER     //Ценовые условия векселя (h\dlbfe.h)
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         +   " AND ban.t_Issuer = party.t_PartyID"
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              //идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            //Номер размножаемого ряда
  println(2);

  stat = veksel.MoveFirst();
  while(stat)
    N = N + 1;
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);

    println("~N" + N);
    println(N);
    
    println("~IssuerShort" + N );
    println(Trim(veksel.IssShortName));

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~IssueDate" + N);
    println(string(date(veksel.IssueDate):f));

    println("~FaceValue" + N);
    println(veksel.Principal:a);

    println("~rate" + N);
    if(veksel.Rate != 0.0)   
      rate = veksel.Rate / 10000;
    else
      rate = "-";
    end;
    println(rate:0:4);

    println("~PayDate" + N);
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));

    totalSum = totalSum + veksel.Principal;

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    println("~N1");
    println(N);
    
    println("~IssuerShort1");
    println("");

    println("~ser1");
    println("-");

    println("~nbr1");
    println("");

    println("~IssueDate1");
    println("");

    println("~FaceValue1");
    println("");

    println("~rate1");
    println("-");

    println("~PayDate1");
    println("");
  end;

  [~total_number];
  println(veksCount);

  [~total_number_text];  /*       1,      2, 3, 4,  5...  род-муж., точность*/                 
  txtVeks = NumToStr(veksCount, "вексель", "векселя", "векселей", true,     0);
  println(txtVeks); 


  [~total_amount];
  println(totalSum:a);

  [~total_amont__rub_text];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  //>>№ и Дата документа "Договор купли-продажи" из документов сделки
  query =   "select gr.t_XLD AS ContractN, gr.t_RegistrDate AS ContractDate"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(26)           //DOCKIND_BUYSALEREPORT - Договор-купли продажи
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);       //LLCLASS_KINDDOC_TSBSORDER - Договор-купли продажи

  Contr = TRsbDataSet(query);
  stat = Contr.MoveNext();
  
  [~ContractN];
  println(TS_IIF(stat, Contr.ContractN, dl_tick.DealCode ));

  [~ContractDate];
  println(TS_IIF(stat, string(date(contr.ContractDate):f), string(date(dl_tick.DealDate):f)));

  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

/****************************************************************************/
/* Договор купли-продажи                                                    */
/****************************************************************************/

MACRO ДУУВ_СформироватьДоговорКуплиПродажи(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_CONTRSB.dot";
  var TempFile;
  record party("party");
  record address ( adress );
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var tbfParty = TBfile("party.dbt");
  var tbfPtOfc = TBfile("ptoffice.dbt");
  var ourBankFullName = "";
  var bankCity = "";
  var bankAddress = "";
  var contrAgentAdrs = "";
  var issuerFullName = "";
  var txtVeks = "";
  var DepartDU = 0;
  var DepartDURp = "";
  var veksCount = 0;
  var totalSum = 0; 
  var totalSumNominal = 0; 
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var fd = null;
  var rate:variant;
  var supplyDate;
  var payDate:variant;
  var err;
  var Bnr= null, Leg=null;
  var Contr = null;
  var ContrDU = null;
  var Ofc = null;
  var ourOfc = null;
  var Spi = null;
  var ContrTypeBuy = false;
  var du_ofbu_text = "учредителя доверительного управления";

  //Определим тип сделки
  if(VA_IsBuy(Dl_Tick.DealType))
    ContrTypeBuy = true;            //Покупка
  elif(VA_IsSale(Dl_Tick.DealType))
    ContrTypeBuy = false;           //Продажа 
  end;

  println(Шаблон);
  println("CONTRSB_"+GenFileName());
  

  if((CB_GetTSContrBySfContr( dl_tick.ClientContrID, TSOrder )) and ((TS_OrderFD(0,TSOrder.rec.ID).Order().rec.DocKind == TS_DOC_DPOFBU) or (TS_OrderFD(0,TSOrder.rec.ID).Order().rec.DocKind == TS_DOC_OFBU)))
    du_ofbu_text = "учредителей общего фонда банковского управления";     
  end;

  [~DU_OFBU];
  println(du_ofbu_text);

  //>>Номер документа "Договор купли-продажи" внутренний
  query =   "select gr.t_XLD AS ContractN, gr.t_RegistrDate AS RegistrDate"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(26)
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591);

  Contr = TRsbDataSet(query);
  stat = Contr.MoveNext();
  
  [~ContractN];
  println(TS_IIF(stat, Contr.ContractN, "" ));
  [~ContractN_dup];
  println(TS_IIF(stat, Contr.ContractN, "" ));

  //>>Дата документа "Договор купли-продажи" из документов операции
  [~OperDate]; /*--закладка идет не по порядку--*/ 
  println(string(date(DL_Tick.DealDate):f));
  [~OperDate_dup]; /*--закладка идет не по порядку--*/ 
  println(string(date(DL_Tick.DealDate):f));

  //>>Полное наименование НАШЕГО БАНКА
  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankFullName = party.Name;
  else
    ourBankFullName = "";
  end;  
  [~OurBankFull]; /*--закладка идет не по порядку--*/
  println(ourBankFullName);

  [~OurBankFull_dup2]; /*--закладка идет не по порядку--*/
  println(ourBankFullName);

  //>>Город из адреса НАШЕГО БАНКА
  if(НайтиЮридическийАдресСубъекта({ourbank}, address))
    bankCity = adress.District;
    bankAddress = adress.Adress;
  else
    bankCity = "";
    bankAddress = "";
  end;
  [~City];
  println(bankCity);

  //>>Адрес нашего банка
  [~OurAddr];  /*--закладка идет не по порядку--*/
  println(bankAddress);

  //>> № и Дата открытия договора ДУ, для которого выполняется погашения
  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder); 
  query =   "select t_XLD AS ContractNDU, t_BeginningDate as ContractDateDU" 
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt}; 
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~ContractDUNmb ];
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));

  [~ContractDUDate ];
  println(TS_IIF(stat, string(date(ContrDU.ContractDateDU):f), "" ));

  [~ContractDUNmb_dup2]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, Contr.ContractN, "" ));

  [~ContractDUDate_dup2]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, string(date(Contr.RegistrDate):f), "" ));              


  //>>Должность (в родительном падеже) представителя НАШЕГО БАНКА 
  GetRegistryValue( "ДОВЕРИТЕЛЬНОЕ УПРАВЛЕНИЕ\\ОТДЕЛ ДОВЕРИТЕЛЬНОГО УПРАВЛЕНИЯ", V_INTEGER, DepartDU, err );
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS OurRepresFio, ofc.t_Post AS OurRepresPost "
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + {ourbank}
         +  "   AND ofc.t_IsFirstOfficePerson = 'X'"
         +  "   AND ofc.t_OfficeID = " + DepartDU; //Отдел ДУ   

  ourOfc = TRsbDataSet(query);
  stat = ourOfc.MoveNext();

  [~OurRepresPos]; /*--закладка идет не по порядку--Должность представителя нашего банка - начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresPost, ""));

  
  [~OurRepres]; /*--закладка идет не по порядку--ФИО нашего представителя - начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = ourOfc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;

  [~OurRepresPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" )); /*50 - Должность в родит. падеже*/

  //>>ФИО начальника отдела ДУ НАШЕГО БАНКА в родит. падеже  
  [~OurRepres_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" )); /*49 - Полное наименование в родит. падеже - ФИО*/
  
  //>>Данные (в родит. падеже) о документе, на основании которого действует представитель НАШЕГО БАНКА 
  [~OurRepresDoc_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 51), "" )); /*51 - Документ-основание представителя по договору в родит. падеже - ФИО*/
  
  //>>Наименование подразделения, указанного в качестве "Отдела ДУ"
  tbfPtOfc.rec.PartyID = {ourbank};
  tbfPtOfc.rec.OfficeID = DepartDU;
  stat = tbfPtOfc.GetEQ();
  if(stat)
    DepartDURp = readNoteForObject(/*OBJTYPE_SUBDIVISION*/10, UniID(tbfPtOfc, /*OBJTYPE_SUBDIVISION*/10), 1); /*1 - Наименование в родит. падеже*/
    if(DepartDURp == "")
      DepartDURp = "Управления доверительных операций";
    end;
  else
    DepartDURp = "Управления доверительных операций";
  end;

  [~DU_department_rp];
  println(DepartDURp);

  [~DU_department_rp_dup2]; /*--закладка идет не по порядку--*/
  println(DepartDURp);

  //>>Полное наименование НАШЕГО БАНКА в родительном падеже 
  [~OurBankFull_rp];
  tbfParty.rec.PartyID = {ourbank};
  stat = tbfParty.GetEQ();
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже*/

  //>>Роль НАШЕГО БАНКА в сделке
  [~OurBankParty];
  if(ContrTypeBuy) 
    println("Покупатель"); //Покупка
  else                                
    println("Продавец");   //Продажа  
  end;

  //>>Роль КОНТРАГЕНТА в сделке
  [~IssuerPart]; /*--закладка идет не по порядку--*/
  if(ContrTypeBuy) 
    println("Продавец");   //Покупка
  else                                
    println("Покупатель"); //Продажа  
  end;

  //>>Полное наименование КОНТРАГЕНТА
  if( not ПолучитьСубъекта(Dl_Tick.PartyID, party) )
    issuerFullName = party.Name;
  else
    issuerFullName = "";
  end;  
  [~IssuerFull];
  println(issuerFullName);

  //>>Полное наименование КОНТРАГЕНТА по сделке
  [~IssuerFull_dup2]; /*--закладка идет не по порядку--*/
  println(issuerFullName);


  //>>Должность и ФИО (в родительном падеже) представителя КОНТРАГЕНТА 
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS IsuuerRepresFio, ofc.t_Post AS IssuerRepresPost"
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + DL_Tick.PartyID
         +  "   AND ofc.t_IsFirstPerson = 'X'";   

  Ofc = TRsbDataSet(query);
  stat = Ofc.MoveNext();

  [~IssuerRepresPos];/*--закладка идет не по порядку--Должность представителя контрагента */
  println(TS_IIF(stat, Ofc.IssuerRepresPost, ""));

  [~IsuuerRepres];/*--закладка идет не по порядку--ФИО представителя контрагента*/
  println(TS_IIF(stat, Ofc.IsuuerRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = Ofc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;
                                                               
  [~IssuerReprPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" ) );/*50 - Должность в родит. падеже*/

  [~IssuerRepr_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже - ФИО*/

  //>>Тело отчета (по одной строке для каждого векселя операции)
  query =   "select ban.t_BCID AS BCID, ban.t_Issuer AS Issuer, party.t_ShortName AS IssShortName , ban.t_BcSeries AS BcSeries," 
         +        " ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost," 
         +        " leg.t_Principal AS Principal, leg.t_Start AS IssueDate, leg.t_Price AS Rate"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg, dparty_dbt party"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND lnk.t_LinkKind = " + TS_IIF(ContrTypeBuy, VSORDLNK_K_BUY,  VSORDLNK_K_SALE)   // Покупка / Продажа
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER     //Ценовые условия векселя (h\dlbfe.h)
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         +   " AND ban.t_Issuer = party.t_PartyID"
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              //идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            //Номер размножаемого ряда
  println(2);

  stat = veksel.MoveFirst();
  while(stat)
    N = N + 1;
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);

    println("~N" + N);
    println(N);
    
    println("~IssuerShort" + N );
    println(Trim(veksel.IssShortName));

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~IssueDate" + N);
    println(string(date(veksel.IssueDate):f));

    println("~FaceValue" + N);
    println(veksel.Principal:a);

    println("~Rate" + N);
    if(veksel.Rate != 0.0)   
      rate = veksel.Rate / 10000;
    else
      rate = "-";
    end;
    println(rate:0:4);

    println("~PayDate" + N);
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));

    println("~Price" + N);
    println(veksel.BcCost:a);

    totalSum = totalSum + veksel.BcCost;
    totalSumNominal = totalSumNominal + veksel.Principal;

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    println("~N1");
    println(N);
    
    println("~issuer_name1");
    println("");

    println("~ser1");
    println("-");

    println("~nbr1");
    println("");

    println("~issue_date1");
    println("");

    println("~face_value1");
    println("");

    println("~rate1");
    println("-");

    println("~pay_date1");
    println("");

    println("~Price1");
    println("");
  end;

  //>>Количество векселей  сделки (цифрами)
  [~TotalNumber];
  println(veksCount);

  //>>Количество векселей  сделки (прописью)
  [~TotalNumberText];  /*       1,      2, 3, 4,  5...  род-муж., точность*/                 
  txtVeks = NumToStr(veksCount, "вексель", "векселя", "векселей", true,     0);
  println(StrUpr(txtVeks, 1)); 

  //>>Сумма номиналов векселей, в рублях, с точностью до копеек, цифрами
  [~TotalAmount];
  println(totalSumNominal:a);

  //>>Сумма номиналов векселей, в рублях, с точностью до копеек, прописью
  [~TotalAamontRubText ];
  println(RubToStrAlt(totalSumNominal, NULL, NULL, NULL));

  //>>Общая сумма сделки в рублях, с точностью до копеек, цифрами
  [~TotalPrice];
  println(totalSum:a);

  //>>Общая сумма сделки в рублях, с точностью до копеек, прописью
  [~TotalPriceRubText];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  //>>Дата оплаты сделки
  [~ContractPayDate];  
  GetOprDate( DATE_BUY_PAY, payDate );
  println(string(date(payDate):f));

  //>>Общая сумма сделки в рублях, с точностью до копеек, цифрами
  [~TotalPrice_dup2];
  println(totalSum:a);

  //>>Общая сумма сделки в рублях, с точностью до копеек, прописью
  [~TotalPriceRubText_dup2 ];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  //>>Плановая дата поставки
  [~ContractDeliveryDate]; 
  GetOprDate( DATE_BUY_SUPPLY, supplyDate );
  println(string(date(supplyDate):f));

  query =    "select sett.t_Account AS Account, sett.t_BankName AS BankName"
          + " from dsettacc_dbt sett"
          + " where sett.t_PartyID = " + {ourbank}
          +   " AND 1 <= (select count(*)"
          +             " from  dpmautoac_dbt pma"
          +             " where  pma.t_PartyID = " + {ourbank}
          +               " AND  pma.t_SettAccID = sett.t_SettAccID"
          +               " AND  pma.t_ServiceKind = " + string(17) + ")"; //17-ДУ


  Spi = TRsbDataSet(query);
  stat = Spi.MoveNext();

  //>>р/счет из СПИ нашего банка 
  [~OurSPIAcc ]; 
  println(TS_IIF(stat, Spi.Account, ""));

  //>>банк из СПИ нашего банка 
  [~OurSPIBank]; 
  println(TS_IIF(stat, Spi.BankName, ""));

  //>>БИК нашего банка
  [~OurBIC];
  println(ПолучитьКодСубъекта({ourbank}, PTCK_BIC));

  //>>ИНН нашего банка
  [~OurINN];
  println(ПолучитьКодСубъекта({ourbank}, PTCK_INN));


  //>>Адрес контрагента
  [~IssuerAddr];
  if(НайтиЮридическийАдресСубъекта(Dl_Tick.PartyID, address))
    contrAgentAdrs = Dl_JoinAddress(address.PostIndex,address.Adress);
  else
    contrAgentAdrs = "";
  end;
  println(contrAgentAdrs);

  query =    "select sett.t_Account AS Account, sett.t_BankName AS BankName, sett.t_BankID as BankID"
          + " from dsettacc_dbt sett"
          + " where sett.t_PartyID = " + Dl_Tick.PartyID
          +   " AND 1 <= (select count(*)"
          +             " from  dpmautoac_dbt pma"
          +             " where  pma.t_PartyID = " + Dl_Tick.PartyID
          +               " AND  pma.t_SettAccID = sett.t_SettAccID"
          +               " AND  pma.t_ServiceKind = " + string(17) + ")"; //17-ДУ


  Spi = TRsbDataSet(query);
  stat = Spi.MoveNext();

  //>>р/счет из СПИ контрагента 
  [~IssuerSPIAcc];
  println(TS_IIF(stat, Spi.Account, ""));

  //>>банк из СПИ контрагента 
  [~IssuerSPIBank];
  println(TS_IIF(stat, Spi.BankName, ""));

  //>>БИК контрагента
  [~IssuerBIС];    
  println(ПолучитьКодСубъекта(Spi.BankID, PTCK_BIC));

  //>>ИНН контрагента
  [~IssuerINN];
  println(ПолучитьКодСубъекта(Dl_Tick.PartyID, PTCK_INN));

  //>>Роль нашего банка в сделке (в родит. падеже) 
  [~OurBankParty_rp];
  if(ContrTypeBuy) 
    println("покупателя"); //Покупка
  else                                 
    println("продавца");  //Продажа
  end;

  //>>Роль контрагента в сделке (в родит. падеже)
  [~IssuerParty_rp];  /*--закладка идет не по порядку--*/
  if(ContrTypeBuy) 
    println("продавца"); //Покупка
  else                                 
    println("покупателя"); //Продажа
  end;


  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

/****************************************************************************/
/* Соглашение о досрочном выкупе                                            */
/****************************************************************************/

MACRO ДУУВ_СформироватьСоглашениеДосрочВыкуп(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_ADVREPAY.dot";
  var TempFile;
  record party("party");
  record address ( adress );
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var tbfParty = TBfile("party.dbt");
  var tbfPtOfc = TBfile("ptoffice.dbt");
  var ourBankShortName = "";
  var ourBankFullName = "";
  var issuerCity = "";
  var issuerAddress = "";
  var bankAddress = "";
  var issuerShortName = "";
  var issuerFullName = "";
  var DepartDU = 0;
  var DepartDURp = "";
  var veksCount = 0;
  var totalSum = 0; 
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var fd = null;
  var payDate:variant;
  var err;
  var Bnr= null, Leg = null;
  var Contr = null;
  var ContrDU = null;
  var Ofc = null;
  var ourOfc = null;
  var Spi = null;
  var advRepay = null;

  //Если нет, "Соглашения о досрочном выкупе", то выходим
  query =   "select gr.t_XLD AS ContractN"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(335) /*DOCKIND_TRUST_AGREEADVREPAY - СОГЛАШЕНИЕ О ДОСРОЧНОМ ВЫКУПЕ*/
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591); /*LLCLASS_KINDDOC_TSBSORDER*/

  advRepay = TRsbDataSet(query);
  stat = advRepay.MoveNext();

  if(not stat)
    RETURN; 
  end;

  println(Шаблон);
  println("ADVREPAY_"+GenFileName());

  //>>Номер документа "Соглашение о досрочном выкупе" внутренний
  query =   "select gr.t_XLD AS ContractN, gr.t_RegistrDate AS RegistrDate"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(335) /*DOCKIND_TRUST_AGREEADVREPAY - Соглашение о досрочном выкупе*/
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591); /*LLCLASS_KINDDOC_TSBSORDER*/

  Contr = TRsbDataSet(query);
  stat = Contr.MoveNext();
  
  [~N];
  println(TS_IIF(stat, Contr.ContractN, "" ));

  [~N_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, Contr.ContractN, "" ));

  //>>Дата документа "Соглашение о досрочном выкупе" из документов операции
  [~OperDate]; /*--закладка идет не по порядку--*/ 
  println(TS_IIF(stat, string(date(Contr.RegistrDate):f), "" ));

  [~OperDate_dup3]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, string(date(Contr.RegistrDate):f), "" ));

  [~OperDate_dup4]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, string(date(Contr.RegistrDate):f), "" ));

  //>>Сокр. наименование векселедателя
  if( not ПолучитьСубъекта(Dl_Tick.PartyID, party) )
    issuerShortName = party.ShortName;
    issuerFullName = party.Name;
  else
    issuerShortName = "";
    issuerFullName = "";
  end;  
  [~IssuerShort];
  println(issuerShortName);

  [~IssuerShort_dup2]; /*--закладка идет не по порядку--*/
  println(issuerShortName);

  [~IssuerShort_dup3]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(issuerShortName);

  [~IssuerShort_dup4]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(issuerShortName);


  //>>Полное наименование векселедателя
  [~IssuerFull]; /*--закладка идет не по порядку--*/
  println(issuerFullName);

  [~IssuerFull_dup2]; /*--закладка идет не по порядку--*/
  println(issuerFullName);

  [~IssuerFull_dup3]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(issuerFullName);

  //>>Город из адреса векселедателя
  if(НайтиЮридическийАдресСубъекта(party.PartyID, address))
    issuerCity = adress.District;
    issuerAddress = adress.Adress; 
  else
    issuerCity = "";
    issuerAddress = "";
  end;
  [~City];
  println(issuerCity);

  [~City_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(issuerCity);

  //>>Адрес векселедателя
  [~IssuerAddr]; /*--закладка идет не по порядку--*/
  println(issuerAddress);


  //>>Должность и ФИО (в родительном падеже) представителя векселедателя  
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS IsuuerRepresFio, ofc.t_Post AS IssuerRepresPost"
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + DL_Tick.PartyID
         +  "   AND ofc.t_IsFirstPerson = 'X'";   

  Ofc = TRsbDataSet(query);
  stat = Ofc.MoveNext();

  
  [~IsuuerRepres]; /*--закладка идет не по порядку--ФИО представителя векселедателя (сотрудника векселедателя с признаком первого лица)*/
  println(TS_IIF(stat, Ofc.IsuuerRepresFio, ""));

  [~IsuuerRepres_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, Ofc.IsuuerRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = Ofc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;
                                                               
  [~IssuerRepresPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" ) );/*50 - Должность в родит. падеже*/

  [~IssuerRepresPos_rp_dup2];/*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" ) );/*50 - Должность в родит. падеже*/

  [~IssuerRepr_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже - ФИО*/

  [~IssuerRepr_rp_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже - ФИО*/


  //>>№ и Дата открытия договора ДУ, для которого выполняется погашения
  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder); 
  query =   "select t_XLD AS ContractNDU, t_RegistrDate as ContractDateDU" 
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt}; 
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~ContractNmbDU];
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));

  [~ContractNmbDU_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));

  [~ContractDateDU];
  println(TS_IIF(stat, string(date(ContrDU.ContractDateDU):f), "" ));

  [~ContractDateDU_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, string(date(ContrDU.ContractDateDU):f), "" ));


  //>>Должность (в родительном падеже) представителя НАШЕГО БАНКА 
  GetRegistryValue( "ДОВЕРИТЕЛЬНОЕ УПРАВЛЕНИЕ\\ОТДЕЛ ДОВЕРИТЕЛЬНОГО УПРАВЛЕНИЯ", V_INTEGER, DepartDU, err );
  query =    "select party.t_PartyID AS OfficerPartyID, party.t_Name AS OurRepresFio, ofc.t_Post AS OurRepresPost "
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + {ourbank}
         +  "   AND ofc.t_IsFirstOfficePerson = 'X'"
         +  "   AND ofc.t_OfficeID = " + DepartDU; //Отдел ДУ   

  ourOfc = TRsbDataSet(query);
  stat = ourOfc.MoveNext();

  [~OurRepres]; /*--закладка идет не по порядку--ФИО начальника подразделения "Отдел ДУ"*/
  println(TS_IIF(stat, ourOfc.OurRepresFio, ""));

  [~OurRepres_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, ourOfc.OurRepresFio, ""));

  if(stat)
    tbfParty.rec.PartyID = ourOfc.OfficerPartyID;
    stat = tbfParty.GetEQ();
  end;

  [~OurRepresPos_rp];
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" )); /*50 - Должность в родит. падеже*/

  [~OurRepresPos_rp_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 50), "" )); /*50 - Должность в родит. падеже*/

  //>>ФИО начальника отдела ДУ НАШЕГО БАНКА в родит. падеже  
  [~OurRepres_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" )); /*49 - Полное наименование в родит. падеже - ФИО*/

  [~OurRepres_rp_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" )); /*49 - Полное наименование в родит. падеже - ФИО*/
  
  //>>Данные (в родит. падеже) о документе, на основании которого действует представитель НАШЕГО БАНКА 
  [~OurRepresDoc_rp]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 51), "" )); /*51 - Документ-основание представителя по договору в родит. падеже - ФИО*/

  [~OurRepresDoc_rp_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 51), "" )); /*51 - Документ-основание представителя по договору в родит. падеже - ФИО*/

  //>>Наименование подразделения, указанного в качестве "Отдела ДУ"
  tbfPtOfc.rec.PartyID = {ourbank};
  tbfPtOfc.rec.OfficeID = DepartDU;
  stat = tbfPtOfc.GetEQ();
  if(stat)
    DepartDURp = readNoteForObject(/*OBJTYPE_SUBDIVISION*/10, UniID(tbfPtOfc, /*OBJTYPE_SUBDIVISION*/10), 1); /*1 - Наименование в родит. падеже*/
    if(DepartDURp == "")
      DepartDURp = "Управления доверительных операций";   
    end;
  else
    DepartDURp = "Управления доверительных операций";
  end;

  [~DU_department_rp];
  println(DepartDURp);

  [~DU_department_rp_dup2];  /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(DepartDURp);

  //>>Полное наименование НАШЕГО БАНКА в родительном падеже 
  [~OurBankFull_rp];
  tbfParty.rec.PartyID = {ourbank};
  stat = tbfParty.GetEQ();
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже*/

  [~OurBankFull_rp_dup2]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(TS_IIF(stat, readNoteForObject(OBJTYPE_PARTY, UniID(tbfParty, OBJTYPE_PARTY), 49), "" ) );/*49 - Полное наименование в родит. падеже*/

  //>>Тело отчета (по одной строке для каждого векселя операции)
  query =   "select ban.t_BCID AS BCID, ban.t_Issuer AS Issuer, party.t_ShortName AS IssShortName , ban.t_BcSeries AS BcSeries," 
         +        " ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost," 
         +        " leg.t_Principal AS Principal, leg.t_Start AS IssueDate, leg.t_Price AS Rate"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg, dparty_dbt party"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND "
         +   "(lnk.t_LinkKind = " + VSORDLNK_K_SALE         //Продажа     == Эмиссия (h\dlbfe.h)
         +          " OR "
         +    "lnk.t_LinkKind = " + VSORDLNK_K_DRAW + ")"   //Погашение   == Покупка (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER     //Ценовые условия векселя 
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         +   " AND ban.t_Issuer = party.t_PartyID"
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              //идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            //Номер размножаемого ряда
  println(2);

  stat = veksel.MoveFirst();
  while(stat)
    N = N + 1;
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);

    println("~N" + N);
    println(N);

    println("~IssuerShort" + N );
    println(Trim(veksel.IssShortName));

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~IssueDate" + N);
    println(string(date(veksel.IssueDate):f));

    println("~FaceValue" + N);
    println(veksel.Principal:a);

    println("~PayDate" + N);
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));

    println("~Price" + N);
    println(veksel.BcCost:a);

    totalSum = totalSum + veksel.BcCost;
    
    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    println("~N1");
    println(N);
    
    println("~IssuerShort1");
    println("");

    println("~ser1");
    println("-");

    println("~nbr1");
    println("");

    println("~IssueDate1");
    println("");

    println("~FaceValue1");
    println("");

    println("~PayDate1");
    println("");

    println("~Price1");
    println("");
  end;

  //>>Общая сумма сделки в рублях, с точностью до копеек, цифрами
  [~TotalPrice];
  println(totalSum:a);

  //>>Общая сумма сделки в рублях, с точностью до копеек, прописью
  [~TotalPriceRub_txt];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));
  
  //>>Общая сумма сделки в рублях, с точностью до копеек, цифрами
  [~TotalPrice_dup2];
  println(totalSum:a);

  //>>Общая сумма сделки в рублях, с точностью до копеек, прописью
  [~TotalPriceRub_txt_dup2];
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  //>>Дата операции
  [~OperDate_dup2]; /*--закладка идет не по порядку--*/ 
  println(string(date(Dl_Tick.DealDate):f)); 

  query =    "select sett.t_Account AS Account, sett.t_BankName AS BankName"
          + " from dsettacc_dbt sett"
          + " where sett.t_PartyID = " + {ourbank}
          +   " AND 1 <= (select count(*)"
          +             " from  dpmautoac_dbt pma"
          +             " where  pma.t_PartyID = " + {ourbank}
          +               " AND  pma.t_SettAccID = sett.t_SettAccID"
          +               " AND  pma.t_ServiceKind = " + string(17) + ")"; //17-ДУ


  Spi = TRsbDataSet(query);
  stat = Spi.MoveNext();

  //>>р/счет из СПИ нашего банка 
  [~OurSPIAcc]; 
  println(TS_IIF(stat, Spi.Account, ""));

  [~OurSPIAcc_dup2]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, Spi.Account, ""));

  //>>банк из СПИ нашего банка 
  [~OurSpiBnk]; 
  println(TS_IIF(stat, Spi.BankName, ""));

  //>>Банк получателя платежа
  [~OurSPIBank_dup2]; /*--закладка идет не по порядку--*/
  println(TS_IIF(stat, Spi.BankName, ""));

  //>>БИК нашего банка
  [~OurBIC];
  println(ПолучитьКодСубъекта({ourbank}, PTCK_BIC));

  [~OurBIC_dup2]; /*--закладка идет не по порядку--*/
  println(ПолучитьКодСубъекта({ourbank}, PTCK_BIC));

  //>>ИНН нашего банка
  [~OurInnCPP]; 
  println(ПолучитьКодСубъекта({ourbank}, PTCK_INN));

  [~OurINN_dup2];  /*--закладка идет не по порядку--*/
  println(ПолучитьКодСубъекта({ourbank}, PTCK_INN));

  query =    "select sett.t_Account AS Account, sett.t_BankName AS BankName"
          + " from dsettacc_dbt sett"
          + " where sett.t_PartyID = " + Dl_Tick.PartyID
          +   " AND 1 <= (select count(*)"
          +             " from  dpmautoac_dbt pma"
          +             " where  pma.t_PartyID = " + Dl_Tick.PartyID
          +               " AND  pma.t_SettAccID = sett.t_SettAccID"
          +               " AND  pma.t_ServiceKind = " + string(17) + ")"; //17-ДУ


  Spi = TRsbDataSet(query);
  stat = Spi.MoveNext();

  //>>р/счет из СПИ векселедателя 
  [~IssuerSPIAcc];
  println(TS_IIF(stat, Spi.Account, ""));

  //>>банк из СПИ векселедателя 
  [~IssuerSPIBank];
  println(TS_IIF(stat, Spi.BankName, ""));

  //>>БИК векселедателя
  [~IssuerBIС];  
  println(ПолучитьКодСубъекта(Dl_Tick.PartyID, PTCK_BIC));

  //>>ИНН векселедателя
  [~IssuerINN];
  println(ПолучитьКодСубъекта(Dl_Tick.PartyID, PTCK_INN));

  //>>Сокращенное наименование НАШЕГО БАНКА
  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankShortName = party.ShortName;
    ourBankFullName = party.Name;
  else
    ourBankShortName = "";
    ourBankFullName = "";
  end;  
  [~OurBankShort];
  println(ourBankShortName);

  [~OurBankShort_dup2];  /*--закладка идет не по порядку--*/
  println(ourBankShortName);

  [~OurBankShort_dup3]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(ourBankShortName);

  [~OurBankShort_dup4]; /*--закладка идет не по порядку--Акт Приемки-Передачи--*/
  println(ourBankShortName);

  //>>Полное наименование нашего банка
  [~OurBankFull]; /*--закладка идет не по порядку--*/
  println(ourBankFullName);

  //>>Адрес НАШЕГО БАНКА
  if(НайтиЮридическийАдресСубъекта({ourbank}, address))
    bankAddress = adress.Adress;
  else
    bankAddress = "";
  end;
  [~OurAddr];
  println(bankAddress);

  /*----------------------------Акт приемки-передачи---------------------------------------------------------*/
  [~MultipleRow];
  println(2);              //идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            //Номер размножаемого ряда
  println(2);

  N = 0;
  stat = veksel.MoveFirst();
  while(stat)
    N = N + 1;
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);

    println("~N2_dup" + N); 
    println(N);

    println("~IssuerShort2_dup" + N );
    println(Trim(veksel.IssShortName));

    println("~Ser2_dup" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~Nbr2_dup" + N);
    println(Trim(veksel.BcNumber));

    println("~IssueDate2_dup" + N);  
    println(string(date(veksel.IssueDate):f));

    println("~FaceValue2_dup" + N); 
    println(veksel.Principal:a);

    println("~PayDate2_dup" + N); 
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));

    println("~Price2_dup" + N); 
    println(veksel.BcCost:a);

    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    println("~N2_dup1");
    println(N);
    
    println("~IssuerShort2_dup1");
    println("");

    println("~Ser2_dup1");
    println("-");

    println("~Nbr2_dup1");
    println("");

    println("~IssueDate2_dup1");
    println("");

    println("~FaceValue2_dup1");
    println("");

    println("~PayDate2_dup1");
    println("");

    println("~Price2_dup1");
    println("");
  end;

  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;

PRIVATE macro DateToStr( pDate )

  var d, m, y, Day, Month, Year;

  DateSplit( pDate, d, m, y );
  Day = String( d );

  if   (m ==  1) Month = " января ";
  elif (m ==  2) Month = " февраля ";
  elif (m ==  3) Month = " марта ";
  elif (m ==  4) Month = " апреля ";
  elif (m ==  5) Month = " мая ";
  elif (m ==  6) Month = " июня ";
  elif (m ==  7) Month = " июля ";
  elif (m ==  8) Month = " августа ";
  elif (m ==  9) Month = " сентября ";
  elif (m == 10) Month = " октября ";
  elif (m == 11) Month = " ноября ";
  elif (m == 12) Month = " декабря ";
  else           Month = "  ";
  end;

  Year = String(y);

  return Day + Month + Year + " г.";

end;

MACRO ДУУВ_СформироватьЗаявленПогаш(ДатаШага, Dl_tick, ID_Operation, ID_Step)
  var Шаблон = "TRVA_DECLREPAY.dot";
  var TempFile;
  record party("party");
  record address ( adress );
  var TSOrder = TRecHandler( "tsorder.dbt" );
  var tbfPtOfc = TBfile("ptoffice.dbt");
  var ourBankShortName = "";
  var bankAddress = "";
  var issuerShortName = "";
  var DepartDU = 0;
  var DepartDURp = "";
  var veksCount = 0;
  var totalSum = 0; 
  var totalSumNominal = 0;
  var txtVeks = "";
  var rate = 0.0;
  var N = 0;
  var stat = false;
  var query = "";
  var veksel = null;
  var fd = null;
  var payDate:variant;
  var err = "";
  var Bnr= null, Leg=null;
  var ContrDU = null;
  var ourOfc = null;
  var Spi = null;
  var advRepay = null;

  //Нет ли "Соглашения о досрочном выкупе"?
  query =   "select gr.t_XLD AS ContractN"
         + " from dspgrdoc_dbt gdoc, dspground_dbt gr"
         + " where gdoc.t_SourceDocKind = " + Dl_Tick.BOfficeKind
         +   " AND gdoc.t_SourceDocID = "   + Dl_Tick.DealID 
         +   " AND gdoc.t_SPGroundID = gr.t_SPGroundID"
         +   " AND gr.t_Kind = " + string(335) /*DOCKIND_TRUST_AGREEADVREPAY - СОГЛАШЕНИЕ О ДОСРОЧНОМ ВЫКУПЕ*/
         +   " AND gr.t_SourceDocKind = " + string(0)
         +   " AND gr.t_SourceDocID = " + string(0)
         +   " AND gr.t_DocLog = " + string(591); /*LLCLASS_KINDDOC_TSBSORDER*/

  advRepay = TRsbDataSet(query);
  stat = advRepay.MoveNext();

  //Если есть "Соглашение о досрочном выкупе", то "Заявление на погашение" не формируется
  if(stat)
    RETURN; 
  end;

  println(Шаблон);
  println("DECLREPAY_"+GenFileName());

  //>>Сокращенное наименование НАШЕГО БАНКА
  if( not ПолучитьСубъекта({ourbank}, party) )
    ourBankShortName = party.ShortName;
  else
    ourBankShortName = "";
  end;  
  [~our_bank];
  println(ourBankShortName);

  [~our_bank_dup2]; /*--закладка идет не по порядку--*/
  println(ourBankShortName);

  //>>№ и Дата открытия договора ДУ, для которого выполняется погашения
  CB_GetTSContrBySfContr( Dl_Tick.ClientContrID, TSOrder); 
  query =   "select t_XLD AS ContractNDU, t_RegistrDate as ContractDateDU" 
          + " from dspground_dbt"
          + " where t_SourceDocID = " + TSOrder.rec.ID
          +   " AND t_SourceDocKind = " + TSOrder.rec.DocKind
          +   " AND t_Direction = " + string(2)
          +   " AND t_Department = " + {OperDprt}; 
  
  ContrDU = TRsbDataSet(query);
  stat = ContrDU.MoveNext();
    
  [~contract_N_DU];
  println(TS_IIF(stat, ContrDU.ContractNDU, "" ));

  [~contract_date_DU];
  println(TS_IIF(stat, string(date(ContrDU.ContractDateDU):f), "" ));

  //>>Юридический адрес нашего банка
  if(НайтиЮридическийАдресСубъекта({ourbank}, address))
    bankAddress = adress.Adress;
  else
    bankAddress = "";
  end;
  [~our_addr];
  println(bankAddress);

  //>>Сокращенное наименование векселедателя
  if( not ПолучитьСубъекта(Dl_Tick.PartyID, party) )
    issuerShortName = party.ShortName;
  else
    issuerShortName = "";
  end;  
  [~issuer_name];
  println(issuerShortName);

  [~issuer_name_dup2]; /*--закладка идет не по порядку--*/
  println(issuerShortName);

  //>>Тело отчета (по одной строке для каждого векселя операции)
  query =   "select ban.t_BCID AS BCID, ban.t_Issuer AS Issuer, party.t_ShortName AS IssShortName , ban.t_BcSeries AS BcSeries," 
         +        " ban.t_BcNumber AS BcNumber, lnk.t_BcCost AS BcCost," 
         +        " leg.t_Principal AS Principal, leg.t_Start AS IssueDate, leg.t_Price AS Rate"
         + " from dvsordlnk_dbt lnk,  dvsbanner_dbt ban, ddl_leg_dbt leg, dparty_dbt party"
         + " where lnk.t_BcID = ban.t_BcID "
         +   " AND lnk.t_ContractID = " + DL_Tick.DealID     //Идентификатор сделки 
         +   " AND lnk.t_DocKind = " + DL_Tick.BOfficeKind   //Вид сделки 
         +   " AND "
         +   "(lnk.t_LinkKind = " + VSORDLNK_K_SALE         //Продажа     == Эмиссия (h\dlbfe.h)
         +          " OR "
         +    "lnk.t_LinkKind = " + VSORDLNK_K_DRAW + ")"   //Погашение   == Покупка (h\dlbfe.h)
         +   " AND leg.t_LegKind = " + LEG_KIND_VSBANNER     //Ценовые условия векселя 
         +   " AND leg.t_DealID =  ban.t_BcID"
         +   " AND leg.t_LegID = " + string(0)
         +   " AND ban.t_Issuer = party.t_PartyID"
         + " Order By BcSeries, BcNumber";

  veksel = TRsbDataSet(query,  RSDVAL_CLIENT, RSDVAL_STATIC );
  veksel.MoveLast();
  veksCount = veksel.GetRecCount();

  [~MultipleRow];
  println(1);              //идентификатор таблицы
  println(veksCount - 1);  //Необходимое количество строк
  println("#");            //Номер размножаемого ряда
  println(2);

  stat = veksel.MoveFirst();
  while(stat)
    N = N + 1;
    fd = TS_VABnrFD(DL_VSBANNER, veksel.BCID, NULL, NULL);

    println("~N" + N);
    println(N);

    println("~ser" + N);
    if(Trim(veksel.BcSeries) != "")
      println(Trim(veksel.BcSeries));
    else
      println("-");
    end;

    println("~nbr" + N);
    println(Trim(veksel.BcNumber));

    println("~issue_date" + N);
    println(string(date(veksel.IssueDate):f));

    println("~face_value" + N);
    println(veksel.Principal:a);

    println("~rate" + N);
    if(veksel.Rate != 0.0)   
      rate = veksel.Rate / 10000;
    else
      rate = "-";
    end;
    println(rate:0:4);

    println("~pay_date" + N);
    Bnr = fd.GetBnr();
    Leg = fd.GetLeg();
    println(ПолучитьСрокПлатежаПоВекселюДляПечати(Bnr, Leg));

    println("~price" + N); 
    println(veksel.BcCost:a);  

    totalSumNominal = totalSumNominal + veksel.Principal;
    totalSum = totalSum + veksel.BcCost;
    
    stat = veksel.MoveNext();
  end;

  //если выборка в veksel пуста
  if(N == 0)
    println("~N1");
    println(N);
    
    println("~ser1");
    println("-");

    println("~nbr1");
    println("");

    println("~issue_date1");
    println("");

    println("~face_value1");
    println("");

    println("~pay_date1");
    println("");

    println("~rate1");
    println("-");

    println("~price1");
    println("");
  end;
  
  //>>Количество векселей операции погашения (цифрами)
  [~total_number];
  println(veksCount);
  
  //>>Количество векселей операции погашения (прописью)
  [~totalNumTxt];  /*       1,      2, 3, 4,  5...  род-муж., точность*/                 
  txtVeks = NumToStr(veksCount, "вексель", "векселя", "векселей", true,     0);
  println(StrUpr(txtVeks, 1)); 
                     
  //>>Сумма номиналов векселей, в рублях, с точностью до копеек, цифрами
  [~total_amount];
  println(totalSumNominal:a);

  //>>Количество целых рублей из суммы номиналов векселей, прописью
  [~total_amont_rub_text];
  println(RubToStrAlt(totalSumNominal, NULL, NULL, NULL));
  
  //>>Общая сумма операции погашения, цифрами, в рублях, с точностью до копеек
  [~total_price]; /*--закладка идет не по порядку--*/
  println(totalSum:a);

  //>>Количество целых рублей из общей суммы операции погашения, прописью
  [~total_price_rub_text]; /*--закладка идет не по порядку--*/
  println(RubToStrAlt(totalSum, NULL, NULL, NULL));

  //>>ИНН нашего банка
  [~our_inn]; 
  println(ПолучитьКодСубъекта({ourbank}, PTCK_INN));

  //>>БИК нашего банка
  [~our_bic];
  println(ПолучитьКодСубъекта({ourbank}, PTCK_BIC));

  query =    "select sett.t_Account AS Account, sett.t_BankName AS BankName"
          + " from dsettacc_dbt sett"
          + " where sett.t_PartyID = " + {ourbank}
          +   " AND 1 <= (select count(*)"
          +             " from  dpmautoac_dbt pma"
          +             " where  pma.t_PartyID = " + {ourbank}
          +               " AND  pma.t_SettAccID = sett.t_SettAccID"
          +               " AND  pma.t_ServiceKind = " + string(17) + ")"; //17-ДУ


  Spi = TRsbDataSet(query);
  stat = Spi.MoveNext();

  //>>р/счет из СПИ нашего банка 
  [~our_SPI_acc]; 
  println(TS_IIF(stat, Spi.Account, ""));

  //>>банк из СПИ нашего банка 
  [~our_SPI_bank]; 
  println(TS_IIF(stat, Spi.BankName, ""));

  //>>Наименование подразделения, указанного в качестве "Отдела ДУ", в родительном падеже
  GetRegistryValue( "ДОВЕРИТЕЛЬНОЕ УПРАВЛЕНИЕ\\ОТДЕЛ ДОВЕРИТЕЛЬНОГО УПРАВЛЕНИЯ", V_INTEGER, DepartDU, err );
  tbfPtOfc.rec.PartyID = {ourbank};
  tbfPtOfc.rec.OfficeID = DepartDU;
  stat = tbfPtOfc.GetEQ();
  if(stat)
    DepartDURp = readNoteForObject(/*OBJTYPE_SUBDIVISION*/10, UniID(tbfPtOfc, /*OBJTYPE_SUBDIVISION*/10), 1); /*1 - Наименование в родит. падеже*/
    if(DepartDURp == "")
      DepartDURp = "Управления доверительных операций";   
    end;
  else
    DepartDURp = "Управления доверительных операций";
  end;

  [~DU_department_rp];
  println(DepartDURp);

  //>>ФИО начальника подразделения, заданного в настройке "Отдел доверительного управления"
  query =    "select party.t_Name AS OurRepresFio"
         +  " from dofficer_dbt ofc, dparty_dbt party"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + {ourbank}
         +  "   AND ofc.t_IsFirstOfficePerson = 'X'"
         +  "   AND ofc.t_OfficeID = " + DepartDU; //Отдел ДУ   

  ourOfc = TRsbDataSet(query);
  stat = ourOfc.MoveNext();

  [~OurRepresShortName]; 
  println(TS_IIF(stat, ourOfc.OurRepresFio, ""));

  //>>ФИО  сотрудника нашего банка с должностью "Главный бухгалтер"
   query =    "select party.t_Name AS OurChiefAccFio"
         +  " from dofficer_dbt ofc, dparty_dbt party, dllvalues_dbt lval"
         +  " where party.t_PartyID = ofc.t_PersonID"
         +  "   AND ofc.t_PartyID = " + {ourbank}
         +    " AND lval.t_List = " + 1128         /*OBJTYPE_APPOINTMENT - Должность - невстроенные виды объектов - виды справочников, используемых в категориях учета*/
         +    " AND lval.t_Element = " + string(4) //Главный бухгалтер
         +    " AND ofc.t_Post = lval.t_Name";     

  ourOfc = TRsbDataSet(query);
  stat = ourOfc.MoveNext();

  [~OurChiefAccShortName]; 
  println(TS_IIF(stat, ourOfc.OurChiefAccFio, ""));

  //>>Дата операции погашения прописью
  [~oper_date_txt];
  println(DateToStr(Dl_Tick.DealDate)); 


  /* Завершение вывода */
  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile (TempFile);

  SetOutput(NULL, false);

  RETURN 1;    
END;
