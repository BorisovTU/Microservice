/* Операция сопровождения договора ДУ
   Шаг "Начисление ПДД". 
   Выполняется при вставке цепочки из сервисной операции начисления дохода*/
IMPORT InsCarryDoc;

PRIVATE VAR ServOp = TRecHandler( "tssrvop.dbt" ); /*Сервисная операция, из которой выполняется расчет*/

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )
  VAR OrderFD:TS_OrderFD; /*Договор ДДУ, для которого происходит расчет*/
  var sql, rsd;
  var v_BegDate, v_EndDate, Year;

  if( TS_RunFromServiceOper( ServOp ) != true )
     MsgBox( "Шаг \"Расчет НОБ\" должен выполняться только из соответствующей сервисной операции." );
     return 1;
  end;                                                         

  OrderFD = TS_OrderFD( 0, FDoc );

  //Определим границы расчетного периода: 
  v_BegDate = OrderFD.Order.rec.NPT_TAXCALCDATE;
  if( v_BegDate == DATE(0,0,0) )
     DateSplit( ServOp.rec.StepDate, NULL, NULL, Year );
     v_BegDate = DATE(31,12,Year-1);
  end;
  v_BegDate = v_BegDate + 1;
  v_EndDate = ServOp.rec.StepDate;

//!!! докрутить проверку!!!   Если шаг вставляется из операции "Операция расчета НОБ для НДФЛ"
  if( TS_RunFromServiceOper( ServOp ) == true )
     if (v_EndDate < v_BegDate)
        MsgBox( "Неверные даты операции расчета НОБ" );
        return 1;
     end;
  else
     if (v_EndDate < v_BegDate)
        MsgBox( "Неверные даты операции расчета НОБ" );
        return 1;
     end;
  end;

  // Проверим, что начало расчета не попадает в закрытый период
  if (v_BegDate < (OrderFD.Order.rec.NPT_CLOSETAXPERIOD + 1))
     MsgBox( "Попытка пересчитать НОБ в закрытом налоговом периоде" );
     return 1;
  end;

  // Проверим, что на дату конца периода расчета НОБ выполнен расчет связй
  if (v_EndDate < OrderFD.Order.rec.NPT_LINKCALCDATE)
     MsgBox( "Не выполнен расчет связей за период" );
     return 1;
  end;

  if( NPTCalcNOB( OrderFD.Order.rec.ID, ID_Operation, ID_Step,
                  v_BegDate, v_EndDate
                ) != 0
    )
     MsgBox( "Ошибка при расчете НОБ" );
     return 1;
  end;

  if( NPTUpdateTaxCalcDate( OrderFD.Order.rec.ID, ServOp.rec.StepDate, v_BegDate ) != 0 )
     MsgBox( "Ошибка при изменении даты начала пересчета НОБ в договоре" );
     return 1;
  end;

  return 0;
END;