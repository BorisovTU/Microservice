/* Операция списания/зачисления ц/б
   Шаг списания/зачисления*/

import InsCarryDoc, "tssec.mac";

/*группа списания для операции*/
VAR    WriteOffGroups = TArray;   /*данные в массиве используются программой при выполнении шага*/      

macro ExecuteStep( Doc, ticket, DocKind, OperationID )

  record deal(dl_tick);
  record pm_avr(pmpaym);
  var    FD, dat, BalCost = $0, BuySale, Ground, Payment, NeedExecutePayment,
         DebetCatCode, CreditCatCode, Outlay, PreOutlay;

  SetBuff( deal, ticket );
  FD = SPFirstDocTrust( deal );
  GetOprDate( 0, dat );
 
  if( IsAVRWRTOUT(FD.Group) )
     if( ПолучитьГруппыСписания( FD, WriteOffGroups ) == false )
        MsgBox( deal, "Ошибка при определении групп списания" );
        return 1;
     end; 
  end;

  NeedExecutePayment = (РАБОТА_С_ДЕПОЗИТАРИЕМ() == TS_WORK_DEPO_NO);

  if( NeedExecutePayment == false ) 
     Copy( pm_avr, FD.pm_avoir ); 
     if( not InsertDepoDraft( deal, pm_avr, dat, null, null, FD ) ) /* вставляем отложенное поручение депо */
        return 1;
     end;
  end;

  СохранитьСчетаВПлатеже( FD.pm_avoir );     
  Payment = RsbPayment( FD.pm_avoir.rec.PaymentID );
  if( ИсполнитьПлатеж( Payment, NeedExecutePayment == false ) )
     return 1;
  end;

  /*обработка лота и установка статуса "Поставлен"*/
  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_DELIVERY, dat, FD ) )
     msgbox("Ошибка при обновлении лота"); 
     return 1;
  end;                   

  if( TS_ExecuteDemandSEC( OperationID, TS_DemandUserMarkSEC_ByPaym(FD.pm_avoir, IIF( IsAVRWRTIN(FD.Group), TS_DEMAND_ROLE_REQUEST, TS_DEMAND_ROLE_OBLIGATION )), dat ) == false )
     return 1;
  end;

  return 0;
end;

