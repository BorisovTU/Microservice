/*    Биржевая операция c ПИ                 */
/*    Шаг настройки операции                 */
import "tsdv.mac";

/*процедура выполнения шага настройки операции*/
MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )
   record deal(dvdeal);
   SetBuff( deal, FDoc );

   var FI = ПроизводныйИнструмент( deal.FIID ), UserMark = "", КУС = "", Role;

   if( (TS_IsBUY_DV(deal.type)) OR 
       (TS_IsEXEC_DV(deal.type) AND (deal.Position == 1)) 
     )
       UserMark = TS_UserMarkDV_prefix(TS_DEMAND_ROLE_REQUEST)+"CK";
       КУС      = "18";
       Role     = TS_DEMAND_ROLE_REQUEST;
    else
       UserMark = TS_UserMarkDV_prefix(TS_DEMAND_ROLE_OBLIGATION)+"CK";
       КУС      = "19";
       Role     = TS_DEMAND_ROLE_OBLIGATION;
    end;

    if( TS_IsEXEC_DV(deal.type) )
       КУС      = "09";
    end;

    if( TS_CreateDemandDV( NULL, ID_Operation,
                           UserMark,
                           Role,
                           "3",
                           КУС,
                           deal.Date,
                           deal.Amount,
                           deal.FIID,
                           IIF(deal.Broker != -1, deal.Broker, FI.FI.Issuer),
                           deal.ClientContr,
                           ALLFININSTR,
                           ID_Step, DL_DVDEAL, deal.ID
                         ) == false 
      )
       return 1;
    end;

   return 0;
end;
