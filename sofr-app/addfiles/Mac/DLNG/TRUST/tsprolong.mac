/* Шаг "Оформление пролонгации"*/
IMPORT TSInter, "tscalcitogs.mac", "tscateg.mac", "tstrans.mac", "tsutil.mac", "tstotal.mac";

PRIVATE MACRO ОбновитьКомиссиюЗаДосрочныйВывод(Order:TS_OrderFD, Valid, ADate:date)

  var ret = 0;
  var select, ComNumber = -1;
  private var ConCom = TRecHandler( "sfconcom.dbt" );
  private var Comiss = TRecHandler( "sfcomiss.dbt" );

  /*проверим на коммисии "за досрочный вывод" значение категории "возобновляемая"*/
  ComNumber = ПолучитьНомерКомиссии(Order.SfContr.rec.ID, "TSP", ADate);
  if(ComNumber > 0)
     if( SfGetComiss( SF_FEE_TYPE_PERIOD, ComNumber, Comiss ) == true )
     if( ДУ_ПолучитьЗначениеКатегории(Comiss, 11, OBJTYPE_SFCOMISS) == 1 ) /*11 - "возобновляемая"*/
        /*найдём комиссию "за досрочный вывод" на договоре*/
        Order.SfContr();
              while( SfGetConCom( Order.SfContr.rec.ID, SF_FEE_TYPE_PERIOD, ConCom ) == true )
                if( ConCom.rec.CommNumber == ComNumber )
             /*обновим комиссию*/
             if( TS_ConComUpdateDate( ConCom.rec.ID, Valid.rec.BeginDate, Valid.rec.EndDate, ConCom.rec.DATEBEGIN, ConCom.rec.DATEEND ) != 0 )
                MsgBox( "Ошибка при изменении дат комиссии" );
                ret = 1;
             end;
          end;
        end;
     end;
  end;
  end;

  return ret;
END;

PRIVATE MACRO ВставитьНовыеИндивидуальныеУсловия(SfContrID:integer, ADate:date)

   var RetVal = true;
   var ConCom = TRecHandler( "sfconcom.dbt" );
   var Comiss = TRecHandler( "sfcomiss.dbt" );

   RetVal = changeSfPlan(SfContrID, 0, ADate);
   while( (RetVal == true) and (SfGetConCom( SfContrID, SF_FEE_TYPE_PERIOD, ConCom ) == true) and ((ConCom.rec.DateEnd == Date(0,0,0)) or (ConCom.rec.DateEnd > ADate)) )
      if( (SfGetComiss( SF_FEE_TYPE_PERIOD, ConCom.rec.CommNumber, Comiss ) == true) and (ДУ_ПолучитьЗначениеКатегории(Comiss, 11, OBJTYPE_SFCOMISS) == 1) )
         if( addComissFromConCom(SF_FEE_TYPE_PERIOD, ConCom.rec.CommNumber, SfContrID, SfContrID) != true )
            RetVal = false;
         end;
      end;
   end;

   return RetVal;
END;

MACRO ОформитьПролонгацию( Order:TRecHandler, DlDoc, ID_Operation, ID_Step ) :INTEGER
  VAR   Itogs = TArray();

  VAR RunInAutoMode, ADate, OrderFD, rest, 
      ServOp     = TRecHandler( "tssrvop.dbt" ),
      Valid      = TRecHandler( "tsvalid.dbt" ),
      CurValid   = TRecHandler( "tsvalid.dbt" ),
      NextValid  = TRecHandler( "tsvalid.dbt" );

  if( TS_RunFromServiceOper( ServOp ) )
     RunInAutoMode = true;
     ADate         = ServOp.rec.StepDate;
  else
     RunInAutoMode = false;
     ADate         = {CurDate};
  end;

  if( Order.rec.CloseAtEndDate == "X" )
     MsgBox( "У договора установлен признак обязательного закрытия в дату окончания срока действия.|Запрещено выполнение пролонгации." );
     return 1;
  elif( (RunInAutoMode == true) AND (Order.rec.AutuProlongation != "X") )
     MsgBox( "Договор должен быть продлен или закрыт." );
     return 1;
  end;

  if( TS_GetCurrentValid( Order.rec.ID, ADate, CurValid ) == 0 )
     if( NOT ( ( (CurValid.rec.EndDate > ADate) AND 
                 (not IsWorkday(CurValid.rec.EndDate)) AND 
                 (ADate == GetDateAfterWorkDays( CurValid.rec.EndDate, -1 ))
               ) OR
               (CurValid.rec.EndDate <= ADate)
             )
       )
        MsgBox( "У договора еще не окончился текущий срок действия.|Запрещено выполнение пролонгации." );
        return 1;
     end;

     if( RunInAutoMode == true )
        Valid.rec.Period = CurValid.rec.Period;
     else
        Valid.rec.Period = 0;
     end;
     Valid.rec.PeriodKind = CurValid.rec.PeriodKind;
     Valid.rec.BeginDate  = TS_IIF( CurValid.rec.EndDate != Date(0,0,0), CurValid.rec.EndDate+1, ADate );

     if( (TS_GetCurrentValid( Order.rec.ID, Valid.rec.BeginDate, NextValid ) == 0) AND (CurValid.rec.ID != NextValid.rec.ID) )
        MsgBox( "У договора уже выполнена пролонгация.|Запрещено выполнение пролонгации." );
        return 1;
     end;

     if( TS_ChangeValid( Order, Valid, RunInAutoMode == false ) != 0 )
        return 1;
     end;

  else
     MsgBox( "Не найден период действия договора на дату " + string(ADate) + "." );
     return 1;
  end;

  OrderFD = TS_OrderFD( Order.rec.DocKind, Order.rec.ID );

  Adate = min(CurValid.rec.EndDate,{curdate});
  var CalcCom = DataCalcCom();
  if( not TS_CalculateItogsProlongation( Itogs, Order, Adate, ID_Operation, ID_Step, CalcCom ) )
     return 1;
  end;

  CalcCom.sfdefcom_parm_M.rec.CommSum = Itogs[ДУ_Купр_ф];
  if( СохранитьПериодическуюКомиссию( OrderFD, CalcCom.CalcDateM, CalcCom.ConCom_M, CalcCom.sfdefcom_parm_M ) != 0 )
     return 1;
  end;
  CalcCom.sfdefcom_parm_S.rec.CommSum = Itogs[ДУ_Кусп_ф];
  if( СохранитьПериодическуюКомиссию( OrderFD, CalcCom.CalcDateS, CalcCom.ConCom_S, CalcCom.sfdefcom_parm_S ) != 0 )
     return 1;
  end;

  if( Itogs[ДУ_Купр_ф] > 0 )
     if( TS_CreateDemandTrust( NULL, ID_Operation,
                          TS_UserMark_prefix(TS_DEMAND_ROLE_OBLIGATION) + "Купр_" + CurValid.rec.ID,
                          TS_DEMAND_ROLE_OBLIGATION,
                          "1",
                          "61",
                          ADate,
                          Abs(Itogs[ДУ_Купр_ф]), 
                          NATCUR,
                          РКЦ(),
                          OrderFD.ID,
                          -1,
                          NULL, NULL,
                          ID_Step, TS_DOC_PROLONG_ORDER, 0
                        ) == false 
       )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору(
              OrderFD, 
              NULL,
              NULL,
              "Расходы ДУ", "-Расчеты, ДУ",
              ADate,
              2, 
              NATCUR,
              Abs(Itogs[ДУ_Купр_ф]),
              DlDoc,
              OrderFD.Number,
              "Начисление комиссий за управление",
              FIROLE_COM_MANAG, FIROLE_COM_MANAG
              )
       )
         return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Купр, Itogs[ДУ_Купр_ф], NATCUR, ADate, "97", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Купр\"" );
        return 1;
     end;
  end;

  if( Itogs[ДУ_Кусп_ф] > 0 )
     if( TS_CreateDemandTrust( NULL, ID_Operation,
                          TS_UserMark_prefix(TS_DEMAND_ROLE_OBLIGATION) + "Кусп_" + CurValid.rec.ID,
                          TS_DEMAND_ROLE_OBLIGATION,
                          "1",
                          "62",
                          ADate,
                          Abs(Itogs[ДУ_Кусп_ф]), 
                          NATCUR,
                          РКЦ(),
                          OrderFD.ID,
                          -1,
                          NULL, NULL,
                          ID_Step, TS_DOC_PROLONG_ORDER, 0
                        ) == false 
       )
        return 1;
     end;


     if( not ПроводкаПоКатегориямУчетаПоДоговору(
              OrderFD, 
              NULL,
              NULL,
              "Расходы ДУ", "-Расчеты, ДУ",
              ADate,
              2, 
              NATCUR,
              Abs(Itogs[ДУ_Кусп_ф]),
              DlDoc,
              OrderFD.Number,
              "Начисление комиссий за успешное управление",
              FIROLE_COM_SUCCESS, FIROLE_COM_SUCCESS
              )
       )
         return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Кусп, Itogs[ДУ_Кусп_ф], NATCUR, ADate, "97", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Кусп\"" );
        return 1;
     end;
  end;

  if( Itogs[ДУ_Нкуд_ф] > 0 )
     if( TS_CreateDemandTrust( NULL, ID_Operation,
                          TS_UserMark_prefix(TS_DEMAND_ROLE_OBLIGATION) + "Нкуд_" + CurValid.rec.ID,
                          TS_DEMAND_ROLE_OBLIGATION,
                          "1",
                          "60",
                          ADate,
                          Abs(Itogs[ДУ_Нкуд_ф]), 
                          NATCUR,
                          РКЦ(),
                          OrderFD.ID,
                          -1,
                          NULL, NULL,
                          ID_Step, TS_DOC_PROLONG_ORDER, 0
                        ) == false 
       )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору(
              OrderFD, 
              NULL,
              NULL,
              "Прибыль ДУ", "-Расчеты, ДУ",
              ADate,
              2, 
              NATCUR,
              Abs(Itogs[ДУ_Нкуд_ф]),
              DlDoc,
              OrderFD.Number,
              "Начисление прибыли для выплаты учредителю",
              FIROLE_NALOG, FIROLE_NALOG
              )
       )
         return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Налог, Itogs[ДУ_Нкуд_ф], NATCUR, ADate, "97", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Налог\"" );
        return 1;
     end;
  end;

  if( Itogs[ДУ_Пвыв_в_ф] != 0 )
     if( TS_CreateDemandTrust( NULL, ID_Operation,
                          TS_UserMark_prefix(TS_DEMAND_ROLE_OBLIGATION) + "Пвыв_в_" + CurValid.rec.ID,
                          TS_DEMAND_ROLE_OBLIGATION,
                          "1",
                          "83",
                          ADate,
                          Itogs[ДУ_Пвыв_в_ф], 
                          NATCUR,
                          РКЦ(),
                          OrderFD.ID,
                          -1,
                          NULL, NULL,
                          ID_Step, TS_DOC_PROLONG_ORDER, 0
                        ) == false 
       )
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_в_ф], NATCUR, ADate, "97", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;
  end;

  if( Itogs[ДУ_Пвыв_к_ф] != 0 )
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_к_ф], NATCUR, ADate, "97", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs[ДУ_Пвыв_к_ф], NATCUR, ADate, "96", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_СК, Itogs[ДУ_Пвыв_к_ф], NATCUR, ADate+1, "96", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, TS_DOC_PROLONG_ORDER, 0, (CurValid.rec.EndDate + 1) ) )
        MsgBox( "Ошибка при сохранении итога \"СК\"" );
        return 1;
     end;
  end;

  if( СвернутьСчета( OrderFD, DlDoc, ADate ) != 0 )
     return 1;
  end;

  if( Itogs[ДУ_Пвыв_в_ф] > 0 )
     if( not ПроводкаПоКатегориямУчетаПоДоговору(
              OrderFD, 
              NULL,
              NULL,
              "Прибыль ДУ", "-Расчеты, ДУ",
              ADate,
              2, 
              NATCUR,
              Itogs[ДУ_Пвыв_в_ф],
              DlDoc,
              OrderFD.Number,
              "Начисление прибыли для выплаты учредителю",
              null, FIROLE_BANKROLL
              )
       )
         return 1;
     end;
  end;

  if( Itogs[ДУ_Пвыв_к_ф] > 0 )
     if( not ПроводкаПоКатегориямУчетаПоДоговору(
              OrderFD, 
              NULL,
              NULL,
              "Прибыль ДУ", "Капитал ДУ",
              ADate,
              2, 
              NATCUR,
              Itogs[ДУ_Пвыв_к_ф],
              DlDoc,
              OrderFD.Number,
              "Капитализация прибыли",
              null, FIROLE_BANKROLL
              )
       )
         return 1;
     end;
  end;
/*
  if(ОбновитьКомиссиюЗаДосрочныйВывод(OrderFD, Valid, ADate) != 0)
     return 1;
  end;
*/

  if(ВставитьНовыеИндивидуальныеУсловия(OrderFD.SfContr().rec.ID, ADate) != true)
     MsgBox( "Ошибка при вставке новых индивидуальных условий" );
     return 1;
  end;

  return 0;
END;

