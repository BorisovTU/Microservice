/* Операция сопровождения ИДДУ и ДП
   Шаг: Открытие договора           */
IMPORT InsCarryDoc, TSInter;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR OrderFD = TS_OrderFD( 0, FDoc );
  DefineOprDate( 0, OrderFD.BeginDate() );

  /* создание продукта клиента */
  if( OrderFD.Order().rec.DocKind == TS_DOC_IDDU )
     if( OrderFD.ProductID() > 0 )
        var ErrorMessage:string = "";
        var ClientProduct:RsbClientProduct = RsbClientProduct();

        ClientProduct.PartyID    = OrderFD.Trustor().rec.PartyID;
        ClientProduct.ProductID  = OrderFD.ProductID();
        ClientProduct.Branch     = {OperDprt};
        ClientProduct.BeginDate  = OrderFD.BeginDate();
        ClientProduct.SFContrID  = OrderFD.Order().rec.SfContrID;
        /* ClientProduct.ObjectType = OrderFD.Order().rec.DocKind; установить нельзя */
        TS_MakeDocumentID(ClientProduct.ObjectID, OrderFD.Order().rec.ID, OrderFD.Order().rec.DocKind);
        ClientProduct.DocNumber  = OrderFD.Number();
        ClientProduct.DocDate    = OrderFD.BeginDate();

        if( ClientProduct.AllowProductToClient(ErrorMessage) == false )
           MsgBox( ErrorMessage );
           return 1;
        end;
     end;
  end;

  return 0;
END;

