/* IAL XX.11.2008                                        */
/*                                                       */   
/* ДУ (Доверительное управление )                        */
/*                                                       */
/* Операция Погашения ДУ                                 */
/*                                                       */

import InsCarryDoc, "tssec.mac";

macro ExecuteStep( Doc, FDoc, DocKind, OperationID )

  record deal(dl_tick);
  var    FD, dat, Dk, Dp;
  VAR Payment, error;

  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  if( ( not IsBROKER(FD.Group) ) AND (FD.tick.rec.Flag1 != SET_CHAR) )
     if( not СтатусПлатежаИсполнен( FD.pm_money.rec.PaymStatus ) )
        MsgBox("Не выполнен шаг получения средств");
        return 1;
     end;
  end;

  GetOprDate( FD.GetKindDate(DATE_DEALEEND), dat );
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( IsRET_ISSUE( FD.Group ) )
     if( not ВыполненыВсеПроводки( FD, error ) )
        return SayErrorBuySale( deal, error );
     end;
  end;

  return 0;
end;

