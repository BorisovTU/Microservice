/*******************************************************************************
 DESCRIPTION  :   Отчет "Доли эмитентов в активах ДУ" 
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   25.05.2010
*******************************************************************************/
import CTInter, "tsisspart_form.mac", "tsutil.mac", "tscateg.mac";

PRIVATE VAR ReportHeader = "";

PRIVATE CLASS TS_IssPartRepParm(_Issuer, _ShareCost, _BondCost, _BillCost, _CurrCost)
  var Issuer    = _Issuer;  
  var ShareCost = _ShareCost;     
  var BondCost  = _BondCost;
  var BillCost  = _BillCost;
  var CurrCost  = _CurrCost;
END;

PRIVATE CLASS TS_IssPartRepCollect()
  var Parm = TArray();
  var CurPos = -1;

  private macro find(Issuer)
    var i = 0;
    while(i<Parm.size)
      if( (Parm[i].Issuer == Issuer) )
        return i;  
      end;
      i = i + 1;
    end;
    return -1;
  end;

  macro add(ActiveFD:TS_ActiveFD, Cost:MONEY)
    var FI_Kind   = ActiveFD.СЧА_ФИОбъекта().rec.FI_Kind;
    var AvoirKind = 0;
    var Issuer    = -1;
    var i = 0;
    var ShareCost = 0.0, BondCost = 0.0, BillCost = 0.0, CurrCost = 0.0;
    
    if(FI_Kind == FIKIND_AVOIRISS)
      if(ActiveFD.СЧА_ВидФИОбъекта() == TS_ACTIVE_KIND_INDIVIDUAL)
        Issuer   = ActiveFD.VSBanner().rec.Issuer;
        BillCost = Cost;
      else
        Issuer    = ActiveFD.СЧА_ФИОбъекта().rec.Issuer;
        if( FI_IsBond(ActiveFD.СЧА_ФИОбъекта()) )
          BondCost = Cost;
        else
          ShareCost = Cost;
        end;
      end;
    else
      CurrCost = Cost;
    end;

    i = find(Issuer);
    if(i >= 0)
      Parm[i].ShareCost = Parm[i].ShareCost + ShareCost;
      Parm[i].BondCost  = Parm[i].BondCost  + BondCost;
      Parm[i].BillCost  = Parm[i].BillCost  + BillCost;
      Parm[i].CurrCost  = Parm[i].CurrCost  + CurrCost;
    else
      Parm[Parm.size] = TS_IssPartRepParm(Issuer, ShareCost, BondCost, BillCost, CurrCost);
    end;
  end;

  macro next()
    CurPos = CurPos + 1;
    if(CurPos < Parm.size)
      return true;
    end;

    return false;
  end;
  
  macro Issuer()
    return Parm[CurPos].Issuer;
  end;

  macro IssuerName()
    if(Parm[CurPos].Issuer != -1)
      return ПолучитьКороткоеИмяСубъектаДУ( Parm[CurPos].Issuer );
    end;
    return "";
  end;

  macro ShareCost()
    return Parm[CurPos].ShareCost;
  end;

  macro BillCost()
    return Parm[CurPos].BillCost;
  end;

  macro BondCost()
    return Parm[CurPos].BondCost;
  end;

  macro CurrCost(pos)
    if((ValType(pos) != V_UNDEF))
      return Parm[pos].CurrCost;
    end;
    return Parm[CurPos].CurrCost;
  end;

END;

PRIVATE CLASS (DL_CReportTemplate) TS_IssuerPartRep_Report( _Form:TS_IssuerPartRep_Panel )
  var Form = _Form;
  var m_RepDate,
      m_UseIDDU,
      m_OrderID_IDDU,
      m_UseOFBU,
      m_OrderID_OFBU;
  var m_TSOrder:TS_OrderFD;


  PRIVATE MACRO PrintMode():INTEGER
    return DL_OUTREPORT_EXCEL;
  END;
/*================================================================================================*/
  PRIVATE MACRO BeginReport()

    m_RepDate       = Form.GetFieldValue( PNFLD_ISSUERPARTREP_ENDDATE );     
    m_UseIDDU       = Form.GetFieldValue( PNFLD_ISSUERPARTREP_USEIDDU );
    m_OrderID_IDDU  = Form.GetFieldValue( PNFLD_ISSUERPARTREP_NUMIDDU );
    m_UseOFBU       = Form.GetFieldValue( PNFLD_ISSUERPARTREP_USEOFBU );
    m_OrderID_OFBU  = Form.GetFieldValue( PNFLD_ISSUERPARTREP_NUMOFBU );

    CreateTotalBook();
    SetActiveSheet( "Отчет" );
  END;

  PRIVATE MACRO PrintHeader()
    var H12 = "";
    var H3 = "";

    if(m_TSOrder.Order().rec.DocKind == TS_DOC_IDDU)
      H12 = "по инд. договору №" + m_TSOrder.Order().rec.RegNum;
      H3  = "Учредитель " + m_TSOrder.Trustor().rec.Name;
    elif(m_TSOrder.DocKind == TS_DOC_OFBU)
      H12 = "по ОФБУ №" + m_TSOrder.Order().rec.RegNum;
      H3  = m_TSOrder.Trustor().rec.Name; 
    end;


    PrintFormatString( ReportHeader,
                       "H1_12", H12,
                       "H1_3",  H3,
                       "H1_4", string("на " + string(Date(m_RepDate):f)));

    CopyAllSheetInTotalBook( "Отчет", false, "Header_1", 0 );

  END;

  PRIVATE MACRO ПолучитьВидЦБ( AvrKind )
    var ds, rsd = RSDCommand( "select t_Name from davrkinds_dbt where t_AvoirKind = ?" );
    rsd.addParam("", RSDBP_IN, AvrKind);
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return ds.Name;
    end;
    return "";
  END;

  PRIVATE MACRO ProtocolMSG(ActiveFD)
    var Issuer;

    if(ActiveFD.СЧА_ФИОбъекта().rec.FI_Kind == FIKIND_AVOIRISS)
      if(ActiveFD.СЧА_ВидФИОбъекта() == TS_ACTIVE_KIND_INDIVIDUAL)
        Issuer   = ActiveFD.VSBanner().rec.Issuer;
      else
        Issuer   = ActiveFD.СЧА_ФИОбъекта().rec.Issuer;
      end;
    end;

    if(ActiveFD.СЧА_ФИОбъекта().rec.FI_Kind == FIKIND_CURRENCY)
      msgbox("Для актива по ден. средствам "+ActiveFD.СЧА_ФИОбъекта().rec.FI_Code+" договора "+ActiveFD.Order().rec.RegNum+" не определена стоимость");
    else
      msgbox("Для актива "+ПолучитьВидЦБ( ActiveFD.Fininstr().rec.AvoirKind )+"/"+ПолучитьКодСубъекта(Issuer, PTCK_CONTR)+" договора "+ActiveFD.Order().rec.RegNum+" не определена стоимость на отчетную дату");
    end;

  END;

  PRIVATE MACRO PrintOrderTable()
    var SqlQuery, DataSet;
    var SumActiveCost = 0.0, ActiveCost = 0.0, Quantity = 0;;
    var ActiveFD;
    var Cost = $0, CostFIID = NATCUR;
    var ActiveCollect = TS_IssPartRepCollect();
    var i = 0, CurrI = -1;
    var H12 = "";
    var H3 = "";
    var ShareCostPerc = 0.0, BondCostPerc = 0.0, BillCostPerc = 0.0, TotalCostPerc = 0.0;
    var TotalShareCost = 0.0, TotalBondCost = 0.0, TotalBillCost = 0.0, TotalCost = 0.0;
    var RetVal;

    if(m_TSOrder.Order().rec.DocKind == TS_DOC_IDDU)
      H12 = "по инд. договору №" + m_TSOrder.Order().rec.RegNum;
      H3  = "Учредитель " + m_TSOrder.Trustor().rec.Name;
    elif(m_TSOrder.Order().rec.DocKind == TS_DOC_OFBU)
      H12 = "по ОФБУ №" + m_TSOrder.Order().rec.RegNum;
      H3  = m_TSOrder.Trustor().rec.Name; 
    end;

    SqlQuery = RSDCommand(  "select * "
                          + "  from dtsactive_dbt"
                          + " where t_OrderID = ? "
                         );

    SqlQuery.addParam("", RSDBP_IN, m_TSOrder.Order().rec.ID);

    SqlQuery.execute();                                       
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    while( DataSet.MoveNext() )

      ActiveFD = TS_ActiveFD( 0, DataSet.ID );
      ActiveCost = $0.0;

      if(((ActiveFD.СЧА_ФИОбъекта().rec.FI_Kind == FIKIND_AVOIRISS) OR (ActiveFD.СЧА_ФИОбъекта().rec.FI_Kind == FIKIND_CURRENCY)) AND (ActiveFD.СЧА_ОбъемОбьекта( m_RepDate ) != 0))
        if(m_TSOrder.ЭтоПаевойОФБУ())
          ActiveCost = ActiveFD.СЧА_СтоимостьОбьекта( m_RepDate );
          if(ActiveCost == 0.0)
            ProtocolMSG(ActiveFD);
          end;
        else
          if( ПолучитьИтогДУ( ActiveFD.Order().rec.ID, ДУ_ИТОГ_СЧА, NULL, 0, NULL, NULL, NULL, m_RepDate, NULL, NULL, @RetVal, 1, 0 ) )
             RetVal = $0.0;
          end;
          if( RetVal != $0.0 ) /* если была операция "Расчет СЧА" в дату выпуска отчета */
            ActiveCost = ActiveFD.СЧА_СтоимостьОбьекта( m_RepDate );
            if(ActiveCost == 0.0)
              ProtocolMSG(ActiveFD); 
            end;
          else
            if(TS_CalcObjectCost( ActiveFD, m_RepDate, m_TSOrder.Order().rec.ID, @Cost, @CostFIID, true ) == true)
               ActiveCost = Cost;
            end;
          end;
        end;

        ActiveCollect.add(ActiveFD, ActiveCost);

        SumActiveCost = SumActiveCost + ActiveCost;

      end;
    end;


    PrintFormatString( ReportHeader,
                       "H1_12", H12,
                       "H1_3",  H3,
                       "H1_4",  string("на " + string(Date(m_RepDate):f)),
                       "H1_5",  SumActiveCost
                     );

    CopyAllSheetInTotalBook( "Отчет", false, "Header_1", 0 );

    if(SumActiveCost != 0)
      while(ActiveCollect.next())
        if(i == 0)
          CopyAllSheetInTotalBook( "Отчет", false, "TableHeader", 0 );
          
          RegisterTable( "MainTable_1", ReportHeader,
                   "A1_1",
                   "A1_2",
                   "A1_3",
                   "A1_4",
                   "A1_5",
                   "A1_6",
                   "A1_7",
                   "A1_8",
                   "A1_9"
                 );
        end;


        if(ActiveCollect.Issuer() == -1)
          CurrI = i;
        else

          ShareCostPerc = 100.0*ActiveCollect.ShareCost()/SumActiveCost; 
          BondCostPerc = 100.0*ActiveCollect.BondCost()/SumActiveCost; 
          BillCostPerc = 100.0*ActiveCollect.BillCost()/SumActiveCost; 
          TotalCostPerc = 100.0*(ActiveCollect.ShareCost() + ActiveCollect.BondCost() + ActiveCollect.BillCost())/SumActiveCost;

          if(ShareCostPerc > 15.0)
            SetCellFont( "A1_3", NULL, NULL, NULL, NULL, NULL, 140000 );
          end;

          if(BondCostPerc > 15.0)
            SetCellFont( "A1_5", NULL, NULL, NULL, NULL, NULL, 140000 );
          end;

          if(BillCostPerc > 15.0)
            SetCellFont( "A1_7", NULL, NULL, NULL, NULL, NULL, 140000 );
          end;

          if(TotalCostPerc > 15.0)
            SetCellFont( "A1_9", NULL, NULL, NULL, NULL, NULL, 140000 );
          end;
          
          PrintTableLine( "A1_1", ActiveCollect.IssuerName(), null,
                          "A1_2", ActiveCollect.ShareCost(),  null,
                          "A1_3", ShareCostPerc, null,
                          "A1_4", ActiveCollect.BondCost(),  null,
                          "A1_5", BondCostPerc, null,
                          "A1_6", ActiveCollect.BillCost(), null,
                          "A1_7", BillCostPerc, null,
                          "A1_8", ActiveCollect.ShareCost() + ActiveCollect.BondCost() + ActiveCollect.BillCost(), null,
                          "A1_9", TotalCostPerc, null
                        );

          TotalShareCost = TotalShareCost + ActiveCollect.ShareCost();  
          TotalBondCost  = TotalBondCost  + ActiveCollect.BondCost(); 
          TotalBillCost  = TotalBillCost  + ActiveCollect.BillCost(); 
          TotalCost      = TotalCost + ActiveCollect.ShareCost() + ActiveCollect.BondCost() + ActiveCollect.BillCost();
        end; 
        i = i + 1;
      end;

      if(CurrI != -1)
        PrintTableLine( "A1_1", "Денежные средства", null,
                        "A1_2", 0.0, null,
                        "A1_3", 0.0, null,
                        "A1_4", 0.0, null,
                        "A1_5", 0.0, null,
                        "A1_6", 0.0, null,
                        "A1_7", 0.0, null,
                        "A1_8", ActiveCollect.CurrCost(CurrI), null,
                        "A1_9", 100.0*ActiveCollect.CurrCost(CurrI)/SumActiveCost, null
                      );

        TotalCost = TotalCost + ActiveCollect.CurrCost(CurrI);
      end;
    

      PrintTableLine( "A1_1", "ВСЕГО", null,
                      "A1_2", TotalShareCost, null,
                      "A1_3", 100.0*TotalShareCost/SumActiveCost, null,
                      "A1_4", TotalBondCost, null,
                      "A1_5", 100.0*TotalBondCost/SumActiveCost, null,
                      "A1_6", TotalBillCost, null,
                      "A1_7", 100.0*TotalBillCost/SumActiveCost, null,
                      "A1_8", TotalCost, null,
                      "A1_9", 100.0*TotalCost/SumActiveCost, null
                    );


      EndTable();
      CopyAllSheetInTotalBook( "Отчет", false, GetTableRange(), 0 );
    end;

    AddStandardFooter( "" );
    CopyAllSheetInTotalBook( "Отчет", false, "Footer_1", 1 );

  END;

  PRIVATE MACRO Create()
    var query, cnt_query, DataSet;
    VAR ActiveFD:TS_ActiveFD;
    var count = 0;

    //отбираем подходящие договора на дату отчета
    query =   " SELECT ord.* "
            + "   FROM dtsorder_dbt ord "
            + "  WHERE 1 = (CASE WHEN ord.t_DocKind = "+TS_DOC_IDDU
            + "                       AND EXISTS( SELECT 1 FROM dtsvalid_dbt valid "
            + "                                    WHERE valid.t_OrderID = ord.t_ID "
            + "                                      AND valid.t_BeginDate <= " + GetSQLDate(m_RepDate) 
            + "                                      AND (valid.t_EndDate >= " + GetSQLDate(m_RepDate) + " OR valid.t_EndDate = " + GetSQLDate(date(0,0,0)) + ")"
            + "                                  ) THEN 1 "
            + "                  WHEN ord.t_DocKind = " + TS_DOC_OFBU
            + "                       AND EXISTS( SELECT 1 FROM dspground_dbt spgr"
            + "                                    WHERE spgr.t_SourceDocID = ord.t_ID " 
            + "                                      AND spgr.t_SourceDocKind = ord.T_dockind "                                                                                        
            + "                                      AND spgr.t_BeginningDate <= " + GetSQLDate(m_RepDate) 
            + "                                      AND (spgr.t_TerminateDate >= " + GetSQLDate(m_RepDate) + " OR spgr.t_TerminateDate = " + GetSQLDate(date(0,0,0)) + ")"
            + "                                 ) THEN 1 "
            + "                  ELSE 0 END) ";

    if((m_UseIDDU == SET_CHAR) AND (m_UseOFBU == SET_CHAR))
      query = query + " AND ord.t_DocKind in ("+TS_DOC_IDDU+", "+TS_DOC_OFBU+") ";
    elif(m_UseIDDU == SET_CHAR)
      query = query + " AND ord.t_DocKind in ("+TS_DOC_IDDU+") ";
    elif(m_UseOFBU == SET_CHAR)
      query = query + " AND ord.t_DocKind in ("+TS_DOC_OFBU+") ";
    end;

    if((m_OrderID_IDDU > 0) AND (m_OrderID_OFBU > 0))
      query = query + " AND ord.t_ID in ("+m_OrderID_IDDU+", "+m_OrderID_OFBU+") ";
    elif(m_OrderID_IDDU > 0)
      query = query + " AND ord.t_ID in ("+m_OrderID_IDDU+") ";
    elif(m_OrderID_OFBU > 0)
      if(m_UseIDDU == SET_CHAR)
        query = query + " AND ( ord.t_ID in ("+m_OrderID_OFBU+") OR ord.t_DocKind in ("+TS_DOC_IDDU+") )";
      else
        query = query + " AND ord.t_ID in ("+m_OrderID_OFBU+") ";
      end;
    end;  

    cnt_query = " select count(1) as cnt from ("+query+")";
    
    DataSet = TRsbDataSet(cnt_query);
    if((DataSet.moveNext()) and (DataSet.cnt > 0))
      InitProgress( int(DataSet.cnt), "Обработка договоров доверительного управления", "Обработка договоров доверительного управления" );

      DataSet = TRsbDataSet(query);

      while(DataSet.moveNext())
        m_TSOrder = TS_OrderFD( 0, DataSet.ID );
        PrintOrderTable();
        UseProgress(count = count + 1);
      end;
      
      RemProgress();
    else
      PrintFormatString( ReportHeader,
                         "NoDataMsg", "Нет данных, удовлетворяющих параметрам отчета"
                       );

      CopyAllSheetInTotalBook( "Отчет", false, "NoDataMsg", 0 );
    end;
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  initDL_CReportTemplate( null, "Report_TSIssPart.xls" );
END;

PRIVATE MACRO YesNoWin(msg:string)
  Array Text;
  Array Button;
  Button(0) = "Нет";
  Button(1) = "Да";
  var but, ind = 0;

  Text(ind) = msg;
  but = ConfWin(Text,Button);
  
  return but;
END;

PRIVATE MACRO CheckOprStep(RepDate)
  var Query, SqlQuery, DataSet;
  
  SqlQuery = RSDCommand(  "select count(1) as cnt " 
                        + "  from doprstep_dbt ostep "
                        + " where ostep.t_Plan_Date = ? "
                        + "   and ostep.t_IsExecute <> 'X' "
                        + "   and (    ostep.t_ServDocKind in ("+TS_DOC_DECLAR+", "+TS_DOC_DECLAR_OUT+") "
                        + "         or ostep.t_DocKind in ("+DL_VATRUST+", "+DL_VATRREPAY+", "+DL_TRUSTDOC+")"
                        + "       )");
  SqlQuery.addParam("", RSDBP_IN, RepDate);

  SqlQuery.execute();                                       
                                                          
  DataSet = TRsbDataSet(SqlQuery);
  
  if( DataSet.MoveNext() )
      return DataSet.cnt;
  end;
  
  return 0;
END;


macro MakeReport()

  var OFBU_ID, OrderFD_OFBU;
  var RepDate, RetVal;
  var Form = TS_IssuerPartRep_Panel();

  while( Form.Run() )

    if((Form.GetFieldValue( PNFLD_ISSUERPARTREP_USEIDDU ) == UNSET_CHAR) AND (Form.GetFieldValue( PNFLD_ISSUERPARTREP_USEOFBU ) == UNSET_CHAR))
      msgbox( "Необходимо указать вид договора доверительного управления" );
      continue;
    end;

    if((Form.GetFieldValue( PNFLD_ISSUERPARTREP_USEOFBU ) == SET_CHAR) AND (not (Form.GetFieldValue( PNFLD_ISSUERPARTREP_NUMOFBU ) > 0)))
      msgbox( "Необходимо указать договор ОФБУ" );
      continue;
    end;

    RepDate = Form.GetFieldValue( PNFLD_ISSUERPARTREP_ENDDATE );

    if(CheckOprStep(RepDate) > 0)
      if( not YesNoWin("В системе имеются неисполненные шаги операций, запланированые на отчетную дату. \n Продолжить?"))
        continue;
      end;
    end;
    
    OFBU_ID = Form.GetFieldValue( PNFLD_ISSUERPARTREP_NUMOFBU );
    if(OFBU_ID > 0)
      OrderFD_OFBU = TS_OrderFD( 0, OFBU_ID );
    
      if(OrderFD_OFBU.ЭтоПаевойОФБУ())
        if( (ПолучитьИтогДУ( OrderFD_OFBU.Order().rec.ID, ДУ_СНП, TS_DemandEvent("79"), 0, NULL, NULL, NULL, RepDate, NULL, NULL, @RetVal, 1, 0 )) OR (RetVal == 0.0))
          if( not YesNoWin("Для паевого ОФБУ в отчетную дату не выполнялась операция \"Расчет СНП\". \n Продолжить?"))
            continue;
          end; 
        end;
      end;
    end;

    TS_IssuerPartRep_Report(Form).Run();

  end;

end;
/*================================================================================================*/
MakeReport();

Exit(1);