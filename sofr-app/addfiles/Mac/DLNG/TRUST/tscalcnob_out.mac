/* Операция сопровождения договора ДУ
   Расчет параметров НОБ*/
IMPORT InsCarryDoc, "tsutil.mac";

PRIVATE VAR Request = TRecHandler( "tsiorqst.dbt" ), /*Заполняется программой при выполнении шага*/
            ДатаУменьшенияКапитала:DATE; 

PRIVATE MACRO CheckDate():BOOL
  VAR ErrStr = "";
  if( ДатаУменьшенияКапитала == Date(0,0,0) )
     ErrStr = "Не задана дата уменьшения капитала.";
  else
     return true;
  end;

  MsgBox( ErrStr + "|Необходимо отредактировать дату в форме заявления на вывод капитала." );
  return false;
END;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR OrderFD:TS_OrderFD; /*Договор ДДУ, для которого происходит расчет*/
  ДатаУменьшенияКапитала = Request.rec.CapitalDate; 
  if( not CheckDate() )
     return 1;
  end;

  OrderFD = TS_OrderFD( 0, FDoc );
  if( TS_IsPayerNPTaxAllCheck( OrderFD.Order.rec.Trustor, ДатаУменьшенияКапитала-1 ) )
     return NPTCalcNOB_Ex( OrderFD, ДатаУменьшенияКапитала-1, ID_Operation, ID_Step );
  end;

  return 0;
END;
