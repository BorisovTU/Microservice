
/* Подведение итогов ИДДУ.
   Выполняется при вставке цепочки из сервисной операции подведения итогов*/

IMPORT InsCarryDoc, TSInter, "tscomiss.mac", "tstrans.mac", "tsutil.mac", "tstotal.mac", "tscalcitogs.mac";

PRIVATE VAR ServOp = TRecHandler( "tssrvop.dbt" ); /*Сервисная операция, из которой выполняется расчет*/

PRIVATE VAR DlDoc; /*Документ проводки шага*/
PRIVATE VAR OrderFD:TS_OrderFD; /*Договор ДДУ, для которого происходит расчет*/
PRIVATE VAR ID_Operation;
PRIVATE VAR ID_Step;
PRIVATE VAR ДатаСписания;
PRIVATE VAR ДатаОперации;
PRIVATE VAR UseNDFL;
PRIVATE VAR MngPlan = TRecHandler( "tsmngpln.dbt" );
PRIVATE VAR CalcCom = DataCalcCom();

PRIVATE MACRO Exception( RslErrObj ):INTEGER
  RemProgress();
  MsgBox( RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message);
  return 1;
END;

PRIVATE MACRO InitGlobal( Order:VARIANT ):BOOL
  OrderFD = TS_OrderFD( 0, Order );
  UseNDFL = TS_IsPayerNPTaxAllCheck( OrderFD.Order.rec.Trustor, ServOp.rec.StepDate );
  MngPlan = OrderFD.MngPlan(ServOp.rec.StepDate);
  if( not MngPlan )
     return false;
  end;
  return true;
END;

PRIVATE MACRO ПервоеЧислоГода(EndCalcDate)
   VAR Year;
   DateSplit(EndCalcDate, null, null, Year);
   return date(1, 1, Year);
END;

/* В TypeSelect в операции подведения итогов ИДДУ сидит четырёхзначное число,
   где знаки 2-4 служат для определения попал ли данный договор по определённому условию отбора */
CONST SELECT_CALC_PERIOD = 2; /* отбор по Расчетному периоду */
CONST SELECT_COM_M       = 3; /* отбор по комиссии за управление */
CONST SELECT_COM_S       = 4; /* отбор по комиссии за успех */
PRIVATE MACRO SelectByType( TypeSelect:integer, ConstSelect ):BOOL
   return SubStr(string(TypeSelect), ConstSelect, 1) == "1";
END;

PRIVATE MACRO Скорректированный_Пнал(OrderID:integer, EndCalcDate:date, Пнал, Нкуд)
  var Н_Дх1=0, Н_Дх2=0,
      Н_Налог1=0, Н_Налог2=0;
  if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, ПервоеЧислоГода(EndCalcDate), NULL, @Н_Дх1, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
     return 1;
  end;
  if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, @Н_Дх2, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
     return 1;
  end;
  if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, ПервоеЧислоГода(EndCalcDate), @Н_Налог1, NULL, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
     return 1;
  end;
  if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, EndCalcDate, @Н_Налог2, NULL, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
     return 1;
  end;

  return (Пнал - ((Н_Дх2 - Н_Дх1) + (Н_Налог2 - Н_Налог1)));
END;

PRIVATE MACRO SaveItogsInBD( Itog:INTEGER, ЗначениеИтога ):BOOL
   if( OrderFD.SaveItog( Itog, ЗначениеИтога, NATCUR, ДатаСписания, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) != 0 )
      return false;
   end;
   return true;
END;

PRIVATE MACRO SaveAllItogsInBD(Itogs):BOOL
   if( (not SaveItogsInBD(ДУ_Купр,     Itogs.rec.A31_1) ) OR
       (not SaveItogsInBD(ДУ_Купр_ф,   Itogs.rec.A31_2) ) OR
       (not SaveItogsInBD(ДУ_Кусп,     Itogs.rec.A32_1) ) OR
       (not SaveItogsInBD(ДУ_Кусп_ф,   Itogs.rec.A32_2) ) OR
       (not SaveItogsInBD(ДУ_Пбух,     Itogs.rec.A34_1) ) OR
       (not SaveItogsInBD(ДУ_Пнал,     Itogs.rec.A34_2) ) OR
       (not SaveItogsInBD(ДУ_БП,       Itogs.rec.A34_3) ) OR
       (not SaveItogsInBD(ДУ_Пвыв_в,   Itogs.rec.A34_4) ) OR
       (not SaveItogsInBD(ДУ_Пвыв_в_ф, Itogs.rec.A34_5) ) OR
       (not SaveItogsInBD(ДУ_Пвыв_к,   Itogs.rec.A34_6) ) OR
       (not SaveItogsInBD(ДУ_Пвыв_к_ф, Itogs.rec.A34_7) ) OR
       (not SaveItogsInBD(ДУ_Нкуд,     Itogs.rec.A35_1) ) OR
       (not SaveItogsInBD(ДУ_Нкуд_ф,   Itogs.rec.A35_2) ) OR
       (not SaveItogsInBD(ДУ_СКост,    Itogs.rec.A41) )
     )
      return false;
   end;
   return true;
END;

/*Вызывается 
   - из панели "Итоги расчетного периода" при изменении суммы в одном из полей
   - при расчете итогов по договору
*/
MACRO ПересчитатьСуммуИтогов( _ServOp:TRecHandler, Itog:VARIANT /*TRecHandler или TBFile*/, ItogOld:TRecHandler ):INTEGER

  VAR IsFullCalc = false, ИзмКусп = false, ИзмКупр = false, ИзмПвыв_в = false, ИзмПвыв_к = false, ИзмНал = false;
  VAR DP = $0, AddAmount_beg = $0, AddAmount_end = $0, Пвыв = $0, cmd, ПУ = $0, Н_Дх_:money = $0.0, Н_Налог_:money = $0.0, Н_Дх_old = $0;
  ServOp  = _ServOp;
  VAR EndCalcDateComiss = GetEndCalcDateComiss(ServOp.rec.OperDate);

  if( not InitGlobal(Itog.rec.OrderID) )
     return 1;
  end;
  if( ItogOld != NULL )
     if( Itog.rec.A31_2 != ItogOld.rec.A31_2)   /*Комиссия за управление (руб)*/
        ИзмКупр = true;

     elif( Itog.rec.A32_2 != ItogOld.rec.A32_2) /*Комиссия за успешное управление (руб)*/
        ИзмКусп = true;

     elif( (Itog.rec.A34_5 != ItogOld.rec.A34_5) and SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) ) /*Прибыль выплачиваемая*/
        ИзмПвыв_в = true;

     elif( (Itog.rec.A34_7 != ItogOld.rec.A34_7) and SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) ) /*Прибыль капитализируемая*/
        ИзмПвыв_к = true;

     elif( (Itog.rec.A35_2 != ItogOld.rec.A35_2) and SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) ) /*Сумма налога (руб)*/
        ИзмНал = true;
     end;
  else /*полный расчет итогов*/
     IsFullCalc = true;
  end;

  if( IsFullCalc )
     /* Комиссия за управление <A31.1> /<A31.2>*/
     if( SelectByType( Itog.rec.TypeSelect, SELECT_COM_M ) )
        if( РасчетКомиссииБанкаЗаУправление( OrderFD, ServOp.rec.ID, EndCalcDateComiss, ОкончаниеПериодаКом, @CalcCom.ConCom_M, @CalcCom.sfdefcom_parm_M ) != 0 )
           MsgBox( "Ошибка при расчете комиссии за управление." );
           return 1;
        end;
        Itog.rec.CalcDateM  = EndCalcDateComiss;
        Itog.rec.IDComM     = CalcCom.ConCom_M.rec.ID;
        Itog.rec.BeginDateM = CalcCom.sfdefcom_parm_M.rec.DateBegin;
        Itog.rec.EndDateM   = CalcCom.sfdefcom_parm_M.rec.DateEnd;
        Itog.rec.A31_1      = CalcCom.sfdefcom_parm_M.rec.CommSum;
     end;
     Itog.rec.A31_2 = Itog.rec.A31_1; /*фактическое значение Купр*/
     /* Прибыль в бухучете A34_1 П/бух */
     Itog.rec.A34_1 = OrderFD.СуммаБухгалтерскойПрибыли( min( {curdate}, ServOp.rec.StepDate ) ) - Itog.rec.A31_2;
     /* Прибыль учредителя ПУ */
     if( ПолучитьИтогДУЗаПериод( OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, НачалоТекущегоПДД(OrderFD.ID, EndCalcDateComiss), EndCalcDateComiss, @Н_Дх_, NULL, NULL ) )
        MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
        return 1;
     end;
     if( ПолучитьИтогДУЗаПериод( OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, НачалоТекущегоПДД(OrderFD.ID, EndCalcDateComiss), EndCalcDateComiss, @Н_Налог_, NULL, NULL ) )
        MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
        return 1;
     end;
     ПУ = OrderFD.СуммаПрибылиУчредителя( EndCalcDateComiss ) + Н_Дх_ + Н_Налог_;
     /* Прибыль базовая A34_3 БП*/
     Itog.rec.A34_3 = OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss );
     /* Дополнительная прибыль ДП = ПУ - Купр - БП */
     DP = ПУ - Itog.rec.A31_1 - Itog.rec.A34_3;

     /* Комиссия за успешное управление <A32.1> /<A32.2> */
     if( SelectByType( Itog.rec.TypeSelect, SELECT_COM_S ) )

        if( РасчетКомиссииБанкаЗаУспех( OrderFD, ServOp.rec.ID, EndCalcDateComiss, TS_ComissSum( DP, NATCUR ), ОкончаниеПериодаКом, @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
           MsgBox( "Ошибка при расчете комиссии за успех." );
           return 1;
        end;
        Itog.rec.CalcDateS  = EndCalcDateComiss;
        Itog.rec.IDComS     = CalcCom.ConCom_S.rec.ID;
        Itog.rec.BeginDateS = CalcCom.sfdefcom_parm_S.rec.DateBegin;
        Itog.rec.EndDateS   = CalcCom.sfdefcom_parm_S.rec.DateEnd;
        Itog.rec.A32_1      = CalcCom.sfdefcom_parm_S.rec.CommSum;

        /*из рассчитанного значения Кусп вычитается сумма комиссий за успех, начисленных в течение текущего ПДД*/
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, OrderFD.ДатаНачалаПР( min( {curdate}, ServOp.rec.StepDate ) ) - 1, @AddAmount_beg ) != 0 )
           MsgBox( "Ошибка при получении итога \"Н_Кусп\"по договору" );
           return 1;
        end;

        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, min( {curdate}, ServOp.rec.StepDate ), @AddAmount_end ) != 0 )
           MsgBox( "Ошибка при получении итога \"Н_Кусп\"по договору" );
           return 1;
        end;

        Itog.rec.A32_1 = max(0, Itog.rec.A32_1 - (AddAmount_end - AddAmount_beg));

     end;
     Itog.rec.A32_2 = Itog.rec.A32_1; /*фактическое значение Кусп*/
     /*Перерассчитывается сумма бухгалтерской прибыли с учетом Кусп:*/
     if( SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) )
        Itog.rec.A34_1 = Itog.rec.A34_1 - Itog.rec.A32_2;
     end;
  end;

  if( ИзмКупр )
     /*Перерассчитывается сумма бухгалтерской прибыли с учетом Купр:*/
     Itog.rec.A34_1 = Itog.rec.A34_1 + ItogOld.rec.A31_2 - Itog.rec.A31_2;
  elif( ИзмКусп )
     /*Перерассчитывается сумма бухгалтерской прибыли с учетом Кусп:*/
     if( SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) )
        Itog.rec.A34_1 = Itog.rec.A34_1 + ItogOld.rec.A32_2 - Itog.rec.A32_2;
     end;
  end;

  /*Делаем расчет НДФЛ - с учетом сумм комиссий Com1, Com2, Com3 */
  if( UseNDFL AND (IsFullCalc OR ИзмКусп OR ИзмКупр) and SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) )
     /* Прибыль в налоговом учете A34_2*/
     /*Сумма налога (руб) A35_1*/

     if( (ServOp.rec.Kind_Operation == TS_DOC_CALCITOGS_IDDU) AND (OrderFD.Order.rec.NPT_TaxCalcDate < ServOp.rec.StepDate) )
        MsgBox( "Для договора: \"" + OrderFD.Number() + "\" не рассчитаны связи на дату расчетов.|" 
                "Необходимо выполнить процедуру расчета НОБ с перерасчетом связей." );
        return 0;
     end;

     if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, ServOp.rec.StepDate, Itog.rec.A31_2, Itog.rec.A32_2, 0, @Itog.rec.A34_2, @Itog.rec.A35_2/*Нкуд*/))
        return 1;
     end;
     Itog.rec.A34_2 = Скорректированный_Пнал(OrderFD.Order.rec.ID, ServOp.rec.StepDate, Itog.rec.A34_2, Itog.rec.A35_2);
     if( IsFullCalc )
        Itog.rec.A35_1 = Itog.rec.A35_2/*Нкуд*/;
     end;
  end;

  if( IsFullCalc OR ИзмКусп OR ИзмКупр OR ИзмНал )
     if( SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) )
        if( not UseNDFL )
           Пвыв = max(0, Itog.rec.A34_1) /*П/бух*/;
        else
           Пвыв = min( max(0, (Itog.rec.A34_2/*П/нал*/ - Itog.rec.A35_2/*Нкуд*/)) , max(0, (Itog.rec.A34_1/*П/бух*/ - Itog.rec.A35_2/*Нкуд*/)) );
        end;

        if( ЭтоНачисление(MngPlan.rec.Flag3) )/*доход: начисление*/
           /* Прибыль выплачиваемая   <A34.4> / <A34.5>*/
           Itog.rec.A34_5 = Пвыв;
           Itog.rec.A34_7 = 0;
           if( IsFullCalc )
              Itog.rec.A34_4 = Itog.rec.A34_5;
              Itog.rec.A34_6 = Itog.rec.A34_7;
           end;
        end;
        if( ЭтоКапитализация(MngPlan.rec.Flag3) )/*доход: капитализация*/
           /* Прибыль капитализируемая <A34.6>/ <A34.7>*/
           Itog.rec.A34_7 = Пвыв;
           Itog.rec.A34_5 = 0;
           if( IsFullCalc )
              Itog.rec.A34_6 = Itog.rec.A34_7;
              Itog.rec.A34_4 = Itog.rec.A34_5;
           end;
        end;
     end;
  end;

  /* Имущество, остающееся в управлении T_A41 СКнов*/
  if( SelectByType( Itog.rec.TypeSelect, SELECT_CALC_PERIOD ) )
     Itog.rec.A41 = Itog.rec.A6 /*СК до расчета итогов*/ + Itog.rec.A34_7/*Пвыв_к*/;
  end;

/* T_A60   Финансовый результат: за РП*/
/* T_A61   Финансовый результат: за текущий срок действия договора*/
  cmd = RsdCommand("begin\n TrustAPI.GetFR(?,?,?,?,?,?,?,?);\n end; ");

  cmd.addParam("",    RSDBP_IN,  OrderFD.ID  );
  cmd.addParam("",    RSDBP_IN,  ServOp.rec.StepDate );
  cmd.addParam("",    RSDBP_IN,  Itog.rec.A34_1 /*П/бух*/ );

  if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, НачалоТекущегоПДД(OrderFD.ID, ServOp.rec.StepDate), @Н_Дх_old, NULL, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
     return 1;
  end;
  cmd.addParam("",    RSDBP_IN,  Itog.rec.A55 /*Н_Дх за ТПДД*/ + Н_Дх_old /*Н_Дх от даты открытия и до ТПДД*/ );

  cmd.addParam("", RSDBP_IN, TS_DOC_CALCITOGS_IDDU );
  cmd.addParam("", RSDBP_IN, ServOp.rec.ID );
  cmd.addParam("A60", RSDBP_OUT, V_DOUBLE    );
  cmd.addParam("A61", RSDBP_OUT, V_DOUBLE    );
  cmd.execute();
  Itog.rec.A60 = SQL_ConvTypeSum( cmd.value("A60") );
  Itog.rec.A61 = SQL_ConvTypeSum( cmd.value("A61") );

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

MACRO РассчитатьИтоги( _ServOp:MEMADDR )
  VAR cmd, fCalcItogs, RecCount = 0, MaxRecCount;

  ServOp.SetRecordAddr( _ServOp );

  InitProgress( -1, "Операция подведения итогов ДУ", "Отбор договоров для операции");
  cmd = RsdCommand(RslDefCon, "begin\n TrustAPI.SelectOrdersForCalcItog(?);\n end; ");
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, ServOp.rec.ID ); 
  cmd.execute();

  MaxRecCount = SQL_GetNRecs( "SELECT * FROM DTSCALCITOGS_TMP WHERE t_Exclude = chr(0)" );
  RemProgress();

  InitProgress( MaxRecCount, "Выполнение ...", "Операция подведения итогов ДУ" );
  fCalcItogs = TBfile( "TSCALCITOGS.TMP", "W", 0 );
  fCalcItogs.AddFilter(" t_Exclude = chr(0) " );

  while( fCalcItogs.Next() )
     if( ПересчитатьСуммуИтогов( ServOp, fCalcItogs, NULL ) == 0 )
        if( not fCalcItogs.update() )
           runerror( "ошибка при обновлении записи в DTSCALCITOGS_TMP" );
        end;
     else 
        return 1;
     end;
     UseProgress( RecCount = RecCount + 1 );
  end;
  RemProgress();

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

PRIVATE MACRO ОплатитьКомиссию( Summa:MONEY, Name:STRING, NumItog:INTEGER, КУС:STRING, Ground:STRING, FIRole:INTEGER ):BOOL

  if( Summa != 0 )

     if( (NumItog == ДУ_ИТОГ_Н_Кусп) or ((NumItog == ДУ_ИТОГ_Н_Купр) and (ServOp.rec.ExpenseAccount == SET_CHAR)) )
        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null, 
                                                     "Расходы ДУ", "-Расчеты, ДУ", /* AccDeb , AccCred*/
                                                     ДатаОперации,                 /* Дата */
                                                     2,                            /* Глава */
                                                     NATCUR,                       /* Валюта */
                                                     Summa,                        /* Сумма */
                                                     DlDoc,                        /* Документ */
                                                     OrderFD.Number,               /* Numb_Document */
                                                     Ground,                       /* Ground */
                                                     FIRole,
                                                     FIRole
                                                    ) 
          )
            return false;
        end;
     else
        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null, 
                                                     "+Расчеты, ДУ", "-Расчеты, ДУ", /* AccDeb , AccCred*/
                                                     ДатаОперации,                   /* Дата */
                                                     2,                              /* Глава */
                                                     NATCUR,                         /* Валюта */
                                                     Summa,                          /* Сумма */
                                                     DlDoc,                          /* Документ */
                                                     OrderFD.Number,                 /* Numb_Document */
                                                     Ground,                         /* Ground */
                                                     FIRole,
                                                     FIRole
                                                    ) 
          )
            return false;
        end;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation, 
                               TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, Name ),
                               TS_DEMAND_ROLE_OBLIGATION, 
                               "2" /*КВТО - оплата*/, 
                               КУС/*КУС */,  
                               ДатаОперации, 
                               Summa, 
                               NATCUR,  
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) == false )
        return false;
     end;

     if( (NumItog == ДУ_ИТОГ_Н_Купр) and (ServOp.rec.ExpenseAccount != SET_CHAR) ) /* комиссия за управление и НЕ выставлен признак начисления со счета расходов */
        if( TS_CreateDemandTrust( NULL, ID_Operation,
                                  TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_REQUEST, ServOp.rec.ID, OrderFD.ID, Name ),
                                  TS_DEMAND_ROLE_REQUEST,
                                  "2" /*КВТО - оплата*/, 
                                  КУС/*КУС */,  
                                  ДатаОперации, 
                                  Summa, 
                                  NATCUR,  
                                  РКЦ(),
                                  OrderFD.ID, NATCUR,
                                  NULL, NULL,
                                  ID_Step, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) == false )
           return false;
        end;
     end;

     if( OrderFD.SaveItog( NumItog, Summa, NATCUR, ДатаСписания, "98", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) )
        MsgBox( "Ошибка при сохранении итога \""+Name+"\"" );
        return false;
     end;
  end;

  return true;
END;

PRIVATE MACRO ВыполнятьСвертку(TypeSelect)
  var dd, mm, yyyy;
  var cmd, DataSet, rez = false;
  DateSplit(ServOp.rec.StepDate, dd, mm, yyyy);

  if((MngPlan.rec.CloseAccount == TS_CLOSE_ACCOUNT_MONTH) and (LastDay(mm, yyyy) == dd))
     rez = true;
  end;
  if((rez == false) and (MngPlan.rec.CloseAccount == TS_CLOSE_ACCOUNT_QUARTER) and ((LastDay(mm, yyyy) == dd) and ((mm == 3) OR (mm == 6) OR (mm == 9) OR (mm == 12))))
     rez = true;
  end;
  if((rez == false) and (MngPlan.rec.CloseAccount == TS_CLOSE_ACCOUNT_CALCPERIOD) and SelectByType( TypeSelect, SELECT_CALC_PERIOD ))
     rez = true;
  end;

  return rez;
END;

MACRO ВыполнитьПодведениеИтогов( _DlDoc:MEMADDR, FDoc:MEMADDR, _ID_Operation:INTEGER, _ID_Step:INTEGER )
  VAR Itogs = TRecHandler( "TSCALCITOGS.TMP" ), КУС = NULL, d, m, y;

  if( TS_RunFromServiceOper( ServOp ) != true )
     MsgBox( "Шаг \"Подведение итогов ДУ\" должен выполняться только из соответствующей сервисной операции." );
     return 1;
  end;

  DlDoc        = _DlDoc;
  ID_Operation = _ID_Operation;
  ID_Step      = _ID_Step;
  ДатаСписания = ServOp.rec.StepDate;
  ДатаОперации = ServOp.rec.OperDate;
  if( not InitGlobal( FDoc ) )
     return 1;
  end;

  if( not TS_GetRecHandler( Itogs, " SELECT * FROM DTSCALCITOGS_TMP WHERE t_OrderID = "+ string(OrderFD.ID) ) )
     MsgBox( "Для договора \"" + OrderFD.Code() + "\" не были рассчитаны итоги.");
     return 1;
  end;

  /*Купр/ф*/
  if( SelectByType( Itogs.rec.TypeSelect, SELECT_COM_M ) )
     CalcCom.sfdefcom_parm_M.rec.CommSum   = Itogs.rec.A31_2;
     CalcCom.sfdefcom_parm_M.rec.DateEnd   = Itogs.rec.EndDateM;
     CalcCom.sfdefcom_parm_M.rec.DateBegin = Itogs.rec.BeginDateM;
     FindSfConCom_ByID(Itogs.rec.IDComM, CalcCom.ConCom_M);
     if( СохранитьПериодическуюКомиссию( OrderFD, Itogs.rec.CalcDateM, CalcCom.ConCom_M, CalcCom.sfdefcom_parm_M ) != 0 )
        return 1;
     end;

     if( Itogs.rec.A31_2 != 0 )
        if( not ОплатитьКомиссию( Itogs.rec.A31_2, "Н_Купр", ДУ_ИТОГ_Н_Купр, "61", "Начисление комиссии за управление", FIROLE_COM_MANAG ) )
           return 1;
        end;
     end;
  end;

  /*Кусп/ф*/
  if( SelectByType( Itogs.rec.TypeSelect, SELECT_COM_S ) )
     CalcCom.sfdefcom_parm_S.rec.CommSum   = Itogs.rec.A32_2;
     CalcCom.sfdefcom_parm_S.rec.DateEnd   = Itogs.rec.EndDateS;
     CalcCom.sfdefcom_parm_S.rec.DateBegin = Itogs.rec.BeginDateS;
     FindSfConCom_ByID(Itogs.rec.IDComS, CalcCom.ConCom_S);
     if( СохранитьПериодическуюКомиссию( OrderFD, Itogs.rec.CalcDateS, CalcCom.ConCom_S, CalcCom.sfdefcom_parm_S ) != 0 )
        return 1;
     end;

     if( Itogs.rec.A32_2 != 0 )
        if( not ОплатитьКомиссию( Itogs.rec.A32_2, "Н_Кусп", ДУ_ИТОГ_Н_Кусп, "62", "Начисление комиссии за успешное управление", FIROLE_COM_SUCCESS ) )
           return 1;
        end;
     end;
  end;

  if( ВыполнятьСвертку(Itogs.rec.TypeSelect) == true )
     if( СвернутьСчета( OrderFD, DlDoc, ДатаОперации ) != 0 )
        return 1;
     end;
  end;

  /*Пвыв_в/ф*/
  if( SelectByType( Itogs.rec.TypeSelect, SELECT_CALC_PERIOD ) )
     if( Itogs.rec.A34_5 != 0 )

        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs.rec.A34_5, NATCUR, ДатаСписания, "98", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null, 
                                                     "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                     ДатаОперации,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Itogs.rec.A34_5,           /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Начисление прибыли для выплаты учредителю", /* Ground */
                                                     FIROLE_TRUSTOR,
                                                     FIROLE_TRUSTOR
                                                    ) 
          )
            return 1;
        end;

        if( TS_CreateDemandTrust( NULL, ID_Operation, 
                                  TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Дх" ),
                                  TS_DEMAND_ROLE_OBLIGATION, 
                                  "2" /*КВТО = оплата*/, 
                                  "83"/*КУС  =  Выплата дохода учредителю*/,  
                                  ДатаОперации, 
                                  Itogs.rec.A34_5,
                                  NATCUR,  
                                  РКЦ(),
                                  OrderFD.ID, NATCUR,
                                  NULL, NULL,
                                  ID_Step, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) == false )
           return 1;
        end;
     end;

     /*Нкуд/ф*/
     if( Itogs.rec.A35_2 != 0 )

        /*Нкуд/ф*/
        DateSplit( ServOp.rec.StepDate, d, m, y);

        if( Itogs.rec.A34_5 != 0 )
           КУС = "83";
        elif( Itogs.rec.A34_7 != 0 )
           КУС = "96";
        elif( (d == 31) and (m == 12) )
           КУС = "98"
        end;

        if( КУС != NULL )
           if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Налог, Itogs.rec.A35_2, NATCUR, ДатаСписания, КУС, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) )
              MsgBox( "Ошибка при сохранении итога \"Н_Налог\"" );
              return 1;
           end;

           if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null, 
                                                        "Прибыль ДУ", "-Расчеты, ДУ",     /* AccDeb , AccCred*/
                                                        ДатаОперации,    /* Дата */
                                                        2,                         /* Глава */
                                                        NATCUR,                    /* Валюта */
                                                        Itogs.rec.A35_2,           /* Сумма */
                                                        DlDoc,                     /* Документ */
                                                        OrderFD.Number,            /* Numb_Document */
                                                        "Начисление налога на доходы физ.лиц", /* Ground */
                                                        FIROLE_NALOG,
                                                        FIROLE_NALOG
                                                       ) 
             )
               return 1;
           end;

           if( TS_CreateDemandTrust( NULL, ID_Operation, 
                                     TS_DemandUserMark_Itogs( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Налог" ),
                                     TS_DEMAND_ROLE_OBLIGATION, 
                                     "2" /*КВТО = оплата*/, 
                                     "60"/*КУС  =  Оплата налога на доходы физ.лиц*/,  
                                     ДатаОперации, 
                                     Itogs.rec.A35_2,
                                     NATCUR,  
                                     РКЦ(),
                                     OrderFD.ID, NATCUR,
                                     NULL, NULL,
                                     ID_Step, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) == false )
              return 1;
           end;
        end;
     end;

     /*Пвыв_к/ф */
     if( Itogs.rec.A34_7 != 0 )

        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs.rec.A34_7, NATCUR, ДатаСписания, "98", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, Itogs.rec.A34_7, NATCUR, ДатаСписания, "96", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) )
           MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null, 
                                                     "Прибыль ДУ", "Капитал ДУ",     /* AccDeb , AccCred*/
                                                     ДатаОперации,    /* Дата */
                                                     2,                         /* Глава */
                                                     NATCUR,                    /* Валюта */
                                                     Itogs.rec.A34_7,           /* Сумма */
                                                     DlDoc,                     /* Документ */
                                                     OrderFD.Number,            /* Numb_Document */
                                                     "Капитализация прибыли", /* Ground */
                                                     FIROLE_TRUSTOR,
                                                     FIROLE_TRUSTOR
                                                    ) 
          )
            return 1;
        end;

        if( OrderFD.SaveItog( ДУ_ИТОГ_СК, Itogs.rec.A34_7, NATCUR, ДатаСписания+1, "96", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, TS_DOC_CALCITOGS_IDDU, ServOp.rec.ID ) )
           MsgBox( "Ошибка при сохранении итога \"СК\"" );
           return 1;
        end;
     end;

     if( UseNDFL )
        if( NPTSaveTaxSum( OrderFD.Order.rec.ID, ID_Operation, ID_Step ) != 0 )
           MsgBox( "Ошибка при занесении объектов НДР в постоянную базу" );
           return 1;
        end;
     end;

     if( TS_UpdateCalcItogDate( OrderFD.ID, ДатаСписания ) != 0 )
        MsgBox( "Ошибка при обновлении даты расчета в договоре ДУ." );
        return 1;
     end;
  end;
  
  SaveAllItogsInBD(Itogs);

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;
