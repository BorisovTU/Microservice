/*******************************************************************************
 DESCRIPTION  :   Žâç¥â " ¥£¨áâà ¢­ãâà¥­­¥£® ãç¥â  ¤¥­¥¦­ëå áà¥¤áâ¢ ¨ 
                  à áç¥â®¢ ¯® á¤¥«ª ¬ ¨ ®¯¥à æ¨ï¬ á æ¥­­ë¬¨ ¡ã¬ £ ¬¨"
*******************************************************************************/
import RsbDataSet;
import "dltsreg_form.mac", "tssec.mac", "tsutil.mac";

PRIVATE CONST PTSK_TRUST = 17; //¤®¢¥à¨â¥«ì­®¥ ã¯à ¢«¥­¨¥
PRIVATE CONST PTSKS_TRUST_OFBU = 1; //„ŽƒŽ‚Ž Ž”“

PRIVATE CONST REP_KIND_CLNT = 1,
              REP_KIND_CALC = 2;

PRIVATE VAR TableHeader1 =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
"³  ¨¬¥­®¢ ­¨¥ ³        ‚¨¤         ³         ü          ³      ‚¨¤        ³       ü         ³  ‚å®¤. ®áâ â®ª,³Š®«-¢® æ/¡ ³ ˆáå. ®áâ â®ª   ³\n" +
"³  à áç¥â­®©   ³  á¤¥«ª¨(®¯¥à æ¨¨)  ³  á¤¥«ª¨(®¯¥à æ¨¨)  ³ ¯®¤â¢¥à¦¤ îé¥£® ³ ¯®¤â¢¥à¦¤ îé¥£® ³       èâ.      ³           ³      èâ.       ³\n" +
"³   ®¯¥à æ¨¨   ³       á æ/¡        ³       á æ/¡        ³    ¤®ªã¬¥­â     ³    ¤®ªã¬¥­â     ³                ³           ³                ³\n" +
"³              ³                    ³                    ³                 ³                 ³                ³           ³                ³\n" +
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";


PRIVATE VAR TableHeader2 =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
"³  ¨¬¥­®¢ ­¨¥ ³       ‚¨¤          ³         ü          ³       ‚¨¤        ³        ü         ³‚å®¤ïé¨© ®áâ â®ª³‚å®¤. ®áâ â®ª    ³ Š®«-¢® æ/¡  ³ˆáå. ®áâ â®ª     ³ ˆáå. ®áâ â®ª ³\n" +
"³  à áç¥â­®©   ³  á¤¥«ª¨(®¯¥à æ¨¨)  ³  á¤¥«ª¨(®¯¥à æ¨¨)  ³ ¯®¤â¢¥à¦¤ îé¥£®  ³ ¯®¤â¢¥à¦¤ îé¥£®  ³  æ/¡, èâ.      ³¯® ®¡ï§ â¥«ìáâ¢ ¬³             ³¯® ®¡ï§ â¥«ìáâ¢ ¬³ æ/¡, èâ.     ³\n" +       
"³   ®¯¥à æ¨¨   ³      á æ/¡         ³       á æ/¡        ³    ¤®ªã¬¥­â      ³    ¤®ªã¬¥­â      ³                ³ª«¨¥­â           ³             ³ª«¨¥­â           ³              ³\n" +
"³              ³                    ³                    ³                  ³                  ³                ³¯¥à¥¤ ¡ ­ª®¬     ³             ³¯¥à¥¤ ¡ ­ª®¬     ³              ³\n" +
"³              ³                    ³                    ³                  ³                  ³                ³                 ³             ³                 ³              ³\n" +
"³              ³                    ³                    ³                  ³                  ³                ³                 ³             ³                 ³              ³\n" +
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

PRIVATE VAR TableHeader1_VA =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄ¿\n" +
"³  ¨¬¥­®¢ ­¨¥ ³    ‚¨¤     ³      N     ³       ‚¨¤       ³        N        ³ ‚¨¤ æ¥­­®© ¡ã¬ £¨ ³       ‹¨æ¥¢®© áç¥â      ³  ‚å®¤. ³ Š®«-¢® ³  ˆáå.  ³\n" +
"³  à áç¥â­®¥©  ³   á¤¥«ª¨   ³   á¤¥«ª¨   ³ ¯®¤â¢¥à¦¤ îé¥£® ³ ¯®¤â¢¥à¦¤ îé¥£® ³   ‘¥à¨ï, ­®¬¥à    ³                         ³®áâ â®ª,³   æ/¡  ³®áâ â®ª,³\n" +
"³   ®¯¥à æ¨¨   ³ (®¯¥à æ¨¨) ³ (®¯¥à æ¨¨) ³    ¤®ªã¬¥­â     ³    ¤®ªã¬¥­â     ³      ¬¨â¥­â      ³                         ³   èâ.  ³        ³   èâ.  ³\n" +
"³              ³   á æ/¡    ³   á æ/¡    ³                 ³                 ³        Š®¤        ³                         ³        ³        ³        ³\n" +
"³              ³            ³            ³                 ³                 ³                   ³                         ³        ³        ³        ³\n" +
"³              ³            ³            ³                 ³                 ³                   ³                         ³        ³        ³        ³\n" +
"³              ³            ³            ³                 ³                 ³                   ³                         ³        ³        ³        ³\n" +
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄ´";
                                   
                                   
PRIVATE VAR TableHeader2_VA =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄ¿\n" +
"³  ¨¬¥­®¢ ­¨¥ ³    ‚¨¤     ³      N     ³       ‚¨¤       ³        N        ³ ‚¨¤ æ¥­­®© ¡ã¬ £¨ ³       ‹¨æ¥¢®© áç¥â      ³  ‚å®¤. ³‚å®¤.®áâ â®ª³ Š®«-¢® ³ ˆáå.®áâ â®ª ³  ˆáå.  ³\n" +
"³  à áç¥â­®¥©  ³   á¤¥«ª¨   ³   á¤¥«ª¨   ³ ¯®¤â¢¥à¦¤ îé¥£® ³ ¯®¤â¢¥à¦¤ îé¥£® ³   ‘¥à¨ï, ­®¬¥à    ³                         ³®áâ â®ª,³  ¯® ®¡ï§ - ³   æ/¡  ³  ¯® ®¡ï§ -  ³®áâ â®ª,³\n" +
"³   ®¯¥à æ¨¨   ³ (®¯¥à æ¨¨) ³ (®¯¥à æ¨¨) ³    ¤®ªã¬¥­â     ³    ¤®ªã¬¥­â     ³      ¬¨â¥­â      ³                         ³   èâ.  ³  â¥«ìá¢ ¬  ³        ³  â¥«ìá¢ ¬   ³   èâ.  ³\n" +
"³              ³   á æ/¡    ³   á æ/¡    ³                 ³                 ³        Š®¤        ³                         ³        ³  ª«¨¥­â    ³        ³  ª«¨¥­â     ³        ³\n" +
"³              ³            ³            ³                 ³                 ³                   ³                         ³        ³¯¥à¥¤ ¡ ­ª®¬³        ³ ¯¥à¥¤ ¡ ­ª®¬³        ³\n" +
"³              ³            ³            ³                 ³                 ³                   ³                         ³        ³            ³        ³             ³        ³\n" +
"³              ³            ³            ³                 ³                 ³                   ³                         ³        ³            ³        ³             ³        ³\n" +
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄ´";

PRIVATE VAR ReportHeader1 = "”¨«¨ « #\n"+
                           "¥£¨áâà ¢­ãâà¥­­¥£® ãç¥â  æ¥­­ëå ¡ã¬ £\n"+                             
                           "‘ç¥â  ãç¥â  æ¥­­ëå ¡ã¬ £\n"+                            
                           "Žâç¥â­ë© ¯¥à¨®¤ #\n"+
                           "‘ç¥â ¢­ãâà¥­­¥£® ãç¥â : –¥­­ë¥ ¡ã¬ £¨ ª«¨¥­â  ¯® ¤®£®¢®àã „“\n";

PRIVATE VAR ReportHeader2 = "”¨«¨ « #\n"+
                           "¥£¨áâà ¢­ãâà¥­­¥£® ãç¥â  æ¥­­ëå ¡ã¬ £\n"+                             
                           "‘ç¥â  à áç¥â®¢ á ª«¨¥­â ¬¨ ¯® æ¥­­ë¬ ¡ã¬ £ ¬\n"+                            
                           "Žâç¥â­ë© ¯¥à¨®¤ #\n"+
                           "‘ç¥â ¢­ãâà¥­­¥£® ãç¥â :  áç¥âë á ª«¨¥­â ¬¨  ¯® æ¥­­ë¬ ¡ã¬ £ ¬ ¯® ¤®£®¢®à ¬ „“\n";

PRIVATE CONST ALL_ITEM = -1; // ã­ªâ Œ¥­î: ‚‘…

PRIVATE CLASS (DL_CReportTemplate) TS_RegAvr_Report
   var m_DepartmentID, m_Emiss, m_NotEmiss, m_BeginDate, m_EndDate,
        m_IsOFBU, m_ClientCode, m_Name, m_Contract1, m_Contract1Date,
        m_IsSeparatelyDate, m_IsSAccounts_Report, m_AccountingPlace, m_Issuer_1,
        m_SecurKind_1, m_SecurIssue, m_IsCL_SAccounts_Report, m_ClientID,
        m_ContractID, m_Issuer_2, m_SecurKind_2, m_SecurCode, m_IsUseOpostrofs,
        m_IsExportToExel;
  var m_IsFirstPrint, m_KindRep, m_SheetName = "‘ç¥â  ãç¥â  –", m_Prefix = "N1_";
  var Sec_Accounts, m_CurDate = Date(0,0,0);

  MACRO WithApp()
     return TS_IIF(m_IsUseOpostrofs,":a","");
  END;

  MACRO ReportPeriod(ProDate:Date)
    if( m_IsSeparatelyDate )
       return ProDate;
    end;

    return " á " + m_BeginDate + " ¯® " + m_EndDate;
  END;

  MACRO PrintHeadDep()
    PrintFormatString( TS_IIF(m_KindRep == REP_KIND_CLNT, ReportHeader1, ReportHeader2),
                                m_Prefix+"H0", Sec_Accounts.DepartmentName,
                                m_Prefix+"H1", ReportPeriod(Sec_Accounts.ProDate)
                              );
    if( m_IsFirstPrint )
       CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Header_1", 0 );
       m_IsFirstPrint = false;
    else
       CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Header_1", 1 );
    end;
  END;

  MACRO PrintHeadClnt()
   VAR Order = TRecHandler( "tsorder.dbt" );
   var Name = "";
   var Number = "";
   var DateDoc = date(0,0,0);

   if( FindOrderBySfContr( Sec_Accounts.Clientcontrid, Order ) )
     var OrderFD = TS_OrderFD( 0, Order.rec.ID );

     if( Order.rec.DocKind == 905 )
       Name   = "“çà¥¤¨â¥«ì " + ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( Sec_Accounts.Owner );
       Number = " „®£®¢®à „“ ü " + OrderFD.Number();
     elif( Order.rec.DocKind == 903 )
       Name   = " Ž”“ " + Order.rec.ShortName;
       Number = " à¥£¨áâà æ¨®­­ë© ü " + OrderFD.Number();
     end;
     DateDoc = OrderFD.BeginDate();
    end;
    PrintFormatString( "\n#\n",
                                m_Prefix+"H3", Name+Number+" ®â "+string(DateDoc)
                              );
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"H3", 1 );
  END;

  MACRO GetOperationKindAndCode( OperKind:@string, OperCode:@integer )                                    
    var FD, Leg;                                                                                                                
                                                                                                                                
    if( Sec_Accounts.DocID != 0 )                                                                                               
       if( (Sec_Accounts.DocKind == 159) or (Sec_Accounts.DealKind == 159) )                                                    
           FD = DLFirstDocDL_ACC( 0, Sec_Accounts.DocID );                                                                      
           /*…á«¨ Ž‚“ ¯à¨¢ï§ ­  ª á¤¥«ª¥ - ¢ë¢¥áâ¨ ­®¬¥à á¤¥«ª¨*/                                                              
           if(Sec_Accounts.DealKind != 159)                                                                                     
              OperKind = ®«ãç¨âì‚¨¤Ž¯¥à æ¨¨(GetOperationGroup(FD.dl_acc.rec.DealType), false, false, true, false, false, true);
              OperCode = Sec_Accounts.DealNumber;                                                                               
           else                                                                                                                 
              OperKind = " áçñâ­ ï ®¯¥à æ¨ï ¢­ãâà¥­­¥£® ãçñâ ";                                                                
              OperCode = FD.dl_acc.rec.Code;                                                                                    
           end;                                                                                                                 
       elif(Sec_Accounts.DealKind == DL_SECURLEG)                                                                               
           Leg = GetDlLegByID( Sec_Accounts.DocID, true, false );                                                               
           if( Leg.DealID > 0 )                                                                                                 
              FD = SPFirstDocTrust( Leg.LegKind, Leg.DealID );                                                                  
              OperKind = ®«ãç¨âì‚¨¤Ž¯¥à æ¨¨(FD.Group, FD.IsBack, true, true, false, false, true);                              
              OperCode = FD.tick.rec.DealCode;                                                                                  
           end;                                                                                                                 
       else                                                                                                                     
          FD = SPFirstDocTrust( 0, Sec_Accounts.DocID );                                                                        
          OperKind = ®«ãç¨âì‚¨¤Ž¯¥à æ¨¨(FD.Group, FD.IsBack, true, true, false, false, true);                                  
          OperCode = FD.tick.rec.DealCode;                                                                                      
       end;                                                                                                                     
    end;                                                                                                                        
    return 0;                                                                                                                   
  END;                                                                                                                          

   MACRO GetFirstDoc( GroundKind)                                    
     var query, Firstdoc, Doc = "";                                          
                                                                             
     query = RSDCommand(" select t_Name from dllvalues_dbt " +               
                        "  where t_List = " + string(OBJTYPE_KINDDOC) +      
                        "    and t_element = ?"                              
                       );                                                    
                                                                             
     query.addParam("", RSDBP_IN, GroundKind);                               
                                                                             
        query.execute();                                                     
                                                                             
     Firstdoc = TRsbDataSet(query);                                          
                                                                             
     if( Firstdoc.MoveNext() )                                               
        Doc = Doc + string(FirstDoc.Name);                                   
      end;                                                                   
                                                                             
     return Doc;                                                             
   END;                                                                      
                                                                             
   macro GetRest( ProDate:date, BegDay )                             
     var Rest = 0;                                                           
     var AccBuf = TRecHandler("account");                                    
      ClearRecord( AccBuf );                                                 
      if( GetAccount( 22, Sec_Accounts.Currency, Sec_Accounts.Acc, AccBuf ) )
          Rest = abs( GetRestAccount( AccBuf.rec, ProDate-1 ) );             
      end;                                                                   
      return Rest;                                                           
   end;                                                                      
                                                                             
   macro GetRestVA( ProDate:date, BegDay )        
     var Rest = $0;                                                          
      OprGetAccountRest( 22, Sec_Accounts.Currency, Sec_Accounts.Acc, ProDate - 1, Rest );             
      Rest = abs( Rest );                                                    
      return Rest;                                                           
   end;                                                                      

   macro GetAccName()                                                   
     var AccBuf = TRecHandler("account");                                       
      ClearRecord( AccBuf );                                                    
      if( GetAccount( 22, Sec_Accounts.Currency, Sec_Accounts.Acc, AccBuf ) )   
         return AccBuf.rec.NameAccount;                                         
      end;                                                                      
      return "";                                                                
   end;                                                                         
                                                                                
   macro GetPositivRest( SumAcc )                                               
     if( SumAcc > 0 )                                                           
       return SumAcc;                                                           
     else                                                                       
       return 0;                                                                
     end;                                                                       
   end;                                                                         
                                                                                
   macro GetAbsRest( SumAcc )                                                   
     if( SumAcc < 0 )                                                           
       return Abs( SumAcc );                                                    
     else                                                                       
       return 0;                                                                
     end;                                                                       
   end;                                                                         
                                                                                
   macro GetRestOut( Amount, SumIn )                                            
     var                                                                        
        A8 = GetPositivRest( SumIn ), /*¢å®¤. ®áâ.*/                            
        A9 = GetAbsRest( SumIn ); /*¢å®¤. ®áâ. ¯® ®¡ï§ â. ª«¨¥­â  ¯¥à¥¤ ¡ ­ª®¬*/
                                                                                
     if( Sec_Accounts.Acc != Sec_Accounts.DebAcc )                              
         return A8 - A9 + Amount;/*§ ç¨á«¥­¨¥*/                                 
       else                                                                     
         return A8 - A9 - Amount;/*á¯¨á ­¨¥*/                                   
     end;                                                                       
   end;                                                                         

  MACRO EndRepTable()
    if( m_IsFirstPrint == false )
       EndTable();
       CopyAllSheetInTotalBook( m_SheetName, false, GetTableRange(), 0 );
    end;
  END;

  MACRO PrintKindEmissive()
    PrintFormatString( "#\n",
                                m_Prefix+"H4", TS_IIF(Sec_Accounts.IsEmissive==SET_CHAR,"¬¨áá¨®­­ë¥ æ¥­­ë¥ ¡ã¬ £¨","¥í¬¨áá¨®­­ë¥ æ¥­­ë¥ ¡ã¬ £¨")
                              );                 
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"H4", 0 );
  END;

  MACRO PrintAvr()
    PrintFormatString( "#\n",
                                m_Prefix+"H5", "–¥­­ ï ¡ã¬ £ : "+Sec_Accounts.AvrName +" Š®¤ æ/¡: "+Sec_Accounts.AvrCode );                 
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"H5", 0 );
    PrintFormatString( "#\n",
                                m_Prefix+"H5_1", "¬¨â¥­â: "+Sec_Accounts.IssuerName+" ‚¨¤: "+Sec_Accounts.AvrKindName+" ‚ë¯ãáª: "+Sec_Accounts.ISSUE+" ‘¥à¨ï/âà ­è: "+Sec_Accounts.SERIES+" / "+Sec_Accounts.TRANCHE
                              );                 
    CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"H5_1", 0 );
  END;

  MACRO RegisterRepTable()
    if( m_KindRep == REP_KIND_CLNT )
       if( Sec_Accounts.IsEmissive == SET_CHAR )
          RegisterTable( m_Prefix+"MainTable", TableHeader1,
                            m_Prefix+"A1",
                            m_Prefix+"A2",
                            m_Prefix+"A3",
                            m_Prefix+"A4",
                            m_Prefix+"A5",
                            m_Prefix+"A6",
                            m_Prefix+"A7",
                            m_Prefix+"A8"
                           );
       else
          RegisterTable( m_Prefix+"MainTable1", TableHeader1_VA,
                            m_Prefix+"A1_1",
                            m_Prefix+"A2_1",
                            m_Prefix+"A3_1",
                            m_Prefix+"A4_1",
                            m_Prefix+"A5_1",
                            m_Prefix+"A6_1",
                            m_Prefix+"A7_1",
                            m_Prefix+"A8_1",
                            m_Prefix+"A9_1",
                            m_Prefix+"A10_1"
                           );
       end;
    else
       if( Sec_Accounts.IsEmissive == SET_CHAR )
          RegisterTable( m_Prefix+"MainTable", TableHeader2,
                            m_Prefix+"A1",
                            m_Prefix+"A2",
                            m_Prefix+"A3",
                            m_Prefix+"A4",
                            m_Prefix+"A5",
                            m_Prefix+"A6",
                            m_Prefix+"A7",
                            m_Prefix+"A8",
                            m_Prefix+"A9",
                            m_Prefix+"A10"
                           );
       else
          RegisterTable( m_Prefix+"MainTable1", TableHeader2_VA,
                            m_Prefix+"A1_1",
                            m_Prefix+"A2_1",
                            m_Prefix+"A3_1",
                            m_Prefix+"A4_1",
                            m_Prefix+"A5_1",
                            m_Prefix+"A6_1",
                            m_Prefix+"A7_1",
                            m_Prefix+"A8_1",
                            m_Prefix+"A9_1",
                            m_Prefix+"A10_1",
                            m_Prefix+"A11_1",
                            m_Prefix+"A12_1"
                           );
       end;
    end;
  END;

  MACRO PrintRepTableLine(In, Out:@money, PrevDealCode)
    var OperKind = "";
    var OperCode = "";

    if(m_KindRep == REP_KIND_CLNT)
        if( Sec_Accounts.Acc == Sec_Accounts.DebAcc ) 
           Out = In + Sec_Accounts.Sum;/*§ ç¨á«¥­¨¥*/
        else
           Out = In - Sec_Accounts.Sum;/*á¯¨á ­¨¥*/
        end;                
        if( Sec_Accounts.IsEmissive == SET_CHAR )

           GetOperationKindAndCode(@OperKind, @OperCode);
           PrintTableLine( m_Prefix+"A1", Sec_Accounts.OperationName, null,
                                 m_Prefix+"A2", OperKind, null,
                                 m_Prefix+"A3", OperCode, null,
                                 m_Prefix+"A4", GetFirstDoc( Sec_Accounts.GroundKind), null,
                                 m_Prefix+"A5", Sec_Accounts.GroundNum, null,
                                 m_Prefix+"A6"+WithApp(), In, null,
                                 m_Prefix+"A7"+WithApp(), Sec_Accounts.Sum, null,
                                 m_Prefix+"A8"+WithApp(), Out, null
                                  );
        else
           if(PrevDealCode!=Sec_Accounts.DealCode)
              PrintTableLine( m_Prefix+"A1_1", Sec_Accounts.OperationName, null,
                                 m_Prefix+"A2_1", Sec_Accounts.OprName, null,
                                 m_Prefix+"A3_1", Sec_Accounts.DealCode, null,
                                 m_Prefix+"A4_1", GetFirstDoc( Sec_Accounts.GroundKind), null,
                                 m_Prefix+"A5_1", Sec_Accounts.GroundNum, null,
                                 m_Prefix+"A6_1", Sec_Accounts.AvrKindName + " á¥à¨ï " + Sec_Accounts.BCSeries + " N " + Sec_Accounts.BCNumber + " " + Sec_Accounts.IssuerName, null,
                                 m_Prefix+"A7_1", Sec_Accounts.Acc + " " + GetAccName(), null,
                                 m_Prefix+"A8_1"+WithApp(), In, null,
                                 m_Prefix+"A9_1"+WithApp(), Sec_Accounts.Sum, null,
                                 m_Prefix+"A10_1"+WithApp(),Out, null
                                  );
           else
              PrintTableLine( m_Prefix+"A6_1", Sec_Accounts.AvrKindName + " á¥à¨ï " + Sec_Accounts.BCSeries + " N " + Sec_Accounts.BCNumber + " " + Sec_Accounts.IssuerName, null,
                                 m_Prefix+"A7_1", Sec_Accounts.Acc + " " + GetAccName(), null,
                                 m_Prefix+"A8_1"+WithApp(), In, null,
                                 m_Prefix+"A9_1"+WithApp(), Sec_Accounts.Sum, null,
                                 m_Prefix+"A10_1"+WithApp(),Out, null
                                  );
           end;
       end;
    else
        if( Sec_Accounts.IsEmissive == SET_CHAR )
           Out = GetRestOut( Sec_Accounts.Sum, In );
           GetOperationKindAndCode(@OperKind, @OperCode);
           PrintTableLine( m_Prefix+"A1", Sec_Accounts.OperationName, null,
                                 m_Prefix+"A2", OperKind, null,
                                 m_Prefix+"A3", OperCode, null,
                                 m_Prefix+"A4", GetFirstDoc( Sec_Accounts.GroundKind), null,
                                 m_Prefix+"A5", Sec_Accounts.GroundNum, null,
                                 m_Prefix+"A6"+WithApp(), GetPositivRest( In ), null,
                                 m_Prefix+"A7"+WithApp(), GetAbsRest( In ), null,
                                 m_Prefix+"A8"+WithApp(), Sec_Accounts.Sum, null,
                                 m_Prefix+"A9"+WithApp(), GetAbsRest(Out), null,
                                 m_Prefix+"A10"+WithApp(),GetPositivRest(Out), null
                                  );
        else
           if( Sec_Accounts.Acc == Sec_Accounts.DebAcc ) 
              Out = In - Sec_Accounts.Sum;/*§ ç¨á«¥­¨¥*/
           else
              Out = In + Sec_Accounts.Sum;/*á¯¨á ­¨¥*/
           end;                

           if(PrevDealCode!=Sec_Accounts.DealCode)
              PrintTableLine( m_Prefix+"A1_1", Sec_Accounts.OperationName, null,
                                 m_Prefix+"A2_1", Sec_Accounts.OprName, null,
                                 m_Prefix+"A3_1", Sec_Accounts.DealCode, null,
                                 m_Prefix+"A4_1", GetFirstDoc( Sec_Accounts.GroundKind), null,
                                 m_Prefix+"A5_1", Sec_Accounts.GroundNum, null,
                                 m_Prefix+"A6_1", Sec_Accounts.AvrKindName + " á¥à¨ï " + Sec_Accounts.BCSeries + " N " + Sec_Accounts.BCNumber + " " + Sec_Accounts.IssuerName, null,
                                 m_Prefix+"A7_1", Sec_Accounts.Acc + " " + GetAccName(), null,
                                 m_Prefix+"A8_1"+WithApp(), In, null,
                                 m_Prefix+"A9_1", 0, null,
                                 m_Prefix+"A10_1"+WithApp(), Sec_Accounts.Sum, null,
                                 m_Prefix+"A11_1",0, null,
                                 m_Prefix+"A12_1"+WithApp(),Out, null
                                  );
           else
              PrintTableLine( m_Prefix+"A6_1", Sec_Accounts.AvrKindName + " á¥à¨ï " + Sec_Accounts.BCSeries + " N " + Sec_Accounts.BCNumber + " " + Sec_Accounts.IssuerName, null,
                                 m_Prefix+"A7_1", Sec_Accounts.Acc + " " + GetAccName(), null,
                                 m_Prefix+"A8_1"+WithApp(), In, null,
                                 m_Prefix+"A9_1", 0, null,
                                 m_Prefix+"A10_1"+WithApp(), Sec_Accounts.Sum, null,
                                 m_Prefix+"A11_1",0, null,
                                 m_Prefix+"A12_1"+WithApp(),Out, null
                                  );
           end;
        end;
    end;
  END;


  PRIVATE MACRO PrintMode():INTEGER
     if( m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_TO_EXEL ) == SET_CHAR )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
    m_DepartmentID              = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_DEPARTMENT );
    m_Emiss                     = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_EMISS );
    m_NotEmiss                  = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_NOT_EMISS );
    m_BeginDate                 = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_BEGINDATE );
    m_EndDate                   = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_FINISHDATE );

    m_IsOFBU                    = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_OFBU );
    m_ClientCode                = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CLIENT_CODE );
    m_Name                      = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CLIENT_CODE_NAME );
    m_Contract1                 = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CONTRACT_1 );
    m_Contract1Date             = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CONTRACT_1_DATE );

    m_IsSeparatelyDate          = TS_IIF(m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SEPARATELY_DATE )==SET_CHAR,true,false);
    m_IsSAccounts_Report        = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SECUR_ACCOUNTS_REP );
    m_AccountingPlace           = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_ACCOUNTING_PLACE );
    m_Issuer_1                  = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_ISSUER_1 );
    m_SecurKind_1               = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SECUR_KIND_1 );
    m_SecurIssue                = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SECUR_ISSUE );
    m_IsCL_SAccounts_Report     = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CL_S_ACOOUNTS_REP );
    m_ClientID                  = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CLIENT );
    m_ContractID                = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CONTRACT_2 );
    m_Issuer_2                  = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_ISSUER_2 );
    m_SecurKind_2               = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SECUR_KIND_2 );
    m_SecurCode                 = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SECUR_CODE );
    m_IsUseOpostrofs            = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_WITH_APOSTROFS );
    m_IsExportToExel            = m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_TO_EXEL );

    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

   /*’¥«® ®âç¥â */                                                                                
   macro AdditionalQuery():string                                                                 
       var sqlQuery =  "      AND (SELECT COUNT (1) "+                                            
                     "             FROM dacctrn_dbt acctrn "+                                      
                     "            WHERE acctrn.t_AccTrnID = inacc.t_AccTrnID "+
                     "              AND acctrn.t_State = 1 ) > 0 ";            
                                                                                                  
        sqlQuery = sqlQuery + "  AND sf.t_id = acc.t_clientcontrid " +                            
                              "  AND sf.t_ServKind = " + string(PTSK_TRUST);                      
                                                                                                  
        if( m_DepartmentID != ALL_ITEM )                                                          
           sqlQuery = sqlQuery + " AND acc.t_DepartmentID = " + String( m_DepartmentID );         
        end;                                                                                          
                                                                                                  
        if( m_KindRep == REP_KIND_CLNT )                                                          
           if( m_IsOFBU == SET_CHAR )                                                             
             sqlQuery = sqlQuery + "AND sf.t_ServKindSub = " + string(PTSKS_TRUST_OFBU);                 
           end;                                                                                          
           if( m_ClientCode != ALL_ITEM )                                                         
               sqlQuery = sqlQuery + "AND acc.t_Owner = " + String( m_ClientCode );               
           end;                                                                                          
           if( m_AccountingPlace != ALL_ITEM )                                                    
             sqlQuery = sqlQuery + "AND acc.t_Place = " + String( m_AccountingPlace );            
           end;                                                                                          
           if( m_SecurIssue != ALL_ITEM )                                                         
             sqlQuery = sqlQuery + "AND fin.T_FIID = " + String( m_SecurIssue );                  
           end;                                                                                          
           if( m_Issuer_1 != ALL_ITEM )                                                           
             sqlQuery = sqlQuery + "AND party.T_PARTYID = " + String( m_Issuer_1 );               
           end;                                                                                          
           if( m_SecurKind_1 != ALL_ITEM )                                                        
             sqlQuery = sqlQuery + " AND RSB_FIInstr.FI_AvrKindsEQ("+string(FIKIND_AVOIRISS)+","+ 
                                   String( m_SecurKind_1 )+",fin.t_AvoirKind) = 1 ";              
           end;                                                                                          
           if( m_Contract1 != ALL_ITEM )                                                          
               sqlQuery = sqlQuery + " AND acc.t_Clientcontrid = " + String( m_Contract1 );       
           end;                                                                                          
        else                                                                                      
           if( m_ContractID != ALL_ITEM )/* ¯¥à¥¤ ¥âáï ID ˆ„„“*/                                  
               sqlQuery = sqlQuery + " AND acc.t_clientcontrid =  " + String( m_ContractID );     
           end;                                                                                          
           if( m_ClientID != ALL_ITEM )                                                           
               sqlQuery = sqlQuery + " AND acc.t_Owner = " + String( m_ClientID );                
           end;                                                                                          
           if( m_SecurCode != ALL_ITEM )                                                          
             sqlQuery = sqlQuery + " AND fin.T_FIID = " + String( m_SecurCode );                  
           end;                                                                                          
           if( m_Issuer_2 != ALL_ITEM )                                                           
             sqlQuery = sqlQuery + " AND party.T_PARTYID = " + String( m_Issuer_2 );              
           end;                                                                                          
           if( m_SecurKind_2 != ALL_ITEM )                                                        
             sqlQuery = sqlQuery + " AND RSB_FIInstr.FI_AvrKindsEQ("+string(FIKIND_AVOIRISS)+","+ 
                                   String( m_SecurKind_2 )+",fin.t_AvoirKind) = 1 ";              
           end;                                                                                          
        end;                                                                                      
                                                                                                  
     return sqlQuery;                                                                             
   end;                                                                                           

   macro GetAccountsVA()                                                                                                                   
      var sqlQuery, categ;                                                                                                                 
                                                                                                                                           
      if( m_KindRep == REP_KIND_CLNT )                                                                                                     
         categ = 561;                                                                                                                      
      else                                                                                                                                 
         categ = 581;                                                                                                                      
      end;                                                                                                                                 
                                                                                                                                           
      sqlQuery =                                                                                                                           
           " SELECT   acc.t_account acc, inacc.t_debacc debacc, acc.t_departmentid depid, "+                                               
           "          acc.t_owner owner, acc.t_Place Place, acc.t_fiid fiid, "+                                                            
           "          acc.t_clientcontrid clientcontrid, acc.t_currency currency, "+                                                       
           "          inacc.t_opertype opertype, inacc.t_dealkind dealkind, "+                                                             
           "          inacc.t_date prodate, inacc.t_groundkind, inacc.t_groundnum, "+                                                      
           "          inacc.t_documentkind dockind, inacc.t_documentid docid, "+                                                           
           "          inacc.t_sum SUM, pt.t_shortname AS departmentname, lvalues.t_name operationname, party.t_shortname issuername, " +   
           "          avrk.t_name AS AvrKindName, avrk.t_IsEmissive IsEmissive, " +                                                        
           "          '' as DealNumber, '' as ISSUE, '' as SERIES, '' as TRANCHE, '' as AvrCode, '' as AvrName, " +                        
           "          opr.t_name AS oprname, tk.t_dealcode, tk.t_dealid dealid, fin.t_fi_code, "+                                          
           "          bnr.t_bcseries, TRIM (bnr.t_bcnumber) AS bcnumber "+                                                                 
           "     FROM ddlinacc_dbt inacc, "+                                                                                               
           "          dparty_dbt party, "+                                                                                                 
           "          dllvalues_dbt lvalues, "+                                                                                            
           "          ddp_dep_dbt dp, "+                                                                                                   
           "          dparty_dbt pt, "+                                                                                                    
           "          dvsbanner_dbt bnr, "+                                                                                                
           "          ddl_tick_dbt tk, "+                                                                                                  
           "          doprkoper_dbt opr, "+                                                                                                
           "          dfininstr_dbt fin, "+                                                                                                
           "          davrkinds_dbt avrk, "+                                                                                               
           "          doprdocs_dbt doc, "+                                                                                                 
           "          doproper_dbt oproper, "+                                                                                             
           "          (SELECT DISTINCT acc.t_account, acc.t_departmentid, acc.t_owner, "+                                                  
           "                           acc.t_fiid, acc.t_clientcontrid, acc.t_currency, "+                                                 
           "                           acc.t_chapter, acc.t_Place "+                                                                       
           "                      FROM dmcaccdoc_dbt acc "+                                                                                
           "                     WHERE acc.t_catnum = "+string(categ)+") acc, dsfcontr_dbt sf "+                                           
           "    WHERE (   (inacc.t_debacc = acc.t_account) "+                                                                              
           "           OR (inacc.t_kredacc = acc.t_account) "+                                                                             
           "          ) "+                                                                                                                 
           "      AND inacc.t_dealkind = 164 "+                                                                                            
           "      AND bnr.t_bcid = inacc.t_documentid "+                                                                                   
           "      AND bnr.t_issuer NOT IN (SELECT t_partyid "+                                                                             
           "                                 FROM ddp_dep_dbt) "+                                                                          
           "      AND party.t_partyid = bnr.t_issuer "+                                                                                    
           "      AND bnr.t_Issuer NOT IN (select t_PartyID from ddp_dep_dbt) "+                                                           
           "      AND party.t_PartyID = bnr.t_Issuer "+                                                                                    
           "      AND doc.t_dockind = "+ DLDOC_CARRY +                                                                                     
           "      AND inacc.t_AccTrnID = doc.t_AccTrnID "+                                                  
           "      AND oproper.t_id_operation = doc.t_id_operation "+                                                                       
           "      AND LTRIM (TO_CHAR (tk.t_dealid, '0000000000000000000000000000000000')) = "+                                             
           "                                                           oproper.t_documentid "+                                             
           "      AND tk.t_bofficekind = oproper.t_dockind "+                                                                              
           "      AND opr.t_kind_operation = tk.t_dealtype "+                                                                              
           "      AND fin.t_fiid = bnr.t_fiid "+                                                                                           
           "      AND avrk.t_fi_kind = fin.t_fi_kind "+                                                                                    
           "      AND avrk.t_avoirkind = fin.t_avoirkind "+                                                                                
           "      AND lvalues.t_list = "+ OBJTYPE_CALCOPKIND +                                                                             
           "      AND lvalues.t_element = inacc.t_opertype "+                                                                              
           "      AND inacc.t_Date <= " + GetSQLDate(m_EndDate) +                                                                          
           "      AND inacc.t_Date >= " + GetSQLDate(m_BeginDate) +                                                                        
           "      AND dp.t_code = acc.t_departmentid "+                                                                                    
           "      AND pt.t_partyid = dp.t_partyid " + AdditionalQuery() +                                                                  
           " UNION "+                                                                                                                      
           " SELECT   acc.t_account acc, inacc.t_debacc debacc, acc.t_departmentid depid, "+                                               
           "          acc.t_owner owner, acc.t_Place Place, acc.t_fiid fiid, "+                                                            
           "          acc.t_clientcontrid clientcontrid, acc.t_currency currency, "+                                                       
           "          inacc.t_opertype opertype, inacc.t_dealkind dealkind, "+                                                             
           "          inacc.t_date prodate, inacc.t_groundkind, inacc.t_groundnum, "+                                                      
           "          inacc.t_documentkind dockind, inacc.t_documentid docid, "+                                                           
           "          inacc.t_sum SUM, pt.t_shortname AS departmentname, lvalues.t_name operationname, party.t_shortname issuername, "+    
           "          avrk.t_name AS AvrKindName, avrk.t_IsEmissive IsEmissive, " +                                                        
           "          '' as DealNumber, '' as ISSUE, '' as SERIES, '' as TRANCHE, '' as AvrCode, '' as AvrName, " +                        
           "          (case when req.t_Direction = 0 THEN '‚¢®¤ ª ¯¨â « ' ELSE '‚ë¢®¤ ª ¯¨â « ' END) AS oprname, "+                        
           "          tk.t_dealcode, tk.t_dealid dealid, fin.t_fi_code, "+                                                                 
           "          bnr.t_bcseries, TRIM (bnr.t_bcnumber) AS bcnumber "+                                                                 
           "     FROM ddlinacc_dbt inacc, "+                                                                                               
           "          dparty_dbt party, "+                                                                                                 
           "          dllvalues_dbt lvalues, "+                                                                                            
           "          ddp_dep_dbt dp, "+                                                                                                   
           "          dparty_dbt pt, "+                                                                                                    
           "          dvsbanner_dbt bnr, "+                                                                                                
           "          ddl_tick_dbt tk, "+                                                                                                  
           "          doprkoper_dbt opr, "+                                                                                                
           "          dfininstr_dbt fin, "+                                                                                                
           "          davrkinds_dbt avrk, "+                                                                                               
           "          dtsreqassets_dbt ass, "+                                                                                             
           "          dtsiorqst_dbt req, "+                                                                                                
           "          (SELECT DISTINCT acc.t_account, acc.t_departmentid, acc.t_owner, "+                                                  
           "                           acc.t_fiid, acc.t_clientcontrid, acc.t_currency, "+                                                 
           "                           acc.t_chapter, acc.t_Place "+                                                                       
           "                      FROM dmcaccdoc_dbt acc "+                                                                                
           "                     WHERE acc.t_catnum = "+string(categ)+") acc, "+                                                           
           "          dsfcontr_dbt sf "+                                                                                                   
           "    WHERE (   (inacc.t_debacc = acc.t_account) "+                                                                              
           "           OR (inacc.t_kredacc = acc.t_account) "+                                                                             
           "          ) "+                                                                                                                 
           "      AND inacc.t_dealkind = 912 "+                                                                                            
           "      AND ass.t_ID = inacc.t_documentid "+                                                                                     
           "      AND bnr.t_bcid = ass.t_VSBannerID "+                                                                                     
           "      AND bnr.t_issuer NOT IN (SELECT t_partyid "+                                                                             
           "                                 FROM ddp_dep_dbt) "+                                                                          
           "      AND party.t_partyid = bnr.t_issuer "+                                                                                    
           "      AND bnr.t_Issuer NOT IN (select t_PartyID from ddp_dep_dbt) "+                                                           
           "      AND party.t_PartyID = bnr.t_Issuer "+                                                                                    
           "      AND tk.t_RequestID = ass.t_RequestID "+                                                                                  
           "      AND req.t_ID = tk.t_RequestID "+                                                                                         
           "      AND opr.t_kind_operation = tk.t_dealtype "+                                                                              
           "      AND fin.t_fiid = bnr.t_fiid "+                                                                                           
           "      AND avrk.t_fi_kind = fin.t_fi_kind "+                                                                                    
           "      AND avrk.t_avoirkind = fin.t_avoirkind "+                                                                                
           "      AND lvalues.t_list = "+ OBJTYPE_CALCOPKIND +                                                                             
           "      AND lvalues.t_element = inacc.t_opertype "+                                                                              
           "      AND inacc.t_Date <= " + GetSQLDate(m_EndDate) +                                                                          
           "      AND inacc.t_Date >= " + GetSQLDate(m_BeginDate) +                                                                        
           "      AND dp.t_code = acc.t_departmentid "+                                                                                    
           "      AND pt.t_partyid = dp.t_partyid " + AdditionalQuery();                                                                   
      return sqlQuery;                                                                                                                     
   end;                                                                                                                                    

   macro GetAccounts()                                                                                                                      
      var sqlQuery, categ;                                                                                                                  
                                                                                                                                            
      if( m_KindRep == REP_KIND_CLNT )                                                                                                      
         categ = 560;                                                                                                                       
      else                                                                                                                                  
         categ = 580;                                                                                                                       
      end;                                                                                                                                  
                                                                                                                                            
      sqlQuery = " SELECT acc.t_Account Acc, inacc.t_DebAcc DebAcc, acc.t_DepartmentID DepID, acc.t_Owner Owner, " +                        
       "        acc.t_Place Place, acc.t_Fiid Fiid, acc.t_Clientcontrid Clientcontrid, acc.t_Currency Currency, " +                         
       "        inacc.t_Opertype Opertype, inacc.t_DealKind DealKind, " +                                                                   
       "        inacc.t_Date ProDate,  inacc.t_GroundKind, inacc.t_GroundNum," +                                                            
       "        inacc.t_DocumentKind DocKind, inacc.t_DocumentID DocID, inacc.t_Sum Sum, pt.t_ShortName as DepartmentName, " +              
       "        lvalues.T_NAME OperationName, party.T_SHORTNAME IssuerName, avrkind.T_Name AvrKindName, avrkind.t_IsEmissive IsEmissive, " +
       "        utl_raw.cast_to_varchar2(dbms_lob.substr(inacc.t_FmtBlobData_XXXX,2000)) DealNumber, " +                                    
       "        avr.T_ISSUE ISSUE, avr.T_SERIES SERIES, avr.T_TRANCHE TRANCHE, " +                                                          
       "        fin.T_FI_CODE AvrCode, fin.T_NAME AvrName, " +                                                                              
       "        '' as oprname, '' as dealcode, 0 as dealid, '' as fi_code, " +                                                              
       "        '' as bcseries, '' as bcnumber " +                                                                                          
       " FROM   ddlinacc_dbt inacc, davoiriss_dbt avr, dfininstr_dbt fin, " +                                                               
       "        davrkinds_dbt avrkind, dparty_dbt party, dllvalues_dbt lvalues, ddp_dep_dbt dp, dparty_dbt pt, " +                          
       "        (SELECT acc.t_Account, acc.t_DepartmentID, acc.t_Place, " +                                                                 
                   "                acc.t_Owner, acc.t_Fiid, acc.t_Clientcontrid, acc.t_Currency " +                                        
                   "        FROM   dmcaccdoc_dbt acc " +                                                                                    
                   "        WHERE acc.t_CatNum = " + string(categ) +                                                                        
                   "          AND  acc.t_Chapter = 22 " +                                                                                   
                   "        GROUP BY acc.t_DepartmentID, acc.t_Owner, acc.t_Place, acc.t_Fiid, acc.t_Account, " +                           
       "        acc.t_Clientcontrid, acc.t_Currency) acc, dsfcontr_dbt sf " +                                                               
       " WHERE ((inacc.t_DebAcc = acc.t_Account) or (inacc.t_KredAcc = acc.t_Account)) " +                                                  
       "        AND inacc.t_DealKind in (131,117,176,945,138,159) "  +                                                                      
       "        AND avr.T_FIID = fin.T_FIID " +                                                                                             
       "  AND avrkind.T_AVOIRKIND = fin.T_AVOIRKIND " +                                                                                     
                   "        AND party.T_PARTYID = fin.T_ISSUER " +                                                                          
       "        AND avrkind.T_FI_KIND = " + string(FIKIND_AVOIRISS) +                                                                       
       "        AND avr.T_FIID = acc.t_Fiid " +                                                                                             
       "  AND lvalues.T_LIST = " + OBJTYPE_CALCOPKIND + ""                                                                                  
       "        AND lvalues.T_ELEMENT = inacc.t_Opertype " +                                                                                
       "        AND inacc.t_Date <=" + GetSQLDate(m_EndDate) +                                                                              
       "        AND inacc.t_Date >=" + GetSQLDate(m_BeginDate) +                                                                            
       "  AND dp.t_Code = acc.t_DepartmentID " +                                                                                            
       "  AND pt.t_PartyID = dp.t_PartyID " + AdditionalQuery();                                                                            
                                                                                                                                            
        if( (m_Emiss == SET_CHAR) AND (m_NotEmiss == SET_CHAR) )                                                                            
           sqlQuery = "select * from ("+sqlQuery+"union"+GetAccountsVA()+")";                                                               
        elif( m_Emiss == SET_CHAR )                                                                                                         
           sqlQuery = "select * from ("+sqlQuery+")";                                                                                       
        else                                                                                                                                
           sqlQuery = "select * from ("+GetAccountsVA()+")";                                                                                
        end;                                                                                                                                
                                                                                                                                            
        if( m_IsSeparatelyDate == "X" )                                                                                                     
           sqlQuery = sqlQuery + "ORDER BY DepID, ProDate, Owner, IsEmissive, DealID, FIID, Acc, DebAcc;";                                  
        else                                                                                                                                
          sqlQuery = sqlQuery + "ORDER BY DepID, Owner, IsEmissive, DealID, FIID, Acc, ProDate, DebAcc;";                                   
        end;                                                                                                                                
                                                                                                                                            
        Sec_Accounts = TRsbDataSet( sqlQuery );                                                                                             
                                                                                                                                            
        if( Sec_Accounts.MoveNext() )                                                                                                       
           return true;                                                                                                                     
        else                                                                                                                                
           return false;                                                                                                                    
        end;                                                                                                                                
   end;                                                                                                                                     

  MACRO ExcRep()                                                                                    
    var PreDepartment = "";                                                                                                    
    var PreClient = "";
    var prevcontr = "";
    var PreFIID = "";                                                                                                      
    var PreAccount = "";                                                                                                       
    var PreProDate;                                                                                                            
    var PreDealCode = "";                                                                                                      
    var PreEmiss = "";
    var IsNotEof = false;                                                                                                     
    var In = 0, Out = 0, Count = 0;                                                                                            
    var m_IsExistsData = false;

    macro PrintEmiss()
       PrintKindEmissive();
       PreEmiss = Sec_Accounts.IsEmissive;
       if( Sec_Accounts.IsEmissive != SET_CHAR )
          CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"TableHeader1", 1 );
          RegisterRepTable();
       end;
    end;

    macro PrintEmissAvr()
       if( Sec_Accounts.IsEmissive == SET_CHAR )
           PreFIID = Sec_Accounts.FIID;
           PrintAvr();
       end;
    end;

    macro PrintAcc()
       if( Sec_Accounts.IsEmissive == SET_CHAR )
          PreAccount = Sec_Accounts.Acc;
          PrintFormatString( "‹¨æ¥¢®© áç¥â #\n",
                                m_Prefix+"H6", Sec_Accounts.Acc+" "+GetAccName()
                              );
          CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"TableHeader", 1 );
          RegisterRepTable();

          In = GetRest( Sec_Accounts.ProDate );
       end;
    end;

    macro PrintClnt()
       PrintHeadClnt();
       PreClient = Sec_Accounts.Owner;
       prevcontr = Sec_Accounts.Clientcontrid;
    end;

    macro PrintDep()
       if( m_IsFirstPrint == false )
          AddStandardFooter( m_Prefix );
          CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Footer", 1 );
       end;
       PrintHeadDep();
       PreDepartment = Sec_Accounts.DepID;
    end;

    macro PrintOprDate()
       if( m_KindRep == REP_KIND_CLNT )                                                          
          if( Sec_Accounts.IsEmissive == SET_CHAR )                                              
             Merge( m_Prefix+"A1", m_Prefix+"A8", null);                                         
          else                                                                                   
             Merge( m_Prefix+"A1_1", m_Prefix+"A10_1", null);                                        
          end;                                                                                   
       else                                                                                      
          if( Sec_Accounts.IsEmissive == SET_CHAR )                                              
             Merge( m_Prefix+"A1", m_Prefix+"A10", null);                                        
          else                                                                                   
             Merge( m_Prefix+"A1_1", m_Prefix+"A12_1", null);                                        
          end;                                                                                   
       end;
       
       if( Sec_Accounts.IsEmissive == SET_CHAR )                                                                        
           PrintTableLine( m_Prefix+"A1", Date(Sec_Accounts.ProDate), null ); 
       else
           PrintTableLine( m_Prefix+"A1_1", Date(Sec_Accounts.ProDate), null ); 
       end;
    end;
                                                                                                                           
    if( GetAccounts() != false )                                                                                     
        m_IsFirstPrint = true; 
        m_CurDate = Date(0,0,0);
        IsNotEof = true;                                                                                                       
        InitProgressBar(  Sec_Accounts.GetRecCount(), "Žâç¥â: ¥£¨áâà ¢­ãâà¥­­¥£® ãç¥â  æ¥­­ëå ¡ã¬ £",                         
                       "”®à¬¨à®¢ ­¨¥ ®âç¥â  " + m_SheetName );                                                                     
        while( IsNotEof ) 
           if( (m_IsSeparatelyDate AND (m_CurDate != Date(Sec_Accounts.ProDate))) OR           
               (PreDepartment != Sec_Accounts.DepID)                                           
             )                                                                                 
              EndRepTable();                                                                   
              PrintDep();                                                                      
              PrintClnt();                                                                     
              PrintEmiss();                                                                    
              PrintEmissAvr();                                                                 
              PrintAcc();                                                                      
           end;                                                                                
                                                                                               
           if( (PreClient != Sec_Accounts.Owner) OR (prevcontr != Sec_Accounts.Clientcontrid) )
              EndRepTable();                                                                      
              PrintClnt();                                                                     
              PrintEmiss();                                                                    
              PrintEmissAvr();                                                                 
              PrintAcc();
              if( not m_IsSeparatelyDate)                                                      
                 m_CurDate = Date(0,0,0);                                                               
              end;
           end;                                                                                
                                                                                               
           if( PreEmiss != Sec_Accounts.IsEmissive )                                           
              EndRepTable();                                                                      
              PrintEmiss();
              PrintEmissAvr();                                                                 
              PrintAcc();
              if( not m_IsSeparatelyDate)                                                      
                 m_CurDate = Date(0,0,0);                                                               
              end;
           end;                                                                                
           
           if( Sec_Accounts.IsEmissive == SET_CHAR )                                                                         
              if( PreFIID != Sec_Accounts.FIID )                                        
                 EndRepTable();                                                                   
                 PrintEmissAvr();                                                              
                 PrintAcc();
                 if( not m_IsSeparatelyDate)                                                      
                    m_CurDate = Date(0,0,0);                                                               
                 end;
              end;                                                                             
                                                                                               
              if( PreAccount != Sec_Accounts.Acc )                                     
                 EndRepTable();                                                                   
                 PrintAcc();
                 if( not m_IsSeparatelyDate)                                                      
                    m_CurDate = Date(0,0,0);                                                               
                 end;
              end;
           else
              if( PreAccount != Sec_Accounts.Acc )
                 PreAccount = Sec_Accounts.Acc;
                 In = GetRestVA( Sec_Accounts.ProDate );
              end;
           end;
                                                                                    
           if( not m_IsSeparatelyDate)                                                         
              if( m_CurDate != Date(Sec_Accounts.ProDate) )                                    
                 PrintOprDate();                                                               
              end;                                                                             
           end;                                                                                
                                                                                               
           PrintRepTableLine(In,@Out,PreDealCode);                                             
                                                                                               
           In = Out;                                                                           
           m_CurDate = Date(Sec_Accounts.ProDate);                                   
           PreDealCode = Sec_Accounts.DealCode;                                                
           m_IsExistsData = true; 
           IsNotEof = Sec_Accounts.MoveNext();
           UseProgressBar(Count=Count+1);
       end;
       RemProgressBar();
    end;

    if(m_IsExistsData)
       EndRepTable();
       AddStandardFooter( m_Prefix );
       CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Footer", 1 );
    end;

    if(not m_IsExistsData)
       PrintFormatString( "#\n", m_Prefix+"NoRepData", "¥â ¤ ­­ëå ¤«ï ä®à¬¨à®¢ ­¨ï ®âç¥â " );
       CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"NoRepData", 0 );
    end;

  END;                                                                                                                         

  PRIVATE MACRO ExecuteReport( KindRep:integer )
    m_KindRep = KindRep;
    if( m_KindRep == REP_KIND_CLNT )
       m_SheetName = "‘ç¥â  ãç¥â  –";
       m_Prefix = "N1_";

    else
       m_SheetName = "‘ç¥â  à áç¥â®¢ á ª«¨¥­â ¬¨";
       m_Prefix = "N2_";
    end;
    UseNewSheetInTotalBook();
    SetActiveSheet( m_SheetName );

    ExcRep();
  END;

  PRIVATE MACRO Create()
    if( m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_SECUR_ACCOUNTS_REP ) == SET_CHAR )
       ExecuteReport( REP_KIND_CLNT );
    end; 
    if( m_Form.GetFieldValue( PNFLD_INACCTRUST_REG_CL_S_ACOOUNTS_REP ) == SET_CHAR )
       ExecuteReport( REP_KIND_CALC );
    end;
  END;
  
  initDL_CReportTemplate( DL_AccountsReg_Panel(), "Report_TsRegAvr.xls" );
END;

TS_RegAvr_Report().Run();
Exit(1);
