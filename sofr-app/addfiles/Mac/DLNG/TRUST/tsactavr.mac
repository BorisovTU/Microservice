/*******************************************************************************
 DESCRIPTION  :   сверки наличия ценных бумаг (ДУ) - форма
 PROGRAMMED BY:   Nikolskaya V.
 CREATION DATE:   03.12.2009
*******************************************************************************/
import "tsactavr_form.mac", "tssec.mac";

PRIVATE CONST KIND_AVR_EMISS     = 1,
              KIND_AVR_NOTEMISS  = 2;

PRIVATE CONST KIND_REP_ALL       = 0,
              KIND_REP_EMISS     = 1,
              KIND_REP_NOTEMISS  = 2;

PRIVATE CONST PTSK_TRUST = 17; //доверительное управление

PRIVATE CONST PTSKS_TRUST_OFBU   = 1; //ДОГОВОР ОФБУ
PRIVATE CONST PTSKS_TRUST_IDDU   = 3; //ДОГОВОР ИДДУ
private const SIDEBALANCE_PASSIVE  = 2;  /* пассивный     */

PRIVATE VAR ReportHeader = 
"Филиал: #################### \n"+                         
"          АКТ О ПРОВЕДЕНИИ СВЕРКИ НАЛИЧИЯ ############# ЦЕННЫХ БУМАГ\n"                            
"                    по состоянию на ############\n"+              
"                Ценные бумаги доверительного управляющего\n";                               

PRIVATE VAR TableHeader = 
" ┌────────────┬──────────┬───────────┬──────────┬───────┬───────┬──────────────────┬───────────────────┬──────────────────┬────────────────────┬──────────────────────┬─────────────────────┬────────────────────┐\n"+
" │   Код ц/б  │ Вид ц/б  │  Эмитент  │  Выпуск  │ Серия │ Номер │ Номер л/счета ВУ │ Остаток по данным │ Остаток по данным│ Остаток по данным  │  Расхождение данных  │  Расхождение данных │Причина расхождения │\n"+
" │            │          │           │          │       │       │                  │ внутреннего       │ депозитарного    │ доверительного     │  внутреннего и       │  учетной системы и  │                    │\n"+
" │            │          │           │          │       │       │                  │ учета, шт.        │ учета, шт.       │ управления, шт.    │  депозитарного       │  депозитарного      │                    │\n"+
" │            │          │           │          │       │       │                  │                   │                  │                    │  учета               │  учета              │                    │\n"+
" ├────────────┼──────────┼───────────┼──────────┼───────┼───────┼──────────────────┼───────────────────┼──────────────────┼────────────────────┼──────────────────────┼─────────────────────┼────────────────────┤";


PRIVATE VAR Footer = 
"Сотрудник, ответственный за\n"+               
"ведение внутреннего учета:\n"+             
"__________________                     ___________________  ####################\n"+  
"    (должность)                             (подпись)           (фамилия)\n\n"+   
"Сотрудник Службы внутреннего контроля:\n"+             
"________________________                     ___________________  /__________________/\n"+ 
"    (должность)                                   (подпись)             (фамилия)\n";

PRIVATE VAR ClientHeader = "#\n";

PRIVATE CLASS TS_RegMoney_Money( Report:OBJECT, KindRep:integer )
  VAR m_Report = Report, m_KindRep = KindRep, m_SheetName = "Акт сверки", m_Prefix = "N1_",
      m_CurDate = Date(0,0,0), m_IsFirstPrint = true;
  VAR m_IsExistsData = false;

  MACRO WithApp()
     return TS_IIF(m_Report.m_WithApp,":a","");
  END;

  MACRO PrintHeadDep()
    m_Report.PrintFormatString( ReportHeader,
                                m_Prefix+"H1", m_Report.Department(),
                                m_Prefix+"H2", TS_IIF(m_KindRep==KIND_REP_ALL,"",
                             TS_IIF(m_KindRep==KIND_REP_EMISS,"ЭМИССИОННЫХ","НЕЭМИССИОННЫХ"))+" ЦЕННЫХ БУМАГ",
                                m_Prefix+"H3", DL_DateToStr(TS_IIF(m_Report.m_ForEveryDate,m_CurDate,m_Report.m_EndDate)+1)
                              );
    if( m_IsFirstPrint )
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Header", 0 );
       m_IsFirstPrint = false;
    else
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Header", 1 );
    end;
  END;

  MACRO RegisterTable()
    m_Report.PrintFormatString( ClientHeader,
                                m_Prefix+"H4", m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"TableHeader", 1 );
    m_Report.RegisterTable( m_Prefix+"MainTable", TableHeader,
                            m_Prefix+"A1",
                            m_Prefix+"A2",
                            m_Prefix+"A3",
                            m_Prefix+"A4",
                            m_Prefix+"A5",
                            m_Prefix+"A6",
                            m_Prefix+"A7",
                            m_Prefix+"A8",
                            m_Prefix+"A9",
                            m_Prefix+"A10",
                            m_Prefix+"A11",
                            m_Prefix+"A12",
                            m_Prefix+"A13"
                           );
  END;

  MACRO BeginReport()
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( m_SheetName );
  END;

  MACRO EndTable()
    if( m_IsFirstPrint == false )
       m_Report.EndTable();
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Report.GetTableRange(), 0 );
    end;
  END;

  MACRO PrintTableLine(AvrEmissKind:integer,RestInn:Money,RestDepo:Money,RestDU:Money)
    var FI_Code = "",Issuer = "",AvrKind = "",Issue = "",Series = "",VaNum = "";
    m_Report.ПолучитьПараметрыЦБ(AvrEmissKind,@FI_Code,@Issuer,@AvrKind,@Issue,@Series,@VaNum);

    m_Report.PrintTableLine( m_Prefix+"A1", FI_Code, null,
                             m_Prefix+"A2", AvrKind, null,
                             m_Prefix+"A3", Issuer, null,
                             m_Prefix+"A4", Issue, null,
                             m_Prefix+"A5", Series, null,
                             m_Prefix+"A6", VaNum, null,
                             m_Prefix+"A7", m_Report.m_RSD_FI.rec.Account, null,
                             m_Prefix+"A8"+WithApp(), Floor_Money(RestInn), null,
                             m_Prefix+"A9"+WithApp(), Floor_Money(RestDepo), null,
                             m_Prefix+"A10"+WithApp(), Floor_Money(RestDU), null,
                             m_Prefix+"A11"+WithApp(),Floor_Money(RestInn-RestDepo), null,
                             m_Prefix+"A12"+WithApp(),Floor_Money(RestDU-RestDepo), null,
                             m_Prefix+"A13","", null
                           );
  END;

  MACRO Execute() 
    var prevclient=-1, prevcontr=-1, prevdep=-1;
    var AvrKind = KIND_AVR_EMISS;

    macro PrintClnt()
       RegisterTable();
       prevclient = m_Report.m_RSD_TSORDER.rec.ClientID;
       prevcontr = m_Report.m_RSD_TSORDER.rec.SfContrID;
    end;

    macro PrintDep()
       if( m_IsFirstPrint == false )
          m_Report.PrintFormatString( Footer, m_Prefix+"F1",{Name_Oper});
          m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Footer", 1 );
       end;
       PrintHeadDep();
       prevdep = m_Report.m_RSD_TSORDER.rec.Dep;
    end;

    macro ClearPrevVal()
       prevclient=-1;
       prevcontr=-1;
       prevdep=-1;
    end;

    m_CurDate = m_Report.m_BeginDate;

    while( m_CurDate <= m_Report.m_EndDate )

       if( m_KindRep != KIND_REP_ALL ) 
          AvrKind = m_KindRep; 
       else
          AvrKind = KIND_AVR_EMISS;
       end;                            

       m_Report.TSOrderList(m_KindRep,m_CurDate,TS_IIF(m_Report.m_ForEveryDate,m_CurDate,m_Report.m_EndDate));
       while( m_Report.TSOrderNext(m_CurDate,TS_IIF(m_Report.m_ForEveryDate,m_CurDate,m_Report.m_EndDate),@AvrKind) )
          if( not m_Report.IsCirculeFI )
             continue;
          end;

          if( prevdep != m_Report.m_RSD_TSORDER.rec.Dep )
             EndTable();
             PrintDep();
             PrintClnt();
          end;

          if( (prevclient != m_Report.m_RSD_TSORDER.rec.ClientID) OR (prevcontr != m_Report.m_RSD_TSORDER.rec.SfContrID) )
             EndTable();
             PrintClnt();
          end;

          PrintTableLine(AvrKind,m_Report.ОстатокВУ(),m_Report.ОстатокДЕПО(),m_Report.ОстатокПоУчетСистДУ());
          m_IsExistsData = true;
       end;
       m_Report.TSOrderEnd();

       if( m_Report.m_ForEveryDate )
          m_CurDate = m_CurDate + 1;
       else
          m_CurDate = m_Report.m_EndDate+1;
       end;

       ClearPrevVal();
    end;

    if(m_IsExistsData)
       EndTable();
       m_Report.PrintFormatString( Footer, m_Prefix+"F1",{Name_Oper});
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"Footer", 1 );
    end;

    if(not m_IsExistsData)
       m_Report.PrintFormatString( ReportHeader, m_Prefix+"NoRepData", "Данных для формирования отчета, по заданным в фильтре параметрам, во внутреннем учете ДУ нет" );
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Prefix+"NoRepData", 0 );
    end;

  END;

  MACRO EndReport()
  END;

END;

/********************************************************************************
Общий класс отчета
********************************************************************************/
PRIVATE CLASS (DL_CReportTemplate) TS_ActAvr_Report
  VAR m_BeginDate, m_EndDate, m_Dprt, m_ForEveryDate, m_KindRep, m_CountAvr = 0;
  VAR rsd_ord, m_RSD_TSORDER, rsd_fi, m_RSD_FI, m_Count = 0, m_NumTsOrder, IsCirculeFI = false, IsCirculeTsOrder = false;

  VAR m_OFBU, m_ClientID, m_ClientContrID, m_AccWithNotMove, m_AvrKind, m_IssuerID, m_FIID, m_WithApp;

  MACRO Department()
    return DL_GetDepartmentNameByCode(m_Dprt);
  END;

  MACRO TSOrderString()
    var party = TRecHandler("party"), Name = "";
    if( m_RSD_TSORDER )
       if( not ПолучитьСубъекта(m_RSD_TSORDER.rec.ClientID, party) )
          Name = party.rec.Name;
       end;
       return TS_IIF(not m_OFBU,"Учредитель: ","ОФБУ: ") + Name + "," +
              TS_IIF(not m_OFBU," договор ДУ № "," общие условия ОФБУ № ") + m_RSD_TSORDER.rec.ContrNum;
    end;
    return "";
  END;
                        
  MACRO ПолучитьПараметрыЦБ(AvrEmissKind:integer,FI_Code:@String,Issuer:@String,AvrKind:@String,Issue:@String,Series:@string,VaNum:@string)
    RECORD RFininstr( fininstr );
    RECORD RAvoiriss( avoiriss );
    if( AvrEmissKind == KIND_AVR_EMISS )
       if( not ПолучитьФинИн( m_RSD_FI.rec.FIID, RFininstr, RAvoiriss ) )
          FI_Code = RFininstr.FI_Code;
          Issuer = ПолучитьКороткоеИмяСубъекта(RFininstr.Issuer);
          AvoirKindName( ToINT(RFininstr.AvoirKind), null, AvrKind );
          if( RAvoiriss.Issue != "" )
             Issue = "вып. " + string(RAvoiriss.Issue);
          end;
          if( RAvoiriss.Series != "" )
             Series = "сер. " + string(RAvoiriss.Series);
          end;
       else
          msgbox("Не могу получить финансовый инструмент с FIID = " +string(m_RSD_FI.rec.FIID));
       end;
    else
       if( not ПолучитьФинИн( m_RSD_FI.rec.FIID, RFininstr ) )
          FI_Code = RFininstr.FI_Code;
          AvoirKindName( ToINT(RFininstr.AvoirKind), null, AvrKind );
       else
          msgbox("Не могу получить финансовый инструмент с FIID = " +string(m_RSD_FI.rec.FIID));
       end;

       Issuer = ПолучитьКороткоеИмяСубъекта(m_RSD_FI.rec.IssuerID);
       if( m_RSD_FI.rec.BCSeries != "" )
          Series = "сер. " + string(m_RSD_FI.rec.BCSeries);
       end;
       VaNum = "№ " + m_RSD_FI.rec.BCNumber;
    end;
  END;                        

  private macro ПоСчетамВУ_ЭЦБ()                                                                                                         
                                                                                                                                       
     return " SELECT acc.t_Account, acc.FIID, " +                                                                             
            "        abs(rsb_account.restall(acc.t_account,22,acc.FIID,?)) InAccRest, " +                                                
            "        (case when (select count(1) from ddlinacc_dbt inacc " + /*есть ли проводки ВУ за период*/                                  
            "                     where (inacc.t_DebAcc = acc.t_Account or inacc.t_KredAcc = acc.t_Account) " +                                 
            "                       and inacc.t_FIID = acc.FIID " +                                                                       
            "                       and inacc.t_Date <= ? " +                                                                                   
            "                       and inacc.t_Date >= ? " +                                                                                   
            "                   ) > 0 " +                                                                                                       
            "              then 1 else 0 end) ExistsInAccCarry " +                                                                       
            "   FROM ( SELECT acc.t_Account, acc.t_Currency FIID " +                                                                       
            "            FROM dmcaccdoc_dbt acc, dmccateg_dbt categ, dfininstr_dbt fin " +                                               
            "           WHERE acc.t_CatID = categ.t_ID " +                                                                                      
            "             AND acc.T_DEPARTMENTID = ? " +                                                                                 
            "             AND acc.t_Chapter = 22 " +                                                                                            
            "             AND acc.t_ClientcontrID = ? " +                                                                                       
            "             AND categ.t_Code = ? " +                                                                                              
            "             AND categ.t_LevelType = 1 " +                                                                                         
            "           GROUP BY acc.t_Account, acc.t_Currency ) acc ";                                                                                         
                                                                                                                                       
  end;                                                                                                                                   
                                                                                                                                       
  private macro ПоСчетамВУ_Н_ЭЦБ()                                                                                                       
                                                                                                                                       
     return " SELECT acc.t_BCID BCID, acc.t_Account, " +                                                                                      
            "        abs(rsb_account.restall(acc.t_account,22,acc.FIID,?)) InAccRest, " +                                     
            "        (case when (select count(1) from ddlinacc_dbt inacc " + /*есть ли проводки ВУ за период*/                                  
            "                     where (inacc.t_DebAcc = acc.t_Account or inacc.t_KredAcc = acc.t_Account) " +                                 
            "                       and inacc.t_FIID = acc.FIID " +                                                                       
            "                       and inacc.t_Date <= ? " +                                                                                   
            "                       and inacc.t_Date >= ? " +                                                                                   
            "                   ) > 0 " +                                                                                                       
            "              then 1 else 0 end) ExistsInAccCarry " + 
            "  FROM ( SELECT acc.t_Account, bnr.t_BCID, acc.t_Currency FIID" +                                               
            "           FROM dmcaccdoc_dbt acc, dmccateg_dbt categ, dvsbanner_dbt bnr " +                                    
            "          WHERE acc.t_CatID = categ.t_ID " +                                                                                
            "            AND acc.T_DEPARTMENTID = ? " +                                                                                  
            "            AND acc.t_Chapter = 22 " +                                                                                      
            "            AND acc.t_ClientcontrID = ? " +                                                                                 
            "            AND rsb_bill.GetVABnrClientContrIDOnDate(bnr.t_BCID, ?) = acc.t_ClientcontrID " +                                     
            "            AND categ.t_Code = ? " +                                                                                        
            "            AND categ.t_LevelType = 1 " +                                                                                   
            "            AND bnr.t_BCID = " +                                                                                     
            "                    (case when acc.t_DocKind = 912 " + 
            "                          then NVL((select reqassets.t_VsBannerID "+
            "                                      from dtsreqassets_dbt reqassets " +
            "                                     where reqassets.t_id = acc.t_DocID ),0) " +
            "                          else acc.t_DocID end) " +                                                                   
            "          GROUP by acc.t_Account, bnr.t_BCID, acc.t_Currency) acc";                                                                                            
                                                                                                                                       
  end;                                                                                                                                   

  private macro ПоЛотамДУ()                                                                                                              
                                                                                                                                       
     return "SELECT t.T_FIID, rsb_pmwrtoff.WRTGetPortfolioAmount(?,t.t_FIID,?,?,-1,-1,?,1,0,0) DURest " + 
            "from ( select t.T_FIID" +                                                                                   
            "         FROM v_scwrthistex t, dfininstr_dbt fin " +                                                                               
            "        WHERE t.t_instance = (SELECT MAX (t_instance) " +                                                                          
            "                                FROM v_scwrthistex " +                                                                               
            "                               WHERE t_sumid = t.t_sumid " +                                                                         
            "                                 AND t_changedate <= ?) " +                                                                          
            "         AND t.T_DEPARTMENT = ? " +                                                                                               
            "         AND t.T_CONTRACT = ? " +
            "       group by t.T_FIID) t";                                                                                      
  end;                                                                                                                                   

  private macro УчтенВекс()                                                                                                              
                                                                                                                                     
     return " SELECT 1 as DURest, bnr.t_BCID BCID" +                                   
            "  FROM dvsbanner_dbt bnr " +                                                                             
            " WHERE rsb_bill.GetVABnrClientContrIDOnDate(bnr.t_BCID, ?) = ? " +                                          
            "   AND rsb_bill.GetVABnrStatusOnDate(bnr.t_BCID, ?) = ? " +                                                                 
            "   AND bnr.t_DEPARTMENT = ? ";                                                                                      
  end;                                                                                                                                   

  private macro ПоСчетамДЕПО_Н_ЭЦБ()                                                                                           

     return "select bnr.t_BCID BCID, " +
            "       DECODE(( select count(1) " +
            "           from dcertif_dbt cert, dvsbanner_dbt bnr_1 " +
            "          where cert.t_XID = bnr_1.t_inventoryxID " +
            "            and bnr_1.t_BCSeries = bnr.t_BCSeries " +
            "            and bnr_1.t_BCNumber = bnr.t_BCNumber" +
            "            and bnr_1.T_ISSUER = bnr.t_ISSUER " +
            "            and bnr_1.T_Department = bnr.t_Department " +
            "            and bnr_1.T_Holder = bnr.T_Holder " +
            "            and cert.t_Department = bnr.t_Department " +
            "            and rsb_depo.icstatus(cert.t_AutoKey, ?) = 0 ),0,0,1) as DEPOAccRest, " +
            "         (select count(1) " +
            "            from dcertchng_dbt ch, dvsbanner_dbt bnr_2  " +
            "           where ch.t_XID = bnr_2.t_inventoryxID " +
            "             and bnr_2.t_BCSeries = bnr.t_BCSeries " +                        
            "             and bnr_2.t_BCNumber = bnr.t_BCNumber" +                         
            "             and bnr_2.T_ISSUER = bnr.t_ISSUER " +                            
            "             and bnr_2.T_Department = bnr.t_Department " +                    
            "             and ch.T_ISSUERDATE = bnr_2.T_IssueDate " +
            "             and bnr_2.T_Holder = bnr.T_Holder " +
            "             and ch.t_Department = bnr.t_Department" +                        
            "             and ch.t_ID_Operation > 0 " +                                    
            "             and ch.t_ID_Step > 0 " +                                         
            "             and ch.t_NewLastDate >= ? AND ch.t_NewLastDate <= ? ) DepoMove "+                                                                                
            "  from dvsbanner_dbt bnr " +
            " where bnr.t_Department = ? " +
            "   and rsb_bill.GetVABnrClientContrIDOnDate(bnr.t_BCID, ?) = ? ";                                            
                                                                                                  
  end;                                                                                                                                    
                                                                                                                                   
  private macro ПоСчетамДЕПО_ЭЦБ()                                                                                           
     var LatStr = "ABCEHKMOPTX",
         RusStr = "АВСЕНКМОРТХ",
         LowRusStr = "авсенкмоптх",
         LowLatStr = "abcehkmoptx";

     return " select acc.t_Code_Currency FIID, " +
            "        sum(acc.DEPOAccRest) DEPOAccRest, acc.DepoMove " +
            "   from ( " +
            "         select abs(rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, 0)) as DEPOAccRest, "+ 
            "                (case when (" +
            "                abs(rsb_account.DebetAC(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?, ?)) > 0 OR " +                   
            "                abs(rsb_account.KreditAC(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?, ?)) > 0 " + 
            "                           ) then 1 else 0 end) DepoMove, acc.t_Code_Currency " +                                                                                       
            "           from daccount_dbt acc, ddepoacnt_dbt acnt, ddepoac_dbt ac, ddepoatvl_dbt atvl, dspground_dbt spgr " +                                                                                                 
            "          where (acc.t_DepoRoot = acnt.t_Root " +                                                                                    
            "                 or acc.t_DepoRoot in (SELECT da.t_AutoKey " +                                                                        
            "                                          FROM ddepoacnt_dbt da " +                                                                    
            "                                       START WITH da.t_AutoKey = acnt.t_Root " +                                                     
            "                                      CONNECT BY da.t_Superior = PRIOR da.t_AutoKey) " +                                             
            "                ) " +                                                                                                                  
            "            and ac.t_ID = acnt.t_Type " +                                                                                       
            "            and acnt.t_Kind = " + SIDEBALANCE_PASSIVE +                                                                         
            "            and ac.t_Type = " + OBJTYPE_DEPOKINDTYPE_ISSUER +                                                                   
            "            and atvl.t_ID = acnt.t_AutoKey " +                                                                                  
            "            and acnt.t_Department = ? " +                                                                                       
            "            and atvl.t_IsType = CHR(0) "  +                                                                                     
            "            and atvl.t_AttrNum = 16" + //DEPOATTR_ATTNUM_TRUST   //   документ ДУ                                               
            "            and TO_CHAR(spgr.t_SPgroundID) = atvl.t_Value " +                                                                 
            "            and spgr.t_DocLog = " + LLCLASS_KINDDOC_DOCDEPO +                                                                   
            "            and spgr.t_Kind = 215 " + //DOCKIND_DEPO_BROKERADMIN  // Договор доверительного управления                          
            "            and TRANSLATE(TRANSLATE(TRANSLATE(spgr.t_AltXLD, '"+LowRusStr+"', '"+LatStr+"'), '"+LowLatStr+"', '"+LatStr+"'), '"+RusStr+"', '"+LatStr+"') " +
            "                = TRANSLATE(TRANSLATE(TRANSLATE(?, '"+LowRusStr+"', '"+LatStr+"'), '"+LowLatStr+"', '"+LatStr+"'), '"+RusStr+"', '"+LatStr+"')" +
            "            and acc.t_Chapter = 5 " +                                                                                          
            "            and rsb_fiinstr.FI_IsSecurIndividual(acc.t_Code_Currency) = 0 "+
            "        ) acc " +                                                                   
            " group by acc.t_Code_Currency, acc.DepoMove";                                                                                                  
  end;                                                                                                                                    

  MACRO Отобрать_ЭЦБ_ПоДоговору(BegPeriod:Date, EndPeriod:Date)
    var sql;
    /* Сброшенный признак  "в т.ч. по ц/б без движения" означает,                                                                       
       что мы не делаем сверку для тех бумаг, по которым не было движений ни в ВУ БО, ни в учете Депозитария.                           
       Поэтому проверку лучше построить так:                                                                                            
          При сброшенном признаке:                                                                                                      
               Если не было проводок по счетам депо в депозитарии И не было проводок по счетам ВУ в БОЦБ,                               
                  то проверяем равенство количества ц/б по                                                                              
                  данным внутр. учета, количества ц/б в лотах и количества ц/б в Депозитарии:                                           
                      если все три количества равны, то в отчете ничего по этой ц/б не выводим.                                         
                      если хотя бы одно из трех количеств отличается, то выводим данные об этой ц/б в отчет.                            
               Если были движения в депозитарии ИЛИ проводки по счетам ВУ ценных бумаг, то сверку делаем, в отчет эту ц/б включаем.*/   
 

   sql = "select fin.T_FIID, NVL(wrtsum.DURest,0) DURest, " +
          "       NVL(inacc.t_Account,'') Account, NVL(inacc.InAccRest,0) InAccRest, NVL(inacc.ExistsInAccCarry,0) ExistsInAccCarry, " +                                                   
          "       NVL(depo.DEPOAccRest,0) DEPOAccRest, NVL(depo.DepoMove,0) DEPOMove " +                                                                                             
          "  from dfininstr_dbt fin " +
          " left join (" + ПоСчетамВУ_ЭЦБ() + ") inacc on (fin.t_FIID = inacc.FIID) " +                                                                 
                   " left join (" + ПоЛотамДУ() + ") wrtsum on (fin.t_FIID = wrtsum.t_FIID) " +                                                                  
                   " left join (" + ПоСчетамДЕПО_ЭЦБ() + ") depo on (fin.t_FIID = depo.FIID) "+
          " WHERE (case when (("+TS_IIF(not m_AccWithNotMove,0,1)+" = 0 "+                                                                              
          "        and NVL(inacc.ExistsInAccCarry,0) = 0 and NVL(depo.DepoMove,0) = 0 "+
          " and NVL(wrtsum.DURest,0) = NVL(depo.DEPOAccRest,0) "+
          "        and NVL(inacc.InAccRest,0) = NVL(depo.DEPOAccRest,0)) " +                         
          "        or ("+TS_IIF(m_AccWithNotMove,0,1)+" = 0 "+
          " and NVL(wrtsum.DURest,0) = 0 "+
          "            and  NVL(depo.DEPOAccRest,0) = 0 and NVL(inacc.InAccRest,0) = 0)"+                                                               
          "        ) then 0 else 1 end) = 1 " + 
          " and rsb_fiinstr.FI_IsSecurIndividual(fin.t_fiid) = 0 "+
          " and fin.t_FI_Kind  = " +string(FIKIND_AVOIRISS)+
          " AND rsb_fiinstr.FI_AvrKindsEQ("+string(FIKIND_AVOIRISS)+"," +                                                            
          "     case when ? > 0 then ? else fin.t_AvoirKind end,fin.t_AvoirKind) = 1 " +                                             
          " and (fin.t_fiid = ? OR -1 = ?) " +  
          " AND (fin.t_Issuer = ? OR -1 = ?) " +                                                            
          " ORDER BY fin.T_FIID";                                                                                                                      

    rsd_fi=RSDCommand(sql);                                                                                                           
                                                                                            
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, BegPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep);                                                                              
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.SfContrID);      
    rsd_fi.addParam("", RSDBP_IN, "ЦБ, Расч. с клиентом, ВУ");       
                                                                       
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep);                                                                              
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.ClientID);                                                                         
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.SfContrID);                                                                        
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep);                                                                              
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.SfContrID);                                                                        
                                                              
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, BegPeriod);                                                                                             
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, BegPeriod);                                                                                             
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep );                                                                                             
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.ContrNum);                                                                         
    rsd_fi.addParam("", RSDBP_IN, m_AvrKind );                                                                                     
    rsd_fi.addParam("", RSDBP_IN, m_AvrKind );                                                                                     
    rsd_fi.addParam("", RSDBP_IN, m_FIID);                                                                                         
    rsd_fi.addParam("", RSDBP_IN, m_FIID);                                                                                         
    rsd_fi.addParam("", RSDBP_IN, m_IssuerID );                                                                                       
    rsd_fi.addParam("", RSDBP_IN, m_IssuerID );                                                                                       

    rsd_fi.execute();                                                                                         
                                                                                                               
    m_RSD_FI = TRsbDataSet( rsd_fi );

    return m_RSD_FI.MoveNext();
  END;

  MACRO Отобрать_Н_ЭЦБ_ПоДоговору(BegPeriod:Date, EndPeriod:Date)
    var sql;
    /* Сброшенный признак  "в т.ч. по ц/б без движения" означает,                                                                       
       что мы не делаем сверку для тех бумаг, по которым не было движений ни в ВУ БО, ни в учете Депозитария.                           
       Поэтому проверку лучше построить так:                                                                                            
          При сброшенном признаке:                                                                                                      
               Если не было проводок по счетам депо в депозитарии И не было проводок по счетам ВУ в БОЦБ,                               
                  то проверяем равенство количества ц/б по                                                                              
                  данным внутр. учета, количества ц/б в лотах и количества ц/б в Депозитарии:                                           
                      если все три количества равны, то в отчете ничего по этой ц/б не выводим.                                         
                      если хотя бы одно из трех количеств отличается, то выводим данные об этой ц/б в отчет.                            
               Если были движения в депозитарии ИЛИ проводки по счетам ВУ ценных бумаг, то сверку делаем, в отчет эту ц/б включаем.*/   

   sql = "select vs.T_BCID, vs.T_FIID, vs.t_BCSeries, vs.t_BCNumber, vs.T_ISSUER IssuerID, "+
         " NVL(bnr.DURest,0) DURest, " +
         " NVL(inacc.t_Account,'') Account, NVL(inacc.InAccRest,0) InAccRest, NVL(inacc.ExistsInAccCarry,0) ExistsInAccCarry, " +                                                   
         " NVL(depo.DEPOAccRest,0) DEPOAccRest, NVL(depo.DepoMove,0) DEPOMove " +                                                                                             
         "  from dfininstr_dbt fin, ddl_leg_dbt leg, dvsbanner_dbt vs"+
         "       left join (" + ПоСчетамВУ_Н_ЭЦБ() + ") inacc on (vs.t_BCID = inacc.BCID) " +                          
         "       left join (" + УчтенВекс() + ") bnr on (vs.t_BCID = bnr.BCID) " +                                     
         "       left join (" + ПоСчетамДЕПО_Н_ЭЦБ() + ") depo on (vs.t_BCID = depo.BCID) "+                                
         " WHERE (case when (("+TS_IIF(not m_AccWithNotMove,0,1)+" = 0 "+                                                                              
         " and NVL(inacc.ExistsInAccCarry,0) = 0 and NVL(depo.DepoMove,0) = 0 "+
         " and NVL(bnr.DURest,0) = NVL(depo.DEPOAccRest,0) "+                              
         " and NVL(inacc.InAccRest,0) = NVL(depo.DEPOAccRest,0)) " +                         
         "        or ("+TS_IIF(m_AccWithNotMove,0,1)+" = 0 "+
         " and NVL(bnr.DURest,0) = 0 "+                              
         " and NVL(depo.DEPOAccRest,0) = 0 and NVL(inacc.InAccRest,0) = 0)"+                                                               
         "         ) then 0 else 1 end) = 1 " +
         "   AND leg.t_LegKind = " + LEG_KIND_VSBANNER +
         "   AND leg.t_DealID = vs.t_BCID " +
         "   AND leg.t_LegID = 0 " +
         "   AND (vs.t_Issuer = ? OR -1 = ?) " +
         "   AND fin.t_FIID = vs.t_FIID " +
         "   AND rsb_fiinstr.FI_AvrKindsEQ("+string(FIKIND_AVOIRISS)+"," +                                                            
         "       case when ? > 0 then ? else fin.t_AvoirKind end,fin.t_AvoirKind) = 1 "+                                            
         " ORDER BY vs.T_BCID";                                                                                                                      

    rsd_fi=RSDCommand(sql);                                                                                                           
                                                                                                                                
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, BegPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep);                                                                              
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.SfContrID);       
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, "НЦБ, Расч. с клиентом, ВУ");       
                                                                                                                   
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.SfContrID);                                                                        
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT);                                                        
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep);                                                                              
                                                               
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, BegPeriod);                                                                                             
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.Dep );                                                                                             
    rsd_fi.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_fi.addParam("", RSDBP_IN, m_RSD_TSORDER.SfContrID);                                                                         
    rsd_fi.addParam("", RSDBP_IN, m_IssuerID );                                                                                       
    rsd_fi.addParam("", RSDBP_IN, m_IssuerID );                                                                                       
    rsd_fi.addParam("", RSDBP_IN, m_AvrKind );                                                                                     
    rsd_fi.addParam("", RSDBP_IN, m_AvrKind );                                                                                     

    rsd_fi.execute();                                                                                         
                                                                                                               
    m_RSD_FI = TRsbDataSet( rsd_fi );

    return m_RSD_FI.MoveNext();
  END;


  MACRO TSOrderList(KindRep,BegPeriod:Date, EndPeriod:Date)
    /*отбор договоров ДУ*/
    var ds, rsd, sqlQuery = "";

    m_KindRep = KindRep;

    IsCirculeFI = IsCirculeTsOrder = false;
    m_CountAvr = 0;

    sqlQuery = " SELECT tsorder.t_SfContrID, tsorder.t_Trustor ClientID, sfcontr.T_DEPARTMENT Dep, " +                
               "        sfcontr.t_Number ContrNum, tsorder.t_ID TsOrderID, tsorder.t_DocKind TsOrderKind " +                      
               "  FROM  dtsorder_dbt tsorder, dsfcontr_dbt sfcontr, dspground_dbt SPGround " +                                                            
               " WHERE  tsorder.t_SfContrID = sfcontr.t_ID " +                                                                    
               "   AND  (tsorder.t_Trustor = ? OR -1 = ? ) " +                                                                    
               "   AND  (sfcontr.t_ID = ? OR -1 = ?) " +                                                                          
               "   AND  (sfcontr.t_ServKindSub = ? OR -1 = ?) " + 
               "   AND  SPGround.t_SourceDocKind = tsorder.t_DocKind "+
               "   AND  SPGround.t_SourceDocID   = tsorder.t_ID "+
               "   AND  SPGround.t_Direction     = "+ string(EXITING) +
               "   AND  SPGround.t_Division      = "+ string(0) +
               "   AND  SPGround.t_BeginningDate <= ? "+
               "   AND  (SPGround.t_TerminateDate = to_date('01.01.0001','DD.MM.YYYY') OR SPGround.t_TerminateDate >= ?) " +                                  
               " ORDER BY sfcontr.T_DEPARTMENT, tsorder.t_Trustor, tsorder.t_SfContrID";              
                                                                                                            
    rsd = RSDCommand( "select count(1) m_Num from ("+sqlQuery+") " );                                          
                                                                                                            
    rsd.addParam("", RSDBP_IN, m_ClientID);                                                                    
    rsd.addParam("", RSDBP_IN, m_ClientID);                                                                    
    rsd.addParam("", RSDBP_IN, m_ClientContrID);                                                               
    rsd.addParam("", RSDBP_IN, m_ClientContrID);                                                               
    rsd.addParam("", RSDBP_IN, TS_IIF(m_OFBU == "X", PTSKS_TRUST_OFBU, -1) );                                  
    rsd.addParam("", RSDBP_IN, TS_IIF(m_OFBU == "X", PTSKS_TRUST_OFBU, -1) );                                  
    rsd.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd.addParam("", RSDBP_IN, BegPeriod);                                                                                      
    rsd.execute();                                                                                             
                                                                                                               
    ds = TRsbDataSet( rsd );                                                                                   
    if( ds.MoveNext() )                                                                                        
       m_NumTsOrder = Int(ds.rec.m_Num);                                                                       
    end;                                                                                                       
                                                                                                               
    rsd_ord = RSDCommand( sqlQuery );                                                                          
                                                                                                            
    rsd_ord.addParam("", RSDBP_IN, m_ClientID);                                                                
    rsd_ord.addParam("", RSDBP_IN, m_ClientID);                                                                
    rsd_ord.addParam("", RSDBP_IN, m_ClientContrID);                                                           
    rsd_ord.addParam("", RSDBP_IN, m_ClientContrID);                                                           
    rsd_ord.addParam("", RSDBP_IN, TS_IIF(m_OFBU == "X", PTSKS_TRUST_OFBU, -1) );                              
    rsd_ord.addParam("", RSDBP_IN, TS_IIF(m_OFBU == "X", PTSKS_TRUST_OFBU, -1) );                              
    rsd_ord.addParam("", RSDBP_IN, EndPeriod);                                                                                      
    rsd_ord.addParam("", RSDBP_IN, BegPeriod);                                                                                      
    rsd_ord.execute();                                                                                         

    m_RSD_TSORDER = TRsbDataSet( rsd_ord );                                                                    

    m_Count = 0;
    InitProgress( m_NumTsOrder, "Просмотр ц/б по договорам ДУ",
                 "Просмотр ц/б по договорам ДУ"+TS_IIF(m_ForEveryDate," за "+string(EndPeriod),"") );
  END;
        
  MACRO ОстатокВУ()
     return SQL_ConvTypeSum(m_RSD_FI.InAccRest);
  END;

  MACRO ОстатокДЕПО()
     return SQL_ConvTypeSum(m_RSD_FI.DEPOAccRest);
  END;

  MACRO ОстатокПоУчетСистДУ()
        return (SQL_ConvTypeInteger(m_RSD_FI.DURest));
  END;

  MACRO TSOrderNext(BegPeriod:Date, EndPeriod:Date, AvrKind:@integer)
    if( IsCirculeFI == true )
       IsCirculeFI = m_RSD_FI.MoveNext();
    end;

    if( (IsCirculeFI == false) and (m_CountAvr == 0) )

        UseProgress(m_Count = m_Count + 1);

       IsCirculeTsOrder = m_RSD_TSORDER.MoveNext();

       if( m_KindRep == KIND_REP_ALL ) 
          AvrKind =  KIND_AVR_EMISS;
          m_CountAvr = 2; 
       else
          m_CountAvr = 1; 
       end;                                 
    end;

    if( (IsCirculeTsOrder == true) AND (IsCirculeFI == false) )

       if( (m_KindRep == KIND_REP_ALL) AND (m_CountAvr == 1 ) AND (AvrKind == KIND_AVR_EMISS) )      
          AvrKind = KIND_AVR_NOTEMISS;   
       end;                                 

       if(AvrKind == KIND_AVR_EMISS)
          IsCirculeFI = Отобрать_ЭЦБ_ПоДоговору(BegPeriod, EndPeriod);
       else
          IsCirculeFI = Отобрать_Н_ЭЦБ_ПоДоговору(BegPeriod, EndPeriod);
       end;
       m_CountAvr = m_CountAvr - 1;

    end;  
    return IsCirculeTsOrder;
  END;

  MACRO TSOrderEnd()
    RemProgress();
  END;

  PRIVATE MACRO PrintMode():INTEGER
     if( m_Form.GetFieldValue( PNFLD_TSACTAVR_ISPRINTEXCEL ) == SET_CHAR )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()

    m_Dprt                = m_Form.GetFieldValue( PNFLD_TSACTAVR_DPRTNUM );
    m_BeginDate           = m_Form.GetFieldValue( PNFLD_TSACTAVR_BEGINDATE );
    m_EndDate             = m_Form.GetFieldValue( PNFLD_TSACTAVR_ENDDATE );
    m_ForEveryDate        = (m_Form.GetFieldValue( PNFLD_TSACTAVR_FOREVERYDATE ) == SET_CHAR);
    m_OFBU                = m_Form.GetFieldValue( PNFLD_TSACTAVR_OFBU );
    m_ClientID            = m_Form.GetFieldValue( PNFLD_TSACTAVR_CLIENTCODE );
    m_ClientContrID       = m_Form.GetFieldValue( PNFLD_TSACTAVR_CLIENTCONTR );
    m_AccWithNotMove      = (m_Form.GetFieldValue( PNFLD_TSACTAVR_WITHNOTMOVE ) == SET_CHAR);
    m_AvrKind             = m_Form.GetFieldValue( PNFLD_TSACTAVR_AVRKIND );
    m_IssuerID            = m_Form.GetFieldValue( PNFLD_TSACTAVR_AVRISSUER );
    m_FIID                = m_Form.GetFieldValue( PNFLD_TSACTAVR_AVRCODE );
    m_WithApp             = (m_Form.GetFieldValue( PNFLD_TSACTAVR_WITHAPP ) == SET_CHAR);

    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    ObjReport.BeginReport();

    ObjReport.Execute();

    ObjReport.EndReport();
  END;

  PRIVATE MACRO Create()
    if( (m_Form.GetFieldValue( PNFLD_TSACTAVR_EMISS ) == SET_CHAR) AND 
        (m_Form.GetFieldValue( PNFLD_TSACTAVR_NOTEMISS ) == SET_CHAR)
      )
       ExecuteReport( TS_RegMoney_Money(this,KIND_REP_ALL) );
    elif( m_Form.GetFieldValue( PNFLD_TSACTAVR_EMISS ) == SET_CHAR )
       ExecuteReport( TS_RegMoney_Money(this,KIND_REP_EMISS) );
    elif( m_Form.GetFieldValue( PNFLD_TSACTAVR_NOTEMISS ) == SET_CHAR )
       ExecuteReport( TS_RegMoney_Money(this,KIND_REP_NOTEMISS) );
    end;
  END;
  
  initDL_CReportTemplate( TS_ACTAVR_Panel(), "Report_TsActAvr.xls" );
END;

TS_ActAvr_Report().Run();
Exit(1);