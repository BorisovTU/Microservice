/*******************************************************************************
 DESCRIPTION  :   Печатная форма Поручение на инвентарную операцию
                  ( прием/снятие на хранение )
 PROGRAMMED BY:   Leksikov E.
 CREATION DATE:   21.11.2009 
*******************************************************************************/

import "tscateg.mac", "dlRepFun.mac", "tsutil.mac", "dlwreps.mac", "adress.mac", "tssec.mac", "dpagacc.mac";
import "tsrepsign.mac";

var GrTemp = TRecHandler( "dlgrtemp.dbt" );

PRIVATE MACRO GetRegistry( PartyID, ListKind_Ref, DocKindID, partyreg, Number )

  if( not CB_GetRegistry( OBJTYPE_PARTY, PartyID, ListKind_Ref, DocKindID, partyreg, Number ) )
    SetParm( 4, Number );
    return true;
  else
    Number = "";
  end;

  return false;
END;;

PRIVATE MACRO FindGrTemp( Num )

  if( Num > 0 )
     return TS_GetRecHandler( GrTemp, " SELECT *"+
                                      "   FROM ddlgrtemp_dbt " +
                                      "  WHERE t_DocLog = 590 AND " +
                                      "        t_Num    = " + string(Num)
                            );
  end;
  return false;
END;

PRIVATE MACRO ДоговорДепо( ID, Num:@string, pDate:@date, Name:@string )
  var ds, rsd;

  rsd = RSDCommand(" select sp.t_AltXld, sp.t_SignedDate, llv.t_Name              "+
                   " from ddepoatvl_dbt atvl, dspground_dbt sp, dllvalues_dbt llv "+
                   " where atvl.t_IsType = CHR(0)                                 "+
                   " and atvl.t_ID = ?                                            "+
                   " and atvl.t_Attrnum = 16                                      "+
                   " and sp.t_SPgroundID = atvl.t_Value                           "+
                   " and llv.t_List = 1050                                        "+
                   " and llv.t_Element = sp.t_Kind                                "
                  );

  rsd.addParam("", RSDBP_IN, ID);
  rsd.execute();
  ds = TRsbDataSet( rsd );
  if( ds.MoveNext() )
    Num   = ds.AltXld;
    pDate = ds.SignedDate;
    Name  = ds.Name;
  end;
END;

PRIVATE MACRO ПолучитьМестоХранения( ID ):string
  var ds, rsd;

  rsd = RSDCommand(" select pt.t_ShortName                  "+
                   " from ddepoatvl_dbt atvl, dparty_dbt pt "+
                   " where atvl.t_IsType = CHR(0)           "+
                   "       and atvl.t_ID = ?                "+
                   "       and atvl.t_Attrnum = 3           "+
                   "       and pt.t_PartyID = atvl.t_Value  "
                  );


  rsd.addParam("", RSDBP_IN, ID);
  rsd.execute();
  ds = TRsbDataSet( rsd );
  if( ds.MoveNext() )
     return ds.ShortName;
  end;
  return "";
END;

PRIVATE MACRO ПолучитьВидЦБ( AvrKind, FIID )
  var ds, rsd;

  if( AvrKind != null )
    rsd = RSDCommand( "select t_Name from davrkinds_dbt where t_AvoirKind = ?" );
    rsd.addParam("", RSDBP_IN, AvrKind);
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return ds.Name;
    end;
  elif ( FIID != null )
    rsd = RSDCommand( " select avrkinds.t_Name, fin.t_AvoirKind "+
                      " from dfininstr_dbt fin, davrkinds_dbt avrkinds "+
                      " where fin.t_FIID = ? and "+
                      "       fin.t_AvoirKind = avrkinds.t_AvoirKind and "+
                      "       fin.t_fi_kind = avrkinds.t_fi_Kind "
                    );
    rsd.addParam("", RSDBP_IN, FIID);
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return ds.Name;
    end;
  end;

  return "";
END;

PRIVATE MACRO ПолучитьНоминал( FIID, Val:@string, Str:@string )
  var kop, ValFIID:integer;
  var ValFin = Trechandler( "fininstr.dbt" ); /* валюта */
  var Fin = Trechandler( "fininstr.dbt" ); /* фин. инструмент */

  ПолучитьФинИн( FIID, Fin );
  ValFIID = Fin.rec.FaceValueFI;
  ПолучитьФинИн( ValFIID, ValFin );

  Val = ДУ_ЧислоCЗаданнойТочностью( Fin.rec.FaceValue , Fin.rec.Point + 2);

  Str = CurToStrAlt ( Val, null, kop, int(ValFin.rec.fi_code) );
  if( kop == "00" ) /* если дробной части нет, копейки не выводим */
    Str = SubStr( Str, 1, StrBrk(Str, kop) - 2 );
  end;

  Val = FormatStrNum( Fin.rec.FaceValue, ".", " ", Fin.rec.Point + 2 );
END;

PRIVATE MACRO ПолучитьГосНомер( FIID )
  var ds, rsd;
  rsd = RSDCommand( "select t_lsin from davoiriss_dbt where t_FIID = ?" );
  rsd.addParam("", RSDBP_IN, FIID);
  rsd.execute();
  ds = TRsbDataSet( rsd );
  if( ds.MoveNext() )
     return ds.lsin;
  end;
  return "";
END;

PRIVATE MACRO НомерЗаТекДень( SpGroundID, Kind, RegistrDate:Date ):integer
  var ds, rsd, NRec = 0;

  rsd = RSDCommand(
    " select t.rnum " +
    "   from (select rownum rnum, t_spgroundid " +
    "           from dspground_dbt " +            
    "          where t_kind = ? " +               
    "            and t_doclog = ? " +             
    "            and t_registrdate = ? " +        
    "         order by t_spgroundid) t " +
    "  where t.t_spgroundid = ? "         
  );

  rsd.addParam("", RSDBP_IN, Kind);
  rsd.addParam("", RSDBP_IN, 590);
  rsd.addParam("", RSDBP_IN, RegistrDate);
  rsd.addParam("", RSDBP_IN, SpGroundID);

  rsd.execute();
  ds = TRsbDataSet( rsd );
  while( ds.MoveNext() )
     NRec = SQL_ConvType(ds.rnum);
    end;

  if( NRec )
     return NRec;
  end;

  return 1;

END;

PRIVATE MACRO _println(str)
  if(ValType(str) != V_UNDEF)
    println(str);
  end;
END;

PRIVATE CLASS CB
  var AvKind,
      Series,
      NumberFirst,
      Issuer,
      Principal,
      Point;
END;

PRIVATE CLASS DepoRecept( parm1:integer, parm2:integer )

  var DocKind = parm2;

  var DocTempl, paymID, DocumentID,
      ДатаПоставки,
      ДатаПодачиПоручения,
      ВхНомер,
      ДатаРегистрации,
      ВремяРегистрации,
      Вид,
      НаимАктСчетаДепо,
      НаимПасСчетаДепо,
      Счет,
      Счет1,
      Количество,
      НомерДоговора,
      Депонент,
      pType, rType, 
      pPartCode, rPartCode,
      FIID, AutoKey, rAutoKey,
      OrderID, OrderDocKind;

  var ArrayCB = TArray;

/* констуктор */                                              
  macro Constructor( SpGroundID )
    var query, SQLcmd, RSD;
    var curCB:CB;
    var i:integer = 0;
    query = RSDCommand(
        " select ground.t_DocTemplate, paym.t_ValueDate, groundDraft.t_SignedDate, "+
        "   groundDraft.t_Xld, groundDraft.t_RegistrDate, groundDraft.t_RegistrTime,"+
        "   paym.t_DocKind Kind, tsorder.t_RegNum, acntPayer.t_Name pNum,          "+
        "   acntReceiver.t_Name rNum,                                              "+
        "   tsorder.t_ID orderID, tsorder.t_DocKind OrderDocKind,                  "+
        "   acntPayer.t_BriefCode PayerCode, acntReceiver.t_BriefCode ReceiverCode,"+ 
        "   paym.t_Amount, paymDraft.t_PaymentID, paym.t_DocumentID,               "+
        "   party.t_ShortName, acP.t_ShortName pType, acR.t_ShortName rType,       "+
        "   partPayer.t_BriefCode pPartCode, partReceiver.t_BriefCode rPartCode,   "+
        "   paym.t_BaseFIID,                                                       "+
        "   acntReceiver.t_AutoKey rAutoKey, acntPayer.t_AutoKey pAutoKey          "+
        " from dtsiorqst_dbt iorqst,                                               "+
        "      dpmpaym_dbt   paym,                                                 "+
        "      dspdrprop_dbt prop,                                                 "+
        "      dspdraft_dbt  draft,                                                "+
        "      dspground_dbt ground,                                               "+
        "      dspground_dbt groundDraft,                                          "+
        "      dspgrdoc_dbt  grdoc,                                                "+
        "      dtsorder_dbt  tsorder,                                              "+
        "      dspdrmove_dbt drmove,                                               "+
        "      dpmpaym_dbt   paymDraft,                                            "+
        "      ddepoacnt_dbt acntPayer,                                            "+
        "      ddepoacnt_dbt acntReceiver,                                         "+
        "      ddepoacnt_dbt partPayer,                                            "+
        "      ddepoacnt_dbt partReceiver,                                         "+
        "      dparty_dbt    party,                                                "+
        "      ddepoac_dbt   acP,                                                  "+
        "      ddepoac_dbt   acR                                                   "+
        " where ground.t_SPgroundID           = ?                                  "+
        "       AND ground.t_SPgroundID       = grdoc.t_SPgroundID                 "+
        "       AND tsorder.t_ID              = grdoc.t_SourceDocID                "+
        "       AND tsorder.t_DocKind         = grdoc.t_SourceDocKind              "+
        "       AND tsOrder.t_ID              = iorqst.t_OrderID                   "+
        "       AND iorqst.t_ID               = paym.t_DocumentID                  "+
        "       AND ( paym.t_DocKind          = 906 OR paym.t_DocKind = 910 )      "+
        "       AND paym.t_PaymentID          = prop.t_PaymentID                   "+
        "       AND prop.t_DraftID            = draft.t_Autokey                    "+
        "       AND draft.t_SPgroundID        = groundDraft.t_SPgroundID           "+
        "       AND (groundDraft.t_Xld        = ground.t_AltXld                    "+
        "            OR  groundDraft.t_AltXld = ground.t_Xld )                     "+
        "       AND drmove.t_DraftID          = draft.t_AutoKey                    "+
        "       AND paymDraft.t_PaymentID     = drmove.t_PaymentID                 "+
        "       AND partPayer.t_AutoKey(+)    = paymDraft.t_PayerDpNode            "+
        "       AND partReceiver.t_AutoKey(+) = paymDraft.t_ReceiverDpNode         "+
        "       AND acntPayer.t_AutoKey(+)    = partPayer.t_Root                   "+
        "       AND acntReceiver.t_AutoKey(+) = partReceiver.t_Root                "+
        "       AND acntReceiver.t_Owner      = party.t_PartyID                    "+
        "       AND partPayer.t_Type        = acP.t_ID                             "+
        "       AND partReceiver.t_Type  = acR.t_ID                                "

    );

    query.addParam( "", RSDBP_IN, SpGroundID );
    query.execute();
    var DataSet = TRSBDataSet(query);

    if( DataSet.MoveNext() )
      DocTempl            = DataSet.DocTemplate;
      paymID              = DataSet.PaymentID;
      DocumentID          = DataSet.DocumentID;

      ДатаПоставки        = DataSet.ValueDate;
      ДатаПодачиПоручения = DataSet.SignedDate;
      ВхНомер             = DataSet.Xld;
      ДатаРегистрации     = DataSet.RegistrDate;
      ВремяРегистрации    = DataSet.RegistrTime;
      Вид                 = DataSet.Kind;
      НаимПасСчетаДепо    = DataSet.pNum;
      НаимАктСчетаДепо    = DataSet.rNum;
      Счет                = DataSet.PayerCode;
      Счет1               = DataSet.ReceiverCode;
      Количество          = DataSet.Amount;
      НомерДоговора       = DataSet.RegNum;
      Депонент            = DataSet.ShortName;
      rType               = DataSet.rType;
      rPartCode           = DataSet.rPartCode;
      pType               = DataSet.pType;
      pPartCode           = DataSet.pPartCode;
      FIID                = DataSet.BaseFIID;
      OrderID             = DataSet.OrderID;
      OrderDocKind        = DataSet.OrderDocKind;
      rAutoKey            = DataSet.rAutoKey;

      if( Вид == 906 ) // Заявление на ввод каритала
        AutoKey             = DataSet.pAutoKey;
      elif( Вид == 910 ) // Заявление на вывод каритала
        AutoKey             = DataSet.rAutoKey;
      end;
    end;

    if( (DocKind == 203 /*DOCKIND_DEPO_REC*/) OR (DocKind == 204/*DOCKIND_DEPO_WITHDR*/) ) /* поручение депо (нэцб) */
      query = RSDCommand(
          " select distinct fin.t_AvoirKind, fin.t_Point,   "+
          "        cm.t_Series, cm.t_NumberFirst,           "+
          "        cm.t_Issuer, leg.t_Principal             "+
          " from dcertmove_dbt cm, dcertif_dbt cert,        "+
          "      dvsbanner_dbt bnr, ddl_leg_dbt leg,        "+
          "      dfininstr_dbt fin                          "+
          " where cm.t_PaymTO = ?                           "+
          "     and cert.t_FIID = cm.t_FIID                 "+
          "     and cert.t_Issuer = cm.t_Issuer             "+
          "     and cert.t_IssuerDate = cm.t_IssuerDate     "+
          "     and cert.t_Series = cm.t_Series             "+ 
          "     and cert.t_NumberFirst = cm.t_NumberFirst   "+
          "     and bnr.t_InventoryXID = cert.t_Xid         "+
          "     and bnr.t_Department = cert.t_Department    "+
          "     and leg.t_DealID = bnr.t_BCID               "+
          "     and leg.t_LegID = 0 and leg.t_LegKind = 1   "+
          "     and fin.t_FIID = cert.t_FIID                " 
      );
  
      query.addParam( "", RSDBP_IN, paymID );
      query.execute();
      DataSet = TRSBDataSet(query);

      i = 0;
      while( DataSet.MoveNext() )
        ArrayCB[i] = CB();
        ArrayCB[i].AvKind      = DataSet.AvoirKind;
        ArrayCB[i].Series      = DataSet.Series;
        ArrayCB[i].NumberFirst = DataSet.NumberFirst;
        ArrayCB[i].Issuer      = DataSet.Issuer;
        ArrayCB[i].Principal   = DataSet.Principal;
        ArrayCB[i].Point       = DataSet.Point;
  
        i = i + 1;
      end;

    elif( DocKind == 299 ) /* поручение депо (эцб) */
      
    end;
  end;
  
  Constructor(parm1, parm2);
END;

PRIVATE MACRO GetAgentByDepoID(ID, RepoDate, AutoKey, short)           
                                                     
    var dpagacc, agent = "________________", rsd, rsd2;
                                                                                      
    var query =   " select dpt.t_AutoKey, cast(Rsb_depo.GetAcntOperatorOnDate(dpt.t_AutoKey, " + GetSQLDate(RepoDate) + " ) as NUMBER(10)) t_Operator, dpt.t_OperGround, dpt.t_AutoKey, dpt.t_Superior  from ddepoacnt_dbt dpt, ddepoatvl_dbt atv"
           + " where dpt.t_Root = " + AutoKey
           + "   and atv.t_ID = dpt.t_AutoKey "
           + "   and atv.t_AttrNum = " + DEPOATTR_ATTNUM_OPERATOR
           + "   and atv.t_IsType = CHR(0)"
           + "   and atv.t_IsOwn = 'X'";
    
    rsd = RSDCommand(query);

    rsd.execute();
        
    var result = TRsbDataSet(rsd);

// #193597 to delete
//    if(result.MoveNext())
    if( false )
        rsd2 = RSDCommand("select t_AgentID from ddpagacc_dbt where t_DepoAccID = " + result.rec.AutoKey);

        rsd2.execute();
        
        dpagacc = TRsbDataSet(rsd2);
    
        if(dpagacc.MoveNext())
               if(short)
                agent = GetPartyShortName( dpagacc.rec.AgentID );
               else
                agent = GetPartyName( dpagacc.rec.AgentID );
               end; 
        end;

        if(short)      // если много распорядителей - не выводим
                if(dpagacc.MoveNext())
                        agent = "________________";
                end;
        else
           if(agent == "________________")
                agent = agent + "____________________________________";
                agent = agent + "___________________________________";
           end;    
        end;   
    end;          

    return agent;
END;

PRIVATE MACRO PrintPor( Depo:DepoRecept, SpGroundID )
  var party    = TRecHandler("party.dbt");
  var adress   = TRecHandler("adress.dbt");

  var ReportData = TS_ReportData();
  
  ПолучитьСубъекта({ourbank}, party);  /*наш банк*/
    
  /*Шаблон*/
  FindGrTemp( Depo.DocTempl );
  [#]( GrTemp.rec.File_Name );
    
  /*Имя выходного файла*/
  var d, m;
  DateSplit( date(Depo.ДатаПоставки), d, m, null );
  d = LeadZero(string(d), 2);
  m = LeadZero(string(m), 2);

  var NumOfDay = string(НомерЗаТекДень( SpGroundID, Depo.DocKind, Depo.ДатаРегистрации ));
  NumOfDay = LeadZero( NumOfDay, 5);
  var Vydano:string;
    
  var DocName = "Поручение на инвентарную операцию_2" + d + m + NumOfDay;
  [#.rtf]( DocName );

  var innerNumber = "2";
  innerNumber = innerNumber + d + m + NumOfDay;

  var txtNum = "";
  var i:integer = 0;
  var partyreg = TRecHandler("objrgdoc");
  var Val, Str;
  var hh, mm;

    /* документы-приложения */
    var DepoNum:string  = "",
        DepoDate:date   = date(0,0,0),
        DepoName:string = "";
    var Order;
    var RegNumber;
  if( (Depo.DocKind == 203 /*DOCKIND_DEPO_REC*/) OR (Depo.DocKind == 204/*DOCKIND_DEPO_WITHDR*/) ) /* поручение депо (нэцб) */
    /* Краткое наименование банка */
    [~our_bank];
    _println( ReportData.OurBankShort() );
  
    /* Юридический адрес нашего банка */
    [~our_addr];
    println( ReportData.OurAddr() );

    /* Телефон нашего банка */
    [~our_tel];
    println( ReportData.OurPhone() );

    [~number];
    /* Внутренний номер поручения депо */
    _println( innerNumber );
  
    [~delivery_day];
    /* Дата подачи поручения */
    _println( date(Depo.ДатаПодачиПоручения) );

    [~our_bank_dup1];
    println(ReportData.OurAddr());

    [~oper];
    println(ReportData.OperName());

    [~Active_Acc_Name];
    println("Касса ДУ");

    [~Passive_Acc_Name];
    /* Наименование пассивного счета депо доверительного управляющего */
    _println( Depo.НаимПасСчетаДепо );
  
    if( Depo.Вид == 906 )
      [~Active_Acc_Number];
      /* Номер активного счета депо (места хранения) */
      _println( Depo.Счет );
      [~Passive_Acc_Number];
      /* Номер пассивного счета депо доверительного управляющего */
      _println( Depo.Счет1 );
    elif( Depo.Вид == 910 )
      [~Active_Acc_Number];
      _println( Depo.Счет1 );
      [~Passive_Acc_Number];
      _println( Depo.Счет );
    end;
  
    [~total_debet];
    /* Количество ценных бумаг, цифрами */
    _println( FormatStrNum( Depo.Количество, null, " ", 0 ) );
    [~total_credit];
    _println( FormatStrNum( Depo.Количество, null, " ", 0 ) );

    [~MultipleRow];
    println(3);
    println( Depo.ArrayCB.size - 1 );
    println("#");
    println(3);

    i = 0;
    while( (i < Depo.ArrayCB.size) AND (Depo.ArrayCB[i] != null) )

      /* Порядковый номер */
      println( "~N" + (i+1) );
      println( string(i+1) );

      /* Серия, Номер */
      println( "~ser" + (i+1) );
      println( Depo.ArrayCB[i].Series );

      println( "~nbr" + (i+1) );
      println( Depo.ArrayCB[i].NumberFirst );

      /* Краткое наименование эмитента */
      println( "~issuer_name" + (i+1) );
      println( ПолучитьКороткоеИмяСубъекта( Depo.ArrayCB[i].Issuer ) );

      /* Номинал */
      println( "~face_value" + (i+1) );
      println( FormatStrNum( Depo.ArrayCB[i].Principal, ".", " ", Depo.ArrayCB[i].Point + 2 ) );

      i = i + 1;
    end;

    [~total_number];
    _println( int(Depo.Количество) );

    [~total_number_text];
    txtNum = NumToStr( int(Depo.Количество), "штука", "штуки", "штук", false,     0);
    _println(StrUpr(txtNum, 1)); 

    [~Dok_A];
    println( "Акт приема передачи векселей к Договору Доверительного управления" );

    /* Номер  договора Доверительного управления имуществом */
    [~contract_N_DU1];
    _println( Depo.НомерДоговора );

    [~Dok_D];
    _println("");

    [~Contract_N];
    println("");

    [~Contract_date];
    println("");

    [~contract_N_DU2];
    println("");

    [~oper_dup1];
    println(ReportData.OperName());

  elif( Depo.DocKind == 299 ) /* поручение депо (эцб) */
    [~A1_1];
    /* Внутренний номер поручения депо */
    _println( innerNumber );
  
    [~A1_2];
    /* Дата подачи поручения */
    _println( date(Depo.ДатаПодачиПоручения) );


    if( Depo.Вид == 906 )
    [~A2_1];
    /* Наименование счета депо */
      _println( Depo.НаимАктСчетаДепо );

      [~A2_2];
      /* Номер пассивного счета депо доверительного управляющего */
      _println( Depo.Счет1 );

      [~A3_1];
      /* Наименование и номер раздела счета  */
      _println( Depo.rType );
      [~A3_2];
      _println( Depo.rPartCode ); 
    elif( Depo.Вид == 910 )
      [~A2_1];
      /* Наименование счета депо */
      _println( Depo.НаимПасСчетаДепо );

      [~A2_2];
      _println( Depo.Счет );

    [~A3_1];
    /* Наименование и номер раздела счета  */
      _println( Depo.pType );
    [~A3_2];
      _println( Depo.pPartCode ); 
    end;


    [~A4_1];
    _println( Depo.Депонент );

    if( GetRegistry( {ourbank}, REGPT_TAXINSTITUTE/* 7 */, OBJKDOC_EVIDENCE_GOS_REG /* 12 */, partyreg, RegNumber ) )
      [~A4_2];
      _println( RegNumber /*partyreg.rec.Number*/ );
      [~A4_3];
      _println( DateToStr(partyreg.rec.StartDate, true) );
      [~A4_4];
      TS_GetPartyName(partyreg.rec.RegPartyID, @Vydano);
      _println( Vydano );
    else
      [~A4_2];
      _println( "_________" );
      [~A4_3];
      _println( "_________" );
      [~A4_4];
      _println( "_________" );
    end;

    [~A5_1];
    _println( GetAgentByDepoId(Depo.Счет, DepoDate, Depo.rAutoKey, false) );

    [~A6_1];
    /* Наменование ценной бумаги */
    _println( GetFIName(Depo.FIID) );

    [~A6_2];
    /* Вид и выпуск ЦБ */
    _println( ПолучитьВидЦБ(null, Depo.FIID) );

    [~A6_3];
    /* Вид и выпуск ЦБ */
    _println( ПолучитьГосНомер(Depo.FIID) );

    ПолучитьНоминал( Depo.FIID, @Val, @Str );
    [~A6_4];
    /* Номинал */
    _println( Val );
    [~A6_5];
    _println( Str );

    [~A7_4];
    _println( FormatStrNum( Depo.Количество, null, " ", 0 ) );

    [~A7_5];                                 /*  1,      2, 3, 4,  5...  род-жен., точность*/                 
    txtNum = NumToStr( int(Depo.Количество), "штука", "штуки", "штук", false,     0);
    println(StrUpr(txtNum, 1)); 


    if( Depo.Вид == 906 )
      [~A8_1];
      _println( "[√]" );
      [~A8_2];
      _println( "[ ]" );
    elif( Depo.Вид == 910 )
      [~A8_1];
      _println( "[ ]" );
      [~A8_2];
      _println( "[√]" );
    end;
    /* 2-я очередь */
    [~A8_3];
    _println( "[ ]" );
    [~A8_4];
    _println( "[ ]" );
    [~A8_5];
    _println( "[ ]" );

    [~A9_1];
    _println( "[ ]" );
    [~A9_2];
    _println( "[ ]" );
    [~A9_3];
    _println( "[ ]" );
    [~A9_4];
    _println( "[ ]" );
    [~A9_5];
    _println( "[√]" );

    [~A10_1_1];
    _println( TS_DEPOACCORDER );

    /* договор доверительного управления */
    Order = TS_OrderFD( Depo.OrderDocKind, Depo.OrderID );
    [~A10_N_1];
    _println( Order.Order().rec.Name );
    [~A10_N_2];
    _println( Order.Number() );
    [~A10_N_3]; 
    _println( DateToStr(Order.BeginDate()) );


    [~A11_1];
    /* Наименование счета депо */
    _println( Depo.НаимПасСчетаДепо /*Depo.НаимАктСчетаДепо*/ );

    if( Depo.Вид == 906 )
      [~A11_2];
      /* Номер активного счета депо (места хранения) */
      _println( Depo.Счет );
    elif( Depo.Вид == 910 )
      [~A11_2];
      _println( Depo.Счет1 );
    end;

    /* Номер активного счета депо */
    [~A12_1];
    /* Наименование и номер раздела счета  */
    _println( Depo.pType );
    [~A12_2];
    _println( Depo.pPartCode );

    [~A13];
    /* Значение характеристики "Место хранения" активного счета депо */
    _println( ПолучитьМестоХранения( Depo.AutoKey ) );

    /* не заполняется */
    [~A14];
    _println( "_________" );
    [~A15_1];
    _println( "_________" );
    [~A15_2];
    _println( "_________" );
    [~A15_3];
    _println( "_________" );
    [~A15_4];
    _println( "_________" );

    [~A16_1];
    _println( "_________" );
    [~A16_2];
    _println( "_________" );
    [~A16_3];
    _println( "_________" );
    [~A16_4];
    _println( "_________" );

    [~A17_1];
     /* Дата регистрации поручения  депо по Журналу входящих Депозитария */
    _println( date(Depo.ДатаРегистрации) );

    TimeSplit( time(Depo.ВремяРегистрации), hh, mm, null );
    /* Время регистрации поручения  депо по Журналу входящих Депозитария */
    [~A17_2];
    _println( hh );
    [~A17_3];
    _println( mm );

    /* не заполняется */
    [~A17_4];
    _println( "_________" );
    [~A18_1];
    _println( "_________" );
    [~A18_2];
    _println( "_________" );
    [~A18_3];
    _println( "_________" );
    [~A18_4];
    _println( "_________" );

    [~A20];
    _println(GetAgentByDepoID(Depo.Счет, DepoDate, Depo.rAutoKey, true) );       //;Depo.shortName ); - расшифровка подписи


  end;

  var TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile( TempFile );

END;

MACRO PrintDocument( SpGroundID, DocKind ):integer

  var RetVal:integer = 0;
  var Doc = DepoRecept( SpGroundID, DocKind );

  if( ValType(Doc.DocumentID) == V_UNDEF)
    msgbox("Поручение не найдено");
    RetVal = 1;
  elif( Doc.DocTempl > 0 )
    message("Печать договора ...");
    PrintPor(Doc, SpGroundID);
  else
    msgbox("шаблон не найден");
    RetVal = 1;
  end;

  return RetVal;
END;
