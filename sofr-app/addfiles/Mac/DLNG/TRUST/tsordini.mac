/* Инициализация операции по договору ДУ */
IMPORT OprInter, TSInter;

PRIVATE MACRO CheckOrderDP( Order:TRecHandler ):BOOL
  VAR RSD, CK = $0;

  VAR cmd = RSDCommand( " SELECT t_Id FROM dtsorder_dbt ord "+
                        "  WHERE     ord.t_OFBU = ? "+
                        "        AND ord.t_DocKind = ? "+
                        "        AND ord.t_Status = ? "+
                        "        AND ord.t_Trustor = ? "+
                        "        AND ord.t_ID != ? "+                                 
                        "        AND (not exists( select t_id from dtsiorqst_dbt req where req.t_OrderID = ord.t_ID AND req.t_Type = ? AND req.t_Status = ?))  "
                      );

  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, Order.rec.OFBU );
  cmd.addParam( "", RSDBP_IN, TS_DOC_DPOFBU );
  cmd.addParam( "", RSDBP_IN, TS_ORDERKIND_OPEN );
  cmd.addParam( "", RSDBP_IN, Order.rec.Trustor );
  cmd.addParam( "", RSDBP_IN, Order.rec.ID );
  cmd.addParam( "", RSDBP_IN, TS_KINDDECLAR_FULL );
  cmd.addParam( "", RSDBP_IN, TS_IOREQ_STATE_EXEC );

  cmd.execute();
  RSD = TRsbDataSet( cmd );

  if( RSD.MoveNext() AND (SQL_ConvTypeInteger(RSD.id) > 0) )
     msgbox( "Уже существует договор присоединения в фонде с данным учредителем" );
     return false;
  end;

  return true;
END;

MACRO InitOperation( KindOpr, KindDoc, FDoc )

  VAR Order = TRecHandler( "tsorder.dbt" );
  Order.SetRecordAddr( FDoc );

  if( Order.rec.DocKind == TS_DOC_DPOFBU )

     if( not CheckOrderDP( Order ) )
        return 1362; /*что бы не было сообщения об ошибке*/
     end;
  end;

  return 0;
END;