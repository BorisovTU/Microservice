/********************************************************************************************
 DESCRIPTION  : Отчет "Карточка аналитического учета по договорам ДОФБУ"
 PROGRAMMED BY: Shalygo S.M.
 CREATION DATE: 25.10.2010
********************************************************************************************/
IMPORT "TSCardAnAccRep_Form.mac", "tscomiss.mac", "tsrepsign.mac";

PRIVATE CLASS МесяцГод( Месяц_:integer, Год_:integer )
   VAR Месяц:integer = Месяц_,
       Год:integer   = Год_;
END;

PRIVATE MACRO СтрМесяцГод( MonTableI )
   return SubStr(TS_MonthName(MonTableI.Месяц), 1, 3) + "." + SubStr(string(MonTableI.Год), 3, 2);
END;

CLASS (TS_CardAnAcc_Report_General) TS_CardAnAccDOFBU_Report( FData:TSCardAnAccFormData )

  var m_FormData:TSCardAnAccFormData = FData;
  var m_CountOrder:integer = 0, m_Count:integer = -1;
  var m_ReportWasRun = false;
  var m_RSD_Order, m_Orders;
  var m_OrderFD:TS_OrderFD;
  var m_BegDate:date;
  var m_RepSign = TS_ReportData();

  var m_Select = "   from dtsorder_dbt tsorder, dspground_dbt ground                                                    " +
                 "  where tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end)                               " +
                 "    and tsorder.t_DocKind       = ?                                                                   " +
                 "    and tsorder.t_DP_ShareCalc  = ?                                                                   " +
                 "    and ground.t_SourceDocID    = tsorder.t_ID                                                        " +
                 "    and ground.t_SourceDocKind  = tsorder.t_DocKind                                                   " +
                 "    and (ground.t_TerminateDate = TO_DATE('01.01.0001','DD.MM.YYYY') or ground.t_TerminateDate >= ? ) " +
                 "    and ground.t_BeginningDate <= ?                                                                   ";

  /* смещение для текущего договора в соответствующей вкладке */
  var m_DeltaOrderN1 = 0,
      m_DeltaOrderN2 = 0,
      m_DeltaOrderN3 = 0,
      m_DeltaOrderN4 = 0,
      m_DeltaOrderN5 = 0,
      m_DeltaOrderN6 = 0,
      m_DeltaOrderN7 = 0,
      m_DeltaOrderN8 = 0;

  /* печались ли данные для текущего договора в соответствующей вкладке */
  var m_PrintOrderN2 = false,
      m_PrintOrderN3 = false,
      m_PrintOrderN4 = false,
      m_PrintOrderN5 = false,
      m_PrintOrderN6 = false,
      m_PrintOrderN7 = false;

  /* есть ли уже соответствующая вкладка в главной книге */
  var m_SheetN1 = false,
      m_SheetN2 = false,
      m_SheetN3 = false,
      m_SheetN4 = false,
      m_SheetN5 = false,
      m_SheetN6 = false,
      m_SheetN7 = false,
      m_SheetN8 = false;

  /* В этих переменных храним ячейки из различных листов, что бы потом их вывести на итогом */
  var GL_FVA3, GL_FVA5, GL_FVA6, GL_VB27,
      GL_VZ1, GL_VZ1_1, GL_VZ1_2, GL_VZ17_1, GL_VZ17, GL_VZ18_2, GL_VZ18_1, GL_VZ20_1, GL_VZ19_2, GL_VZ18, GL_VZ20,
      GL_FAA3, GL_AA14, GL_FAC2, GL_FAA10, GL_FAA5, GL_AA15,
      GL_FOA17_1, GL_FOA24, GL_OA19, GL_FOD2, GL_FOA15, GL_FOA11, GL_OA20;

  /* Константы координат ячеек: лист ИТОГ */

  CONST N1_A2_X   = "A";   CONST N1_A2_Y   = 2;
  CONST N1_B6_X   = "B";   CONST N1_B6_Y   = 6;
  CONST N1_B41_X  = "B";   CONST N1_B41_Y  = 41;
  CONST N1_C6_X   = "C";   CONST N1_C6_Y   = 6;
  CONST N1_C41_X  = "C";   CONST N1_C41_Y  = 41;
  CONST N1_C47_X  = "C";   CONST N1_C47_Y  = 47;
  CONST N1_C52_X  = "C";   CONST N1_C52_Y  = 52;
  CONST N1_C57_X  = "C";   CONST N1_C57_Y  = 57;
  CONST N1_D6_X   = "D";   CONST N1_D6_Y   = 6;
  CONST N1_D41_X  = "D";   CONST N1_D41_Y  = 41;
  CONST N1_E6_X   = "E";   CONST N1_E6_Y   = 6;
  CONST N1_E18_X  = "E";   CONST N1_E18_Y  = 18;
  CONST N1_E19_X  = "E";   CONST N1_E19_Y  = 19;
  CONST N1_E20_X  = "E";   CONST N1_E20_Y  = 20;
  CONST N1_E22_X  = "E";   CONST N1_E22_Y  = 22;
  CONST N1_E23_X  = "E";   CONST N1_E23_Y  = 23;
  CONST N1_E28_X  = "E";   CONST N1_E28_Y  = 28;
  CONST N1_E37_X  = "E";   CONST N1_E37_Y  = 37;
  CONST N1_E47_X  = "E";   CONST N1_E47_Y  = 47;
  CONST N1_F1_X   = "F";   CONST N1_F1_Y   = 1;
  CONST N1_F2_X   = "F";   CONST N1_F2_Y   = 2;
  CONST N1_F6_X   = "F";   CONST N1_F6_Y   = 6;
  CONST N1_F13_X  = "F";   CONST N1_F13_Y  = 13;
  CONST N1_F18_X  = "F";   CONST N1_F18_Y  = 18;
  CONST N1_F19_X  = "F";   CONST N1_F19_Y  = 19;
  CONST N1_F20_X  = "F";   CONST N1_F20_Y  = 20;
  CONST N1_F21_X  = "F";   CONST N1_F21_Y  = 21;
  CONST N1_F22_X  = "F";   CONST N1_F22_Y  = 22;
  CONST N1_F23_X  = "F";   CONST N1_F23_Y  = 23;
  CONST N1_F28_X  = "F";   CONST N1_F28_Y  = 28;
  CONST N1_G6_X   = "G";   CONST N1_G6_Y   = 6;
  CONST N1_G13_X  = "G";   CONST N1_G13_Y  = 13;
  CONST N1_G18_X  = "G";   CONST N1_G18_Y  = 18;
  CONST N1_G19_X  = "G";   CONST N1_G19_Y  = 19;
  CONST N1_G20_X  = "G";   CONST N1_G20_Y  = 20;
  CONST N1_G22_X  = "G";   CONST N1_G22_Y  = 22;
  CONST N1_G23_X  = "G";   CONST N1_G23_Y  = 23;
  CONST N1_G28_X  = "G";   CONST N1_G28_Y  = 28;
  CONST N1_H6_X   = "H";   CONST N1_H6_Y   = 6;
  CONST N1_H13_X  = "H";   CONST N1_H13_Y  = 13;
  CONST N1_H18_X  = "H";   CONST N1_H18_Y  = 18;
  CONST N1_H19_X  = "H";   CONST N1_H19_Y  = 19;
  CONST N1_H20_X  = "H";   CONST N1_H20_Y  = 20;
  CONST N1_H22_X  = "H";   CONST N1_H22_Y  = 22;
  CONST N1_H23_X  = "H";   CONST N1_H23_Y  = 23;
  CONST N1_H28_X  = "H";   CONST N1_H28_Y  = 28;
  CONST N1_I13_X  = "I";   CONST N1_I13_Y  = 13;
  CONST N1_I18_X  = "I";   CONST N1_I18_Y  = 18;
  CONST N1_I28_X  = "I";   CONST N1_I28_Y  = 28;
  CONST N1_I29_X  = "I";   CONST N1_I29_Y  = 29;
  CONST N1_I33_X  = "I";   CONST N1_I33_Y  = 33;
  CONST N1_I34_X  = "I";   CONST N1_I34_Y  = 34;
  CONST N1_J4_X   = "J";   CONST N1_J4_Y   = 4;
  CONST N1_J13_X  = "J";   CONST N1_J13_Y  = 13;
  CONST N1_J18_X  = "J";   CONST N1_J18_Y  = 18;
  CONST N1_J28_X  = "J";   CONST N1_J28_Y  = 28;
  CONST N1_J29_X  = "J";   CONST N1_J29_Y  = 29;
  CONST N1_K13_X  = "K";   CONST N1_K13_Y  = 13;
  CONST N1_L9_X   = "L";   CONST N1_L9_Y   = 9;
  CONST N1_L13_X  = "L";   CONST N1_L13_Y  = 13;
  CONST N1_L18_X  = "L";   CONST N1_L18_Y  = 18;
  CONST N1_L28_X  = "L";   CONST N1_L28_Y  = 28;
  CONST N1_M4_X   = "M";   CONST N1_M4_Y   = 4;
  CONST N1_M13_X  = "M";   CONST N1_M13_Y  = 13;
  CONST N1_N13_X  = "N";   CONST N1_N13_Y  = 13;
  CONST N1_O13_X  = "O";   CONST N1_O13_Y  = 13;
  CONST N1_Q13_X  = "Q";   CONST N1_Q13_Y  = 13;
  CONST N1_R13_X  = "R";   CONST N1_R13_Y  = 13;
  CONST N1_S13_X  = "S";   CONST N1_S13_Y  = 13;
  CONST N1_U13_X  = "U";   CONST N1_U13_Y  = 13;
  CONST N1_V13_X  = "V";   CONST N1_V13_Y  = 13;
  CONST N1_W13_X  = "W";   CONST N1_W13_Y  = 13;
  CONST N1_X13_X  = "X";   CONST N1_X13_Y  = 13;
  CONST N1_Y13_X  = "Y";   CONST N1_Y13_Y  = 13;
  CONST N1_Z13_X  = "Z";   CONST N1_Z13_Y  = 13;
  CONST N1_AA13_X = "AA";  CONST N1_AA13_Y = 13;
  CONST N1_AB13_X = "AB";  CONST N1_AB13_Y = 13;
  CONST N1_AC13_X = "AC";  CONST N1_AC13_Y = 13;
  CONST N1_AD13_X = "AD";  CONST N1_AD13_Y = 13;
  CONST N1_AE13_X = "AE";  CONST N1_AE13_Y = 13;
  CONST N1_AF13_X = "AF";  CONST N1_AF13_Y = 13;
  CONST N1_AG13_X = "AG";  CONST N1_AG13_Y = 13;
  CONST N1_AH13_X = "AH";  CONST N1_AH13_Y = 13;
  CONST N1_AI13_X = "AI";  CONST N1_AI13_Y = 13;
  CONST N1_AJ13_X = "AJ";  CONST N1_AJ13_Y = 13;
  CONST N1_AK13_X = "AK";  CONST N1_AK13_Y = 13;
  CONST N1_AP13_X = "AN";  CONST N1_AP13_Y = 13; /*шаблон менялся*/
  CONST N1_AQ13_X = "AO";  CONST N1_AQ13_Y = 13; /*шаблон менялся*/
  CONST N1_AR13_X = "AP";  CONST N1_AR13_Y = 13; /*шаблон менялся*/

  /* Константы координат ячеек: лист Акции */

  CONST N2_A12_X = "A";  CONST N2_A12_Y = 12;
  CONST N2_B2_X  = "B";  CONST N2_B2_Y  = 2;
  CONST N2_B8_X  = "B";  CONST N2_B8_Y  = 8;
  CONST N2_B17_X = "B";  CONST N2_B17_Y = 17;
  CONST N2_C8_X  = "C";  CONST N2_C8_Y  = 8;
  CONST N2_D8_X  = "D";  CONST N2_D8_Y  = 8;
  CONST N2_D12_X = "D";  CONST N2_D12_Y = 12;
  CONST N2_E8_X  = "E";  CONST N2_E8_Y  = 8;
  CONST N2_E12_X = "E";  CONST N2_E12_Y = 12;
  CONST N2_F8_X  = "F";  CONST N2_F8_Y  = 8;
  CONST N2_F12_X = "F";  CONST N2_F12_Y = 12;
  CONST N2_G1_X  = "G";  CONST N2_G1_Y  = 1;
  CONST N2_G8_X  = "G";  CONST N2_G8_Y  = 8;
  CONST N2_G12_X = "G";  CONST N2_G12_Y = 12;
  CONST N2_H8_X  = "H";  CONST N2_H8_Y  = 8;
  CONST N2_H12_X = "H";  CONST N2_H12_Y = 12;
  CONST N2_I8_X  = "I";  CONST N2_I8_Y  = 8;
  CONST N2_I12_X = "I";  CONST N2_I12_Y = 12;
  CONST N2_J8_X  = "J";  CONST N2_J8_Y  = 8;
  CONST N2_K12_X = "K";  CONST N2_K12_Y = 12;
  CONST N2_L4_X  = "L";  CONST N2_L4_Y  = 4;
  CONST N2_L5_X  = "L";  CONST N2_L5_Y  = 5;
  CONST N2_L12_X = "L";  CONST N2_L12_Y = 12;
  CONST N2_M8_X  = "M";  CONST N2_M8_Y  = 8;
  CONST N2_M12_X = "M";  CONST N2_M12_Y = 12;
  CONST N2_N8_X  = "N";  CONST N2_N8_Y  = 8;

  /* Константы координат ячеек: лист Акции Закрытые */

  CONST N3_A7_X  = "A";  CONST N3_A7_Y  = 7;
  CONST N3_D7_X  = "D";  CONST N3_D7_Y  = 7;
  CONST N3_E7_X  = "E";  CONST N3_E7_Y  = 7;
  CONST N3_F7_X  = "F";  CONST N3_F7_Y  = 7;
  CONST N3_H7_X  = "H";  CONST N3_H7_Y  = 7;
  CONST N3_K7_X  = "K";  CONST N3_K7_Y  = 7;
  CONST N3_L7_X  = "L";  CONST N3_L7_Y  = 7;
  CONST N3_M7_X  = "M";  CONST N3_M7_Y  = 7;
  CONST N3_N7_X  = "N";  CONST N3_N7_Y  = 7;
  CONST N3_O7_X  = "O";  CONST N3_O7_Y  = 7;
  CONST N3_P3_X  = "P";  CONST N3_P3_Y  = 3;
  CONST N3_P4_X  = "P";  CONST N3_P4_Y  = 4;
  CONST N3_P7_X  = "P";  CONST N3_P7_Y  = 7;
  CONST N3_R7_X  = "R";  CONST N3_R7_Y  = 7;

  /* Константы координат ячеек: лист Облигации */

  CONST N4_B3_X  = "B";  CONST N4_B3_Y  = 3;
  CONST N4_B9_X  = "B";  CONST N4_B9_Y  = 9;
  CONST N4_B13_X = "B";  CONST N4_B13_Y = 13;
  CONST N4_B23_X = "B";  CONST N4_B23_Y = 23;
  CONST N4_C9_X  = "C";  CONST N4_C9_Y  = 9;
  CONST N4_D9_X  = "D";  CONST N4_D9_Y  = 9;
  CONST N4_D18_X = "D";  CONST N4_D18_Y = 18;
  CONST N4_E9_X  = "E";  CONST N4_E9_Y  = 9;
  CONST N4_E13_X = "E";  CONST N4_E13_Y = 13;
  CONST N4_F13_X = "F";  CONST N4_F13_Y = 13;
  CONST N4_G2_X  = "G";  CONST N4_G2_Y  = 2;
  CONST N4_G9_X  = "G";  CONST N4_G9_Y  = 9;
  CONST N4_G13_X = "G";  CONST N4_G13_Y = 13;
  CONST N4_H9_X  = "H";  CONST N4_H9_Y  = 9;
  CONST N4_H13_X = "H";  CONST N4_H13_Y = 13;
  CONST N4_I9_X  = "I";  CONST N4_I9_Y  = 9;
  CONST N4_I13_X = "I";  CONST N4_I13_Y = 13;
  CONST N4_J9_X  = "J";  CONST N4_J9_Y  = 9;
  CONST N4_J13_X = "J";  CONST N4_J13_Y = 13;
  CONST N4_K9_X  = "K";  CONST N4_K9_Y  = 9;
  CONST N4_K13_X = "K";  CONST N4_K13_Y = 13;
  CONST N4_L5_X  = "L";  CONST N4_L5_Y  = 5;
  CONST N4_L6_X  = "L";  CONST N4_L6_Y  = 6;
  CONST N4_L9_X  = "L";  CONST N4_L9_Y  = 9;
  CONST N4_L13_X = "L";  CONST N4_L13_Y = 13;
  CONST N4_M9_X  = "M";  CONST N4_M9_Y  = 9;
  CONST N4_N9_X  = "N";  CONST N4_N9_Y  = 9;
  CONST N4_N13_X = "N";  CONST N4_N13_Y = 13;
  CONST N4_O9_X  = "O";  CONST N4_O9_Y  = 9;
  CONST N4_O13_X = "O";  CONST N4_O13_Y = 13;
  CONST N4_P9_X  = "P";  CONST N4_P9_Y  = 9;
  CONST N4_Q13_X = "Q";  CONST N4_Q13_Y = 13;
  CONST N4_R13_X = "R";  CONST N4_R13_Y = 13;
  CONST N4_S9_X  = "S";  CONST N4_S9_Y  = 9;
  CONST N4_S13_X = "S";  CONST N4_S13_Y = 13;
  CONST N4_T9_X  = "T";  CONST N4_T9_Y  = 9;
  CONST N4_U9_X  = "U";  CONST N4_U9_Y  = 9;
  CONST N4_U13_X = "U";  CONST N4_U13_Y = 13;
  CONST N4_V9_X  = "V";  CONST N4_V9_Y  = 9;
  CONST N4_W9_X  = "W";  CONST N4_W9_Y  = 9;
  CONST N4_W13_X = "W";  CONST N4_W13_Y = 13;
  CONST N4_X9_X  = "X";  CONST N4_X9_Y  = 9;
  CONST N4_X13_X = "X";  CONST N4_X13_Y = 13;
  CONST N4_Y9_X  = "Y";  CONST N4_Y9_Y  = 9;
  CONST N4_Y13_X = "Y";  CONST N4_Y13_Y = 13;
  CONST N4_Z9_X  = "Z";  CONST N4_Z9_Y  = 9;
  CONST N4_Z13_X = "Z";  CONST N4_Z13_Y = 13;
  CONST N4_AA9_X  = "AA"; CONST N4_AA9_Y  = 9;
  CONST N4_AA13_X = "AA"; CONST N4_AA13_Y = 13;
  CONST N4_AB9_X  = "AB"; CONST N4_AB9_Y  = 9;
  CONST N4_AB13_X = "AB"; CONST N4_AB13_Y = 13;
  CONST N4_AC13_X = "AC"; CONST N4_AC13_Y = 13;
  CONST N4_AD13_X = "AD"; CONST N4_AD13_Y = 13;
  CONST N4_AF13_X = "AF"; CONST N4_AF13_Y = 13;
  CONST N4_AG13_X = "AG"; CONST N4_AG13_Y = 13;
  CONST N4_AH13_X = "AH"; CONST N4_AH13_Y = 13;
  CONST N4_AI13_X = "AI"; CONST N4_AI13_Y = 13;
  CONST N4_AJ13_X = "AJ"; CONST N4_AJ13_Y = 13;
  CONST N4_AK13_X = "AK"; CONST N4_AK13_Y = 13;
  CONST N4_AL13_X = "AL"; CONST N4_AL13_Y = 13;
  CONST N4_AM13_X = "AM"; CONST N4_AM13_Y = 13;
  CONST N4_AN13_X = "AN"; CONST N4_AN13_Y = 13;

  /* Константы координат ячеек: лист Облигации Закрытые */

  CONST N5_A7_X  = "A";  CONST N5_A7_Y  = 7;
  CONST N5_B2_X  = "B";  CONST N5_B2_Y  = 2;
  CONST N5_D7_X_1= "D";  CONST N5_D7_Y_1= 7;
  CONST N5_D7_X  = "E";  CONST N5_D7_Y  = 7;
  CONST N5_E7_X  = "F";  CONST N5_E7_Y  = 7;
  CONST N5_F7_X  = "G";  CONST N5_F7_Y  = 7;
  CONST N5_G7_X  = "H";  CONST N5_G7_Y  = 7;
  CONST N5_H7_X  = "I";  CONST N5_H7_Y  = 7;
  CONST N5_J7_X  = "K";  CONST N5_J7_Y  = 7;
  CONST N5_M7_X  = "O";  CONST N5_M7_Y  = 7;
  CONST N5_N7_X  = "P";  CONST N5_N7_Y  = 7;
  CONST N5_O7_X  = "Q";  CONST N5_O7_Y  = 7;
  CONST N5_P7_X  = "R";  CONST N5_P7_Y  = 7;
  CONST N5_Q3_X  = "Q";  CONST N5_Q3_Y  = 3;
  CONST N5_Q4_X  = "Q";  CONST N5_Q4_Y  = 4;
  CONST N5_Q7_X  = "S";  CONST N5_Q7_Y  = 7;
  CONST N5_R7_X  = "T";  CONST N5_R7_Y  = 7;
  CONST N5_S7_X  = "U";  CONST N5_S7_Y  = 7;
  CONST N5_T7_X  = "V";  CONST N5_T7_Y  = 7;
  CONST N5_U7_X  = "W";  CONST N5_U7_Y  = 7;
  CONST N5_V7_X  = "X";  CONST N5_V7_Y  = 7;
  CONST N5_X7_X  = "Z";  CONST N5_X7_Y  = 7;
  CONST N5_Y7_X  = "AA"; CONST N5_Y7_Y  = 7;

  /* Константы координат ячеек: лист Векселя */

  CONST N6_B3_X  = "B";  CONST N6_B3_Y  = 3;
  CONST N6_B6_X  = "B";  CONST N6_B6_Y  = 6;
  CONST N6_C6_X  = "C";  CONST N6_C6_Y  = 6;
  CONST N6_D6_X  = "D";  CONST N6_D6_Y  = 6;
  CONST N6_E6_X  = "E";  CONST N6_E6_Y  = 6;
  CONST N6_E13_X = "E";  CONST N6_E13_Y = 13;
  CONST N6_E18_X = "E";  CONST N6_E18_Y = 18;
  CONST N6_F2_X  = "F";  CONST N6_F2_Y  = 2;
  CONST N6_F6_X  = "F";  CONST N6_F6_Y  = 6;
  CONST N6_F13_X = "F";  CONST N6_F13_Y = 13;
  CONST N6_H13_X = "H";  CONST N6_H13_Y = 13;
  CONST N6_I13_X = "I";  CONST N6_I13_Y = 13;
  CONST N6_J13_X = "J";  CONST N6_J13_Y = 13;
  CONST N6_K13_X = "K";  CONST N6_K13_Y = 13;
  CONST N6_L13_X = "L";  CONST N6_L13_Y = 13;
  CONST N6_N13_X = "N";  CONST N6_N13_Y = 13;
  CONST N6_O13_X = "O";  CONST N6_O13_Y = 13;
  CONST N6_P13_X = "P";  CONST N6_P13_Y = 13;
  CONST N6_Q13_X = "Q";  CONST N6_Q13_Y = 13;
  CONST N6_R13_X = "R";  CONST N6_R13_Y = 13;
  CONST N6_S13_X = "S";  CONST N6_S13_Y = 13;
  CONST N6_T13_X = "T";  CONST N6_T13_Y = 13;
  CONST N6_V13_X = "V";  CONST N6_V13_Y = 13;
  CONST N6_W13_X = "W";  CONST N6_W13_Y = 13;
  CONST N6_X13_X = "W";  CONST N6_X13_Y = 13; /*изменился шаблон*/
  CONST N6_Y8_X  = "Y";  CONST N6_Y8_Y  = 8;
  CONST N6_Y9_X  = "Y";  CONST N6_Y9_Y  = 9;
  CONST N6_Y10_X = "Y";  CONST N6_Y10_Y = 10;
  CONST N6_Y13_X = "X";  CONST N6_Y13_Y = 13; /*изменился шаблон*/
  CONST N6_Z13_X = "Y";  CONST N6_Z13_Y = 13; /*изменился шаблон*/

  /* Константы координат ячеек: лист Векселя Закрытые */

  CONST N7_E20_X = "E";  CONST N7_E20_Y = 20;
  CONST N7_H10_X = "H";  CONST N7_H10_Y = 10;
  CONST N7_H15_X = "H";  CONST N7_H15_Y = 15;
  CONST N7_J10_X = "J";  CONST N7_J10_Y = 10;
  CONST N7_J15_X = "J";  CONST N7_J15_Y = 15;
  CONST N7_L4_X  = "L";  CONST N7_L4_Y  = 4;
  CONST N7_L5_X  = "L";  CONST N7_L5_Y  = 5;
  CONST N7_L6_X  = "L";  CONST N7_L6_Y  = 6;
  CONST N7_L10_X = "L";  CONST N7_L10_Y = 10;
  CONST N7_L15_X = "L";  CONST N7_L15_Y = 15;
  CONST N7_M10_X = "M";  CONST N7_M10_Y = 10;
  CONST N7_M15_X = "M";  CONST N7_M15_Y = 15;
  CONST N7_N10_X = "N";  CONST N7_N10_Y = 10;
  CONST N7_N15_X = "N";  CONST N7_N15_Y = 15;
  CONST N7_O10_X = "O";  CONST N7_O10_Y = 10;
  CONST N7_O15_X = "O";  CONST N7_O15_Y = 15;
  CONST N7_P10_X = "P";  CONST N7_P10_Y = 10;
  CONST N7_P15_X = "P";  CONST N7_P15_Y = 15;
  CONST N7_Q15_X = "Q";  CONST N7_Q15_Y = 15;
  CONST N7_R10_X = "R";  CONST N7_R10_Y = 10;
  CONST N7_R15_X = "R";  CONST N7_R15_Y = 15;
  CONST N7_T15_X = "T";  CONST N7_T15_Y = 15;
  CONST N7_U15_X = "U";  CONST N7_U15_Y = 15;

  /* Константы координат ячеек: лист Пром_рез */

// номера ячеек не совпадают с названиями т.к. менялся шаблон
  CONST N8_A5_X  = "A";  CONST N8_A5_Y  = 3;
  CONST N8_A7_X  = "A";  CONST N8_A7_Y  = 5;
  CONST N8_A9_X  = "A";  CONST N8_A9_Y  = 7;
  CONST N8_A10_X = "A";  CONST N8_A10_Y = 9;
  CONST N8_A11_X = "A";  CONST N8_A11_Y = 11;
  CONST N8_A19_X = "A";  CONST N8_A19_Y = 13;
  CONST N8_A20_X = "A";  CONST N8_A20_Y = 15;
  CONST N8_A21_X = "A";  CONST N8_A21_Y = 17;


  PRIVATE MACRO N1_()
     return "'ИТОГ'!";
  END;

  PRIVATE MACRO N2_()
     return "'Акции'!";
  END;

  PRIVATE MACRO N3_()
     return "'Акции Закрытые'!";
  END;

  PRIVATE MACRO N4_()
     return "'Облигации'!";
  END;

  PRIVATE MACRO N5_()
     return "'Облигации Закрытые'!";
  END;

  PRIVATE MACRO N6_()
     return "'Векселя'!";
  END;

  PRIVATE MACRO N7_()
     return "'Векселя Закрытые'!";
  END;

  PRIVATE MACRO N8_()
     return "'Пром_рез'!";
  END;

  /* Функции получения ячеек: лист ИТОГ */

  PRIVATE MACRO N1_A2( dY:integer )
     return (N1_A2_X + string(N1_A2_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_B6( dY:integer, con:bool )
     var AddStr:string = "";
     if( (con != null) and (con == true) )
        AddStr = "$";
     end;
     return (AddStr + N1_B6_X + AddStr + string(N1_B6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_B41( dY:integer )
     return (N1_B41_X + string(N1_B41_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C6( dY:integer )
     return (N1_C6_X + string(N1_C6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C41( dY:integer )
     return (N1_C41_X + string(N1_C41_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C47( dY:integer )
     return (N1_C47_X + string(N1_C47_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C52( dY:integer )
     return (N1_C52_X + string(N1_C52_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C57( dY:integer )
     return (N1_C57_X + string(N1_C57_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D6( dY:integer )
     return (N1_D6_X + string(N1_D6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D41( dY:integer )
     return (N1_D41_X + string(N1_D41_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E6( dY:integer )
     return (N1_E6_X + string(N1_E6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E18( dY:integer )
     return (N1_E18_X + string(N1_E18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E19( dY:integer )
     return (N1_E19_X + string(N1_E19_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E20( dY:integer )
     return (N1_E20_X + string(N1_E20_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E22( dY:integer )
     return (N1_E22_X + string(N1_E22_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E23( dY:integer )
     return (N1_E23_X + string(N1_E23_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E28( dY:integer )
     return (N1_E28_X + string(N1_E28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E37( dY:integer )
     return (N1_E37_X + string(N1_E37_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E47( dY:integer )
     return (N1_E47_X + string(N1_E47_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F1( dY:integer )
     return (N1_F1_X + string(N1_F1_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F2( dY:integer )
     return ("$" + N1_F2_X + "$" + string(N1_F2_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F6( dY:integer )
     return (N1_F6_X + string(N1_F6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F13( dY:integer )
     return (N1_F13_X + string(N1_F13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F18( dY:integer )
     return (N1_F18_X + string(N1_F18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F19( dY:integer )
     return (N1_F19_X + string(N1_F19_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F20( dY:integer )
     return (N1_F20_X + string(N1_F20_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F21( dY:integer )
     return (N1_F21_X + string(N1_F21_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F22( dY:integer )
     return (N1_F22_X + string(N1_F22_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F23( dY:integer )
     return (N1_F23_X + string(N1_F23_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F28( dY:integer )
     return (N1_F28_X + string(N1_F28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G6( dY:integer )
     return (N1_G6_X + string(N1_G6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G13( dY:integer )
     return (N1_G13_X + string(N1_G13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G18( dY:integer )
     return (N1_G18_X + string(N1_G18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G19( dY:integer )
     return (N1_G19_X + string(N1_G19_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G20( dY:integer )
     return (N1_G20_X + string(N1_G20_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G22( dY:integer )
     return (N1_G22_X + string(N1_G22_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G23( dY:integer )
     return (N1_G23_X + string(N1_G23_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G28( dY:integer )
     return (N1_G28_X + string(N1_G28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H6( dY:integer )
     return (N1_H6_X + string(N1_H6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H13( dY:integer )
     return (N1_H13_X + string(N1_H13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H18( dY:integer )
     return (N1_H18_X + string(N1_H18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H19( dY:integer )
     return (N1_H19_X + string(N1_H19_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H20( dY:integer )
     return (N1_H20_X + string(N1_H20_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H22( dY:integer )
     return (N1_H22_X + string(N1_H22_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H23( dY:integer )
     return (N1_H23_X + string(N1_H23_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H28( dY:integer )
     return (N1_H28_X + string(N1_H28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I13( dY:integer )
     return (N1_I13_X + string(N1_I13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I18( dY:integer )
     return (N1_I18_X + string(N1_I18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I28( dY:integer )
     return (N1_I28_X + string(N1_I28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I29( dY:integer )
     return (N1_I29_X + string(N1_I29_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I33( dY:integer )
     return (N1_I33_X + string(N1_I33_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I34( dY:integer )
     return (N1_I34_X + string(N1_I34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J4( dY:integer )
     return (N1_J4_X + string(N1_J4_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J13( dY:integer )
     return (N1_J13_X + string(N1_J13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J18( dY:integer )
     return (N1_J18_X + string(N1_J18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J28( dY:integer )
     return (N1_J28_X + string(N1_J28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J29( dY:integer, con:bool )
     var AddStr:string = "";
     if( (con != null) and (con == true) )
        AddStr = "$";
     end;
     return (AddStr + N1_J29_X + AddStr + string(N1_J29_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_K13( dY:integer, con:bool )
     var AddStr:string = "";
     if( (con != null) and (con == true) )
        AddStr = "$";
     end;
     return (AddStr + N1_K13_X + AddStr + string(N1_K13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_L9( dY:integer, con:bool )
     var AddStr:string = "";
     if( (con != null) and (con == true) )
        AddStr = "$";
     end;
     return (AddStr + N1_L9_X + AddStr + string(N1_L9_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_L13( dY:integer )
     return (N1_L13_X + string(N1_L13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_L18( dY:integer )
     return (N1_L18_X + string(N1_L18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_L28( dY:integer )
     return (N1_L28_X + string(N1_L28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_M4( dY:integer )
     return (N1_M4_X + string(N1_M4_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_M13( dY:integer )
     return (N1_M13_X + string(N1_M13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_N13( dY:integer )
     return (N1_N13_X + string(N1_N13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_O13( dY:integer )
     return (N1_O13_X + string(N1_O13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_Q13( dY:integer )
     return (N1_Q13_X + string(N1_Q13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_R13( dY:integer )
     return (N1_R13_X + string(N1_R13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_S13( dY:integer )
     return (N1_S13_X + string(N1_S13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_U13( dY:integer )
     return (N1_U13_X + string(N1_U13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_V13( dY:integer )
     return (N1_V13_X + string(N1_V13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_W13( dY:integer )
     return (N1_W13_X + string(N1_W13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_X13( dY:integer )
     return (N1_X13_X + string(N1_X13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_Y13( dY:integer )
     return (N1_Y13_X + string(N1_Y13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_Z13( dY:integer )
     return (N1_Z13_X + string(N1_Z13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AA13( dY:integer )
     return (N1_AA13_X + string(N1_AA13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AB13( dY:integer )
     return (N1_AB13_X + string(N1_AB13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AC13( dY:integer )
     return (N1_AC13_X + string(N1_AC13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AD13( dY:integer )
     return (N1_AD13_X + string(N1_AD13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AE13( dY:integer )
     return (N1_AE13_X + string(N1_AE13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AF13( dY:integer )
     return (N1_AF13_X + string(N1_AF13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AG13( dY:integer )
     return (N1_AG13_X + string(N1_AG13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AH13( dY:integer )
     return (N1_AH13_X + string(N1_AH13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AI13( dY:integer, con:bool )
     var AddStr:string = "";
     if( (con != null) and (con == true) )
        AddStr = "$";
     end;
     return (AddStr + N1_AI13_X + AddStr + string(N1_AI13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AJ13( dY:integer )
     return (N1_AJ13_X + string(N1_AJ13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AK13( dY:integer )
     return (N1_AK13_X + string(N1_AK13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AP13( dY:integer )
     return (N1_AP13_X + string(N1_AP13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AQ13( dY:integer )
     return (N1_AQ13_X + string(N1_AQ13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_AR13( dY:integer )
     return (N1_AR13_X + string(N1_AR13_Y + m_DeltaOrderN1 + dY));
  END;

  /* Функции получения ячеек: лист Акции */

  PRIVATE MACRO N2_A12( dY:integer )
     return (N2_A12_X + string(N2_A12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_B2( dY:integer )
     return (N2_B2_X + string(N2_B2_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_B8( dY:integer )
     return (N2_B8_X + string(N2_B8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_B17( dY:integer )
     return (N2_B17_X + string(N2_B17_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_C8( dY:integer )
     return (N2_C8_X + string(N2_C8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_D8( dY:integer )
     return (N2_D8_X + string(N2_D8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_D12( dY:integer )
     return (N2_D12_X + string(N2_D12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_E8( dY:integer )
     return (N2_E8_X + string(N2_E8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_E12( dY:integer )
     return (N2_E12_X + string(N2_E12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_F8( dY:integer )
     return (N2_F8_X + string(N2_F8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_F12( dY:integer )
     return (N2_F12_X + string(N2_F12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_G1( dY:integer )
     return (N2_G1_X + string(N2_G1_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_G8( dY:integer )
     return (N2_G8_X + string(N2_G8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_G12( dY:integer )
     return (N2_G12_X + string(N2_G12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_H8( dY:integer )
     return (N2_H8_X + string(N2_H8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_H12( dY:integer )
     return (N2_H12_X + string(N2_H12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_I8( dY:integer )
     return (N2_I8_X + string(N2_I8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_I12( dY:integer )
     return (N2_I12_X + string(N2_I12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_J8( dY:integer )
     return (N2_J8_X + string(N2_J8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_K12( dY:integer )
     return (N2_K12_X + string(N2_K12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_L4( dY:integer )
     return (N2_L4_X + string(N2_L4_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_L5( dY:integer )
     return (N2_L5_X + string(N2_L5_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_L12( dY:integer )
     return (N2_L12_X + string(N2_L12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_M8( dY:integer )
     return (N2_M8_X + string(N2_M8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_M12( dY:integer )
     return (N2_M12_X + string(N2_M12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_N8( dY:integer )
     return (N2_N8_X + string(N2_N8_Y + m_DeltaOrderN2 + dY));
  END;

  /* Функции получения ячеек: лист Акции Закрытые */

  PRIVATE MACRO N3_A7( dY:integer )
     return (N3_A7_X + string(N3_A7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_D7( dY:integer )
     return (N3_D7_X + string(N3_D7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_E7( dY:integer )
     return (N3_E7_X + string(N3_E7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_F7( dY:integer )
     return (N3_F7_X + string(N3_F7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_H7( dY:integer )
     return (N3_H7_X + string(N3_H7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_K7( dY:integer )
     return (N3_K7_X + string(N3_K7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_L7( dY:integer )
     return (N3_L7_X + string(N3_L7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_M7( dY:integer )
     return (N3_M7_X + string(N3_M7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_N7( dY:integer )
     return (N3_N7_X + string(N3_N7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_O7( dY:integer )
     return (N3_O7_X + string(N3_O7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_P3( dY:integer )
     return (N3_P3_X + string(N3_P3_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_P4( dY:integer )
     return (N3_P4_X + string(N3_P4_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_P7( dY:integer )
     return (N3_P7_X + string(N3_P7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_R7( dY:integer )
     return (N3_R7_X + string(N3_R7_Y + m_DeltaOrderN3 + dY));
  END;

  /* Функции получения ячеек: лист Облигации */

  PRIVATE MACRO N4_B3( dY:integer )
     return (N4_B3_X + string(N4_B3_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_B9( dY:integer )
     return (N4_B9_X + string(N4_B9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_B13( dY:integer )
     return (N4_B13_X + string(N4_B13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_B23( dY:integer )
     return (N4_B23_X + string(N4_B23_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_C9( dY:integer )
     return (N4_C9_X + string(N4_C9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_D9( dY:integer )
     return (N4_D9_X + string(N4_D9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_D18( dY:integer )
     return (N4_D18_X + string(N4_D18_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_E9( dY:integer )
     return (N4_E9_X + string(N4_E9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_E13( dY:integer )
     return (N4_E13_X + string(N4_E13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_F13( dY:integer )
     return (N4_F13_X + string(N4_F13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_G2( dY:integer )
     return (N4_G2_X + string(N4_G2_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_G9( dY:integer )
     return (N4_G9_X + string(N4_G9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_G13( dY:integer )
     return (N4_G13_X + string(N4_G13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_H9( dY:integer )
     return (N4_H9_X + string(N4_H9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_H13( dY:integer )
     return (N4_H13_X + string(N4_H13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_I9( dY:integer )
     return (N4_I9_X + string(N4_I9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_I13( dY:integer )
     return (N4_I13_X + string(N4_I13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_J9( dY:integer )
     return (N4_J9_X + string(N4_J9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_J13( dY:integer )
     return (N4_J13_X + string(N4_J13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_K9( dY:integer )
     return (N4_K9_X + string(N4_K9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_K13( dY:integer )
     return (N4_K13_X + string(N4_K13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L5( dY:integer )
     return (N4_L5_X + string(N4_L5_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L6( dY:integer )
     return (N4_L6_X + string(N4_L6_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L9( dY:integer )
     return (N4_L9_X + string(N4_L9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L13( dY:integer )
     return (N4_L13_X + string(N4_L13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_M9( dY:integer )
     return (N4_M9_X + string(N4_M9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_N9( dY:integer )
     return (N4_N9_X + string(N4_N9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_N13( dY:integer )
     return (N4_N13_X + string(N4_N13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_O9( dY:integer )
     return (N4_O9_X + string(N4_O9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_O13( dY:integer )
     return (N4_O13_X + string(N4_O13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_P9( dY:integer )
     return (N4_P9_X + string(N4_P9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Q13( dY:integer )
     return (N4_Q13_X + string(N4_Q13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_R13( dY:integer )
     return (N4_R13_X + string(N4_R13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_S9( dY:integer )
     return (N4_S9_X + string(N4_S9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_S13( dY:integer )
     return (N4_S13_X + string(N4_S13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_T9( dY:integer )
     return (N4_T9_X + string(N4_T9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_U9( dY:integer )
     return (N4_U9_X + string(N4_U9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_U13( dY:integer )
     return (N4_U13_X + string(N4_U13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_V9( dY:integer )
     return (N4_V9_X + string(N4_V9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_W9( dY:integer )
     return (N4_W9_X + string(N4_W9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_W13( dY:integer )
     return (N4_W13_X + string(N4_W13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_X9( dY:integer )
     return (N4_X9_X + string(N4_X9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_X13( dY:integer )
     return (N4_X13_X + string(N4_X13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Y9( dY:integer )
     return (N4_Y9_X + string(N4_Y9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Y13( dY:integer )
     return (N4_Y13_X + string(N4_Y13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Z9( dY:integer )
     return (N4_Z9_X + string(N4_Z9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Z13( dY:integer )
     return (N4_Z13_X + string(N4_Z13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AA9( dY:integer )
     return (N4_AA9_X + string(N4_AA9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AA13( dY:integer )
     return (N4_AA13_X + string(N4_AA13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AB9( dY:integer )
     return (N4_AB9_X + string(N4_AB9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AB13( dY:integer )
     return (N4_AB13_X + string(N4_AB13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AC13( dY:integer )
     return (N4_AC13_X + string(N4_AC13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AD13( dY:integer )
     return (N4_AD13_X + string(N4_AD13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AF13( dY:integer )
     return (N4_AF13_X + string(N4_AF13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AG13( dY:integer )
     return (N4_AG13_X + string(N4_AG13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AH13( dY:integer )
     return (N4_AH13_X + string(N4_AH13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AI13( dY:integer )
     return (N4_AI13_X + string(N4_AI13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AJ13( dY:integer )
     return (N4_AJ13_X + string(N4_AJ13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AK13( dY:integer )
     return (N4_AK13_X + string(N4_AK13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AL13( dY:integer )
     return (N4_AL13_X + string(N4_AL13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AM13( dY:integer )
     return (N4_AM13_X + string(N4_AM13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AN13( dY:integer )
     return (N4_AN13_X + string(N4_AN13_Y + m_DeltaOrderN4 + dY));
  END;

  /* Функции получения ячеек: лист Облигации Закрытые */

  PRIVATE MACRO N5_A7( dY:integer )
     return (N5_A7_X + string(N5_A7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_B2( dY:integer )
     return (N5_B2_X + string(N5_B2_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_D7_1( dY:integer )
     return (N5_D7_X_1 + string(N5_D7_Y_1 + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_D7( dY:integer )
     return (N5_D7_X + string(N5_D7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_E7( dY:integer )
     return (N5_E7_X + string(N5_E7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_F7( dY:integer )
     return (N5_F7_X + string(N5_F7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_G7( dY:integer )
     return (N5_G7_X + string(N5_G7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_H7( dY:integer )
     return (N5_H7_X + string(N5_H7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_J7( dY:integer )
     return (N5_J7_X + string(N5_J7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_M7( dY:integer )
     return (N5_M7_X + string(N5_M7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_N7( dY:integer )
     return (N5_N7_X + string(N5_N7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_O7( dY:integer )
     return (N5_O7_X + string(N5_O7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_P7( dY:integer )
     return (N5_P7_X + string(N5_P7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Q3( dY:integer )
     return (N5_Q3_X + string(N5_Q3_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Q4( dY:integer )
     return (N5_Q4_X + string(N5_Q4_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Q7( dY:integer )
     return (N5_Q7_X + string(N5_Q7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_R7( dY:integer )
     return (N5_R7_X + string(N5_R7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_S7( dY:integer )
     return (N5_S7_X + string(N5_S7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_T7( dY:integer )
     return (N5_T7_X + string(N5_T7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_U7( dY:integer )
     return (N5_U7_X + string(N5_U7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_V7( dY:integer )
     return (N5_V7_X + string(N5_V7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_X7( dY:integer )
     return (N5_X7_X + string(N5_X7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Y7( dY:integer )
     return (N5_Y7_X + string(N5_Y7_Y + m_DeltaOrderN5 + dY));
  END;

  /* Функции получения ячеек: лист Векселя */

  PRIVATE MACRO N6_B3( dY:integer )
     return (N6_B3_X + string(N6_B3_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_B6( dY:integer )
     return (N6_B6_X + string(N6_B6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_C6( dY:integer )
     return (N6_C6_X + string(N6_C6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_D6( dY:integer )
     return (N6_D6_X + string(N6_D6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_E6( dY:integer )
     return (N6_E6_X + string(N6_E6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_E13( dY:integer )
     return (N6_E13_X + string(N6_E13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_E18( dY:integer )
     return (N6_E18_X + string(N6_E18_Y + m_DeltaOrderN6 + dY));
  END;

  /*Из ТЗ. Для того, чтобы при протягивании (если понадобиться) выгруженной формулы в Excel, значение ячейки не 
    изменялось, необходимо в формуле добавить символ $ перед обозначением строки и столбца. */
  PRIVATE MACRO N6_F2( dY:integer )
     return ("$"+N6_F2_X + "$"+ string(N6_F2_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_F6( dY:integer )
     return (N6_F6_X + string(N6_F6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_F13( dY:integer )
     return (N6_F13_X + string(N6_F13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_H13( dY:integer )
     return (N6_H13_X + string(N6_H13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_I13( dY:integer )
     return (N6_I13_X + string(N6_I13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_J13( dY:integer )
     return (N6_J13_X + string(N6_J13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_K13( dY:integer )
     return (N6_K13_X + string(N6_K13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_L13( dY:integer )
     return (N6_L13_X + string(N6_L13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_N13( dY:integer )
     return (N6_N13_X + string(N6_N13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_O13( dY:integer )
     return (N6_O13_X + string(N6_O13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_P13( dY:integer )
     return (N6_P13_X + string(N6_P13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Q13( dY:integer )
     return (N6_Q13_X + string(N6_Q13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_R13( dY:integer )
     return (N6_R13_X + string(N6_R13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_S13( dY:integer )
     return (N6_S13_X + string(N6_S13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_T13( dY:integer )
     return (N6_T13_X + string(N6_T13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_V13( dY:integer )
     return (N6_V13_X + string(N6_V13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_W13( dY:integer )
     return (N6_W13_X + string(N6_W13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_X13( dY:integer )
     return (N6_X13_X + string(N6_X13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y8( dY:integer )
     return (N6_Y8_X + string(N6_Y8_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y9( dY:integer )
     return (N6_Y9_X + string(N6_Y9_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y10( dY:integer )
     return (N6_Y10_X + string(N6_Y10_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y13( dY:integer )
     return (N6_Y13_X + string(N6_Y13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Z13( dY:integer )
     return (N6_Z13_X + string(N6_Z13_Y + m_DeltaOrderN6 + dY));
  END;

  /* Функции получения ячеек: лист Векселя Закрытые */

  PRIVATE MACRO N7_E20( dY:integer )
     return (N7_E20_X + string(N7_E20_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_H10( dY:integer )
     return (N7_H10_X + string(N7_H10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_H15( dY:integer )
     return (N7_H15_X + string(N7_H15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_J10( dY:integer )
     return (N7_J10_X + string(N7_J10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_J15( dY:integer )
     return (N7_J15_X + string(N7_J15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L4( dY:integer )
     return (N7_L4_X + string(N7_L4_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L5( dY:integer )
     return (N7_L5_X + string(N7_L5_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L6( dY:integer )
     return (N7_L6_X + string(N7_L6_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L10( dY:integer )
     return (N7_L10_X + string(N7_L10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L15( dY:integer )
     return (N7_L15_X + string(N7_L15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_M10( dY:integer )
     return (N7_M10_X + string(N7_M10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_M15( dY:integer )
     return (N7_M15_X + string(N7_M15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_N10( dY:integer )
     return (N7_N10_X + string(N7_N10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_N15( dY:integer )
     return (N7_N15_X + string(N7_N15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_O10( dY:integer )
     return (N7_O10_X + string(N7_O10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_O15( dY:integer )
     return (N7_O15_X + string(N7_O15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_P10( dY:integer )
     return (N7_P10_X + string(N7_P10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_P15( dY:integer )
     return (N7_P15_X + string(N7_P15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_Q15( dY:integer )
     return (N7_Q15_X + string(N7_Q15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_R10( dY:integer )
     return (N7_R10_X + string(N7_R10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_R15( dY:integer )
     return (N7_R15_X + string(N7_R15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_T15( dY:integer )
     return (N7_T15_X + string(N7_T15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_U15( dY:integer )
     return (N7_U15_X + string(N7_U15_Y + m_DeltaOrderN7 + dY));
  END;

  /* Функции получения ячеек: лист Пром_рез */

  PRIVATE MACRO N8_A5( dY:integer )
     return (N8_A5_X + string(N8_A5_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A7( dY:integer )
     return (N8_A7_X + string(N8_A7_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A9( dY:integer )
     return (N8_A9_X + string(N8_A9_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A10( dY:integer )
     return (N8_A10_X + string(N8_A10_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A11( dY:integer )
     return (N8_A11_X + string(N8_A11_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A19( dY:integer )
     return (N8_A19_X + string(N8_A19_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A20( dY:integer )
     return (N8_A20_X + string(N8_A20_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A21( dY:integer )
     return (N8_A21_X + string(N8_A21_Y + m_DeltaOrderN8 + dY));
  END;


  PRIVATE MACRO F( Str:string, Transform:bool ):string

     /* заменим разделитель целой и дробной частей */
     ReplaceSeparator( @Str, "." );
     ReplaceSeparator( @Str, "," );

     return FORMULA + Str;
  END;

  PRIVATE MACRO ДатаДоговора( Order:TS_OrderFD ):date
    var RetVal:date = date(0,0,0);
    var Query = " select nvl((select SPGround.t_RegistrDate from dspground_dbt SPGround where SPGround.t_SpGroundID = t_DocumentID), to_date('01-01-0001','DD-MM-YYYY')) RegistrDate " +
                "   from dtsiorqst_dbt " +
                "  where t_OrderID = ? " +
                "  order by t_ID       ";

    var SqlData = RSDCommand( Query );
    SqlData.addParam("", RSDBP_IN, Order.Order().rec.ID );
    SqlData.execute();

    var DataSet = TRsbDataSet(SqlData);
    if( DataSet.MoveNext() )
       RetVal = SQL_ConvTypeDate(DataSet.RegistrDate);
    end;

    if( RetVal == date(0,0,0) )
       RetVal = Order.BeginDate();
    end;

    return RetVal;
  END;

  PRIVATE MACRO СуммаПродажи( RSD, AmountLine:integer ):string

     var RetVal:string = "";

     if( ((RSD.Buy_Sale == PM_WRITEOFF_SUM_SALE) AND (RSD.KindSale == 330)) OR (RSD.KindSale == PM_WRTSUM_KIND_S) OR (RSD.KindSale == PM_WRTSUM_KIND_FS) )

        RetVal = F( N5_E7(AmountLine) + "*" + N5_D7(AmountLine) + "*" + N5_F7(AmountLine) + "/100" );

     elif( (RSD.KindSale == PM_WRTSUM_KIND_DI) or (RSD.KindSale == PM_WRTSUM_KIND_DP) )

        RetVal = F( N5_E7(AmountLine) + "*" + N5_D7_1(AmountLine) + "*" + N5_F7(AmountLine) );

     elif( RSD.KindSale == PM_WRTSUM_KIND_DC )
  
        RetVal = "";
  
     end;

     return RetVal;
  END;

  PRIVATE MACRO ПолученныйНКД( RSD, AmountLine:integer ):string

     var RetVal:string = "";
     var Query, SqlData, DataSet;

     if( (RSD.Buy_Sale == PM_WRITEOFF_SUM_SALE) AND (RSD.KindSale == 330) )

        Query = " select t_NKD            " +
                "   from dtsreqassets_dbt " +
                "  where t_FIID = ?       " +
                "    and t_RequestID = ?  ";

        SqlData = RSDCommand( Query );
        SqlData.addParam("", RSDBP_IN, RSD.FIID       );
        SqlData.addParam("", RSDBP_IN, RSD.DocumentID );
        SqlData.execute();

        DataSet = TRsbDataSet(SqlData);

        if( DataSet.MoveNext() )
           RetVal = string(SQL_ConvTypeSum(DataSet.NKD));
        end;

     elif( (RSD.KindSale == PM_WRTSUM_KIND_S) OR (RSD.KindSale == PM_WRTSUM_KIND_FS) )

        RetVal = string(RSD.NKDSaleAmount);

     elif( (RSD.KindSale == PM_WRTSUM_KIND_DI) OR (RSD.KindSale == PM_WRTSUM_KIND_DP) )

        RetVal = "";

     elif( RSD.KindSale == PM_WRTSUM_KIND_DC )
  
        RetVal = F( N5_E7(AmountLine) + "*" + N5_F7(AmountLine) );

     end;

     return RetVal;
  END;

  PRIVATE MACRO ВесьНачисленныйПД( RSD ):money

     var RetVal:money = $0.0;
     var ПД0:money = $0.0, ПД1:money = $0.0;
     var w0, w1;

     RetVal = RSD.InterestIncomeBuy + RSD.InterestIncomeAdd; /* ПД2 + ПДдонач */

     if( БылоПогашениеКупона(RSD.FIID, m_BegDate, m_FormData.ReportDate) == false )
        if( GetLotFirstInstance(RSD.BuySumID, @w0) )
           ПД0 = RestSum(w0.InterestIncome, RSD.Amount, w0.Amount);
           RetVal = RetVal - ПД0;
        end;
     end;

     return RetVal;
  END;

  PRIVATE MACRO CountOrder()
  
    var rsd, ds;
    
    rsd = RSDCommand( " select count(1) CountRec " + m_Select );
    rsd.addParam( "", RSDBP_IN, m_FormData.OFBU_Number );
    rsd.addParam( "", RSDBP_IN, m_FormData.OFBU_Number );
    rsd.addParam( "", RSDBP_IN, TS_DOC_OFBU            );
    rsd.addParam( "", RSDBP_IN, TS_CALCPART_MONEY      );
    rsd.addParam( "", RSDBP_IN, m_FormData.ReportDate  );
    rsd.addParam( "", RSDBP_IN, m_FormData.ReportDate  );
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       m_CountOrder = SQL_ConvTypeInteger(ds.rec.CountRec);
    end;

  END;

  PRIVATE MACRO OrderList()

    m_RSD_Order = RSDCommand( " select tsorder.t_ID " + m_Select );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.OFBU_Number );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.OFBU_Number );
    m_RSD_Order.addParam( "", RSDBP_IN, TS_DOC_OFBU            );
    m_RSD_Order.addParam( "", RSDBP_IN, TS_CALCPART_MONEY      );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.ReportDate  );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.ReportDate  );
    m_RSD_Order.execute();
    m_Orders = TRsbDataSet( m_RSD_Order );

    m_Count = -1;
    InitProgress( m_CountOrder, "Обработка договоров ДОФБУ", "Обработка договоров ДОФБУ" );

  END;

  PRIVATE MACRO OrderNext()

    var RetVal = false;

    if( m_Orders.MoveNext() )

       UseProgress(m_Count = m_Count + 1);

       m_OrderFD = TS_OrderFD(0, m_Orders.rec.ID);
       var YYYY:integer = 0, MM:integer = 0;
       DateSplit(m_FormData.ReportDate, null, MM, YYYY);
       m_BegDate = date(1, MM, YYYY);

       RetVal = true;
    end;

    return RetVal;
  END;

  PRIVATE MACRO OrderEnd()
    RemProgress();
  END;

  PRIVATE MACRO Печать_Акции(delta)

     record wsum(pmwrtsum);
     var dl_leg = TRecHandler("dl_leg");
     var dlsum  = TRecHandler("dlsum");
     var AmountPortf:integer  = 0;
     var SqlQuery, HeadSelect2, HeadSelect3, WhereFIID, FooterQuery, FooterQueryFIID, SqlQueryCom;
     var Query, RSD, Query1, RSD1, Query2, RSD2, Query3, RSD3, Query4, RSD4, Query5, RSD5;
     var ТСС;

     HeadSelect2 = " select /*+LEADING(lot)*/ wrt.t_FIID, fi.t_FaceValueFI, fi.t_Name, paym.t_Purpose, paym.t_DocKind, paym.t_DocumentID, " +
                   "        lot.t_Date, lot.t_Time, wrt.t_Amount, wrt.t_SumID, wrt.t_Sum, lot.t_DealID, lot.t_DealDate, " +
                   "        wrt.t_balancecost, lot.t_currency, lot.t_Kind, wrt.t_NKDAmount, wrt.t_InterestIncome ";
     HeadSelect3 = " select /*+LEADING(lot)*/ distinct fi.t_FIID, fi.t_Name ";
     SqlQuery = "   from v_scwrthistex wrt, dpmwrtsum_dbt lot, dfininstr_dbt fi,           " +
                "        dpmpaym_dbt paym                                                  " +
                "  where wrt.t_Amount > 0                                                  " +
                "    and wrt.t_instance = ( select max (hw.t_instance)                     " +
                "                             from v_scwrthist hw                          " +
                "                            where hw.t_ChangeDate <= ?                    " +
                "                              and hw.t_SumID = lot.t_SumID )              " +
                "    and lot.t_SumID    = wrt.t_SumID                                      " +
                "    and lot.t_Trust    = 'X'                                              " +
                "    and lot.t_Buy_Sale = ?                                                " +
                "    and lot.t_Contract = ?                                                " +
                "    and lot.t_State    = ?                                                " +
                "    and fi.t_FIID      = lot.t_FIID                                       " +
                "    and fi.t_FI_Kind   = ?                                                " +
                "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                "    and fi.t_FaceValueFI = ?                                              " +
                "    and paym.t_paymentid = lot.t_DocID                                    ";
     WhereFIID = "   and lot.t_FIID = ? ";
     FooterQuery = " order by fi.t_FIID, lot.t_Date, lot.t_Time                            ";
     FooterQueryFIID = " order by fi.t_FIID ";

     SqlQueryCom = " select /*+LEADING(dlsum)*/ dlsum.t_Date, sum(dlsum.t_Sum) Sum  " + 
                   "   from ddlsum_dbt dlsum, ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fi " +
                   "  where dlsum.t_Date between ? and ?        " +
                   "    and dlsum.t_Kind  = ?                   " +
                   "    and tick.t_DealID = dlsum.t_DocID       " +
                   "    and tick.t_BofficeKind in(?, ?)         " +
                   "    and tick.t_ClientContrID = ?            " +
                   "    and leg.t_DealID = tick.t_DealID        " +
                   "    and fi.t_FIID = leg.t_PFI               " +
                   "    and fi.t_FI_Kind   = ?                                                " +
                   "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                   " group by dlsum.t_Date                      " +
                   " order by dlsum.t_Date                      ";

     MACRO КоличествоСтрокПоБумаге( FIID:integer ):integer

        var RetVal = 0;
        var Select = RSDCommand( " select count(1) NRec from ( " + HeadSelect2 + SqlQuery + WhereFIID + " ) " );
        Select.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Select.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Select.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Select.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Select.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Select.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
        Select.addParam("", RSDBP_IN, NATCUR                );
        Select.addParam("", RSDBP_IN, FIID                  );
        Select.execute();

        var RSDSelect = TRsbDataSet(Select);

        if( RSDSelect.MoveNext() )
           RetVal = SQL_ConvTypeInteger(RSDSelect.NRec);
        end;

        return RetVal;
     END;

     MACRO PrintLineTable1( N2_AA1, N2_AA2, N2_AA3, N2_AA4, N2_AA5, N2_AA6, N2_AA7, N2_AA8, N2_AA9, N2_AA10,
                            N2_AA11, N2_AA12, N2_AA16, N2_AA17 )
        PrintTableLine( "N2_AA1",  N2_AA1,  null,
                        "N2_AA2",  N2_AA2,  null,
                        "N2_AA3",  N2_AA3,  null,
                        "N2_AA4",  N2_AA4,  null,
                        "N2_AA5",  N2_AA5,  null,
                        "N2_AA6",  N2_AA6,  null,
                        "N2_AA7",  N2_AA7,  null,
                        "N2_AA8",  N2_AA8,  null,
                        "N2_AA9",  N2_AA9,  null,
                        "N2_AA10", N2_AA10, null,
                        "N2_AA11", N2_AA11, null,
                        "N2_AA12", N2_AA12, null,
                        "N2_AA16", N2_AA16, null,
                        "N2_AA17", N2_AA17, null);
     END;

     MACRO PrintLineTable2( N2_AB1, N2_AB2, N2_AB3, N2_AB4, N2_AB5, N2_AB6, N2_AB7, N2_AB8, N2_AB9, N2_AB10,
                            N2_AB11, N2_AB12, N2_AB13 )
        PrintTableLine( "N2_AB1",  N2_AB1,  null,
                        "N2_AB2",  N2_AB2,  null,
                        "N2_AB3",  N2_AB3,  null,
                        "N2_AB4",  N2_AB4,  null,
                        "N2_AB5",  N2_AB5,  null,
                        "N2_AB6",  N2_AB6,  null,
                        "N2_AB7",  N2_AB7,  null,
                        "N2_AB8",  N2_AB8,  null,
                        "N2_AB9",  N2_AB9,  null,
                        "N2_AB10", N2_AB10, null,
                        "N2_AB11", N2_AB11, null,
                        "N2_AB12", N2_AB12, null,
                        "N2_AB13", N2_AB13, null);
     END;

     MACRO PrintLineTable3( N2_AC1, N2_AC2 )
        PrintTableLine( "N2_AC1",  N2_AC1,  null,
                        "N2_AC2",  N2_AC2,  null);
     END;

     Query = RSDCommand( " select case when exists ( " + HeadSelect2 + SqlQuery + " ) then 1 else 0 end NRec from dual " );
     Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
     Query.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
     Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
     Query.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
     Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
     Query.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
     Query.addParam("", RSDBP_IN, NATCUR                );
     Query.execute();

     RSD = TRsbDataSet(Query);

     var ExistsLot = 0;
     if( RSD.MoveNext() )
        ExistsLot = SQL_ConvTypeInteger(RSD.NRec);
     end;

     Query4 = RSDCommand( " select count(1) NRec from ( " + SqlQueryCom + " ) " );
     Query4.addParam("", RSDBP_IN, m_BegDate                       );
     Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
     Query4.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
     Query4.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
     Query4.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
     Query4.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
     Query4.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
     Query4.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE              );
     Query4.execute();

     RSD4 = TRsbDataSet(Query4);

     var ExistsCom:integer = 0;
     if( RSD4.MoveNext() )
        ExistsCom = SQL_ConvTypeInteger(RSD4.NRec);
     end;

     if( (ExistsLot > 0) or (ExistsCom > 0) )

        if( m_SheetN2 == false )
           UseNewSheetInTotalBook();
           m_SheetN2 = true;
        end;
        SetActiveSheet( "Акции" );

        m_PrintOrderN2 = true;

        Query1 = RSDCommand( " select count(1) NRec from ( " + HeadSelect3 + SqlQuery + " ) " );
        Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query1.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query1.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query1.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
        Query1.addParam("", RSDBP_IN, NATCUR                );
        Query1.execute();

        RSD1 = TRsbDataSet(Query1);

        if( RSD1.MoveNext() )
           AmountPortf = SQL_ConvTypeInteger(RSD1.NRec); /* количество строк в таблице "портфель" */
        end;

        var DeltaPortfItog = max(AmountPortf, 1);

        /* печатаем шапку */

        PrintFormatString( "", "N2_C1",   F( N1_() + N1_A2(0) ),
                               "N2_G1",   F( N1_() + N1_F1(0) ),
                               "N2_AD1",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, "Дата окончания предыдущего месяца:", ""),
                               "N2_AD2",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, (m_BegDate - 1), ""),
                               "N2_AA13", F( N2_J8(DeltaPortfItog) + "*100/" + N2_N8(DeltaPortfItog) + "*" + N8_() + N8_A9(0) ),
                               "N2_L4",   TS_IIF(m_PrintOrderN3, F( N3_() + N3_P3(0) ), 0.0),
                               "N2_AA15", F( "(" + N2_L4(0) + "+" + N2_J8(DeltaPortfItog) + "+" + N1_() + N1_C52(delta) + ")*100*" + N8_() + N8_A9(0) + "/(" + N8_() + N8_A7(0) + "+" + N2_N8(DeltaPortfItog) + "+" + TS_IIF(m_PrintOrderN3, N3_() + N3_P4(0), "0") + ")" ) );

        GL_AA14 = N2_L4(0);
        GL_AA15 = N2_L5(0);

        /* печатем таблицу "портфель" */
        RegisterTable( "N2_MainTable_1", "",
                       "N2_AA1", "N2_AA2", "N2_AA3", "N2_AA4", "N2_AA5", "N2_AA6", "N2_AA7", "N2_AA8",
                       "N2_AA9", "N2_AA10", "N2_AA11", "N2_AA12", "N2_AA16", "N2_AA17" );

        var DeltaDealItog = DeltaPortfItog - 1;

        var i = 0;
        if( AmountPortf > 0 )

           Query2 = RSDCommand( HeadSelect3 + SqlQuery + FooterQueryFIID );
           Query2.addParam("", RSDBP_IN, m_FormData.ReportDate );
           Query2.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
           Query2.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
           Query2.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
           Query2.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
           Query2.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
           Query2.addParam("", RSDBP_IN, NATCUR                );
           Query2.execute();
          
           RSD2 = TRsbDataSet(Query2);
          
           while( RSD2.MoveNext() )
          
              var L12:string = "";
              var СтрокПоБумаге = КоличествоСтрокПоБумаге(RSD2.FIID);
              DeltaDealItog = DeltaDealItog + СтрокПоБумаге + TS_IIF(i == 0, 0, 1); /* итоговая строка по данной бумаге в таблице "Сделки приобретения" */
          
              var j = СтрокПоБумаге;
              while(j > 0)
                 if( j == СтрокПоБумаге )
                    L12 = N2_L12(DeltaDealItog - СтрокПоБумаге);
                 else
                    L12 = L12 + ";" + N2_L12(DeltaDealItog - СтрокПоБумаге);
                 end;
                 j = j - 1;
              end;
          
              ТСС = ПолучитьТСС(RSD2.FIID, NATCUR, m_FormData.ReportDate - 1);
              PrintLineTable1( RSD2.Name,
                               F( N2_D12(DeltaDealItog) ),
                               F( N2_F12(DeltaDealItog) ),
                               F( N2_C8(i) + "+" + N2_E8(i) ),
                               F( N2_G12(DeltaDealItog) ),
                               F( N2_I12(DeltaDealItog) ),
                               TS_IIF( ТСС > 0, ТСС, F( N2_F12(DeltaDealItog) + "/" + N2_B8(i) ) ),
                               F( N2_G8(i) + "*" + N2_B8(i) + "*" + N8_() + N8_A11(0) + "/100" ),
                               F( N2_B8(i) + "*" + N2_G8(i) + "-" + N2_H8(i) ),
                               F( N2_I8(i) + "-" + N2_D8(i) ),
                               F( FormulaMAX() + "(" + L12 + ")" ),
                               F( N2_J8(i) + "/" + N2_N8(i) + "*" + N8_() + N8_A9(0) + "*100" ),
                               F( N2_I8(i) + "-" + N2_F8(i) ),
                               F( N2_M12(DeltaDealItog) ) );
          
              i = i + 1;
           end;
        else
           PrintLineTable1( "",
                            F( N2_D12(DeltaDealItog+1) ),
                            F( N2_F12(DeltaDealItog+1) ),
                            F( N2_C8(0) + "+" + N2_E8(0) ),
                            F( N2_G12(DeltaDealItog+1) ),
                            F( N2_I12(DeltaDealItog+1) ),
                            0.0,
                            F( N2_G8(0) + "*" + N2_B8(0) + "*" + N8_() + N8_A11(0) + "/100" ),
                            F( N2_B8(0) + "*" + N2_G8(0) + "-" + N2_H8(0) ),
                            F( N2_I8(0) + "-" + N2_D8(0) ),
                            F( FormulaMAX() + "(" + N2_L12(DeltaDealItog+1) + ")" ),
                            F( N2_J8(0) + "/" + N2_N8(0) + "*" + N8_() + N8_A9(0) + "*100" ),
                            F( N2_I8(0) + "-" + N2_F8(0) ),
                            F( N2_M12(DeltaDealItog+1) ) );
          
           i = i + 1;
        end;

        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable1( "ИТОГО:",
                         F( FormulaSUM() + "(" + N2_B8(0) + ":" + N2_B8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_C8(0) + ":" + N2_C8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_D8(0) + ":" + N2_D8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_E8(0) + ":" + N2_E8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_F8(0) + ":" + N2_F8(i-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + N2_H8(0) + ":" + N2_H8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_I8(0) + ":" + N2_I8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_J8(0) + ":" + N2_J8(i-1) + ")" ),
                         "",
                         "",
                         F( FormulaSUM() + "(" + N2_M8(0) + ":" + N2_M8(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N2_N8(0) + ":" + N2_N8(i-1) + ")" ));

        GL_FAA3  = N2_C8(i);
        GL_FAA10 = N2_J8(i);
        GL_FAA5  = N2_E8(i);

        EndTable();
        CopyAllSheetInTotalBook( "Акции", false, "N2_Table1", 0, "Акции" );

        /* печатем таблицу "Сделки приобретения" */

        var DeltaDeal = DeltaPortfItog - 1;

        Query3 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
        Query3.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query3.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query3.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query3.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query3.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query3.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
        Query3.addParam("", RSDBP_IN, NATCUR                );
        Query3.execute();

        RSD3 = TRsbDataSet(Query3);

        RegisterTable( "N2_MainTable_2", "",
                       "N2_AB1", "N2_AB2", "N2_AB3", "N2_AB4", "N2_AB5", "N2_AB6", "N2_AB7", "N2_AB8", "N2_AB9",
                       "N2_AB10", "N2_AB11", "N2_AB12", "N2_AB13" );

        i = 0;
        var k = 0; /* количество итоговых строк */
        var PrevFIID = 0;
        var AB4 = "", AB5 = "", AB6 = "", AB7 = "", AB9 = "", AB11 = "", AB13 = "";
        if( AmountPortf > 0 )
           while( RSD3.MoveNext() )
          
              if( (PrevFIID != RSD3.FIID) and (i != 0) )
                 /* печатаем итог по выпуску */
                 SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                 PrintLineTable2( "", "", "",
                                  F( FormulaSUM() + "(" + AB4 + ":" + N2_D12(DeltaDeal+i+k-1) + ")" ),
                                  F( FormulaSUM() + "(" + AB5 + ":" + N2_E12(DeltaDeal+i+k-1) + ")" ),
                                  F( FormulaSUM() + "(" + AB6 + ":" + N2_F12(DeltaDeal+i+k-1) + ")" ),
                                  F( FormulaSUM() + "(" + AB7 + ":" + N2_G12(DeltaDeal+i+k-1) + ")" ),
                                  "",
                                  F( FormulaSUM() + "(" + AB9 + ":" + N2_I12(DeltaDeal+i+k-1) + ")" ),
                                  "",
                                  F( FormulaSUM() + "(" + AB11 + ":" + N2_K12(DeltaDeal+i+k-1) + ")" ),
                                  "",
                                  F( FormulaSUM() + "(" + AB13 + ":" + N2_M12(DeltaDeal+i+k-1) + ")" ),
                                  "");
                 AB4 = ""; AB5 = ""; AB6 = ""; AB7 = ""; AB9 = ""; AB11 = ""; AB13 = "";
                 k = k + 1;
              end;
          
              var InCap = ( (RSD3.Kind == 340) and (RSD3.DocKind == TS_DOC_DECLAR) ); /* операции внесения капитала */
          
              var N2_AB5 = $0.0; /* Цена */
              var N2_AB7 = $0.0; /* Комиссия брокера и биржи */
              if( InCap == false )
                 FindDL_LEG( TS_IIF(RSD3.Purpose == BRi, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK), RSD3.DealID, 0, dl_leg );
          
                 if( dl_leg.rec.RelativePrice != "X" )
                    N2_AB5 = dl_leg.rec.Price;
                 else
                    var Nominal = TS_GetFaceValue(RSD3.FIID, SQL_ConvTypeDate(RSD3.Date));
                    if( Nominal != 0.0 )
                       N2_AB5 = dl_leg.rec.Price / 100.0 * Nominal;
                    end;
                 end;
          
                 if( dl_leg.rec.Principal != 0.0 )
                    if( FindDLSUM( RSD3.DocKind, RSD3.DealID, DLSUM_KIND_AGENT_PERIOD, RSD3.DealDate, dlsum ) == 0)
                       N2_AB7 = N2_AB7 + dlsum.rec.Sum;
                    end;
                    if( FindDLSUM( RSD3.DocKind, RSD3.DealID, DLSUM_KIND_AGENT_ONCE, RSD3.DealDate, dlsum ) == 0)
                       N2_AB7 = N2_AB7 + dlsum.rec.Sum;
                    end;
                    if( FindDLSUM( RSD3.DocKind, RSD3.DealID, DLSUM_KIND_AGENT_ONCE_IMPORT, RSD3.DealDate, dlsum ) == 0)
                       N2_AB7 = N2_AB7 + dlsum.rec.Sum;
                    end;
                    N2_AB7 = N2_AB7 * RSD3.Amount / dl_leg.rec.Principal;
                 end;
              else
                 N2_AB5 = ПолучитьКурсИзВВК( RSD3.FIID, RSD3.DocumentID );
              end;

              var N2_AB12:string = "";
              if( m_OrderFD.BeginDate() >= m_BegDate )
                 N2_AB12 = F( N2_G1(0) + "-" + N2_A12(DeltaDeal+i+k) );
              else
                 N2_AB12 = F( FormulaIF() + "(" + N2_A12(DeltaDeal+i+k) + ">" + N2_B2(0) + ";" + N2_G1(0) + "-" + N2_A12(DeltaDeal+i+k) + ";" + N2_G1(0) + "-" + N2_B2(0) + ")" );
              end;

              ТСС = ПолучитьТСС(RSD3.FIID, RSD3.FaceValueFI, m_FormData.ReportDate - 1);
              PrintLineTable2( SQL_ConvTypeDate(RSD3.Date),
                               SQL_ConvTypeTime(RSD3.Time),
                               RSD3.Name,
                               RSD3.Amount,
                               F( ДУ_ЧислоCЗаданнойТочностью(N2_AB5,4) ),
                               F( N2_D12(DeltaDeal+i+k) + "*" + N2_E12(DeltaDeal+i+k) ),
                               N2_AB7,
                               F( ДУ_ЧислоCЗаданнойТочностью(ЦенаПоБалансу( RSD3.SumID, RSD3.FIID, RSD3.FaceValueFI, m_FormData.ReportDate ),4) ),
                               F( N2_H12(DeltaDeal+i+k) + "*" + N2_D12(DeltaDeal+i+k) ),
                               TS_IIF( ТСС > 0, F( ДУ_ЧислоCЗаданнойТочностью(ТСС,4) ), F( N2_E12(DeltaDeal+i+k) ) ),
                               F( N2_I12(DeltaDeal+i+k) + "-" + N2_F12(DeltaDeal+i+k) ),
                               N2_AB12,
                               F( N2_F12(DeltaDeal+i+k) + "*" + N2_L12(DeltaDeal+i+k) ));
          
              if( AB4 == "" )
                 AB4  = N2_D12(DeltaDeal+i+k);
                 AB5  = N2_E12(DeltaDeal+i+k);
                 AB6  = N2_F12(DeltaDeal+i+k);
                 AB7  = N2_G12(DeltaDeal+i+k);
                 AB9  = N2_I12(DeltaDeal+i+k);
                 AB11 = N2_K12(DeltaDeal+i+k);
                 AB13 = N2_M12(DeltaDeal+i+k);
              end;
          
              PrevFIID = RSD3.FIID;
          
              i = i + 1;
           end;
        else
           PrintLineTable2( F( N2_G1(0) ),
                            "",
                            "",
                            0.0,
                            0.0,
                            F( N2_D12(DeltaDeal+i+k) + "*" + N2_E12(DeltaDeal+i+k) ),
                            0.0,
                            0.0,
                            F( N2_H12(DeltaDeal+i+k) + "*" + N2_D12(DeltaDeal+i+k) ),
                            0.0,
                            F( N2_I12(DeltaDeal+i+k) + "-" + N2_F12(DeltaDeal+i+k) ),
                            F( N2_G1(0) + "-" + N2_A12(DeltaDeal+i+k) ),
                            F( N2_F12(DeltaDeal+i+k) + "*" + N2_L12(DeltaDeal+i+k) ));
          
           AB4  = N2_D12(DeltaDeal+i+k);
           AB5  = N2_E12(DeltaDeal+i+k);
           AB6  = N2_F12(DeltaDeal+i+k);
           AB7  = N2_G12(DeltaDeal+i+k);
           AB9  = N2_I12(DeltaDeal+i+k);
           AB11 = N2_K12(DeltaDeal+i+k);
           AB13 = N2_M12(DeltaDeal+i+k);
          
           i = i + 1;
        end;

        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        /* печатаем итог по последнему выпуску */
        PrintLineTable2( "", "", "",
                         F( FormulaSUM() + "(" + AB4 + ":" + N2_D12(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + AB5 + ":" + N2_E12(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + AB6 + ":" + N2_F12(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + AB7 + ":" + N2_G12(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AB9 + ":" + N2_I12(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AB11 + ":" + N2_K12(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AB13 + ":" + N2_M12(DeltaDeal+i+k-1) + ")" ),
                         "");

        EndTable();
        CopyAllSheetInTotalBook( "Акции", false, "N2_Table2", 0, "Акции" );

        /* печатем таблицу "Комиссии" */
        
        if( ExistsCom > 0 )

           var DeltaCom = DeltaDeal + i + k - 1;
           RegisterTable( "N2_MainTable_3", "", "N2_AC1", "N2_AC2" );

           Query5 = RSDCommand( SqlQueryCom );
           Query5.addParam("", RSDBP_IN, m_BegDate                       );
           Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
           Query5.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
           Query5.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
           Query5.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
           Query5.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
           Query5.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
           Query5.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE              );
           Query5.execute();

           RSD5 = TRsbDataSet(Query5);

           i = 0;
           while( RSD5.MoveNext() )
              PrintLineTable3( SQL_ConvTypeDate(RSD5.Date), RSD5.Sum );
              i = i + 1;
           end;

           SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
           PrintLineTable3( "ИТОГО:", F( FormulaSUM() + "(" + N2_B17(DeltaCom) + ":" + N2_B17(DeltaCom + i - 1) + ")" ) );

           GL_FAC2 = N2_B17(DeltaCom + i);

           EndTable();
           CopyAllSheetInTotalBook( "Акции", false, "N2_Table3", 0, "Акции" );

        end;

     end;

  END;


  PRIVATE MACRO Печать_АкцииЗакрытые()

    var AZ_ExistsLNK:integer = 0;
    record wsum(pmwrtsum);
    var SqlQueryHead1, SqlQuery;
    var Query, RSD, Query1, RSD1;

    SqlQueryHead1 = " select /*+LEADING(lnk)*/ lnk.t_Amount, lnk.t_SumSale, lnk.t_SumBuy, wrtbuy.t_SumID BuySumID, wrtsale.t_DealID DealIDSale, wrtsale.t_Buy_Sale Buy_Sale, wrtsale.t_Kind KindSale," +
                    "        wrtsale.t_Date DateSale, wrtsale.t_Time TimeSale, wrtbuy.t_Date DateBuy, wrtbuy.t_Time TimeBuy, " +
                    "        fi.t_Name, fi.t_FIID, fi.t_FaceValueFI, paym.t_DocumentID                                       ";
    SqlQuery = "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt wrtsale, dpmwrtsum_dbt wrtbuy, dfininstr_dbt fi, " +
               "        dpmpaym_dbt paym                                                 " +
               "  where lnk.t_SaleID       = wrtsale.t_SumID                             " +
               "    and lnk.t_BuyID        = wrtbuy.t_SumID                              " +
               "    and wrtbuy.t_Trust     = 'X'                                         " +
               "    and wrtsale.t_fiid     = fi.t_fiid                                   " +
               "    and wrtsale.t_Contract = ?                                           " +
               "    and wrtsale.t_Date    >= ?                                           " +
               "    and wrtsale.t_Date    <= ?                                           " +
               "    and wrtsale.t_Currency = fi.t_FaceValueFI                            " +
               "    and wrtbuy.t_Currency  = fi.t_FaceValueFI                            " +
               "    and fi.t_FaceValueFI   = ?                                           " +
               "    and fi.t_FI_Kind       = ?                                           " +
               "    and RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
               "    and paym.t_paymentid   = wrtsale.t_DocID                             ";
    var SqlQueryFooter = " order by wrtsale.t_Date, wrtsale.t_Time, fi.t_FIID, wrtsale.t_SumID ";

    MACRO PrintLineTable1( N3_AZ2, N3_AZ3, N3_AZ4, N3_AZ5, N3_AZ6, N3_AZ7, N3_AZ8, N3_AZ9, N3_AZ10, N3_AZ11, N3_AZ12, N3_AZ13, N3_AZ14,
                           N3_AZ15, N3_AZ16, N3_AZ17, N3_AZ18 )
       PrintTableLine( "N3_AZ2",  N3_AZ2,  null,
                       "N3_AZ3",  N3_AZ3,  null,
                       "N3_AZ4",  N3_AZ4,  null,
                       "N3_AZ5",  N3_AZ5,  null,
                       "N3_AZ6",  N3_AZ6,  null,
                       "N3_AZ7",  N3_AZ7,  null,
                       "N3_G7",   "",      null, /* разделительное поле */
                       "N3_AZ8",  N3_AZ8,  null,
                       "N3_AZ9",  N3_AZ9,  null,
                       "N3_AZ10", N3_AZ10, null,
                       "N3_AZ11", N3_AZ11, null,
                       "N3_AZ12", N3_AZ12, null,
                       "N3_AZ13", N3_AZ13, null,
                       "N3_AZ14", N3_AZ14, null,
                       "N3_AZ15", N3_AZ15, null,
                       "N3_AZ16", N3_AZ16, null,
                       "N3_AZ17", N3_AZ17, null,
                       "N3_AZ18", N3_AZ18, null);
    END;

    Query = RSDCommand( " select case when exists ( " + SqlQueryHead1 + SqlQuery + " ) then 1 else 0 end NRec from dual " );
    Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam("", RSDBP_IN, m_BegDate );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
    Query.addParam("", RSDBP_IN, NATCUR );
    Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
    Query.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE);
    Query.execute();
    
    RSD = TRsbDataSet(Query);
    if( RSD.MoveNext() )
       AZ_ExistsLNK = SQL_ConvTypeInteger(RSD.NRec);
    end;

    if( AZ_ExistsLNK > 0 )

       if( m_SheetN3 == false )
          UseNewSheetInTotalBook();
          m_SheetN3 = true;
       end;
       SetActiveSheet( "Акции Закрытые" );

       m_PrintOrderN3 = true;

       /* печатаем таблицу */
       var PrevFIID:integer = 0, PrevDateSale:date = date(0,0,0), PrevDealIDSale = -1, DealID = -1;
       var i:integer = 0;
       var AmountItogLine:integer = 0; /* количество итоговых линий */
       var AZ5 = "", AZ7 = "", AZ11 = "", AZ13 = "", AZ15 = "", AZ161 = "";

       Query1 = RSDCommand( SqlQueryHead1 + SqlQuery + SqlQueryFooter );
       Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query1.addParam("", RSDBP_IN, m_BegDate );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
       Query1.addParam("", RSDBP_IN, NATCUR );
       Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
       Query1.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE);
       Query1.execute();
       RSD1 = TRsbDataSet(Query1);

       RegisterTable( "N3_MainTable_1", "",
                      "N3_AZ2", "N3_AZ3", "N3_AZ4", "N3_AZ5", "N3_AZ6", "N3_AZ7", "N3_G7", "N3_AZ8", "N3_AZ9", "N3_AZ10", "N3_AZ11",
                      "N3_AZ12", "N3_AZ13", "N3_AZ14", "N3_AZ15", "N3_AZ16", "N3_AZ17", "N3_AZ18" );

       while( RSD1.MoveNext() )

          if( ((PrevDateSale != SQL_ConvTypeDate(RSD1.DateSale)) or (PrevFIID != RSD1.FIID)) and (i != 0) ) /* печатаем итог по выпуску */

             SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
             PrintLineTable1( "", "", "",
                              F( FormulaSUM() + "(" + AZ5 + ":" + N3_D7(i+AmountItogLine-1) + ")" ),
                              "",
                              F( FormulaSUM() + "(" + AZ7 + ":" + N3_F7(i+AmountItogLine-1) + ")" ),
                              "", "", "",
                              F( FormulaSUM() + "(" + AZ11 + ":" + N3_K7(i+AmountItogLine-1) + ")" ),
                              "",
                              F( FormulaSUM() + "(" + AZ13 + ":" + N3_M7(i+AmountItogLine-1) + ")" ),
                              "",
                              F( FormulaSUM() + "(" + AZ15 + ":" + N3_O7(i+AmountItogLine-1) + ")" ),
                              F( N3_F7(i+AmountItogLine) + "-" + N3_M7(i+AmountItogLine) ),
                              F( N3_F7(i+AmountItogLine) + "-" + N3_O7(i+AmountItogLine) ),
                              "" );

             AZ5 = ""; AZ7 = ""; AZ11 = ""; AZ13 = ""; AZ15 = "";

             if( AZ161 == "" );
                AZ161 = N3_P7(i+AmountItogLine);
             end;

             AmountItogLine = AmountItogLine + 1;
          end;

          var ВыводЦБ = ( RSD1.Buy_Sale == PM_WRITEOFF_SUM_SALE ) AND ( RSD1.KindSale == 330 );
          if( ВыводЦБ )
             DealID = RSD1.DocumentID;
          else
             DealID = RSD1.DealIDSale;
          end;

          PrintLineTable1( SQL_ConvTypeDate(RSD1.DateSale),
                           TS_IIF(PrevDealIDSale == DealID, "", SQL_ConvTypeTime(RSD1.TimeSale)),
                           TS_IIF(PrevDealIDSale == DealID, "", RSD1.Name),
                           TS_IIF(PrevDealIDSale == DealID, "", КоличествоБумаг(DealID, RSD1.FIID, ВыводЦБ )),
                           TS_IIF(PrevDealIDSale == DealID, "", TS_IIF((RSD1.Amount > 0), F( ДУ_ЧислоCЗаданнойТочностью(RSD1.SumSale/RSD1.Amount,4) ), 0)),
                           TS_IIF(PrevDealIDSale == DealID, "", F( N3_D7(i+AmountItogLine) + "*" + N3_E7(i+AmountItogLine) )),
                           SQL_ConvTypeDate(RSD1.DateBuy),
                           SQL_ConvTypeTime(RSD1.TimeBuy),
                           RSD1.Name,
                           RSD1.Amount,
                           F( ДУ_ЧислоCЗаданнойТочностью(TS_IIF((RSD1.Amount > 0), RSD1.SumBuy/RSD1.Amount, 0),4) ),
                           F( N3_L7(i+AmountItogLine) + "*" + N3_K7(i+AmountItogLine) ),
                           ЦенаПоБалансу( RSD1.BuySumID, RSD1.FIID, RSD1.FaceValueFI, RSD1.DateSale ),
                           F( N3_N7(i+AmountItogLine) + "*" + N3_K7(i+AmountItogLine) ),
                           "", "",
                           F( N3_M7(i+AmountItogLine) + "*(" + N3_A7(i+AmountItogLine) + "-" + N3_H7(i+AmountItogLine) + ")" ) );

          if( AZ5 == "" )
             AZ5  = N3_D7(i+AmountItogLine);
             AZ7  = N3_F7(i+AmountItogLine);
             AZ11 = N3_K7(i+AmountItogLine);
             AZ13 = N3_M7(i+AmountItogLine);
             AZ15 = N3_O7(i+AmountItogLine);
          end;

          PrevFIID       = RSD1.FIID;
          PrevDateSale   = SQL_ConvTypeDate(RSD1.DateSale);
          PrevDealIDSale = DealID;

          i = i + 1;
       end;

       /* итоговая строчка от последнего выпуска */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "",
                        F( FormulaSUM() + "(" + AZ5 + ":" + N3_D7(i+AmountItogLine-1) + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ7 + ":" + N3_F7(i+AmountItogLine-1) + ")" ),
                        "", "", "",
                        F( FormulaSUM() + "(" + AZ11 + ":" + N3_K7(i+AmountItogLine-1) + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ13 + ":" + N3_M7(i+AmountItogLine-1) + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ15 + ":" + N3_O7(i+AmountItogLine-1) + ")" ),
                        F( N3_F7(i+AmountItogLine) + "-" + N3_M7(i+AmountItogLine) ),
                        F( N3_F7(i+AmountItogLine) + "-" + N3_O7(i+AmountItogLine) ),
                        "" );

       /* последняя итоговая строка */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + TS_IIF(AZ161 == "", N3_P7(i+AmountItogLine), AZ161 + ":" + N3_P7(i+AmountItogLine)) + ")" ),
                        "",
                        F( FormulaSUM() + "(" + N3_R7(AmountItogLine) + ":" + N3_R7(i+AmountItogLine) + ")" ),
                        "", "", "" );
       AmountItogLine = AmountItogLine + 1;

       EndTable();

       /* печатаем шапку */

       PrintFormatString( "", "N3_D1",    F( N1_() + N1_A2(0) ),
                              "N3_H1",    F( N1_() + N1_F1(0) ),
                              "N3_AZD1",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, "Дата окончания предыдущего месяца:", ""),
                              "N3_AZD2",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, (m_BegDate - 1), ""),
                              "N3_AZ1",   F( N3_P7(i+AmountItogLine) ),
                              "N3_AZ1_1", F( N3_R7(i+AmountItogLine) ) );

       CopyAllSheetInTotalBook( "Акции Закрытые", false, "N3_Table1", 0, "Акции Закрытые" );

    end;

  END;


  PRIVATE MACRO Печать_Облигации()

     record wsum(pmwrtsum);
     record fiwarnts(fiwarnts);
     var dl_leg = TRecHandler("dl_leg");
     var dlsum  = TRecHandler("dlsum");
     var AmountAllLot:integer = 0;
     var AmountPortf:integer  = 0;
     var SqlQuery, HeadSelect1, HeadSelect2, HeadSelect3, WhereFIID, FooterQuery, FooterQueryFIID, SqlQueryCom;
     var Query, RSD, Query1, RSD1, Query2, RSD2, Query3, RSD3, Query4, RSD4, Query5, RSD5, Query6, RSD6;
     var Nominal;
     var BegPerDate:date = date(0,0,0), EndPerDate:date = date(0,0,0);
     var BeginMon:date, EndMon:date;
     var ТСС;

     HeadSelect1 = " select /*+LEADING(lot)*/ count(1) NRec ";
     HeadSelect2 = " select /*+LEADING(lot)*/ wrt.t_FIID, fi.t_Issuer, fi.t_fi_code, fi.t_FaceValueFI, fi.t_DrawingDate, paym.t_Purpose, paym.t_DocKind, paym.t_DocumentID, " +
                   "        lot.t_Date, lot.t_Time, wrt.t_Amount, wrt.t_SumID, wrt.t_Sum, lot.t_DealID DealIDBuy, lot.t_DealDate, lot.t_DealCode, " +
                   "        wrt.t_portfolio, wrt.t_balancecost, lot.t_currency, lot.t_Kind KindBuy, " +
                   "        wrt.t_NKDAmount, wrt.t_InterestIncome, fi.t_Name    ";
     HeadSelect3 = " select /*+LEADING(lot)*/ distinct fi.t_FIID, fi.t_Name ";
     SqlQuery = "   from v_scwrthistex wrt, dpmwrtsum_dbt lot, dfininstr_dbt fi,           " +
                "        dpmpaym_dbt paym                                                  " +
                "  where wrt.t_Amount > 0                                                  " +
                "    and wrt.t_instance = ( select max (hw.t_instance)                     " +
                "                             from v_scwrthist hw                          " +
                "                            where hw.t_ChangeDate < ?                     " +
                "                              and hw.t_SumID = lot.t_SumID )              " +
                "    and lot.t_SumID    = wrt.t_SumID                                      " +
                "    and lot.t_Trust    = 'X'                                              " +
                "    and lot.t_Buy_Sale = ?                                                " +
                "    and lot.t_Contract = ?                                                " +
                "    and lot.t_State    = ?                                                " +
                "    and fi.t_FIID      = lot.t_FIID                                       " +
                "    and fi.t_FI_Kind   = ?                                                " +
                "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                "    and fi.t_FaceValueFI = ?                                              " +
                "    and paym.t_paymentid (+)= lot.t_DocID                                 ";

     WhereFIID = "   and lot.t_FIID = ? ";
     FooterQuery = " order by fi.t_FIID, lot.t_Date, lot.t_Time                            ";
     FooterQueryFIID = " order by fi.t_FIID ";

     SqlQueryCom = " select /*+LEADING(dlsum)*/ dlsum.t_Date, sum(dlsum.t_Sum) Sum  " + 
                   "   from ddlsum_dbt dlsum, ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fi " +
                   "  where dlsum.t_Date between ? and ?        " +
                   "    and dlsum.t_Kind  = ?                   " +
                   "    and tick.t_DealID = dlsum.t_DocID       " +
                   "    and tick.t_BofficeKind in(?, ?)         " +
                   "    and tick.t_ClientContrID = ?            " +
                   "    and leg.t_DealID = tick.t_DealID        " +
                   "    and fi.t_FIID = leg.t_PFI               " +
                   "    and fi.t_FI_Kind   = ?                                                " +
                   "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                   " group by dlsum.t_Date                      " +
                   " order by dlsum.t_Date                      ";

     MACRO КоличествоСтрокПоБумаге( FIID:integer ):integer

        var RetVal = 0;
        var Select = RSDCommand( " select count(1) NRec from ( " + HeadSelect2 + SqlQuery + WhereFIID + " ) " );
        Select.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Select.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Select.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Select.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Select.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Select.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Select.addParam("", RSDBP_IN, NATCUR                );
        Select.addParam("", RSDBP_IN, FIID                  );
        Select.execute();

        var RSDSelect = TRsbDataSet(Select);

        if( RSDSelect.MoveNext() )
           RetVal = SQL_ConvTypeInteger(RSDSelect.NRec);
        end;

        return RetVal;
     END;

     MACRO PrintLineTable1( N4_OA1, N4_OA2, N4_OA2_1, N4_OA3, N4_A4, N4_OA5, N4_OA6, N4_OA7, N4_OA8, N4_OA9, N4_OA10, N4_OA11,
                            N4_OA12, N4_OA13, N4_OA14, N4_OA15, N4_OA16, N4_OA17, N4_OA17_1, N4_OA20_1, N4_OA21, N4_OA21_1,
                            N4_OA22, N4_OA23, N4_OA24, N4_OA25, N4_OA26, N4_OA27 )
        PrintTableLine( "N4_OA1",    N4_OA1,    null,
                        "N4_OA2",    N4_OA2,    null,
                        "N4_OA2_1",  N4_OA2_1,  null,
                        "N4_OA3",    N4_OA3,    null,
                        "N4_A4",     N4_A4,     null,
                        "N4_OA5",    N4_OA5,    null,
                        "N4_OA6",    N4_OA6,    null,
                        "N4_OA7",    N4_OA7,    null,
                        "N4_OA8",    N4_OA8,    null,
                        "N4_OA9",    N4_OA9,    null,
                        "N4_OA10",   N4_OA10,   null,
                        "N4_OA11",   N4_OA11,   null,
                        "N4_OA12",   N4_OA12,   null,
                        "N4_OA13",   N4_OA13,   null,
                        "N4_OA14",   N4_OA14,   null,
                        "N4_OA15",   N4_OA15,   null,
                        "N4_OA16",   N4_OA16,   null,
                        "N4_OA17",   N4_OA17,   null,
                        "N4_OA17_1", N4_OA17_1, null,
                        "N4_OA20_1", N4_OA20_1, null,
                        "N4_OA21",   N4_OA21,   null,
                        "N4_OA21_1", N4_OA21_1, null,
                        "N4_OA22",   N4_OA22,   null,
                        "N4_OA23",   N4_OA23,   null,
                        "N4_OA24",   N4_OA24,   null,
                        "N4_OA25",   N4_OA25,   null,
                        "N4_OA26",   N4_OA26,   null,
                        "N4_OA27",   N4_OA27,   null);
     END;

     MACRO PrintLineTable2( N4_OB0, N4_OB1, N4_OB2, N4_OB3, N4_OB4, N4_OB5, N4_OB5_1, N4_OB6, N4_OB7, N4_OB8, N4_OB9, N4_OB10, N4_OB11,
                            N4_OB12, N4_OB13, N4_OB14, N4_OB15, N4_OB16, N4_OB17, N4_OB18, N4_OB19, N4_OB20, N4_OB21, N4_OB22, N4_OB22_1,
                            N4_OB23, N4_OB24, N4_OB25, N4_OB26, N4_OB27, N4_OB28, N4_OB29, N4_OB30, N4_OB31, N4_OB32, N4_OB33, N4_OB34, N4_OB35, N4_OB36, N4_OB37 )
        PrintTableLine( "N4_OB0",    N4_OB0,    null,
                        "N4_OB1",    N4_OB1,    null,
                        "N4_OB2",    N4_OB2,    null,
                        "N4_OB3",    N4_OB3,    null,
                        "N4_OB4",    N4_OB4,    null,
                        "N4_OB5",    N4_OB5,    null,
                        "N4_OB5_1",  N4_OB5_1,  null,
                        "N4_OB6",    N4_OB6,    null,
                        "N4_OB7",    N4_OB7,    null,
                        "N4_OB8",    N4_OB8,    null,
                        "N4_OB9",    N4_OB9,    null,
                        "N4_OB10",   N4_OB10,   null,
                        "N4_OB11",   N4_OB11,   null,
                        "N4_OB12",   N4_OB12,   null,
                        "N4_OB13",   N4_OB13,   null,
                        "N4_OB14",   N4_OB14,   null,
                        "N4_OB15",   N4_OB15,   null,
                        "N4_OB16",   N4_OB16,   null,
                        "N4_OB17",   N4_OB17,   null,
                        "N4_OB18",   N4_OB18,   null,
                        "N4_OB19",   N4_OB19,   null,
                        "N4_OB20",   N4_OB20,   null,
                        "N4_OB21",   N4_OB21,   null,
                        "N4_OB22",   N4_OB22,   null,
                        "N4_OB22_1", N4_OB22_1, null,
                        "N4_OB23",   N4_OB23,   null,
                        "N4_OB24",   N4_OB24,   null,
                        "N4_OB25",   N4_OB25,   null,
                        "N4_OB26",   N4_OB26,   null,
                        "N4_OB27",   N4_OB27,   null,
                        "N4_OB28",   N4_OB28,   null,
                        "N4_OB29",   N4_OB29,   null,
                        "N4_OB30",   N4_OB30,   null,
                        "N4_OB31",   N4_OB31,   null,
                        "N4_OB32",   N4_OB32,   null,
                        "N4_OB33",   N4_OB33,   null,
                        "N4_OB34",   N4_OB34,   null,
                        "N4_OB35",   N4_OB35,   null,
                        "N4_OB36",   N4_OB36,   null,
                        "N4_OB37",   N4_OB37,   null);
     END;

     MACRO PrintLineTable3( N4_OC1, N4_OC2, N4_OC3, N4_OC4 )
        PrintTableLine( "N4_OC1", N4_OC1, null,
                        "N4_OC2", N4_OC2, null,
                        "N4_OC3", N4_OC3, null,
                        "N4_OC4", N4_OC4, null);
     END;

     MACRO PrintLineTable4( N4_OD1_, N4_OD2_ )
        PrintTableLine( "N4_OD1_", N4_OD1_, null,
                        "N4_OD2_", N4_OD2_, null);
     END;

     Query = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
     Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
     Query.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
     Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
     Query.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
     Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
     Query.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
     Query.addParam("", RSDBP_IN, NATCUR                );
     Query.execute();

     RSD = TRsbDataSet(Query);

     if( RSD.MoveNext() )
        AmountAllLot = SQL_ConvTypeInteger(RSD.NRec); /* количество строк в таблице "Сделки приобретения" */
     end;

     if( AmountAllLot > 0 )

        if( m_SheetN4 == false )
           UseNewSheetInTotalBook();
           m_SheetN4 = true;
        end;
        SetActiveSheet( "Облигации" );

        m_PrintOrderN4 = true;

        Query1 = RSDCommand( " select count(1) NRec from ( " + HeadSelect3 + SqlQuery + " ) " );
        Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query1.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query1.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query1.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query1.addParam("", RSDBP_IN, NATCUR                );
        Query1.execute();

        RSD1 = TRsbDataSet(Query1);

        if( RSD1.MoveNext() )
           AmountPortf = SQL_ConvTypeInteger(RSD1.NRec); /* количество строк в таблице "портфель" */
        end;

        var DeltaPortfItog = AmountPortf;

        /* печатаем шапку */

        PrintFormatString( "", "N4_C2",   F( N1_() + N1_A2(0) ),
                               "N4_G2",   F( N1_() + N1_F1(0) ),
                               "N4_OT1",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, "Дата окончания предыдущего месяца:", ""),
                               "N4_OT2",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, (m_BegDate - 1), ""),
                               "N4_OA18", F( N4_P9(DeltaPortfItog) + "/" + N4_T9(DeltaPortfItog) + "*" + N8_() + N8_A9(0) + "*100" ),
                               "N4_L5",   TS_IIF(m_PrintOrderN5, F( N5_() + N5_Q3(0) ), 0.0),
                               "N4_OA20", F( "(" + N4_P9(DeltaPortfItog) + "+" + N4_L5(0) + ")/(" + N8_() + N8_A7(0) + "+" + N4_T9(DeltaPortfItog) + "+" + TS_IIF(m_PrintOrderN5, N5_() + N5_Q4(0), "0") + ")*" + N8_() + N8_A9(0) + "*100" ) );

        GL_OA19 = N4_L5(0);
        GL_OA20 = N4_L6(0);

        /* печатем таблицу "портфель" */
        Query2 = RSDCommand( HeadSelect3 + SqlQuery + FooterQueryFIID );
        Query2.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query2.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query2.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query2.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query2.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query2.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query2.addParam("", RSDBP_IN, NATCUR                );
        Query2.execute();

        RSD2 = TRsbDataSet(Query2);

        RegisterTable( "N4_MainTable_1", "",
                       "N4_OA1", "N4_OA2", "N4_OA2_1", "N4_OA3", "N4_A4", "N4_OA5", "N4_OA6", "N4_OA7", "N4_OA8",
                       "N4_OA9", "N4_OA10", "N4_OA11", "N4_OA12", "N4_OA13", "N4_OA14", "N4_OA15", "N4_OA16",
                       "N4_OA17", "N4_OA17_1", "N4_OA20_1", "N4_OA21", "N4_OA21_1", "N4_OA22", "N4_OA23", "N4_OA24",
                       "N4_OA25", "N4_OA26", "N4_OA27" );

        var DeltaDealItog = DeltaPortfItog - 1;

        var i = 0;
        while( RSD2.MoveNext() )

           var МассивOB22:string = "";
           var СтрокПоБумаге = КоличествоСтрокПоБумаге(RSD2.FIID);
           DeltaDealItog = DeltaDealItog + СтрокПоБумаге + TS_IIF(i == 0, 0, 1); /* итоговая строка по данной бумаге в таблице "Сделки приобретения" */

           var j = СтрокПоБумаге;
           while( j > 0 )
              if( j == СтрокПоБумаге )
                 МассивOB22 = N4_X13(DeltaDealItog - СтрокПоБумаге);
              else
                 МассивOB22 = МассивOB22 + ";" + N4_X13(DeltaDealItog - СтрокПоБумаге);
              end;
              j = j - 1;
           end;

           Nominal = TS_GetFaceValue(RSD2.FIID, m_FormData.ReportDate);
           var БылоПогашение = БылоПогашениеКупона(RSD2.FIID, m_BegDate, m_FormData.ReportDate);

           var N4_OA6;
           if( Nominal != 0.0 )
              ТСС = ПолучитьТСС(RSD2.FIID, NATCUR, m_FormData.ReportDate - 1);
              if( ТСС > 0 )
                 N4_OA6 = ТСС / Nominal;
              else
                 N4_OA6 = F( N4_H13(DeltaDealItog) + "/" + N4_B9(i) + "/" + N4_C9(i) );
              end;
           else
              N4_OA6 = 0.0;
           end;

           PrintLineTable1( RSD2.Name,
                            F( N4_F13(DeltaDealItog) ),
                            Nominal,
                            F( N4_H13(DeltaDealItog) ),
                            F( N4_D9(i) + "+" + N4_J9(i) ),
                            F( N4_D9(i) + "/" + N4_B9(i) + "/" + N4_C9(i) + "*100" ),
                            N4_OA6,
                            F( N4_W13(DeltaDealItog) ),
                            F( N4_Q13(DeltaDealItog) ),
                            F( N4_J13(DeltaDealItog) ),
                            F( N4_H9(i) + "+" + N4_I9(i) + "-" + N4_M9(i) ),
                            F( N4_L13(DeltaDealItog) ),
                            F( N4_G9(i) + "/100*" + N4_B9(i) + "*" + N4_C9(i) + "*" + N8_() + N8_A11(0) ),
                            F( N4_O13(DeltaDealItog) ),
                            F( N4_I9(i) + "-" + N4_J9(i) + "+" + N4_N9(i) ),
                            F( N4_K9(i) + "-" + N4_D9(i) + "-" + N4_J9(i) + "+" + N4_N9(i) + "-" + N4_L9(i)+ "-" + N4_V9(i) + "-" + N4_Y9(i) + "-" + N4_AA9(i) + "+" + N4_AB9(i) ),
                            F( FormulaMAX() + "(" + МассивOB22 + ")" ),
                            F( N4_P9(i) + "/" + N4_T9(i) + "*" + N8_() + N8_A9(0) + "*100" ),
                            F( N4_D9(i) + "+" + N4_U9(i) + "+" + N4_Y9(i) + "+" + N4_AA9(i) + "-" + N4_AB9(i)),
                            F( N4_Y13(DeltaDealItog) ),
                            F( N4_Z13(DeltaDealItog) ),
                            F( N4_N9(i) + "-" + N4_J9(i) + "+" + N4_U9(i) ),
                            F( N4_AB13(DeltaDealItog) ),
                            F( N4_AC13(DeltaDealItog) ),
                            F( N4_AD13(DeltaDealItog) ),
                            F( N4_W9(i) + "-" + N4_D9(i) ),
                            F( N4_AM13(DeltaDealItog) + "-" + N4_D9(i)),
                            F( N4_AN13(DeltaDealItog)) );

           i = i + 1;
        end;

        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable1( "ИТОГО:",
                         F( FormulaSUM() + "(" + N4_B9(0) + ":" + N4_B9(i-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + N4_D9(0) + ":" + N4_D9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_E9(0) + ":" + N4_E9(i-1) + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + N4_H9(0) + ":" + N4_H9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_I9(0) + ":" + N4_I9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_J9(0) + ":" + N4_J9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_K9(0) + ":" + N4_K9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_L9(0) + ":" + N4_L9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_M9(0) + ":" + N4_M9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_N9(0) + ":" + N4_N9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_O9(0) + ":" + N4_O9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_P9(0) + ":" + N4_P9(i-1) + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + N4_S9(0) + ":" + N4_S9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_T9(0) + ":" + N4_T9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_U9(0) + ":" + N4_U9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_V9(0) + ":" + N4_V9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_W9(0) + ":" + N4_W9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_X9(0) + ":" + N4_X9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_Y9(0) + ":" + N4_Y9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_Z9(0) + ":" + N4_Z9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_AA9(0) + ":" + N4_AA9(i-1) + ")" ),
                         F( FormulaSUM() + "(" + N4_AB9(0) + ":" + N4_AB9(i-1) + ")" ) );

        GL_FOA11   = N4_L9(i);
        GL_FOA15   = N4_P9(i);
        GL_FOA17_1 = N4_S9(i);
        GL_FOA24   = N4_Y9(i);

        EndTable();
        CopyAllSheetInTotalBook( "Облигации", false, "N4_Table1", 0, "Облигации" );

        /* печатем таблицу "Сделки приобретения" */

        var DeltaDeal = DeltaPortfItog - 1;

        Query3 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
        Query3.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query3.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query3.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query3.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query3.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query3.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query3.addParam("", RSDBP_IN, NATCUR                );
        Query3.execute();

        RSD3 = TRsbDataSet(Query3);

        RegisterTable( "N4_MainTable_2", "",
                       "N4_OB0", "N4_OB1", "N4_OB2", "N4_OB3", "N4_OB4", "N4_OB5", "N4_OB5_1", "N4_OB6", "N4_OB7", "N4_OB8", "N4_OB9",
                       "N4_OB10", "N4_OB11", "N4_OB12", "N4_OB13", "N4_OB14", "N4_OB15", "N4_OB16", "N4_OB17", "N4_OB18", "N4_OB19", "N4_OB20",
                       "N4_OB21", "N4_OB22", "N4_OB22_1", "N4_OB23", "N4_OB24", "N4_OB25", "N4_OB26", "N4_OB27", "N4_OB28", "N4_OB29",
                       "N4_OB30", "N4_OB31", "N4_OB32", "N4_OB33", "N4_OB34", "N4_OB35", "N4_OB36", "N4_OB37" );

        i = 0;
        var k = 0; /* количество итоговых строк */
        var m = 0; /* счётчик строк в таблице "Начисленный доход" вместе с итогами */
        var PrevFIID = 0;
        var FOB5 = "", FOB6 = "", FOB8 = "", FOB10 = "", FOB13 = "", FOB15 = "", FOB21 = "", FOB22_1 = "", FOB23 = "",
            FOB25 = "", FOB26 = "", FOB27 = "", FOB29 = "", FOB32 = "", FOB33 = "", FOB34 = "", FOB36 = "", FOB37 = "";
        var ItogFOB22 = "";

        while( RSD3.MoveNext() )

           if( (PrevFIID != RSD3.FIID) and (i != 0) )
              /* печатаем итог по выпуску */
              SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
              PrintLineTable2( "", "", "", "", "",
                               F( FormulaSUM() + "(" + FOB5 + ":" + N4_F13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB6 + ":" + N4_H13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB8 + ":" + N4_J13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB10 + ":" + N4_L13(DeltaDeal+i+k-1) + ")" ),
                               "", "",
                               F( FormulaSUM() + "(" + FOB13 + ":" + N4_O13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB15 + ":" + N4_Q13(DeltaDeal+i+k-1) + ")" ),
                               "", "", "", "", "",
                               F( FormulaSUM() + "(" + FOB21 + ":" + N4_W13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaMAX() + "(" + FOB22_1 + ":" + N4_Y13(DeltaDeal+i+k-1) + ")" ),
                               F( FormulaSUM() + "(" + FOB23 + ":" + N4_Z13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB25 + ":" + N4_AB13(DeltaDeal+i+k-1) + ")" ),
                               F( FormulaSUM() + "(" + FOB26 + ":" + N4_AC13(DeltaDeal+i+k-1) + ")" ),
                               F( FormulaSUM() + "(" + FOB27 + ":" + N4_AD13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB29 + ":" + N4_AF13(DeltaDeal+i+k-1) + ")" ),
                               "", "",
                               F( FormulaSUM() + "(" + FOB32 + ":" + N4_AI13(DeltaDeal+i+k-1) + ")" ),
                               F( FormulaSUM() + "(" + FOB33 + ":" + N4_AJ13(DeltaDeal+i+k-1) + ")" ),
                               F( FormulaSUM() + "(" + FOB34 + ":" + N4_AK13(DeltaDeal+i+k-1) + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB36 + ":" + N4_AM13(DeltaDeal+i+k-1) + ")" ),
                               F( FormulaSUM() + "(" + FOB37 + ":" + N4_AN13(DeltaDeal+i+k-1) + ")" ) );

              /*формируем строку суммы для итоговй строки таблицы*/
              ItogFOB22 = ItogFOB22 + TS_IIF(ItogFOB22 == "", "", ";") + N4_Y13(DeltaDeal+i+k);

              FOB5 = FOB6 = FOB8 = FOB10 = FOB13 = FOB15 = FOB21 = FOB22_1 = FOB23 = FOB25 = FOB26 = FOB27 = FOB29 = FOB32 = FOB33 = FOB34 = FOB36 = FOB37 = "";
              k = k + 1;
           end;

           var InCap = ( (RSD3.KindBuy == 340) and (RSD3.DocKind == TS_DOC_DECLAR) ); /* операции внесения капитала */

           var DealCode;       /* Номер сделки */
           var N4_OB10 = $0.0; /* Комиссия брокера и биржи */
           if( InCap )
              DealCode = ПолучитьНомерОперацииВВК(RSD3.DocumentID);
           else
              DealCode = RSD3.DealCode;

              FindDL_LEG( TS_IIF(RSD3.Purpose == BRi, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK), RSD3.DealIDBuy, 0, dl_leg );
              if( dl_leg.rec.Principal != 0.0 )
                 if( FindDLSUM( RSD3.DocKind, RSD3.DealIDBuy, DLSUM_KIND_AGENT_PERIOD, RSD3.DealDate, dlsum ) == 0)
                    N4_OB10 = N4_OB10 + dlsum.rec.Sum;
                 end;
                 if( FindDLSUM( RSD3.DocKind, RSD3.DealIDBuy, DLSUM_KIND_AGENT_ONCE, RSD3.DealDate, dlsum ) == 0)
                    N4_OB10 = N4_OB10 + dlsum.rec.Sum;
                 end;
                 if( FindDLSUM( RSD3.DocKind, RSD3.DealIDBuy, DLSUM_KIND_AGENT_ONCE_IMPORT, RSD3.DealDate, dlsum ) == 0)
                    N4_OB10 = N4_OB10 + dlsum.rec.Sum;
                 end;
                 N4_OB10 = N4_OB10 * RSD3.Amount / dl_leg.rec.Principal;
              end;
           end;

           Nominal = TS_GetFaceValue(RSD3.FIID, SQL_ConvTypeDate(RSD3.Date));

           var ДатаПогашенияТекущегоКупона:date = date(0,0,0);
           var CтавкаНКД:money = $0.0;
           if(FI_GetCouponOnDate(RSD3.FIID, m_FormData.ReportDate, fiwarnts) == 0)
              ДатаПогашенияТекущегоКупона = fiwarnts.DrawingDate;
              CтавкаНКД = fiwarnts_GetIncomePercent(fiwarnts, Nominal);
           end;

           BegPerDate = max(SQL_ConvTypeDate(RSD3.Date), ПоследнееПогашениеКупонаЗаПериод(RSD3.FIID, date(0,0,0), m_FormData.ReportDate));
           EndPerDate = m_FormData.ReportDate;
           var Период_ = ПериодПоМесяцам(BegPerDate, EndPerDate);
           var FOC5 = "";
           var ExStr = false;

           while( Период_.СледующийМесяц(null, @BeginMon, @EndMon) )
              if( ПДЗаПериод(RSD3.SumID, BeginMon, EndMon, RSD3.Amount) > 0.0 )
                 m = m + 1;
                 ExStr = true;
              end;
           end;
           if( ExStr )
              FOC5 = N4_D18(DeltaDeal + AmountAllLot + AmountPortf - 1 + m);
              m = m + 1;
           end;

           var OB7:money = $0.0;
           var FirstLot;
           if( GetLotFirstInstance(RSD3.SumID, @FirstLot) )
              if( FirstLot.Amount != 0.0 )
                 OB7 = FirstLot.NKDAmount / FirstLot.Amount;
              end;
           end;

           var N4_OB24:money = 0.0;
           if( Nominal != 0.0 )
              N4_OB24 = ЦенаПоБалансу( RSD3.SumID, RSD3.FIID, RSD3.FaceValueFI, m_FormData.ReportDate ) * 100.0 / Nominal;
           end;

           var N4_OB9;
           if( Nominal != 0.0 )
              ТСС = ПолучитьТСС(RSD3.FIID, NATCUR, m_FormData.ReportDate - 1);
              if( ТСС > 0 )
                 N4_OB9 = ТСС * 100 / Nominal;
              else
                 N4_OB9 = F( N4_E13(DeltaDeal+i+k) );
              end;
           else
              N4_OB9 = 0.0;
           end;

           var N4_OB22:string = "";
           if( m_OrderFD.BeginDate() >= m_BegDate )
              N4_OB22 = F( N4_G2(0) + "-" + N4_B13(DeltaDeal+i+k) );
           else
              N4_OB22 = F( FormulaIF() + "(" + N4_B13(DeltaDeal+i+k) + ">" + N4_B3(0) + ";" + N4_G2(0) + "-" + N4_B13(DeltaDeal+i+k) + ";" + N4_G2(0) + "-" + N4_B3(0) + ")" );
           end;

           PrintLineTable2( DealCode,
                            SQL_ConvTypeDate(RSD3.Date),
                            SQL_ConvTypeTime(RSD3.Time),
                            RSD3.Name,
                            ЦенаПокупки(RSD3, Nominal),
                            RSD3.Amount,
                            Nominal,
                            F( N4_F13(DeltaDeal+i+k) + "*" + N4_G13(DeltaDeal+i+k) + "*" + N4_E13(DeltaDeal+i+k) + "/100" ),
                            OB7,
                            F( N4_I13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) ),
                            N4_OB9,
                            N4_OB10,
                            F( N4_N13(DeltaDeal+i+k) + "-" + N4_S13(DeltaDeal+i+k) ),
                            ДатаПогашенияТекущегоКупона,
                            TS_GetCouponSumByPeriod( SQL_ConvTypeInteger(RSD3.FIID), SQL_ConvTypeSum(RSD3.Amount), SQL_ConvTypeDate(RSD3.Date), m_FormData.ReportDate, "", null, null, null, null ),
                            CтавкаНКД,
                            F( N4_U13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) ),
                            ВесьKупон(fiwarnts),
                            (fiwarnts.DrawingDate - fiwarnts.FirstDate) + 1/* даты начала и конца включаются*/,
                            F( N4_R13(DeltaDeal+i+k) + "/" + N4_S13(DeltaDeal+i+k) ),
                            НКДНаДатуРасчета(RSD3.FIID, m_FormData.ReportDate),
                            F( FormulaIF() + "(" + N4_O13(DeltaDeal+i+k) + "=0;" + N4_O13(DeltaDeal+i+k) + "+" + N4_Q13(DeltaDeal+i+k) + "-" + N4_J13(DeltaDeal+i+k) + ";" + N4_Q13(DeltaDeal+i+k) + ")" ),
                            F( N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "*" + N4_K13(DeltaDeal+i+k) + "/100" ),
                            N4_OB22,
                            F( N4_X13(DeltaDeal+i+k) + "*(" + N4_AM13(DeltaDeal+i+k) + "+" + N4_AD13(DeltaDeal+i+k) + "+" + N4_J13(DeltaDeal+i+k) + ")" ),
                            TS_IIF(БылоПогашениеКупона(RSD3.FIID, m_BegDate, m_FormData.ReportDate), 0.0, F( N4_J13(DeltaDeal+i+k) ) ),
                            N4_OB24,
                            F( N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "*" + N4_AA13(DeltaDeal+i+k) + "/100" ),
                            F( FormulaIF() + "(" + N4_O13(DeltaDeal+i+k) + "=0;" + N4_U13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "-" + N4_J13(DeltaDeal+i+k) + "-" + N4_AD13(DeltaDeal+i+k) + ";" + N4_Q13(DeltaDeal+i+k) + "-" + N4_AD13(DeltaDeal+i+k) + ")"),
                            TS_IIF(ExStr, F( FOC5 ), 0.0),
                            F( N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) ),
                            F( FormulaMAX() + "(0;" + N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "-" + N4_H13(DeltaDeal+i+k) + ")" ),
                            SQL_ConvTypeDate(RSD3.DrawingDate),
                            F( N4_AG13(DeltaDeal+i+k) + "-" + N4_B13(DeltaDeal+i+k) ),
                            F( N4_AF13(DeltaDeal+i+k) + "/" + N4_AH13(DeltaDeal+i+k) ),
                            F( N4_AI13(DeltaDeal+i+k) + "*" + N4_X13(DeltaDeal+i+k) ),
                            F( N4_AB13(DeltaDeal+i+k) + "-" + N4_H13(DeltaDeal+i+k) + "-" + N4_AJ13(DeltaDeal+i+k) ),
                            TS_IIF(SQL_ConvTypeDate(RSD3.Date) >= m_BegDate, 0.0, ПолучитьТСС(RSD3.FIID, NATCUR, m_BegDate - 1) * 100 / TS_GetFaceValue(RSD3.FIID, m_BegDate - 1)),
                            F( FormulaIF() + "(" + N4_B13(DeltaDeal+i+k) + ">" + FormulaDate(m_BegDate - 1) + ";" + N4_H13(DeltaDeal+i+k) + ";" + N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "*" + N4_AL13(DeltaDeal+i+k) + "/100)" ),
                            ПДЗаПериод(RSD3.SumID, m_BegDate, m_FormData.ReportDate) );

           if( FOB5 == "" )
              FOB5    = N4_F13(DeltaDeal+i+k);
              FOB6    = N4_H13(DeltaDeal+i+k);
              FOB8    = N4_J13(DeltaDeal+i+k);
              FOB10   = N4_L13(DeltaDeal+i+k);
              FOB13   = N4_O13(DeltaDeal+i+k);
              FOB15   = N4_Q13(DeltaDeal+i+k);
              FOB21   = N4_W13(DeltaDeal+i+k);
              FOB22_1 = N4_Y13(DeltaDeal+i+k);
              FOB23   = N4_Z13(DeltaDeal+i+k);
              FOB25   = N4_AB13(DeltaDeal+i+k);
              FOB26   = N4_AC13(DeltaDeal+i+k);
              FOB27   = N4_AD13(DeltaDeal+i+k);
              FOB29   = N4_AF13(DeltaDeal+i+k);
              FOB32   = N4_AI13(DeltaDeal+i+k);
              FOB33   = N4_AJ13(DeltaDeal+i+k);
              FOB34   = N4_AK13(DeltaDeal+i+k);
              FOB36   = N4_AM13(DeltaDeal+i+k);
              FOB37   = N4_AN13(DeltaDeal+i+k);
           end;

           PrevFIID = RSD3.FIID;

           i = i + 1;
        end;

        /* печатаем итог по последнему выпуску */
        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable2( "", "", "", "", "",
                         F( FormulaSUM() + "(" + FOB5 + ":" + N4_F13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB6 + ":" + N4_H13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB8 + ":" + N4_J13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB10 + ":" + N4_L13(DeltaDeal+i+k-1) + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOB13 + ":" + N4_O13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB15 + ":" + N4_Q13(DeltaDeal+i+k-1) + ")" ),
                         "", "", "", "", "",
                         F( FormulaSUM() + "(" + FOB21 + ":" + N4_W13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaMAX() + "(" + FOB22_1 + ":" + N4_Y13(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + FOB23 + ":" + N4_Z13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB25 + ":" + N4_AB13(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + FOB26 + ":" + N4_AC13(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + FOB27 + ":" + N4_AD13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB29 + ":" + N4_AF13(DeltaDeal+i+k-1) + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOB32 + ":" + N4_AI13(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + FOB33 + ":" + N4_AJ13(DeltaDeal+i+k-1) + ")" ),
                         F( FormulaSUM() + "(" + FOB34 + ":" + N4_AK13(DeltaDeal+i+k-1) + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB36 + ":" + N4_AM13(DeltaDeal+i+k-1) + ")" ) ,
                         F( FormulaSUM() + "(" + FOB37 + ":" + N4_AN13(DeltaDeal+i+k-1) + ")" ) );

        ItogFOB22 = ItogFOB22 + TS_IIF(ItogFOB22 == "", "", ";") + N4_Y13(DeltaDeal+i+k);

        /* печатаем итог по таблице */
        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable2( "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                         F( FormulaSUM() + "(" + ItogFOB22 + ")" ),
                         "", "", "", "", "", "", "", "", "", "", "", "", "", "", "" );

        EndTable();
        CopyAllSheetInTotalBook( "Облигации", false, "N4_Table2", 0, "Облигации" );

        /* печатем таблицу "Начисленный доход" */

        Query6 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
        Query6.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query6.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query6.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query6.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query6.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query6.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query6.addParam("", RSDBP_IN, NATCUR                );
        Query6.execute();

        RSD6 = TRsbDataSet(Query6);

        var DeltaPD = DeltaDeal + i + k;
        var RegTable = false;

        i = 0; /* количество строк в таблице "Начисленный доход" вместе с итогами */
        while( RSD6.MoveNext() )

           /* Номер сделки */
           var Code;
           if( (RSD6.KindBuy == 340) and (RSD6.DocKind == TS_DOC_DECLAR) )
              Code = ПолучитьНомерОперацииВВК(RSD6.DocumentID);
           else
              Code = RSD6.DealCode;
           end;

           BegPerDate = max(SQL_ConvTypeDate(RSD6.Date), ПоследнееПогашениеКупонаЗаПериод(RSD6.FIID, date(0,0,0), m_FormData.ReportDate));
           EndPerDate = m_FormData.ReportDate;

           var Период = ПериодПоМесяцам(BegPerDate, EndPerDate);
           var Name:string;
           var FOC4 = "";

           while( Период.СледующийМесяц(@Name, @BeginMon, @EndMon) )
              var ПД = ПДЗаПериод(RSD6.SumID, BeginMon, EndMon, RSD6.Amount);
              if( ПД > 0.0 )
                 if( RegTable == false )
                    RegisterTable( "N4_MainTable_3", "", "N4_OC1", "N4_OC2", "N4_OC3", "N4_OC4" );
                    RegTable = true;
                 end;

                 PrintLineTable3(Code, RSD6.Name, Name, ПД);

                 if( FOC4 == "" )
                    FOC4 = N4_D18(DeltaPD + i);
                 end;
                 i = i + 1;
              end;
           end;

           if( FOC4 != "")
              SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
              PrintLineTable3( "ИТОГО:", "", "", F( FormulaSUM() + "(" + FOC4 + ":" + N4_D18(DeltaPD+i-1) + ")" ) );
              i = i + 1;
           end;

        end;

        if( RegTable )
           EndTable();
           CopyAllSheetInTotalBook( "Облигации", false, "N4_Table3", 0, "Облигации" );
        end;

        /* печатем таблицу "Комиссии" */
        
        Query4 = RSDCommand( " select count(1) NRec from ( " + SqlQueryCom + " ) " );
        Query4.addParam("", RSDBP_IN, m_BegDate                       );
        Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
        Query4.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
        Query4.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
        Query4.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
        Query4.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query4.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
        Query4.addParam("", RSDBP_IN, AVOIRISSKIND_BOND               );
        Query4.execute();

        RSD4 = TRsbDataSet(Query4);

        var ExistsCom:integer = 0;
        if( RSD4.MoveNext() )
           ExistsCom = SQL_ConvTypeInteger(RSD4.NRec);
        end;

        if( ExistsCom > 0 )

           var DeltaCom = DeltaPD + i - 5;
           if(RegTable)
              DeltaCom = DeltaCom + 3;
           end;

           RegisterTable( "N4_MainTable_4", "", "N2_AC1", "N2_AC2" );

           Query5 = RSDCommand( SqlQueryCom );
           Query5.addParam("", RSDBP_IN, m_BegDate                       );
           Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
           Query5.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
           Query5.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
           Query5.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
           Query5.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
           Query5.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
           Query5.addParam("", RSDBP_IN, AVOIRISSKIND_BOND               );
           Query5.execute();

           RSD5 = TRsbDataSet(Query5);

           i = 0;
           while( RSD5.MoveNext() )
              PrintLineTable4( SQL_ConvTypeDate(RSD5.Date), RSD5.Sum );
              i = i + 1;
           end;

           SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
           PrintLineTable3( "ИТОГО:", F( FormulaSUM() + "(" + N4_B23(DeltaCom) + ":" + N4_B23(DeltaCom+i-1) + ")" ) );

           GL_FOD2 = N4_B23(DeltaCom + i);

           EndTable();
           CopyAllSheetInTotalBook( "Облигации", false, "N4_Table4", 0, "Облигации" );

        end;

     end;

  END;


  PRIVATE MACRO Печать_ОблигацииЗакрытые()

    var OZ_ExistsLNK:integer = 0;
    record wsum(pmwrtsum);
    var SqlQueryHead1, SqlQueryHead2, SqlQuery;
    var Query, RSD, Query1, RSD1;

    SqlQueryHead1 = " select /*+LEADING(lnk)*/ lnk.t_Amount, wrtsale.t_DealCode DealCodeSale, wrtsale.t_DealID DealIDSale, wrtbuy.t_DealID DealIDBuy, paym.t_Purpose, paym.t_DocKind, paym.t_DocumentID, " +
                    "        wrtsale.t_Date DateSale, wrtsale.t_Time TimeSale, wrtbuy.t_Date DateBuy, wrtbuy.t_Time TimeBuy," +
                    "        wrtsale.t_Buy_Sale Buy_Sale, wrtsale.t_Kind KindSale, wrtbuy.t_Kind KindBuy, lnk.t_SumSale,   " +
                    "        wrtsale.t_Currency SaleCur, wrtbuy.t_Currency BuyCur, fi.t_FaceValueFI, lnk.t_BalanceCostBuy, " +
                    "        lnk.t_SumBuy, wrtbuy.t_SumID BuySumID, wrtsale.t_SumID SaleSumID,                             " +
                    "        lnk.t_NKDBuyAmount, lnk.t_InterestIncomeBuy, lnk.t_CostSale, lnk.t_CostBuy,                   " +
                    "        lnk.t_Partly, lnk.t_Coupon, lnk.t_NKDSaleAmount, lnk.t_NKDBuyAmount,                          " +
                    "        lnk.t_InterestIncomeAdd, fi.t_Name, fi.t_FIID,                                                " +
                    "        (case when (lnk.t_Partly != chr(0))                                                           " +
                    "        then (RSB_FIInstr.FI_GetPartialPersentByName(fi.t_FIID,lnk.t_Partly)) else 0 end) PartlyPc    ";
    SqlQueryHead2 = " select /*+LEADING(lnk)*/ count(1) NRec ";
    SqlQuery = "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt wrtsale, dpmwrtsum_dbt wrtbuy, dfininstr_dbt fi, " +
               "        dpmpaym_dbt paym                                                 " +
               "  where lnk.t_SaleID       = wrtsale.t_SumID                             " +
               "    and lnk.t_BuyID        = wrtbuy.t_SumID                              " +
               "    and wrtbuy.t_Trust     = 'X'                                         " +
               "    and wrtsale.t_fiid     = fi.t_fiid                                   " +
               "    and wrtsale.t_Contract = ?                                           " +
               "    and wrtsale.t_Date    >= ?                                           " +
               "    and wrtsale.t_Date    <= ?                                           " +
               "    and wrtsale.t_Currency = fi.t_FaceValueFI                            " +
               "    and wrtbuy.t_Currency  = fi.t_FaceValueFI                            " +
               "    and fi.t_FaceValueFI   = ?                                           " +
               "    and fi.t_FI_Kind       = ?                                           " +
               "    and RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
               "    and paym.t_paymentid   (+)= wrtsale.t_DocID                          ";
    var SqlQueryFooter = " order by wrtsale.t_Date, wrtsale.t_Time, wrtsale.t_SumID ";

    MACRO PrintLineTable1( N5_OZ2, N5_OZ3, N5_OZ4, N5_OZ5_1, N5_OZ5, N5_OZ6, N5_OZ7, N5_OZ8, N5_OZ9, N5_OZ10, N5_OZ11, N5_OZ12,
                           N5_OZ13_1, N5_OZ13, N5_OZ14, N5_OZ15, N5_OZ16, N5_OZ18, N5_OZ19, N5_S7, N5_OZ20, N5_OZ21, N5_OZ22,
                           N5_W7, N5_OZ23, N5_OZ24 );

       PrintTableLine( "N5_OZ2",  N5_OZ2,  null,
                       "N5_OZ3",  N5_OZ3,  null,
                       "N5_OZ4",  N5_OZ4,  null,
                       "N5_OZ5_1",N5_OZ5_1,null,
                       "N5_OZ5",  N5_OZ5,  null,
                       "N5_OZ6",  N5_OZ6,  null,
                       "N5_OZ7",  N5_OZ7,  null,
                       "N5_OZ8",  N5_OZ8,  null,
                       "N5_OZ9",  N5_OZ9,  null,
                       "N5_I7",   "",      null, /* разделительное поле */
                       "N5_OZ10", N5_OZ10, null,
                       "N5_OZ11", N5_OZ11, null,
                       "N5_OZ12", N5_OZ12, null,
                       "N5_OZ13_1",N5_OZ13_1,null,
                       "N5_OZ13", N5_OZ13, null,
                       "N5_OZ14", N5_OZ14, null,
                       "N5_OZ15", N5_OZ15, null,
                       "N5_OZ16", N5_OZ16, null,
                       "N5_OZ18", N5_OZ18, null,
                       "N5_OZ19", N5_OZ19, null,
                       "N5_S7",   N5_S7,   null,
                       "N5_OZ20", N5_OZ20, null,
                       "N5_OZ21", N5_OZ21, null,
                       "N5_OZ22", N5_OZ22, null,
                       "N5_W7",   N5_W7,   null,
                       "N5_OZ23", N5_OZ23, null,
                       "N5_OZ24", N5_OZ24, null);
    END;

    Query = RSDCommand( " select case when exists ( " + SqlQueryHead1 + SqlQuery + " ) then 1 else 0 end NRec from dual " );
    Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam("", RSDBP_IN, m_BegDate );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
    Query.addParam("", RSDBP_IN, NATCUR );
    Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
    Query.addParam("", RSDBP_IN, AVOIRISSKIND_BOND);
    Query.execute();
    
    RSD = TRsbDataSet(Query);
    if( RSD.MoveNext() )
       OZ_ExistsLNK = SQL_ConvTypeInteger(RSD.NRec);
    end;

    if( OZ_ExistsLNK > 0 )

       if( m_SheetN5 == false )
          UseNewSheetInTotalBook();
          m_SheetN5 = true;
       end;
       SetActiveSheet( "Облигации Закрытые" );

       m_PrintOrderN5 = true;

       /* печатаем таблицу */
       var PrevDealID:integer = 0, DealID = -1;
       var i:integer = 0;
       var AmountItogLine:integer = 0; /* количество итоговых линий и заголовков сделок */

       var FOZ6 = "", FOZ8 = "", FOZ9 = "", FOZ15 = "", FOZ16 = "", FOZ19 = "", FOZ21 = "",
           FOZ23 = "", FOZ17_1 = "", FOZ24 = "";
       var ЯчейкаПогашенногоНКД = "";

       Query1 = RSDCommand( SqlQueryHead1 + SqlQuery + SqlQueryFooter );
       Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query1.addParam("", RSDBP_IN, m_BegDate );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
       Query1.addParam("", RSDBP_IN, NATCUR );
       Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
       Query1.addParam("", RSDBP_IN, AVOIRISSKIND_BOND);
       Query1.execute();
       RSD1 = TRsbDataSet(Query1);

       RegisterTable( "N5_MainTable_1", "",
                      "N5_OZ2", "N5_OZ3", "N5_OZ4", "N5_OZ5", "N5_OZ6", "N5_OZ7", "N5_OZ8", "N5_OZ9", "N5_I7", "N5_OZ10", "N5_OZ11",
                      "N5_OZ12", "N5_OZ13", "N5_OZ14", "N5_OZ15", "N5_OZ16", "N5_OZ18", "N5_OZ19", "N5_S7", "N5_OZ20", "N5_OZ21", "N5_OZ22",
                      "N5_W7", "N5_OZ23", "N5_OZ24" );

       while( RSD1.MoveNext() )

          var ВыводЦБ = ( RSD1.Buy_Sale == PM_WRITEOFF_SUM_SALE ) AND ( RSD1.KindSale == 330 );
          if( ВыводЦБ )
             DealID = RSD1.DocumentID;
          else
             DealID = RSD1.DealIDSale;
          end;

          if( PrevDealID != DealID ) /* новая сделка */

             if( i != 0 ) /* печатаем итог по предыдущей сделке */
                SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                PrintLineTable1( "", "", "", "","",
                                 F( FormulaSUM() + "(" + FOZ6 + ":" + N5_E7(i+AmountItogLine-1) + ")" ),
                                 "",
                                 F( FormulaSUM() + "(" + FOZ8 + ":" + N5_G7(i+AmountItogLine-1) +  ")" ),
                                 F( FormulaSUM() + "(" + FOZ9 + ":" + N5_H7(i+AmountItogLine-1) +  ")" ),
                                 "", "", "", "", "", "",
                                 F( FormulaSUM() + "(" + FOZ15 + ":" + N5_O7(i+AmountItogLine-1) +  ")" ),
                                 F( FormulaSUM() + "(" + FOZ16 + ":" + N5_P7(i+AmountItogLine-1) +  ")" ),
                                 "",
                                 F( FormulaSUM() + "(" + FOZ19 + ":" + N5_R7(i+AmountItogLine-1) +  ")" ),
                                 F( FormulaIF() + "(" + N5_G7(i+AmountItogLine) + "=0;" + N5_H7(i+AmountItogLine) + "-" + N5_R7(i+AmountItogLine) + "+" + N5_Y7(i+AmountItogLine) + "-" + N5_X7(i+AmountItogLine) + ";" +  N5_G7(i+AmountItogLine) + "+" + N5_H7(i+AmountItogLine) + "-" + N5_R7(i+AmountItogLine) + "-" + N5_U7(i+AmountItogLine) + "+" + N5_Y7(i+AmountItogLine) + "-" + N5_X7(i+AmountItogLine)),
                                 "",
                                 F( FormulaSUM() + "(" + FOZ21 + ":" + N5_U7(i+AmountItogLine-1) +  ")" ),
                                 "",
                                 TS_IIF(ЭтоПогашение(RSD1.KindSale), 0, F( N5_G7(i+AmountItogLine) + "-" + N5_U7(i+AmountItogLine) )),
                                 F( FormulaSUM() + "(" + FOZ23 + ":" + N5_X7(i+AmountItogLine-1) +  ")" ),
                                 F( FormulaSUM() + "(" + FOZ24 + ":" + N5_Y7(i+AmountItogLine-1) +  ")" ) );

                FOZ6 = ""; FOZ8 = ""; FOZ9 = ""; FOZ15 = ""; FOZ16 = ""; FOZ19 = ""; FOZ21 = ""; FOZ23 = ""; FOZ24 = "";

                if( FOZ17_1 == "" )
                   FOZ17_1 = N5_S7(i+AmountItogLine);
                end;

                AmountItogLine = AmountItogLine + 1;
             end;

             PrintLineTable1( ПолучитьВидОперации(RSD1.Buy_Sale, RSD1.KindSale),
                              "", "", "", "",
                              TS_IIF(ЭтоПогашение(RSD1.KindSale), "", "НКД погашенный"),
                              "", "",
                              TS_IIF(ЭтоПогашение(RSD1.KindSale), "", СуммаПогашенногоНКД(DealID, RSD1.FIID, ВыводЦБ) ),
                              "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "" );

             ЯчейкаПогашенногоНКД = TS_IIF(ЭтоПогашение(RSD1.KindSale), "", N5_H7(i+AmountItogLine));
             AmountItogLine = AmountItogLine + 1;

          end;

          var NominalI = TS_GetFaceValue( RSD1.FIID ),
              NominalS = TS_GetFaceValue( RSD1.FIID, SQL_ConvTypeDate(RSD1.DateSale) ),
              NominalB = TS_GetFaceValue( RSD1.FIID, SQL_ConvTypeDate(RSD1.DateBuy) );
          var Amount = КоличествоБумаг(DealID, RSD1.FIID, ВыводЦБ);

          var N5_OZ20;
          if( (NominalS != 0.0) and (ЭтоПогашение(RSD1.KindSale) == false) )
             N5_OZ20 = ЦенаПоБалансу(RSD1.BuySumID, RSD1.FIID, RSD1.FaceValueFI, RSD1.DateSale) * 100.0 / NominalS;
          else
             N5_OZ20 = "";
          end;

          var N5_OZ18:money = 0.0;
          if( RSD1.Amount != 0.0 )
             N5_OZ18 = RSD1.NKDBuyAmount/RSD1.Amount;
          end;

          var N5_OZ22:string = "";
          if( ЭтоПогашение(RSD1.KindSale) == false )
             if( m_OrderFD.BeginDate() < m_BegDate )
                N5_OZ22 = F( FormulaIF() + "(" + N5_J7(i+AmountItogLine) + ">" + N5_B2(0) + ";" + N5_A7(i+AmountItogLine) + "-" + N5_J7(i+AmountItogLine) + ";" + N5_A7(i+AmountItogLine) + "-" + N5_B2(0) + ")*(" + N5_U7(i+AmountItogLine) + "+" + N5_X7(i+AmountItogLine) + "+" + N5_R7(i+AmountItogLine) + ")" );
             else
                N5_OZ22 = F( "(" + N5_A7(i+AmountItogLine) + "-" + N5_J7(i+AmountItogLine) + ")*(" + N5_U7(i+AmountItogLine) + "+" + N5_X7(i+AmountItogLine) + "+" + N5_R7(i+AmountItogLine) + ")" );
             end;
          end;

          PrintLineTable1( SQL_ConvTypeDate(RSD1.DateSale),
                           TS_IIF(PrevDealID == DealID, "", SQL_ConvTypeTime(RSD1.TimeSale)),
                           TS_IIF(PrevDealID == DealID, "", RSD1.Name),
                           TS_IIF(PrevDealID == DealID, "", NominalI),
                           TS_IIF(PrevDealID == DealID, "", NominalS),
                           TS_IIF(PrevDealID == DealID, "", Amount),
                           TS_IIF(PrevDealID == DealID, "", F( ДУ_ЧислоCЗаданнойТочностью(ЦенаПродажи(RSD1, NominalS, Amount, NominalI),4)) ),
                           TS_IIF(PrevDealID == DealID, "", СуммаПродажи(RSD1, i+AmountItogLine)),
                           TS_IIF(PrevDealID == DealID, "", ПолученныйНКД(RSD1, i+AmountItogLine)),

                           SQL_ConvTypeDate(RSD1.DateBuy),
                           SQL_ConvTypeTime(RSD1.TimeBuy),
                           RSD1.Name,
                           NominalI,
                           NominalS, /*"для уравнивания"*/
                           F( ДУ_ЧислоCЗаданнойТочностью(ЦенаПокупки(RSD1, NominalB), 4) ),
                           RSD1.Amount,
                           F( N5_O7(i+AmountItogLine) + "*" + N5_M7(i+AmountItogLine) + "*" + N5_N7(i+AmountItogLine) + "/100" ),
                           N5_OZ18,
                           TS_IIF(RSD1.NKDBuyAmount == 0, 0, F( N5_Q7(i+AmountItogLine) + "*" + N5_O7(i+AmountItogLine) )),
                           "",
                           N5_OZ20,
                           F( N5_O7(i+AmountItogLine) + "*" + N5_M7(i+AmountItogLine) + "*" + N5_T7(i+AmountItogLine) + "/100" ),
                           N5_OZ22,
                           "",
                           ВесьНачисленныйПД(RSD1),
                           ПДДоначисленныйПриПродаже(RSD1.SaleSumID) * RSD1.Amount / Amount);

          if( FOZ6 == "" )
             FOZ6  = N5_E7(i+AmountItogLine);
             FOZ8  = N5_G7(i+AmountItogLine);
             FOZ9  = N5_H7(i+AmountItogLine);
             FOZ15 = N5_O7(i+AmountItogLine);
             FOZ16 = N5_P7(i+AmountItogLine);
             FOZ19 = N5_R7(i+AmountItogLine);
             FOZ21 = N5_U7(i+AmountItogLine);
             FOZ23 = N5_X7(i+AmountItogLine);
             FOZ24 = N5_Y7(i+AmountItogLine);
          end;

          PrevDealID = DealID;

          i = i + 1;
       end;

       /* итоговая строчка от последней сделки */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "", "", "",
                        F( FormulaSUM() + "(" + FOZ6 + ":" + N5_E7(i+AmountItogLine-1) + ")" ),
                        "",
                        F( FormulaSUM() + "(" + FOZ8 + ":" + N5_G7(i+AmountItogLine-1) +  ")" ),
                        F( FormulaSUM() + "(" + FOZ9 + ":" + N5_H7(i+AmountItogLine-1) +  ")" ),
                        "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + FOZ15 + ":" + N5_O7(i+AmountItogLine-1) +  ")" ),
                        F( FormulaSUM() + "(" + FOZ16 + ":" + N5_P7(i+AmountItogLine-1) +  ")" ),
                        "",
                        F( FormulaSUM() + "(" + FOZ19 + ":" + N5_R7(i+AmountItogLine-1) +  ")" ),
                        F( FormulaIF() + "(" + N5_G7(i+AmountItogLine) + "=0;" + N5_H7(i+AmountItogLine) + "-" + N5_R7(i+AmountItogLine) + "+" + N5_Y7(i+AmountItogLine) + "-" + N5_X7(i+AmountItogLine) + ";" +  N5_G7(i+AmountItogLine) + "+" + N5_H7(i+AmountItogLine) + "-" + N5_R7(i+AmountItogLine) + "-" + N5_U7(i+AmountItogLine) + "+" + N5_Y7(i+AmountItogLine) + "-" + N5_X7(i+AmountItogLine)),
                        "",
                        F( FormulaSUM() + "(" + FOZ21 + ":" + N5_U7(i+AmountItogLine-1) +  ")" ),
                        "",
                        TS_IIF(ЭтоПогашение(RSD1.KindSale), 0, F( N5_G7(i+AmountItogLine) + "-" + N5_U7(i+AmountItogLine) )),
                        F( FormulaSUM() + "(" + FOZ23 + ":" + N5_X7(i+AmountItogLine-1) +  ")" ),
                        F( FormulaSUM() + "(" + FOZ24 + ":" + N5_Y7(i+AmountItogLine-1) +  ")" ) );

       /* последняя итоговая строка */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + TS_IIF(FOZ17_1 == "", N5_S7(i+AmountItogLine), FOZ17_1 + ":" + N5_S7(i+AmountItogLine)) + ")" ),
                        "", "",
                        F( FormulaSUM() + "(" + N5_V7(AmountItogLine) + ":" + N5_V7(i+AmountItogLine) + ")" ),
                        "", "", "" );
       AmountItogLine = AmountItogLine + 1;

       EndTable();

       /* печатаем шапку */

       PrintFormatString( "", "N5_D1",   F( N1_() + N1_A2(0) ),
                              "N5_H1",   F( N1_() + N1_F1(0) ),
                              "N5_OZT1", TS_IIF(m_OrderFD.BeginDate() < m_BegDate, "Дата окончания предыдущего месяца:", ""),
                              "N5_OZT2", TS_IIF(m_OrderFD.BeginDate() < m_BegDate, (m_BegDate - 1), ""),
                              "N5_OZI1", F( N5_S7(i+AmountItogLine) ),
                              "N5_OZI2", F( N5_V7(i+AmountItogLine) ) );

       CopyAllSheetInTotalBook( "Облигации Закрытые", false, "N5_Table1", 0, "Облигации Закрытые" );

    end;

  END;


  PRIVATE MACRO Печать_Векселя()

    var SqlQuery, Query, RSD, Query1, RSD1, Query2, RSD2, Query3, RSD3, Query4, RSD4, Query5, RSD5;
    var HeadSelect1, HeadSelect2, WhereIssuerName, FooterQuery;
    var AmountPortf:integer = 0, AmountDeal:integer = 0;
    var delim:string = "";
    var BalanceDate:date = date(0,0,0);
    var Cost:money = $0.0;
    var BeginMon:date, EndMon:date;
    var Период, FVС5 = "";
    var ExStr = false;

    HeadSelect1 = " select bnr.t_IssuerName, bnr.t_BCNumber, bnr.t_BCSeries, bnr.t_RepaymentDate, bnr.t_BCTermFormula, bnr.t_BCPresentationDate, " +
                  "        dl_leg.t_Maturity, dl_leg.t_Diff, dl_leg.t_Formula, dl_leg.t_Start, dl_leg.t_Principal, dl_leg.t_PFI, dl_leg.t_Price, " +
                  "        bnr.t_BCID, bnr.t_Issuer, dl_leg.t_Expiry, bnr.t_IssuerTaxCode, dl_leg.t_Point, tk.t_DealDate                         ";
    HeadSelect2 = " select distinct bnr.t_IssuerName, bnr.t_Issuer, bnr.t_IssuerTaxCode ";
    SqlQuery = "   from dvsbanner_dbt bnr, dfininstr_dbt fin, ddl_tick_dbt tk, dvsordlnk_dbt lnk, doprkoper_dbt kop, ddl_leg_dbt dl_leg       " +
               "  where bnr.t_bcformkind = 1 and bnr.t_Issuer not in (select t_PartyID from ddp_dep_dbt)                                      " +
               "    and fin.t_FIID = bnr.t_FIID                                                                                               " +
               "    and ( (bnr.t_BackOffice = 'А') OR (bnr.t_BackOffice = CHR(0)) )                                                           " +
               "    and bnr.t_BCID = lnk.t_BCID                                                                                               " +
               "    and kop.t_Kind_Operation = tk.t_DealType                                                                                  " +
               "    and ((instr(kop.t_SysTypes, 'B') != 0) or (tk.t_bofficekind = ?))                                                         " +
               "    and lnk.t_ContractID = tk.t_DealID                                                                                        " +
               "    and lnk.t_DocKind    = tk.t_bofficekind                                                                                   " +
               "    and lnk.t_LinkKind   = 1                                                                                                  " +
               "    and lnk.t_InterestChargeDate =                                                                                            " +
               "        ( CASE WHEN lnk.t_DocKind = ? THEN                                                                                    " +
               "                    (SELECT nvl(max(l1.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date                 " +
               "                       FROM doproper_dbt oper, doprkoper_dbt koper, ddl_tick_dbt tick, dvsordlnk_dbt l1                       " +
               "                      WHERE oper.t_DocKind    = ?                                                                             " +
               "                        AND oper.t_DocumentID = lpad(tick.T_DealID, 34, '0')                                                  " +
               "                        AND tick.t_Dealid     = l1.t_contractid                                                               " +
               "                        AND koper.t_Kind_Operation = tick.t_DealType                                                          " +
               "                        AND instr(koper.t_SysTypes, 'B') != 0                                                                 " +
               "                        AND l1.t_bcid     = bnr.t_BCID                                                                        " +
               "                        AND l1.t_linkkind = 1                                                                                 " +
               "                        AND l1.t_InterestChargeDate < ? )                                                                     " +
               "           ELSE                                                                                                               " +
               "                    (SELECT nvl(max(l2.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date                 " +
               "                       FROM dvsordlnk_dbt l2                                                                                  " +
               "                      WHERE l2.t_DocKind  = ?                                                                                 " +
               "                        AND l2.t_bcid     = bnr.t_BCID                                                                        " +
               "                        AND l2.t_linkkind = 1                                                                                 " +
               "                        AND l2.t_InterestChargeDate < ? )                                                                     " +
               "           END                                                                                                                " +
               "        )                                                                                                                     " +
               "    and fin.t_avoirkind    = ?                                                                                                " +
               "    and dl_leg.t_LegKind   = ?                                                                                                " +
               "    and dl_leg.t_DealID    = bnr.t_BCID                                                                                       " +
               "    and dl_leg.t_LegID     = 0                                                                                                " +
               "    and dl_leg.t_Formula in(0,1,2)                                                                                            " +
               "    and tk.t_ClientContrID = ?                                                                                                " +
               "    and EXISTS(select MAX(t_ChangeDate)                                                                                       " +
               "                 from dvsbnrbck_dbt                                                                                           " +
               "                where t_BCID = bnr.t_bcid                                                                                     " +
               "                  and t_ABCStatus = chr(88)                                                                                   " +
               "                  and t_NewABCStatus = ?                                                                                      " +
               "                  and t_ChangeDate < ? )                                                                                      " +
               "    and NOT EXISTS(select t_BCID                                                                                              " +
               "                     from dvsbnrbck_dbt                                                                                       " +
               "                    where t_BCID = bnr.t_bcid                                                                                 " +
               "                      and t_ABCStatus = chr(88)                                                                               " +
               "                      and t_OldABCStatus = ?                                                                                  " +
               "                      and t_ChangeDate >= ( select MAX(t_ChangeDate)                                                          " +
               "                                              from dvsbnrbck_dbt                                                              " +
               "                                             where t_BCID         = bnr.t_bcid                                                " +
               "                                               and t_ABCStatus    = chr(88)                                                   " +
               "                                               and t_NewABCStatus = ?                                                         " +
               "                                               and t_ChangeDate   < ? )                                                       " +
               "                      and t_ChangeDate < ?)                                                                                   ";
    WhereIssuerName = " and bnr.t_IssuerName = ? ";
    FooterQuery = " order by bnr.t_IssuerName ";

    MACRO PrintLineTable1( N6_VA1, N6_VA2, N6_VA3, N6_VA4, N6_VA5, N6_VA6, N6_VA7 )
       PrintTableLine( "N6_VA1", N6_VA1, null,
                       "N6_VA2", N6_VA2, null,
                       "N6_VA3", N6_VA3, null,
                       "N6_VA4", N6_VA4, null,
                       "N6_VA5", N6_VA5, null,
                       "N6_VA6", N6_VA6, null,
                       "N6_VA7", N6_VA7, null);
    END;

    MACRO PrintLineTable2( N6_VB1, N6_VB2, N6_VB3, N6_VB4, N6_VB5, N6_VB6, N6_VB7, N6_VB8, N6_VB9, N6_VB10, N6_VB11,
                           N6_VB12, N6_VB13, N6_N13, N6_VB15, N6_VB16, N6_VB17, N6_VB18, N6_VB19, N6_VB20, N6_VB21,
                           N6_VB22, N6_VB23, N6_VB24, N6_Z13 )
       PrintTableLine( "N6_VB1",    N6_VB1,    null,
                       "N6_VB2",    N6_VB2,    null,
                       "N6_VB3",    N6_VB3,    null,
                       "N6_VB4",    N6_VB4,    null,
                       "N6_VB5",    N6_VB5,    null,
                       "N6_VB6",    N6_VB6,    null,
                       "N6_VB7",    N6_VB7,    null,
                       "N6_VB8",    N6_VB8,    null,
                       "N6_VB9",    N6_VB9,    null,
                       "N6_VB10",   N6_VB10,   null,
                       "N6_VB11",   N6_VB11,   null,
                       "N6_VB12",   N6_VB12,   null,
                       "N6_VB13",   N6_VB13,   null,
                       "N6_N13",    N6_N13,    null,
                       "N6_VB15",   N6_VB15,   null,
                       "N6_VB16",   N6_VB16,   null,
                       "N6_VB17",   N6_VB17,   null,
                       "N6_VB18",   N6_VB18,   null,
                       "N6_VB19",   N6_VB19,   null,
                       "N6_VB20",   N6_VB20,   null,
                       "N6_VB21",   N6_VB21,   null,
                       "N6_VB22",   N6_VB22,   null,
                       "N6_VB23",   N6_VB23,   null,
                       "N6_VB24",   N6_VB24,   null,
                       "N6_Z13",    N6_Z13,    null);
    END;

    MACRO PrintLineTable3( N6_VС1, N6_VС2, N6_VС3, N6_VС4, N6_VС5 )
       PrintTableLine( "N6_VС1", N6_VС1, null,
                       "N6_VС2", N6_VС2, null,
                       "N6_VС3", N6_VС3, null,
                       "N6_VС4", N6_VС4, null,
                       "N6_VС5", N6_VС5, null);
    END;

    MACRO КоличествоВекселейВекселедателя( IssuerName:string ):integer

       var RetVal = 0;
       var Select = RSDCommand( " select count(1) NRec from ( " + HeadSelect1 + SqlQuery + WhereIssuerName + " ) " );
       Select.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Select.addParam("", RSDBP_IN, DL_VATRUST                      );
       Select.addParam("", RSDBP_IN, DL_VATRUST                      );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Select.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Select.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Select.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Select.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, IssuerName                      );
       Select.execute();

       var RSDSelect = TRsbDataSet(Select);

       if( RSDSelect.MoveNext() )
          RetVal = SQL_ConvTypeInteger(RSDSelect.NRec);
       end;

       return RetVal;
    END;

    MACRO СуммаПроцентовНаДатуПогашения( Formula:integer, DeltaLine:integer, ДатаН:date, ДатаК:date ):string

       var RetVal:string = "";

       if( Formula == VS_IN_DISCONT )
          RetVal = N6_I13(DeltaLine) + "-" + N6_J13(DeltaLine);
       else

          var DifferentYear:bool = false;
          var YearB, YearE, CurYear;

          DateSplit( ДатаН, null, null, YearB );
          DateSplit( ДатаК, null, null, YearE );

          var PrevAmount:integer = ДУ_ДнейВГоду( YearB );
          if( YearB != YearE )
             CurYear = YearB + 1;
             while( CurYear <= YearE )
                if( PrevAmount != ДУ_ДнейВГоду( CurYear ) )
                   DifferentYear = true;
                   break;
                end;
                CurYear = CurYear + 1;
             end;
          end;

          if( DifferentYear )
             var P1:integer = 0, P2:integer = 0;
             var T1:integer = 365, T2:integer = 366;
             var Период = ПериодПоГодам(ДатаН, ДатаК);
             var BegDate, EndDate;
             while( Период.СледующийГод(@BegDate, @EndDate) )
                if( ДУ_ДнейВГоду(BegDate) == T1 )
                   P1 = P1 + (EndDate - BegDate + 1);
                else
                   P2 = P2 + (EndDate - BegDate + 1);
                end;
             end;

             RetVal = N6_I13(DeltaLine) + "*" + N6_K13(DeltaLine) + "/100*(" + P1 + "/" + T1 + "+" + P2 + "/" + T2 + ")";
          else
             RetVal = N6_I13(DeltaLine) + "*" + N6_K13(DeltaLine) + "/100*" + N6_L13(DeltaLine) + "/" + PrevAmount;
          end;

       end;

       return F( RetVal );
    END;

    Query = RSDCommand( " select count(1) NRec from ( " + HeadSelect2 + SqlQuery + " ) " );
    Query.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
    Query.addParam("", RSDBP_IN, DL_VATRUST                      );
    Query.addParam("", RSDBP_IN, DL_VATRUST                      );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
    Query.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
    Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
    Query.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.execute();

    RSD = TRsbDataSet( Query );

    if( RSD.MoveNext() )
       AmountPortf = SQL_ConvTypeInteger(RSD.NRec); /* количество строк в таблице "Портфель" */
    end;

    if( AmountPortf > 0 )

       Query4 = RSDCommand( " select count(1) NRec from ( " + HeadSelect1 + SqlQuery + " ) " );
       Query4.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query4.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query4.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query4.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query4.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query4.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query4.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.execute();
      
       RSD4 = TRsbDataSet( Query4 );
      
       if( RSD4.MoveNext() )
          AmountDeal = SQL_ConvTypeInteger(RSD4.NRec); /* количество строк в таблице "Сделки приобретения" без итогов */
       end;

       var DeltaTable3 = AmountDeal + (AmountPortf - 1)*2;

       if( m_SheetN6 == false )
          UseNewSheetInTotalBook();
          m_SheetN6 = true;
       end;
       SetActiveSheet( "Векселя" );

       m_PrintOrderN6 = true;

       /* печатаем шапку */

       PrintFormatString( "", "N6_C2",  F( N1_() + N1_A2(0) ),
                              "N6_F2",  F( N1_() + N1_F1(0) ),
                              "N6_VT1", TS_IIF(m_OrderFD.BeginDate() < m_BegDate, "Дата окончания предыдущего месяца:", ""),
                              "N6_VT2", TS_IIF(m_OrderFD.BeginDate() < m_BegDate, (m_BegDate - 1), "") );

       /* печатем таблицу "портфель" */

       Query1 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
       Query1.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query1.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query1.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query1.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query1.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query1.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.execute();

       RSD1 = TRsbDataSet( Query1 );

       RegisterTable( "N6_MainTable_1", "",
                      "N6_VA1", "N6_VA2", "N6_VA3", "N6_VA4", "N6_VA5", "N6_VA6", "N6_VA7" );

       var DeltaDealItog = AmountPortf - 1;

       var i = 0;
       while( RSD1.MoveNext() )

          var КоличествоВекселей = КоличествоВекселейВекселедателя(RSD1.IssuerName);
          DeltaDealItog = DeltaDealItog + КоличествоВекселей + TS_IIF(i == 0, 0, 1); /* итоговая строка по данному векселедателю в таблице "Сделки приобретения" */

          RSD1.IssuerTaxCode = ПолучитьИННВекселедателя(RSD1.Issuer, RSD1.IssuerTaxCode);

          PrintLineTable1( TS_IIF((RSD1.IssuerTaxCode == ""), RSD1.IssuerName, RSD1.IssuerName + "/" + RSD1.IssuerTaxCode),
                           КоличествоВекселей,
                           F( N6_J13(DeltaDealItog) ),
                           F( N6_C6(i) + "+" + N6_E6(i) + "+" + N6_F6(i) ),
                           F( N6_V13(DeltaDealItog) ),
                           F( N6_T13(DeltaDealItog) ),
                           F( N6_Z13(DeltaDealItog) ) );
          i = i + 1;
       end;

       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "ИТОГО:",
                        F( FormulaSUM() + "(" + N6_B6(0) + ":" + N6_B6(i-1) + ")" ),
                        F( FormulaSUM() + "(" + N6_C6(0) + ":" + N6_C6(i-1) + ")" ),
                        F( FormulaSUM() + "(" + N6_D6(0) + ":" + N6_D6(i-1) + ")" ),
                        F( FormulaSUM() + "(" + N6_E6(0) + ":" + N6_E6(i-1) + ")" ),
                        F( FormulaSUM() + "(" + N6_F6(0) + ":" + N6_F6(i-1) + ")" ),
                        F( N6_Y9(AmountPortf - 1) ) );

       GL_FVA3 = N6_C6(i);
       GL_FVA5 = N6_E6(i);
       GL_FVA6 = N6_F6(i);

       EndTable();
       CopyAllSheetInTotalBook( "Векселя", false, "N6_Table1", 0, "Векселя" );

       /* печатем таблицу "Сделки приобретения" */

       var DeltaDeal = AmountPortf - 1;

       PrintFormatString( "", "N6_VB25", F( FormulaMAX() + "(" + N6_O13(DeltaDeal) + ":" + N6_O13(DeltaTable3) + TS_IIF((m_PrintOrderN7==true) and (GL_VZ19_2 != ""), ";" + GL_VZ19_2, "") + ")"),
                              "N6_VB26", F( N6_Y13(DeltaTable3+1) + "/" + N6_X13(DeltaTable3+1) + "*" + N8_() + N8_A9(0) + "*100" ),
                              "N6_VB27", F( "(" + N6_Y13(DeltaTable3+1) + "+" +
                                                  TS_IIF((m_PrintOrderN7==true) and (GL_VZ18_1 != ""), N7_() + GL_VZ18_1, "0") +
                                                  TS_IIF((m_PrintOrderN7==true) and (GL_VZ18 != ""), N7_() + GL_VZ18, "0") + ")/((" +
                                                  N6_W13(DeltaTable3+1) + "+" + 
                                                  TS_IIF((m_PrintOrderN7==true) and (GL_VZ20_1 != ""), N7_() + GL_VZ20_1, "0") +
                                                  TS_IIF((m_PrintOrderN7==true) and (GL_VZ20 != ""), N7_() + GL_VZ20, "0") + ")/" +
                                                  N6_Y8(DeltaDeal) + ")/" +  N6_Y8(DeltaDeal) + "*" + N8_() + N8_A9(0) + "*100" ) );

       GL_VB27 = N6_Y10(DeltaDeal);

       Query2 = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
       Query2.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query2.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query2.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query2.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query2.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query2.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query2.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.execute();

       RSD2 = TRsbDataSet( Query2 );

       RegisterTable( "N6_MainTable_2", "",
                      "N6_VB1", "N6_VB2", "N6_VB3", "N6_VB4", "N6_VB5", "N6_VB6", "N6_VB7", "N6_VB8", "N6_VB9", "N6_VB10", "N6_VB11",
                      "N6_VB12", "N6_VB13", "N6_N13", "N6_VB15", "N6_VB16", "N6_VB17", "N6_VB18", "N6_VB19", "N6_VB20", "N6_VB21",
                      "N6_VB22", "N6_VB23", "N6_VB24", "N6_Z13" );

       i = 0;
       var k = 0; /* количество итоговых строк */
       var m = 0; /* счётчик строк в таблице "Начисленный доход" вместе с итогами */
       var PrevIssuerName = 0;
       var VVB9 = "", VVB10 = "", VVB16 = "", VVB17 = "", VVB18 = "", VVB19 = "", VVB20 = "", VVB22 = "", VVB23 = "", VVB24 = "";
       var FVB9 = "", FVB10 = "", FVB16 = "", FVB17 = "", FVB18 = "", FVB19 = "", FVB20 = "", FVB22 = "", FVB23 = "", FVB24 = "";

       while( RSD2.MoveNext() )

          if( (PrevIssuerName != RSD2.IssuerName) and (i != 0) )
             /* печатаем итог по векселедателю */
             SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
             PrintLineTable2( "", "", "", "", "", "", "", "",
                              F( FormulaSUM() + "(" + VVB9 + ":" + N6_I13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB10 + ":" + N6_J13(DeltaDeal+i+k-1) + ")" ),
                              "", "", "", "", "",
                              F( FormulaSUM() + "(" + VVB16 + ":" + N6_P13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB17 + ":" + N6_Q13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB18 + ":" + N6_R13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB19 + ":" + N6_S13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB20 + ":" + N6_T13(DeltaDeal+i+k-1) + ")" ),
                              "",
                              F( FormulaSUM() + "(" + VVB22 + ":" + N6_V13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB23 + ":" + N6_X13(DeltaDeal+i+k-1) + ")" ),
                              F( FormulaSUM() + "(" + VVB24 + ":" + N6_Y13(DeltaDeal+i+k-1) + ")" ),
                              F( N6_Y13(DeltaDeal+i+k) + "/" + N6_X13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) + "*100" ) );

             VVB9 = ""; VVB10 = ""; VVB16 = ""; VVB17 = ""; VVB18 = ""; VVB19 = ""; VVB20 = ""; VVB22 = ""; VVB23 = ""; VVB24 = "";

             delim = TS_IIF(FVB9 == "", "", ";");
             FVB9    = FVB9    + delim + N6_I13(DeltaDeal+i+k);
             FVB10   = FVB10   + delim + N6_J13(DeltaDeal+i+k);
             FVB16   = FVB16   + delim + N6_P13(DeltaDeal+i+k);
             FVB17   = FVB17   + delim + N6_Q13(DeltaDeal+i+k);
             FVB18   = FVB18   + delim + N6_R13(DeltaDeal+i+k);
             FVB19   = FVB19   + delim + N6_S13(DeltaDeal+i+k);
             FVB20   = FVB20   + delim + N6_T13(DeltaDeal+i+k);
             FVB22   = FVB22   + delim + N6_V13(DeltaDeal+i+k);
             FVB23   = FVB23   + delim + N6_X13(DeltaDeal+i+k);
             FVB24   = FVB24   + delim + N6_Y13(DeltaDeal+i+k);

             k = k + 1;
          end;

          DL_VA_GetBalanceDate(RSD2.BCID, RSD2.DealDate, @BalanceDate, null, @Cost, null, null, null, m_OrderFD.Order().rec.SfContrID );
          var ДатаПогашения_ = ДатаПогашения(RSD2.BCTermFormula, SQL_ConvTypeDate(RSD2.BCPresentationDate), SQL_ConvTypeDate(RSD2.Maturity),
                                             SQL_ConvTypeDate(RSD2.Expiry), SQL_ConvTypeDate(RSD2.Start));

          ExStr = false;
          if( BalanceDate != date(0,0,0) )
             Период = ПериодПоМесяцам(BalanceDate, m_FormData.ReportDate-1);
             FVС5 = "";
             while( Период.СледующийМесяц(null, @BeginMon, @EndMon) )
                if( (ПолучитьСуммуПДДЗаПериод(RSD2.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD2.BCID, BeginMon, EndMon, FIROLE_PERCENT)) > 0.0 )
                   m = m + 1;
                   ExStr = true;
                end;
             end;
             if( ExStr )
                FVС5 = N6_E18(DeltaTable3 + m);
                m = m + 1;
             end;
          end;

          RSD2.IssuerTaxCode = ПолучитьИННВекселедателя(RSD2.Issuer, RSD2.IssuerTaxCode);

          var N6_VB15:string = "";
          if( m_OrderFD.BeginDate() >= m_BegDate )
             N6_VB15 = F( N6_N13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) );
          else
             N6_VB15 = F( FormulaIF() + "(" + N6_B3(0) + "<" + N6_H13(DeltaDeal+i+k) + ";" + N6_N13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) + ";" + N6_N13(DeltaDeal+i+k) + "-" + N6_B3(0) + ")" );
          end;

          PrintLineTable2( НомерКлиента(m_OrderFD.Order().rec.RegNum, true),
                           TS_IIF((RSD2.IssuerTaxCode == ""), RSD2.IssuerName, RSD2.IssuerName + "/" + RSD2.IssuerTaxCode),
                           GetVA_Kind(RSD2.Formula),
                           TS_IIF(((RSD2.BCNumber != "") and (RSD2.BCSeries != "")), trim(RSD2.BCNumber) + "," + trim(RSD2.BCSeries), trim(RSD2.BCNumber) + trim(RSD2.BCSeries)),
                           SQL_ConvTypeDate(RSD2.Start),
                           ДатаПогашения_,
                           УсловнаяДатаПогашения(RSD2.BCTermFormula, SQL_ConvTypeDate(RSD2.BCPresentationDate), SQL_ConvTypeDate(RSD2.Maturity),
                                         SQL_ConvTypeDate(RSD2.Expiry), SQL_ConvTypeDate(RSD2.Start)),
                           BalanceDate,
                           RSD2.Principal,
                           Cost,
                           TS_IIF((RSD2.Formula == VS_IN_S_PC) OR (RSD2.Formula == VS_IN_M_PC), (RSD2.Price / pow(10, RSD2.Point)), ""),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_F13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) ),
                                                                 F( N6_F13(DeltaDeal+i+k) + "-" + N6_E13(DeltaDeal+i+k) )),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_P13(DeltaDeal+i+k) + "/" + N6_J13(DeltaDeal+i+k) + "*100/" + N6_L13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) ),
                                                                 F( "(" + N6_P13(DeltaDeal+i+k) + "-" + "(" + N6_I13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + "))/" + N6_J13(DeltaDeal+i+k) + "*100/(" + N6_F13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) + ")*" + N8_() + N8_A9(0) )),
                           F( N6_F2(0) ),
                           N6_VB15,
                           СуммаПроцентовНаДатуПогашения(RSD2.Formula, DeltaDeal+i+k, SQL_ConvTypeDate(RSD2.Start), ДатаПогашения_ ),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_P13(DeltaDeal+i+k) + "/" + N6_L13(DeltaDeal+i+k) ),
                                                                 F( "(" + N6_P13(DeltaDeal+i+k) + "+" + N6_I13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + ")/(" + N6_F13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) + ")" )),
                           F( N6_Q13(DeltaDeal+i+k) + "*" + N6_O13(DeltaDeal+i+k) ),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_R13(DeltaDeal+i+k) + "+" + N6_J13(DeltaDeal+i+k) ),
                                                                 F( N6_I13(DeltaDeal+i+k) + "+" + N6_I13(DeltaDeal+i+k) + "*" + N6_K13(DeltaDeal+i+k) + "/100*(" + N6_N13(DeltaDeal+i+k) + "-" + N6_E13(DeltaDeal+i+k) + ")/" + N8_() + N8_A9(0) )),
                           F( N6_S13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + "-" + N6_V13(DeltaDeal+i+k) ),
                           F( N6_Y13(DeltaDeal+i+k) + "/" + N6_X13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) + "*100" ),
                           TS_IIF(ExStr, F(FVС5), 0.0),
                           F( N6_J13(DeltaDeal+i+k) + "*" + N6_O13(DeltaDeal+i+k) ),
                           F( N6_T13(DeltaDeal+i+k) + "+" + N6_V13(DeltaDeal+i+k) ),
                           ""
                         );

          if( VVB9 == "" )
             VVB9  = N6_I13(DeltaDeal+i+k);
             VVB10 = N6_J13(DeltaDeal+i+k);
             VVB16 = N6_P13(DeltaDeal+i+k);
             VVB17 = N6_Q13(DeltaDeal+i+k);
             VVB18 = N6_R13(DeltaDeal+i+k);
             VVB19 = N6_S13(DeltaDeal+i+k);
             VVB20 = N6_T13(DeltaDeal+i+k);
             VVB22 = N6_V13(DeltaDeal+i+k);
             VVB23 = N6_X13(DeltaDeal+i+k);
             VVB24 = N6_Y13(DeltaDeal+i+k);
          end;

          PrevIssuerName = RSD2.IssuerName;
          i = i + 1;
       end;

       /* печатаем итог по последнему векселедателю */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable2( "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + VVB9 + ":" + N6_I13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB10 + ":" + N6_J13(DeltaDeal+i+k-1) + ")" ),
                        "", "", "", "", "",
                        F( FormulaSUM() + "(" + VVB16 + ":" + N6_P13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB17 + ":" + N6_Q13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB18 + ":" + N6_R13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB19 + ":" + N6_S13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB20 + ":" + N6_T13(DeltaDeal+i+k-1) + ")" ),
                        "",
                        F( FormulaSUM() + "(" + VVB22 + ":" + N6_V13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB23 + ":" + N6_X13(DeltaDeal+i+k-1) + ")" ),
                        F( FormulaSUM() + "(" + VVB24 + ":" + N6_Y13(DeltaDeal+i+k-1) + ")" ),
                        F( N6_Y13(DeltaDeal+i+k) + "/" + N6_X13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) + "*100" ) );

       delim = TS_IIF(FVB9 == "", "", ";");
       FVB9    = FVB9    + delim + N6_I13(DeltaDeal+i+k);
       FVB10   = FVB10   + delim + N6_J13(DeltaDeal+i+k);
       FVB16   = FVB16   + delim + N6_P13(DeltaDeal+i+k);
       FVB17   = FVB17   + delim + N6_Q13(DeltaDeal+i+k);
       FVB18   = FVB18   + delim + N6_R13(DeltaDeal+i+k);
       FVB19   = FVB19   + delim + N6_S13(DeltaDeal+i+k);
       FVB20   = FVB20   + delim + N6_T13(DeltaDeal+i+k);
       FVB22   = FVB22   + delim + N6_V13(DeltaDeal+i+k);
       FVB23   = FVB23   + delim + N6_X13(DeltaDeal+i+k);
       FVB24   = FVB24   + delim + N6_Y13(DeltaDeal+i+k);
       k = k + 1;

       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable2( "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + FVB9 + ")", false ),
                        F( FormulaSUM() + "(" + FVB10 + ")", false ),
                        "", "", "", "", "",
                        F( FormulaSUM() + "(" + FVB16 + ")", false ),
                        F( FormulaSUM() + "(" + FVB17 + ")", false ),
                        F( FormulaSUM() + "(" + FVB18 + ")", false ),
                        F( FormulaSUM() + "(" + FVB19 + ")", false ),
                        F( FormulaSUM() + "(" + FVB20 + ")", false ),
                        "",
                        F( FormulaSUM() + "(" + FVB22 + ")", false ),
                        F( FormulaSUM() + "(" + FVB23 + ")", false ),
                        F( FormulaSUM() + "(" + FVB24 + ")", false ),
                        "" );

       EndTable();
       CopyAllSheetInTotalBook( "Векселя", false, "N6_Table2", 0, "Векселя" );

       /* печатем таблицу "Начисленный доход" */

       Query3 = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
       Query3.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query3.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query3.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query3.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query3.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query3.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query3.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.execute();

       RSD3 = TRsbDataSet( Query3 );

       var RegTable = false;
       i = 0;
       while( RSD3.MoveNext() )
          DL_VA_GetBalanceDate(RSD3.BCID, RSD3.DealDate, @BalanceDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );

          if( BalanceDate != date(0,0,0) )
             Период = ПериодПоМесяцам(BalanceDate, m_FormData.ReportDate-1);
             FVС5 = "";
             var Name:string = "";

             while( Период.СледующийМесяц(@Name, @BeginMon, @EndMon) )
                var ПДД = ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_PERCENT);

                if( ПДД > 0.0 )
                   if( RegTable == false )
                      RegisterTable( "N6_MainTable_3", "", "N6_VС1", "N6_VС2", "N6_VС3", "N6_VС4", "N6_VС5" );
                      RegTable = true;
                   end;

                   RSD3.IssuerTaxCode = ПолучитьИННВекселедателя(RSD3.Issuer, RSD3.IssuerTaxCode);
            
                   PrintLineTable3( TS_IIF((RSD3.IssuerTaxCode == ""), RSD3.IssuerName, RSD3.IssuerName + "/" + RSD3.IssuerTaxCode),
                                    GetVA_Kind(RSD3.Formula),
                                    TS_IIF(((RSD3.BCNumber != "") and (RSD3.BCSeries != "")), trim(RSD3.BCNumber) + "," + trim(RSD3.BCSeries), trim(RSD3.BCNumber) + trim(RSD3.BCSeries)),
                                    Name,
                                    ПДД);
            
                   delim = TS_IIF(FVС5 == "", "", ";");
                   FVС5 = FVС5 + delim + N6_E18(DeltaTable3 + i);
                   i = i + 1;
                end;
             end;

             if( FVС5 != "")
                SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                PrintLineTable3( "ИТОГО:", "", "", "", F( FormulaSUM() + "(" + FVС5 + ")" ) );
                i = i + 1;
             end;
          end;

       end;

       if( RegTable == true )
          EndTable();
          CopyAllSheetInTotalBook( "Векселя", false, "N6_Table3", 0, "Векселя" );
       end;

    end;

  END;


  PRIVATE MACRO Печать_ВекселяЗакрытые()

    var SqlQuery, Query, RSD, Query1, RSD1, Query2, RSD2;
    var BalanceDate:date = date(0,0,0);
    var Cost:money = $0.0;
    var BeginMon:date, EndMon:date;
    var ExStr = false;
    var Период, FVZN5 = "";

    SqlQuery = " select ban.t_Issuer, ban.t_IssuerName, ban.t_IssuerTaxCode, leg.t_Formula, ban.t_BCSeries, ban.t_BCNumber, " +
               "        ban.t_RegistrationDate, ban.t_BCTermFormula, leg.t_Principal,                  " +
               "        leg.t_PFI, ban.t_BCPresentationDate, leg.t_Start, leg.t_Duration,              " +
               "        leg.t_Maturity, leg.t_Expiry, ban.t_BCID, leg.t_Price, leg.t_Point, lnk.t_BCCost, " +
               "        lnk.t_DocKind, tick.t_DealDate, tick.t_DealTime                                " +
               "   from dvsordlnk_dbt lnk, dvsbanner_dbt ban, ddl_tick_dbt tick, ddl_leg_dbt leg       " +
               "  where lnk.t_BCID = ban.t_BCID                                                        " +
               "    and ( (lnk.t_LinkKind = ?) or ((lnk.t_LinkKind = ?) and (lnk.t_DocKind = ?)) )     " +
               "    and tick.t_DealID = lnk.t_ContractID                                               " +
               "    AND tick.t_bofficekind = lnk.t_dockind "+
               "    and tick.t_ClientContrID = ?                                                       " +
               "    and tick.t_DealDate >= ?                                                           " +
               "    and tick.t_DealDate <  ?                                                           " +
               "    and leg.t_DealID = ban.t_BCID                                                      " +
               "    and leg.t_LegKind = 1                                                              " +
               "    and leg.t_LegID = 0                                                                " +
               "    and leg.t_Formula in(?, ?, ?)                                                      " +
               "    and ban.t_Issuer not in (select t_PartyID from ddp_dep_dbt) "
               " order by tick.t_DealDate, tick.t_DealTime, ban.t_Issuer                               ";

    MACRO PrintLineTable1( N7_VZ2, N7_VZ3, N7_VZ4, N7_VZ5, N7_VZ6, N7_VZ7, N7_VZ8, N7_VZ9, N7_VZ10, N7_VZ11, N7_VZ12,
                           N7_VZ13, N7_VZ15, N7_VZ16, N7_VZ17, N7_VZ18, N7_VZ19, N7_VZ20 )
       PrintTableLine( "N7_VZ2",  N7_VZ2,  null,
                       "N7_VZ3",  N7_VZ3,  null,
                       "N7_VZ4",  N7_VZ4,  null,
                       "N7_VZ5",  N7_VZ5,  null,
                       "N7_VZ6",  N7_VZ6,  null,
                       "N7_VZ7",  N7_VZ7,  null,
                       "N7_VZ8",  N7_VZ8,  null,
                       "N7_VZ9",  N7_VZ9,  null,
                       "N7_VZ10", N7_VZ10, null,
                       "N7_VZ11", N7_VZ11, null,
                       "N7_VZ12", N7_VZ12, null,
                       "N7_VZ13", N7_VZ13, null,
                       "N7_VZ15", N7_VZ15, null,
                       "N7_VZ16", N7_VZ16, null,
                       "N7_VZ17", N7_VZ17, null,
                       "N7_VZ18", N7_VZ18, null,
                       "N7_VZ19", N7_VZ19, null,
                       "N7_VZ20", N7_VZ20, null);
    END;

    MACRO PrintLineTable2( N7_VZ2_1, N7_VZ3_1, N7_VZ4_1, N7_VZ5_1, N7_VZ6_1, N7_VZ7_1, N7_VZ8_1, N7_VZ9_1, N7_VZ10_1, N7_VZ11_1, N7_VZ12_1,
                           N7_VZ13_1, N7_VZ13_2, N7_VZ15_1, N7_VZ16_1, N7_VZ17_1, N7_VZ18_1, N7_VZ18_2, N7_VZ19_1, N7_VZ19_2, N7_VZ20_1 )
       PrintTableLine( "N7_VZ2_1",  N7_VZ2_1,  null,
                       "N7_VZ3_1",  N7_VZ3_1,  null,
                       "N7_VZ4_1",  N7_VZ4_1,  null,
                       "N7_VZ5_1",  N7_VZ5_1,  null,
                       "N7_VZ6_1",  N7_VZ6_1,  null,
                       "N7_VZ7_1",  N7_VZ7_1,  null,
                       "N7_VZ8_1",  N7_VZ8_1,  null,
                       "N7_VZ9_1",  N7_VZ9_1,  null,
                       "N7_VZ10_1", N7_VZ10_1, null,
                       "N7_VZ11_1", N7_VZ11_1, null,
                       "N7_VZ12_1", N7_VZ12_1, null,
                       "N7_VZ13_1", N7_VZ13_1, null,
                       "N7_VZ13_2", N7_VZ13_2, null,
                       "N7_VZ15_1", N7_VZ15_1, null,
                       "N7_VZ16_1", N7_VZ16_1, null,
                       "N7_VZ17_1", N7_VZ17_1, null,
                       "N7_VZ18_1", N7_VZ18_1, null,
                       "N7_VZ18_2", N7_VZ18_2, null,
                       "N7_VZ19_1", N7_VZ19_1, null,
                       "N7_VZ19_2", N7_VZ19_2, null,
                       "N7_VZ20_1", N7_VZ20_1, null);
    END;

    MACRO PrintLineTable3( N7_VZN1, N7_VZN2, N7_VZN3, N7_VZN4, N7_VZN5 )
       PrintTableLine( "N7_VZN1", N7_VZN1, null,
                       "N7_VZN2", N7_VZN2, null,
                       "N7_VZN3", N7_VZN3, null,
                       "N7_VZN4", N7_VZN4, null,
                       "N7_VZN5", N7_VZN5, null);
    END;

    MACRO PrintPartTable3( Flag:bool, DeltaTable3:integer, i:@integer, RegTable:@bool )

       var Query3, RSD3, BDate;

       Query3 = RSDCommand( SqlQuery );
       Query3.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
       Query3.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
       Query3.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
       Query3.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query3.addParam( "", RSDBP_IN, m_BegDate                       );
       Query3.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
       Query3.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
       Query3.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
       Query3.execute();

       RSD3 = TRsbDataSet(Query3);
       while( RSD3.MoveNext() )
          DL_VA_GetBalanceDate(RSD3.BCID, RSD3.DealDate, @BDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );

          if( BDate != date(0,0,0) )
             if( ((Flag == true) and (BDate >= (m_BegDate-1))) or
                 ((Flag == false) and (BDate < (m_BegDate-1))) )

                var Период = ПериодПоМесяцам(BDate, RSD3.DealDate);
                var Name:string;
                var FVZN5 = "";

                while( Период.СледующийМесяц(@Name, @BeginMon, @EndMon) )
                   var ПДД = ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_PERCENT);

                   if( ПДД > 0.0 )
                      if( RegTable == false )
                         RegisterTable( "N7_MainTable_3", "", "N7_VZN1", "N7_VZN2", "N7_VZN3", "N7_VZN4", "N7_VZN5" );
                         RegTable = true;
                      end;

                      RSD3.IssuerTaxCode = ПолучитьИННВекселедателя(RSD3.Issuer, RSD3.IssuerTaxCode);

                      PrintLineTable3( TS_IIF((RSD3.IssuerTaxCode == ""), RSD3.IssuerName, RSD3.IssuerName + "/" + RSD3.IssuerTaxCode),
                                       GetVA_Kind(RSD3.Formula),
                                       TS_IIF(((RSD3.BCNumber != "") and (RSD3.BCSeries != "")), trim(RSD3.BCNumber) + "," + trim(RSD3.BCSeries), trim(RSD3.BCNumber) + trim(RSD3.BCSeries)),
                                       Name,
                                       ПДД);

                      if( FVZN5 == "" )
                         FVZN5 = N7_E20(DeltaTable3 + i);
                      end;
                      i = i + 1;
                   end;
                end;

                if( FVZN5 != "")
                   SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                   PrintLineTable3( "ИТОГО:", "", "", "", F( FormulaSUM() + "(" + FVZN5 + ":" + N7_E20(DeltaTable3+i-1) + ")" ) );
                   i = i + 1;
                end;
             end;
          end;
       end;

    END;

    /* печатаем шапку */

    var AmountLineT1:integer = 0, /* Количество строк в первой таблице вместе с итогом */
        AmountLineT2:integer = 0; /* Количество строк во второй таблице вместе с итогом */

    Query2 = RSDCommand( SqlQuery );
    Query2.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
    Query2.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
    Query2.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
    Query2.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query2.addParam( "", RSDBP_IN, m_BegDate                       );
    Query2.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
    Query2.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
    Query2.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
    Query2.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
    Query2.execute();
    RSD2 = TRsbDataSet(Query2);
    while( RSD2.MoveNext() )
       DL_VA_GetBalanceDate(RSD2.BCID, RSD2.DealDate, @BalanceDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );

       if( BalanceDate != date(0,0,0) )
          if( BalanceDate >= (m_BegDate-1) ) /* Дата поставки сделки покупки входит в отчётный период */
             AmountLineT1 = AmountLineT1 + 1;
          else
             AmountLineT2 = AmountLineT2 + 1;
          end;
       end;
    end;

    if( (AmountLineT1 == 0) AND (AmountLineT2 == 0) )
       return; /*пустую страницу не печатать*/
    end;
 
    if( m_SheetN7 == false )
       UseNewSheetInTotalBook();
       m_SheetN7 = true;
    end;
    SetActiveSheet( "Векселя Закрытые" );

    m_PrintOrderN7 = true;

    var PrT1 = false, PrT2 = false;
    if( AmountLineT1 == 0 )
       AmountLineT1 = 2; /* пустая строка и итог */
    else
       AmountLineT1 = AmountLineT1 + 1; /* + итог */
       PrT1 = true;
    end;

    if( AmountLineT2 == 0 )
       AmountLineT2 = 2; /* пустая строка и итог */
    else
       AmountLineT2 = AmountLineT2 + 1; /* + итог */
       PrT2 = true;
    end;

    var DeltaTable2 = (AmountLineT1-1) - 1; /* смещение второй таблицы */
    var DeltaTable3 = DeltaTable2 + (AmountLineT2-1) - 1; /* смещение третей таблицы */

    PrintFormatString( "", "N7_C2",    F( N1_() + N1_A2(0) ),
                           "N7_G2",    F( N1_() + N1_F1(0) ),
                           "N7_VZT1",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, "Дата окончания предыдущего месяца:", ""),
                           "N7_VZT2",  TS_IIF(m_OrderFD.BeginDate() < m_BegDate, (m_BegDate - 1), ""),
                           "N7_VZ1",   F( N7_P10(AmountLineT1-1) ),
                           "N7_VZ1_1", F( N7_R15(DeltaTable2 + (AmountLineT2-1)) ),
                           "N7_VZ1_2", F( N7_R10(AmountLineT1-1) + "+" + N7_U15(DeltaTable2 + (AmountLineT2-1)) ),
                           "N7_VZ1_3", F( "(" + N7_L4(0) + "+" + N7_L5(0) + ")/" + N7_L6(0) + "*" + N8_() + N8_A9(0) + "*100" ) );

    GL_VZ1 = N7_L4(0);
    GL_VZ1_1 = N7_L5(0);
    GL_VZ1_2 = N7_L6(0);

    /* печатаем таблицу "Закрытые векселя, приобретенные в отчетном периоде" */

    Query = RSDCommand( SqlQuery );
    Query.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
    Query.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
    Query.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
    Query.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam( "", RSDBP_IN, m_BegDate                       );
    Query.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
    Query.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
    Query.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
    Query.execute();
    RSD = TRsbDataSet(Query);

    RegisterTable( "N7_MainTable_1", "",
                   "N7_VZ2", "N7_VZ3", "N7_VZ4", "N7_VZ5", "N7_VZ6", "N7_VZ7", "N7_VZ8", "N7_VZ9", "N7_VZ10", "N7_VZ11",
                   "N7_VZ12", "N7_VZ13", "N7_VZ15", "N7_VZ16", "N7_VZ17", "N7_VZ18", "N7_VZ19", "N7_VZ20" );

    var m = 0; /* счётчик строк в таблице "Начисленный доход" вместе с итогами */

    var i = 0;
    while( RSD.MoveNext() )

       DL_VA_GetBalanceDate(RSD.BCID, RSD.DealDate, @BalanceDate, null, @Cost, null, null, null, m_OrderFD.Order().rec.SfContrID );

       if( BalanceDate != date(0,0,0) )
          if( BalanceDate >= (m_BegDate-1) ) /* Дата поставки сделки покупки входит в отчётный период */

             ExStr = false;
             Период = ПериодПоМесяцам(BalanceDate, RSD.DealDate);
             FVZN5 = "";
             while( Период.СледующийМесяц(null, @BeginMon, @EndMon) )
                if( (ПолучитьСуммуПДДЗаПериод(RSD.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD.BCID, BeginMon, EndMon, FIROLE_PERCENT)) > 0.0 )
                   m = m + 1;
                   ExStr = true;
                end;
             end;
             if( ExStr )
                FVZN5 = N7_E20(DeltaTable3 + m);
                m = m + 1;
             end;

             RSD.IssuerTaxCode = ПолучитьИННВекселедателя(RSD.Issuer, RSD.IssuerTaxCode);

             PrintLineTable1( НомерКлиента(m_OrderFD.Order().rec.RegNum, true),
                              TS_IIF((RSD.IssuerTaxCode == ""), RSD.IssuerName, RSD.IssuerName + "/" + RSD.IssuerTaxCode),
                              GetVA_Kind(RSD.Formula),
                              TS_IIF(((RSD.BCNumber != "") and (RSD.BCSeries != "")), trim(RSD.BCNumber) + "," + trim(RSD.BCSeries), trim(RSD.BCNumber) + trim(RSD.BCSeries)),
                              SQL_ConvTypeDate(RSD.Start),
                              ДатаПогашения(RSD.BCTermFormula, SQL_ConvTypeDate(RSD.BCPresentationDate), SQL_ConvTypeDate(RSD.Maturity),
                                            SQL_ConvTypeDate(RSD.Expiry), SQL_ConvTypeDate(RSD.Start)),
                              УсловнаяДатаПогашения(RSD.BCTermFormula, SQL_ConvTypeDate(RSD.BCPresentationDate), SQL_ConvTypeDate(RSD.Maturity),
                                            SQL_ConvTypeDate(RSD.Expiry), SQL_ConvTypeDate(RSD.Start)),
                              BalanceDate,
                              RSD.Principal,
                              Cost,
                              TS_IIF((Formula == VS_IN_S_PC) OR (Formula == VS_IN_M_PC), (RSD.Price / pow(10, RSD.Point)), ""),
                              TS_IIF(ExStr, F(FVZN5), 0.0),
                              SQL_ConvTypeDate(RSD.DealDate),
                              RSD.BCCost,
                              F( N7_N10(i) + "-" + N7_L10(i) + "-" + N7_J10(i) ),
                              F( N7_N10(i) + "-" + N7_J10(i) ),
                              F( N7_P10(i) + "/" + N7_J10(i) + "*" + N8_() + N8_A9(0) + "/(" + N7_M10(i) + "-" + N7_H10(i) + ")*100" ),
                              F( N7_J10(i) + "*(" + N7_M10(i) + "-" + N7_H10(i) + ")" ) );

             i = i + 1;
          end;
       end;
    end;

    if( i == 0 ) /* ничего не напечатали */
       /* пустая строка с формулами */
       PrintLineTable1( "", "", "", "", "", "", "", "", "", 0, "", 0, "", 0,
                        F( N7_N10(i) + "-" + N7_L10(i) + "-" + N7_J10(i) ),
                        F( N7_N10(i) + "-" + N7_J10(i) ),
                        F( N7_P10(i) + "/" + N7_J10(i) + "*" + N8_() + N8_A9(i) + "/(" + N7_M10(i) + "-" + N7_H10(i) + ")*100" ),
                        0 );
       i = i + 1;
    end;

    /* строка с итогом */
    SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
    PrintLineTable1( "", "", "", "", "", "", "", "", "",
                     F( FormulaSUM() + "(" + N7_J10(0) + ":" + N7_J10(i-1) + ")" ),
                     "",
                     F( FormulaSUM() + "(" + N7_L10(0) + ":" + N7_L10(i-1) + ")" ),
                     "",
                     F( FormulaSUM() + "(" + N7_N10(0) + ":" + N7_N10(i-1) + ")" ),
                     F( FormulaSUM() + "(" + N7_O10(0) + ":" + N7_O10(i-1) + ")" ),
                     F( FormulaSUM() + "(" + N7_P10(0) + ":" + N7_P10(i-1) + ")" ),
                     "",
                     F( FormulaSUM() + "(" + N7_R10(0) + ":" + N7_R10(i-1) + ")" ) );
    EndTable();
    CopyAllSheetInTotalBook( "Векселя Закрытые", false, "N7_Table1", 0, "Векселя Закрытые" );

    GL_VZ17 = N7_O10(i);
    GL_VZ18 = N7_P10(i);
    GL_VZ20 = N7_R10(i);

    /* печатаем таблицу "Закрытые векселя, приобретенные до отчетного периода" */

    Query1 = RSDCommand( SqlQuery );
    Query1.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
    Query1.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
    Query1.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
    Query1.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query1.addParam( "", RSDBP_IN, m_BegDate                       );
    Query1.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
    Query1.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
    Query1.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
    Query1.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
    Query1.execute();
    RSD1 = TRsbDataSet(Query1);

    RegisterTable( "N7_MainTable_2", "",
                   "N7_VZ2_1", "N7_VZ3_1", "N7_VZ4_1", "N7_VZ5_1", "N7_VZ6_1", "N7_VZ7_1", "N7_VZ8_1", "N7_VZ9_1", "N7_VZ10_1", "N7_VZ11_1", "N7_VZ12_1",
                   "N7_VZ13_1", "N7_VZ13_2", "N7_VZ15_1", "N7_VZ16_1", "N7_VZ17_1", "N7_VZ18_1", "N7_VZ18_2", "N7_VZ19_1", "N7_VZ19_2", "N7_VZ20_1" );

    i = 0;
    while( RSD1.MoveNext() )

       DL_VA_GetBalanceDate(RSD1.BCID, RSD1.DealDate, @BalanceDate, null, @Cost, null, null, null, m_OrderFD.Order().rec.SfContrID );

       if( BalanceDate != date(0,0,0) )
          if( BalanceDate < (m_BegDate-1) ) /* Дата поставки сделки покупки не входит в отчётный период */

             ExStr = false;
             Период = ПериодПоМесяцам(BalanceDate, RSD1.DealDate);
             FVZN5 = "";
             while( Период.СледующийМесяц(null, @BeginMon, @EndMon) )
                if( (ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BeginMon, EndMon, FIROLE_PERCENT)) > 0.0 )
                   m = m + 1;
                   ExStr = true;
                end;
             end;
             if( ExStr )
                FVZN5 = N7_E20(DeltaTable3 + m);
                m = m + 1;
             end;

             RSD1.IssuerTaxCode = ПолучитьИННВекселедателя(RSD1.Issuer, RSD1.IssuerTaxCode);

             PrintLineTable2( НомерКлиента(m_OrderFD.Order().rec.RegNum, false),
                              TS_IIF((RSD1.IssuerTaxCode == ""), RSD1.IssuerName, RSD1.IssuerName + "/" + RSD1.IssuerTaxCode),
                              GetVA_Kind(RSD1.Formula),
                              TS_IIF(((RSD1.BCNumber != "") and (RSD1.BCSeries != "")), trim(RSD1.BCNumber) + "," + trim(RSD1.BCSeries), trim(RSD1.BCNumber) + trim(RSD1.BCSeries)),
                              SQL_ConvTypeDate(RSD1.Start),
                              ДатаПогашения(RSD1.BCTermFormula, SQL_ConvTypeDate(RSD1.BCPresentationDate), SQL_ConvTypeDate(RSD1.Maturity),
                                            SQL_ConvTypeDate(RSD1.Expiry), SQL_ConvTypeDate(RSD1.Start)),
                              УсловнаяДатаПогашения(RSD1.BCTermFormula, SQL_ConvTypeDate(RSD1.BCPresentationDate), SQL_ConvTypeDate(RSD1.Maturity),
                                            SQL_ConvTypeDate(RSD1.Expiry), SQL_ConvTypeDate(RSD1.Start)),
                              BalanceDate,
                              RSD1.Principal,
                              Cost,
                              (RSD1.Price / pow(10, RSD1.Point)),
                              TS_IIF(ExStr, F(FVZN5), 0.0),
                              ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BalanceDate, m_BegDate-1, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BalanceDate, m_BegDate-1, FIROLE_PERCENT),
                              SQL_ConvTypeDate(RSD1.DealDate),
                              RSD1.BCCost,
                              F( N7_O15(DeltaTable2+i) + "-" + N7_L15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                              F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                              F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) + "-" + N7_M15(DeltaTable2+i) ),
                              F( N7_Q15(DeltaTable2+i) + "/" + N7_J15(DeltaTable2+i) + "*" + N8_() + N8_A9(0) + "/(" + N7_N15(DeltaTable2+i) + "-" + N7_H15(DeltaTable2+i) + ")*100" ),
                              F( N7_N15(DeltaTable2+i) + "-" + N7_H15(DeltaTable2+i) ),
                              F( N7_J15(DeltaTable2+i) + "*" + N7_T15(DeltaTable2+i) ) );
             i = i + 1;
          end;
       end;
    end;

    if( i == 0 ) /* ничего не напечатали */
       /* пустая строка с формулами */
       PrintLineTable2( "", "", "", "", "", "", "", "", "", 0, "", 0, 0, "", 0,
                        F( N7_O15(DeltaTable2+i) + "-" + N7_L15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                        F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                        F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) + "-" + N7_M15(DeltaTable2+i) ),
                        F( N7_Q15(DeltaTable2+i) + "/" + N7_J15(DeltaTable2+i) + "*" + N8_() + N8_A9(0) + "/(" + N7_N15(DeltaTable2+i) + "-" + N7_H15(DeltaTable2+i) + ")*100" ),
                        0,
                        F( N7_J15(DeltaTable2+i) + "*" + N7_T15(DeltaTable2+i) ) );
       i = i + 1;
    end;

    /* строка с итогом */
    SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
    PrintLineTable2( "", "", "", "", "", "", "", "", "",
                     F( FormulaSUM() + "(" + N7_J15(0) + ":" + N7_J15(i-1) + ")" ),
                     "",
                     F( FormulaSUM() + "(" + N7_L15(0) + ":" + N7_L15(i-1) + ")" ),
                     "", "",
                     F( FormulaSUM() + "(" + N7_O15(0) + ":" + N7_O15(i-1) + ")" ),
                     F( FormulaSUM() + "(" + N7_P15(0) + ":" + N7_P15(i-1) + ")" ),
                     F( FormulaSUM() + "(" + N7_Q15(0) + ":" + N7_Q15(i-1) + ")" ),
                     F( FormulaSUM() + "(" + N7_R15(0) + ":" + N7_R15(i-1) + ")" ),
                     "", "",
                     F( FormulaSUM() + "(" + N7_U15(0) + ":" + N7_U15(i-1) + ")" ) );
    EndTable();
    CopyAllSheetInTotalBook( "Векселя Закрытые", false, "N7_Table2", 0, "Векселя Закрытые" );

    GL_VZ17_1 = N7_P15(i);
    GL_VZ18_2 = N7_R15(i);
    GL_VZ18_1 = N7_Q15(i);
    GL_VZ20_1 = N7_U15(i);
    GL_VZ19_2 = N7_() + N7_T15(0) + ":" + N7_() + N7_T15(i-1);

    /* печатаем таблицу "Начисленный доход" */

    if( (PrT1 == true) or (PrT2 == true) )

       var RegTable = false;
       i = 0;

       if( PrT1 == true ) /* если первая таблица не пустая */
          PrintPartTable3(true, DeltaTable3, @i, @RegTable);
       end;
       if( PrT2 == true ) /* если вторая таблица не пустая */
          PrintPartTable3(false, DeltaTable3, @i, @RegTable);
       end;

       if( RegTable == true )
          EndTable();
          CopyAllSheetInTotalBook( "Векселя Закрытые", false, "N7_Table3", 0, "Векселя Закрытые" );
       end;

    end;

  END;


  PRIVATE MACRO Печать_Отчёт();

    var SqlQuery_ДС = " SELECT distinct accdoc.t_Account, accdoc.t_chapter, accdoc.t_currency, " +
                      "        abs(rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) rest " +
                      "   FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dmctempl_dbt templ   " +
                      "  WHERE accdoc.t_catid = categ.t_id                                    " +
                      "    AND accdoc.t_clientcontrid = ?                                     " +
                      "    AND abs(rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) > 0 " +
                      "    AND categ.t_leveltype = 1                                          " +
                      "    AND categ.t_code = 'ДС ДУ'                                         " +
                      "    AND templ.t_catid = accdoc.t_catid                                 " +
                      "    AND templ.t_number = accdoc.t_templnum                             " +
                      "    AND (CASE                                                          " +
                      "            WHEN (categ.t_param1 = 2818 AND categ.t_class1 = 1702)     " +
                      "               THEN templ.t_value1                                     " +
                      "            WHEN (categ.t_param2 = 2818 AND categ.t_class2 = 1702)     " +
                      "               THEN templ.t_value2                                     " +
                      "            WHEN (categ.t_param3 = 2818 AND categ.t_class3 = 1702)     " +
                      "               THEN templ.t_value3                                     " +
                      "            WHEN (categ.t_param4 = 2818 AND categ.t_class4 = 1702)     " +
                      "               THEN templ.t_value4                                     " +
                      "            WHEN (categ.t_param5 = 2818 AND categ.t_class5 = 1702)     " +
                      "               THEN templ.t_value5                                     " +
                      "            WHEN (categ.t_param6 = 2818 AND categ.t_class6 = 1702)     " +
                      "               THEN templ.t_value6                                     " +
                      "            WHEN (categ.t_param7 = 2818 AND categ.t_class7 = 1702)     " +
                      "               THEN templ.t_value7                                     " +
                      "            WHEN (categ.t_param8 = 2818 AND categ.t_class8 = 1702)     " +
                      "               THEN templ.t_value8                                     " +
                      "         END                                                           " +
                      "        ) != 41                                                        ";/*!!! 1 "Торговый" (для 1ОБ)*/

    var StrOrder = " select t_ID " +
                   "   from dtsorder_dbt  " +
                   "  where t_DocKind = ? " +
                   "    and t_OFBU    = ? " +
                   "    and ((TrustAPI.OrderIOReqFillOutDate(t_ID) >= ? and TrustAPI.OrderIOReqFillOutDate(t_ID) < ?) " +
                   "         or " +
                   "         (TrustAPI.GetItog(t_ID,?,0,?,NULL,NULL,NULL,NULL,2) <> 0) " +
                   "        ) ";

    MACRO SqlQuery_Итог( sign:integer ):string

       var RetVal = " SELECT tstotal.t_BeginDate, sum(tstotal.t_RestAmount) as RestAmount " +
                    "   FROM dtstotal_dbt tstotal     " +
                    "  WHERE tstotal.t_OrderID   = ?  " +
                    "    AND tstotal.t_TotalType = ?  " +
                    "    AND tstotal.t_BeginDate >= ? " +
                    "    AND tstotal.t_BeginDate <= ? ";
       if( (sign == null) or (sign < 0) )
          RetVal = RetVal + " AND tstotal.t_Sign < 0 ";
       else
          RetVal = RetVal + " AND tstotal.t_Sign > 0 ";
       end;

       RetVal = RetVal + " GROUP BY tstotal.t_BeginDate "
                       + " ORDER BY tstotal.t_BeginDate ";

       return RetVal;
    END;

    MACRO ИтогПоВсемДП( OrderID:integer, Дата:date, Итог:integer, КУС:string ):money

       var RetVal:money = $0.0;
       var Sum:money = $0.0, Sum1:money = $0.0, Sum2:money = $0.0;
       var EventID:integer = 0;

       if( (КУС != null) AND (КУС != "") )
          EventID = TS_DemandEvent(КУС);
       end;

       var Select = " select tsorder.t_ID         " +
                    "   from dtsorder_dbt tsorder " +
                    "  where tsorder.t_OFBU = ?   ";

       var Query = RSDCommand(Select);
       Query.addParam( "", RSDBP_IN, OrderID );
       Query.execute();

       var DataSet = TRSBDataSet(Query);

       while( DataSet.MoveNext() )

          if( EventID > 0 ) /*завяжемся на EventID (КУС), что бы параметр лишний не передавать*/
             if( ПолучитьИтогДУ(SQL_ConvTypeInteger(DataSet.ID), Итог, EventID, 0, NULL, NULL, NULL, Дата, NULL, NULL, @Sum, 1) )
             Sum = $0.0;
          end;

             if( ПолучитьИтогДУ(SQL_ConvTypeInteger(DataSet.ID), Итог, null, 0, NULL, NULL, NULL, Дата, NULL, NULL, @Sum2, 0) )
                Sum2 = $0.0;
             end;

             if( ПолучитьИтогДУ(SQL_ConvTypeInteger(DataSet.ID), Итог, EventID, 0, NULL, NULL, NULL, Дата, NULL, NULL, @Sum1, 0) )
                Sum1 = $0.0;
             end;
          else
             if( ПолучитьИтогДУ(SQL_ConvTypeInteger(DataSet.ID), Итог, EventID, 0, NULL, NULL, NULL, Дата, NULL, NULL, @Sum, 1) )
             Sum = $0.0;
          end;
             Sum1 = Sum2 = $0.0;
          end;

          RetVal = RetVal + Sum + (Sum2 - Sum1);
       end;

       return RetVal;
    END;

    MACRO ЗаполнитьКолонкуРПУ( OrderID:integer, MonTableI:МесяцГод, MM:integer, YYYY:integer, РПУ:@money )
       РПУ = $0.0;
       if( (MonTableI.Год > YYYY) or ((MonTableI.Год == YYYY) and (MonTableI.Месяц >= MM)) )
          var РПУ_end:money = $0.0, РПУ_beg:money = $0.0;
          if(ПолучитьИтогДУ(OrderID, ДУ_ИТОГ_Р_ПУ, null, 0, NULL, NULL, NULL, date(1,MonTableI.Месяц,MonTableI.Год)-1, @РПУ_beg, NULL, NULL))
             РПУ_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(OrderID, ДУ_ИТОГ_Р_ПУ, null, 0, NULL, NULL, NULL, date(LastDay(MonTableI.Месяц,MonTableI.Год),MonTableI.Месяц,MonTableI.Год), @РПУ_end, NULL, NULL))
             РПУ_end = $0.0;
          end;
          РПУ = РПУ_end - РПУ_beg;
       end;
    END;

    MACRO ЗаполнитьПоляЗависящиеОт_i( deltaItog:integer, i:integer, AmountStrTotal:integer, RateComM, RateComS,
                                      IA16:@integer, IK16:@string, IL16:@string, IM16:@string, IN16:@string, IO16:@string, IP16:@string, IQ16:@string,
                                      IR16:@string, IS16:@string, IT16:@string, IAD16:@string, IAF16:@string, IAG16:@string, IAH16:@string, IAI16:@string,
                                      IAK16:@string, IAL16:@string, IAP16:@string, IAQ16:@string, IAR16:@string );
       IA16 = i + 1;

       IK16 = F( N1_J13(deltaItog+i) + "*" + N1_I13(deltaItog+i) + "/(" + N1_F2(0) + "-" + N1_B6(0, true) + ")" );
       IL16 = F( N1_K13(deltaItog+i) + "/" + N1_K13(deltaItog+AmountStrTotal, true) + "*100" );
       IM16 = F( N1_J29(deltaItog+AmountStrTotal-1, true) + "*" + N1_L13(deltaItog+i) + "%" );
       IN16 = F( N1_J13(deltaItog+i) + "*" + N1_L9(deltaItog, true) + "%/" + N8_() + N8_A9(0) + "*" + N1_I13(deltaItog+i) );
       IO16 = F( N1_R13(deltaItog+i) + "-" + N1_N13(deltaItog+i) );
       IP16 = F( "(" + N1_M13(deltaItog+i) + "/" + N1_J13(deltaItog+i) + "/" + N1_I13(deltaItog+i) + "*" + N8_() + N8_A9(0) + ")*100" );
       IQ16 = F( N1_J13(deltaItog+i) + "*" + string(MakeMoney(RateComM)) + "%/" + N8_() + N8_A9(0) + "*" + N1_I13(deltaItog+i) );
       IR16 = F( N1_M13(deltaItog+i) + "-" + N1_Q13(deltaItog+i) );
       IS16 = F( N1_R13(deltaItog+i) + "/" + N1_J13(deltaItog+i) + "/" + N1_I13(deltaItog+i) + "*" + N8_() + N8_A9(0) + "*100" );
       IT16 = F( N1_K13(deltaItog+AmountStrTotal, true) + "-" + N1_K13(deltaItog+i) );

       IAD16 = F( FormulaSUM() + "(" + N1_U13(deltaItog+i) + ":" + N1_AC13(deltaItog+i) + ")+" + N1_R13(deltaItog+i) );
       IAF16 = F( N1_H13(deltaItog+i) + "-" + N1_F13(deltaItog+i) );
       IAG16 = F( N1_J13(deltaItog+i) + "*" + N1_AJ13(deltaItog+i) + "%/" + N8_() + N8_A9(0) + "*" + N1_AF13(deltaItog+i) );
       IAH16 = F( N1_AD13(deltaItog+i) + "/" + N1_J13(deltaItog+i) + "/" + N1_AF13(deltaItog+i) + "*" + N8_() + N8_A9(0) + "*100" );
       IAI16 = F( N1_AD13(deltaItog+i) + "-" + N1_AG13(deltaItog+i) );
       IAK16 = F( FormulaIF() + "(" + N1_AH13(deltaItog+i) + ">" + N1_AJ13(deltaItog+i) + ";" + N1_AJ13(deltaItog+i) + "+0" + DecimalSeparator + "35*(" + N1_AH13(deltaItog+i) + "-" + N1_AJ13(deltaItog+i) + ");" + N1_AJ13(deltaItog+i) + ")" );
       IAL16 = F( N1_AK13(deltaItog+i) + "*0" + DecimalSeparator + "87" );

       IAP16 = F( FormulaIF() + "(" + N1_AI13(deltaItog+i) + ">0;" + N1_AG13(deltaItog+i) + "+" + N1_AI13(deltaItog+i) + "*0" + DecimalSeparator + "35;" + N1_AI13(deltaItog+i) + ")" );
       IAQ16 = F( N1_AP13(deltaItog+i) + "-" + FormulaROUND() + "(" + N1_AP13(deltaItog+i) + "*0" + DecimalSeparator + "13;0)" );
       IAR16 = F( FormulaIF() + "(" + N1_AI13(deltaItog+i) + ">0;" + N1_AI13(deltaItog+i) + "*" + string(RateComS) + ";0)" );
    END;

    MACRO ЗаполнитьКолонкиРПУ( OrderID:integer, BeginDate:date, MonTable:TArray, IU16:@money, IV16:@money, IW16:@money, IX16:@money, IY16:@money, IZ16:@money, IAA16:@money, IAB16:@money, IAC16:@money );

       var YYYY:integer = 0, MM:integer = 0;
       DateSplit(BeginDate, null, MM, YYYY);

       ЗаполнитьКолонкуРПУ( OrderID, MonTable[0], MM, YYYY, @IU16  );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[1], MM, YYYY, @IV16  );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[2], MM, YYYY, @IW16  );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[3], MM, YYYY, @IX16  );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[4], MM, YYYY, @IY16  );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[5], MM, YYYY, @IZ16  );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[6], MM, YYYY, @IAA16 );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[7], MM, YYYY, @IAB16 );
       ЗаполнитьКолонкуРПУ( OrderID, MonTable[8], MM, YYYY, @IAC16 );

    END;

    MACRO PrintLineTable1( N1_IB6, N1_IC6, N1_ID6, N1_IE6, N1_IF6, N1_IG6, N1_IH6, N1_FII6 )
       PrintTableLine( "A6",      "",      null,
                       "N1_IB6",  N1_IB6,  null,
                       "N1_IC6",  N1_IC6,  null,
                       "N1_ID6",  N1_ID6,  null,
                       "N1_IE6",  N1_IE6,  null,
                       "N1_IF6",  N1_IF6,  null,
                       "N1_IG6",  N1_IG6,  null,
                       "N1_IH6",  N1_IH6,  null,
                       "N1_FII6", N1_FII6, null );
    END;

    MACRO PrintLineTable2( T_IA16, T_IB16, T_IC16, T_ID16, T_IE16, T_IF16, T_IG16, T_IH16, T_II16, T_IJ16, T_IK16, T_IL16, T_IM16, T_IN16,
                           T_IO16, T_IP16, T_IQ16, T_IR16, T_IS16, T_IT16, T_IU16, T_IV16, T_IW16, T_IX16, T_IY16, T_IZ16, T_IAA16, T_IAB16,
                           T_IAC16, T_IAD16, T_IAE16, T_IAF16, T_IAG16, T_IAH16, T_IAI16, T_IAJ16, T_IAK16, T_IAL16, T_IAM16, T_IAP16, T_IAQ16, T_IAR16
                         )
       PrintTableLine( "N1_IA16",  T_IA16,  NULL,
                       "N1_IB16",  T_IB16,  NULL,
                       "N1_IC16",  T_IC16,  NULL,
                       "N1_ID16",  T_ID16,  NULL,
                       "N1_IE16",  T_IE16,  NULL,
                       "N1_IF16",  T_IF16,  NULL,
                       "N1_IG16",  T_IG16,  NULL,
                       "N1_IH16",  T_IH16,  NULL,
                       "N1_II16",  T_II16,  NULL,
                       "N1_IJ16",  T_IJ16,  NULL,
                       "N1_IK16",  T_IK16,  NULL,
                       "N1_IL16",  T_IL16,  NULL,
                       "N1_IM16",  T_IM16,  NULL,
                       "N1_IN16",  T_IN16,  NULL,
                       "N1_IO16",  T_IO16,  NULL,
                       "N1_IP16",  T_IP16,  NULL,
                       "N1_IQ16",  T_IQ16,  NULL,
                       "N1_IR16",  T_IR16,  NULL,
                       "N1_IS16",  T_IS16,  NULL,
                       "N1_IT16",  T_IT16,  NULL,
                       "N1_IU16",  T_IU16,  NULL,
                       "N1_IV16",  T_IV16,  NULL,
                       "N1_IW16",  T_IW16,  NULL,
                       "N1_IX16",  T_IX16,  NULL,
                       "N1_IY16",  T_IY16,  NULL,
                       "N1_IZ16",  T_IZ16,  NULL,
                       "N1_IAA16", T_IAA16, NULL,
                       "N1_IAB16", T_IAB16, NULL,
                       "N1_IAC16", T_IAC16, NULL,
                       "N1_IAD16", T_IAD16, NULL,
                       "N1_IAE16", T_IAE16, NULL,
                       "N1_IAF16", T_IAF16, NULL,
                       "N1_IAG16", T_IAG16, NULL,
                       "N1_IAH16", T_IAH16, NULL,
                       "N1_IAI16", T_IAI16, NULL,
                       "N1_IAJ16", T_IAJ16, NULL,
                       "N1_IAK16", T_IAK16, NULL,
                       "N1_IAL16", T_IAL16, NULL,
                       "N1_IAM16", T_IAM16, NULL,
                       "N1_IAP16", T_IAP16, NULL,
                       "N1_IAQ16", T_IAQ16, NULL,
                       "N1_IAR16", T_IAR16, NULL );
    END;

    MACRO PrintLineTable1_3( T_IAP16, T_IAQ16, T_IAR16 )
       PrintTableLine( "N1_IAP16",  T_IAP16,  NULL,
                       "N1_IAQ16",  T_IAQ16,  NULL,
                       "N1_IAR16",  T_IAR16,  NULL );
    END;

    MACRO РаспределеннаяПрибыль( OrderID:integer, ValidBeginDate:date, ReportDate:date ):MONEY
       var Р_ПУ_ув:MONEY = $0.0, Р_ПУ_ум:MONEY = $0.0;

       if(ПолучитьИтогДУ(OrderID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, ValidBeginDate-1, @Р_ПУ_ув, NULL, NULL))
          Р_ПУ_ув = $0.0;
       end;

       if(ПолучитьИтогДУ(OrderID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, ReportDate-1, NULL, @Р_ПУ_ум, NULL))
          Р_ПУ_ум = $0.0;
       end;

       return max($0.0, (Р_ПУ_ум - Р_ПУ_ув));
    END;

    OrderList();
    while( OrderNext() )

       m_PrintOrderN2 = false; m_PrintOrderN3 = false; m_PrintOrderN4 = false; m_PrintOrderN5 = false; m_PrintOrderN6 = false; m_PrintOrderN7 = false;

       GL_FVA3 = GL_FVA5 = GL_FVA6 = GL_VB27 = "";
       GL_VZ1 = GL_VZ1_1 = GL_VZ1_2 = GL_VZ17_1 = GL_VZ17 = GL_VZ18_2 = GL_VZ18_1 = GL_VZ20_1 = GL_VZ19_2 = GL_VZ18 = GL_VZ20 = "";
       GL_FAA3 = GL_AA14 = GL_FAC2 = GL_FAA10 = GL_FAA5 = GL_AA15 = "";
       GL_FOA17_1 = GL_FOA24 = GL_OA19 = GL_FOD2 = GL_FOA15 = GL_FOA11 = GL_OA20 = "";

       if( (m_BegDate != date(0,0,0)) and (m_FormData.ReportDate != date(0,0,0)) and (m_BegDate <= m_FormData.ReportDate) )

          /* печатаем вкладку 'ИТОГ'*/

          /* опеределим количество строк в таблице "Итоги по договорам присоединения" */
          var AmountStrTotal:integer = 0;
          var SqlQ = RSDCommand( StrOrder );
          SqlQ.addParam("", RSDBP_IN, TS_DOC_DPOFBU            );
          SqlQ.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID );
          SqlQ.addParam("", RSDBP_IN, m_BegDate                );
          SqlQ.addParam("", RSDBP_IN, m_FormData.ReportDate    );
          SqlQ.addParam("", RSDBP_IN, ДУ_ИТОГ_СК               );
          SqlQ.addParam("", RSDBP_IN, m_FormData.ReportDate    );
          SqlQ.execute();
          var DataSet = TRsbDataSet(SqlQ);
          while( DataSet.MoveNext() )
             var DPOrder_ = TS_OrderFD(0, SQL_ConvTypeInteger(DataSet.ID));
             var BegDate_ = max(m_BegDate, DPOrder_.BeginDateByValid());
             var БылаПролонгация_:bool = false;
             if( BegDate_ < m_FormData.ReportDate )
                БылаПролонгация_ = DPOrder_.БылаПролонгация(BegDate_, m_FormData.ReportDate);
             end;

             if( БылаПролонгация_ == true )
                AmountStrTotal = AmountStrTotal + 2;
             else
                AmountStrTotal = AmountStrTotal + 1;
             end;
          end;

          if( AmountStrTotal <= 0 )
             continue;
          end;

          m_ReportWasRun = true;

          var Amount_ДС:integer = 0; /* количество строк в таблице "Денежные средства" */
          var SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_ДС + " ) " );
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
          SqlData.execute();
          var DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_ДС = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_Н_Купр_ув:integer = 0; /* количество строк в таблице "Комиссия за управление: начислено" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог(1) + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Купр);
          SqlData.addParam("", RSDBP_IN, m_BegDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Н_Купр_ув = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_Н_Купр_ум:integer = 0; /* количество строк в таблице "Комиссия за управление: удержано" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог(-1) + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Купр);
          SqlData.addParam("", RSDBP_IN, m_BegDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Н_Купр_ум = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_Н_Купр = max(Amount_Н_Купр_ув, Amount_Н_Купр_ум);

          var Amount_Д_Двд:integer = 0; /* количество строк в таблице "Дивиденды" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог(1) + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Д_Двд);
          SqlData.addParam("", RSDBP_IN, m_BegDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Д_Двд = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          if( m_SheetN1 == false )
             UseNewSheetInTotalBook();
             m_SheetN1 = true;
          end;
          SetActiveSheet( "ИТОГ" );

          /* Заголовок отчета */

          PrintFormatString( "",
                             "N1_IF1", m_FormData.ReportDate,
                             "N1_IA1", "ОФБУ " + m_OrderFD.Number() + " " + m_OrderFD.Name(),
                             "N1_IF2", F( N1_F1(0) + "+1" ) );

          /* Средневзвешенный капитал ОФБУ */

          RegisterTable( "N1_MainTable_1", "",
                         "A6", "N1_IB6", "N1_IC6", "N1_ID6", "N1_IE6", "N1_IF6", "N1_IG6", "N1_IH6", "N1_FII6",
                         "J6", "K6", "L6", "M6", "N6", "O6", "P6", "Q6", "R6", "S6", "T6", "U6", "V6", "W6", "X6", "Y6", "Z6", "AA6", "AB6", "AC6", "AD6", "AE6", "AF6", "AG6", "AH6" );

          var Sum:money = $0.0;
          if( ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, m_BegDate-1, NULL, NULL, @Sum) )
             Sum = $0.0;
          end;

          PrintLineTable1( m_BegDate,
                           Sum,
                           "", "",
                           F( N1_C6(0) + "+" + FormulaIF() + "(" + N1_D6(0) + "<>\" \";" + N1_D6(0) + ")-" + FormulaIF() + "(" + N1_E6(0) + "<>\" \";" + N1_E6(0) + ")" ),
                           F( N1_B6(1) + "-" + N1_B6(0) ),
                           F( N1_F6(0) + "*" + N1_G6(0) ),
                           "" );

          SqlQ = RSDCommand( " select distinct t_BeginDate " +
                             "   from dtstotal_dbt         " +
                             "  where t_totaltype = ?      " +
                             "    and t_orderid   = ?      " +
                             "    and t_EventID  <> ?      " +
                             "    and t_BeginDate < ?      " +
                             "    and t_BeginDate > ?      " +
                             " order by t_BeginDate        " );

          SqlQ.addParam("", RSDBP_IN, ДУ_ИТОГ_СК               );
          SqlQ.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID );
          SqlQ.addParam("", RSDBP_IN, TS_DemandEvent("96")     );
          SqlQ.addParam("", RSDBP_IN, m_FormData.ReportDate    );
          SqlQ.addParam("", RSDBP_IN, m_BegDate                );
          SqlQ.execute();
          DataSet = TRsbDataSet(SqlQ);

          var i = 1;
          while( DataSet.MoveNext() )

             var SubAmount:money = $0.0, AddAmount:money = $0.0;

             var rsd = RSDCommand( " select SUM(CASE WHEN t_Sign < 0 THEN (NVL(t_RestAmount,0)) ELSE 0 END) SubAmount, " +
                                   "        SUM(CASE WHEN t_Sign > 0 THEN  (NVL(t_RestAmount,0)) ELSE 0 END) AddAmount  " +
                                   "   from dtstotal_dbt    " +
                                   "  where t_totaltype = ? " +
                                   "    and t_orderid   = ? " +
                                   "    and t_EventID  <> ? " +
                                   "    and t_BeginDate = ? " );

             rsd.addParam( "", RSDBP_IN, ДУ_ИТОГ_СК               );
             rsd.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.ID );
             rsd.addParam( "", RSDBP_IN, TS_DemandEvent("96")     );
             rsd.addParam( "", RSDBP_IN, SQL_ConvTypeDate(DataSet.BeginDate) );
             rsd.execute();
             var ds = TRsbDataSet( rsd );
             if( ds.MoveNext() )
                SubAmount = SQL_ConvTypeSum(ds.rec.SubAmount);
                AddAmount = SQL_ConvTypeSum(ds.rec.AddAmount);
             end;

             PrintLineTable1( SQL_ConvTypeDate(DataSet.BeginDate),
                              F( N1_F6(i-1) ),
                              TS_IIF(AddAmount == $0.0, "", AddAmount),
                              TS_IIF(SubAmount == $0.0, "", SubAmount),
                              F( N1_C6(i) + "+" + FormulaIF() + "(" + N1_D6(i) + "<>\" \";" + N1_D6(i) + ")-" + FormulaIF() + "(" + N1_E6(i) + "<>\" \";" + N1_E6(i) + ")" ),
                              F( N1_B6(i+1) + "-" + N1_B6(i) ),
                              F( N1_F6(i) + "*" + N1_G6(i) ),
                              "" );
             i = i + 1;
          end;

          PrintLineTable1( F( N1_F2(0) ), "", "", "", "", "", "", "" ); i = i + 1;
          PrintLineTable1( "ИТОГО", "",
                           F( FormulaSUM() + "(" + N1_D6(0) + ":" + N1_D6(i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_E6(0) + ":" + N1_E6(i-1) + ")" ),
                           "",
                           F( FormulaSUM() + "(" + N1_G6(0) + ":" + N1_G6(i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_H6(0) + ":" + N1_H6(i-1) + ")" ),
                           F( N1_H6(i+1) + "-" + N1_K13(i+AmountStrTotal-1) ) );
          EndTable();

          /* Отдельные показатели отчета */

          var RateComS = 0.0;
          var CommNumberS = ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSS", m_FormData.ReportDate);
          ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, CommNumberS, m_FormData.ReportDate, 1, @RateComS, null);

          var RateComM = 0.0;
          var CommNumberM = ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSM", m_FormData.ReportDate);
          ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, CommNumberM, m_FormData.ReportDate, 1, @RateComM, null);

          var deltaItog  = i - 1;
          var DeltaActiv = deltaItog + AmountStrTotal - 1;
          var DeltaCom   = DeltaActiv + (Amount_ДС - 1) + 2 - 1;
          var DeltaDvd   = DeltaCom + (Amount_Н_Купр - 1);

          PrintFormatString( "",
                             "N1_IJ6", F( N1_S13(deltaItog) ),
                             "N1_IM3", "Распределение Прибыли Учредителей после распределения " + string(MakeMoney(RateComS)) + "/" + string(MakeMoney(100-RateComS)) + " (% от превышения)",
                             "N1_IM6", F( FormulaIF() + "(" + N1_J4(0) + ">" + N1_L9(deltaItog) + ";(" + N1_J4(0) + "-" + N1_L9(deltaItog) + ")*" + string(MakeMoney(100-RateComS)) + "/100;0)" ),
                             "N1_IO6", F( N1_L9(deltaItog) + "+" + N1_M4(0) ),
                             "N1_IX6", F( N1_O13(deltaItog+AmountStrTotal) ),
                             "N1_IAB6", F( FormulaSUMIF() + "(" + N1_AI13(deltaItog,true) + ":" + N1_AI13(deltaItog+AmountStrTotal-1) + ";\">0\";" + N1_AI13(deltaItog,true) + ":" + N1_AI13(deltaItog+AmountStrTotal-1) + ")" ),
                             "N1_IAF6", F( FormulaSUMIF() + "(" + N1_AI13(deltaItog,true) + ":" + N1_AI13(deltaItog+AmountStrTotal-1) + ";\"<0\";" + N1_AI13(deltaItog,true) + ":" + N1_AI13(deltaItog+AmountStrTotal-1) + ")" )
                           );

          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table1", 0, "ИТОГ" );

          /* Показатель для контроля, СЧА и ставка рефинансирования ЦБ */

          PrintFormatString( "",
                             "N1_FFIH6", F( N1_H6(i) + "/" + N1_G6(i) ),
                             "N1_IK9",   F( N1_I29(DeltaActiv) + "+" + N1_E37(DeltaActiv+Amount_ДС+1) + "-" + N1_Q13(deltaItog+AmountStrTotal) ),
                             "N1_IL10",  СреднCтавкаРефинансированияЦБР(m_BegDate, m_FormData.ReportDate, NATCUR)
                           );

          /* Итоги по договорам присоединения */
          /* Для включения в таблицу отбираются договора присоединения данного ОФБУ, у которых:
               - по состоянию на начало ОД капитал не равен 0
               или
               - дата, предшествующая Думк при закрытии договора, входит в ОМ. */

          var MonTable = TArray();
          var YYYY:integer = 0, MM:integer = 0;
          DateSplit(m_FormData.ReportDate, null, MM, YYYY);
          var YYYY_:integer = YYYY;
          i = 0;
          while( i <= 8 )
             if( MM == 1 )
                MM = 12;
             else
                MM = MM - 1;
             end;
             if( MM == 12 )
                YYYY_ = YYYY_ - 1;
             end;
             MonTable[8-i] = МесяцГод(MM, YYYY_);
             i = i + 1;
          end;

          /* Печатаем первый блок */
          PrintFormatString( "",
                             "N1_IQ15",  "Вознаграждение, " + string(MakeMoney(RateComM)) + "% в год",
                             "N1_IU15",  СтрМесяцГод(MonTable[0]),
                             "N1_IV15",  СтрМесяцГод(MonTable[1]),
                             "N1_IW15",  СтрМесяцГод(MonTable[2]),
                             "N1_IX15",  СтрМесяцГод(MonTable[3]),
                             "N1_IY15",  СтрМесяцГод(MonTable[4]),
                             "N1_IZ15",  СтрМесяцГод(MonTable[5]),
                             "N1_IAA15", СтрМесяцГод(MonTable[6]),
                             "N1_IAB15", СтрМесяцГод(MonTable[7]),
                             "N1_IAC15", СтрМесяцГод(MonTable[8]),
                             "N1_IAJ15", "Наши " + string(MakeMoney(RateComS)) + "%"
                           );

          RegisterTable( "N1_MainTable2", "",
                         "N1_IA16", "N1_IB16", "N1_IC16", "N1_ID16", "N1_IE16", "N1_IF16", "N1_IG16", "N1_IH16", "N1_II16", "N1_IJ16", "N1_IK16",
                         "N1_IL16", "N1_IM16", "N1_IN16", "N1_IO16", "N1_IP16", "N1_IQ16", "N1_IR16", "N1_IS16", "N1_IT16", "N1_IU16", "N1_IV16",
                         "N1_IW16", "N1_IX16", "N1_IY16", "N1_IZ16", "N1_IAA16", "N1_IAB16", "N1_IAC16", "N1_IAD16", "N1_IAE16", "N1_IAF16",
                         "N1_IAG16", "N1_IAH16", "N1_IAI16", "N1_IAJ16", "N1_IAK16", "N1_IAL16", "N1_IAM16", "N1_IAP16", "N1_IAQ16", "N1_IAR16"
                       );

          SqlQ = RSDCommand( StrOrder );
          SqlQ.addParam("", RSDBP_IN, TS_DOC_DPOFBU            );
          SqlQ.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID );
          SqlQ.addParam("", RSDBP_IN, m_BegDate                );
          SqlQ.addParam("", RSDBP_IN, m_FormData.ReportDate    );
          SqlQ.addParam("", RSDBP_IN, ДУ_ИТОГ_СК               );
          SqlQ.addParam("", RSDBP_IN, m_FormData.ReportDate    );
          SqlQ.execute();
          DataSet = TRsbDataSet(SqlQ);
          i = 0;
          while( DataSet.MoveNext() )
             var DPOrder = TS_OrderFD(0, SQL_ConvTypeInteger(DataSet.ID));
             var ДатаПервичногоВнесения = DPOrder.ДатаПервичногоВнесения();
             var ДатаПолногоВывода = DPOrder.ДатаПолногоВывода();
             var BegDate = max(m_BegDate, DPOrder.BeginDateByValid());
             var БылаПролонгация:bool = false;

             if( BegDate < m_FormData.ReportDate )
                БылаПролонгация = DPOrder.БылаПролонгация(BegDate, m_FormData.ReportDate);
             end;

             var IB16 = DPOrder.Trustor().rec.ShortName,
                 IC16 = DPOrder.Number(),
                 ID16 = ДатаДоговора(DPOrder),
                 IJ16;

             if( (ДатаПолногоВывода >= BegDate) and (ДатаПолногоВывода < m_FormData.ReportDate) )
                 IJ16 = DPOrder.КапиталУчредителя(ДатаПолногоВывода - 1);
             else
                 IJ16 = DPOrder.КапиталУчредителя(m_FormData.ReportDate - 1);
             end;

             var IE16, IF16, IG16, IH16, II16, IU16, IV16, IW16, IX16, IY16, IZ16, IAA16, IAB16, IAC16, IAE16, IAJ16, IAM16,
                 IA16, IK16, IL16, IM16, IN16, IO16, IP16, IQ16, IR16, IS16, IT16, IAD16, IAF16, IAG16, IAH16, IAI16, IAK16, IAL16, IAP16, IAQ16, IAR16;
             var ValidBeginDate, ValidEndDate;
             if( БылаПролонгация )
                /* первый период */
                ValidBeginDate = DPOrder.Valid(BegDate).rec.BeginDate;
                ValidEndDate   = DPOrder.Valid(BegDate).rec.EndDate;

                ЗаполнитьПоляЗависящиеОт_i( deltaItog, i, AmountStrTotal, RateComM, RateComS, @IA16, @IK16, @IL16, @IM16, @IN16, @IO16, @IP16,
                                            @IQ16, @IR16, @IS16, @IT16, @IAD16, @IAF16, @IAG16, @IAH16, @IAI16, @IAK16, @IAL16, @IAP16, @IAQ16, @IAR16 );

                IE16 = IF16 = max(ValidBeginDate, ДатаПервичногоВнесения);

                if( (ДатаПервичногоВнесения > BegDate) and (ДатаПервичногоВнесения < m_FormData.ReportDate) )
                   IG16 = ДатаПервичногоВнесения;
                else
                   IG16 = BegDate;
                end;

                if( (ДатаПолногоВывода > BegDate) and (ДатаПолногоВывода < m_FormData.ReportDate) )
                   IH16 = ДатаПолногоВывода;
                else
                   IH16 = ValidEndDate + 1;
                end;

                II16 = F(N1_H13(deltaItog+i) + "-" + N1_G13(deltaItog+i));

                ЗаполнитьКолонкиРПУ( DPOrder.Order().rec.ID, ValidBeginDate, MonTable, @IU16, @IV16, @IW16, @IX16, @IY16, @IZ16, @IAA16, @IAB16, @IAC16 );

                IAE16 = РаспределеннаяПрибыль(DPOrder.Order().rec.ID, ValidBeginDate, m_FormData.ReportDate);

                IAJ16 = СреднCтавкаРефинансированияЦБР(max(ДатаПервичногоВнесения, ValidBeginDate), ValidEndDate, NATCUR);

                IAM16 = ValidEndDate;

                PrintLineTable2(IA16, IB16, IC16, ID16, IE16, IF16, IG16, IH16, II16, IJ16, IK16, IL16, IM16, IN16,
                                IO16, IP16, IQ16, IR16, IS16, IT16, IU16, IV16, IW16, IX16, IY16, IZ16, IAA16,
                                IAB16, IAC16, IAD16, IAE16, IAF16, IAG16, IAH16, IAI16, IAJ16, IAK16, IAL16,
                                IAM16, IAP16, IAQ16, IAR16 );
                i = i + 1;

                /* второй период */
                ValidBeginDate = DPOrder.Valid(m_FormData.ReportDate).rec.BeginDate;
                ValidEndDate   = DPOrder.Valid(m_FormData.ReportDate).rec.EndDate;

                ЗаполнитьПоляЗависящиеОт_i( deltaItog, i, AmountStrTotal, RateComM, RateComS, @IA16, @IK16, @IL16, @IM16, @IN16, @IO16, @IP16,
                                            @IQ16, @IR16, @IS16, @IT16, @IAD16, @IAF16, @IAG16, @IAH16, @IAI16, @IAK16, @IAL16, @IAP16, @IAQ16, @IAR16 );

                IE16 = IF16 = ValidBeginDate;
                if( (ДатаПервичногоВнесения > BegDate) and (ДатаПервичногоВнесения < m_FormData.ReportDate) )
                   IG16 = ДатаПервичногоВнесения;
                else
                   IG16 = ValidBeginDate;
                end;

                if( (ДатаПолногоВывода > BegDate) and (ДатаПолногоВывода < m_FormData.ReportDate) )
                   IH16 = ДатаПолногоВывода;
                else
                   IH16 = m_FormData.ReportDate;
                end;

                if( (ДатаПолногоВывода > BegDate) and (ДатаПолногоВывода < m_FormData.ReportDate) )
                   II16 = F(N1_H13(deltaItog+i) + "-" + N1_G13(deltaItog+i));
                else
                   II16 = F( N1_F2(0) + "-" + N1_G13(deltaItog+i));
                end;

                ЗаполнитьКолонкиРПУ( DPOrder.Order().rec.ID, ValidBeginDate, MonTable, @IU16, @IV16, @IW16, @IX16, @IY16, @IZ16, @IAA16, @IAB16, @IAC16 );

                IAE16 = РаспределеннаяПрибыль(DPOrder.Order().rec.ID, ValidBeginDate, m_FormData.ReportDate);

                IAJ16 = СреднCтавкаРефинансированияЦБР(ValidBeginDate, m_FormData.ReportDate, NATCUR);

                IAM16 = ValidEndDate;

                PrintLineTable2(IA16, IB16, IC16, ID16, IE16, IF16, IG16, IH16, II16, IJ16, IK16, IL16, IM16, IN16,
                                IO16, IP16, IQ16, IR16, IS16, IT16, IU16, IV16, IW16, IX16, IY16, IZ16, IAA16,
                                IAB16, IAC16, IAD16, IAE16, IAF16, IAG16, IAH16, IAI16, IAJ16, IAK16, IAL16,
                                IAM16, IAP16, IAQ16, IAR16 );
             else
                ValidBeginDate = DPOrder.Valid(m_FormData.ReportDate).rec.BeginDate;
                ValidEndDate   = DPOrder.Valid(m_FormData.ReportDate).rec.EndDate;

                ЗаполнитьПоляЗависящиеОт_i( deltaItog, i, AmountStrTotal, RateComM, RateComS, @IA16, @IK16, @IL16, @IM16, @IN16, @IO16, @IP16,
                                            @IQ16, @IR16, @IS16, @IT16, @IAD16, @IAF16, @IAG16, @IAH16, @IAI16, @IAK16, @IAL16, @IAP16, @IAQ16, @IAR16 );

                IE16 = max(ValidBeginDate, ДатаПервичногоВнесения);

                if( DPOrder.БылаПролонгация(DPOrder.BeginDate(), m_FormData.ReportDate) )
                   IF16 = IE16;
                else
                   IF16 = ДатаПервичногоВнесения;
                end;

                if( (ДатаПервичногоВнесения > BegDate) and (ДатаПервичногоВнесения < m_FormData.ReportDate) )
                   IG16 = ДатаПервичногоВнесения;
                else
                   IG16 = BegDate;
                end;

                if( (ДатаПолногоВывода > BegDate) and (ДатаПолногоВывода < m_FormData.ReportDate) )
                   IH16 = ДатаПолногоВывода;
                else
                   IH16 = m_FormData.ReportDate;
                end;

                if( (ДатаПолногоВывода > BegDate) and (ДатаПолногоВывода < m_FormData.ReportDate) )
                   II16 = F(N1_H13(deltaItog+i) + "-" + N1_G13(deltaItog+i));
                else
                   II16 = F(N1_F1(1) + "-" + N1_G13(deltaItog+i));
                end;

                ЗаполнитьКолонкиРПУ( DPOrder.Order().rec.ID, ValidBeginDate, MonTable, @IU16, @IV16, @IW16, @IX16, @IY16, @IZ16, @IAA16, @IAB16, @IAC16 );

                IAE16 = РаспределеннаяПрибыль(DPOrder.Order().rec.ID, ValidBeginDate, m_FormData.ReportDate);

                IAJ16 = СреднCтавкаРефинансированияЦБР(max(ДатаПервичногоВнесения, ValidBeginDate), m_FormData.ReportDate, NATCUR);

                IAM16 = ValidEndDate;

                PrintLineTable2(IA16, IB16, IC16, ID16, IE16, IF16, IG16, IH16, II16, IJ16, IK16, IL16, IM16, IN16,
                                IO16, IP16, IQ16, IR16, IS16, IT16, IU16, IV16, IW16, IX16, IY16, IZ16, IAA16,
                                IAB16, IAC16, IAD16, IAE16, IAF16, IAG16, IAH16, IAI16, IAJ16, IAK16, IAL16,
                                IAM16, IAP16, IAQ16, IAR16 );
             end;

             i = i + 1;
          end;

          PrintLineTable2( "", "ИТОГО:", "", "", "", "", "", "", "",
                           F( FormulaSUM() + "(" + N1_J13(deltaItog) + ":" + N1_J13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_K13(deltaItog) + ":" + N1_K13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_L13(deltaItog) + ":" + N1_L13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_M13(deltaItog) + ":" + N1_M13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_N13(deltaItog) + ":" + N1_N13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_O13(deltaItog) + ":" + N1_O13(deltaItog+i-1) + ")" ),
                           "",
                           F( FormulaSUM() + "(" + N1_Q13(deltaItog) + ":" + N1_Q13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_R13(deltaItog) + ":" + N1_R13(deltaItog+i-1) + ")" ),
                           "", "",
                           F( FormulaSUM() + "(" + N1_U13(deltaItog) + ":" + N1_U13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_V13(deltaItog) + ":" + N1_V13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_W13(deltaItog) + ":" + N1_W13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_X13(deltaItog) + ":" + N1_X13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_Y13(deltaItog) + ":" + N1_Y13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_Z13(deltaItog) + ":" + N1_Z13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AA13(deltaItog) + ":" + N1_AA13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AB13(deltaItog) + ":" + N1_AB13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AC13(deltaItog) + ":" + N1_AC13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AD13(deltaItog) + ":" + N1_AD13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AE13(deltaItog) + ":" + N1_AE13(deltaItog+i-1) + ")" ),
                           "",
                           F( FormulaSUM() + "(" + N1_AG13(deltaItog) + ":" + N1_AG13(deltaItog+i-1) + ")" ),
                           "",
                           F( FormulaSUM() + "(" + N1_AI13(deltaItog) + ":" + N1_AI13(deltaItog+i-1) + ")" ),
                           "", "", "", "",
                           F( FormulaSUM() + "(" + N1_AP13(deltaItog) + ":" + N1_AP13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AQ13(deltaItog) + ":" + N1_AQ13(deltaItog+i-1) + ")" ),
                           F( FormulaSUM() + "(" + N1_AR13(deltaItog) + ":" + N1_AR13(deltaItog+i-1) + ")" ) );

          EndTable();
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table2", 0, "ИТОГ" );

          /* отдельная строчка с полем FFIM16 */
          PrintFormatString( "", "N1_FFIM16", F( N1_N13(deltaItog+i) + "+" + N1_O13(deltaItog+i) + "+" + N1_Q13(deltaItog+i) ) );
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_FFIM16_", 0, "ИТОГ" );
          Печать_АкцииЗакрытые();
          Печать_Акции(DeltaDvd + Amount_Д_Двд);
          Печать_ОблигацииЗакрытые();
          Печать_Облигации();
          Печать_ВекселяЗакрытые();
          Печать_Векселя();

          SetActiveSheet( "ИТОГ" );

          /* Расшифровка активов ОФБУ */

          var N1_IH21:string = "0";
          if( m_PrintOrderN6 and m_PrintOrderN7 )
             N1_IH21 = N6_() + GL_FVA6 + "+" + N7_() + GL_VZ18_2;
          elif( m_PrintOrderN6 )
             N1_IH21 = N6_() + GL_FVA6;
          elif( m_PrintOrderN7 )
             N1_IH21 = N7_() + GL_VZ18_2;
          end;

          PrintFormatString( "",
                             "N1_IE21", TS_IIF(m_PrintOrderN6, F( N6_() + GL_FVA3 + "+" + N6_() + GL_FVA5 ), 0.0),
                             "N1_IF21", TS_IIF(m_PrintOrderN7, F( N7_() + GL_VZ17_1 + "+" + N7_() + GL_VZ17 ), 0.0),
                             "N1_IG21", 0.0,
                             "N1_IH21", F( N1_IH21 ),
                             "N1_II21", F( N1_E18(DeltaActiv) + "+" + N1_H18(DeltaActiv) ),
                             "N1_IJ21", F( N1_F18(DeltaActiv) + "+" + N1_H18(DeltaActiv) + "-" + N1_G18(DeltaActiv) ),
                             "N1_IK21", TS_IIF(m_PrintOrderN6, F( N6_() + GL_VB27 ), 0.0),

                             "N1_IE22", TS_IIF(m_PrintOrderN2, F( N2_() + GL_FAA3 ), 0.0),
                             "N1_IF22", TS_IIF(m_PrintOrderN2, F( N2_() + GL_AA14 ), 0.0),
                             "N1_IG22", TS_IIF(m_PrintOrderN2, F( FormulaIF() + "(" + N1_E19(DeltaActiv) + ">" + N1_E22(DeltaActiv) + ";" + TS_IIF(GL_FAC2 != "", N2_() + GL_FAC2, "0") + "+" + N8_() + N8_A5(0) + ";" + TS_IIF(GL_FAC2 != "", N2_() + GL_FAC2, "0") + ")" ), 0.0),
                             "N1_IH22", TS_IIF(m_PrintOrderN2, F( N2_() + GL_FAA10 + "+" + N2_() + GL_FAA5 ), 0.0),
                             "N1_II22", F( N1_E19(DeltaActiv) + "+" + N1_H19(DeltaActiv) ),
                             "N1_IJ22", F( N1_F19(DeltaActiv) + "+" + N1_H19(DeltaActiv) + "-" + N1_G19(DeltaActiv) ),
                             "N1_IK22", TS_IIF(m_PrintOrderN2, F( N2_() + GL_AA15 ), 0.0),

                             "N1_IE23", 0.0,
                             "N1_IF23", 0.0,
                             "N1_IG23", 0.0,
                             "N1_IH23", 0.0,
                             "N1_II23", F( N1_E20(DeltaActiv) + "+" + N1_H20(DeltaActiv) ),
                             "N1_IJ23", F( N1_F20(DeltaActiv) + "+" + N1_H20(DeltaActiv) + "-" + N1_G20(DeltaActiv) ),
                             "N1_IK23", 0.0,

                             "N1_IF24", F( N1_C52(DeltaDvd + Amount_Д_Двд) ),
                             "N1_IJ24", F( N1_F21(DeltaActiv) ),

                             "N1_IE25", TS_IIF(m_PrintOrderN4, F( N4_() + GL_FOA17_1), 0.0),
                             "N1_IF25", TS_IIF(m_PrintOrderN4, F( N4_() + GL_OA19 ), 0.0),
                             "N1_IG25", TS_IIF(m_PrintOrderN4, F( FormulaIF() + "(" + N1_E19(DeltaActiv) + ">" + N1_E22(DeltaActiv) + ";" + TS_IIF(GL_FOD2 != "", N4_() + GL_FOD2, "0") + ";" + TS_IIF(GL_FOD2 != "", N4_() + GL_FOD2, "0") + "+" + N8_() + N8_A5(0) + ")" ), 0.0),
                             "N1_IH25", TS_IIF(m_PrintOrderN4, F( N4_() + GL_FOA15 + "+" + N4_() + GL_FOA11 ), 0.0),
                             "N1_II25", F( N1_E22(DeltaActiv) + "+" + N1_H22(DeltaActiv) ),
                             "N1_IJ25", F( N1_F22(DeltaActiv) + "+" + N1_H22(DeltaActiv) + "-" + N1_G22(DeltaActiv) ),
                             "N1_IK25", TS_IIF(m_PrintOrderN4, F( N4_() + GL_OA20 ), 0.0),

                             "N1_IE26", 0.0,
                             "N1_IF26", 0.0,
                             "N1_IG26", 0.0,
                             "N1_IH26", 0.0,
                             "N1_II26", F( N1_E23(DeltaActiv) + "+" + N1_H23(DeltaActiv) ),
                             "N1_IJ26", F( N1_F23(DeltaActiv) + "+" + N1_H23(DeltaActiv) + "-" + N1_G23(DeltaActiv) ),
                             "N1_IK26", 0.0,

                             "N1_IJ27", 0.0,
                             "N1_IJ28", 0.0,
                             "N1_IJ29", 0.0,
                             "N1_IJ30", 0.0,

                             "N1_IG31", F( N8_() + N8_A21(0) ),
                             "N1_IJ31", F( "-" + N1_G28(DeltaActiv) ),

                             "N1_IE32", F( FormulaSUM() + "(" + N1_E18(DeltaActiv) + ":" + N1_E28(DeltaActiv) + ")" ),
                             "N1_IF32", F( FormulaSUM() + "(" + N1_F18(DeltaActiv) + ":" + N1_F28(DeltaActiv) + ")" ),
                             "N1_IG32", F( FormulaSUM() + "(" + N1_G18(DeltaActiv) + ":" + N1_G28(DeltaActiv) + ")" ),
                             "N1_IH32", F( FormulaSUM() + "(" + N1_H18(DeltaActiv) + ":" + N1_H28(DeltaActiv) + ")" ),
                             "N1_II32", F( FormulaSUM() + "(" + N1_I18(DeltaActiv) + ":" + N1_I28(DeltaActiv) + ")" ),
                             "N1_IJ32", F( FormulaSUM() + "(" + N1_J18(DeltaActiv) + ":" + N1_J28(DeltaActiv) + ")" ),

                             "N1_IЕ33", F( N1_E28(DeltaActiv+1) + "+" + N1_E37(DeltaActiv+Amount_ДС+1) ) );

          /* Денежные средства */

          RegisterTable( "N1_MainTable_3", "",
                         "A37", "N1_IB38", "C37", "D37", "N1_IE38", "F37", "G37", "H37", "I37", "J37", "K37", "L37" );

          i = 0;
          if( Amount_ДС > 0 )
             var NameAccount = "";
             var AccRec = TRecHandler( "account" );
             var SqlData_ДС = RSDCommand( SqlQuery_ДС );
             SqlData_ДС.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
             SqlData_ДС.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID);
             SqlData_ДС.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
             SqlData_ДС.execute();

             var DataSet_ДС = TRsbDataSet(SqlData_ДС);

             while( DataSet_ДС.MoveNext() )
                if( TS_GetAccount(SQL_ConvTypeInteger(DataSet_ДС.chapter), SQL_ConvTypeInteger(DataSet_ДС.currency), SQL_ConvTypeStr(DataSet_ДС.Account), AccRec) )
                   NameAccount = AccRec.rec.NameAccount;
                end;
                PrintTableLine( "N1_IB38", NameAccount,                      NULL,
                                "N1_IE38", SQL_ConvTypeSum(DataSet_ДС.rest), NULL );
                i = i + 1;
             end;
          end;

          PrintTableLine( "N1_IB38", "Срочный рынок",                  NULL,
                          "N1_IE38", 0.0/*m_OrderFD.ОстатокПоСчету( "+Расчеты, ДУ", m_FormData.ReportDate, /*с КВТ = 72*/ ) + m_OrderFD.ОстатокПоСчету( "+Расчеты, ДУ", m_FormData.ReportDate, /*с КВТ = 40*/ )*/, NULL );
          i = i + 1;

          PrintTableLine( "N1_IB38", "ИТОГО",                          NULL,
                          "N1_IE38", F( FormulaSUM() + "(" + N1_E37(DeltaActiv) + ":" + N1_E37(DeltaActiv+(Amount_ДС-1)+1) + ")" ), NULL );

          EndTable();

          /* Контрольные суммы */

          PrintFormatString( "",
                             "N1_II38", F( N1_I29(DeltaActiv) + "+" + N1_E37(DeltaActiv+(Amount_ДС-1)+2) ),
                             "N1_II39", F( N1_F6(deltaItog-1) + "+" + TS_IIF(AmountStrTotal>0, N1_AD13(deltaItog+AmountStrTotal), "0") + "+" +
                                           TS_IIF(AmountStrTotal>0, N1_AE13(deltaItog+AmountStrTotal), "0") + "+" +
                                           TS_IIF(AmountStrTotal>0, N1_Q13(deltaItog+AmountStrTotal), "0") + "+" + N8_() + N8_A10(0) ),
                             "N1_II40", F( N1_I33(DeltaActiv) + "-" + N1_I34(DeltaActiv) ) );

          /* Стоимость активов */

          var ПоследняяОтчётнаяДата:date = date(0,0,0); /* ??? правильно ли что задесь надо на эту дату? */
          if( MM <= 3 )
             ПоследняяОтчётнаяДата = date(31, 12, YYYY-1);
          elif( (MM > 3) and (MM <= 6) )
             ПоследняяОтчётнаяДата = date(31, 3, YYYY);
          elif( (MM > 6) and (MM <= 9) )
             ПоследняяОтчётнаяДата = date(30, 6, YYYY);
          elif( (MM > 9) and (MM <= 12) )
             ПоследняяОтчётнаяДата = date(30, 9, YYYY);
          end;
          if( IsWorkday(ПоследняяОтчётнаяДата) == 0 )
             ПоследняяОтчётнаяДата = GetDateAfterWorkDays(ПоследняяОтчётнаяДата, -1);
          end;
/*
          var ТСЧА:money = $0.0; 
          if( ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СЧА, NULL, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @ТСЧА) )
             ТСЧА = $0.0;
          end;
*/
          var СЧА_old:money = $0.0, СЧА_new:money = $0.0; 
          if( ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СЧА, NULL, 0, NULL, NULL, NULL, ПоследняяОтчётнаяДата, NULL, NULL, @СЧА_old) )
             СЧА_old = $0.0;
          end;

          var Н_СК_ум:money = $0.0, Н_СК_ув:money = $0.0;
          var Н_СК_ум_beg:money = $0.0, Н_СК_ув_beg:money = $0.0;
          var Н_СК_ум_end:money = $0.0, Н_СК_ув_end:money = $0.0;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, ПоследняяОтчётнаяДата, NULL, @Н_СК_ум_beg, NULL))
             Н_СК_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_СК_ум_end, NULL))
             Н_СК_ум_end = $0.0;
          end;
          Н_СК_ум = Н_СК_ум_end - Н_СК_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, ПоследняяОтчётнаяДата, NULL, @Н_СК_ув_beg, NULL))
             Н_СК_ув_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_СК_ув_end, NULL))
             Н_СК_ув_end = $0.0;
          end;
          Н_СК_ув = Н_СК_ув_end - Н_СК_ув_beg;

          PrintFormatString( "",
                             "N1_IB47", СЧА_old,
                             "N1_IC47", Н_СК_ув - Н_СК_ум,
                             "N1_ID47", F( N1_I29(DeltaActiv) + "+" + N1_E37(DeltaActiv+(Amount_ДС-1)+2))/*ТСЧА*/,
                             "N1_IE47", F( "(" + N1_D41(DeltaActiv+(Amount_ДС-1)+2) + "-" + N1_B41(DeltaActiv+(Amount_ДС-1)+2) + "-" + N1_C41(DeltaActiv+(Amount_ДС-1)+2) + ")/" + N1_B41(DeltaActiv+(Amount_ДС-1)+2) ) );

          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table3", 0, "ИТОГ" );

          /* "Комиссия за управление" */

          RegisterTable( "N1_MainTable_4", "",
                         "A47", "N1_IB54", "N1_IC54", "N1_ID54", "N1_IE54" );

          var SqlData_Н_Купр_ув = RSDCommand( SqlQuery_Итог(1) );
          SqlData_Н_Купр_ув.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Н_Купр_ув.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Купр);
          SqlData_Н_Купр_ув.addParam("", RSDBP_IN, m_BegDate);
          SqlData_Н_Купр_ув.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Н_Купр_ув.execute();
          var DataSet_Н_Купр_ув = TRsbDataSet(SqlData_Н_Купр_ув);

          var SqlData_Н_Купр_ум = RSDCommand( SqlQuery_Итог(-1) );
          SqlData_Н_Купр_ум.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Н_Купр_ум.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Купр);
          SqlData_Н_Купр_ум.addParam("", RSDBP_IN, m_BegDate);
          SqlData_Н_Купр_ум.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Н_Купр_ум.execute();
          var DataSet_Н_Купр_ум = TRsbDataSet(SqlData_Н_Купр_ум);

          var B54, C54, D54, E54;
          i = 0;
          while(i < Amount_Н_Купр )

             if( DataSet_Н_Купр_ув.MoveNext() )
                B54 = SQL_ConvTypeDate(DataSet_Н_Купр_ув.rec.BeginDate);
                C54 = SQL_ConvTypeSum(DataSet_Н_Купр_ув.rec.RestAmount);
             else
                B54 = C54 = "";
             end;

             if( DataSet_Н_Купр_ум.MoveNext() )
                D54 = SQL_ConvTypeDate(DataSet_Н_Купр_ум.rec.BeginDate);
                E54 = SQL_ConvTypeSum(DataSet_Н_Купр_ум.rec.RestAmount);
             else
                D54 = E54 = "";
             end;

             PrintTableLine( "N1_IB54", B54, NULL,
                             "N1_IC54", C54, NULL,
                             "N1_ID54", D54, NULL,
                             "N1_IE54", E54, NULL );
             i = i + 1;
          end;

          B54 = D54 = "Итого:";
          if( i > 0 )
             C54 = F( FormulaSUM() + "(" + N1_C47(DeltaCom) + ":" + N1_C47(DeltaCom + i - 1) + ")" );
             E54 = F( FormulaSUM() + "(" + N1_E47(DeltaCom) + ":" + N1_E47(DeltaCom + i - 1) + ")" );
          else
             C54 = E54 = 0.0;
          end;

          PrintTableLine( "N1_IB54", B54, NULL,
                          "N1_IC54", C54, NULL,
                          "N1_ID54", D54, NULL,
                          "N1_IE54", E54, NULL );
          EndTable();

          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table4", 0, "ИТОГ" );

          /* "Дивиденды" */

          RegisterTable( "N1_MainTable_5", "",
                         "A52", "N1_IB60", "N1_IC60" );

          var SqlData_Д_Двд = RSDCommand( SqlQuery_Итог(1) );
          SqlData_Д_Двд.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Д_Двд.addParam("", RSDBP_IN, ДУ_ИТОГ_Д_Двд);
          SqlData_Д_Двд.addParam("", RSDBP_IN, m_BegDate);
          SqlData_Д_Двд.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Д_Двд.execute();
          var DataSet_Д_Двд = TRsbDataSet(SqlData_Д_Двд);

          while( DataSet_Д_Двд.MoveNext() )
             PrintTableLine( "N1_IB60", SQL_ConvTypeDate(DataSet_Д_Двд.rec.BeginDate), NULL,
                             "N1_IC60", SQL_ConvTypeSum(DataSet_Д_Двд.rec.RestAmount), NULL );
          end;

          PrintTableLine( "N1_IB60", "Итого:", NULL,
                          "N1_IC60", TS_IIF(Amount_Д_Двд > 0, F( FormulaSUM() + "(" + N1_C52(DeltaDvd) + ":" + N1_C52(DeltaDvd + Amount_Д_Двд - 1) + ")" ), 0.0), NULL );

          EndTable();
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table5", 0, "ИТОГ" );

          /* Внешние комиссии */

          var DeltaVn = DeltaDvd + Amount_Д_Двд - 1;
          RegisterTable( "N1_MainTable_6", "",
                         "A57", "N1_IB66", "N1_IC66" );

          var SqlData_Р_Квн = RSDCommand( SqlQuery_Итог(-1) );
          SqlData_Р_Квн.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Р_Квн.addParam("", RSDBP_IN, ДУ_ИТОГ_Р_Квн);
          SqlData_Р_Квн.addParam("", RSDBP_IN, m_BegDate);
          SqlData_Р_Квн.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Р_Квн.execute();
          var DataSet_Р_Квн = TRsbDataSet(SqlData_Р_Квн);

          i = 0;
          while( DataSet_Р_Квн.MoveNext() )
             PrintTableLine( "N1_IB66", SQL_ConvTypeDate(DataSet_Р_Квн.rec.BeginDate), NULL,
                             "N1_IC66", SQL_ConvTypeSum(DataSet_Р_Квн.rec.RestAmount), NULL );
             i = i + 1;
          end;

          PrintTableLine( "N1_IB66", "Итого:", NULL,
                          "N1_IC66", TS_IIF(i > 0, F( FormulaSUM() + "(" + N1_C57(DeltaVn) + ":" + N1_C57(DeltaVn+i-1) + ")" ), 0.0), NULL );

          EndTable();
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table6", 0, "ИТОГ" );

          /* печатаем вкладку Пром_рез */

          if( m_SheetN8 == false )
             UseNewSheetInTotalBook();
             m_SheetN8 = true;
          end;
          SetActiveSheet( "Пром_рез" );

          var Квн_add_68:MONEY = $0.0;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0, NULL, NULL, NULL, m_FormData.ReportDate, @Квн_add_68, NULL, NULL))
             Квн_add_68 = $0.0;
          end;

          var Квн_add_65:MONEY = $0.0;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("65"), 0, NULL, NULL, NULL, m_FormData.ReportDate, @Квн_add_65, NULL, NULL))
             Квн_add_65 = $0.0;
          end;
                                                                       
          var DC:money = $0.0;
          var Query = RSDCommand( " SELECT distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                                  "   FROM dmcaccdoc_dbt accdoc, daccount_dbt acc, dmccateg_dbt categ, dmctempl_dbt templ " +
                                  "  WHERE accdoc.t_ClientContrID = ?                 " + 
                                  "    AND acc.t_Account          = accdoc.t_Account  " +
                                  "    AND acc.t_Code_Currency    = accdoc.t_Currency " +
                                  "    AND acc.t_Chapter          = accdoc.t_Chapter  " +
                                  "    AND acc.t_Balance          = '80801'           " +
                                  "    AND categ.t_ID             = accdoc.t_CatID    " +
                                  "    AND categ.t_leveltype      = 1                 " +
                                  "    AND categ.t_code           = 'ДС ДУ'           " +
                                  "    AND templ.t_catid = accdoc.t_catid                                 " +
                                  "    AND templ.t_number = accdoc.t_templnum                             " +
                                  "    AND (CASE                                                          " +
                                  "            WHEN (categ.t_param1 = 2818 AND categ.t_class1 = 1702)     " +
                                  "               THEN templ.t_value1                                     " +
                                  "            WHEN (categ.t_param2 = 2818 AND categ.t_class2 = 1702)     " +
                                  "               THEN templ.t_value2                                     " +
                                  "            WHEN (categ.t_param3 = 2818 AND categ.t_class3 = 1702)     " +
                                  "               THEN templ.t_value3                                     " +
                                  "            WHEN (categ.t_param4 = 2818 AND categ.t_class4 = 1702)     " +
                                  "               THEN templ.t_value4                                     " +
                                  "            WHEN (categ.t_param5 = 2818 AND categ.t_class5 = 1702)     " +
                                  "               THEN templ.t_value5                                     " +
                                  "            WHEN (categ.t_param6 = 2818 AND categ.t_class6 = 1702)     " +
                                  "               THEN templ.t_value6                                     " +
                                  "            WHEN (categ.t_param7 = 2818 AND categ.t_class7 = 1702)     " +
                                  "               THEN templ.t_value7                                     " +
                                  "            WHEN (categ.t_param8 = 2818 AND categ.t_class8 = 1702)     " +
                                  "               THEN templ.t_value8                                     " +
                                  "         END                                                           " +
                                  "        ) = 40                                                         " + /* = 10 "Расчетный" - отчет 1ОБ */
/*                                  "    AND (CASE                                                          " +
                                  "            WHEN (categ.t_param1 = 5008 AND categ.t_class1 = 5008)     " +
                                  "               THEN templ.t_value1                                     " +
                                  "            WHEN (categ.t_param2 = 5008 AND categ.t_class2 = 5008)     " +
                                  "               THEN templ.t_value2                                     " +
                                  "            WHEN (categ.t_param3 = 5008 AND categ.t_class3 = 5008)     " +
                                  "               THEN templ.t_value3                                     " +
                                  "            WHEN (categ.t_param4 = 5008 AND categ.t_class4 = 5008)     " +
                                  "               THEN templ.t_value4                                     " +
                                  "            WHEN (categ.t_param5 = 5008 AND categ.t_class5 = 5008)     " +
                                  "               THEN templ.t_value5                                     " +
                                  "            WHEN (categ.t_param6 = 5008 AND categ.t_class6 = 5008)     " +
                                  "               THEN templ.t_value6                                     " +
                                  "            WHEN (categ.t_param7 = 5008 AND categ.t_class7 = 5008)     " +
                                  "               THEN templ.t_value7                                     " +
                                  "            WHEN (categ.t_param8 = 5008 AND categ.t_class8 = 5008)     " +
                                  "               THEN templ.t_value8                                     " +
                                  "         END                                                           " +
                                  "        ) = 0                                                          " + Q = 0 "основной" - отчет 1ОБ */
                                  "    AND NVL((select partcode.t_Code from dpartcode_dbt partcode        " +
                                  "              where partcode.t_PartyID = accdoc.t_Place                " +
                                  "                and partcode.t_CodeKind = 1),'') = 'РП ММВБ'           " );

          Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
          Query.execute();
          var DataS = TRsbDataSet(Query);

          while( DataS.MoveNext() )
             var CurDate = m_BegDate;
             while( CurDate < m_FormData.ReportDate )
                DC = DC + TS_GetRestAccount(DataS.Account, DataS.Currency, DataS.Chapter, CurDate);
                CurDate = CurDate + 1;
             end;
          end;

          var B = ДУ_ДнейВГоду(YYYY);

          PrintFormatString( "", "N8_D1",  F( N1_() + N1_A2(0) ),
                                 "N8_F1",  F( N1_() + N1_F1(0) ),
                                 "N8_A5",  Квн_add_68,
                                 "N8_A7",  abs(DC),
                                 "N8_A9",  B,
                                 "N8_A10", ИтогПоВсемДП(m_OrderFD.Order().rec.ID, m_FormData.ReportDate-1, ДУ_ИТОГ_Н_Кусп) +
                                           ИтогПоВсемДП(m_OrderFD.Order().rec.ID, m_FormData.ReportDate-1, ДУ_ИТОГ_Н_Дх) +
                                           ИтогПоВсемДП(m_OrderFD.Order().rec.ID, m_FormData.ReportDate-1, ДУ_ИТОГ_Н_Налог),
                                 "N8_A11", 0.01,
                                 "N8_A19", RateComS/100.0,
                                 "N8_A20", 0,
                                 "N8_A21", Квн_add_65 );

          CopyAllSheetInTotalBook( "Пром_рез", false, "N8_All", 0, "Пром_рез" );

          if( m_SheetN1 )
             m_DeltaOrderN1 = GetLastPosition("ИТОГ") - 1;
          end;
          if( m_SheetN2 )
             m_DeltaOrderN2 = GetLastPosition("Акции") - 1;
          end;
          if( m_SheetN3 )
             m_DeltaOrderN3 = GetLastPosition("Акции Закрытые") - 1;
          end;
          if( m_SheetN4 )
             m_DeltaOrderN4 = GetLastPosition("Облигации") - 1;
          end;
          if( m_SheetN5 )
             m_DeltaOrderN5 = GetLastPosition("Облигации Закрытые") - 1;
          end;
          if( m_SheetN6 )
             m_DeltaOrderN6 = GetLastPosition("Векселя") - 1;
          end;
          if( m_SheetN7 )
             m_DeltaOrderN7 = GetLastPosition("Векселя Закрытые") - 1;
          end;
          if( m_SheetN8 )
             m_DeltaOrderN8 = GetLastPosition("Пром_рез") - 1;
          end;

       end;
    end;

    OrderEnd();

  END;

  PRIVATE MACRO Create()

     CountOrder();
     if( m_CountOrder > 0 )
        m_DeltaOrderN1 = 0; m_DeltaOrderN2 = 0; m_DeltaOrderN3 = 0; m_DeltaOrderN4 = 0; m_DeltaOrderN5 = 0; m_DeltaOrderN6 = 0; m_DeltaOrderN7 = 0; m_DeltaOrderN8 = 0;
        m_PrintOrderN2 = false; m_PrintOrderN3 = false; m_PrintOrderN4 = false; m_PrintOrderN5 = false; m_PrintOrderN6 = false; m_PrintOrderN7 = false;
        m_SheetN1 = false; m_SheetN2 = false; m_SheetN3 = false; m_SheetN4 = false; m_SheetN5 = false; m_SheetN6 = false; m_SheetN7 = false; m_SheetN8 = false;
        Печать_Отчёт();
     end;
  
     if( (m_CountOrder <= 0) OR (m_ReportWasRun == false) )
        SetActiveSheet( "No data" );
        PrintFormatString( "", "N9_NoData", "Нет договоров, удовлетворяющих параметрам отчета." );
        CopyAllSheetInTotalBook( null, false, "N9_NoData", 1 );
     end;

  END;

  initTS_CardAnAcc_Report_General( "Report_TSCardAnAcc_DOFBU.xls" );
END;
