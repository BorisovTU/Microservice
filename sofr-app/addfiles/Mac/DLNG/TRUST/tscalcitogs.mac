import TSInter, "tsutil.mac", "tscateg.mac", "DlForms_h.mac", "tscomiss.mac", "TSCheckLimit.mac";

/*Номера полей в форме */
PRIVATE CONST PNFLD_A1      = 0,  /*Учредитель*/
              PNFLD_A2_1    = 1,  /*Договор №*/
              PNFLD_A2_2    = 2,  /*от*/
              PNFLD_A3      = 3,  /*ОФБУ*/
              PNFLD_A4      = 4,  /*Дата расчета*/
              PNFLD_A5      = 5,  /*Дата окончания расчетного периода*/
              PNFLD_A6      = 6,  /*Имущество в управлении (руб)*/
              PNFLD_A6_1    = 7,  /*Выводятся: денежные средства*/
              PNFLD_A6_2    = 8,
              PNFLD_A7      = 9,  /*Выводятся: акции*/
              PNFLD_A7_1    = 10, /*стоимость*/
              PNFLD_A7_2    = 11,
              PNFLD_A8      = 12, /*Выводятся: облигации*/
              PNFLD_A8_1    = 13, /*стоимость*/
              PNFLD_A8_2    = 14,
              PNFLD_A9      = 15, /*Выводятся: векселя*/
              PNFLD_A9_1    = 16, /*стоимость*/
              PNFLD_A9_2    = 17,
              PNFLD_A12_1   = 18, /*Общая стоимость выводимого имущества*/
              PNFLD_A12_2   = 19,
              PNFLD_A30_1   = 20, /* Комиссия за досрочный вывод (руб)*/
              PNFLD_A30_2   = 21,
              PNFLD_A31_1   = 22, /*Комиссия за управление (руб)*/
              PNFLD_A31_2   = 23,
              PNFLD_A32_1   = 24, /*Комиссия за успешное управление (руб)*/
              PNFLD_A32_2   = 25,
              PNFLD_A34_1   = 26, /*Прибыль(руб): в бухучете*/
              PNFLD_A34_3   = 27, /*Прибыль(руб): базовая*/
              PNFLD_A34_2   = 28, /*Прибыль(руб): в налоговом учете*/
              PNFLD_A34_4   = 29, /*выплачиваемая*/
              PNFLD_A34_5   = 30,
              PNFLD_A34_6   = 31, /*капитализируемая*/
              PNFLD_A34_7   = 32,
              PNFLD_A35_1   = 33, /*Сумма налога (руб)*/
              PNFLD_A35_2   = 34,
              PNFLD_A36_1   = 35, /*Списываемый капитал (руб)*/
              PNFLD_A36_2   = 36,
              PNFLD_A40_1   = 37, /*Сумма к выплате*/
              PNFLD_A40_2   = 38,
              PNFLD_A41     = 39, /*Имущество, остающееся в управлении*/
              PNFLD_C0      = 40, /*отключить перерасчет*/
              PNFLD_A70     = 41, /*Филиал  */
              PNFLD_A71     = 42, /*Исполнитель*/
              PNFLD_A71_1   = 43;

PRIVATE VAR MngPlan = TRecHandler( "tsmngpln.dbt" );

CLASS (DL_CPanel) CItogs_Panel( _Itogs:TArray, _Order:TRecHandler, _Req:TRecHandler, _IsProlongation:BOOL, _ReadOnly:BOOL, _EndCalcDate:DATE,
                                _ID_Operation:INTEGER, _ID_Step:INTEGER, _CalcCom:DataCalcCom )
  PRIVATE CONST MODE_ALL = 0, 
                MODE_A   = 1, 
                MODE_B   = 2;

  VAR Пвыв = $0, ПДне_отн = $0, ДДне_отн = $0;
  VAR OrderFD:TS_OrderFD = NULL,
      UseNDFL,
      EndCalcDateComiss,
      ID_Operation   = _ID_Operation, 
      ID_Step        = _ID_Step,
      Itogs          = _Itogs,
      EndCalcDate    = _EndCalcDate,
      ReadOnly       = _ReadOnly,
      ReqFD:TS_RequestFD = NULL, 
      IsProlongation = _IsProlongation,
      CalcCom        = _CalcCom;
  VAR Изменили_Кдв:bool = false, Изменили_Купр:bool = false, Изменили_Кусп:bool = false,
      Изменили_Нкуд:bool = false, Изменили_Пвыв_к:bool = false, Изменили_Пвыв_в:bool = false, Изменили_Sкап:bool = false;

  PRIVATE MACRO SaveItogsInBD( Itog:INTEGER ):BOOL
     VAR ServOpKind = 0, ServOpID = 0;

     if( ReqFD )
        ServOpKind = ReqFD.Kind;   
        ServOpID   = ReqFD.ID;   
     end;

     if( OrderFD.SaveItog( Itog, Itogs[Itog], NATCUR, EndCalcDate, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOpKind, ServOpID ) != 0 )
         return false;
     end;
     return true;
  END;

  PRIVATE MACRO SaveAllItogsInBD():BOOL

     if( ReadOnly == false )
        if( UseNDFL )
           if( NPTSaveTaxSum( OrderFD.Order.rec.ID, ID_Operation, ID_Step ) != 0 )
              MsgBox( "Ошибка при занесении объектов НДР в постоянную базу" );
              return false;
           end;
        END;

        if( (not SaveItogsInBD(ДУ_Sкап)   ) OR
            (not SaveItogsInBD(ДУ_Sкап_ф) ) OR 
            (not SaveItogsInBD(ДУ_Кдв)    ) OR    
            (not SaveItogsInBD(ДУ_Кдв_ф)  ) OR  
            (not SaveItogsInBD(ДУ_Купр)   ) OR   
            (not SaveItogsInBD(ДУ_Купр_ф) ) OR 
            (not SaveItogsInBD(ДУ_Кусп)   ) OR   
            (not SaveItogsInBD(ДУ_Кусп_ф) ) OR 
            (not SaveItogsInBD(ДУ_Пбух)   ) OR   
            (not SaveItogsInBD(ДУ_Пнал)   ) OR   
            (not SaveItogsInBD(ДУ_БП)     ) OR     
            (not SaveItogsInBD(ДУ_Пвыв_в) ) OR 
            (not SaveItogsInBD(ДУ_Пвыв_в_ф)) OR
            (not SaveItogsInBD(ДУ_Пвыв_к) ) OR 
            (not SaveItogsInBD(ДУ_Пвыв_к_ф)) OR
            (not SaveItogsInBD(ДУ_Нкуд)   ) OR   
            (not SaveItogsInBD(ДУ_Нкуд_ф) ) OR 
            (not SaveItogsInBD(ДУ_Sвыпл)  ) OR  
            (not SaveItogsInBD(ДУ_СКост)  ) OR
            (not SaveItogsInBD(ДУ_Кцб_а)  ) OR
            (not SaveItogsInBD(ДУ_Сцб_а)  ) OR
            (not SaveItogsInBD(ДУ_Кцб_о)  ) OR
            (not SaveItogsInBD(ДУ_Сцб_о)  ) OR
            (not SaveItogsInBD(ДУ_Кцб_в)  ) OR
            (not SaveItogsInBD(ДУ_Сцб_в)  ) OR
            (not SaveItogsInBD(ДУ_Sзаявл) ) OR
            (not SaveItogsInBD(ДУ_Сцб)    ) OR
            (not SaveItogsInBD(ДУ_ПУ)     )
          )
           return false;
        end;

     end;
     return true;
  END;

  PRIVATE MACRO SaveItogsToPanel()

     Изменили_Кдв    = false;
     Изменили_Купр   = false;
     Изменили_Кусп   = false;
     Изменили_Нкуд   = false;
     Изменили_Пвыв_к = false;
     Изменили_Пвыв_в = false;
     Изменили_Sкап   = false;

     m_Panel.rec.A30_1   = Itogs[ДУ_Кдв]; /* Комиссия за досрочный вывод (руб)*/
     m_Panel.rec.A30_2   = Itogs[ДУ_Кдв_ф];
     m_Panel.rec.A31_1   = Itogs[ДУ_Купр]; /*Комиссия за управление (руб)*/
     m_Panel.rec.A31_2   = Itogs[ДУ_Купр_ф];
     m_Panel.rec.A32_1   = Itogs[ДУ_Кусп]; /*Комиссия за успешное управление (руб)*/
     m_Panel.rec.A32_2   = Itogs[ДУ_Кусп_ф];
     m_Panel.rec.A34_1   = Itogs[ДУ_Пбух]; /*Прибыль(руб): в бухучете*/
     m_Panel.rec.A34_2   = Itogs[ДУ_Пнал]; /*Прибыль(руб): в налоговом учете*/
     m_Panel.rec.A34_3   = Itogs[ДУ_БП]; /*Прибыль(руб): базовая*/
     m_Panel.rec.A34_4   = Itogs[ДУ_Пвыв_в]; /*выплачиваемая*/
     m_Panel.rec.A34_5   = Itogs[ДУ_Пвыв_в_ф];
     m_Panel.rec.A34_6   = Itogs[ДУ_Пвыв_к]; /*капитализируемая*/
     m_Panel.rec.A34_7   = Itogs[ДУ_Пвыв_к_ф];
     m_Panel.rec.A35_1   = Itogs[ДУ_Нкуд]; /*Сумма налога (руб)*/
     m_Panel.rec.A35_2   = Itogs[ДУ_Нкуд_ф];
     m_Panel.rec.A36_1   = Itogs[ДУ_Sкап]; /*Списываемый капитал (руб)*/
     m_Panel.rec.A36_2   = Itogs[ДУ_Sкап_ф];
     m_Panel.rec.A40_1   = Itogs[ДУ_Sвыпл]; /*Сумма к выплате*/
     m_Panel.rec.A41     = Itogs[ДУ_СКост]; /*Имущество, остающееся в управлении*/
     m_Panel.rec.A7      = Itogs[ДУ_Кцб_а]; /*акции кол-во*/
     m_Panel.rec.A7_1    = Itogs[ДУ_Сцб_а]; /*акции стоимость*/
     m_Panel.rec.A8      = Itogs[ДУ_Кцб_о]; /*облигации кол-во*/   
     m_Panel.rec.A8_1    = Itogs[ДУ_Сцб_о]; /*облигации стоимость*/
     m_Panel.rec.A9      = Itogs[ДУ_Кцб_в]; /*векселя кол-во*/   
     m_Panel.rec.A9_1    = Itogs[ДУ_Сцб_в]; /*векселя стоимость*/
     m_Panel.rec.A6      = Itogs[ДУ_ИТОГ_СК];

     if( ReqFD )
        if( (ReqFD.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY) AND (not ReqFD.IsOutFULL() ) ) 
           m_Panel.rec.A6_1  =  Itogs[ДУ_Sзаявл]; /* Если частичный вывод ДС*/
        else
           m_Panel.rec.A6_1  =  Itogs[ДУ_Пвыв_в_ф] + Itogs[ДУ_Sкап_ф] - Itogs[ДУ_Сцб];
        end;
        m_Panel.rec.A12_1 = m_Panel.rec.A6_1 + m_Panel.rec.A7_1 + m_Panel.rec.A8_1 + m_Panel.rec.A9_1; /*Общая стоимость выводимого имущества*/
     end;
  END;

  PRIVATE MACRO SaveItogsFromPanel( Mode:INTEGER ):INTEGER

     if( Itogs[ДУ_Кдв_ф] != m_Panel.rec.A30_2 )
       Изменили_Кдв = true;
     end;

     if( Itogs[ДУ_Купр_ф] != m_Panel.rec.A31_2 )
       Изменили_Купр = true;
     end;

     if( Itogs[ДУ_Кусп_ф] != m_Panel.rec.A32_2 )
       Изменили_Кусп = true;
     end;

     if( Itogs[ДУ_Нкуд_ф] != m_Panel.rec.A35_2 )
       Изменили_Нкуд = true;
     end;

     if( Itogs[ДУ_Пвыв_к_ф] != m_Panel.rec.A34_7 )
       Изменили_Пвыв_к = true;
     end;

     if( Itogs[ДУ_Пвыв_в_ф] != m_Panel.rec.A34_5 )
       Изменили_Пвыв_в = true;
     end;

     if( Itogs[ДУ_Sкап_ф] != m_Panel.rec.A36_2 )
       Изменили_Sкап = true;
     end;

     if( (Mode == MODE_A) AND (not Изменили_Кдв) AND (not Изменили_Купр) AND (not Изменили_Кусп) )
        MsgBox( "Фактические суммы комиссий не менялись. Перерасчет не будет выполнен." );
        return 1;
     end;

     if( (Mode == MODE_B) AND (not Изменили_Нкуд) AND (not Изменили_Пвыв_к) AND (not Изменили_Пвыв_в) AND (not Изменили_Sкап) )
        MsgBox( "Фактические суммы не менялись. Перерасчет не будет выполнен." );
        return 1;
     end;

     Itogs[ДУ_Кдв_ф]    = m_Panel.rec.A30_2;
     Itogs[ДУ_Купр_ф]   = m_Panel.rec.A31_2;
     Itogs[ДУ_Кусп_ф]   = m_Panel.rec.A32_2;
     Itogs[ДУ_Пвыв_в_ф] = m_Panel.rec.A34_5;
     Itogs[ДУ_Пвыв_к_ф] = m_Panel.rec.A34_7;
     Itogs[ДУ_Нкуд_ф]   = m_Panel.rec.A35_2;
     Itogs[ДУ_Sкап_ф]   = m_Panel.rec.A36_2;
     Itogs[ДУ_Sвыпл]    = m_Panel.rec.A40_1;

     return 0;
  END;

  PRIVATE MACRO ПервоеЧислоГода(EndCalcDate)
     VAR Year;
     DateSplit(EndCalcDate, null, null, Year);
     return date(1, 1, Year);
  END;

  PRIVATE MACRO Скорректированный_Пнал(OrderID:integer, EndCalcDate:date, Пнал, Нкуд)
    var Н_Дх1=0, Н_Дх2=0,
        Н_Налог1=0, Н_Налог2=0;
    if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, ПервоеЧислоГода(EndCalcDate), NULL, @Н_Дх1, NULL ) )
       MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
       return 0.0;
    end;
    if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, @Н_Дх2, NULL ) )
       MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
       return 0.0;
    end;
    if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, ПервоеЧислоГода(EndCalcDate), @Н_Налог1, NULL, NULL ) )
       MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
       return 0.0;
    end;
    if( ПолучитьИтогДУ( OrderID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, EndCalcDate, @Н_Налог2, NULL, NULL ) )
       MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
       return 0.0;
    end;

    return (Пнал - ((Н_Дх2 - Н_Дх1) + (Н_Налог2 - Н_Налог1)));
  END;

  PRIVATE MACRO ПрибыльУчредителя():INTEGER
    var Н_Дх_:money = $0.0, Н_Налог_:money = $0.0;

    if( ПолучитьИтогДУЗаПериод( OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, НачалоТекущегоПДД(OrderFD.ID, EndCalcDateComiss), EndCalcDateComiss, @Н_Дх_, NULL, NULL ) )
       MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
       return 1;
    end;
    if( ПолучитьИтогДУЗаПериод( OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, НачалоТекущегоПДД(OrderFD.ID, EndCalcDateComiss), EndCalcDateComiss, @Н_Налог_, NULL, NULL ) )
       MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
       return 1;
    end;

    Itogs[ДУ_ПУ] = OrderFD.СуммаПрибылиУчредителя( EndCalcDateComiss ) + Н_Дх_ + Н_Налог_;

    return 0;
  END;

  PRIVATE MACRO РасчетПриПролонгации( Mode:INTEGER ):INTEGER
     VAR Н_Кусп_add1 = 0, Н_Кусп_add2 = 0;

     if( Mode == MODE_ALL )
        CalcCom.CalcDateM = EndCalcDateComiss;
        if( РасчетКомиссииБанкаЗаУправление( OrderFD, NULL, EndCalcDateComiss, ПролонгацияДоговора, @CalcCom.ConCom_M, @CalcCom.sfdefcom_parm_M ) != 0 )
           MsgBox( "Ошибка при расчете комиссии за управление." );
           return 1;
        end;
        Itogs[ДУ_Купр_ф] = CalcCom.sfdefcom_parm_M.rec.CommSum;

        Itogs[ДУ_Пбух] = OrderFD.СуммаБухгалтерскойПрибыли( EndCalcDate ) - Itogs[ДУ_Купр_ф];
        /* Прибыль учредителя ПУ */
        if( ПрибыльУчредителя() )
           return 1;
        end;
        /* Прибыль базовая БП*/
        Itogs[ДУ_БП] = OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss );
        /* Дополнительная прибыль ДП = ПУ - Купр - БП */
        Itogs[ДУ_ДП] = Itogs[ДУ_ПУ] - Itogs[ДУ_Купр_ф] - Itogs[ДУ_БП];

        CalcCom.CalcDateS = EndCalcDateComiss;
        if( РасчетКомиссииБанкаЗаУспех( OrderFD, NULL, EndCalcDateComiss, TS_ComissSum( Itogs[ДУ_ДП], NATCUR ), ПролонгацияДоговора, @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
           MsgBox( "Ошибка при расчете комиссии за успех." );
           return 1;
        end;
        Itogs[ДУ_Кусп_ф] = CalcCom.sfdefcom_parm_S.rec.CommSum;

        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, НачалоТекущегоПДД(OrderFD.ID, EndCalcDateComiss), @Н_Кусп_add1 ) )
           MsgBox( "Ошибка при получении итога \"Н_Кусп\"по договору" );
           return 1;
        end;
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, EndCalcDateComiss, @Н_Кусп_add2 ) )
           MsgBox( "Ошибка при получении итога \"Н_Кусп\"по договору" );
           return 1;
        end;
        Itogs[ДУ_Кусп_ф] = Itogs[ДУ_Кусп_ф] - (Н_Кусп_add2 - Н_Кусп_add1);
        Itogs[ДУ_Пбух]   = Itogs[ДУ_Пбух] - Itogs[ДУ_Кусп_ф];

     elif( Mode == MODE_A )
        Itogs[ДУ_Пбух] = OrderFD.СуммаБухгалтерскойПрибыли( EndCalcDate ) - Itogs[ДУ_Купр_ф] - Itogs[ДУ_Кусп_ф];
     end;

     if( Mode != MODE_B )
        if( ЭтоНачисление(MngPlan.rec.Flag1) OR ЭтоКапитализация(MngPlan.rec.Flag1) )
           if( not UseNDFL )
              Пвыв = max(0, Itogs[ДУ_Пбух]);
           else
              if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], 0, @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                 return 1;
              end;
              Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
           end;

           if( ЭтоКапитализация(MngPlan.rec.Flag1) )
              Itogs[ДУ_Пвыв_к_ф] = Пвыв;
              Itogs[ДУ_Пвыв_в_ф] = 0;
           end;

           if( ЭтоНачисление(MngPlan.rec.Flag1) )
              Itogs[ДУ_Пвыв_в_ф] = Пвыв;
              Itogs[ДУ_Пвыв_к_ф] = 0;
           end;
        end; /*if( Mode != MODE_B )*/
     end;

     if( Mode != MODE_A )
        if( ЭтоКапитализация(MngPlan.rec.Flag1) )
           Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] + Itogs[ДУ_Пвыв_к_ф];
        end;
     end;

     return 0;
  END;

  PRIVATE MACRO РасчетПриВыводеКапитала( Mode:INTEGER ):INTEGER
     VAR recAsset, Н_Купр, Н_Кусп, Н_Кдв, Н_Налог, Н_Дх;

     if( Mode == MODE_ALL )
        ReqFD.ПолучитьСуммыВывода( EndCalcDate, @Itogs[ДУ_Sзаявл], @Itogs[ДУ_Сцб],
                                   @Itogs[ДУ_Кцб_а], @Itogs[ДУ_Сцб_а],  /*акции*/
                                   @Itogs[ДУ_Кцб_о], @Itogs[ДУ_Сцб_о],  /*облигации*/
                                   @Itogs[ДУ_Кцб_в], @Itogs[ДУ_Сцб_в],
                                   @ПДне_отн, @ДДне_отн
                                 );/*векселя*/
     end;

     if( ReqFD.Request.rec.Type == TS_KINDDECLAR_PARTLY )
        /*при выводе денежных средств:*/
        if( ReqFD.Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY )
           recAsset = ReqFD.MoveFirstAsset();
           if( Mode != MODE_B )
              if( (not Изменили_Купр) OR (Mode == MODE_ALL) )
                 CalcCom.CalcDateM = EndCalcDateComiss;
                 if( РасчетКомиссииБанкаЗаУправление( OrderFD, ReqFD.Request.rec.ID, EndCalcDateComiss, ДосрочныйВывод, @CalcCom.ConCom_M, @CalcCom.sfdefcom_parm_M ) != 0 )
                    MsgBox( "Ошибка при расчете комиссии за управление." );
                    return 1;
                 end;
                 Itogs[ДУ_Купр_ф] = CalcCom.sfdefcom_parm_M.rec.CommSum;
              end;

              /* Прибыль в бухучете П/бух */
              Itogs[ДУ_Пбух] = OrderFD.СуммаБухгалтерскойПрибыли( EndCalcDate ) - Itogs[ДУ_Купр_ф];

              if( Mode == MODE_ALL )
                 /* Прибыль учредителя ПУ */
                 if( ПрибыльУчредителя() )
                    return 1;
                 end;
                 /* Прибыль базовая БП*/
                 Itogs[ДУ_БП] = OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss );
              end;

              if( ((not Изменили_Кусп) and Изменили_Купр) OR (Mode == MODE_ALL) )
                 /* Дополнительная прибыль ДП = ПУ - Купр - БП */
                 Itogs[ДУ_ДП] = Itogs[ДУ_ПУ] - Itogs[ДУ_Купр_ф] - Itogs[ДУ_БП];

                 /* Комиссия за успешное управление */
                 CalcCom.CalcDateS = EndCalcDateComiss;
                 if( РасчетКомиссииБанкаЗаУспех( OrderFD, ReqFD.Request.rec.ID, EndCalcDateComiss, TS_ComissSum( Itogs[ДУ_ДП], NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
                    MsgBox( "Ошибка при расчете комиссии за успех." );
                    return 1;
                 end;
                 Itogs[ДУ_Кусп_ф] = CalcCom.sfdefcom_parm_S.rec.CommSum;
              end;

              Itogs[ДУ_Пбух] = Itogs[ДУ_Пбух] - Itogs[ДУ_Кусп_ф];
           end;

           if( ЭтоВыплата(MngPlan.rec.Flag2) OR ЭтоКапитализация(MngPlan.rec.Flag2) )
              if( Mode != MODE_B )
                 /* определяется сумма прибыли, доступной для вывода Пвыв */
                 if( not UseNDFL )
                    if( ЭтоВыплата(MngPlan.rec.Flag2) )
                       if( recAsset.rec.ExactAmount == "X" )
                          Пвыв = min( max(0, Itogs[ДУ_Пбух]), Itogs[ДУ_Sзаявл] );
                       else
                          Пвыв = max(0, Itogs[ДУ_Пбух]);
                       end;
                    elif(ЭтоКапитализация(MngPlan.rec.Flag2))
                       Пвыв = max(0, Itogs[ДУ_Пбух]);
                    end;
                 else
                    if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], 0, @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                       return 1;
                    end;
                    Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                    if( ЭтоВыплата(MngPlan.rec.Flag2) )
                       if( recAsset.rec.ExactAmount == "X" )
                          Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), min(max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])), Itogs[ДУ_Sзаявл]) );
                       else
                          Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
                       end;
                    elif(ЭтоКапитализация(MngPlan.rec.Flag2))
                       Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
                    end;
                 end;

                 /* рассчитывается сумма, списываемая со счета "Капитал ДУ" */
                 if( recAsset.rec.ExactAmount == "X" )
                    Itogs[ДУ_Sкап_ф] = TS_IIF( ((Itogs[ДУ_Sзаявл] - Пвыв) > 0), Itogs[ДУ_Sзаявл] - Пвыв, 0 );
                 else
                    if( Mode != MODE_A ) /* тут я не уверен, но так по ТЗ */
                       Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Sзаявл];
                    end;
                 end;

                 /* начало учёта комиссии за досрочный вывод */
                 if( (not Изменили_Кдв) OR (Mode == MODE_ALL) )
                    CalcCom.CalcDateP = EndCalcDate;
                    if( РасчетКомиссииЗаДосрочныйВывод( OrderFD, ReqFD.Request.rec.ID, EndCalcDate, TS_ComissSum( TS_IIF( Itogs[ДУ_Пбух] > 0, Itogs[ДУ_Sкап_ф], Itogs[ДУ_Sкап_ф]+Itogs[ДУ_Пбух] ), NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_P, @CalcCom.sfdefcom_parm_P ) != 0 )
                       MsgBox( "Ошибка при расчете комиссии за досрочный вывод." );
                       return 1;
                    end;
                    Itogs[ДУ_Кдв_ф] = CalcCom.sfdefcom_parm_P.rec.CommSum;
                 end;

                 if( Itogs[ДУ_Кдв_ф] > 0 )
                    Itogs[ДУ_Пбух]  = Itogs[ДУ_Пбух] - Itogs[ДУ_Кдв_ф];
                 end;

                 if( UseNDFL )
                    if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], Itogs[ДУ_Кдв_ф], @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                       return 1;
                    end;
                    Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                    if( ЭтоВыплата(MngPlan.rec.Flag2) )
                       if(recAsset.rec.ExactAmount == "X")
                          Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), min(max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])), Itogs[ДУ_Sзаявл]) );
                       else
                          Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
                       end;
                    elif(ЭтоКапитализация(MngPlan.rec.Flag2))
                       Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
                    end;
                 else
                    if( ЭтоВыплата(MngPlan.rec.Flag2) )
                       if(recAsset.rec.ExactAmount == "X")
                          Пвыв = min( max(0, Itogs[ДУ_Пбух]), Itogs[ДУ_Sзаявл] );
                       else
                          Пвыв = max(0, Itogs[ДУ_Пбух]);
                       end;
                    elif(ЭтоКапитализация(MngPlan.rec.Flag2))
                       Пвыв = max(0, Itogs[ДУ_Пбух]);
                    end;
                 end;
                 /* конец учёта комиссии за досрочный вывод */

                  if( ЭтоКапитализация(MngPlan.rec.Flag2) )
                     Itogs[ДУ_Sвыпл] = Itogs[ДУ_Sзаявл];
                     if(Itogs[ДУ_Sвыпл] > Пвыв)
                        Itogs[ДУ_Sкап_ф]   = Itogs[ДУ_Sвыпл];
                        Itogs[ДУ_Пвыв_к_ф] = Пвыв;
                        Itogs[ДУ_Пвыв_в_ф] = 0;
                     else
                        Itogs[ДУ_Sкап_ф] = 0;
                        Itogs[ДУ_Пвыв_в_ф] = Itogs[ДУ_Sвыпл];
                        Itogs[ДУ_Пвыв_к_ф] = Пвыв - Itogs[ДУ_Пвыв_в_ф];
                     end;
                  end;

                  if( ЭтоВыплата(MngPlan.rec.Flag2) )
                     if( recAsset.rec.ExactAmount == "X" )
                        Itogs[ДУ_Sвыпл]    = Itogs[ДУ_Sзаявл];
                        Itogs[ДУ_Пвыв_к_ф] = 0;
                        if(Itogs[ДУ_Sвыпл] > Пвыв)
                           Itogs[ДУ_Sкап_ф]   = Itogs[ДУ_Sвыпл] - Пвыв;
                           Itogs[ДУ_Пвыв_в_ф] = Пвыв;
                        else
                           Itogs[ДУ_Sкап_ф]   = 0;
                           Itogs[ДУ_Пвыв_в_ф] = Itogs[ДУ_Sвыпл];
                        end;
                     else
                        Itogs[ДУ_Sкап_ф]   = Itogs[ДУ_Sзаявл];
                        Itogs[ДУ_Sвыпл]    = Itogs[ДУ_Sзаявл] + Пвыв;
                        Itogs[ДУ_Пвыв_в_ф] = Пвыв;
                        Itogs[ДУ_Пвыв_к_ф] = 0;
                     end;
                  end;
              end; /*if( Mode != MODE_B )*/

              if( ЭтоКапитализация(MngPlan.rec.Flag2) )
                 Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] - Itogs[ДУ_Sкап_ф] + Itogs[ДУ_Пвыв_к_ф];
              end;
              if( ЭтоВыплата(MngPlan.rec.Flag2) )
                 Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] - Itogs[ДУ_Sкап_ф];
              end;
           else /*b. если в плане управления договора, действующем на дату расчета, НЕ выставлен признак капитализации дохода или его выплаты учредителю при частичном выводе капитала*/
              /* ТЗ: перерасчет А для варианта 2 не выполняется,
                     перерасчет Б для варианта 2 не выполняется */
              if( Mode == MODE_ALL )
                 Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Sзаявл];
                 Itogs[ДУ_Sвыпл]  = Itogs[ДУ_Sзаявл];
                 Пвыв               = 0;
                 Itogs[ДУ_Пвыв_в_ф] = 0;
                 Itogs[ДУ_Пвыв_к_ф] = 0;

                 CalcCom.CalcDateP = EndCalcDate;
                 if( РасчетКомиссииЗаДосрочныйВывод( OrderFD, ReqFD.Request.rec.ID, EndCalcDate, TS_ComissSum( TS_IIF( Itogs[ДУ_Пбух] > 0, Itogs[ДУ_Sкап_ф], Itogs[ДУ_Sкап_ф]+Itogs[ДУ_Пбух] ), NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_P, @CalcCom.sfdefcom_parm_P ) != 0 )
                    MsgBox( "Ошибка при расчете комиссии за досрочный вывод." );
                    return 1;
                 end;
                 Itogs[ДУ_Кдв_ф] = CalcCom.sfdefcom_parm_P.rec.CommSum;

                 if( UseNDFL )
                    if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], Itogs[ДУ_Кдв_ф], @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                       return 1;
                    end;
                    Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                    Itogs[ДУ_Sвыпл] = Itogs[ДУ_Sвыпл]; /* как в ТЗ :) */
                 end;
                 Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] - Itogs[ДУ_Sкап_ф];
              end;
           end; /*ЭтоВыплата OR ЭтоКапитализация*/

        else /*при выводе ценных бумаг*/
           if( Mode != MODE_B )
              if( (not Изменили_Купр) OR (Mode == MODE_ALL) )
                 CalcCom.CalcDateM = EndCalcDateComiss;
                 if( РасчетКомиссииБанкаЗаУправление( OrderFD, ReqFD.Request.rec.ID, EndCalcDateComiss, ДосрочныйВывод, @CalcCom.ConCom_M, @CalcCom.sfdefcom_parm_M ) != 0 )
                    MsgBox( "Ошибка при расчете комиссии за управление." );
                    return 1;
                 end;
                 Itogs[ДУ_Купр_ф] = CalcCom.sfdefcom_parm_M.rec.CommSum;
              end;

              /* Прибыль в бухучете П/бух */
              Itogs[ДУ_Пбух] = OrderFD.СуммаБухгалтерскойПрибыли( EndCalcDate ) - Itogs[ДУ_Купр_ф] + ПДне_отн + ДДне_отн;

              if( Mode == MODE_ALL )
                 /* Прибыль учредителя ПУ */
                 if( ПрибыльУчредителя() )
                    return 1;
                 end;
                 Itogs[ДУ_ПУ] = Itogs[ДУ_ПУ] + ПДне_отн + ДДне_отн;
                 /* Прибыль базовая БП*/
                 Itogs[ДУ_БП] = OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss );
              end;

              if( ((not Изменили_Кусп) and Изменили_Купр) OR (Mode == MODE_ALL) )
                 /* Дополнительная прибыль ДП = ПУ - Купр - БП */
                 Itogs[ДУ_ДП] = Itogs[ДУ_ПУ] - Itogs[ДУ_Купр_ф] - Itogs[ДУ_БП];
                 /* Комиссия за успешное управление */
                 CalcCom.CalcDateS = EndCalcDateComiss;
                 if( РасчетКомиссииБанкаЗаУспех( OrderFD, ReqFD.Request.rec.ID, EndCalcDateComiss, TS_ComissSum( Itogs[ДУ_ДП], NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
                    MsgBox( "Ошибка при расчете комиссии за успех." );
                    return 1;
                 end;
                 Itogs[ДУ_Кусп_ф] = CalcCom.sfdefcom_parm_S.rec.CommSum;
              end;

              Itogs[ДУ_Пбух] = Itogs[ДУ_Пбух] - Itogs[ДУ_Кусп_ф];

              if( ЭтоВыплата(MngPlan.rec.Flag2) OR ЭтоКапитализация(MngPlan.rec.Flag2) )
                 if( ЭтоВыплата(MngPlan.rec.Flag2) and (not ДУ_ВЫПЛАТА_ПРИБЫЛИ_ДЕНЬГАМИ()) )
                     if( not UseNDFL )
                        Пвыв = min( max(0, Itogs[ДУ_Пбух]), Itogs[ДУ_Сцб] );
                     else
                        if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], 0, @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                           return 1;
                        end;
                        Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                        Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), min( max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])), Itogs[ДУ_Сцб]) );
                     end;
                     Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Сцб] - Пвыв;

                     if( (not Изменили_Кдв) OR (Mode == MODE_ALL) )
                        CalcCom.CalcDateP = EndCalcDate;
                        if( РасчетКомиссииЗаДосрочныйВывод( OrderFD, ReqFD.Request.rec.ID, EndCalcDate, TS_ComissSum( TS_IIF( Itogs[ДУ_Пбух] > 0, Itogs[ДУ_Sкап_ф], Itogs[ДУ_Sкап_ф]+Itogs[ДУ_Пбух] ), NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_P, @CalcCom.sfdefcom_parm_P ) != 0 )
                           MsgBox( "Ошибка при расчете комиссии за досрочный вывод." );
                           return 1;
                        end;
                        Itogs[ДУ_Кдв_ф] = CalcCom.sfdefcom_parm_P.rec.CommSum;
                     end;

                     if( Itogs[ДУ_Кдв_ф] > 0 )
                        Itogs[ДУ_Пбух]  = Itogs[ДУ_Пбух] - Itogs[ДУ_Кдв_ф];
                     end;

                     if( UseNDFL )
                        if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], Itogs[ДУ_Кдв_ф], @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                           return 1;
                        end;
                        Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                        Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), min( max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])), Itogs[ДУ_Сцб]) );
                     else
                        Пвыв = min( max(0, Itogs[ДУ_Пбух]), Itogs[ДУ_Сцб] );
                     end;
                     Itogs[ДУ_Пвыв_в_ф] = Пвыв;
                     Itogs[ДУ_Пвыв_к_ф] = 0;
                     Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Сцб] - Itogs[ДУ_Пвыв_в_ф];
                     Itogs[ДУ_Sвыпл]  = 0;
                 else  /* if( (ЭтоВыплата(MngPlan.rec.Flag2) and ДУ_ВЫПЛАТА_ПРИБЫЛИ_ДЕНЬГАМИ()) or ЭтоКапитализация(MngPlan.rec.Flag2) ) */
                    if( UseNDFL )
                       if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], 0, @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                          return 1;
                       end;
                       Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                       Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
                    else
                       Пвыв = max( 0, Itogs[ДУ_Пбух]);
                    end;

                    if( (not Изменили_Кдв) OR (Mode == MODE_ALL) )
                       CalcCom.CalcDateP = EndCalcDate;
                       if( РасчетКомиссииЗаДосрочныйВывод( OrderFD, ReqFD.Request.rec.ID, EndCalcDate, TS_ComissSum( TS_IIF( Itogs[ДУ_Пбух] > 0, Itogs[ДУ_Sкап_ф], Itogs[ДУ_Sкап_ф]+Itogs[ДУ_Пбух] ), NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_P, @CalcCom.sfdefcom_parm_P ) != 0 )
                          MsgBox( "Ошибка при расчете комиссии за досрочный вывод." );
                          return 1;
                       end;
                       Itogs[ДУ_Кдв_ф] = CalcCom.sfdefcom_parm_P.rec.CommSum;
                    end;

                    if( Itogs[ДУ_Кдв_ф] > 0 )
                       Itogs[ДУ_Пбух]  = Itogs[ДУ_Пбух] - Itogs[ДУ_Кдв_ф];
                    end;
                    if( UseNDFL )
                       if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], Itogs[ДУ_Кдв_ф], @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                          return 1;
                       end;
                       Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                       Пвыв = min( max(0, (Itogs[ДУ_Пбух]-Itogs[ДУ_Нкуд_ф])), max(0, (Itogs[ДУ_Пнал]-Itogs[ДУ_Нкуд_ф])) );
                    else
                       Пвыв = max(0, Itogs[ДУ_Пбух]);
                    end;

                    if( ЭтоВыплата(MngPlan.rec.Flag2) )
                       Itogs[ДУ_Пвыв_в_ф] = Пвыв;
                       Itogs[ДУ_Пвыв_к_ф] = 0;
                    end;

                    if( ЭтоКапитализация(MngPlan.rec.Flag2) )
                       Itogs[ДУ_Пвыв_к_ф] = Пвыв;
                       Itogs[ДУ_Пвыв_в_ф] = 0;
                    end;

                    Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Сцб];

                 end; /*if( ЭтоВыплата(MngPlan.rec.Flag2) and (not ДУ_ВЫПЛАТА_ПРИБЫЛИ_ДЕНЬГАМИ()) )*/
              else 
                 Пвыв = 0;
                 Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Сцб];

                 if( (not Изменили_Кдв) OR (Mode == MODE_ALL) )
                    CalcCom.CalcDateP = EndCalcDate;
                    if( РасчетКомиссииЗаДосрочныйВывод( OrderFD, ReqFD.Request.rec.ID, EndCalcDate, TS_ComissSum( TS_IIF( Itogs[ДУ_Пбух] > 0, Itogs[ДУ_Sкап_ф], Itogs[ДУ_Sкап_ф]+Itogs[ДУ_Пбух] ), NATCUR ), ДосрочныйВывод, @CalcCom.ConCom_P, @CalcCom.sfdefcom_parm_P ) != 0 )
                       MsgBox( "Ошибка при расчете комиссии за досрочный вывод." );
                       return 1;
                    end;
                    Itogs[ДУ_Кдв_ф] = CalcCom.sfdefcom_parm_P.rec.CommSum;
                 end;

                 if( Itogs[ДУ_Кдв_ф] > 0 )
                    Itogs[ДУ_Пбух]  = Itogs[ДУ_Пбух] - Itogs[ДУ_Кдв_ф];
                 end;
                 if( UseNDFL )
                    if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], Itogs[ДУ_Кдв_ф], @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                       return 1;
                    end;
                    Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
                 end;
                 Itogs[ДУ_Пвыв_в_ф] = 0;
                 Itogs[ДУ_Пвыв_к_ф] = 0;
              end; /*if( ЭтоВыплата(MngPlan.rec.Flag2) OR ЭтоКапитализация(MngPlan.rec.Flag2) )*/
           end;/*if( Mode != MODE_B )*/

           if( Mode != MODE_A )
              if( ЭтоВыплата(MngPlan.rec.Flag2) OR ЭтоКапитализация(MngPlan.rec.Flag2) )
                 if( not ДУ_ВЫПЛАТА_ПРИБЫЛИ_ДЕНЬГАМИ() )
                    Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] - Itogs[ДУ_Sкап_ф];
                 else
                    Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] - Itogs[ДУ_Sкап_ф] + Itogs[ДУ_Пвыв_к_ф];
                 end;
              else 
                 Itogs[ДУ_СКост] = Itogs[ДУ_ИТОГ_СК] - Itogs[ДУ_Sкап_ф];
              end; /*if( ЭтоВыплата(MngPlan.rec.Flag2) OR ЭтоКапитализация(MngPlan.rec.Flag2) )*/
           end;
        end; /*Req.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY*/
     else /*полный вывод*/

        if( Mode != MODE_B )
           if( (not Изменили_Купр) OR (Mode == MODE_ALL) )
              CalcCom.CalcDateM = EndCalcDateComiss;
              if( РасчетКомиссииБанкаЗаУправление( OrderFD, ReqFD.Request.rec.ID, EndCalcDateComiss, ЗакрытиеДоговора, @CalcCom.ConCom_M, @CalcCom.sfdefcom_parm_M ) != 0 )
                 MsgBox( "Ошибка при расчете комиссии за управление." );
                 return 1;
              end;
              Itogs[ДУ_Купр_ф] = CalcCom.sfdefcom_parm_M.rec.CommSum;
           end;

           /* Прибыль в бухучете П/бух */
           Itogs[ДУ_Пбух] = OrderFD.СуммаБухгалтерскойПрибыли( EndCalcDate ) - Itogs[ДУ_Купр_ф] + ПДне_отн + ДДне_отн;

           if( Mode == MODE_ALL )
              /* Прибыль учредителя ПУ */
              if( ПрибыльУчредителя() )
                 return 1;
              end;
              /* Прибыль базовая БП*/
              Itogs[ДУ_БП] = OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss );
           end;

           if( ((not Изменили_Кусп) and Изменили_Купр) OR (Mode == MODE_ALL) )
              /* Дополнительная прибыль ДП = ПУ - Купр - БП */
              Itogs[ДУ_ДП] = Itogs[ДУ_ПУ] - Itogs[ДУ_Купр_ф] - Itogs[ДУ_БП];
              /* Комиссия за успешное управление */
              CalcCom.CalcDateS = EndCalcDateComiss;
              if( РасчетКомиссииБанкаЗаУспех( OrderFD, ReqFD.Request.rec.ID, EndCalcDateComiss, TS_ComissSum( Itogs[ДУ_ДП], NATCUR ), ЗакрытиеДоговора, @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
                 MsgBox( "Ошибка при расчете комиссии за успех." );
                 return 1;
              end;
              Itogs[ДУ_Кусп_ф] = CalcCom.sfdefcom_parm_S.rec.CommSum;
           end;

           if( Mode == MODE_ALL )
              Itogs[ДУ_Sкап_ф] = OrderFD.ОстатокПоСчету( "Капитал ДУ", EndCalcDate );
           end;

           if( (not Изменили_Кдв) OR (Mode == MODE_ALL) )
              CalcCom.CalcDateP = EndCalcDate;
              if( РасчетКомиссииЗаДосрочныйВывод( OrderFD, ReqFD.Request.rec.ID, EndCalcDate, TS_ComissSum( TS_IIF( Itogs[ДУ_Пбух] > 0, Itogs[ДУ_Sкап_ф], Itogs[ДУ_Sкап_ф]+Itogs[ДУ_Пбух] ), NATCUR ), ЗакрытиеДоговора, @CalcCom.ConCom_P, @CalcCom.sfdefcom_parm_P ) != 0 )
                 MsgBox( "Ошибка при расчете комиссии за досрочный вывод." );
                 return 1;
              end;
              Itogs[ДУ_Кдв_ф] = CalcCom.sfdefcom_parm_P.rec.CommSum;
           end;

           /* скорректируем Пбух на суммы комиссий Кусп и Кдв */
           if( Itogs[ДУ_Кусп_ф] > 0 )
              Itogs[ДУ_Пбух] = Itogs[ДУ_Пбух] - Itogs[ДУ_Кусп_ф];
           end;

           if( Itogs[ДУ_Кдв_ф] > 0 )
              Itogs[ДУ_Пбух] = Itogs[ДУ_Пбух] - Itogs[ДУ_Кдв_ф];
           end;

           /* определяется Пвыв */
           if( Itogs[ДУ_Пбух] <= 0 )
              Пвыв = 0;
           else
              Пвыв = Itogs[ДУ_Пбух];
           end;
           if( UseNDFL )
              if (not NPTRecalcTaxSum( OrderFD.Order.rec.ID, EndCalcDate, Itogs[ДУ_Купр_ф], Itogs[ДУ_Кусп_ф], Itogs[ДУ_Кдв_ф], @Itogs[ДУ_Пнал], @Itogs[ДУ_Нкуд_ф]))
                 return 1;
              end;
              Itogs[ДУ_Пнал] = Скорректированный_Пнал(OrderFD.ID, EndCalcDate, Itogs[ДУ_Пнал], Itogs[ДУ_Нкуд_ф]);
              Itogs[ДУ_Пвыв_в_ф] = max(0, (Пвыв-Itogs[ДУ_Нкуд_ф]));
           else
              Itogs[ДУ_Пвыв_в_ф] = Пвыв;
           end;
        end;

        /*значения Итогов по состоянию до начала операции*/
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, NULL, @Н_Купр ) )
           MsgBox( "Ошибка при получении итога \"Н_Купр\"по договору" );
           return 1;
        end;

        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, NULL, @Н_Кусп ) )
           MsgBox( "Ошибка при получении итога \"Н_Кусп\"по договору" );
           return 1;
        end;

        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, NULL, @Н_Кдв ) )
           MsgBox( "Ошибка при получении итога \"Н_Кдв\"по договору" );
           return 1;
        end;

        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, NULL, @Н_Налог ) )
           MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
           return 1;
        end;

        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, EndCalcDate, NULL, NULL, @Н_Дх ) )
           MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
           return 1;
        end;

        Itogs[ДУ_Sвыпл] = OrderFD.ОстатокПоСчету( "ДС ДУ", EndCalcDate ) - Н_Купр - Н_Кусп - Н_Кдв - Н_Налог - Н_Дх - Itogs[ДУ_Купр_ф] - Itogs[ДУ_Кусп_ф] - Itogs[ДУ_Кдв_ф] - Itogs[ДУ_Нкуд_ф];
     end; /*ReqFD.Request.rec.Type == TS_KINDDECLAR_PARTLY*/

     return 0;
  END;
  
  PRIVATE MACRO CalculateItogs( Mode:INTEGER )

     if( SaveItogsFromPanel( Mode ) != 0 )
        return;
     end;

     Itogs[ДУ_ИТОГ_СК] = OrderFD.КапиталУчредителя( {curdate} ); /*Имущество в управлении (руб)*/

     if( IsProlongation ) 
        РасчетПриПролонгации( Mode );
     else
        if( ReqFD )
           РасчетПриВыводеКапитала( Mode );
        end;
     end;

     if( Mode != MODE_B )
        if( (not Изменили_Кдв) OR (Mode == MODE_ALL) )
           Itogs[ДУ_Кдв] = Itogs[ДУ_Кдв_ф];
        end;
        if( (not Изменили_Купр) OR (Mode == MODE_ALL) )
           Itogs[ДУ_Купр] = Itogs[ДУ_Купр_ф];
        end;
        if( (not Изменили_Кусп) OR (Mode == MODE_ALL) )
           Itogs[ДУ_Кусп] = Itogs[ДУ_Кусп_ф];
        end;
        Itogs[ДУ_Пвыв_к] = Itogs[ДУ_Пвыв_к_ф];
        Itogs[ДУ_Пвыв_в] = Itogs[ДУ_Пвыв_в_ф];
        Itogs[ДУ_Нкуд]   = Itogs[ДУ_Нкуд_ф];
        Itogs[ДУ_Sкап]   = Itogs[ДУ_Sкап_ф];
     end;

     SaveItogsToPanel();
  END;

  PRIVATE MACRO ListAvr()
  END;

  PRIVATE MACRO Report()
  END;

  PRIVATE MACRO InitFields()
     m_Panel.rec.A1      = OrderFD.Trustor.rec.ShortName; /*Учредитель*/
     m_Panel.rec.A2_1    = OrderFD.Number(); /*Договор №*/
     m_Panel.rec.A2_2    = OrderFD.BeginDate(); /*от*/
     m_Panel.rec.A3      = ""; /*ОФБУ*/
     m_Panel.rec.A4      = {curdate}; /*Дата расчета*/
     m_Panel.rec.A5      = EndCalcDate; /*Дата окончания расчетного периода*/
     m_Panel.rec.A70     = {OperDprt}; /*Филиал  */
     m_Panel.rec.A71     = {Oper}; /*Исполнитель*/
     m_Panel.rec.A71_1   = {Name_Oper};
     m_Panel.rec.A6_2    = "RUR";/*в 1 очереди реализации - выводится "RUR" и не редактируется*/
     m_Panel.rec.A7_2    = "RUR";/*в 1 очереди реализации - выводится "RUR" и не редактируется*/
     m_Panel.rec.A8_2    = "RUR";/*в 1 очереди реализации - выводится "RUR" и не редактируется*/
     m_Panel.rec.A9_2    = "RUR";/*в 1 очереди реализации - выводится "RUR" и не редактируется*/
     m_Panel.rec.A12_2   = "RUR";/*в 1 очереди реализации - выводится "RUR" и не редактируется*/
     m_Panel.rec.A40_2   = "RUR";/*в 1 очереди реализации - выводится "RUR" и не редактируется*/
  END;

  MACRO Run( RunKey:INTEGER ):BOOL

     InitProgress( -1, "Расчет итогов по договору", "Расчет итогов по договору" );
        InitFields();
        CalculateItogs( MODE_ALL );
     RemProgress;

     if( Run( RunKey ) )
        SaveItogsFromPanel( MODE_ALL );

        if( SaveAllItogsInBD() )
           return true;
        end;
     end;
     return false;
  END;

  PRIVATE MACRO Construct( Order, Req ):BOOL
     if( Itogs == NULL )
        Itogs = TArray();
     end;

     if( Order == NULL )
        if( Req )
           OrderFD = TS_OrderFD( 0, Req.rec.OrderID );
           if( not OrderFD )                  
              MsgBox( "Не найден договор ДУ по заявлению ВВК \"" + Req.rec.Number + "\"");
              return false;
           end;
        else
           MsgBox( "Не задан договор ДУ для расчета итогов.");
           return false;
        end;
     else
        OrderFD = TS_OrderFD( 0, Order.rec.ID );
     end;

     if( Req )
        ReqFD = TS_RequestFD( Req, null, OrderFD );
     end;

     if( EndCalcDate == NULL )
        if( ReqFD )                
           if( ReqFD.Request.rec.Status == 0/*TS_IOREQ_STATE_INP*/ )
              EndCalcDate = {curdate};
           else
              EndCalcDate = Req.rec.CapitalDate-1;
           end;
        else             
           EndCalcDate = {curdate};
        end;
     end;

     EndCalcDateComiss = EndCalcDate;

     Itogs[ДУ_Sкап] = Itogs[ДУ_Sкап_ф] = Itogs[ДУ_Кдв]  = Itogs[ДУ_Кдв_ф] = Itogs[ДУ_Купр] = Itogs[ДУ_Купр_ф] =
     Itogs[ДУ_Кусп] = Itogs[ДУ_Кусп_ф] = Itogs[ДУ_Пбух] = Itogs[ДУ_Пнал] =  Itogs[ДУ_БП] = Itogs[ДУ_Пвыв_в] =
     Itogs[ДУ_Пвыв_в_ф] = Itogs[ДУ_Пвыв_к] = Itogs[ДУ_Пвыв_к_ф] = Itogs[ДУ_Нкуд] = Itogs[ДУ_Нкуд_ф] = Itogs[ДУ_Sвыпл] =
     Itogs[ДУ_СКост] = Itogs[ДУ_Кцб_а] = Itogs[ДУ_Сцб_а] = Itogs[ДУ_Кцб_о] = Itogs[ДУ_Сцб_о] = Itogs[ДУ_Кцб_в] =
     Itogs[ДУ_Сцб_в] = Itogs[ДУ_Sзаявл] = Itogs[ДУ_Сцб] = $0;
     
     MngPlan = OrderFD.MngPlan( EndCalcDate );

     UseNDFL = TS_IsPayerNPTaxAllCheck( OrderFD.Order.rec.Trustor, EndCalcDate );

     return true;
  END;

  PRIVATE MACRO Init()
     VAR StatusStr = "Esc Выход ";
     if( ReadOnly == false )
        StatusStr = StatusStr + "F2 Исполнить "
     end;

     if( ReqFD )
        if( ReqFD.ActiveKind == TS_IOREQ_ACTIVEKIND_EMISSIVE )
           StatusStr = StatusStr + "F3 Список ЭЦБ "
        elif( ReqFD.ActiveKind == TS_IOREQ_ACTIVEKIND_NOEMISSIVE )
           StatusStr = StatusStr + "F3 Список НЭЦБ "
        end;
     end;
     if( ReadOnly == false )
        StatusStr = StatusStr + "F5 Перерасчет комиссий, прибыли, ост. капитала и выплат F6 Перерасчет ост. капитала и выплат "
     end;

     StatusStr = StatusStr + "F7 Отчет";

     Message( StatusStr );
     if( ReadOnly == true )
        DisableFields( m_Panel );
     end;
  END;

  MACRO KeyProc( Pan:Variant, Cmd:INTEGER, FldId:INTEGER, _Key:INTEGER )
     VAR RetKey = KeyProc( Pan, Cmd, FldId, _Key );

     if( (Cmd == DLG_KEY) AND (RetKey == CM_DEFAULT) )
        if( ( ReadOnly == false ) AND (_Key == 319/*F5*/) )   /*Перерасчет комиссий, прибыли, остатка капитала и выплат*/
            if( m_Panel.rec.C0 != "X" )
               InitProgress( -1, "Расчет итогов по договору", "Расчет итогов по договору" );
                  CalculateItogs( MODE_A );
               RemProgress;
            end;
            UpdateFields( Pan );
        elif( ( ReadOnly == false ) AND (_Key == 320/*F6*/) ) /*Перерасчет остатка капитала и выплат*/
            if( m_Panel.rec.C0 != "X" )
               InitProgress( -1, "Расчет итогов по договору", "Расчет итогов по договору" );
                  CalculateItogs( MODE_B );
               RemProgress;
            end;
            UpdateFields( Pan );
        elif( ReqFD AND (ReqFD.ActiveKind != TS_IOREQ_ACTIVEKIND_MONEY) AND (_Key == 317/*F3*/) ) /*Список вносимых/вводимых бумаг*/
           ListAvr(); 
        elif( _Key == 321/*F7*/ ) /*Печать в Excel*/ 
           Report(); 
        elif( (_Key == KEY_SPACE) AND (FldId == PNFLD_C0) ) 
           if( m_Panel.rec.C0 == "X" )
              m_Panel.rec.C0 = "";
           else
              m_Panel.rec.C0 = "X";
           end;
        end;
     end;

     return RetKey;
  END;

  PRIVATE MACRO Check():BOOL
     var RetVal = true;
     if((IsProlongation == false) and (ReqFD.Request.rec.Type == TS_KINDDECLAR_PARTLY) and (ReadOnly == false)/* and (ReqFD.Request.rec.ActiveKind == TS_IOREQ_ACTIVEKIND_MONEY)*/)
        RetVal = TSCheckLimitMP( OrderFD.ID, EndCalcDate, m_Panel.rec.A41, 1/*TS_MP_LIMDIC_MINVOLMONEY*/ );
     end;

     return RetVal;
  END;

  initDL_CPanel( "trust.lbr", "PCALCREP" ); 
  if( not Construct( _Order, _Req ) )
     return NULL;
  end;
END;

/*Расчет итогов при выводе капитала*/
MACRO TS_CalculateItogsOut( Itogs:TArray, Req:TRecHandler, EndCalcDate:DATE, ID_Operation:INTEGER, ID_Step:INTEGER, CalcCom:DataCalcCom ):BOOL
  VAR Form = CItogs_Panel( Itogs, NULL, Req, false, false, EndCalcDate, ID_Operation, ID_Step, CalcCom );
  if( Form )
     return Form.Run();
  end;
  return false;
END;

/*Расчет итогов при пролонгации*/
MACRO TS_CalculateItogsProlongation( Itogs:TArray, Order:TRecHandler, EndCalcDate:DATE, ID_Operation:INTEGER, ID_Step:INTEGER, CalcCom:DataCalcCom ):BOOL
  VAR Form = CItogs_Panel( Itogs, Order, NULL, true, false, EndCalcDate, ID_Operation, ID_Step, CalcCom );
  if( Form )
     return Form.Run();
  end;
  return false;
END;

PRIVATE MACRO ВыполнитьПроводкиСвертки( FD:TS_OrderFD, DlDoc:VARIANT, DebCat:STRING, CredCat:STRING, IsRestDebet:BOOL, RestDate:DATE, DebCatRole:INTEGER, CredCatRole:INTEGER )
  VAR i = 0, Rests = TArray(), AccDebet, AccCredit,
      AccBuf = TRecHandler( "account.dbt" );

  FD.ОстатокПоСчету( TS_IIF( IsRestDebet, DebCat, CredCat ), RestDate, TS_IIF( IsRestDebet, DebCatRole, CredCatRole ), Rests );

  while( i < Rests.Size )

     if( not TS_GetAccount( 2, Rests[i].FIID, Rests[i].Account, AccBuf, true ) )
        return 1;
     end;

     if( IsRestDebet )
        AccDebet  = AccBuf;
        AccCredit = CredCat;
     else
        AccDebet  = DebCat;
        AccCredit = AccBuf;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору(
              FD, NULL, NULL,
              AccDebet, AccCredit,
              RestDate,
              2, 
              NATCUR,
              abs(Rests[i].Summa),
              DlDoc,
              FD.Number,
              "Списание остатков счетов по учету доходов и расходов на счета по учету прибыли и убытков",
              DebCatRole, CredCatRole
              )
       )
         return 1;
     end;

     i = i + 1;
  end;

  return 0;
END;

MACRO СвернутьСчета( OrderFD:TS_OrderFD, DlDoc:VARIANT, CalcDate:DATE ):INTEGER
  VAR ПрибыльRest, УбытокRest,
      ПрибыльBuf = TRecHandler( "account.dbt" ),
      УбытокBuf  = TRecHandler( "account.dbt" );

  if( ВыполнитьПроводкиСвертки( OrderFD, DlDoc, "Доходы ДУ", "Прибыль ДУ", true, CalcDate ) )
     return 1;
  end;
  if( ВыполнитьПроводкиСвертки( OrderFD, DlDoc, "ДоходыЭцб ДУ", "Прибыль ДУ", true, CalcDate ) )
     return 1;
  end;
  if( ВыполнитьПроводкиСвертки( OrderFD, DlDoc, "Прибыль ДУ", "+Расчеты, ДУ", false, CalcDate, null, FIROLE_AVANCE ) )
     return 1;
  end;
  if( ВыполнитьПроводкиСвертки( OrderFD, DlDoc, "Прибыль ДУ", "Расходы ДУ", false, CalcDate ) )
     return 1;
  end;
  if( ВыполнитьПроводкиСвертки( OrderFD, DlDoc, "Прибыль ДУ", "РасходыЭцб ДУ", false, CalcDate ) )
     return 1;
  end;

  if( OrderFD.ActualAccount( NULL, "Прибыль ДУ", null, true, null, ПрибыльBuf, CalcDate, null, null, MC_PAIRACCMODE_MANUAL ) AND
      OrderFD.ActualAccount( NULL, "Убыток ДУ", null, true, null, УбытокBuf, CalcDate, null, null, MC_PAIRACCMODE_MANUAL )
    )
     ПрибыльRest = TS_GetRestAccount( ПрибыльBuf.rec.Account, ПрибыльBuf.rec.Code_Currency, ПрибыльBuf.rec.Chapter, CalcDate );
     УбытокRest  = -TS_GetRestAccount( УбытокBuf.rec.Account, УбытокBuf.rec.Code_Currency, УбытокBuf.rec.Chapter, CalcDate );
     /*образовалось дебетовое сальдо на л/счете по учету прибыли данного договора ДУ*/
     if( ПрибыльRest < УбытокRest )
        if( not ПроводкаПоКатегориямУчетаПоДоговору(
                 OrderFD, 
                 NULL,
                 NULL,
                 /*ПрибыльBuf, УбытокBuf,*/
                 УбытокBuf, ПрибыльBuf,
                 CalcDate,
                 ПрибыльBuf.rec.Chapter, 
                 NATCUR,
                 Abs(ПрибыльRest),
                 DlDoc,
                 OrderFD.Number,
                 "Списание остатков счетов по учету доходов и расходов на счета по учету прибыли и убытков"
                 )
          )
            return 1;
        end;
     else
        if( not ПроводкаПоКатегориямУчетаПоДоговору(
                 OrderFD, 
                 NULL,
                 NULL,
                 ПрибыльBuf, УбытокBuf,
                 CalcDate,
                 УбытокBuf.rec.Chapter, 
                 NATCUR,
                 Abs(УбытокRest),
                 DlDoc,
                 OrderFD.Number,
                 "Списание остатков счетов по учету доходов и расходов на счета по учету прибыли и убытков"
                 )
          )
            return 1;
        end;
     end;
  end;

  return 0;
END;