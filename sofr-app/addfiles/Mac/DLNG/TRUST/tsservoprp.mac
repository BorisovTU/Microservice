/*®âç¥âë á¥à¢¨á­ëå ®¯¥à æ¨© „“*/
IMPORT rsd, BankInter, TSInter, OprInter, "dlreport.mac", "TsChargeCom.mac", "TSCalcPrCl.mac";

/*‚ à¨ ­âë ¢ë§®¢  TS_ServiceOperReport (¯ à ¬¥âà ReportMode)*/
CONST TS_SVOPREP_ALL    = 1, /* Žâç¥â + ®è¨¡ª¨ */
      TS_SVOPREP_ERROR  = 2, /* ’®«ìª® ®è¨¡ª¨  */
      TS_SVOPREP_REPORT = 3; /* ’®«ìª® ®âç¥â   */

PRIVATE VAR rFinInstr = TRecHandler( "fininstr.dbt" );
PRIVATE VAR LastFIID = -1;

PRIVATE MACRO Exception( RslErrObj ):INTEGER
  RemProgress();
  MsgBox( RslErrObj.Module + " áâà®ª  " + RslErrObj.Line + "|" + RslErrObj.Message);
  return 1;
END;


PRIVATE MACRO GetFinInstr( FIID:INTEGER )
  if( LastFIID != FIID )
     if( ®«ãç¨âì”¨­ˆ­( FIID, rFinInstr ) == 0 ) 
        LastFIID = FIID;
     else
        LastFIID = -1;
        return false;
     end;
   end;
   return true;
END;

PRIVATE MACRO à®¢®¤ª¨®Ž¯¥à æ¨¨( ServOp:TRecHandler )
  VAR doc  = TRecHandler( "acctrn.dbt" );
  VAR Query, DataSet, NumRec = 0;

  PRIVATE MACRO PrintLine( Account_Payer:STRING, Account_Receiver:STRING, Sum:MONEY, FIID:INTEGER, Ground:STRING )

     GetFinInstr( FIID );

[ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³#########################³#########################³####################³################³###################################################³]
      ( Account_Payer:r, Account_Receiver:r, Sum:r, rFinInstr.rec.FI_Code:r, Ground:w);

     NumRec = NumRec + 1;
  END;

[
                                                ‘¯¨á®ª ¯à®¢®¤®ª ¯® ®¯¥à æ¨¨ 
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³    ‘ç¥â ¯« â¥«ìé¨ª      ³    ‘ç¥â ¯®«ãç â¥«ï      ³       ‘ã¬¬         ³     ‚ «îâ      ³                    Žá­®¢ ­¨¥                      ³
];                                             

  Query = RSDCommand( "SELECT t_ID_Operation, t_ID_Step " +
                      "  FROM doprstep_dbt " +
                      " WHERE     t_ServDocKind = ? " +
                      "       AND t_ServDocID   = ? "
                    );
                                           
  Query.addParam( "", RSDBP_IN, ServOp.rec.Kind_Operation );
  Query.addParam( "", RSDBP_IN, ServOp.rec.ID );
  Query.execute();
  DataSet = TRSBDataSet(query);
  while( DataSet.MoveNext() )
     Doc.Clear();
     while( GetDocsByOperStep( doc, int(SQL_ConvTypeInteger(DataSet.ID_Operation) ), int(SQL_ConvTypeInteger(DataSet.ID_Step) ) ) )
        PrintLine( doc.rec.Account_Payer, doc.rec.Account_Receiver, doc.rec.Sum_Payer, doc.rec.FIID_Payer, doc.rec.Ground );
     end;
  end;

[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

  if( NumRec == 0 )
[¥â ¢ë¯®«­¥­­ëå ¯à®¢®¤®ª ¯® ®¯¥à æ¨¨.];
  end;
END;

PRIVATE MACRO ServObjName( ServOp:TRecHandler ) :STRING
  return "„®£®¢®à";
END;

PRIVATE MACRO ServObjCode( ServOp:TRecHandler, ObjectID:INTEGER ) :STRING
  VAR Ground = TRecHandler( "spground.dbt" );

  if( FindOrderGround( ObjectID, Ground ) )
     return Ground.rec.Xld;
  end;
  return "";
END;

/************************************************************************************************
  ¥ç âì ®âç¥â  ®¡ ®è¨¡ª å ¢ë¯®«­¥­¨ï
*************************************************************************************************/
MACRO TS_ServiceOperErrorReport( ServOp:TRecHandler )
  VAR PrintHead = false;
  VAR rs = RsdRecordSet( "   SELECT * "+
                         "     FROM DTSSERVOP_ERROR_TMP TSErrLog "+
                         "    WHERE TSErrLog.t_OperID = " + string(ServOp.rec.ID) +
                         " ORDER BY TSErrLog.t_ErrorNum" 
                       );

  while( rs.moveNext() )
     if( PrintHead == false )
        PrintHead = true;

[

  à®â®ª®« ¢ë¯®«­¥­¨ï á¥à¢¨á­®© ®¯¥à æ¨¨:
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³           Š®¤            ³###############³  ü   ³                          ‘®®¡é¥­¨¥                                                                    ³
 ³         ®¯¥à æ¨¨         ³               ³®è¨¡ª¨³                                                                                                       ³
]( ServObjName(ServOp):c );
     end;

[ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³##########################³###############³######³#######################################################################################################³
](ServOp.rec.Code, ServObjCode( ServOp, rs.value("t_ObjectID") ), rs.value("t_ErrorNum"), rs.value("t_ErrorStr"):w );
  end;

  if( PrintHead == true )
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
  end;

END;

/************************************************************************************************
  ¥ç âì ®âç¥â  ® ¢ë¯®«­¥­¨¨ ®¯¥à æ¨¨ ¯®¤¢¥¤¥­¨ï ¨â®£®¢ Ž”“
*************************************************************************************************/
PRIVATE MACRO PrintOFBUItogHeader()
[ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³  ü  ³      “çà¥¤¨â¥«ì       ³„­¥©³    ‘ã¬¬  ¨¬ãé¥áâ¢ ,   ³  ‘à.¢§¢. ¯® áà®ªã   ³  à¨¡ë«ì ãçà¥¤¨â¥«ï   ³    ‚®§­ £à ¦¤¥­¨¥     ³    à¨¡ë«ì á ãç¥â®¬   ³
 ³     ³                       ³¢ ³    ¯¥à¥¤ ­­®£® ¢ „“   ³   ¤®«ï ãçà¥¤¨â¥«ï ¢   ³     §   (àã¡.)      ³     1% (£®¤®¢®©)      ³  ¢®§­ £à ¦¤¥­¨ï §   ³
 ³     ³                       ³    ³                       ³     ª ¯¨â «¥ Ž”“     ³                       ³                       ³         (àã¡.)        ³
];
END;

PRIVATE MACRO PrintOFBUItogLine( C1, C2, C3, C4, C5, C6, C7, C8, C9 )
[ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ ### ³ ##################### ³### ³ ##################### ³ ##################### ³ ##################### ³ ##################### ³ ##################### ³
](C1, C2, C3, C4, C5, C6, C7, C8, C9);
END;


PRIVATE MACRO PrintOFBUItogFoot()
[ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
END;


/************************************************************************************************
  ¥ç âì ®âç¥â  ® ¢ë¯®«­¥­¨¨ ®¯¥à æ¨¨ ¯®¤¢¥¤¥­¨ï ¨â®£®¢ „“
*************************************************************************************************/
PRIVATE MACRO PrintItogHeader()
[ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³        ¨¬¥­®¢ ­¨¥ ˆâ®£          ³          ‡­ ç¥­¨¥         ³ „ â  ­ ç «  ¯¥- ³ ‚á¥£® ­ ç¨á«¥­® á ³ ‚á¥£® ®¯« ç¥­® á ­ ç - ³
 ³                                  ³                           ³ à¨®¤  à áç¥â    ³ ­ ç «  áà®ª  ¤¥©- ³  «  áà®ª  ¤¥©áâ¢¨ï ¤®- ³
 ³                                  ³                           ³                 ³  áâ¢¨ï ¤®£®¢®à    ³          £®¢®à         ³
 ³                                  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³                                  ³   áç¥â­®¥  ³ ” ªâ¨ç¥áª®¥ ³                 ³                   ³                        ³
];
END;

PRIVATE MACRO PrintItogFoot( FromServiceOper:bool )
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];

  if( FromServiceOper == true )
    [ ‘¯¨á®ª ­¥ ®¡à ¡®â ­­ëå ¤®£®¢®à®¢: ];
  end;
END;

PRIVATE MACRO PrintExclude( NumOrder )
[ ################      ˆáª«îç¥­ ¯®«ì§®¢ â¥«¥¬ ]( NumOrder );
END;

PRIVATE MACRO PrintItogDelimiter()
[ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
END;

PRIVATE MACRO PrintItogLine( RestDate:DATE, TotalTypeName:STRING, RestAmount:MONEY )
[³############³#############################################³######################³
]( RestDate, TotalTypeName:w, RestAmount:a );
END;

PRIVATE MACRO PrintItogHeaderByOrder( OrderFD:TS_OrderFD )
[ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ „®£®¢®à ü ############### “çà¥¤¨â¥«ì #                                                                                      ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
]( OrderFD.Number(), OrderFD.Trustor().rec.ShortName );
END;

PRIVATE MACRO PrintItogBodyByOrder( ServOp, Set, OrderFD:TS_OrderFD )
  var d, m, y, StartDate12, StartDate3, StartDate4, StartDate5, StartDate6, BegDate;

  DateSplit( ServOp.rec.StepDate, d, m, y );
  BegDate = OrderFD.„ â  ç « ( ServOp.rec.StepDate );
  StartDate12 = BegDate;
  StartDate3  = BegDate;
  StartDate4  = BegDate;
  StartDate5  = BegDate;
  StartDate6  = DATE( 1,1,y);

  var T_A31_1 = TS_IIF( Set.T_A31_1 == NULL, "", Set.T_A31_1 );
  var T_A31_2 = TS_IIF( Set.T_A31_2 == NULL, "", Set.T_A31_2 );
  var T_A51   = TS_IIF( Set.T_A51   == NULL, "", Set.T_A51   );
  var T_A52   = TS_IIF( Set.T_A52   == NULL, "", Set.T_A52   );

  var T_A34_3 = TS_IIF( Set.T_A34_3 == NULL, "", Set.T_A34_3 );

  var T_A32_1 = TS_IIF( Set.T_A32_1 == NULL, "", Set.T_A32_1 );
  var T_A32_2 = TS_IIF( Set.T_A32_2 == NULL, "", Set.T_A32_2 );
  var T_A53   = TS_IIF( Set.T_A53   == NULL, "", Set.T_A53   );
  var T_A54   = TS_IIF( Set.T_A54   == NULL, "", Set.T_A54   );

  var T_A34_4 = TS_IIF( Set.T_A34_4 == NULL, "", Set.T_A34_4 );
  var T_A34_5 = TS_IIF( Set.T_A34_5 == NULL, "", Set.T_A34_5 );
  var T_A55   = TS_IIF( Set.T_A55   == NULL, "", Set.T_A55   );
  var T_A56   = TS_IIF( Set.T_A56   == NULL, "", Set.T_A56   );

  var T_A34_6 = TS_IIF( Set.T_A34_6 == NULL, "", Set.T_A34_6 );
  var T_A34_7 = TS_IIF( Set.T_A34_7 == NULL, "", Set.T_A34_7 );
  var T_A57   = TS_IIF( Set.T_A57   == NULL, "", Set.T_A57   );

  var T_A35_1 = TS_IIF( Set.T_A35_1 == NULL, "", Set.T_A35_1 );
  var T_A35_2 = TS_IIF( Set.T_A35_2 == NULL, "", Set.T_A35_2 );
  var T_A58   = TS_IIF( Set.T_A58   == NULL, "", Set.T_A58   );
  var T_A59   = TS_IIF( Set.T_A59   == NULL, "", Set.T_A59   );

  var T_A41   = TS_IIF( Set.T_A41   == NULL, "", Set.T_A41   );
  var T_A60   = TS_IIF( Set.T_A60   == NULL, "", Set.T_A60   );
  var T_A61   = TS_IIF( Set.T_A61   == NULL, "", Set.T_A61   );

 [³ Š®¬¨áá¨ï §  ã¯à ¢«¥­¨¥           ³ ########### ³ ########### ³ ############### ³ ################# ³ ###################### ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³  §®¢ ï ¯à¨¡ë«ì                  ³ ########### ³ ########### ³ ############### ³                   ³                        ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ Š®¬¨áá¨ï §  ãá¯¥å                ³ ########### ³ ########### ³ ############### ³ ################# ³ ###################### ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ à¨¡ë«ì ¢ë¯« ç¨¢ ¥¬ ï            ³ ########### ³ ########### ³ ############### ³ ################# ³ ###################### ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ à¨¡ë«ì ª ¯¨â «¨§¨àã¥¬ ï         ³ ########### ³ ########### ³ ############### ³                   ³ ###################### ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ „”‹ (®¯« ç¥­­ë¥ ¨ ­ ç¨á«¥­­ë¥   ³ ########### ³ ########### ³ ############### ³ ################# ³ ###################### ³
  ³ áã¬¬ë à áç¨âë¢ îâáï ®â ­ ç «     ³             ³             ³                 ³                   ³                        ³
  ³ ­ «®£®¢®£® £®¤                   ³             ³             ³                 ³                   ³                        ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ Š ¯¨â « ¢ ã¯à ¢«¥­¨¨             ³             ³ ########### ³                 ³                   ³                        ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ ”¨­ ­á®¢ë© à¥§ã«ìâ â §         ³             ³ ########### ³                 ³                   ³                        ³
  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
  ³ ”¨­ ­á®¢ë© à¥§ã«ìâ â á ­ ç «     ³             ³ ########### ³                 ³                   ³                        ³
  ³ áà®ª  ¤¥©áâ¢¨ï ¤®£®¢®à           ³             ³             ³                 ³                   ³                        ³]
 (
    T_A31_1, T_A31_2, StartDate12, T_A51, T_A52,
    T_A34_3, T_A34_3, StartDate12,
    T_A32_1, T_A32_2, StartDate3,  T_A53, T_A54,
    T_A34_4, T_A34_5, StartDate4,  T_A55, T_A56,
    T_A34_6, T_A34_7, StartDate5,         T_A57,
    T_A35_1, T_A35_2, StartDate6,  T_A58, T_A59,
             T_A41,
             T_A60,
             T_A61
                      );

END;

PRIVATE MACRO ReportCalcItogsByOrder( ServOp:TRecHandler, OrderFD:TS_OrderFD, Set )
   PrintItogHeaderByOrder( OrderFD );
   PrintItogBodyByOrder( ServOp, Set, OrderFD );
END;

PRIVATE MACRO Ž¡à ¡®â âìŽè¨¡ª¨®Š®¬¨áá¨ï¬( OrderFD:TS_OrderFD, ServOp:TRecHandler, ComM:bool )

   var Query, DataSet;

   Query = RSDCommand( " SELECT count(1) nRec   " +
                       "   FROM DTSTOTAL_DBT    " +
                       "  WHERE t_OrderID   = ? " +
                       "    AND t_BeginDate = ? " +
                       "    AND t_TotalType = ? " +
                       "    AND t_Sign      > 0 " +
                       "    AND t_EventID   = ? " );
   Query.addParam( "", RSDBP_IN, OrderFD.Order().rec.ID );
   Query.addParam( "", RSDBP_IN, ServOp.rec.StepDate    );
   Query.addParam( "", RSDBP_IN, TS_IIF(ComM, „“_ˆ’Žƒ__Šã¯à, „“_ˆ’Žƒ__Šãá¯) );
   Query.addParam( "", RSDBP_IN, TS_DemandEvent("98")   );
   Query.execute();
   DataSet = TRSBDataSet(Query);
   if( DataSet.MoveNext() and (DataSet.nRec > 0) )
      var ComPeriod:integer = 0;
      if( ®«ãç¨âì®¬¥àŠ®¬¨áá¨¨( OrderFD.Order().rec.SfContrID, TS_IIF(ComM, "TSM", "TSS"), ServOp.rec.StepDate, @ComPeriod ) > 0 )
         var Month, Year, Str;
         DateSplit(ServOp.rec.StepDate, null, Month, Year);
         if( ComPeriod == TS_SV_PERIOD_CALC_DAY )
            Str = "§  " + ServOp.rec.StepDate;
         elif( ComPeriod == TS_SV_PERIOD_CALC_MONTH )
            Str = "§  " + DL_GetNameAlg( 2260, Month ) + " " + Year + "£.";
         elif( ComPeriod == TS_SV_PERIOD_CALC_QUARTER )
            Str = "§  " + DL_GetNameAlg( 996, (Month-1) / 3 + 1 ) + " " + Year + "£.";
         elif( ComPeriod == TS_SV_PERIOD_CALC_YEAR )
            Str = "§  " + Year + "£.";
         end;
      end;

      println(" „«ï ¤®£®¢®à  ü " + OrderFD.Number() + " ­ ç¨á«¥­¨¥ ª®¬¨áá¨¨ §  " + TS_IIF(ComM, "ã¯à ¢«¥­¨¥ ", "ãá¯¥å ") + Str + " ã¦¥ ¢ë¯®«­ï«®áì.");
   else
      if( CheckOrderComiss( OrderFD.Order().rec.SfContrID, ServOp.rec.StepDate, TS_IIF(ComM, 1, 2) ) <= 0 )
         println(" „«ï ¤®£®¢®à  ü " + OrderFD.Number() + " ­¥ ¢ë¯®«­ïîâáï ãá«®¢¨ï ­ ç¨á«¥­¨ï ª®¬¨áá¨¨ §  " + TS_IIF(ComM, "ã¯à ¢«¥­¨¥.", "ãá¯¥å."));
      end;
   end;
END;

/*®âç¥â ® ¢ë¯®«­¥­¨¨ ¤«ï ˆ„„“*/
PRIVATE MACRO ReportCalcItogsIDDU( ServOp:TRecHandler )
  var OrderFD:TS_OrderFD;
  var ExcludeOrders = TArray();
  var i:integer = 0;
  var FromServiceOper:bool = true;
  var DprtCode = "";

  if( TS_RunFromServiceOper( ServOp ) != true )
    FromServiceOper = false;
    if( „®£®¢®à ®Ž¯¥à æ¨¨( ServOp ) != 0 )
      return;
    end;
  end;

  CB_GetDepartmentCodeAndName( ServOp.rec.Department, DprtCode );

[
            à®â®ª®« ®¯¥à æ¨¨ ¯®¤¢¥¤¥­¨ï ¨â®£®¢ ¤®¢¥à¨â¥«ì­®£® ã¯à ¢«¥­¨ï
                     „ â  ®ª®­ç ­¨ï à áç¥â­®£® ¯¥à¨®¤  # 
 ”¨«¨ « #
 „ â  ®¯¥à æ¨¨ ########## 
 Š®¤ ®¯¥à æ¨¨ # 
]( ServOp.rec.StepDate, DprtCode,ServOp.rec.OperDate, ServOp.rec.Code );

  VAR Query = RSDCommand( " select * from DTSCALCITOGS_TMP " );
  Query.execute();

  var DataSet = TRSBDataSet(query);

  PrintItogHeader();
  while( DataSet.MoveNext() )
    OrderFD = TS_OrderFD( 0, int(SQL_ConvTypeInteger(DataSet.OrderID)) );
    if( DataSet.Exclude != "X" )
      ReportCalcItogsByOrder( ServOp, OrderFD, DataSet );
    else
      ExcludeOrders[i] = OrderFD.Number();
      i = i + 1;
     end;
  end;

  PrintItogFoot( FromServiceOper );

  i = 0;
  while( i < ExcludeOrders.size )
    PrintExclude( ExcludeOrders[i] );
    i = i + 1;
  end;

  /* …á«¨ ®¯¥à æ¨ï ¢ë¯®«­ï¥âáï ¤«ï á¯¨áª  ¤®£®¢®à®¢, áä®à¬¨à®¢ ­­®£® ¯®«ì§®¢ â¥«¥¬,
     â® ¤«ï ª ¦¤®£® ¤®£®¢®à  ¨§ á¯¨áª , ¤«ï ª®â®à®£® ­¥ ¢ë¯®«­ïîâáï ãá«®¢¨ï ®â¡®à ,
     ¢ ¯à®â®ª®« ®¯¥à æ¨¨ ¢ë¤ ¥âáï á®®¡é¥­¨¥ á ¯à¨ç¨­®© ¨áª«îç¥­¨ï íâ®£® ¤®£®¢®à  ¨§ ®¡à ¡®âª¨ */
  if( ServOp.rec.IsManual == SET_CHAR )
     var Query1, DataSet1;
     if( TS_RunFromServiceOper( ServOp ) != true )
        Query1 = RSDCommand( " SELECT distinct tsorder.t_ID                                                       " +
                             "   FROM dtssrvobj_dbt srvobj, dtsorder_dbt tsorder                                  " +
                             "  WHERE srvobj.t_SrvOpID    = ?                                                     " +
                             "    AND srvobj.t_ObjectKind = ?                                                     " +
                             "    AND tsorder.t_ID        = srvobj.t_ObjectID                                     " +
                             "    AND not exists ( SELECT ord.t_ID                                                " +
                             "                       FROM dtsorder_dbt ord, doproper_dbt opr                      " +
                             "                      WHERE ord.t_ID         = tsorder.t_ID                         " +
                             "                        AND ord.t_DocKind    = ?                                    " +
                             "                        AND opr.t_DocumentID = lpad(ord.T_ID, 34, '0')              " +
                             "                        AND opr.t_DocKind    = ord.T_DocKind                        " +
                             "                        AND exists ( SELECT st.t_ID_Step                            " +
                             "                                       FROM doprstep_dbt st                         " +
                             "                                      WHERE st.t_ID_Operation  = opr.t_ID_Operation " +
                             "                                        AND st.t_IsRemoveStep != chr(0)             " +
                             "                                        AND st.t_ServDocKind   = ?                  " +
                             "                                        AND st.t_ServDocID     = ?                  " +
                             "                                   )                                                " +
                             "                   )                                                                " );
        Query1.addParam( "", RSDBP_IN, ServOp.rec.ID         );
        Query1.addParam( "", RSDBP_IN, TS_DOC_IDDU           );
        Query1.addParam( "", RSDBP_IN, TS_DOC_IDDU           );
        Query1.addParam( "", RSDBP_IN, TS_DOC_CALCITOGS_IDDU );
        Query1.addParam( "", RSDBP_IN, ServOp.rec.ID         );
     else
        Query1 = RSDCommand( " SELECT distinct tsorder.t_ID                          " +
                             "   FROM dtssrvobj_dbt srvobj, dtsorder_dbt tsorder     " +
                             "  WHERE srvobj.t_SrvOpID    = ?                        " +
                             "    AND srvobj.t_ObjectKind = ?                        " +
                             "    AND tsorder.t_ID        = srvobj.t_ObjectID        " +
                             "    AND not exists ( SELECT t_OrderID                  " +
                             "                       FROM DTSCALCITOGS_TMP           " +
                             "                      WHERE t_OrderID = tsorder.t_ID ) " );
        Query1.addParam( "", RSDBP_IN, ServOp.rec.ID );
        Query1.addParam( "", RSDBP_IN, TS_DOC_IDDU   );
     end;

     Query1.execute();
     DataSet1 = TRSBDataSet(Query1);
     while( DataSet1.MoveNext() )
        OrderFD = TS_OrderFD( 0, SQL_ConvTypeInteger(DataSet1.rec.ID) );
        if( ServOp.rec.IsCalcAfterCalcPeriod == SET_CHAR )
           var MngPlan = OrderFD.MngPlan( ServOp.rec.StepDate, null, false );
           if( MngPlan != NULL )
              if( MngPlan.rec.CalcPeriod <= 0 )
                 println( " „«ï ¤®£®¢®à  ü " + OrderFD.Number() + " ­¥ § ¤ ­ à áç¥â­ë© ¯¥à¨®¤.");
              else
                 if( OrderFD.Order().rec.CalcItogDate >= ServOp.rec.StepDate )
                    var Month, Year, Str;
                    DateSplit(ServOp.rec.StepDate, null, Month, Year);
                    if( MngPlan.rec.CalcPeriod == TS_CALCPERIOD_MNGPLN_DAY )
                       Str = "§  " + ServOp.rec.StepDate;
                    elif( MngPlan.rec.CalcPeriod == TS_CALCPERIOD_MNGPLN_MONTH )
                       Str = "§  " + DL_GetNameAlg( 2260, Month ) + " " + Year + "£.";
                    elif( MngPlan.rec.CalcPeriod == TS_CALCPERIOD_MNGPLN_QUARTAL )
                       Str = "§  " + DL_GetNameAlg( 996, (Month-1) / 3 + 1 ) + " " + Year + "£.";
                    elif( MngPlan.rec.CalcPeriod == TS_CALCPERIOD_MNGPLN_HALFYEAR )
                       Str = "§  " + DL_GetNameAlg( 3260, TS_IIF(ServOp.rec.StepDate <= date(30,6,Year), 1, 2) ) + " " + Year + "£.";
                    elif(MngPlan.rec.CalcPeriod == TS_CALCPERIOD_MNGPLN_YEAR)
                       Str = "§  " + Year + "£.";
                    end;

                    println(" „«ï ¤®£®¢®à  ü " + OrderFD.Number() + " à áç¥âë " + Str + " ã¦¥ ¢ë¯®«­ï«¨áì.");
                 else
                    if( CheckOrderPeriod( OrderFD.Order().rec.ID, ServOp.rec.StepDate ) != 1 )
                       println(" „ â  ¯®¤¢¥¤¥­¨ï ¨â®£®¢ ®â«¨ç ¥âáï ®â ¤ âë ®ª®­ç ­¨ï à áç¥â­®£® ¯¥à¨®¤  ¤®£®¢®à  ü " + OrderFD.Number() + ".");
                    end;
                 end;
              end;
           end;
        end;
        if( ServOp.rec.IsChargeComM == SET_CHAR )
           Ž¡à ¡®â âìŽè¨¡ª¨®Š®¬¨áá¨ï¬( OrderFD, ServOp, true );
        end;
        if( ServOp.rec.IsChargeComS == SET_CHAR )
           Ž¡à ¡®â âìŽè¨¡ª¨®Š®¬¨áá¨ï¬( OrderFD, ServOp, false );
        end;
     end;
  end;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

/*®âç¥â ® ¢ë¯®«­¥­¨¨ ¤«ï Ž”“*/
PRIVATE MACRO ReportCalcItogsOFBU( ServOp:TRecHandler )
  var OrderFD:TS_OrderFD;
  var ExcludeOrders = TArray();
  var i:integer = 0;
  var FromServiceOper:bool = true;
  var Str2 = "", Year:integer = 0;
  var MngPlan = TRecHandler( "tsmngpln.dbt" );

  if( TS_RunFromServiceOper( ServOp ) != true )
    FromServiceOper = false;
    if( „®£®¢®à ®Ž¯¥à æ¨¨( ServOp ) != 0 )
      return;
    end;
  end;

  OrderFD = TS_OrderFD( 0, ServOp.rec.OrderID );
  MngPlan = OrderFD.MngPlan(ServOp.rec.OperDate);
  DateSplit(ServOp.rec.BegDate, null, null, Year);

  if(ServOp.rec.Period == TS_SRVOP_PERIOD_DAY)
     Str2 = "§  " + ServOp.rec.BegDate;
  elif((ServOp.rec.Period >= TS_SRVOP_PERIOD_JANUARY) and (ServOp.rec.Period <= TS_SRVOP_PERIOD_DECEMBER))
     Str2 = "§  " + DL_GetNameAlg( 2260, ServOp.rec.Period ) + " " + Year + "£.";
  elif((ServOp.rec.Period >= TS_SRVOP_PERIOD_I_QUARTER) and (ServOp.rec.Period <= TS_SRVOP_PERIOD_IV_QUARTER))
     Str2 = "§  " + DL_GetNameAlg( 996, ServOp.rec.Period - 12 ) + " " + Year + "£.";
  elif(ServOp.rec.Period == TS_SRVOP_PERIOD_YEAR)
     Str2 = "§  " + Year + "£.";
  end;

[
                           ‚¥¤®¬®áâì à á¯à¥¤¥«¥­¨ï ¯à¨¡ë«¨ ¯® Ž”“ #
                                            #
]( OrderFD.Order().rec.RegNum + " " + OrderFD.Order().rec.Name + " " +
   TS_IIF(MngPlan.rec.CalcPeriod, Str2, ""),
   TS_IIF(not MngPlan.rec.CalcPeriod, " áç¥â­ë© ¯¥à¨®¤ á " + ServOp.rec.BegDate + " ¯® " + ServOp.rec.EndDate, "")
 );

  VAR Query = RSDCommand( " select * from DTSCALCITOGS_TMP order by t_Sort, t_OrderID " );
  Query.execute();

  var DataSet = TRSBDataSet(query);
  i = 1;
  PrintOFBUItogHeader();
  while( DataSet.MoveNext() )
    OrderFD = TS_OrderFD( 0, int(SQL_ConvTypeInteger(DataSet.OrderID)) );
    if( DataSet.Sort == 0)
       PrintOFBUItogLine( i, OrderFD.Trustor().rec.Name, 
                             Int(DataSet.A7),
                             OrderFD.Š ¯¨â «“çà¥¤¨â¥«ï(ServOp.rec.EndDate),
                             OrderFD.‘à¥¤­¥¢§¢¥è¥­­ë©Š ¯¨â «(ServOp.rec.EndDate),  
                             money(DataSet.A23_2),
                             money(DataSet.A30),
                             money(DataSet.A23_2) - money(DataSet.A30) );
    else
       PrintOFBUItogLine( "", "ˆ’ŽƒŽ:", 
                              "",
                              OrderFD.Š ¯¨â «“çà¥¤¨â¥«ï(ServOp.rec.EndDate),
                              OrderFD.‘à¥¤­¥¢§¢¥è¥­­ë©Š ¯¨â «(ServOp.rec.EndDate), 
                              money(DataSet.A23_2),
                              money(DataSet.A30),
                              money(DataSet.A23_2) - money(DataSet.A30) );
    end;
    i = i + 1;
  end;

  PrintOFBUItogFoot( FromServiceOper );

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

PRIVATE MACRO ReportOvervalue( ServOp:TRecHandler )
  VAR DprtCode = "";

  CB_GetDepartmentCodeAndName( ServOp.rec.Department, DprtCode );

[   
            à®â®ª®« ®¯¥à æ¨¨ ¯¥à¥®æ¥­ª¨ æ/¡ ¯® ’‘‘
 ”¨«¨ « #
 „ â  ®¯¥à æ¨¨ ##########  Š®¤ ®¯¥à æ¨¨ # 
]( DprtCode, ServOp.rec.OperDate, ServOp.rec.Code );

  à®¢®¤ª¨®Ž¯¥à æ¨¨( ServOp );
END;

PRIVATE MACRO ReportFurl( ServOp:TRecHandler )
  VAR DprtCode = "";

  CB_GetDepartmentCodeAndName( ServOp.rec.Department, DprtCode );

[   
            à®â®ª®« ®¯¥à æ¨¨ á¢¥àâª¨ áç¥â®¢ ¤®å®¤®¢/à áå®¤®¢
 ”¨«¨ « #
 „ â  ®¯¥à æ¨¨ ##########  Š®¤ ®¯¥à æ¨¨ # 
 „ â  á¢¥àâª¨ áç¥â®¢ ##########
]( DprtCode, ServOp.rec.OperDate, ServOp.rec.Code, ServOp.rec.StepDate );

  à®¢®¤ª¨®Ž¯¥à æ¨¨( ServOp );
END;


PRIVATE MACRO ReportPrDs( ServOp:TRecHandler )
  VAR DprtCode = "";
  VAR query, IssuerData, DataSet;
  VAR i = 0, j = 0, printdisc = false;

  
  //¯® ¢¥ªá¥«ï¬
  if(ServOp.rec.IsBill == "X")
    CB_GetDepartmentCodeAndName( ServOp.rec.Department, DprtCode );
    

    query =   " select distinct(bnr.t_Issuer), t_IssuerName "
            + "   from dvsbanner_dbt bnr, dvsincome_dbt inc, doprdocs_dbt odoc "
            + "  where odoc.t_ServDocKind = " + ServOp.rec.Kind_Operation
            + "    and odoc.t_ServDocID = " + ServOp.rec.ID
            + "    and odoc.t_DocKind = " + DL_VSINCOME
            + "    and inc.t_AutoKey = TO_NUMBER(odoc.t_DocumentID) "
            + "    and (inc.t_PercDoc > 0 OR inc.t_DiscDoc > 0 )"
            + "    and bnr.t_BCID = inc.t_BCID ";
    IssuerData = TRsbDataSet(query);
    while(IssuerData.moveNext())
      printdisc = false;

      if(j == 0)
        [   
         ”¨«¨ « #

                                    €—ˆ‘‹…ˆ… „Ž•Ž„Ž‚ Ž ‚…Š‘…‹ŸŒ ˆ €ŠŽ‚‘ŠˆŒ ‘…’ˆ”ˆŠ€’€Œ
         ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
         ³    „®£®¢®à     ³  Š®«-¢® æ/¡  ³         ‘ç¥â „â         ³         ‘ç¥â Šâ         ³  ‘ã¬¬  ­ ç¨á«¥­¨ï (àã¡.)  ³
        ]( DprtCode );
      end;

      [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
       ³###############################################################################################################³
       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
      ]( IssuerData.IssuerName );
      
      //¯® ¤¨áª®­âã
      query =   " select distinct(arh.t_AccTrnID), arh.*, (select count(1) from dvsincome_dbt ic where ic.t_DiscDoc = arh.t_AccTrnID) as cnt"
              + "   from dvsbanner_dbt bnr, dvsincome_dbt inc, doprdocs_dbt odoc, dacctrn_dbt arh "
              + "  where odoc.t_ServDocKind = " + ServOp.rec.Kind_Operation
              + "    and odoc.t_ServDocID = " + ServOp.rec.ID
              + "    and odoc.t_DocKind = " + DL_VSINCOME
              + "    and inc.t_AutoKey = TO_NUMBER(odoc.t_DocumentID) "
              + "    and arh.t_AccTrnID = inc.t_DiscDoc "
              + "    and arh.t_State = 1 "/*ä ªâ¨ç¥áª ï ¯à®¢®¤ª */
              + "    and bnr.t_BCID = inc.t_BCID "
              + "    and bnr.t_Issuer = " + IssuerData.Issuer;
     
      DataSet = TRsbDataSet(query);
      i = 0;
      while(DataSet.moveNext())
        printdisc = true;
        if(i == 0)
          [³„¨áª®­â­ë¥ ¤®å®¤ë                                                                                              ³
           ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
          ];
        else
          [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
          ];
        end;

          [³################³##############³#########################³#########################³###########################³
          ](DataSet.Numb_Document:c, int(DataSet.cnt):c, DataSet.Account_Payer:c, DataSet.t_Account_Receiver:c, DataSet.Sum_Payer:c );

        i = i + 1;
      end;

      //¯® ¯à®æ¥­â ¬
      query =   " select distinct(arh.t_AccTrnID), arh.*, (select count(1) from dvsincome_dbt ic where ic.t_PercDoc = arh.t_AccTrnID) as cnt "
              + "   from dvsbanner_dbt bnr, dvsincome_dbt inc, doprdocs_dbt odoc, dacctrn_dbt arh "
              + "  where odoc.t_ServDocKind = " + ServOp.rec.Kind_Operation
              + "    and odoc.t_ServDocID = " + ServOp.rec.ID
              + "    and odoc.t_DocKind = " + DL_VSINCOME
              + "    and inc.t_AutoKey = TO_NUMBER(odoc.t_DocumentID) "
              + "    and arh.t_State = 1 "/*ä ªâ¨ç¥áª ï ¯à®¢®¤ª */
              + "    and arh.t_AccTrnID = inc.t_PercDoc "
              + "    and bnr.t_BCID = inc.t_BCID "
              + "    and bnr.t_Issuer = " + IssuerData.Issuer;
     
      DataSet = TRsbDataSet(query);
      i = 0;
      while(DataSet.moveNext())
        if(i == 0)
          if(printdisc)
            [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
          end;

          [³à®æ¥­â­ë¥ ¤®å®¤ë                                                                                              ³
           ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
          ];
        else
          [ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
          ];
        end;

          [³################³##############³#########################³#########################³###########################³
          ](DataSet.Numb_Document:c, int(DataSet.cnt):c, DataSet.Account_Payer:c, DataSet.t_Account_Receiver:c, DataSet.Sum_Payer:c );

        i = i + 1;
      end;

      j = j + 1;
    end;
    if((i > 0) or (printdisc))
      [ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
    end;
  end;
END;

/************************************************************************************************
  ¥ç âì ®âç¥â  ® ¢ë¯®«­¥­¨¨ ®¯¥à æ¨¨ ­ ç¨á«¥­¨ï ª®¬¨áá¨¨ §  ã¯à ¢«¥­¨¥ „Ž”“
*************************************************************************************************/
PRIVATE MACRO PrintChargeComHeader(RateCom)
  var Header = "ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
               "³  ü  ³         „®£®¢®à           ³             “çà¥¤¨â¥«ì              ³     „­¥© ¢      ³    ‘ã¬¬  ¨¬ãé¥áâ¢ ,   ³  ‘à.¢§¢. ¯® áà®ªã   ³     ‚®§­ £à ¦¤¥­¨¥     ³\n" +
               "³     ³                           ³                                     ³ ã¯à ¢«¥­¨¨ ¢  ³    ¯¥à¥¤ ­­®£® ¢ „“   ³   ¤®«ï ãçà¥¤¨â¥«ï ¢   ³ " + string(RateCom:6) + "% (£®¤®¢®©)      ³\n" +
               "³     ³                           ³                                     ³                 ³                       ³     ª ¯¨â «¥ Ž”“     ³                        ³";
  println(Header);
END;

PRIVATE MACRO PrintChargeComLine( C1, C2, C3, C4, C5, C6, C7 )
[ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ ### ³ ######################### ³#################################### ³ ############### ³ ##################### ³ ##################### ³ ###################### ³
](C1, C2, C3, C4, C5, C6, C7 );
END;


PRIVATE MACRO PrintChargeComFoot()
[ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
END;

PRIVATE MACRO ReportChargeCom( ServOp:TRecHandler )

  var OrderFD:TS_OrderFD;
  var Str1:string = "", Str2:string = "";
  var Year;
  var i:integer = 0;
  var RateCom = 0;

  OrderFD = TS_OrderFD( 0, ServOp.rec.OrderID );
  DateSplit( ServOp.rec.EndDate, NULL, NULL, Year );
  Str1 = OrderFD.Number() + " " + OrderFD.Name();

  if(ServOp.rec.Period == TS_SRVOP_PERIOD_USER)
     Str2 = "à áç¥â­ë© ¯¥à¨®¤ á " + ServOp.rec.BegDate + " ¯® " + ServOp.rec.EndDate;
  elif(ServOp.rec.Period == TS_SRVOP_PERIOD_DAY)
     Str2 = "§  " + ServOp.rec.BegDate;
  elif((ServOp.rec.Period >= TS_SRVOP_PERIOD_JANUARY) and (ServOp.rec.Period <= TS_SRVOP_PERIOD_DECEMBER))
     Str2 = "§  " + DL_GetNameAlg( 2260, ServOp.rec.Period ) + " " + Year + "£.";
  elif((ServOp.rec.Period >= TS_SRVOP_PERIOD_I_QUARTER) and (ServOp.rec.Period <= TS_SRVOP_PERIOD_IV_QUARTER))
     Str2 = "§  " + DL_GetNameAlg( 996, ServOp.rec.Period - 12 ) + " " + Year + "£.";
  elif(ServOp.rec.Period == TS_SRVOP_PERIOD_YEAR)
     Str2 = "§  " + Year + "£.";
  end;

[
            ‚¥¤®¬®áâì ­ ç¨á«¥­­ëå ¢®§­ £à ¦¤¥­¨© §  ã¯à ¢«¥­¨¥ ¯® Ž”“ #
                            #
]( Str1, Str2 );

  if( TS_RunFromServiceOper( ServOp ) != true )
    if( „®£®¢®à ®Ž¯¥à æ¨¨Š( ServOp ) != 0 )
      return;
    end;
  end;

  ®«ãç¨âì‘â ¢ªãŠ®¬¨áá¨¨(OrderFD.SfContr.rec.ID, ®«ãç¨âì®¬¥àŠ®¬¨áá¨¨(OrderFD.SfContr.rec.ID, "TSM", ServOp.rec.EndDate), null, null, @RateCom, null);

  var Query = RSDCommand( " select * from DTSCALCITOGS_TMP order by t_Sort, t_OrderID " );
  Query.execute();

  var DataSet = TRSBDataSet(query);
  i = 1;
  PrintChargeComHeader(RateCom);
  while( DataSet.MoveNext() )
    OrderFD = TS_OrderFD( 0, SQL_ConvTypeInteger(DataSet.OrderID) );
    if( DataSet.Sort == 0)
       PrintChargeComLine( i, OrderFD.Number(),
                           OrderFD.Trustor().rec.Name,
                           SQL_ConvTypeInteger(DataSet.A7),
                           OrderFD.Š ¯¨â «“çà¥¤¨â¥«ï(SQL_ConvTypeDate(DataSet.A8_2)),
                           SQL_ConvTypeSum(DataSet.A9),
                           SQL_ConvTypeSum(DataSet.A31_2) );
    else
       PrintChargeComLine( "", "", 
                           "ˆ’ŽƒŽ:",
                           "", "", 
                           SQL_ConvTypeSum(DataSet.A9),
                           SQL_ConvTypeSum(DataSet.A31_2) );
    end;
    i = i + 1;
  end;

  PrintChargeComFoot();

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

/************************************************************************************************
  ¥ç âì ®âç¥â  ® ¢ë¯®«­¥­¨¨ ®¯¥à æ¨¨ ‡
*************************************************************************************************/
PRIVATE MACRO PrintPrClHeader()
  var Header = "ÚÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
               "³  ü  ³         „®£®¢®à           ³            “çà¥¤¨â¥«ì             ³   ¥à¨®¤   ³  ‘à.¢§¢. ¤®«ï ãçà¥¤¨â¥«ï ³ à¨¡ë«ì ãçà¥¤¨â¥«ï §  ³  Š®¬¨áá¨ï §  ãá¯¥è­®¥ ³       „”‹      ³   ç¨á«¥­­ ï/¢ë¢¥¤¥­­ ï/   ³ Š®¬¯¥­á æ¨ï £ à ­â. ³ Š®¬¯¥­á æ¨ï £ à ­â. ³\n" +
               "³     ³                           ³                                   ³ ã¯à ¢«¥­¨ï ³     ¢ ª ¯¨â «¥ Ž”“      ³  áà®ª ¤®£®¢®à  (àã¡.) ³     ã¯à ¢«¥­¨¥        ³                 ³ ª ¯¨â «¨§¨à®¢ ­­ ï ¯à¨¡ë«ì ³  ¢®§¢à â  ª ¯¨â «   ³       ¯à¨¡ë«¨       ³\n" +
               "³     ³                           ³                                   ³            ³     §  áà®ª ¤®£®¢®à      ³                       ³                       ³                 ³                            ³                     ³                     ³";
  println(Header);
END;

PRIVATE MACRO PrintPrClLine( C1, C2, C3, C4, C5, C6, C7, C8, C9, C10, C11 )
[ÃÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³ ### ³ ######################### ³################################## ³ ########## ³ ######################## ³ ##################### ³ ##################### ³ ############### ³ ########################## ³ ################### ³ ################### ³
](C1, C2, C3, C4, C5, C6, C7, C8, C9, C10, C11 );
END;


PRIVATE MACRO PrintPrClFoot()
[ÀÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
END;

PRIVATE MACRO ReportPrCl( ServOp:TRecHandler )

  var OrderFD:TS_OrderFD;
  var Str1:string = "", Str2:string = "";
  var Year;
  var i:integer = 0;

  OrderFD = TS_OrderFD( 0, ServOp.rec.OrderID );
  DateSplit( ServOp.rec.BegDate, NULL, NULL, Year );
  Str1 = OrderFD.Order().rec.RegNum + " " + OrderFD.Order().rec.Name;

  if(ServOp.rec.Period == TS_SRVOP_PERIOD_USER)
     Str2 = "à áç¥â­ë© ¯¥à¨®¤ á " + ServOp.rec.BegDate + " ¯® " + ServOp.rec.EndDate;
  elif(ServOp.rec.Period == TS_SRVOP_PERIOD_DAY)
     Str2 = "§  " + ServOp.rec.BegDate;
  elif((ServOp.rec.Period >= TS_SRVOP_PERIOD_JANUARY) and (ServOp.rec.Period <= TS_SRVOP_PERIOD_DECEMBER))
     Str2 = "§  " + DL_GetNameAlg( 2260, ServOp.rec.Period ) + " " + Year + "£.";
  elif((ServOp.rec.Period >= TS_SRVOP_PERIOD_I_QUARTER) and (ServOp.rec.Period <= TS_SRVOP_PERIOD_IV_QUARTER))
     Str2 = "§  " + DL_GetNameAlg( 996, ServOp.rec.Period - 12 ) + " " + Year + "£.";
  elif(ServOp.rec.Period == TS_SRVOP_PERIOD_YEAR)
     Str2 = "§  " + Year + "£.";
  end;

[
            à®â®ª®« à áç¥â®¢ ¯® ¯à®«®­£¨à®¢ ­­ë¬ ¨ § ªàëâë¬ ¤®£®¢®à ¬ ¯à¨á®¥¤¨­¥­¨ï ¯® Ž”“ #
                            #
]( Str1, Str2 );

  if( TS_RunFromServiceOper( ServOp ) != true )
    if( „®£®¢®à ®Ž¯¥à æ¨¨‡( ServOp ) != 0 )
      return;
    end;
  end;

  var Query = RSDCommand( " select * from DTSCALCITOGS_TMP order by t_Sort, t_OrderID " );
  Query.execute();

  var DataSet = TRSBDataSet(query);
  i = 1;
  PrintPrClHeader();
  while( DataSet.MoveNext() )
    OrderFD = TS_OrderFD( 0, SQL_ConvTypeInteger(DataSet.OrderID) );
    if( DataSet.Sort != 2)
       PrintPrClLine( i, OrderFD.Order().rec.RegNum,
                      OrderFD.Trustor().rec.Name,
                      SQL_ConvTypeInteger(DataSet.A7),
                      SQL_ConvTypeSum(DataSet.A9),
                      SQL_ConvTypeSum(DataSet.A23_2),
                      SQL_ConvTypeSum(DataSet.A32_2),
                      SQL_ConvTypeSum(DataSet.A38_2),
                      SQL_ConvTypeSum(DataSet.A35_2) + SQL_ConvTypeSum(DataSet.A36_2) + SQL_ConvTypeSum(DataSet.A37_2),
                      SQL_ConvTypeSum(DataSet.A42_2),
                      SQL_ConvTypeSum(DataSet.A41_2) );
    else
       PrintPrClLine( "", "", 
                      "ˆ’ŽƒŽ:",
                      "",
                      SQL_ConvTypeSum(DataSet.A9),
                      SQL_ConvTypeSum(DataSet.A23_2),
                      SQL_ConvTypeSum(DataSet.A32_2),
                      SQL_ConvTypeSum(DataSet.A38_2),
                      SQL_ConvTypeSum(DataSet.A35_2) + SQL_ConvTypeSum(DataSet.A36_2) + SQL_ConvTypeSum(DataSet.A37_2),
                      SQL_ConvTypeSum(DataSet.A42_2),
                      SQL_ConvTypeSum(DataSet.A41_2) );
    end;
    i = i + 1;
  end;

  PrintPrClFoot();

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

/************************************************************************************************
¥ç âì ®âç¥â  ® ¢ë¯®«­¥­¨¨ á¥à¢¨á­®© ®¯¥à æ¨¨
*************************************************************************************************/
MACRO TS_ServiceOperReport( ServOp:TRecHandler, ReportMode:INTEGER, ServObjID:INTEGER )

  if( (ReportMode == TS_SVOPREP_ALL) OR (ReportMode == TS_SVOPREP_REPORT) )
     if( ServOp.rec.Kind_Operation == TS_DOC_CALCITOGS_IDDU )
        ReportCalcItogsIDDU( ServOp );
     elif( ServOp.rec.Kind_Operation == TS_DOC_CALCITOGS_OFBU )
        ReportCalcItogsOFBU( ServOp );
     elif( ServOp.rec.Kind_Operation == TS_DOC_OVERVALUE )
        ReportOvervalue( ServOp );
     elif( ServOp.rec.Kind_Operation == 937/*TS_DOC_FURL*/ )
        ReportFurl( ServOp );
     elif(ServOp.rec.Kind_Operation == TS_DOC_PERDISC)
        ReportPrDs( ServOp );
     elif( ServOp.rec.Kind_Operation == TS_DOC_CHARGE_COM )
        ReportChargeCom( ServOp );
     elif( ServOp.rec.Kind_Operation == TS_DOC_CALC_PROLONG_CLOSE )
        ReportPrCl( ServOp );
     end;
  END;

  if( (ReportMode == TS_SVOPREP_ALL) OR (ReportMode == TS_SVOPREP_ERROR) )
     TS_ServiceOperErrorReport( ServOp );
  end;
END;
