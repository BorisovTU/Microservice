/* Операция РПЗ */

import TSInter, "tscateg.mac" , "tscomiss.mac", "tsfunc.mac";

private var SubPurpose = 0;
private var TmpPaymentID = -1;
private var CalcCom = DataCalcCom();

PRIVATE MACRO Exception( RslErrObj ):integer
  RemProgress();
  MsgBox( RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message);
  return 1;
END;

PRIVATE MACRO SaveItogsInBD( Order:TS_OrderFD, Itog:integer, ЗначениеИтога:money, Itogs, ServOp ):bool

   if( Order.SaveItog( Itog, round(ЗначениеИтога, 2), NATCUR, ServOp.rec.OperDate, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) != 0 )
      return false;
   end;
   return true;
END;

PRIVATE MACRO SaveAllItogsInBD(Order:TS_OrderFD, Itogs, ServOp):BOOL

   var OrderFD_OFBU = TS_OrderFD( 0, ServOp.rec.OrderID );

   if( (not SaveItogsInBD(Order, ДУ_ПУ,       Itogs.rec.A23_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_ПУ_ф,     Itogs.rec.A23_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Купр,     Itogs.rec.A30,   Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_БП,       Itogs.rec.A31,   Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Кусп,     Itogs.rec.A32_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Кусп_ф,   Itogs.rec.A32_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Пвыв_н,   Itogs.rec.A35_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Пвыв_н_ф, Itogs.rec.A35_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Пвыв_к,   Itogs.rec.A36_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Пвыв_к_ф, Itogs.rec.A36_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Пвыв_в,   Itogs.rec.A37_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Пвыв_в_ф, Itogs.rec.A37_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Нкуд,     Itogs.rec.A38_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Нкуд_ф,   Itogs.rec.A38_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_ПУост,    Itogs.rec.A40,   Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Гвк,      Itogs.rec.A42_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Гвк_ф,    Itogs.rec.A42_2, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Гбп,      Itogs.rec.A41_1, Itogs, ServOp)) OR
       (not SaveItogsInBD(Order, ДУ_Гбп_ф,    Itogs.rec.A41_2, Itogs, ServOp))
     )
      return false;
   end;

   if( OrderFD_OFBU.SaveItog( ДУ_ДлУ, round(СрВзКапиталОФБУ( ServOp.rec.OrderID ), 2), NATCUR, ServOp.rec.OperDate, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, ServOp.rec.EndDate ) != 0 )
      return false;
   end;

   return true;
END;

PRIVATE MACRO ПроверитьИтоги( OrderFD:TS_OrderFD, BeginDate:date, ISort:integer )

  var RetVal:bool = true;
  var Select1:string = "", Query1, DataSet1;
  var Select2:string = "", Query2, DataSet2;

  Select1 = Select2 = " select count(1) ExistRec " +
                      "   from dtstotal_dbt      " +
                      "  where t_OrderID   = ?   " +
                      "    and t_TotalType = ?   " +
                      "    and t_BeginDate = ?   ";
  if(ISort == 0)
     Select1 = Select1 + " and t_EventID = ? ";
  end;

  Query1 = RSDCommand(Select1);
  Query1.addParam( "", RSDBP_IN, OrderFD.ID   );
  Query1.addParam( "", RSDBP_IN, ДУ_ИТОГ_Р_ПУ );
  Query1.addParam( "", RSDBP_IN, BeginDate    );
  if(ISort == 0)
     Query1.addParam( "", RSDBP_IN, TS_DemandEvent("97") );
  end;
  Query1.execute();

  DataSet1 = TRSBDataSet(Query1);

  if( (DataSet1.MoveNext() == false) or (DataSet1.ExistRec <= 0) )
     MsgBox("По договору " + OrderFD.Number() + " не выполнено распределение прибыли за весь срок договора.");
     RetVal = false;
  end;

  if(RetVal == true)
     Query2 = RSDCommand(Select2);
     Query2.addParam( "", RSDBP_IN, OrderFD.ID     );
     Query2.addParam( "", RSDBP_IN, ДУ_ИТОГ_Н_Купр );
     Query2.addParam( "", RSDBP_IN, BeginDate      );
     Query2.execute();

     DataSet2 = TRSBDataSet(Query2);

     if( (DataSet2.MoveNext() == false) or (DataSet2.ExistRec <= 0) )
        MsgBox("По договору " + OrderFD.Number() + " не выполнено начисление комиссии за управление за весь срок договора.");
        RetVal = false;
     end;
  end;

  return RetVal;
END;

PRIVATE MACRO ЗакрытиеБылоДосрочным( OrderID:integer, BeginDate:date )

  var RetVal:bool = false;
  var Select1:string = "", Query1, DataSet1;

  Select1 = " select count(1) ExistRec " +
            "   from dtstotal_dbt      " +
            "  where t_OrderID   = ?   " +
            "    and t_TotalType = ?   " +
            "    and t_BeginDate = ?   " + 
            "    and t_Sign      > 0   ";

  Query1 = RSDCommand(Select1);
  Query1.addParam( "", RSDBP_IN, OrderID       );
  Query1.addParam( "", RSDBP_IN, ДУ_ИТОГ_Н_Кдв );
  Query1.addParam( "", RSDBP_IN, BeginDate     );
  Query1.execute();

  DataSet1 = TRSBDataSet(Query1);

  if( (DataSet1.MoveNext() == false) or (DataSet1.ExistRec > 0) )
     RetVal = true;
  end;

  return RetVal;
END;

PRIVATE MACRO ВзятьЗаписьПролонгации(OrderID:integer, pr_A36_2:@money, pr_ПУР:@money, pr_A32_2:@money)
  var RetVal:bool = false;
  var Select1:string = "", Query1, DataSet1;

  Select1 = " select t_A8_2, t_A36_2, t_A32_2, t_A35_2, t_A37_2, t_A38_2 " +
            "   from dtscalcitogs_tmp  " +
            "  where t_OrderID   = ?   " +
            "    and t_Sort      = 0   ";

  Query1 = RSDCommand(Select1);
  Query1.addParam( "", RSDBP_IN, OrderID );
  Query1.execute();

  DataSet1 = TRSBDataSet(Query1);

  if( DataSet1.MoveNext() )

     if(SQL_ConvTypeSum(DataSet1.A36_2) > 0.0)
        pr_A36_2 = SQL_ConvTypeSum(DataSet1.A36_2);
     end;

     if(SQL_ConvTypeSum(DataSet1.A32_2) > 0.0)
        pr_ПУР   = -SQL_ConvTypeSum(DataSet1.A32_2);
        pr_A32_2 = SQL_ConvTypeSum(DataSet1.A32_2);
     end;

     if( SQL_ConvTypeSum(DataSet1.A35_2) > 0.0 )
        pr_ПУР = pr_ПУР - SQL_ConvTypeSum(DataSet1.A35_2);
     elif( SQL_ConvTypeSum(DataSet1.A36_2) > 0.0 )
        pr_ПУР = pr_ПУР - (SQL_ConvTypeSum(DataSet1.A36_2) + SQL_ConvTypeSum(DataSet1.A38_2));
     elif( SQL_ConvTypeSum(DataSet1.A37_2) > 0.0 )
        pr_ПУР = pr_ПУР - (SQL_ConvTypeSum(DataSet1.A37_2) + SQL_ConvTypeSum(DataSet1.A38_2));
     end;

     RetVal = true;

  end;

  return RetVal;
END;

MACRO ПересчитатьСуммуИтоговОФБУ( ServOp:TRecHandler, OFBU:INTEGER ):INTEGER
  VAR RS, cmd;
  var OrderFD = TS_OrderFD( 0, OFBU );

  cmd = RSDCommand( " UPDATE DTSCALCITOGS_TMP " +
                    "    SET ( t_A9, t_A23_1, t_A23_2, t_A30, t_A31, t_A32_1, t_A32_2, t_A35_1, t_A35_2, t_A36_1, t_A36_2, t_A37_1, t_A37_2, t_A38_1, t_A38_2, t_A41_1, t_A41_2, t_A42_1, t_A42_2, t_CalcDateS, t_IDComS, t_BeginDateS, t_EndDateS ) = " +
                    "        ( SELECT SUM(t.t_A9), SUM(t.t_A23_1), SUM(t.t_A23_2), SUM(t.t_A30), SUM(t.t_A31), SUM(t.t_A32_1), SUM(t.t_A32_2), SUM(t.t_A35_1), SUM(t.t_A35_2), SUM(t.t_A36_1), " +
                    "                 SUM(t.t_A36_2), SUM(t.t_A37_1), SUM(t.t_A37_2), SUM(t.t_A38_1), SUM(t.t_A38_2), SUM(t_A41_1), SUM(t_A41_2), SUM(t_A42_1), SUM(t_A42_2), MAX(t_CalcDateS), MAX(t_IDComS), MIN(t_BeginDateS), MAX(t_EndDateS) " +
                    "            FROM DTSCALCITOGS_TMP t " + 
                    "           WHERE t.t_Sort in(0, 1) ) " +
                    "  WHERE t_OrderID = ? " +
                    "    AND t_Sort = ? " );

  cmd.addParam( "", RSDBP_IN, OFBU );
  cmd.addParam( "", RSDBP_IN, 2 );

  cmd.execute();

  return 0;
END;

/*Вызывается 
   - из панели, при изменении суммы в одном из полей
   - при расчете итогов по договору
*/
MACRO ПересчитатьСуммуИтогов( ServOp:TRecHandler, Itog:VARIANT /*TRecHandler или TBFile*/, ItogOld:TRecHandler ):INTEGER

  var OrderFD = TS_OrderFD( 0, Itog.rec.OrderID );
  var OrderFD_OFBU = TS_OrderFD( 0, ServOp.rec.OrderID );
  var MngPlan = TRecHandler( "tsmngpln.dbt" );
  var Пвыв_в = $0, Пвыв_к = $0, Пвыв_н = $0;
  var КГбп = $0, КГвк = $0;
  var IsFullCalc = false, ИзмКусп = false, ИзмПвыв = false, ИзмНДФЛ = false, ИзмКГбп = false, ИзмКГвк = false;
  var EndCalcDateComiss = GetEndCalcDateComiss(Itog.rec.A8_2);
  var ПУ1 = $0, РПУ1= $0, РПУ2= $0, ПУ2 = $0, DP = $0, Кдв1 = $0, Кдв2 = $0;
  var ПУР = $0, Купр1 = $0, Купр2 = $0, Нкуд = $0, Кусп = $0, Кусп1 = $0.0, Кусп2 = $0.0, ПП = $0.0;
  var ЕстьЗаписьПролонгации:bool = false, ChangeDate:date;
  var pr_A36_2:money = $0.0, pr_ПУР:money = $0.0, pr_A32_2:money = $0.0;

  MngPlan = OrderFD_OFBU.MngPlan(Itog.rec.A8_2);

  if( ItogOld != NULL )
     /* Флаги изменений взведём, но пока обрабатывать не будем*/
     if( Itog.rec.A32_2 != ItogOld.rec.A32_2 )
        ИзмКусп = true;
     end;

     if( (Itog.rec.A35_2 != ItogOld.rec.A35_2) or
         (Itog.rec.A36_2 != ItogOld.rec.A36_2) or
         (Itog.rec.A37_2 != ItogOld.rec.A37_2)
       )
        ИзмПвыв = true;
     end;

     if( Itog.rec.A38_2 != ItogOld.rec.A38_2 )
        ИзмНДФЛ = true;
     end;

     if( Itog.rec.A41_2 != ItogOld.rec.A41_2 )
        ИзмКГбп = true;
     end;

     if( Itog.rec.A42_2 != ItogOld.rec.A42_2 )
        ИзмКГвк = true;
     end;
  else /*полный расчет итогов*/
     IsFullCalc = true;
  end;

  if( IsFullCalc )

     if(ПроверитьИтоги(OrderFD, Itog.rec.A8_2, Itog.rec.Sort) == false)
        return 1;
     end;

     if(Itog.rec.Sort == 1)
        ВзятьЗаписьПролонгации(OrderFD.ID, @pr_A36_2, @pr_ПУР, @pr_A32_2);
     end;

     /* Дсрвзв за ПДД */
     Itog.rec.A9 = OrderFD.СредневзвешенныйКапиталЗаПериод( Itog.rec.A8_1, Itog.rec.A8_2, false, TS_IIF((Itog.rec.Sort == 0), false, true) );

     /* Расчет базовой прибыли */
     Itog.rec.A31 = OrderFD.СуммаБазовойПрибыли( EndCalcDateComiss, Itog.rec.A8_1, true, pr_A36_2 );

     /* Расчет комиссии за успех ДП */
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_1, @Кдв1 ) != 0 )
        return 1;
     end;
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, EndCalcDateComiss, @Кдв2 ) != 0 )
        return 1;
     end;

     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_1, @РПУ1 ) != 0 )
        return 1;
     end;
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, EndCalcDateComiss, @РПУ2 ) != 0 )
        return 1;
     end;

     DP = max(0, ( (РПУ2-РПУ1) - Itog.rec.A31/*БП*/ - (Кдв2 - Кдв1) ) );

     if( РасчетКомиссииБанкаЗаУспех( OrderFD, ServOp.rec.ID, EndCalcDateComiss, TS_ComissSum( DP, NATCUR ), TS_IIF((Itog.rec.Sort == 0), ПролонгацияДоговора, ЗакрытиеДоговора), @CalcCom.ConCom_S, @CalcCom.sfdefcom_parm_S ) != 0 )
        MsgBox( "Ошибка при расчете комиссии за успех." );
        return 1;
     end;
     Itog.rec.CalcDateS  = EndCalcDateComiss;
     Itog.rec.IDComS     = CalcCom.ConCom_S.rec.ID;
     Itog.rec.BeginDateS = CalcCom.sfdefcom_parm_S.rec.DateBegin;
     Itog.rec.EndDateS   = CalcCom.sfdefcom_parm_S.rec.DateEnd;
     Itog.rec.A32_2      = Itog.rec.A32_1 = Кусп = CalcCom.sfdefcom_parm_S.rec.CommSum;

     /* Определение распределенной, но еще не начисленной прибыли */
     var NoCalc = false;
     if( MngPlan.rec.CalcAfterCalcPeriod != "X" )
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_2, NULL, NULL, @ПУР ) != 0 )
           return 1;
        end;
     else
        if( (ЭтоКапитализация(MngPlan.rec.Flag3) == false) and (ЭтоВыплата(MngPlan.rec.Flag3) == false) and (ЭтоНачисление(MngPlan.rec.Flag3) == false) )
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_2, NULL, NULL, @ПУР ) != 0 )
              return 1;
           end;
        else
           ПУР = $0;
           Пвыв_в = $0;
           Пвыв_к = $0;
           Пвыв_н = $0;
           NoCalc = true;
        end;
     end;
     ПУР = ПУР + pr_ПУР;
     Itog.rec.A23_2 = Itog.rec.A23_1 = ПУР;

     /* Вывод прибыли */
     if( NoCalc == false )
        if(Itog.rec.Sort == 0)
           if( ЭтоКапитализация(MngPlan.rec.Flag1) or ЭтоВыплата(MngPlan.rec.Flag1) or ЭтоНачисление(MngPlan.rec.Flag1) )
              Пвыв_в = $0;
              Пвыв_к = $0;
              Пвыв_н = $0;
              if( ЭтоВыплата(MngPlan.rec.Flag1) )
                 Пвыв_в = max(0, (ПУР - Кусп));
              elif( ЭтоКапитализация(MngPlan.rec.Flag1) )
                 Пвыв_к = max(0, (ПУР - Кусп));
              elif( ЭтоНачисление(MngPlan.rec.Flag1) )
                 if(TS_ExistProfitReq(OrderFD.ID, ServOp.rec.StepDate) > 0)
                    Пвыв_н = max(0, (ПУР - Кусп));
                 else
                    if( ЭтоКапитализация(MngPlan.rec.OnApplOnly) )
                       Пвыв_к = max(0, (ПУР - Кусп));
                    else
                       Пвыв_н = max(0, (ПУР - Кусп));
                    end;
                 end;
              end;
           end;
        else
           Пвыв_в = $0;
           Пвыв_к = $0;
           Пвыв_н = max(0, (ПУР - Кусп));
        end;
     end;

     /* Комиссия за управление */
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_1, @Купр1 ) != 0 )
        return 1;
     end;
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, EndCalcDateComiss, @Купр2 ) != 0 )
        return 1;
     end;
     Itog.rec.A30 = Купр2 - Купр1;

     /* Начисление компенсации гарантий */
     if( (Itog.rec.Sort == 0) or (ЗакрытиеБылоДосрочным( OrderFD.ID, Itog.rec.A8_2 ) == false) )
        if( (MngPlan.rec.GBPCapitalization == TS_PERIOD_GBP_END_ORDER) or (MngPlan.rec.ISFirmBCK == SET_CHAR ) or (Itog.rec.Sort == 1) )

           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_1, @Кусп1 ) != 0 )
              return 1;
           end;
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, EndCalcDateComiss, @Кусп2 ) != 0 )
              return 1;
           end;

           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_ПУ, NULL, 0, NULL, NULL, NULL, Itog.rec.A8_1, NULL, NULL, @ПУ1 ) != 0 )
              return 1;
           end;
           if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_ПУ, NULL, 0, NULL, NULL, NULL, EndCalcDateComiss, NULL, NULL, @ПУ2 ) != 0 )
              return 1;
           end;

           ПП = (ПУ2 - ПУ1) - (Купр2 - Купр1) - (Кусп2 - Кусп1/* +- pr_A32_2 */) - Кусп;

           if( (MngPlan.rec.GBPCapitalization == TS_PERIOD_GBP_END_ORDER) and (ПП < Itog.rec.A31/*БП*/) )
              if( ПП > 0 )
                 КГбп = Itog.rec.A31/*БП*/ - ПП;
              else
                 КГбп = Itog.rec.A31/*БП*/;
              end;
           end;

           if( ((MngPlan.rec.ISFirmBCK == SET_CHAR) or (Itog.rec.Sort == 1)) and (ПП < 0.0) )
              КГвк= abs(ПП);
           end;

           Itog.rec.A41_1 = Itog.rec.A41_2 = КГбп;
           Itog.rec.A42_1 = Itog.rec.A42_2 = КГвк;
        end;
     end;

     /* Корректируется сумма передаваемой учредителю прибыли с учетом КГбп */
     if(Itog.rec.Sort == 0)
        if( (Пвыв_в > 0) or ((КГбп > 0) and (ЭтоВыплата(MngPlan.rec.Flag1))) )
           Пвыв_в = Пвыв_в + КГбп;
        end;
        if( (Пвыв_к > 0) or ((КГбп > 0) and (ЭтоКапитализация(MngPlan.rec.Flag1))) )
           Пвыв_к = Пвыв_к + КГбп;
        end;
        if( (Пвыв_н > 0) or ((КГбп > 0) and (ЭтоНачисление(MngPlan.rec.Flag1))) )
           Пвыв_н = Пвыв_н + КГбп;
        end;
     else
        Пвыв_н = Пвыв_н + КГбп;
     end;

     /* Начисление НДФЛ */
     if(Itog.rec.Sort == 0)
        if( TS_IsPayerNPTaxAllCheck( OrderFD.Order.rec.Trustor, Itog.rec.A8_2 ) )
           if( ЭтоВыплата(MngPlan.rec.Flag1) and (Пвыв_в > 0.0) )
              Нкуд = РассчитатьНкуд( OrderFD, EndCalcDateComiss, Пвыв_в );
              Пвыв_в = Пвыв_в - Нкуд;
           elif( ЭтоКапитализация(MngPlan.rec.Flag1) and (Пвыв_к > 0.0) )
              Нкуд = РассчитатьНкуд( OrderFD, EndCalcDateComiss, Пвыв_к );
              Пвыв_к = Пвыв_к - Нкуд;
           end;
           Itog.rec.A38_2 = Itog.rec.A38_1 = Нкуд;
        end;
     end;

     Itog.rec.A35_2 = Itog.rec.A35_1 = Пвыв_н;
     Itog.rec.A36_2 = Itog.rec.A36_1 = Пвыв_к;
     Itog.rec.A37_2 = Itog.rec.A37_1 = Пвыв_в;
  else
     /* изменения не опрабатываем */
  end;

  /*Остаток распределенной прибыли = ПУiф - Куспi/ф - Пвыв_вi/ф - Пвыв_кi/ф - Пвыв_нi/ф - Нкудi /ф */
  Itog.rec.A40 = Itog.rec.A23_2 - Itog.rec.A32_2 - Itog.rec.A35_2 - Itog.rec.A36_2 - Itog.rec.A37_2 - Itog.rec.A38_2;

  return 0;
OnError( RslErrObj )
  return Exception( RslErrObj );
END;

MACRO РассчитатьИтоги( _ServOp:MEMADDR )

  var ServOp = TRecHandler( "tssrvop.dbt" );
  var OrderOFBU:TS_OrderFD = NULL;
  var cmd, fCalcItogs, RecCount = 0, MaxRecCount;

  ServOp.SetRecordAddr( _ServOp );
  OrderOFBU = TS_OrderFD( 0, ServOp.rec.OrderID );

  InitProgress( -1, "Операция РПЗ", "Отбор договоров для операции");
  cmd = RsdCommand(RslDefCon, "begin\n TrustAPI.SelectOrdersCalcProlongClose(?);\n end; ");
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, ServOp.rec.ID );
  cmd.execute();

  MaxRecCount = SQL_GetNRecs( "SELECT * FROM DTSCALCITOGS_TMP WHERE t_Exclude = chr(0)" );
  RemProgress();

  InitProgress( MaxRecCount, "Выполнение ...", "Операция РПЗ" );
  fCalcItogs = TBfile( "TSCALCITOGS.TMP", "W", 0 );
  fCalcItogs.AddFilter(" t_Exclude = chr(0) " );

  while( fCalcItogs.Next() )
     if( (fCalcItogs.rec.Sort == 0) or (fCalcItogs.rec.Sort == 1) )
        /* Для ДП ОФБУ, отобранных по условию П или З */
        if( ПересчитатьСуммуИтогов( ServOp, fCalcItogs, NULL ) == 0 )
           if( not fCalcItogs.update() )
              runerror( "Ошибка при обновлении записи в DTSCALCITOGS_TMP" );
           end;
        else 
           return 1;
        end;
     else
        /* Для ОФБУ как сумма по всем ДП */
        if( ПересчитатьСуммуИтоговОФБУ( ServOp, fCalcItogs.rec.OrderID ) != 0 )
           return 1;
        end;
     end;
     UseProgress( RecCount = RecCount + 1 );
  end;
  RemProgress();

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

MACRO ОбработатьИтогиПЗ( DlDoc:MEMADDR, FDoc:MEMADDR, ID_Operation:INTEGER, ID_Step:INTEGER, ISort:integer/*0-пролонгация, 1-закрытие*/ )

  var ServOp      = TRecHandler( "tssrvop.dbt" );
  var ПрибыльДУ   = TRecHandler( "account.dbt" );
  var РасчетыДУ   = TRecHandler( "account.dbt" );
  var РасчетыДУ18 = TRecHandler( "account.dbt" );
  var РасчетыДУ26 = TRecHandler( "account.dbt" );
  var РасчетыДУ68 = TRecHandler( "account.dbt" );
  var ДСДУ        = TRecHandler( "account.dbt" );
  var УбытокДУ    = TRecHandler( "account.dbt" );
  var Valid       = TRecHandler( "tsvalid.dbt" );
  var Itogs       = TRecHandler( "tscalcitogs.tmp" );
  var ДатаСписания, ДатаОперации, ДатаШага;
  var OrderFD:TS_OrderFD, OFBUFD:TS_OrderFD;
  var Payment, Дх = $0;

  if( TS_RunFromServiceOper( ServOp ) != true )
     MsgBox( "Шаг \"Расчеты при " + TS_IIF((ISort == 0), "пролонгации", "закрытиии договора") + "\" должен выполняться только из соответствующей сервисной операции." );
     return 1;
  end;

  OrderFD = TS_OrderFD( 0, FDoc );
  OFBUFD  = TS_OrderFD( 0, OrderFD.Order.rec.OFBU );

  if( not TS_GetRecHandler( Itogs, " SELECT * FROM DTSCALCITOGS_TMP WHERE t_OrderID = " + string(OrderFD.ID) + " and t_Sort = " + string(ISort) ) )
     MsgBox( "Для договора \"" + OrderFD.Code() + "\" не были рассчитаны итоги.");
     return 1;
  end;

  ДатаСписания = ServOp.rec.EndDate;
  ДатаОперации = ServOp.rec.OperDate;
  ДатаШага     = ServOp.rec.StepDate;

  SubPurpose = int(TS_NewSubpurpose( CAi, OrderFD.Order().rec.DocKind, OrderFD.Order().rec.ID ));

  CalcCom.sfdefcom_parm_S.rec.CommSum   = Itogs.rec.A32_2;
  CalcCom.sfdefcom_parm_S.rec.DateEnd   = Itogs.rec.EndDateS;
  CalcCom.sfdefcom_parm_S.rec.DateBegin = Itogs.rec.BeginDateS;
  FindSfConCom_ByID(Itogs.rec.IDComS, CalcCom.ConCom_S);
  if( СохранитьПериодическуюКомиссию( OrderFD, Itogs.rec.CalcDateS, CalcCom.ConCom_S, CalcCom.sfdefcom_parm_S ) != 0 )
     return 1;
  end;

  /* Cредневзвешенная доля учредителя */
  if( OrderFD.SaveItog( ДУ_ИТОГ_ДлУ, round(Itogs.rec.A9, 2), NATCUR, ДатаОперации, TS_IIF((ISort == 0), "97", "100"), null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_ALL, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2) )
     MsgBox( "Ошибка при сохранении итога \"ДлУ\"" );
     return 1;
  end;

  /* должно выполняться до проводок по выплате или капитализации прибыли */
  if(Itogs.rec.A41_2/*КГбп*/ > 0)
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Гбп, round(Itogs.rec.A41_2, 2), NATCUR, ДатаОперации, "81", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Гбп\"" );
        return 1;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation,
                               TS_DemandUserMark_CalcPrCl( TS_DEMAND_ROLE_REQUEST, ServOp.rec.ID, OrderFD.ID, "Н_Гбп", ID_Step ),
                               TS_DEMAND_ROLE_REQUEST,
                               "2" /*КВТО = оплата*/,
                               "81"/*КУС  = компенсация ГБП*/,
                               ДатаШага,
                               round(Itogs.rec.A41_2, 2),
                               NATCUR,
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_CALC_PROLONG_CLOSE, ServOp.rec.ID ) == false )
        return 1;
     end;

     if( not OFBUFD.OpenAccount( null, "+Расчеты, ДУ", null, null, FIROLE_COMPENSPAY, РасчетыДУ26, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  РасчетыДУ26, "-Расчеты, ДУ", /* AccDeb , AccCred*/
                                                  ДатаОперации,                /* Дата */
                                                  2,                           /* Глава */
                                                  NATCUR,                      /* Валюта */
                                                  round(Itogs.rec.A41_2, 2),   /* Сумма */
                                                  DlDoc,                       /* Документ */
                                                  OrderFD.Number(),            /* Numb_Document */
                                                  "Начисление компенсации гарантированной прибыли по договору " + OrderFD.Number(), /* Ground */
                                                  null,
                                                  FIROLE_TRUSTOR
                                                 ) 
       )
         return 1;
     end;

  end;

  Дх = Itogs.rec.A32_2 + Itogs.rec.A35_2 + Itogs.rec.A36_2 + Itogs.rec.A37_2 + Itogs.rec.A38_2 - Itogs.rec.A41_2/*КГбп*/;
  if( Дх > 0 )
     if( not OFBUFD.OpenAccount( null, "Прибыль ДУ", null, null, null, ПрибыльДУ, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  ПрибыльДУ, "-Расчеты, ДУ", /* AccDeb , AccCred*/
                                                  ДатаОперации,              /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  round(Дх, 2),              /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number(),          /* Numb_Document */
                                                  "Начисление прибыли по договору " + OrderFD.Number(), /* Ground */
                                                  null,
                                                  FIROLE_TRUSTOR
                                                 ) 
       )
         return 1;
     end;
  end;

  /* Комиссия за успех */
  if(Itogs.rec.A32_2 > 0.0)
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Кусп, round(Itogs.rec.A32_2, 2), NATCUR, ДатаОперации, TS_IIF((ISort == 0), "97", "100"), null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Кусп\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, round(Itogs.rec.A32_2, 2), NATCUR, ДатаСписания, "62", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
        return 1;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation,
                               TS_DemandUserMark_CalcPrCl( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Кусп", ID_Step ),
                               TS_DEMAND_ROLE_OBLIGATION,
                               "2" /*КВТО = оплата*/,
                               "62"/*КУС  = Оплата комиссии за успех*/,
                               ДатаШага,
                               round(Itogs.rec.A32_2, 2),
                               NATCUR,
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_CALC_PROLONG_CLOSE, ServOp.rec.ID ) == false )
        return 1;
     end;

     if( not OFBUFD.OpenAccount( null, "-Расчеты, ДУ", null, null, FIROLE_COM_MANAG, РасчетыДУ18, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  "-Расчеты, ДУ", РасчетыДУ18,    /* AccDeb , AccCred*/
                                                  ДатаОперации,                   /* Дата */
                                                  2,                              /* Глава */
                                                  NATCUR,                         /* Валюта */
                                                  round(Itogs.rec.A32_2, 2),      /* Сумма */
                                                  DlDoc,                          /* Документ */
                                                  OrderFD.Number(),               /* Numb_Document */
                                                  "Начисление комиссии за успех", /* Ground */
                                                  FIROLE_TRUSTOR, NULL
                                                 ) 
       )
         return 1;
     end;
  end;

  if(Itogs.rec.A35_2/*Пвыв_н*/ > 0)
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, round(Itogs.rec.A35_2, 2), NATCUR, ДатаОперации, TS_IIF((ISort == 0), "97", "100"), null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, round((Itogs.rec.A35_2 - Itogs.rec.A41_2/*КГбп*/), 2), NATCUR, ДатаОперации, "82", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
        return 1;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation,
                               TS_DemandUserMark_CalcPrCl( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Дх", ID_Step ),
                               TS_DEMAND_ROLE_OBLIGATION,
                               "2" /*КВТО = оплата*/,
                               "83"/*КУС  = Выплата дохода*/,
                               ДатаШага,
                               round(Itogs.rec.A35_2, 2),
                               NATCUR,
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_CALC_PROLONG_CLOSE, ServOp.rec.ID ) == false )
        return 1;
     end;
  end;

  if( (Itogs.rec.A37_2/*Пвыв_в*/ > 0) and (ISort == 0) )
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, round(Itogs.rec.A37_2, 2), NATCUR, ДатаОперации, TS_IIF((ISort == 0), "97", "100"), null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, round(Itogs.rec.A37_2, 2), NATCUR, ДатаОперации, "83", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, round(((Itogs.rec.A37_2 - Itogs.rec.A41_2/*КГбп*/) + Itogs.rec.A38_2), 2), NATCUR, ДатаОперации, "83", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
        return 1;
     end;

     if( not OFBUFD.OpenAccount( null, "ДС ДУ", null, null, null, ДСДУ, ДатаОперации) )
        return 1;
     end;
     if( not OrderFD.OpenAccount( null, "-Расчеты, ДУ", null, null, FIROLE_TRUSTOR, РасчетыДУ, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  РасчетыДУ, ДСДУ,      /* AccDeb , AccCred*/
                                                  ДатаОперации,         /* Дата */
                                                  2,                    /* Глава */
                                                  NATCUR,               /* Валюта */
                                                  round(Itogs.rec.A37_2, 2), /* Сумма */
                                                  DlDoc,                /* Документ */
                                                  OrderFD.Number(),     /* Numb_Document */
                                                  "Выплата прибыли при пролонгации договора " + OrderFD.Number(), /* Ground */
                                                  null, null
                                                 ) 
       )
         return 1;
     end;

     if( not ПроводкаПоКатегориямВнутреннегоУчета( 94,
                                                   OFBUFD,
                                                   FDoc,
                                                   ДатаОперации,
                                                   NATCUR,
                                                   round(Itogs.rec.A37_2, 2), OrderFD, null, "", "Выплата дохода учредителю по договору ДУ " + OrderFD.Number() )
       )
         return 1;
     end;

     Payment = NULL;
     if( TS_CreatePayment( CAi, OrderFD.Kind, OrderFD.ID, ДатаОперации,
                           OrderFD.Order.rec.Trustor, {OurBank},
                           {OurBank}, {OurBank},
                           Itogs.rec.A37_2, NATCUR, "Выплата дохода учередителю по договору № " + OrderFD.Number(),
                           РасчетыДУ.rec.Account , ДСДУ.rec.Account,
                           {OperDprt}, SubPurpose, NULL, @Payment, TmpPaymentID
                         )
       )
        return 1;
     end;
     TmpPaymentID = TmpPaymentID - 1;
     SubPurpose = SubPurpose + 1;

     if( ИсполнитьПлатеж( Payment, (РАБОТА_С_РАСЧЕТНЫМ_БАНКОМ() == true) ) )
        return 1;
     end;
  end;

  if((Itogs.rec.A36_2/*Пвыв_к*/ > 0) and (ISort == 0))
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, round(Itogs.rec.A36_2, 2), NATCUR, ДатаОперации, "97", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Дх, round(Itogs.rec.A36_2, 2), NATCUR, ДатаОперации, "96", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Дх\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_СК, round(Itogs.rec.A36_2, 2), NATCUR, ДатаОперации, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2+1 ) )
        MsgBox( "Ошибка при сохранении итога \"СК\"" );
        return 1;
     end;

     if( OFBUFD.SaveItog( ДУ_ИТОГ_СК, round(Itogs.rec.A36_2, 2), NATCUR, ДатаОперации, null, null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2+1 ) )
        MsgBox( "Ошибка при сохранении итога \"СК\"" );
        return 1;
     end;

     if( OrderFD.SaveItog( ДУ_ИТОГ_Р_ПУ, round(((Itogs.rec.A36_2 - Itogs.rec.A41_2/*КГбп*/) + Itogs.rec.A38_2), 2), NATCUR, ДатаОперации, "96", null, TS_TOTAL_SUMMA_OUT, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Р_ПУ\"" );
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  "-Расчеты, ДУ", "Капитал ДУ",  /* AccDeb , AccCred*/
                                                  ДатаОперации,                  /* Дата */
                                                  2,                             /* Глава */
                                                  NATCUR,                        /* Валюта */
                                                  round(Itogs.rec.A36_2, 2),     /* Сумма */
                                                  DlDoc,                         /* Документ */
                                                  OrderFD.Number(),              /* Numb_Document */
                                                  "Капитализация прибыли при пролонгации договора " + OrderFD.Number(), /* Ground */
                                                  FIROLE_TRUSTOR,
                                                  FIROLE_TRUSTOR
                                                 ) 
       )
         return 1;
     end;
  end;

  if( (Itogs.rec.A38_2/*Нкуд*/ > 0) and ( (ISort == 0) and ((Itogs.rec.A36_2 > 0) or (Itogs.rec.A37_2 > 0)) ) )
     /* проверка ((Itogs.rec.A36_2 > 0) or (Itogs.rec.A37_2 > 0)) нужна если поправили значения руками*/
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Налог, round(Itogs.rec.A38_2, 2), NATCUR, ДатаОперации, TS_IIF((Itogs.rec.A37_2 > 0), "83", "96"), null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Налог\"" );
        return 1;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation,
                               TS_DemandUserMark_CalcPrCl( TS_DEMAND_ROLE_OBLIGATION, ServOp.rec.ID, OrderFD.ID, "Н_Налог", ID_Step ),
                               TS_DEMAND_ROLE_OBLIGATION,
                               "2" /*КВТО = оплата*/,
                               "60"/*КУС  = Оплата налога на доходы физ.лиц*/,
                               ДатаШага,
                               round(Itogs.rec.A38_2, 2),
                               NATCUR,
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_CALC_PROLONG_CLOSE, ServOp.rec.ID ) == false )
        return 1;
     end;

     if( not OFBUFD.OpenAccount( null, "-Расчеты, ДУ", null, null, FIROLE_NALOG, РасчетыДУ68, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  "-Расчеты, ДУ", РасчетыДУ68,  /* AccDeb , AccCred*/
                                                  ДатаОперации,                 /* Дата */
                                                  2,                            /* Глава */
                                                  NATCUR,                       /* Валюта */
                                                  round(Itogs.rec.A38_2, 2),    /* Сумма */
                                                  DlDoc,                        /* Документ */
                                                  OrderFD.Number(),             /* Numb_Document */
                                                  "Взимание налога на доходы физ.лиц", /* Ground */
                                                  FIROLE_TRUSTOR, NULL
                                                 ) 
       )
         return 1;
     end;
  end;

  if(Itogs.rec.A42_2/*КГвк*/ > 0)
     if( OrderFD.SaveItog( ДУ_ИТОГ_Н_Гвк, round(Itogs.rec.A42_2, 2), NATCUR, ДатаОперации, "84", null, TS_TOTAL_SUMMA_IN, TS_TOTAL_SUMMA_CHANGE, ServOp.rec.Kind_Operation, ServOp.rec.ID, Itogs.rec.A8_2 ) )
        MsgBox( "Ошибка при сохранении итога \"Н_Гвк\"" );
        return 1;
     end;

     if( TS_CreateDemandTrust( NULL, ID_Operation,
                               TS_DemandUserMark_CalcPrCl( TS_DEMAND_ROLE_REQUEST, ServOp.rec.ID, OrderFD.ID, "Н_Гвк", ID_Step ),
                               TS_DEMAND_ROLE_REQUEST,
                               "2" /*КВТО = оплата*/,
                               "84"/*КУС  = компенсация убытка*/,
                               ДатаШага,
                               round(Itogs.rec.A42_2, 2),
                               NATCUR,
                               РКЦ(),
                               OrderFD.ID, NATCUR,
                               NULL, NULL,
                               ID_Step, TS_DOC_CALC_PROLONG_CLOSE, ServOp.rec.ID ) == false )
        return 1;
     end;

     if( not OFBUFD.OpenAccount( null, "+Расчеты, ДУ", null, null, FIROLE_COMPENSPAY, РасчетыДУ26, ДатаОперации) )
        return 1;
     end;

     if( not OFBUFD.OpenAccount( null, "Убыток ДУ", null, null, null, УбытокДУ, ДатаОперации) )
        return 1;
     end;

     if( not ПроводкаПоКатегориямУчетаПоДоговору( OrderFD, null, null,
                                                  РасчетыДУ26, УбытокДУ,     /* AccDeb , AccCred*/
                                                  ДатаОперации,              /* Дата */
                                                  2,                         /* Глава */
                                                  NATCUR,                    /* Валюта */
                                                  round(Itogs.rec.A42_2, 2), /* Сумма */
                                                  DlDoc,                     /* Документ */
                                                  OrderFD.Number(),          /* Numb_Document */
                                                  TS_IIF((ISort == 0), "Начисление компенсации убытка при пролонгации договора ", "Начисление компенсации убытка при закрытии договора ") + OrderFD.Number(), /* Ground */
                                                  NULL, NULL
                                                 ) 
       )
         return 1;
     end;

  end;

  /* Проставим Finished */
  if( TS_GetCurrentValid( OrderFD.ID, Itogs.rec.A8_2, Valid ) == 0 )
     Valid.rec.Finished = SET_CHAR;
     if( TS_ChangeValid( OrderFD.Order(), Valid, false ) != 0 )
        return 1;
     end;
  else
     MsgBox( "Не найден период действия договора на дату " + string(Itogs.rec.A8_2) + "." );
     return 1;
  end;

  TS_InsertSrvObj( ServOp.rec.ID, TS_DOC_DPOFBU, OrderFD.ID, ID_Operation, ID_Step );

  SaveAllItogsInBD(OrderFD, Itogs, ServOp);

  return 0;

OnError( RslErrObj )
  return Exception( RslErrObj );
END;

/*Отобрать договора, попавшие в операцию (F6 на операции)*/
MACRO ДоговораПоОперацииРПЗ( _ServOp:VARIANT )
  VAR cmd, ServOpID, ServOp;

  if( valtype(_ServOp) == V_MEMADDR )
    ServOp = TRecHandler( "tssrvop.dbt" ); /*Сервисная операция, из которой выполняется расчет*/
    ServOp.SetRecordAddr( _ServOp );
    ServOpID = ServOp.rec.ID;
  else
    ServOpID = _ServOp.rec.ID;
  end;

  cmd = RsdCommand(RslDefCon, "begin\n TrustAPI.SelectOrdersIncomingPrCl(?);\n end; ");
  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, ServOpID ); 
  cmd.execute();

  return 0;

OnError( RslErrObj )
  RemProgress();
  MsgBox( RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message);
  return 1;
END;
