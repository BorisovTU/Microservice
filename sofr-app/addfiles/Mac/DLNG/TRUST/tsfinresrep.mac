/*
$Name:        tsfinresrep.mac
$Module:      ДУ
$Description: Финансовый результат по операциям с ц/б в ДУ
*/
import "spRepFn2.mac", "sp_class.mac", "globals.mac", "DLReport_h.mac";
import "tsfinresrep_Form.mac";
import RsbDataSet;

private var Data;
private var DprtID_t;
PRIVATE CONST PTSK_TRUST          = 17; //доверительное управление

/* Структура с данными для отчета*/
class SourceData( _DprtID:integer, /*_IsOwnDeal:bool, _IsClientDeal:bool,*/ _IsOFBU,
                  _ClientID:integer, _OrderID:integer, _AvrKind: integer, _AvrFIID:integer, _ByIss, _FICode: integer,
                  _dateMin:date,  _dateMax:date )

  var DprtID        =  _DprtID,
      IsOFBU        =  _IsOFBU,
      ClientID      =  _ClientID,
      OrderID       =  _OrderID,
      AvrKind       =  _AvrKind,
      AvrFIID       =  _AvrFIID,
      FICode        =  _FICode,
      dateMin       =  _dateMin,
      dateMax       =  _dateMax,
      ByIss         =  _ByIss,

      FlagPrintIss = false,
      FlagPrnHeadDprt = false,
      FlagPrnHeadClnt   = false,
      FlagReportRun = false;
end;

private var
   IsApp = false;

private var
   IsAvrHead = false;

macro PrintSum( Sum )
   if( Sum )
      if( IsApp )
         return string( money(Sum):a );
      else
         return string( money(Sum) );
      end;
   else
      return "";
   end;
end;

macro ПолучитьИмяКлиента(PartyID)
  file  rParty( "party" ) ;
  var Name;
  if( not ПолучитьСубъекта( PartyID, rParty ) )
      Name = rParty.ShortName;
      return Name;
  else RunError ("Не найден субъект с кодом", + string(PartyID));
  end;
end;

PRIVATE VAR Cap =
"Финансовый результат по операциям с ценными бумагами за период с ########## по ##########\n\n";

PRIVATE VAR Branch1 =
"Филиал  #\n" +
"Вид ц/б #\n" +
"Валюта номинала #\n";

PRIVATE VAR Branch2 =
"#\n";

PRIVATE VAR ReportRunFalse =
"#";

PRIVATE VAR TableHeader =
"┌────────────────┬────────────┬─────────┬──────────────────────┬──────┬───────────────┬─────────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┬─────────────────────────────┬─────────────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬─────────────────────────────────────┬─────────────────────────────────────┐\n"+
"│      Номер     │    Дата    │   Вид   │   Наименование ц/б   │  ВН  │     Кол-во    │             Цена реализации             │            Сумма реализации         │         Балансовая стоимость        │            Цена реализации          │           Сумма реализации          │        НКД полученный       │        НКД уплаченный       │ Ранее начисленный КД │   Доначисленный КД   │ Ранее начисленный ДД │   Доначисленный ДД   │      Переоценка      │         Финансовый результат        │         Финансовый результат        │\n"+
"│    операции    │поставки ц/б│ операции│                      │      │       ц/б     │                                         │                                     │            реализуемых ц/б          │                                     │                                     │                             │                             │                      │                      │                      │                      │                      │            (балансовый)             │              (общий)                │\n"+
"│                │            │         │                      │      │               ├──────────────────┬──────────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┼──────────┬──────────────────┼──────────┬──────────────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼───────────┬──────────┼──────────────────┬──────────────────┼──────────────────┬──────────────────┤\n"+
"│                │            │         │                      │      │               │        вал.      │          RUR.        │        вал.      │        RUR.      │        вал.      │        RUR.      │        вал.      │        RUR.      │        вал.      │        RUR.      │    вал.  │        RUR.      │    вал.  │        RUR.      │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │    вал.   │   RUR.   │        вал.      │        RUR.      │        вал.      │        RUR.      │\n"+
"├────────────────┼────────────┼─────────┼──────────────────────┼──────┼───────────────┼──────────────────┼──────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────┼──────────────────┼──────────┼──────────────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼───────────┼──────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┤";

PRIVATE CLASS (DL_CReportTemplate) TS_FinRes_Report

  PRIVATE VAR flag = false;
  PRIVATE VAR ReoOrderID;

  var
    ItgSaleSum_rur = $0,
    ItgBalCost_rur = $0,
    ItgCost_Buy_rur = $0,
    ItgNKDReceiv_rur = $0,
    ItgNKDPaid_rur = $0,
    ItgINTERESTINCOMEBUY_rur = $0,
    ItgINTERESTINCOMEADD_rur = $0,
    ItgDISCOUNTINCOMEBUY_rur = $0,
    ItgDISCOUNTINCOMEADD_rur = $0,
    ItgOVERAMOUNTBUY_rur = $0,
    ItgFinRes_rur = $0,
    ItgFinRes_rur_com = $0;

  var
    AvrItgSaleSum_rur = $0,
    AvrItgBalCost_rur = $0,
    AvrItgCost_Buy_rur = $0,
    AvrItgNKDReceiv_rur = $0,
    AvrItgNKDPaid_rur = $0,
    AvrItgINTERESTINCOMEBUY_rur = $0,
    AvrItgINTERESTINCOMEADD_rur = $0,
    AvrItgDISCOUNTINCOMEBUY_rur = $0,
    AvrItgDISCOUNTINCOMEADD_rur = $0,
    AvrItgOVERAMOUNTBUY_rur = $0,
    AvrItgFinRes_rur = $0,
    AvrItgFinRes_rur_com = $0;


  var ClientName:string = "";

  PRIVATE MACRO PrintMode():INTEGER
     return m_Form.GetFieldValue( PNFLD_FINRESREP_PRINTMETHOD );

  END;

  PRIVATE MACRO BeginReport()

     Data = SourceData( m_Form.GetFieldValue( PNFLD_FINRESREP_DEPARTCODE ),
                        m_Form.GetFieldValue( PNFLD_FINRESREP_IS_CLIENT_OFBU ),
                        m_Form.GetFieldValue( PNFLD_FINRESREP_CLIENT_OFBU ),
                        m_Form.GetFieldValue( PNFLD_FINRESREP_CONTRACT_OFBU ),
                        m_Form.GetFieldValue( PNFLD_FINRESREP_AVR_KIND ),
                        m_Form.GetFieldValue( PNFLD_FINRESREP_AVR_CODE ),
                        (m_Form.GetFieldValue( PNFLD_FINRESREP_BY_ISS ) == SET_CHAR),
                        m_Form.GetFieldValue( PNFLD_FINRESREP_FI_CODE ),
                        FormData.BegDate,
                        FormData.EndDate );

     IsApp    = m_Form.GetFieldValue( PNFLD_FINRESREP_COMPRINTMETHOD );
     DprtID_t =  m_Form.GetFieldValue( PNFLD_FINRESREP_DEPARTCODE );

     CreateTotalBook();
     SetActiveSheet( "0101" );
     PrintFormatString( Cap,
                        "N1_H0_1", Data.dateMin,
                        "N1_H0_2", Data.dateMax
                      );
     CopyAllSheetInTotalBook( NULL, false, "N1_Cap", 0 );
  END;

  PRIVATE MACRO Register_Table()
     RegisterTable( "N1_MainTable", TableHeader,
                    "N1_A1",
                    "N1_A2",
                    "N1_A3",
                    "N1_A4",
                    "N1_A5",
                    "N1_A6",
                    "N1_A7",
                    "N1_A8",
                    "N1_A9",
                    "N1_A10",
                    "N1_A11",
                    "N1_A12",
                    "N1_A12_1",
                    "N1_A12_2",
                    "N1_A12_2",
                    "N1_A12_4",
                    "N1_A13",
                    "N1_A14",
                    "N1_A15",
                    "N1_A16",
                    "N1_A17",
                    "N1_A18",
                    "N1_A19",
                    "N1_A20",
                    "N1_A21",
                    "N1_A22",
                    "N1_A23",
                    "N1_A24",
                    "N1_A25",
                    "N1_A26",
                    "N1_A29",
                    "N1_A30",
                    "N1_A31",
                    "N1_A32"
                   );

     flag = true;
  END;

  PRIVATE MACRO PrintAvrItog()
     PrintTableLine( "N1_A1",    "Итого по выпуску:",                   null,
                     "N1_A2",    "",                                    null,
                     "N1_A3",    "",                                    null,
                     "N1_A4",    "",                                    null,
                     "N1_A5",    "",                                    null,
                     "N1_A6",    "",                                    null,
                     "N1_A7",    "",                                    null,
                     "N1_A8",    "",                                    null,
                     "N1_A9",    "",                                    null,
                     "N1_A10",   PrintSum(AvrItgSaleSum_rur),           null,
                     "N1_A11",   "",                                    null,
                     "N1_A12",   PrintSum(AvrItgBalCost_rur),           null,
                     "N1_A12_1", "",                                    null,
                     "N1_A12_2", "",                                    null,
                     "N1_A12_3", "",                                    null,
                     "N1_A12_4", PrintSum(AvrItgCost_Buy_rur),          null,
                     "N1_A13",   "",                                    null,
                     "N1_A14",   PrintSum(AvrItgNKDReceiv_rur),         null,
                     "N1_A15",   "",                                    null,
                     "N1_A16",   PrintSum(AvrItgNKDPaid_rur),           null,
                     "N1_A17",   "",                                    null,
                     "N1_A18",   PrintSum(AvrItgINTERESTINCOMEBUY_rur), null,
                     "N1_A19",   "",                                    null,
                     "N1_A20",   PrintSum(AvrItgINTERESTINCOMEADD_rur), null,
                     "N1_A21",   "",                                    null,
                     "N1_A22",   PrintSum(AvrItgDISCOUNTINCOMEBUY_rur), null,
                     "N1_A23",   "",                                    null,
                     "N1_A24",   PrintSum(AvrItgDISCOUNTINCOMEADD_rur), null,
                     "N1_A25",   "",                                    null,
                     "N1_A26",   PrintSum(AvrItgOVERAMOUNTBUY_rur),     null,
                     "N1_A29",   "",                                    null,
                     "N1_A30",   PrintSum(AvrItgFinRes_rur),            null,
                     "N1_A31",   "",                                    null,
                     "N1_A32",   PrintSum(AvrItgFinRes_rur_com),        null
                   );

     IsAvrHead = false;
  END;

  PRIVATE MACRO EndCopyTable()
     if(flag == true)
     if( IsAvrHead )
        PrintAvrItog()
     end;
     PrintTableLine( "N1_A1",    "Итого за период:",                 null,
                     "N1_A2",    "",                                 null,
                     "N1_A3",    "",                                 null,
                     "N1_A4",    "",                                 null,
                     "N1_A5",    "",                                 null,
                     "N1_A6",    "",                                 null,
                     "N1_A7",    "",                                 null,
                     "N1_A8",    "",                                 null,
                     "N1_A9",    "",                                 null,
                     "N1_A10",   PrintSum(ItgSaleSum_rur),           null,
                     "N1_A11",   "",                                 null,
                     "N1_A12",   PrintSum(ItgBalCost_rur),           null,
                     "N1_A12_1", "",                                 null,
                     "N1_A12_2", "",                                 null,
                     "N1_A12_3", "",                                 null,
                     "N1_A12_4", PrintSum(ItgCost_Buy_rur),          null,
                     "N1_A13",   "",                                 null,
                     "N1_A14",   PrintSum(ItgNKDReceiv_rur),         null,
                     "N1_A15",   "",                                 null,
                     "N1_A16",   PrintSum(ItgNKDPaid_rur),           null,
                     "N1_A17",   "",                                 null,
                     "N1_A18",   PrintSum(ItgINTERESTINCOMEBUY_rur), null,
                     "N1_A19",   "",                                 null,
                     "N1_A20",   PrintSum(ItgINTERESTINCOMEADD_rur), null,
                     "N1_A21",   "",                                 null,
                     "N1_A22",   PrintSum(ItgDISCOUNTINCOMEBUY_rur), null,
                     "N1_A23",   "",                                 null,
                     "N1_A24",   PrintSum(ItgDISCOUNTINCOMEADD_rur), null,
                     "N1_A25",   "",                                 null,
                     "N1_A26",   PrintSum(ItgOVERAMOUNTBUY_rur),     null,
                     "N1_A29",   "",                                 null,
                     "N1_A30",   PrintSum(ItgFinRes_rur),            null,
                     "N1_A31",   "",                                 null,
                     "N1_A32",   PrintSum(ItgFinRes_rur_com),        null
      );


        EndTable();
        CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
        flag = false;
        IsAvrHead = false;
     end;
  END;

  PRIVATE MACRO PrintHeadTable( FIID )
    var FI       = TRecHandler( "fininstr.dbt" );
    
     if( ПолучитьФинИн( FIID, FI ) ) 
        MsgBox( "Не найден финансовый инструмент FIID = " + FIID );
     end;

     Merge("N1_A1", "N1_A32");

     PrintTableLine( "N1_A1", "По выпуску: " + FI.rec.FI_Code, null );

     IsAvrHead = true;
  
  END;

  PRIVATE MACRO PrintHeadDprt( Data )
     var _avrkind = IIF(Data.AvrKind != -1, FormData.AvrKind, "");
     var _ficode  = IIF(Data.FICode  != -1, FormData.FICode, "");
     file Dprt( dp_dep );
     /*Название филиала*/
     if( Data.DprtID != 0 )
        ClearRecord( Dprt );
        Dprt.Code = Data.DprtID;
        if( not GetEQ( Dprt ) )
          MsgBox( "Не найден филиал с кодом " + string(Data.DprtID) );
        else
          PrintFormatString( Branch1, "N1_H1_1", Dprt.name,
                                      "N1_H1_2", _avrkind,
                                      "N1_H1_3", _ficode );

          CopyAllSheetInTotalBook( NULL, false, "N1_HeaderClient", 1 );
        end;
     end;

     Data.FlagReportRun = true;
     Data.FlagPrnHeadDprt = true;
  END;

  PRIVATE MACRO PrintHeadClient( Data )

     var head_str = "";
     var Select4, Data4;

        Select4 = RSDCommand( " select t_Number, t_DateBegin " +
                              "   from dsfcontr_dbt where t_id = ? " +
                              "    and t_servkind = ? " );

        Select4.addParam("id",       RSDBP_IN, ReoOrderID);
        Select4.addParam("servkind", RSDBP_IN, PTSK_TRUST);
        Select4.execute();

        Data4 = TRsbDataSet(Select4);

        if( NOT Data4.MoveNext() )
           MsgBox("Договор не найден, id = " + string(ReoOrderID));
        end;

        if(Data.IsOFBU == SET_CHAR)
           head_str = ClientName + ", ОФБУ № " + string(Data4.Number) + " от " + string(Date(Data4.DateBegin));
        else
           head_str = ClientName + ", Договор № " + string(Data4.Number) + " от " + string(Date(Data4.DateBegin));
        end;

     PrintFormatString( Branch2, "N1_H1", head_str );

     PrintFormatString( null,
                        "N1_H0_4",  {CCYNatCur},
                        "N1_H0_5",  {CCYNatCur},
                        "N1_H0_6",  {CCYNatCur},
                        "N1_H0_6_2",{CCYNatCur},
                        "N1_H0_6_4",{CCYNatCur},
                        "N1_H0_7",  {CCYNatCur},
                        "N1_H0_8",  {CCYNatCur},
                        "N1_H0_9",  {CCYNatCur},
                        "N1_H0_10", {CCYNatCur},
                        "N1_H0_11", {CCYNatCur},
                        "N1_H0_12", {CCYNatCur},
                        "N1_H0_13", {CCYNatCur},
                        "N1_H0_15", {CCYNatCur},
                        "N1_H0_16", {CCYNatCur}
                      );
     CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 1 );

     Data.FlagPrnHeadClnt = true;
     Register_Table();
  END;

  PRIVATE MACRO PrintHeadClnt( Data, ClientID )
     record  rParty( party );
     var     Title;

     if( not Data.FlagPrnHeadDprt )
        PrintHeadDprt( Data );
     end;

     if( not Data.FlagPrnHeadClnt )
        PrintHeadClient( Data );
     end;

  END;

  PRIVATE MACRO PrintDeal( Data, DataSet )
     /* Конвертируем sumFrom из валюты FIFrom в валюту FIFace по курсу на дату
        Data, если FIFace != NATCUR. Иначе sumTo = $0. */
     macro ConvertToFIFace( sumTo, sumFrom, Data, FIFrom, FIFace )
        if( FIFace != NATCUR )
           SmartConvertSum( sumTo, sumFrom, Data, FIFrom, FIFace, true );
           setparm( 0, SumTo );
        else
           setparm( 0, $0 );
        end;
     end;

     /* Получаем строку с видом сделки */
     macro GetDealKind( FDeals, Group )
        if( FDeals.BofficeKind == DL_TRUSTDOC )
           return "Продажа";
        elif( IsRET_PARTLY(Group) )
           return "Част.пог."
        else
           return "Погашение";
        end;
     end;

     macro GetDealKind_( FDeals )
        if( FDeals.BofficeKind == DL_TRUSTDOC )
           return "Продаже";
        else
           return "Погашению";
        end;
     end;

     var
        Amount, Group,
        Price = $0,
        BalanceCost = $0,    /*сумма балансовой стоимости наших покупок, связанных с продажей\погашением лотов*/
        BuySum = $0,         /*сумма стоимости клиентских покупок, связанных с продажей\погашением лотов */
        Outlay = $0,         /*Сумма затрат покупок и продаж*/
        DocKind, DocID,
        BalCost_val = $0, BalCost_rur = $0,
        NKDPaid = $0, NKDPaid_val = $0, NKDPaid_rur = $0,        /* Уплаченный НКД */
        NKDReceiv = $0, NKDReceiv_val = $0, NKDReceiv_rur = $0,             /* Полученный НКД */
        IncomeNKD = $0, IncomeNKD_rur = $0,  /* Доход по НКД */
        OutlayBuy = $0,
        Price_valText = $0, Price_val = $0, Price_rur = $0,
        SaleSum_val = $0, SaleSum_rur = $0,
        FinRes_val = $0, FinRes_rur = $0,
        FinRes_val_com = $0, FinRes_rur_com = $0,
        DateSale    = ConvertSQLDate(DataSet.WrtSumDate),  /* дата продажи (погашения) */
        FIPrice     = DataSet.CFI,         /* валюта цены */
        FIFace      = DataSet.FaceValueFI, /* валюта номинала */
        FIFaceCcyAll;

    var INTERESTINCOMEBUY_val, INTERESTINCOMEBUY_rur, INTERESTINCOMEBUY = $0,
        DISCOUNTINCOMEBUY_val, DISCOUNTINCOMEBUY_rur, DISCOUNTINCOMEBUY = $0,
        INTERESTINCOMEADD_val, INTERESTINCOMEADD_rur, INTERESTINCOMEADD = $0,
        DISCOUNTINCOMEADD_val, DISCOUNTINCOMEADD_rur, DISCOUNTINCOMEADD = $0,
        OVERAMOUNTBUY_val, OVERAMOUNTBUY_rur, OVERAMOUNTBUY = $0,
        balcost_buy_val, balcost_buy_rur,
        sum_buy_val, sum_buy_rur,
        ItogSum_buy_rur,
        cost_buy_val, cost_buy_rur,
        price_buy_val, price_buy_rur;

    var N1_A13, N1_A14, /* НКД полученный - NKDSALEAMOUNT */
        N1_A15, N1_A16, /* НКД уплаченный - NKDBUYAMOUNT */
        N1_A17, N1_A18, /* ранее начисленный КД - InterestIncomeBuy */
        N1_A19, N1_A20, /* доначисленный КД - InterestIncomeAdd */
        N1_A21, N1_A22, /* ранее начисленный ДД - DiscountIncomeBuy */
        N1_A23, N1_A24, /* доначисленный ДД - DiscountIncomeAdd */
        N1_A25, N1_A26, /* переоценка - OverChange */
        N1_A29, N1_A30, /* финансовый результат (балансовый) */
        N1_A31, N1_A32, /* финансовый результат (общий) */
        N1_A9,  N1_A10, /* сумма реализации */
        N1_A11, N1_A12; /* балансовая стоимость реализуемых цб*/

    var firstmov = true;

     var FDeals = TBFile( "dl_tick.dbt", "R", 0 );
     file fininstr (fininstr) key 0;
     var cmd, qwery;

     /*Получим буфер сделки - только для определения Group*/
     FDeals.Clear();
     FDeals.rec.DealID = DataSet.DealID;
     if( FDeals.GetEQ() )
        Group = SP_GetOperationGroup(FDeals.rec);
     else
        msgbox("Не найдена сделка с кодом " + DataSet.DealCode);
        return;
     end;

     PrintHeadClnt( Data, DataSet.ClientID );

     /* A5 - К-во ц/б */
     Amount = DataSet.Principal;
     /* A60, A61, A62 - Цена реализации */
     if( IsRET_PARTLY(Group) )
        /* частичное погашение */
        Price = money(DataSet.TotalCost/DataSet.Principal);
        ConvertToFIFace( Price_val, Price, DateSale, FIPrice, FIFace );
        SmartConvertSum( Price_rur, Price, DateSale, FIPrice, NATCUR, true );
     elif( IsRET_ISSUE(Group) )
        /* погашение выпуска */
        FI_GetNominal( DataSet.FIID, Price );
        ConvertToFIFace( Price_val, Price, DateSale, FIFace, FIFace );
        SmartConvertSum( Price_rur, Price, DateSale, FIFace, NATCUR, true );
     else
        /* продажа */
        Price = money(DataSet.Cost/Amount);
        ConvertToFIFace( Price_val, Price, DateSale, FIPrice, FIFace );
        SmartConvertSum( Price_rur, Price, DateSale, FIPrice, NATCUR, true );
     end;

     ClearRecord(fininstr);
     fininstr.FIID = DataSet.FacevalueFI;
     if (GETEQ(fininstr))
        FIFaceCcyAll = fininstr.Ccy;
     end;

     if( Price_val )
        Price_valText = Price_val + " " + FIFaceCcyAll;
     else
        Price_valText = "";
     end;

     /* A71, A72 - Сумма реализации */
     SaleSum_val = money(Amount*Price_val);
     SaleSum_rur = money(Amount*Price_rur);

     if( IsRET_PARTLY(Group) OR IsRET_COUPON(Group) )
        DocKind = DataSet.BofficeKind;
        DocID   = DataSet.DealID;
     else
        DocKind = DLDOC_PAYMENT;
        DocID   = DataSet.PaymentID;
     end;
     
     if( not WRT_GetSaleFinResult( DataSet.SumID, KINDPORT_UNDEF, 0,
                           BuySum, BalanceCost, NKDPaid,
                           INTERESTINCOMEBUY, DISCOUNTINCOMEBUY,
                           null, null,
                           INTERESTINCOMEADD, DISCOUNTINCOMEADD,
                           null, null, null, null, null, null, null, OutlayBuy,
                           OVERAMOUNTBUY, null, null, null, null, NKDReceiv ) )

        MsgBox(  "Ошибка при получении результатов списания.|Код сделки = ",
                 DataSet.DealCode );
        return false;
     end;

     /* A111, A112 - НКД, уплаченный */
     ConvertToFIFace( NKDPaid_val, NKDPaid, DateSale, FIFace, FIFace );
     SmartConvertSum( NKDPaid_rur, NKDPaid, DateSale, FIFace, NATCUR, true );

     /* A81, A82 - Балансовая стоимость */
     /*так как для клиентов балансовую стоимость на лотах не учитываем - берем стоимость покупок*/
     ConvertToFIFace( BalCost_val, BalanceCost-INTERESTINCOMEBUY-NKDPaid, DateSale, FIFace, FIFace );
     SmartConvertSum( BalCost_rur, BalanceCost-INTERESTINCOMEBUY-NKDPaid, DateSale, FIFace, NATCUR, true );

     /* A101, A102 - НКД, полученный */
     ConvertToFIFace( NKDReceiv_val, /*DataSet.NKDAmount*/NKDReceiv, DateSale, FIFace, FIFace );
     SmartConvertSum( NKDReceiv_rur, /*DataSet.NKDAmount*/NKDReceiv, DateSale, FIFace, NATCUR );

     ConvertToFIFace( INTERESTINCOMEBUY_val, INTERESTINCOMEBUY, DateSale, FIPrice, FIFace );
     SmartConvertSum( INTERESTINCOMEBUY_rur, INTERESTINCOMEBUY, DateSale, FIPrice, NATCUR, true );

     ConvertToFIFace( DISCOUNTINCOMEBUY_val, DISCOUNTINCOMEBUY, DateSale, FIPrice, FIFace );
     SmartConvertSum( DISCOUNTINCOMEBUY_rur, DISCOUNTINCOMEBUY, DateSale, FIPrice, NATCUR, true );

     ConvertToFIFace( INTERESTINCOMEADD_val, INTERESTINCOMEADD, DateSale, FIPrice, FIFace );
     SmartConvertSum( INTERESTINCOMEADD_rur, INTERESTINCOMEADD, DateSale, FIPrice, NATCUR, true );

     ConvertToFIFace( DISCOUNTINCOMEADD_val, DISCOUNTINCOMEADD, DateSale, FIPrice, FIFace );
     SmartConvertSum( DISCOUNTINCOMEADD_rur, DISCOUNTINCOMEADD, DateSale, FIPrice, NATCUR, true );

     ConvertToFIFace( OVERAMOUNTBUY_val, BalanceCost-INTERESTINCOMEBUY-DISCOUNTINCOMEBUY-NKDPaid-BuySum, DateSale, FIPrice, FIFace );
     SmartConvertSum( OVERAMOUNTBUY_rur, BalanceCost-INTERESTINCOMEBUY-DISCOUNTINCOMEBUY-NKDPaid-BuySum, DateSale, FIPrice, NATCUR, true );

     /* A91, A92 - финансовый результат */
     FinRes_val = SaleSum_val - BalCost_val - DISCOUNTINCOMEADD_val;
     FinRes_rur = SaleSum_rur - BalCost_rur - DISCOUNTINCOMEADD_rur;

     FinRes_val_com = SaleSum_val - BalCost_val;
     FinRes_rur_com = SaleSum_rur - BalCost_rur;

     if( Data.FlagPrintIss )
         if( IsAvrHead )
            PrintAvrItog();
         end;
        AvrItgSaleSum_rur = $0;
        AvrItgBalCost_rur = $0;
        AvrItgCost_Buy_rur = $0;
        AvrItgNKDReceiv_rur = $0;
        AvrItgNKDPaid_rur = $0;
        AvrItgINTERESTINCOMEBUY_rur = $0;
        AvrItgINTERESTINCOMEADD_rur = $0;
        AvrItgDISCOUNTINCOMEBUY_rur = $0;
        AvrItgDISCOUNTINCOMEADD_rur = $0;
        AvrItgOVERAMOUNTBUY_rur = $0;
        AvrItgFinRes_rur = $0;
        AvrItgFinRes_rur_com = $0;

        PrintHeadTable( DataSet.FIID );
        Data.FlagPrintIss = false;
     end;


     if( m_Form.GetFieldValue( PNFLD_FINRESREP_BUY_SALE ) == UNSET_CHAR )

         PrintTableLine( "N1_A1",    DataSet.DealCode,                                                  null,
                         "N1_A2",    date_as_string(1, DateSale),                                       null,
                         "N1_A3",    GetDealKind( FDeals.rec, Group ),                                  null,
                         "N1_A4",    DataSet.Name,                                                      null,
                         "N1_A5",    FIFaceCcyAll,                                                      null,
                         "N1_A6",    Amount,                                                            null,
                         "N1_A7",    PrintSum(Price_valText),                                           null,
                         "N1_A8",    PrintSum(Price_rur),                                               null,
                         "N1_A9",    PrintSum(SaleSum_val),                                             null,
                         "N1_A10",   PrintSum(SaleSum_rur),                                             null,
                         "N1_A11",   PrintSum(BalCost_val),                                             null,
                         "N1_A12",   PrintSum(BalCost_rur),                                             null,
                         "N1_A12_1", "",                                                                null,
                         "N1_A12_2", "",                                                                null,
                         "N1_A12_3", "",                                                                null,
                         "N1_A12_4", "",                                                                null,
                         "N1_A13",   PrintSum(NKDReceiv_val),                                           null,
                         "N1_A14",   PrintSum(NKDReceiv_rur),                                           null,
                         "N1_A15",   PrintSum(NKDPaid_val),                                             null,
                         "N1_A16",   PrintSum(NKDPaid_rur),                                             null,
                         "N1_A17",   PrintSum(INTERESTINCOMEBUY_val),                                   null,
                         "N1_A18",   PrintSum(INTERESTINCOMEBUY_rur),                                   null,
                         "N1_A19",   PrintSum(INTERESTINCOMEADD_val),                                   null,
                         "N1_A20",   PrintSum(INTERESTINCOMEADD_rur),                                   null,
                         "N1_A21",   PrintSum(DISCOUNTINCOMEBUY_val),                                   null,
                         "N1_A22",   PrintSum(DISCOUNTINCOMEBUY_rur),                                   null,
                         "N1_A23",   PrintSum(DISCOUNTINCOMEADD_val),                                   null,
                         "N1_A24",   PrintSum(DISCOUNTINCOMEADD_rur),                                   null,
                         "N1_A25",   PrintSum(OVERAMOUNTBUY_val),                                       null,
                         "N1_A26",   PrintSum(OVERAMOUNTBUY_rur),                                       null,
                         "N1_A29",   PrintSum(FinRes_val),                                              null,
                         "N1_A30",   PrintSum(FinRes_rur),                                              null,
                         "N1_A31",   PrintSum(FinRes_val_com),                                          null,
                         "N1_A32",   PrintSum(FinRes_rur_com),                                          null
          );
     else
         ItogSum_buy_rur = 0;
         cmd = RSDCommand( " SELECT (lnk.t_BalanceCostBuy - lnk.t_InterestIncomeBuy - lnk.t_NKDBuyAmount) BalanceCost, " +
                           " (lnk.t_SumBuy / lnk.t_amount) Price, " +
                           " (lnk.t_BalanceCostBuy - lnk.t_NKDBuyAmount - lnk.t_InterestIncomeBuy - lnk.t_DiscountIncomeBuy - lnk.t_CostBuy) OverAmount, " +
                           " (lnk.t_BalanceCostBuy - lnk.t_InterestIncomeBuy - lnk.t_NKDBuyAmount - lnk.t_DiscountIncomeBuy - lnk.t_CostBuy), lnk.* " +
                           "   FROM dpmwrtlnk_dbt lnk " +
                           "  WHERE lnk.t_saleid = ? " );

         cmd.addParam( "", RSDBP_IN, DataSet.SumID );
         cmd.execute();

         qwery = TRsbDataSet(cmd);

         firstmov = true;
         while(qwery.MoveNext())

            ConvertToFIFace( price_buy_val, qwery.price, DateSale, FIPrice, FIFace );
            SmartConvertSum( price_buy_rur, qwery.price, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( balcost_buy_val, qwery.BalanceCost, DateSale, FIPrice, FIFace );
            SmartConvertSum( balcost_buy_rur, qwery.BalanceCost, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( sum_buy_val, qwery.SumBuy, DateSale, FIPrice, FIFace );
            SmartConvertSum( sum_buy_rur, qwery.SumBuy, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( N1_A15, qwery.NKDBUYAMOUNT, DateSale, FIFace, FIFace );
            SmartConvertSum( N1_A16, qwery.NKDBUYAMOUNT, DateSale, FIFace, NATCUR, true );

            ConvertToFIFace( N1_A13, qwery.NKDSALEAMOUNT, DateSale, FIFace, FIFace );
            SmartConvertSum( N1_A14, qwery.NKDSALEAMOUNT, DateSale, FIFace, NATCUR );

            ConvertToFIFace( N1_A25, qwery.OverAmount, DateSale, FIPrice, FIFace );
            SmartConvertSum( N1_A26, qwery.OverAmount, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( N1_A21, qwery.DiscountIncomeBuy, DateSale, FIPrice, FIFace );
            SmartConvertSum( N1_A22, qwery.DiscountIncomeBuy, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( N1_A17, qwery.InterestIncomeBuy, DateSale, FIPrice, FIFace );
            SmartConvertSum( N1_A18, qwery.InterestIncomeBuy, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( N1_A19, qwery.InterestIncomeAdd, DateSale, FIPrice, FIFace );
            SmartConvertSum( N1_A20, qwery.InterestIncomeAdd, DateSale, FIPrice, NATCUR, true );

            ConvertToFIFace( N1_A23, qwery.DiscountIncomeAdd, DateSale, FIPrice, FIFace );
            SmartConvertSum( N1_A24, qwery.DiscountIncomeAdd, DateSale, FIPrice, NATCUR, true );

            N1_A9  = SaleSum_val * (qwery.amount / Amount);
            N1_A10 = SaleSum_rur * (qwery.amount / Amount);

            N1_A11 = balcost_buy_val;
            N1_A12 = balcost_buy_rur;

            N1_A29 = N1_A9  - N1_A11 - N1_A23;
            N1_A30 = N1_A10 - N1_A12 - N1_A24;

            N1_A31 = N1_A9  - N1_A11;
            N1_A32 = N1_A10 - N1_A12;

            PrintTableLine( "N1_A1",    IIF(firstmov,DataSet.DealCode,""),                       null,
                            "N1_A2",    IIF(firstmov,date_as_string(1, DateSale),""),            null,
                            "N1_A3",    IIF(firstmov,GetDealKind( FDeals.rec, Group ),""),       null,
                            "N1_A4",    IIF(firstmov,DataSet.Name,""),                           null,
                            "N1_A5",    IIF(firstmov,FIFaceCcyAll,""),                           null,
                            "N1_A6",    qwery.amount,                                            null,
                            "N1_A7",    IIF(firstmov,PrintSum(Price_valText),""),                null,
                            "N1_A8",    IIF(firstmov,PrintSum(Price_rur),""),                    null,
                            "N1_A9",    PrintSum(N1_A9),                                         null,
                            "N1_A10",   PrintSum(N1_A10),                                        null,
                            "N1_A11",   PrintSum(N1_A11),                                        null,
                            "N1_A12",   PrintSum(N1_A12),                                        null,
                            "N1_A12_1", PrintSum(price_buy_val),                                 null,
                            "N1_A12_2", PrintSum(price_buy_rur),                                 null,
                            "N1_A12_3", PrintSum(sum_buy_val),                                   null,
                            "N1_A12_4", PrintSum(sum_buy_rur),                                   null,
                            "N1_A13",   PrintSum(N1_A13),                                        null,
                            "N1_A14",   PrintSum(N1_A14),                                        null,
                            "N1_A15",   PrintSum(N1_A15),                                        null,
                            "N1_A16",   PrintSum(N1_A16),                                        null,
                            "N1_A17",   PrintSum(N1_A17),                                        null,
                            "N1_A18",   PrintSum(N1_A18),                                        null,
                            "N1_A19",   PrintSum(N1_A19),                                        null,
                            "N1_A20",   PrintSum(N1_A20),                                        null,
                            "N1_A21",   PrintSum(N1_A21),                                        null,
                            "N1_A22",   PrintSum(N1_A22),                                        null,
                            "N1_A23",   PrintSum(N1_A23),                                        null,
                            "N1_A24",   PrintSum(N1_A24),                                        null,
                            "N1_A25",   PrintSum(N1_A25),                                        null,
                            "N1_A26",   PrintSum(N1_A26),                                        null,
                            "N1_A29",   PrintSum(N1_A29),                                        null,
                            "N1_A30",   PrintSum(N1_A30),                                        null,
                            "N1_A31",   PrintSum(N1_A31),                                        null,
                            "N1_A32",   PrintSum(N1_A32),                                        null
             );

             ItgCost_Buy_rur = ItgCost_Buy_rur + sum_buy_rur;
             ItogSum_buy_rur = ItogSum_buy_rur + sum_buy_rur;
            firstmov = false;
         end;

         PrintTableLine( "N1_A1",    "Итого по " + GetDealKind_( FDeals.rec ) + ":", null,
                         "N1_A2",    "",                                             null,
                         "N1_A3",    "",                                             null,
                         "N1_A4",    "",                                             null,
                         "N1_A5",    "",                                             null,
                         "N1_A6",    Amount,                                         null,
                         "N1_A7",    "",                                             null,
                         "N1_A8",    "",                                             null,
                         "N1_A9",    "",                                             null, 
                         "N1_A10",   PrintSum(SaleSum_rur),                          null,
                         "N1_A11",   "",                                             null, 
                         "N1_A12",   PrintSum(BalCost_rur),                          null,
                         "N1_A12_1", "",                                             null,
                         "N1_A12_2", "",                                             null,
                         "N1_A12_3", "",                                             null,
                         "N1_A12_4", PrintSum(ItogSum_buy_rur),                      null,
                         "N1_A13",   "",                                             null, 
                         "N1_A14",   PrintSum(NKDReceiv_rur),                        null,
                         "N1_A15",   "",                                             null, 
                         "N1_A16",   PrintSum(NKDPaid_rur),                          null,
                         "N1_A17",   "",                                             null, 
                         "N1_A18",   PrintSum(INTERESTINCOMEBUY_rur),                null,
                         "N1_A19",   "",                                             null, 
                         "N1_A20",   PrintSum(INTERESTINCOMEADD_rur),                null,
                         "N1_A21",   "",                                             null,   
                         "N1_A22",   PrintSum(DISCOUNTINCOMEBUY_rur),                null,
                         "N1_A23",   "",                                             null,   
                         "N1_A24",   PrintSum(DISCOUNTINCOMEADD_rur),                null,
                         "N1_A25",   "",                                             null,   
                         "N1_A26",   PrintSum(OVERAMOUNTBUY_rur),                    null,
                         "N1_A29",   "",                                             null,   
                         "N1_A30",   PrintSum(FinRes_rur),                           null,
                         "N1_A31",   "",                                             null,
                         "N1_A32",   PrintSum(FinRes_rur_com),                       null
             );

     end;

     ItgSaleSum_rur = ItgSaleSum_rur + SaleSum_rur;
     ItgBalCost_rur = ItgBalCost_rur + BalCost_rur;
     ItgNKDReceiv_rur = ItgNKDReceiv_rur + NKDReceiv_rur;
     ItgNKDPaid_rur = ItgNKDPaid_rur + NKDPaid_rur;
     ItgINTERESTINCOMEBUY_rur = ItgINTERESTINCOMEBUY_rur + INTERESTINCOMEBUY_rur;
     ItgINTERESTINCOMEADD_rur = ItgINTERESTINCOMEADD_rur + INTERESTINCOMEADD_rur;
     ItgDISCOUNTINCOMEBUY_rur = ItgDISCOUNTINCOMEBUY_rur + DISCOUNTINCOMEBUY_rur;
     ItgDISCOUNTINCOMEADD_rur = ItgDISCOUNTINCOMEADD_rur + DISCOUNTINCOMEADD_rur;
     ItgOVERAMOUNTBUY_rur = ItgOVERAMOUNTBUY_rur + OVERAMOUNTBUY_rur;
     ItgFinRes_rur = ItgFinRes_rur + FinRes_rur;
     ItgFinRes_rur_com = ItgFinRes_rur_com + FinRes_rur_com;

     AvrItgSaleSum_rur = AvrItgSaleSum_rur + SaleSum_rur;
     AvrItgBalCost_rur = AvrItgBalCost_rur + BalCost_rur;
     AvrItgNKDReceiv_rur = AvrItgNKDReceiv_rur + NKDReceiv_rur;
     AvrItgNKDPaid_rur = AvrItgNKDPaid_rur + NKDPaid_rur;
     AvrItgINTERESTINCOMEBUY_rur = AvrItgINTERESTINCOMEBUY_rur + INTERESTINCOMEBUY_rur;
     AvrItgINTERESTINCOMEADD_rur = AvrItgINTERESTINCOMEADD_rur + INTERESTINCOMEADD_rur;
     AvrItgDISCOUNTINCOMEBUY_rur = AvrItgDISCOUNTINCOMEBUY_rur + DISCOUNTINCOMEBUY_rur;
     AvrItgDISCOUNTINCOMEADD_rur = AvrItgDISCOUNTINCOMEADD_rur + DISCOUNTINCOMEADD_rur;
     AvrItgOVERAMOUNTBUY_rur = AvrItgOVERAMOUNTBUY_rur + OVERAMOUNTBUY_rur;
     AvrItgFinRes_rur = AvrItgFinRes_rur + FinRes_rur;
     AvrItgFinRes_rur_com = AvrItgFinRes_rur_com + FinRes_rur_com;

  END;

  PRIVATE MACRO СделкиПоКлиентуИДоговору( Data, ClientID, OrderID )
   var
      FDeals    = TBFile( "dl_tick.dbt", "R", 6 ),
      Group, ExistBack, CheckClientID, query, DataSet, stat, count, Num = 0, SQL = "";
   var printrep = true, OldFIID = ALLFININSTR;

   Data.FlagPrnHeadClnt = false;

   ItgSaleSum_rur = $0;
   ItgBalCost_rur = $0;
   ItgCost_Buy_rur = $0;
   ItgNKDReceiv_rur = $0;
   ItgNKDPaid_rur = $0;
   ItgINTERESTINCOMEBUY_rur = $0;
   ItgINTERESTINCOMEADD_rur = $0;
   ItgDISCOUNTINCOMEBUY_rur = $0;
   ItgDISCOUNTINCOMEADD_rur = $0;
   ItgOVERAMOUNTBUY_rur = $0;
   ItgFinRes_rur = $0;
   ItgFinRes_rur_com = $0;

   SQL =    " SELECT deal.t_DealID, deal.t_BOfficeKind, deal.t_ClientID, " +
            " deal.t_DealDate, deal.t_DealStatus, deal.t_DealCode, " +
            " wrtsum.t_Date as WrtSumDate, wrtsum.t_SumID, wrtsum.t_NKDAmount, " +
            " fininstr.t_Name, fininstr.t_FaceValueFI, fininstr.t_FIID, " +
            " paym.t_PaymentID, " +
            " leg.t_TotalCost, leg.t_Principal, leg.t_Cost, leg.t_CFI " +

            " FROM  ddl_tick_dbt deal, dpmwrtsum_dbt wrtsum, dfininstr_dbt fininstr, " +
                  " dpmpaym_dbt paym, ddl_leg_dbt leg " +

            " WHERE "+
                  " deal.t_BOfficeKind = " + string(DL_TRUSTDOC) +
              " and deal.t_ClientID    = ? " +
              " and deal.t_Department  = ? " +
              " and deal.t_DealID      = wrtsum.t_DealID " +

              " and wrtsum.t_DocKind     = " + string(DLDOC_PAYMENT) +
              " and   (wrtsum.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_SALE) +
              "     or wrtsum.t_Buy_Sale = " + string(PM_WRITEOFF_SUM_PARTIAL) + ")" +

              " and wrtsum.t_State >= " + string(PM_WRTSUM_FORM) +
              " and wrtsum.t_Date  >= ? " +
              " and wrtsum.t_Date  <= ? " +
              " and wrtsum.t_FIID   = fininstr.t_FIID ";

              if( Data.AvrFIID > ALLFININSTR )
               SQL = SQL + " and fininstr.t_FIID = ? ";
              end;
              SQL = SQL + " and wrtsum.t_Kind not in (" + string(200/*PM_WRTSUM_KIND_RRWAS1*/) + ", "
                                                        + string(290/*PM_WRTSUM_KIND_RRAS1*/) + ")" +

              " and leg.t_DealID = deal.t_DealID " +
              IIF(Data.AvrKind == -1, "", " and RSB_FIInstr.FI_AvrKindsEQ( 2, " + string(Data.AvrKind) + ", fininstr.t_AvoirKind ) = 1 " ) +
              IIF(Data.FICode  == -1, "", " and fininstr.t_FaceValueFI = " + string(Data.FICode )) +

              " AND deal.t_ClientContrID = ? " +

              " and wrtsum.t_DocID      = paym.t_PaymentID " +
              " and   ( (paym.t_Purpose = " + string(BAi) + /*по 1 части - продажа или частичное погашение*/
              "      and leg.t_LegKind  = " + string(LEG_KIND_DL_TICK) + ")" +
              "    or   (paym.t_Purpose = " + string(BRi) + /*по 2 части - покупка*/
              "      and leg.t_LegKind  = " + string(LEG_KIND_DL_TICK_BACK) + ") )";

              if( Data.ByIss )
               SQL = SQL + " ORDER BY deal.t_BOfficeKind, deal.t_ClientID, fininstr.t_FIID, deal.t_DealDate, deal.t_DealID";  /*по 6-му ключу*/
              else
               SQL = SQL + " ORDER BY deal.t_BOfficeKind, deal.t_ClientID, deal.t_DealDate, deal.t_DealID";  /*по 6-му ключу*/
              end;


   query = RSDCommand(SQL);
   query.addParam( "", RSDBP_IN, ClientID );
   query.addParam( "", RSDBP_IN, Data.DprtID );
   query.addParam( "", RSDBP_IN, Data.dateMin );
   query.addParam( "", RSDBP_IN, Data.dateMax );
   if( Data.AvrFIID > ALLFININSTR )
      query.addParam( "", RSDBP_IN, Data.AvrFIID );
   end;
   query.addParam( "", RSDBP_IN, OrderID );
   query.execute();
   DataSet = TRsbDataSet( query, RSDVAL_CLIENT, RSDVAL_STATIC );
   DataSet.MoveLast();
   count = DataSet.GetRecCount();
   stat = DataSet.MoveFirst();

//   InitProgress( count, "Просмотр сделок", "Просмотр сделок" );
   while( stat )
      if( ((OldFIID != DataSet.rec.FIID) AND (Data.ByIss == TRUE)) OR (Data.FlagPrintIss == true) )
         Data.FlagPrintIss = true;
         OldFIID = DataSet.rec.FIID;
      else
         Data.FlagPrintIss = false;
      end;

      printrep = true;

      if( ClientID <= 0 )
         CheckClientID = {OurBank};
      else
         CheckClientID = ClientID;
      end;

      if( DataSet.DealStatus != DL_CLOSED )
         if(not БылЗакрытТорговыйДень( ConvertSQLDate(DataSet.WrtSumDate), CheckClientID ) )
            if(ClientID != -1)
               MsgBox( "Перед выпуском отчета необходимо закрыть день для клиента  '" + ПолучитьИмяКлиента(CheckClientID) + "' " );
                 printrep = false;
            end;
         end;
      end;

      if(printrep == true)
         PrintDeal( Data, DataSet );
      end;

//      UseProgress(Num = Num + 1);
      stat = DataSet.MoveNext();
   end;
   EndCopyTable();

//   RemProgress;
  END;

  PRIVATE MACRO ПолучитьИмяСубъекта(ID)
     FILE party(party);
     ClearRecord(party);
     party.PartyID = ID;
     if(not getEQ(party))
        return "";
     end;
     return party.Name;
  end;

  PRIVATE MACRO СделкиПоКлиенту( Data, ClientID )

     var sqlQuery;
     var Data1;
     var IsNotEof;
     var Num = 0;

     ClientName = ПолучитьИмяСубъекта(ClientID);

     if( Data.OrderID != -1 )
        ReoOrderID = Data.OrderID;
        СделкиПоКлиентуИДоговору(Data, ClientID, Data.OrderID);
     else

        sqlQuery = RSDCommand( " select t_id from dsfcontr_dbt where t_servkind = ? AND T_PARTYID = ? " );

        sqlQuery.addParam("servkind", RSDBP_IN, PTSK_TRUST);
        sqlQuery.addParam("PARTYID",  RSDBP_IN, ClientID);
        sqlQuery.execute();
        Data1 = TRsbDataSet(sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
        Data1.MoveLast();

        IsNotEof = Data1.MoveFirst();

//        InitProgress( Data1.GetRecCount(), HTML_StSheetName, "Отчет по договорам" );

        while( IsNotEof )
           ReoOrderID = Data1.id;
           СделкиПоКлиентуИДоговору(Data, ClientID, Data1.id);
//           UseProgress( Num = Num + 1 );
           IsNotEof = Data1.MoveNext();
        end;

//        RemProgress();
     end;

  END;

/*По конкретному филиалу*/
  PRIVATE MACRO СделкиПоФилиалу( Data )
     var Num = 0;
     var SqlQuery, SqlClnt, DataSetClnt;
     Data.FlagPrnHeadDprt = false;
     if( Data.ClientID != -1 )
        if(Data.ClientID != {OurBank})  /*наш банк не может быть клиентом у самого себя*/
//           InitProgress( 1, "Просмотр клиентов", "Просмотр клиентов" );
           СделкиПоКлиенту( Data, Data.ClientID );
//           UseProgress(1);
//           RemProgress;
        end;
     else
        SqlQuery = "select t_PartyID " +
                   "  from dclient_dbt " +      
                   " where t_ServiceKind = ? " +
                   "   and t_PartyID != ? " +   
                   "   and t_Department = ? " +
                   "   and t_Branch = 0 " +
                   " order by t_PartyID";   

        SqlClnt = RSDCommand(SqlQuery);

        SqlClnt.addParam("", RSDBP_IN, PTSK_TRUST);
        SqlClnt.addParam("", RSDBP_IN, {OurBank});
        SqlClnt.addParam("", RSDBP_IN, Data.DprtID);
        SqlClnt.execute();
        DataSetClnt = TRsbDataSet(SqlClnt);

//        InitProgress( SQL_GetNRecs(SqlQuery), "Просмотр клиентов", "Просмотр клиентов" );
        while( DataSetClnt.MoveNext() )
           СделкиПоКлиенту( Data, DataSetClnt.PartyID );
//           UseProgress(Num = Num + 1);
        end;
//        RemProgress;
     end;
  END;

/*По всем филиалам*/
  PRIVATE MACRO СделкиПоВсемФилиалам( Data )
   var  Continue_cicle, Num = 0;
   file Department( dp_dep );

   InitProgress( NRecords(Department), "Отчет \"Финансовый результат по операциям с ц/б в ДУ\"",
                 "Просмотр сделок для филиалов" );

   ClearRecord( Department );
   Department.Code = 0;
   Continue_cicle = GetGE(Department);
   while( Continue_cicle )
      if( Department.Code != {OperDprt} ) /*Свой уже распечатан (первый при запуске)*/
         Data.DprtID = Department.Code;
         СделкиПоФилиалу( Data );
      end;
      Continue_cicle = Next(Department);
      Num = Num + 1;
      UseProgress( Num );
   end;
   RemProgress;
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
  END;

  PRIVATE MACRO Create()
     if( DprtID_t == -1 ) /* Не задан филиал, то сначала для себя, затем по всем
                           оставшимся филиалам */
        Data.DprtID = {OperDprt};
        СделкиПоФилиалу( Data );
        СделкиПоВсемФилиалам( Data );
     else
        СделкиПоФилиалу( Data );
     end;

     if( Data.FlagReportRun == false )
        PrintFormatString( ReportRunFalse, "N1_ReportRunFalse", "В указанный период сделок, соответствующих параметрам отчета, не проводилось" );
        CopyAllSheetInTotalBook( NULL, false, "N1_ReportRunFalse", 1 );
     else
        AddStandardFooter( "N1_" );
        CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1 );
     end;
  END;

  initDL_CReportTemplate( TS_FinResRep_Panel(), "Report_FinResRep.xls" );
END;

TS_FinRes_Report().Run();
Exit(1);
