/*******************************************************************************
 DESCRIPTION  :   Отчеты по операции Расчет СЧА 
 PROGRAMMED BY:   Иванов А.И.
 CREATION DATE:   IAL 02 April 2010
*******************************************************************************/
IMPORT "DLReport_h.mac", "dlreport.mac", "cb_sql.mac", "oralib", "tsutil.mac", "tscateg.mac";
PRIVATE VAR ReportHeader =
"                        ##########################################\n" +
"                        ##########################################\n" +
"                        ##########################################\n";
PRIVATE VAR ReportSNP_1 = "####################                                 #####################";
PRIVATE VAR ReportSNP_2 = "#";
PRIVATE CONST TS_TYPEREPORT_STANDART   = 0,
              TS_TYPEREPORT_EXTENDET   = 1,
              TS_TYPEREPORT_OVERVALUE  = 2;
                                                                                                                                                                                                                                                                                                                             

PRIVATE CONST TS_ACTIVEKIND_CURRENCY   = 0,
              TS_ACTIVEKIND_SHARE      = 1,
              TS_ACTIVEKIND_BOND       = 2,
              TS_ACTIVEKIND_VEKSEL     = 3,
              TS_ACTIVEKIND_DERIVATIVE = 4,
              TS_ACTIVEKIND_OBLIGATION = 5,
              TS_ACTIVEKIND_REQUEST    = 6;

PRIVATE VAR TableHeadNorm = "┌─────────────────────────────────────────────────────────────┬─────────────────────┐\n"+
                            "│                         Вид актива                          │   Стоимость, руб.   │\n"+
                            "│                                                             │                     │\n"+
                            "├─────────────────────────────────────────────────────────────┼─────────────────────┤";
                
PRIVATE VAR TableHeadExtd = "┌─────────────────────────────────────────────────────────────┬──────────────────────┬─────────────────────┐\n"+
                            "│                         Вид актива                          │        Эмитент       │   Стоимость, руб.   │\n"+
                            "│                                                             │                      │                     │\n"+
                            "├─────────────────────────────────────────────────────────────┼──────────────────────┼─────────────────────┤";


PRIVATE CLASS Report_Iterator( ObjKind, OrderID, CalcDate )
  VAR m_Object:VARIANT;
  VAR cmd, m_RS, m_ObjKind = ObjKind, m_OrderID = OrderID, m_CalcDate = CalcDate;

  MACRO MoveNext()
    var stat = m_RS.MoveNext();

    if( stat )
       if( (m_ObjKind == TS_ACTIVEKIND_OBLIGATION) OR
           (m_ObjKind == TS_ACTIVEKIND_REQUEST)
         )
          m_Object = TS_DemandFD( 0, m_RS.rec.ID );
       else
          m_Object = TS_ActiveFD( 0, m_RS.rec.ID );
       end;
    end;

    return stat;
  END;

  MACRO NameKind()
    if( m_ObjKind == TS_ACTIVEKIND_CURRENCY )
       return "Денежные средства";
    elif( m_ObjKind == TS_ACTIVEKIND_SHARE )
       return "Акции";
    elif( m_ObjKind == TS_ACTIVEKIND_BOND )
       return "Облигации";
    elif( m_ObjKind == TS_ACTIVEKIND_VEKSEL )
       return "Векселя";
    elif( m_ObjKind == TS_ACTIVEKIND_DERIVATIVE )
       return "Срочные инструменты";
    elif( m_ObjKind == TS_ACTIVEKIND_OBLIGATION )
       return "Обязательства";
    elif( m_ObjKind == TS_ACTIVEKIND_REQUEST )
       return "Требования";
    end;
  END;

  MACRO Init( WhereCond )

    if( m_ObjKind == TS_ACTIVEKIND_CURRENCY )
       cmd = RSDCommand(" SELECT active.t_ID " + 
                        "   FROM dtsactive_dbt active, dfininstr_dbt fi " +
                        "  WHERE     active.t_Kind = ? " +
                        "        AND active.t_FIID = fi.t_FIID " +
                        "        AND fi.t_FI_Kind = ? " +
                        "        AND active.t_OrderID = ? " + WhereCond
                       );
       cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_EMISSIVE );
       cmd.addParam( "", RSDBP_IN, FIKIND_CURRENCY );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.execute();

    elif( m_ObjKind == TS_ACTIVEKIND_SHARE )
       cmd = RSDCommand(" SELECT active.t_ID " + 
                        "   FROM dtsactive_dbt active, dfininstr_dbt fi " +
                        "  WHERE     active.t_Kind = ? " +
                        "        AND active.t_FIID = fi.t_FIID " +
                        "        AND fi.t_FI_Kind = ? " +
                        "        AND RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                        "        AND active.t_OrderID = ? " + WhereCond +
                        " ORDER BY fi.t_Issuer"
                       );
       cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_EMISSIVE );
       cmd.addParam( "", RSDBP_IN, FIKIND_AVOIRISS );
       cmd.addParam( "", RSDBP_IN, AVOIRISSKIND_SHARE );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.execute();

    elif( m_ObjKind == TS_ACTIVEKIND_BOND )
       cmd = RSDCommand(" SELECT active.t_ID " + 
                        "   FROM dtsactive_dbt active, dfininstr_dbt fi " +
                        "  WHERE     active.t_Kind = ? " +
                        "        AND active.t_FIID = fi.t_FIID " +
                        "        AND fi.t_FI_Kind = ? " +
                        "        AND RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                        "        AND active.t_OrderID = ? " + WhereCond +
                        " ORDER BY fi.t_Issuer"
                       );
       cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_EMISSIVE );
       cmd.addParam( "", RSDBP_IN, FIKIND_AVOIRISS );
       cmd.addParam( "", RSDBP_IN, AVOIRISSKIND_BOND );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.execute();

    elif( m_ObjKind == TS_ACTIVEKIND_VEKSEL )
       cmd = RSDCommand(" SELECT active.t_ID " + 
                        "   FROM dtsactive_dbt active, dvsbanner_dbt vsbanner " +
                        "  WHERE     active.t_Kind = ? " +
                        "        AND active.t_OrderID = ? " +
                        "        AND vsbanner.t_BCID = active.t_FIID " + WhereCond +
                        " ORDER BY vsbanner.t_Issuer"
                       );
       cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_INDIVIDUAL );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.execute();

    elif( m_ObjKind == TS_ACTIVEKIND_DERIVATIVE )
       cmd = RSDCommand(" SELECT active.t_ID " + 
                        "   FROM dtsactive_dbt active, dfininstr_dbt fi " +
                        "  WHERE     active.t_Kind = ? " +
                        "        AND active.t_FIID = fi.t_FIID " +
                        "        AND fi.t_FI_Kind = ? " +
                        "        AND active.t_OrderID = ? " + WhereCond +
                        " ORDER BY fi.t_Issuer"
                       );
       cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_EMISSIVE );
       cmd.addParam( "", RSDBP_IN, FIKIND_DERIVATIVE );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.execute();

    elif( m_ObjKind == TS_ACTIVEKIND_OBLIGATION )
       cmd = RSDCommand("SELECT t.t_ID " +
                        "  FROM dtsdemand_dbt t" +
                        " WHERE     ( t.t_OrderID = ? OR " + 
                        "             t.t_OrderID in (SELECT t_ID FROM dtsorder_dbt WHERE t_OFBU = ? ) ) " +
                        "       AND ( (t.t_State = ?) OR " +
                        "             ( (t.t_State in(?,?)) AND (t.t_FactCloseDate > ?) ) ) " + 
                        "       AND t.t_OpenDate = (case when (t.t_EventID = ?) then ? else t.t_OpenDate end) " + /* для исключения корректировочных ТО за другие дни */
                        "       AND t.t_Role = ? " + WhereCond +
                        " ORDER BY t.t_EventID"
                       );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_STATE_PLAN );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_STATE_EXECUTE );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_STATE_WRITEOFF );
       cmd.addParam( "", RSDBP_IN, m_CalcDate );
       cmd.addParam( "", RSDBP_IN, TS_DemandEvent("75") );
       cmd.addParam( "", RSDBP_IN, m_CalcDate );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_ROLE_OBLIGATION );
       cmd.execute();

    elif( m_ObjKind == TS_ACTIVEKIND_REQUEST )
       cmd = RSDCommand("SELECT t.t_ID " +
                        "  FROM dtsdemand_dbt t" +
                        " WHERE     ( t.t_OrderID = ? OR " + 
                        "             t.t_OrderID in (SELECT t_ID FROM dtsorder_dbt WHERE t_OFBU = ? ) ) " +
                        "       AND ( (t.t_State = ?) OR " +
                        "             ( (t.t_State in(?,?)) AND (t.t_FactCloseDate > ?) ) ) " + 
                        "       AND t.t_OpenDate = (case when (t.t_EventID = ?) then ? else t.t_OpenDate end) " + /* для исключения корректировочных ТО за другие дни */
                        "       AND t.t_Role = ? " + WhereCond +
                        " ORDER BY t.t_EventID"
                       );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.addParam( "", RSDBP_IN, m_OrderID );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_STATE_PLAN );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_STATE_EXECUTE );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_STATE_WRITEOFF );
       cmd.addParam( "", RSDBP_IN, m_CalcDate );
       cmd.addParam( "", RSDBP_IN, TS_DemandEvent("75") );
       cmd.addParam( "", RSDBP_IN, m_CalcDate );
       cmd.addParam( "", RSDBP_IN, TS_DEMAND_ROLE_REQUEST );
       cmd.execute();

    end;

    if( cmd )
       m_RS = TRsbDataSet( cmd );
    end;

  END;

  MACRO GetSum()
    VAR СЧА = $0;

     while( MoveNext() )
       СЧА = СЧА + m_Object.СЧА_ЗнакУчетаСтоимости() * m_Object.СЧА_СтоимостьОбьекта( m_CalcDate, false );
     end;

     return СЧА;
  END;

  Init("");
END;

PRIVATE CLASS Report_Standart( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_Itog = $0;

  MACRO BeginReport()
     m_Report.SetActiveSheet( "RASO418" );

     if( m_Report.OrderFD.ЭтоПаевойОФБУ() )
        m_Report.PrintFormatString( ReportHeader, "H0_0", "Расчет СЧА и денежного эквивалента Номинального Пая" );
     else
        m_Report.PrintFormatString( ReportHeader, "H0_0", "Расчет СЧА" );
     end;

     m_Report.PrintFormatString( ReportHeader, "H0_1", TS_IIF( m_Report.OrderFD.Kind == TS_DOC_IDDU, "Договор ", "ОФБУ " + TS_GetPartyName({OurBank}) ) +
                                                       " № " + m_Report.OrderFD.Number() + " " +
                                                       TS_IIF( m_Report.OrderFD.Kind == TS_DOC_IDDU, "", m_Report.OrderFD.Order().rec.Name ) );
     m_Report.PrintFormatString( ReportHeader, "H0_2", "по итогам за " + string(m_Report.CalcDate)  );

     m_Report.RegisterTable( "H0_MainTable", TableHeadNorm,
               /*1  */       "A0_1",       
               /*2  */       "A0_2"
                           );
  END;

  MACRO PrintLines( ActiveKind )
    VAR Iterator = Report_Iterator( ActiveKind, m_Report.OrderFD.Order.rec.ID, m_Report.CalcDate );
    VAR СЧА = Iterator.GetSum(), cmd, RS, DemName;

    if( (ActiveKind == TS_ACTIVEKIND_OBLIGATION) OR (ActiveKind == TS_ACTIVEKIND_REQUEST) )
       СЧА = $0;
       m_Report.SetCurrentLineFont( 12, true, false );
       m_Report.PrintTableLine( "A0_1", Iterator.NameKind(), null,
                                "A0_2", "", null );

       cmd = RSDCommand("SELECT distinct t.t_EventID EventID " +
                        "  FROM dtsdemand_dbt t" +
                        " WHERE     ( t.t_OrderID = ? OR " + 
                        "             t.t_OrderID in (SELECT t_ID FROM dtsorder_dbt WHERE t_OFBU = ? ) ) " +
                        "       AND t.t_Role = ? " +
                        " ORDER BY t.t_EventID"
                       );
       cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
       cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
       cmd.addParam( "", RSDBP_IN, TS_IIF( ActiveKind == TS_ACTIVEKIND_OBLIGATION, TS_DEMAND_ROLE_OBLIGATION, TS_DEMAND_ROLE_REQUEST ) );
       cmd.execute();
       if( cmd )
          RS = TRsbDataSet( cmd );
       end;

       while( RS.MoveNext() )
          Iterator.Init( " AND t.t_EventID = " + RS.rec.EventID );
          СЧА = Iterator.GetSum();
          if( СЧА != 0 )
             TS_GetValueLL( OBJTYPE_TSEVENT, RS.rec.EventID, NULL, @DemName );
             m_Report.PrintTableLine( "A0_1", "  " + DemName, null,
                                      "A0_2", СЧА, null );
          end;
          m_Itog = m_Itog + СЧА;
       end;
     else
       m_Report.PrintTableLine( "A0_1", Iterator.NameKind(), null,
                                "A0_2", СЧА, null );
       m_Itog = m_Itog + СЧА;
     end;
  END;

  MACRO PrintItogAndInfoShare()
     m_Report.PrintTableLine( "A0_1", "ИТОГО:", null,
                              "A0_2", m_Itog, null );
     m_Report.EndTable();

     if( m_Report.OrderFD.ЭтоПаевойОФБУ() )
        m_Report.PrintFormatString( ReportSNP_1, "F1_1", "Количество паев, шт.",
                                                 "F1_2", m_Report.OrderFD.КоличествоПаев(m_Report.CalcDate) );
        m_Report.PrintFormatString( ReportSNP_2, "F2_0", "Денежный эквивалент Номинального пая, руб."       );
        m_Report.PrintFormatString( ReportSNP_1, "F3_1", "на " + string(m_Report.CalcDate + 1),
                                                 "F3_2", m_Report.OrderFD.СНП(m_Report.CalcDate + 1)        );
     else
        m_Report.PrintFormatString( ReportSNP_1, "F1_1", "",
                                                 "F1_2", "");
        m_Report.PrintFormatString( ReportSNP_2, "F2_0", "");
        m_Report.PrintFormatString( ReportSNP_1, "F3_1", "",
                                                 "F3_2", "");
     end;
  END;

  MACRO EndReport()
     m_Report.PrintFormatString( ReportHeader, "F0_4_1", TS_GetPartyName({OurBank}) );
     m_Report.PrintFormatString( ReportHeader, "F0_4_2", m_Report.НачальникОтдела() );
     m_Report.PrintFormatString( ReportHeader, "F0_4_3", {FIO_Book} );
     m_Report.PrintFormatString( ReportHeader, "F0_4_4", m_Report.Операционист() );
  END;         
END;

PRIVATE CLASS Report_Extendet( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_Itog = $0;

  MACRO BeginReport()
     m_Report.SetActiveSheet( "RASO419" );

     m_Report.PrintFormatString( ReportHeader, "H1_0", "Информация о стоимости чистых активов" );
     m_Report.PrintFormatString( ReportHeader, "H1_1", TS_IIF( m_Report.OrderFD.Kind == TS_DOC_IDDU, "Договор ", "ОФБУ " + TS_GetPartyName({OurBank}) ) +
                                                       " № " + m_Report.OrderFD.Number() + " " +
                                                       TS_IIF( m_Report.OrderFD.Kind == TS_DOC_IDDU, "", m_Report.OrderFD.Order().rec.Name ) );
     m_Report.PrintFormatString( ReportHeader, "H1_2", "рассчитанной по итогам за " + string(m_Report.CalcDate)  );

     m_Report.RegisterTable( "H1_MainTable", TableHeadNorm,
               /*1  */       "A1_1",       
               /*2  */       "A1_2",
               /*3  */       "A1_3"
                           );
  END;

  MACRO PrintLines( ActiveKind )
    VAR Iterator = Report_Iterator( ActiveKind, m_Report.OrderFD.Order.rec.ID, m_Report.CalcDate );
    VAR СЧА = $0, SubItog = $0, cmd, RS, DemName;

      if( (ActiveKind == TS_ACTIVEKIND_OBLIGATION) OR (ActiveKind == TS_ACTIVEKIND_REQUEST))
         if( ActiveKind == TS_ACTIVEKIND_OBLIGATION )
            Iterator.Init( " AND t.t_EventID in (" + TS_DemandEvent("61") + "," + TS_DemandEvent("62") + "," + TS_DemandEvent("63") + "," + TS_DemandEvent("64") + 
                                               "," + TS_DemandEvent("65") + "," + TS_DemandEvent("66") + "," + TS_DemandEvent("67") + "," + TS_DemandEvent("67") + 
                                               "," + TS_DemandEvent("67") + "," + TS_DemandEvent("68") + "," + TS_DemandEvent("69") + " )" );
            СЧА = Iterator.GetSum();
            m_Report.PrintTableLine( "A1_1", "Обязательства по уплате вознаграждения и комиссий", null,
                                     "A1_2", "", null,
                                     "A1_2", СЧА, null );
            SubItog = SubItog + СЧА;
            Iterator.Init( " AND t.t_EventID in (" + TS_DemandEvent("85") + ")" );
            СЧА = Iterator.GetSum();
            m_Report.PrintTableLine( "A1_1", "Обязательства по увеличению капитала", null,
                                     "A1_2", "", null,
                                     "A1_2", СЧА, null );
            SubItog = SubItog + СЧА;
         end;

         cmd = RSDCommand("SELECT distinct t.t_EventID EventID " +
                          "  FROM dtsdemand_dbt t" +
                          " WHERE     ( t.t_OrderID = ? OR " + 
                          "             t.t_OrderID in (SELECT t_ID FROM dtsorder_dbt WHERE t_OFBU = ? ) ) " +
                          "       AND t.t_Role = ? " +
                          TS_IIF( ActiveKind == TS_ACTIVEKIND_OBLIGATION, 
                          " AND t.t_EventID not in (" + TS_DemandEvent("61") + "," + TS_DemandEvent("62") + "," + TS_DemandEvent("63") + "," + TS_DemandEvent("64") + 
                                               "," + TS_DemandEvent("65") + "," + TS_DemandEvent("66") + "," + TS_DemandEvent("67") + "," + TS_DemandEvent("67") + 
                                               "," + TS_DemandEvent("67") + "," + TS_DemandEvent("68") + "," + TS_DemandEvent("69") + "," + TS_DemandEvent("85") + " ) ", "") + 
                          " ORDER BY t.t_EventID"
                         );
         cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
         cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
         cmd.addParam( "", RSDBP_IN, TS_IIF( ActiveKind == TS_ACTIVEKIND_OBLIGATION, TS_DEMAND_ROLE_OBLIGATION, TS_DEMAND_ROLE_REQUEST ) );
         cmd.execute();
         if( cmd )
            RS = TRsbDataSet( cmd );
         end;

         while( RS.MoveNext() )
            Iterator.Init( " AND t.t_EventID = " + RS.rec.EventID );
            СЧА = Iterator.GetSum();
            if( СЧА != 0 )
               TS_GetValueLL( OBJTYPE_TSEVENT, RS.rec.EventID, NULL, @DemName );
               m_Report.PrintTableLine( "A1_1", DemName, null,
                                        "A1_2", "", null,
                                        "A1_2", СЧА, null );
            end;
            SubItog = SubItog + СЧА;
         end;

      elif( ActiveKind == TS_ACTIVEKIND_VEKSEL )
         cmd = RSDCommand(" SELECT distinct vsbanner.t_Issuer IssuerID" + 
                          "   FROM dtsactive_dbt active, dvsbanner_dbt vsbanner " +
                          "  WHERE     active.t_Kind = ? " +
                          "        AND active.t_OrderID = ? " +
                          "        AND vsbanner.t_BCID = active.t_FIID "
                         );
         cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_INDIVIDUAL );
         cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
         cmd.execute();
         if( cmd )
            RS = TRsbDataSet( cmd );
         end;

         while( RS.MoveNext() )
            Iterator.Init( " AND vsbanner.t_Issuer = " + RS.rec.IssuerID );
            СЧА = Iterator.GetSum();
            if( СЧА != 0 )
               m_Report.PrintTableLine( "A1_1", Iterator.NameKind(), null,
                                        "A1_2", TS_GetPartyName(RS.rec.IssuerID), null,
                                        "A1_2", СЧА, null );
            end;
            SubItog = SubItog + СЧА;
         end;
      elif( ActiveKind == TS_ACTIVEKIND_CURRENCY )
         Iterator.Init( " AND active.t_DepositoryID = " + РКЦ() );
         СЧА = Iterator.GetSum();
         m_Report.PrintTableLine( "A1_1", Iterator.NameKind() + " в РКЦ", null,
                                  "A1_2", "", null,
                                  "A1_2", СЧА, null );
         SubItog = SubItog + СЧА;

         cmd = RSDCommand(" SELECT distinct active.t_DepositoryID DepositoryID" + 
                          "   FROM dtsactive_dbt active, dfininstr_dbt fi " +
                          "  WHERE     active.t_Kind = ? " +
                          "        AND active.t_FIID = fi.t_FIID " +
                          "        AND fi.t_FI_Kind = ? " +
                          "        AND active.t_OrderID = ? " +
                          "        AND active.t_DepositoryID <> ? " );
         cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_EMISSIVE );
         cmd.addParam( "", RSDBP_IN, FIKIND_CURRENCY );
         cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
         cmd.addParam( "", RSDBP_IN, РКЦ() );
         cmd.execute();

         if( cmd )
            RS = TRsbDataSet( cmd );
         end;

         while( RS.MoveNext() )
            Iterator.Init( " AND active.t_DepositoryID = " + RS.rec.DepositoryID );
            СЧА = Iterator.GetSum();
            if( СЧА != 0 )
               m_Report.PrintTableLine( "A1_1", Iterator.NameKind() + " в " + TS_GetPartyName(RS.rec.DepositoryID), null,
                                        "A1_2", "", null,
                                        "A1_2", СЧА, null );
            end;
            SubItog = SubItog + СЧА;
         end;
      else
         cmd = RSDCommand(" SELECT distinct fi.t_Issuer IssuerID" + 
                          "   FROM dtsactive_dbt active, dfininstr_dbt fi " +
                          "  WHERE     active.t_Kind = ? " +
                          "        AND active.t_FIID = fi.t_FIID " +
                          "        AND fi.t_FI_Kind in ( ? , ?) " +
                          "        AND active.t_OrderID = ? " +
                          " ORDER BY fi.t_Issuer"
                         );
         cmd.addParam( "", RSDBP_IN, TS_ACTIVE_KIND_EMISSIVE );
         cmd.addParam( "", RSDBP_IN, FIKIND_AVOIRISS );
         cmd.addParam( "", RSDBP_IN, FIKIND_DERIVATIVE );
         cmd.addParam( "", RSDBP_IN, m_Report.OrderFD.Order.rec.ID );
         cmd.execute();

         if( cmd )
            RS = TRsbDataSet( cmd );
         end;

         while( RS.MoveNext() )
            Iterator.Init( " AND fi.t_Issuer = " + RS.rec.IssuerID );
            СЧА = Iterator.GetSum();
            if( СЧА != 0 )
               m_Report.PrintTableLine( "A1_1", Iterator.NameKind(), null,
                                        "A1_2", TS_GetPartyName(RS.rec.IssuerID), null,
                                        "A1_2", СЧА, null );
            end;
            SubItog = SubItog + СЧА;
         end;
      end;
     m_Report.SetCurrentLineFont( 12, true, false );
     m_Report.PrintTableLine( "A1_1", "     " + Iterator.NameKind() + ", итого", null,
                              "A1_2", "", null,
                              "A1_2", SubItog, null );
     m_Itog = m_Itog + SubItog;
  END;

  MACRO PrintItogAndInfoShare()
     m_Report.SetCurrentLineFont( 12, true, false );
     m_Report.PrintTableLine( "A1_1", "     ИТОГО:", null,
                              "A1_2", "", null,
                              "A1_2", m_Itog, null );
     m_Report.EndTable();
  END;

  MACRO EndReport()
     m_Report.PrintFormatString( ReportHeader, "F1_4_1", TS_GetPartyName({OurBank}) );
     m_Report.PrintFormatString( ReportHeader, "F1_4_2", m_Report.НачальникОтдела() );
     m_Report.PrintFormatString( ReportHeader, "F1_4_3", {FIO_Book} );
     m_Report.PrintFormatString( ReportHeader, "F1_4_4", m_Report.Операционист() );
  END;         
END;


CLASS (DL_CReportTemplate) TS_CalcCostRep_Report( ServOp, _TypeRep, _OrderID, _CalcDate )
  VAR OrderFD:TS_OrderFD;
  VAR m_ServOp = ServOp;
  VAR CalcDate, TypeRep = _TypeRep, OrderID;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  MACRO НачальникОтдела()
     var RS = TRsbDataSet("SELECT party.t_Name " +
                          "  FROM dofficer_dbt officer, dparty_dbt party " +
                          " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                          "       officer.t_OfficeID = " + string(SelfDivision) + " AND " +
                          "       officer.t_IsFirstOfficePerson = 'X' AND "
                          "       party.t_PartyID = officer.t_PersonID "
                         );

     if( RS.MoveNext() )
        return RS.Name;
     end;
     return "";
  END;

  MACRO Операционист()
     var RS = TRsbDataSet("SELECT person.t_Name " +
                          "  FROM dperson_dbt person " +
                          " WHERE person.t_oper = " + string({oper})
                         );

     if( RS.MoveNext() )
        return RS.Name;
     end;
     return "";
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
     ObjReport.BeginReport();

     if( TypeRep == TS_TYPEREPORT_STANDART )
        ObjReport.PrintLines(TS_ACTIVEKIND_CURRENCY);
     end;
     ObjReport.PrintLines(TS_ACTIVEKIND_SHARE);
     ObjReport.PrintLines(TS_ACTIVEKIND_BOND);
     ObjReport.PrintLines(TS_ACTIVEKIND_VEKSEL);
     ObjReport.PrintLines(TS_ACTIVEKIND_DERIVATIVE);
     if( TypeRep != TS_TYPEREPORT_STANDART )
        ObjReport.PrintLines(TS_ACTIVEKIND_CURRENCY);
     end;
     ObjReport.PrintLines(TS_ACTIVEKIND_OBLIGATION);
     ObjReport.PrintLines(TS_ACTIVEKIND_REQUEST);

     ObjReport.PrintItogAndInfoShare();
     ObjReport.EndReport();
  END;

  PRIVATE MACRO RunByOrder( OrderID:INTEGER )
     OrderFD = TS_OrderFD( 0, OrderID );

     if( TypeRep == TS_TYPEREPORT_STANDART )
        ExecuteReport( Report_Standart(this) );
     else
        ExecuteReport( Report_Extendet(this) );
     end;
  END;

  PRIVATE MACRO Create()
    if( OrderID > 0 )
       RunByOrder( OrderID );
    else
       if( (m_ServOp != NULL) AND (m_ServOp.rec.Kind_Operation == TS_DOC_CALC_COST_ACTIVE ) )

          CreateTotalBook();

          InitProgress(  -1, "Отчет по операции \"Расчет СЧА\"", "Просмотр договоров" );

          var ExecRep = 0, RSD, SQLcmd = RSDCommand("select distinct t_OrderID from dtstotal_dbt where t_totaltype = ? AND t_dockind = ? AND t_docid = ? ");

          SQLcmd.addParam( "", RSDBP_IN, ДУ_ИТОГ_СЧА );
          SQLcmd.addParam( "", RSDBP_IN, m_ServOp.rec.Kind_Operation );
          SQLcmd.addParam( "", RSDBP_IN, m_ServOp.rec.ID );
          SQLcmd.execute();

          RSD = TRsbDataSet(SQLcmd);

          while( RSD.MoveNext() )
             RunByOrder( RSD.OrderID );
             if( TypeRep == TS_TYPEREPORT_STANDART )
                CopyAllSheetInTotalBook( "RASO418", false, "RAS0418_ALL", 2 );
             else
                CopyAllSheetInTotalBook( "RASO419", false, "RAS0419_ALL", 2 );
             end;
             ExecRep = ExecRep + 1;
             UseProgress( ExecRep );
          end;

          if( ExecRep == 0 )
             MsgBox( "Нет договоров по операции." );
          end;

          SaveTotalBook();

          RemProgress();
       end;
    end;

  END;

  if( m_ServOp != NULL )
     CalcDate = m_ServOp.rec.StepDate;
     OrderID  = m_ServOp.rec.OrderID;
  else
     CalcDate = _CalcDate;
     OrderID  = _OrderID;
  end;
  
  initDL_CReportTemplate( NULL, "Report_TsCalcCostOp.xls" );
END;

MACRO PrintStandartRep( ServOp:TRecHandler )
   TS_CalcCostRep_Report(ServOp, TS_TYPEREPORT_STANDART).Run();
END;

MACRO PrintExtendetRep( ServOp:TRecHandler )
   TS_CalcCostRep_Report(ServOp, TS_TYPEREPORT_EXTENDET).Run();
END;

MACRO PrintOvervalueRep( ServOp:TRecHandler )
   TS_CalcCostRep_Report(ServOp, TS_TYPEREPORT_OVERVALUE).Run();
END;

MACRO PrintOrderStandartRep( OrderID )
  VAR dat = {CurDate};
   if( not GetDate( dat,"Введите дату выпуска отчета") ) 
      return 1;
   end;

   TS_CalcCostRep_Report(NULL, TS_TYPEREPORT_STANDART, OrderID, dat).Run();
END;

MACRO PrintOrderExtendetRep( OrderID )
  VAR dat = {CurDate};
   if( not GetDate( dat,"Введите дату выпуска отчета") ) 
      return 1;
   end;

   TS_CalcCostRep_Report(NULL, TS_TYPEREPORT_EXTENDET, OrderID, dat).Run();
END;
