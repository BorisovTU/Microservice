/* IAL 11 November 2008                               */
/*                                                    */   
/* ДУ (Доверительное управление )                     */
/*                                                    */
/* Операция покупки ц/б внебиржевая  ДУ               */
/* Исполнение требований: поставка ц/б                */

import InsCarryDoc, "tssec.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation )
  record deal(dl_tick);
  var    FD:SPFirstDocTrust, dat:date;
  var    PCalcDU_Acc      = TRecHandler("account.dbt" );
  var    MCalcDU_Acc      = TRecHandler("account.dbt" );
  var    MCalcDU_ORCB_Acc = TRecHandler("account.dbt" );
  var    DebtCat, DebtFIID, DebtFiRole;

  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;
/*
  if( not FD.OpenAccount( "+Расчеты, ДУ", null, null, FIROLE_ORCB, PCalcDU_Acc, dat) )
     return 1;
  end;

  if( TS_ChangeAccountDemandSEC(ID_Operation, TS_DEMAND_ROLE_REQUEST, "опл", PCalcDU_Acc.rec.Account) == false )
     return 1;
  end;

  if( not FD.OpenAccount( "-Расчеты, ДУ", null, null, FIROLE_SECURITIES, MCalcDU_Acc, dat) )
     return 1;
  end;

  if( TS_ChangeAccountDemandSEC(ID_Operation, TS_DEMAND_ROLE_OBLIGATION, "пост", MCalcDU_Acc.rec.Account) == false )
     return 1;
  end;

  if( not FD.OpenAccount( "-Расчеты, ДУ", null, null, FIROLE_ORCB, MCalcDU_ORCB_Acc, dat) )
     return 1;
  end;

  if( TS_ChangeAccountDemandSEC(ID_Operation, TS_DEMAND_ROLE_REQUEST, "НКДполуч", MCalcDU_ORCB_Acc.rec.Account) == false )
     return 1;
  end;
*/
  /*Исполнение требований и обязательств по сделке*/
  if( FD.ВидСрочностиСделки() != СделкаToday )
     DebtCat = "-Расчеты, ДУ";
     DebtFIID = FD.GetPayFIID();
     DebtFIRole = FIROLE_BA;
  else
     DebtCat = "ДС ДУ";
     DebtFIID = FD.GetPayFIID();
     DebtFIRole = null;
  end;

  if( not ПроводкаПоКатегориямУчета( FD, 
                                     DebtCat, "-Расчеты, ДУ",/* AccDeb , AccCred*/
                                     dat,                            /* Дата */
                                     2,                              /* Глава */
                                     FD.FaceFIID(),                  /* Валюта */
                                     FD.dl_leg.rec.TotalCost,        /* Сумма */
                                     FDoc,                           /* Документ */
                                     INPCARRY,                       /* Result_Carry */
                                     "",                             /* Kind_Oper */
                                     FD.tick.rec.DealCode,           /* Numb_Document */
                                     "Исполнение обязательств",      /* Ground */
                                     0, DebtFiRole, FIROLE_SECURITIES,
                                     DebtFIID, FD.FaceFIID()
                                   ) )
      return 1;
  end;

  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, dat ) != 0 )
     return false;
  end; 

  if( ОбработатьЛот( FD, FD.pmwrtsum, dat ) == false )
     return false;
  end; 

  if( not ПроставитьСтатусНаПлатеж( FD.pm_money.rec, PM_FINISHED ) )
     return 1;
  end;   

  if( not ОбновитьЛот_ЛотОплачен(FD, dat) )
      return 1;
  end;
  
  /* Внутренний учет */
  if( not ПроводкаПоКатегориямВнутреннегоУчета( 55, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.pm_avoir.rec.BaseFIID,  
                                                FD.pm_avoir.rec.Amount
                                              ) )
      return 1;
  end;

  if( TS_ExecuteDemandSEC( ID_Operation, TS_DemandUserMarkSEC_ByPaym(FD.pm_avoir, TS_DEMAND_ROLE_OBLIGATION), dat ) == false )
     return 1;
  end;

  return 0;
end;  
