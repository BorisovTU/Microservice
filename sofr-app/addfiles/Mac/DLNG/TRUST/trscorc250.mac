/* IAL XX.11.2008                                            */
/*                                                          */   
/* ДУ (Доверительное управление )                           */
/*                                                          */

/* Операция покупки ц/б на бирже (или через брокера)                       */
/*                                                                         */
/*   Шаг - Выполнение обязательств - проводки по оплате бумаг              */

import InsCarryDoc, "tssec.mac";

macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation )

  record deal(dl_tick);
  var    FD:SPFirstDocTrust, dat:date;
  var    PCalcDU_Acc      = TRecHandler("account.dbt" );
  var    MCalcDU_Acc      = TRecHandler("account.dbt" );
  var    MCalcDU_ORCB_Acc = TRecHandler("account.dbt" );
  var    CredCat, CredFIID, CredFiRole;

  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  GetOprDate( FD.GetKindDate(DATE_DEALPAY), dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  /*Исполнение требований и обязательств по сделке*/
  if( FD.ВидСрочностиСделки() != СделкаToday )
     CredCat = "+Расчеты, ДУ";
     CredFIID = FD.GetPayFIID();
     CredFIRole = FIROLE_CA;
  else
     CredCat = "-Расчеты, ДУ";
     CredFIID = FD.GetPayFIID();
     CredFIRole = FIROLE_SECURITIES;
  end;

  if( not ПроводкаПоКатегориямУчета( FD, 
                                     "+Расчеты, ДУ", Credcat, /* AccDeb , AccCred*/
                                     dat,                            /* Дата */
                                     2,                              /* Глава */
                                     FD.FaceFIID(),                  /* Валюта */
                                     FD.dl_leg.rec.TotalCost,        /* Сумма */
                                     FDoc,                           /* Документ */
                                     INPCARRY,                       /* Result_Carry */
                                     "",                             /* Kind_Oper */
                                     FD.tick.rec.DealCode,           /* Numb_Document */
                                     "Учет стоимости ц/б",/* Ground */
                                     0, FIROLE_ORCB_REQUEST, CredFiRole, 
                                     FD.FaceFIID(), CredFIID
                                   ) )
      return 1;
  end;

  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, dat ) != 0 )
     return false;
  end; 

  if( ОбработатьЛот( FD, FD.pmwrtsum, dat ) == false )
     return false;
  end; 

  if( not ПроставитьСтатусНаПлатеж( FD.pm_money.rec, PM_FINISHED ) )
     return 1;
  end;   

  if( not ОбновитьЛот_ЛотОплачен(FD, dat) )
      return 1;
  end;

  /* Внутренний учет */
  if( not ПроводкаПоКатегориямВнутреннегоУчета( 20, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.GetPayFIID(), 
                                                FD.dl_leg.rec.TotalCost
                                              ) )
      return 1;
  end;

  if( not ПроводкаПоКатегориямВнутреннегоУчета( 55, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.pm_avoir.rec.BaseFIID,  
                                                FD.pm_avoir.rec.Amount
                                              ) )
      return 1;
  end;


  if( TS_ExecuteDemandSEC( ID_Operation, TS_DemandUserMarkSEC_ByPaym(FD.pm_money, TS_DEMAND_ROLE_REQUEST), dat ) == false )
     return 1;
  end;
  
  if( TS_ExecuteDemandSEC( ID_Operation, TS_DemandUserMarkSEC_ByPaym(FD.pm_avoir, TS_DEMAND_ROLE_OBLIGATION), dat ) == false )
     return 1;
  end;

  return 0;
end;