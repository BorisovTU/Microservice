/*¥ç âì ¯à®â®ª®«  à á¯à¥¤¥«¥­¨ï ¢­¥è­¥© ª®¬¨áá¨¨*/
import "tscateg.mac";
import "dlRepForm_h.mac";

macro PrintRep( defcomID ):bool
  var stat;
  var ReportFile, errcode, errtext;
  FILE ReportOutFile() txt write; /*ä ©« ¢ë¢®¤  ¤«ï ¯à®â®ª®« */
  var SfContr  = TRecHandler( "sfcontr.dbt" );
  var Order    = TRecHandler( "tsorder.dbt" );
  var Comiss   = TRecHandler( "sfcomiss.dbt" );
  var party    = TRecHandler( "party.dbt" );
  var defcom   = TRecHandler( "sfdefcom.dbt" );
  VAR doc      = TRecHandler( "acctrn.dbt" );
  var OrderFD;
  var ‚¨¤Š®¬¨áá¨¨ = "", ®¬¥à„®£®¢®à  = "";
  var „®£®¢®à„“ = "", Š«¨¥­â®„®£®¢®àã = "";
  var ‘ç¥â„â = "", ‘ç¥âŠ¤ = "";
  var RSB;
  var Query, DataSet;
  var PrintFlag = false, first = true;
  var HeadTable = "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
                  "³    „®£®¢®à „“   ³   Š«¨¥­â ¯® ¤®£®¢®àã   ³          ‘ç¥â „â          ³          ‘ç¥â Šâ          ³ ‘ã¬¬  ª®¬¨áá¨¨ ³\n" +
                  "³                 ³                        ³                           ³                           ³      (àã¡.)    ³\n" +
                  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

  if( TS_GetRecHandler( defcom, " SELECT defcom.* "+
                                "   FROM dsfdefcom_dbt defcom " +
                                "  WHERE defcom.t_ID = " + defcomID ) == false)
     return false;
  end;

  ReportFile = GetTxtFileName( "¯à®â®ª®«" );
  if( Open( ReportOutFile, ReportFile ) == false )
     errcode = status( errtext );
     MsgBox( "è¨¡ª  ¯à¨ ®âªàëâ¨¨ ä ©«  |"+ ReportFile +"|(" + errcode + ") " + errtext);
     return false;
  end;
  SetOutput( ReportFile );

  println( "”¨«¨ «: " + DL_GetDepartmentNameByCode({OperDprt}) );
  println( "                               €‘…„…‹…ˆ… ŠŒˆ‘‘ˆˆ  „ƒ‚€Œ „‚…ˆ’…‹œƒ “€‚‹…ˆŸ" );

  if( SfGetComiss( defcom.rec.feeType, defcom.rec.commNumber, Comiss ) == true )
     ‚¨¤Š®¬¨áá¨¨ = Comiss.rec.Name;
  end;
  println( "‚¨¤ ª®¬¨áá¨¨: " + ‚¨¤Š®¬¨áá¨¨ );
  if( FindSfContrByOrder( defcom.rec.ConId, SfContr ) == true )
     ®¬¥à„®£®¢®à  = SfContr.rec.Number;
  end;
  println( "ü ¤®£®¢®à : " + ®¬¥à„®£®¢®à );
  println( "‘ã¬¬  ª®¬¨áá¨¨: " + defcom.rec.CommSum);
  println( "„ â  ­ ç¨á«¥­¨ï: " + defcom.rec.DateFee + "\n");

  RSB = TRsbDataSet( " SELECT defcom.t_Id, defcom.t_conId, defcom.t_CommSum " +
                     " FROM dsfdefcom_dbt defcom " +
                     " WHERE defcom.t_ExtComID = " + defcom.rec.ID + " AND " +
                     "       defcom.t_Status = 40 " );
  stat = RSB.MoveNext();
  if(stat)
     println( HeadTable );
     PrintFlag = true;
  else
     println( "¥â à á¯à¥¤¥«¥­¨© ¯® ª®¬¨áá¨¨." );
  end;
  while(stat)
     „®£®¢®à„“ = ""; Š«¨¥­â®„®£®¢®àã = ""; ‘ç¥â„â = ""; ‘ç¥âŠ¤ = "";
     if( FindSfContrByOrder( RSB.conId, SfContr ) == true )
        if( FindOrderBySfContr( SfContr, Order ) == true )
           „®£®¢®à„“ = Order.rec.RegNum;
           if( not ®«ãç¨âì‘ã¡ê¥ªâ (Order.rec.Trustor, party))
              Š«¨¥­â®„®£®¢®àã = party.rec.ShortName;
           end;
        end;
     end;
     Query = RSDCommand( "SELECT t_ID_Operation, t_ID_Step " +
                         "  FROM doprstep_dbt " +
                         " WHERE     t_ServDocKind = ? " +
                         "       AND t_ServDocID   = ? "
                       );
     Query.addParam( "", RSDBP_IN, 939 ); /*TS_DOC_PAY_EXTERNAL_COM*/
     Query.addParam( "", RSDBP_IN, RSB.ID );
     Query.execute();
     DataSet = TRSBDataSet(query);
     if( DataSet.MoveNext() )
        Doc.Clear();
        if( GetDocsByOperStep( doc, int(SQL_ConvTypeInteger(DataSet.ID_Operation) ), int(SQL_ConvTypeInteger(DataSet.ID_Step) ) ) )
           ‘ç¥â„â = doc.rec.Account_Payer;
           ‘ç¥âŠ¤ = doc.rec.Account_Receiver
        end;
     end;
     if(not first)
        println( "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´");
     end;
     println( "³ " + String(„®£®¢®à„“:15) + " ³ " + String(Š«¨¥­â®„®£®¢®àã:22) + " ³ " + String(‘ç¥â„â:25) + " ³ " + String(‘ç¥âŠ¤:25) + " ³ " + String(RSB.CommSum:14) + " ³" );
     first = false;
     stat = RSB.MoveNext();
  end;
  if(PrintFlag == true)
     println( "ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\n" );
  end;

  var PrintHead = false;
  var rs = RsdRecordSet( " SELECT t_OperID, t_ObjectKind, t_ErrorStr FROM DTSSERVOP_ERROR_TMP TSErrLog " );
  while( rs.moveNext() )
     if( PrintHead == false )
        PrintHead = true;
[  ‘®®¡é¥­¨ï ®¯¥à æ¨¨:
 ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³    „®£®¢®à „“   ³ ID ¢­ãâà¥­­¥© ª®¬¨áá¨¨ ³                                              ‘®®¡é¥­¨¥                                                ³
];
     end;

  OrderFD = TS_OrderFD(0, rs.value("t_OperID"));
[ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
 ³#################³########################³#######################################################################################################³
]( OrderFD.Order().rec.RegNum:r, rs.value("t_ObjectKind"):r, rs.value("t_ErrorStr"):w );
  end;

  if( PrintHead == true )
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
  end;

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );

  return true;
end;
