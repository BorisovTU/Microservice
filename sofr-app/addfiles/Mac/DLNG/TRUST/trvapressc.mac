/*******************************************************************************
 FILE         :   trvapressc.mac
 COPYRIGHT    :   R-Style, 2011
 DESCRIPTION  :   Макрос скролинга операций предъявления векселей в ДУ
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   10.06.2011
*******************************************************************************/
import DealsInter, SPInter, PTInter, TSInter, globals;
import RsbDataSet;

/* Уже заполненные структуры, все изменения отразятся в базах */
PRIVATE VAR Документ         = TRecHandler( "tssrvop" );
PRIVATE VAR СтарыйДокумент   = TRecHandler( "tssrvop" ); /* заполняется при редактировании */

/* Макрофункция инициализации нового актива 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ()
  
  return 0;
END;

private macro Проверить_Документ( Режим:integer )
  var DataSet, query;
  var err = 0;

  if(Режим == TS_EXECUTE) //старт операции 
    query =   "select Count(1) as Cnt "
            + "  from dvsordlnk_dbt "
            + " where t_ContractID = " + Документ.rec.ID
            + "   and t_DocKind = " + Документ.rec.Kind_Operation;
    DataSet = TRsbDataSet(query);
    if((not DataSet.moveNext()) or (DataSet.Cnt == 0))
      msgbox("К операции не привязано ни одного векселя");
      err = 1;
    end;
  elif(Режим == TS_EDIT) //редактирование операции

    //здесь должны быть проверки при редактировании

  elif(Режим == TS_DELETE) //удаление
    
    //здесь должны быть проверки при удалении

  end;
  
  return err;
end;

/* Установка подсказки для скролингов из макроса */
private MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string

  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t dtssrvop_dbt_idx0)*/";

  return DefaultHint;

END;

/* Вызывается по CTRL+Z из скроллинга */
private macro Функция_Пользователя()
  return 0;
end;

