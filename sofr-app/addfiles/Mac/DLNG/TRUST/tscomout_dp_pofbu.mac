/* ¥à¨®¤¨ç¥áª ï ª®¬¨áá¨ï §  ¤®áà. ¢ë¢®¤ ª ¯¨â «  ¤«ï „ ¯ ¥¢®£® Ž”“ */
IMPORT "tscomiss.mac", TSInter, "tscateg.mac";

/*‡Ž á¬®âà¨â áî¤  ¤«ï ®¯à¥¤¥«¥­¨ï ®è¨¡ª¨*/
VAR MacroError :INTEGER = 0;
MACRO SayError( Error:STRING )
  MsgBox( Error );
  MacroError = 1;
END;

PRIVATE RECORD bassum("sfbassum.str");
PRIVATE VAR SfContr  = TRecHandler( "sfcontr.dbt" );
PRIVATE VAR Order    = TRecHandler( "tsorder.dbt" );
PRIVATE VAR rComiss  = TRecHandler( "sfcomiss.dbt" );
PRIVATE VAR rAlgBase = TRecHandler( "sfcalcal.dbt" );

CONST ALG_A1 = "A1",
      ALG_A2 = "A2";

/* ®«ãç¨âì ¡ §®¢ãî áã¬¬ã ¤«ï à áç¥â  ¯¥à¨®¤¨ç¥áª®© ª®¬¨áá¨¨  
  sfcontr_addr - „®£®¢®à ®¡á«ã¦¨¢ ­¨ï
  BeginDate    -  ç «® ¯¥à¨®¤ 
  EndDate      - Š®­¥æ ¯¥à¨®¤ */
MACRO CalcServiceSum( _sfcontr_addr, _BeginDate, _EndDate, _sfalg_adr  )
  VAR ServOp, CalcDate;
  VAR OrderFD:TS_OrderFD;
  VAR BeginInDate:date;
  FILE   fAlgBase( "sfcalcal.dbt" );
  RECORD rAlg( "sfclusr.str" );

  ClearRecord( bassum );
  SfContr.SetRecordAddr( _sfcontr_addr );
  rAlgBase.SetRecordAddr( _sfalg_adr );
  MacroError = 0;

  if( FindOrderBySfContr( SfContr, Order ) == false )
     SayError("¥ ­ ©¤¥­ ¤®£®¢®à „“ ¯® ¤®£®¢®àã ®¡á«ã¦¨¢ ­¨ï.");
     return;
  end;

  if( SfGetComiss( rAlgBase.rec.FeeType, rAlgBase.rec.CommNumber, rComiss ) == false )
     SayError( "Žè¨¡ª  ¯à¨ à áç¥â¥ ¡ §®¢®© áã¬¬ë ¯¥à¨®¤¨ç¥áª®© ª®¬¨áá¨¨.\n¥ ­ ©¤¥­  ª®¬¨áá¨ï ¢¨¤  " + rAlgBase.rec.FeeType + " á ­®¬¥à®¬ " + rAlgBase.rec.CommNumber );
     return;
  end;   

  if(  ç¨á«ïâìŠ®¬¨áá¨î‡ „®áà‚ë¢®¤( rComiss ) != true )
     return;
  end;

  OrderFD = TS_OrderFD( 0, Order.rec.ID );
  BeginInDate = OrderFD.„ â ¥à¢¨ç­®£®‚­¥á¥­¨ï();
  if(BeginInDate != Date(0,0,0))

     ClearRecord(fAlgBase);
     fAlgBase.FeeType     = rAlgBase.rec.FeeType;
     fAlgBase.CommNumber  = rAlgBase.rec.CommNumber;
     fAlgBase.Kind        = rAlgBase.rec.Kind;
     fAlgBase.Number      = rAlgBase.rec.Number;
     if( GetEQ(fAlgBase) == false )
        return;
     end;
     SetRecordAddr( rAlg, fAlgBase );

     if( ( (rAlg.Name == ALG_A2) and ((_EndDate - BeginInDate) >= 0) and ((_EndDate - BeginInDate) <= 180) ) or
         ( (rAlg.Name == ALG_A1) and ((_EndDate - BeginInDate) > 180) and ((_EndDate - BeginInDate) <= 365) )
       )
        if( not „“_®«ãç¨âì §®¢ãî‘ã¬¬ã( TS_COMMISS_KIND_P, @bassum.baseSum, @bassum.FIID_baseSum ) )
           return;
        end;
     end;
  end;

  bassum.baseType  = TS_SF_BASETYPE_SUM;
  bassum.baseType2 = bassum.baseType;
  bassum.baseSum2  = bassum.baseSum;
  if( InsertSumList( bassum ) )
     SayError( "Žè¨¡ª  ¯à¨ ¢áâ ¢ª¥ ¡ §®¢®© áã¬¬ë" );
     return;
  end;
END;

/*****************************************************************************
    ¥ç âì ¯®¤à®¡­®£® ®âç¥â  ® à áç¥â¥ ¯¥à¨®¤¨ç¥áª®© ª®¬¨áá¨¨
******************************************************************************/
/* ˜ ¯ª  ®âç¥â  ¯®¤à®¡­®£® ®âç¥â  ® à áç¥â¥ ¯¥à¨®¤¨ç¥áª®© ª®¬¨áá¨¨ */
macro CalcReportPrintHeader( sfrepdet )
[ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
 ³ ‘ã¬¬  ¤®¯®«­¨â¥«ì­®© ³‘â ¢ª  ³                Š®¬¨áá¨ï                ³
 ³        ¯à¨¡ë«¨       ³       ³                                        ³
 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
];                                    
   return 0;
end;

/* ¥ç âì áâà®çª¨ ®âç¥â  ¯®¤à®¡­®£® ®âç¥â  ® à áç¥â¥ ¯¥à¨®¤¨ç¥áª®© ª®¬¨áá¨¨ */
macro CalcReportPrintLine( sfrepdet )

[³################## ###³#######³####################### ################³
]( sfrepdet.baseSum, 
   ®«ãç¨âìŠ®¤”¨­ˆ­(sfrepdet.FIID_baseSum, NULL, FICK_ISOSTRING), 
   sfrepdet.tariff, 
   sfrepdet.CalcSum,
   ®«ãç¨âìŠ®¤”¨­ˆ­(sfrepdet.FIID_CalcSum, NULL, FICK_ISOSTRING)
 );

  return 0;
end;

/* ¥ç âì ®ª®­ç ­¨ï ®âç¥â  ¯®¤à®¡­®£® ®âç¥â  ® à áç¥â¥ ¯¥à¨®¤¨ç¥áª®© ª®¬¨áá¨¨ */
macro CalcReportPrintFooter( sfrepdet, TotalSum )
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
];
end;
