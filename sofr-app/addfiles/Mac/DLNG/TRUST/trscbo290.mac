/* IAL 11 November 2008                               */
/*                                                    */   
/* ДУ (Доверительное управление )                     */
/*                                                    */
/* Операция покупки ц/б внебиржевая  ДУ               */
/* Исполнение требований: поставка ц/б                */

import InsCarryDoc, "tssec.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation )
  
  record deal(dl_tick);
  record fiwarnts(fiwarnts);

  var    FD:SPFirstDocTrust, dat:date;
  var    PercentAcc     = TRecHandler("account.dbt" );
  var    MCalcDU_CA_Acc = TRecHandler("account.dbt" );
  var    CredCat, CredFIID, CredFiRole, FIRoleBA, FIRolePD;

  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );

  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  /*Исполнение требований и обязательств по сделке*/
  if( FD.ВидСрочностиСделки() != СделкаToday )
     CredCat = "+Расчеты, ДУ";
     CredFIID = FD.FaceFIID();
     CredFIRole = FIROLE_BA;
  else
     CredCat = "ДС ДУ";
     CredFIID = FD.FaceFIID();
     CredFIRole = null;
  end;

  if( TS_ExistNOSS( FD.Avoiriss, dat) )
     FIRoleBA = FIROLE_BA_TP;
     FIRolePD = FIROLE_PD_TP;
  else
     FIRoleBA = FIROLE_BA_PPR;
     FIRolePD = FIROLE_PD_PPR;
  end;

  if( not ПроводкаПоКатегориямУчета( FD, 
                                     "ПортфельЭцб ДУ", Credcat, /* AccDeb , AccCred*/
                                     dat,                            /* Дата */
                                     2,                              /* Глава */
                                     FD.FaceFIID(),                  /* Валюта */
                                     FD.dl_leg.rec.Cost,             /* Сумма */
                                     FDoc,                           /* Документ */
                                     INPCARRY,                       /* Result_Carry */
                                     "",                             /* Kind_Oper */
                                     FD.tick.rec.DealCode,           /* Numb_Document */
                                     "Учет стоимости ц/б",/* Ground */
                                     0, FIRoleBA, CredFiRole, 
                                     FD.FaceFIID(), CredFIID
                                   ) )
      return 1;
  end;

  if( ( FI_IsCouponAvoiriss( FD.fininstr ) ) AND 
      ( (FD.dl_leg.rec.TotalCost - FD.dl_leg.rec.Cost) > 0 )
    )
     if( not ПроводкаПоКатегориямУчета( FD, 
                                        "ПортфельЭцб ДУ", Credcat, /* AccDeb , AccCred*/
                                        dat,                            /* Дата */
                                        2,                              /* Глава */
                                        FD.FaceFIID(),                  /* Валюта */
                                        (FD.dl_leg.rec.TotalCost - FD.dl_leg.rec.Cost),             /* Сумма */
                                        FDoc,                           /* Документ */
                                        INPCARRY,                       /* Result_Carry */
                                        "",                             /* Kind_Oper */
                                        FD.tick.rec.DealCode,           /* Numb_Document */
                                        "Учет НКД уплаченного",/* Ground */
                                        0, FIRolePD, CredFiRole, 
                                        FD.FaceFIID(), CredFIID
                                      ) )
         return 1;
     end;
  end;


  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, dat ) )
     return false;
  end; 

  if( ОбработатьЛот( FD, FD.pmwrtsum, dat ) == false )
     return false;
  end; 

  /* Внутренний учет */
  if( not ПроводкаПоКатегориямВнутреннегоУчета( 55, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.pm_avoir.rec.BaseFIID,  
                                                FD.pm_avoir.rec.Amount
                                              ) )
      return 1;
  end;

  if( TS_ExecuteDemandSEC( ID_Operation, TS_DemandUserMarkSEC_ByPaym(FD.pm_avoir, TS_DEMAND_ROLE_REQUEST), dat ) == false )
     return 1;
  end;

  return 0;
end;  
