/* IAL 11 November 2008                               */
/*                                                    */   
/* ДУ (Доверительное управление )                     */
/*                                                    */
/* Операция покупки ц/б внебиржевая  ДУ               */
/* Расчет себестоимости ц/б                           */

import InsCarryDoc, "tssec.mac";

VAR    WriteOffGroups = TArray;   /*данные в массиве используются программой при выполнении шага*/      

macro ExecuteStep( Doc, FDoc )

  record  deal(dl_tick);
  var     FD;

  SetBuff( deal, FDoc ); 
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );


  /*В погашениях связывание может происходить и для тех лотов погашения, 
    где еще не произошла поставка ц/б*/
  if( deal.BofficeKind != DL_RETIREMENT )
     if( FD.pmwrtsum.rec.State < PM_WRTSUM_FORM )
        return SayErrorBuySale( deal, "При списании лот должен иметь статус поставлен или готов" );
     end;   
  end;

  if( bAND( FD.dl_leg.rec.BitMask, DL_LEG_ANOTHER_DEPOSITARY ) )
     return 0; /*на лоте признак "учет в другом депозитарии", ничего не делаем*/
  end; 

  if( ПолучитьГруппыСписания( FD, WriteOffGroups ) == false )
     return SayErrorBuySale( deal, "Ошибка при определении групп списания" );
  end; 
  
  return 0;
end;
