/*******************************************************************************
 DESCRIPTION  :   Отчет "Регистр НУ доходов и расходов юр. лиц в ДУ"
 PROGRAMMED BY:   Leksikov E.
 CREATION DATE:   09.2009 
*******************************************************************************/

IMPORT "tsincexp_form.mac", "DLReport_h.mac", "dlreport.mac", "tsutil.mac", "tscateg.mac", "tssec.mac", "dlvaprds.mac";

InstLoadModule("spserv.mac", "vamisc.mac");

PRIVATE VAR ReportHeader =
"                                               Регистр налогового учета доходов и расходов \n"+
"                                                      по договору № ################       \n"+
"                                                Отчетный период с #########  по  ########  \n"+
"Учредитель:                                                #############################################################          \n"+
"Дата начала договора                                       ###########          \n"+
"Дата окончания договора                                    ###########          \n"+
"Сроки выплаты доходов учредителю доверительного управления согласно Договора \n"+
"Сроки удержания комиссионного вознаграждения управляющего  согласно Договора \n\n";

PRIVATE VAR Cap2 = "Капитал в управлении на ##########";
PRIVATE VAR Cap3 = "Денежные средства / Дебиторская задолженность на ##########";
PRIVATE VAR Cap4 = "Портфель ценных бумаг по договору на ########## \n\n";
PRIVATE VAR Cap5 = "* Данная таблица предоставлена учредителю ДУ для самостоятельного расчета налогооблагаемой базы по долговым обязательствам по методу начисления (см.ст.328 гл.25 Налогового кодекса РФ)\n\n";
PRIVATE VAR Cap6 = "Сделки с ценными бумагами по договору за период с ########## по ##########";
                                                                      
PRIVATE VAR TableHeader1 =  /* Капитал в управлении на <H2.0> */
"┌────────────────┬────────────────┬─────────────┬─────────────────────────┐\n"+
"│      Дата      │     Внесено    │   Выведено  │ Остаток в управлении    │\n"+
"├────────────────┼────────────────┼─────────────┼─────────────────────────┤";  

PRIVATE VAR TableHeader2 =  /* Денежные средства / Дебиторская задолженность на <H3.0> */
"┌─────────────────────────────────┬──────────────┐\n"+
"│             Наименование        │   Остаток    │\n"+
"├─────────────────────────────────┼──────────────┤";

PRIVATE VAR TableHeader3 =  /* Вид ц/б: Акции* */
"Вид ц/б: Акции* \n"+
"┌───────────┬─────────────┬─────────────┬──────────┬──────────────────────┬─────────┬──────────┬──────────────────┬──────────────────┬──────────────────┬──────────────┐\n"+
"│  Эмитент  │  Код бумаги │ Номер гос.  │  Валюта  │      Дата и время    │ Количе- │ Портфель │ Цена и стоимость │ Цена и стоимость │ Цена и стоимость │ Переоценка   │\n"+
"│           │             │ регистрации │ номинала │        покупки       │  ство   │          │   приобретения   │     рыночная     │    балансовая    ├───────┬──────┤\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │с даты │за от-│\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │покупки│четный│\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │       │период│\n"+
"├───────────┼─────────────┼─────────────┼──────────┼───────────┬──────────┼─────────┼──────────┼───────┬──────────┼────────┬─────────┼─────────┬────────┼───────┼──────┤\n"+
"│    1      │      2      │      3      │     4    │     5     │     6    │    7    │     8    │   9   │    10    │   11   │    12   │    13   │  14    │  15   │  16  │\n"+
"├───────────┼─────────────┼─────────────┼──────────┼───────────┼──────────┼─────────┼──────────┼───────┼──────────┼────────┼─────────┼─────────┼────────┼───────┼──────┤";

PRIVATE VAR TableHeader4 =  /* Вид ц/б: Облигации* */
"Вид ц/б: Облигации* \n"+
"┌───────────┬─────────────┬─────────────┬──────────┬──────────────────────┬─────────┬──────────┬──────────────────┬──────────────────┬──────────────────┬──────────────┬──────────┬─────────────────────────────────────────────┬─────────────────────────────────────────────┐\n"+
"│  Эмитент  │  Код бумаги │ Номер гос.  │  Валюта  │      Дата и время    │ Количе- │ Портфель │ Цена и стоимость │ Цена и стоимость │ Цена и стоимость │ Переоценка   │          │   Накопленный купонный доход                │        Накопленный дисконтный доход         │\n"+
"│           │             │ регистрации │ номинала │        покупки       │  ство   │          │   приобретения   │     рыночная     │    балансовая    ├───────┬──────┼──────────┼──────────┬──────────┬───────────┬───────────┼──────────┬──────────┬───────────┬───────────┤\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │с даты │за от-│Уплаченный│Погашенный│Погашенный│Начисленный│Начисленный│Погашенный│Погашенный│Начисленный│Начисленный│\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │покупки│четный│          │за период │за отчет- │  до даты  │за отчетный│за период │за отчет- │  на дату  │за отчетный│\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │       │период│          │ от даты  │ный период│ окончания │  период   │ от даты  │ный период│ окончания │  период   │\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │       │      │          │приобрете-│          │  периода  │           │приобрете-│          │  периода  │           │\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │       │      │          │  ния до  │          │           │           │  ния до  │          │           │           │\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │       │      │          │окончания │          │           │           │окончания │          │           │           │\n"+
"│           │             │             │          │                      │         │          │                  │                  │                  │       │      │          │ периода  │          │           │           │ периода  │          │           │           │\n"+
"├───────────┼─────────────┼─────────────┼──────────┼───────────┬──────────┼─────────┼──────────┼───────┬──────────┼────────┬─────────┼─────────┬────────┼───────┼──────┼──────────┼──────────┼──────────┼───────────┼───────────┼──────────┼──────────┼───────────┼───────────┤\n"+
"│    1      │      2      │      3      │     4    │     5     │     6    │    7    │     8    │   9   │    10    │   11   │    12   │    13   │  14    │  15   │  16  │    17    │    18    │    19    │    20     │    21     │    22    │    23    │     24    │     25    │\n"+
"├───────────┼─────────────┼─────────────┼──────────┼───────────┼──────────┼─────────┼──────────┼───────┼──────────┼────────┼─────────┼─────────┼────────┼───────┼──────┼──────────┼──────────┼──────────┼───────────┼───────────┼──────────┼──────────┼───────────┼───────────┤";

PRIVATE VAR TableHeader5 =  /* Вид ц/б: Векселя* */
"Вид ц/б: Векселя* \n"+
"┌─────────────┬────────────┬─────────────┬──────────┬──────────┬──────────┬──────────────────┬─────────┬────────────────────┬───────────┬──────────────────────┬──────────────────────┬──────────┐\n"+
"│Векселедатель│ Вид дохода │ №, серия    │ Дата со- │ Дата по- │ Дата по- │      Номинал     │ Цена, % │      Стоимость     │ Ставка, % │ Начисленный доход на │ Начисленный доход за │Балансовая│\n"+
"│(Эмитент)    │            │             │ ставления│  ставки  │ гашения  │                  │         │       покупки      │           │ конец отчетного пе-  │  отчетный период, в  │стоимость │\n"+
"│             │            │             │          │          │          │                  │         │                    │           │ риода, в валюте номи-│    валюте номинала   │          │\n"+
"│             │            │             │          │          │          │                  │         │                    │           │        нала          │                      │          │\n"+
"│             │            │             │          │          │          │                  │         │                    │           ├───────────┬──────────┼───────────┬──────────┤          │\n"+
"│             │            │             │          │          │          │                  │         │                    │           │   Дисконт │ Проценты │   Дисконт │ Проценты │          │\n"+
"├─────────────┼────────────┼─────────────┼──────────┼──────────┼──────────┼──────────────────┼─────────┼────────────────────┼───────────┼───────────┼──────────┼───────────┼──────────┼──────────┤\n"+
"│      1      │      2     │      3      │     4    │     5    │    6     │         7        │    8    │          9         │    10     │     11    │    12    │     13    │    14    │     15   │\n"+
"├─────────────┼────────────┼─────────────┼──────────┼──────────┼──────────┼─────────┬────────┼─────────┼──────────┬─────────┼───────────┼───────────┼──────────┼───────────┼──────────┼──────────┤";   

PRIVATE VAR TableHeader6 =  /* Сделки с акциями */
"Сделки с акциями \n"+
"┌────────┬───────────────┬──────────┬─────────┬────────────┬──────┬─────────┬───────────┬──────────────┬────────────┬─────────────┬───────────────┬───────────────┬─────────────┬────────┐\n"+
"│ Номер  │ Дата поставки │Вид опера-│Наимено- │Валюта номи-│Кол-во│Цена реа-│ Сумма реа-│  Балансовая  │Цена покупки│Стоимость по-│ Переоценка    │ Переоценка    │ Финансовый  │Общий ФР│\n"+
"│операции│      ц/б      │   ции    │вание ц/б│    нала    │ ц/б  │ лизации │  лизации  │стоимость реа-│            │    купки    │ (от даты      │ (за отчетный  │результат ба-│        │\n"+
"│        │               │          │         │            │      │         │           │ лизуемых ц/б │            │             │ приобретения) │ период)       │  лансовый   │        │\n"+
"├────────┼───────────────┼──────────┼─────────┼────────────┼──────┼─────────┼───────────┼──────────────┼────────────┼─────────────┼───────────────┼───────────────┼─────────────┼────────┤\n"+
"│   1    │       2       │    3     │   4     │      5     │  6   │    7    │     8     │       9      │       10   │      11     │      12.1     │     12.2      │     13      │   14   │\n"+
"├────────┼───────────────┼──────────┼─────────┼────────────┼──────┼─────────┼───────────┼──────────────┼────────────┼─────────────┼───────────────┼───────────────┼─────────────┼────────┤";
                                                                                                                                                         
PRIVATE VAR TableHeader7 =  /* Сделки с облигациями */                                                                                                                                                                                           
"Сделки с облигациями \n"+                                                                                                                                                                        
"┌────────┬───────────────┬──────────┬─────────┬────────────┬──────┬─────────┬───────────┬──────────────┬────────────┬─────────────┬───────┬───────┬──────────────────┬──────────────────┬───────┬──────────────────┬──────────────────┬───────┬───────────────┬──────────────┬──────────┬────────┐\n"+
"│ Номер  │ Дата поставки │Вид опера-│Наимено- │Валюта номи-│Кол-во│Цена реа-│ Сумма реа-│  Балансовая  │Цена покупки│Стоимость по-│НКД по-│НКД уп-│Ранее начисленный │Ранее начисленный │ Дона- │Ранее начисленный │Ранее начисленный │ Дона- │ Переоценка    │ Переоценка   │Финансовый│Общий ФР│\n"+
"│операции│      ц/б      │   ции    │вание ц/б│    нала    │ ц/б  │ лизации │  лизации  │стоимость реа-│            │    купки    │лучен- │лачен- │ПКД (от даты при- │ПКД               │числен-│ДД (от даты при-  │ДД (за отчетный   │числен-│ (от даты      │ (за отчетный │результат │        │\n"+
"│        │               │          │         │            │      │         │           │ лизуемых ц/б │            │             │ ный   │ ный   │обретения до даты │(за отчетный      │ный ПКД│обретения до даты │период)           │ный ДД │ приобретения) │ период)      │балансовый│        │\n"+
"│        │               │          │         │            │      │         │           │              │            │             │       │       │начала отчетного  │период)           │       │начала отчетного  │                  │       │               │              │          │        │\n"+
"│        │               │          │         │            │      │         │           │              │            │             │       │       │периода           │                  │       │периода           │                  │       │               │              │          │        │\n"+
"├────────┼───────────────┼──────────┼─────────┼────────────┼──────┼─────────┼───────────┼──────────────┼────────────┼─────────────┼───────┼───────┼──────────────────┼──────────────────┼───────┼──────────────────┼──────────────────┼───────┼───────────────┼──────────────┼──────────┼────────┤\n"+
"│   1    │       2       │    3     │   4     │      5     │  6   │    7    │     8     │       9      │       10   │      11     │  12   │  13   │       14.1       │       14.2       │  15   │       16.1       │       16.2       │   17  │      18.1     │     18.2     │    19    │   20   │\n"+
"├────────┼───────────────┼──────────┼─────────┼────────────┼──────┼─────────┼───────────┼──────────────┼────────────┼─────────────┼───────┼───────┼──────────────────┼──────────────────┼───────┼──────────────────┼──────────────────┼───────┼───────────────┼──────────────┼──────────┼────────┤";

PRIVATE VAR TableHeader8 =  /* Сделки с векселями */
"┌─────────────┬─────────┬───────┬───────────┬───────────┬──────────┬──────────────┬───────┬──────┬───────┬───────┬───────┬───────┬───────┬──────────┬───────┬──────────┬───────┐\n"+
"│Векселедатель│   Вид   │№,серия│    Дата   │   Дата    │    Дата  │    Номинал   │ Сумма │Кол-во│   %   │Процент│Дисконт│Процент│Дисконт│   Дата   │ Сумма │  Балан-  │ Общая │\n"+
"│             │         │       │coставления│ погашения │  покупки │              │покупки│      │       │начис- │начис- │начис- │начис- │  продажи │продажи│совая при-│прибыль│\n"+
"│             │         │       │           │           │          │              │       │      │       │ленный │ленный │ленный │ленный │          │       │   быль   │       │\n"+
"│             │         │       │           │           │          │              │       │      │       │ ВСЕГО │ ВСЕГО │за от- │за от- │          │       │          │       │\n"+
"│             │         │       │           │           │          │              │       │      │       │       │       │четный │четный │          │       │          │       │\n"+
"│             │         │       │           │           │          │              │       │      │       │       │       │период │период │          │       │          │       │\n"+
"├─────────────┼─────────┼───────┼───────────┼───────────┼──────────┼──────────────┼───────┼──────┼───────┼───────┼───────┼───────┼───────┼──────────┼───────┼──────────┼───────┤\n"+
"│     1       │    2    │   3   │     4     │     5     │   6      │       7      │    8  │   9  │   10  │  11   │  12   │  13   │  14   │    15    │   16  │   17     │   18  │\n"+
"├─────────────┼─────────┼───────┼───────────┼───────────┼──────────┼───────┬──────┼───────┼──────┼───────┼───────┼───────┼───────┼───────┼──────────┼───────┼──────────┼───────┤";  

PRIVATE VAR TableHeader9 =  /* Финансовый результат */
"┌─────────────────────────────────────┬───────────────┬─────────────┐\n"+
"│Финансовый результат                 │Отчетный период│C начала года│\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│Доходы                               │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│   в том числе:                      │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Доход по векселям              │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Доход по акциям                │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│         в том числе:                │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- положительная переоценка по акциям │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- отрицательная переоценка по акциям │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Доход по облигациям            │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│         в том числе:                │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- положительная переоценка по        │               │             │\n"+
"│  облигациям                         │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- отрицательная переоценка по        │               │             │\n"+
"│  облигациям                         │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Дивиденды                      │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│Расходы                              │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│   в том числе:                      │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Расход по векселям             │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Расход по акциям               │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│         в том числе:                │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- положительная переоценка по акциям │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- отрицательная переоценка по акциям │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Расход по облигациям           │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│         в том числе:                │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- положительная переоценка по        │               │             │\n"+
"│  облигациям                         │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│- отрицательная переоценка по        │               │             │\n"+
"│  облигациям                         │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Комиссия биржи                 │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Комиссия депозитария           │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│      Вознаграждение управляющему    │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│         в том числе:                │               │             │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│            За управление            │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│            За успешное управление   │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│            За досрочный вывод       │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│            в т.ч. НДС               │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│Прибыль / Убыток                     │    ########   │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│Выплаченная прибыль                  │               │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│Капитализированная прибыль           │               │  ########   │\n"+
"├─────────────────────────────────────┼───────────────┼─────────────┤\n"+
"│Остаток прибыли/убытка               │               │  ########   │\n"+
"└─────────────────────────────────────┴───────────────┴─────────────┘";  

PRIVATE CONST SIDE_DEB    = 1,
              SIDE_KRED   = 2;

PRIVATE MACRO RestSum(Sum:Money, Aostatok, Atotal)
   if( Atotal != $0. )
      return Sum - round(Sum * (Atotal - Aostatok)/Atotal, 2);
   else
     return $0;
   end;
END;

/*итоговые суммы по всем акциям или облигациям - нужно для ФР*/
PRIVATE CLASS EmissData( SumBuy_,  SumTSS_,  BalanceCost_,  OverAmount_,  KDBefEnd_,  KDByPer_,  DDOnEnd_,  DDByPer_ ) 
  var  SumBuy         =  SumBuy_,
       SumTSS         =  SumTSS_,
       BalanceCost    =  BalanceCost_,
       OverAmount     =  OverAmount_,
       KDBefEnd       =  KDBefEnd_, 
       KDByPer        =  KDByPer_, 
       DDOnEnd        =  DDOnEnd_, 
       DDByPer        =  DDByPer_;
END;

/*итоговые суммы по всем векселям - нужно для ФР*/
PRIVATE CLASS VAData( DDOnEnd_,  PDOnEnd_,  DDByPer_,  PDByPer_, BalanceCost_ ) 
  var  DDOnEnd        =  DDOnEnd_, 
       PDByPer        =  PDByPer_, 
       DDByPer        =  DDByPer_, 
       PDOnEnd        =  PDOnEnd_,
       BalanceCost    =  BalanceCost_;
END;

/*итоговые суммы по всем сделкам с акциям или облигациям - нужно для ФР*/
PRIVATE CLASS EmissDealData(  Amount_,  SumSale_, BalanceCostBuy_,  SumBuy_,
                              PKDBefBegDate_,  PKDByPer_,  PKD_ADD_, DDBefBegDate_,  DDByPer_,  DD_ADD_,
                              OverAmount_,  OverAmountByPer_, FR_, FR_Total_) 
  var  Amount          = Amount_,
       SumSale         = SumSale_,
       BalanceCostBuy  = BalanceCostBuy_,
       SumBuy          = SumBuy_,
       PKDBefBegDate   = PKDBefBegDate_, 
       PKDByPer        = PKDByPer_, 
       PKD_ADD         = PKD_ADD_, 
       DDBefBegDate    = DDBefBegDate_,
       DDByPer         = DDByPer_,
       DD_ADD          = DD_ADD_,
       OverAmount      = OverAmount_,
       OverAmountByPer = OverAmountByPer_,
       FR              = FR_,
       FR_Total        = FR_Total_;
END;

/*итоговые суммы по всем сделкам с векселям - нужно для ФР*/
PRIVATE CLASS VADealData( BuySum_, PDTotal_, DDTotal_, PDByPer_, DDByPer_, SaleSum_, BalanceCost_, IncomeTotal_ ) 
  var  BuySum      = BuySum_,
       PDTotal     = PDTotal_, 
       DDTotal     = DDTotal_, 
       PDByPer     = PDByPer_, 
       DDByPer     = DDByPer_,
       SaleSum     = SaleSum_, 
       BalanceCost = BalanceCost_, 
       IncomeTotal = IncomeTotal_;
END;

PRIVATE CLASS CIncExp( Report:OBJECT ) 
END;
/*================================================================================================*/
PRIVATE CLASS (DL_CReportTemplate) TS_IncExp_Report( _Form:TS_IncExp_Panel )

  Var m_BegDate,
      m_EndDate,
      m_ClientID,
      m_ClientName,
      m_ClientContr,
      m_AvrKind,
      m_IsExcel,
      m_IsText,
      m_IsApostrof;

  var OrderFD:TS_OrderFD;
  var Form = _Form;

  var m_BegYearDate;
  var m_PortfHeaderPrint, m_PortfDealPrint;

  private macro PrintSum( Sum )   
     if( Sum )                    
        if( m_IsApostrof AND m_IsText )               
           return string( Sum:a );
        else                      
           return string( Sum );  
        end;                      
     else                         
        return Sum;                
     end;                         
  end;                            

  PRIVATE MACRO PrintMode():INTEGER
     if( Form.GetFieldValue( PNFLD_TSINCEXP_ISEXCEL ) == "X")
       return DL_OUTREPORT_EXCEL;
     else
       return DL_OUTREPORT_STD;
     end;
  END;
/*================================================================================================*/
  PRIVATE MACRO BeginReport()
    var y;

    m_BegDate      = Form.GetFieldValue( PNFLD_TSINCEXP_BEGDATE );
    m_EndDate      = Form.GetFieldValue( PNFLD_TSINCEXP_ENDDATE );
    m_ClientID     = Form.GetFieldValue( PNFLD_TSINCEXP_CLIENT_ID );
    m_ClientName   = Form.GetFieldValue( PNFLD_TSINCEXP_CLIENTNAME );
    m_ClientContr  = Form.GetFieldValue( PNFLD_TSINCEXP_CLIENTCONTR );
    m_AvrKind      = Form.GetFieldValue( PNFLD_TSINCEXP_AVRKIND );
    m_IsExcel      = (Form.GetFieldValue( PNFLD_TSINCEXP_ISEXCEL ) == SET_CHAR);
    m_IsText       = (Form.GetFieldValue( PNFLD_TSINCEXP_ISTEXT ) == SET_CHAR);
    m_IsApostrof   = (Form.GetFieldValue( PNFLD_TSINCEXP_APOSTROF ) == SET_CHAR);

    OrderFD = TS_OrderFD(0, m_ClientContr);

    DateSplit(m_EndDate,0,0,y);
    m_BegYearDate = Date(1,1,y);

    CreateTotalBook();
    SetActiveSheet( "Отчет" );

  END;
/*================================================================================================*/
  PRIVATE MACRO PrintRepHeader()
    var EndDate:date = OrderFD.EndDate();
    if( EndDate == ZeroDate )
      var Valid = OrderFD.Valid(IIF(m_BegDate < OrderFD.BeginDate(), OrderFD.BeginDate(),m_BegDate));
      if( Valid != null)
        EndDate = Valid.rec.EndDate;
      end;
    end;
    PrintFormatString( ReportHeader,
                       "N1_H0",   string( OrderFD.Number() ),
                       "N1_H0_1", Date(m_BegDate),
                       "N1_H0_2", Date(m_EndDate),
                       "N1_H1_1", m_ClientName,
                       "N1_H1_2", OrderFD.BeginDate(),
                       "N1_H1_3", EndDate );

    CopyAllSheetInTotalBook( null, false, "N1_Cap1", 0 );
  END;
/*================================================================================================*/
  PRIVATE MACRO ПечатьКапиталВУправлении()
    var SqlData;

    PrintFormatString( Cap2, "N1_H2_0", Date(m_EndDate + 1) );
    CopyAllSheetInTotalBook( null, false, "N1_Cap2", 1 );
    CopyAllSheetInTotalBook( null, false, "N1_TableHead1", 0 );

    RegisterTable( "N1_TableLine1", TableHeader1,
                   "N1_A2_1",
                   "N1_A2_2",
                   "N1_A2_3",
                   "N1_A2_4"
                 );

    var SqlQuery = " select total.t_restdate, total.t_restamount,              "+
                   "        total.t_addamount, total.t_subamount, total.t_sign "+
                   " from dtstotal_dbt total                                   "+
                   " where total.t_totaltype = ? and total.t_orderid = ?       "+
                   "       and total.t_restdate <= ?                           "+
                   " order by total.t_restdate, total.t_id                     ";

    SqlData = RSDCommand( SqlQuery );

    SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_СК);
    SqlData.addParam("", RSDBP_IN, OrderFD.ID);
    SqlData.addParam("", RSDBP_IN, m_EndDate );

    SqlData.execute();

    var DataSet = TRsbDataSet(SqlData);
    
    while( DataSet.MoveNext() )
      var Itog = DataSet.addamount - DataSet.subamount;

      if( DataSet.sign > 0 )
        PrintTableLine( "N1_A2_1", SQL_ConvTypeDate(DataSet.restdate), NULL,
                        "N1_A2_2", DataSet.restamount,     NULL,
                        "N1_A2_4", Itog,                   NULL
                      );
      else
        PrintTableLine( "N1_A2_1", SQL_ConvTypeDate(DataSet.restdate), NULL,
                        "N1_A2_3", DataSet.restamount,     NULL,
                        "N1_A2_4", Itog,                   NULL
                      );
      end;
    end;
    EndTable();
    CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
  END;
/*================================================================================================*/
  PRIVATE MACRO PrintMainLinesTable2():double
    var retItog:double = 0.0, NameAccount = "";
    VAR AccRec = TRecHandler( "account" );

    var SqlQuery = " SELECT distinct accdoc.t_Account, " +
                   "        abs(rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) rest, " +
                   "        accdoc.t_chapter, accdoc.t_currency                               "+
                   "      FROM dmcaccdoc_dbt accdoc,                                          "+
                   "           dmccateg_dbt categ,                                            "+
                   "           dmctempl_dbt templ                                             "+
                   "     WHERE accdoc.t_catid = categ.t_id                                    "+
                   "       AND accdoc.t_clientcontrid = ?                                     "+
                   "       AND categ.t_leveltype = 1                                          "+
                   "       AND categ.t_code = 'ДС ДУ'                                         "+
                   "       AND templ.t_catid = accdoc.t_catid                                 "+
                   "       AND templ.t_number = accdoc.t_templnum                             "+
                   "       AND (CASE                                                          "+
                   "               WHEN (categ.t_param1 = 2818 AND categ.t_class1 = 1702)     "+
                   "                  THEN templ.t_value1                                     "+
                   "               WHEN (categ.t_param2 = 2818 AND categ.t_class2 = 1702)     "+
                   "                  THEN templ.t_value2                                     "+
                   "               WHEN (categ.t_param3 = 2818 AND categ.t_class3 = 1702)     "+
                   "                  THEN templ.t_value3                                     "+
                   "               WHEN (categ.t_param4 = 2818 AND categ.t_class4 = 1702)     "+
                   "                  THEN templ.t_value4                                     "+
                   "               WHEN (categ.t_param5 = 2818 AND categ.t_class5 = 1702)     "+
                   "                  THEN templ.t_value5                                     "+
                   "               WHEN (categ.t_param6 = 2818 AND categ.t_class6 = 1702)     "+
                   "                  THEN templ.t_value6                                     "+
                   "               WHEN (categ.t_param7 = 2818 AND categ.t_class7 = 1702)     "+
                   "                  THEN templ.t_value7                                     "+
                   "               WHEN (categ.t_param8 = 2818 AND categ.t_class8 = 1702)     "+
                   "                  THEN templ.t_value8                                     "+
                   "            END                                                           "+
                   "           ) != 41                                                        ";/*!!! 1 "Торговый" (для 1ОБ)*/

    var SqlData = RSDCommand( SqlQuery );
    SqlData.addParam("", RSDBP_IN, m_EndDate);
    SqlData.addParam("", RSDBP_IN, OrderFD.Order.rec.SfContrID );
    SqlData.execute();

    var DataSet = TRsbDataSet(SqlData);
                              
    while( DataSet.MoveNext() )
       if( SQL_ConvTypeSum(DataSet.rest) > 0 )
           if( TS_GetAccount(int(SQL_ConvTypeInteger(DataSet.chapter)), int(SQL_ConvTypeInteger(DataSet.currency)), 
                             SQL_ConvTypeStr(DataSet.Account), AccRec) )                                            
              NameAccount = AccRec.rec.NameAccount;                                                                 
           end;                                                                                                     
                                                                                                                    
           PrintTableLine( "N1_A3_1", NameAccount,     NULL,                                                        
                           "N1_A3_2", SQL_ConvTypeSum(DataSet.rest),    NULL                                        
                         );                                                                                         
           retItog = retItog + SQL_ConvTypeSum(DataSet.rest);                                                       
       end;
    end;
    return retItog;
  END;
/*================================================================================================*/
  PRIVATE MACRO GetSelectSumTable2( equal71:bool, header:string ):double
    var SqlQuery, SqlData, DataSet;

    SqlQuery = " SELECT NVL(SUM(abs(rsb_account.restall(accdoc.t_account,          "+
               "                accdoc.t_chapter,                                  "+           
               "                accdoc.t_currency, ?))),0) s                       "+           
               "   FROM dmcaccdoc_dbt accdoc,                                      "+           
               "        dmccateg_dbt categ,                                        "+           
               "        dmctempl_dbt templ                                         "+           
               "  WHERE accdoc.t_catid = categ.t_id                                "+           
               "    AND accdoc.t_clientcontrid = ?                                 "+           
               "    AND categ.t_leveltype = 1                                      "+           
               "    AND categ.t_code = '+Расчеты, ДУ'                              "+           
               "    AND templ.t_catid = accdoc.t_catid                             "+           
               "    AND templ.t_number = accdoc.t_templnum                         "+           
               "    AND (CASE                                                      "+           
               "            WHEN (categ.t_param1 = 2815 AND categ.t_class1 = 1700) "+           
               "               THEN templ.t_value1                                 "+           
               "            WHEN (categ.t_param2 = 2815 AND categ.t_class2 = 1700) "+           
               "               THEN templ.t_value2                                 "+           
               "            WHEN (categ.t_param3 = 2815 AND categ.t_class3 = 1700) "+           
               "               THEN templ.t_value3                                 "+           
               "            WHEN (categ.t_param4 = 2815 AND categ.t_class4 = 1700) "+           
               "               THEN templ.t_value4                                 "+           
               "            WHEN (categ.t_param5 = 2815 AND categ.t_class5 = 1700) "+           
               "               THEN templ.t_value5                                 "+           
               "            WHEN (categ.t_param6 = 2815 AND categ.t_class6 = 1700) "+           
               "               THEN templ.t_value6                                 "+           
               "            WHEN (categ.t_param7 = 2815 AND categ.t_class7 = 1700) "+           
               "               THEN templ.t_value7                                 "+           
               "            WHEN (categ.t_param8 = 2815 AND categ.t_class8 = 1700) "+           
               "               THEN templ.t_value8                                 "+           
               "         END                                                       ";           
    if( equal71 )
      SqlQuery = SqlQuery + " ) = 72 ";
    else
      SqlQuery = SqlQuery + " ) != 72 ";
    end;

    SqlData = RSDCommand( SqlQuery );
    SqlData.addParam("", RSDBP_IN, m_EndDate);
    SqlData.addParam("", RSDBP_IN, OrderFD.Order.rec.SfContrID);
    SqlData.execute();

    DataSet = TRsbDataSet(SqlData);
    if( DataSet.MoveNext() )
       PrintTableLine( "N1_A3_1", header,                     NULL,
                       "N1_A3_2", SQL_ConvTypeSum(DataSet.s), NULL
                     );
    end;

    return double(SQL_ConvTypeSum(DataSet.s));
  END;
/*================================================================================================*/
  PRIVATE MACRO PrintItogLinesTable2(_Itog:double)
    var Itog = _Itog;

    Itog = Itog + GetSelectSumTable2( true, "Денежные средства на срочном рынке" );
    Itog = Itog + GetSelectSumTable2( false, "Дебиторская задолженность" );

    PrintTableLine( "N1_A3_1", "Итого", NULL,
                    "N1_A3_2", Itog,    NULL
                  );
  END;
/*================================================================================================*/
  PRIVATE MACRO ПечататьДСДЗ()
    var Itog:double = 0.0;
    PrintFormatString( Cap3, "N1_H3_0", Date(m_EndDate + 1) );
    CopyAllSheetInTotalBook( null, false, "N1_Cap3", 1 );
    CopyAllSheetInTotalBook( null, false, "N1_TableHead2", 0 );

    RegisterTable( "N1_TableLine2", TableHeader2,
                   "N1_A3_1",
                   "N1_A3_2"
                 );

    Itog = PrintMainLinesTable2();
    PrintItogLinesTable2(Itog);

    EndTable();
    CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
  END;
/*================================================================================================*/
  PRIVATE MACRO ПолучитьИмяСубъекта(ID)
     FILE party(party);
     ClearRecord(party);
     party.PartyID = ID;
     if(not getEQ(party))
        return "";
     end;
     return party.Name;
  end;
/*================================================================================================*/
  PRIVATE MACRO ПолучитьВидЦБ( AvrKind )
    var ds, rsd = RSDCommand( "select t_Name from davrkinds_dbt where t_AvoirKind = ?" );
    rsd.addParam("", RSDBP_IN, AvrKind);
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return ds.Name;
    end;
    return "";
  END;
/*================================================================================================*/
  PRIVATE MACRO GetValueLLCode( List:INTEGER, ElementOrCode:VARIANT ):string
    var ll = TRecHandler("llvalues.dbt");

    LL_FindLLVALUES( List, ElementOrCode, ll );

    return ll.rec.Code;
  END;
/*================================================================================================*/
/*Курс вида "ТСС_ДУ" без НКД в валюте номинала за последний рабочий день, предшествующий отчетной дате; 
если за эту дату курс не введен, то выводится курс этого вида с наибольшей датой, не превышающей отчетную.
Если ТСС_ДУ не найдена, то поле не заполняется
*/
  PRIVATE MACRO GetCource(fiid, FaceValueFI)
    VAR ТСС, ТСС_Kind, TSSDate, OperDate;

    OperDate = GetDateAfterWorkDays(m_EndDate+1,-1);
  
    ТСС_Kind = ДУ_ПолучитьВидКурса(TS_RATETYPE_TSS);
    ТСС = GetRateOnDate( OperDate, fiid, FaceValueFI, false, ТСС_Kind, null, TSSDate );
          
    if( ( TSSDate != null ) AND ( ( TSSDate <= m_EndDate ) OR ( ТСС > 0 ) ) )
      return round(ТСС,4);
    end;

    return $0;
  END;

  PRIVATE MACRO GetBalanceCostForDate( _Date:Date, SumID:integer, Amount )
    var Query, RSD;

    Query = RSDCommand( " select w1.t_BalanceCost, w1.t_Amount                   "+
                        "  from v_scwrthist w1                                  "+     
                        " where w1.t_SumID = ?                                  "+     
                        "   AND w1.t_instance = (SELECT MAX (wm.t_instance)     "+     
                        "                          FROM v_scwrthist wm          "+     
                        "                         WHERE wm.t_SumID = w1.t_SumID "+     
                        "                           AND wm.t_changedate < ?)    "     
                       );                                                              
    Query.addParam( "", RSDBP_IN, SumID );
    Query.addParam( "", RSDBP_IN, _Date );
    Query.execute();
    RSD = TRsbDataSet(Query);

    if( RSD.movenext() )
       if( Amount > 0 )
          return RestSum(RSD.BalanceCost,Amount,RSD.Amount);
       end;
    end;
    return $0;
  End;

  PRIVATE MACRO PrintPortfHeader()
    if( not m_PortfHeaderPrint )
       PrintFormatString( Cap4, "N1_H4_0", Date(m_EndDate + 1) );
       CopyAllSheetInTotalBook( null, false, "N1_Cap4", 1 );
       m_PortfHeaderPrint = true;
    end;
  END;

  PRIVATE MACRO PrintPortfFooter()
     PrintFormatString( Cap5 );
     CopyAllSheetInTotalBook( null, false, "N1_Cap5", 1 );
  END;

  PRIVATE MACRO PrintDealHeader()
    if( not m_PortfDealPrint )
       PrintFormatString( Cap6, "N1_H5_1", m_BegDate, "N1_H5_2", m_EndDate );
       CopyAllSheetInTotalBook( null, false, "N1_Cap6", 1 );
       m_PortfDealPrint = true;
    end;
  END;

/*================================================================================================*/
  PRIVATE MACRO ПечататьВидАкции( RSD, BegDate:Date, DoPrint:bool )
    var first = true, circule = true;

    var ИтогПриобретенияПоАкциям = $0;
    var ИтогТССПоАкциям          = $0;
    var ИтогБалансовыйПоАкциям   = $0;
    var ИтогПереоценкаПоАкциям   = $0;
    
    var prevKind = -1;
    var ИтогПриобретенияПоПодвиду = $0;
    var ИтогТССПоПодвиду = $0;
    var ИтогБалансовыйПоПодвиду   = $0;
    var ИтогПереоценкаПоПодвиду   = $0;
   
    var prevCode   = -1;
    var ИтогПриобретенияПоБумаге = $0;
    var ИтогТССПоБумаге          = $0;
    var ИтогБалансовыйПоБумаге   = $0;
    var ИтогПереоценкаПоБумаге   = $0;
    var amount = 0;

    var TSS = $0;
    var СтоимостьTSS = $0;
    var overAmount = $0, Sum = $0;

    macro  RegisterShare()
       if(DoPrint)
           PrintPortfHeader();
           CopyAllSheetInTotalBook( null, false, "N1_TableHead3", 1 );
           RegisterTable( "N1_TableLine3", TableHeader3,
                          "N1_A4_1",                    
                          "N1_A4_2",                    
                          "N1_A4_3",                    
                          "N1_A4_4",                    
                          "N1_A4_5",                    
                          "N1_A4_6",                    
                          "N1_A4_7",                    
                          "N1_A4_8",                    
                          "N1_A4_9",                    
                          "N1_A4_10",                   
                          "N1_A4_11",                   
                          "N1_A4_12",                   
                          "N1_A4_13",                   
                          "N1_A4_14",                   
                          "N1_A4_15",                   
                          "N1_A4_16"                    
                        );                              
        end;
    end;

    macro  PrintShare(A4_1,A4_2,A4_3,A4_4,A4_5,A4_6,A4_7,A4_8,A4_9,A4_10,A4_11,A4_12,A4_13,A4_14,A4_15,A4_16)
       if(DoPrint)
          PrintTableLine( "N1_A4_1",  A4_1, NULL,
                          "N1_A4_2",  A4_2, NULL,                       
                          "N1_A4_3",  A4_3, NULL,                       
                          "N1_A4_4",  A4_4, NULL,                       
                          "N1_A4_5",  A4_5, NULL,                       
                          "N1_A4_6",  A4_6, NULL,                       
                          "N1_A4_7",  PrintSum(A4_7), NULL,                       
                          "N1_A4_8",  A4_8, NULL,                       
                          "N1_A4_9",  PrintSum(A4_9), NULL,                       
                          "N1_A4_10", PrintSum(A4_10), NULL,                       
                          "N1_A4_11", PrintSum(A4_11), NULL,                       
                          "N1_A4_12", PrintSum(A4_12), NULL,                     
                          "N1_A4_13", PrintSum(A4_13), NULL,                       
                          "N1_A4_14", PrintSum(A4_14), NULL,                        
                          "N1_A4_15", PrintSum(A4_15), NULL,                       
                          "N1_A4_16", PrintSum(A4_16), NULL                       
                        );
       end;                                     
    end;

    macro  PrintShareEnd(A4_10,A4_12,A4_14,A4_16)
       if(DoPrint)
          PrintShare("Итого по акциям:","","","","","","","","",A4_10,
                     "",A4_12,"",A4_14,"",A4_16);
          EndTable();
          CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
       end;                                     
    end;

    macro ClearData()
       Sum = $0;                                                  
       TSS = $0;                                                   
       СтоимостьTSS = $0;                                          
       overAmount = $0;                                             
    end;

    prevCode = RSD.fi_code;

    while( circule )
      
      TSS = GetCource(RSD.FIID, RSD.FaceValueFI);
      СтоимостьTSS = TSS * RSD.amount;

      if( first )
        RegisterShare();
      end;

      if( (prevCode != RSD.fi_code) AND ( first == false ) )
         PrintShare("Итого по "+string( prevCode ),"","","","","", amount,"","", ИтогПриобретенияПоБумаге, "", ИтогТССПоБумаге, "",
                           ИтогБалансовыйПоБумаге, "", ИтогПереоценкаПоБумаге);
        ИтогПриобретенияПоБумаге = $0;
        ИтогТССПоБумаге          = $0;
        ИтогБалансовыйПоБумаге   = $0;
        ИтогПереоценкаПоБумаге   = $0;
        amount = 0;
        prevCode = RSD.fi_code;
      end;

      if( (prevKind != RSD.avkind) AND ( first == false ) )

        PrintShare("Итого по "+string( ПолучитьВидЦБ(prevKind) ),"","","","","","","","", ИтогПриобретенияПоПодвиду, "", ИтогТССПоПодвиду, "",
                           ИтогБалансовыйПоПодвиду, "", ИтогПереоценкаПоПодвиду);

        ИтогПриобретенияПоАкциям = ИтогПриобретенияПоАкциям + ИтогПриобретенияПоПодвиду;
        ИтогТССПоАкциям          = ИтогТССПоАкциям + ИтогТССПоПодвиду;
        ИтогБалансовыйПоАкциям = ИтогБалансовыйПоАкциям + ИтогБалансовыйПоПодвиду;
        ИтогПереоценкаПоАкциям = ИтогПереоценкаПоАкциям + ИтогПереоценкаПоПодвиду;

        ИтогПриобретенияПоПодвиду = $0;
        ИтогТССПоПодвиду          = $0;
        ИтогБалансовыйПоПодвиду   = $0;
        ИтогПереоценкаПоПодвиду   = $0;
      end;

      if( prevKind != RSD.avkind )
         PrintShare(ПолучитьВидЦБ(RSD.avkind),"","","","","","","","","","","","","","","");
         prevKind = RSD.avkind;
      end;

      Sum = RSD.Sum;
      if( RSD.currency != RSD.FaceValueFI )
         TS_SmartConvertSum( Sum, Sum, SQL_ConvTypeDate(RSD.date), RSD.currency, RSD.FaceValueFI, true );
      end;

      if( SQL_ConvTypeDate(RSD.date) >= BegDate )
        overAmount = RSD.balancecost - Sum;
      else
        overAmount = RSD.balancecost - GetBalanceCostForDate( BegDate, RSD.SumID, RSD.amount );
      end;

      PrintShare( ПолучитьИмяСубъекта(RSD.Issuer),                     
                  RSD.fi_code,                                                     
                  RSD.lsin,                                                        
                  DL_getCCode(RSD.FaceValueFI),                                    
                  SQL_ConvTypeDate(RSD.date),                                      
                  SQL_ConvTypeTime(RSD.time),                                      
                  RSD.amount,                                            
                  GetValueLLCode(OBJTYPE_KINDPORT, RSD.Portfolio),                 
                  IIF(RSD.amount==0, 0, Sum/RSD.amount),                 
                  Sum,                                                   
                  TSS,                                                   
                  СтоимостьTSS,                                          
                  IIF(RSD.amount==0, 0, RSD.balancecost / RSD.amount),   
                  RSD.balancecost,                                       
                  RSD.balancecost - Sum,                                 
                  overAmount                                             
                );                                                                         

      ИтогПриобретенияПоБумаге = ИтогПриобретенияПоБумаге + Sum;
      ИтогТССПоБумаге          = ИтогТССПоБумаге          + СтоимостьTSS;
      ИтогБалансовыйПоБумаге   = ИтогБалансовыйПоБумаге   + RSD.balancecost;
      ИтогПереоценкаПоБумаге   = ИтогПереоценкаПоБумаге   + overAmount;

      ИтогПриобретенияПоПодвиду   = ИтогПриобретенияПоПодвиду + Sum;
      ИтогБалансовыйПоПодвиду     = ИтогБалансовыйПоПодвиду   + RSD.balancecost;
      ИтогПереоценкаПоПодвиду     = ИтогПереоценкаПоПодвиду   + overAmount;
      ИтогТССПоПодвиду            = ИтогТССПоПодвиду          + СтоимостьTSS;

      amount = amount + RSD.amount;

      if(first) first = false; end;
      ClearData();
      circule = RSD.MoveNext();
    end;

    if( first == false )
      PrintShare("Итого по "+string( prevCode ),"","","","","", amount,"","", ИтогПриобретенияПоБумаге, "", ИтогТССПоБумаге, "",
                           ИтогБалансовыйПоБумаге, "", ИтогПереоценкаПоБумаге);

      PrintShare("Итого по "+string( ПолучитьВидЦБ(prevKind) ),"","","","","", "","","", ИтогПриобретенияПоПодвиду, "", ИтогТССПоПодвиду, "",
                           ИтогБалансовыйПоПодвиду, "", ИтогПереоценкаПоПодвиду);

      ИтогПриобретенияПоАкциям = ИтогПриобретенияПоАкциям + ИтогПриобретенияПоПодвиду;
      ИтогТССПоАкциям          = ИтогТССПоАкциям          + ИтогТССПоПодвиду;
      ИтогБалансовыйПоАкциям   = ИтогБалансовыйПоАкциям   + ИтогБалансовыйПоПодвиду;
      ИтогПереоценкаПоАкциям   = ИтогПереоценкаПоАкциям   + ИтогПереоценкаПоПодвиду;

      PrintShareEnd(ИтогПриобретенияПоАкциям,ИтогТССПоАкциям,ИтогБалансовыйПоАкциям,ИтогПереоценкаПоАкциям);

      return EmissData( ИтогПриобретенияПоАкциям, ИтогТССПоАкциям, ИтогБалансовыйПоАкциям, 
                        ИтогПереоценкаПоАкциям, $0, $0, $0, $0 );

    end;

    return EmissData( $0, $0, $0, $0, $0, $0, $0, $0 );

  END;
/*================================================================================================*/


  PRIVATE MACRO TS_GetCouponSumByPeriod( FIID, Amount, DateBeg, DateEnd, IsPartial:STRING )
    var cmd, rsd;
    var Sum = 0.0, S;
  
    cmd = RSDCommand(
          " SELECT FI.t_FaceValueFI, FI.t_FaceValue, warnt.t_DrawingDate as DrawingDate, "
        + "        (case when (warnt.t_IsPartial = 'X') " 
        + "        then (RSB_FIInstr.FI_GetPartialPersentByName(warnt.t_FIID,warnt.t_Number)) else 0 end) PartlyPc " 
        + "   FROM dfiwarnts_dbt warnt, dfininstr_dbt FI "
        + "  WHERE warnt.t_FIID = ? and "
        + "        warnt.t_IsPartial = " + IIF(IsPartial=="X","'X'", "chr(0)") + " and "
        + "        warnt.t_DrawingDate <= ? and "
        + "        warnt.t_DrawingDate >= ? and "
        + "        FI.t_FIID = warnt.t_FIID and "
        + "        warnt.t_TSIsClosed = 'X' "
        + " ORDER BY warnt.t_DrawingDate ASC "
                    );
  
    cmd.addParam( "", RSDBP_IN, FIID );
    cmd.addParam( "", RSDBP_IN, DateEnd );
    cmd.addParam( "", RSDBP_IN, DateBeg );
  
    cmd.execute();
  
    rsd = TRsbDataSet(cmd);
    while(rsd.MoveNext())
  
      /*Сумма частичных погашений*/
      if (IsPartial == "X")
        S = Amount * rsd.PartlyPc;
      /*Сумма купонов*/
      else
         S = СуммаКупона(FIID, Amount, SQL_ConvTypeDate(rsd.DrawingDate) );
      end;
  
      Sum = Sum + S;
    end;
  
    return Sum;
  END;

  PRIVATE MACRO IsExistsPartialByPeriod( FIID, DateBeg:Date, DateEnd:Date )
    var cmd, rsd;
    var Sum = 0.0, S;
  
    cmd = RSDCommand(
          " SELECT count(1) NumPartly "
        + "   FROM dfiwarnts_dbt warnt "
        + "  WHERE warnt.t_FIID = ? and "
        + "        warnt.t_IsPartial = 'X' and "
        + "        warnt.t_DrawingDate <= ? and "
        + "        warnt.t_DrawingDate >= ? "
                    );
  
    cmd.addParam( "", RSDBP_IN, FIID );
    cmd.addParam( "", RSDBP_IN, DateEnd );
    cmd.addParam( "", RSDBP_IN, DateBeg );
  
    cmd.execute();
  
    rsd = TRsbDataSet(cmd);
    if(rsd.MoveNext())
       return TS_IIF(rsd.NumPartly>0,true,false);
    end;
  
    return false;
  END;

/*================================================================================================*/
  PRIVATE MACRO GetLotFirstInstance( SumID:integer, Lot0:@variant )
    var Query, RSD;

    Query = RSDCommand( " select w0.*             "+
                        "  from v_scwrthist w0    "+     
                        " where w0.t_SumID = ?    "+     
                        "   AND w0.t_instance = (SELECT min (ws.t_instance) "+                       
                        "                          FROM v_scwrthist ws "+                          
                        "                         WHERE ws.t_SumID = w0.t_SumID "+                   
                        "                           AND ws.t_State = 1)"     
                       );                                                              
    Query.addParam( "", RSDBP_IN, SumID );
    Query.execute();
    RSD = TRsbDataSet(Query);

    if( RSD.movenext() )
       Lot0 = RSD.GetRecord();
       return true;
    end;

    return false;
  END;

  PRIVATE MACRO GetLotBefDate( _Date:Date, SumID:integer, LotBefDate:@variant )
    var Query, RSD;

    Query = RSDCommand( " select w1.*                                           "+
                        "  from v_scwrthist w1                                  "+     
                        " where w1.t_SumID = ?                                  "+     
                        "   AND w1.t_instance = (SELECT MAX (wm.t_instance)     "+     
                        "                          FROM v_scwrthist wm          "+     
                        "                         WHERE wm.t_SumID = w1.t_SumID "+     
                        "                           AND wm.t_changedate < ?)    "     
                       );                                                              
    Query.addParam( "", RSDBP_IN, SumID );
    Query.addParam( "", RSDBP_IN, _Date );
    Query.execute();
    RSD = TRsbDataSet(Query);

    if( RSD.movenext() )
       LotBefDate =  RSD.GetRecord();
       return true;
    end;

    return false;
  END;

/*================================================================================================*/
  PRIVATE MACRO ПечататьВидОблигации(RSD, BegDate:Date, DoPrint:bool)
    var first = true, circule = true;

    var ИтогПриобретенияПоОблигациям  = $0;
    var ИтогТССПоОблигациям           = $0;
    var ИтогБалансовыйПоОблигациям    = $0;
    var ИтогПереоценкаПоОблигациям    = $0;
    var ИтогКупонПоОблигациям         = $0;
    var ИтогКупонЗаПериодПоОблигациям = $0;
    var ИтогДисконтПоОблигациям         = $0;
    var ИтогДисконтЗаПериодПоОблигациям = $0;


    var prevKind = -1;
    var ИтогПриобретенияПоПодвиду  = $0;
    var ИтогТССПоПодвиду           = $0;
    var ИтогБалансовыйПоПодвиду    = $0;
    var ИтогПереоценкаПоПодвиду    = $0;
    var ИтогКупонПоПодвиду         = $0;
    var ИтогКупонЗаПериодПоПодвиду = $0;
    var ИтогДисконтПоПодвиду         = $0;
    var ИтогДисконтЗаПериодПоПодвиду = $0;
 
    var prevCode = -1;
    var ИтогПриобретенияПоБумаге  = $0;
    var ИтогБалансовыйПоБумаге    = $0;
    var ИтогТССПоБумаге           = $0;
    var ИтогПереоценкаПоБумаге    = $0;
    var ИтогКупонПоБумаге         = $0;
    var ИтогКупонЗаПериодПоБумаге = $0;
    var ИтогДисконтПоБумаге         = $0;
    var ИтогДисконтЗаПериодПоБумаге = $0;

    var amount = 0;

    var КупонныйДоход = TArray();
        КупонныйДоход.Size = 5;
    var ДисконтныйДоход = TArray();
        ДисконтныйДоход.Size = 4;

    var TSS = $0;
    var СтоимостьTSS = $0;
    var OverAmountFrom = $0, OverAmountAbout = $0, Sum = $0, BalanceCost = $0; 
    var IsPrintPD = false, IsPrintDD = false;

    КупонныйДоход[0]=КупонныйДоход[1]=КупонныйДоход[2]=КупонныйДоход[3]=КупонныйДоход[4]=$0;
    ДисконтныйДоход[0]=ДисконтныйДоход[1]=ДисконтныйДоход[2]=ДисконтныйДоход[3]=$0;

    var Lot0, LotBefDate;

    macro RegisterBond()
       if(DoPrint)
        PrintPortfHeader();
        CopyAllSheetInTotalBook( null, false, "N1_TableHead4", 1 );
  
        RegisterTable( "N1_TableLine4", TableHeader4,
                       "N1_A5_1",
                       "N1_A5_2",
                       "N1_A5_3",
                       "N1_A5_4",
                       "N1_A5_5",
                       "N1_A5_6",
                       "N1_A5_7",
                       "N1_A5_8",
                       "N1_A5_9",
                       "N1_A5_10",
                       "N1_A5_11",
                       "N1_A5_12",
                       "N1_A5_13",
                       "N1_A5_14",
                       "N1_A5_15",
                       "N1_A5_16",
                       "N1_A5_17",
                       "N1_A5_18",
                       "N1_A5_19",
                       "N1_A5_20",
                       "N1_A5_21",
                       "N1_A5_22",
                       "N1_A5_23",
                       "N1_A5_24",
                       "N1_A5_25"
                     );
       end;                                     
    end;

    macro  PrintBond(A5_1,A5_2,A5_3,A5_4,A5_5,A5_6,A5_7,A5_8,A5_9,A5_10,
                     A5_11,A5_12,A5_13,A5_14,A5_15,A5_16,A5_17,A5_18,A5_19,A5_20,A5_21,A5_22,A5_23,A5_24,A5_25)
       if(DoPrint)
        PrintTableLine( "N1_A5_1",  A5_1, NULL,
                        "N1_A5_2",  A5_2, NULL,
                        "N1_A5_3",  A5_3, NULL,
                        "N1_A5_4",  A5_4, NULL,
                        "N1_A5_5",  A5_5, NULL,
                        "N1_A5_6",  A5_6, NULL,
                        "N1_A5_7",  A5_7, NULL,
                        "N1_A5_8",  A5_8, NULL,
                        "N1_A5_9",  PrintSum(A5_9), NULL,
                        "N1_A5_10", PrintSum(A5_10), NULL,
                        "N1_A5_11", PrintSum(A5_11), NULL,
                        "N1_A5_12", PrintSum(A5_12), NULL,
                        "N1_A5_13", PrintSum(A5_13), NULL,
                        "N1_A5_14", PrintSum(A5_14), NULL,
                        "N1_A5_15", PrintSum(A5_15), NULL,
                        "N1_A5_16", PrintSum(A5_16), NULL,
                        "N1_A5_17", PrintSum(A5_17), NULL,
                        "N1_A5_18", PrintSum(A5_18), NULL,
                        "N1_A5_19", PrintSum(A5_19), NULL,
                        "N1_A5_20", PrintSum(A5_20), NULL,
                        "N1_A5_21", PrintSum(A5_21), NULL,
                        "N1_A5_22", PrintSum(A5_22), NULL,
                        "N1_A5_23", PrintSum(A5_23), NULL,
                        "N1_A5_24", PrintSum(A5_24), NULL,
                        "N1_A5_25", PrintSum(A5_25), NULL
                      );
       end;                                     
    end;
    
    macro  PrintBondEnd(A5_10,A5_12,A5_14,A5_16,A5_20,A5_21,A5_24,A5_25)
       if(DoPrint)
          PrintBond( "Итого по облигациям:","","","","","","","","",A5_10,"",A5_12,"",
                      A5_14,"",A5_16,"","","",A5_20, A5_21,"","",
                      A5_24, A5_25);

          EndTable();
          CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
       end;                                     
    end;

    macro ClearData()
       BalanceCost = $0;                                              
       OverAmountFrom = $0;                                          
       OverAmountAbout = $0;                                         
       КупонныйДоход[0]=КупонныйДоход[1]=КупонныйДоход[2]=КупонныйДоход[3]=КупонныйДоход[4]=$0;
       ДисконтныйДоход[0]=ДисконтныйДоход[1]=ДисконтныйДоход[2]=ДисконтныйДоход[3]=$0;
       IsPrintPD = false;
       IsPrintDD = false;
    end;
    
    prevCode = RSD.fi_code;
    
    while( circule )
      GetLotFirstInstance(RSD.SumID,@Lot0);
      GetLotBefDate(BegDate,RSD.SumID,@LotBefDate);

      TSS = GetCource(RSD.FIID, RSD.FaceValueFI);
      СтоимостьTSS = TSS * RSD.amount;
      
      if( first )
         RegisterBond();
      end;

      if( (prevCode != RSD.fi_code) AND ( first == false ) )
        PrintBond( "Итого по "+string( prevCode ),"","","","","",amount,"","",ИтогПриобретенияПоБумаге,"",ИтогТССПоБумаге,"",
                   ИтогБалансовыйПоБумаге,"",ИтогПереоценкаПобумаге,"","","",ИтогКупонПоБумаге,ИтогКупонЗаПериодПоБумаге,"","",
                   ИтогДисконтПоБумаге,ИтогДисконтЗаПериодПоБумаге);

        ИтогПриобретенияПоБумаге = $0;
        ИтогБалансовыйПоБумаге   = $0;
        ИтогТССПоБумаге          = $0;
        ИтогПереоценкаПоБумаге   = $0;
        ИтогКупонПоБумаге         = $0;
        ИтогКупонЗаПериодПоБумаге = $0;
        ИтогДисконтПоБумаге         = $0;
        ИтогДисконтЗаПериодПоБумаге = $0;

        amount = 0;
        prevCode = RSD.fi_code;
      end;

      if( (prevKind != RSD.avkind) AND ( first == false ) )
        PrintBond( "Итого по "+string( ПолучитьВидЦБ(prevKind) ),"","","","","","","","",ИтогПриобретенияПоПодвиду,"",ИтогТССПоПодвиду,"",
                   ИтогБалансовыйПоПодвиду,"",ИтогПереоценкаПоПодвиду,"","","",ИтогКупонПоПодвиду, ИтогКупонЗаПериодПоПодвиду,"","",
                   ИтогДисконтПоПодвиду, ИтогДисконтЗаПериодПоПодвиду);

        ИтогПриобретенияПоОблигациям  = ИтогПриобретенияПоОблигациям  + ИтогПриобретенияПоПодвиду;
        ИтогТССПоОблигациям           = ИтогТССПоОблигациям           + ИтогТССПоПодвиду;
        ИтогБалансовыйПоОблигациям    = ИтогБалансовыйПоОблигациям    + ИтогБалансовыйПоПодвиду;
        ИтогПереоценкаПоОблигациям    = ИтогПереоценкаПоОблигациям    + ИтогПереоценкаПоПодвиду;

        ИтогКупонПоОблигациям         = ИтогКупонПоОблигациям         + ИтогКупонПоПодвиду;                  
        ИтогКупонЗаПериодПоОблигациям = ИтогКупонЗаПериодПоОблигациям + ИтогКупонЗаПериодПоПодвиду;          
                                                                                                         
        ИтогДисконтПоОблигациям         = ИтогДисконтПоОблигациям         + ИтогДисконтПоПодвиду;            
        ИтогДисконтЗаПериодПоОблигациям = ИтогДисконтЗаПериодПоОблигациям + ИтогДисконтЗаПериодПоПодвиду;    

        ИтогПриобретенияПоПодвиду  = $0;
        ИтогТССПоПодвиду           = $0;
        ИтогБалансовыйПоПодвиду    = $0;
        ИтогПереоценкаПоПодвиду    = $0;
        ИтогКупонПоПодвиду         = $0;
        ИтогКупонЗаПериодПоПодвиду = $0;
        ИтогДисконтПоПодвиду         = $0;
        ИтогДисконтЗаПериодПоПодвиду = $0;
      end;

      if( prevKind != RSD.avkind )
        PrintBond( ПолучитьВидЦБ(RSD.avkind),"","","","","","","","","","","","","","","","","","","","","","","","");
        prevKind = RSD.avkind;
      end;

      Sum = RSD.Sum;
      if( RSD.currency != RSD.FaceValueFI )
         TS_SmartConvertSum( Sum, Sum, SQL_ConvTypeDate(RSD.date), RSD.currency, RSD.FaceValueFI, true );
      end;

      BalanceCost = RSD.BalanceCost - RSD.NKDAmount - RSD.InterestIncome;

      if( FI_IsCouponAvoiriss(RSD.FIID) == true )
        КупонныйДоход[0] = RestSum(Lot0.NKDAmount, RSD.Amount, Lot0.Amount);
        КупонныйДоход[1] = TS_GetCouponSumByPeriod( RSD.FIID, RSD.Amount, SQL_ConvTypeDate(RSD.date), m_EndDate, "" );
        КупонныйДоход[2] = TS_GetCouponSumByPeriod( RSD.FIID, RSD.Amount, BegDate, m_EndDate, "" );
        КупонныйДоход[3] = RSD.InterestIncome - Lot0.InterestIncome*RSD.Amount/Lot0.Amount+КупонныйДоход[1];
        КупонныйДоход[4] = RSD.InterestIncome;
        if(SQL_ConvTypeDate(RSD.date)<BegDate)
           КупонныйДоход[4] = КупонныйДоход[4] - RestSum(LotBefDate.InterestIncome, RSD.Amount, LotBefDate.Amount);
        else
           КупонныйДоход[4] = КупонныйДоход[4] - RestSum(Lot0.InterestIncome, RSD.Amount, Lot0.Amount);
        end;
        IsPrintPD = true;
      end;

      if( IsExistsPartialByPeriod( RSD.FIID, BegDate, m_EndDate ) )
        ДисконтныйДоход[0] = TS_GetCouponSumByPeriod( RSD.FIID, RSD.Amount, SQL_ConvTypeDate(RSD.date), m_EndDate, "X");
        ДисконтныйДоход[1] = TS_GetCouponSumByPeriod( RSD.FIID, RSD.Amount, BegDate, m_EndDate, "X");
        IsPrintDD = true;
      end;

      ДисконтныйДоход[2] = RSD.DiscountIncome - Lot0.DiscountIncome*RSD.Amount/Lot0.Amount + ДисконтныйДоход[0];
      ДисконтныйДоход[3] = RSD.DiscountIncome;
      if(SQL_ConvTypeDate(RSD.date)<BegDate)
        ДисконтныйДоход[3] = ДисконтныйДоход[3] - RestSum(LotBefDate.DiscountIncome, RSD.Amount, LotBefDate.Amount);
      else
        ДисконтныйДоход[3] = ДисконтныйДоход[3] - RestSum(Lot0.DiscountIncome, RSD.Amount, Lot0.Amount) + ДисконтныйДоход[2];
      end;                                         

      OverAmountFrom  = BalanceCost - Sum - ДисконтныйДоход[2];

      if( SQL_ConvTypeDate(RSD.date) >= BegDate )
         OverAmountAbout = OverAmountFrom;
      else
         OverAmountAbout = BalanceCost - RestSum(LotBefDate.BalanceCost-LotBefDate.NKDAmount-LotBefDate.InterestIncome,
                                                 RSD.Amount,LotBefDate.Amount) - ДисконтныйДоход[3];
      end;

      PrintBond( ПолучитьИмяСубъекта(RSD.Issuer),                                   
                 RSD.fi_code,                                                       
                 RSD.lsin,                                                          
                 DL_getCCode(RSD.FaceValueFI),                                      
                 SQL_ConvTypeDate(RSD.date),                                        
                 SQL_ConvTypeTime(RSD.time),                                        
                 PrintSum(RSD.amount),                                              
                 GetValueLLCode(OBJTYPE_KINDPORT, RSD.Portfolio),                   
                 PrintSum(IIF(RSD.amount==0, 0, Sum / RSD.amount)),                 
                 PrintSum(Sum),                                                     
                 PrintSum(TSS),                                                     
                 PrintSum(СтоимостьTSS),                                            
                 PrintSum(IIF(RSD.amount==0, 0, BalanceCost / RSD.amount)),     
                 PrintSum(BalanceCost),                                              
                 PrintSum(OverAmountFrom),                                          
                 PrintSum(OverAmountAbout),                                         
                 PrintSum(TS_IIF(IsPrintPD,КупонныйДоход[0],"")),                                         
                 PrintSum(TS_IIF(IsPrintPD,КупонныйДоход[1],"")),                                         
                 PrintSum(TS_IIF(IsPrintPD,КупонныйДоход[2],"")),                                         
                 PrintSum(TS_IIF(IsPrintPD,КупонныйДоход[3],"")),                                         
                 PrintSum(TS_IIF(IsPrintPD,КупонныйДоход[4],"")),                                         
                 PrintSum(TS_IIF(IsPrintDD,ДисконтныйДоход[0],"")),                                       
                 PrintSum(TS_IIF(IsPrintDD,ДисконтныйДоход[1],"")),                                       
                 PrintSum(ДисконтныйДоход[2]),                                       
                 PrintSum(ДисконтныйДоход[3])                                       
               );                                                                                     

      ИтогПриобретенияПоБумаге = ИтогПриобретенияПоБумаге + Sum;
      ИтогБалансовыйПоБумаге   = ИтогБалансовыйПоБумаге   + BalanceCost;
      ИтогТССПоБумаге          = ИтогТССПоБумаге          + СтоимостьTSS;
      ИтогПереоценкаПоБумаге   = ИтогПереоценкаПоБумаге   + OverAmountAbout;

      ИтогКупонПоБумаге         = ИтогКупонПоБумаге       + КупонныйДоход[3];              
      ИтогКупонЗаПериодПоБумаге = ИтогКупонЗаПериодПоБумаге + КупонныйДоход[4];            
      ИтогКупонПоПодвиду         = ИтогКупонПоПодвиду         + КупонныйДоход[3];            
      ИтогКупонЗаПериодПоПодвиду = ИтогКупонЗаПериодПоПодвиду + КупонныйДоход[4];           
                                                                                       
      ИтогДисконтПоБумаге         = ИтогДисконтПоБумаге       + ДисконтныйДоход[2];        
      ИтогДисконтЗаПериодПоБумаге = ИтогДисконтЗаПериодПоБумаге + ДисконтныйДоход[3];      
      ИтогДисконтПоПодвиду         = ИтогДисконтПоПодвиду         + ДисконтныйДоход[2];
      ИтогДисконтЗаПериодПоПодвиду = ИтогДисконтЗаПериодПоПодвиду + ДисконтныйДоход[3];   

      ИтогПриобретенияПоПодвиду  = ИтогПриобретенияПоПодвиду  + Sum;
      ИтогТССПоПодвиду           = ИтогТССПоПодвиду           + СтоимостьTSS;
      ИтогБалансовыйПоПодвиду    = ИтогБалансовыйПоПодвиду    + BalanceCost;
      ИтогПереоценкаПоПодвиду    = ИтогПереоценкаПоПодвиду    + OverAmountAbout;

      amount = amount + RSD.amount;

      if(first) first = false; end;
      ClearData();
      circule = RSD.MoveNext();
    end;

    if( first == false )
        PrintBond( "Итого по "+string( prevCode ),"","","","","",amount,"","",ИтогПриобретенияПоБумаге,"",ИтогТССПоБумаге,"",
                   ИтогБалансовыйПоБумаге,"",ИтогПереоценкаПобумаге,"","","",ИтогКупонПоБумаге,ИтогКупонЗаПериодПоБумаге,"","",
                   ИтогДисконтПоБумаге,ИтогДисконтЗаПериодПоБумаге);
        PrintBond( "Итого по "+string( ПолучитьВидЦБ(prevKind) ),"","","","","","","","",ИтогПриобретенияПоПодвиду,"",ИтогТССПоПодвиду,"",
                   ИтогБалансовыйПоПодвиду,"",ИтогПереоценкаПоПодвиду,"","","",ИтогКупонПоПодвиду, ИтогКупонЗаПериодПоПодвиду,"","",
                   ИтогДисконтПоПодвиду, ИтогДисконтЗаПериодПоПодвиду);

      ИтогПриобретенияПоОблигациям  = ИтогПриобретенияПоОблигациям  + ИтогПриобретенияПоПодвиду;
      ИтогТССПоОблигациям           = ИтогТССПоОблигациям           + ИтогТССПоПодвиду;
      ИтогБалансовыйПоОблигациям    = ИтогБалансовыйПоОблигациям    + ИтогБалансовыйПоПодвиду;
      ИтогПереоценкаПоОблигациям    = ИтогПереоценкаПоОблигациям    + ИтогПереоценкаПоПодвиду;
      ИтогКупонПоОблигациям         = ИтогКупонПоОблигациям         + ИтогКупонПоПодвиду;
      ИтогКупонЗаПериодПоОблигациям = ИтогКупонЗаПериодПоОблигациям + ИтогКупонЗаПериодПоПодвиду;
      ИтогДисконтПоОблигациям         = ИтогДисконтПоОблигациям         + ИтогДисконтПоПодвиду;
      ИтогДисконтЗаПериодПоОблигациям = ИтогДисконтЗаПериодПоОблигациям + ИтогДисконтЗаПериодПоПодвиду;
      
      PrintBondEnd(ИтогПриобретенияПоОблигациям, ИтогТССПоОблигациям, ИтогБалансовыйПоОблигациям, ИтогПереоценкаПоОблигациям,
                   ИтогКупонПоОблигациям, ИтогКупонЗаПериодПоОблигациям, ИтогДисконтПоОблигациям, ИтогДисконтЗаПериодПоОблигациям );

      return EmissData(ИтогПриобретенияПоОблигациям, ИтогТССПоОблигациям, ИтогБалансовыйПоОблигациям, ИтогПереоценкаПоОблигациям,
                       ИтогКупонПоОблигациям, ИтогКупонЗаПериодПоОблигациям, ИтогДисконтПоОблигациям, ИтогДисконтЗаПериодПоОблигациям );

    end;

    return EmissData( $0, $0, $0, $0, $0, $0, $0, $0 );
  END;

  PRIVATE MACRO ПечататьЭЦБ( AvrKind:integer, BegDate:Date, DoPrint:bool, ItogsSum:@variant, ExistsData:@bool )
    var sqlQuery = " select wrt.t_FIID, fi.t_Issuer, fi.t_fi_code, fi.t_FaceValueFI,                    "+
                   "        avr.t_lsin, lot.t_date, lot.t_time, wrt.t_amount,                           "+
                   "        wrt.t_portfolio, wrt.t_Sum, wrt.t_balancecost, lot.t_currency,              "+
                   "        Rsb_Secur.SecurKind(fi.t_AvoirKind) avkind, wrt.t_SumID,                    "+
                   "        wrt.t_NKDAmount, wrt.t_InterestIncome, wrt.t_DiscountIncome                 " +
                   "   FROM v_scwrthistex wrt, dpmwrtsum_dbt lot, dfininstr_dbt fi, davoiriss_dbt avr   "+ 
                   "  WHERE lot.t_Trust = 'X'                                                           "+
                   "    and fi.t_AvoirKind in ( SELECT listavr.t_AvoirKind                             " +
                   "                           FROM davrkinds_dbt listavr                               " +
                   "                              START WITH listavr.t_FI_Kind = ? AND                  " +
                   "                                    listavr.t_AvoirKind = ?                         " +
                   "                            CONNECT BY listavr.t_FI_Kind = PRIOR                    " +
                   "                                       listavr.t_FI_Kind AND PRIOR                  " +
                   "                               listavr.t_AvoirKind = listavr.t_Parent)              " +
                   "        AND lot.t_Buy_Sale = 0                                                      "+
                   "        AND lot.t_Contract = ?                                                      "+
                   "        AND fi.t_FIID = lot.t_FIID                                                  "+
                   "        AND avr.t_fiid = fi.t_fiid                                                  "+
                   "        AND lot.t_SumID = wrt.t_SumID                                               "+
                   "        AND lot.t_EnterDate <= ?                                                    "+
                   "        AND lot.t_State = 1                                                         "+
                   "        AND wrt.t_amount > 0                                                        "+
                   "        AND wrt.t_instance = (SELECT MAX (hw.t_instance)                            "+
                   "                                FROM v_scwrthist hw                                 "+
                   "                               WHERE hw.t_ChangeDate <= ?                           "+
                   "                                 AND hw.t_SumID = lot.t_SumID)                      "+
                   "        AND fi.t_FaceValueFI = ? " +
                   " order by avkind, fi.t_fi_code                                                      ";

    VAR Query = RSDCommand( sqlQuery );
    
    Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
    Query.addParam("", RSDBP_IN, AvrKind);
 
    Query.addParam( "", RSDBP_IN, OrderFD.Order.rec.SfContrID );
    Query.addParam( "", RSDBP_IN, m_EndDate );
    Query.addParam( "", RSDBP_IN, m_EndDate );
    Query.addParam( "", RSDBP_IN, NATCUR );
    Query.execute();
    
    var RSD = TRsbDataSet(Query);

    ExistsData = false;
    if( RSD.MoveNext() )
       ExistsData = true;
       if( AvrKind == AVOIRISSKIND_SHARE ) 
          ItogsSum = ПечататьВидАкции(RSD,BegDate,DoPrint);           
       elif( AvrKind == AVOIRISSKIND_BOND )
          ItogsSum = ПечататьВидОблигации(RSD,BegDate,DoPrint);       
       end;                                
    end;
  END;

/*================================================================================================*/
PRIVATE MACRO GetPlanRepDateDet(bnrBCTermFormula, bnrBCPresentationDate, legMaturity)
    VAR prd = date(0,0,0);
    if((bnrBCTermFormula == 10) OR (bnrBCTermFormula == 15))
        prd = legMaturity;
    elif( (bnrBCTermFormula == 30) AND (bnrBCPresentationDate != date(0,0,0)) )
        prd = bnrBCPresentationDate;
    else
        prd = "";
    end;
    return prd;
  END;
/*================================================================================================*/
  PRIVATE MACRO ИтогПоВекселям( IssuerName, DiscountOnDate, PercentOnDate, DiscountOnPeriod,
                                PercentOnPeriod, Balance  )
    PrintTableLine( "N1_A6_1",  "Итого по " + IssuerName, NULL,
                    "N1_A6_2",  "",                       NULL,
                    "N1_A6_3",  "",                       NULL,
                    "N1_A6_4",  "",                       NULL,
                    "N1_A6_5",  "",                       NULL,
                    "N1_A6_6",  "",                       NULL,
                    "N1_A6_7",  "",                       NULL,
                    "N1_A6_7_1",  "",                     NULL,
                    "N1_A6_8",  "",                       NULL,
                    "N1_A6_9",  "",                       NULL,
                    "N1_A6_9_1",  "",                     NULL,
                    "N1_A6_10", "",                       NULL,
                    "N1_A6_11", DiscountOnDate,           NULL,
                    "N1_A6_12", PercentOnDate,            NULL,
                    "N1_A6_13", DiscountOnPeriod,         NULL,
                    "N1_A6_14", PercentOnPeriod,          NULL,
                    "N1_A6_15", Balance,                  NULL
                  );
  END;
/*================================================================================================*/
  PRIVATE MACRO GetVA_Kind( Formula )
    if( Formula == 0 )                               // VS_IN_DISCONT
      return "Дисконтный вексель";
    elif( (Formula == 1) OR (Formula == 2) )         // VS_IN_S_PC, VS_IN_M_PC
      return "Процентный вексель";
    elif( Formula == 3 )                             // VS_IN_DISC_PC
      return "Процентно-дисконтный вексель";
    end;
    return "";
  END;
/*================================================================================================*/
  PRIVATE MACRO ПечататьВидВексель(BegDate:Date, DoPrint:bool, ExistsData:@bool )
    var SqlQuery, SqlData, DataSet;
    var first = true, ItogsSum;

    SqlQuery = " select ban.t_IssuerName, leg.t_Formula, ban.t_bcSeries, ban.t_bcNumber,                                     "+
               "        ban.t_RegistrationDate, ban.t_bcTermFormula, leg.t_Principal, leg.t_PFI,                             "+
               "        lnk.t_BCCost, lnk.t_BCCostR, lnk.t_BCCFI, leg.t_Price, ban.t_BCID, leg.t_Point,                      "+
               "        ban.t_BCPresentationDate, leg.t_Start, leg.t_Duration, leg.t_Maturity                                "+
               "  from dvsbanner_dbt ban, ddl_leg_dbt leg, dvsordlnk_dbt lnk, ddl_tick_dbt tk                                "+
               " where leg.t_DealID = ban.t_BCID                                                                             "+
               "       AND leg.t_LegKind = 1                                                                                 "+
               "       AND leg.t_LegID = 0                                                                                   "+
               "   AND tk.t_ClientContrID =  ?                                                                               "+
               "   AND tk.t_DealID = lnk.t_ContractID                                                                        "+
               "       AND lnk.t_BCID = ban.t_BCID                                                                           "+
               "       AND lnk.t_DocKind IN ( 147, 906 )                                                                     "+
               "       AND lnk.t_LinkKind = 1                                                                                "+
               "       AND ( (SELECT instr(koper.t_SysTypes, 'B')                                                      "+
               "                FROM doprkoper_dbt koper                                                                "+
               "               WHERE koper.t_Kind_Operation = tk.t_DealType) != 0                                           "+
               "             or tk.t_bofficekind = "+string(TS_DOC_DECLAR)+" )                                                                            "+
               "       and lnk.t_InterestChargeDate =                                                                        "+
               "                   (SELECT nvl(max(l2.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date "+
               "                     FROM dvsordlnk_dbt l2                                                                   "+
               "             WHERE l2.t_DocKind = lnk.t_DocKind                                                              "+
               "                      AND l2.t_bcid = ban.t_BCID                                                             "+
               "                      AND l2.t_linkkind = 1                                                                  "+
               "                      AND l2.t_InterestChargeDate <= ? )                                                     "+
               "       and lnk.t_InterestChargeDate =                                                                        "+
               "           (SELECT nvl(max(l2.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date "+
               "              FROM dvsordlnk_dbt l2                                                                   "+
               "             WHERE l2.t_bcid = ban.t_BCID                                                             "+
               "               AND l2.t_InterestChargeDate <= ? )                                                     "+
               " order by ban.t_IssuerName ";

    SqlData = RSDCommand( SqlQuery );

    SqlData.addParam("", RSDBP_IN, OrderFD.Order.rec.SfContrID);
    SqlData.addParam("", RSDBP_IN, m_EndDate);
    SqlData.addParam("", RSDBP_IN, m_EndDate);

    SqlData.execute();

    DataSet = TRsbDataSet(SqlData);

    var curIssuer = -1, prevIssuer = -1;

    var
      ItogDiscountOnDate   = 0.0,
      ItogPercentOnDate    = 0.0,
      ItogDiscountOnPeriod = 0.0,
      ItogPercentOnPeriod  = 0.0,
      ItogBalance          = 0.0;
    var
      ItogAllDiscountOnDate   = 0.0,       
      ItogAllPercentOnDate    = 0.0,       
      ItogAllDiscountOnPeriod = 0.0, 
      ItogAllPercentOnPeriod  = 0.0, 
      ItogAllBalance          = 0.0; 

    ExistsData = false;

    while( DataSet.MoveNext() )
      curIssuer = DataSet.IssuerName;
      ExistsData = true;
      if( first AND DoPrint )
        PrintPortfHeader();
        CopyAllSheetInTotalBook( null, false, "N1_TableHead5", 1 );
  
        RegisterTable( "N1_TableLine5", TableHeader5,
                       "N1_A6_1",
                       "N1_A6_2",
                       "N1_A6_3",
                       "N1_A6_4",
                       "N1_A6_5",
                       "N1_A6_6",
                       "N1_A6_7",
                       "N1_A6_7_1",
                       "N1_A6_8",
                       "N1_A6_9",
                       "N1_A6_9_1",
                       "N1_A6_10",
                       "N1_A6_11",
                       "N1_A6_12",
                       "N1_A6_13",
                       "N1_A6_14",
                       "N1_A6_15"
                     );
      end;

      if( (curIssuer != prevIssuer) AND ( first == false ) )
        if(DoPrint)
           ИтогПоВекселям( prevIssuer, ItogDiscountOnDate, ItogPercentOnDate, ItogDiscountOnPeriod,
                           ItogPercentOnPeriod, ItogBalance  );
        end;

        ItogAllDiscountOnDate   = ItogAllDiscountOnDate   + ItogDiscountOnDate;
        ItogAllPercentOnDate    = ItogAllPercentOnDate    + ItogPercentOnDate;
        ItogAllDiscountOnPeriod = ItogAllDiscountOnPeriod + ItogDiscountOnPeriod;
        ItogAllPercentOnPeriod  = ItogAllPercentOnPeriod  + ItogPercentOnPeriod;
        ItogAllBalance          = ItogAllBalance          + ItogBalance;
        
        ItogDiscountOnDate   = 0.0;
        ItogPercentOnDate    = 0.0;
        ItogDiscountOnPeriod = 0.0;
        ItogPercentOnPeriod  = 0.0;
        ItogBalance          = 0.0;
      end;

      var BalanceDate = date(0,0,0);
      var incomeKind = GetVA_Kind( DataSet.Formula );
      var BalanceDealID = 0, BalanceDocKind = 0;

      var SerNumb = string(DataSet.bcNumber) + ", " + string(DataSet.bcSeries);
      var Nominal = string(DataSet.Principal);

      DL_VA_GetBalanceDate(DataSet.BCID, m_EndDate, @BalanceDate, @BalanceDealID, null, null, null, null, OrderFD.Order.rec.SfContrID, 0, @BalanceDocKind );
      var Discount = ПолучитьСуммуПДДНаДату(DataSet.BCID, m_EndDate, FIROLE_DISCOUNT, BalanceDate, BalanceDealID, BalanceDocKind);
      var Percent  = ПолучитьСуммуПДДНаДату(DataSet.BCID, m_EndDate, FIROLE_PERCENT, BalanceDate, BalanceDealID, BalanceDocKind);

      var ДатаПогашения = GetPlanRepDateDet(DataSet.bcTermFormula, SQL_ConvTypeDate(DataSet.BCPresentationDate),
                                            SQL_ConvTypeDate(DataSet.Maturity));

      var DiscountOnPeriod = Discount - ПолучитьСуммуПДДНаДату(DataSet.BCID, BegDate-1, FIROLE_DISCOUNT, BalanceDate, BalanceDealID, BalanceDocKind);
      var PercentOnPeriod  = Percent  - ПолучитьСуммуПДДНаДату(DataSet.BCID, BegDate-1, FIROLE_PERCENT, BalanceDate, BalanceDealID, BalanceDocKind);
      var Balance          = DataSet.BCCost + Discount + Percent;

      if( DataSet.BCCFI != DataSet.PFI )
         TS_SmartConvertSum( Balance, Balance, BalanceDate, DataSet.BCCFI, DataSet.PFI, true );
      end;

      if(DoPrint)
         PrintTableLine( "N1_A6_1",  DataSet.IssuerName,                       NULL,                                        
                         "N1_A6_2",  incomeKind,                               NULL,                                        
                         "N1_A6_3",  SerNumb,                                  NULL,                                        
                         "N1_A6_4",  SQL_ConvTypeDate(DataSet.Start),                    NULL,                            
                         "N1_A6_5",  BalanceDate,                              NULL,                                        
                         "N1_A6_6",  ДатаПогашения,                            NULL,                                        
                         "N1_A6_7",  PrintSum(Nominal),                        NULL,                                        
                         "N1_A6_7_1",DL_getCCode(DataSet.PFI),                           NULL,                                        
                         "N1_A6_8",  PrintSum(IIF(DataSet.Principal==0, 0, DataSet.BCCost / DataSet.Principal * 100)), NULL,
                         "N1_A6_9",  PrintSum(DataSet.BCCost),                           NULL, 
                         "N1_A6_9_1",DL_getCCode(DataSet.BCCFI),                         NULL, 
                         "N1_A6_10", PrintSum(DataSet.Price / pow(10, DataSet.Point)),   NULL,                              
                         "N1_A6_11", PrintSum(Discount),                                 NULL,                              
                         "N1_A6_12", PrintSum(Percent),                                  NULL,                              
                         "N1_A6_13", PrintSum(DiscountOnPeriod),                         NULL,                              
                         "N1_A6_14", PrintSum(PercentOnPeriod),                          NULL,                              
                         "N1_A6_15", PrintSum(Balance),                                  NULL                               
                       );                                                                                                   
      end;
                                     
      ItogDiscountOnDate   = ItogDiscountOnDate   + Discount;
      ItogPercentOnDate    = ItogPercentOnDate    + Percent;
      ItogDiscountOnPeriod = ItogDiscountOnPeriod + DiscountOnPeriod;
      ItogPercentOnPeriod  = ItogPercentOnPeriod  + PercentOnPeriod;
      ItogBalance          = ItogBalance          + Balance;

      prevIssuer = DataSet.IssuerName;
      if(first) first = false; end;
    end; // end while()

    if(first == false)
      if(DoPrint)
         ИтогПоВекселям( prevIssuer, ItogDiscountOnDate, ItogPercentOnDate, ItogDiscountOnPeriod, ItogPercentOnPeriod, ItogBalance );
      end;   
      ItogAllDiscountOnDate   = ItogAllDiscountOnDate   + ItogDiscountOnDate;
      ItogAllPercentOnDate    = ItogAllPercentOnDate    + ItogPercentOnDate;
      ItogAllDiscountOnPeriod = ItogAllDiscountOnPeriod + ItogDiscountOnPeriod;
      ItogAllPercentOnPeriod  = ItogAllPercentOnPeriod  + ItogPercentOnPeriod;
      ItogAllBalance          = ItogAllBalance          + ItogBalance;
      if(DoPrint)
         ИтогПоВекселям( "векселям", ItogAllDiscountOnDate, ItogAllPercentOnDate, ItogAllDiscountOnPeriod,
                         ItogAllPercentOnPeriod, ItogAllBalance  );
         
         EndTable();
         CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
      end;
      return VAData(ItogAllDiscountOnDate, ItogAllPercentOnDate, ItogAllDiscountOnPeriod, ItogAllPercentOnPeriod, ItogAllBalance);
    end;

    return VAData($0,$0,$0,$0,$0);

  END;
/*================================================================================================*/
  PRIVATE MACRO ПолучитьВидОперации(BuySale, Kind)
    if( ( BuySale == PM_WRITEOFF_SUM_SALE ) AND ( Kind == 330 ) ) /*WRTSUM_KIND_FS_TRUSTREQ*/
      return "Вывод ц/б";
    end;
    if( Kind == PM_WRTSUM_KIND_S )
      return "Продажа";
    elif( Kind == PM_WRTSUM_KIND_FS )
      return "Списание";
    elif( Kind == PM_WRTSUM_KIND_DI )
      return "Погашение выпуска";
    elif( Kind == PM_WRTSUM_KIND_DP )
      return "Частичное погашение";
    elif( Kind == PM_WRTSUM_KIND_DC )
      return "Погашение купона";
    end;

    return "Не определен";
  END;

  PRIVATE MACRO GetBalBefDate( _Date:Date, SumID:integer, Amount )
    var Query, RSD;

    Query = RSDCommand( " select w1.t_BalanceCost, w1.t_Amount                   "+
                        "  from dpmwrtbc_dbt w1                                 "+     
                        " where w1.t_SumID = ?                                  "+     
                        "   AND w1.t_instance = (SELECT MAX (wm.t_instance)     "+     
                        "                          FROM dpmwrtbc_dbt wm         "+     
                        "                         WHERE wm.t_SumID = w1.t_SumID "+     
                        "                           AND wm.t_changedate < ?)    "     
                       );                                                              
    Query.addParam( "", RSDBP_IN, SumID );
    Query.addParam( "", RSDBP_IN, _Date );
    Query.execute();
    RSD = TRsbDataSet(Query);

    if( RSD.movenext() )
       return RestSum( RSD.BalanceCost, Amount, RSD.Amount)
    end;

    return $0;
  END;

/*================================================================================================*/
  PRIVATE MACRO ПечататьСделкиСАкциями(RSD,BegDate:Date,DoPrint:bool)
    var circule = true;
    var prevKind = -1;
    var first = true;
    var SumCostSale = $0, SumCostBuy = $0, SumSale = $0, SumBuy = $0, OverAmountByPer = $0;
    var ALL_A7_6 = $0, ALL_A7_8 = $0, ALL_A7_9 = $0, ALL_A7_11 = $0, 
        ALL_A7_12_1 = $0, ALL_A7_12_2 = $0, ALL_A7_13 = $0, ALL_A7_14 = $0;

    macro  RegisterShare()
       if(DoPrint)
           PrintDealHeader();
          CopyAllSheetInTotalBook( null, false, "N1_TableHead6", 1 );
                                                                     
          RegisterTable( "N1_TableLine6", TableHeader6,              
                         "N1_A7_1",                                  
                         "N1_A7_2",                                  
                         "N1_A7_3",                                  
                         "N1_A7_4",                                  
                         "N1_A7_5",                                  
                         "N1_A7_6",                                  
                         "N1_A7_7",                                  
                         "N1_A7_8",                                  
                         "N1_A7_9",                                  
                         "N1_A7_10",                                 
                         "N1_A7_11",                                 
                         "N1_A7_12_1",                               
                         "N1_A7_12_2",                               
                         "N1_A7_13",                                 
                         "N1_A7_14"                                  
                       );                                            
       end;                                     
    end;

    macro  PrintShare(A7_1,A7_2,A7_3,A7_4,A7_5,A7_6,A7_7,A7_8,A7_9,A7_10,A7_11,A7_12_1,A7_12_2,A7_13,A7_14)
       if(DoPrint)
          PrintTableLine( "N1_A7_1",  A7_1, NULL,
                          "N1_A7_2",  A7_2, NULL,                       
                          "N1_A7_3",  A7_3, NULL,                       
                          "N1_A7_4",  A7_4, NULL,                       
                          "N1_A7_5",  A7_5, NULL,                       
                          "N1_A7_6",  PrintSum(A7_6), NULL,                       
                          "N1_A7_7",  PrintSum(A7_7), NULL,                       
                          "N1_A7_8",  PrintSum(A7_8), NULL,                       
                          "N1_A7_9",  PrintSum(A7_9), NULL,                       
                          "N1_A7_10", PrintSum(A7_10), NULL,                       
                          "N1_A7_11", PrintSum(A7_11), NULL,                       
                          "N1_A7_12_1", PrintSum(A7_12_1), NULL,                     
                          "N1_A7_12_2", PrintSum(A7_12_2), NULL,                     
                          "N1_A7_13",   PrintSum(A7_13), NULL,                       
                          "N1_A7_14",   PrintSum(A7_14), NULL                        
                        );
       end;                                     
    end;

    macro  PrintShareEnd()
       if(DoPrint)
          PrintShare("Итого по акциям:","","","","",ALL_A7_6,"",ALL_A7_8,ALL_A7_9,"",
                     ALL_A7_11,ALL_A7_12_1,ALL_A7_12_2,ALL_A7_13,ALL_A7_14);
          EndTable();
          CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
       end;                                     
    end;

    macro PutInItogs(A7_6,A7_8,A7_9,A7_11,A7_12_1,A7_12_2,A7_13,A7_14)
       ALL_A7_6    = ALL_A7_6   +A7_6;
       ALL_A7_8    = ALL_A7_8   +A7_8;
       ALL_A7_9    = ALL_A7_9   +A7_9;
       ALL_A7_11   = ALL_A7_11  +A7_11; 
       ALL_A7_12_1 = ALL_A7_12_1+A7_12_1;
       ALL_A7_12_2 = ALL_A7_12_2+A7_12_2;
       ALL_A7_13   = ALL_A7_13  +A7_13;
       ALL_A7_14   = ALL_A7_14  +A7_14;
    end;

    macro ClearData()
       SumCostSale = $0;
       SumCostBuy = $0;
       SumSale = $0;
       SumBuy = $0;
       OverAmountByPer = $0;
    end;

    while( circule )
       if( first )
          RegisterShare();
          first = false;
       end;

       if( RSD.avkind != prevKind )
          PrintShare( ПолучитьВидЦБ(RSD.avkind), "",  "",  "",  "",  "",  "",  "",  "", "", "", "", "", "", "" );
          prevKind = RSD.avkind;
       end;

       SumSale = RSD.SumSale;
       if(RSD.SaleCur!=RSD.FaceValueFI)
          TS_SmartConvertSum( SumSale, SumSale, SQL_ConvTypeDate(RSD.DateSale), RSD.SaleCur, RSD.FaceValueFI, true );
       end;

       SumBuy = RSD.SumBuy;
       if(RSD.BuyCur!=RSD.FaceValueFI)
          TS_SmartConvertSum( SumBuy, SumBuy, SQL_ConvTypeDate(RSD.DateBuy), RSD.BuyCur, RSD.FaceValueFI, true );
       end;

       if(RSD.Amount>0)
          SumCostSale = SumSale / RSD.Amount;
          SumCostBuy  = SumBuy  / RSD.Amount;
       end;

       if(SQL_ConvTypeDate(RSD.DateBuy)>=BegDate)
          OverAmountByPer = RSD.BalanceCostBuy-SumBuy;
       else
          OverAmountByPer = RSD.BalanceCostBuy-GetBalBefDate( BegDate, RSD.BuySumID, RSD.Amount );
       end;
    
       PrintShare( RSD.DealCodeSale,                                      
                   SQL_ConvTypeDate(RSD.DateSale),                                
                   ПолучитьВидОперации(RSD.Buy_Sale, RSD.KindSale),       
                   RSD.Name,                                          
                   DL_getCCode(RSD.FaceValueFI),                      
                   RSD.Amount,                                        
                   SumCostSale,   
                   SumSale,                                       
                   RSD.BalanceCostBuy,                                
                   SumCostBuy,   
                   SumBuy,                                       
                   RSD.BalanceCostBuy-SumBuy,                    
                   OverAmountByPer,                    
                   SumSale-RSD.BalanceCostBuy,                   
                   SumSale-SumBuy                            
                 );                                                                    
                             
       PutInItogs(RSD.Amount,SumSale,RSD.BalanceCostBuy,SumBuy,RSD.BalanceCostBuy-SumBuy,OverAmountByPer,
                  SumSale-RSD.BalanceCostBuy,SumSale-SumBuy);
       ClearData();
       circule = RSD.MoveNext();
    end;

    if( not first )
       PrintShareEnd();
       return EmissDealData(ALL_A7_6 ,ALL_A7_8,ALL_A7_9,ALL_A7_11,
                            $0,$0,$0,$0,$0,$0,
                            ALL_A7_12_1,ALL_A7_12_2,ALL_A7_13,ALL_A7_14);
    end;

    return EmissDealData($0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0);

  END;
/*================================================================================================*/
  PRIVATE MACRO ПечататьСделкиСОблигациями(RSD,BegDate:Date,DoPrint:bool)
    var circule = true;
    var prevKind = -1;
    var first = true;
    var SumCostSale = $0, SumCostBuy = $0, SumSale = $0, SumBuy = $0, BalanceCostSale = $0,
        NKDPay = $0, NKDRec = $0, PKDBefBegDate = $0, PKDByPer = $0, PKD_ADD = $0,
        DDBefBegDate = $0, DDByPer = $0, DD_ADD = $0, OverAmountBefBegDate = $0, OverAmountByPer = $0,
        FR = $0, FR_Total = $0;

    var ALL_A8_6    = $0,
        ALL_A8_8    = $0, 
        ALL_A8_9    = $0,
        ALL_A8_11   = $0,
        ALL_A8_14_1 = $0,
        ALL_A8_14_2 = $0, 
        ALL_A8_15   = $0,
        ALL_A8_16_1 = $0,
        ALL_A8_16_2 = $0,
        ALL_A8_17   = $0,
        ALL_A8_18_1 = $0,
        ALL_A8_18_2 = $0,
        ALL_A8_19   = $0,
        ALL_A8_20   = $0;


    record fiwarnts(fiwarnts);
    var pmwrtbc_0 = TRecHandler("pmwrtbc");                                              
    var pmwrtbc_1 = TRecHandler("pmwrtbc"); 
                                             
    var Query_1 = " select w.* "+                                                             
                  "  from dpmwrtbc_dbt w "+                                                   
                  " where w.t_SumID = "+string(RSD.BuySumID)+                                 
                  "   AND w.t_instance = (SELECT MAX (wm.t_instance) "+                       
                  "                          FROM dpmwrtbc_dbt wm "+                          
                  "                         WHERE wm.t_SumID = w.t_SumID "+                   
                  "                           AND wm.t_changedate < "+GetSQLDate(BegDate)+")";           
                                                                                              
    var Query_0 = " select w.* "+                                                             
                  "  from dpmwrtbc_dbt w "+                                                   
                  " where w.t_SumID = "+string(RSD.BuySumID)+                                 
                  "   AND w.t_instance = (SELECT min (ws.t_instance) "+                       
                  "                          FROM dpmwrtbc_dbt ws "+                          
                  "                         WHERE ws.t_SumID = w.t_SumID "+                   
                  "                           AND ws.t_State = 1)";                           

    macro RegisterBond()
       if(DoPrint)
          PrintDealHeader();
         CopyAllSheetInTotalBook( null, false, "N1_TableHead7", 1 );
                                                                    
         RegisterTable( "N1_TableLine7", TableHeader7,              
                        "N1_A8_1",                                  
                        "N1_A8_2",                                  
                        "N1_A8_3",                                  
                        "N1_A8_4",                                  
                        "N1_A8_5",                                  
                        "N1_A8_6",                                  
                        "N1_A8_7",                                  
                        "N1_A8_8",                                  
                        "N1_A8_9",                                  
                        "N1_A8_10",                                 
                        "N1_A8_11",                                 
                        "N1_A8_12",                               
                        "N1_A8_13",                                 
                        "N1_A8_14_1",                                 
                        "N1_A8_14_2",                                 
                        "N1_A8_15",                                 
                        "N1_A8_16_1",                                 
                        "N1_A8_16_2",                                 
                        "N1_A8_17",                                 
                        "N1_A8_18_1",                                 
                        "N1_A8_18_2",                                 
                        "N1_A8_19",                                 
                        "N1_A8_20"                                  
                      );                                            
       end;                                     
    end;

    macro  PrintBond(A8_1,A8_2,A8_3,A8_4,A8_5,A8_6,A8_7,A8_8,A8_9,A8_10,
                     A8_11,A8_12,A8_13,A8_14_1,A8_14_2,A8_15,A8_16_1,A8_16_2,A8_17,A8_18_1,A8_18_2,A8_19,A8_20)
       if(DoPrint)
          PrintTableLine( "N1_A8_1",  A8_1, NULL,
                          "N1_A8_2",  A8_2, NULL,                       
                          "N1_A8_3",  A8_3, NULL,                       
                          "N1_A8_4",  A8_4, NULL,                       
                          "N1_A8_5",  A8_5, NULL,                       
                          "N1_A8_6",  PrintSum(A8_6), NULL,                       
                          "N1_A8_7",  PrintSum(A8_7), NULL,                       
                          "N1_A8_8",  PrintSum(A8_8), NULL,                       
                          "N1_A8_9",  PrintSum(A8_9), NULL,                       
                          "N1_A8_10", PrintSum(A8_10), NULL,                       
                          "N1_A8_11", PrintSum(A8_11), NULL,                       
                          "N1_A8_12", PrintSum(A8_12), NULL,                     
                          "N1_A8_13",   PrintSum(A8_13), NULL,                       
                          "N1_A8_14_1", PrintSum(A8_14_1), NULL,                       
                          "N1_A8_14_2", PrintSum(A8_14_2), NULL,                       
                          "N1_A8_15",   PrintSum(A8_15), NULL,                       
                          "N1_A8_16_1", PrintSum(A8_16_1), NULL,                       
                          "N1_A8_16_2", PrintSum(A8_16_2), NULL,                       
                          "N1_A8_17",   PrintSum(A8_17), NULL,                       
                          "N1_A8_18_1", PrintSum(A8_18_1), NULL,                        
                          "N1_A8_18_2", PrintSum(A8_18_2), NULL,                        
                          "N1_A8_19",   PrintSum(A8_19), NULL,                        
                          "N1_A8_20",   PrintSum(A8_20), NULL                        
                        );
       end;                                     
    end;

    macro  PrintBondEnd()
       if(DoPrint)
          PrintBond("Итого по облигациям:","","","","",ALL_A8_6,"",ALL_A8_8,ALL_A8_9,"",
                     ALL_A8_11,"","",ALL_A8_14_1,ALL_A8_14_2,ALL_A8_15,
                     ALL_A8_16_1,ALL_A8_16_2,ALL_A8_17,ALL_A8_18_1,ALL_A8_18_2,ALL_A8_19,ALL_A8_20);
          EndTable();
          CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
       end;                                     
    end;

    macro PutInItogs(A8_6,A8_8,A8_9,A8_11,A8_14_1,A8_14_2,A8_15,A8_16_1,A8_16_2,A8_17,A8_18_1,A8_18_2,A8_19,A8_20)
       ALL_A8_6    = ALL_A8_6   +A8_6;
       ALL_A8_8    = ALL_A8_8   +A8_8;
       ALL_A8_9    = ALL_A8_9   +A8_9;
       ALL_A8_11   = ALL_A8_11  +A8_11; 
       ALL_A8_14_1 = ALL_A8_14_1+A8_14_1;
       ALL_A8_14_2 = ALL_A8_14_2+A8_14_2;
       ALL_A8_15   = ALL_A8_15  +A8_15;
       ALL_A8_16_1 = ALL_A8_16_1+A8_16_1;
       ALL_A8_16_2 = ALL_A8_16_2+A8_16_2;
       ALL_A8_17   = ALL_A8_17  +A8_17;
       ALL_A8_18_1 = ALL_A8_18_1+A8_18_1;
       ALL_A8_18_2 = ALL_A8_18_2+A8_18_2;
       ALL_A8_19   = ALL_A8_19  +A8_19;
       ALL_A8_20   = ALL_A8_20  +A8_20;
    end;

    macro ClearData()
        SumCostSale = $0;
        SumCostBuy = $0;
        SumSale = $0;
        SumBuy = $0;
        BalanceCostSale = $0;
        NKDPay = $0;
        NKDRec = $0;
        PKDBefBegDate = $0;
        PKDByPer = $0;
        PKD_ADD = $0;
        DDBefBegDate = $0;
        DDByPer = $0;
        DD_ADD = $0;
        OverAmountBefBegDate = $0;
        OverAmountByPer = $0;
        FR = $0;
        FR_Total = $0;
    end;

    while( circule )

      if( first )
        RegisterBond();
        first = false;
      end;

      if( RSD.avkind != prevKind )
        PrintBond( ПолучитьВидЦБ(RSD.avkind), "",  "",  "",  "",  "",  "",  "",  "", "", "", 
                                              "",  "",  "",  "",  "",  "",  "",  "", "", "",
                                              "",  "" );
      end;

      pmwrtbc_1.Clear();
      pmwrtbc_0.Clear();
      if(SQL_ConvTypeDate(RSD.DateBuy)<BegDate)                        
         TS_GetRecHandler(pmwrtbc_1,Query_1);
      end;
      TS_GetRecHandler(pmwrtbc_0,Query_0);
                                                                                  
      if( RSD.KindSale != PM_WRTSUM_KIND_DC )
         SumSale = RSD.SumSale;
         if(RSD.SaleCur!=RSD.FaceValueFI)
            TS_SmartConvertSum( SumSale, SumSale, SQL_ConvTypeDate(RSD.DateSale), RSD.SaleCur, RSD.FaceValueFI, true );
         end;
      end;

      SumCostSale = SumCostBuy = "";
      if( (RSD.KindSale != PM_WRTSUM_KIND_DC) AND (RSD.KindSale != PM_WRTSUM_KIND_DP) )
         SumCostSale = SumSale/RSD.Amount;
         BalanceCostSale = RSD.BalanceCostBuy - RSD.NKDBuyAmount - RSD.InterestIncomeBuy;
         if(pmwrtbc_0.rec.Amount>0)
            SumCostBuy = pmwrtbc_0.rec.Sum/pmwrtbc_0.rec.Amount;
            if(RSD.BuyCur!=RSD.FaceValueFI)
               TS_SmartConvertSum( SumCostBuy, SumCostBuy, SQL_ConvTypeDate(RSD.DateBuy), RSD.BuyCur, RSD.FaceValueFI, true );
            end;
         end;
         SumBuy = RSD.CostBuy;
      elif(RSD.KindSale == PM_WRTSUM_KIND_DP)
         if(pmwrtbc_0.rec.Amount>0)                                                    
            SumBuy = RestSum(pmwrtbc_0.rec.Sum, RSD.Amount, pmwrtbc_0.rec.Amount)*(RSD.PartlyPc)/100;
            if(RSD.BuyCur!=RSD.FaceValueFI)
               TS_SmartConvertSum( SumBuy, SumBuy, SQL_ConvTypeDate(RSD.DateBuy), RSD.BuyCur, RSD.FaceValueFI, true );
            end;
         end;
         BalanceCostSale = SumBuy + (RSD.CostSale - RSD.CostBuy);
      end;

      NKDRec = NKDPay = "";
      if( (RSD.KindSale != PM_WRTSUM_KIND_DP) OR (RSD.Coupon!="") )
         NKDRec = RSD.NKDSaleAmount;
         NKDPay = RSD.NKDBuyAmount;
      end;

      PKDBefBegDate = "";
      if( SQL_ConvTypeDate(RSD.DateBuy) < BegDate )
         if( (RSD.KindSale != PM_WRTSUM_KIND_DC) AND (RSD.KindSale != PM_WRTSUM_KIND_DP) )
            if( FI_GetCouponOnDate(RSD.FIID, BegDate-1, fiwarnts) == 0 ) 
               if( fiwarnts.DrawingDate >= SQL_ConvTypeDate(RSD.DateBuy) )
                  PKDBefBegDate = RestSum(pmwrtbc_1.rec.InterestIncome, RSD.Amount, pmwrtbc_1.rec.Amount);
               else
                  PKDBefBegDate = RestSum(pmwrtbc_1.rec.InterestIncome, RSD.Amount, pmwrtbc_1.rec.Amount) - 
                                  RestSum(pmwrtbc_0.rec.InterestIncome, RSD.Amount, pmwrtbc_0.rec.Amount);
               end;
            else
               PKDBefBegDate = RestSum(pmwrtbc_1.rec.InterestIncome, RSD.Amount, pmwrtbc_1.rec.Amount) - 
                               RestSum(pmwrtbc_0.rec.InterestIncome, RSD.Amount, pmwrtbc_0.rec.Amount);
            end;
         elif( (RSD.KindSale == PM_WRTSUM_KIND_DC) or 
               ((RSD.KindSale == PM_WRTSUM_KIND_DP) and (RSD.Coupon!="")) )                           
            PKDBefBegDate = TS_GetCouponSumByPeriod( RSD.FIID, RSD.Amount, SQL_ConvTypeDate(RSD.DateBuy), BegDate-1, "" );
         end;
      end;

      PKDByPer = "";
      if( (RSD.KindSale != PM_WRTSUM_KIND_DC) AND (RSD.KindSale != PM_WRTSUM_KIND_DP) )
         if( SQL_ConvTypeDate(RSD.DateBuy) < BegDate )
            if( FI_GetCouponOnDate(RSD.FIID, m_EndDate, fiwarnts) == 0 ) 
               if( fiwarnts.DrawingDate >= BegDate )
                  PKDByPer = RSD.InterestIncomeBuy;
               else
                  PKDByPer = RSD.InterestIncomeBuy - RestSum(pmwrtbc_1.rec.InterestIncome, RSD.Amount, pmwrtbc_1.rec.Amount);
               end;
            else
               PKDByPer = RSD.InterestIncomeBuy - RestSum(pmwrtbc_1.rec.InterestIncome, RSD.Amount, pmwrtbc_1.rec.Amount);
            end;
         else
            if( FI_GetCouponOnDate(RSD.FIID, m_EndDate, fiwarnts) == 0 )
               if( fiwarnts.DrawingDate >= BegDate )
                  PKDByPer = RSD.InterestIncomeBuy;
               else
                  PKDByPer = RSD.InterestIncomeBuy - RestSum(pmwrtbc_0.rec.InterestIncome, RSD.Amount, pmwrtbc_0.rec.Amount);
               end;
            else
               PKDByPer = RSD.InterestIncomeBuy - RestSum(pmwrtbc_0.rec.InterestIncome, RSD.Amount, pmwrtbc_0.rec.Amount);
            end;
         end;
      elif((RSD.KindSale == PM_WRTSUM_KIND_DC) or 
               ((RSD.KindSale == PM_WRTSUM_KIND_DP) and (RSD.Coupon!="")))   
         PKDByPer = TS_GetCouponSumByPeriod( RSD.FIID, RSD.Amount, maxDate(SQL_ConvTypeDate(RSD.DateBuy),BegDate), m_EndDate, "");
      end;

      PKD_ADD = "";
      if( (RSD.KindSale != PM_WRTSUM_KIND_DP) OR (RSD.Coupon!="") )
         PKD_ADD = RSD.InterestIncomeAdd;
      end;

      if( RSD.KindSale != PM_WRTSUM_KIND_DC )
         if( SQL_ConvTypeDate(RSD.DateBuy) < BegDate )
            DDBefBegDate = RestSum(pmwrtbc_1.rec.DiscountIncome, RSD.Amount, pmwrtbc_1.rec.Amount) - 
                           RestSum(pmwrtbc_0.rec.DiscountIncome, RSD.Amount, pmwrtbc_0.rec.Amount);
            DDByPer = RSD.DiscountIncomeBuy - RestSum(pmwrtbc_1.rec.DiscountIncome, RSD.Amount, pmwrtbc_1.rec.Amount);
         else
            DDByPer = RSD.DiscountIncomeBuy - RestSum(pmwrtbc_0.rec.DiscountIncome, RSD.Amount, pmwrtbc_0.rec.Amount);
         end;
         DD_ADD = RSD.DiscountIncomeAdd;
      end;

      OverAmountBefBegDate = BalanceCostSale - SumBuy - DDBefBegDate - DDByPer;

      if( SQL_ConvTypeDate(RSD.DateBuy) >= BegDate )
         OverAmountByPer = BalanceCostSale - SumBuy - DDByPer;
      else
         OverAmountByPer = BalanceCostSale - 
             RestSum( pmwrtbc_1.rec.BalanceCost - pmwrtbc_1.rec.NKDAmount - pmwrtbc_1.rec.InterestIncome, RSD.Amount, pmwrtbc_1.rec.Amount) - DDByPer;
      end;

      FR = SumSale - BalanceCostSale - DD_ADD; 
      FR_Total = SumSale - SumBuy;

      PrintBond( RSD.DealCodeSale,                                
                 SQL_ConvTypeDate(RSD.DateSale),                          
                 ПолучитьВидОперации(RSD.Buy_Sale, RSD.KindSale), 
                 RSD.Name,                                    
                 DL_getCCode(RSD.FaceValueFI),                
                 RSD.Amount,                                  
                 SumCostSale,                              
                 TS_IIF(RSD.KindSale!=PM_WRTSUM_KIND_DC,SumSale,""),                            
                 TS_IIF(RSD.KindSale!=PM_WRTSUM_KIND_DC,BalanceCostSale,""),                         
                 SumCostBuy,
                 TS_IIF(RSD.KindSale!=PM_WRTSUM_KIND_DC,SumBuy,""),                   
                 NKDRec,                           
                 NKDPay,                           
                 PKDBefBegDate,                            
                 PKDByPer,                               
                 PKD_ADD,                             
                 TS_IIF((RSD.KindSale!=PM_WRTSUM_KIND_DC) AND (SQL_ConvTypeDate(RSD.DateBuy) < BegDate),DDBefBegDate,""),    
                 TS_IIF(RSD.KindSale!=PM_WRTSUM_KIND_DC,DDByPer,""),                     
                 TS_IIF(RSD.KindSale!=PM_WRTSUM_KIND_DC,DD_ADD,""),        
                 OverAmountBefBegDate,               
                 OverAmountByPer,              
                 FR,
                 FR_Total     
                );

      PutInItogs(RSD.Amount,SumSale,BalanceCostSale,SumBuy,PKDBefBegDate,PKDByPer,PKD_ADD,
                 DDBefBegDate,DDByPer,DD_ADD,OverAmountBefBegDate,OverAmountByPer,FR,FR_Total);

      ClearData();

      prevKind = RSD.avkind;
      circule = RSD.MoveNext();
    end;

    if(first == false)
       PrintBondEnd();
       return EmissDealData(ALL_A8_6,ALL_A8_8,ALL_A8_9,ALL_A8_11,
                            ALL_A8_14_1,ALL_A8_14_2,ALL_A8_15,ALL_A8_16_1,ALL_A8_16_2,ALL_A8_17,
                            ALL_A8_18_1,ALL_A8_18_2,ALL_A8_19,ALL_A8_20);
    end;

    return EmissDealData($0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0);

  END;
                                                           
  PRIVATE MACRO ПечататьСделкиСЭЦБ( AvrKind:integer, BegDate:Date, DoPrint:bool, ItogsSum:@variant )
    var sqlQuery = " select lnk.t_Amount,wrtsale.t_DealCode DealCodeSale, wrtsale.t_Date DateSale, wrtbuy.t_Date DateBuy,  " +
                   "        wrtsale.t_Buy_Sale Buy_Sale, wrtsale.t_Kind KindSale, lnk.t_SumSale, " +
                   "        wrtsale.t_Currency SaleCur, wrtbuy.t_Currency BuyCur, fi.t_FaceValueFI, lnk.t_BalanceCostBuy, " +
                   "        lnk.t_SumBuy, wrtbuy.t_SumID BuySumID,  wrtsale.t_SumID SaleSumID, " +
                   "        lnk.t_NKDBuyAmount, lnk.t_InterestIncomeBuy, lnk.t_CostSale, lnk.t_CostBuy, " +
                   "        lnk.t_Partly, lnk.t_Coupon, lnk.t_NKDSaleAmount, lnk.t_NKDBuyAmount, " +
                   "        lnk.t_InterestIncomeAdd, lnk.t_DiscountIncomeBuy, lnk.t_DiscountIncomeAdd, " +
                   "        fi.t_Name, fi.t_FIID, " +
                   "        Rsb_Secur.SecurKind(fi.t_AvoirKind) avkind,                     "+ 
                   "        (case when (lnk.t_Partly != chr(0)) " +
                   "        then (RSB_FIInstr.FI_GetPartialPersentByName(fi.t_FIID,lnk.t_Partly)) else 0 end) PartlyPc " +
                   "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt wrtsale,                       " +
                   "        dpmwrtsum_dbt wrtbuy, dfininstr_dbt fi                          "+               
                   "  where lnk.t_SaleID = wrtsale.t_SumID                                  "+ 
                   "    AND lnk.t_BuyID = wrtbuy.t_SumID                                    " +
                   "    AND wrtbuy.t_Trust = 'X'                                            "+
                   "    and fi.t_AvoirKind in ( SELECT listavr.t_AvoirKind                  " +            
                   "                           FROM davrkinds_dbt listavr                   " +            
                   "                              START WITH listavr.t_FI_Kind = ? AND      " +            
                   "                                    listavr.t_AvoirKind = ?             " +            
                   "                            CONNECT BY listavr.t_FI_Kind = PRIOR        " +            
                   "                                       listavr.t_FI_Kind AND PRIOR      " +            
                   "                               listavr.t_AvoirKind = listavr.t_Parent)  " +            
                   "    and wrtsale.t_fiid = fi.t_fiid                                      " +
                   "    and wrtsale.t_Contract = ?                                          " +
                   "    and wrtsale.t_Date >= ?                                             " +
                   "    and wrtsale.t_Date <= ?                                             "+ 
                   "    and fi.t_FaceValueFI = ? " +
                   " order by avkind, fi.t_fi_code ";

    VAR Query = RSDCommand( sqlQuery );
    
    Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
    Query.addParam("", RSDBP_IN, AvrKind);
 
    Query.addParam( "", RSDBP_IN, OrderFD.Order.rec.SfContrID );
    Query.addParam( "", RSDBP_IN, BegDate );
    Query.addParam( "", RSDBP_IN, m_EndDate );
    Query.addParam( "", RSDBP_IN, NATCUR );
    Query.execute();
    
    var RSD = TRsbDataSet(Query);

    if( RSD.MoveNext() )
       if( AvrKind == AVOIRISSKIND_SHARE ) 
          ItogsSum = ПечататьСделкиСАкциями(RSD,BegDate,DoPrint);           
       elif( AvrKind == AVOIRISSKIND_BOND )
          ItogsSum = ПечататьСделкиСОблигациями(RSD,BegDate,DoPrint);       
       end;                                
    end;
  END;

/*================================================================================================*/
  PRIVATE MACRO ИтогПоВекселямСделки( IssuerName, SumBuy, Percent, Discount, PercentOnPeriod,
                                      DiscountOnPeriod, SumSale, Balance, Total )
    PrintTableLine( "N1_A9_1",  "Итого по " + IssuerName, NULL,
                    "N1_A9_2",  "",                       NULL,
                    "N1_A9_3",  "",                       NULL,
                    "N1_A9_4",  "",                       NULL,
                    "N1_A9_5",  "",                       NULL,
                    "N1_A9_6",  "",                       NULL,
                    "N1_A9_7",  "",                       NULL,
                    "N1_A9_7_1","",                       NULL,
                    "N1_A9_8",  SumBuy,                   NULL,
                    "N1_A9_9",  "",                       NULL,
                    "N1_A9_10", "",                       NULL,
                    "N1_A9_11", Percent,                  NULL,
                    "N1_A9_12", Discount,                 NULL,
                    "N1_A9_13", PercentOnPeriod,          NULL,
                    "N1_A9_14", DiscountOnPeriod,         NULL,
                    "N1_A9_15", "",                       NULL,
                    "N1_A9_16", SumSale,                  NULL,
                    "N1_A9_17", Balance,                  NULL,
                    "N1_A9_18", Total,                    NULL

                  );
  END;
/*================================================================================================*/
  PRIVATE MACRO ПечататьСделкиСВекселями(BegDate:Date,DoPrint:bool)

    var sqlQuery = " select ban.t_IssuerName, leg.t_Formula, ban.t_bcSeries, ban.t_bcNumber,       "+
                   "        ban.t_RegistrationDate, ban.t_bcTermFormula, leg.t_Principal,          "+
                   "        leg.t_PFI, ban.t_BCPresentationDate, leg.t_Start, leg.t_Duration,      "+
                   "        leg.t_Maturity, ban.t_BCID, leg.t_Price, leg.t_Point, lnk.t_BCCost,        "+
                   "        lnk.t_DocKind, tick.t_DealDate                                         "+
                   " from dvsordlnk_dbt lnk, dvsbanner_dbt ban, ddl_tick_dbt tick, ddl_leg_dbt leg "+
                   " where tick.t_ClientContrID = ?                                                "+
                   "       AND leg.t_DealID = ban.t_BCID                                           "+
                   "       AND leg.t_LegKind = 1                                                   "+
                   "       AND leg.t_LegID = 0                                                     "+
                   "       AND lnk.t_BCID = ban.t_BCID                                             "+
                   "       AND lnk.t_ContractID = tick.t_DealID                                    "+
                   "       AND (lnk.t_LinkKind = " + string(VSORDLNK_K_SALE) + 
                   "            OR (lnk.t_LinkKind = "+string(VSORDLNK_K_DRAW)+" AND lnk.t_DocKind = 148))"+    //DL_VATRREPAY
                   "       AND tick.t_DealDate >= ?                                                "+
                   "       AND tick.t_DealDate <= ?                                                ";

    VAR Query = RSDCommand( sqlQuery );
    
    Query.addParam( "", RSDBP_IN, OrderFD.Order.rec.SfContrID );
    Query.addParam( "", RSDBP_IN, BegDate );
    Query.addParam( "", RSDBP_IN, m_EndDate );

    Query.execute();
    var RSD = TRsbDataSet(Query);

    var curIssuer = -1, prevIssuer = -1;
    var first = true;

    var
      ItogSumBuy           = 0.0,
      ItogPercent          = 0.0,
      ItogDiscount         = 0.0,
      ItogPercentOnPeriod  = 0.0,
      ItogDiscountOnPeriod = 0.0,
      ItogSumSale          = 0.0,
      ItogBalance          = 0.0,
      ItogTotal            = 0.0;
    var
      ItogAllSumBuy           = 0.0,
      ItogAllPercent          = 0.0,
      ItogAllDiscount         = 0.0,
      ItogAllPercentOnPeriod  = 0.0,
      ItogAllDiscountOnPeriod = 0.0,
      ItogAllSumSale          = 0.0,
      ItogAllBalance          = 0.0,
      ItogAllTotal            = 0.0;

    while( RSD.MoveNext() )
      curIssuer = RSD.IssuerName;

      if( first and DoPrint )
        PrintDealHeader();
        CopyAllSheetInTotalBook( null, false, "N1_TableHead8", 1 );
  
        RegisterTable( "N1_TableLine8", TableHeader8,
                       "N1_A9_1",
                       "N1_A9_2",
                       "N1_A9_3",
                       "N1_A9_4",
                       "N1_A9_5",
                       "N1_A9_6",
                       "N1_A9_7",
                       "N1_A9_7_1",
                       "N1_A9_8",
                       "N1_A9_9",
                       "N1_A9_10",
                       "N1_A9_11",
                       "N1_A9_12",
                       "N1_A9_13",
                       "N1_A9_14",
                       "N1_A9_15",
                       "N1_A9_16",
                       "N1_A9_17",
                       "N1_A9_18"
                     );
      end;

      if( (curIssuer != prevIssuer) AND ( first == false ) )
        if( DoPrint )
           ИтогПоВекселямСделки( prevIssuer, ItogSumBuy, ItogPercent, ItogDiscount, ItogPercentOnPeriod,
                                 ItogDiscountOnPeriod, ItogSumSale, ItogBalance, ItogTotal );
        end;

        ItogAllSumBuy           = ItogAllSumBuy           + ItogSumBuy;
        ItogAllPercent          = ItogAllPercent          + ItogPercent;
        ItogAllDiscount         = ItogAllDiscount         + ItogDiscount;
        ItogAllPercentOnPeriod  = ItogAllPercentOnPeriod  + ItogPercentOnPeriod;
        ItogAllDiscountOnPeriod = ItogAllDiscountOnPeriod + ItogDiscountOnPeriod;
        ItogAllSumSale          = ItogAllSumSale          + ItogSumSale;
        ItogAllBalance          = ItogAllBalance          + ItogBalance;
        ItogAllTotal            = ItogAllTotal            + ItogTotal;

        ItogSumBuy           = 0.0;
        ItogPercent          = 0.0;
        ItogDiscount         = 0.0;
        ItogPercentOnPeriod  = 0.0;
        ItogDiscountOnPeriod = 0.0;
        ItogSumSale          = 0.0;
        ItogBalance          = 0.0;
        ItogTotal            = 0.0;

      end;


      var incomeKind = GetVA_Kind( RSD.Formula );
      var SerNumb = string(RSD.bcNumber) + ", " + string(RSD.bcSeries);
      var ДатаПогашения = GetPlanRepDateDet(RSD.bcTermFormula, SQL_ConvTypeDate(RSD.BCPresentationDate), SQL_ConvTypeDate(RSD.Maturity) );
      var BalanceDate = date(0,0,0);
      var BalanceDealID = 0, BalanceDocKind = 0;
      var Cost = 0.0;

      DL_VA_GetBalanceDate(RSD.BCID, SQL_ConvTypeDate(RSD.DealDate), @BalanceDate, @BalanceDealID, @Cost, null, null, null, OrderFD.Order.rec.SfContrID, 0, @BalanceDocKind );

      var Nominal = string(RSD.Principal);
      var SumSale = RSD.BCCost;

      var DiscountFull  = ПолучитьСуммуПДДНаДату(RSD.BCID, m_EndDate, FIROLE_DISCOUNT, BalanceDate, BalanceDealID, BalanceDocKind);
      var PercentFull   = ПолучитьСуммуПДДНаДату(RSD.BCID, m_EndDate, FIROLE_PERCENT, BalanceDate, BalanceDealID, BalanceDocKind);
      var Discount      = DiscountFull - ПолучитьСуммуПДДНаДату(RSD.BCID, BegDate-1, FIROLE_DISCOUNT, BalanceDate, BalanceDealID, BalanceDocKind);
      var Percent       = PercentFull - ПолучитьСуммуПДДНаДату(RSD.BCID, BegDate-1, FIROLE_PERCENT, BalanceDate, BalanceDealID, BalanceDocKind);
      var TotalIncome   = SumSale - Cost;
      var BalanceIncome = TotalIncome - DiscountFull - PercentFull;

      if( DoPrint )
         PrintTableLine( "N1_A9_1",  RSD.IssuerName,                 NULL,            
                         "N1_A9_2",  incomeKind,                     NULL,            
                         "N1_A9_3",  SerNumb,                        NULL,            
                         "N1_A9_4",  SQL_ConvTypeDate(RSD.Start),     NULL,
                         "N1_A9_5",  ДатаПогашения,                  NULL,            
                         "N1_A9_6",  BalanceDate,                    NULL,            
                         "N1_A9_7",  PrintSum(Nominal),              NULL,            
                         "N1_A9_7_1", DL_getCCode(RSD.PFI),              NULL,            
                         "N1_A9_8",  PrintSum(Cost),                           NULL,  
                         "N1_A9_9",  "1",                            NULL, // всегда 1
                         "N1_A9_10", PrintSum(RSD.Price / pow(10, RSD.Point)), NULL,  
                         "N1_A9_11", PrintSum(PercentFull),                    NULL,  
                         "N1_A9_12", PrintSum(DiscountFull),                   NULL,  
                         "N1_A9_13", PrintSum(Percent),                        NULL,  
                         "N1_A9_14", PrintSum(Discount),                       NULL,  
                         "N1_A9_15", SQL_ConvTypeDate(RSD.DealDate),             NULL,
                         "N1_A9_16", PrintSum(SumSale),                        NULL,  
                         "N1_A9_17", PrintSum(BalanceIncome),                  NULL,  
                         "N1_A9_18", PrintSum(TotalIncome),                    NULL   
                       );                                                             
      end;
      ItogSumBuy           = ItogSumBuy           + Cost;
      ItogPercent          = ItogPercent          + PercentFull;
      ItogDiscount         = ItogDiscount         + DiscountFull;
      ItogPercentOnPeriod  = ItogPercentOnPeriod  + Percent;
      ItogDiscountOnPeriod = ItogDiscountOnPeriod + Discount;
      ItogSumSale          = ItogSumSale          + SumSale;
      ItogBalance          = ItogBalance          + BalanceIncome;
      ItogTotal            = ItogTotal            + TotalIncome;

      prevIssuer = RSD.IssuerName;
      if(first) first = false; end;
    end;

    if(first == false)
      if( DoPrint )
         ИтогПоВекселямСделки( RSD.IssuerName, ItogSumBuy, ItogPercent, ItogDiscount, ItogPercentOnPeriod,
                               ItogDiscountOnPeriod, ItogSumSale, ItogBalance, ItogTotal );
      end;
      ItogAllSumBuy           = ItogAllSumBuy           + ItogSumBuy;          
      ItogAllPercent          = ItogAllPercent          + ItogPercent;         
      ItogAllDiscount         = ItogAllDiscount         + ItogDiscount;        
      ItogAllPercentOnPeriod  = ItogAllPercentOnPeriod  + ItogPercentOnPeriod; 
      ItogAllDiscountOnPeriod = ItogAllDiscountOnPeriod + ItogDiscountOnPeriod;
      ItogAllSumSale          = ItogAllSumSale          + ItogSumSale;         
      ItogAllBalance          = ItogAllBalance          + ItogBalance;         
      ItogAllTotal            = ItogAllTotal            + ItogTotal;           

      if( DoPrint )
         ИтогПоВекселямСделки( "векселям", ItogAllSumBuy, ItogAllPercent, ItogAllDiscount, ItogAllPercentOnPeriod,
                               ItogAllDiscountOnPeriod, ItogAllSumSale, ItogAllBalance, ItogAllTotal );

         EndTable();
         CopyAllSheetInTotalBook( null, false, GetTableRange(), 0 );
      end;

      return VADealData(ItogAllSumBuy, ItogAllPercent, ItogAllDiscount, ItogAllPercentOnPeriod,
                               ItogAllDiscountOnPeriod, ItogAllSumSale, ItogAllBalance, ItogAllTotal);
    end;

    return VADealData($0,$0,$0,$0,$0,$0,$0,$0);
  END;

  PRIVATE MACRO GetSumFromTotal(OrderID, TotalType, EventID, Sign, BegDate:Date, EndDate:Date )
    var Query, RSD, EventID_ = -1;
    
    if( ValType(EventID) == V_INTEGER )
       EventID_ = EventID;
    end;

    Query = RSDCommand( " select NVL(sum(t_RestAmount),0) RestAmount  "+
                        "  from dtstotal_dbt  "+     
                        " where t_OrderID = ? "+     
                        "   AND t_TotalType = ? "+     
                        TS_IIF(EventID_>0,"   AND t_EventID = ? ","")+     
                        "   AND t_Sign = ? "+     
                        "   AND t_RestDate >= ? " +
                        "   AND t_RestDate <= ? "
                       );                                                              
    Query.addParam( "", RSDBP_IN, OrderID );
    Query.addParam( "", RSDBP_IN, TotalType );
    if( EventID_ > 0 )
       Query.addParam( "", RSDBP_IN, EventID_ );
    end;
    Query.addParam( "", RSDBP_IN, Sign );
    Query.addParam( "", RSDBP_IN, BegDate );
    Query.addParam( "", RSDBP_IN, EndDate );
    Query.execute();
    RSD = TRsbDataSet(Query);

    if( RSD.movenext() )
       return RSD.RestAmount;
    end;

    return $0;
  END;

  PRIVATE MACRO SetInOut( In:@money, Out:@money )
   if( In < $0. )
      Out = abs(In);
      In = $0;
   else
      Out = $0;
   end;
  END;                                               

  PRIVATE MACRO СуммаПроводокПоКатегории( CatCode:string, BegDate:Date )/*в рублях*/
    var Query, SqlQuery, DataSet;

    SqlQuery = RSDCommand("select NVL(SUM(abs(arh.t_Sum_Payer)),0) as ArhSum " +
                          "  from dacctrn_dbt arh, " +
                          "       (SELECT distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                          "          FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dmctempl_dbt templ " +
                          "         WHERE accdoc.t_ClientContrID = ? " +
                          "           AND accdoc.t_CatID    = categ.t_ID " +
                          "           AND categ.t_LevelType = 1 " +
                          "           AND categ.t_Code      = ? "
                          "           and templ.t_CatID = categ.t_ID" +
                          "           and templ.t_Number = accdoc.t_TemplNum " +
                          "           and (CASE WHEN (categ.t_Param1 = ? AND categ.t_class1 = ?) THEN templ.t_Value1  " +
                          "                      WHEN (categ.t_Param2 = ? AND categ.t_class2 = ?) THEN templ.t_Value2  " +
                          "                      WHEN (categ.t_Param3 = ? AND categ.t_class3 = ?) THEN templ.t_Value3  " +
                          "                      WHEN (categ.t_Param4 = ? AND categ.t_class4 = ?) THEN templ.t_Value4  " +
                          "                      WHEN (categ.t_Param5 = ? AND categ.t_class5 = ?) THEN templ.t_Value5  " +
                          "                      WHEN (categ.t_Param6 = ? AND categ.t_class6 = ?) THEN templ.t_Value6  " +
                          "                      WHEN (categ.t_Param7 = ? AND categ.t_class7 = ?) THEN templ.t_Value7  " +
                          "                      WHEN (categ.t_Param8 = ? AND categ.t_class8 = ?) THEN templ.t_Value8  " +
                          "                 END) in (3,4)  " +
                          "           and (CASE WHEN (categ.t_Param1 = ? AND categ.t_class1 = ?) THEN templ.t_Value1  " +
                          "                      WHEN (categ.t_Param2 = ? AND categ.t_class2 = ?) THEN templ.t_Value2  " +
                          "                      WHEN (categ.t_Param3 = ? AND categ.t_class3 = ?) THEN templ.t_Value3  " +
                          "                      WHEN (categ.t_Param4 = ? AND categ.t_class4 = ?) THEN templ.t_Value4  " +
                          "                      WHEN (categ.t_Param5 = ? AND categ.t_class5 = ?) THEN templ.t_Value5  " +
                          "                      WHEN (categ.t_Param6 = ? AND categ.t_class6 = ?) THEN templ.t_Value6  " +
                          "                      WHEN (categ.t_Param7 = ? AND categ.t_class7 = ?) THEN templ.t_Value7  " +
                          "                      WHEN (categ.t_Param8 = ? AND categ.t_class8 = ?) THEN templ.t_Value8  " +
                          "                 END) = 20 " +
                          "       ) acc " +
                          " where arh.t_FIID_Payer = acc.t_Currency " +
                          "   and arh.t_chapter = acc.t_Chapter " +
                          "   and arh.t_account_payer = acc.t_Account " +
                          "   and arh.t_date_carry >= ? " +
                          "   and arh.t_date_carry <= ? " +
                          "   and arh.t_State = 1 "/*фактическая проводка*/);

    SqlQuery.addParam("", RSDBP_IN, OrderFD.Order.rec.SfContrID);
    SqlQuery.addParam("", RSDBP_IN, CatCode);

    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSFIKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSFIKIND );    

    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
    SqlQuery.addParam("", RSDBP_IN, OBJTYPE_TSDEBKIND );  
    SqlQuery.addParam("", RSDBP_IN, LLCLASS_TSDEBKIND );    
                                            
    SqlQuery.addParam("", RSDBP_IN, BegDate );
    SqlQuery.addParam("", RSDBP_IN, m_EndDate );

    SqlQuery.execute();                                       
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    if( DataSet.MoveNext() )
        return DataSet.ArhSum;
    end;

    return $0.;
  END;

  PRIVATE MACRO ПечататьФинРез(ShareFromBegY, ShareByPer, BondFromBegY, BondByPer, VAFromBegY, VAByPer,
                               ShareDealFromBegY, ShareDealByPer, BondDealFromBegY, BondDealByPer, VADealFromBegY, VADealByPer,
                               NoShareBond:bool, NoVA:bool)
   var H10 = $0, H10_1 = $0, H11 = $0, H11_1 = $0, H12 = $0, H12_1 = $0, H13 = $0, H13_1 = $0, H14 = $0, H14_1 = $0,
         H15 = $0, H15_1 = $0, H16 = $0, H16_1 = $0, H17 = $0, H17_1 = $0, H18 = $0, H18_1 = $0, H19 = $0, H19_1 = $0,
         H20 = $0, H20_1 = $0, H21 = $0, H21_1 = $0, H22 = $0, H22_1 = $0, H23 = $0, H23_1 = $0, H24 = $0, H24_1 = $0,
         H25 = $0, H25_1 = $0, H26 = $0, H26_1 = $0, H27 = $0, H27_1 = $0, H28 = $0, H28_1 = $0, H29 = $0, H29_1 = $0,
         H30 = $0, H30_1 = $0, H31 = $0, H31_1 = $0, H32 = $0, H32_1 = $0, H33 = $0, H33_1 = $0, H34 = $0, H34_1 = $0,
         H35_1 = $0, H36_1 = $0, H37_1 = $0;

   var СтавкаНДС = ДУ_ПолучитьНДС(true);

   MACRO PrintAvr( Sum:money, IsPrint )
      if( IsPrint )
         return Sum;
      else
         return "-";
      end;
   END;

   /*Векселя:*/
   H11 = VADealByPer.BalanceCost + VADealByPer.DDByPer + VADealByPer.PDByPer + VAByPer.PDByPer + VAByPer.DDByPer;
   SetInOut(@H11,@H20);

   H11_1 = VADealFromBegY.BalanceCost + VADealFromBegY.DDByPer + VADealFromBegY.PDByPer + VAFromBegY.PDByPer + VAFromBegY.DDByPer;
   SetInOut(@H11_1,@H20_1);

   /*Акции:*/
   H12 = ShareByPer.OverAmount + ShareDealByPer.OverAmountByPer + ShareDealByPer.FR;
   SetInOut(@H12,@H21);

   H12_1 = ShareFromBegY.OverAmount + ShareDealFromBegY.OverAmountByPer + ShareDealFromBegY.FR;
   SetInOut(@H12_1,@H21_1);

   if( H12 > $0. )
      H13 = ShareByPer.OverAmount;
      SetInOut(@H13,@H14);
      H22 = H23 = $0;
   else
      H22 = ShareByPer.OverAmount;
      SetInOut(@H22,@H23);
      H13 = H14 = $0;
   end;

   if( H12_1 > $0. )
      H13_1 = ShareFromBegY.OverAmount;
      SetInOut(@H13_1,@H14_1);
      H22_1 = H23_1 = $0;
   else
      H22_1 = ShareFromBegY.OverAmount;
      SetInOut(@H22_1,@H23_1);
      H13_1 = H14_1 = $0;
   end;
   /*Облигации:*/
   H15 = BondByPer.OverAmount + BondByPer.DDByPer + BondByPer.KDByPer + BondDealByPer.OverAmountByPer+ 
         (BondDealByPer.PKDByPer + BondDealByPer.PKD_ADD) + 
         (BondDealByPer.DDByPer + BondDealByPer.DD_ADD) + BondDealByPer.FR;
   SetInOut(@H15,@H24);

   H15_1 = BondFromBegY.OverAmount + BondFromBegY.DDByPer + BondFromBegY.KDByPer  + BondDealFromBegY.OverAmountByPer +
           (BondDealFromBegY.PKDByPer + BondDealFromBegY.PKD_ADD) + 
           (BondDealFromBegY.DDByPer + BondDealFromBegY.DD_ADD) + BondDealFromBegY.FR;
   SetInOut(@H15_1,@H24_1);

   if( H15 > $0. )
      H16 = BondByPer.OverAmount;
      SetInOut(@H16,@H17);
      H25 = H26 = $0;
   else
      H25 = BondByPer.OverAmount;
      SetInOut(@H25,@H26);
      H16 = H17 = $0;
   end;

   if( H15_1 > $0. )
      H16_1 = BondFromBegY.OverAmount;
      SetInOut(@H16_1,@H17_1);
      H25_1 = H26_1 = $0;
   else
      H25_1 = BondFromBegY.OverAmount;
      SetInOut(@H25_1,@H26_1);
      H16_1 = H17_1 = $0;
   end;

   /*ДивидеHды*/
   H18 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Д_Двд, TS_DemandEvent("51"), 1 /*HачсислеHие*/, m_BegDate, m_EndDate);
   H18_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Д_Двд, TS_DemandEvent("51"), 1 /*HачсислеHие*/, m_BegYearDate, m_EndDate);

   /*Доходы:*/
   H10 = H11+ H12 + H15+ H18;
   H10_1 = H11_1+ H12_1 + H15_1+ H18_1;

   /*Комисии:*/
   H27 = СуммаПроводокПоКатегории("РасходыЭцб ДУ", m_BegDate ) + 
         GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 1, m_BegDate, m_EndDate);

   H27_1 = СуммаПроводокПоКатегории("РасходыЭцб ДУ", m_BegYearDate ) + 
         GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 1, m_BegYearDate, m_EndDate);

   H28 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("65"), 1, m_BegDate, m_EndDate);
   H28_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("65"), 1, m_BegYearDate, m_EndDate);

   H30 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Купр, "", 1, m_BegDate, m_EndDate);
   H30_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Купр, "", 1, m_BegYearDate, m_EndDate);

   H31 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Кусп, "", 1, m_BegDate, m_EndDate);
   H31_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Кусп, "", 1, m_BegYearDate, m_EndDate);

   H32 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Кдв, "", 1, m_BegDate, m_EndDate);
   H32_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Кдв, "", 1, m_BegYearDate, m_EndDate);

   H29 = H30 + H31 + H32;
   H29_1 = H30_1 + H31_1 + H32_1;

   H33 =  H29 * СтавкаНДС / (СтавкаНДС + 100);
   H33_1 =  H29_1 * СтавкаНДС / (СтавкаНДС +100);

   H35_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Дх,TS_DemandEvent("83"), -1 /*"СписаHие"*/, m_BegYearDate, m_EndDate);
   H36_1 = GetSumFromTotal(OrderFD.ID, ДУ_ИТОГ_Н_Дх, TS_DemandEvent("96"), -1, m_BegYearDate, m_EndDate);

   /*Расходы:*/
   H19 = H20 + H21+ H24 + H27 + H28 + H29;
   H19_1 = H20_1 + H21_1 + H24_1 + H27_1+ H28_1 + H29_1;

   /*Прибыли/Убытки*/
   H34 = H10 - H19;
   H34_1 = H10_1 - H19_1;

   H37_1 = H34_1  - H35_1 - H36_1;

   PrintFormatString(TableHeader9,
                     "N1_H10", H10,
                     "N1_H10_1", H10_1,
                     "N1_H11", PrintAvr(H11,(NoVA==false)),
                     "N1_H11_1", PrintAvr(H11_1,(NoVA==false)),
                     "N1_H12", PrintAvr(H12,(NoShareBond==false)),
                     "N1_H12_1", PrintAvr(H12_1,(NoShareBond==false)),
                     "N1_H13", PrintAvr(H13,(NoShareBond==false)),
                     "N1_H13_1", PrintAvr(H13_1,(NoShareBond==false)),
                     "N1_H14", PrintAvr(H14,(NoShareBond==false)),
                     "N1_H14_1", PrintAvr(H14_1,(NoShareBond==false)),
                     "N1_H15", PrintAvr(H15,(NoShareBond==false)),
                     "N1_H15_1", PrintAvr(H15_1,(NoShareBond==false)),
                     "N1_H16", PrintAvr(H16,(NoShareBond==false)),
                     "N1_H16_1", PrintAvr(H16_1,(NoShareBond==false)),
                     "N1_H17", PrintAvr(H17,(NoShareBond==false)),
                     "N1_H17_1", PrintAvr(H17_1,(NoShareBond==false)),
                     "N1_H18", PrintAvr(H18,(NoShareBond==false)),
                     "N1_H18_1", PrintAvr(H18_1,(NoShareBond==false)),
                     "N1_H19", H19,
                     "N1_H19_1", H19_1,
                     "N1_H20", PrintAvr(H20,(NoVA==false)),
                     "N1_H20_1", PrintAvr(H20_1,(NoVA==false)),
                     "N1_H21", PrintAvr(H21,(NoShareBond==false)),
                     "N1_H21_1", PrintAvr(H21_1,(NoShareBond==false)),
                     "N1_H22", PrintAvr(H22,(NoShareBond==false)),
                     "N1_H22_1", PrintAvr(H22_1,(NoShareBond==false)),
                     "N1_H23", PrintAvr(H23,(NoShareBond==false)),
                     "N1_H23_1", PrintAvr(H23_1,(NoShareBond==false)),
                     "N1_H24", PrintAvr(H24,(NoShareBond==false)),
                     "N1_H24_1", PrintAvr(H24_1,(NoShareBond==false)),
                     "N1_H25", PrintAvr(H25,(NoShareBond==false)),
                     "N1_H25_1", PrintAvr(H25_1,(NoShareBond==false)),
                     "N1_H26", PrintAvr(H26,(NoShareBond==false)),
                     "N1_H26_1", PrintAvr(H26_1,(NoShareBond==false)),
                     "N1_H27", PrintAvr(H27,(NoShareBond==false)),
                     "N1_H27_1", PrintAvr(H27_1,(NoShareBond==false)),
                     "N1_H28", PrintAvr(H28,(NoShareBond==false)),
                     "N1_H28_1", PrintAvr(H28_1,(NoShareBond==false)),
                     "N1_H29", H29,
                     "N1_H29_1", H29_1,
                     "N1_H30", H30,
                     "N1_H30_1", H30_1,
                     "N1_H31", H31,
                     "N1_H31_1", H31_1,
                     "N1_H32", H32,
                     "N1_H32_1", H32_1,
                     "N1_H33", H33,
                     "N1_H33_1", H33_1,
                     "N1_H34", H34,
                     "N1_H34_1", H34_1,
                     "N1_H35_1", H35_1,
                     "N1_H36_1", H36_1,
                     "N1_H37_1", H37_1
                    );
   CopyAllSheetInTotalBook( null, false, "N1_FR", 1 );

  END;

/*================================================================================================*/
  PRIVATE MACRO Create()
    var ПечататьАкции = false;
    var ПечататьОблигации = false;
    var ПечататьВексель   = false;
    var ShareFromBegY = EmissData( $0, $0, $0, $0, $0, $0, $0, $0 ),
        ShareByPer = EmissData( $0, $0, $0, $0, $0, $0, $0, $0 ),
        BondByPer = EmissData( $0, $0, $0, $0, $0, $0, $0, $0 ),
        BondFromBegY = EmissData( $0, $0, $0, $0, $0, $0, $0, $0 ), 
        VAFromBegY = VAData($0,$0,$0,$0,$0),
        VAByPer = VAData($0,$0,$0,$0,$0),
        ShareDealFromBegY = EmissDealData($0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0),
        ShareDealByPer = EmissDealData($0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0),
        BondDealFromBegY = EmissDealData($0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0),
        BondDealByPer = EmissDealData($0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0,$0),
        VADealFromBegY = VADealData($0,$0,$0,$0,$0,$0,$0,$0),
        VADealByPer = VADealData($0,$0,$0,$0,$0,$0,$0,$0);
    var ExShareByPer = false, ExBondByPer = false,
        ExShareFromBegY = false, ExBondFromBegY = false,
        ExVAByPer = false, ExVAFromBegY = false;

    PrintRepHeader();
    ПечатьКапиталВУправлении();
    ПечататьДСДЗ();

    m_PortfHeaderPrint = false;
    m_PortfDealPrint   = false;
 
    if( (m_AvrKind == AVOIRISSKIND_SHARE) OR (m_AvrKind == -1) )
      ПечататьАкции = true;
      ПечататьЭЦБ(AVOIRISSKIND_SHARE,m_BegDate,true,@ShareByPer,@ExShareByPer);
      ПечататьЭЦБ(AVOIRISSKIND_SHARE,m_BegYearDate,false,@ShareFromBegY,@ExShareFromBegY);
    end;
    if( (m_AvrKind == AVOIRISSKIND_BOND) OR (m_AvrKind == -1) )
      ПечататьОблигации = true;
      ПечататьЭЦБ(AVOIRISSKIND_BOND,m_BegDate,true,@BondByPer,@ExBondByPer);
      ПечататьЭЦБ(AVOIRISSKIND_BOND,m_BegYearDate,false,@BondFromBegY,@ExBondFromBegY);
    end;

    if( (m_AvrKind == AVOIRISSKIND_BILL) OR (m_AvrKind == -1) )
      ПечататьВексель = true;
      VAByPer = ПечататьВидВексель(m_BegDate,true,@ExVAByPer);
      VAFromBegY = ПечататьВидВексель(m_BegYearDate,false,@ExVAFromBegY);
    end;

    if(ExShareByPer or ExBondByPer or ExVAByPer)
       PrintPortfFooter();
    end;

    if( ПечататьАкции )
      ПечататьСделкиСЭЦБ(AVOIRISSKIND_SHARE,m_BegDate,true,@ShareDealByPer);
      ПечататьСделкиСЭЦБ(AVOIRISSKIND_SHARE,m_BegYearDate,false,@ShareDealFromBegY);
    end;
    if( ПечататьОблигации )
      ПечататьСделкиСЭЦБ(AVOIRISSKIND_BOND,m_BegDate,true,@BondDealByPer);
      ПечататьСделкиСЭЦБ(AVOIRISSKIND_BOND,m_BegYearDate,false,@BondDealFromBegY);
    end;
    if( ПечататьВексель )
      VADealByPer = ПечататьСделкиСВекселями(m_BegDate,true);
      VADealFromBegY = ПечататьСделкиСВекселями(m_BegYearDate,false);
    end;

    ПечататьФинРез(ShareFromBegY, ShareByPer, BondFromBegY, BondByPer, VAFromBegY, VAByPer,
                   ShareDealFromBegY, ShareDealByPer, BondDealFromBegY, BondDealByPer, VADealFromBegY, VADealByPer,
                   ((ExShareByPer == false) AND (ExShareFromBegY == false) AND
                   (ExBondByPer == false) AND (ExBondFromBegY == false)),
                   ((ExVAByPer == false) AND (ExVAFromBegY == false))
                  );

    AddStandardFooter( "N1_" );
    CopyAllSheetInTotalBook( null, false, "N1_Footer", 1 );
  END;
/*================================================================================================*/
  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  initDL_CReportTemplate( null, "Report_incexp.xls" );
END;
/*================================================================================================*/
macro MakeReport()

  var Form = TS_IncExp_Panel();

  while( Form.Run() )

    if( Form.GetFieldValue( PNFLD_TSINCEXP_ENDDATE ) > {curdate} )
      msgbox( "Дата окончания отчетного периода превышает текущую дату" );
      continue;
    end;

    if( Form.GetFieldValue( PNFLD_TSINCEXP_CLIENT_ID ) < 0 )
      msgbox( "Не выбран код клиента" );
      continue;
    end;

    if( Form.GetFieldValue( PNFLD_TSINCEXP_CLIENTCONTR ) < 0 )
      msgbox( "Не выбран № договора с клиентом" );
      continue;
    end;

    TS_IncExp_Report(Form).Run();

  end;

end;
/*================================================================================================*/
MakeReport();

Exit(1);
