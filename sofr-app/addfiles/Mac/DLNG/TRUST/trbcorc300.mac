/* IAL XX.11.2008                                               */
/*                                                             */   
/* ДУ (Доверительное управление )                              */
/*                                                             */

/* Операция покупки ц/б на бирже (или через брокера)           */
/*   Шаг - закрытие операции в режиме Online                   */
import "tssec.mac";

macro ExecuteStep( Doc, FDoc )
  record deal(dl_tick);       
  var    contrID, FD, error; 

  SetBuff( deal, FDoc ); 
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );
     
/*
  if( FD.GetPeriodComiss() )/*по договору есть периодические комиссии*/
     msgbox("По договору есть периодические комиссии.|Нельзя закрыть сделку в режиме online.");
     return 1;
  end;
*/

  if( FD.tick.rec.CommDate != Date(0,0,0) ) 
     /*Проверяем оплаченность единовременных комиссий (начислена но не оплачена)*/
     if( not ОплаченыВсеЕдинКомиссии(FD.dl_leg.rec, FD) )
        msgbox( "Оплачены не все единовременные комиссии|Нельзя закрыть сделку" );
        return 1;
     end;
  end; 

  if( not ВыполненыВсеПроводки( FD, error ) )
     msgbox( error );
     return 1;
  end;

  return 0;
end;
