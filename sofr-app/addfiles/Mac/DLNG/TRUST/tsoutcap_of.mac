/* Вывод капитала ДОФБУ
   Шаг "Возврат средств"*/
IMPORT InsCarryDoc, TSInter, "tstrans.mac", "dl_car.mac", "tstotal.mac";

PRIVATE VAR Request = TRecHandler( "tsiorqst.dbt" ), /*Заполняется программой при выполнении шага*/
            DlDoc:MEMADDR,
            ID_Operation:INTEGER,
            ID_Step:INTEGER,
            recAsset:Object,
            ReqFD:TS_RequestFD,
            OrderFD:TS_OrderFD,
            AssetFD:TS_ReqAssetFD,
            ДатаУменьшенияКапитала:DATE,
            ДатаСписания:DATE;

PRIVATE MACRO CheckDate():BOOL
  VAR ErrStr = "";

  if( ДатаСписания == Date(0,0,0) )
     ErrStr = "Не задана дата списания средств.";
  elif( ДатаСписания > {curdate} )
     ErrStr = "Дата списания средств больше текущей даты.";
  else
     return true;
  end;

  MsgBox( ErrStr + "|Необходимо отредактировать дату в форме заявления на вывод капитала." );
  return false;
END;

PRIVATE MACRO ВыполнитьВыводКапитала():BOOL
  VAR Sвыв, Кдвф, Куспф:money = $0.0, Нкудф:money = $0.0;
  VAR OrderFD_OFBU:TS_OrderFD,
      СчетУчета = TRecHandler("account.dbt" );

  recAsset = ReqFD.MoveNextAsset();
  AssetFD  = TS_ReqAssetFD( recAsset, 0, OrderFD, ReqFD );
  Sвыв     = AssetFD.КоличествоАктива();

  OrderFD_OFBU = TS_OrderFD( 0, OrderFD.Order.rec.OFBU );
  VAR AssetFD_OFBU = TS_ReqAssetFD( recAsset, 0, OrderFD_OFBU, ReqFD );
  VAR PayOFBU = (OrderFD_OFBU.Order().rec.DP_ShareCalc == TS_CALCPART_NOMINAL);

  if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, ReqFD.Kind, ReqFD.Id, ДатаУменьшенияКапитала, @Кдвф, NULL, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Кдв\"по договору" );
     return 1;
  end;
  if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, ReqFD.Kind, ReqFD.Id, ДатаУменьшенияКапитала, @Куспф, NULL, NULL ) )
     MsgBox( "Ошибка при получении итога \"Н_Куп\"по договору" );
     return 1;
  end;

  if(PayOFBU)
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, ReqFD.Kind, ReqFD.Id, ДатаУменьшенияКапитала, @Нкудф, NULL, NULL ) )
        MsgBox( "Ошибка при получении итога \"Н_Налог\"по договору" );
        return 1;
     end;
  end;

  if( not OrderFD_OFBU.OpenAccount( null, "ДС ДУ", null, null, FIROLE_BANKROLL, СчетУчета, ДатаСписания) )
     return false;
  end;

  if( not ПроводкаПоКатегориямУчетаПоДоговору( AssetFD, null, null, 
                                               "-Расчеты, ДУ", СчетУчета, /* AccDeb , AccCred*/
                                               ДатаСписания,              /* Дата */
                                               2,                         /* Глава */
                                               NATCUR,                    /* Валюта */
                                               (Sвыв - Кдвф - Куспф - Нкудф), /* Сумма */
                                               DlDoc,                     /* Документ */
                                               OrderFD.Number,            /* Numb_Document */
                                               TS_IIF( ReqFD.IsOutFULL(), "Вывод денежных средств", "Перевод денежных средств учредителю" ) + " по договору " + OrderFD.Number(), /* Ground */
                                               FIROLE_BANKROLL,
                                               FIROLE_BANKROLL
                                              ) 
    )
      return false;
  end;

  if( TS_ExecuteDemandByMark( TS_BofficeKind(), ID_Operation, TS_DemandUserMark_Req( TS_DEMAND_ROLE_OBLIGATION, Request.rec.ID, recAsset.rec.ID ), ДатаСписания, true ) != 0 )
     return false;
  end;

  if( ИсполнитьПлатеж( AssetFD.Payment(), (РАБОТА_С_РАСЧЕТНЫМ_БАНКОМ() == true) ) )
     return false;
  end;

  if( not ПроводкаПоКатегориямВнутреннегоУчета( 91,
                                                AssetFD_OFBU,
                                                DlDoc, 
                                                ДатаСписания, 
                                                recAsset.rec.FIID,  
                                                (Sвыв - Кдвф - Куспф - Нкудф)
                                              ) )
     return false;
  end;
           
  return true;
END;

MACRO ExecuteStep( _DlDoc, _FDoc, _DocKind, _ID_Operation, _ID_Step )

  DlDoc                  = _DlDoc;
  ID_Operation           = _ID_Operation;
  ID_Step                = _ID_Step;
  ДатаСписания           = Request.rec.FactTransferDate;
  ДатаУменьшенияКапитала = Request.rec.CapitalDate; 
  OrderFD = TS_OrderFD( 0, Request.rec.OrderID );
  ReqFD   = TS_RequestFD( Request, null, OrderFD );

  if( not CheckDate() )
     return 1;
  end;

  if( not ВыполнитьВыводКапитала() )
     return 1;
  end;

  return 0;
END;

