/*
$Name:        trprdssc.mac
$Module:      Доверительное управление
$Description: 
*/

IMPORT InsCarryDoc, /*"tssec.mac"*/ "tstrans.mac";
PRIVATE VAR ServOp = TRecHandler( "tssrvop.dbt" ); /*Сервисная операция, из которой выполняется расчет*/

macro ExecuteStep( D, FirstDoc, _DocKind, ID_Operation, ID_Step )
   macro ВыполнитьПроводки( FD, Portfolio, FIID, dat, BalanceCost, NotCarryInterest, NotCarryDiscount, InterestIncome, DiscountIncome, 
                                                   WriteOffNotCarryIncome, OldInterestIncome, OldDiscountIncome, Amount )
      var CategAddIncome;
      var AvoirissFD:TS_AvoirissFD;
      
      AvoirissFD = TS_AvoirissFD( FIID, FD.Order.rec.ID );
      AvoirissFD.Order.ОпределитьПортфельДляПроводок( Portfolio );

      /* Доначисление дохода */
      if( FI_IsResponsible(FIID, dat) == true )
         CategAddIncome = "ДоходыЭцб ДУ";
      else
         CategAddIncome = "ПДДЭцб ДУ";
      end;

      if( (NotCarryInterest < 0) and (FI_IsResponsible(FIID, dat) == true) )
         if( not ПроводкаПоКатегориямУчетаПоДоговору( AvoirissFD, NULL, NULL,
                                                      "ПДДЭцб ДУ", "ДоходыЭцб ДУ",  /* AccDeb , AccCred*/
                                                      dat,                            /* Дата */
                                                      2,                              /* Глава */
                                                      NATCUR,                         /* Валюта */
                                                      Abs(NotCarryInterest),          /* Сумма */
                                                      FirstDoc,                       /* Документ */
                                                      FD.Number,                      /* Numb_Document */
                                                      "Отнесение начисленного ПД на доходы",/* Ground */
                                                      FIROLE_PERCENT, FIROLE_PERCENT
                                                    ) )
             msgbox("Ошибка при выполнении проводки \"Отнесение начисленного ПД на доходы\"");
             return 1;
         end;
      end;

      if( (NotCarryDiscount < 0) and (FI_IsResponsible(FIID, dat) == true) ) 
         if( not ПроводкаПоКатегориямУчетаПоДоговору( AvoirissFD, NULL, NULL, 
                                                      "ПДДЭцб ДУ", "ДоходыЭцб ДУ",  /* AccDeb , AccCred*/
                                                      dat,                            /* Дата */
                                                      2,                              /* Глава */
                                                      NATCUR,                         /* Валюта */
                                                      Abs(NotCarryDiscount),          /* Сумма */
                                                      FirstDoc,                       /* Документ */
                                                      FD.Number,                      /* Numb_Document */
                                                      "Отнесение начисленного ДД на доходы",/* Ground */
                                                      FIROLE_DISCOUNT, FIROLE_DISCOUNT
                                                    ) )
             msgbox("Ошибка при выполнении проводки \"Отнесение начисленного ДД на доходы\"");
             return 1;
         end;
      end;

      if( InterestIncome > 0 )
         if( not ПроводкаПоКатегориямУчетаПоДоговору( AvoirissFD, NULL, NULL,
                                                      "ПортфельЭцб ДУ", CategAddIncome,  /* AccDeb , AccCred*/
                                                      dat,                            /* Дата */
                                                      2,                              /* Глава */
                                                      NATCUR,                         /* Валюта */
                                                      InterestIncome,                 /* Сумма */
                                                      FirstDoc,                       /* Документ */
                                                      FD.Number,                      /* Numb_Document */
                                                      "Доначисление ПД",/* Ground */
                                                      FIROLE_PERCENT, FIROLE_PERCENT
                                                    ) )
             msgbox("Ошибка при выполнении проводки \"Доначисление ПД\"");
             return 1;
         end;
      end;

      if( DiscountIncome > 0 ) 
         if( not ПроводкаПоКатегориямУчетаПоДоговору( AvoirissFD, NULL, NULL, 
                                                       "ПортфельЭцб ДУ", CategAddIncome,  /* AccDeb , AccCred*/
                                                       dat,                            /* Дата */
                                                       2,                              /* Глава */
                                                       NATCUR,                         /* Валюта */
                                                       DiscountIncome,                 /* Сумма */
                                                       FirstDoc,                       /* Документ */
                                                       FD.Number,                      /* Numb_Document */
                                                       "Доначисление ДД",/* Ground */
                                                       FIROLE_DISCOUNT, FIROLE_DISCOUNT
                                                     ) )
             msgbox("Ошибка при выполнении проводки \"Доначисление ДД\"");
             return 1;
         end;
      end;

      return 0;
   end;
   
   
   macro ВыполнитьДляГруппы(Group, Previous_Step, Delivered, WithoutAccept)
      var cmd, IsResponsible, Sum = $0, CatDeb = "", CatCred = "", FIRoleDeb, FIRoleCred, OrderFD, ground, DebFIID, CredFIID, dat;
      var BalanceCost = $0, NotCarryInterest = $0, NotCarryDiscount = $0,
          InterestIncome = $0, DiscountIncome = $0, WriteOffNotCarryIncome = $0,
          OldInterestIncome = $0, OldDiscountIncome = $0, Amount = $0;
      var RSD, SQLcmd, FIID;

      OrderFD = TS_OrderFD( 0, FirstDoc );
      dat = ServOp.rec.OperDate;

      var CalcInterest:bool = true, CalcDiscount:bool = true;
      if( ServOp.rec.SubKind_Operation == 1 )
         CalcDiscount = false;
      elif( ServOp.rec.SubKind_Operation == 2 )
         CalcInterest = false;
      end;

      var Kind:integer = 0;
      if( (CalcInterest == true) and (CalcDiscount == true) )
         Kind = PM_WRTSUM_UPDTMODE_INCPDD;
      elif( CalcInterest == true )
         Kind = PM_WRTSUM_UPDTMODE_INCPD;
      elif( CalcDiscount == true )
         Kind = PM_WRTSUM_UPDTMODE_INCDD;
      end;

      if( ( FIID = FindFirstTSSRVOBJ( ServOp.rec.ID, TS_DOC_ACTIVE )) > ALLFININSTR )
         cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTGetServiceFinResult(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);\n end; ");

         cmd.addParam("p_ID_Operation",  RSDBP_IN,     ID_Operation  );
         cmd.addParam("p_ID_Step",       RSDBP_IN,     Previous_Step );
         cmd.addParam("p_Action",        RSDBP_IN,     Kind          );
         cmd.addParam("p_Party",         RSDBP_IN,     OrderFD.Trustor.rec.PartyID );
         cmd.addParam("p_Contract",      RSDBP_IN,     OrderFD.SfContr.rec.ID );
         cmd.addParam("p_FIID",          RSDBP_IN,     FIID          );
         cmd.addParam("p_Portfolio",     RSDBP_IN,     Group         );
         cmd.addParam("p_Delivered",     RSDBP_IN,     Delivered     );
         cmd.addParam("p_WithoutAccept", RSDBP_IN,     WithoutAccept );
         cmd.addParam("p_BalanceCost",            RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_InterestIncome",         RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_DiscountIncome",         RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_Bonus",                  RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_DefDiff",                RSDBP_OUT, V_DOUBLE );
      	 cmd.addParam("p_CorrIntToEIR",           RSDBP_OUT, V_DOUBLE );
         cmd.addParam("p_OldInterestIncome",      RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_OldDiscountIncome",      RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_OldBonus",               RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_Amount",                 RSDBP_OUT,    V_DOUBLE   );
         cmd.addParam("p_BonusAmount",            RSDBP_OUT,    V_DOUBLE   ); 
         cmd.addParam("p_DiscountAmount",         RSDBP_OUT,    V_DOUBLE   ); 
         cmd.addParam("p_InterestAmount",         RSDBP_OUT,    V_DOUBLE   );
         cmd.execute();

         BalanceCost            = cmd.value( 9);
         InterestIncome         = cmd.value(10);
         DiscountIncome         = cmd.value(11);
         OldInterestIncome      = cmd.value(15);
         OldDiscountIncome      = cmd.value(16);
         Amount                 = cmd.value(18);
      
         if( ВыполнитьПроводки( OrderFD, Group, FIID, dat, BalanceCost, NotCarryInterest, NotCarryDiscount, InterestIncome, DiscountIncome, 
                                                   WriteOffNotCarryIncome, OldInterestIncome, OldDiscountIncome, Amount )
           )
            return 1;
         end;
      else
         SQLcmd = RSDCommand( "select distinct t_FIID from dpmwrtsum_dbt where t_Party = ? and t_Contract = ? and t_Department = ?" );
         SQLcmd.addParam( "", RSDBP_IN, OrderFD.Trustor.rec.PartyID );
         SQLcmd.addParam( "", RSDBP_IN, OrderFD.SfContr.rec.ID );
         SQLcmd.addParam( "", RSDBP_IN, ServOp.rec.Department );
         SQLcmd.execute();

         RSD = TRsbDataSet(SQLcmd);
         while( RSD.MoveNext() )

            cmd = RsdCommand("begin\n RSB_PMWRTOFF.WRTGetServiceFinResult(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);\n end; ");

            cmd.addParam("p_ID_Operation",  RSDBP_IN,     ID_Operation  );
            cmd.addParam("p_ID_Step",       RSDBP_IN,     Previous_Step );
            cmd.addParam("p_Action",        RSDBP_IN,     Kind          );
            cmd.addParam("p_Party",         RSDBP_IN,     OrderFD.Trustor.rec.PartyID );
            cmd.addParam("p_Contract",      RSDBP_IN,     OrderFD.SfContr.rec.ID );
            cmd.addParam("p_FIID",          RSDBP_IN,     RSD.rec.FIID  );
            cmd.addParam("p_Portfolio",     RSDBP_IN,     Group         );
            cmd.addParam("p_Delivered",     RSDBP_IN,     Delivered     );
            cmd.addParam("p_WithoutAccept", RSDBP_IN,     WithoutAccept );
            cmd.addParam("p_BalanceCost",            RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_InterestIncome",         RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_DiscountIncome",         RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_Bonus",                  RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_DefDiff",                RSDBP_OUT, V_DOUBLE );
      	    cmd.addParam("p_CorrIntToEIR",           RSDBP_OUT, V_DOUBLE );
            cmd.addParam("p_OldInterestIncome",      RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_OldDiscountIncome",      RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_OldBonus",               RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_Amount",                 RSDBP_OUT,    V_DOUBLE   );
            cmd.addParam("p_BonusAmount",            RSDBP_OUT,    V_DOUBLE   ); 
            cmd.addParam("p_DiscountAmount",         RSDBP_OUT,    V_DOUBLE   ); 
            cmd.addParam("p_InterestAmount",         RSDBP_OUT,    V_DOUBLE   ); 
            cmd.execute();

         BalanceCost            = cmd.value( 9);
         InterestIncome         = cmd.value(10);
         DiscountIncome         = cmd.value(11);
         OldInterestIncome      = cmd.value(15);
         OldDiscountIncome      = cmd.value(16);
         Amount                 = cmd.value(18);

            if( ВыполнитьПроводки( OrderFD, Group, RSD.rec.FIID, dat, BalanceCost, NotCarryInterest, NotCarryDiscount, InterestIncome, DiscountIncome, 
                                                      WriteOffNotCarryIncome, OldInterestIncome, OldDiscountIncome, Amount )
              )
               return 1;
            end;
         
         end;
      end;

      return 0;
   end;

   if( TS_RunFromServiceOper( ServOp ) != true )
      MsgBox( "Шаг \"Начисление ПДД\" должен выполняться только из соответствующей сервисной операции." );
      return 1;
   end;                                                         

   var Previous_Step = 0;
   var Query = RSDCommand(" Select MAX(t_ID_Step) Previous_Step From doprstep_dbt Where t_ID_Operation = ? and t_ID_Step <> ? and t_ServDocKind = ? and t_ServDocID = ?");
   Query.addParam( "", RSDBP_IN, ID_Operation );
   Query.addParam( "", RSDBP_IN, ID_Step );
   Query.addParam( "", RSDBP_IN, ServOp.rec.Kind_Operation );
   Query.addParam( "", RSDBP_IN, ServOp.rec.ID );
   Query.execute();
   var DataSet = TRsbDataSet(Query);

   if (DataSet.MoveNext())
      Previous_Step = DataSet.Previous_Step;
   else
      return 1;
   end;

   if ((ВыполнитьДляГруппы(KINDPORT_TRADETRUST, Previous_Step, 1, 0) != 0) or 
       (ВыполнитьДляГруппы(KINDPORT_SALETRUST,  Previous_Step, 1, 0) != 0)
      )
      return 1;
   end;

   return 0;
end;
