/* Операция движения активов
   Списание обязательств*/
IMPORT InsCarryDoc, TSInter;

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )
  VAR    RoleOA, RoleBA;;
  RECORD Oper( tsoper );
  SetBuff( Oper, FDoc );   

  RoleOA = ПолучитьРольТО( Oper.MainDemand );
  RoleBA = ПолучитьРольТО( Oper.BaseDemand );

  if( RoleOA == TS_DEMAND_ROLE_OBLIGATION )
     if( TS_DiscardDemandByID( Oper.MainDemand, Oper.BeginDate, true ) != 0 )
        return 1;
     end;
  end;

  if( RoleBA == TS_DEMAND_ROLE_OBLIGATION )
     if( TS_DiscardDemandByID( Oper.BaseDemand, Oper.BeginDate, true ) != 0 )
        return 1;
     end;
  end;

  if( not InsertOprStatus( TS_OPERSTATUS_KIND_OBLIGATION, TS_OPERSTATUS_OBLIGATION_OUT) ) 
     msgbox( "Ошибка при установке статуса операции" );
     return 1;
  end;

  if( GetOprStatus( TS_OPERSTATUS_KIND_DEMAND ) == TS_OPERSTATUS_DEMAND_OUT )
     if( not InsertOprStatus( TS_OPERSTATUS_KIND_DOC, TS_OPERSTATUS_CLOSE ) ) 
        msgbox( "Ошибка при установке статуса операции" );
        return 1;
     end;
  end;

  return 0;
END;

