/* Заявление на внесение/вывод  капитала*/
IMPORT TSInter, "tscateg.mac";

PRIVATE VAR Документ       = TRecHandler( "tsiorqst" );
PRIVATE VAR СтарыйДокумент = TRecHandler( "tsiorqst" ); /* заполняется при редактировании */

PRIVATE VAR ReqDoc    = TRecHandler( "spground.dbt" );
PRIVATE VAR OldReqDoc = TRecHandler( "spground.dbt" );


/* Получить выводимую сумму.
   Вызывается в интерфейсе ввода/редактирования ВВК полного вывода капитала для ДП ОФБУ 
   OutSumma = выводимая сумма.
   Вернуть
     0 - ошибок не было
     1 - была ошибка
*/
PRIVATE MACRO GetOutSumma( OutSumma:@MONEY ):INTEGER
  /* выплачиваемая по Заявлению сумма, равная остатку л/счета "Капитал ДУ" на дату приема Заявления (Sвыв) */ 
  VAR OrderFD = TS_OrderFD( 0, Документ.rec.OrderID );
  OutSumma = OrderFD.ОстатокПоСчету( "Капитал ДУ", Документ.rec.Date /*дата приема*/);
  return 0;
END;

PRIVATE MACRO GetBalanceCostEmiss( ID:integer, CalcDate:DATE, OutSumma:@MONEY ):INTEGER
  VAR ТП_Стек:MONEY,  ТП_ПДначисл:MONEY,  ТП_ДДначисл:MONEY,  ТП_НКДупл:MONEY,
      ППР_Стек:MONEY, ППР_ПДначисл:MONEY, ППР_ДДначисл:MONEY, ППР_НКДупл:MONEY;
  VAR OrderFD = TS_OrderFD( 0, Документ.rec.OrderID );
  VAR ReqFD   = TS_RequestFD( Документ, null, OrderFD );
  var AssetFD = TS_ReqAssetFD( 0, ID, OrderFD, ReqFD );
  ТП_Стек = ТП_ПДначисл = ТП_ДДначисл = ТП_НКДупл = ППР_Стек = ППР_ПДначисл = ППР_ДДначисл = ППР_НКДупл =$0;

  AssetFD.ПолучитьСуммыСписанияЭЦБ( @ТП_Стек,  @ТП_ПДначисл,  @ТП_ДДначисл,  @ТП_НКДупл,  null, null,
                                    @ППР_Стек, @ППР_ПДначисл, @ППР_ДДначисл, @ППР_НКДупл, null, null, CalcDate
                                  );

  OutSumma = Round(ТП_Стек /* + ТП_ПДначисл  + ТП_ДДначисл  + ТП_НКДупл */ +
                   ППР_Стек/* + ППР_ПДначисл + ППР_ДДначисл + ППР_НКДупл */, 2);
  return 0;
END;

PRIVATE MACRO GetBalanceCostNotEmiss( ID:integer, CalcDate:DATE, OutSumma:@MONEY ):INTEGER
  VAR BalCost:MONEY, ПДначисл:MONEY, ДДначисл:MONEY;
  VAR OrderFD = TS_OrderFD( 0, Документ.rec.OrderID );
  VAR ReqFD   = TS_RequestFD( Документ, null, OrderFD );
  var AssetFD = TS_ReqAssetFD( 0, ID, OrderFD, ReqFD );
  BalCost = ПДначисл = ДДначисл = $0;

  AssetFD.ПолучитьСуммыСписанияНЦБ( @BalCost, @ПДначисл, @ДДначисл, null, null, CalcDate );

  OutSumma = Round(BalCost + ПДначисл + ДДначисл, 2);
  return 0;
END;


/* Инициализации новой операции 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ():INTEGER
  return 0;
END;


/* Макрофункция проверки операции при вводе, редактировании, удалении 
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Проверить_Документ( Режим:INTEGER ):INTEGER

  if( Режим == TS_INSERT ) /* ввод нового договора */

  elif( Режим == TS_EDIT ) /* редактирование договора */

  elif( Режим == TS_DELETE ) /* удаление договора*/

  elif( Режим == TS_REQ_EXECUTE ) /* перед запуском операции */

  end;

  return 0;
END;

/* Макрофункция вызывается по Ctrl-Z из скроллинга/панели */
PRIVATE MACRO Функция_Пользователя()
   MsgBox( "Выполняется макрофункция \"tsrequest.mac\\ Функция_Пользователя\"." );
END;