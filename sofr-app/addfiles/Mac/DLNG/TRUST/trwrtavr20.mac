/* Операция списания/зачисления ц/б
   Шаг актуализации счетов */

import InsCarryDoc, "tssec.mac", "dldlngfun.mac";

macro ExecuteStep( Doc, ticket, DocKind, OperationID, ID_Step )

  record deal(dl_tick);
  var    FD, dat;

  SetBuff( deal, ticket );
  FD = SPFirstDocTrust( deal );
  GetOprDate( 0, dat );

  if( not FD.IsExistAccount( "ПортфельЭцб ДУ", null, true, null, null, null, dat) )
     MsgBoxEx( " Не обнаружены лицевые балансовые счета для учета вложений"+ 
               " в ценные бумаги \"" + string(FD.fininstr().rec.FI_Code) + "\"" +
               " портфеля \"" + DL_GetValueName( OBJTYPE_KINDPORT, FD.ТипПортфеля() )  + "\"\n" +
               " Для  того, чтобы впоследствии операции начисления и" +
               " переоценки были корректными, РЕКОМЕНДУЕТСЯ для этой ц/б" + 
               " задать оответствующий счет категории" +
               " \"ПортфельЭцб ДУ\" ( Меню \"Счета для документа\")",
            MB_OK, MB_OK,
            "Предупреждение", "Подтверждение выполнения шага" );
  end;

  /*Вставка лота*/
  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_CREATE, dat, FD ) )
     msgbox("Ошибка при создании лота");
     return 1;
  end;

  if( TS_CreateDemandSEC_ByDeal( FD, OperationID, ID_Step ) == false )
     return 1;
  end;


  return 0;
end;

