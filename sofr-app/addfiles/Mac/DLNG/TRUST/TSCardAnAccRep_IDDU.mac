/********************************************************************************************
 DESCRIPTION  : Отчет "Карточка аналитического учета учредителя"
 PROGRAMMED BY: Shalygo S.M.
 CREATION DATE: 18.06.2010
********************************************************************************************/
IMPORT "TSCardAnAccRep_Form.mac", "tscomiss.mac";

PRIVATE CLASS ТаблицаПромРез( A20_:string, B20_:Date, C20_:Date )
   VAR A20 = A20_,
       B20 = B20_,
       C20 = C20_;
END;

CLASS (TS_CardAnAcc_Report_General) TS_CardAnAcc_Report( FData:TSCardAnAccFormData )

  var m_delta1 = 0; /* смещение всех полей от размножения строк в первой таблице */
  var m_delta2 = 0; /* смещение для 2-го блока */
  var m_delta3 = 0; /* смещение для 3-го блока */
  var m_delta4 = 0; /* смещение для 4-го блока */
  var m_delta5 = 0; /* смещение для 5-го блока */
  var m_FormData:TSCardAnAccFormData = FData;
  var m_CountOrder:integer = 0, m_Count:integer = -1;
  var m_RSD_Order, m_Orders;
  var m_OrderFD:TS_OrderFD;
  var m_BegDate:date;
  var m_BegValidDate:date, m_EndValidDate:date;
  var m_PrevValid;

  var m_Select = "   from dtsorder_dbt tsorder, dspground_dbt ground                                                    " +
                 "  where tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end)                               " +
                 "    and tsorder.t_DocKind       = ?                                                                   " +
                 "    and ground.t_SourceDocID    = tsorder.t_ID                                                        " +
                 "    and ground.t_SourceDocKind  = tsorder.t_DocKind                                                   " +
                 "    and (ground.t_TerminateDate = TO_DATE('01.01.0001','DD.MM.YYYY') or ground.t_TerminateDate >= ? ) " +
                 "    and ground.t_BeginningDate <= ?                                                                   ";

  /* смещение для текущего договора в соответствующей вкладке */
  var m_DeltaOrderN1 = 0,
      m_DeltaOrderN2 = 0,
      m_DeltaOrderN3 = 0,
      m_DeltaOrderN4 = 0,
      m_DeltaOrderN5 = 0,
      m_DeltaOrderN6 = 0,
      m_DeltaOrderN7 = 0,
      m_DeltaOrderN8 = 0;

  /* печались ли данные для текущего договора в соответствующей вкладке */
  var m_PrintOrderN2 = false,
      m_PrintOrderN3 = false,
      m_PrintOrderN4 = false,
      m_PrintOrderN5 = false,
      m_PrintOrderN6 = false,
      m_PrintOrderN7 = false;

  /* есть ли уже соответствующая вкладка в главной книге */
  var m_SheetN1 = false,
      m_SheetN2 = false,
      m_SheetN3 = false,
      m_SheetN4 = false,
      m_SheetN5 = false,
      m_SheetN6 = false,
      m_SheetN7 = false,
      m_SheetN8 = false;

  /* В этих переменных храним ячейки из различных листов, что бы потом их вывести на итогом */
  var GL_FVA3, GL_FVB22_1, GL_FVA5, GL_FVA6, GL_VB27,
      GL_VZ1, GL_VZ1_1, GL_VZ1_2,
      GL_FAA3, GL_AA14, GL_FAC2, GL_FAA10, GL_FAA5, GL_AA15,
      GL_FOA17_1, GL_FOA24, GL_OA19, GL_FOA21_1, GL_FOD2, GL_FOA15, GL_FOA11, GL_OA20;

  CONST N1_F1_X  = "F";  CONST N1_F1_Y  = 1;
  CONST N1_B66_X = "B";  CONST N1_B66_Y = 66;
  CONST N1_B70_X = "B";  CONST N1_B70_Y = 70;
  CONST N1_C1_X  = "C";  CONST N1_C1_Y  = 1;
  CONST N1_C3_X  = "C";  CONST N1_C3_Y  = 3;
  CONST N1_C34_X = "C";  CONST N1_C34_Y = 34;
  CONST N1_C35_X = "C";  CONST N1_C35_Y = 35;
  CONST N1_C36_X = "C";  CONST N1_C36_Y = 36;
  CONST N1_C38_X = "C";  CONST N1_C38_Y = 38;
  CONST N1_C39_X = "C";  CONST N1_C39_Y = 39;
  CONST N1_C40_X = "C";  CONST N1_C40_Y = 40;
  CONST N1_C66_X = "C";  CONST N1_C66_Y = 66;
  CONST N1_C75_X = "C";  CONST N1_C75_Y = 75;
  CONST N1_C80_X = "C";  CONST N1_C80_Y = 80;
  CONST N1_F5_X  = "F";  CONST N1_F5_Y  = 5;
  CONST N1_F6_X  = "F";  CONST N1_F6_Y  = 6;
  CONST N1_F12_X = "F";  CONST N1_F12_Y = 12;
  CONST N1_F24_X = "F";  CONST N1_F24_Y = 24;
  CONST N1_F34_X = "F";  CONST N1_F34_Y = 34;
  CONST N1_F35_X = "F";  CONST N1_F35_Y = 35;
  CONST N1_F36_X = "F";  CONST N1_F36_Y = 36;
  CONST N1_F38_X = "F";  CONST N1_F38_Y = 38;
  CONST N1_F39_X = "F";  CONST N1_F39_Y = 39;
  CONST N1_F40_X = "F";  CONST N1_F40_Y = 40;
  CONST N1_F55_X = "F";  CONST N1_F55_Y = 55;
  CONST N1_F62_X = "F";  CONST N1_F62_Y = 62;
  CONST N1_F75_X = "F";  CONST N1_F75_Y = 75;
  CONST N1_F80_X = "F";  CONST N1_F80_Y = 80;
  CONST N1_H5_X  = "H";  CONST N1_H5_Y  = 5;
  CONST N1_H6_X  = "H";  CONST N1_H6_Y  = 6;
  CONST N1_H8_X  = "H";  CONST N1_H8_Y  = 8;
  CONST N1_H34_X = "H";  CONST N1_H34_Y = 34;
  CONST N1_H35_X = "H";  CONST N1_H35_Y = 35;
  CONST N1_H36_X = "H";  CONST N1_H36_Y = 36;
  CONST N1_H37_X = "H";  CONST N1_H37_Y = 37;
  CONST N1_H38_X = "H";  CONST N1_H38_Y = 38;
  CONST N1_H39_X = "H";  CONST N1_H39_Y = 39;
  CONST N1_H40_X = "H";  CONST N1_H40_Y = 40;
  CONST N1_H42_X = "H";  CONST N1_H42_Y = 42;
  CONST N1_H44_X = "H";  CONST N1_H44_Y = 44;
  CONST N1_H45_X = "H";  CONST N1_H45_Y = 45;
  CONST N1_H46_X = "H";  CONST N1_H46_Y = 46;
  CONST N1_H47_X = "H";  CONST N1_H47_Y = 47;
  CONST N1_H52_X = "H";  CONST N1_H52_Y = 52;
  CONST N1_H54_X = "H";  CONST N1_H54_Y = 54;
  CONST N1_H55_X = "H";  CONST N1_H55_Y = 55;
  CONST N1_H80_X = "H";  CONST N1_H80_Y = 80;
  CONST N1_J5_X  = "J";  CONST N1_J5_Y  = 5;
  CONST N1_J58_X = "J";  CONST N1_J58_Y = 58;
  CONST N1_J59_X = "J";  CONST N1_J59_Y = 59;
  CONST N1_J75_X = "J";  CONST N1_J75_Y = 75;
  CONST N1_I5_X  = "I";  CONST N1_I5_Y  = 5;
  CONST N1_K13_X = "K";  CONST N1_K13_Y = 13;
  CONST N1_L13_X = "L";  CONST N1_L13_Y = 13;
  CONST N1_J7_X  = "J";  CONST N1_J7_Y  = 7;
  CONST N1_J34_X = "J";  CONST N1_J34_Y = 34;
  CONST N1_J35_X = "J";  CONST N1_J35_Y = 35;
  CONST N1_J36_X = "J";  CONST N1_J36_Y = 36;
  CONST N1_J38_X = "J";  CONST N1_J38_Y = 38;
  CONST N1_J39_X = "J";  CONST N1_J39_Y = 39;
  CONST N1_G12_X = "G";  CONST N1_G12_Y = 12;
  CONST N1_G13_X = "G";  CONST N1_G13_Y = 13;
  CONST N1_G18_X = "G";  CONST N1_G18_Y = 18;
  CONST N1_G20_X = "G";  CONST N1_G20_Y = 20;
  CONST N1_G22_X = "G";  CONST N1_G22_Y = 22;
  CONST N1_G23_X = "G";  CONST N1_G23_Y = 23;
  CONST N1_G24_X = "G";  CONST N1_G24_Y = 24;
  CONST N1_G25_X = "G";  CONST N1_G25_Y = 25;
  CONST N1_G26_X = "G";  CONST N1_G26_Y = 26;
  CONST N1_G27_X = "G";  CONST N1_G27_Y = 27;
  CONST N1_G28_X = "G";  CONST N1_G28_Y = 28;
  CONST N1_G30_X = "G";  CONST N1_G30_Y = 30;
  CONST N1_G34_X = "G";  CONST N1_G34_Y = 34;
  CONST N1_G35_X = "G";  CONST N1_G35_Y = 35;
  CONST N1_G36_X = "G";  CONST N1_G36_Y = 36;
  CONST N1_G38_X = "G";  CONST N1_G38_Y = 38;
  CONST N1_G39_X = "G";  CONST N1_G39_Y = 39;
  CONST N1_G40_X = "G";  CONST N1_G40_Y = 40;
  CONST N1_G55_X = "G";  CONST N1_G55_Y = 55;
  CONST N1_G80_X = "G";  CONST N1_G80_Y = 80;
  CONST N1_D34_X = "D";  CONST N1_D34_Y = 34;
  CONST N1_D35_X = "D";  CONST N1_D35_Y = 35;
  CONST N1_D36_X = "D";  CONST N1_D36_Y = 36;
  CONST N1_D37_X = "D";  CONST N1_D37_Y = 37;
  CONST N1_D38_X = "D";  CONST N1_D38_Y = 38;
  CONST N1_D39_X = "D";  CONST N1_D39_Y = 39;
  CONST N1_D40_X = "D";  CONST N1_D40_Y = 40;
  CONST N1_D48_X = "D";  CONST N1_D48_Y = 48;
  CONST N1_D49_X = "D";  CONST N1_D49_Y = 49;
  CONST N1_D50_X = "D";  CONST N1_D50_Y = 50;
  CONST N1_D51_X = "D";  CONST N1_D51_Y = 51;
  CONST N1_D52_X = "D";  CONST N1_D52_Y = 52;
  CONST N1_D53_X = "D";  CONST N1_D53_Y = 53;
  CONST N1_D54_X = "D";  CONST N1_D54_Y = 54;
  CONST N1_D66_X = "D";  CONST N1_D66_Y = 66;
  CONST N1_D70_X = "D";  CONST N1_D70_Y = 70;
  CONST N1_E35_X = "E";  CONST N1_E35_Y = 35;
  CONST N1_E36_X = "E";  CONST N1_E36_Y = 36;
  CONST N1_E38_X = "E";  CONST N1_E38_Y = 38;
  CONST N1_E39_X = "E";  CONST N1_E39_Y = 39;
  CONST N1_E40_X = "E";  CONST N1_E40_Y = 40;
  CONST N1_E59_X = "E";  CONST N1_E59_Y = 59;
  CONST N1_E60_X = "E";  CONST N1_E60_Y = 60;
  CONST N1_E61_X = "E";  CONST N1_E61_Y = 61;
  CONST N1_E62_X = "E";  CONST N1_E62_Y = 62;


  CONST N2_A12_X = "A";  CONST N2_A12_Y = 12;
  CONST N2_G1_X  = "G";  CONST N2_G1_Y  = 1;
  CONST N2_G8_X  = "G";  CONST N2_G8_Y  = 8;
  CONST N2_G12_X = "G";  CONST N2_G12_Y = 12;
  CONST N2_O8_X  = "O";  CONST N2_O8_Y  = 8;
  CONST N2_O12_X = "O";  CONST N2_O12_Y = 12;
  CONST N2_C2_X  = "C";  CONST N2_C2_Y  = 2;
  CONST N2_C8_X  = "C";  CONST N2_C8_Y  = 8;
  CONST N2_L4_X  = "L";  CONST N2_L4_Y  = 4;
  CONST N2_L5_X  = "L";  CONST N2_L5_Y  = 5;
  CONST N2_L12_X = "L";  CONST N2_L12_Y = 12;
  CONST N2_N8_X  = "N";  CONST N2_N8_Y  = 8;
  CONST N2_D8_X  = "D";  CONST N2_D8_Y  = 8;
  CONST N2_D12_X = "D";  CONST N2_D12_Y = 12;
  CONST N2_F8_X  = "F";  CONST N2_F8_Y  = 8;
  CONST N2_F12_X = "F";  CONST N2_F12_Y = 12;
  CONST N2_E8_X  = "E";  CONST N2_E8_Y  = 8;
  CONST N2_E12_X = "E";  CONST N2_E12_Y = 12;
  CONST N2_I12_X = "I";  CONST N2_I12_Y = 12;
  CONST N2_J8_X  = "J";  CONST N2_J8_Y  = 8;
  CONST N2_B8_X  = "B";  CONST N2_B8_Y  = 8;
  CONST N2_B17_X = "B";  CONST N2_B17_Y = 17;
  CONST N2_H8_X  = "H";  CONST N2_H8_Y  = 8;
  CONST N2_H12_X = "H";  CONST N2_H12_Y = 12;
  CONST N2_I8_X  = "I";  CONST N2_I8_Y  = 8;
  CONST N2_M8_X  = "M";  CONST N2_M8_Y  = 8;
  CONST N2_M12_X = "M";  CONST N2_M12_Y = 12;
  CONST N2_P12_X = "P";  CONST N2_P12_Y = 12;
  CONST N2_K12_X = "K";  CONST N2_K12_Y = 12;


  CONST N3_H1_X  = "H";  CONST N3_H1_Y  = 1;
  CONST N3_H7_X  = "H";  CONST N3_H7_Y  = 7;
  CONST N3_C2_X  = "C";  CONST N3_C2_Y  = 2;
  CONST N3_P3_X  = "P";  CONST N3_P3_Y  = 3;
  CONST N3_P4_X  = "P";  CONST N3_P4_Y  = 4;
  CONST N3_P7_X  = "P";  CONST N3_P7_Y  = 7;
  CONST N3_R7_X  = "R";  CONST N3_R7_Y  = 7;
  CONST N3_D7_X  = "D";  CONST N3_D7_Y  = 7;
  CONST N3_E7_X  = "E";  CONST N3_E7_Y  = 7;
  CONST N3_K7_X  = "K";  CONST N3_K7_Y  = 7;
  CONST N3_L7_X  = "L";  CONST N3_L7_Y  = 7;
  CONST N3_N7_X  = "N";  CONST N3_N7_Y  = 7;
  CONST N3_M7_X  = "M";  CONST N3_M7_Y  = 7;
  CONST N3_A7_X  = "A";  CONST N3_A7_Y  = 7;
  CONST N3_T7_X  = "T";  CONST N3_T7_Y  = 7;
  CONST N3_F7_X  = "F";  CONST N3_F7_Y  = 7;
  CONST N3_O7_X  = "O";  CONST N3_O7_Y  = 7;
  CONST N3_U7_X  = "U";  CONST N3_U7_Y  = 7;


  CONST N4_C3_X  = "C";  CONST N4_C3_Y  = 3;
  CONST N4_C9_X  = "C";  CONST N4_C9_Y  = 9;
  CONST N4_G2_X  = "G";  CONST N4_G2_Y  = 2;
  CONST N4_G9_X  = "G";  CONST N4_G9_Y  = 9;
  CONST N4_G13_X = "G";  CONST N4_G13_Y = 13;
  CONST N4_L5_X  = "L";  CONST N4_L5_Y  = 5;
  CONST N4_L6_X  = "L";  CONST N4_L6_Y  = 6;
  CONST N4_L9_X  = "L";  CONST N4_L9_Y  = 9;
  CONST N4_L13_X = "L";  CONST N4_L13_Y = 13;
  CONST N4_P9_X  = "P";  CONST N4_P9_Y  = 9;
  CONST N4_S9_X  = "S";  CONST N4_S9_Y  = 9;
  CONST N4_S13_X = "S";  CONST N4_S13_Y = 13;
  CONST N4_R13_X = "R";  CONST N4_R13_Y = 13;
  CONST N4_U9_X  = "U";  CONST N4_U9_Y  = 9;
  CONST N4_U13_X = "U";  CONST N4_U13_Y = 13;
  CONST N4_V9_X  = "V";  CONST N4_V9_Y  = 9;
  CONST N4_E9_X  = "E";  CONST N4_E9_Y  = 9;
  CONST N4_E13_X = "E";  CONST N4_E13_Y = 13;
  CONST N4_T9_X  = "T";  CONST N4_T9_Y  = 9;
  CONST N4_D9_X  = "D";  CONST N4_D9_Y  = 9;
  CONST N4_D18_X = "D";  CONST N4_D18_Y = 18;
  CONST N4_J9_X  = "J";  CONST N4_J9_Y  = 9;
  CONST N4_J13_X = "J";  CONST N4_J13_Y = 13;
  CONST N4_B9_X  = "B";  CONST N4_B9_Y  = 9;
  CONST N4_B13_X = "B";  CONST N4_B13_Y = 13;
  CONST N4_B23_X = "B";  CONST N4_B23_Y = 23;
  CONST N4_F13_X = "F";  CONST N4_F13_Y = 13;
  CONST N4_H9_X  = "H";  CONST N4_H9_Y  = 9;
  CONST N4_H13_X = "H";  CONST N4_H13_Y = 13;
  CONST N4_W9_X  = "W";  CONST N4_W9_Y  = 9;
  CONST N4_W13_X = "W";  CONST N4_W13_Y = 13;
  CONST N4_Q13_X = "Q";  CONST N4_Q13_Y = 13;
  CONST N4_I9_X  = "I";  CONST N4_I9_Y  = 9;
  CONST N4_I13_X = "I";  CONST N4_I13_Y = 13;
  CONST N4_M9_X  = "M";  CONST N4_M9_Y  = 9;
  CONST N4_O9_X  = "O";  CONST N4_O9_Y  = 9;
  CONST N4_O13_X = "O";  CONST N4_O13_Y = 13;
  CONST N4_N9_X  = "N";  CONST N4_N9_Y  = 9;
  CONST N4_N13_X = "N";  CONST N4_N13_Y = 13;
  CONST N4_K9_X  = "K";  CONST N4_K9_Y  = 9;
  CONST N4_K13_X = "K";  CONST N4_K13_Y = 13;
  CONST N4_X9_X  = "X";  CONST N4_X9_Y  = 9;
  CONST N4_X13_X = "X";  CONST N4_X13_Y = 13;
  CONST N4_Y9_X  = "Y";  CONST N4_Y9_Y  = 9;
  CONST N4_Y13_X = "Y";  CONST N4_Y13_Y = 13;
  CONST N4_Z9_X  = "Z";  CONST N4_Z9_Y  = 9;
  CONST N4_Z13_X = "Z";  CONST N4_Z13_Y = 13;
  CONST N4_AB13_X = "AB"; CONST N4_AB13_Y = 13;
  CONST N4_AC13_X = "AC"; CONST N4_AC13_Y = 13;
  CONST N4_AD13_X = "AD"; CONST N4_AD13_Y = 13;
  CONST N4_AN13_X = "AN"; CONST N4_AN13_Y = 13;
  CONST N4_AA9_X  = "AA"; CONST N4_AA9_Y  = 9;
  CONST N4_AA13_X = "AA"; CONST N4_AA13_Y = 13;
  CONST N4_AO13_X = "AO"; CONST N4_AO13_Y = 13;
  CONST N4_AP13_X = "AP"; CONST N4_AP13_Y = 13;
  CONST N4_AQ13_X = "AQ"; CONST N4_AQ13_Y = 13;
  CONST N4_AG13_X = "AG"; CONST N4_AG13_Y = 13;
  CONST N4_AF13_X = "AF"; CONST N4_AF13_Y = 13;
  CONST N4_AH13_X = "AH"; CONST N4_AH13_Y = 13;
  CONST N4_AI13_X = "AI"; CONST N4_AI13_Y = 13;
  CONST N4_AJ13_X = "AJ"; CONST N4_AJ13_Y = 13;
  CONST N4_AM13_X = "AM"; CONST N4_AM13_Y = 13;
  CONST N4_AK13_X = "AK"; CONST N4_AK13_Y = 13;


  CONST N5_H1_X  = "H";  CONST N5_H1_Y  = 1;
  CONST N5_H7_X  = "I";  CONST N5_H7_Y  = 7;
  CONST N5_C2_X  = "C";  CONST N5_C2_Y  = 2;
  CONST N5_S7_X  = "U";  CONST N5_S7_Y  = 7;
  CONST N5_V7_X  = "X";  CONST N5_V7_Y  = 7;
  CONST N5_E7_X  = "F";  CONST N5_E7_Y  = 7;
  CONST N5_D7_X_1 = "D";  CONST N5_D7_Y_1  = 7;
  CONST N5_D7_X  = "E";  CONST N5_D7_Y  = 7;
  CONST N5_F7_X  = "G";  CONST N5_F7_Y  = 7;
  CONST N5_O7_X  = "Q";  CONST N5_O7_Y  = 7;
  CONST N5_M7_X  = "O";  CONST N5_M7_Y  = 7;
  CONST N5_N7_X  = "P";  CONST N5_N7_Y  = 7;
  CONST N5_T7_X  = "V";  CONST N5_T7_Y  = 7;
  CONST N5_A7_X  = "A";  CONST N5_A7_Y  = 7;
  CONST N5_J7_X  = "K";  CONST N5_J7_Y  = 7;
  CONST N5_U7_X  = "W";  CONST N5_U7_Y  = 7;
  CONST N5_X7_X  = "Z";  CONST N5_X7_Y  = 7;
  CONST N5_R7_X  = "T";  CONST N5_R7_Y  = 7;
  CONST N5_Z7_X  = "AB"; CONST N5_Z7_Y  = 7;
  CONST N5_G7_X  = "H";  CONST N5_G7_Y  = 7;
  CONST N5_P7_X  = "R";  CONST N5_P7_Y  = 7;
  CONST N5_W7_X  = "Y";  CONST N5_W7_Y  = 7;
  CONST N5_Q3_X  = "Q";  CONST N5_Q3_Y  = 3;
  CONST N5_Q4_X  = "Q";  CONST N5_Q4_Y  = 4;
  CONST N5_Q7_X  = "S";  CONST N5_Q7_Y  = 7;
  CONST N5_AA7_X = "AC"; CONST N5_AA7_Y = 7;
  CONST N5_AB7_X = "AD"; CONST N5_AB7_Y = 7;


  CONST N6_F2_X  = "F";  CONST N6_F2_Y  = 2;
  CONST N6_F6_X  = "F";  CONST N6_F6_Y  = 6;
  CONST N6_F13_X = "F";  CONST N6_F13_Y = 13;
  CONST N6_C3_X  = "C";  CONST N6_C3_Y  = 3;
  CONST N6_C6_X  = "C";  CONST N6_C6_Y  = 6;
  CONST N6_E6_X  = "E";  CONST N6_E6_Y  = 6;
  CONST N6_E13_X = "E";  CONST N6_E13_Y = 13;
  CONST N6_E18_X = "E";  CONST N6_E18_Y = 18;
  CONST N6_B6_X  = "B";  CONST N6_B6_Y  = 6;
  CONST N6_D6_X  = "D";  CONST N6_D6_Y  = 6;
  CONST N6_I13_X = "I";  CONST N6_I13_Y = 13;
  CONST N6_J13_X = "J";  CONST N6_J13_Y = 13;
  CONST N6_K13_X = "K";  CONST N6_K13_Y = 13;
  CONST N6_L13_X = "L";  CONST N6_L13_Y = 13;
  CONST N6_V13_X = "V";  CONST N6_V13_Y = 13;
  CONST N6_T13_X = "T";  CONST N6_T13_Y = 13;
  CONST N6_Z13_X = "Z";  CONST N6_Z13_Y = 13;
  CONST N6_Y9_X  = "Y";  CONST N6_Y9_Y  = 9;
  CONST N6_Y10_X = "Y";  CONST N6_Y10_Y = 10;
  CONST N6_Y13_X = "Y";  CONST N6_Y13_Y = 13;
  CONST N6_X13_X = "X";  CONST N6_X13_Y = 13;
  CONST N6_Q13_X = "Q";  CONST N6_Q13_Y = 13;
  CONST N6_R13_X = "R";  CONST N6_R13_Y = 13;
  CONST N6_S13_X = "S";  CONST N6_S13_Y = 13;
  CONST N6_W13_X = "W";  CONST N6_W13_Y = 13;
  CONST N6_H13_X = "H";  CONST N6_H13_Y = 13;
  CONST N6_P13_X = "P";  CONST N6_P13_Y = 13;
  CONST N6_N13_X = "N";  CONST N6_N13_Y = 13;
  CONST N6_O13_X = "O";  CONST N6_O13_Y = 13;
  CONST N6_AA13_X = "AA";  CONST N6_AA13_Y = 13;
  CONST N6_AB13_X = "AB";  CONST N6_AB13_Y = 13;
  CONST N6_AC13_X = "AC";  CONST N6_AC13_Y = 13;


  CONST N7_G2_X  = "G";  CONST N7_G2_Y  = 2;
  CONST N7_C3_X  = "C";  CONST N7_C3_Y  = 3;
  CONST N7_P10_X = "P";  CONST N7_P10_Y = 10;
  CONST N7_P15_X = "P";  CONST N7_P15_Y = 15;
  CONST N7_R10_X = "R";  CONST N7_R10_Y = 10;
  CONST N7_R15_X = "R";  CONST N7_R15_Y = 15;
  CONST N7_U15_X = "U";  CONST N7_U15_Y = 15;
  CONST N7_L4_X  = "L";  CONST N7_L4_Y  = 4;
  CONST N7_L5_X  = "L";  CONST N7_L5_Y  = 5;
  CONST N7_L6_X  = "L";  CONST N7_L6_Y  = 6;
  CONST N7_L10_X = "L";  CONST N7_L10_Y = 10;
  CONST N7_L15_X = "L";  CONST N7_L15_Y = 15;
  CONST N7_E20_X = "E";  CONST N7_E20_Y = 20;
  CONST N7_N10_X = "N";  CONST N7_N10_Y = 10;
  CONST N7_N15_X = "N";  CONST N7_N15_Y = 15;
  CONST N7_J10_X = "J";  CONST N7_J10_Y = 10;
  CONST N7_J15_X = "J";  CONST N7_J15_Y = 15;
  CONST N7_M10_X = "M";  CONST N7_M10_Y = 10;
  CONST N7_M15_X = "M";  CONST N7_M15_Y = 15;
  CONST N7_H10_X = "H";  CONST N7_H10_Y = 10;
  CONST N7_H15_X = "H";  CONST N7_H15_Y = 15;
  CONST N7_O10_X = "O";  CONST N7_O10_Y = 10;
  CONST N7_O15_X = "O";  CONST N7_O15_Y = 15;
  CONST N7_Q15_X = "Q";  CONST N7_Q15_Y = 15;
  CONST N7_T15_X = "T";  CONST N7_T15_Y = 15;


// номера ячеек не совпадают с названиями т.к. менялся шаблон
  CONST N8_C20_X = "C";  CONST N8_C20_Y = 16;
  CONST N8_A5_X  = "A";  CONST N8_A5_Y  = 3;
  CONST N8_A7_X  = "A";  CONST N8_A7_Y  = 5;
  CONST N8_A9_X  = "A";  CONST N8_A9_Y  = 7;
  CONST N8_A11_X = "A";  CONST N8_A11_Y = 9;
  CONST N8_A13_X = "A";  CONST N8_A13_Y = 11;
  CONST N8_A17_X = "A";  CONST N8_A17_Y = 13;


  PRIVATE MACRO N1_()
     return "'ИТОГ'!";
  END;

  PRIVATE MACRO N2_()
     return "'Акции'!";
  END;

  PRIVATE MACRO N3_()
     return "'Акции Закрытые'!";
  END;

  PRIVATE MACRO N4_()
     return "'Облигации'!";
  END;

  PRIVATE MACRO N5_()
     return "'Облигации Закрытые'!";
  END;

  PRIVATE MACRO N6_()
     return "'Векселя'!";
  END;

  PRIVATE MACRO N7_()
     return "'Векселя Закрытые'!";
  END;

  PRIVATE MACRO N8_()
     return "'Пром_рез'!";
  END;

  PRIVATE MACRO N1_F1( dY:integer )
     return (N1_F1_X + string(N1_F1_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_B66( dY:integer )
     return (N1_B66_X + string(N1_B66_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_B70( dY:integer )
     return (N1_B70_X + string(N1_B70_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C1( dY:integer )
     return (N1_C1_X + string(N1_C1_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C3( dY:integer )
     return (N1_C3_X + string(N1_C3_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C34( dY:integer )
     return (N1_C34_X + string(N1_C34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C35( dY:integer )
     return (N1_C35_X + string(N1_C35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C36( dY:integer )
     return (N1_C36_X + string(N1_C36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C38( dY:integer )
     return (N1_C38_X + string(N1_C38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C39( dY:integer )
     return (N1_C39_X + string(N1_C39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C40( dY:integer )
     return (N1_C40_X + string(N1_C40_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C66( dY:integer )
     return (N1_C66_X + string(N1_C66_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C75( dY:integer )
     return (N1_C75_X + string(N1_C75_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_C80( dY:integer )
     return (N1_C80_X + string(N1_C80_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F5( dY:integer )
     return (N1_F5_X + string(N1_F5_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F6( dY:integer )
     return (N1_F6_X + string(N1_F6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F12( dY:integer )
     return (N1_F12_X + string(N1_F12_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F24( dY:integer )
     return (N1_F24_X + string(N1_F24_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F34( dY:integer )
     return (N1_F34_X + string(N1_F34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F35( dY:integer )
     return (N1_F35_X + string(N1_F35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F36( dY:integer )
     return (N1_F36_X + string(N1_F36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F38( dY:integer )
     return (N1_F38_X + string(N1_F38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F39( dY:integer )
     return (N1_F39_X + string(N1_F39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F40( dY:integer )
     return (N1_F40_X + string(N1_F40_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F55( dY:integer )
     return (N1_F55_X + string(N1_F55_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F62( dY:integer )
     return (N1_F62_X + string(N1_F62_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F75( dY:integer )
     return (N1_F75_X + string(N1_F75_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_F80( dY:integer )
     return (N1_F80_X + string(N1_F80_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H5( dY:integer )
     return (N1_H5_X + string(N1_H5_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H6( dY:integer )
     return (N1_H6_X + string(N1_H6_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H8( dY:integer )
     return (N1_H8_X + string(N1_H8_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H34( dY:integer )
     return (N1_H34_X + string(N1_H34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H35( dY:integer )
     return (N1_H35_X + string(N1_H35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H36( dY:integer )
     return (N1_H36_X + string(N1_H36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H37( dY:integer )
     return (N1_H37_X + string(N1_H37_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H38( dY:integer )
     return (N1_H38_X + string(N1_H38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H39( dY:integer )
     return (N1_H39_X + string(N1_H39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H40( dY:integer )
     return (N1_H40_X + string(N1_H40_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H42( dY:integer )
     return (N1_H42_X + string(N1_H42_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H44( dY:integer )
     return (N1_H44_X + string(N1_H44_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H45( dY:integer )
     return (N1_H45_X + string(N1_H45_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H46( dY:integer )
     return (N1_H46_X + string(N1_H46_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H47( dY:integer )
     return (N1_H47_X + string(N1_H47_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H52( dY:integer )
     return (N1_H52_X + string(N1_H52_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H54( dY:integer )
     return (N1_H54_X + string(N1_H54_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H55( dY:integer )
     return (N1_H55_X + string(N1_H55_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_H80( dY:integer )
     return (N1_H80_X + string(N1_H80_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J5( dY:integer )
     return (N1_J5_X + string(N1_J5_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J58( dY:integer )
     return (N1_J58_X + string(N1_J58_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J59( dY:integer )
     return (N1_J59_X + string(N1_J59_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J75( dY:integer )
     return (N1_J75_X + string(N1_J75_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_I5( dY:integer )
     return (N1_I5_X + string(N1_I5_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_K13( dY:integer )
     return (N1_K13_X + string(N1_K13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_L13( dY:integer )
     return (N1_L13_X + string(N1_L13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J7( dY:integer )
     return (N1_J7_X + string(N1_J7_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J34( dY:integer )
     return (N1_J34_X + string(N1_J34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J35( dY:integer )
     return (N1_J35_X + string(N1_J35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J36( dY:integer )
     return (N1_J36_X + string(N1_J36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J38( dY:integer )
     return (N1_J38_X + string(N1_J38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_J39( dY:integer )
     return (N1_J39_X + string(N1_J39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G12( dY:integer )
     return (N1_G12_X + string(N1_G12_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G13( dY:integer )
     return (N1_G13_X + string(N1_G13_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G18( dY:integer )
     return (N1_G18_X + string(N1_G18_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G20( dY:integer )
     return (N1_G20_X + string(N1_G20_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G22( dY:integer )
     return (N1_G22_X + string(N1_G22_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G23( dY:integer )
     return (N1_G23_X + string(N1_G23_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G24( dY:integer )
     return (N1_G24_X + string(N1_G24_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G25( dY:integer )
     return (N1_G25_X + string(N1_G25_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G26( dY:integer )
     return (N1_G26_X + string(N1_G26_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G27( dY:integer )
     return (N1_G27_X + string(N1_G27_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G28( dY:integer )
     return (N1_G28_X + string(N1_G28_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G30( dY:integer )
     return (N1_G30_X + string(N1_G30_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G34( dY:integer )
     return (N1_G34_X + string(N1_G34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G35( dY:integer )
     return (N1_G35_X + string(N1_G35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G36( dY:integer )
     return (N1_G36_X + string(N1_G36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G38( dY:integer )
     return (N1_G38_X + string(N1_G38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G39( dY:integer )
     return (N1_G39_X + string(N1_G39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G40( dY:integer )
     return (N1_G40_X + string(N1_G40_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G55( dY:integer )
     return (N1_G55_X + string(N1_G55_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_G80( dY:integer )
     return (N1_G80_X + string(N1_G80_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D34( dY:integer )
     return (N1_D34_X + string(N1_D34_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D35( dY:integer )
     return (N1_D35_X + string(N1_D35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D36( dY:integer )
     return (N1_D36_X + string(N1_D36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D37( dY:integer )
     return (N1_D37_X + string(N1_D37_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D38( dY:integer )
     return (N1_D38_X + string(N1_D38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D39( dY:integer )
     return (N1_D39_X + string(N1_D39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D40( dY:integer )
     return (N1_D40_X + string(N1_D40_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D48( dY:integer )
     return (N1_D48_X + string(N1_D48_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D49( dY:integer )
     return (N1_D49_X + string(N1_D49_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D50( dY:integer )
     return (N1_D50_X + string(N1_D50_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D51( dY:integer )
     return (N1_D51_X + string(N1_D51_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D52( dY:integer )
     return (N1_D52_X + string(N1_D52_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D53( dY:integer )
     return (N1_D53_X + string(N1_D53_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D54( dY:integer )
     return (N1_D54_X + string(N1_D54_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D66( dY:integer )
     return (N1_D66_X + string(N1_D66_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_D70( dY:integer )
     return (N1_D70_X + string(N1_D70_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E35( dY:integer )
     return (N1_E35_X + string(N1_E35_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E36( dY:integer )
     return (N1_E36_X + string(N1_E36_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E38( dY:integer )
     return (N1_E38_X + string(N1_E38_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E39( dY:integer )
     return (N1_E39_X + string(N1_E39_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E40( dY:integer )
     return (N1_E40_X + string(N1_E40_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E59( dY:integer )
     return (N1_E59_X + string(N1_E59_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E60( dY:integer )
     return (N1_E60_X + string(N1_E60_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E61( dY:integer )
     return (N1_E61_X + string(N1_E61_Y + m_DeltaOrderN1 + dY));
  END;

  PRIVATE MACRO N1_E62( dY:integer )
     return (N1_E62_X + string(N1_E62_Y + m_DeltaOrderN1 + dY));
  END;


  PRIVATE MACRO N2_A12( dY:integer )
     return (N2_A12_X + string(N2_A12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_G1( dY:integer )
     return (N2_G1_X + string(N2_G1_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_G8( dY:integer )
     return (N2_G8_X + string(N2_G8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_G12( dY:integer )
     return (N2_G12_X + string(N2_G12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_O8( dY:integer )
     return (N2_O8_X + string(N2_O8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_O12( dY:integer )
     return (N2_O12_X + string(N2_O12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_C2( dY:integer )
     return (N2_C2_X + string(N2_C2_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_C8( dY:integer )
     return (N2_C8_X + string(N2_C8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_L4( dY:integer )
     return (N2_L4_X + string(N2_L4_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_L5( dY:integer )
     return (N2_L5_X + string(N2_L5_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_L12( dY:integer )
     return (N2_L12_X + string(N2_L12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_N8( dY:integer )
     return (N2_N8_X + string(N2_N8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_D8( dY:integer )
     return (N2_D8_X + string(N2_D8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_D12( dY:integer )
     return (N2_D12_X + string(N2_D12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_F8( dY:integer )
     return (N2_F8_X + string(N2_F8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_F12( dY:integer )
     return (N2_F12_X + string(N2_F12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_E8( dY:integer )
     return (N2_E8_X + string(N2_E8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_E12( dY:integer )
     return (N2_E12_X + string(N2_E12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_I12( dY:integer )
     return (N2_I12_X + string(N2_I12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_J8( dY:integer )
     return (N2_J8_X + string(N2_J8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_B8( dY:integer )
     return (N2_B8_X + string(N2_B8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_B17( dY:integer )
     return (N2_B17_X + string(N2_B17_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_H8( dY:integer )
     return (N2_H8_X + string(N2_H8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_H12( dY:integer )
     return (N2_H12_X + string(N2_H12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_I8( dY:integer )
     return (N2_I8_X + string(N2_I8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_M8( dY:integer )
     return (N2_M8_X + string(N2_M8_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_M12( dY:integer )
     return (N2_M12_X + string(N2_M12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_P12( dY:integer )
     return (N2_P12_X + string(N2_P12_Y + m_DeltaOrderN2 + dY));
  END;

  PRIVATE MACRO N2_K12( dY:integer )
     return (N2_K12_X + string(N2_K12_Y + m_DeltaOrderN2 + dY));
  END;



  PRIVATE MACRO N3_H1( dY:integer )
     return (N3_H1_X + string(N3_H1_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_H7( dY:integer )
     return (N3_H7_X + string(N3_H7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_C2( dY:integer )
     return (N3_C2_X + string(N3_C2_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_P3( dY:integer )
     return (N3_P3_X + string(N3_P3_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_P4( dY:integer )
     return (N3_P4_X + string(N3_P4_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_P7( dY:integer )
     return (N3_P7_X + string(N3_P7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_R7( dY:integer )
     return (N3_R7_X + string(N3_R7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_D7( dY:integer )
     return (N3_D7_X + string(N3_D7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_E7( dY:integer )
     return (N3_E7_X + string(N3_E7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_K7( dY:integer )
     return (N3_K7_X + string(N3_K7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_L7( dY:integer )
     return (N3_L7_X + string(N3_L7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_N7( dY:integer )
     return (N3_N7_X + string(N3_N7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_M7( dY:integer )
     return (N3_M7_X + string(N3_M7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_A7( dY:integer )
     return (N3_A7_X + string(N3_A7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_T7( dY:integer )
     return (N3_T7_X + string(N3_T7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_F7( dY:integer )
     return (N3_F7_X + string(N3_F7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_O7( dY:integer )
     return (N3_O7_X + string(N3_O7_Y + m_DeltaOrderN3 + dY));
  END;

  PRIVATE MACRO N3_U7( dY:integer )
     return (N3_U7_X + string(N3_U7_Y + m_DeltaOrderN3 + dY));
  END;


  PRIVATE MACRO N4_C3( dY:integer )
     return (N4_C3_X + string(N4_C3_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_C9( dY:integer )
     return (N4_C9_X + string(N4_C9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_G2( dY:integer )
     return (N4_G2_X + string(N4_G2_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_G9( dY:integer )
     return (N4_G9_X + string(N4_G9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_G13( dY:integer )
     return (N4_G13_X + string(N4_G13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L5( dY:integer )
     return (N4_L5_X + string(N4_L5_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L6( dY:integer )
     return (N4_L6_X + string(N4_L6_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L9( dY:integer )
     return (N4_L9_X + string(N4_L9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_L13( dY:integer )
     return (N4_L13_X + string(N4_L13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_P9( dY:integer )
     return (N4_P9_X + string(N4_P9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_S9( dY:integer )
     return (N4_S9_X + string(N4_S9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_S13( dY:integer )
     return (N4_S13_X + string(N4_S13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_R13( dY:integer )
     return (N4_R13_X + string(N4_R13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_U9( dY:integer )
     return (N4_U9_X + string(N4_U9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_U13( dY:integer )
     return (N4_U13_X + string(N4_U13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_V9( dY:integer )
     return (N4_V9_X + string(N4_V9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_E9( dY:integer )
     return (N4_E9_X + string(N4_E9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_E13( dY:integer )
     return (N4_E13_X + string(N4_E13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_T9( dY:integer )
     return (N4_T9_X + string(N4_T9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_D9( dY:integer )
     return (N4_D9_X + string(N4_D9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_D18( dY:integer )
     return (N4_D18_X + string(N4_D18_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_J9( dY:integer )
     return (N4_J9_X + string(N4_J9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_J13( dY:integer )
     return (N4_J13_X + string(N4_J13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_B9( dY:integer )
     return (N4_B9_X + string(N4_B9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_B13( dY:integer )
     return (N4_B13_X + string(N4_B13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_B23( dY:integer )
     return (N4_B23_X + string(N4_B23_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_F13( dY:integer )
     return (N4_F13_X + string(N4_F13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_H9( dY:integer )
     return (N4_H9_X + string(N4_H9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_H13( dY:integer )
     return (N4_H13_X + string(N4_H13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_W9( dY:integer )
     return (N4_W9_X + string(N4_W9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_W13( dY:integer )
     return (N4_W13_X + string(N4_W13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Q13( dY:integer )
     return (N4_Q13_X + string(N4_Q13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_I9( dY:integer )
     return (N4_I9_X + string(N4_I9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_I13( dY:integer )
     return (N4_I13_X + string(N4_I13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_M9( dY:integer )
     return (N4_M9_X + string(N4_M9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_O9( dY:integer )
     return (N4_O9_X + string(N4_O9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_O13( dY:integer )
     return (N4_O13_X + string(N4_O13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_N9( dY:integer )
     return (N4_N9_X + string(N4_N9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_N13( dY:integer )
     return (N4_N13_X + string(N4_N13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_K9( dY:integer )
     return (N4_K9_X + string(N4_K9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_K13( dY:integer )
     return (N4_K13_X + string(N4_K13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_X9( dY:integer )
     return (N4_X9_X + string(N4_X9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_X13( dY:integer )
     return (N4_X13_X + string(N4_X13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Y9( dY:integer )
     return (N4_Y9_X + string(N4_Y9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Y13( dY:integer )
     return (N4_Y13_X + string(N4_Y13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Z9( dY:integer )
     return (N4_Z9_X + string(N4_Z9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_Z13( dY:integer )
     return (N4_Z13_X + string(N4_Z13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AB13( dY:integer )
     return (N4_AB13_X + string(N4_AB13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AC13( dY:integer )
     return (N4_AC13_X + string(N4_AC13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AD13( dY:integer )
     return (N4_AD13_X + string(N4_AD13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AN13( dY:integer )
     return (N4_AN13_X + string(N4_AN13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AA9( dY:integer )
     return (N4_AA9_X + string(N4_AA9_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AA13( dY:integer )
     return (N4_AA13_X + string(N4_AA13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AO13( dY:integer )
     return (N4_AO13_X + string(N4_AO13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AP13( dY:integer )
     return (N4_AP13_X + string(N4_AP13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AQ13( dY:integer )
     return (N4_AQ13_X + string(N4_AQ13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AG13( dY:integer )
     return (N4_AG13_X + string(N4_AG13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AF13( dY:integer )
     return (N4_AF13_X + string(N4_AF13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AH13( dY:integer )
     return (N4_AH13_X + string(N4_AH13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AI13( dY:integer )
     return (N4_AI13_X + string(N4_AI13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AJ13( dY:integer )
     return (N4_AJ13_X + string(N4_AJ13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AM13( dY:integer )
     return (N4_AM13_X + string(N4_AM13_Y + m_DeltaOrderN4 + dY));
  END;

  PRIVATE MACRO N4_AK13( dY:integer )
     return (N4_AK13_X + string(N4_AK13_Y + m_DeltaOrderN4 + dY));
  END;


  PRIVATE MACRO N5_H1( dY:integer )
     return (N5_H1_X + string(N5_H1_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_H7( dY:integer )
     return (N5_H7_X + string(N5_H7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_C2( dY:integer )
     return (N5_C2_X + string(N5_C2_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_S7( dY:integer )
     return (N5_S7_X + string(N5_S7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_V7( dY:integer )
     return (N5_V7_X + string(N5_V7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_E7( dY:integer )
     return (N5_E7_X + string(N5_E7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_D7_1( dY:integer )
     return (N5_D7_X_1 + string(N5_D7_Y_1 + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_D7( dY:integer )
     return (N5_D7_X + string(N5_D7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_F7( dY:integer )
     return (N5_F7_X + string(N5_F7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_O7( dY:integer )
     return (N5_O7_X + string(N5_O7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_M7( dY:integer )
     return (N5_M7_X + string(N5_M7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_N7( dY:integer )
     return (N5_N7_X + string(N5_N7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_T7( dY:integer )
     return (N5_T7_X + string(N5_T7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_A7( dY:integer )
     return (N5_A7_X + string(N5_A7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_J7( dY:integer )
     return (N5_J7_X + string(N5_J7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_U7( dY:integer )
     return (N5_U7_X + string(N5_U7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_X7( dY:integer )
     return (N5_X7_X + string(N5_X7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_R7( dY:integer )
     return (N5_R7_X + string(N5_R7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Z7( dY:integer )
     return (N5_Z7_X + string(N5_Z7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_G7( dY:integer )
     return (N5_G7_X + string(N5_G7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_P7( dY:integer )
     return (N5_P7_X + string(N5_P7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_W7( dY:integer )
     return (N5_W7_X + string(N5_W7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Q3( dY:integer )
     return (N5_Q3_X + string(N5_Q3_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Q4( dY:integer )
     return (N5_Q4_X + string(N5_Q4_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_Q7( dY:integer )
     return (N5_Q7_X + string(N5_Q7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_AA7( dY:integer )
     return (N5_AA7_X + string(N5_AA7_Y + m_DeltaOrderN5 + dY));
  END;

  PRIVATE MACRO N5_AB7( dY:integer )
     return (N5_AB7_X + string(N5_AB7_Y + m_DeltaOrderN5 + dY));
  END;


  PRIVATE MACRO N6_F2( dY:integer )
     return (N6_F2_X + string(N6_F2_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_F6( dY:integer )
     return (N6_F6_X + string(N6_F6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_F13( dY:integer )
     return (N6_F13_X + string(N6_F13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_C3( dY:integer )
     return (N6_C3_X + string(N6_C3_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_C6( dY:integer )
     return (N6_C6_X + string(N6_C6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_E6( dY:integer )
     return (N6_E6_X + string(N6_E6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_E13( dY:integer )
     return (N6_E13_X + string(N6_E13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_E18( dY:integer )
     return (N6_E18_X + string(N6_E18_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_B6( dY:integer )
     return (N6_B6_X + string(N6_B6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_D6( dY:integer )
     return (N6_D6_X + string(N6_D6_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_I13( dY:integer )
     return (N6_I13_X + string(N6_I13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_J13( dY:integer )
     return (N6_J13_X + string(N6_J13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_K13( dY:integer )
     return (N6_K13_X + string(N6_K13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_L13( dY:integer )
     return (N6_L13_X + string(N6_L13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_V13( dY:integer )
     return (N6_V13_X + string(N6_V13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_T13( dY:integer )
     return (N6_T13_X + string(N6_T13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Z13( dY:integer )
     return (N6_Z13_X + string(N6_Z13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y9( dY:integer )
     return (N6_Y9_X + string(N6_Y9_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y10( dY:integer )
     return (N6_Y10_X + string(N6_Y10_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Y13( dY:integer )
     return (N6_Y13_X + string(N6_Y13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_X13( dY:integer )
     return (N6_X13_X + string(N6_X13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_Q13( dY:integer )
     return (N6_Q13_X + string(N6_Q13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_R13( dY:integer )
     return (N6_R13_X + string(N6_R13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_S13( dY:integer )
     return (N6_S13_X + string(N6_S13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_W13( dY:integer )
     return (N6_W13_X + string(N6_W13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_H13( dY:integer )
     return (N6_H13_X + string(N6_H13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_P13( dY:integer )
     return (N6_P13_X + string(N6_P13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_N13( dY:integer )
     return (N6_N13_X + string(N6_N13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_O13( dY:integer )
     return (N6_O13_X + string(N6_O13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_AA13( dY:integer )
     return (N6_AA13_X + string(N6_AA13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_AB13( dY:integer )
     return (N6_AB13_X + string(N6_AB13_Y + m_DeltaOrderN6 + dY));
  END;

  PRIVATE MACRO N6_AC13( dY:integer )
     return (N6_AC13_X + string(N6_AC13_Y + m_DeltaOrderN6 + dY));
  END;


  PRIVATE MACRO N7_G2( dY:integer )
     return (N7_G2_X + string(N7_G2_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_C3( dY:integer )
     return (N7_C3_X + string(N7_C3_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_P10( dY:integer )
     return (N7_P10_X + string(N7_P10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_P15( dY:integer )
     return (N7_P15_X + string(N7_P15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_R10( dY:integer )
     return (N7_R10_X + string(N7_R10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_R15( dY:integer )
     return (N7_R15_X + string(N7_R15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_U15( dY:integer )
     return (N7_U15_X + string(N7_U15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L4( dY:integer )
     return (N7_L4_X + string(N7_L4_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L5( dY:integer )
     return (N7_L5_X + string(N7_L5_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L6( dY:integer )
     return (N7_L6_X + string(N7_L6_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L10( dY:integer )
     return (N7_L10_X + string(N7_L10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_L15( dY:integer )
     return (N7_L15_X + string(N7_L15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_E20( dY:integer )
     return (N7_E20_X + string(N7_E20_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_N10( dY:integer )
     return (N7_N10_X + string(N7_N10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_N15( dY:integer )
     return (N7_N15_X + string(N7_N15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_J10( dY:integer )
     return (N7_J10_X + string(N7_J10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_J15( dY:integer )
     return (N7_J15_X + string(N7_J15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_M10( dY:integer )
     return (N7_M10_X + string(N7_M10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_M15( dY:integer )
     return (N7_M15_X + string(N7_M15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_H10( dY:integer )
     return (N7_H10_X + string(N7_H10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_H15( dY:integer )
     return (N7_H15_X + string(N7_H15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_O10( dY:integer )
     return (N7_O10_X + string(N7_O10_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_O15( dY:integer )
     return (N7_O15_X + string(N7_O15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_Q15( dY:integer )
     return (N7_Q15_X + string(N7_Q15_Y + m_DeltaOrderN7 + dY));
  END;

  PRIVATE MACRO N7_T15( dY:integer )
     return (N7_T15_X + string(N7_T15_Y + m_DeltaOrderN7 + dY));
  END;


  PRIVATE MACRO N8_C20( dY:integer )
     return (N8_C20_X + string(N8_C20_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A5( dY:integer )
     return (N8_A5_X + string(N8_A5_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A7( dY:integer )
     return (N8_A7_X + string(N8_A7_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A9( dY:integer )
     return (N8_A9_X + string(N8_A9_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A11( dY:integer )
     return (N8_A11_X + string(N8_A11_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A13( dY:integer )
     return (N8_A13_X + string(N8_A13_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO N8_A17( dY:integer )
     return (N8_A17_X + string(N8_A17_Y + m_DeltaOrderN8 + dY));
  END;

  PRIVATE MACRO F( Str:string, Transform:bool ):string

     /* заменим разделитель целой и дробной частей */
     ReplaceSeparator( @Str, "." );
     ReplaceSeparator( @Str, "," );

     /* В 2003 Excel функция СУММ может принимать только 30 аргументов. Этого не хватает для отчёта, 
        поэтому, если передали такую формулу, то заменим на обычное суммирование. */
     var index_;
     if( ((Transform == null) or (Transform == true)) and (FormulaSUM() == substr(Str, 1, strlen(FormulaSUM()))) )
        if( Index(Str,":") == 0 ) /* только для перечислений, если передали формулу через диапазон, то должно работать */
           var TempStr = "";
           index_  = Index(Str,";");
           if(index_ > 0)
              TempStr = substr(Str, 1, index_-1) + ":";
              Str     = InvertStr(Str);
              index_  = Index(Str,";");
              Str     = TempStr + InvertStr(substr(Str, 1, index_-1))
           end;
        end;
     end;
/*
     if( FormulaSUM() == substr(Str, 1, strlen(FormulaSUM())) )
        if( Index(Str,":") == 0 ) /* только для перечислений, если передали формулу через диапазон, то должно работать */
           var i:integer = 1;
           var j:integer = 1;
           while( j <= strlen(Str)-1 )
              if(substr(Str, j, 1) == ";")
                 i = i + 1;
              end;
              j = j + 1;
           end;
           if( i > 30 )
              var RetStr = "";
              Str = substr(Str, strlen(FormulaSUM())+2, strlen(Str)-strlen(FormulaSUM())-2);
              index_ = Index(Str,";");
              while( (index_ != 0) and (index_ <= strlen(Str)) )
                 RetStr = RetStr + TS_IIF(RetStr == "", "", "+") + FormulaIF() + "(" + substr(Str, 1, index_-1) + ";" + substr(Str, 1, index_-1) + ";0)";
                 Str = substr(Str, index_ + 1, strlen(Str) - 1);
                 index_ = Index(Str,";");
              end;
              Str = RetStr + TS_IIF(RetStr == "", "", "+") + FormulaIF() + "(" + Str + ";" + Str + ";0)";
           end;
        end;
     end;
*/
     return FORMULA + Str;
  END;

  PRIVATE MACRO СуммаПродажи( RSD, AmountLine:integer ):string

     var RetVal:string = "";

     if( ((RSD.Buy_Sale == PM_WRITEOFF_SUM_SALE) AND (RSD.KindSale == 330)) OR (RSD.KindSale == PM_WRTSUM_KIND_S) OR (RSD.KindSale == PM_WRTSUM_KIND_FS) )

        RetVal = F( N5_E7(AmountLine) + "*" + N5_D7(AmountLine) + "*" + N5_F7(AmountLine) + "/100" );
/*
     elif( RSD.KindSale == PM_WRTSUM_KIND_DI )

        RetVal = F( N5_E7(AmountLine) + "*" + N5_D7(AmountLine) );
*/
     elif( (RSD.KindSale == PM_WRTSUM_KIND_DI) or (RSD.KindSale == PM_WRTSUM_KIND_DP) )

        RetVal = F( N5_E7(AmountLine) + "*" + N5_D7_1(AmountLine) + "*" + N5_F7(AmountLine) );

     elif( RSD.KindSale == PM_WRTSUM_KIND_DC )
  
        RetVal = "";
  
     end;

     return RetVal;
  END;

  PRIVATE MACRO ПолученныйНКД( RSD, AmountLine:integer ):string

     var RetVal:string = "";
     var Query, SqlData, DataSet;

     if( (RSD.Buy_Sale == PM_WRITEOFF_SUM_SALE) AND (RSD.KindSale == 330) )

        Query = " select t_NKD            " +
                "   from dtsreqassets_dbt " +
                "  where t_FIID = ?       " +
                "    and t_RequestID = ?  ";

        SqlData = RSDCommand( Query );
        SqlData.addParam("", RSDBP_IN, RSD.FIID       );
        SqlData.addParam("", RSDBP_IN, RSD.DocumentID );
        SqlData.execute();

        DataSet = TRsbDataSet(SqlData);

        if( DataSet.MoveNext() )
           RetVal = string(SQL_ConvTypeSum(DataSet.NKD));
        end;

     elif( (RSD.KindSale == PM_WRTSUM_KIND_S) OR (RSD.KindSale == PM_WRTSUM_KIND_FS) )

        RetVal = string(RSD.NKDSaleAmount);

     elif( (RSD.KindSale == PM_WRTSUM_KIND_DI) OR (RSD.KindSale == PM_WRTSUM_KIND_DP) )

        RetVal = "";

     elif( RSD.KindSale == PM_WRTSUM_KIND_DC )
  
        RetVal = F( N5_E7(AmountLine) + "*" + N5_F7(AmountLine) );

     end;

     return RetVal;
  END;

  PRIVATE MACRO ВесьНачисленныйПД( RSD, InPeriod:bool ):money

     var RetVal:money = $0.0;
     var ПД0:money = $0.0, ПД1:money = $0.0;
     var w0, w1;

     RetVal = RSD.InterestIncomeBuy + RSD.InterestIncomeAdd; /* ПД2 + ПДдонач */

     if( БылоПогашениеКупона(RSD.FIID, m_BegDate, m_FormData.ReportDate) == false )
        if( InPeriod )
           if( GetLotFirstInstance(RSD.BuySumID, @w0) )
              ПД0 = RestSum(w0.InterestIncome, RSD.Amount, w0.Amount);
              RetVal = RetVal - ПД0;
           end;
        else
           if( GetLotBefDate(m_BegDate, RSD.BuySumID, @w1) )
              ПД1 = -RestSum(w1.InterestIncome, RSD.Amount, w1.Amount);
              RetVal = RetVal - ПД1;
           end;
        end;
     end;

     return RetVal;
  END;

  PRIVATE MACRO ПрибыльЗаПериод()

     var RetVal:money = $0.0, Н_Дх:money = $0.0, Н_Налог:money = $0.0;

     if( ПолучитьИтогДУ( m_OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, m_FormData.ReportDate, @Н_Дх, NULL, NULL ) )
        Н_Дх = $0.0;
     end;
     if( ПолучитьИтогДУ( m_OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, m_FormData.ReportDate, @Н_Налог, NULL, NULL ) )
        Н_Налог = $0.0;
     end;

     RetVal = m_OrderFD.СуммаПрибылиУчредителя(m_FormData.ReportDate) + Н_Дх + Н_Налог;

     if( ПолучитьИтогДУ( m_OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, m_BegDate-1, @Н_Дх, NULL, NULL ) )
        Н_Дх = $0.0;
     end;
     if( ПолучитьИтогДУ( m_OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, m_BegDate-1, @Н_Налог, NULL, NULL ) )
        Н_Налог = $0.0;
     end;

     RetVal = RetVal - (m_OrderFD.СуммаПрибылиУчредителя(m_BegDate-1) + Н_Дх + Н_Налог);

     return RetVal;
  END;

  PRIVATE MACRO CountOrder()

    var rsd, ds;

    rsd = RSDCommand( " select count(1) CountRec " + m_Select );
    rsd.addParam( "", RSDBP_IN, m_FormData.Contract   );
    rsd.addParam( "", RSDBP_IN, m_FormData.Contract   );
    rsd.addParam( "", RSDBP_IN, TS_DOC_IDDU           );
    rsd.addParam( "", RSDBP_IN, m_FormData.ReportDate );
    rsd.addParam( "", RSDBP_IN, m_FormData.ReportDate );
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       m_CountOrder = SQL_ConvTypeInteger(ds.rec.CountRec);
    end;

  END;

  PRIVATE MACRO OrderList()

    m_RSD_Order = RSDCommand( " select tsorder.t_ID " + m_Select );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.Contract   );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.Contract   );
    m_RSD_Order.addParam( "", RSDBP_IN, TS_DOC_IDDU           );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.ReportDate );
    m_RSD_Order.addParam( "", RSDBP_IN, m_FormData.ReportDate );
    m_RSD_Order.execute();
    m_Orders = TRsbDataSet( m_RSD_Order );

    m_Count = -1;
    InitProgress( m_CountOrder, "Обработка договоров доверительного управления", "Обработка договоров доверительного управления" );

  END;

  PRIVATE MACRO OrderNext()

    var RetVal = false;

    if( m_Orders.MoveNext() )

       UseProgress(m_Count = m_Count + 1);

       m_OrderFD = TS_OrderFD(0, m_Orders.rec.ID);

       var Valid = m_OrderFD.Valid( m_FormData.ReportDate );
       if( Valid != NULL )
          m_BegValidDate = Valid.rec.BeginDate;
          m_EndValidDate = Valid.rec.EndDate;
       end;
       m_BegDate = max(m_OrderFD.ДатаПервичногоВнесения(), m_BegValidDate);

       RetVal = true;
    end;

    return RetVal;
  END;

  PRIVATE MACRO OrderEnd()
    RemProgress();
  END;

  PRIVATE MACRO БСПоДатам( БС:@TArray, BegDate:DATE, EndDate:DATE )

    var Rate = $0.0;
    var RS, cmd;

    БС.Size = 0;

    cmd = RSDCommand( " SELECT p.t_GBPBaseProfit, p.t_GBPRate, p.t_GBPPoint, p.t_OpenDate, " +
                      "        NVL( (SELECT MIN(pm.t_OpenDate)-1                           " +
                      "                FROM dtsmngpln_dbt pm                               " +
                      "               WHERE pm.t_OrderID = p.t_OrderID                     " +
                      "                 AND pm.t_OpenDate > (p.t_OpenDate + 1)             " +
                      "             ), to_date('31-12-9999','DD-MM-YYYY') ) t_EndDate      " +
                      "   FROM dtsmngpln_dbt p                                             " +
                      "  WHERE p.t_OrderID = ?                                             " +
                      "    AND p.t_OpenDate BETWEEN (SELECT MAX(p1.t_OpenDate)             " +
                      "                                FROM dtsmngpln_dbt p1               " +
                      "                               WHERE p1.t_OrderID   = ?             " +
                      "                                 AND p1.t_OpenDate <= ?             " +
                      "                             ) AND ?                                " +
                      "  ORDER BY p.t_OpenDate                                             " );

    cmd.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.ID );
    cmd.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.ID );
    cmd.addParam( "", RSDBP_IN, BegDate                  );
    cmd.addParam( "", RSDBP_IN, EndDate                  );
    cmd.execute();

    RS = TRsbDataSet( cmd );
    while( RS.MoveNext() )

       if( RS.GBPBaseProfit == TS_BASE_PROFIT_FIX )
          Rate = RS.t_GBPRate;
       elif( RS.GBPBaseProfit == TS_BASE_PROFIT_MIDDLE )
          Rate = СреднCтавкаРефинансированияЦБР( BegDate, EndDate, NATCUR );
       else
          Rate = 0;
       end;

       БС[БС.Size] = СуммаПоДатам(SQL_ConvTypeDate(RS.t_OpenDate), Rate);

    end;

  END;

  PRIVATE MACRO СрокУправления(СК:TArray, i:integer):string
     var RetVal = "";

     if(СК.size - 2 == i) /* последняя строка */
        RetVal = F( N1_F6(i) + "-" + N1_F5(i) );
     else
        RetVal = F( N1_F5(i + 1) + "-" + N1_F5(i) );
     end;

     return RetVal;
  END;

  PRIVATE MACRO ДоходПоБазовойСтавке( БС:TArray, СК:TArray, i:integer, Size_EOY_F5:integer, IsProlong:bool ):string

     var RetVal;
     var ДатаНачала:date = СК[i].Дата + TS_IIF((i==0) and not IsProlong, 0, 1);/*Если первый период после пролонгации то плюсуем день*/
     var NRate = false;
     var temp = TArray(); temp.size = 0;
     var j = 0;
     var Rate_j:integer = 0;
     var De, year:integer;

     while( j < БС.Size )
        if( (БС[j].Дата > ДатаНачала) and (БС[j].Дата < СК[i+1].Дата) )
           if(NRate == false)
              if( j == 0 ) /* не было плана управления на начало */
                 temp[temp.Size] = СуммаПоДатам(ДатаНачала, 0);
              else
                 temp[temp.Size] = СуммаПоДатам(ДатаНачала, БС[j-1].Сумма);
              end;
           end;
           temp[temp.Size] = СуммаПоДатам(БС[j].Дата, БС[j].Сумма);
           NRate = true;
        end;
        if( (NRate == false) and (БС[j].Дата <= СК[i+1].Дата) )
           Rate_j = j; /* если за период одна ставка, то это её индекс */
        end;
        j = j + 1;
     end;

     if( NRate ) /* несколько ставок - расчитываем значение */

        j = 0; RetVal = 0;
        while( j < temp.Size )
           /* вычисляем как сумму по периодам в течении которых ставка была постоянна */
           if( j==(temp.Size-1) )
              De = СК[i+1].Дата;
           else
              De = temp[j+1].Дата;
           end;
           DateSplit( temp[j].Дата, null, null, year );
           RetVal = RetVal + СК[i].Сумма * temp[j].Сумма * ( ((date(31,12,year) - temp[j].Дата) / ДУ_ДнейВГоду(temp[j].Дата)) + ((De - date(31,12,year)) / ДУ_ДнейВГоду(De)) );
           j = j + 1;
        end;

     else /* одна ставка - формируем формулу */

        var F5 = N1_F5(i);
        var Н5 = N1_H5(i);
        var K12 = N1_K13(Rate_j + m_delta2);
        var EOY_F5 = N8_() + N8_C20(Size_EOY_F5);
        var BB1 = string(ДУ_ДнейВГоду(ДатаНачала));
        if(СК.size - 2 == i) /* последняя строка */
           De = N1_F6(i);
        else
           De = N1_F5(i + 1);
        end;
        var BB2 = string(ДУ_ДнейВГоду(СК[i+1].Дата));

        RetVal = F( Н5 + "*" + K12 + "*((" + EOY_F5 + "-" + F5 + ")/" + BB1 + "+(" + De + "-" + EOY_F5 + ")/" + BB2 + ")" );
     end;

     return string(RetVal);
  END;

  PRIVATE MACRO ДоходПоБазовойСтавкеЗаОП( БС:TArray, СК:TArray, IsProlong:bool ):string

     var RetVal:string = "";
     var NRate = false;
     var temp = TArray(); temp.size = 0;
     var j = 0;
     var Rate_j:integer = 0;
     var De;

     while( j < БС.Size )
        if( (БС[j].Дата > m_BegDate) and (БС[j].Дата < m_FormData.ReportDate) )
           if(NRate == false)
              if( j == 0 ) /* не было плана управления на начало */
                 temp[temp.Size] = СуммаПоДатам(m_BegDate, 0);
              else
                 temp[temp.Size] = СуммаПоДатам(m_BegDate, БС[j-1].Сумма);
              end;
           end;
           temp[temp.Size] = СуммаПоДатам(БС[j].Дата, БС[j].Сумма);
           NRate = true;
        end;
        if( (NRate == false) and (БС[j].Дата <= m_FormData.ReportDate) )
           Rate_j = j; /* если за период одна ставка, то это её индекс */
        end;
        j = j + 1;
     end;

     var BB1 = string(ДУ_ДнейВГоду(m_BegDate));
     var BB2 = string(ДУ_ДнейВГоду(m_FormData.ReportDate));

     if( NRate ) /* несколько ставок */
        j = 0;
        var year:integer;
        DateSplit( m_BegDate, null, null, year );
        while( j < temp.Size )
           if( j==(temp.Size-1) )
              De = m_FormData.ReportDate;
           else
              De = temp[j+1].Дата;
           end;
           RetVal = RetVal + TS_IIF(RetVal == "", "", "+" ) + "(" + N1_H8(m_delta1) + "*" + string(temp[j].Сумма) + "*((" + string(date(31,12,year)-temp[j].Дата) + ")/" + BB1 + "+(" + string(De-date(31,12,year)) + ")/" + BB2 + ")" + ")";
           j = j + 1;
        end;
     else /* одна ставка */
        RetVal = N1_H8(m_delta1) + "*" + N1_L13(Rate_j + m_delta2) + "*((" + N8_() + N8_A13(0) + "-" + N1_C3(0) + TS_IIF(IsProlong," + 1","") + ")/" + BB1 + "+(" + N1_F1(0) + "-" + N8_() + N8_A13(0) + ")/" + BB2 + ")";
     end;

     return F( FormulaIF() + "(" + N1_C3(0) + "=" + N1_F1(0) + ";" + N1_H8(m_delta1) + "*" + N1_L13(Rate_j + m_delta2) + "/" + BB1 + ";" + RetVal + ")" );
  END;

  PRIVATE MACRO МенялсяКапитал( СК:TArray, BegDate:date, EndDate:date )

     var RetVal = false;
     var i = 0;

     while( i < (СК.Size-1) )
        var ДатаНачала:date = СК[i].Дата + TS_IIF(i==0, 0, 1);
        if( (ДатаНачала > BegDate) and (ДатаНачала < EndDate) )
           RetVal = true;
        end;
        i = i + 1;
     end;

     return RetVal;
  END;

  PRIVATE MACRO ДоходПоБазовойСтавкеЗаТекущийМесяц( БС:TArray, СК:TArray, BegCurDate:date, EndCurDate:date ):string

     var RetVal:string = "";
     var NRate = false;
     var temp = TArray(); temp.size = 0;
     var j = 0;
     var Rate_j:integer = 0;
     var De;

     while( j < БС.Size )
        if( (БС[j].Дата > BegCurDate) and (БС[j].Дата < EndCurDate) )
           if(NRate == false)
              if( j == 0 ) /* не было плана управления на начало */
                 temp[temp.Size] = СуммаПоДатам(BegCurDate, 0);
              else
                 temp[temp.Size] = СуммаПоДатам(BegCurDate, БС[j-1].Сумма);
              end;
           end;
           temp[temp.Size] = СуммаПоДатам(БС[j].Дата, БС[j].Сумма);
           NRate = true;
        end;
        if( (NRate == false) and (БС[j].Дата <= EndCurDate) )
           Rate_j = j; /* если за период одна ставка, то это её индекс */
        end;
        j = j + 1;
     end;

     var МенКапитал = МенялсяКапитал(СК, BegCurDate, EndCurDate);

     if( NRate ) /* несколько ставок */

        if( МенКапитал )
           j = 0;
           while( j < temp.Size )
              if( j==(temp.Size-1) )
                 De = EndCurDate;
              else
                 De = temp[j+1].Дата;
              end;
              RetVal = RetVal + TS_IIF(RetVal == "", "", "+" ) + "(" + N8_() + N8_A17(0) + "*" + temp[j].Сумма + "*" + string(De - temp[j].Дата) + "/" + N8_() + N8_A9(0) + ")";
              j = j + 1;
           end;
        else
           j = 0;
           while( j < temp.Size )
              if( j==(temp.Size-1) )
                 De = EndCurDate;
              else
                 De = temp[j+1].Дата;
              end;
              RetVal = RetVal + TS_IIF(RetVal == "", "", "+" ) + "(" + N1_H8(m_delta1) + "*" + temp[j].Сумма + "*" + string(De - temp[j].Дата) + "/" + N8_() + N8_A9(0) + ")";
              j = j + 1;
           end;
        end;

     else /* одна ставка */

        if( МенКапитал )
           RetVal = N8_() + N8_A17(0) + "*" + N1_K13(Rate_j + m_delta2) + "*" + string(EndCurDate - BegCurDate + 1) + "/" + N8_() + N8_A9(0);
        else
           RetVal = N1_H8(m_delta1) + "*" + N1_K13(Rate_j + m_delta2) + "*" + string(EndCurDate - BegCurDate + 1) + "/" + N8_() + N8_A9(0);
        end;

     end;

     return F( RetVal );
  END;


  PRIVATE MACRO Печать_Акции(delta5)

     record wsum(pmwrtsum);
     var dl_leg = TRecHandler("dl_leg");
     var dlsum  = TRecHandler("dlsum");
     var AmountPortf:integer  = 0;
     var SqlQuery, HeadSelect2, HeadSelect3, WhereFIID, FooterQuery, FooterQueryFIID, SqlQueryCom;
     var Query, RSD, Query1, RSD1, Query2, RSD2, Query3, RSD3, Query4, RSD4, Query5, RSD5;
     var delim:string = "";
     var ТСС;

     HeadSelect2 = " select /*+LEADING(lot)*/ wrt.t_FIID, fi.t_FaceValueFI, fi.t_Name, paym.t_Purpose, paym.t_DocKind, paym.t_DocumentID, " +
                   "        lot.t_Date, lot.t_Time, wrt.t_Amount, wrt.t_SumID, wrt.t_Sum, lot.t_DealID, lot.t_DealDate, " +
                   "        wrt.t_balancecost, lot.t_currency, lot.t_Kind, wrt.t_NKDAmount, wrt.t_InterestIncome ";
     HeadSelect3 = " select /*+LEADING(lot)*/ distinct fi.t_FIID, fi.t_Name ";
     SqlQuery = "   from v_scwrthistex wrt, dpmwrtsum_dbt lot, dfininstr_dbt fi,           " +
                "        dpmpaym_dbt paym                                                  " +
                "  where wrt.t_Amount > 0                                                  " +
                "    and wrt.t_instance = ( select max (hw.t_instance)                     " +
                "                             from v_scwrthist hw                          " +
                "                            where hw.t_ChangeDate <= ?                    " +
                "                              and hw.t_SumID = lot.t_SumID )              " +
                "    and lot.t_SumID    = wrt.t_SumID                                      " +
                "    and lot.t_Trust    = 'X'                                              " +
                "    and lot.t_Buy_Sale = ?                                                " +
                "    and lot.t_Contract = ?                                                " +
                "    and lot.t_State    = ?                                                " +
                "    and fi.t_FIID      = lot.t_FIID                                       " +
                "    and fi.t_FI_Kind   = ?                                                " +
                "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                "    and fi.t_FaceValueFI = ?                                              " +
                "    and paym.t_paymentid = lot.t_DocID                                    ";
     WhereFIID = "   and lot.t_FIID = ? ";
     FooterQuery = " order by fi.t_FIID, lot.t_Date, lot.t_Time                            ";
     FooterQueryFIID = " order by fi.t_FIID ";

     SqlQueryCom = " select /*+LEADING(dlsum)*/ dlsum.t_Date, sum(dlsum.t_Sum) Sum  " + 
                   "   from ddlsum_dbt dlsum, ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fi " +
                   "  where dlsum.t_Date between ? and ?        " +
                   "    and dlsum.t_Kind  = ?                   " +
                   "    and tick.t_DealID = dlsum.t_DocID       " +
                   "    and tick.t_BofficeKind in(?, ?)         " +
                   "    and tick.t_ClientContrID = ?            " +
                   "    and leg.t_DealID = tick.t_DealID        " +
                   "    and fi.t_FIID = leg.t_PFI               " +
                   "    and fi.t_FI_Kind   = ?                                                " +
                   "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                   " group by dlsum.t_Date                      " +
                   " order by dlsum.t_Date                      ";

     MACRO КоличествоСтрокПоБумаге( FIID:integer ):integer

        var RetVal = 0;
        var Select = RSDCommand( " select count(1) NRec from ( " + HeadSelect2 + SqlQuery + WhereFIID + " ) " );
        Select.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Select.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Select.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Select.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Select.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Select.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
        Select.addParam("", RSDBP_IN, NATCUR                );
        Select.addParam("", RSDBP_IN, FIID                  );
        Select.execute();

        var RSDSelect = TRsbDataSet(Select);

        if( RSDSelect.MoveNext() )
           RetVal = SQL_ConvTypeInteger(RSDSelect.NRec);
        end;

        return RetVal;
     END;

     MACRO PrintLineTable1( N2_AA1, N2_AA2, N2_AA3, N2_AA4, N2_AA5, N2_AA6, N2_AA7, N2_AA8, N2_AA9, N2_AA10,
                            N2_AA11, N2_AA12, N2_AA16, N2_AA17, N2_AA18, N2_AA19 )
        PrintTableLine( "N2_AA1",  N2_AA1,  null,
                        "N2_AA2",  N2_AA2,  null,
                        "N2_AA3",  N2_AA3,  null,
                        "N2_AA4",  N2_AA4,  null,
                        "N2_AA5",  N2_AA5,  null,
                        "N2_AA6",  N2_AA6,  null,
                        "N2_AA7",  N2_AA7,  null,
                        "N2_AA8",  N2_AA8,  null,
                        "N2_AA9",  N2_AA9,  null,
                        "N2_AA10", N2_AA10, null,
                        "N2_AA11", N2_AA11, null,
                        "N2_AA12", N2_AA12, null,
                        "N2_AA16", N2_AA16, null,
                        "N2_AA17", N2_AA17, null,
                        "N2_AA18", N2_AA18, null,
                        "N2_AA19", N2_AA19, null);
     END;

     MACRO PrintLineTable2( N2_AB1, N2_AB2, N2_AB3, N2_AB4, N2_AB5, N2_AB6, N2_AB7, N2_AB8, N2_AB9, N2_AB10,
                            N2_AB11, N2_AB12, N2_AB13, N2_AB14, N2_AB15, N2_AB16 )
        PrintTableLine( "N2_AB1",  N2_AB1,  null,
                        "N2_AB2",  N2_AB2,  null,
                        "N2_AB3",  N2_AB3,  null,
                        "N2_AB4",  N2_AB4,  null,
                        "N2_AB5",  N2_AB5,  null,
                        "N2_AB6",  N2_AB6,  null,
                        "N2_AB7",  N2_AB7,  null,
                        "N2_AB8",  N2_AB8,  null,
                        "N2_AB9",  N2_AB9,  null,
                        "N2_AB10", N2_AB10, null,
                        "N2_AB11", N2_AB11, null,
                        "N2_AB12", N2_AB12, null,
                        "N2_AB13", N2_AB13, null,
                        "N2_AB14", N2_AB14, null,
                        "N2_AB15", N2_AB15, null,
                        "N2_AB16", N2_AB16, null);
     END;

     MACRO PrintLineTable3( N2_AC1, N2_AC2 )
        PrintTableLine( "N2_AC1",  N2_AC1,  null,
                        "N2_AC2",  N2_AC2,  null);
     END;

     Query = RSDCommand( " select case when exists ( " + HeadSelect2 + SqlQuery + " ) then 1 else 0 end NRec from dual " );
     Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
     Query.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
     Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
     Query.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
     Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
     Query.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
     Query.addParam("", RSDBP_IN, NATCUR                );
     Query.execute();

     RSD = TRsbDataSet(Query);

     var ExistsLot = 0;
     if( RSD.MoveNext() )
        ExistsLot = SQL_ConvTypeInteger(RSD.NRec);
     end;

     Query4 = RSDCommand( " select count(1) NRec from ( " + SqlQueryCom + " ) " );
     Query4.addParam("", RSDBP_IN, m_BegDate                       );
     Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
     Query4.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
     Query4.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
     Query4.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
     Query4.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
     Query4.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
     Query4.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE              );
     Query4.execute();

     RSD4 = TRsbDataSet(Query4);

     var ExistsCom:integer = 0;
     if( RSD4.MoveNext() )
        ExistsCom = SQL_ConvTypeInteger(RSD4.NRec);
     end;

     if( (ExistsLot > 0) or (ExistsCom > 0) )

        if( m_SheetN2 == false )
           UseNewSheetInTotalBook();
           m_SheetN2 = true;
        end;
        SetActiveSheet( "Акции" );

        m_PrintOrderN2 = true;

        Query1 = RSDCommand( " select count(1) NRec from ( " + HeadSelect3 + SqlQuery + " ) " );
        Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query1.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query1.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query1.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
        Query1.addParam("", RSDBP_IN, NATCUR                );
        Query1.execute();

        RSD1 = TRsbDataSet(Query1);

        if( RSD1.MoveNext() )
           AmountPortf = SQL_ConvTypeInteger(RSD1.NRec); /* количество строк в таблице "портфель" */
        end;

        var DeltaPortfItog = max(AmountPortf, 1);

        PrintFormatString( "", "N2_C1",   F( N1_() + N1_C1(0) ),
                               "N2_G1",   F( N1_() + N1_F1(0) ),
                               "N2_AT",   TS_IIF(m_PrevValid != NULL, "Продленный договор с", ""),
                               "N2_AD1",  TS_IIF(m_PrevValid != NULL, m_BegValidDate, ""),
                               "N2_AT1",  TS_IIF(m_PrevValid != NULL, "за", ""),
                               "N2_AT2",  TS_IIF(m_PrevValid != NULL, F( N2_G1(0) + "-" + N2_C2(0) + "+1" ), ""),
                               "N2_AT3",  TS_IIF(m_PrevValid != NULL, strdays( m_FormData.ReportDate - m_BegValidDate + 1), ""),
                               "N2_AA13", F( N2_J8(DeltaPortfItog) + "*100/" + N2_N8(DeltaPortfItog) + "*" + N8_() + N8_A9(0) ),
                               "N2_L4",   TS_IIF(m_PrintOrderN3, F( N3_() + N3_P3(0) ), 0.0),
                               "N2_AA15", F( "(" + N2_L4(0) + "+" + N2_J8(DeltaPortfItog) + "+" + N1_() + N1_C80(delta5) + ")*100*" + N8_() + N8_A9(0) + "/(" + N8_() + N8_A7(0) + "+" + N2_N8(DeltaPortfItog) + "+" + TS_IIF(m_PrintOrderN3, N3_() + N3_P4(0), "0") + ")" ) );

        GL_AA14 = N2_L4(0);
        GL_AA15 = N2_L5(0);

        /* печатем таблицу "портфель" */
        RegisterTable( "N2_MainTable_1", "",
                       "N2_AA1", "N2_AA2", "N2_AA3", "N2_AA4", "N2_AA5", "N2_AA6", "N2_AA7", "N2_AA8",
                       "N2_AA9", "N2_AA10", "N2_AA11", "N2_AA12", "N2_AA16", "N2_AA17", "N2_AA18", "N2_AA19" );

        var DeltaDealItog = DeltaPortfItog - 1;

        var i = 0;
        var AA2 = "", AA3 = "", AA4 = "", AA5 = "", AA6 = "", AA8 = "", AA9 = "", AA10 = "", AA16 = "", AA17 = "", AA18 = "";
        if( AmountPortf > 0 )

           Query2 = RSDCommand( HeadSelect3 + SqlQuery + FooterQueryFIID );
           Query2.addParam("", RSDBP_IN, m_FormData.ReportDate );
           Query2.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
           Query2.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
           Query2.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
           Query2.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
           Query2.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
           Query2.addParam("", RSDBP_IN, NATCUR                );
           Query2.execute();
          
           RSD2 = TRsbDataSet(Query2);

           while( RSD2.MoveNext() )
          
              var L12:string = "";
              var СтрокПоБумаге = КоличествоСтрокПоБумаге(RSD2.FIID);
              DeltaDealItog = DeltaDealItog + СтрокПоБумаге + TS_IIF(i == 0, 0, 1); /* итоговая строка по данной бумаге в таблице "Сделки приобретения" */
          
              var j = СтрокПоБумаге;
              while(j > 0)
                 if( j == СтрокПоБумаге )
                    L12 = N2_L12(DeltaDealItog - СтрокПоБумаге);
                 else
                    L12 = L12 + ";" + N2_L12(DeltaDealItog - СтрокПоБумаге);
                 end;
                 j = j - 1;
              end;

              ТСС = ПолучитьТСС(RSD2.FIID, NATCUR, m_FormData.ReportDate - 1);
              PrintLineTable1( RSD2.Name,
                               F( N2_D12(DeltaDealItog) ),
                               F( N2_F12(DeltaDealItog) ),
                               F( N2_C8(i) + "+" + N2_E8(i) ),
                               F( N2_G12(DeltaDealItog) ),
                               F( N2_I12(DeltaDealItog) ),
                               TS_IIF( ТСС > 0, ТСС, F( N2_F12(DeltaDealItog) + "/" + N2_B8(i) ) ),
                               F( N2_G8(i) + "*" + N2_B8(i) + "*" + N8_() + N8_A11(0) + "/100" ),
                               F( N2_B8(i) + "*" + N2_G8(i) + "-" + N2_H8(i) ),
                               F( N2_I8(i) + "-" + N2_D8(i) ),
                               F( FormulaMAX() + "(" + L12 + ")" ),
                               F( N2_J8(i) + "/" + N2_N8(i) + "*" + N8_() + N8_A9(0) + "*100" ),
                               F( N2_I8(i) + "-" + N2_F8(i) ),
                               F( N2_M12(DeltaDealItog) ),
                               F( N2_P12(DeltaDealItog) ),
                               F( N2_O8(i) + "/" + N2_B8(i) ) );
          
              delim = TS_IIF(i == 0, "", ";");
              AA2  = AA2  + delim + N2_B8(i);
              AA3  = AA3  + delim + N2_C8(i);
              AA4  = AA4  + delim + N2_D8(i);
              AA5  = AA5  + delim + N2_E8(i);
              AA6  = AA6  + delim + N2_F8(i);
              AA8  = AA8  + delim + N2_H8(i);
              AA9  = AA9  + delim + N2_I8(i);
              AA10 = AA10 + delim + N2_J8(i);
              AA16 = AA16 + delim + N2_M8(i);
              AA17 = AA17 + delim + N2_N8(i);
              AA18 = AA18 + delim + N2_O8(i);
          
              i = i + 1;
           end;
        else
           PrintLineTable1( "",
                            F( N2_D12(DeltaDealItog+1) ),
                            F( N2_F12(DeltaDealItog+1) ),
                            F( N2_C8(0) + "+" + N2_E8(0) ),
                            F( N2_G12(DeltaDealItog+1) ),
                            F( N2_I12(DeltaDealItog+1) ),
                            0.0,
                            F( N2_G8(0) + "*" + N2_B8(0) + "*" + N8_() + N8_A11(0) + "/100" ),
                            F( N2_B8(0) + "*" + N2_G8(0) + "-" + N2_H8(0) ),
                            F( N2_I8(0) + "-" + N2_D8(0) ),
                            F( FormulaMAX() + "(" + N2_L12(DeltaDealItog+1) + ")" ),
                            F( N2_J8(0) + "/" + N2_N8(0) + "*" + N8_() + N8_A9(0) + "*100" ),
                            F( N2_I8(0) + "-" + N2_F8(0) ),
                            F( N2_M12(DeltaDealItog+1) ),
                            F( N2_P12(DeltaDealItog+1) ),
                            F( N2_O8(0) + "/" + N2_B8(0) ) );
          
           AA2  = N2_B8(0);
           AA3  = N2_C8(0);
           AA4  = N2_D8(0);
           AA5  = N2_E8(0);
           AA6  = N2_F8(0);
           AA8  = N2_H8(0);
           AA9  = N2_I8(0);
           AA10 = N2_J8(0);
           AA16 = N2_M8(0);
           AA17 = N2_N8(0);
           AA18 = N2_O8(0);
          
           i = i + 1;
        end;

        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable1( "ИТОГО:",
                         F( FormulaSUM() + "(" + AA2 + ")" ),
                         F( FormulaSUM() + "(" + AA3 + ")" ),
                         F( FormulaSUM() + "(" + AA4 + ")" ),
                         F( FormulaSUM() + "(" + AA5 + ")" ),
                         F( FormulaSUM() + "(" + AA6 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AA8 + ")" ),
                         F( FormulaSUM() + "(" + AA9 + ")" ),
                         F( FormulaSUM() + "(" + AA10 + ")" ),
                         "",
                         "",
                         F( FormulaSUM() + "(" + AA16 + ")" ),
                         F( FormulaSUM() + "(" + AA17 + ")" ),
                         F( FormulaSUM() + "(" + AA18 + ")" ),
                         "");

        GL_FAA3  = N2_C8(i);
        GL_FAA10 = N2_J8(i);
        GL_FAA5  = N2_E8(i);

        EndTable();
        CopyAllSheetInTotalBook( "Акции", false, "N2_Table1", 0, "Акции" );

        /* печатем таблицу "Сделки приобретения" */

        var DeltaDeal = DeltaPortfItog - 1;

        Query3 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
        Query3.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query3.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query3.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query3.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query3.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query3.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE    );
        Query3.addParam("", RSDBP_IN, NATCUR                );
        Query3.execute();

        RSD3 = TRsbDataSet(Query3);

        RegisterTable( "N2_MainTable_2", "",
                       "N2_AB1", "N2_AB2", "N2_AB3", "N2_AB4", "N2_AB5", "N2_AB6", "N2_AB7", "N2_AB8", "N2_AB9",
                       "N2_AB10", "N2_AB11", "N2_AB12", "N2_AB13", "N2_AB14", "N2_AB15", "N2_AB16" );

        i = 0;
        var k = 0; /* количество итоговых строк */
        var PrevFIID = 0;
        var AB4 = "", AB5 = "", AB6 = "", AB7 = "", AB9 = "", AB11 = "", AB13 = "", AB16 = "";
        if( AmountPortf > 0 )
           while( RSD3.MoveNext() )
          
              if( (PrevFIID != RSD3.FIID) and (i != 0) )
                 /* печатаем итог по выпуску */
                 SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                 PrintLineTable2( "", "", "",
                                  F( FormulaSUM() + "(" + AB4 + ")" ),
                                  F( FormulaSUM() + "(" + AB5 + ")" ),
                                  F( FormulaSUM() + "(" + AB6 + ")" ),
                                  F( FormulaSUM() + "(" + AB7 + ")" ),
                                  "",
                                  F( FormulaSUM() + "(" + AB9 + ")" ),
                                  "",
                                  F( FormulaSUM() + "(" + AB11 + ")" ),
                                  "",
                                  F( FormulaSUM() + "(" + AB13 + ")" ),
                                  "", "",
                                  F( FormulaSUM() + "(" + AB16 + ")" ));
                 AB4 = ""; AB5 = ""; AB6 = ""; AB7 = ""; AB9 = ""; AB11 = ""; AB13 = ""; AB16 = "";
                 k = k + 1;
              end;
          
              var InPeriod = (RSD3.Date >= m_BegValidDate); /* Дата поставки входит в отчётный период? */
              var InCap = ( (RSD3.Kind == 340) and (RSD3.DocKind == TS_DOC_DECLAR) ); /* операции внесения капитала */
          
              if( InCap == false )
                 FindDL_LEG( TS_IIF(RSD3.Purpose == BRi, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK), RSD3.DealID, 0, dl_leg );
              end;
          
              var N2_AB5  = $0.0; /* Цена */
              var N2_AB15 = $0.0; /* _Цена покупки */
              var Nominal;
              if( InPeriod )
                 if( InCap )
                    N2_AB5 = ПолучитьКурсИзВВК( RSD3.FIID, RSD3.DocumentID );
                 else
                    if( dl_leg.rec.RelativePrice != "X" )
                       N2_AB5 = dl_leg.rec.Price;
                    else
                       Nominal = TS_GetFaceValue(RSD3.FIID, SQL_ConvTypeDate(RSD3.Date));
                       if( Nominal != 0.0 )
                          N2_AB5 = dl_leg.rec.Price / 100.0 * Nominal;
                       end;
                    end;
                 end;
              else
                 if( InCap )
                    N2_AB15 = ПолучитьКурсИзВВК( RSD3.FIID, RSD3.DocumentID );
                 else
                    if( dl_leg.rec.RelativePrice != "X" )
                       N2_AB15 = dl_leg.rec.Price;
                    else
                       Nominal = TS_GetFaceValue(RSD3.FIID, SQL_ConvTypeDate(RSD3.Date));
                       if( Nominal != 0.0 )
                          N2_AB15 = dl_leg.rec.Price / 100.0 * Nominal;
                       end;
                    end;
                 end;
              if( WRTGetRestoreLotOnDate(RSD3.SumID, m_BegValidDate/* - 1*/, wsum) == true ) 
                    if( wsum.Amount != 0.0 )
                       N2_AB5 = (wsum.BalanceCost - wsum.NKDAmount - wsum.InterestIncome) / wsum.Amount;
                    end;
                 end;
              end;
          
              var N2_AB7 = $0.0; /* Комиссия брокера и биржи */
              if( InCap == false)
                 if( dl_leg.rec.Principal != 0.0 )
                    if( FindDLSUM( RSD3.DocKind, RSD3.DealID, DLSUM_KIND_AGENT_PERIOD, RSD3.DealDate, dlsum ) == 0)
                       N2_AB7 = N2_AB7 + dlsum.rec.Sum;
                    end;
                    if( FindDLSUM( RSD3.DocKind, RSD3.DealID, DLSUM_KIND_AGENT_ONCE, RSD3.DealDate, dlsum ) == 0)
                       N2_AB7 = N2_AB7 + dlsum.rec.Sum;
                    end;
                    if( FindDLSUM( RSD3.DocKind, RSD3.DealID, DLSUM_KIND_AGENT_ONCE_IMPORT, RSD3.DealDate, dlsum ) == 0)
                       N2_AB7 = N2_AB7 + dlsum.rec.Sum;
                    end;
                    N2_AB7 = N2_AB7 * RSD3.Amount / dl_leg.rec.Principal;
                 end;
              end;

              ТСС = ПолучитьТСС(RSD3.FIID, RSD3.FaceValueFI, m_FormData.ReportDate - 1);
              PrintLineTable2( TS_IIF(InPeriod, SQL_ConvTypeDate(RSD3.Date), m_BegValidDate - 1),
                               SQL_ConvTypeTime(RSD3.Time),
                               RSD3.Name,
                               RSD3.Amount,
                               F( ДУ_ЧислоCЗаданнойТочностью(N2_AB5,4) ),
                               F( N2_D12(DeltaDeal+i+k) + "*" + N2_E12(DeltaDeal+i+k) ),
                               N2_AB7,
                               F( ДУ_ЧислоCЗаданнойТочностью(ЦенаПоБалансу( RSD3.SumID, RSD3.FIID, RSD3.FaceValueFI, m_FormData.ReportDate ),4) ),
                               F( N2_H12(DeltaDeal+i+k) + "*" + N2_D12(DeltaDeal+i+k) ),
                               TS_IIF( ТСС > 0, F( ДУ_ЧислоCЗаданнойТочностью(ТСС,4) ), F( N2_E12(DeltaDeal+i+k) ) ),
                               F( N2_I12(DeltaDeal+i+k) + "-" + N2_F12(DeltaDeal+i+k) ),
                               F( N2_G1(0) + "-" + N2_A12(DeltaDeal+i+k) ),
                               F( N2_F12(DeltaDeal+i+k) + "*" + N2_L12(DeltaDeal+i+k) ),
                               TS_IIF(InPeriod, "", SQL_COnvTypeDate(RSD3.Date)),
                               TS_IIF(InPeriod, "", F( ДУ_ЧислоCЗаданнойТочностью(N2_AB15,4) ) ),
                               TS_IIF(InPeriod, "", F( N2_O12(DeltaDeal+i+k) + "*" + N2_D12(DeltaDeal+i+k) )));
          
              delim = TS_IIF(AB4 == "", "", ";");
              AB4  = AB4  + delim + N2_D12(DeltaDeal+i+k);
              AB5  = AB5  + delim + N2_E12(DeltaDeal+i+k);
              AB6  = AB6  + delim + N2_F12(DeltaDeal+i+k);
              AB7  = AB7  + delim + N2_G12(DeltaDeal+i+k);
              AB9  = AB9  + delim + N2_I12(DeltaDeal+i+k);
              AB11 = AB11 + delim + N2_K12(DeltaDeal+i+k);
              AB13 = AB13 + delim + N2_M12(DeltaDeal+i+k);
              AB16 = AB16 + delim + N2_P12(DeltaDeal+i+k);
          
              PrevFIID = RSD3.FIID;
          
              i = i + 1;
           end;
        else
           PrintLineTable2( F(N2_G1(0)),
                            "",
                            "",
                            0.0,
                            0.0,
                            F( N2_D12(DeltaDeal+i+k) + "*" + N2_E12(DeltaDeal+i+k) ),
                            0.0,
                            0.0,
                            F( N2_H12(DeltaDeal+i+k) + "*" + N2_D12(DeltaDeal+i+k) ),
                            0.0,
                            F( N2_I12(DeltaDeal+i+k) + "-" + N2_F12(DeltaDeal+i+k) ),
                            F( N2_G1(0) + "-" + N2_A12(DeltaDeal+i+k) ),
                            F( N2_F12(DeltaDeal+i+k) + "*" + N2_L12(DeltaDeal+i+k) ),
                            "",
                            0.0,
                            0.0 );

           AB4  = N2_D12(DeltaDeal+i+k);
           AB5  = N2_E12(DeltaDeal+i+k);
           AB6  = N2_F12(DeltaDeal+i+k);
           AB7  = N2_G12(DeltaDeal+i+k);
           AB9  = N2_I12(DeltaDeal+i+k);
           AB11 = N2_K12(DeltaDeal+i+k);
           AB13 = N2_M12(DeltaDeal+i+k);
           AB16 = N2_P12(DeltaDeal+i+k);

           i = i + 1;
        end;

        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        /* печатаем итог по последнему выпуску */
        PrintLineTable2( "", "", "",
                         F( FormulaSUM() + "(" + AB4 + ")" ),
                         F( FormulaSUM() + "(" + AB5 + ")" ),
                         F( FormulaSUM() + "(" + AB6 + ")" ),
                         F( FormulaSUM() + "(" + AB7 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AB9 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AB11 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + AB13 + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + AB16 + ")" ));
        AB4 = ""; AB5 = ""; AB6 = ""; AB7 = ""; AB9 = ""; AB11 = ""; AB13 = ""; AB16 = "";

        EndTable();
        CopyAllSheetInTotalBook( "Акции", false, "N2_Table2", 0, "Акции" );

        /* печатем таблицу "Комиссии" */
        
        if( ExistsCom > 0 )

           var DeltaCom = DeltaDeal + i + k - 1;
           RegisterTable( "N2_MainTable_3", "", "N2_AC1", "N2_AC2" );

           Query5 = RSDCommand( SqlQueryCom );
           Query5.addParam("", RSDBP_IN, m_BegDate                       );
           Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
           Query5.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
           Query5.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
           Query5.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
           Query5.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
           Query5.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
           Query5.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE              );
           Query5.execute();

           RSD5 = TRsbDataSet(Query5);

           i = 0;
           var FAC2 = "";
           while( RSD5.MoveNext() )

              PrintLineTable3( SQL_ConvTypeDate(RSD5.Date), RSD5.Sum );

              delim = TS_IIF(FAC2 == "", "", ";");
              FAC2 = FAC2 + delim + N2_B17(DeltaCom + i);

              i = i + 1;
           end;

           SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
           PrintLineTable3( "ИТОГО:", F( FormulaSUM() + "(" + FAC2 + ")" ) );

           GL_FAC2 = N2_B17(DeltaCom + i);

           EndTable();
           CopyAllSheetInTotalBook( "Акции", false, "N2_Table3", 0, "Акции" );

        end;

     end;

  END;


  PRIVATE MACRO Печать_АкцииЗакрытые()

    var AZ_ExistsLNK:integer = 0;
    record wsum(pmwrtsum);
    var SqlQueryHead1, SqlQuery;
    var Query, RSD, Query1, RSD1;
    var delim:string = "";

    SqlQueryHead1 = " select /*+LEADING(lnk)*/ lnk.t_Amount, lnk.t_SumSale, lnk.t_SumBuy, wrtbuy.t_SumID BuySumID, wrtsale.t_DealID DealIDSale, wrtsale.t_Buy_Sale Buy_Sale, wrtsale.t_Kind KindSale," +
                    "        wrtsale.t_Date DateSale, wrtsale.t_Time TimeSale, wrtbuy.t_Date DateBuy, wrtbuy.t_Time TimeBuy, " +
                    "        fi.t_Name, fi.t_FIID, fi.t_FaceValueFI, paym.t_DocumentID                                       ";
    SqlQuery = "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt wrtsale, dpmwrtsum_dbt wrtbuy, dfininstr_dbt fi, " +
               "        dpmpaym_dbt paym                                                 " +
               "  where lnk.t_SaleID       = wrtsale.t_SumID                             " +
               "    and lnk.t_BuyID        = wrtbuy.t_SumID                              " +
               "    and wrtbuy.t_Trust     = 'X'                                         " +
               "    and wrtsale.t_fiid     = fi.t_fiid                                   " +
               "    and wrtsale.t_Contract = ?                                           " +
               "    and wrtsale.t_Date    >= ?                                           " +
               "    and wrtsale.t_Date    <= ?                                           " +
               "    and wrtsale.t_Currency = fi.t_FaceValueFI                            " +
               "    and wrtbuy.t_Currency  = fi.t_FaceValueFI                            " +
               "    and fi.t_FaceValueFI   = ?                                           " +
               "    and fi.t_FI_Kind       = ?                                           " +
               "    and RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
               "    and paym.t_paymentid   = wrtsale.t_DocID                             ";
    var SqlQueryFooter = " order by wrtsale.t_Date, wrtsale.t_Time, fi.t_FIID, wrtsale.t_SumID ";

    MACRO PrintLineTable1( N3_AZ2, N3_AZ3, N3_AZ4, N3_AZ5, N3_AZ6, N3_AZ7, N3_AZ8, N3_AZ9, N3_AZ10, N3_AZ11, N3_AZ12, N3_AZ13, N3_AZ14,
                           N3_AZ15, N3_AZ16, N3_AZ17, N3_AZ18, N3_AZ19, N3_AZ20, N3_AZ21 )
       PrintTableLine( "N3_AZ2",  N3_AZ2,  null,
                       "N3_AZ3",  N3_AZ3,  null,
                       "N3_AZ4",  N3_AZ4,  null,
                       "N3_AZ5",  N3_AZ5,  null,
                       "N3_AZ6",  N3_AZ6,  null,
                       "N3_AZ7",  N3_AZ7,  null,
                       "N3_G7",   "",      null, /* разделительное поле */
                       "N3_AZ8",  N3_AZ8,  null,
                       "N3_AZ9",  N3_AZ9,  null,
                       "N3_AZ10", N3_AZ10, null,
                       "N3_AZ11", N3_AZ11, null,
                       "N3_AZ12", N3_AZ12, null,
                       "N3_AZ13", N3_AZ13, null,
                       "N3_AZ14", N3_AZ14, null,
                       "N3_AZ15", N3_AZ15, null,
                       "N3_AZ16", N3_AZ16, null,
                       "N3_AZ17", N3_AZ17, null,
                       "N3_AZ18", N3_AZ18, null,
                       "N3_AZ19", N3_AZ19, null,
                       "N3_AZ20", N3_AZ20, null,
                       "N3_AZ21", N3_AZ21, null);
    END;

    Query = RSDCommand( " select case when exists ( " + SqlQueryHead1 + SqlQuery + " ) then 1 else 0 end NRec from dual " );
    Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam("", RSDBP_IN, m_BegDate );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
    Query.addParam("", RSDBP_IN, NATCUR );
    Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
    Query.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE);
    Query.execute();
    
    RSD = TRsbDataSet(Query);
    if( RSD.MoveNext() )
       AZ_ExistsLNK = SQL_ConvTypeInteger(RSD.NRec);
    end;

    if( AZ_ExistsLNK > 0 )

       if( m_SheetN3 == false )
          UseNewSheetInTotalBook();
          m_SheetN3 = true;
       end;
       SetActiveSheet( "Акции Закрытые" );

       m_PrintOrderN3 = true;

       /* печатаем таблицу */
       var PrevFIID:integer = 0, PrevDateSale:date = date(0,0,0), PrevDealIDSale = -1, DealID = -1;
       var i:integer = 0;
       var AmountItogLine:integer = 0; /* количество итоговых линий */
       var AZ5 = "", AZ7 = "", AZ11 = "", AZ13 = "", AZ15 = "", AZ21 = "", AZ161 = "", AZ181 = "";

       Query1 = RSDCommand( SqlQueryHead1 + SqlQuery + SqlQueryFooter );
       Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query1.addParam("", RSDBP_IN, m_BegDate );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
       Query1.addParam("", RSDBP_IN, NATCUR );
       Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
       Query1.addParam("", RSDBP_IN, AVOIRISSKIND_SHARE);
       Query1.execute();
       RSD1 = TRsbDataSet(Query1);

       RegisterTable( "N3_MainTable_1", "",
                      "N3_AZ2", "N3_AZ3", "N3_AZ4", "N3_AZ5", "N3_AZ6", "N3_AZ7", "N3_G7", "N3_AZ8", "N3_AZ9", "N3_AZ10", "N3_AZ11",
                      "N3_AZ12", "N3_AZ13", "N3_AZ14", "N3_AZ15", "N3_AZ16", "N3_AZ17", "N3_AZ18", "N3_AZ19", "N3_AZ20", "N3_AZ21" );

       while( RSD1.MoveNext() )

          if( ((PrevDateSale != SQL_ConvTypeDate(RSD1.DateSale)) or (PrevFIID != RSD1.FIID)) and (i != 0) ) /* печатаем итог по выпуску */

             SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
             PrintLineTable1( "", "", "",
                              F( FormulaSUM() + "(" + AZ5 + ")" ),
                              "",
                              F( FormulaSUM() + "(" + AZ7 + ")" ),
                              "", "", "",
                              F( FormulaSUM() + "(" + AZ11 + ")" ),
                              "",
                              F( FormulaSUM() + "(" + AZ13 + ")" ),
                              "",
                              F( FormulaSUM() + "(" + AZ15 + ")" ),
                              F( N3_F7(i+AmountItogLine) + "-" + N3_M7(i+AmountItogLine) ),
                              F( N3_F7(i+AmountItogLine) + "-" + N3_O7(i+AmountItogLine) ),
                              "", "", "",
                              F( FormulaSUM() + "(" + AZ21 + ")" ));

             AZ5 = ""; AZ7 = ""; AZ11 = ""; AZ13 = ""; AZ15 = ""; AZ21 = "";

             delim = TS_IIF(AZ161 == "", "", ";");
             AZ161 = AZ161 + delim + N3_P7(i+AmountItogLine);

             AmountItogLine = AmountItogLine + 1;
          end;

          var InPeriod = (RSD1.DateBuy >= m_BegValidDate); /* Дата поставки сделки покупки входит в отчётный период? */
          var N3_AZ12 = $0.0; /* Цена */
          var N3_AZ20 = $0.0; /* _Цена покупки */
          if( InPeriod )
             N3_AZ12 = TS_IIF((RSD1.Amount > 0), RSD1.SumBuy/RSD1.Amount, 0);
          else
             N3_AZ20 = TS_IIF((RSD1.Amount > 0), RSD1.SumBuy/RSD1.Amount, 0);

             if( WRTGetRestoreLotOnDate(RSD1.BuySumID, m_BegValidDate /*- 1*/, wsum) == true )
                if( wsum.Amount != 0.0 )
                   N3_AZ12 = (wsum.BalanceCost - wsum.NKDAmount - wsum.InterestIncome) / wsum.Amount;
                end;
             end;
          end;

          var ВыводЦБ = ( RSD1.Buy_Sale == PM_WRITEOFF_SUM_SALE ) AND ( RSD1.KindSale == 330 );
          if( ВыводЦБ )
             DealID = RSD1.DocumentID;
          else
             DealID = RSD1.DealIDSale;
          end;

          PrintLineTable1( SQL_ConvTypeDate(RSD1.DateSale),
                           TS_IIF(PrevDealIDSale == DealID, "", SQL_ConvTypeTime(RSD1.TimeSale)),
                           TS_IIF(PrevDealIDSale == DealID, "", RSD1.Name),
                           TS_IIF(PrevDealIDSale == DealID, "", КоличествоБумаг(DealID, RSD1.FIID, ВыводЦБ )),
                           TS_IIF(PrevDealIDSale == DealID, "", TS_IIF((RSD1.Amount > 0), F( ДУ_ЧислоCЗаданнойТочностью(RSD1.SumSale/RSD1.Amount,4) ), 0)),
                           TS_IIF(PrevDealIDSale == DealID, "", F( N3_D7(i+AmountItogLine) + "*" + N3_E7(i+AmountItogLine) )),
                           TS_IIF(InPeriod, SQL_ConvTypeDate(RSD1.DateBuy), m_BegValidDate - 1),
                           SQL_ConvTypeTime(RSD1.TimeBuy),
                           RSD1.Name,
                           RSD1.Amount,
                           F( ДУ_ЧислоCЗаданнойТочностью(N3_AZ12,4) ),
                           F( N3_L7(i+AmountItogLine) + "*" + N3_K7(i+AmountItogLine) ),
                           ЦенаПоБалансу( RSD1.BuySumID, RSD1.FIID, RSD1.FaceValueFI, RSD1.DateSale ),
                           F( N3_N7(i+AmountItogLine) + "*" + N3_K7(i+AmountItogLine) ),
                           "", "",
                           F( N3_M7(i+AmountItogLine) + "*(" + N3_A7(i+AmountItogLine) + "-" + N3_H7(i+AmountItogLine) + ")" ),
                           TS_IIF(InPeriod, "", SQL_ConvTypeDate(RSD1.DateBuy)),
                           TS_IIF(InPeriod, "", F( ДУ_ЧислоCЗаданнойТочностью(N3_AZ20,4) ) ),
                           TS_IIF(InPeriod, "", F( N3_T7(i+AmountItogLine) + "*" + N3_K7(i+AmountItogLine) ) ) );

          delim = TS_IIF(AZ5 == "", "", ";");
          AZ5  = AZ5  + delim + N3_D7(i+AmountItogLine);
          AZ7  = AZ7  + delim + N3_F7(i+AmountItogLine);
          AZ11 = AZ11 + delim + N3_K7(i+AmountItogLine);
          AZ13 = AZ13 + delim + N3_M7(i+AmountItogLine);
          AZ15 = AZ15 + delim + N3_O7(i+AmountItogLine);
          AZ21 = AZ21 + delim + N3_U7(i+AmountItogLine);
          delim = TS_IIF(AZ181 == "", "", ";");
          AZ181 = AZ181 + delim + N3_R7(i+AmountItogLine);

          PrevFIID       = RSD1.FIID;
          PrevDateSale   = SQL_ConvTypeDate(RSD1.DateSale);
          PrevDealIDSale = DealID;

          i = i + 1;
       end;

       /* итоговая строчка от последнего выпуска */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "",
                        F( FormulaSUM() + "(" + AZ5 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ7 + ")" ),
                        "", "", "",
                        F( FormulaSUM() + "(" + AZ11 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ13 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ15 + ")" ),
                        F( N3_F7(i+AmountItogLine) + "-" + N3_M7(i+AmountItogLine) ),
                        F( N3_F7(i+AmountItogLine) + "-" + N3_O7(i+AmountItogLine) ),
                        "", "", "",
                        F( FormulaSUM() + "(" + AZ21 + ")" ));

       AZ5 = ""; AZ7 = ""; AZ11 = ""; AZ13 = ""; AZ15 = ""; AZ21 = "";
       delim = TS_IIF(AZ161 == "", "", ";");
       AZ161 = AZ161 + delim + N3_P7(i+AmountItogLine);
       AmountItogLine = AmountItogLine + 1;

       /* последняя итоговая строка */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + AZ161 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + AZ181 + ")" ),
                        "", "", "" );

       AZ161 = ""; AZ181 = "";

       EndTable();

       /* печатаем шапку */
       PrintFormatString( "", "N3_D1",    F( N1_() + N1_C1(0) ),
                              "N3_H1",    F( N1_() + N1_F1(0) ),
                              "N3_AZT",   TS_IIF(m_PrevValid != NULL, "Продленный договор с", ""),
                              "N3_AZD1",  TS_IIF(m_PrevValid != NULL, m_BegValidDate, ""),
                              "N3_AZT1",  TS_IIF(m_PrevValid != NULL, "за", ""),
                              "N3_AZT2",  TS_IIF(m_PrevValid != NULL, F( N3_H1(0) + "-" + N3_C2(0) + "+1" ), ""),
                              "N3_AZT3",  TS_IIF(m_PrevValid != NULL, strdays( m_FormData.ReportDate - m_BegValidDate + 1), ""),
                              "N3_AZ1",   F( N3_P7(i+AmountItogLine) ),
                              "N3_AZ1_1", F( N3_R7(i+AmountItogLine) ) );

       CopyAllSheetInTotalBook( "Акции Закрытые", false, "N3_Table1", 0, "Акции Закрытые" );

    end;

  END;


  PRIVATE MACRO Печать_Облигации()

     record wsum(pmwrtsum);
     record fiwarnts(fiwarnts);
     var dl_leg = TRecHandler("dl_leg");
     var dlsum  = TRecHandler("dlsum");
     var AmountAllLot:integer = 0;
     var AmountPortf:integer  = 0;
     var SqlQuery, HeadSelect1, HeadSelect2, HeadSelect3, WhereFIID, FooterQuery, FooterQueryFIID, SqlQueryCom;
     var Query, RSD, Query1, RSD1, Query2, RSD2, Query3, RSD3, Query4, RSD4, Query5, RSD5, Query6, RSD6;
     var delim:string = ""; var Nominal;
     var BegPerDate:date = date(0,0,0), EndPerDate:date = date(0,0,0);
     var BeginMon:date, EndMon:date;
     var ТСС;

     HeadSelect1 = " select /*+LEADING(lot)*/ count(1) NRec ";
     HeadSelect2 = " select /*+LEADING(lot)*/ wrt.t_FIID, fi.t_Issuer, fi.t_fi_code, fi.t_FaceValueFI, fi.t_DrawingDate, paym.t_Purpose, paym.t_DocKind, paym.t_DocumentID, " +
                   "        lot.t_Date, lot.t_Time, wrt.t_Amount, wrt.t_SumID, wrt.t_Sum, lot.t_DealID DealIDBuy, lot.t_DealDate, lot.t_DealCode, " +
                   "        wrt.t_portfolio, wrt.t_balancecost, lot.t_currency, lot.t_Kind KindBuy, " +
                   "        wrt.t_NKDAmount, wrt.t_InterestIncome, fi.t_Name    ";
     HeadSelect3 = " select /*+LEADING(lot)*/ distinct fi.t_FIID, fi.t_Name ";
     SqlQuery = "   from v_scwrthistex wrt, dpmwrtsum_dbt lot, dfininstr_dbt fi,           " +
                "        dpmpaym_dbt paym                                                  " +
                "  where wrt.t_Amount > 0                                                  " +
                "    and wrt.t_instance = ( select max (hw.t_instance)                     " +
                "                             from v_scwrthist hw                          " +
                "                            where hw.t_ChangeDate <= ?                    " +
                "                              and hw.t_SumID = lot.t_SumID )              " +
                "    and lot.t_SumID    = wrt.t_SumID                                      " +
                "    and lot.t_Trust    = 'X'                                              " +
                "    and lot.t_Buy_Sale = ?                                                " +
                "    and lot.t_Contract = ?                                                " +
                "    and lot.t_State    = ?                                                " +
                "    and fi.t_FIID      = lot.t_FIID                                       " +
                "    and fi.t_FI_Kind   = ?                                                " +
                "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                "    and fi.t_FaceValueFI = ?                                              " +
                "    and paym.t_paymentid (+)= lot.t_DocID                                 ";

     WhereFIID = "   and lot.t_FIID = ? ";
     FooterQuery = " order by fi.t_FIID, lot.t_Date, lot.t_Time                            ";
     FooterQueryFIID = " order by fi.t_FIID ";

     SqlQueryCom = " select /*+LEADING(dlsum)*/ dlsum.t_Date, sum(dlsum.t_Sum) Sum  " + 
                   "   from ddlsum_dbt dlsum, ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt fi " +
                   "  where dlsum.t_Date between ? and ?        " +
                   "    and dlsum.t_Kind  = ?                   " +
                   "    and tick.t_DealID = dlsum.t_DocID       " +
                   "    and tick.t_BofficeKind in(?, ?)         " +
                   "    and tick.t_ClientContrID = ?            " +
                   "    and leg.t_DealID = tick.t_DealID        " +
                   "    and fi.t_FIID = leg.t_PFI               " +
                   "    and fi.t_FI_Kind   = ?                                                " +
                   "    and RSB_FIInstr.FI_AvrKindsGetRoot( fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
                   " group by dlsum.t_Date                      " +
                   " order by dlsum.t_Date                      ";

     MACRO КоличествоСтрокПоБумаге( FIID:integer ):integer

        var RetVal = 0;
        var Select = RSDCommand( " select count(1) NRec from ( " + HeadSelect2 + SqlQuery + WhereFIID + " ) " );
        Select.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Select.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Select.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Select.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Select.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Select.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Select.addParam("", RSDBP_IN, NATCUR                );
        Select.addParam("", RSDBP_IN, FIID                  );
        Select.execute();

        var RSDSelect = TRsbDataSet(Select);

        if( RSDSelect.MoveNext() )
           RetVal = SQL_ConvTypeInteger(RSDSelect.NRec);
        end;

        return RetVal;
     END;

     MACRO PrintLineTable1( N4_OA1, N4_OA2, N4_OA2_1, N4_OA3, N4_A4, N4_OA5, N4_OA6, N4_OA7, N4_OA8, N4_OA9, N4_OA10, N4_OA11,
                            N4_OA12, N4_OA13, N4_OA14, N4_OA15, N4_OA16, N4_OA17, N4_OA17_1, N4_OA20_1, N4_OA21, N4_OA21_1,
                            N4_OA22, N4_OA23, N4_OA24, N4_OA25, N4_OA26, N4_OA27, N4_OA28, N4_OA29 )
        PrintTableLine( "N4_OA1",    N4_OA1,    null,
                        "N4_OA2",    N4_OA2,    null,
                        "N4_OA2_1",  N4_OA2_1,  null,
                        "N4_OA3",    N4_OA3,    null,
                        "N4_A4",     N4_A4,     null,
                        "N4_OA5",    N4_OA5,    null,
                        "N4_OA6",    N4_OA6,    null,
                        "N4_OA7",    N4_OA7,    null,
                        "N4_OA8",    N4_OA8,    null,
                        "N4_OA9",    N4_OA9,    null,
                        "N4_OA10",   N4_OA10,   null,
                        "N4_OA11",   N4_OA11,   null,
                        "N4_OA12",   N4_OA12,   null,
                        "N4_OA13",   N4_OA13,   null,
                        "N4_OA14",   N4_OA14,   null,
                        "N4_OA15",   N4_OA15,   null,
                        "N4_OA16",   N4_OA16,   null,
                        "N4_OA17",   N4_OA17,   null,
                        "N4_OA17_1", N4_OA17_1, null,
                        "N4_OA20_1", N4_OA20_1, null,
                        "N4_OA21",   N4_OA21,   null,
                        "N4_OA21_1", N4_OA21_1, null,
                        "N4_OA22",   N4_OA22,   null,
                        "N4_OA23",   N4_OA23,   null,
                        "N4_OA24",   N4_OA24,   null,
                        "N4_OA25",   N4_OA25,   null,
                        "N4_OA26",   N4_OA26,   null,
                        "N4_OA27",   N4_OA27,   null,
                        "N4_OA28",   N4_OA28,   null,
                        "N4_OA29",   N4_OA29,   null);
     END;

     MACRO PrintLineTable2( N4_OB0, N4_OB1, N4_OB2, N4_OB3, N4_OB4, N4_OB5, N4_OB5_1, N4_OB6, N4_OB7, N4_OB8, N4_OB9, N4_OB10, N4_OB11,
                            N4_OB12, N4_OB13, N4_OB14, N4_OB15, N4_OB16, N4_OB17, N4_OB18, N4_OB19, N4_OB20, N4_OB21, N4_OB22, N4_OB22_1,
                            N4_OB23, N4_OB24, N4_OB25, N4_OB26, N4_OB27, N4_OB28, N4_OB29, N4_OB30, N4_OB31, N4_OB32, N4_OB33, N4_OB34,
                            N4_OB35, N4_OB36, N4_OB37, N4_OB38, N4_OB39, N4_OB40 )
        PrintTableLine( "N4_OB0",    N4_OB0,    null,
                        "N4_OB1",    N4_OB1,    null,
                        "N4_OB2",    N4_OB2,    null,
                        "N4_OB3",    N4_OB3,    null,
                        "N4_OB4",    N4_OB4,    null,
                        "N4_OB5",    N4_OB5,    null,
                        "N4_OB5_1",  N4_OB5_1,  null,
                        "N4_OB6",    N4_OB6,    null,
                        "N4_OB7",    N4_OB7,    null,
                        "N4_OB8",    N4_OB8,    null,
                        "N4_OB9",    N4_OB9,    null,
                        "N4_OB10",   N4_OB10,   null,
                        "N4_OB11",   N4_OB11,   null,
                        "N4_OB12",   N4_OB12,   null,
                        "N4_OB13",   N4_OB13,   null,
                        "N4_OB14",   N4_OB14,   null,
                        "N4_OB15",   N4_OB15,   null,
                        "N4_OB16",   N4_OB16,   null,
                        "N4_OB17",   N4_OB17,   null,
                        "N4_OB18",   N4_OB18,   null,
                        "N4_OB19",   N4_OB19,   null,
                        "N4_OB20",   N4_OB20,   null,
                        "N4_OB21",   N4_OB21,   null,
                        "N4_OB22",   N4_OB22,   null,
                        "N4_OB22_1", N4_OB22_1, null,
                        "N4_OB23",   N4_OB23,   null,
                        "N4_OB24",   N4_OB24,   null,
                        "N4_OB25",   N4_OB25,   null,
                        "N4_OB26",   N4_OB26,   null,
                        "N4_OB27",   N4_OB27,   null,
                        "N4_OB28",   N4_OB28,   null,
                        "N4_OB29",   N4_OB29,   null,
                        "N4_OB30",   N4_OB30,   null,
                        "N4_OB31",   N4_OB31,   null,
                        "N4_OB32",   N4_OB32,   null,
                        "N4_OB33",   N4_OB33,   null,
                        "N4_OB34",   N4_OB34,   null,
                        "N4_OB35",   N4_OB35,   null,
                        "N4_OB36",   N4_OB36,   null,
                        "N4_OB37",   N4_OB37,   null,
                        "N4_OB38",   N4_OB38,   null,
                        "N4_OB39",   N4_OB39,   null,
                        "N4_OB40",   N4_OB40,   null);
     END;

     MACRO PrintLineTable3( N4_OC1, N4_OC2, N4_OC3, N4_OC4 )
        PrintTableLine( "N4_OC1", N4_OC1, null,
                        "N4_OC2", N4_OC2, null,
                        "N4_OC3", N4_OC3, null,
                        "N4_OC4", N4_OC4, null);
     END;

     MACRO PrintLineTable4( N4_OD1_, N4_OD2_ )
        PrintTableLine( "N4_OD1_", N4_OD1_, null,
                        "N4_OD2_", N4_OD2_, null);
     END;

     Query = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
     Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
     Query.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
     Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
     Query.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
     Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
     Query.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
     Query.addParam("", RSDBP_IN, NATCUR                );
     Query.execute();

     RSD = TRsbDataSet(Query);

     if( RSD.MoveNext() )
        AmountAllLot = SQL_ConvTypeInteger(RSD.NRec); /* количество строк в таблице "Сделки приобретения" */
     end;

     if( AmountAllLot > 0 )

        if( m_SheetN4 == false )
           UseNewSheetInTotalBook();
           m_SheetN4 = true;
        end;
        SetActiveSheet( "Облигации" );

        m_PrintOrderN4 = true;

        Query1 = RSDCommand( " select count(1) NRec from ( " + HeadSelect3 + SqlQuery + " ) " );
        Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query1.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query1.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query1.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query1.addParam("", RSDBP_IN, NATCUR                );
        Query1.execute();

        RSD1 = TRsbDataSet(Query1);

        if( RSD1.MoveNext() )
           AmountPortf = SQL_ConvTypeInteger(RSD1.NRec); /* количество строк в таблице "портфель" */
        end;

        var DeltaPortfItog = AmountPortf;

        PrintFormatString( "", "N4_C2",   F( N1_() + N1_C1(0) ),
                               "N4_G2",   F( N1_() + N1_F1(0) ),
                               "N4_OT",   TS_IIF(m_PrevValid != NULL, "Продленный договор с", ""),
                               "N4_OD1",  TS_IIF(m_PrevValid != NULL, m_BegValidDate, ""),
                               "N4_OT1",  TS_IIF(m_PrevValid != NULL, "за", ""),
                               "N4_OT2",  TS_IIF(m_PrevValid != NULL, F( N4_G2(0) + "-" + N4_C3(0) + "+1" ), ""),
                               "N4_OT3",  TS_IIF(m_PrevValid != NULL, strdays( m_FormData.ReportDate - m_BegValidDate + 1), ""),
                               "N4_OA18", F( N4_P9(DeltaPortfItog) + "/" + N4_T9(DeltaPortfItog) + "*" + N8_() + N8_A9(0) + "*100" ),
                               "N4_L5",   TS_IIF(m_PrintOrderN5, F( N5_() + N5_Q3(0) ), 0.0),
                               "N4_OA20", F( "(" + N4_P9(DeltaPortfItog) + "+" + N4_L5(0) + ")/(" + N8_() + N8_A7(0) + "+" + N4_T9(DeltaPortfItog) + "+" + TS_IIF(m_PrintOrderN5, N5_() + N5_Q4(0), "0") + ")*" + N8_() + N8_A9(0) + "*100" ) );

        GL_OA19 = N4_L5(0);
        GL_OA20 = N4_L6(0);

        /* печатем таблицу "портфель" */
        Query2 = RSDCommand( HeadSelect3 + SqlQuery + FooterQueryFIID );
        Query2.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query2.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query2.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query2.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query2.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query2.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query2.addParam("", RSDBP_IN, NATCUR                );
        Query2.execute();

        RSD2 = TRsbDataSet(Query2);

        RegisterTable( "N4_MainTable_1", "",
                       "N4_OA1", "N4_OA2", "N4_OA2_1", "N4_OA3", "N4_A4", "N4_OA5", "N4_OA6", "N4_OA7", "N4_OA8",
                       "N4_OA9", "N4_OA10", "N4_OA11", "N4_OA12", "N4_OA13", "N4_OA14", "N4_OA15", "N4_OA16",
                       "N4_OA17", "N4_OA17_1", "N4_OA20_1", "N4_OA21", "N4_OA21_1", "N4_OA22", "N4_OA23", "N4_OA24",
                       "N4_OA25", "N4_OA26", "N4_OA27", "N4_OA28", "N4_OA29" );

        var DeltaDealItog = DeltaPortfItog - 1;

        var i = 0;
        var FOA2 = "", FOA3 = "", FA4 = "", FOA7 = "", FOA8 = "", FOA9 = "", FOA10 = "", FOA11 = "", FOA12 = "", FOA13 = "", FOA14 = "", FOA15 = "", FOA17_1 = "", FOA20_1 = "", FOA21 = "", FOA21_1 = "", FOA22 = "", FOA23 = "", FOA24 = "", FOA25 = "", FOA26 = "";

        while( RSD2.MoveNext() )

           var МассивOB22:string = "";
           var СтрокПоБумаге = КоличествоСтрокПоБумаге(RSD2.FIID);
           DeltaDealItog = DeltaDealItog + СтрокПоБумаге + TS_IIF(i == 0, 0, 1); /* итоговая строка по данной бумаге в таблице "Сделки приобретения" */

           var j = СтрокПоБумаге;
           while( j > 0 )
              if( j == СтрокПоБумаге )
                 МассивOB22 = N4_X13(DeltaDealItog - СтрокПоБумаге);
              else
                 МассивOB22 = МассивOB22 + ";" + N4_X13(DeltaDealItog - СтрокПоБумаге);
              end;
              j = j - 1;
           end;

           Nominal = TS_GetFaceValue(RSD2.FIID, m_FormData.ReportDate);
           var БылоПогашение = БылоПогашениеКупона(RSD2.FIID, m_BegDate, m_FormData.ReportDate);

           var N4_OA6;
           if( Nominal != 0.0 )
              ТСС = ПолучитьТСС(RSD2.FIID, NATCUR, m_FormData.ReportDate - 1);
              if( ТСС > 0 )
                 N4_OA6 = ТСС / Nominal;
              else
                 N4_OA6 = F( N4_H13(DeltaDealItog) + "/" + N4_B9(i) + "/" + N4_C9(i) );
              end;
           else
              N4_OA6 = 0.0;
           end;

           PrintLineTable1( RSD2.Name,
                            F( N4_F13(DeltaDealItog) ),
                            Nominal,
                            F( N4_H13(DeltaDealItog) ),
                            F( N4_D9(i) + "+" + N4_J9(i) ),
                            F( N4_D9(i) + "/" + N4_B9(i) + "/" + N4_C9(i) + "*100" ),
                            N4_OA6,
                            F( N4_W13(DeltaDealItog) ),
                            F( N4_Q13(DeltaDealItog) ),
                            F( N4_J13(DeltaDealItog) ),
                            F( N4_H9(i) + "+" + N4_I9(i) + "-" + N4_M9(i) ),
                            F( N4_L13(DeltaDealItog) ),
                            F( N4_G9(i) + "/100*" + N4_B9(i) + "*" + N4_C9(i) + "*" + N8_() + N8_A11(0) ),
                            F( N4_O13(DeltaDealItog) ),
                            F( N4_I9(i) + "-" + N4_J9(i) + "+" + N4_N9(i) ),
                            F( N4_K9(i) + "-" + N4_D9(i) + "-" + N4_J9(i) + "+" + N4_N9(i) + "-" + N4_L9(i) ),
                            F( FormulaMAX() + "(" + МассивOB22 + ")" ),
                            F( N4_P9(i) + "/" + N4_T9(i) + "*" + N8_() + N8_A9(0) + "*100" ),
                            F( TS_IIF(БылоПогашение, N4_D9(i), N4_D9(i) + "+" + N4_J9(i)) ),
                            F( N4_Y13(DeltaDealItog) ),
                            F( N4_Z13(DeltaDealItog) ),
                            F( TS_IIF(БылоПогашение, N4_D9(i) + "-" + N4_J9(i), 0.0) ),
                            F( N4_AB13(DeltaDealItog) ),
                            F( N4_AC13(DeltaDealItog) ),
                            F( N4_AD13(DeltaDealItog) ),
                            F( N4_W9(i) + "-" + N4_D9(i) ),
                            F( N4_AN13(DeltaDealItog) ),
                            F( N4_AA9(i) + "/" + N4_B9(i) + "/" + N4_C9(i) + "*100" ),
                            F( N4_AO13(DeltaDealItog) ),
                            F( N4_AP13(DeltaDealItog) ) );

           delim = TS_IIF(i == 0, "", ";");

           FOA2    = FOA2    + delim + N4_B9(i);
           FOA3    = FOA3    + delim + N4_D9(i);
           FA4     = FA4     + delim + N4_E9(i);
           FOA7    = FOA7    + delim + N4_H9(i);
           FOA8    = FOA8    + delim + N4_I9(i);
           FOA9    = FOA9    + delim + N4_J9(i);
           FOA10   = FOA10   + delim + N4_K9(i);
           FOA11   = FOA11   + delim + N4_L9(i);
           FOA12   = FOA12   + delim + N4_M9(i);
           FOA13   = FOA13   + delim + N4_N9(i);
           FOA14   = FOA14   + delim + N4_O9(i);
           FOA15   = FOA15   + delim + N4_P9(i);
           FOA17_1 = FOA17_1 + delim + N4_S9(i);
           FOA20_1 = FOA20_1 + delim + N4_T9(i);
           FOA21   = FOA21   + delim + N4_U9(i);
           FOA21_1 = FOA21_1 + delim + N4_V9(i);
           FOA22   = FOA22   + delim + N4_W9(i);
           FOA23   = FOA23   + delim + N4_X9(i);
           FOA24   = FOA24   + delim + N4_Y9(i);
           FOA25   = FOA25   + delim + N4_Z9(i);
           FOA26   = FOA26   + delim + N4_AA9(i);

           i = i + 1;
        end;

        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable1( "ИТОГО:",
                         F( FormulaSUM() + "(" + FOA2 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOA3 + ")" ),
                         F( FormulaSUM() + "(" + FA4 + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOA7 + ")" ),
                         F( FormulaSUM() + "(" + FOA8 + ")" ),
                         F( FormulaSUM() + "(" + FOA9 + ")" ),
                         F( FormulaSUM() + "(" + FOA10 + ")" ),
                         F( FormulaSUM() + "(" + FOA11 + ")" ),
                         F( FormulaSUM() + "(" + FOA12 + ")" ),
                         F( FormulaSUM() + "(" + FOA13 + ")" ),
                         F( FormulaSUM() + "(" + FOA14 + ")" ),
                         F( FormulaSUM() + "(" + FOA15 + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOA17_1 + ")" ),
                         F( FormulaSUM() + "(" + FOA20_1 + ")" ),
                         F( FormulaSUM() + "(" + FOA21 + ")" ),
                         F( FormulaSUM() + "(" + FOA21_1 + ")" ),
                         F( FormulaSUM() + "(" + FOA22 + ")" ),
                         F( FormulaSUM() + "(" + FOA23 + ")" ),
                         F( FormulaSUM() + "(" + FOA24 + ")" ),
                         F( FormulaSUM() + "(" + FOA25 + ")" ),
                         F( FormulaSUM() + "(" + FOA26 + ")" ),
                         "", "", "" );

        GL_FOA11   = N4_L9(i);
        GL_FOA15   = N4_P9(i);
        GL_FOA17_1 = N4_S9(i);
        GL_FOA24   = N4_Y9(i);
        GL_FOA21_1 = N4_V9(i);

        EndTable();
        CopyAllSheetInTotalBook( "Облигации", false, "N4_Table1", 0, "Облигации" );

        /* печатем таблицу "Сделки приобретения" */

        var DeltaDeal = DeltaPortfItog - 1;

        Query3 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
        Query3.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query3.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query3.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query3.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query3.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query3.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query3.addParam("", RSDBP_IN, NATCUR                );
        Query3.execute();

        RSD3 = TRsbDataSet(Query3);

        RegisterTable( "N4_MainTable_2", "",
                       "N4_OB0", "N4_OB1", "N4_OB2", "N4_OB3", "N4_OB4", "N4_OB5", "N4_OB5_1", "N4_OB6", "N4_OB7", "N4_OB8", "N4_OB9",
                       "N4_OB10", "N4_OB11", "N4_OB12", "N4_OB13", "N4_OB14", "N4_OB15", "N4_OB16", "N4_OB17", "N4_OB18", "N4_OB19", "N4_OB20",
                       "N4_OB21", "N4_OB22", "N4_OB22_1", "N4_OB23", "N4_OB24", "N4_OB25", "N4_OB26", "N4_OB27", "N4_OB28", "N4_OB29",
                       "N4_OB30", "N4_OB31", "N4_OB32", "N4_OB33", "N4_OB34", "N4_OB35", "N4_OB36", "N4_OB37", "N4_OB38", "N4_OB39", "N4_OB40" );

        i = 0;
        var k = 0; /* количество итоговых строк */
        var m = 0; /* счётчик строк в таблице "Начисленный доход" вместе с итогами */
        var PrevFIID = 0;
        var FOB5 = "", FOB6 = "", FOB8 = "", FOB10 = "", FOB13 = "", FOB15 = "", FOB21 = "", FOB22_1 = "", FOB23 = "",
            FOB25 = "", FOB26 = "", FOB27 = "", FOB29 = "", FOB32 = "", FOB33 = "", FOB34 = "", FOB37 = "", FOB38 = "", FOB39 = "";

        while( RSD3.MoveNext() )

           if( (PrevFIID != RSD3.FIID) and (i != 0) )
              /* печатаем итог по выпуску */
              SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
              PrintLineTable2( "", "", "", "", "",
                               F( FormulaSUM() + "(" + FOB5 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB6 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB8 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB10 + ")" ),
                               "", "",
                               F( FormulaSUM() + "(" + FOB13 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB15 + ")" ),
                               "", "", "", "", "",
                               F( FormulaSUM() + "(" + FOB21 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB22_1 + ")" ),
                               F( FormulaSUM() + "(" + FOB23 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB25 + ")" ),
                               F( FormulaSUM() + "(" + FOB26 + ")" ),
                               F( FormulaSUM() + "(" + FOB27 + ")" ),
                               "",
                               F( FormulaSUM() + "(" + FOB29 + ")" ),
                               "", "",
                               F( FormulaSUM() + "(" + FOB32 + ")" ),
                               F( FormulaSUM() + "(" + FOB33 + ")" ),
                               F( FormulaSUM() + "(" + FOB34 + ")" ),
                               "", "",
                               F( FormulaSUM() + "(" + FOB37 + ")" ),
                               F( FormulaSUM() + "(" + FOB38 + ")" ),
                               F( FormulaSUM() + "(" + FOB39 + ")" ),
                               "" );

              FOB5 = FOB6 = FOB8 = FOB10 = FOB13 = FOB15 = FOB21 = FOB22_1 = FOB23 = FOB25 = FOB26 = FOB27 = FOB29 = FOB32 = FOB33 = FOB34 = FOB37 = FOB38 = FOB39 = "";
              k = k + 1;
           end;

           var InPeriod = (RSD3.Date >= m_BegDate); /* Дата поставки входит в отчётный период? */
           var InCap = ( (RSD3.KindBuy == 340) and (RSD3.DocKind == TS_DOC_DECLAR) ); /* операции внесения капитала */

           /* Номер сделки */
           var DealCode;
           if( InCap )
              DealCode = ПолучитьНомерОперацииВВК(RSD3.DocumentID);
           else
              DealCode = RSD3.DealCode;
           end;

           Nominal = TS_GetFaceValue(RSD3.FIID, SQL_ConvTypeDate(RSD3.Date));

           var N4_OB4  = $0.0; /* Цена */
           var N4_OB36 = $0.0; /* _Цена покупки */
           if( InPeriod )
              N4_OB4 = ЦенаПокупки(RSD3, Nominal);
           else
              N4_OB36 = ЦенаПокупки(RSD3, Nominal);
          
              if( WRTGetRestoreLotOnDate(RSD3.SumID, m_BegValidDate - 1, wsum) == true )
                 if( (wsum.Amount != 0.0) and (Nominal != 0.0) )
                    N4_OB4 = ((wsum.BalanceCost - wsum.NKDAmount - wsum.InterestIncome) / wsum.Amount) * 100.0 / Nominal;
                 end;
              end;
           end;

           var N4_OB10 = $0.0; /* Комиссия брокера и биржи */
           if( InCap == false)
              FindDL_LEG( TS_IIF(RSD3.Purpose == BRi, LEG_KIND_DL_TICK_BACK, LEG_KIND_DL_TICK), RSD3.DealIDBuy, 0, dl_leg );
              if( dl_leg.rec.Principal != 0.0 )
                 if( FindDLSUM( RSD3.DocKind, RSD3.DealIDBuy, DLSUM_KIND_AGENT_PERIOD, RSD3.DealDate, dlsum ) == 0)
                    N4_OB10 = N4_OB10 + dlsum.rec.Sum;
                 end;
                 if( FindDLSUM( RSD3.DocKind, RSD3.DealIDBuy, DLSUM_KIND_AGENT_ONCE, RSD3.DealDate, dlsum ) == 0)
                    N4_OB10 = N4_OB10 + dlsum.rec.Sum;
                 end;
                 if( FindDLSUM( RSD3.DocKind, RSD3.DealIDBuy, DLSUM_KIND_AGENT_ONCE_IMPORT, RSD3.DealDate, dlsum ) == 0)
                    N4_OB10 = N4_OB10 + dlsum.rec.Sum;
                 end;
                 N4_OB10 = N4_OB10 * RSD3.Amount / dl_leg.rec.Principal;
              end;
           end;

           var ДатаПогашенияТекущегоКупона:date = date(0,0,0);
           var CтавкаНКД:money = $0.0;
           if(FI_GetCouponOnDate(RSD3.FIID, m_FormData.ReportDate, fiwarnts) == 0)
              ДатаПогашенияТекущегоКупона = fiwarnts.DrawingDate;
              CтавкаНКД = fiwarnts_GetIncomePercent(fiwarnts, Nominal);
           end;

           var НКДПолученныйПриПогашении:money = $0.0;
           if( (InCap == true) or (ПрибыльЗаПериод() < 0.0) )
              НКДПолученныйПриПогашении = TS_GetCouponSumByPeriod( SQL_ConvTypeInteger(RSD3.FIID), SQL_ConvTypeSum(RSD3.Amount), SQL_ConvTypeDate(RSD3.Date), m_FormData.ReportDate, "", null, null, null, null );
           end;

           var _ПДНачисленныйДоПролонгации:money = $0.0;
           if( InPeriod == false )
              _ПДНачисленныйДоПролонгации = ПДЗаПериод(RSD3.SumID, max(SQL_ConvTypeDate(RSD3.Date), ПоследнееПогашениеКупонаЗаПериод(RSD3.FIID, SQL_ConvTypeDate(RSD3.Date), m_BegDate)), m_BegDate);
           end;

           if( InPeriod )
              BegPerDate = max(SQL_ConvTypeDate(RSD3.Date), ПоследнееПогашениеКупонаЗаПериод(RSD3.FIID, m_BegDate, m_FormData.ReportDate));
              EndPerDate = m_FormData.ReportDate;
           else
              BegPerDate = max(m_BegDate, ПоследнееПогашениеКупонаЗаПериод(RSD3.FIID, m_BegDate, m_FormData.ReportDate));
              EndPerDate = m_FormData.ReportDate;
           end;
           var Период_ = ПериодПоМесяцам(BegPerDate, EndPerDate);
           var FOC5 = "";
           var ExStr = false;

           while( Период_.СледующийМесяц(null, @BeginMon, @EndMon) )
              if( ПДЗаПериод(RSD3.SumID, BeginMon, EndMon, RSD3.Amount) > 0.0 )
                 m = m + 1;
                 ExStr = true;
              end;
           end;
           if( ExStr )
              FOC5 = N4_D18(DeltaDeal + AmountAllLot + AmountPortf - 2 + m);
              m = m + 1;
           end;

           var OB7:money = $0.0;
           var FirstLot;
           if( GetLotFirstInstance(RSD3.SumID, @FirstLot) )
              if( FirstLot.Amount != 0.0 )
                 OB7 = FirstLot.NKDAmount / FirstLot.Amount;
              end;
           end;

           var N4_OB24:money = 0.0;
           if( Nominal != 0.0 )
              N4_OB24 = ЦенаПоБалансу( RSD3.SumID, RSD3.FIID, RSD3.FaceValueFI, m_FormData.ReportDate ) * 100.0 / Nominal;
           end;

           var N4_OB9;
           if( Nominal != 0.0 )
              ТСС = ПолучитьТСС(RSD3.FIID, NATCUR, m_FormData.ReportDate - 1);
              if( ТСС > 0 )
                 N4_OB9 = ТСС * 100 / Nominal;
              else
                 N4_OB9 = F( N4_E13(DeltaDeal+i+k) );
              end;
           else
              N4_OB9 = 0.0;
           end;

           PrintLineTable2( DealCode,
                            TS_IIF(InPeriod, SQL_ConvTypeDate(RSD3.Date), m_BegValidDate - 1),
                            SQL_ConvTypeTime(RSD3.Time),
                            RSD3.Name,
                            N4_OB4,
                            RSD3.Amount,
                            Nominal,
                            F( N4_F13(DeltaDeal+i+k) + "*" + N4_G13(DeltaDeal+i+k) + "*" + N4_E13(DeltaDeal+i+k) + "/100" ),
                            OB7,
                            TS_IIF(InPeriod, F( N4_I13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) ), F( N4_AO13(DeltaDeal+i+k) + "+" + N4_AP13(DeltaDeal+i+k) + "+" + N4_AQ13(DeltaDeal+i+k) )),
                            N4_OB9,
                            N4_OB10,
                            F( N4_N13(DeltaDeal+i+k) + "-" + N4_S13(DeltaDeal+i+k) ),
                            ДатаПогашенияТекущегоКупона,
                            НКДПолученныйПриПогашении,
                            CтавкаНКД,
                            F( N4_U13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) ),
                            ВесьKупон(fiwarnts),
                            (fiwarnts.DrawingDate - fiwarnts.FirstDate) + 1/* даты начала и конца включаются*/,
                            F( N4_R13(DeltaDeal+i+k) + "/" + N4_S13(DeltaDeal+i+k) ),
                            НКДНаДатуРасчета(RSD3.FIID, m_FormData.ReportDate),
                            F( FormulaIF() + "(" + N4_O13(DeltaDeal+i+k) + "=0;" + N4_O13(DeltaDeal+i+k) + "+" + N4_Q13(DeltaDeal+i+k) + "-" + N4_J13(DeltaDeal+i+k) + ";" + N4_Q13(DeltaDeal+i+k) + ")" ),
                            F( N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "*" + N4_K13(DeltaDeal+i+k) + "/100" ),
                            F( N4_G2(0) + "-" + N4_B13(DeltaDeal+i+k) ),
                            F( N4_X13(DeltaDeal+i+k) + "*(" + N4_H13(DeltaDeal+i+k) + "+" + N4_J13(DeltaDeal+i+k) + ")" ),
                            TS_IIF(БылоПогашениеКупона(RSD3.FIID, m_BegDate, m_FormData.ReportDate), 0.0, F( N4_J13(DeltaDeal+i+k) ) ),
                            N4_OB24,
                            F( N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "*" + N4_AA13(DeltaDeal+i+k) + "/100" ),
                            F( N4_Q13(DeltaDeal+i+k) + "-" + N4_AD13(DeltaDeal+i+k) ),
                            TS_IIF(ExStr, F( FOC5 ), 0.0),
                            F( N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) ),
                            F( FormulaMAX() + "(0;" + N4_G13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) + "-" + N4_H13(DeltaDeal+i+k) + ")" ),
                            SQL_ConvTypeDate(RSD3.DrawingDate),
                            F( N4_AG13(DeltaDeal+i+k) + "-" + N4_B13(DeltaDeal+i+k) ),
                            F( N4_AF13(DeltaDeal+i+k) + "/" + N4_AH13(DeltaDeal+i+k) ),
                            F( N4_AI13(DeltaDeal+i+k) + "*" + N4_X13(DeltaDeal+i+k) ),
                            F( N4_AB13(DeltaDeal+i+k) + "-" + N4_H13(DeltaDeal+i+k) + "-" + N4_AJ13(DeltaDeal+i+k) ),
                            TS_IIF(InPeriod, "", RSD3.Date),
                            TS_IIF(InPeriod, "", N4_OB36),
                            TS_IIF(InPeriod, "", F( N4_F13(DeltaDeal+i+k) + "*" + N4_G13(DeltaDeal+i+k) + "*" + N4_AM13(DeltaDeal+i+k) + "/100" )),
                            TS_IIF(InPeriod, "", F( N4_I13(DeltaDeal+i+k) + "*" + N4_F13(DeltaDeal+i+k) )),
                            TS_IIF(InPeriod, "", TS_GetCouponSumByPeriod( SQL_ConvTypeInteger(RSD3.FIID), SQL_ConvTypeSum(RSD3.Amount), SQL_ConvTypeDate(RSD3.Date), m_BegDate, "", null, null, null, null )),
                            TS_IIF(InPeriod, "", _ПДНачисленныйДоПролонгации) );

           delim = TS_IIF(FOB5 == "", "", ";");
           FOB5    = FOB5    + delim + N4_F13(DeltaDeal+i+k);
           FOB6    = FOB6    + delim + N4_H13(DeltaDeal+i+k);
           FOB8    = FOB8    + delim + N4_J13(DeltaDeal+i+k);
           FOB10   = FOB10   + delim + N4_L13(DeltaDeal+i+k);
           FOB13   = FOB13   + delim + N4_O13(DeltaDeal+i+k);
           FOB15   = FOB15   + delim + N4_Q13(DeltaDeal+i+k);
           FOB21   = FOB21   + delim + N4_W13(DeltaDeal+i+k);
           FOB22_1 = FOB22_1 + delim + N4_Y13(DeltaDeal+i+k);
           FOB23   = FOB23   + delim + N4_Z13(DeltaDeal+i+k);
           FOB25   = FOB25   + delim + N4_AB13(DeltaDeal+i+k);
           FOB26   = FOB26   + delim + N4_AC13(DeltaDeal+i+k);
           FOB27   = FOB27   + delim + N4_AD13(DeltaDeal+i+k);
           FOB29   = FOB29   + delim + N4_AF13(DeltaDeal+i+k);
           FOB32   = FOB32   + delim + N4_AI13(DeltaDeal+i+k);
           FOB33   = FOB33   + delim + N4_AJ13(DeltaDeal+i+k);
           FOB34   = FOB34   + delim + N4_AK13(DeltaDeal+i+k);
           FOB37   = FOB37   + delim + N4_AN13(DeltaDeal+i+k);
           FOB38   = FOB38   + delim + N4_AO13(DeltaDeal+i+k);
           FOB39   = FOB39   + delim + N4_AP13(DeltaDeal+i+k);

           PrevFIID = RSD3.FIID;

           i = i + 1;
        end;

        /* печатаем итог по последнему выпуску */
        SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
        PrintLineTable2( "", "", "", "", "",
                         F( FormulaSUM() + "(" + FOB5 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB6 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB8 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB10 + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOB13 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB15 + ")" ),
                         "", "", "", "", "",
                         F( FormulaSUM() + "(" + FOB21 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB22_1 + ")" ),
                         F( FormulaSUM() + "(" + FOB23 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB25 + ")" ),
                         F( FormulaSUM() + "(" + FOB26 + ")" ),
                         F( FormulaSUM() + "(" + FOB27 + ")" ),
                         "",
                         F( FormulaSUM() + "(" + FOB29 + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOB32 + ")" ),
                         F( FormulaSUM() + "(" + FOB33 + ")" ),
                         F( FormulaSUM() + "(" + FOB34 + ")" ),
                         "", "",
                         F( FormulaSUM() + "(" + FOB37 + ")" ),
                         F( FormulaSUM() + "(" + FOB38 + ")" ),
                         F( FormulaSUM() + "(" + FOB39 + ")" ),
                         "" );
        FOB5 = FOB6 = FOB8 = FOB10 = FOB13 = FOB15 = FOB21 = FOB22_1 = FOB23 = FOB25 = FOB26 = FOB27 = FOB29 = FOB32 = FOB33 = FOB34 = FOB37 = FOB38 = FOB39 = "";

        EndTable();
        CopyAllSheetInTotalBook( "Облигации", false, "N4_Table2", 0, "Облигации" );

        /* печатем таблицу "Начисленный доход" */

        Query6 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
        Query6.addParam("", RSDBP_IN, m_FormData.ReportDate );
        Query6.addParam("", RSDBP_IN, PM_WRITEOFF_SUM_BUY   );
        Query6.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query6.addParam("", RSDBP_IN, PM_WRTSUM_FORM        );
        Query6.addParam("", RSDBP_IN, FIKIND_AVOIRISS       );
        Query6.addParam("", RSDBP_IN, AVOIRISSKIND_BOND     );
        Query6.addParam("", RSDBP_IN, NATCUR                );
        Query6.execute();

        RSD6 = TRsbDataSet(Query6);

        var DeltaPD = DeltaDeal + i + k - 1;
        var RegTable = false;

        i = 0; /* количество строк в таблице "Начисленный доход" вместе с итогами */
        while( RSD6.MoveNext() )

           /* Номер сделки */
           var Code;
           if( (RSD6.KindBuy == 340) and (RSD6.DocKind == TS_DOC_DECLAR) )
              Code = ПолучитьНомерОперацииВВК(RSD6.DocumentID);
           else
              Code = RSD6.DealCode;
           end;

           if( RSD6.Date >= m_BegDate )
              BegPerDate = max(SQL_ConvTypeDate(RSD6.Date), ПоследнееПогашениеКупонаЗаПериод(RSD6.FIID, m_BegDate, m_FormData.ReportDate));
              EndPerDate = m_FormData.ReportDate;
           else
              BegPerDate = max(m_BegDate, ПоследнееПогашениеКупонаЗаПериод(RSD6.FIID, m_BegDate, m_FormData.ReportDate));
              EndPerDate = m_FormData.ReportDate;
           end;

           var Период = ПериодПоМесяцам(BegPerDate, EndPerDate);
           var Name:string;
           var FOC4 = "";

           while( Период.СледующийМесяц(@Name, @BeginMon, @EndMon) )
              var ПД = ПДЗаПериод(RSD6.SumID, BeginMon, EndMon, RSD6.Amount);
              if( ПД > 0.0 )
                 if( RegTable == false )
                    RegisterTable( "N4_MainTable_3", "", "N4_OC1", "N4_OC2", "N4_OC3", "N4_OC4" );
                    RegTable = true;
                 end;

                 PrintLineTable3(Code, RSD6.Name, Name, ПД);

                 delim = TS_IIF(FOC4 == "", "", ";");
                 FOC4 = FOC4 + delim + N4_D18(DeltaPD + i);
                 i = i + 1;
              end;
           end;

           if( FOC4 != "")
              SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
              PrintLineTable3( "ИТОГО:", "", "", F( FormulaSUM() + "(" + FOC4 + ")" ) );
              i = i + 1;
           end;

        end;

        if( RegTable )
           EndTable();
           CopyAllSheetInTotalBook( "Облигации", false, "N4_Table3", 0, "Облигации" );
        end;

        /* печатем таблицу "Комиссии" */
        
        Query4 = RSDCommand( " select count(1) NRec from ( " + SqlQueryCom + " ) " );
        Query4.addParam("", RSDBP_IN, m_BegDate                       );
        Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
        Query4.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
        Query4.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
        Query4.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
        Query4.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
        Query4.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
        Query4.addParam("", RSDBP_IN, AVOIRISSKIND_BOND               );
        Query4.execute();

        RSD4 = TRsbDataSet(Query4);

        var ExistsCom:integer = 0;
        if( RSD4.MoveNext() )
           ExistsCom = SQL_ConvTypeInteger(RSD4.NRec);
        end;

        if( ExistsCom > 0 )

           var DeltaCom = DeltaPD + i - 5;
           if(RegTable)
              DeltaCom = DeltaCom + 3;
           end;

           RegisterTable( "N4_MainTable_4", "", "N2_AC1", "N2_AC2" );

           Query5 = RSDCommand( SqlQueryCom );
           Query5.addParam("", RSDBP_IN, m_BegDate                       );
           Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
           Query5.addParam("", RSDBP_IN, DLSUM_KIND_AGENT_ONCE_IMPORT    );
           Query5.addParam("", RSDBP_IN, DL_TRUSTDOC                     );
           Query5.addParam("", RSDBP_IN, DL_TRUSTAVRWRT                  );
           Query5.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
           Query5.addParam("", RSDBP_IN, FIKIND_AVOIRISS                 );
           Query5.addParam("", RSDBP_IN, AVOIRISSKIND_BOND               );
           Query5.execute();

           RSD5 = TRsbDataSet(Query5);

           i = 0;
           var FOD2_ = "";
           while( RSD5.MoveNext() )

              PrintLineTable4( SQL_ConvTypeDate(RSD5.Date), RSD5.Sum );

              delim = TS_IIF(FOD2_ == "", "", ";");
              FOD2_ = FOD2_ + delim + N4_B23(DeltaCom + i);

              i = i + 1;
           end;

           SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
           PrintLineTable3( "ИТОГО:", F( FormulaSUM() + "(" + FOD2_ + ")" ) );

           GL_FOD2 = N4_B23(DeltaCom + i);

           EndTable();
           CopyAllSheetInTotalBook( "Облигации", false, "N4_Table4", 0, "Облигации" );

        end;

     end;

  END;


  PRIVATE MACRO Печать_ОблигацииЗакрытые()

    var OZ_ExistsLNK:integer = 0;
    record wsum(pmwrtsum);
    var SqlQueryHead1, SqlQueryHead2, SqlQuery;
    var Query, RSD, Query1, RSD1;
    var delim:string = "";

    SqlQueryHead1 = " select /*+LEADING(lnk)*/ lnk.t_Amount, wrtsale.t_DealCode DealCodeSale, wrtsale.t_DealID DealIDSale, wrtbuy.t_DealID DealIDBuy, paym.t_Purpose, paym.t_DocKind, paym.t_DocumentID, " +
                    "        wrtsale.t_Date DateSale, wrtsale.t_Time TimeSale, wrtbuy.t_Date DateBuy, wrtbuy.t_Time TimeBuy," +
                    "        wrtsale.t_Buy_Sale Buy_Sale, wrtsale.t_Kind KindSale, wrtbuy.t_Kind KindBuy, lnk.t_SumSale,   " +
                    "        wrtsale.t_Currency SaleCur, wrtbuy.t_Currency BuyCur, fi.t_FaceValueFI, lnk.t_BalanceCostBuy, " +
                    "        lnk.t_SumBuy, wrtbuy.t_SumID BuySumID, wrtsale.t_SumID SaleSumID,                             " +
                    "        lnk.t_NKDBuyAmount, lnk.t_InterestIncomeBuy, lnk.t_CostSale, lnk.t_CostBuy,                   " +
                    "        lnk.t_Partly, lnk.t_Coupon, lnk.t_NKDSaleAmount, lnk.t_NKDBuyAmount,                          " +
                    "        lnk.t_InterestIncomeAdd, fi.t_Name, fi.t_FIID,                                                " +
                    "        (case when (lnk.t_Partly != chr(0))                                                           " +
                    "        then (RSB_FIInstr.FI_GetPartialPersentByName(fi.t_FIID,lnk.t_Partly)) else 0 end) PartlyPc    ";
    SqlQueryHead2 = " select /*+LEADING(lnk)*/ count(1) NRec ";
    SqlQuery = "   from dpmwrtlnk_dbt lnk, dpmwrtsum_dbt wrtsale, dpmwrtsum_dbt wrtbuy, dfininstr_dbt fi, " +
               "        dpmpaym_dbt paym                                                 " +
               "  where lnk.t_SaleID       = wrtsale.t_SumID                             " +
               "    and lnk.t_BuyID        = wrtbuy.t_SumID                              " +
               "    and wrtbuy.t_Trust     = 'X'                                         " +
               "    and wrtsale.t_fiid     = fi.t_fiid                                   " +
               "    and wrtsale.t_Contract = ?                                           " +
               "    and wrtsale.t_Date    >= ?                                           " +
               "    and wrtsale.t_Date    <= ?                                           " +
               "    and wrtsale.t_Currency = fi.t_FaceValueFI                            " +
               "    and wrtbuy.t_Currency  = fi.t_FaceValueFI                            " +
               "    and fi.t_FaceValueFI   = ?                                           " +
               "    and fi.t_FI_Kind       = ?                                           " +
               "    and RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) = ? " +
               "    and paym.t_paymentid   (+)= wrtsale.t_DocID                          ";
    var SqlQueryFooter = " order by wrtsale.t_Date, wrtsale.t_Time, wrtsale.t_SumID ";

    MACRO PrintLineTable1( N5_OZ2, N5_OZ3, N5_OZ4, N5_OZ5_1, N5_OZ5, N5_OZ6, N5_OZ7, N5_OZ8, N5_OZ9, N5_OZ10, N5_OZ11, N5_OZ12,
                           N5_OZ13_1, N5_OZ13, N5_OZ14, N5_OZ15, N5_OZ16, N5_OZ18, N5_OZ19, N5_S7, N5_OZ20, N5_OZ21, N5_OZ22,
                           N5_W7, N5_OZ23, N5_OZ25, N5_OZ26, N5_OZ27, N5_OZ28 );

       PrintTableLine( "N5_OZ2",  N5_OZ2,  null,
                       "N5_OZ3",  N5_OZ3,  null,
                       "N5_OZ4",  N5_OZ4,  null,
                       "N5_OZ5_1",N5_OZ5_1,null,
                       "N5_OZ5",  N5_OZ5,  null,
                       "N5_OZ6",  N5_OZ6,  null,
                       "N5_OZ7",  N5_OZ7,  null,
                       "N5_OZ8",  N5_OZ8,  null,
                       "N5_OZ9",  N5_OZ9,  null,
                       "N5_I7",   "",      null, /* разделительное поле */
                       "N5_OZ10", N5_OZ10, null,
                       "N5_OZ11", N5_OZ11, null,
                       "N5_OZ12", N5_OZ12, null,
                       "N5_OZ13_1",N5_OZ13_1,null,
                       "N5_OZ13", N5_OZ13, null,
                       "N5_OZ14", N5_OZ14, null,
                       "N5_OZ15", N5_OZ15, null,
                       "N5_OZ16", N5_OZ16, null,
                       "N5_OZ18", N5_OZ18, null,
                       "N5_OZ19", N5_OZ19, null,
                       "N5_S7",   N5_S7,   null,
                       "N5_OZ20", N5_OZ20, null,
                       "N5_OZ21", N5_OZ21, null,
                       "N5_OZ22", N5_OZ22, null,
                       "N5_W7",   N5_W7,   null,
                       "N5_OZ23", N5_OZ23, null,
                       "N5_OZ25", N5_OZ25, null,
                       "N5_OZ26", N5_OZ26, null,
                       "N5_OZ27", N5_OZ27, null,
                       "N5_OZ28", N5_OZ28, null);
    END;

    Query = RSDCommand( " select case when exists ( " + SqlQueryHead1 + SqlQuery + " ) then 1 else 0 end NRec from dual " );
    Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam("", RSDBP_IN, m_BegDate );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate );
    Query.addParam("", RSDBP_IN, NATCUR );
    Query.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
    Query.addParam("", RSDBP_IN, AVOIRISSKIND_BOND);
    Query.execute();
    
    RSD = TRsbDataSet(Query);
    if( RSD.MoveNext() )
       OZ_ExistsLNK = SQL_ConvTypeInteger(RSD.NRec);
    end;

    if( OZ_ExistsLNK > 0 )

       if( m_SheetN5 == false )
          UseNewSheetInTotalBook();
          m_SheetN5 = true;
       end;
       SetActiveSheet( "Облигации Закрытые" );

       m_PrintOrderN5 = true;

       /* печатаем таблицу */
       var PrevDealID:integer = 0, DealID = -1;
       var i:integer = 0;
       var AmountItogLine:integer = 0; /* количество итоговых линий и заголовков сделок */

       var FOZ6 = "", FOZ8 = "", FOZ9 = "", FOZ15 = "", FOZ16 = "", FOZ19 = "", FOZ21 = "",
           FOZ23 = "", FOZ27 = "", FOZ28 = "", FOZ17_1 = "", FOZ22_1 = "";
       var ЯчейкаПогашенногоНКД = "";

       Query1 = RSDCommand( SqlQueryHead1 + SqlQuery + SqlQueryFooter );
       Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query1.addParam("", RSDBP_IN, m_BegDate );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate );
       Query1.addParam("", RSDBP_IN, NATCUR );
       Query1.addParam("", RSDBP_IN, FIKIND_AVOIRISS);
       Query1.addParam("", RSDBP_IN, AVOIRISSKIND_BOND);
       Query1.execute();
       RSD1 = TRsbDataSet(Query1);

       RegisterTable( "N5_MainTable_1", "",
                      "N5_OZ2", "N5_OZ3", "N5_OZ4", "N5_OZ5", "N5_OZ6", "N5_OZ7", "N5_OZ8", "N5_OZ9", "N5_I7", "N5_OZ10", "N5_OZ11",
                      "N5_OZ12", "N5_OZ13", "N5_OZ14", "N5_OZ15", "N5_OZ16", "N5_OZ18", "N5_OZ19", "N5_S7", "N5_OZ20", "N5_OZ21", "N5_OZ22",
                      "N5_W7", "N5_OZ23", "N5_OZ25", "N5_OZ26", "N5_OZ27", "N5_OZ28" );

       while( RSD1.MoveNext() )

          var ВыводЦБ = ( RSD1.Buy_Sale == PM_WRITEOFF_SUM_SALE ) AND ( RSD1.KindSale == 330 );
          if( ВыводЦБ )
             DealID = RSD1.DocumentID;
          else
             DealID = RSD1.DealIDSale;
          end;

          if( PrevDealID != DealID ) /* новая сделка */

             if( i != 0 ) /* печатаем итог по предыдущей сделке */
                SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                PrintLineTable1( "", "", "", "", "",
                                 F( FormulaSUM() + "(" + FOZ6 + ")" ),
                                 "",
                                 F( FormulaSUM() + "(" + FOZ8 + ")" ),
                                 F( FormulaSUM() + "(" + FOZ9 + ")" ),
                                 "", "", "", "", "", "",
                                 F( FormulaSUM() + "(" + FOZ15 + ")" ),
                                 F( FormulaSUM() + "(" + FOZ16 + ")" ),
                                 "",
                                 F( FormulaSUM() + "(" + FOZ19 + ")" ),
                                 F( N5_G7(i+AmountItogLine) + "+" + N5_H7(i+AmountItogLine) + TS_IIF(ЯчейкаПогашенногоНКД != "", "+" + ЯчейкаПогашенногоНКД, "") + "-" + N5_R7(i+AmountItogLine) + "-" + N5_P7(i+AmountItogLine) ),
                                 "",
                                 F( FormulaSUM() + "(" + FOZ21 + ")" ),
                                 "",
                                 F( N5_G7(i+AmountItogLine) + "-" + N5_U7(i+AmountItogLine) ),
                                 F( FormulaSUM() + "(" + FOZ23 + ")" ),
                                 "", "",
                                 F( FormulaSUM() + "(" + FOZ27 + ")" ),
                                 F( FormulaSUM() + "(" + FOZ28 + ")" ) );

                FOZ6 = ""; FOZ8 = ""; FOZ9 = ""; FOZ15 = ""; FOZ16 = ""; FOZ19 = ""; FOZ21 = ""; FOZ23 = ""; FOZ27 = ""; FOZ28 = "";

                delim = TS_IIF(FOZ17_1 == "", "", ";");
                FOZ17_1 = FOZ17_1 + delim + N5_S7(i+AmountItogLine);

                AmountItogLine = AmountItogLine + 1;
             end;

             PrintLineTable1( ПолучитьВидОперации(RSD1.Buy_Sale, RSD1.KindSale),
                              "", "", "", "",
                              TS_IIF(ЭтоПогашение(RSD1.KindSale), "", "НКД погашенный"),
                              "", "",
                              TS_IIF(ЭтоПогашение(RSD1.KindSale), "", СуммаПогашенногоНКД(DealID, RSD1.FIID, ВыводЦБ)),
                              "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "" );

             ЯчейкаПогашенногоНКД = TS_IIF(ЭтоПогашение(RSD1.KindSale), "", N5_H7(i+AmountItogLine));
             AmountItogLine = AmountItogLine + 1;

          end;

          var InPeriod = (RSD1.DateBuy >= m_BegDate); /* Дата поставки сделки покупки входит в отчётный период? */
          var NominalI = TS_GetFaceValue( RSD1.FIID ),
              NominalS = TS_GetFaceValue( RSD1.FIID, SQL_ConvTypeDate(RSD1.DateSale) ),
              NominalB = TS_GetFaceValue( RSD1.FIID, SQL_ConvTypeDate(RSD1.DateBuy) );

          var N5_OZ14 = $0.0; /* Цена */
          var N5_OZ26 = $0.0; /* _Цена покупки */
          if( InPeriod )
             N5_OZ14 = ЦенаПокупки(RSD1, NominalB);
          else
             N5_OZ26 = ЦенаПокупки(RSD1, NominalB);

             if( WRTGetRestoreLotOnDate(RSD1.BuySumID, m_BegValidDate - 1, wsum) == true )
                if( (wsum.Amount != 0.0) and (NominalB != 0.0) )
                   N5_OZ14 = ((wsum.BalanceCost - wsum.NKDAmount - wsum.InterestIncome) / wsum.Amount) * 100.0 / NominalB;
                end;
             end;
          end;

          var Amount = КоличествоБумаг(DealID, RSD1.FIID, ВыводЦБ);

          var НКДупл = $0.0;
          var FirstLot;
          if( InPeriod )
             НКДупл = F( N5_Q7(i+AmountItogLine) + "*" + N5_O7(i+AmountItogLine) );
          else
             if( GetLotFirstInstance(RSD1.BuySumID, @FirstLot) and (FirstLot.Amount != 0.0) )
                НКДупл = FirstLot.NKDAmount*RSD1.Amount/FirstLot.Amount;
             end;
//           НКДупл = RSD1.NKDBuyAmount + RSD1.InterestIncomeBuy + TS_GetCouponSumByPeriod( SQL_ConvTypeInteger(RSD1.FIID), SQL_ConvTypeSum(RSD1.Amount), SQL_ConvTypeDate(RSD1.DateBuy)+1, m_BegValidDate-1, "", null, null, null, null );
          end;

          var N5_OZ20;
          if( (NominalS != 0.0) and (ЭтоПогашение(RSD1.KindSale) == false) )
             N5_OZ20 = ЦенаПоБалансу(RSD1.BuySumID, RSD1.FIID, RSD1.FaceValueFI, RSD1.DateSale) * 100.0 / NominalS;
          else
             N5_OZ20 = "";
          end;

          var N5_OZ18:money = 0.0;
          if( RSD1.Amount != 0.0 )
             N5_OZ18 = RSD1.NKDBuyAmount/RSD1.Amount;
          end;

          PrintLineTable1( SQL_ConvTypeDate(RSD1.DateSale),
                           TS_IIF(PrevDealID == DealID, "", SQL_ConvTypeTime(RSD1.TimeSale)),
                           TS_IIF(PrevDealID == DealID, "", RSD1.Name),
                           TS_IIF(PrevDealID == DealID, "", NominalI),
                           TS_IIF(PrevDealID == DealID, "", NominalS),
                           TS_IIF(PrevDealID == DealID, "", Amount),
                           TS_IIF(PrevDealID == DealID, "", F( ДУ_ЧислоCЗаданнойТочностью(ЦенаПродажи(RSD1, NominalS, Amount, NominalI),4)) ),
                           TS_IIF(PrevDealID == DealID, "", СуммаПродажи(RSD1, i+AmountItogLine)),
                           TS_IIF(PrevDealID == DealID, "", ПолученныйНКД(RSD1, i+AmountItogLine)),

                           TS_IIF(InPeriod, SQL_ConvTypeDate(RSD1.DateBuy), m_BegValidDate - 1),
                           SQL_ConvTypeTime(RSD1.TimeBuy),
                           RSD1.Name,
                           NominalI,
                           NominalS, /*"для уравнивания"*/
                           F( ДУ_ЧислоCЗаданнойТочностью(N5_OZ14, 4) ),
                           RSD1.Amount,
                           F( N5_O7(i+AmountItogLine) + "*" + N5_M7(i+AmountItogLine) + "*" + N5_N7(i+AmountItogLine) + "/100" ),
                           N5_OZ18,
                           НКДупл,
                           "",
                           N5_OZ20,
                           TS_IIF((ЭтоПогашение(RSD1.KindSale) == false),
                                  F( N5_O7(i+AmountItogLine) + "*" + N5_M7(i+AmountItogLine) + "*" + N5_T7(i+AmountItogLine) + "/100" ), ""),
                           TS_IIF((ЭтоПогашение(RSD1.KindSale) == false),
                                  F( "(" + N5_A7(i+AmountItogLine) + "-" + N5_J7(i+AmountItogLine) + ")*(" + N5_U7(i+AmountItogLine) + "+" + N5_X7(i+AmountItogLine) + "+" + N5_R7(i+AmountItogLine) + ")" ), ""),
                           "",
                           ВесьНачисленныйПД(RSD1, InPeriod),
                           TS_IIF(InPeriod, "", SQL_ConvTypeDate(RSD1.DateBuy)),
                           TS_IIF(InPeriod, "", N5_OZ26),
                           TS_IIF(InPeriod, "", F( N5_O7(i+AmountItogLine) + "*" + N5_M7(i+AmountItogLine) + "*" + N5_Z7(i+AmountItogLine) + "/100" ) ),
                           TS_IIF(InPeriod, "", F( N5_Q7(i+AmountItogLine) + "*" + N5_O7(i+AmountItogLine) )) );

          delim = TS_IIF(FOZ6 == "", "", ";");
          if(PrevDealID != DealID)
             FOZ6 = FOZ6 + delim + N5_E7(i+AmountItogLine);
             FOZ8 = FOZ8 + delim + N5_G7(i+AmountItogLine);
             FOZ9 = FOZ9 + delim + N5_H7(i+AmountItogLine);
          end;
          FOZ15 = FOZ15 + delim + N5_O7(i+AmountItogLine);
          FOZ16 = FOZ16 + delim + N5_P7(i+AmountItogLine);
          FOZ19 = FOZ19 + delim + N5_R7(i+AmountItogLine);
          FOZ21 = FOZ21 + delim + N5_U7(i+AmountItogLine);
          FOZ23 = FOZ23 + delim + N5_X7(i+AmountItogLine);
          FOZ27 = FOZ27 + delim + N5_AA7(i+AmountItogLine);
          FOZ28 = FOZ28 + delim + N5_AB7(i+AmountItogLine);

          delim = TS_IIF(FOZ22_1 == "", "", ";");
          FOZ22_1 = FOZ22_1 + delim + N5_V7(i+AmountItogLine);

          PrevDealID = DealID;

          i = i + 1;
       end;

       /* итоговая строчка от последней сделки */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "", "", "",
                        F( FormulaSUM() + "(" + FOZ6 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + FOZ8 + ")" ),
                        F( FormulaSUM() + "(" + FOZ9 + ")" ),
                        "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + FOZ15 + ")" ),
                        F( FormulaSUM() + "(" + FOZ16 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + FOZ19 + ")" ),
                        F( N5_G7(i+AmountItogLine) + "+" + N5_H7(i+AmountItogLine) + TS_IIF(ЯчейкаПогашенногоНКД != "", "+" + ЯчейкаПогашенногоНКД, "") + "-" + N5_R7(i+AmountItogLine) + "-" + N5_P7(i+AmountItogLine) ),
                        "",
                        F( FormulaSUM() + "(" + FOZ21 + ")" ),
                        "",
                        F( N5_G7(i+AmountItogLine) + "-" + N5_U7(i+AmountItogLine) ),
                        F( FormulaSUM() + "(" + FOZ23 + ")" ),
                        "", "",
                        F( FormulaSUM() + "(" + FOZ27 + ")" ),
                        F( FormulaSUM() + "(" + FOZ28 + ")" ) );

       FOZ6 = FOZ8 = FOZ9 = FOZ15 = FOZ16 = FOZ19 = FOZ21 = FOZ23 = FOZ27 = FOZ28 = "";
       delim = TS_IIF(FOZ17_1 == "", "", ";");
       FOZ17_1 = FOZ17_1 + delim + N5_S7(i+AmountItogLine);
       AmountItogLine = AmountItogLine + 1;

       /* последняя итоговая строка */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + FOZ17_1 + ")" ),
                        "", "",
                        F( FormulaSUM() + "(" + FOZ22_1 + ")" ),
                        "", "", "", "", "", "" );
       FOZ17_1 = FOZ22_1 = "";

       EndTable();

       /* печатаем шапку */
       PrintFormatString( "", "N5_D1",   F( N1_() + N1_C1(0) ),
                              "N5_H1",   F( N1_() + N1_F1(0) ),
                              "N5_OZT",  TS_IIF(m_PrevValid != NULL, "Продленный договор с", ""),
                              "N5_OZD1", TS_IIF(m_PrevValid != NULL, m_BegValidDate, ""),
                              "N5_OZT1", TS_IIF(m_PrevValid != NULL, "за", ""),
                              "N5_OZT2", TS_IIF(m_PrevValid != NULL, F( N5_H1(0) + "-" + N5_C2(0) + "+1" ), ""),
                              "N5_OZT3", TS_IIF(m_PrevValid != NULL, strdays( m_FormData.ReportDate - m_BegValidDate + 1 ), ""),
                              "N5_OZI1", F( N5_S7(i+AmountItogLine) ),
                              "N5_OZI2", F( N5_V7(i+AmountItogLine) ) );

       CopyAllSheetInTotalBook( "Облигации Закрытые", false, "N5_Table1", 0, "Облигации Закрытые" );

    end;

  END;


  PRIVATE MACRO Печать_Векселя()

    var SqlQuery, Query, RSD, Query1, RSD1, Query2, RSD2, Query3, RSD3, Query4, RSD4, Query5, RSD5;
    var HeadSelect1, HeadSelect2, WhereIssuerName, FooterQuery;
    var AmountPortf:integer = 0, AmountDeal:integer = 0;
    var delim:string = "";
    var BalanceDate:date = date(0,0,0);
    var Cost:money = $0.0;
    var BeginMon:date, EndMon:date;
    var Период, FVС5 = "";
    var ExStr = false;

    HeadSelect1 = " select bnr.t_IssuerName, bnr.t_BCNumber, bnr.t_BCSeries, bnr.t_RepaymentDate, bnr.t_BCTermFormula, bnr.t_BCPresentationDate, " +
                  "        dl_leg.t_Maturity, dl_leg.t_Diff, dl_leg.t_Formula, dl_leg.t_Start, dl_leg.t_Principal, dl_leg.t_PFI, dl_leg.t_Price, " +
                  "        bnr.t_BCID, bnr.t_Issuer, dl_leg.t_Expiry, bnr.t_IssuerTaxCode, dl_leg.t_Point, tk.t_DealDate                         ";
    HeadSelect2 = " select distinct bnr.t_IssuerName, bnr.t_Issuer, bnr.t_IssuerTaxCode ";
    SqlQuery = "   from dvsbanner_dbt bnr, dfininstr_dbt fin, ddl_tick_dbt tk, dvsordlnk_dbt lnk, doprkoper_dbt kop, ddl_leg_dbt dl_leg       " +
               "  where bnr.t_bcformkind = 1 and bnr.t_Issuer not in (select t_PartyID from ddp_dep_dbt)                                      " +
               "    and fin.t_FIID = bnr.t_FIID                                                                                               " +
               "    and ( (bnr.t_BackOffice = 'А') OR (bnr.t_BackOffice = CHR(0)) )                                                           " +
               "    and bnr.t_BCID = lnk.t_BCID                                                                                               " +
               "    and kop.t_Kind_Operation = tk.t_DealType                                                                                  " +
               "    and ((instr(kop.t_SysTypes, 'B') != 0) or (tk.t_bofficekind = ?))                                                         " +
               "    and lnk.t_ContractID = tk.t_DealID                                                                                        " +
               "    and lnk.t_DocKind    = tk.t_bofficekind                                                                                   " +
               "    and lnk.t_LinkKind   = 1                                                                                                  " +
               "    and lnk.t_InterestChargeDate =                                                                                            " +
               "        ( CASE WHEN lnk.t_DocKind = ? THEN                                                                                    " +
               "                    (SELECT nvl(max(l1.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date                 " +
               "                       FROM doproper_dbt oper, doprkoper_dbt koper, ddl_tick_dbt tick, dvsordlnk_dbt l1                       " +
               "                      WHERE oper.t_DocKind    = ?                                                                             " +
               "                        AND oper.t_DocumentID = lpad(tick.T_DealID, 34, '0')                                                  " +
               "                        AND tick.t_Dealid     = l1.t_contractid                                                               " +
               "                        AND koper.t_Kind_Operation = tick.t_DealType                                                          " +
               "                        AND instr(koper.t_SysTypes, 'B') != 0                                                                 " +
               "                        AND l1.t_bcid     = bnr.t_BCID                                                                        " +
               "                        AND l1.t_linkkind = 1                                                                                 " +
               "                        AND l1.t_InterestChargeDate <= ? )                                                                    " +
               "           ELSE                                                                                                               " +
               "                    (SELECT nvl(max(l2.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date                 " +
               "                       FROM dvsordlnk_dbt l2                                                                                  " +
               "                      WHERE l2.t_DocKind  = ?                                                                                 " +
               "                        AND l2.t_bcid     = bnr.t_BCID                                                                        " +
               "                        AND l2.t_linkkind = 1                                                                                 " +
               "                        AND l2.t_InterestChargeDate <= ? )                                                                    " +
               "           END                                                                                                                " +
               "        )                                                                                                                     " +
               "    and fin.t_avoirkind    = ?                                                                                                " +
               "    and dl_leg.t_LegKind   = ?                                                                                                " +
               "    and dl_leg.t_DealID    = bnr.t_BCID                                                                                       " +
               "    and dl_leg.t_LegID     = 0                                                                                                " +
               "    and dl_leg.t_Formula in(0,1,2)                                                                                            " +
               "    and tk.t_ClientContrID = ?                                                                                                " +
               "    and EXISTS(select MAX(t_ChangeDate)                                                                                       " +
               "                 from dvsbnrbck_dbt                                                                                           " +
               "                where t_BCID = bnr.t_bcid                                                                                     " +
               "                  and t_ABCStatus = chr(88)                                                                                   " +
               "                  and t_NewABCStatus = ?                                                                                      " +
               "                  and t_ChangeDate <= ? )                                                                                     " +
               "    and NOT EXISTS(select t_BCID                                                                                              " +
               "                     from dvsbnrbck_dbt                                                                                       " +
               "                    where t_BCID = bnr.t_bcid                                                                                 " +
               "                      and t_ABCStatus = chr(88)                                                                               " +
               "                      and t_OldABCStatus = ?                                                                                  " +
               "                      and t_ChangeDate >= ( select MAX(t_ChangeDate)                                                          " +
               "                                              from dvsbnrbck_dbt                                                              " +
               "                                             where t_BCID         = bnr.t_bcid                                                " +
               "                                               and t_ABCStatus    = chr(88)                                                   " +
               "                                               and t_NewABCStatus = ?                                                         " +
               "                                               and t_ChangeDate  <= ? )                                                       " +
               "                      and t_ChangeDate <= ?)                                                                                  ";
    WhereIssuerName = " and bnr.t_IssuerName = ? ";
    FooterQuery = " order by bnr.t_IssuerName ";

    MACRO PrintLineTable1( N6_VA1, N6_VA2, N6_VA3, N6_VA4, N6_VA5, N6_VA6, N6_VA7 )
       PrintTableLine( "N6_VA1", N6_VA1, null,
                       "N6_VA2", N6_VA2, null,
                       "N6_VA3", N6_VA3, null,
                       "N6_VA4", N6_VA4, null,
                       "N6_VA5", N6_VA5, null,
                       "N6_VA6", N6_VA6, null,
                       "N6_VA7", N6_VA7, null);
    END;

    MACRO PrintLineTable2( N6_VB1, N6_VB2, N6_VB3, N6_VB4, N6_VB5, N6_VB6, N6_VB7, N6_VB8, N6_VB9, N6_VB10, N6_VB11,
                           N6_VB12, N6_VB13, N6_N13, N6_VB15, N6_VB16, N6_VB17, N6_VB18, N6_VB19, N6_VB20, N6_VB21,
                           N6_VB22, N6_VB22_1, N6_VB23, N6_VB24, N6_Z13, N6_VB28, N6_VB29, N6_VB30 )
       PrintTableLine( "N6_VB1",    N6_VB1,    null,
                       "N6_VB2",    N6_VB2,    null,
                       "N6_VB3",    N6_VB3,    null,
                       "N6_VB4",    N6_VB4,    null,
                       "N6_VB5",    N6_VB5,    null,
                       "N6_VB6",    N6_VB6,    null,
                       "N6_VB7",    N6_VB7,    null,
                       "N6_VB8",    N6_VB8,    null,
                       "N6_VB9",    N6_VB9,    null,
                       "N6_VB10",   N6_VB10,   null,
                       "N6_VB11",   N6_VB11,   null,
                       "N6_VB12",   N6_VB12,   null,
                       "N6_VB13",   N6_VB13,   null,
                       "N6_N13",    N6_N13,    null,
                       "N6_VB15",   N6_VB15,   null,
                       "N6_VB16",   N6_VB16,   null,
                       "N6_VB17",   N6_VB17,   null,
                       "N6_VB18",   N6_VB18,   null,
                       "N6_VB19",   N6_VB19,   null,
                       "N6_VB20",   N6_VB20,   null,
                       "N6_VB21",   N6_VB21,   null,
                       "N6_VB22",   N6_VB22,   null,
                       "N6_VB22_1", N6_VB22_1, null,
                       "N6_VB23",   N6_VB23,   null,
                       "N6_VB24",   N6_VB24,   null,
                       "N6_Z13",    N6_Z13,    null,
                       "N6_VB28",   N6_VB28,   null,
                       "N6_VB29",   N6_VB29,   null,
                       "N6_VB30",   N6_VB30,   null);
    END;

    MACRO PrintLineTable3( N6_VС1, N6_VС2, N6_VС3, N6_VС4, N6_VС5 )
       PrintTableLine( "N6_VС1", N6_VС1, null,
                       "N6_VС2", N6_VС2, null,
                       "N6_VС3", N6_VС3, null,
                       "N6_VС4", N6_VС4, null,
                       "N6_VС5", N6_VС5, null);
    END;

    MACRO КоличествоВекселейВекселедателя( IssuerName:string ):integer

       var RetVal = 0;
       var Select = RSDCommand( " select count(1) NRec from ( " + HeadSelect1 + SqlQuery + WhereIssuerName + " ) " );
       Select.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Select.addParam("", RSDBP_IN, DL_VATRUST                      );
       Select.addParam("", RSDBP_IN, DL_VATRUST                      );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Select.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Select.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Select.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Select.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Select.addParam("", RSDBP_IN, IssuerName                      );
       Select.execute();

       var RSDSelect = TRsbDataSet(Select);

       if( RSDSelect.MoveNext() )
          RetVal = SQL_ConvTypeInteger(RSDSelect.NRec);
       end;

       return RetVal;
    END;

    MACRO СуммаПроцентовНаДатуПогашения( Formula:integer, DeltaLine:integer, ДатаН:date, ДатаК:date ):string

       var RetVal:string = "";

       if( Formula == VS_IN_DISCONT )
          RetVal = N6_I13(DeltaLine) + "-" + N6_J13(DeltaLine);
       else

          var DifferentYear:bool = false;
          var YearB, YearE, CurYear;

          DateSplit( ДатаН, null, null, YearB );
          DateSplit( ДатаК, null, null, YearE );

          var PrevAmount:integer = ДУ_ДнейВГоду( YearB );
          if( YearB != YearE )
             CurYear = YearB + 1;
             while( CurYear <= YearE )
                if( PrevAmount != ДУ_ДнейВГоду( CurYear ) )
                   DifferentYear = true;
                   break;
                end;
                CurYear = CurYear + 1;
             end;
          end;

          if( DifferentYear )
             var P1:integer = 0, P2:integer = 0;
             var T1:integer = 365, T2:integer = 366;
             var Период = ПериодПоГодам(ДатаН, ДатаК);
             var BegDate, EndDate;
             while( Период.СледующийГод(@BegDate, @EndDate) )
                if( ДУ_ДнейВГоду(BegDate) == T1 )
                   P1 = P1 + (EndDate - BegDate + 1);
                else
                   P2 = P2 + (EndDate - BegDate + 1);
                end;
             end;

             RetVal = N6_I13(DeltaLine) + "*" + N6_K13(DeltaLine) + "/100*(" + P1 + "/" + T1 + "+" + P2 + "/" + T2 + ")";
          else
             RetVal = N6_I13(DeltaLine) + "*" + N6_K13(DeltaLine) + "/100*" + N6_L13(DeltaLine) + "/" + PrevAmount;
          end;

       end;

       return F( RetVal );
    END;

    Query = RSDCommand( " select count(1) NRec from ( " + HeadSelect2 + SqlQuery + " ) " );
    Query.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
    Query.addParam("", RSDBP_IN, DL_VATRUST                      );
    Query.addParam("", RSDBP_IN, DL_VATRUST                      );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
    Query.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
    Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
    Query.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam("", RSDBP_IN, m_FormData.ReportDate           );
    Query.execute();

    RSD = TRsbDataSet( Query );

    if( RSD.MoveNext() )
       AmountPortf = SQL_ConvTypeInteger(RSD.NRec); /* количество строк в таблице "Портфель" */
    end;

    if( AmountPortf > 0 )

       Query4 = RSDCommand( " select count(1) NRec from ( " + HeadSelect1 + SqlQuery + " ) " );
       Query4.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query4.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query4.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query4.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query4.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query4.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query4.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query4.execute();
      
       RSD4 = TRsbDataSet( Query4 );
      
       if( RSD4.MoveNext() )
          AmountDeal = SQL_ConvTypeInteger(RSD4.NRec); /* количество строк в таблице "Сделки приобретения" без итогов */
       end;

       var DeltaTable3 = AmountDeal + (AmountPortf - 1)*2;

       if( m_SheetN6 == false )
          UseNewSheetInTotalBook();
          m_SheetN6 = true;
       end;
       SetActiveSheet( "Векселя" );

       m_PrintOrderN6 = true;

       /* печатаем шапку */

       PrintFormatString( "", "N6_C2",  F( N1_() + N1_C1(0) ),
                              "N6_F2",  F( N1_() + N1_F1(0) ),
                              "N6_VT",  TS_IIF(m_PrevValid != NULL, "Продленный договор с", ""),
                              "N6_VD1", TS_IIF(m_PrevValid != NULL, m_BegValidDate, ""),
                              "N6_VT1", TS_IIF(m_PrevValid != NULL, "за", ""),
                              "N6_VT2", TS_IIF(m_PrevValid != NULL, F( N6_F2(0) + "-" + N6_C3(0) + "+1" ), ""),
                              "N6_VT3", TS_IIF(m_PrevValid != NULL, strdays( m_FormData.ReportDate - m_BegValidDate + 1), "") );

       /* печатем таблицу "портфель" */

       Query1 = RSDCommand( HeadSelect2 + SqlQuery + FooterQuery );
       Query1.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query1.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query1.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query1.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query1.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query1.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query1.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query1.execute();

       RSD1 = TRsbDataSet( Query1 );

       RegisterTable( "N6_MainTable_1", "",
                      "N6_VA1", "N6_VA2", "N6_VA3", "N6_VA4", "N6_VA5", "N6_VA6", "N6_VA7" );

       var DeltaDealItog = AmountPortf - 1;

       var i = 0;
       var FVA2 = "", FVA3 = "", FVA4 = "", FVA5 = "", FVA6 = "";
       while( RSD1.MoveNext() )

          var КоличествоВекселей = КоличествоВекселейВекселедателя(RSD1.IssuerName);
          DeltaDealItog = DeltaDealItog + КоличествоВекселей + TS_IIF(i == 0, 0, 1); /* итоговая строка по данному векселедателю в таблице "Сделки приобретения" */

          RSD1.IssuerTaxCode = ПолучитьИННВекселедателя(RSD1.Issuer, RSD1.IssuerTaxCode);

          PrintLineTable1( TS_IIF((RSD1.IssuerTaxCode == ""), RSD1.IssuerName, RSD1.IssuerName + "/" + RSD1.IssuerTaxCode),
                           КоличествоВекселей,
                           F( N6_J13(DeltaDealItog) ),
                           F( N6_C6(i) + "+" + N6_E6(i) + "+" + N6_F6(i) ),
                           F( N6_V13(DeltaDealItog) ),
                           F( N6_T13(DeltaDealItog) ),
                           F( N6_Z13(DeltaDealItog) ) );

          delim = TS_IIF(i == 0, "", ";");
          FVA2 = FVA2 + delim + N6_B6(i);
          FVA3 = FVA3 + delim + N6_C6(i);
          FVA4 = FVA4 + delim + N6_D6(i);
          FVA5 = FVA5 + delim + N6_E6(i);
          FVA6 = FVA6 + delim + N6_F6(i);
          i = i + 1;

       end;

       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable1( "ИТОГО:",
                        F( FormulaSUM() + "(" + FVA2 + ")" ),
                        F( FormulaSUM() + "(" + FVA3 + ")" ),
                        F( FormulaSUM() + "(" + FVA4 + ")" ),
                        F( FormulaSUM() + "(" + FVA5 + ")" ),
                        F( FormulaSUM() + "(" + FVA6 + ")" ),
                        F( N6_Y9(AmountPortf - 1) ) );

       GL_FVA3 = N6_C6(i);
       GL_FVA5 = N6_E6(i);
       GL_FVA6 = N6_F6(i);

       EndTable();
       CopyAllSheetInTotalBook( "Векселя", false, "N6_Table1", 0, "Векселя" );

       /* печатем таблицу "Сделки приобретения" */

       var DeltaDeal = AmountPortf - 1;

       var AllIn = true; /* дата поставки всех векселей в таблице входит в ОП */
       Query5 = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
       Query5.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query5.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query5.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query5.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query5.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query5.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query5.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query5.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query5.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query5.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query5.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query5.execute();

       RSD5 = TRsbDataSet( Query5 );
       while( RSD5.MoveNext() )
          DL_VA_GetBalanceDate(RSD5.BCID, RSD5.DealDate, @BalanceDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );
          if( BalanceDate != date(0,0,0) )
             if( (BalanceDate < m_BegDate) or (BalanceDate > m_FormData.ReportDate) )
                AllIn = false;
                break;
             end;
          end;
       end;

       PrintFormatString( "", "N6_VB26", TS_IIF( AllIn, F( N6_Y13(DeltaTable3+1) + "/" + N6_X13(DeltaTable3+1) + "*" + N8_() + N8_A9(0) + "*100" ),
                                                        F( N6_AC13(DeltaTable3+1) + "/" + N6_AB13(DeltaTable3+1) + "*" + N8_() + N8_A9(0) + "*100" )),
                              "N6_VB27", TS_IIF( m_PrintOrderN7 == true, TS_IIF( AllIn, F( "(" + N6_Y13(DeltaTable3+1) + "+" + N7_() + GL_VZ1 + ")/(" + N6_X13(DeltaTable3+1) + "+" + N7_() + GL_VZ1_2 + ")*" + N8_() + N8_A9(0) + "*100" ),
                                                                                 F( "(" + N6_AC13(DeltaTable3+1) + "+" + N7_() + GL_VZ1 + "+" + N7_() + GL_VZ1_1 + ")/(" + N6_AB13(DeltaTable3+1) + "+" + N7_() + GL_VZ1_2 + ")*" + N8_() + N8_A9(0) + "*100" )
                                                                               ), 0)
                        );
                                         
       GL_VB27 = N6_Y10(DeltaDeal);

       Query2 = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
       Query2.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query2.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query2.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query2.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query2.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query2.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query2.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query2.execute();

       RSD2 = TRsbDataSet( Query2 );

       RegisterTable( "N6_MainTable_2", "",
                      "N6_VB1", "N6_VB2", "N6_VB3", "N6_VB4", "N6_VB5", "N6_VB6", "N6_VB7", "N6_VB8", "N6_VB9", "N6_VB10", "N6_VB11",
                      "N6_VB12", "N6_VB13", "N6_N13", "N6_VB15", "N6_VB16", "N6_VB17", "N6_VB18", "N6_VB19", "N6_VB20", "N6_VB21",
                      "N6_VB22", "N6_VB22_1", "N6_VB23", "N6_VB24", "N6_Z13", "N6_VB28", "N6_VB29", "N6_VB30" );

       i = 0;
       var k = 0; /* количество итоговых строк */
       var m = 0; /* счётчик строк в таблице "Начисленный доход" вместе с итогами */
       var PrevIssuerName = 0;
       var VVB9 = "", VVB10 = "", VVB16 = "", VVB17 = "", VVB18 = "", VVB19 = "", VVB20 = "", VVB22 = "", VVB22_1 = "", VVB23 = "", VVB24 = "", VVB29 = "", VVB30 = "";
       var FVB9 = "", FVB10 = "", FVB16 = "", FVB17 = "", FVB18 = "", FVB19 = "", FVB20 = "", FVB22 = "", FVB22_1 = "", FVB23 = "", FVB24 = "", FVB29 = "", FVB30 = "";

       while( RSD2.MoveNext() )

          if( (PrevIssuerName != RSD2.IssuerName) and (i != 0) )
             /* печатаем итог по векселедателю */
             SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
             PrintLineTable2( "", "", "", "", "", "", "", "",
                              F( FormulaSUM() + "(" + VVB9 + ")" ),
                              F( FormulaSUM() + "(" + VVB10 + ")" ),
                              "", "", "", "", "",
                              F( FormulaSUM() + "(" + VVB16 + ")" ),
                              F( FormulaSUM() + "(" + VVB17 + ")" ),
                              F( FormulaSUM() + "(" + VVB18 + ")" ),
                              F( FormulaSUM() + "(" + VVB19 + ")" ),
                              F( FormulaSUM() + "(" + VVB20 + ")" ),
                              "",
                              F( FormulaSUM() + "(" + VVB22 + ")" ),
                              F( FormulaSUM() + "(" + VVB22_1 + ")" ),
                              F( FormulaSUM() + "(" + VVB23 + ")" ),
                              F( FormulaSUM() + "(" + VVB24 + ")" ),
                              F( N6_Y13(DeltaDeal+i+k) + "/" + N6_X13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) + "*100" ),
                              "",
                              F( FormulaSUM() + "(" + VVB29 + ")" ),
                              F( FormulaSUM() + "(" + VVB30 + ")" ) );

             VVB9 = ""; VVB10 = ""; VVB16 = ""; VVB17 = ""; VVB18 = ""; VVB19 = ""; VVB20 = ""; VVB22 = ""; VVB22_1 = ""; VVB23 = ""; VVB24 = ""; VVB29 = ""; VVB30 = "";

             delim = TS_IIF(FVB9 == "", "", ";");
             FVB9    = FVB9    + delim + N6_I13(DeltaDeal+i+k);
             FVB10   = FVB10   + delim + N6_J13(DeltaDeal+i+k);
             FVB16   = FVB16   + delim + N6_P13(DeltaDeal+i+k);
             FVB17   = FVB17   + delim + N6_Q13(DeltaDeal+i+k);
             FVB18   = FVB18   + delim + N6_R13(DeltaDeal+i+k);
             FVB19   = FVB19   + delim + N6_S13(DeltaDeal+i+k);
             FVB20   = FVB20   + delim + N6_T13(DeltaDeal+i+k);
             FVB22   = FVB22   + delim + N6_V13(DeltaDeal+i+k);
             FVB22_1 = FVB22_1 + delim + N6_W13(DeltaDeal+i+k);
             FVB23   = FVB23   + delim + N6_X13(DeltaDeal+i+k);
             FVB24   = FVB24   + delim + N6_Y13(DeltaDeal+i+k);
             FVB29   = FVB29   + delim + N6_AB13(DeltaDeal+i+k);
             FVB30   = FVB30   + delim + N6_AC13(DeltaDeal+i+k);

             k = k + 1;
          end;

          DL_VA_GetBalanceDate(RSD2.BCID, RSD2.DealDate, @BalanceDate, null, @Cost, null, null, null, m_OrderFD.Order().rec.SfContrID );
          var ДатаПогашения_ = ДатаПогашения(RSD2.BCTermFormula, SQL_ConvTypeDate(RSD2.BCPresentationDate), SQL_ConvTypeDate(RSD2.Maturity),
                                             SQL_ConvTypeDate(RSD2.Expiry), SQL_ConvTypeDate(RSD2.Start));

          ExStr = false;
          if( BalanceDate != date(0,0,0) )
             Период = ПериодПоМесяцам(BalanceDate, m_FormData.ReportDate);
             FVС5 = "";
             while( Период.СледующийМесяц(null, @BeginMon, @EndMon) )
                if( (ПолучитьСуммуПДДЗаПериод(RSD2.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD2.BCID, BeginMon, EndMon, FIROLE_PERCENT)) > 0.0 )
                   m = m + 1;
                   ExStr = true;
                end;
             end;
             if( ExStr )
                FVС5 = N6_E18(DeltaTable3 + m);
                m = m + 1;
             end;
          end;

          RSD2.IssuerTaxCode = ПолучитьИННВекселедателя(RSD2.Issuer, RSD2.IssuerTaxCode);

          PrintLineTable2( НомерКлиента(m_OrderFD.Order().rec.RegNum, false),
                           TS_IIF((RSD2.IssuerTaxCode == ""), RSD2.IssuerName, RSD2.IssuerName + "/" + RSD2.IssuerTaxCode),
                           GetVA_Kind(RSD2.Formula),
                           TS_IIF(((RSD2.BCNumber != "") and (RSD2.BCSeries != "")), trim(RSD2.BCNumber) + "," + trim(RSD2.BCSeries), trim(RSD2.BCNumber) + trim(RSD2.BCSeries)),
                           SQL_ConvTypeDate(RSD2.Start),
                           ДатаПогашения_,
                           УсловнаяДатаПогашения(RSD2.BCTermFormula, SQL_ConvTypeDate(RSD2.BCPresentationDate), SQL_ConvTypeDate(RSD2.Maturity),
                                         SQL_ConvTypeDate(RSD2.Expiry), SQL_ConvTypeDate(RSD2.Start)),
                           BalanceDate,
                           RSD2.Principal,
                           Cost,
                           TS_IIF((RSD2.Formula == VS_IN_S_PC) OR (RSD2.Formula == VS_IN_M_PC), (RSD2.Price / pow(10, RSD2.Point)), ""),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_F13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) ),
                                                                 F( N6_F13(DeltaDeal+i+k) + "-" + N6_E13(DeltaDeal+i+k) )),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_P13(DeltaDeal+i+k) + "/" + N6_J13(DeltaDeal+i+k) + "*100/" + N6_L13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) ),
                                                                 F( "(" + N6_P13(DeltaDeal+i+k) + "-" + "(" + N6_I13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + "))/" + N6_J13(DeltaDeal+i+k) + "*100/(" + N6_F13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) + ")*" + N8_() + N8_A9(0) )),
                           F( N6_F2(0) ),
                           F( N6_N13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) ),
                           СуммаПроцентовНаДатуПогашения(RSD2.Formula, DeltaDeal+i+k, SQL_ConvTypeDate(RSD2.Start), ДатаПогашения_ ),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_P13(DeltaDeal+i+k) + "/" + N6_L13(DeltaDeal+i+k) ),
                                                                 F( "(" + N6_P13(DeltaDeal+i+k) + "+" + N6_I13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + ")/(" + N6_F13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) + ")" )),
                           F( N6_Q13(DeltaDeal+i+k) + "*" + N6_O13(DeltaDeal+i+k) ),
                           TS_IIF(RSD2.Formula == VS_IN_DISCONT, F( N6_R13(DeltaDeal+i+k) + "+" + N6_J13(DeltaDeal+i+k) ),
                                                                 F( N6_I13(DeltaDeal+i+k) + "+" + N6_I13(DeltaDeal+i+k) + "*" + N6_K13(DeltaDeal+i+k) + "/100*(" + N6_N13(DeltaDeal+i+k) + "-" + N6_E13(DeltaDeal+i+k) + ")/" + N8_() + N8_A9(0) )),
                           F( N6_S13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + "-" + N6_V13(DeltaDeal+i+k) ),
                           F( N6_Y13(DeltaDeal+i+k) + "/" + N6_X13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) + "*100" ),
                           TS_IIF(ExStr, F(FVС5), 0.0),
                           TS_IIF(BalanceDate < m_BegDate, (ПолучитьСуммуПДДЗаПериод(RSD2.BCID, BalanceDate, m_BegValidDate-1, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD2.BCID, BalanceDate, m_BegValidDate-1, FIROLE_PERCENT)), 0.0),
                           F( N6_J13(DeltaDeal+i+k) + "*" + N6_O13(DeltaDeal+i+k) ),
                           F( N6_T13(DeltaDeal+i+k) + "+" + N6_V13(DeltaDeal+i+k) ),
                           "",
                           TS_IIF( AllIn, "", TS_IIF(m_PrevValid != NULL, TS_IIF(BalanceDate > m_BegValidDate-1, F( N6_N13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) ), F( N6_N13(DeltaDeal+i+k) + "-" + N6_C3(0) + "+1" )), F( N6_N13(DeltaDeal+i+k) + "-" + N6_H13(DeltaDeal+i+k) )) ),
                           TS_IIF( AllIn, "", F( N6_J13(DeltaDeal+i+k) + "*" + N6_AA13(DeltaDeal+i+k) ) ),
                           TS_IIF( AllIn, "", F( N6_S13(DeltaDeal+i+k) + "-" + N6_J13(DeltaDeal+i+k) + "-" + N6_W13(DeltaDeal+i+k) ) )
                         );

          delim = TS_IIF(VVB9 == "", "", ";");
          VVB9    = VVB9    + delim + N6_I13(DeltaDeal+i+k);
          VVB10   = VVB10   + delim + N6_J13(DeltaDeal+i+k);
          VVB16   = VVB16   + delim + N6_P13(DeltaDeal+i+k);
          VVB17   = VVB17   + delim + N6_Q13(DeltaDeal+i+k);
          VVB18   = VVB18   + delim + N6_R13(DeltaDeal+i+k);
          VVB19   = VVB19   + delim + N6_S13(DeltaDeal+i+k);
          VVB20   = VVB20   + delim + N6_T13(DeltaDeal+i+k);
          VVB22   = VVB22   + delim + N6_V13(DeltaDeal+i+k);
          VVB22_1 = VVB22_1 + delim + N6_W13(DeltaDeal+i+k);
          VVB23   = VVB23   + delim + N6_X13(DeltaDeal+i+k);
          VVB24   = VVB24   + delim + N6_Y13(DeltaDeal+i+k);
          VVB29   = VVB29   + delim + N6_AB13(DeltaDeal+i+k);
          VVB30   = VVB30   + delim + N6_AC13(DeltaDeal+i+k);

          PrevIssuerName = RSD2.IssuerName;
          i = i + 1;
       end;

       /* печатаем итог по последнему векселедателю */
       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable2( "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + VVB9 + ")" ),
                        F( FormulaSUM() + "(" + VVB10 + ")" ),
                        "", "", "", "", "",
                        F( FormulaSUM() + "(" + VVB16 + ")" ),
                        F( FormulaSUM() + "(" + VVB17 + ")" ),
                        F( FormulaSUM() + "(" + VVB18 + ")" ),
                        F( FormulaSUM() + "(" + VVB19 + ")" ),
                        F( FormulaSUM() + "(" + VVB20 + ")" ),
                        "",
                        F( FormulaSUM() + "(" + VVB22 + ")" ),
                        F( FormulaSUM() + "(" + VVB22_1 + ")" ),
                        F( FormulaSUM() + "(" + VVB23 + ")" ),
                        F( FormulaSUM() + "(" + VVB24 + ")" ),
                        F( N6_Y13(DeltaDeal+i+k) + "/" + N6_X13(DeltaDeal+i+k) + "*" + N8_() + N8_A9(0) + "*100" ),
                        "",
                        F( FormulaSUM() + "(" + VVB29 + ")" ),
                        F( FormulaSUM() + "(" + VVB30 + ")" ) );
       VVB9 = ""; VVB10 = ""; VVB16 = ""; VVB17 = ""; VVB18 = ""; VVB19 = ""; VVB20 = ""; VVB22 = ""; VVB22_1 = ""; VVB23 = ""; VVB24 = ""; VVB29 = ""; VVB30 = "";

       delim = TS_IIF(FVB9 == "", "", ";");
       FVB9    = FVB9    + delim + N6_I13(DeltaDeal+i+k);
       FVB10   = FVB10   + delim + N6_J13(DeltaDeal+i+k);
       FVB16   = FVB16   + delim + N6_P13(DeltaDeal+i+k);
       FVB17   = FVB17   + delim + N6_Q13(DeltaDeal+i+k);
       FVB18   = FVB18   + delim + N6_R13(DeltaDeal+i+k);
       FVB19   = FVB19   + delim + N6_S13(DeltaDeal+i+k);
       FVB20   = FVB20   + delim + N6_T13(DeltaDeal+i+k);
       FVB22   = FVB22   + delim + N6_V13(DeltaDeal+i+k);
       FVB22_1 = FVB22_1 + delim + N6_W13(DeltaDeal+i+k);
       FVB23   = FVB23   + delim + N6_X13(DeltaDeal+i+k);
       FVB24   = FVB24   + delim + N6_Y13(DeltaDeal+i+k);
       FVB29   = FVB29   + delim + N6_AB13(DeltaDeal+i+k);
       FVB30   = FVB30   + delim + N6_AC13(DeltaDeal+i+k);
       k = k + 1;

       SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
       PrintLineTable2( "", "", "", "", "", "", "", "",
                        F( FormulaSUM() + "(" + FVB9 + ")", false ),
                        F( FormulaSUM() + "(" + FVB10 + ")", false ),
                        "", "", "", "", "",
                        F( FormulaSUM() + "(" + FVB16 + ")", false ),
                        F( FormulaSUM() + "(" + FVB17 + ")", false ),
                        F( FormulaSUM() + "(" + FVB18 + ")", false ),
                        F( FormulaSUM() + "(" + FVB19 + ")", false ),
                        F( FormulaSUM() + "(" + FVB20 + ")", false ),
                        "",
                        F( FormulaSUM() + "(" + FVB22 + ")", false ),
                        F( FormulaSUM() + "(" + FVB22_1 + ")", false ),
                        F( FormulaSUM() + "(" + FVB23 + ")", false ),
                        F( FormulaSUM() + "(" + FVB24 + ")", false ),
                        "", "",
                        F( FormulaSUM() + "(" + FVB29 + ")", false ),
                        F( FormulaSUM() + "(" + FVB30 + ")", false ) );

       GL_FVB22_1 = N6_W13(DeltaDeal+i+k);

       EndTable();
       CopyAllSheetInTotalBook( "Векселя", false, "N6_Table2", 0, "Векселя" );

       /* печатем таблицу "Начисленный доход" */

       Query3 = RSDCommand( HeadSelect1 + SqlQuery + FooterQuery );
       Query3.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query3.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query3.addParam("", RSDBP_IN, DL_VATRUST                      );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, TS_DOC_DECLAR                   );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, AVOIRISSKIND_BILL               );
       Query3.addParam("", RSDBP_IN, LEG_KIND_VSBANNER               );
       Query3.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query3.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query3.addParam("", RSDBP_IN, VABANNER_STATUS_ACCOUNT         );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam("", RSDBP_IN, m_FormData.ReportDate           );
       Query3.execute();

       RSD3 = TRsbDataSet( Query3 );

       var RegTable = false;
       i = 0;
       while( RSD3.MoveNext() )
          DL_VA_GetBalanceDate(RSD3.BCID, RSD3.DealDate, @BalanceDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );

          if( BalanceDate != date(0,0,0) )
             Период = ПериодПоМесяцам(BalanceDate, m_FormData.ReportDate);
             FVС5 = "";
             var Name:string = "";

             while( Период.СледующийМесяц(@Name, @BeginMon, @EndMon) )
                var ПДД = ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_PERCENT);

                if( ПДД > 0.0 )
                   if( RegTable == false )
                      RegisterTable( "N6_MainTable_3", "", "N6_VС1", "N6_VС2", "N6_VС3", "N6_VС4", "N6_VС5" );
                      RegTable = true;
                   end;

                   RSD3.IssuerTaxCode = ПолучитьИННВекселедателя(RSD3.Issuer, RSD3.IssuerTaxCode);
            
                   PrintLineTable3( TS_IIF((RSD3.IssuerTaxCode == ""), RSD3.IssuerName, RSD3.IssuerName + "/" + RSD3.IssuerTaxCode),
                                    GetVA_Kind(RSD3.Formula),
                                    TS_IIF(((RSD3.BCNumber != "") and (RSD3.BCSeries != "")), trim(RSD3.BCNumber) + "," + trim(RSD3.BCSeries), trim(RSD3.BCNumber) + trim(RSD3.BCSeries)),
                                    Name,
                                    ПДД);
            
                   delim = TS_IIF(FVС5 == "", "", ";");
                   FVС5 = FVС5 + delim + N6_E18(DeltaTable3 + i);
                   i = i + 1;
                end;
             end;

             if( FVС5 != "")
                SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                PrintLineTable3( "ИТОГО:", "", "", "", F( FormulaSUM() + "(" + FVС5 + ")" ) );
                i = i + 1;
             end;
          end;

       end;

       if( RegTable == true )
          EndTable();
          CopyAllSheetInTotalBook( "Векселя", false, "N6_Table3", 0, "Векселя" );
       end;

    end;

  END;


  PRIVATE MACRO Печать_ВекселяЗакрытые()

    var SqlQuery, Query, RSD, Query1, RSD1, Query2, RSD2;
    var delim:string = "";
    var BalanceDate:date = date(0,0,0);
    var Cost:money = $0.0;
    var BeginMon:date, EndMon:date;
    var ExStr = false;
    var Период, FVZN5 = "";

    SqlQuery = " select ban.t_Issuer, ban.t_IssuerName, ban.t_IssuerTaxCode, leg.t_Formula, ban.t_BCSeries, ban.t_BCNumber, " +
               "        ban.t_RegistrationDate, ban.t_BCTermFormula, leg.t_Principal,                  " +
               "        leg.t_PFI, ban.t_BCPresentationDate, leg.t_Start, leg.t_Duration,              " +
               "        leg.t_Maturity, leg.t_Expiry, ban.t_BCID, leg.t_Price, leg.t_Point, lnk.t_BCCost, " +
               "        lnk.t_DocKind, tick.t_DealDate, tick.t_DealTime                                " +
               "   from dvsordlnk_dbt lnk, dvsbanner_dbt ban, ddl_tick_dbt tick, ddl_leg_dbt leg       " +
               "  where lnk.t_BCID = ban.t_BCID                                                        " +
               "    and ( (lnk.t_LinkKind = ?) or ((lnk.t_LinkKind = ?) and (lnk.t_DocKind = ?)) )     " +
               "    and tick.t_DealID = lnk.t_ContractID                                               " +
               "    AND tick.t_bofficekind = lnk.t_dockind "+
               "    and tick.t_ClientContrID = ?                                                       " +
               "    and tick.t_DealDate >= ?                                                           " +
               "    and tick.t_DealDate <= ?                                                           " +
               "    and leg.t_DealID = ban.t_BCID                                                      " +
               "    and leg.t_LegKind = 1                                                              " +
               "    and leg.t_LegID = 0                                                                " +
               "    and leg.t_Formula in(?, ?, ?)                                                      " +
               "    and ban.t_Issuer not in (select t_PartyID from ddp_dep_dbt) "
               " order by tick.t_DealDate, tick.t_DealTime, ban.t_Issuer                               ";

    MACRO PrintLineTable1( N7_VZ2, N7_VZ3, N7_VZ4, N7_VZ5, N7_VZ6, N7_VZ7, N7_VZ8, N7_VZ9, N7_VZ10, N7_VZ11, N7_VZ12,
                           N7_VZ13, N7_VZ15, N7_VZ16, N7_VZ17, N7_VZ18, N7_VZ19, N7_VZ20 )
       PrintTableLine( "N7_VZ2",  N7_VZ2,  null,
                       "N7_VZ3",  N7_VZ3,  null,
                       "N7_VZ4",  N7_VZ4,  null,
                       "N7_VZ5",  N7_VZ5,  null,
                       "N7_VZ6",  N7_VZ6,  null,
                       "N7_VZ7",  N7_VZ7,  null,
                       "N7_VZ8",  N7_VZ8,  null,
                       "N7_VZ9",  N7_VZ9,  null,
                       "N7_VZ10", N7_VZ10, null,
                       "N7_VZ11", N7_VZ11, null,
                       "N7_VZ12", N7_VZ12, null,
                       "N7_VZ13", N7_VZ13, null,
                       "N7_VZ15", N7_VZ15, null,
                       "N7_VZ16", N7_VZ16, null,
                       "N7_VZ17", N7_VZ17, null,
                       "N7_VZ18", N7_VZ18, null,
                       "N7_VZ19", N7_VZ19, null,
                       "N7_VZ20", N7_VZ20, null);
    END;

    MACRO PrintLineTable2( N7_VZ2_1, N7_VZ3_1, N7_VZ4_1, N7_VZ5_1, N7_VZ6_1, N7_VZ7_1, N7_VZ8_1, N7_VZ9_1, N7_VZ10_1, N7_VZ11_1, N7_VZ12_1,
                           N7_VZ13_1, N7_VZ13_2, N7_VZ15_1, N7_VZ16_1, N7_VZ17_1, N7_VZ18_1, N7_VZ18_2, N7_VZ19_1, N7_VZ19_2, N7_VZ20_1 )
       PrintTableLine( "N7_VZ2_1",  N7_VZ2_1,  null,
                       "N7_VZ3_1",  N7_VZ3_1,  null,
                       "N7_VZ4_1",  N7_VZ4_1,  null,
                       "N7_VZ5_1",  N7_VZ5_1,  null,
                       "N7_VZ6_1",  N7_VZ6_1,  null,
                       "N7_VZ7_1",  N7_VZ7_1,  null,
                       "N7_VZ8_1",  N7_VZ8_1,  null,
                       "N7_VZ9_1",  N7_VZ9_1,  null,
                       "N7_VZ10_1", N7_VZ10_1, null,
                       "N7_VZ11_1", N7_VZ11_1, null,
                       "N7_VZ12_1", N7_VZ12_1, null,
                       "N7_VZ13_1", N7_VZ13_1, null,
                       "N7_VZ13_2", N7_VZ13_2, null,
                       "N7_VZ15_1", N7_VZ15_1, null,
                       "N7_VZ16_1", N7_VZ16_1, null,
                       "N7_VZ17_1", N7_VZ17_1, null,
                       "N7_VZ18_1", N7_VZ18_1, null,
                       "N7_VZ18_2", N7_VZ18_2, null,
                       "N7_VZ19_1", N7_VZ19_1, null,
                       "N7_VZ19_2", N7_VZ19_2, null,
                       "N7_VZ20_1", N7_VZ20_1, null);
    END;

    MACRO PrintLineTable3( N7_VZN1, N7_VZN2, N7_VZN3, N7_VZN4, N7_VZN5 )
       PrintTableLine( "N7_VZN1", N7_VZN1, null,
                       "N7_VZN2", N7_VZN2, null,
                       "N7_VZN3", N7_VZN3, null,
                       "N7_VZN4", N7_VZN4, null,
                       "N7_VZN5", N7_VZN5, null);
    END;

    MACRO PrintPartTable3( Flag:bool, DeltaTable3:integer, i:@integer, RegTable:@bool )

       var Query3, RSD3, BDate;

       Query3 = RSDCommand( SqlQuery );
       Query3.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
       Query3.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
       Query3.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
       Query3.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
       Query3.addParam( "", RSDBP_IN, m_BegDate                       );
       Query3.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
       Query3.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
       Query3.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
       Query3.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
       Query3.execute();

       RSD3 = TRsbDataSet(Query3);
       while( RSD3.MoveNext() )
          DL_VA_GetBalanceDate(RSD3.BCID, RSD3.DealDate, @BDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );

          if( BDate != date(0,0,0) )
             if( ((Flag == true) and (BDate >= (m_BegDate-1))) or
                 ((Flag == false) and (BDate < (m_BegDate-1))) )
            
                var Период = ПериодПоМесяцам(BDate, RSD3.DealDate);
                var Name:string;
                var FVZN5 = "";
            
                while( Период.СледующийМесяц(@Name, @BeginMon, @EndMon) )
                   var ПДД = ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD3.BCID, BeginMon, EndMon, FIROLE_PERCENT);
            
                   if( ПДД > 0.0 )
                      if( RegTable == false )
                         RegisterTable( "N7_MainTable_3", "", "N7_VZN1", "N7_VZN2", "N7_VZN3", "N7_VZN4", "N7_VZN5" );
                         RegTable = true;
                      end;
            
                      RSD3.IssuerTaxCode = ПолучитьИННВекселедателя(RSD3.Issuer, RSD3.IssuerTaxCode);
            
                      PrintLineTable3( TS_IIF((RSD3.IssuerTaxCode == ""), RSD3.IssuerName, RSD3.IssuerName + "/" + RSD3.IssuerTaxCode),
                                       GetVA_Kind(RSD3.Formula),
                                       TS_IIF(((RSD3.BCNumber != "") and (RSD3.BCSeries != "")), trim(RSD3.BCNumber) + "," + trim(RSD3.BCSeries), trim(RSD3.BCNumber) + trim(RSD3.BCSeries)),
                                       Name,
                                       ПДД);
            
                      delim = TS_IIF(FVZN5 == "", "", ";");
                      FVZN5 = FVZN5 + delim + N7_E20(DeltaTable3 + i);
                      i = i + 1;
                   end;
                end;
            
                if( FVZN5 != "")
                   SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
                   PrintLineTable3( "ИТОГО:", "", "", "", F( FormulaSUM() + "(" + FVZN5 + ")" ) );
                   i = i + 1;
                end;
             end;
          end;
       end;

    END;

    /* печатаем шапку */

    var AmountLineT1:integer = 0, /* Количество строк в первой таблице вместе с итогом */
        AmountLineT2:integer = 0; /* Количество строк во второй таблице вместе с итогом */

    Query2 = RSDCommand( SqlQuery );
    Query2.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
    Query2.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
    Query2.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
    Query2.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query2.addParam( "", RSDBP_IN, m_BegDate                       );
    Query2.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
    Query2.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
    Query2.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
    Query2.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
    Query2.execute();
    RSD2 = TRsbDataSet(Query2);
    while( RSD2.MoveNext() )
       DL_VA_GetBalanceDate(RSD2.BCID, RSD2.DealDate, @BalanceDate, null, null, null, null, null, m_OrderFD.Order().rec.SfContrID );

       if( BalanceDate != date(0,0,0) )
          if( BalanceDate >= (m_BegDate-1) ) /* Дата поставки сделки покупки входит в отчётный период */
             AmountLineT1 = AmountLineT1 + 1;
          else
             AmountLineT2 = AmountLineT2 + 1;
          end;
       end;
     end;
 
     if( (AmountLineT1 == 0) AND (AmountLineT2 == 0) )
        return; /*пустую страницу не печатать*/
     end;
 
     if( m_SheetN7 == false )
        UseNewSheetInTotalBook();
        m_SheetN7 = true;
     end;
     SetActiveSheet( "Векселя Закрытые" );
 
     m_PrintOrderN7 = true;
 
     var PrT1 = false, PrT2 = false;
     if( AmountLineT1 == 0 )
        AmountLineT1 = 2; /* пустая строка и итог */
     else
        AmountLineT1 = AmountLineT1 + 1; /* + итог */
        PrT1 = true;
     end;
 
     if( AmountLineT2 == 0 )
        AmountLineT2 = 2; /* пустая строка и итог */
     else
        AmountLineT2 = AmountLineT2 + 1; /* + итог */
        PrT2 = true;
     end;
 
     var DeltaTable2 = (AmountLineT1-1) - 1; /* смещение второй таблицы */
    var DeltaTable3 = DeltaTable2 + (AmountLineT2-1) - 1; /* смещение третей таблицы */

    PrintFormatString( "", "N7_C2",    F( N1_() + N1_C1(0) ),
                           "N7_G2",    F( N1_() + N1_F1(0) ),
                           "N7_VZT",   TS_IIF(m_PrevValid != NULL, "Продленный договор с", ""),
                           "N7_VZD1",  TS_IIF(m_PrevValid != NULL, m_BegValidDate, ""),
                           "N7_VZT1",  TS_IIF(m_PrevValid != NULL, "за", ""),
                           "N7_VZT2",  TS_IIF(m_PrevValid != NULL, F( N7_G2(0) + "-" + N7_C3(0) + "+1" ), ""),
                           "N7_VZT3",  TS_IIF(m_PrevValid != NULL, strdays( m_FormData.ReportDate - m_BegValidDate + 1), ""),
                           "N7_VZ1",   F( N7_P10(AmountLineT1-1) ),
                           "N7_VZ1_1", F( N7_R15(DeltaTable2 + (AmountLineT2-1)) ),
                           "N7_VZ1_2", F( N7_R10(AmountLineT1-1) + "+" + N7_U15(DeltaTable2 + (AmountLineT2-1)) ),
                           "N7_VZ1_3", F( "(" + N7_L4(0) + "+" + N7_L5(0) + ")/" + N7_L6(0) + "*" + N8_() + N8_A9(0) + "*100" ) );

    GL_VZ1 = N7_L4(0);
    GL_VZ1_1 = N7_L5(0);
    GL_VZ1_2 = N7_L6(0);

    /* печатаем таблицу "Закрытые векселя, приобретенные в отчетном периоде" */

    Query = RSDCommand( SqlQuery );
    Query.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
    Query.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
    Query.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
    Query.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query.addParam( "", RSDBP_IN, m_BegDate                       );
    Query.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
    Query.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
    Query.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
    Query.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
    Query.execute();
    RSD = TRsbDataSet(Query);

    RegisterTable( "N7_MainTable_1", "",
                   "N7_VZ2", "N7_VZ3", "N7_VZ4", "N7_VZ5", "N7_VZ6", "N7_VZ7", "N7_VZ8", "N7_VZ9", "N7_VZ10", "N7_VZ11",
                   "N7_VZ12", "N7_VZ13", "N7_VZ15", "N7_VZ16", "N7_VZ17", "N7_VZ18", "N7_VZ19", "N7_VZ20" );

    var m = 0; /* счётчик строк в таблице "Начисленный доход" вместе с итогами */

    var i = 0;
    var FVZ11 = "", FVZ13 = "", FVZ16 = "", FVZ17 = "", FVZ18 = "", FVZ20 = "";
    while( RSD.MoveNext() )

       DL_VA_GetBalanceDate(RSD.BCID, RSD.DealDate, @BalanceDate, null, @Cost, null, null, null, m_OrderFD.Order().rec.SfContrID );

       if( BalanceDate != date(0,0,0) )
          if( BalanceDate >= (m_BegDate-1) ) /* Дата поставки сделки покупки входит в отчётный период */
         
             ExStr = false;
             Период = ПериодПоМесяцам(BalanceDate, RSD.DealDate);
             FVZN5 = "";
             while( Период.СледующийМесяц(null, @BeginMon, @EndMon) )
                if( (ПолучитьСуммуПДДЗаПериод(RSD.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD.BCID, BeginMon, EndMon, FIROLE_PERCENT)) > 0.0 )
                   m = m + 1;
                   ExStr = true;
                end;
             end;
             if( ExStr )
                FVZN5 = N7_E20(DeltaTable3 + m);
                m = m + 1;
             end;
         
             RSD.IssuerTaxCode = ПолучитьИННВекселедателя(RSD.Issuer, RSD.IssuerTaxCode);
         
             PrintLineTable1( НомерКлиента(m_OrderFD.Order().rec.RegNum, false),
                              TS_IIF((RSD.IssuerTaxCode == ""), RSD.IssuerName, RSD.IssuerName + "/" + RSD.IssuerTaxCode),
                              GetVA_Kind(RSD.Formula),
                              TS_IIF(((RSD.BCNumber != "") and (RSD.BCSeries != "")), trim(RSD.BCNumber) + "," + trim(RSD.BCSeries), trim(RSD.BCNumber) + trim(RSD.BCSeries)),
                              SQL_ConvTypeDate(RSD.Start),
                              ДатаПогашения(RSD.BCTermFormula, SQL_ConvTypeDate(RSD.BCPresentationDate), SQL_ConvTypeDate(RSD.Maturity),
                                            SQL_ConvTypeDate(RSD.Expiry), SQL_ConvTypeDate(RSD.Start)),
                              УсловнаяДатаПогашения(RSD.BCTermFormula, SQL_ConvTypeDate(RSD.BCPresentationDate), SQL_ConvTypeDate(RSD.Maturity),
                                            SQL_ConvTypeDate(RSD.Expiry), SQL_ConvTypeDate(RSD.Start)),
                              BalanceDate,
                              RSD.Principal,
                              Cost,
                              TS_IIF((Formula == VS_IN_S_PC) OR (Formula == VS_IN_M_PC), (RSD.Price / pow(10, RSD.Point)), ""),
                              TS_IIF(ExStr, F(FVZN5), 0.0),
                              SQL_ConvTypeDate(RSD.DealDate),
                              RSD.BCCost,
                              F( N7_N10(i) + "-" + N7_L10(i) + "-" + N7_J10(i) ),
                              F( N7_N10(i) + "-" + N7_J10(i) ),
                              F( N7_P10(i) + "/" + N7_J10(i) + "*" + N8_() + N8_A9(0) + "/(" + N7_M10(i) + "-" + N7_H10(i) + ")*100" ),
                              F( N7_J10(i) + "*(" + N7_M10(i) + "-" + N7_H10(i) + ")" ) );
         
             delim = TS_IIF(FVZ11 == "", "", ";");
             FVZ11 = FVZ11 + delim + N7_J10(i);
             FVZ13 = FVZ13 + delim + N7_L10(i);
             FVZ16 = FVZ16 + delim + N7_N10(i);
             FVZ17 = FVZ17 + delim + N7_O10(i);
             FVZ18 = FVZ18 + delim + N7_P10(i);
             FVZ20 = FVZ20 + delim + N7_R10(i);
         
             i = i + 1;
          end;
       end;
    end;

    if( i == 0 ) /* ничего не напечатали */
       /* пустая строка с формулами */
       PrintLineTable1( "", "", "", "", "", "", "", "", "", 0, "", 0, "", 0,
                        F( N7_N10(i) + "-" + N7_L10(i) + "-" + N7_J10(i) ),
                        F( N7_N10(i) + "-" + N7_J10(i) ),
                        F( N7_P10(i) + "/" + N7_J10(i) + "*" + N8_() + N8_A9(i) + "/(" + N7_M10(i) + "-" + N7_H10(i) + ")*100" ),
                        0 );

       FVZ11 = N7_J10(i);
       FVZ13 = N7_L10(i);
       FVZ16 = N7_N10(i);
       FVZ17 = N7_O10(i);
       FVZ18 = N7_P10(i);
       FVZ20 = N7_R10(i);

       i = i + 1;
    end;

    /* строка с итогом */
    SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
    PrintLineTable1( "", "", "", "", "", "", "", "", "",
                     F( FormulaSUM() + "(" + FVZ11 + ")" ),
                     "",
                     F( FormulaSUM() + "(" + FVZ13 + ")" ),
                     "",
                     F( FormulaSUM() + "(" + FVZ16 + ")" ),
                     F( FormulaSUM() + "(" + FVZ17 + ")" ),
                     F( FormulaSUM() + "(" + FVZ18 + ")" ),
                     "",
                     F( FormulaSUM() + "(" + FVZ20 + ")" ) );
    EndTable();
    CopyAllSheetInTotalBook( "Векселя Закрытые", false, "N7_Table1", 0, "Векселя Закрытые" );


    /* печатаем таблицу "Закрытые векселя, приобретенные до отчетного периода" */

    Query1 = RSDCommand( SqlQuery );
    Query1.addParam( "", RSDBP_IN, VSORDLNK_K_SALE                 );
    Query1.addParam( "", RSDBP_IN, VSORDLNK_K_DRAW                 );
    Query1.addParam( "", RSDBP_IN, DL_VATRREPAY                    );
    Query1.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
    Query1.addParam( "", RSDBP_IN, m_BegDate                       );
    Query1.addParam( "", RSDBP_IN, m_FormData.ReportDate           );
    Query1.addParam( "", RSDBP_IN, VS_IN_DISCONT                   );
    Query1.addParam( "", RSDBP_IN, VS_IN_S_PC                      );
    Query1.addParam( "", RSDBP_IN, VS_IN_M_PC                      );
    Query1.execute();
    RSD1 = TRsbDataSet(Query1);

    RegisterTable( "N7_MainTable_2", "",
                   "N7_VZ2_1", "N7_VZ3_1", "N7_VZ4_1", "N7_VZ5_1", "N7_VZ6_1", "N7_VZ7_1", "N7_VZ8_1", "N7_VZ9_1", "N7_VZ10_1", "N7_VZ11_1", "N7_VZ12_1",
                   "N7_VZ13_1", "N7_VZ13_2", "N7_VZ15_1", "N7_VZ16_1", "N7_VZ17_1", "N7_VZ18_1", "N7_VZ18_2", "N7_VZ19_1", "N7_VZ19_2", "N7_VZ20_1" );

    i = 0;
    var FVZ11_1 = "", FVZ13_1 = "", FVZ16_1 = "", FVZ17_1 = "", FVZ18_1 = "", FVZ18_2 = "", FVZ20_1 = "";
    while( RSD1.MoveNext() )

       DL_VA_GetBalanceDate(RSD1.BCID, RSD1.DealDate, @BalanceDate, null, @Cost, null, null, null, m_OrderFD.Order().rec.SfContrID );

       if( BalanceDate != date(0,0,0) )
          if( BalanceDate < (m_BegDate-1) ) /* Дата поставки сделки покупки не входит в отчётный период */
         
             ExStr = false;
             Период = ПериодПоМесяцам(BalanceDate, RSD1.DealDate);
             FVZN5 = "";
             while( Период.СледующийМесяц(null, @BeginMon, @EndMon) )
                if( (ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BeginMon, EndMon, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BeginMon, EndMon, FIROLE_PERCENT)) > 0.0 )
                   m = m + 1;
                   ExStr = true;
                end;
             end;
             if( ExStr )
                FVZN5 = N7_E20(DeltaTable3 + m);
                m = m + 1;
             end;
         
             RSD1.IssuerTaxCode = ПолучитьИННВекселедателя(RSD1.Issuer, RSD1.IssuerTaxCode);
         
             PrintLineTable2( НомерКлиента(m_OrderFD.Order().rec.RegNum, false),
                              TS_IIF((RSD1.IssuerTaxCode == ""), RSD1.IssuerName, RSD1.IssuerName + "/" + RSD1.IssuerTaxCode),
                              GetVA_Kind(RSD1.Formula),
                              TS_IIF(((RSD1.BCNumber != "") and (RSD1.BCSeries != "")), trim(RSD1.BCNumber) + "," + trim(RSD1.BCSeries), trim(RSD1.BCNumber) + trim(RSD1.BCSeries)),
                              SQL_ConvTypeDate(RSD1.Start),
                              ДатаПогашения(RSD1.BCTermFormula, SQL_ConvTypeDate(RSD1.BCPresentationDate), SQL_ConvTypeDate(RSD1.Maturity),
                                            SQL_ConvTypeDate(RSD1.Expiry), SQL_ConvTypeDate(RSD1.Start)),
                              УсловнаяДатаПогашения(RSD1.BCTermFormula, SQL_ConvTypeDate(RSD1.BCPresentationDate), SQL_ConvTypeDate(RSD1.Maturity),
                                            SQL_ConvTypeDate(RSD1.Expiry), SQL_ConvTypeDate(RSD1.Start)),
                              BalanceDate,
                              RSD1.Principal,
                              Cost,
                              (RSD1.Price / pow(10, RSD1.Point)),
                              TS_IIF(ExStr, F(FVZN5), 0.0),
                              ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BalanceDate, m_BegDate-1, FIROLE_DISCOUNT) + ПолучитьСуммуПДДЗаПериод(RSD1.BCID, BalanceDate, m_BegDate-1, FIROLE_PERCENT),
                              SQL_ConvTypeDate(RSD1.DealDate),
                              RSD1.BCCost,
                              F( N7_O15(DeltaTable2+i) + "-" + N7_L15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                              F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                              F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) + "-" + N7_M15(DeltaTable2+i) ),
                              F( N7_Q15(DeltaTable2+i) + "/" + N7_J15(DeltaTable2+i) + "*" + N8_() + N8_A9(0) + "/(" + N7_N15(DeltaTable2+i) + "-" + N7_H15(DeltaTable2+i) + ")*100" ),
                              F( N7_N15(DeltaTable2+i) + "-" + N7_C3(0) + "+1" ),
                              F( N7_J15(DeltaTable2+i) + "*" + N7_T15(DeltaTable2+i) ) );
         
             delim = TS_IIF(FVZ11_1 == "", "", ";");
             FVZ11_1 = FVZ11_1 + delim + N7_J15(DeltaTable2+i);
             FVZ13_1 = FVZ13_1 + delim + N7_L15(DeltaTable2+i);
             FVZ16_1 = FVZ16_1 + delim + N7_O15(DeltaTable2+i);
             FVZ17_1 = FVZ17_1 + delim + N7_P15(DeltaTable2+i);
             FVZ18_1 = FVZ18_1 + delim + N7_Q15(DeltaTable2+i);
             FVZ18_2 = FVZ18_2 + delim + N7_R15(DeltaTable2+i);
             FVZ20_1 = FVZ20_1 + delim + N7_U15(DeltaTable2+i);
         
             i = i + 1;
          end;
       end;
    end;

    if( i == 0 ) /* ничего не напечатали */
       /* пустая строка с формулами */
       PrintLineTable2( "", "", "", "", "", "", "", "", "", 0, "", 0, 0, "", 0,
                        F( N7_O15(DeltaTable2+i) + "-" + N7_L15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                        F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) ),
                        F( N7_O15(DeltaTable2+i) + "-" + N7_J15(DeltaTable2+i) + "-" + N7_M15(DeltaTable2+i) ),
                        F( N7_Q15(DeltaTable2+i) + "/" + N7_J15(DeltaTable2+i) + "*" + N8_() + N8_A9(0) + "/(" + N7_N15(DeltaTable2+i) + "-" + N7_H15(DeltaTable2+i) + ")*100" ),
                        0,
                        F( N7_J15(DeltaTable2+i) + "*" + N7_T15(DeltaTable2+i) ) );

       FVZ11_1 = N7_J15(DeltaTable2+i);
       FVZ13_1 = N7_L15(DeltaTable2+i);
       FVZ16_1 = N7_O15(DeltaTable2+i);
       FVZ17_1 = N7_P15(DeltaTable2+i);
       FVZ18_1 = N7_Q15(DeltaTable2+i);
       FVZ18_2 = N7_R15(DeltaTable2+i);
       FVZ20_1 = N7_U15(DeltaTable2+i);

       i = i + 1;
    end;

    /* строка с итогом */
    SetCurrentLineFont( 10, true, false, null, null, COLOR_GRAY );
    PrintLineTable2( "", "", "", "", "", "", "", "", "",
                     F( FormulaSUM() + "(" + FVZ11_1 + ")" ),
                     "",
                     F( FormulaSUM() + "(" + FVZ13_1 + ")" ),
                     "", "",
                     F( FormulaSUM() + "(" + FVZ16_1 + ")" ),
                     F( FormulaSUM() + "(" + FVZ17_1 + ")" ),
                     F( FormulaSUM() + "(" + FVZ18_1 + ")" ),
                     F( FormulaSUM() + "(" + FVZ18_2 + ")" ),
                     "", "",
                     F( FormulaSUM() + "(" + FVZ20_1 + ")" ) );
    EndTable();
    CopyAllSheetInTotalBook( "Векселя Закрытые", false, "N7_Table2", 0, "Векселя Закрытые" );

    /* печатаем таблицу "Начисленный доход" */

    if( (PrT1 == true) or (PrT2 == true) )

       var RegTable = false;
       i = 0;

       if( PrT1 == true ) /* если первая таблица не пустая */
          PrintPartTable3(true, DeltaTable3, @i, @RegTable);
       end;
       if( PrT2 == true ) /* если вторая таблица не пустая */
          PrintPartTable3(false, DeltaTable3, @i, @RegTable);
       end;

       if( RegTable == true )
          EndTable();
          CopyAllSheetInTotalBook( "Векселя Закрытые", false, "N7_Table3", 0, "Векселя Закрытые" );
       end;

    end;

  END;


  PRIVATE MACRO Печать_Отчёт();

    var SqlQuery_ДС = " SELECT distinct accdoc.t_Account, accdoc.t_chapter, accdoc.t_currency, " +
                      "        abs(rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) rest " +
                      "   FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dmctempl_dbt templ   " +
                      "  WHERE accdoc.t_catid = categ.t_id                                    " +
                      "    AND accdoc.t_clientcontrid = ?                                     " +
                      "    AND abs(rsb_account.restall(accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) > 0 " +
                      "    AND categ.t_leveltype = 1                                          " +
                      "    AND categ.t_code = 'ДС ДУ'                                         " +
                      "    AND templ.t_catid = accdoc.t_catid                                 " +
                      "    AND templ.t_number = accdoc.t_templnum                             " +
                      "    AND (CASE                                                          " +
                      "            WHEN (categ.t_param1 = 2818 AND categ.t_class1 = 1702)     " +
                      "               THEN templ.t_value1                                     " +
                      "            WHEN (categ.t_param2 = 2818 AND categ.t_class2 = 1702)     " +
                      "               THEN templ.t_value2                                     " +
                      "            WHEN (categ.t_param3 = 2818 AND categ.t_class3 = 1702)     " +
                      "               THEN templ.t_value3                                     " +
                      "            WHEN (categ.t_param4 = 2818 AND categ.t_class4 = 1702)     " +
                      "               THEN templ.t_value4                                     " +
                      "            WHEN (categ.t_param5 = 2818 AND categ.t_class5 = 1702)     " +
                      "               THEN templ.t_value5                                     " +
                      "            WHEN (categ.t_param6 = 2818 AND categ.t_class6 = 1702)     " +
                      "               THEN templ.t_value6                                     " +
                      "            WHEN (categ.t_param7 = 2818 AND categ.t_class7 = 1702)     " +
                      "               THEN templ.t_value7                                     " +
                      "            WHEN (categ.t_param8 = 2818 AND categ.t_class8 = 1702)     " +
                      "               THEN templ.t_value8                                     " +
                      "         END                                                           " +
                      "        ) != 41                                                        ";/*!!! 1 "Торговый" (для 1ОБ)*/

    var Query_Итог = " (SELECT tstotal.t_BeginDate, tstotal.t_RestAmount, tstotal.t_EventID, tstotal.t_TotalType " +
                     "   FROM dtstotal_dbt tstotal    " +
                     "  WHERE tstotal.t_OrderID   = ? " +
                     "    AND tstotal.t_TotalType = ? " +
                     "    AND tstotal.t_BeginDate >= ? " +
                     "    AND tstotal.t_BeginDate <= ? " +
                     "    AND tstotal.t_Sign < 0      " + 
                     "  union                         " +
                     " SELECT tstotal.t_BeginDate, tstotal.t_RestAmount, tstotal.t_EventID, tstotal.t_TotalType " +
                     "   FROM dtstotal_dbt tstotal    " +
                     "  WHERE tstotal.t_OrderID   = ? " +
                     "    AND tstotal.t_TotalType = ? " +
                     "    AND tstotal.t_BeginDate >= ? " +
                     "    AND tstotal.t_BeginDate <= ? " +
                     "    AND tstotal.t_Sign > 0      " + 
                     "    AND tstotal.t_EventID   = ?) " + 
                     " ORDER BY t_BeginDate    ";

    MACRO SqlQuery_Итог( sign:integer, КУС:bool ):string

       var RetVal = " SELECT tstotal.t_BeginDate, tstotal.t_RestAmount, tstotal.t_EventID " +
                    "   FROM dtstotal_dbt tstotal     " +
                    "  WHERE tstotal.t_OrderID   = ?  " +
                    "    AND tstotal.t_TotalType = ?  " +
                    "    AND tstotal.t_BeginDate >= ? " +
                    "    AND tstotal.t_BeginDate <= ? ";
       if( (sign == null) or (sign < 0) )
          RetVal = RetVal + " AND tstotal.t_Sign < 0 ";
       else
          RetVal = RetVal + " AND tstotal.t_Sign > 0 ";
       end;

       if( (КУС != null) and (КУС == true) )
          RetVal = RetVal + " AND tstotal.t_EventID = ? ";
       end;

       RetVal = RetVal + " ORDER BY tstotal.t_BeginDate ";

       return RetVal;
    END;

    MACRO IsProlong():BOOL
       var RetVal = false;
       var sql = RSDCommand( " SELECT count(tsvalid.t_begindate) as LastDate     " +
                             "   FROM dtsvalid_dbt tsvalid, dtsorder_dbt tsorder " +
                             "  WHERE tsorder.t_sfcontrid  = ?                   " +
                             "    AND tsvalid.t_orderid    = tsorder.t_id        " +
                             "    AND tsvalid.t_begindate <= ?                   " );
       sql.addParam("", RSDBP_IN, m_OrderFD.Sfcontr.rec.ID );
       sql.addParam("", RSDBP_IN, m_FormData.ReportDate    );
       sql.execute();
       var Dt = TRsbDataSet(sql);
      
       if( Dt.movenext() and (Dt.LastDate > 1) )
          RetVal = true;
       end;

       return RetVal;
    end;

    OrderList();
    while( OrderNext() )

       m_PrintOrderN2 = false; m_PrintOrderN3 = false; m_PrintOrderN4 = false; m_PrintOrderN5 = false; m_PrintOrderN6 = false; m_PrintOrderN7 = false;
       GL_FVA3 = ""; GL_FVB22_1 = ""; GL_FVA5 = ""; GL_FVA6 = ""; GL_VB27 = "";
       GL_VZ1 = ""; GL_VZ1_1 = ""; GL_VZ1_2 = "";
       GL_FAA3 = ""; GL_AA14 = ""; GL_FAC2 = ""; GL_FAA10 = ""; GL_FAA5 = ""; GL_AA15 = "";
       GL_FOA17_1 = ""; GL_FOA24 = ""; GL_OA19 = ""; GL_FOA21_1 = ""; GL_FOD2 = ""; GL_FOA15 = ""; GL_FOA11 = ""; GL_OA20 = "";

       if( (m_BegDate != date(0,0,0)) and (m_FormData.ReportDate != date(0,0,0)) and (m_BegDate <= m_FormData.ReportDate) )

          if( m_SheetN1 == false )
             UseNewSheetInTotalBook();
             m_SheetN1 = true;
          end;
          SetActiveSheet( "ИТОГ" );

          m_PrevValid = m_OrderFD.Valid( m_BegValidDate - 1, true );
          var СК = TArray(), БС = TArray(), Array_EOY_F5 = TArray(), Sum;
          var SqlQuery, DataSet;
          var year:integer;

          БСПоДатам(@БС, m_BegDate, m_FormData.ReportDate);

          /* Заголовок отчета */
          PrintFormatString( "",
                             "N1_C1", m_OrderFD.Number(),
                             "N1_F1", m_FormData.ReportDate,
                             "N1_C2", ПолучитьКороткоеИмяСубъектаДУ( m_FormData.Trustor ),
                             "N1_C3", m_BegValidDate,
                             "N1_E3", m_EndValidDate );

          /* Капитал в управлении */
          RegisterTable( "N1_MainTable_1", "",
                         "A5", "N1_B5", "C5", "D5", "N1_E5", "N1_F5", "N1_G5", "N1_I5", "N1_J5" );

          СК.Size = 0;
//          if (IsProlong())
             if( ПолучитьИтогДУ( m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, m_BegDate, NULL, NULL, @Sum ) )
                Sum = $0;
             end;
             СК[СК.Size] = СуммаПоДатам(m_BegDate, Sum);
//          end;

          SqlQuery = RSDCommand( " select distinct t_BeginDate " +
                                 "   from dtstotal_dbt         " +
                                 "  where t_totaltype = ?      " +
                                 "    and t_orderid   = ?      " +
                                 "    and t_BeginDate < ?      " +
                                 "    and t_BeginDate > ?      " +
                                 " order by t_BeginDate        " );

          SqlQuery.addParam("", RSDBP_IN, ДУ_ИТОГ_СК               );
          SqlQuery.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID );
          SqlQuery.addParam("", RSDBP_IN, m_FormData.ReportDate    );
          SqlQuery.addParam("", RSDBP_IN, m_BegDate                );
          SqlQuery.execute();
          DataSet = TRsbDataSet(SqlQuery);

          while( DataSet.MoveNext() )
             if( ПолучитьИтогДУ( m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, SQL_ConvTypeDate(DataSet.BeginDate), NULL, NULL, @Sum ) )
                Sum = $0;
             end;
             СК[СК.Size] = СуммаПоДатам(SQL_ConvTypeDate(DataSet.BeginDate)-1, Sum);
          end;
          СК[СК.Size] = СуммаПоДатам(m_FormData.ReportDate, 0);

          m_delta1 = СК.Size - 2;
          m_delta2 = m_delta1 - 1;

          m_delta3 = m_delta2 + TS_IIF(БС.Size > 18, БС.Size - 18, 0) - 1; /* если таблица "Изменение базовой ставки для расчета отклонения" размножилась и стала ниже чем таблица "Доходы и расходы ДУ" */

          var Amount_ДС:integer = 0; /* количество строк в таблице "Денежные средства" */
          var SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_ДС + " ) " );
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
          SqlData.execute();
          var DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_ДС = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          m_delta4 = m_delta3 + (Amount_ДС-1) + 2 - 1;

          var Amount_Н_Кдв:integer = 0; /* количество строк в таблице "Комиссия за досрочный вывод" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Кдв);
          SqlData.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Н_Кдв = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_Н_Купр:integer = 0; /* количество строк в таблице "Комиссия за управление" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Купр);
          SqlData.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Н_Купр = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_Р_Квн:integer = 0; /* количество строк в таблице "Оплата внешних комиссий" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог(-1, true) + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Р_Квн);
          SqlData.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.addParam("", RSDBP_IN, TS_DemandEvent("65"));
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Р_Квн = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_m = max(Amount_Н_Кдв, max(Amount_Н_Купр, Amount_Р_Квн));
          m_delta5 = m_delta4 + (Amount_m-1);

          var Amount_Д_Двд:integer = 0; /* количество строк в таблице "Дивиденды" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + SqlQuery_Итог(1) + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Д_Двд);
          SqlData.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Д_Двд = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var Amount_Н_Дх:integer = 0; /* количество строк в таблице "Капитализация и выплата прибыли" */
          SqlData = RSDCommand( " select count(1) NRec from ( " + Query_Итог + " ) " );
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Дх);
          SqlData.addParam("", RSDBP_IN, m_BegDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Налог);
          SqlData.addParam("", RSDBP_IN, m_BegDate);
          SqlData.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData.addParam("", RSDBP_IN, TS_DemandEvent("98"));
          SqlData.execute();
          DataSet_ = TRsbDataSet(SqlData);
          if( DataSet_.MoveNext() )
             Amount_Н_Дх = SQL_ConvTypeInteger(DataSet_.NRec);
          end;

          var i=0; Array_EOY_F5.size = 0;
          var H5J5 = "";
          while( i < (СК.Size-1) )

             var rsd, ds;
             var RestAmount:money = $0.0, Sign:integer = 0, EventID:integer = 0;
             var B5:string = "";
             var ДатаНачала:date = СК[i].Дата + TS_IIF(i==0, 0, 1);

             rsd = RSDCommand( " select t_RestAmount, t_Sign, t_EventID " +
                               "   from dtstotal_dbt                    " +
                               "  where t_totaltype = ?                 " +
                               "    and t_orderid   = ?                 " +
                               "    and t_BeginDate = ?                 " );

             rsd.addParam( "", RSDBP_IN, ДУ_ИТОГ_СК               );
             rsd.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.ID );
             rsd.addParam( "", RSDBP_IN, ДатаНачала               );
             rsd.execute();
             ds = TRsbDataSet( rsd );
             while( ds.MoveNext() )
                RestAmount = RestAmount + (SQL_ConvTypeInteger(ds.rec.Sign) * SQL_ConvTypeSum(ds.rec.RestAmount));
                if( EventID != -1)
                   if( EventID == 0 )
                      EventID = SQL_ConvTypeInteger(ds.rec.EventID);
                   elif( EventID != SQL_ConvTypeInteger(ds.rec.EventID) )
                      EventID = -1;
                   end;
                end;
             end;

             var Дата_E5 = "";
             rsd = RSDCommand( " select tsiorqst.t_FactTransferDate                    " +
                               "   from dtsiorqst_dbt tsiorqst                         " +
                               "  where tsiorqst.t_ID in ( select t_DocID              " +
                               "                             from dtstotal_dbt         " +
                               "                            where t_totaltype = ?      " +
                               "                              and t_orderid   = ?      " +
                               "                              and t_BeginDate = ?      " +
                               "                              and t_DocKind in(?, ?) ) " +
                               " order by tsiorqst.t_ActiveKind                        " );

             rsd.addParam( "", RSDBP_IN, ДУ_ИТОГ_СК               );
             rsd.addParam( "", RSDBP_IN, m_OrderFD.Order().rec.ID );
             rsd.addParam( "", RSDBP_IN, ДатаНачала               );
             rsd.addParam( "", RSDBP_IN, TS_DOC_DECLAR            );
             rsd.addParam( "", RSDBP_IN, TS_DOC_DECLAR_OUT        );
             rsd.execute();
             ds = TRsbDataSet( rsd );
             if( ds.MoveNext() and (ds.FactTransferDate != null) )
                Дата_E5 = SQL_ConvTypeDate(ds.FactTransferDate);
             end;

             if( RestAmount != $0.0 )
                if( RestAmount > 0 )
                   if( EventID == TS_DemandEvent("85") )
                      B5 = "Введено в управление";
                   elif( EventID == TS_DemandEvent("96") )
                      B5 = "Капитализация прибыли";
                   /*elif( EventID == -1 /*несколько*/ ) */
                   end;
                else
                   B5 = "Выведено из управления";
                end;
             else
                B5 = "Входящий остаток капитала";
             end;

             PrintTableLine( "N1_B5", B5,                                                              null,
                             "N1_E5", Дата_E5,                                                         null,
                             "N1_F5", ДатаНачала,                                                      null,
                             "N1_G5", TS_IIF((RestAmount == $0.0), "", RestAmount),                    null,
                             "N1_H5", СК[i].Сумма,                                                     null,
                             "N1_I5", ДоходПоБазовойСтавке(БС, СК, i, Array_EOY_F5.Size, IsProlong()), null,
                             "N1_J5", СрокУправления(СК, i),                                           null );

             DateSplit( ДатаНачала, null, null, year );
             Array_EOY_F5[Array_EOY_F5.Size] = ТаблицаПромРез( B5, ДатаНачала, date(31,12,year) );
             H5J5 = H5J5 + TS_IIF(i == 0, "", ";") + N1_H5(i) + "*" + N1_J5(i);

             i = i + 1;
          end;

          EndTable();

          PrintFormatString( "",
                             "N1_H6", СК[m_delta1].Сумма,
                             "N1_J7", F( FormulaSUM() + "(" + N1_J5(0) + ":" + N1_J5(m_delta1) + ")" ),
                             "N1_H8", F( "(" + FormulaSUM() + "(" + H5J5 + "))/" + N1_J7(m_delta1) ) );
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table1", 0, "ИТОГ" );

          Печать_АкцииЗакрытые();
          Печать_Акции( m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) );
          Печать_ОблигацииЗакрытые();
          Печать_Облигации();
          Печать_ВекселяЗакрытые();
          Печать_Векселя();

          SetActiveSheet( "ИТОГ" );

          /* Доходность договора */
          var RateComM = 0.0, RateComP = 0.0, RateComS = 0.0;
          var BB1 = string(ДУ_ДнейВГоду(m_BegDate));
          var BB2 = string(ДУ_ДнейВГоду(m_FormData.ReportDate));
          /* определяем границы "текущего месяца" */
          var BegCurDate:date, EndCurDate:date;
          var CurMon:integer, CurYear:integer;
          var EndValidMon:integer, EndValidYear:integer;
          var m_BegDateMon:integer, m_BegDateYear:integer;
          DateSplit( m_FormData.ReportDate, null, CurMon, CurYear );
          DateSplit( m_EndValidDate, null, EndValidMon, EndValidYear );
          DateSplit( m_BegDate, null, m_BegDateMon, m_BegDateYear );
         
          if( (m_BegDateYear == CurYear) and (m_BegDateMon == CurMon) )
             BegCurDate = m_BegDate;
          else
             BegCurDate = date(1, CurMon, CurYear);
          end;
          if( (EndValidYear == CurYear) and (EndValidMon == CurMon) )
             EndCurDate = m_EndValidDate;
          else
             EndCurDate = date(LastDay(CurMon, CurYear), CurMon, CurYear);
          end;

          var CommNumberM = ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSM", m_FormData.ReportDate);
          var CommNumberP = ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSP", m_FormData.ReportDate);
          var CommNumberS = ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSS", m_FormData.ReportDate);

          ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, CommNumberM, m_FormData.ReportDate, 1, @RateComM, null );
          ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, CommNumberP, m_FormData.ReportDate, 1, @RateComP, null );
          ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, CommNumberS, m_FormData.ReportDate, 1, @RateComS, null );

          var DifferentYear:bool = false, ChRate:bool = false;
          /* Проверим менялось ли количество дней в году в ОП */
          if( m_BegDateYear != CurYear )
             var BegAmount:integer = ДУ_ДнейВГоду( m_BegDateYear );
             var TempCurYear = m_BegDateYear + 1;
             while( TempCurYear <= CurYear )
                if( BegAmount != ДУ_ДнейВГоду( TempCurYear ) )
                   DifferentYear = true; break;
                end;
                TempCurYear = TempCurYear + 1;
             end;
          end;

          if( DifferentYear == false )
             /* Проверим менялась ли ставка комиссии за управление в ОП */
             var TempCurDate = m_BegDate + 1, BegRate;
             ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSM", m_BegDate), m_BegDate, 1, @BegRate, null );
             while( TempCurDate <= m_FormData.ReportDate )
                var Rate;
                ПолучитьСтавкуКомиссии(m_OrderFD.SfContr().rec.ID, ПолучитьНомерКомиссии(m_OrderFD.SfContr().rec.ID, "TSM", TempCurDate), TempCurDate, 1, @Rate, null );
                if( BegRate != Rate )
                   ChRate = true; break;
                end;
                TempCurDate = TempCurDate + 1;
             end;
          end;

          var ЗаУправлениеНеНачисленное;
          if( (DifferentYear == false) and (ChRate == false) )
             ЗаУправлениеНеНачисленное = F( N1_H8(m_delta1) + "*" + N1_F12(m_delta2) + "*" + N1_J7(m_delta1) + "/" + N8_() + N8_A9(0) + "+" + N1_H44(m_delta3) );
          else
             ЗаУправлениеНеНачисленное = $0.0;
             if( CommNumberM > 0 )
                var ConCom = TRecHandler( "sfconcom.dbt" );
                var sfdefcom_parm = TRecHandler( "sfdefcom_parm.rec" );
                while( SfGetConCom( m_OrderFD.Order().rec.SfContrID, SF_FEE_TYPE_PERIOD, ConCom ) == true )
                   if( ConCom.rec.CommNumber == CommNumberM )
                      УстановитьМоментВзиманияКомиссии(ВзимаетсяВсегда);
                      SfPeriodOprsCalcCom( m_OrderFD.SfContr(), ConCom, null, m_FormData.ReportDate, m_FormData.ReportDate, 
                                           0/*SFREP_NONE*/, false, 2/*OBJGROUP_SFCOM_KIND*/, "TSM", @sfdefcom_parm, SF_PERIOD_CALC );
                      ЗаУправлениеНеНачисленное = sfdefcom_parm.rec.CommSum;
                      break;
                   end;
                end;
             end;
          end;

          PrintFormatString( "",
                             "N1_F12", RateComM/100.0,
                             "N1_G12", ЗаУправлениеНеНачисленное,
                             "N1_G13", F( FormulaIF() + "(" + N1_K13(m_delta2) + "=0;0;" + FormulaSUM() + "(" + N1_I5(0) + ":" + N1_I5(m_delta1) + ")" + "+" + N1_H46(m_delta3) + "+" + N1_H47(m_delta3) + "+" + N1_H52(m_delta3) + "+" + N1_H54(m_delta3) + ")"),
                             "N1_G14", ДоходПоБазовойСтавкеЗаТекущийМесяц(БС, СК, BegCurDate, EndCurDate),
                             "N1_G15", F( FormulaIF() + "(" + N1_C3(0) + "=" + N1_F1(0) + ";" + N1_H40(m_delta3) + "/" + N1_H8(m_delta1) + "*" + BB1 + "*100;" + N1_H40(m_delta3) + "/" + N1_H8(m_delta1) + "*" + BB1 + "*" + BB2 + "*100/(" + BB1 + "*(" + N8_() + N8_A13(0) + "-" + N1_C3(0) + TS_IIF(IsProlong()," + 1","") + ")+" + BB2 + "*(" + N1_F1(0) + "-" + N8_() + N8_A13(0) + ")))" ),
                             "N1_G16", F( N1_H55(m_delta3) + "-" + N1_G13(m_delta2) + "-" + N1_G12(m_delta2) ) );

          var UseNDFL = TS_IsPayerNPTaxAllCheck( m_FormData.Trustor, m_FormData.ReportDate );
          /* Доходы и расходы ДУ */
          PrintFormatString( "",
                             "N1_F21", F( "1-" + N1_F24(m_delta2) ),
                             "N1_F22", RateComP/100,
                             "N1_F23", RateComM/100,
                             "N1_F24", RateComS/100,

                             "N1_G18", F( N1_H40(m_delta3) ),
                             "N1_G20", ДоходПоБазовойСтавкеЗаОП(БС, СК, IsProlong() ),
                             "N1_G21", F( FormulaMAX() + "(0;(" + N1_G18(m_delta2) + "-" + N1_G20(m_delta2) + "-" + N1_G23(m_delta2) + "-" + N1_G24(m_delta2) + "))" ),
                             "N1_G22", F( "-" + N1_H45(m_delta3) ),
                             "N1_G23", F( N1_G12(m_delta2) + "-" + N1_H44(m_delta3) ),
                             "N1_G24", F( FormulaMAX() + "(0;(" + N1_G18(m_delta2) + "-" + N1_G20(m_delta2) + "-" + N1_G23(m_delta2) + ")*" + N1_F24(m_delta2) + ")" ),
                             "N1_G25", F( N1_G18(m_delta2) + "-" + N1_G22(m_delta2) + "-" + N1_G23(m_delta2) + "-" + N1_G24(m_delta2) ),
                             "N1_G26", F( N1_G80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),
                             "N1_G27", F( N1_H80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),
                             "N1_G28", F( FormulaMAX() + "(0;" + N1_G25(m_delta2) + "-" + N1_G27(m_delta2) + "-" + N1_G30(m_delta2) + ")" ),
                             "N1_G29", F( N1_G25(m_delta2) + "-" + N1_G26(m_delta2) + "-" + N1_G27(m_delta2) + "-" + N1_G30(m_delta2) ),
                             "N1_G30", TS_IIF(not UseNDFL, 0.0, F( FormulaROUND() + "((" + N1_G25(m_delta2) + "-" + N1_F55(m_delta3) + "+" + N1_G24(m_delta2) + "-" + N1_H36(m_delta2) + ")*0" + DecimalSeparator + "13;0)-" + N1_G27(m_delta2) ) ),
                             "N1_H25", F( FormulaIF() + "(" + N1_C3(0) + "=" + N1_F1(0) + ";" + N1_G25(m_delta2) + "/" + N1_H8(m_delta1) + "*" + BB1 + ";" + N1_G25(m_delta2) + "/" + N1_H8(m_delta1) + "*" + BB1 + "*" + BB2 + "/(" + BB1 + "*(" + N8_() + N8_A13(0) + "-" + N1_C3(0) + TS_IIF(IsProlong()," + 1","") + ")+" + BB2 + "*(" + N1_F1(0) + "-" + N8_() + N8_A13(0) + ")))" ),
                             "N1_H28", F( FormulaIF() + "(" + N1_C3(0) + "=" + N1_F1(0) + ";" + N1_G28(m_delta2) + "/" + N1_H8(m_delta1) + "*" + BB1 + ";" + N1_G28(m_delta2) + "/" + N1_H8(m_delta1) + "*" + BB1 + "*" + BB2 + "/(" + BB1 + "*(" + N8_() + N8_A13(0) + "-" + N1_C3(0) + TS_IIF(IsProlong()," + 1","") + ")+" + BB2 + "*(" + N1_F1(0) + "-" + N8_() + N8_A13(0) + ")))" ) );

          /* Изменение базовой ставки для расчета отклонения */
          RegisterTable( "N1_MainTable_2", "",
                         "N1_J13", "N1_K13", "N1_L13" );

          i = 0;
          var F_rate:string = "";
          while( i < БС.Size )
             F_rate = F( ДУ_ЧислоCЗаданнойТочностью(БС[i].Сумма/100, 15) );
             PrintTableLine( "N1_J13", БС[i].Дата,  null,
                             "N1_K13", F_rate, null,
                             "N1_L13", F_rate, null);
             i = i + 1;
          end;

          EndTable();
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table2", 0, "ИТОГ" );

          /* Активы, доходы и расходы */

          var Скупр:money = $0.0, Скусп:money = $0.0, Скдв:money = $0.0, Сндх:money = $0.0, Снналог:money = $0.0;
          var НКупр_нпдд:money = $0.0, НКусп_нпдд:money = $0.0, НКдв_нпдд:money = $0.0, НДх_нпдд:money = $0.0;
          var Н_Купр_опдд:money = $0.0, Н_Кусп_опдд:money = $0.0, Н_Кдв_опдд:money = $0.0, Н_Дх_опдд:money = $0.0, Н_Налог_опдд:money = $0.0;
          var Н_Купр_ум:money = $0.0, Н_Кусп_ум:money = $0.0, Н_Кдв_ум:money = $0.0, Н_Дх_ум:money = $0.0, Н_Налог_ум:money = $0.0;
          var Н_Купр_ум_beg:money = $0.0, Н_Кусп_ум_beg:money = $0.0, Н_Кдв_ум_beg:money = $0.0, Н_Дх_ум_beg:money = $0.0, Н_Налог_ум_beg:money = $0.0;
          var Н_Купр_ум_end:money = $0.0, Н_Кусп_ум_end:money = $0.0, Н_Кдв_ум_end:money = $0.0, Н_Дх_ум_end:money = $0.0, Н_Налог_ум_end:money = $0.0;
          var ННалог_0101:money = $0.0;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, NULL, @НКупр_нпдд))
             НКупр_нпдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, NULL, @НКусп_нпдд))
             НКусп_нпдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, NULL, @НКдв_нпдд))
             НКдв_нпдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, NULL, @НДх_нпдд))
             НДх_нпдд = $0.0;
          end;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @Н_Купр_опдд))
             Н_Купр_опдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @Н_Кусп_опдд))
             Н_Кусп_опдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @Н_Кдв_опдд))
             Н_Кдв_опдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @Н_Дх_опдд))
             Н_Дх_опдд = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @Н_Налог_опдд))
             Н_Налог_опдд = $0.0;
          end;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, @Н_Купр_ум_beg, NULL))
             Н_Купр_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_Купр_ум_end, NULL))
             Н_Купр_ум_end = $0.0;
          end;
          Н_Купр_ум = Н_Купр_ум_end - Н_Купр_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, @Н_Кусп_ум_beg, NULL))
             Н_Кусп_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_Кусп_ум_end, NULL))
             Н_Кусп_ум_end = $0.0;
          end;
          Н_Кусп_ум = Н_Кусп_ум_end - Н_Кусп_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, @Н_Кдв_ум_beg, NULL))
             Н_Кдв_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_Кдв_ум_end, NULL))
             Н_Кдв_ум_end = $0.0;
          end;
          Н_Кдв_ум = Н_Кдв_ум_end - Н_Кдв_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, @Н_Дх_ум_beg, NULL))
             Н_Дх_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_Дх_ум_end, NULL))
             Н_Дх_ум_end = $0.0;
          end;
          Н_Дх_ум = Н_Дх_ум_end - Н_Дх_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, null, 0, NULL, NULL, NULL, date(1,1,CurYear)-1, NULL, @Н_Налог_ум_beg, NULL))
             Н_Налог_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_Налог_ум_end, NULL))
             Н_Налог_ум_end = $0.0;
          end;
          Н_Налог_ум = Н_Налог_ум_end - Н_Налог_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, null, 0, NULL, NULL, NULL, date(1,1,CurYear)-1, NULL, NULL, @ННалог_0101))
             ННалог_0101 = $0.0;
          end;

          if( (НКупр_нпдд > 0) and (Н_Купр_ум < НКупр_нпдд) )
             Скупр = НКупр_нпдд - Н_Купр_ум;
          end;
          if( (НКусп_нпдд > 0) and (Н_Кусп_ум < НКусп_нпдд) )
             Скусп = НКусп_нпдд - Н_Кусп_ум;
          end;
          if( (НКдв_нпдд > 0) and (Н_Кдв_ум < НКдв_нпдд) )
             Скдв = НКдв_нпдд - Н_Кдв_ум;
          end;
          if( (НДх_нпдд > 0) and (Н_Дх_ум < НДх_нпдд) )
             Сндх = НДх_нпдд - Н_Дх_ум;
          end;
          if( (ННалог_0101 > 0) and (Н_Налог_ум < ННалог_0101) )
             Снналог = ННалог_0101 - Н_Налог_ум;
          end;

          PrintFormatString( "",
                             "N1_C33", TS_IIF(m_PrintOrderN6, F( N6_() + GL_FVA3 + "+" + N6_() + GL_FVB22_1 ), 0.0),
                             "N1_D33", TS_IIF(m_PrintOrderN7, F( N7_() + GL_VZ1 + "+" + N7_() + GL_VZ1_1 ), 0.0),
                             "N1_F33", TS_IIF(m_PrintOrderN6, F( N6_() + GL_FVA5 + "+" + N6_() + GL_FVA6 + "-" + N6_() + GL_FVB22_1 ), 0.0),
                             "N1_G33", F( N1_F34(m_delta3) + "+" + N1_C34(m_delta3) ),
                             "N1_H33", F( N1_G34(m_delta3) + "-" + N1_C34(m_delta3) + "+" + N1_D34(m_delta3) ),
                             "N1_I33", TS_IIF(m_PrintOrderN6, F( N6_() + GL_VB27 ), 0.0),
                             "N1_J33", F( N1_G34(m_delta3) + "/(" + N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) + ")*100" ),

                             "N1_C34", TS_IIF(m_PrintOrderN2, F( N2_() + GL_FAA3 ), 0.0),
                             "N1_D34", TS_IIF(m_PrintOrderN2, F( N2_() + GL_AA14 ), 0.0),
                             "N1_E34", TS_IIF(m_PrintOrderN2, F( FormulaIF() + "(" + N1_C35(m_delta3) + ">" + N1_C38(m_delta3) + ";" + TS_IIF(GL_FAC2 != "", N2_() + GL_FAC2, "0") + "+" + N8_() + N8_A5(0) + ";" + TS_IIF(GL_FAC2 != "", N2_() + GL_FAC2, "0") + ")" ), 0.0),
                             "N1_F34", TS_IIF(m_PrintOrderN2, F( N2_() + GL_FAA10 + "+" + N2_() + GL_FAA5 ), 0.0),
                             "N1_G34", F( N1_F35(m_delta3) + "+" + N1_C35(m_delta3) ),
                             "N1_H34", F( N1_G35(m_delta3) + "-" + N1_C35(m_delta3) + "+" + N1_D35(m_delta3) + "-" + N1_E35(m_delta3) ),
                             "N1_I34", TS_IIF(m_PrintOrderN2, F( N2_() + GL_AA15 ), 0.0),
                             "N1_J34", F( N1_G35(m_delta3) + "/(" + N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) + ")*100" ),

                             "N1_C35", 0.0,
                             "N1_D35", 0.0,
                             "N1_E35", 0.0,
                             "N1_F35", 0.0,
                             "N1_G35", F( N1_F36(m_delta3) + "+" + N1_C36(m_delta3) ),
                             "N1_H35", F( N1_G36(m_delta3) + "-" + N1_C36(m_delta3) + "+" + N1_D36(m_delta3) + "-" + N1_E36(m_delta3) ),
                             "N1_I35", 0.0,
                             "N1_J35", F( N1_G36(m_delta3) + "/(" + N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) + ")*100" ),
                             "N1_D36", F( N1_C80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),
                             "N1_H36", F( N1_C80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),

                             "N1_C37", TS_IIF(m_PrintOrderN4, F( N4_() + GL_FOA17_1 + "+" + N4_() + GL_FOA24 ), 0.0),
                             "N1_D37", TS_IIF(m_PrintOrderN4, F( N4_() + GL_OA19 + "+" + N4_() + GL_FOA21_1 ), 0.0),
                             "N1_E37", TS_IIF(m_PrintOrderN4, F( FormulaIF() + "(" + N1_C35(m_delta3) + ">" + N1_C38(m_delta3) + ";" + TS_IIF(GL_FOD2 != "", N4_() + GL_FOD2, "0") + ";" + TS_IIF(GL_FOD2 != "", N4_() + GL_FOD2, "0") + "+" + N8_() + N8_A5(0) + ")" ), 0.0),
                             "N1_F37", TS_IIF(m_PrintOrderN4, F( N4_() + GL_FOA15 + "+" + N4_() + GL_FOA11 + "-" + N4_() + GL_FOA21_1 ), 0.0),
                             "N1_G37", F( N1_F38(m_delta3) + "+" + N1_C38(m_delta3) ),
                             "N1_H37", F( N1_G38(m_delta3) + "-" + N1_C38(m_delta3) + "+" + N1_D38(m_delta3) + "-" + N1_E38(m_delta3) ),
                             "N1_I37", TS_IIF(m_PrintOrderN4, F( N4_() + GL_OA20 ), 0.0),
                             "N1_J37", F( N1_G38(m_delta3) + "/(" + N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) + ")*100" ),

                             "N1_C38", 0.0,
                             "N1_D38", 0.0,
                             "N1_E38", 0.0,
                             "N1_F38", 0.0,
                             "N1_G38", F( N1_F39(m_delta3) + "+" + N1_C39(m_delta3) ),
                             "N1_H38", F( N1_G39(m_delta3) + "-" + N1_C39(m_delta3) + "+" + N1_D39(m_delta3) + "-" + N1_E39(m_delta3) ),
                             "N1_I38", 0.0,
                             "N1_J38", F( N1_G39(m_delta3) + "/(" + N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) + ")*100" ),

                             "N1_C39", F( N1_C34(m_delta3) + "+" + N1_C35(m_delta3) + "+" + N1_C36(m_delta3) + "+" + N1_C38(m_delta3) + "+" + N1_C39(m_delta3) ),
                             "N1_D39", F( N1_D34(m_delta3) + "+" + N1_D35(m_delta3) + "+" + N1_D36(m_delta3) + "+" + N1_D37(m_delta3) + "+" + N1_D38(m_delta3) + "+" + N1_D39(m_delta3) ),
                             "N1_E39", F( N1_E35(m_delta3) + "+" + N1_E36(m_delta3) + "+" + N1_E38(m_delta3) + "+" + N1_E39(m_delta3) ),
                             "N1_F39", F( N1_F34(m_delta3) + "+" + N1_F35(m_delta3) + "+" + N1_F36(m_delta3) + "+" + N1_F38(m_delta3) + "+" + N1_F39(m_delta3) ),
                             "N1_G39", F( N1_G34(m_delta3) + "+" + N1_G35(m_delta3) + "+" + N1_G36(m_delta3) + "+" + N1_G38(m_delta3) + "+" + N1_G39(m_delta3) ),
                             "N1_H39", F( N1_H34(m_delta3) + "+" + N1_H35(m_delta3) + "+" + N1_H36(m_delta3) + "+" + N1_H37(m_delta3) + "+" + N1_H38(m_delta3) + "+" + N1_H39(m_delta3) ),
                             "N1_J39", F( N1_J34(m_delta3) + "+" + N1_J35(m_delta3) + "+" + N1_J36(m_delta3) + "+" + N1_J38(m_delta3) + "+" + N1_J39(m_delta3) + "+" + N1_F62(m_delta3+(Amount_ДС-1)+2) ),

                             "N1_D40", 0.0,
                             "N1_H40", 0.0,
                             "N1_D41", 0.0,
                             "N1_H41", 0.0,
                             "N1_D42", F( "-" + N1_J75(m_delta4 + Amount_m) ),
                             "N1_H42", F( "-" + N1_J75(m_delta4 + Amount_m) ),
                             "N1_D43", F( "-" + N1_F75(m_delta4 + Amount_m) ),
                             "N1_H43", F( "-" + N1_F75(m_delta4 + Amount_m) ),
                             "N1_D44", F( "-" + N1_C75(m_delta4 + Amount_m) ),
                             "N1_H44", F( "-" + N1_C75(m_delta4 + Amount_m) ),
                             "N1_D45", F( "-" + N1_H80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),
                             "N1_H45", F( "-" + N1_H80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),
                             "N1_D46", F( "-" + N1_G80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),
                             "N1_H46", F( "-" + N1_G80(m_delta5 + max(Amount_Д_Двд, Amount_Н_Дх) ) ),

                             "N1_D47", - m_OrderFD.ОстатокПоСчету( "+Расчеты, ДУ", m_FormData.ReportDate, FIROLE_TRUSTOR ),
                             "N1_H48", F( N1_D48(m_delta3) ),
                             "N1_D48", - (Скупр + Скусп + Скдв),
                             "N1_H49", F( N1_D49(m_delta3) ),
                             "N1_D49", F( "-(" + string(Н_Купр_опдд + Н_Кусп_опдд + Н_Кдв_опдд) + "+" + N1_D49(m_delta3) + ")" ),
                             "N1_H50", F( N1_D50(m_delta3) ),
                             "N1_D50", - Сндх,
                             "N1_H51", F( N1_D51(m_delta3) ),
                             "N1_D51", F( "-(" + Н_Дх_опдд + "+" + N1_D51(m_delta3) + ")" ),
                             "N1_H52", F( N1_D52(m_delta3) ),
                             "N1_D52", - Снналог,
                             "N1_H53", F( N1_D53(m_delta3) ),
                             "N1_D53", F( "-(" + Н_Налог_опдд + "+" + N1_D53(m_delta3) + ")" ),
                             "N1_H54_0", F( N1_D54(m_delta3) ),

                             "N1_C55", F( N1_C40(m_delta3) ),
                             "N1_D54", F( FormulaSUM() + "(" + N1_D40(m_delta3) + ":" + N1_D54(m_delta3) + ")" ),
                             "N1_E55", F( N1_E40(m_delta3) ),
                             "N1_F55", F( N1_F40(m_delta3) ),
                             "N1_G55", F( N1_G40(m_delta3) ),
                             "N1_H54", F( FormulaSUM() + "(" + N1_H40(m_delta3) + ":" + N1_H54(m_delta3) + ")" ) );

          /* Денежные средства */

          RegisterTable( "N1_MainTable_3", "",
                         "A62", "N1_B58", "C62", "D62", "N1_E58", "N1_F58", "G62", "H62", "I62", "J62" );

          i = 0;
          if( Amount_ДС > 0 )
             var NameAccount = "";
             var AccRec = TRecHandler( "account" );
             var SqlData_ДС = RSDCommand( SqlQuery_ДС );
             SqlData_ДС.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
             SqlData_ДС.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID);
             SqlData_ДС.addParam("", RSDBP_IN, m_FormData.ReportDate - 1);
             SqlData_ДС.execute();

             var DataSet_ДС = TRsbDataSet(SqlData_ДС);

             while( DataSet_ДС.MoveNext() )
                if( TS_GetAccount(SQL_ConvTypeInteger(DataSet_ДС.chapter), SQL_ConvTypeInteger(DataSet_ДС.currency), SQL_ConvTypeStr(DataSet_ДС.Account), AccRec) )
                   NameAccount = AccRec.rec.NameAccount;
                end;
                PrintTableLine( "N1_B58", NameAccount,                      NULL,
                                "N1_E58", SQL_ConvTypeSum(DataSet_ДС.rest), NULL,
                                "N1_F58", F( N1_E62(m_delta3+i) + "/" + N1_E62(m_delta3+(Amount_ДС-1)+2) + "*100" ), NULL );
                i = i + 1;
             end;
          end;

          PrintTableLine( "N1_B58", "Срочный рынок",                  NULL,
                          "N1_E58", 0.0/*m_OrderFD.ОстатокПоСчету( "+Расчеты, ДУ", m_FormData.ReportDate, /*с КВТ = 72*/ ) + m_OrderFD.ОстатокПоСчету( "+Расчеты, ДУ", m_FormData.ReportDate, /*с КВТ = 40*/ )*/, NULL,
                          "N1_F58", F( N1_E62(m_delta3+i) + "/" + N1_E62(m_delta3+(Amount_ДС-1)+2) + "*100" ), NULL
                        );
          i = i + 1;

          PrintTableLine( "N1_B58", "ИТОГО",                          NULL,
                          "N1_E58", F( FormulaSUM() + "(" + N1_E62(m_delta3) + ":" + N1_E62(m_delta3+(Amount_ДС-1)+1) + ")" ), NULL,
                          "N1_F58", F( N1_E62(m_delta3+(Amount_ДС-1)+2) + "/(" + N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) + ")*100" ), NULL
                        );

          EndTable();

          /* Контрольные суммы */

          PrintFormatString( "",
                             "N1_J57", F( N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) ),
                             "N1_J58", F( N1_H6(m_delta1) + "+" + N1_H55(m_delta3) ),
                             "N1_J59", F( N1_J58(m_delta3) + "-" + N1_J59(m_delta3) ));

          /* Стоимость активов */

          var PrevReportDate:date = date(0,0,0);
          if( m_FormData.PrevReportDate == date(0,0,0) )
             if( m_OrderFD.УчредительЮрЛицо() )
                PrevReportDate = BegCurDate;
             else
                if( CurMon <= 3 )
                   PrevReportDate = date(1,1,CurYear);
                elif( CurMon <= 6 )
                   PrevReportDate = date(1,4,CurYear);
                elif( CurMon <= 9 )
                   PrevReportDate = date(1,7,CurYear);
                elif( CurMon <= 12 )
                   PrevReportDate = date(1,10,CurYear);
                end;
             end;
          else
             PrevReportDate = m_FormData.PrevReportDate;
          end;

          var СЧА_old:money = $0.0, СЧА_new:money = $0.0; 
          if( ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СЧА, NULL, 0, NULL, NULL, NULL, PrevReportDate, NULL, NULL, @СЧА_old) )
             СЧА_old = $0.0;
          end;
/*
          if( ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СЧА, NULL, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, NULL, @СЧА_new) )
             СЧА_new = $0.0;
          end;
*/
          var Н_СК_ум:money = $0.0, Н_СК_ув:money = $0.0;
          var Н_СК_ум_beg:money = $0.0, Н_СК_ув_beg:money = $0.0;
          var Н_СК_ум_end:money = $0.0, Н_СК_ув_end:money = $0.0;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, @Н_СК_ум_beg, NULL))
             Н_СК_ум_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_СК_ум_end, NULL))
             Н_СК_ум_end = $0.0;
          end;
          Н_СК_ум = Н_СК_ум_end - Н_СК_ум_beg;

          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, m_BegDate-1, NULL, @Н_СК_ув_beg, NULL))
             Н_СК_ув_beg = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, null, 0, NULL, NULL, NULL, m_FormData.ReportDate, NULL, @Н_СК_ув_end, NULL))
             Н_СК_ув_end = $0.0;
          end;
          Н_СК_ув = Н_СК_ув_end - Н_СК_ув_beg;

          PrintFormatString( "",
                             "N1_B64", "   Стоимость активов на " + PrevReportDate,
                             "N1_B65", СЧА_old,
                             "N1_C65", Н_СК_ув - Н_СК_ум,
                             "N1_D65", /*СЧА_new*/ F( N1_G55(m_delta3) + "+" + N1_E62(m_delta3+(Amount_ДС-1)+2) ),
                             "N1_E65", F( "(" + N1_D66(m_delta3+(Amount_ДС-1)+2) + "-" + N1_B66(m_delta3+(Amount_ДС-1)+2) + "-" + N1_C66(m_delta3+(Amount_ДС-1)+2) + ")/" + N1_B66(m_delta3+(Amount_ДС-1)+2) ) );

          /* Капитал */

          PrintFormatString( "",
                             "N1_B70", F( N1_H6(m_delta1) ),
                             "N1_D70", F( N1_D66(m_delta3+(Amount_ДС-1)+2) ),
                             "N1_E69", F( "(" + N1_D70(m_delta3+(Amount_ДС-1)+2) + "-" + N1_B70(m_delta3+(Amount_ДС-1)+2) + ")/" + N1_B70(m_delta3+(Amount_ДС-1)+2) ) );

          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table3", 0, "ИТОГ" );

          /* "Комиссия за досрочный вывод"    "Комиссия за управление"    "Оплата внешних комиссий" */

          RegisterTable( "N1_MainTable_4", "",
                         "A75", "N1_B74", "N1_C74", "D75", "N1_E74", "N1_F74", "G75", "N1_H74", "N1_I74", "N1_J74" );

          var SqlData_Н_Кдв = RSDCommand( SqlQuery_Итог );
          SqlData_Н_Кдв.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Н_Кдв.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Кдв);
          SqlData_Н_Кдв.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData_Н_Кдв.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Н_Кдв.execute();
          var DataSet_Н_Кдв = TRsbDataSet(SqlData_Н_Кдв);

          var SqlData_Н_Купр = RSDCommand( SqlQuery_Итог );
          SqlData_Н_Купр.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Н_Купр.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Купр);
          SqlData_Н_Купр.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData_Н_Купр.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Н_Купр.execute();
          var DataSet_Н_Купр = TRsbDataSet(SqlData_Н_Купр);

          var SqlData_Р_Квн = RSDCommand( SqlQuery_Итог(-1, true) );
          SqlData_Р_Квн.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Р_Квн.addParam("", RSDBP_IN, ДУ_ИТОГ_Р_Квн);
          SqlData_Р_Квн.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData_Р_Квн.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Р_Квн.addParam("", RSDBP_IN, TS_DemandEvent("65"));
          SqlData_Р_Квн.execute();
          var DataSet_Р_Квн = TRsbDataSet(SqlData_Р_Квн);

          var B74, C74, E74, F74, H74, I74, J74;
          i = 0;
          while(i < Amount_m )

             if( DataSet_Н_Кдв.MoveNext() )
                B74 = SQL_ConvTypeDate(DataSet_Н_Кдв.rec.BeginDate);
                C74 = SQL_ConvTypeSum(DataSet_Н_Кдв.rec.RestAmount);
             else
                B74 = ""; C74 = "";
             end;

             if( DataSet_Н_Купр.MoveNext() )
                E74 = SQL_ConvTypeDate(DataSet_Н_Купр.rec.BeginDate);
                F74 = SQL_ConvTypeSum(DataSet_Н_Купр.rec.RestAmount);
             else
                E74 = ""; F74 = "";
             end;

             if( DataSet_Р_Квн.MoveNext() )
                H74 = SQL_ConvTypeDate(DataSet_Р_Квн.rec.BeginDate);
                TS_GetValueLL( OBJTYPE_TSEVENT, DataSet_Р_Квн.rec.EventID, null, @I74 );
                J74 = SQL_ConvTypeSum(DataSet_Р_Квн.rec.RestAmount);
             else
                H74 = ""; I74 = ""; J74 = "";
             end;

             PrintTableLine( "N1_B74", B74, NULL,
                             "N1_C74", C74, NULL,
                             "N1_E74", E74, NULL,
                             "N1_F74", F74, NULL,
                             "N1_H74", H74, NULL,
                             "N1_I74", I74, NULL,
                             "N1_J74", J74, NULL );
             i = i + 1;
          end;

          if( i > 0 )
             C74 = F( FormulaSUM() + "(" + N1_C75(m_delta4) + ":" + N1_C75(m_delta4 + i - 1) + ")" );
             F74 = F( FormulaSUM() + "(" + N1_F75(m_delta4) + ":" + N1_F75(m_delta4 + i - 1) + ")" );
             J74 = F( FormulaSUM() + "(" + N1_J75(m_delta4) + ":" + N1_J75(m_delta4 + i - 1) + ")" );
          else
             C74 = 0.0;
             F74 = 0.0;
             J74 = 0.0;
          end;

          PrintTableLine( "N1_C74", C74, NULL,
                          "N1_F74", F74, NULL,
                          "N1_J74", J74, NULL );
          EndTable();

          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table4", 0, "ИТОГ" );

          /* "Дивиденды"    "Капитализация и выплата приб" */

          RegisterTable( "N1_MainTable_5", "",
                         "A80", "N1_B80", "N1_C80", "D80", "N1_E80", "N1_F80", "N1_H80", "N1_J80" );

          Amount_m = max(Amount_Д_Двд, Amount_Н_Дх);

          var SqlData_Д_Двд = RSDCommand( SqlQuery_Итог(1) );
          SqlData_Д_Двд.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Д_Двд.addParam("", RSDBP_IN, ДУ_ИТОГ_Д_Двд);
          SqlData_Д_Двд.addParam("", RSDBP_IN, m_BegValidDate);
          SqlData_Д_Двд.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Д_Двд.execute();
          var DataSet_Д_Двд = TRsbDataSet(SqlData_Д_Двд);

          var SqlData_Н_Дх = RSDCommand( Query_Итог );
          SqlData_Н_Дх.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Н_Дх.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Дх);
          SqlData_Н_Дх.addParam("", RSDBP_IN, m_BegDate);
          SqlData_Н_Дх.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Н_Дх.addParam("", RSDBP_IN, m_OrderFD.Order().rec.ID);
          SqlData_Н_Дх.addParam("", RSDBP_IN, ДУ_ИТОГ_Н_Налог);
          SqlData_Н_Дх.addParam("", RSDBP_IN, m_BegDate);
          SqlData_Н_Дх.addParam("", RSDBP_IN, m_FormData.ReportDate);
          SqlData_Н_Дх.addParam("", RSDBP_IN, TS_DemandEvent("98"));
          SqlData_Н_Дх.execute();
          var DataSet_Н_Дх = TRsbDataSet(SqlData_Н_Дх);

          var B80, C80, E80, F80, H80, J80;
          i = 0;
          while(i < Amount_m )

             if( DataSet_Д_Двд.MoveNext() )
                B80 = SQL_ConvTypeDate(DataSet_Д_Двд.rec.BeginDate);
                C80 = SQL_ConvTypeSum(DataSet_Д_Двд.rec.RestAmount);
             else
                B80 = ""; C80 = "";
             end;

             if( DataSet_Н_Дх.MoveNext() )
                E80 = SQL_ConvTypeDate(DataSet_Н_Дх.rec.BeginDate);
                F80 = 0.0;
                if( DataSet_Н_Дх.rec.TotalType == ДУ_ИТОГ_Н_Дх )
                   H80 = SQL_ConvTypeSum(DataSet_Н_Дх.rec.RestAmount);

                   var Налог83:money = $0.0, Налог96:money = $0.0;
                   if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, TS_DemandEvent("83"), 0, NULL, NULL, NULL, E80, @Налог83, NULL, NULL, 0, 0))
                      Налог83 = $0.0;
                   end;
                   if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, TS_DemandEvent("83"), 0, NULL, NULL, NULL, E80, @Налог96, NULL, NULL, 0, 0))
                      Налог96 = $0.0;
                   end;
                   if( (Налог83 + Налог96) > 0 )
                      J80 = Налог83 + Налог96;
                   else
                      J80 = "";
                   end;
                else
                   H80 = 0.0;
                   J80 = SQL_ConvTypeSum(DataSet_Н_Дх.rec.RestAmount);
                end;
             else
                E80 = ""; F80 = ""; H80 = ""; J80 = "";
             end;

             PrintTableLine( "N1_B80", B80, NULL,
                             "N1_C80", C80, NULL,
                             "N1_E80", E80, NULL,
                             "N1_F80", F80, NULL,
                             "N1_H80", H80, NULL,
                             "N1_J80", J80, NULL );
             i = i + 1;
          end;

          if( i > 0 )
             C80 = F( FormulaSUM() + "(" + N1_C80(m_delta5) + ":" + N1_C80(m_delta5 + i - 1) + ")" );
             F80 = F( FormulaSUM() + "(" + N1_F80(m_delta5) + ":" + N1_F80(m_delta5 + i - 1) + ")" );
             H80 = F( FormulaSUM() + "(" + N1_G80(m_delta5) + ":" + N1_G80(m_delta5 + i - 1) + ")" );
             J80 = F( FormulaSUM() + "(" + N1_H80(m_delta5) + ":" + N1_H80(m_delta5 + i - 1) + ")" );
          else
             C80 = 0.0;
             F80 = 0.0;
             H80 = 0.0;
             J80 = 0.0;
          end;

          PrintTableLine( "N1_C80", C80, NULL,
                          "N1_F80", F80, NULL,
                          "N1_H80", H80, NULL,
                          "N1_J80", J80, NULL );

          EndTable();
          CopyAllSheetInTotalBook( "ИТОГ", false, "N1_Table5", 0, "ИТОГ" );


          if( m_SheetN8 == false )
             UseNewSheetInTotalBook();
             m_SheetN8 = true;
          end;
          SetActiveSheet( "Пром_рез" );

          DateSplit( m_BegDate, null, null, year );
          var Квн_beg_add:MONEY = $0.0, Квн_end_add:MONEY = $0.0;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0, NULL, NULL, NULL, m_BegDate-1, @Квн_beg_add, NULL, NULL))
             Квн_beg_add = $0.0;
          end;
          if(ПолучитьИтогДУ(m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0, NULL, NULL, NULL, m_FormData.ReportDate, @Квн_end_add, NULL, NULL))
             Квн_end_add = $0.0;
          end;

          var DC:money = $0.0;
          var Query = RSDCommand( " SELECT distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                                  "   FROM dmcaccdoc_dbt accdoc, daccount_dbt acc, dmccateg_dbt categ, dmctempl_dbt templ " +
                                  "  WHERE accdoc.t_ClientContrID = ?                 " + 
                                  "    AND acc.t_Account          = accdoc.t_Account  " +
                                  "    AND acc.t_Code_Currency    = accdoc.t_Currency " +
                                  "    AND acc.t_Chapter          = accdoc.t_Chapter  " +
                                  "    AND acc.t_Balance          = '80801'           " +
                                  "    AND categ.t_ID             = accdoc.t_CatID    " +
                                  "    AND categ.t_leveltype      = 1                 " +
                                  "    AND categ.t_code           = 'ДС ДУ'           " +
                                  "    AND templ.t_catid = accdoc.t_catid                                 " +
                                  "    AND templ.t_number = accdoc.t_templnum                             " +
                                  "    AND (CASE                                                          " +
                                  "            WHEN (categ.t_param1 = 2818 AND categ.t_class1 = 1702)     " +
                                  "               THEN templ.t_value1                                     " +
                                  "            WHEN (categ.t_param2 = 2818 AND categ.t_class2 = 1702)     " +
                                  "               THEN templ.t_value2                                     " +
                                  "            WHEN (categ.t_param3 = 2818 AND categ.t_class3 = 1702)     " +
                                  "               THEN templ.t_value3                                     " +
                                  "            WHEN (categ.t_param4 = 2818 AND categ.t_class4 = 1702)     " +
                                  "               THEN templ.t_value4                                     " +
                                  "            WHEN (categ.t_param5 = 2818 AND categ.t_class5 = 1702)     " +
                                  "               THEN templ.t_value5                                     " +
                                  "            WHEN (categ.t_param6 = 2818 AND categ.t_class6 = 1702)     " +
                                  "               THEN templ.t_value6                                     " +
                                  "            WHEN (categ.t_param7 = 2818 AND categ.t_class7 = 1702)     " +
                                  "               THEN templ.t_value7                                     " +
                                  "            WHEN (categ.t_param8 = 2818 AND categ.t_class8 = 1702)     " +
                                  "               THEN templ.t_value8                                     " +
                                  "         END                                                           " +
                                  "        ) = 40                                                         " + /* = 10 "Расчетный" - отчет 1ОБ */
/*                                  "    AND (CASE                                                          " +
                                  "            WHEN (categ.t_param1 = 5008 AND categ.t_class1 = 5008)     " +
                                  "               THEN templ.t_value1                                     " +
                                  "            WHEN (categ.t_param2 = 5008 AND categ.t_class2 = 5008)     " +
                                  "               THEN templ.t_value2                                     " +
                                  "            WHEN (categ.t_param3 = 5008 AND categ.t_class3 = 5008)     " +
                                  "               THEN templ.t_value3                                     " +
                                  "            WHEN (categ.t_param4 = 5008 AND categ.t_class4 = 5008)     " +
                                  "               THEN templ.t_value4                                     " +
                                  "            WHEN (categ.t_param5 = 5008 AND categ.t_class5 = 5008)     " +
                                  "               THEN templ.t_value5                                     " +
                                  "            WHEN (categ.t_param6 = 5008 AND categ.t_class6 = 5008)     " +
                                  "               THEN templ.t_value6                                     " +
                                  "            WHEN (categ.t_param7 = 5008 AND categ.t_class7 = 5008)     " +
                                  "               THEN templ.t_value7                                     " +
                                  "            WHEN (categ.t_param8 = 5008 AND categ.t_class8 = 5008)     " +
                                  "               THEN templ.t_value8                                     " +
                                  "         END                                                           " +
                                  "        ) = 0                                                          " + Q = 0 "основной" - отчет 1ОБ */
                                  "    AND NVL((select partcode.t_Code from dpartcode_dbt partcode        " +
                                  "              where partcode.t_PartyID = accdoc.t_Place                " +
                                  "                and partcode.t_CodeKind = 1),'') = 'РП ММВБ'           " );

          Query.addParam("", RSDBP_IN, m_OrderFD.Order().rec.SfContrID );
          Query.execute();
          var DataS = TRsbDataSet(Query);

          while( DataS.MoveNext() )
             var CurDate = m_BegDate;
             while( CurDate < m_FormData.ReportDate )
                DC = DC + TS_GetRestAccount(DataS.Account, DataS.Currency, DataS.Chapter, CurDate);
                CurDate = CurDate + 1;
             end;
          end;

          PrintFormatString( "", "C1", F( N1_() + N1_C1(0) ),
                                 "N8_A5",  Квн_end_add - Квн_beg_add,
                                 "N8_A7",  abs(DC),
                                 "N8_A9",  BB2,
                                 "N8_A11", 0.01,
                                 "N8_A13", date(31,12,year),
                                 "N8_A17", m_OrderFD.СредневзвешенныйКапиталДляДПОФБУ( m_OrderFD.Order().rec.ID, BegCurDate, EndCurDate, false, false ) /*название функции конечно не в тему))*/
                           );

          if(Array_EOY_F5.Size > 0)
             RegisterTable( "N8_MainTable_1", "",
                            "N8_A20", "N8_B20", "N8_C20" );
             i=0;
             while( i < (Array_EOY_F5.Size) )
                PrintTableLine( "N8_A20", Array_EOY_F5[i].A20, null,
                                "N8_B20", Array_EOY_F5[i].B20, null,
                                "N8_C20", Array_EOY_F5[i].C20, null);
                i = i + 1;
             end;
             EndTable();
          end;

          CopyAllSheetInTotalBook( "Пром_рез", false, "N8_All", 0, "Пром_рез" );

          if( m_SheetN1 )
             m_DeltaOrderN1 = GetLastPosition("ИТОГ") - 1;
          end;
          if( m_SheetN2 )
             m_DeltaOrderN2 = GetLastPosition("Акции") - 1;
          end;
          if( m_SheetN3 )
             m_DeltaOrderN3 = GetLastPosition("Акции Закрытые") - 1;
          end;
          if( m_SheetN4 )
             m_DeltaOrderN4 = GetLastPosition("Облигации") - 1;
          end;
          if( m_SheetN5 )
             m_DeltaOrderN5 = GetLastPosition("Облигации Закрытые") - 1;
          end;
          if( m_SheetN6 )
             m_DeltaOrderN6 = GetLastPosition("Векселя") - 1;
          end;
          if( m_SheetN7 )
             m_DeltaOrderN7 = GetLastPosition("Векселя Закрытые") - 1;
          end;
          if( m_SheetN8 )
             m_DeltaOrderN8 = GetLastPosition("Пром_рез") - 1;
          end;

       end;
    end;

    OrderEnd();

  END;

  PRIVATE MACRO Create()

     CountOrder();
     if( m_CountOrder > 0 )
        m_delta1 = 0; m_delta2 = 0;
        m_DeltaOrderN1 = 0; m_DeltaOrderN2 = 0; m_DeltaOrderN3 = 0; m_DeltaOrderN4 = 0; m_DeltaOrderN5 = 0; m_DeltaOrderN6 = 0; m_DeltaOrderN7 = 0; m_DeltaOrderN8 = 0;
        m_PrintOrderN2 = false; m_PrintOrderN3 = false; m_PrintOrderN4 = false; m_PrintOrderN5 = false; m_PrintOrderN6 = false; m_PrintOrderN7 = false;
        m_SheetN1 = false; m_SheetN2 = false; m_SheetN3 = false; m_SheetN4 = false; m_SheetN5 = false; m_SheetN6 = false; m_SheetN7 = false; m_SheetN8 = false;
        Печать_Отчёт();
     end;

     if( (m_CountOrder <= 0) OR
         (
                (m_SheetN1 == false)  
            AND (m_SheetN2 == false)  
            AND (m_SheetN3 == false)  
            AND (m_SheetN4 == false)  
            AND (m_SheetN5 == false)  
            AND (m_SheetN6 == false)  
            AND (m_SheetN7 == false)  
            AND (m_SheetN8 == false)  
         )
       )
        SetActiveSheet( "No data" );
        PrintFormatString( "", "N9_NoData", "Нет договоров, удовлетворяющих параметрам отчета." );
        CopyAllSheetInTotalBook( null, false, "N9_NoData", 1 );
     end;

  END;

  initTS_CardAnAcc_Report_General( "Report_TSCardAnAcc.xls" );
END;
