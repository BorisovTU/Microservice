/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style SoftLab

  File Name   : tsdsdu.mac
  Programmer  : Leksikov Evgeny
  Операция    : Печать Доп. Сглашения к договору ИДДУ
└───────────────────────────────────────────────────────────────────────────*/

import "tscateg.mac", "dlwreps.mac", "or_tools.mac", "dlRepFun.mac", "adress.mac", "tsutil.mac", "pt_lib.mac", "tsrepsign.mac";

var GrTemp = TRecHandler( "dlgrtemp.dbt" );
var FreeText = "Произвольный текст соглашения.";

private class Ground( parm:integer )

  var structGround;
  var order:TS_OrderFD;
  macro GetTemplate():integer
    return structGround.rec.doctemplate;
  end;

/* констуктор */
  macro Constructor( SpGroundID )
    var query:string, SQLcmd, RSD;
    structGround = TRecHandler( "spground.dbt" );
    query = " select ground.* "
          + " from dspground_dbt ground "
          + " where GROUND.T_SPGROUNDID = "
          + string(SpGroundID);

    TS_GetRecHandler(structGround, query);

    var structOrder = TRecHandler( "tsorder.dbt" );
    query = " select ord.*                     "
          + " from dtsorder_dbt ord            "
          + " where ord.T_ID =                 "
          + " ( select GRDOC.T_SOURCEDOCID     "
          + " from dspgrdoc_dbt grdoc          "
          + " where GRDOC.T_SPGROUNDID =       "
          + string(SpGroundID)
          + " AND GRDOC.T_SOURCEDOCKIND = 905 )" ;

    TS_GetRecHandler(structOrder, query);

    order = TS_OrderFD( structOrder.rec.DocKind, structOrder.rec.ID );
  end;

  Constructor(parm);
end;

private macro FindGrTemp( Num )

  if( Num > 0 )
     return TS_GetRecHandler( GrTemp, " SELECT GrTemp.* "+
                                      "   FROM ddlgrtemp_dbt GrTemp " +
                                      "  WHERE GrTemp.t_DocLog = 590 AND " +
                                      "        GrTemp.t_Num    = " + string(Num)
                            );
  end;
  return false;
end;

private macro _println(str)
  if(ValType(str) != V_UNDEF)
    println(str);
  end;
end;

private macro ДатаСВедущимНулем(str_)

  var str = string(str_);
  while(Index(str," ") == 1)
     str = substr(str, 2, strlen(str)-1);
  end;
  if((str == "") or (Index(str,".") == 3) or (Index(str," ") == 3))
     return str;
  else
     return "0" + str;
  end;
end;

private macro DateToStr(pDate)

  var str = DL_DateToStr(pDate);

  return ДатаСВедущимНулем(substr(str, 1, strlen(str)-3));  /*отсекём " г."*/
end;

private macro ПечатьСПроверкой(Str:string, Flag:@bool)
  if(Str == "")
     Flag = FALSE;
  else
     _println( Str );
  end;
end;

private macro PrintContr( ncopy:integer, gr:Ground )
  var TempFile;
  var ClientRepresPosFlag = true;
  var ClientRepresFlag = true;
  var OurRepresPosFlag = true;
  var OurRepresFlag    = true;
  var RepSign = TS_ReportData(gr.order.order);

  /*Шаблон*/
  [#]( GrTemp.rec.File_Name );

  /*Имя выходного файла*/
  var DocName = "Допсоглашение к договору ИДДУ № " + gr.order.Number();
  if( ncopy > 1 )
     /*добавить в название номер копии, иначе будет ошибка при создании, т.к. получим
       несколько документов с одинаковыми именами*/
     DocName = DocName + "_"+ string(ncopy);
  end;
  [#.rtf]( DocName );

  if(gr.order.Trustor().rec.LegalForm == 1)   /*Юридическое лицо*/

     /*Номер дополнительного соглашения к Договору ИДДУ.*/
     [~DopSoglDUNumb];
     _println( gr.structGround.rec.XLD);
  
     /*Номер договора с учредителем*/
     [~ContractDUNumb];
     _println( gr.order.Number() );

     /*Город из адреса нашего банка*/
     [~City];
     _println( RepSign.City );

     /*Дата заключения договора*/
     [~ContractDUDate];
     _println( DateToStr(gr.order.BeginDate()) );

     /*Полное наименование нашего банка из анкеты субъекта*/
     [~OurBankFull];
     _println( RepSign.OurBankFull );

     /*Должность в родительном падеже представителя нашего банка*/
     [~OurRepresPos_rp];
     ПечатьСПроверкой( RepSign.OurRepresPos, @OurRepresPosFlag ); /*50 - Должность в родит. падеже*/

     /*Фамилия, имя, отчество в родительном падеже*/
     [~OurRepres_rp];
     ПечатьСПроверкой( RepSign.OurRepres, @OurRepresFlag ); /*49 - Полное наименование в родит. падеже - ФИО*/

     /*Данные в родительном падеже о документе, на основании которого действует представитель нашего банка.*/
     [~OurRepresDoc];
     ПечатьСПроверкой( RepSign.OurRepresDoc, @OurRepresFlag ); /*51 - Документ-основание */

     /*Полное наименование клиента-учредителя из договора*/
     [~ClientFull];
     _println( RepSign.ClientFull );

     /*Должность в родительном падеже представителя клиента-учредителя*/
     [~ClientRepresPos];
     ПечатьСПроверкой( RepSign.ClientRepresPos, @ClientRepresPosFlag ); /*50 - Должность в родит. падеже*/

     /*Фамилия, имя и отчество в родительном падеже представителя клиента-учредителя*/
     [~ClientRepres];
     ПечатьСПроверкой( RepSign.ClientRepres, @ClientRepresFlag ); /*49 - Полное наименование в родит. падеже - ФИО*/


     /*Произвольный текст дополнительного соглашения*/
     [~SoglText];
     _println( FreeText );

     /*Сокращенное наименование нашего банка из анкеты субъекта*/
     [~OurBankShort];
     _println( RepSign.OurBankShort );

     /*Адрес нашего банка, включая индекс*/
     [~OurAddr];
     _println( RepSign.OurFullAddr );

     /*ИНН/КПП нашего банка из анкеты субъекта*/
     [~OurINN];
     _println( RepSign.OurINN );

     /*р/счет из СПИ нашего банка (выбор СПИ - по виду обслуживания = "Доверительное управление"). Поле в СПИ "счет"*/
     [~OurSPIAcc];
     _println( RepSign.OurSPIAcc );

     /*банк из СПИ нашего банка (выбор СПИ - по виду обслуживания = "Доверительное управление"). Поле в СПИ "в банке"*/
     [~OurSPIBank];
     _println( RepSign.OurSPIBank );

     /*БИК банка из СПИ нашего банка (выбор СПИ - по виду обслуживания = "Доверительное управление"). Поле в СПИ "БИК"*/
     [~BICOurSPIBank];
     _println( RepSign.BICOurSPIBankCode );

     /*Фамилия, Инициалы представителя нашего Банка*/
     [~OurRepres];
     _println( RepSign.ShortOurRepr );

     [~ClientFull_dup_2];

     /*Адрес учредителя, включая индекс*/
     [~ClientAddr];
     _println( RepSign.ClientFullAddr );

     /*ИНН/КПП учредителя из анкеты субъекта*/
     [~ClientINN];
     _println( RepSign.ClientINN );

     /*р/счет из СПИ учредителя по договору. Поле "счет"*/
     [~ClientSPIAcc];
     _println( RepSign.ClientSPIAcc );

     /*Полное наименование банка из СПИ учредителя по договору. Поле "в банке"*/
     [~ClientSPIBank];
     _println( RepSign.ClientSPIBank );

     /*БИК банка из СПИ учредителя по договору. Поле "БИК"*/
     [~BICClientSPIBank];
     _println( RepSign.BICClientSPIBank );

     /*Кор/счет из СПИ учредителя по договору. Поле "корсчет"*/
     [~ClientSPICorrAcc];
     _println( RepSign.ClientSPICorrAcc );

     /*ФИО представителя учредителя (сотрудника учредителя с признаком первого лица)*/
     [~ClientRepr];
     _println( RepSign.ShortClientRepr );

  elif(gr.order.Trustor().rec.LegalForm == 2)  /*Физическое лицо*/

     /*Номер дополнительного соглашения к Договору ИДДУ.*/
     [~DopSoglDUNumb];
     _println( gr.structGround.rec.XLD);
  
     /*Номер договора с учредителем*/
     [~ContractDUNumb];
     _println( gr.order.Number() );

     /*Город из адреса нашего банка*/
     [~City];
     _println( RepSign.City );

     /*Дата заключения договора*/
     [~ContractDUDate];
     _println( DateToStr(gr.order.BeginDate()) );

     /*Полное наименование нашего банка из анкеты субъекта*/
     [~OurBankFull];
     _println( RepSign.OurBankFull );

     /*Должность в родительном падеже представителя нашего банка*/
     [~OurRepresPos_rp];
     ПечатьСПроверкой( RepSign.OurRepresPos, @OurRepresPosFlag ); /*50 - Должность в родит. падеже*/

     /*Фамилия, имя, отчество в родительном падеже*/
     [~OurRepres_rp];
     ПечатьСПроверкой( RepSign.OurRepres, @OurRepresFlag ); /*49 - Полное наименование в родит. падеже - ФИО*/

     /*Данные в родительном падеже о документе, на основании которого действует представитель нашего банка.*/
     [~OurRepresDoc];
     ПечатьСПроверкой( RepSign.OurRepresDoc, @OurRepresFlag ); /*51 - Документ-основание */

     /*Полное наименование клиента-учредителя из договора*/
     [~ClientFull];
     _println( RepSign.ClientFull );

     /*Серия паспорта учредителя из анкеты субъекта*/
     [~ClPasspSer];
     _println( RepSign.ClPasspSer );

     /*Номер паспорта из анкеты субъекта*/
     [~ClPasspNumb];
     _println( RepSign.ClPasspNumb );

     /*Орган, выдавший паспорт, из анкеты субъекта*/
     [~ClPasspGive];
     _println( RepSign.ClPasspGive );

     /*Дата выдачи паспорта из анкеты субъекта*/
     [~ClPasspGiveDate];
     _println( ДатаСВедущимНулем(RepSign.ClPasspGiveDate) );

     /*Адрес учредителя, включая индекс*/
     [~ClientAddr];
     _println( RepSign.ClientFullAddr );

     /*Произвольный текст дополнительного соглашения*/
     [~SoglText];
     _println( FreeText );

     /*тоже, что и OurBankFull*/
     [~OurBankFull_dup_2];

     /*Адрес нашего банка, включая индекс*/
     [~OurAddr];
     _println( RepSign.OurFullAddr );

     /*ИНН/КПП нашего банка из анкеты субъекта*/
     [~OurINN];
     _println( RepSign.OurINN );

     /*р/счет из СПИ нашего банка (выбор СПИ - по виду обслуживания = "Доверительное управление"). Поле в СПИ "счет"*/
     [~OurSPIAcc];
     _println( RepSign.OurSPIAcc );

     /*банк из СПИ нашего банка (выбор СПИ - по виду обслуживания = "Доверительное управление"). Поле в СПИ "в банке"*/
     [~OurSPIBank];
     _println( RepSign.OurSPIBank );

     /*БИК банка из СПИ нашего банка (выбор СПИ - по виду обслуживания = "Доверительное управление"). Поле в СПИ "БИК"*/
     [~BICOurSPIBank];
     _println( RepSign.BICOurSPIBankCode );

     /*Фамилия, Инициалы представителя нашего Банка*/
     [~OurRepres];
     _println( RepSign.ShortOurRepr );

     [~ClPasspSer_dup_2];
     [~ClPasspNumb_dup_2];
     [~ClPasspGive_dup_2];
     [~ClPasspGiveDate_dup_2];

     /*Дата рождения из анкеты субъекта*/
     [~ClBithDate];
     _println( ДатаСВедущимНулем(RepSign.ClBithDate) );

     /*Место рождения из анкеты субъекта*/
     [~ClBithPlace];
     _println( RepSign.ClBithPlace );

     /*р/счет из СПИ учредителя по договору. Поле "счет"*/
     [~ClientSPIAcc];
     _println( RepSign.ClientSPIAcc );

     /*Полное наименование банка из СПИ учредителя по договору. Поле "в банке"*/
     [~ClientSPIBank];
     _println( RepSign.ClientSPIBank );

     /*БИК банка из СПИ учредителя по договору. Поле "БИК"*/
     [~BIСClientSPIBank];
     _println( RepSign.BICClientSPIBank );

     /*Кор/счет из СПИ учредителя по договору. Поле "корсчет"*/
     [~ClientSPICorrAcc];
     _println( RepSign.ClientSPICorrAcc );

     /*Сокращенное ФИО учредителя из анкеты субъекта*/
     [~ClientRepr];
     _println( RepSign.ShortClientRepr );

  end;

  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile( TempFile );

end;

macro PrintDocument( SpGroundID ):bool

  var errcode, errtext;
  var GR = Ground( SpGroundID );

  if( FindGrTemp( GR.GetTemplate() ) )
    message("Печать договора ...");
    PrintContr(1, GR);
  else
    msgbox("шаблон не найден");
  end;

  return true;
end;
