/*******************************************************************************
 DESCRIPTION  :   Форма запуска отчета "Реестр долей учредителей в капитале ОФБУ" 
 PROGRAMMED BY:   Nikonorov Evgeny
 CREATION DATE:   27.05.2010
*******************************************************************************/
import "DlRepForm_h.mac", "globals.mac", TSInter;

/*Номера полей в форме отчета*/
CONST PNFLD_TRUSTORPARTREP_ENDDATE  = 0,
      PNFLD_TRUSTORPARTREP_OFBU     = 1,
      PNFLD_TRUSTORPARTREP_NUMOFBU  = 2;
      
      
PRIVATE CONST
      H_CALC_OFBU     = 101,
      H_CALC_NUMOFBU  = 102;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = "";
    end;

    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
    FldRealValue = FldShowValue;
  end;
  return CM_DEFAULT;
END;

/*Договор ОФБУ*/
PRIVATE MACRO FldProc_NameOFBU( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var Choice;
  var Select:string = "";

  var RepDate = pThis.GetFieldValue( PNFLD_TRUSTORPARTREP_ENDDATE );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = 0;
     end;

     if( FldRealValue <= 0 )
        FldShowValue = "";
        pThis.SetLinkedValue( H_CALC_NUMOFBU, "");
     end;

  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )

     FldRealValue = 0;
     FldShowValue = "";
     pThis.SetLinkedValue( H_CALC_NUMOFBU, "");

  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )

      Select = " SELECT ord.T_ID OrderID, ord.t_RegNUM RegNUM, ord.t_NAME NAME, spgr.T_BeginningDate BEGINDATE, " +
               "        ord.T_Trustor Trustor " +
               "   FROM dtsorder_DBT ord, dspground_dbt spgr " +                                                                            
               "  WHERE ord.T_dockind = " + TS_DOC_OFBU +
               "    AND ord.T_DP_ShareCalc = " + TS_CALCPART_NOMINAL + //только паевые ОФБУ                                                                                            
               "    AND spgr.T_SourceDocID = ord.T_id " +
               "    AND spgr.T_SourceDocKind = ord.T_dockind " +                                                                                       
               "    AND spgr.T_BeginningDate <= " + GetSQLDate(RepDate) +
               "    AND (spgr.T_TerminateDate >= " + GetSQLDate(RepDate) + " OR spgr.T_TerminateDate = " + GetSQLDate(date(0,0,0)) + ")";
                                                                                                                                        
      Choice = DL_Scroll( Select,                                                                                                           
                         "Договора доверительного управления - ОФБУ",                                                                              
                          pThis.CurrentFldX(), pThis.CurrentFldY(),                                                                         
                         "RegNUM",       "№ договора",                                                                                      
                         "NAME",         "Наименование договора",                                                                           
                         "BEGINDATE",    "Дата открытия"                                                                                   
                        );                                                                                                                  

      if( Choice != NULL )                                                          
          FldRealValue = Choice.Value("OrderID");                                   
          FldShowValue = Choice.Value("NAME");                                    
          pThis.SetLinkedValue( H_CALC_NUMOFBU, Choice.Value("RegNUM")); 
      end;                                                                          
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) TS_TrustorPartRep_Panel()

  PRIVATE MACRO Init()

     AddFieldProc( 0, PNFLD_TRUSTORPARTREP_ENDDATE,   DL_PNFLD_ENDDATE,  @DL_FldProc_EndDate,      {CurDate} );

     AddFieldProc( 0, PNFLD_TRUSTORPARTREP_OFBU,      H_CALC_OFBU,       @FldProc_NameOFBU );
     AddFieldProc( 0, PNFLD_TRUSTORPARTREP_NUMOFBU,   H_CALC_NUMOFBU,    @Default          );

  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;

  initDL_CPanel( "trust.lbr", "TSTRPART" ); 
END;
