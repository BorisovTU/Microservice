/* Операция движения активов
   Исполнение требований */
IMPORT InsCarryDoc, TSInter, "tstrans.mac";

MACRO ExecuteStep( DlDoc, FDoc, DocKind, ID_Operation, ID_Step )

  VAR ProfitAmountNATCUR = $0, CatCode:STRING;

  VAR Account        = TRecHandler("account"),
      AccountProfit  = TRecHandler("account"),
      FD_Oper   = TS_OperFD( NULL, FDoc ),
      FD_Order  = FD_Oper.Order, 
      DemandObl = FD_Oper.GetDemandByRole( TS_DEMAND_ROLE_OBLIGATION ), 
      DemandReq = FD_Oper.GetDemandByRole( TS_DEMAND_ROLE_REQUEST );

  VAR ДатаИсполнения = FD_Oper.BeginDate();

  if( DemandReq != NULL )
     if( TS_ExecuteDemandByID( DemandReq.Demand.rec.ID, ДатаИсполнения, true ) != 0 )
        return 1;
     end;
  else
     msgbox( "Не определен вид требования в операции." );
     return 1;
  end;

  if( not InsertOprStatus( TS_OPERSTATUS_KIND_DEMAND, TS_OPERSTATUS_DEMAND_EXEC ) ) 
     msgbox( "Ошибка при установке статуса операции" );
     return 1;
  end;

  if( GetOprStatus( TS_OPERSTATUS_KIND_OBLIGATION ) != TS_OPERSTATUS_OBLIGATION_PLAN )
     if( not InsertOprStatus( TS_OPERSTATUS_KIND_DOC, TS_OPERSTATUS_CLOSE ) ) 
        msgbox( "Ошибка при установке статуса операции" );
        return 1;
     end;
  end;

  return 0;
END;
