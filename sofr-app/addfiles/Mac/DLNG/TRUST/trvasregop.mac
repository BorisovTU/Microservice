/*******************************************************************************
 FILE         :   trvasregop.mac

 DESCRIPTION  :   é‚Á•‚ "ë„°‡•£®·‚‡ ®≠ÎÂ ÆØ•‡†Ê®© Ñì"

 PROGRAMMED BY:   Nikonorov Evgeny

 CREATION DATE:   17.09.09
*******************************************************************************/
import DealsInter, "DLReport_h.mac", "tsutil.mac";

private const PTK_MATERIALCOMPLEX = 39; //®¨„È•·‚¢•≠≠Î© ™Æ¨Ø´•™·

/* ë‚‡„™‚„‡† · ®·ÂÆ§≠Î¨® §†≠≠Î¨® */
private class SourceData(
      _DprtID:integer, 
      _AvrTypeID: integer, 
      _EmiID: integer,
      _AvrID: integer,
      _IsClientOFBU: bool, 
      _ClientID: integer, 
      _ClientContr: integer, 
      _DepositaryID:integer,
      _OperType,
      _DealMarket:bool,
      _MarketID:integer, 
      _DealNotMarket:bool, 
      _dateMin: date,  
      _dateMax: date,
      _SplitByDates,
      _OperStatus:integer, 
      _apostrSum: bool, 
      _toExcel
   )

   var 
      PrintHead,
      IsFirstHead    =  true,
      PrintTableHead =  false,
      DprtID         =  _DprtID,
      AvrTypeID      =  _AvrTypeID,
      EmiID          =  _EmiID,
      AvrID          =  _AvrID,
      IsClientOFBU   =  _IsClientOFBU,
      ClientID       =  _ClientID,
      ClientContr    =  _ClientContr,
      DepositaryID   =  _DepositaryID,
      OperType       =  _OperType,
      DealMarket     =  _DealMarket,
      MarketID       =  _MarketID,
      DealNotMarket  =  _DealNotMarket,
      dateMin        =  _dateMin,
      dateMax        =  _dateMax,
      SplitByDates   =  _SplitByDates,
      OperStatus     =  _OperStatus,
      apostrSum      =  _apostrSum,
      toExcel        =  _toExcel;
end;

var TableHead = "⁄ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
                "≥          ≥          ≥                ≥             ≥             ≥              ≥    ¸     ≥     ¸     ≥           èÆ§‚¢•‡¶§†ÓÈ®©       ≥       ≥                 ≥          ≥                          ñ•≠≠Î• °„¨†£®                         ≥\n"+
                "≥¸ ÆØ•‡†Ê®®≥  Ñ†‚†    ≥ä‡†‚™Æ• ÆØ®·†≠®•≥  èÆ·‡•§≠®™  ≥ Ñ•ØÆß®‚†‡®© ≥ ç†®¨•≠Æ¢†≠®• ≥ §Æ£Æ¢Æ‡† ≥ ØÆ‡„Á•≠®Ô ≥              §Æ™„¨•≠‚          ≥ äÆ´-¢Æ≥  ë„¨¨† ÆØ•‡†Ê®® ≥  Ç†´Ó‚†  ≥                                                                ≥\n"+
                "≥          ≥ ÆØ•‡†Ê®® ≥    ÆØ•‡†Ê®®    ≥             ≥             ≥    ™´®•≠‚†   ≥          ≥           √ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¥       ≥                 ≥ ÆØ•‡†Ê®® √ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¥\n"+
                "≥          ≥          ≥                ≥             ≥             ≥              ≥          ≥           ≥    Ç®§    ≥    ¸    ≥   Ñ†‚†   ≥  Ê/°  ≥                 ≥          ≥  ù¨®‚•≠‚   ≥Ç®§ Ê/°≥   äÆ§ Ê/°  ≥ ÇÎØ„·™ ≥ ë•‡®Ô,   ≥ ñ•≠† Ê/° ≥\n"+
                "≥          ≥          ≥                ≥             ≥             ≥              ≥          ≥           ≥           ≥         ≥          ≥       ≥                 ≥          ≥            ≥       ≥            ≥        ≥ ¸, ‚‡†≠Ë ≥          ≥\n"+
                "√ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ¥";


// Ñ´Ô WinRep
private var Rep = CMakeReport(TableHead);
private const FontStyleTitel =  "ex_FS(b)";


/////////////////////////////////////////////////////////////////////////////////////////////////////////

private macro PrintHeader(Data, DepartmentName, RepDate) 

   var party = TBFile( "party.dbt",  "R", 0 );
   var avrk = TBFile( "AvrKinds.dbt",  "R", 0 );
   VAR SfContr     = TRecHandler( "sfcontr.dbt" );
   var DateShow = "", StatusName = ""; 

   if(Data.SplitByDates)
      DateShow = string(RepDate);
   else
      DateShow = string(Data.dateMin) + " ØÆ " + string(Data.dateMax);
   end;

   
   if(DepartmentName)
     Rep.AddPrintCell("î®´®†´    " + DepartmentName, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
     Rep.AddStr();
   end;
   Rep.AddPrintCell("                                                                                       ëìÅêÖÉàëíê ¢≠„‚‡•≠≠•£Æ „Á•‚† ", Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell("                                                                             ®≠ÎÂ ÆØ•‡†Ê®© · ≠•Ì¨®··®Æ≠≠Î¨® Ê•≠≠Î¨® °„¨†£†¨®", Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell("                                                                                    ß† Ø•‡®Æ§ " + DateShow , Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   Rep.AddStr();

   if( (Data.AvrTypeID > 0) AND TS_FindAvrKinds(FIKIND_AVOIRISS,Data.AvrTypeID,avrk) )
       Rep.AddPrintCell("Ç®§ Ê/°:    "+avrk.rec.Name, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
       Rep.AddStr();
     end;
   if( (Data.EmiID > 0) and (not èÆ´„Á®‚Ïë„°Í•™‚†(Data.EmiID, party)) )
       Rep.AddPrintCell("ù¨®‚•≠‚:    "+party.rec.ShortName, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
       Rep.AddStr();
     end;
   if( (Data.ClientID > 0) and (not èÆ´„Á®‚Ïë„°Í•™‚†(Data.ClientID, party)) )
       Rep.AddPrintCell("ä´®•≠‚:     "+party.rec.ShortName, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
       Rep.AddStr();
     end;

   if( (Data.ClientContr > 0) AND FindSfContrByOrder(Data.ClientContr,SfContr) )
       Rep.AddPrintCell("ÑÆ£Æ¢Æ‡ ¸ "+SfContr.rec.Number + " Æ‚ " +string(SfContr.rec.DATECONC), Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
       Rep.AddStr();
   end;

   if(Data.OperStatus >= 0)
      if(Data.OperStatus == 20)
        StatusName = "á†¢•‡Ë•≠≠Î• ÆØ•‡†Ê®®";
      elif(Data.OperStatus == 10)
        StatusName = "ç•ß†¢•‡Ë•≠≠Î• ÆØ•‡†Ê®®";
      end;
      Rep.AddPrintCell(StatusName, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
      Rep.AddStr();
   end;
   
   Rep.AddEmptyStr();
end;

private macro PrintRepLine(A1,A2,A3,A5,A6,A7,A8,A10,A11,A12,A13,A14,A15,V18,V19,V221,V222,V23,V24)
  Rep.AddPrintCell(A1, 0, 0, "c");
  Rep.AddPrintCell(A2, 0, 0, "c");
  Rep.AddPrintCell(A3, 0, 0, "c");
  Rep.AddPrintCell(A5, 0, 0, "c");
  Rep.AddPrintCell(A6, 0, 0, "c");
  Rep.AddPrintCell(A7, 0, 0, "c");
  Rep.AddPrintCell(A8, 0, 0, "c");
  Rep.AddPrintCell("", 0, 0, "c"); // A9 Ø‡ÆØ„·™†•¨ ≠Æ Æ≠† •·‚Ï!
  Rep.AddPrintCell(A10, 0, 0, "c");
  Rep.AddPrintCell(A11, 0, 0, "c");
  Rep.AddPrintCell(A12, 0, 0, "c");
  Rep.AddPrintCell(A13, 0, 0, "c");
  Rep.AddPrintCell(A14, 0, 0, "c");
  Rep.AddPrintCell(A15, 0, 0, "c");
  Rep.AddPrintCell(V18, 0, 0, "c");
  Rep.AddPrintCell(V19, 0, 0, "c");
  Rep.AddPrintCell("", 0, 0, "c"); // A20 Ø‡ÆØ„·™†•¨ ≠Æ Æ≠† •·‚Ï!
  Rep.AddPrintCell("", 0, 0, "c"); // A21 Ø‡ÆØ„·™†•¨ ≠Æ Æ≠† •·‚Ï!        
  Rep.AddPrintCell(V221+" "+V222, 0, 0, "c");
  Rep.AddPrintCell(V23+" "+V24, 0, 0, "c");
        
  Rep.AddStr();                 
end;


private macro PrintDealLine(A1,A2,A3,A5,A6,A7,A8,A10,A11,A12,A13,A14,A15)
  PrintRepLine(A1,A2,A3,A5,A6,A7,A8,A10,A11,A12,A13,A14,A15,"","","","","","");
end;

private macro PrintBnrLine(V18,V19,V221,V222,V23,V24)
  PrintRepLine("","","","","","","","","","","","","",V18,V19,V221,V222,V23,V24);
end;

private macro GetGround(DealKind, DealID, Kind, Xld:@variant, RegDate:@variant, KindName:@variant)
  var ground, query;
  var groundstr = "";
  var Select;
  var stat = false;

  query = " select val.t_Name, spgr.t_XLD, spgr.t_RegistrDate from dspground_dbt spgr, dspgrdoc_dbt doc, dllvalues_dbt val "
        + "  where doc.t_SourceDocKind = ? /*1*/ " 
        + "    and doc.t_SourceDocID = ? /*2*/ "  
        + "    and spgr.t_SPgroundID = doc.t_SPgroundID" 
        + "    and spgr.t_Kind = ? /*3*/ " 
        + "    and val.t_Element = spgr.t_Kind "
        + "    and val.t_List = " + OBJTYPE_KINDDOC;
  
  Select = RSDCommand( query );

  Select.AddParam("DealKind", RSDBP_IN, DealKind );  /*1*/
  Select.AddParam("DealID",   RSDBP_IN, DealID );    /*2*/
  Select.AddParam("Kind",     RSDBP_IN, Kind );      /*3*/

  Select.Execute();

  ground = TRsbDataSet(Select);

  stat = ground.moveNext();
  if(stat)
    Xld   = ground.XLD;
    KindName = ground.Name;
    RegDate  = string(date(ground.RegistrDate)); 
  else
    Xld   = "";
    KindName = "";
    RegDate  = "";
  end;

  return stat;
end;

private macro GetCountDealBnr(DealKind, DealID, CountBnr:@variant)
  var query, Select, DataSet;

  query = "select count(1) as CountBnr from dvsordlnk_dbt lnk where lnk.t_DocKind = ? and lnk.t_ContractID = ? ";

  Select = RSDCommand( query );

  Select.AddParam("DealKind", RSDBP_IN, DealKind );  /*1*/
  Select.AddParam("DealID",   RSDBP_IN, DealID );    /*2*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  if(DataSet.moveNext())
    CountBnr = DataSet.CountBnr;
  else
    CountBnr = 0;
  end;
end;

private macro GetSumDealCost(DealKind, DealID, DealCost:@variant, DealFI_ISO:@variant)
  var query, Select, DataSet;
  var BCCFI = -1;
  file fin(fininstr);
  
  DealCost = 0.0;
  DealFI_ISO = "";

  query = "select t_BCCost, t_BCCFI from dvsordlnk_dbt where t_DocKind = ? and t_ContractID = ?";

  Select = RSDCommand( query );

  Select.AddParam("DealKind", RSDBP_IN, DealKind );  /*1*/
  Select.AddParam("DealID",   RSDBP_IN, DealID );    /*2*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);
  while(DataSet.moveNext())
    DealCost = DealCost + DataSet.BCCost;
    BCCFI = DataSet.BCCFI;
  end;

  if(BCCFI != -1)
    if( not èÆ´„Á®‚Ïî®≠à≠(BCCFI,fin) )
      DealFI_ISO = fin.CCY;
    end;
  end;
end;

private macro Ñ•ØÆß®‚†‡®©():string
  var ds, CustodyOfficeID, Err;
  var DepoShortName:string = "";

  var WithDopo = êÄÅéíÄ_ë_ÑÖèéáàíÄêàÖå();
  if( (WithDopo == TS_WORK_DEPO_BACK_NO) OR (WithDopo==TS_WORK_DEPO_BACK))
    GetRegistryValue( "DEPO\\OURDEPOSITOFFICE", V_INTEGER, CustodyOfficeID, Err );
    if( Err != 0 )
      MsgBox( "éË®°™† Ø‡® Á‚•≠®® ≠†·‚‡Æ©™® \"" + "DEPO\\OURDEPOSITOFFICE" + "\".");
    else
      DepoShortName = TS_GetPartyName( CustodyOfficeID );
    end;
  end;

  return DepoShortName;
end;

private macro CreateRep(Data)
  VAR ReportFileName, TblName = "trvasregop";
  FILE ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/
  var noData = "Ç „™†ß†≠≠Î© Ø•‡®Æ§ ÆØ•‡†Ê®©, ·ÆÆ‚¢•‚·‚¢„ÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†, ≠• ·Æ¢•‡Ë†´Æ·Ï.";
  var cDate = Data.dateMin;
  var oldDprtID = Data.DprtID;
  var query, DataSet;
  var olddate = date(0,0,0), olddep = 0, olddeal = 0;
  var DepName = "";
  var Xld = "", DealKindName = "", RegDate = "";
  var CountBnr = 0;
  var DealCost = 0.0, DealFI_ISO = "";
  var i = 0;
  var stat = 0;
  
  var DepoShortName:string = Ñ•ØÆß®‚†‡®©();

  query =   " select tick.t_Department, dp.t_ShortName as DepartmentName, tick.t_DealDate, tick.t_DealID, "
          + "        tick.t_DealCode, cl.t_ShortName as ClientName, sf.t_Number as SfNumber, tick.t_BOfficeKind, bnr.t_IssuerName, avr.t_Name as AvoirName, "
          + "        bnr.t_BCSeries, bnr.t_BCNumber, lnk.t_BCCost, bccfi.t_CCY "
          + "   from dvsbanner_dbt bnr, ddl_leg_dbt leg, dvsordlnk_dbt lnk, ddl_tick_dbt tick, ddp_dep_dbt dep, dparty_dbt dp, "
          + "        dfininstr_dbt fin, dparty_dbt cl, dsfcontr_dbt sf, davrkinds_dbt avr, dfininstr_dbt bccfi "
          + "  where bnr.t_Issuer not in (select dc.t_PartyID from ddp_dep_dbt dc) "
          + "    and leg.t_LegKind = 1 and leg.t_DealID = bnr.t_BCID and leg.t_LegID = 0 "
          + "    and lnk.t_BCID = bnr.t_BCID "
          + "    and lnk.t_DocKind = " + DL_VATRREPAY //ØÆ£†Ë•≠®• ìÇ ¢ Ñì
          + "    and tick.t_DealID = lnk.t_ContractID "
          + "    and fin.t_FIID = bnr.t_FIID "
          + "    and (tick.t_DealStatus = "+DL_CLOSED+" or tick.t_DealStatus = "+DL_READIED+") "
          + "    and tick.t_DealDate >= " + GetSQLDate(Data.dateMin) + " and tick.t_DealDate <= " + GetSQlDate(Data.dateMax)
          + "    and dep.t_Code = tick.t_Department "
          + "    and dp.t_PartyID = dep.t_PartyID "
          + "    and cl.t_PartyID = tick.t_ClientID "
          + "    and sf.t_ID = tick.t_CLientContrID "
          + "    and avr.t_FI_Kind = fin.t_FI_Kind "
          + "    and avr.t_AvoirKind = fin.t_AvoirKind "
          + "    and bccfi.t_FIID (+)= lnk.t_BCCFI";

  if(Data.AvrTypeID != -1)
    query = query + " and RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + Data.AvrTypeID + ", fin.t_AvoirKind) > 0 ";
  end;

  if(Data.EmiID != -1)
    query = query + " and bnr.t_Issuer = " + Data.EmiID;
  end;

  if(Data.AvrID != -1)
    query = query + " and bnr.t_FIID = " + Data.AvrID;
  end;

  if( Data.OperStatus > 0 )
     query = query + " and tick.t_DealStatus = " + Data.OperStatus;
  else
     Query = Query  + " and tick.t_DealStatus > " + DL_PREPARING;
  end;

  if(Data.DprtID != -1)
    query = query + " and tick.t_Department = " + Data.DprtID;
  end;

  if(Data.IsClientOFBU)
    query = query + " and tick.t_ClientID IN ( SELECT d2.T_PARTYID FROM DPARTYOWN_DBT d2 WHERE d2.T_PARTYID = tick.t_ClientID AND d2.T_PARTYKIND = " + PTK_MATERIALCOMPLEX+")";
  end;

  if(Data.ClientID != -1)
    query = query + " and tick.t_ClientID = " + Data.ClientID;
  end;

  if( Data.ClientContr != -1 )
     Query = Query  + " and t_ClientContrID = " + Data.ClientContr;
  end;

  query = query + " order by tick.t_Department, tick.t_DealDate, t_DealCode, t_DealID";

  DataSet = TRsbDataSet( query, RSDVAL_CLIENT, RSDVAL_STATIC );
  DataSet.MoveLast();

  InitProgress( DataSet.GetRecCount(), "é‚Á•‚† \"ë„°‡•£®·‚‡ ®≠ÎÂ ÆØ•‡†Ê®©\"", "è‡Æ·¨Æ‚‡ ·§•´Æ™ · ≠•Ì¨®··®Æ≠≠Î¨® Ê/°" );

  stat = DataSet.MoveFirst();

  while(stat)

    if(i > 0)
      if(((Data.SplitByDates) and (olddate != date(DataSet.DealDate))) //ØÆ §†‚†¨
       or (olddep != DataSet.Department))
        after_44_footer(Rep);
      end;
    end;  
    
    DepName = "";

    if(olddep != DataSet.Department)
      DepName = DataSet.DepartmentName;
      if(olddep != 0)
        Rep.AddNewSheetBreak(DepName);
      else
        Rep.GetCurSheet().SetSheetName(DepName);
      end;
    end;

    if((Data.SplitByDates) and (olddate != date(DataSet.DealDate))) //ØÆ §†‚†¨
      PrintHeader(Data, DepName, date(DataSet.DealDate));
    elif(olddep != DataSet.Department)
      PrintHeader(Data, DepName);
    end;

    if(olddeal != DataSet.DealID) //•·´® ≠Æ¢†Ô ·§•´™† - Ø•Á†‚†•¨ ®≠‰Æ‡¨†Ê®Ó Æ ·§•´™•
      if(not GetGround(DataSet.BOfficeKind, DataSet.DealID, 102 /*á†Ô¢´•≠®• ≠† ØÆ£†Ë•≠®•*/, @Xld, @RegDate, @DealKindName))
         GetGround(DataSet.BOfficeKind, DataSet.DealID, 335 /*ëÆ£´†Ë•≠®• Æ §Æ·‡ÆÁ≠Æ¨ ¢Î™„Ø•*/, @Xld, @RegDate, @DealKindName);
      end;

      GetCountDealBnr(DataSet.BOfficeKind, DataSet.DealID, @CountBnr);
      GetSumDealCost(DataSet.BOfficeKind, DataSet.DealID, @DealCost, @DealFI_ISO);

      PrintDealLine(DataSet.DealCode,
                    date(DataSet.DealDate),
                    "èÆ£†Ë•≠®• Ê/°",
                    "",
                    DepoShortName,       /* Ñ•ØÆß®‚†‡®© */
                    DataSet.ClientName,
                    DataSet.SfNumber,
                    DealKindName,
                    TS_IIF(Xld, "¸"+Xld, ""),
                    RegDate,
                    CountBnr, 
                    string(money(DealCost)),
                    DealFI_ISO);
    end;

    //Ø•Á†‚†•¨ ¢•™·•´Ï
    PrintBnrLine(DataSet.IssuerName,
                 DataSet.AvoirName,
                 DataSet.BCSeries,
                 TS_IIF(DataSet.BCNumber, string("¸"+trim(DataSet.BCNumber)), ""),
                 DataSet.BCCost,
                 DataSet.CCY);
    

    olddate = date(DataSet.DealDate);
    olddep = DataSet.Department;
    olddeal = DataSet.DealID;

    UseProgress(i = i + 1);
    stat = DataSet.moveNext();
  end;

  if(i)
    after_44_footer(Rep);
  else
    Rep.AddPrintCell(noData, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
  end;

  RemProgress();

  if( Data.toExcel )
    Rep.PrintWinRep();
    Rep.ShowWinRep();
  else
    //Rep.PrintRep();
    ReportFileName = GetTxtFileName( TblName );

    if( Open( ReportOutFile, ReportFileName ) == true )
      SetOutput( ReportFileName );
      Rep.PrintRep();
      SetOutput( NULL, true );
      close( ReportOutFile );
      ViewFile( ReportOutFile );
    end;
  end;
end;

macro TRVASubRegistrReport(DprtID:integer,
                           AvrTypeID: integer,
                           EmiID: integer,
                           AvrID: integer,
                           IsClientOFBU: bool,
                           ClientID: integer,
                           ClientContr: integer,
                           DepositaryID: integer,
                           OperType: integer,
                           DealMarket:bool,
                           MarketID:integer,
                           DealNotMarket:bool,
                           dateMin: date,
                           dateMax: date,
                           SplitByDates:bool,
                           OperStatus:integer,
                           apostrSum: bool,
                           toExcel:bool)
   var Data = SourceData(
         DprtID,
         AvrTypeID,
         EmiID,
         AvrID,
         IsClientOFBU,
         ClientID,
         ClientContr,
         DepositaryID,
         OperType,
         DealMarket,
         MarketID,
         DealNotMarket,
         dateMin,
         dateMax,
         SplitByDates,
         OperStatus,
         apostrSum,
         toExcel
      );
   
   CreateRep(Data);

end;
