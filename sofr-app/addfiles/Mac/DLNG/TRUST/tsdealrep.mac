/*******************************************************************************
 Отчет Субрегистр срочных сделок ДУ
*******************************************************************************/
import "tsdealrep_Form.mac", "dvRepFun2.mac";

PRIVATE VAR ReportHeader =
"Субрегистр срочных сделок, совершенных по договорам доверительного управления\n" +
" \n" +
" \n" +
"Филиал:                      ##########################\n" +
"Отчетный период:             с ########## по ##########\n" +
"Вид базового актива:         ##########################\n" +
"Базовый актив:               ##########################\n" +
"Вид контракта:               ##########################\n" +
"Контрагент  по расчетам:     ##########################\n" +
" \n" +
"Клиент:     ####################  #################  Договор: #################\n";

PRIVATE VAR TableHeader =
"┌──────────┬───────────┬────────────┬──────────────────┬──────────────────┬─────────────┬──────────────────┬───────────────────────┬──────────────────────┬─────────────────┬───────────────────────┐\n"+
"│          │           │            │                  │                  │             │                  │                       │   Цена фьючерсного   │                 │                       │\n"+
"│          │           │            │ Место совершения │    Вид сделки/   │     Вид     │                  │Цена исполнения опциона│       контракта      │                 │Подтверждающий документ│\n"+
"│ № сделки │    Дата   │   Время    │      сделки      │     операции     │  контракта  │     Контракт     │                       │  (премия по опциону) │    Количество   │                       │\n"+
"│          │           │            │                  │                  │             │                  ├────────────────┬──────┼───────────────┬──────┤                 ├───────────┬───────────┤\n"+
"│          │           │            │                  │                  │             │                  │      Сумма     │Валюта│     Сумма     │Валюта│                 │Вид №док-та│   Дата    │\n"+
"├──────────┼───────────┼────────────┼──────────────────┼──────────────────┼─────────────┼──────────────────┼────────────────┼──────┼───────────────┼──────┼─────────────────┼───────────┼───────────┤";

PRIVATE CLASS (DL_CReportTemplate) TS_Deal_Report

  var IsNotEof;       /*конец выборки*/
  var KindOper = "", IssName = "";
  var Num = 0;
  var App = "";
  var FKIND = 0;
  var AKIND = 0;


  var m_FormRV_Department,
      m_FormRV_ClientNum,
      m_FormRV_Contract,
      m_FormRV_ExchengeNum,
      m_FormRV_BaseFIKind,
      m_FormRV_BaseFINum,
      m_FormRV_DerivKind,
      m_FormRV_DerivNum,
      m_FormRV_ContrKind,
      m_FormRV_ContrNum,
      m_FormRV_IsApp;

  var FI = ПроизводныйИнструмент();

  var File_DVMarketDeal;

  PRIVATE MACRO PrintMode():INTEGER
     return m_Form.GetFieldValue( PNFLD_DEALREP_PRINTMETHOD );
  END;

  PRIVATE MACRO BeginReport()

     m_FormRV_Department  = m_Form.GetFieldValue( PNFLD_DEALREP_DEPARTCODE );
     m_FormRV_ClientNum   = m_Form.GetFieldValue( PNFLD_DEALREP_CLIENT_OFBU );
     m_FormRV_Contract    = m_Form.GetFieldValue( PNFLD_DEALREP_CONTRACT_OFBU );
     m_FormRV_ExchengeNum = m_Form.GetFieldValue( PNFLD_DEALREP_EXCHANGE );
     m_FormRV_BaseFIKind  = m_Form.GetFieldValue( PNFLD_DEALREP_BASEACT_KIND );
     m_FormRV_BaseFINum   = m_Form.GetFieldValue( PNFLD_DEALREP_BASEACT_NUM );
     m_FormRV_DerivKind   = m_Form.GetFieldValue( PNFLD_DEALREP_DERIV_KIND );
     m_FormRV_DerivNum    = m_Form.GetFieldValue( PNFLD_DEALREP_DERIV_NUM );
     m_FormRV_ContrKind   = m_Form.GetFieldValue( PNFLD_DEALREP_CONTR_KIND );
     m_FormRV_ContrNum    = m_Form.GetFieldValue( PNFLD_DEALREP_CONTR_NUM );
     m_FormRV_IsApp       = m_Form.GetFieldValue( PNFLD_DEALREP_PRINTMETHOD );

     this.SetActiveSheet( "Отчет" );

     this.PrintFormatString( ReportHeader,
                             "N_H_0",   IIF(m_FormRV_Department == UNDF, "", FormData.Department), // Филиал
                             "N_H_1_1", FormData.BegDate,                                          // Отчетный период
                             "N_H_1_2", FormData.EndDate,                                          // Отчетный период
                             "N_H_1",   IIF(m_FormRV_BaseFIKind == UNDF, "", FormData.BaseFIKind), // Вид базового актива
                             "N_H_2",   IIF(m_FormRV_BaseFINum  == UNDF, "", FormData.BaseFIName), // Базовый актив
                             "N_H_3",   IIF(m_FormRV_DerivKind  == UNDF, "", FormData.DerivKind),  // Вид контракта
                             "N_H_4",   IIF(m_FormRV_DerivNum   == UNDF, "", FormData.DerivNum),   // Код контракта
                             "N_H_5",   IIF(m_FormRV_ContrNum   == UNDF, "", FormData.ContrName),  // Контрагент  по расчетам
                             "N_H_6_1", IIF(m_FormRV_ClientNum  == UNDF, "", FormData.ClientNum),  // Клиент
                             "N_H_6_2", IIF(m_FormRV_ClientNum  == UNDF, "", FormData.ClientName), // Клиент
                             "N_H_7",   IIF(m_FormRV_Contract   == UNDF, "", FormData.Contract) ); // Договор

     this.RegisterTable( "N_MainTable", TableHeader,
               /*1  */   "N_NumDeal",
               /*2  */   "N_Date",
               /*3  */   "N_Time",
               /*4  */   "N_Place",
               /*5  */   "N_Kind",
               /*6  */   "N_KindContract",
               /*7  */   "N_Contract",
               /*8  */   "N_OptSum",
               /*9  */   "N_OptCur",
               /*10 */   "N_Amount",
               /*11 */   "N_DocKind",
               /*12 */   "N_DocDate" );

  END;

  PRIVATE MACRO EndReport()
     this.EndTable();
     this.AddStandardFooter( "N_" );
  END;

  PRIVATE MACRO OptionType( type )

     if( type == 0 )
        return " ";
     elif( type == 1 )
        return "Put";
     else
        return "Call";
     end;
  END;

  PRIVATE MACRO Create()

/* Создаем SQL запрос для того чтобы в один прием выгрести все данные для отчета. */
var sqlQuery =  " SELECT DVDeal.T_DATE," +
                "        DVDeal.T_TIME," +
               "        DVDeal.T_FIID," +
               "        DVDeal.T_DEPARTMENT," +
//               "        ( SELECT Dprt.T_NAME FROM ddp_dep_dbt Dprt WHERE Dprt.T_CODE = DVDeal.T_DEPARTMENT ) DepartmentName," +
                "        DVDeal.T_KIND," +
                "        DVDeal.T_CODE," +
                "        ( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = ContrFI.T_FI_KIND and AvrKinds.T_AVOIRKIND = ContrFI.T_AVOIRKIND) DVFIKind," +
                "        ContrFI.T_FI_CODE," +
                "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER ) IssuerName," +
//               "        DECODE( BaseFI2.T_FI_KIND, 2, ( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = BaseFI2.T_FI_KIND and AvrKinds.T_AVOIRKIND = BaseFI2.T_AVOIRKIND)," +
//               "                                   3, 'Индекс' ) BaseKind," +
//               "        BaseFI2.T_FI_CODE BaseFICode," +
//               "        DECODE( ( SELECT SfContr.T_SERVKIND FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVPos.T_CLIENTCONTR ), NULL, 1," +
//               "                                                                                                                    15, 2," +
//               "                                                                                                                   999, 3) DealType," +
////               "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVPos.T_CLIENT ) ClientName," +
////               "        ( SELECT SfContr.T_NAME FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVPos.T_CLIENTCONTR ) SfContrName," +
//               "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVPos.T_BROKER ) BrokerName," +
                "        DECODE( DvDeal.t_Type, 'E', DECODE( DVDeal.T_POSITION, 1, 'Короткие позиции', 'Длинные позиции' ), DECODE(DvDeal.t_Type, 'B', 'Короткие позиции','Длинные позиции') ) Position," +
                "        DVDeal.T_AMOUNT," +
                "        DVDeal.T_PRICE," +
                "        ContrDV.T_STRIKE," +
                "        DECODE( ContrDV.T_STRIKEFIID, -10, 'Пункт(ов)', ( SELECT FI.T_CCY FROM dfininstr_dbt FI WHERE FI.T_FIID = DECODE( ContrDV.T_STRIKE, 0.0, NULL, ContrDV.T_STRIKEFIID ) ) ) StrikeFI," +
                "        ContrDV.T_OPTIONTYPE , " +
                "        ( SELECT SpGround.T_XLD FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 ) OrderNum, "
                "        ( SELECT SpGround.T_SignedDATE FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 ) OrderSigDate"
               "   FROM " +
//               "        ddvfipos_dbt DVPos,  " +
               "        ddvdeal_dbt DVDeal,  " +
               "        dfininstr_dbt ContrFI, " +
               "        dfideriv_dbt ContrDV, " +
               "        dfininstr_dbt BaseFI1 " +
//               "        dfininstr_dbt BaseFI2 " +
               "  WHERE ContrFI.T_FIID = DVDeal.T_FIID and " +
               "        BaseFI1.T_FIID = ContrFI.T_FACEVALUEFI and " +
//               "        BaseFI2.T_FIID = DECODE(BaseFI1.T_FI_KIND, 4, BaseFI1.T_FACEVALUEFI,ContrFI.T_FACEVALUEFI) and " +
               "        ContrDV.T_FIID = DVDeal.T_FIID and " +
//               "        DVPos.T_FIID = DVDeal.T_FIID and " +
//               "        DVPos.T_DEPARTMENT = DVDeal.T_DEPARTMENT and " +
//               "        DVPos.T_CLIENT = DVDeal.T_CLIENT and " +
//               "        DVPos.T_BROKER = DVDeal.T_BROKER AND " +
               "        dvdeal.t_istrust = 'X' " +
               /*условия по датам*/
               "      and DVdeal.T_DATE >= " + GetSQLDate( FormData.BegDate ) +
               "      and DVdeal.T_DATE <= " + GetSQLDate( FormData.EndDate );

   if( m_FormRV_Department != UNDF )
       sqlQuery = sqlQuery + " and DVDeal.T_DEPARTMENT = " + String( m_FormRV_Department );
   end;

   if( m_FormRV_ClientNum != UNDF )
       sqlQuery = sqlQuery + " and DVDeal.T_CLIENT = " + String( m_FormRV_ClientNum );
   end;

   if( m_FormRV_Contract != UNDF )
       sqlQuery = sqlQuery + " and DVDeal.T_CLIENTCONTR = " + String( m_FormRV_Contract );
   end;

   if( m_FormRV_ExchengeNum != UNDF )
       sqlQuery = sqlQuery +
           "AND   ( SELECT Party.T_PARTYID FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER ) = " + string(m_FormRV_ExchengeNum);
   end;

   /* Если надо уставливаем условие типу базового актива*/
   if( m_FormRV_BaseFIKind != DL_BAKIND_ALL )

      if( m_FormRV_BaseFIKind == DL_BAKIND_SHARE )
         FKIND = FIKIND_AVOIRISS;
         AKIND = AVOIRISSKIND_SHARE;
         sqlQuery = sqlQuery + " AND RSB_FIInstr.FI_AvrKindsEQ(" + string(FKIND) + ", " + string(AKIND) + ", BaseFI1.t_AvoirKind) > 0 ";
      elif( m_FormRV_BaseFIKind == DL_BAKIND_BOND )
         FKIND = FIKIND_AVOIRISS;
         AKIND = AVOIRISSKIND_BOND;
         sqlQuery = sqlQuery + " AND RSB_FIInstr.FI_AvrKindsEQ(" + string(FKIND) + ", " + string(AKIND) + ", BaseFI1.t_AvoirKind) > 0 ";
      elif( m_FormRV_BaseFIKind == DL_BAKIND_FI )
         FKIND = FIKIND_CURRENCY;
         AKIND = FIKIND_ALLAVOIRISS;
         sqlQuery = sqlQuery + " and BaseFI1.T_FI_KIND = " + String( FKIND ) + " AND BaseFI1.t_AvoirKind = " +  string(AKIND);
      elif( m_FormRV_BaseFIKind == DL_BAKIND_IDX)
         FKIND = FIKIND_INDEX;
         AKIND = FIKIND_ALLAVOIRISS;
         sqlQuery = sqlQuery + " and BaseFI1.T_FI_KIND = " + String( FKIND ) + " AND BaseFI1.t_AvoirKind = " +  string(AKIND);
      end;

   end;

   /* Если надо уставливаем условие базому активу*/
   if( m_FormRV_BaseFINum != UNDF )
         sqlQuery = sqlQuery + " and BaseFI1.T_FIID = " + String( m_FormRV_BaseFINum );
   end;

   /* Если надо уставливаем условие типу ПИ*/
   if( m_FormRV_DerivKind != DL_DERIVKIND_ALL )
       sqlQuery = sqlQuery + " and ContrFI.T_AVOIRKIND = " + String( m_FormRV_DerivKind );
   end;

   /* Если надо уставливаем условие по ПИ*/
   if( m_FormRV_DerivNum != UNDF )
       sqlQuery = sqlQuery + " and DVDeal.T_FIID = " + String( m_FormRV_DerivNum );
   end;

   if( (m_FormRV_ContrKind == CONTRKIND_BROKER) AND (m_FormRV_ContrNum == UNDF) )
      sqlQuery = sqlQuery + " and DVDeal.T_BROKER != -1 ";
   elif( (m_FormRV_ContrKind == CONTRKIND_EXCHENGE) AND (m_FormRV_ContrNum == UNDF) )
      sqlQuery = sqlQuery + " and DVDeal.T_BROKER = -1 ";
   end;

   if( (m_FormRV_ContrKind == CONTRKIND_BROKER) AND (m_FormRV_ContrNum != UNDF) )
      sqlQuery = sqlQuery + " and DVDeal.T_BROKER = " + String( m_FormRV_ContrNum );
   elif( (m_FormRV_ContrKind == CONTRKIND_EXCHENGE) AND (m_FormRV_ContrNum != UNDF) )
      sqlQuery = sqlQuery + " and ContrFI.T_ISSUER = " + String( m_FormRV_ContrNum );
   end;

   /* Уставливаем Нужную сортировку для последующего вывода*/
   sqlQuery = sqlQuery + " ORDER BY DVDeal.T_DEPARTMENT, DVDeal.T_DATE, DVDeal.T_TIME, DVDeal.T_CLIENT ";

   File_DVMarketDeal = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
   File_DVMarketDeal.MoveLast();

   IsNotEof = File_DVMarketDeal.MoveFirst();

   InitProgress( File_DVMarketDeal.GetRecCount(), HTML_StSheetName, HTML_StSheetName );

   while( IsNotEof )

      FI.Init( File_DVMarketDeal.FIID );
      KindOper = GetKindOper( File_DVMarketDeal.Kind );
      if(KindOper == "Исполнение")
        KindOper = KindOper + " " + File_DVMarketDeal.Position;
      end;

      IssName = File_DVMarketDeal.IssuerName;

      if( (m_FormRV_ContrKind == CONTRKIND_BROKER) AND (m_FormRV_ContrNum != UNDF) )
         IssName = IssName + " брокер " +  string(FormData.ContrName);
      end;

      if( m_FormRV_IsApp )
         App = ":a";
      end;

      this.PrintTableLine(
                /*1 */  "N_NumDeal",       File_DVMarketDeal.Code,        null,
                /*2 */  "N_Date",          Date(File_DVMarketDeal.Date),  null,
                /*3 */  "N_Time",          Time(File_DVMarketDeal.Time),  null,
                /*4 */  "N_Place",         IssName,                       null,
                /*5 */  "N_Kind",          KindOper,                      null,
                /*6 */  "N_KindContract",  File_DVMarketDeal.DVFIKind + " " + OptionType(File_DVMarketDeal.OptionType),  null,
                /*7 */  "N_Contract",      File_DVMarketDeal.FI_Code,     null,
                /*8 */  "N_OptSum" + App,  File_DVMarketDeal.Strike,      null,
                /*9 */  "N_OptCur",        File_DVMarketDeal.StrikeFI,    null,
                /*10 */ "N_DealSum" + App, File_DVMarketDeal.Price * File_DVMarketDeal.Amount,    null,
                /*11 */ "N_DealCur",       FI.PriceCCY(),                 null,
                /*12 */ "N_Amount" + App,  File_DVMarketDeal.Amount,      null,
                /*13 */ "N_DocKind",       File_DVMarketDeal.OrderNum,    null,
                /*14 */ "N_DocDate",       File_DVMarketDeal.OrderSigDate, null );

      UseProgress( Num = Num + 1 );
      IsNotEof = File_DVMarketDeal.MoveNext();
   end;


   RemProgress();

   END;

   initDL_CReportTemplate( SP_DealRep_Panel(), "Report_DealRep.xls" );
END;

TS_Deal_Report().Run();
Exit(1);
