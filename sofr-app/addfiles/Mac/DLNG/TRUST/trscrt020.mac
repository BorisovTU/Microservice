/* IAL XX.11.2008                                        */
/*                                                       */   
/* ДУ (Доверительное управление )                        */
/*                                                       */
/* Операция Погашения ДУ                                 */
/*                                                       */
import InsCarryDoc, "tssec.mac";

macro ExecuteStep( Doc, FDoc, DocKind, OperationID, ID_Step )

  record deal(dl_tick);
  var    FD, dat, Dk, Dp;
  var    FiRoleAcc = FIROLE_UNDEF;
  var    PercentAcc     = TRecHandler("account.dbt");
  var    DebetAcc       = TRecHandler("account.dbt");


  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );
  GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat );

  if( FD.СделкаОРЦБ() )
     FiRoleAcc = FIROLE_ORCB_REQUEST;
  else
     FiRoleAcc = FIROLE_SETTL_AGENT;
  end;

  if( not FD.OpenAccount( "ПортфельЭцб ДУ", null, null, FIROLE_BA, PercentAcc, dat) )
     return 1;
  end;

  if( not FD.OpenAccount( "+Расчеты, ДУ", null, null, FiRoleAcc, DebetAcc, dat) )
     return 1;
  end;

  if( FD.СделкаОРЦБ() )
     ДУ_СохранитьСчетаВПлатеже( FD.pm_money, PercentAcc, DebetAcc );
  end;

  /*статус лота меняем на инициализирован*/
  if( not ОбновитьЛот( FD.pmwrtsum, PM_WRTSUM_UPDTMODE_DELIVERY, FD.DateArray[DATE_DEALDATE], FD ) )
     msgbox("Ошибка при изменении статуса лота");
     return 1;
  end;     

  if( TS_CreateDemandSEC_ByDeal( FD, OperationID, ID_Step ) == false )
     return 1;
  end;

  return 0;
end;

