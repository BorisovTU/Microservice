/*******************************************************************************
 é‚Á•‚ ëÆ·‚†¢ ØÆ‡‚‰•´Ô Ê/° ¢ Ñì
*******************************************************************************/
import "tsportfrep_Form.mac", "dvRepFun2.mac", "tsutil.mac";

PRIVATE CONST PTK_MATERIALCOMPLEX = 39; //®¨„È•·‚¢•≠≠Î© ™Æ¨Ø´•™·
PRIVATE CONST PTSK_TRUST          = 17; //§Æ¢•‡®‚•´Ï≠Æ• „Ø‡†¢´•≠®•
PRIVATE const SP_RATETYPE_TSS_DU_reqcom = 16;

PRIVATE VAR ReportHeader1 =
   " \n          ###############################################################################################\n" +
   " \n          ###############################################################################################\n";
   " \n";

PRIVATE VAR ReportHeader2 =
   " \n          ###############################################################################################\n";

PRIVATE VAR ReportHeader3 =
   " \n############################################################################################\n";

PRIVATE VAR TableHeader =
  "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
  "≥        ù¨®‚•≠‚        ≥    äÆ§ °„¨†£®     ≥ çÆ¨•‡ £Æ·. ‡•£®·‚‡†Ê®® ≥Ç†´Ó‚† ≠Æ¨®≠†´†≥ Ñ†‚† ® ¢‡•¨Ô ØÆ™„Ø™®  ≥   äÆ´®Á•·‚¢Æ  ≥   èÆ‡‚‰•´Ï   ≥           ñ•≠† ® ·‚Æ®¨Æ·‚Ï             ≥           ñ•≠† ® ·‚Æ®¨Æ·‚Ï             ≥           ñ•≠† ® ·‚Æ®¨Æ·‚Ï             ≥                       ≥               ç†™ÆØ´•≠≠Î© ™„ØÆ≠≠Î© §ÆÂÆ§                   ≥        ç†™ÆØ´•≠≠Î© §®·™Æ≠‚≠Î© §ÆÂÆ§       ≥\n"+
  "≥                       ≥                   ≥                        ≥               ≥                       ≥               ≥              ≥             Ø‡®Æ°‡•‚•≠®Ô               ≥               ‡Î≠ÆÁ≠†Ô                 ≥              °†´†≠·Æ¢†Ô                ≥       è•‡•ÆÊ•≠™†      √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n"+
  "≥                       ≥                   ≥                        ≥               ≥                       ≥               ≥              ≥                                        ≥                                        ≥                                        ≥                       ≥   ìØ´†Á•≠≠Î©   ≥ èÆ£†Ë•≠≠Î©        ≥      ç†Á®·´•≠≠Î©      ≥ èÆ£†Ë•≠≠Î©        ≥       ç†Á®·´•≠≠Î©     ≥\n"+
  "≥                       ≥                   ≥                        ≥               ≥                       ≥               ≥              ≥                                        ≥                                        ≥                                        ≥                       ≥                ≥ ß† Ø•‡®Æ§ Æ‚      ≥      ≠† Æ‚Á•‚≠„Ó      ≥ ß† Ø•‡®Æ§ Æ‚      ≥       ≠† Æ‚Á•‚≠„Ó     ≥\n"+
  "≥                       ≥                   ≥                        ≥               ≥                       ≥               ≥              ≥                                        ≥                                        ≥                                        ≥                       ≥                ≥ §†‚Î Ø‡®Æ°‡•‚•≠®Ô ≥         §†‚„          ≥ §†‚Î Ø‡®Æ°‡•‚•≠®Ô ≥          §†‚„         ≥\n"+
  "≥                       ≥                   ≥                        ≥               ≥                       ≥               ≥              ≥                                        ≥                                        ≥                                        ≥                       ≥                ≥ §Æ Æ‚Á•‚≠Æ© §†‚Î  ≥                       ≥ §Æ Æ‚Á•‚≠Æ© §†‚Î  ≥                       ≥\n"+
  "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ¥\n"+
  "≥            1          ≥          2        ≥            3           ≥       4       ≥     5     ≥     6     ≥       7       ≥       8      ≥        9       ≥       10       ≥      ≥        11      ≥        12      ≥      ≥        13      ≥        14      ≥      ≥        15      ≥      ≥   16           ≥       17          ≥        18      ≥      ≥         19        ≥       20       ≥      ≥\n"+
  "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ¥";

PRIVATE VAR ReportItogH3 =
"\n ############################################################################################################################                                 ################ ######                  ################ ######                  ################ ###### ################ ######                                      ################ ######                     ################ ######\n";

PRIVATE MACRO GetCouponSumByPeriod( FIID, Amount, DateBeg, DateEnd, CouponCount:@INTEGER, ExcludeDate, CalcByDates )
  return TS_GetCouponSumByPeriod( FIID, Amount, DateBeg, DateEnd, "", null, @CouponCount, ExcludeDate, CalcByDates );
end;

PRIVATE MACRO GetPartialSumByPeriod( FIID, Amount, DateBeg, DateEnd, CouponCount:@INTEGER, ExcludeDate, CalcByDates )
  return TS_GetCouponSumByPeriod( FIID, Amount, DateBeg, DateEnd, "X", null, @CouponCount, ExcludeDate, CalcByDates );
end;

PRIVATE class TItogSUM

   var i:integer = 0;
   var sum = TArray();
   var ccy = TArray();
   var add_stat = false;
   var c_sum:string = "";
   var c_ccy:string = "";

   macro add(ccy_val, ccy_sum)
      i = 0;
      add_stat = false;
      while(ccy[i] != NULL)

         if(ccy[i] == ccy_val)
            sum[i] = sum[i] + ccy_sum;
            add_stat = true;
         end;

         i = i + 1;
      end;

      if(add_stat == false)
         ccy[i] = ccy_val;
         sum[i] = ccy_sum;
      end;
   end;

   macro clear()
      i = 0;
      while( (ccy[i] != NULL) OR (sum[i] != NULL) )
         ccy[i] = NULL;
         sum[i] = NULL;
         i = i + 1;
      end;
   end;

   macro print_cur_sum()
      i = 0;
      c_sum = "";
      c_ccy = "";
      while(sum[i] != NULL)
         if(c_sum == "")
            c_sum = sum[i] + " " + ccy[i];
         else
            c_sum = c_sum + "\n" + sum[i] + " " + ccy[i];
         end;

         i = i + 1;
      end;
      return c_sum;
   end;

   macro print_cur_ccy()
      i = 0;
      c_sum = "";
      c_ccy = "";
      while(ccy[i] != NULL)
         if(c_ccy == "")
            c_ccy = ccy[i];
         else
            c_ccy = c_ccy + "\n" + ccy[i];
         end;

         i = i + 1;
      end;
      return c_ccy;
   end;
end;

PRIVATE CLASS (DL_CReportTemplate) TS_Portf_Report

  var App = "";

  var m_FormRV_IsApp,
      m_FormRV_IsClientOFBU,
      m_FormRV_ClientNum,
      m_FormRV_Contract,
      m_FormRV_AvrKind;

  var FlagPrnFullTbl:bool = false;
  var FlagPrnOrder:bool = false;

  var sqlQuery3:string = "";
  var Data3;
  var AvrKindName:string = "";
  var ClientName:string = "";
  var CurCCY  = "";

  var  ItogAmount     = 0,
       ItogBuyCost    = 0,
       ItogMarketCost = 0,
       ItogBalCost    = 0,
       ItogOvervalSum = 0,
       ItogOvervalSumPeriod = 0,
       ItogNKDDate    = 0,
       ItogNKDCalc    = 0,
       ItogNKD2Date   = 0,
       ItogNKD2Period = 0;

  var  ItogH3BuyCost:TItogSUM,
       ItogH3MarketCost:TItogSUM,
       ItogH3BalCost:TItogSUM,
       ItogH3OvervalSum:TItogSUM,
       ItogH3OvervalSumPeriod:TItogSUM,
       ItogH3NKDDate:TItogSUM,
       ItogH3NKDCalc:TItogSUM,
       ItogH3NKD2Date:TItogSUM,
       ItogH3NKD2Period:TItogSUM;

  PRIVATE MACRO èÆ´„Á®‚Ïà¨Ôë„°Í•™‚†(ID)
     FILE party(party);
     ClearRecord(party);
     party.PartyID = ID;
     if(not getEQ(party))
        return "";
     end;
     return party.Name;
  end;

  PRIVATE MACRO PrintMode():INTEGER
     return m_Form.GetFieldValue( PNFLD_PORTFREP_PRINTMETHOD );
  END;

  PRIVATE MACRO Register_Table(OrderID:integer)

     var Order_str = "";
     var Select4, Data4;

     if(FlagPrnOrder == true)
        FlagPrnOrder = false;

        Select4 = RSDCommand( " select t_Number, t_DateBegin " +
                              "   from dsfcontr_dbt where t_id = ? " +
                              "    and t_servkind = ? " );

        Select4.addParam("id",       RSDBP_IN, OrderID);
        Select4.addParam("servkind", RSDBP_IN, PTSK_TRUST);
        Select4.execute();

        Data4 = TRsbDataSet(Select4);

        if( NOT Data4.MoveNext() )
           MsgBox("ÑÆ£Æ¢Æ‡ ≠• ≠†©§•≠, id = " + string(OrderID));
        else

           if(m_FormRV_IsClientOFBU == SET_CHAR)
              Order_str = ClientName + ", éîÅì ¸ " + string(Data4.Number) + " Æ‚ " + string(Date(Data4.DateBegin));
           else
              Order_str = ClientName + ", ÑÆ£Æ¢Æ‡ ¸ " + string(Data4.Number) + " Æ‚ " + string(Date(Data4.DateBegin));
           end;

           this.PrintFormatString( ReportHeader2,
                                   "N_H_2", Order_str);

           CopyAllSheetInTotalBook( NULL, false, "N_Head2", 0 );

        end;


     end;

     this.PrintFormatString( ReportHeader3,
                             "N_H_3", "Ç®§ Ê/°: " + AvrKindName );

     CopyAllSheetInTotalBook( NULL, false, "N_Head3", 0 );

     this.RegisterTable( "N_MainTable  ", TableHeader,
               /*1  */   "N_Issuer     ",
               /*2  */   "N_AvrCode    ",
               /*3  */   "N_AvrRegNum  ",
               /*4  */   "N_AvrNomCCY  ",
               /*5  */   "N_Date       ",
               /*6  */   "N_Time       ",
               /*7  */   "N_Amount     ",
               /*8  */   "N_Portf      ",
               /*9  */   "N_BuyPrice   ",
               /*10 */   "N_BuyCost    ",
               /*12 */   "N_MarketPrice",
               /*13 */   "N_MarketCost ",
               /*15 */   "N_BalPrice   ",
               /*16 */   "N_BalCost    ",
               /*18 */   "N_OvervalSum ",
               /*18 */   "N_OvervalSumPeriod ",
               /*20 */   "N_NKDSale    ",
               /*21 */   "N_NKDPartial ",
                         "N_RetNKD     ",
               /*22 */   "N_NKDDate    ",
                         "N_NKDCalc    ",
               /*24 */   "N_NKD2Partial",
                         "N_RetNKD2    ",
               /*25 */   "N_NKD2Date   ",
                         "N_NKD2Period " );

  END;

  PRIVATE MACRO PrintItogAvr(CurFICODE)

     this.PrintTableLine(
                 /*1  */ "N_Issuer",       "à‚Æ£Æ ØÆ " + CurFICODE, null,
                 /*2  */ "N_AvrCode",      "",             null,
                 /*3  */ "N_AvrRegNum",    "",             null,
                 /*4  */ "N_AvrNomCCY",    "",             null,
                 /*5  */ "N_Date",         "",             null,
                 /*6  */ "N_Time",         "",             null,
                 /*7  */ "N_Amount"        + App,  ItogAmount,        null,
                 /*8  */ "N_Portf",        "",             null,
                 /*9  */ "N_BuyPrice",     "",             null,
                 /*10 */ "N_BuyCost"       + App,      ItogBuyCost,   null,
                 /*12 */ "N_MarketPrice",  "",             null,
                 /*13 */ "N_MarketCost"    + App,   IIF(ItogMarketCost  != $0, ItogMarketCost,   ""), null,
                 /*15 */ "N_BalPrice",     "",             null,
                 /*16 */ "N_BalCost"       + App,   ItogBalCost,      null,
                 /*18 */ "N_OvervalSum"    + App,   ItogOvervalSum,   null,
                 /*18 */ "N_OvervalSumPeriod"    + App,   ItogOvervalSumPeriod,   null,
                 /*20 */ "N_NKDSale",      "",             null,
                 /*21 */ "N_NKDPartial",   "",             null,
                         "N_RetNKD",       "",             null,
                 /*22 */ "N_NKDDate"       + App,   ItogNKDDate,      null,
                 /*22 */ "N_NKDCalc"       + App,   ItogNKDCalc,      null,
                 /*24 */ "N_NKD2Partial",  "",             null,
                         "N_RetNKD2",      "",             null,
                 /*25 */ "N_NKD2Date   "   + App,   ItogNKD2Date,     null,
                         "N_NKD2Period"    + App,   ItogNKD2Period,   null );

     ItogH3BuyCost.add(CurCCY,    ItogBuyCost);
     ItogH3MarketCost.add(CurCCY, ItogMarketCost);
     ItogH3BalCost.add(CurCCY,    ItogBalCost);
     ItogH3OvervalSum.add(CurCCY, ItogOvervalSum);
     ItogH3OvervalSumPeriod.add(CurCCY, ItogOvervalSumPeriod);
     ItogH3NKDDate.add(CurCCY,    ItogNKDDate);
     ItogH3NKDCalc.add(CurCCY,    ItogNKDCalc);
     ItogH3NKD2Date.add(CurCCY,   ItogNKD2Date);
     ItogH3NKD2Period.add(CurCCY, ItogNKD2Period);

     ItogAmount     = 0;
     ItogBuyCost    = 0;
     ItogMarketCost = 0;
     ItogBalCost    = 0;
     ItogOvervalSum = 0;
     ItogOvervalSumPeriod = 0;
     ItogNKDDate    = 0;
     ItogNKDCalc    = 0;
     ItogNKD2Date   = 0;
     ItogNKD2Period = 0;

  END;

  PRIVATE MACRO PrintH3Avr()

     this.PrintFormatString( ReportItogH3,
                          "N_ItogH3AvrCode",   "Ç·•£Æ ØÆ " + AvrKindName,
                          "N_ItogH3BuyCost"    + App, ItogH3BuyCost.print_cur_sum(),
                          "N_ItogH3MarketCost" + App, ItogH3MarketCost.print_cur_sum(),
                          "N_ItogH3BalCost"    + App, ItogH3BalCost.print_cur_sum(),
                          "N_ItogH3OvervalSum" + App, ItogH3OvervalSum.print_cur_sum(),
                          "N_ItogH3OvervalSumPeriod" + App, ItogH3OvervalSumPeriod.print_cur_sum(),
                          "N_ItogH3NKDDate"    + App, ItogH3NKDDate.print_cur_sum(),
                          "N_ItogH3NKDCalc"    + App, ItogH3NKDCalc.print_cur_sum(),
                          "N_ItogH3NKD2Date"   + App, ItogH3NKD2Date.print_cur_sum(),
                          "N_ItogH3NKD2Period" + App, ItogH3NKD2Period.print_cur_sum() );

     CopyAllSheetInTotalBook( NULL, false, "N_ItogH3AvrTable", 0 );

     ItogH3BuyCost.clear();
     ItogH3MarketCost.clear();
     ItogH3BalCost.clear();
     ItogH3OvervalSum.clear();
     ItogH3OvervalSumPeriod.clear();
     ItogH3NKDDate.clear();
     ItogH3NKDCalc.clear();
     ItogH3NKD2Date.clear();
     ItogH3NKD2Period.clear();

  END;


  PRIVATE MACRO BeginReport()

     m_FormRV_IsApp        = m_Form.GetFieldValue( PNFLD_PORTFREP_PRINTMETHOD );
     m_FormRV_IsClientOFBU = m_Form.GetFieldValue( PNFLD_PORTFREP_IS_CLIENT_OFBU );
     m_FormRV_ClientNum    = m_Form.GetFieldValue( PNFLD_PORTFREP_CLIENT_OFBU );
     m_FormRV_Contract     = m_Form.GetFieldValue( PNFLD_PORTFREP_CONTRACT_OFBU );
     m_FormRV_AvrKind      = m_Form.GetFieldValue( PNFLD_PORTFREP_AVR_KIND );

     if( m_FormRV_IsApp )
        App = ":a";
     end;

     CreateTotalBook();

     this.SetActiveSheet( "é‚Á•‚" );

     this.PrintFormatString( ReportHeader1,
                             "N_H_0", "ëÆ·‚†¢ ØÆ‡‚‰•´Ô Ê/° ¢ Ñì " + èÆ´„Á®‚Ïà¨Ôë„°Í•™‚†({OurBank}),
                             "N_H_1", "é‚Á•‚≠†Ô §†‚† " + string(FormData.MaxDate) );

     CopyAllSheetInTotalBook( NULL, false, "N_Head1", 0 );

  END;

  PRIVATE MACRO EndReport()

     this.AddStandardFooter( "N_" );

     CopyAllSheetInTotalBook( NULL, false, "N_Footer", 0 );

     SaveTotalBook();

  END;

  PRIVATE MACRO GetValueLLCode( List:INTEGER, ElementOrCode:VARIANT ):string
    var ll = TRecHandler("llvalues.dbt");

    LL_FindLLVALUES( List, ElementOrCode, ll );

    return ll.rec.Code;
  END;

  PRIVATE MACRO é‚Á•‚èÆÑÆ£Æ¢Æ‡„àÇ®§„ñÅ(OrderID:integer, AvrKind:integer)

     record wsum(pmwrtsum);
     record wsum_old(pmwrtsum);
     var CurFIID = 0;
     var CurFICODE = 0;
     var CurMPrice  = $0;
     var CurOverval:string = "";
     var NKD = "";

     sqlQuery3 =      " SELECT wrt.t_SumID, wrt.t_DATE, wrt.t_TIME, fin.t_FIID, fin.t_FaceValueFI, fin.t_issuer, fin.t_fi_code, party.t_name, " +
                         "          avr.t_lsin, fin_nom.t_ccy, wrt.t_BalanceCost, wrt.t_Amount, leg.t_NKD, leg.t_Principal " +
                         "     FROM dpmwrtsum_dbt wrt, " +
                         "          dfininstr_dbt fin, " +
                         "          dfininstr_dbt fin_nom, " +
                         "          dparty_dbt party, " +
                         "          ddl_leg_dbt leg, " +
                         "          davoiriss_dbt avr " +
                         "    WHERE wrt.t_buy_sale  = " + PM_WRITEOFF_SUM_BUY +
                         "      AND wrt.t_trust     = 'X' " +
                         "      AND wrt.T_Contract  = " + OrderID +
                         "      AND fin.t_fiid      = wrt.t_fiid " +
                         "      AND fin.T_FI_KIND   = " + string( FIKIND_AVOIRISS ) +
                         "      AND RSB_FIInstr.FI_AvrKindsGetRoot(fin.T_FI_KIND,fin.t_AvoirKind) = " + string( AvrKind ) +
                         "      AND avr.t_fiid      = fin.t_fiid " +
                         "      AND fin_nom.t_fiid  = fin.t_facevaluefi " +
                         "      AND leg.t_dealid    = wrt.t_dealid " +
                         "      AND party.t_partyid = fin.t_issuer " +
                         " ORDER BY fin.t_issuer, fin.t_fi_code ";

     Data3 = TRsbDataSet( sqlQuery3 );

     if( SQL_GetNRecs( sqlQuery3 ) > 0 )

        CurFIID = Data3.FIID;
        CurFICODE = Data3.fi_code;

        while( Data3.MoveNext() )
           if(( WRTGetRestoreLotOnDate(Data3.SumID, FormData.MaxDate+1, wsum ) == false ) or
              ( WRTGetRestoreLotOnDate(Data3.SumID, FormData.MinDate, wsum_old ) == false ) 
             )
              MsgBox("ãÆ‚ ≠• ≠†©§•≠, SumID = " + string(Data3.SumID));
           else

              if( (wsum.State ==  PM_WRTSUM_FORM) AND (wsum.amount > 0) )

                 if(FlagPrnFullTbl == false)
                    FlagPrnFullTbl = true;
                    Register_Table(OrderID);
                    CurFIID = Data3.FIID;
                    CurFICODE = Data3.fi_code;
                 end;

                 if(CurFIID != Data3.FIID)
                    PrintItogAvr(CurFICODE);
                 end;

                 CurCCY = Data3.CCY;

                 if( ConvSum(CurMPrice, $1, FormData.MaxDate, Data3.FIID, Data3.FaceValueFI, SP_RATETYPE_TSS_DU_reqcom) )
                    MsgBox( "Ñ´Ô Ê•≠≠Æ© °„¨†£® · ID = " + string(Data3.FIID)
                            + " ≠• „§†´Æ·Ï ØÆ´„Á®‚Ï ™„‡· ¢®§† íëë §´Ô Ñì ≠† " + string( FormData.MaxDate) );
                 end;

                 if( Data3.Principal > 0. )
                    NKD = Data3.NKD / Data3.Principal * wsum.Amount;
                 end;

                 this.PrintTableLine(
                           /*1  */ "N_Issuer",               Data3.name,                                        null,
                           /*2  */ "N_AvrCode",              Data3.fi_code,                                     null,
                           /*3  */ "N_AvrRegNum",            Data3.lsin,                                        null,
                           /*4  */ "N_AvrNomCCY",            Data3.CCY,                                         null,
                           /*5  */ "N_Date",                 Date(Data3.Date),                                  null,
                           /*6  */ "N_Time",                 Time(Data3.Time),                                  null,
                           /*7  */ "N_Amount"       + App,   wsum.Amount,                                       null,
                           /*8  */ "N_Portf",                GetValueLLCode(OBJTYPE_KINDPORT, wsum.Portfolio),  null,
                           /*9  */ "N_BuyPrice"     + App,   wsum.Cost / wsum.Amount,                           null,
                           /*10 */ "N_BuyCost"      + App,   wsum.Cost,                                         null,
                           /*12 */ "N_MarketPrice"  + App,   IIF(CurMPrice  != $0, CurMPrice,   ""),            null,
                           /*13 */ "N_MarketCost"   + App,   IIF(CurMPrice  != $0, CurMPrice * wsum.Amount,""), null,
                           /*15 */ "N_BalPrice"     + App,   wsum.BalanceCost / wsum.Amount,                    null,
                           /*16 */ "N_BalCost"      + App,   wsum.BalanceCost,                                  null,
                           /*18 */ "N_OvervalSum"   + App,   wsum.OverAmount,                                        null,
                           /*18 */ "N_OvervalSumPeriod" + App,   (wsum.OverAmount - wsum_old.OverAmount),                                        null,
                           /*20 */ "N_NKDSale"      + App,   NKD,         null,
                           /*21 */ "N_NKDPartial"   + App,   GetCouponSumByPeriod(Data3.FIID, Data3.Amount, Data3.Date, FormData.MaxDate),   null,
                                   "N_RetNKD     "  + App,   GetCouponSumByPeriod(Data3.FIID, Data3.Amount, Data3.Date, FormData.MaxDate)-
                                                             GetCouponSumByPeriod(Data3.FIID, Data3.Amount, Data3.Date, FormData.MinDate),                                   null,
                           /*22 */ "N_NKDDate"      + App,   wsum.InterestIncome,             null,
                           /*22 */ "N_NKDCalc"      + App,   (wsum.InterestIncome-wsum_old.InterestIncome),             null,
                           /*24 */ "N_NKD2Partial",          GetPartialSumByPeriod(Data3.FIID, Data3.Amount, Data3.Date, FormData.MaxDate),   null,
                                   "N_RetNKD2"      + App,   GetPartialSumByPeriod(Data3.FIID, Data3.Amount, Data3.Date, FormData.MaxDate)-
                                                             GetPartialSumByPeriod(Data3.FIID, Data3.Amount, Data3.Date, FormData.MinDate),                                       null,
                           /*25 */ "N_NKD2Date   ",          wsum.DiscountIncome,                               null,
                                   "N_NKD2Period"   + App,   (wsum.DiscountIncome-wsum_old.DiscountIncome),     null );

                 ItogAmount     = ItogAmount     + wsum.Amount;
                 ItogBuyCost    = ItogBuyCost    + wsum.Cost;
                 ItogMarketCost = ItogMarketCost + (CurMPrice * wsum.Amount);
                 ItogBalCost    = ItogBalCost    + wsum.BalanceCost;
                 ItogOvervalSum = ItogOvervalSum + wsum.OverAmount;
                 ItogOvervalSumPeriod = ItogOvervalSumPeriod + (wsum.OverAmount - wsum_old.OverAmount);
                 ItogNKDDate    = ItogNKDDate    + wsum.InterestIncome;
                 ItogNKDCalc    = ItogNKDCalc    + (wsum.InterestIncome-wsum_old.InterestIncome);
                 ItogNKD2Date   = ItogNKD2Date   + wsum.DiscountIncome;
                 ItogNKD2Period = ItogNKD2Period + (wsum.DiscountIncome-wsum_old.DiscountIncome);

                 CurFIID = Data3.FIID;
                 CurFICODE = Data3.fi_code;

              end;

           end;

        end;

        if(FlagPrnFullTbl == true)
           FlagPrnFullTbl = false;

           PrintItogAvr(CurFICODE);
           this.EndTable();
           CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
           PrintH3Avr();

        end;

     end;

  END;

  PRIVATE MACRO é‚Á•‚èÆÑÆ£Æ¢Æ‡„(OrderID:integer)

     var sqlQuery2;
     var Data2;

     FlagPrnOrder = true;

     if(m_FormRV_AvrKind != UNDF)
        AvrKindName = FormData.AvrType;
        é‚Á•‚èÆÑÆ£Æ¢Æ‡„àÇ®§„ñÅ(OrderID, m_FormRV_AvrKind );
     else
        sqlQuery2 = RSDCommand( " SELECT T_AVOIRKIND, T_NAME FROM Davrkinds_DBT WHERE T_FI_KIND = ? " );

        sqlQuery2.addParam("servkind", RSDBP_IN, FIKIND_AVOIRISS);
        sqlQuery2.execute();
        Data2 = TRsbDataSet(sqlQuery2, RSDVAL_CLIENT, RSDVAL_STATIC );

        while( Data2.MoveNext() )
           AvrKindName = Data2.NAME;
           é‚Á•‚èÆÑÆ£Æ¢Æ‡„àÇ®§„ñÅ(OrderID, Data2.AVOIRKIND);
        end;

     end;

  END;

  PRIVATE MACRO é‚Á•‚èÆä´®•≠‚„(ClientID)

     var sqlQuery1;
     var Data1;
     var IsNotEof1;
     var Num1 = 0;

     ClientName = èÆ´„Á®‚Ïà¨Ôë„°Í•™‚†(ClientID);

     if(m_FormRV_Contract != UNDF)
        é‚Á•‚èÆÑÆ£Æ¢Æ‡„(m_FormRV_Contract);
     else
        sqlQuery1 = RSDCommand( " select t_id from dsfcontr_dbt where t_servkind = ? and t_PartyID = ? " );

        sqlQuery1.addParam("", RSDBP_IN, PTSK_TRUST);
        sqlQuery1.addParam("", RSDBP_IN, ClientID);
        sqlQuery1.execute();
        Data1 = TRsbDataSet(sqlQuery1, RSDVAL_CLIENT, RSDVAL_STATIC );
        Data1.MoveLast();

        IsNotEof1 = Data1.MoveFirst();

        InitProgress( Data1.GetRecCount(), HTML_StSheetName, "è‡Æ·¨Æ‚‡ §Æ£Æ¢Æ‡Æ¢" );

        while( IsNotEof1 )
           é‚Á•‚èÆÑÆ£Æ¢Æ‡„(Data1.id);
           UseProgress( Num1 = Num1 + 1 );
           IsNotEof1 = Data1.MoveNext();
        end;

        RemProgress();
     end;

  END;

  PRIVATE MACRO Create()

     var Num0 = 0;
     var Query, SqlQuery, Client;

     if( FormData.MaxDate > {curdate} )
        MsgBox("Ñ†‚† Æ‚Á•‚† °Æ´ÏË• ‚•™„È•©");
     else
        if( m_FormRV_ClientNum != -1 )
           if(m_FormRV_ClientNum != {OurBank})  /*≠†Ë °†≠™ ≠• ¨Æ¶•‚ °Î‚Ï ™´®•≠‚Æ¨ „ ·†¨Æ£Æ ·•°Ô*/
              InitProgress( 1, "è‡Æ·¨Æ‚‡ ™´®•≠‚Æ¢", "è‡Æ·¨Æ‚‡ ™´®•≠‚Æ¢" );
              é‚Á•‚èÆä´®•≠‚„( m_FormRV_ClientNum );
              UseProgress(1);
              RemProgress;
           end;
        else
           Query = "select t_PartyID " +                                           
                   "  from dclient_dbt " +                                         
                   " where t_ServiceKind = " + string(PTSK_TRUST) +
                   "   and t_PartyID != " + string({OurBank}) +
                   "   and t_Department = " +string({OperDprt})+                   
                   "   and t_Branch = 0";                                          
           SqlQuery = RSDCommand(Query);                                           
           SqlQuery.execute();                                                     
           Client = TRsbDataSet(SqlQuery);                                      

           InitProgress( SQL_GetNRecs(Query), HTML_StSheetName, "è‡Æ·¨Æ‚‡ ™´®•≠‚Æ¢" );                  

           while( Client.MoveNext() )
              é‚Á•‚èÆä´®•≠‚„( Client.PartyID );
              UseProgress(Num0 = Num0 + 1);
           end;
           RemProgress;
        end;
     end;

  END;

  initDL_CReportTemplate( TS_PortfRep_Panel(), "Report_PortfRep.xls" );
END;

TS_Portf_Report().Run();
Exit(1);
