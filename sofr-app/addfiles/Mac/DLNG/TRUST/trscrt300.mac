/* IAL XX.11.2008                                        */
/*                                                       */   
/* ДУ (Доверительное управление )                        */
/*                                                       */
/* Операция Погашения ДУ                                 */
/*                                                       */

import InsCarryDoc, "tssec.mac", "tsutil.mac", "tstrans.mac", "tssccar.mac";

macro ExecuteStep( Doc, FDoc, DocKind, OperationID )

  record deal(dl_tick);
  var    FD, dat, Dk, Dp;
  VAR Payment;

  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), dat );
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( ВыполнитьСписаниПриПогашении( FD, dat, FDoc ) )
     return 1;
  end;

  Payment = RsbPayment( FD.pm_money.rec.PaymentID );
  if( ( IsBROKER(FD.Group) ) OR (FD.tick.rec.Flag1 == SET_CHAR) )
     if( ИсполнитьПлатеж( Payment, (РАБОТА_С_РАСЧЕТНЫМ_БАНКОМ() == true) ) )
        return 1;
     end;
     if( TS_ExecuteDemandSEC( OperationID, TS_DemandUserMarkSEC_ByPaym(FD.pm_money, TS_DEMAND_ROLE_REQUEST), dat ) == false )
        return 1;
     end;
  end;

  if( ВыполнитьНатуральныйУчетЦенныхБумаг( FD, Doc, dat ) != 0 )
     return false;
  end; 

  /* Внутренний учет */
  if( not ПроводкаПоКатегориямВнутреннегоУчета( 55, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.pm_avoir.rec.BaseFIID,  
                                                FD.pm_avoir.rec.Amount
                                              ) )
      return 1;
  end;

  if( TS_ExecuteDemandSEC( OperationID, TS_DemandUserMarkSEC_ByPaym(FD.pm_avoir, TS_DEMAND_ROLE_OBLIGATION), dat ) == false )
     return 1;
  end;

  return 0;
end;

