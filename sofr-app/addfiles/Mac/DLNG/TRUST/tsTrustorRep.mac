
 /*
 $Name: tsTrustorRep.mac
 $Module: <module>
 $Description: Отчет учредителю ДУ 
 */
/*******************************************************************************
 DESCRIPTION  :   Отчет учредителю ДУ 
 PROGRAMMED BY:   Иванов А.И.
 CREATION DATE:   IAL 11 June 2009
*******************************************************************************/
IMPORT "tsTrustorRep_Form.mac", "DLReport_h.mac", PtInter, VSInter, "dlreport.mac", "cb_sql.mac", "oralib", "tssec.mac", "tsrepsign.mac";

PRIVATE CONST PTSK_TRUST = 17; //доверительное управление

PRIVATE CONST PTSKS_TRUST_OFBU   = 1; //ДОГОВОР ОФБУ
PRIVATE CONST PTSKS_TRUST_DPOFBU = 2; //Договор присоединения
PRIVATE CONST PTSKS_TRUST_IDDU   = 3; //ДОГОВОР ИДДУ

PRIVATE CONST NUM_SHEET_CLREP       = 1,
              NUM_SHEET_CALCRATE    = 2,
              NUM_SHEET_VAPORTF     = 3,
              NUM_SHEET_SHAREPORTF  = 4,
              NUM_SHEET_BONDPORTF   = 5,
              NUM_SHEET_VADEAL      = 6,
              NUM_SHEET_SECURDEAL   = 7,
              NUM_SHEET_CLREP_DOFBU = 8,
              NUM_SHEET_CLREP_POFBU = 9;

PRIVATE CONST VALUE_VA       = 1,
              VALUE_SHARE    = 3,
              VALUE_BOND     = 4,
              VALUE_KBP60    = 60,
              VALUE_KBP63    = 63,
              VALUE_KBP69    = 69,
              VALUE_KBP70    = 70,
              VALUE_TRUSTOR  = 73,
              VALUE_63       = -1;

PRIVATE CONST SIDE_DEB    = 1,
              SIDE_KRED   = 2;

PRIVATE CONST KINDREP_CL     = 1,
              KINDREP_CLRATE = 2;

PRIVATE VAR ExistPrintFirstSheet = false,
            ExistPrintVAPortf    = false,
            ExistPrintSharePortf = false,
            ExistPrintBondPortf  = false,
            ExistPrintVADeal     = false,
            ExistPrintSecurDeal  = false;

PRIVATE VAR ReportHeader = "";
PRIVATE VAR TableHeader  = "";
/*Класс для массива сумм в разных валютах*/
private class TArraySum
  var i:integer = 0;
  var sum = TArray();
  var ccy = TArray();
  var add_stat = false;

  macro Add(FIID, Summ)
     i = 0;
     add_stat = false;
     while( ccy[i] != NULL )
       if( ccy[i] == FIID )
          sum[i] = sum[i] + Summ;
          add_stat = true;
       end;
        i = i + 1;
     end;
     if( add_stat == false )
        ccy[i] = FIID;
        sum[i] = Summ;
     end;

     return Summ;
  end;

  macro Clear()
     i = 0;
     while( (ccy[i] != NULL) OR (sum[i] != NULL) )
        ccy[i] = NULL;
        sum[i] = NULL;
        i = i + 1;
     end;
  end;

  macro SetFirst()
     i = -1;
  end;

  macro Next()
     i= i + 1;
     if( ccy[i] != NULL )
        return true;
     end;
     return false;
  end;

  macro GetSum()
     if( sum[i] != NULL )
        return sum[i];
     end;
     return 0;
  end;

  macro GetCCy()
     if( ccy[i] != NULL )
        return ccy[i];
     end;
     return "";
  end;
end;

PRIVATE MACRO ДСПоКатегории( TSOrderID:INTEGER, EndDate:DATE, CatCode:STRING, Param:INTEGER, Cls:INTEGER, Val:INTEGER, MarketPlaceID:INTEGER )
    VAR Query, DataSet, RestAcc = $0;
    Query = RSDCommand( "SELECT distinct accdoc.t_account, ( rsb_account.restall (accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) RestAcc " +
                      "  FROM dmcaccdoc_dbt accdoc, dmctempl_dbt templ, dmccateg_dbt categ  " +
                      " WHERE categ.t_LevelType = 1 " +
                      "       AND categ.t_Code = ? " +
                      "       AND accdoc.t_CatID   = categ.t_ID " +
                      "       AND accdoc.t_ClientContrID = ? " +
                      "       AND accdoc.t_Currency = " + string(NATCUR) +
                      TS_IIF( MarketPlaceID != null, " AND accdoc.t_MarketPlaceID = ? ", "" ) +
                      "       AND templ.t_CatID  = accdoc.t_CatID " +
                      "       AND templ.t_Number = accdoc.t_TemplNum " +
                      TS_IIF( (Param != null)AND(Cls != null)AND(Val != null),
                      "       AND (CASE WHEN (categ.t_Param1 = ? AND categ.t_class1 = ?) THEN templ.t_Value1  " +
                      "                 WHEN (categ.t_Param2 = ? AND categ.t_class2 = ?) THEN templ.t_Value2  " +
                      "                 WHEN (categ.t_Param3 = ? AND categ.t_class3 = ?) THEN templ.t_Value3  " +
                      "                 WHEN (categ.t_Param4 = ? AND categ.t_class4 = ?) THEN templ.t_Value4  " +
                      "                 WHEN (categ.t_Param5 = ? AND categ.t_class5 = ?) THEN templ.t_Value5  " +
                      "                 WHEN (categ.t_Param6 = ? AND categ.t_class6 = ?) THEN templ.t_Value6  " +
                      "                 WHEN (categ.t_Param7 = ? AND categ.t_class7 = ?) THEN templ.t_Value7  " +
                      "                 WHEN (categ.t_Param8 = ? AND categ.t_class8 = ?) THEN templ.t_Value8  " +
                      "             END) = ?","") +
                      TS_IIF( (CatCode == "ДС ДУ")AND(Param==OBJTYPE_TSACCOWNKIND)AND(Cls==LLCLASS_TSACCOWNKIND)AND(Val==41),
                      "       AND NVL((select partcode.t_Code from dpartcode_dbt partcode " +
                      "                 where partcode.t_PartyID = accdoc.t_MarketPlaceID " +
                      "                   and partcode.t_CodeKind = 1),'') = 'РП ММВБ' ", "") + 
                      TS_IIF( CatCode == "+Расчеты, ДУ", 
                      "       AND (CASE WHEN (categ.t_Param1 = 2816 AND categ.t_class1 = 1706) THEN templ.t_Value1  " +
                      "                 WHEN (categ.t_Param2 = 2816 AND categ.t_class2 = 1706) THEN templ.t_Value2  " +
                      "                 WHEN (categ.t_Param3 = 2816 AND categ.t_class3 = 1706) THEN templ.t_Value3  " +
                      "                 WHEN (categ.t_Param4 = 2816 AND categ.t_class4 = 1706) THEN templ.t_Value4  " +
                      "                 WHEN (categ.t_Param5 = 2816 AND categ.t_class5 = 1706) THEN templ.t_Value5  " +
                      "                 WHEN (categ.t_Param6 = 2816 AND categ.t_class6 = 1706) THEN templ.t_Value6  " +
                      "                 WHEN (categ.t_Param7 = 2816 AND categ.t_class7 = 1706) THEN templ.t_Value7  " +
                      "                 WHEN (categ.t_Param8 = 2816 AND categ.t_class8 = 1706) THEN templ.t_Value8  " +
                      "             END) = 0","")
                    );


    Query.addParam( "", RSDBP_IN, EndDate );
    Query.addParam( "", RSDBP_IN, CatCode );
    Query.addParam( "", RSDBP_IN, TSOrderID );
    if( MarketPlaceID != null )
       Query.addParam("", RSDBP_IN, MarketPlaceID );
    end;
    if((Param != null)AND(Cls != null)AND(Val != null))
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );
      Query.addParam("", RSDBP_IN, Param );
      Query.addParam("", RSDBP_IN, Cls );

      Query.addParam("", RSDBP_IN, Val );
    end;

    Query.execute();
    DataSet = TRSBDataSet(Query); 

    while( DataSet.MoveNext() )
       RestAcc = RestAcc + ABS(SQL_ConvTypeSum(DataSet.RestAcc));
    end;

    return RestAcc;
  END;

/********************************************************************************
Класс для шаблона "Отчет клиента ДУ"
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_ClRep( Report:OBJECT, KindRep:integer )
  VAR m_Report = Report, m_KindRep = KindRep, НачалоГода = Date(0,0,0), m_SheetName, m_IsFirstPrint = true;

  MACRO GetCellName(CellName:string)
     if( m_KindRep == KINDREP_CLRATE )
        return CellName+"_1";
     end;
     return CellName;                                   
  END;

  MACRO PrintReportHead()
    m_Report.PrintFormatString( ReportHeader,
                                GetCellName("H1_1"), "по договору № "+m_Report.m_TSOrders.rec.Number,
                                GetCellName("H1_2"), "Учредитель: "+m_Report.GetPartyName(m_Report.m_TSOrders.rec.PartyID,
                                                              (m_Report.m_TSOrders.rec.LegalForm != 2)),
                                GetCellName("H1_3"), "за период "+m_Report.ReportPeriod(false),
                                GetCellName("H1_4"), "Дата начала договора: "+Date(m_Report.m_TSOrders.rec.DateBegin)+"г."
                              );
    if( m_IsFirstPrint )
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, GetCellName("H1_Head"), 0 );
       m_IsFirstPrint = false;
    else
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, GetCellName("H1_Head"), 1 );
    end;
  END;

  MACRO PrintHeadTable_1()
    m_Report.PrintFormatString( ReportHeader,
                                GetCellName("H1_5"), m_Report.m_EndDate+1
                              );
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, GetCellName("H1_Table_1"), 1 );
  END;
  MACRO RegisterTable_1()
    m_Report.RegisterTable( GetCellName("MainTable_1_1"), TableHeader,
                            GetCellName("A1_1_0"),
                            GetCellName("A1_1_1"),
                            GetCellName("A1_1_2"),
                            GetCellName("A1_1_3"),
                            GetCellName("A1_1_4")
                           );
  END;

  MACRO PrintHeadTable_2()
    m_Report.PrintFormatString( ReportHeader,
                                GetCellName("H1_6"), m_Report.m_EndDate+1
                              );
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, GetCellName("H1_Table_2"), 1 );
  END;
  MACRO RegisterTable_2()
    m_Report.RegisterTable( GetCellName("MainTable_1_2"), TableHeader,
                            GetCellName("A1_2_1"),
                            GetCellName("A1_2_2")
                           );
  END;
 
  MACRO RegisterTable_3()

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, GetCellName("H1_Table_3"), 1 );

    if( m_KindRep == KINDREP_CL )
       m_Report.RegisterTable( "MainTable_1_3", TableHeader,
                               "A1_3_1",
                               "A1_3_2",
                               "A1_3_3"
                             );
    else
       m_Report.RegisterTable( "MainTable_1_3_1", TableHeader,
                               "A1_3_1_1",
                               "A1_3_2_1",
                               "A1_3_3_1",
                               "A1_3_4_1"
                             );
    end;
  END;
                                          
  PRIVATE MACRO СуммаПроводокПоКатегории( CatCode:string, Param:integer, Cls:integer, Val:integer, DebKred:integer, BegDate:Date, Param2:integer, Cls2:integer, ValFlagSelect:integer )/*в рублях*/
    var Query, SqlQuery, DataSet;
    var BondAddIn = ((Val == VALUE_BOND) AND (ValFlagSelect != VALUE_63) AND (CatCode=="ДоходыЭцб ДУ"));

    SqlQuery = RSDCommand("select NVL(SUM(arh.t_Sum_Payer),0) as ArhSum " +
                          "  from dacctrn_dbt arh, " +
                          "       (SELECT distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                          "          FROM dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dmctempl_dbt templ " +
                          "         WHERE accdoc.t_ClientContrID = ? " +
                          "           AND accdoc.t_CatID    = categ.t_ID " +
                          "           AND categ.t_LevelType = 1 " +
                          "           AND categ.t_Code      = ? " +
                          "           and templ.t_CatID = categ.t_ID" +
                          "           and templ.t_Number = accdoc.t_TemplNum " +
                          TS_IIF( ((Param != null) AND (Cls != null)) AND (Val != null),
                          "           and (CASE WHEN (categ.t_Param1 = ? AND categ.t_class1 = ?) THEN templ.t_Value1  " +
                          "                      WHEN (categ.t_Param2 = ? AND categ.t_class2 = ?) THEN templ.t_Value2  " +
                          "                      WHEN (categ.t_Param3 = ? AND categ.t_class3 = ?) THEN templ.t_Value3  " +
                          "                      WHEN (categ.t_Param4 = ? AND categ.t_class4 = ?) THEN templ.t_Value4  " +
                          "                      WHEN (categ.t_Param5 = ? AND categ.t_class5 = ?) THEN templ.t_Value5  " +
                          "                      WHEN (categ.t_Param6 = ? AND categ.t_class6 = ?) THEN templ.t_Value6  " +
                          "                      WHEN (categ.t_Param7 = ? AND categ.t_class7 = ?) THEN templ.t_Value7  " +
                          "                      WHEN (categ.t_Param8 = ? AND categ.t_class8 = ?) THEN templ.t_Value8  " +
                          "                 END) = ? ","")+
                          TS_IIF( (Param2 != null) AND (Cls2 != null) AND (Val != null) AND (Val != VALUE_VA),
                          "           and (CASE WHEN (categ.t_Param1 = ? AND categ.t_class1 = ?) THEN templ.t_Value1  " +
                          "                      WHEN (categ.t_Param2 = ? AND categ.t_class2 = ?) THEN templ.t_Value2  " +
                          "                      WHEN (categ.t_Param3 = ? AND categ.t_class3 = ?) THEN templ.t_Value3  " +
                          "                      WHEN (categ.t_Param4 = ? AND categ.t_class4 = ?) THEN templ.t_Value4  " +
                          "                      WHEN (categ.t_Param5 = ? AND categ.t_class5 = ?) THEN templ.t_Value5  " +
                          "                      WHEN (categ.t_Param6 = ? AND categ.t_class6 = ?) THEN templ.t_Value6  " +
                          "                      WHEN (categ.t_Param7 = ? AND categ.t_class7 = ?) THEN templ.t_Value7  " +
                          "                      WHEN (categ.t_Param8 = ? AND categ.t_class8 = ?) THEN templ.t_Value8  " +
                          "                 END) " + TS_IIF( ValFlagSelect == VALUE_63, " = ? ", 
                                                     TS_IIF(BondAddIn," in (?,?,?,?) "," in (?,?) ")),"")+
                          "       ) acc " +
                          " where arh.t_FIID_Payer = acc.t_Currency " +
                          "   and arh.t_chapter = acc.t_Chapter " +
                          "   and arh.t_State = 1 "/*фактическая проводка*/ +
                          "   and (case when ? = 1 then arh.t_account_payer else arh.t_account_receiver end) = acc.t_Account " +
                          "   and arh.t_date_carry >= ? " +
                          "   and arh.t_date_carry <= ? " + 
                          TS_IIF( (ValFlagSelect == VALUE_63),
                          "   and not exists ( SELECT distinct adoc.t_Account                    " +
                          "                      FROM dmcaccdoc_dbt adoc, dmccateg_dbt cat       " +
                          "                     WHERE /*adoc.t_ClientContrID = ?                   " +
                          "                       AND*/ adoc.t_CatID    = cat.t_ID                 " +
                          "                       AND adoc.t_Currency = arh.t_FIID_Payer      " +
                          "                       AND adoc.t_Chapter  = arh.t_chapter            " +
                          "                       AND adoc.t_Account  = (case when ? = 1 then arh.t_account_receiver else arh.t_account_payer end) " +
                          "                       AND cat.t_LevelType = 1                        " +
                          "                       AND cat.t_Code in('Прибыль ДУ', 'Убыток ДУ') ) " , "" )
                         );

    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    SqlQuery.addParam("", RSDBP_IN, CatCode);
    if((Param != null)AND(Cls != null)AND(Val != null))
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );
      SqlQuery.addParam("", RSDBP_IN, Param );
      SqlQuery.addParam("", RSDBP_IN, Cls );

      SqlQuery.addParam("", RSDBP_IN, Val );
    end;

    if( (Param2 != null) AND (Cls2 != null) AND (Val != null) AND (Val != VALUE_VA) )
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );
      SqlQuery.addParam("", RSDBP_IN, Param2 );
      SqlQuery.addParam("", RSDBP_IN, Cls2 );

      if(BondAddIn)
         SqlQuery.addParam("", RSDBP_IN, VALUE_KBP69 );
         SqlQuery.addParam("", RSDBP_IN, VALUE_KBP70 );
      end;

      if( ValFlagSelect != VALUE_63 )
         SqlQuery.addParam("", RSDBP_IN, VALUE_KBP60 );
      end;
      if( Val != VALUE_VA )
        SqlQuery.addParam("", RSDBP_IN, VALUE_KBP63 );
      end;
    end;

    SqlQuery.addParam("", RSDBP_IN, DebKred);
    SqlQuery.addParam("", RSDBP_IN, BegDate );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate );

    if(ValFlagSelect == VALUE_63)
       /*SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);*/
       SqlQuery.addParam("", RSDBP_IN, DebKred);
    end;

    SqlQuery.execute();                                       
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    if( DataSet.MoveNext() )
        return DataSet.ArhSum;
    end;

    return $0.;
  END;

  PRIVATE MACRO СуммаПоРОВУ( OperType:integer, BegDate:Date, IsDV:bool )
    var SqlQuery, DataSet;

    SqlQuery = RSDCommand(" select NVL(SUM(inacc.T_SUM),0) as DlAccSum " +
                          "   from ddlinacc_dbt inacc " +
                          "  where inacc.t_OperType = ? " +
                          "    and inacc.t_Date >= ? " +
                          "    and inacc.t_Date <= ? " +
                          "    and inacc.T_chapter = 21 " +
                          "    and (select distinct deb.t_ClientContrID from dmcaccdoc_dbt deb " +
                          "          where deb.t_account = inacc.T_DEBACC " +
                          "            and deb.t_currency = inacc.T_FIID " +
                          "            and deb.t_chapter = inacc.T_chapter) = ? " +
                          "    and (select distinct kred.t_ClientContrID from dmcaccdoc_dbt kred " +
                          "         where kred.t_account = inacc.T_KREDACC " +
                          "           and kred.t_currency = inacc.T_FIID  " +
                          "           and kred.t_chapter = inacc.T_chapter) = ? " +
                          TS_IIF(((OperType==9)OR(OperType==10)) AND (IsDV==true),
                          "    and (select count(1) from doproper_dbt oper, doprdocs_dbt oprdocs " +
                          "          where oprdocs.t_DocKind = " + string(DL_DLINACC) +
                          "            and oper.t_DocKind = " +string(DL_DVOPER_TRUST) +
                          "            and oprdocs.t_DocumentID = lpad(inacc.t_ID, 10, '0') " +
                          "            and oprdocs.t_ID_Operation = oper.t_ID_Operation) > 0"
                                ,"")                              
                         );

    SqlQuery.addParam("", RSDBP_IN, OperType);
    SqlQuery.addParam("", RSDBP_IN, BegDate );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    SqlQuery.execute();                                     
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    if( DataSet.MoveNext() )
        return DataSet.DlAccSum;
    end;

    return $0.;
  END;

  PRIVATE MACRO СуммаПоИтогам(TotalType:integer, BegDate:Date)
    var SqlQuery, DataSet;

    SqlQuery = RSDCommand(" SELECT NVL(SUM(t_RestAmount), 0) SumRestAmount " +
                          "   FROM DTSTOTAL_DBT " +
                          "  WHERE T_ORDERID    = ? " +
                          "    AND T_TOTALTYPE  = ? " +
                          "    AND T_SIGN       = 1 " +
                          "    AND T_RESTDATE  >= ? " +
                          "    AND T_RESTDATE  <= ? "
                         );

    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.TsOrderID);
    SqlQuery.addParam("", RSDBP_IN, TotalType);
    SqlQuery.addParam("", RSDBP_IN, BegDate );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate );
    SqlQuery.execute();                                     
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    if( DataSet.MoveNext() )
        return DataSet.SumRestAmount;
    end;
    return $0.;    
  END;
 
  PRIVATE MACRO ТО_ОбязКом( OrderID:integer, BegDate:date, EndDate:date )
    var sum = $0.0;
    var query, RS;

    query = RSDCommand( " SELECT demand.t_ID, demand.t_EventID, demand.t_ExecQuantity " +
                        "   FROM dtsdemand_dbt demand " +
                        "  WHERE demand.t_OrderID = ? AND " +
                        "        demand.t_State   = ? AND " +
                        "        demand.t_UserMark like 'Обяз_ком%' AND" +
                        "        (demand.t_FactCloseDate >= ? AND demand.t_FactCloseDate <= ?) "+
                        " ORDER BY t_EventID, t_ID "
                      );
    query.addParam( "", RSDBP_IN, OrderID );
    query.addParam( "", RSDBP_IN, TS_DEMAND_STATE_EXECUTE );
    query.addParam( "", RSDBP_IN, BegDate );
    query.addParam( "", RSDBP_IN, EndDate );
    query.execute();
    RS = TRSBDataSet(query);
  
    while( RS.MoveNext() )
      sum = sum + RS.ExecQuantity;
    end;

    return sum;
  END;
 
  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Report.GetTableRange(), 0 );
  END;

  MACRO BeginReport()
    if( m_KindRep == KINDREP_CL )
       m_SheetName = "Отчет клиента ДУ";
    else
       m_SheetName = "Отчет клиента ДУ с расч. нал.";
    end;
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( m_SheetName );
  END;

  PRIVATE MACRO Капитал( ReqID:integer ):string
    var SqlQuery, DataSet;
    var retStr = "";
    SqlQuery = RSDCommand(
                   "select distinct RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) RootKind, "+
                   "       fi.t_CCY, fi.t_FI_Kind "+
                   "from dtsreqassets_dbt reqasset, dfininstr_dbt fi "+
                   "where reqasset.t_RequestID = ? "+
                   "  and reqasset.t_FIID = fi.t_FIID "+
                   "order by RootKind desc" );
                      
    SqlQuery.addParam("", RSDBP_IN, ReqID);
    SqlQuery.execute();                                       
    DataSet = TRsbDataSet(SqlQuery);

    var isFirst:bool = true;
    while( DataSet.MoveNext() )
      if( ( DataSet.RootKind == FIKIND_ALLAVOIRISS ) AND ( DataSet.FI_Kind == FIKIND_CURRENCY ) )
        retStr = retStr + DataSet.CCY;
      elif ( DataSet.RootKind == AVOIRISSKIND_BILL )
        retStr = retStr + "векселя";
      else
        if( isFirst )
          retStr = retStr + TS_IIF( DataSet.RootKind == AVOIRISSKIND_SHARE, "акции", "облигации" );
        else
          retStr = retStr + ", облигации";
        end;
      end;
      isFirst = false
    end;
    return retStr;
  END;

  PRIVATE MACRO ПечатьКапиталВУправлении()
    var SqlQuery, DataSet, IsExistItogs = false;

    PrintHeadTable_1();
    RegisterTable_1();

    SqlQuery = RSDCommand(
                   " select total.t_RestDate, total.t_RestAmount, (total.t_addamount-total.t_subamount) as Itog, "+
                   "        total.t_sign, iorqst.t_FactTRansferDate, iorqst.t_ID "+
                   " from dtstotal_dbt total, dtsorder_dbt tsorder, "+
                   "      dtsiorqst_dbt iorqst "+
                   " where total.t_totaltype = ?                               "+
                   "   and total.t_orderid = tsorder.t_ID                      "+
                   "   and tsorder.t_SfContrID = ?                             "+
                   "   and iorqst.t_FactTRansferDate <= ?                      "+
                   "   and iorqst.t_ID = total.t_DocID                         "+
                   " order by total.t_restdate, total.t_id                     ");

    SqlQuery.addParam("", RSDBP_IN, ДУ_ИТОГ_СК);
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate );

    SqlQuery.execute();                                       
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    while( DataSet.MoveNext() )
       if( DataSet.sign > 0 )
          m_Report.PrintTableLine( GetCellName("A1_1_0"), Капитал(DataSet.ID), null,
                                   GetCellName("A1_1_1"), Date(DataSet.FactTRansferDate), null,
                                   GetCellName("A1_1_2"), DataSet.RestAmount, null,
                                   GetCellName("A1_1_4"), DataSet.Itog, null
                                 );
       else
          m_Report.PrintTableLine( GetCellName("A1_1_0"), Капитал(DataSet.ID), null,
                                   GetCellName("A1_1_1"), Date(DataSet.FactTRansferDate), null,
                                   GetCellName("A1_1_3"), DataSet.RestAmount, null,
                                   GetCellName("A1_1_4"), DataSet.Itog, null
                                 );
       end;
       IsExistItogs = true;
     end;

     if( not IsExistItogs )
          m_Report.PrintTableLine( GetCellName("A1_1_4"), 0.00, null);
     end;
     EndTable();
  END;

  PRIVATE MACRO ПечатьДенСредстваДебЗадолж()
    var OrderFD = TS_OrderFD(0,m_Report.m_TSOrders.rec.TsOrderID);
    var СумОстатокДСДУ = $0, ОстатокДСДУ = $0, СрочнРынок = $0., ДебЗадолж =  $0.;

    PrintHeadTable_2();
    RegisterTable_2();                 

    /* отбираются все лицевые счета категории "ДС ДУ" (балансовый счет 80801) данного договора с ненулевым остатком, 
       за исключением счетов с назначением счета 41 - "Торговый на бирже". 
       По каждому отобранному лицевому счету в таблицу выводится одна строка, содержащая наименование счета и 
       остаток денежных средств лицевого счета, на дату конца отчетного периода из формы запуска отчета + 1 день.*/
    VAR DataSet,
        Query = RSDCommand( "SELECT distinct accdoc.t_account, ( rsb_account.restall (accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) RestAcc " +
                            "  FROM dmcaccdoc_dbt accdoc, dmctempl_dbt templ, dmccateg_dbt categ  " +
                            " WHERE categ.t_LevelType = 1 " +
                            "       AND categ.t_Code = 'ДС ДУ' " +
                            "       AND accdoc.t_CatID   = categ.t_ID " +
                            "       AND accdoc.t_ClientContrID = ? " +
                            "       AND templ.t_CatID  = accdoc.t_CatID " +
                            "       AND templ.t_Number = accdoc.t_TemplNum " +
                            "       AND (CASE WHEN (categ.t_Param1 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class1 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value1  " +
                            "                 WHEN (categ.t_Param2 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class2 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value2  " +
                            "                 WHEN (categ.t_Param3 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class3 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value3  " +
                            "                 WHEN (categ.t_Param4 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class4 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value4  " +
                            "                 WHEN (categ.t_Param5 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class5 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value5  " +
                            "                 WHEN (categ.t_Param6 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class6 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value6  " +
                            "                 WHEN (categ.t_Param7 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class7 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value7  " +
                            "                 WHEN (categ.t_Param8 = "+string(OBJTYPE_TSACCOWNKIND)+" AND categ.t_class8 = "+string(LLCLASS_TSACCOWNKIND)+") THEN templ.t_Value8  " +
                            "             END) != 41" 
                          );
    Query.addParam( "", RSDBP_IN, m_Report.m_EndDate );
    Query.addParam( "", RSDBP_IN, m_Report.m_TSOrders.rec.ID );

    Query.execute();
    DataSet = TRSBDataSet( Query ); 

    while( DataSet.MoveNext() )
       ОстатокДСДУ = ABS( SQL_ConvTypeSum( DataSet.RestAcc ) );

       if( ОстатокДСДУ != 0 )
          m_Report.PrintTableLine( GetCellName("A1_2_1"), SQL_ConvTypeStr( DataSet.account ), null,
                                   GetCellName("A1_2_2"), ОстатокДСДУ, null
                                 );
          СумОстатокДСДУ = СумОстатокДСДУ + ОстатокДСДУ;
       end;
    end;

    СрочнРынок = ДСПоКатегории( m_Report.m_TSOrders.rec.ID, m_Report.m_EndDate, "+Расчеты, ДУ", OBJTYPE_TSREQKIND, LLCLASS_TSREQKIND, 72 );
    ДебЗадолж = ДСПоКатегории( m_Report.m_TSOrders.rec.ID, m_Report.m_EndDate, "+Расчеты, ДУ" ) - СрочнРынок;
                                                                                                
    m_Report.PrintTableLine( GetCellName("A1_2_1"), "Денежные средства на срочном рынке", null,
                             GetCellName("A1_2_2"), СрочнРынок, null
                           );
    m_Report.PrintTableLine( GetCellName("A1_2_1"), "Дебиторская задолженность", null,
                             GetCellName("A1_2_2"), ДебЗадолж, null
                           );
    m_Report.PrintTableLine( GetCellName("A1_2_1"), "Итого", null,
                             GetCellName("A1_2_2"), СумОстатокДСДУ+СрочнРынок+ДебЗадолж, null
                           );
    EndTable();
  END;

  PRIVATE MACRO FindNPTaxObj(Direction:integer,IfMarket:integer,TaxGroup:integer,Kind:integer)
    var SqlQuery, DataSet;

    if((Kind == NPTAX_KIND_DIVIDEND) AND 
       ((TaxGroup != NPTAX_GROUP_SHARE) AND 
        (TaxGroup != NPTAX_GROUP_BOND_USUAL)))
         return $0.;
    end;

    if((Kind == NPTAX_KIND_MAT_VIG) AND (IfMarket == 2))
       return $0.;
    end;

    SqlQuery = RSDCommand("SELECT (t1.Sum + t2.AddSum) S " +
                          "  FROM (Select NVL(SUM(T_SUM), 0) as Sum " +
                          "          FROM DNPTAXOBJ_DBT " +
                          "         WHERE T_ORDERID   = ? " +
                          "           AND T_DIRECTION = ? " +
                          "           AND T_IFMARKET  = ? " +
                          "           AND T_TAXGROUP  = ? " +
                          "           AND T_KIND      = ? " +
                          "           AND T_DATE     >= ? " +
                          "           AND T_DATE     <= ?) t1, " +
                          "       (SELECT NVL(SUM(T_SUM), 0) as AddSum " +
                          "          FROM DNPTAXOBJ_TMP " +
                          "         WHERE T_ORDERID   = ? " +
                          "           AND T_DIRECTION = ? " +
                          "           AND T_IFMARKET  = ? " +
                          "           AND T_TAXGROUP  = ? " +
                          "           AND T_KIND      = ? " +
                          "           AND T_DATE     >= ? " +
                          "           AND T_DATE     <= ? ) t2");


    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.TsOrderID);
    SqlQuery.addParam("", RSDBP_IN, Direction);
    SqlQuery.addParam("", RSDBP_IN, IfMarket );
    SqlQuery.addParam("", RSDBP_IN, TaxGroup );
    SqlQuery.addParam("", RSDBP_IN, Kind );
    SqlQuery.addParam("", RSDBP_IN, НачалоГода );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.TsOrderID);
    SqlQuery.addParam("", RSDBP_IN, Direction);
    SqlQuery.addParam("", RSDBP_IN, IfMarket );
    SqlQuery.addParam("", RSDBP_IN, TaxGroup );
    SqlQuery.addParam("", RSDBP_IN, Kind );
    SqlQuery.addParam("", RSDBP_IN, НачалоГода );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate );
    SqlQuery.execute();                                     
                                                          
    DataSet = TRsbDataSet(SqlQuery);
    
    if( DataSet.MoveNext() )
        return DataSet.S;
    end;
    return $0.;    
  END;

  PRIVATE MACRO FindNPTaxSumByGroup(IfMarket:integer,TaxGroup:integer)
    var Sum = FindNPTaxObj(1, IfMarket, TaxGroup, NPTAX_KIND_REALIZ) -  FindNPTaxObj(2, IfMarket, TaxGroup, NPTAX_KIND_REALIZ);
    if( Sum < $0. )
      Sum = $0.;
    end;

    Sum = Sum + FindNPTaxObj(1, IfMarket, TaxGroup, NPTAX_KIND_MAT_VIG) +
                FindNPTaxObj(1, IfMarket, TaxGroup, NPTAX_KIND_DIVIDEND) +
                FindNPTaxObj(1, IfMarket, TaxGroup, NPTAX_KIND_COUPON) +
                FindNPTaxObj(1, IfMarket, TaxGroup, NPTAX_KIND_OTHR_INC) - FindNPTaxObj(2, IfMarket, TaxGroup, NPTAX_KIND_OTHR_CHRG);
    if(  Sum < $0. )
       return $0.;
    end;

    return Sum;
  END;

  PRIVATE MACRO ПолучитьНОБ(ShareNOB:@money,BondNOB:@money,VaNOB:@money)
    ShareNOB = FindNPTaxSumByGroup(1,NPTAX_GROUP_SHARE) + FindNPTaxSumByGroup(2,NPTAX_GROUP_SHARE);
    BondNOB = FindNPTaxSumByGroup(1,NPTAX_GROUP_BOND_USUAL) + FindNPTaxSumByGroup(2,NPTAX_GROUP_BOND_USUAL) +
              FindNPTaxSumByGroup(1,NPTAX_GROUP_BOND_IP) + FindNPTaxSumByGroup(2,NPTAX_GROUP_BOND_IP) +
              FindNPTaxSumByGroup(1,NPTAX_GROUP_BOND_PRIV) + FindNPTaxSumByGroup(2,NPTAX_GROUP_BOND_PRIV) +
              FindNPTaxSumByGroup(1,NPTAX_GROUP_BOND_PRIV_RET) + FindNPTaxSumByGroup(2,NPTAX_GROUP_BOND_PRIV_RET);

    VaNOB =  FindNPTaxSumByGroup(2,NPTAX_GROUP_VEKS);
  ENd;

  PRIVATE MACRO ПрибыльСНачДоговора()
     var RetVal:money = $0.0, Н_Дх:money = $0.0, Н_Налог:money = $0.0;
     var OrderFD:TS_OrderFD = TS_OrderFD(0, m_Report.m_TSOrders.rec.TsOrderID);
     var ProlongDate:date = TS_GetLastProlongDate(OrderFD.ID, m_Report.m_EndDate);

     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Н_Дх, NULL, NULL ) )
        Н_Дх = $0.0;
     end;
     if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Н_Налог, NULL, NULL ) )
        Н_Налог = $0.0;
     end;

     RetVal = OrderFD.СуммаПрибылиУчредителя(m_Report.m_EndDate) + Н_Дх + Н_Налог;

     if(ProlongDate != date(0,0,0))
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, ProlongDate, @Н_Дх, NULL, NULL ) )
           Н_Дх = $0.0;
        end;
        if( ПолучитьИтогДУ( OrderFD.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, ProlongDate, @Н_Налог, NULL, NULL ) )
           Н_Налог = $0.0;
        end;

        RetVal = RetVal - (OrderFD.СуммаПрибылиУчредителя(ProlongDate) + Н_Дх + Н_Налог);
     end;

     return RetVal;
  END;

  MACRO PrintLineTable3(A1:string,A2:variant,A3:variant,A4:Variant)
     if( m_KindRep == KINDREP_CL )
        m_Report.PrintTableLine( "A1_3_1", A1, null,
                                 "A1_3_2", A2, null,
                                 "A1_3_3", A3, null
                               );
     else
        m_Report.PrintTableLine( "A1_3_1_1", A1, null,
                                 "A1_3_2_1", A2, null,
                                 "A1_3_3_1", A3, null,
                                 "A1_3_4_1", A4, null
                               );
     end;
  END;

  var ДоходРасходАкцЗаПериод = 0, ДоходРасходОблЗаПериод = 0, ДоходРасходВексЗаПериод = 0,
      ДоходРасходАкцСначГода = 0, ДоходРасходОблСначГода = 0, ДоходРасходВексСначГода = 0;

  PRIVATE MACRO РасчитатьДоходРасход()
/* Доход */
     var ДоходРасходАкцЗаПериодКред = СуммаПроводокПоКатегории("ДоходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_KRED, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_SHARE ) +
                                      СуммаПроводокПоКатегории("РасходыЭцб ДУ",OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_KRED, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_63 ),
         ДоходРасходОблЗаПериодКред = СуммаПроводокПоКатегории("ДоходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_KRED, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_BOND ) +
                                      СуммаПроводокПоКатегории("РасходыЭцб ДУ",OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_KRED, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_63 ),
         ДоходРасходВексЗаПериодКред = СуммаПроводокПоКатегории("Доходы ДУ",   OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_VA,    SIDE_KRED, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_VA ),

         ДоходРасходАкцСначГодаКред = СуммаПроводокПоКатегории("ДоходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_KRED, НачалоГода,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_SHARE ) + 
                                      СуммаПроводокПоКатегории("РасходыЭцб ДУ",OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_KRED, НачалоГода,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_63 ),
         ДоходРасходОблСначГодаКред = СуммаПроводокПоКатегории("ДоходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_KRED, НачалоГода,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_BOND ) +
                                      СуммаПроводокПоКатегории("РасходыЭцб ДУ",OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_KRED, НачалоГода,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_63 ),
         ДоходРасходВексСначГодаКред = СуммаПроводокПоКатегории("Доходы ДУ",   OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_VA,    SIDE_KRED, НачалоГода,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_VA );

/* Расход */
     var ДоходРасходАкцЗаПериодДеб = СуммаПроводокПоКатегории("РасходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_DEB, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_SHARE ) + 
                                     СуммаПроводокПоКатегории("ДоходыЭцб ДУ",  OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_DEB, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_63 ),
         ДоходРасходОблЗаПериодДеб = СуммаПроводокПоКатегории("РасходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_DEB, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_BOND ) +
                                     СуммаПроводокПоКатегории("ДоходыЭцб ДУ",  OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_DEB, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_63 ),
         ДоходРасходВексЗаПериодДеб = СуммаПроводокПоКатегории("Расходы ДУ",   OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_VA,    SIDE_DEB, m_Report.m_BeginDate,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_VA ),

         ДоходРасходАкцСначГодаДеб = СуммаПроводокПоКатегории("РасходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_DEB,НачалоГода,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_SHARE ) +
                                     СуммаПроводокПоКатегории("ДоходыЭцб ДУ",  OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_SHARE, SIDE_DEB,НачалоГода,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_63 ),
         ДоходРасходОблСначГодаДеб = СуммаПроводокПоКатегории("РасходыЭцб ДУ", OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_DEB,НачалоГода,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_BOND ) +
                                     СуммаПроводокПоКатегории("ДоходыЭцб ДУ",  OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_BOND,  SIDE_DEB,НачалоГода,
                                                                               OBJTYPE_TSCREDKIND, LLCLASS_TSCREDKIND, VALUE_63 ),
         ДоходРасходВексСначГодаДеб = СуммаПроводокПоКатегории("Расходы ДУ",   OBJTYPE_TSFIKIND,   LLCLASS_TSFIKIND, VALUE_VA,    SIDE_DEB,НачалоГода,
                                                                               OBJTYPE_TSDEBKIND,  LLCLASS_TSDEBKIND, VALUE_VA );

/* ДохРас = Кред - Деб */
     ДоходРасходАкцЗаПериод  = ДоходРасходАкцЗаПериодКред  - ДоходРасходАкцЗаПериодДеб;
     ДоходРасходОблЗаПериод  = ДоходРасходОблЗаПериодКред  - ДоходРасходОблЗаПериодДеб;
     ДоходРасходВексЗаПериод = ДоходРасходВексЗаПериодКред - ДоходРасходВексЗаПериодДеб;
     ДоходРасходАкцСначГода  = ДоходРасходАкцСначГодаКред  - ДоходРасходАкцСначГодаДеб;
     ДоходРасходОблСначГода  = ДоходРасходОблСначГодаКред  - ДоходРасходОблСначГодаДеб;
     ДоходРасходВексСначГода = ДоходРасходВексСначГодаКред - ДоходРасходВексСначГодаДеб;
  END;

  PRIVATE MACRO ПечатьДоходы(ДоходыЗапериод:@money, ДоходыСНачалаГода:@money, ДоходыНОБ:@money)
     var АкцНОБ = $0., ОблНОБ = $0., ВексНОБ = $0.;
     var ДоходРасходДвдЗаПериод = СуммаПоРОВУ(24,m_Report.m_BeginDate,false),
         ДоходРасходДвдСначГода = СуммаПоРОВУ(24,НачалоГода,false);

     ДоходыЗапериод = ДоходыЗапериод + 
                      TS_IIF(ДоходРасходАкцЗаПериод  > 0, ДоходРасходАкцЗаПериод,  0) +
                      TS_IIF(ДоходРасходОблЗаПериод  > 0, ДоходРасходОблЗаПериод,  0) + 
                      TS_IIF(ДоходРасходВексЗаПериод > 0, ДоходРасходВексЗаПериод, 0) + 
                      ДоходРасходДвдЗаПериод;
     ДоходыСНачалаГода = ДоходыСНачалаГода + 
                         TS_IIF(ДоходРасходАкцСначГода  > 0, ДоходРасходАкцСначГода,  0) +
                         TS_IIF(ДоходРасходОблСначГода  > 0, ДоходРасходОблСначГода,  0) + 
                         TS_IIF(ДоходРасходВексСначГода > 0, ДоходРасходВексСначГода, 0) + 
                         ДоходРасходДвдСначГода; 

     if( m_KindRep == KINDREP_CLRATE )
        ПолучитьНОБ(@АкцНОБ,@ОблНОБ,@ВексНОБ);
        ДоходыНОБ = АкцНОБ + ОблНОБ + ВексНОБ;
     end;

     PrintLineTable3("Доходы, в т.ч.",ДоходыЗапериод,ДоходыСНачалаГода,ДоходыНОБ);
     PrintLineTable3("  Доход по акциям",    TS_IIF(ДоходРасходАкцЗаПериод  > 0, ДоходРасходАкцЗаПериод,  0),
                                             TS_IIF(ДоходРасходАкцСначГода  > 0, ДоходРасходАкцСначГода,  0),АкцНОБ);
     PrintLineTable3("  Доход по облигациям",TS_IIF(ДоходРасходОблЗаПериод  > 0, ДоходРасходОблЗаПериод,  0),
                                             TS_IIF(ДоходРасходОблСначГода  > 0, ДоходРасходОблСначГода,  0),ОблНОБ);
     PrintLineTable3("  Доход по векселям",  TS_IIF(ДоходРасходВексЗаПериод > 0, ДоходРасходВексЗаПериод, 0),
                                             TS_IIF(ДоходРасходВексСначГода > 0, ДоходРасходВексСначГода, 0),ВексНОБ);
     PrintLineTable3("  Дивиденды",ДоходРасходДвдЗаПериод,ДоходРасходДвдСначГода,$0);
  END;

  PRIVATE MACRO ПечатьРасходы(РасходыЗапериод:@money,РасходыСНачалаГода:@money, РасходыНОБ:@money)
     var КомисЗаУпрЗапериод = $0., КомисЗаУпрСначГода = $0., КомисЗаУспЗапериод = $0., КомисЗаУспСначГода = $0.;

     var КомиссияБиржиЗапериод = $0.0, наНач = $0.0;

         ПолучитьИтогДУ( m_Report.m_TSOrders.rec.TsOrderID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0,
                         NULL, NULL, NULL, m_Report.m_EndDate, @КомиссияБиржиЗапериод );
         ПолучитьИтогДУ( m_Report.m_TSOrders.rec.TsOrderID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0,
                         NULL, NULL, NULL, m_Report.m_BeginDate, @наНач );
         КомиссияБиржиЗапериод = КомиссияБиржиЗапериод - наНач + ТО_ОбязКом( m_Report.m_TSOrders.rec.TsOrderID, m_Report.m_BeginDate, m_Report.m_EndDate );
     var КомиссияБиржиПИЗапериод = СуммаПоРОВУ(9,m_Report.m_BeginDate,true) + СуммаПоРОВУ(10,m_Report.m_BeginDate,true),
         КомиссияДепоЗапериод = СуммаПоРОВУ(11,m_Report.m_BeginDate,false),
         КомиссияБиржиПИСначГода = СуммаПоРОВУ(9,НачалоГода,true)+СуммаПоРОВУ(10,НачалоГода,true);
     var КомиссияБиржиСначГода; наНач = $0.0;
         ПолучитьИтогДУ( m_Report.m_TSOrders.rec.TsOrderID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0,
                         NULL, NULL, NULL, m_Report.m_EndDate, @КомиссияБиржиСначГода);
         ПолучитьИтогДУ( m_Report.m_TSOrders.rec.TsOrderID, ДУ_ИТОГ_Р_Квн, TS_DemandEvent("68"), 0,
                         NULL, NULL, NULL, НачалоГода, @наНач );
         КомиссияБиржиСначГода = КомиссияБиржиСначГода - НаНач + ТО_ОбязКом( m_Report.m_TSOrders.rec.TsOrderID, НачалоГода, m_Report.m_EndDate );

     var КомиссияДепоСначГода = СуммаПоРОВУ(11,НачалоГода,false);

     КомисЗаУпрЗапериод = СуммаПоИтогам(ДУ_ИТОГ_Н_Купр, m_Report.m_BeginDate);
     КомисЗаУпрСначГода = СуммаПоИтогам(ДУ_ИТОГ_Н_Купр, НачалоГода);

     КомисЗаУспЗапериод = СуммаПоИтогам(ДУ_ИТОГ_Н_Кусп, m_Report.m_BeginDate);
     КомисЗаУспСначГода = СуммаПоИтогам(ДУ_ИТОГ_Н_Кусп, НачалоГода);

     РасходыЗапериод = TS_IIF(ДоходРасходАкцЗаПериод  < 0, abs(ДоходРасходАкцЗаПериод),  0) +
                       TS_IIF(ДоходРасходОблЗаПериод  < 0, abs(ДоходРасходОблЗаПериод),  0) + 
                       TS_IIF(ДоходРасходВексЗаПериод < 0, abs(ДоходРасходВексЗаПериод), 0) + 
                       КомиссияБиржиЗапериод  + КомиссияБиржиПИЗапериод + КомиссияДепоЗапериод + КомисЗаУпрЗапериод + КомисЗаУспЗапериод;

     РасходыСНачалаГода = TS_IIF(ДоходРасходАкцСначГода  < 0, abs(ДоходРасходАкцСначГода),  0) +
                          TS_IIF(ДоходРасходОблСначГода  < 0, abs(ДоходРасходОблСначГода),  0) + 
                          TS_IIF(ДоходРасходВексСначГода < 0, abs(ДоходРасходВексСначГода), 0) + 
                          КомиссияБиржиСначГода + КомиссияБиржиПИСначГода + КомиссияДепоСначГода + КомисЗаУпрСначГода + КомисЗаУспСначГода; 

     РасходыНОБ = КомиссияБиржиСначГода + КомиссияДепоСначГода + КомисЗаУпрСначГода + КомисЗаУспСначГода;

     PrintLineTable3("Расходы, в т.ч.",РасходыЗапериод,РасходыСНачалаГода, РасходыНОБ);
     PrintLineTable3("  Отрицательный финансовый результат по акциям",    TS_IIF(ДоходРасходАкцЗаПериод  < 0, abs(ДоходРасходАкцЗаПериод),  0),
                                                                          TS_IIF(ДоходРасходАкцСначГода  < 0, abs(ДоходРасходАкцСначГода),  0), 0.00);
     PrintLineTable3("  Отрицательный финансовый результат по облигациям",TS_IIF(ДоходРасходОблЗаПериод  < 0, abs(ДоходРасходОблЗаПериод),  0),
                                                                          TS_IIF(ДоходРасходОблСначГода  < 0, abs(ДоходРасходОблСначГода),  0), 0.00);
     PrintLineTable3("  Отрицательный финансовый результат по векселям",  TS_IIF(ДоходРасходВексЗаПериод < 0, abs(ДоходРасходВексЗаПериод), 0),
                                                                          TS_IIF(ДоходРасходВексСначГода < 0, abs(ДоходРасходВексСначГода), 0), 0.00);
     PrintLineTable3("  Комиссия биржи",КомиссияБиржиЗапериод,КомиссияБиржиСначГода, КомиссияБиржиСначГода);
     PrintLineTable3("  Комиссия брокера и биржи на срочном рынке",КомиссияБиржиПИЗапериод,КомиссияБиржиПИСначГода, КомиссияБиржиПИСначГода);
     PrintLineTable3("  Комиссия депозитария",КомиссияДепоЗапериод,КомиссияДепоСначГода, КомиссияДепоСначГода);
     PrintLineTable3("  Вознаграждение управляющему, в т.ч.",КомисЗаУпрЗапериод+КомисЗаУспЗапериод,КомисЗаУпрСначГода+КомисЗаУспСначГода, 
                     КомисЗаУпрСначГода+КомисЗаУспСначГода);
     PrintLineTable3("    За управление",КомисЗаУпрЗапериод,КомисЗаУпрСначГода, КомисЗаУпрСначГода);
     PrintLineTable3("    За успешное управление",КомисЗаУспЗапериод,КомисЗаУспСначГода, КомисЗаУспСначГода);

      var nds_rate:double = 0; 
      if ( not GetNDSRateByDate(nds_rate) )    
          nds_rate = 0;
      end;
     PrintLineTable3("    в т.ч. НДС",((КомисЗаУпрЗапериод+КомисЗаУспЗапериод)*nds_rate)/(nds_rate+100),((КомисЗаУпрСначГода+КомисЗаУспСначГода)*nds_rate)/(nds_rate+100), 
                     ((КомисЗаУпрСначГода+КомисЗаУспСначГода)*nds_rate)/(nds_rate+100));
  END;

  MACRO ПечатьНалог()
     var НДФЛЗапериод = $0., НДФЛСначГода = $0.;
 
     if( m_Report.m_TSOrders.rec.LegalForm == 2 )
        if( TS_IsPayerNPTaxAllCheck(m_Report.m_OrderFD.Order().rec.Trustor, m_Report.m_EndDate) )
           НДФЛЗапериод = СуммаПоИтогам(6, m_Report.m_BeginDate);
           НДФЛСначГода = СуммаПоИтогам(6, НачалоГода);
        end;
        PrintLineTable3("НДФЛ",НДФЛЗапериод,НДФЛСначГода, НДФЛСначГода);
     else
        PrintLineTable3("Налог на прибыль",0.00,0.00, 0.00);
     end;
  END;
 
  MACRO ПечатьПодвал()
     var ВыплаченПрибыль = 0, КапитализирПрибыль = 0, Прибыль = ПрибыльСНачДоговора();
     var F1_4_1, F1_4_2;
     var EventID:integer = TS_DemandEvent("95");

     if( ПолучитьИтогДУ( m_Report.m_TSOrders.rec.TsOrderID, ДУ_ИТОГ_Н_Дх, EventID, 0, 
                         НачалоТекущегоПДД(m_Report.m_TSOrders.rec.TsOrderID, m_Report.m_EndDate),
                         NULL, NULL, m_Report.m_EndDate, null, @ВыплаченПрибыль) )
        MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
     end;

     EventID = TS_DemandEvent("96");
     if( ПолучитьИтогДУ( m_Report.m_TSOrders.rec.TsOrderID, ДУ_ИТОГ_Н_Дх, EventID, 0, 
                         НачалоТекущегоПДД(m_Report.m_TSOrders.rec.TsOrderID, m_Report.m_EndDate),
                         NULL, NULL, m_Report.m_EndDate, null, @КапитализирПрибыль) )
        MsgBox( "Ошибка при получении итога \"Н_Дх\"по договору" );
     end;


     if((m_KindRep == KINDREP_CLRATE) OR ((m_KindRep == KINDREP_CL)AND(m_Report.m_TSOrders.rec.LegalForm == 2)))
        F1_4_1 = "НДФЛ с начала договора / даты последней пролонгации";
        if( TS_IsPayerNPTaxAllCheck(m_Report.m_OrderFD.Order().rec.Trustor, m_Report.m_EndDate) )
           F1_4_2 = СуммаПоИтогам(6, НачалоТекущегоПДД(m_Report.m_TSOrders.rec.TsOrderID, m_Report.m_EndDate));
        else
           F1_4_2 = 0.0;
        end;
     else
        F1_4_1 = "Налог на прибыль с начала договора / даты последней пролонгации";
        F1_4_2 = 0.0;
     end;

     m_Report.PrintFormatString( ReportHeader,
                                GetCellName("F1_1"), Прибыль,
                                GetCellName("F1_2"), ВыплаченПрибыль,
                                GetCellName("F1_3"), КапитализирПрибыль,
                                GetCellName("F1_4_1"), F1_4_1,
                                GetCellName("F1_4_2"), F1_4_2,
                                GetCellName("F1_5"), (Прибыль - ВыплаченПрибыль - КапитализирПрибыль - F1_4_2)
                              );
     m_Report.CopyAllSheetInTotalBook( m_SheetName, false, GetCellName("N1_Footer"), 0 );
  END;

  PRIVATE MACRO ПечатьФинансовыйРезультат()
     var y, ДоходыЗапериод = $0., ДоходыСНачалаГода = $0., ДоходыНОБ = $0., РасходыЗапериод = $0., РасходыСНачалаГода = $0., РасходыНОБ = $0.;
 
     DateSplit (m_Report.m_EndDate,0,0,y);
     НачалоГода = Date(1,1,y);

     RegisterTable_3();
     РасчитатьДоходРасход();
     ПечатьДоходы(@ДоходыЗапериод, @ДоходыСНачалаГода, @ДоходыНОБ);
     ПечатьРасходы(@РасходыЗапериод, @РасходыСНачалаГода, @РасходыНОБ);
     PrintLineTable3("Прибыль / Убыток",ДоходыЗапериод-РасходыЗапериод,ДоходыСНачалаГода-РасходыСНачалаГода,ДоходыНОБ-РасходыНОБ);
     ПечатьНалог();
     EndTable();
  END;

  MACRO Execute()
    var LegalForm = -1;

    if( m_KindRep == KINDREP_CLRATE )
       LegalForm = 2;
    else
       if( m_Report.m_FormClRepWithRate == true )
          LegalForm = 1;
       end;
    end;
    if( LegalForm )
       m_Report.TSOrderList(LegalForm);
    else
       m_Report.TSOrderList();
    end;

    while( m_Report.TsOrderNext() )
       ExistPrintFirstSheet = true;
       PrintReportHead();
       ПечатьКапиталВУправлении();
       ПечатьДенСредстваДебЗадолж();
       ПечатьФинансовыйРезультат();
       ПечатьПодвал();                            
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
  END;

END;
/********************************************************************************
Класс для шаблона "Портфель векселей"
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_VAPortf( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_RSD, m_DS, m_BuySum, m_BuyFIID, m_BalanceDate;
  VAR m_A2_1_1, m_A2_1_2:TArraySum, m_A2_1_3:TArraySum, m_A2_1_5:TArraySum, m_A2_1_7:TArraySum, m_A2_1_8:TArraySum, m_A2_1_9:TArraySum, m_A2_1_10:TArraySum, m_A2_1_11:TArraySum;
  VAR m_A2_2_1:TArraySum, m_A2_2_2:TArraySum, m_A2_2_4:TArraySum, m_A2_2_6:TArraySum, m_A2_2_7:TArraySum, m_A2_2_8:TArraySum, m_A2_2_9:TArraySum, m_A2_2_10:TArraySum;

  MACRO GetLastEnrolmentID(BCID, Дата)
    var rsd, ds;
    
    rsd = RSDCommand("select bnr.t_ID " +
                     "  from dvsbnrbck_dbt bnr" +
                     " where     bnr.t_BCID = ? " +
                     "       and bnr.t_ChangeDate = ( select max(t_ChangeDate) " + 
                     "                                  from dvsbnrbck_dbt " +
                     "                                 where     t_BCID = bnr.t_BCID " +
                     "                                       and t_NewABCStatus = " + VABANNER_STATUS_ACCOUNT + 
                     "                                       and t_ChangeDate <= ? ) ");
    rsd.addParam("", RSDBP_IN, BCID);
    rsd.addParam("", RSDBP_IN, Дата);
    rsd.execute();

    ds = TRsbDataSet(rsd);

    if( ds.MoveNext() )
       return ds.ID;
    end;

    return 0;

  END;

  /*получить сумму ПДД (на период обращения)*/
  MACRO ПолучитьСуммуПДД(BCID, FIRole, Дата, EnrolID )
    var query, DataSet;
    var Сумма = 0.0;
    var CurrEnrolID;

    if( EnrolID )
       CurrEnrolID = EnrolID;
    else
       CurrEnrolID = GetLastEnrolmentID(BCID, Дата);
    end;

    if(FIRole == FIROLE_PERCENT)
      query =   " select sum(inc.t_Perc) ";
    elif(FIRole == FIROLE_DISCOUNT)
      query =   " select sum(inc.t_Disc) ";
    else
      query =   " select sum(inc.t_Perc+inc.t_Disc) ";
    end;
    
    query =  query + " as Summ"
                   + " from dvsincome_dbt inc "
                   + " where inc.t_BCID = " + BCID + " AND inc.t_Enrolment_ID = " + CurrEnrolID;

    if((ValType(Дата) != V_UNDEF) and (Дата > date(0,0,0)))
      query =  query + " and inc.t_EndDate <= " + GetSQLDate(date(Дата));
    end;
    
    DataSet = TRsbDataSet(query);
    
    if( (DataSet.moveNext()) and (ValType(DataSet.Summ) != V_UNDEF) )
      Сумма = DataSet.Summ;
    end;

    return Сумма;

  END;

  /*сумма начисленного ПДД на дату */
  MACRO ПолучитьСуммуПДДНаДату(BCID, Дата, FIRole)
    var query, DataSet;
    var Сумма = 0.0;

    Сумма = ПолучитьСуммуПДД(BCID, FIRole, Дата);

    return Сумма;
  END;

  /*сумма за период*/
  MACRO ПолучитьСуммуПДДЗаПериод(BCID, DateB, DateE, FIRole)
    var query, DataSet;
    var SumE = 0.0, SumB = 0.0;
    var CurrEnrolID = GetLastEnrolmentID(BCID, DateE);

    SumE = ПолучитьСуммуПДД(BCID, FIRole, date(DateB-1), CurrEnrolID);
    SumB = ПолучитьСуммуПДД(BCID, FIRole, DateE, CurrEnrolID);

    return SumB-SumE;
  END;


  MACRO A2_1()
    return trim(string(m_DS.IssuerName));
  END;

  MACRO A2_2()
    if( m_DS.Formula == VS_IN_DISCONT )
       return "Вексель дисконтный";
    elif( (m_DS.Formula == VS_IN_S_PC) or (m_DS.Formula == VS_IN_M_PC) )
       return "Вексель процентный";
    elif( m_DS.Formula == VS_IN_DISC_PC )
       return "Вексель процентно-дисконтный";
    end;
  END;

  MACRO A2_3()
    return trim(string(m_DS.BCNumber) + " " + string(m_DS.BCSeries));
  END;

  MACRO A2_4()
    return date(m_DS.Start);
  END;

  MACRO A2_5()
    return m_BalanceDate;
  END;

  MACRO A2_6()
    if( (m_DS.BCTermFormula == VS_TERMF_FIXEDDAY) OR (m_DS.BCTermFormula == VS_TERMF_INATIME) )
       return date(m_DS.Maturity);
    elif( m_DS.BCTermFormula == VS_TERMF_DURING )
       return date(m_DS.BCPresentationDate) + m_DS.Diff;
    else
       return "По предъявлении";
    end;
  END;

  MACRO A2_7()
    /*это поле удалено*/
    return "";
  END;

  MACRO A2_8()
    return m_A2_2_2.Add(m_DS.PFI, m_A2_1_3.Add(m_DS.PFI, money(m_DS.Principal)));
  END;

  MACRO A2_9()
    return ПолучитьКодФинИн(m_DS.PFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A2_10()
    if( m_DS.PFI == m_BuyFIID)  /*если валюты одинаковые тогда все просто*/
       return double(m_BuySum/m_DS.Principal*100);
    else                        /*иначе придется извращаться, но пока у нас в ДУ только РУБЛИ все хорошо*/
       return "";
    end;
  END;

  MACRO A2_11()
    return m_A2_2_4.Add(m_BuyFIID, m_A2_1_5.Add(m_BuyFIID, m_BuySum));
  END;

  MACRO A2_12()
    return ПолучитьКодФинИн(m_BuyFIID, NULL, FICK_ISOSTRING);
  END;

  MACRO A2_13()
    if( (m_DS.Formula == VS_IN_S_PC) or (m_DS.Formula == VS_IN_M_PC) or (m_DS.Formula == VS_IN_DISC_PC) ) /*только для процентного векселя*/
       return double(m_DS.Price / 10000);
    end;
    return "";
  END;

  MACRO A2_14()
    return m_A2_2_6.Add(m_DS.PFI, m_A2_1_7.Add(m_DS.PFI, money(ПолучитьСуммуПДДНаДату( m_DS.BCID, m_Report.m_EndDate, FIROLE_DISCOUNT))));
  END;

  MACRO A2_15()
    return m_A2_2_7.Add(m_DS.PFI, m_A2_1_8.Add(m_DS.PFI, money(ПолучитьСуммуПДДНаДату( m_DS.BCID, m_Report.m_EndDate, FIROLE_PERCENT))));
  END;

  MACRO A2_16()
    return m_A2_2_8.Add(m_DS.PFI, m_A2_1_9.Add(m_DS.PFI, money(ПолучитьСуммуПДДЗаПериод( m_DS.BCID, m_Report.m_BeginDate, m_Report.m_EndDate, FIROLE_DISCOUNT))));
  END;

  MACRO A2_17()
    return m_A2_2_9.Add(m_DS.PFI, m_A2_1_10.Add(m_DS.PFI, money(ПолучитьСуммуПДДЗаПериод( m_DS.BCID, m_Report.m_BeginDate, m_Report.m_EndDate, FIROLE_PERCENT))));
  END;

  MACRO A2_18()
    return m_A2_2_10.Add(m_DS.PFI, m_A2_1_11.Add(m_DS.PFI, money(m_BuySum + ПолучитьСуммуПДДНаДату( m_DS.BCID, m_Report.m_EndDate))));
  END;

  MACRO A2_19()
    return ПолучитьКодФинИн(m_DS.PFI, NULL, FICK_ISOSTRING);
  END;

  MACRO InitDataSet()
    m_RSD = RSDCommand( "select bnr.t_IssuerName, bnr.t_BCNumber, bnr.t_BCSeries, bnr.t_RepaymentDate, bnr.t_BCTermFormula, bnr.t_BCPresentationDate, " +
                        "       dl_leg.t_Maturity, dl_leg.t_Diff, dl_leg.t_Formula, dl_leg.t_Start, dl_leg.t_Principal, dl_leg.t_PFI, dl_leg.t_Price, " +
                        "       bnr.t_BCID, bnr.t_Issuer "
                        "  from dvsbanner_dbt bnr, dfininstr_dbt fin, ddl_tick_dbt tk, dvsordlnk_dbt lnk, doprkoper_dbt kop, ddl_leg_dbt dl_leg" +
                        " where     bnr.t_bcformkind = 1 and bnr.t_Issuer not in (select t_PartyID from ddp_dep_dbt) "+
                        "       and fin.t_FIID = bnr.t_FIID" + 
                        "       and ( (bnr.t_BackOffice = 'А') OR (bnr.t_BackOffice = CHR(0)) ) " +
                        "       and bnr.t_BCID = lnk.t_BCID " +
                        "       and kop.t_Kind_Operation = tk.t_DealType " +
                        "       and ((instr(kop.t_SysTypes, 'B') != 0) OR (kop.t_DocKind = " + string(TS_DOC_IDDU) + "))" +
                        "       and lnk.t_ContractID = tk.t_DealID " +
                        "       and lnk.t_DocKind = tk.t_bofficekind " +
                        "       and lnk.t_LinkKind = 1" +
                        "       and lnk.t_InterestChargeDate = ( select nvl(max(l1.t_InterestChargeDate),to_date('01-01-0001','DD-MM-YYYY')) t_Start_Date " +
                                                       "           from doprkoper_dbt koper, ddl_tick_dbt tick, dvsordlnk_dbt l1 " +
                                                       "          where     l1.t_DocKind IN (" + string(DL_VATRUST) + ", " + string(TS_DOC_DECLAR) + ") " +
                                                       "                and tick.t_DealID = l1.t_ContractID " +
                                                       "                and koper.t_Kind_Operation = tick.t_DealType " +
                                                       "                and ((instr(koper.t_SysTypes, 'B') != 0) OR (koper.t_DocKind = " + string(TS_DOC_IDDU) + ")) " +
                                                       "                and l1.t_BCID = bnr.t_BCID"
                                                       "                and l1.t_linkkind = 1 " +
                                                       "                and l1.t_InterestChargeDate <= ? ) " +
                        "       and fin.t_avoirkind = ? " +
                        "       and dl_leg.t_LegKind = " + string(LEG_KIND_VSBANNER) +
                        "       and dl_leg.t_DealID = bnr.t_BCID " + 
                        "       and dl_leg.t_LegID = 0 "
                        "       and ((tk.T_ClientID = ?) OR (-1 = ?))" 
                        "       and ((tk.t_ClientContrID = ?) OR (-1 = ?)) " +
                        "       and EXISTS(select MAX(t_ChangeDate) " +
                        "                    from dvsbnrbck_dbt " +
                        "                   where     t_BCID = bnr.t_bcid " +
                        "                         and t_ABCStatus = '" + SET_CHAR + "' " +
                        "                         and t_NewABCStatus = " + VABANNER_STATUS_ACCOUNT + " " +
                        "                         and t_ChangeDate <= ? ) " +
                        "       AND NOT EXISTS(select t_BCID " +
                        "                        from dvsbnrbck_dbt " +
                        "                       where     t_BCID = bnr.t_bcid  " +
                        "                             and t_ABCStatus = '" + SET_CHAR + "'  " +
                        "                             and t_OldABCStatus = " + VABANNER_STATUS_ACCOUNT + " " +
                        "                             and t_ChangeDate >=(select MAX(t_ChangeDate)  " +
                        "                                                   from dvsbnrbck_dbt  " +
                        "                                                  where     t_BCID = bnr.t_bcid  " +
                        "                                                        and t_ABCStatus = '" + SET_CHAR + "' " +
                        "                                                        and t_NewABCStatus = 100  " +
                        "                                                        and t_ChangeDate <= ?)  " +
                        "                             and t_ChangeDate <= ?) " +
                        "order by bnr.t_IssuerName, bnr.t_BCSeries, bnr.t_BCNumber" );
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, AVOIRISSKIND_BILL);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.execute();

    m_DS = TRsbDataSet( m_RSD );

    return m_DS.MoveNext();
  END;

  MACRO GetDataFromDeal()
    var ds; 
    var rsd = RSDCommand("select paym.t_ValueDate, lnk.t_BCCost, lnk.t_BCCFI" +
                         "  from dvsordlnk_dbt lnk, ddl_tick_dbt tick, dpmpaym_dbt paym, doprkoper_dbt koper " +
                         " where     lnk.t_BCID = ? " +
                         "       and lnk.t_LinkKind = " + VSORDLNK_K_BUY +
                         "       and (lnk.t_DocKind = "+ DL_VEKSELACCOUNTED +" OR lnk.t_DocKind = " + DL_VATRUST + " OR lnk.t_DocKind = " + DL_VAENWR + ")"
                         "       and lnk.t_ContractID = tick.t_DealID " +
                         "       and tick.t_DealType = koper.T_Kind_Operation " +
                         "       and paym.t_DocKind = tick.t_BofficeKind " +
                         "       and paym.t_DocumentID = tick.t_DealID " +
                         "       and ((paym.t_Purpose = " + BRi + " and koper.t_SysTypes LIKE '%W%' and koper.T_SysTypes LIKE '%S%') " +
                         "             or (paym.t_Purpose = " + BAi + ") )" +
                         "       and paym.t_PaymStatus = " + PM_FINISHED + 
                         "       and paym.t_ValueDate <= ? " +
                         "order by paym.t_ValueDate DESC");
    rsd.addParam("", RSDBP_IN, m_DS.BCID);
    rsd.addParam("", RSDBP_IN, m_Report.m_EndDate);
    rsd.execute();

    ds = TRsbDataSet( rsd );

    m_BuySum = m_BuyFIID = m_BalanceDate = NULL;

    if( ds.MoveNext() )
       m_BalanceDate = date(ds.ValueDate);
       m_BuySum      = money(ds.BCCost);
       m_BuyFIID     = int(ds.BCCFI);
    else
       m_BuySum      = 0;
       m_BuyFIID     = 0;
    end;
  END;

  MACRO PrintHeadTable()
    var Query, DataSet, i = 0, СуммаПоСчетам = 0.0;
    var СрочнРынок = 0.0, ДебЗадолж = 0.0;
    
    m_Report.PrintFormatString( ReportHeader,
                                "H2_1", m_Report.Department()
                              );
    m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "H2_Head", 1 );
    
    
    //для отчета по ОФБУ выводим "Состав портфеля"
    if(m_Report.m_TSOrders.rec.ServKindSub == PTSKS_TRUST_OFBU)

      m_Report.PrintFormatString( ReportHeader,
                                  "H2_1_1", "Приложение к Отчету Доверительного Управляющего",
                                  "H2_1_2", "по ОФБУ  № "+m_Report.m_TSOrders.rec.Number+"  от "+Date(m_Report.m_TSOrders.rec.DateBegin)+"  г.",
                                  "H2_1_3", "за период с "+m_Report.m_BeginDate+"  по " +m_Report.m_EndDate
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "H2_Head1", 0 );   
      
      Query = RSDCommand( "SELECT distinct accdoc.t_account, ( rsb_account.restall (accdoc.t_account, accdoc.t_chapter, accdoc.t_currency, ? )) RestAcc, " +
                        "         (SELECT acc2.t_NameAccount FROM daccount_dbt acc2 WHERE acc2.t_Account = accdoc.t_Account AND " +
                        "                 acc2.t_Code_Currency = accdoc.t_Currency AND acc2.t_Chapter = accdoc.t_Chapter AND " +
                        "                 acc2.t_Department = accdoc.t_DepartmentID) as NameAccount " +
                        "  FROM dmcaccdoc_dbt accdoc, dmctempl_dbt templ, dmccateg_dbt categ  " +
                        " WHERE categ.t_LevelType = 1 " +
                        "       AND categ.t_Code = 'ДС ДУ' " +
                        "       AND accdoc.t_CatID   = categ.t_ID " +
                        "       AND accdoc.t_ClientContrID = ? " +
                        "       AND templ.t_CatID  = accdoc.t_CatID " +
                        "       AND templ.t_Number = accdoc.t_TemplNum " +
                        "       AND (CASE WHEN (categ.t_Param1 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class1 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value1  " +
                        "                 WHEN (categ.t_Param2 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class2 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value2  " +
                        "                 WHEN (categ.t_Param3 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class3 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value3  " +
                        "                 WHEN (categ.t_Param4 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class4 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value4  " +
                        "                 WHEN (categ.t_Param5 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class5 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value5  " +
                        "                 WHEN (categ.t_Param6 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class6 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value6  " +
                        "                 WHEN (categ.t_Param7 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class7 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value7  " +
                        "                 WHEN (categ.t_Param8 = "+OBJTYPE_TSACCOWNKIND+" AND categ.t_class8 = "+LLCLASS_TSACCOWNKIND+") THEN templ.t_Value8  " +
                        "             END) <> 41"
                        );

      Query.addParam( "", RSDBP_IN, m_Report.m_EndDate );
      Query.addParam( "", RSDBP_IN, m_Report.m_TSOrders.rec.ID );

      Query.execute();
      DataSet = TRSBDataSet(Query);   
      
      m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "H2_Table_0", 1 );
     
      while( DataSet.MoveNext() )
        if(ABS(SQL_ConvTypeSum(DataSet.RestAcc)) > 0)

          СуммаПоСчетам = СуммаПоСчетам + ABS(SQL_ConvTypeSum(DataSet.RestAcc));

          m_Report.PrintFormatString( ReportHeader,
                                      "A2_0_1",    DataSet.NameAccount,     
                                      "A2_0_2",    ABS(SQL_ConvTypeSum(DataSet.RestAcc))     
                                    );  
          m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "MainTable_0", 0 );

        end;
      end;

      СрочнРынок = ДСПоКатегории( m_Report.m_TSOrders.rec.ID, m_Report.m_EndDate, "+Расчеты, ДУ", OBJTYPE_TSREQKIND, LLCLASS_TSREQKIND, 72 );
      ДебЗадолж = ДСПоКатегории( m_Report.m_TSOrders.rec.ID, m_Report.m_EndDate, "+Расчеты, ДУ" ) - СрочнРынок;

      m_Report.PrintFormatString( ReportHeader,
                                  "A2_0_1", "Денежные средства на срочном рынке",
                                  "A2_0_2", СрочнРынок
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "MainTable_0", 0 );

      m_Report.PrintFormatString( ReportHeader,
                                  "A2_0_1", "Дебиторская задолженность",
                                  "A2_0_2", ДебЗадолж
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "MainTable_0", 0 );

      m_Report.PrintFormatString( ReportHeader,
                                  "A2_0_1", "Итого",
                                  "A2_0_2", СуммаПоСчетам+СрочнРынок+ДебЗадолж
                                ); 
      m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "MainTable_0", 0 );
    end;

    m_Report.PrintFormatString( ReportHeader,
                                "H2_2", "Вексельный портфель ДУ " + m_Report.GetPartyName({OurBank}),
                                "H2_3", m_Report.ReportPeriod( true ),
                                "H2_4", m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "H2_Head2", 1 );
    
  END;

  MACRO RegisterTable()
    m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "H2_Table", 0 );
    m_Report.RegisterTable( "MainTable_2", TableHeader,
                            "A2_1",
                            "A2_2",
                            "A2_3",
                            "A2_4",
                            "A2_5",
                            "A2_6",
                            "A2_8",
                            "A2_9",
                            "A2_10",
                            "A2_11",
                            "A2_12",
                            "A2_13",
                            "A2_14",
                            "A2_15",
                            "A2_16",
                            "A2_17",
                            "A2_18",
                            "A2_19"
                           );
  END;

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, m_Report.GetTableRange(), 0 );
  END;


  MACRO PrintLine()
    m_Report.PrintTableLine( "A2_1",    A2_1(),     null,
                             "A2_2",    A2_2(),     null,
                             "A2_3",    A2_3(),     null,
                             "A2_4",    string(date(A2_4()):f),     null,
                             "A2_5",    string(date(A2_5()):f),     null,
                             "A2_6",    A2_6(),     null,
                             "A2_8",    A2_8(),     null,
                             "A2_9",    A2_9(),     null,
                             "A2_10",   A2_10(),    null,
                             "A2_11",   A2_11(),    null,
                             "A2_12",   A2_12(),    null,
                             "A2_13",   A2_13(),    null,
                             "A2_14",   A2_14(),    null,
                             "A2_15",   A2_15(),    null,
                             "A2_16",   A2_16(),    null,
                             "A2_17",   A2_17(),    null,
                             "A2_18",   A2_18(),    null,
                             "A2_19",   A2_19(),    null
                            );
  END;

  MACRO PrintIssueItogLine()
    m_A2_1_2.SetFirst();
    m_A2_1_3.SetFirst();
    m_A2_1_5.SetFirst();
    m_A2_1_7.SetFirst();
    m_A2_1_8.SetFirst();
    m_A2_1_9.SetFirst();
    m_A2_1_10.SetFirst();
    m_A2_1_11.SetFirst();

    while( m_A2_1_2.Next() )  
      m_A2_1_3.Next();
      m_A2_1_5.Next();
      m_A2_1_7.Next();
      m_A2_1_8.Next();
      m_A2_1_9.Next();
      m_A2_1_10.Next();
      m_A2_1_11.Next();

      m_Report.SetCurrentLineFont( 10, true );

      m_Report.Merge( "A2_1", "A2_3", null);
      m_Report.PrintTableLine(    "A2_1:r",  m_A2_1_1,                                                   NULL,
                                  "A2_4",    "Векселей",                                                 NULL,
                                  "A2_5",    ЧислоCЗаданнойТочностью(m_A2_1_2.GetSum(),0,"r"),           NULL,
                                  "A2_6",    "шт.",                                                      NULL,
                                  "A2_8",    m_A2_1_3.GetSum(),                                          NULL,
                                  "A2_9",    ПолучитьКодФинИн(m_A2_1_3.GetCCy(), NULL, FICK_ISOSTRING),  NULL,
                                  "A2_11",   m_A2_1_5.GetSum(),                                          NULL,
                                  "A2_12",   ПолучитьКодФинИн(m_A2_1_5.GetCCy(), NULL, FICK_ISOSTRING),  NULL,
                                  "A2_14",   m_A2_1_7.GetSum(),                                          NULL,
                                  "A2_15",   m_A2_1_8.GetSum(),                                          NULL,
                                  "A2_16",   m_A2_1_9.GetSum(),                                          NULL,
                                  "A2_17",   m_A2_1_10.GetSum(),                                         NULL,
                                  "A2_18",   m_A2_1_11.GetSum(),                                         NULL,
                                  "A2_19",   ПолучитьКодФинИн(m_A2_1_11.GetCCy(), NULL, FICK_ISOSTRING), NULL
                                );
    end;
    m_A2_1_2.Clear();
    m_A2_1_3.Clear();
    m_A2_1_5.Clear();
    m_A2_1_7.Clear();
    m_A2_1_8.Clear();
    m_A2_1_9.Clear();
    m_A2_1_10.Clear();
    m_A2_1_11.Clear();
  END;


  MACRO PrintClientItogLine()
    m_A2_2_1.SetFirst();
    m_A2_2_2.SetFirst();
    m_A2_2_4.SetFirst();
    m_A2_2_6.SetFirst();
    m_A2_2_7.SetFirst();
    m_A2_2_8.SetFirst();
    m_A2_2_9.SetFirst();
    m_A2_2_10.SetFirst();

    while( m_A2_2_1.Next() )  
      m_A2_2_2.Next();
      m_A2_2_4.Next();
      m_A2_2_6.Next();
      m_A2_2_7.Next();
      m_A2_2_8.Next();
      m_A2_2_9.Next();
      m_A2_2_10.Next();

      m_Report.SetCurrentLineFont( 10, true );
      m_Report.Merge( "A2_1", "A2_3", null);
      m_Report.PrintTableLine(    "A2_1:r",  "Итого:",                                                   NULL,
                                  "A2_4",    "",                                                         NULL,
                                  "A2_5",    ЧислоCЗаданнойТочностью(m_A2_2_1.GetSum(),0,"r"),           NULL,
                                  "A2_6",    "шт.",                                                      NULL,
                                  "A2_8",    m_A2_2_2.GetSum(),                                          NULL,
                                  "A2_9",    ПолучитьКодФинИн(m_A2_2_2.GetCCy(), NULL, FICK_ISOSTRING),  NULL,
                                  "A2_11",   m_A2_2_4.GetSum(),                                          NULL, 
                                  "A2_12",   ПолучитьКодФинИн(m_A2_2_4.GetCCy(), NULL, FICK_ISOSTRING),  NULL,
                                  "A2_14",   m_A2_2_6.GetSum(),                                          NULL,
                                  "A2_15",   m_A2_2_7.GetSum(),                                          NULL,
                                  "A2_16",   m_A2_2_8.GetSum(),                                          NULL,
                                  "A2_17",   m_A2_2_9.GetSum(),                                          NULL,
                                  "A2_18",   m_A2_2_10.GetSum(),                                         NULL,
                                  "A2_19",   ПолучитьКодФинИн(m_A2_2_10.GetCCy(), NULL, FICK_ISOSTRING), NULL
                                );

    end;
    m_A2_2_1.Clear();
    m_A2_2_2.Clear();
    m_A2_2_4.Clear();
    m_A2_2_6.Clear();
    m_A2_2_7.Clear();
    m_A2_2_8.Clear();
    m_A2_2_9.Clear();
    m_A2_2_10.Clear();
  END;

  MACRO BeginReport()
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( "Портфель векселей" );
  END;

  MACRO Execute()
    var ExistData = false, whileFlag = false;
    var Issuer;
    m_Report.TSOrderList();

    while( m_Report.TsOrderNext() )
       ExistData = InitDataSet();
       whileFlag = ExistData;

       if( ExistData )
          ExistPrintVAPortf = true;
          PrintHeadTable();
          RegisterTable();
       end;

       Issuer = m_DS.Issuer;

       while( whileFlag )
          m_A2_1_1 = trim(string(m_DS.IssuerName));
          m_A2_2_1.Add(m_DS.PFI, m_A2_1_2.Add(m_DS.PFI, 1));
          GetDataFromDeal();
          PrintLine();
          whileFlag = m_DS.MoveNext();
          if( Issuer != m_DS.Issuer )
             PrintIssueItogLine();
             Issuer = m_DS.Issuer;
          end;
       end;

       if( ExistData )
          PrintIssueItogLine();
          PrintClientItogLine();
          EndTable();
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
    if( ExistPrintSharePortf == true )
       m_Report.AddStandardFooter( "N2_" );
       m_Report.CopyAllSheetInTotalBook( "Портфель векселей", false, "H2_Footer", 1 );
    end;
  END;

END;

/********************************************************************************
Класс для шаблона "Портфель акций"
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_SharePortf( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_RSD, m_DS, m_TCC, m_TCC_Old;
  VAR m_A3_1_1, m_A3_1_2:TArraySum, m_A3_1_3:TArraySum, m_A3_1_5:TArraySum, m_A3_1_7:TArraySum, m_A3_1_9:TArraySum, m_A3_1_11:TArraySum;
  VAR m_A3_2_1:TArraySum, m_A3_2_3:TArraySum, m_A3_2_5:TArraySum, m_A3_2_7:TArraySum, m_A3_2_9:TArraySum;

  MACRO A3_1()
    return trim(string(m_DS.IssuerName));
  END;

  MACRO A3_2()
    return trim(string(m_DS.FI_Code));
  END;

  MACRO A3_3()
    return trim(string(m_DS.LSIN));
  END;

  MACRO A3_4()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A3_5()
    return date(m_DS.DealDate);
  END;

  MACRO A3_6()
    return time(m_DS.Time);
  END;

  MACRO A3_7()
    return m_A3_1_2.Add(m_DS.FaceValueFI, money(m_DS.Amount));
  END;

  MACRO A3_8()
    return "";
  END;

  MACRO A3_9()
    return double(m_DS.Sum/m_DS.Amount);
  END;

  MACRO A3_10()
    return m_A3_2_1.Add(m_DS.FaceValueFI, m_A3_1_3.Add(m_DS.FaceValueFI, money(m_DS.Sum)));
  END;

  MACRO A3_11()
    return ПолучитьКодФинИн(m_DS.Currency, NULL, FICK_ISOSTRING);
  END;

  MACRO A3_12()
    return double(m_TCC);
  END;

  MACRO A3_13()
    return m_A3_2_3.Add(m_DS.FaceValueFI, m_A3_1_5.Add(m_DS.FaceValueFI, money(m_TCC*m_DS.Amount)));
  END;

  MACRO A3_14()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A3_15()
    return double(m_DS.BalanceCost/m_DS.Amount);
  END;

  MACRO A3_16()
    return m_A3_2_5.Add(m_DS.FaceValueFI, m_A3_1_7.Add(m_DS.FaceValueFI, money(m_DS.BalanceCost)));
  END;

  MACRO A3_17()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A3_18()
    return m_A3_2_7.Add(m_DS.FaceValueFI, m_A3_1_9.Add(m_DS.FaceValueFI, money(m_DS.OverAmount)));
  END;

  MACRO A3_19()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A3_20()
    return m_A3_2_9.Add(m_DS.FaceValueFI, m_A3_1_11.Add(m_DS.FaceValueFI, money(m_DS.OverAmount - m_DS.OldOverAmount)));
  END;

  MACRO A3_21()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO InitDataSet()
    m_RSD = RSDCommand( "select issuer.t_Name IssuerName, fi.t_Issuer, fi.t_FIID, fi.t_FI_Code, avr.t_LSIN, fi.t_FaceValueFI, wrtsum.t_Date DealDate, wrtsum.t_Time, " +
                        "       wrtsum.t_Amount, wrtsum.t_Portfolio, wrtsum.t_Sum, wrtsum.t_Currency, (wrtsum.t_BalanceCost - wrtsum.t_NKDAmount - wrtsum.t_InterestIncome) BalanceCost, " +
                        "       (wrtsum.t_BalanceCost - wrtsum.t_NKDAmount - wrtsum.t_InterestIncome - wrtsum.t_DiscountIncome - wrtsum.t_Cost) OverAmount, " +
                        "       NVL((select (t_BalanceCost - t_NKDAmount - t_InterestIncome - t_DiscountIncome - t_Cost)*wrtsum.t_amount/t_amount  " +
                        "              from V_SCWRTHISTEX " +
                        "             where     t_SumID = wrtsum.t_SumID " +
                        "                   and t_Instance = ( select max(t_Instance) " +
                        "                                        from V_SCWRTHIST " +
                        "                                       where     t_SumID = wrtsum.t_SumID " +
                        "                                             and t_ChangeDate <= ? )), 0) t_OldOverAmount " +
                        "  from V_SCWRTHISTEX wrtsum, dfininstr_dbt fi, davoiriss_dbt avr, dparty_dbt issuer " +
                        " where     fi.t_FIID = wrtsum.t_FIID " +
                        "       and avr.t_FIID = fi.t_FIID " +
                        "       and issuer.t_PartyID = fi.t_Issuer " + 
                        "       and RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) = " + AVOIRISSKIND_SHARE +
                        "       and wrtsum.t_Trust = '" + SET_CHAR + "' " +
                        "       and wrtsum.t_Instance = ( select max(t_Instance) " +
                        "                                   from V_SCWRTHIST " +
                        "                                  where     t_SumID = wrtsum.t_SumID " +
                        "                                        and t_ChangeDate <= ? ) " +
                        "       and wrtsum.t_Date <= ?  " +
                        "       and wrtsum.t_IsFree = '" + SET_CHAR + "' " +
                        "       and ((wrtsum.T_Party = ?) OR (-1 = ?))" +
                        "       and ((wrtsum.t_Contract = ?) OR (-1 = ?)) " +
                        " order by fi.t_Issuer, fi.t_FIID; " );
    m_RSD.addParam("", RSDBP_IN, m_Report.m_BeginDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.execute();

    m_DS = TRsbDataSet( m_RSD );

    return m_DS.MoveNext();
  END;

  MACRO CalcData()
    VAR ТСС_Kind = ДУ_ПолучитьВидКурса(TS_RATETYPE_TSS);
    m_TCC = GetRateOnDate( m_Report.m_EndDate, m_DS.FIID, m_DS.FaceValueFI, false, ТСС_Kind );
    m_TCC_Old = GetRateOnDate( m_Report.m_BeginDate, m_DS.FIID, m_DS.FaceValueFI, false, ТСС_Kind );
  END;

  MACRO PrintHeadTable()

    m_Report.PrintFormatString( ReportHeader,
                                "H3_1", m_Report.Department(),
                                "H3_2", "Состав портфеля акций ДУ " + m_Report.GetPartyName({OurBank}),
                                "H3_3", m_Report.ReportPeriod( true )
                              );
    m_Report.CopyAllSheetInTotalBook( "Портфель акций", false, "H3_Head", 1 );

    m_Report.PrintFormatString( ReportHeader,
                                "H3_4", m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Портфель акций", false, "H3_Table", 1 );
  END;

  MACRO RegisterTable()
    m_Report.RegisterTable( "MainTable_3", TableHeader,
                            "A3_1",
                            "A3_2",
                            "A3_3",
                            "A3_4",
                            "A3_5",
                            "A3_6",
                            "A3_7",
                            "A3_9",
                            "A3_10",
                            "A3_11",
                            "A3_12",
                            "A3_13",
                            "A3_14",
                            "A3_15",
                            "A3_16",
                            "A3_17",
                            "A3_18",
                            "A3_19",
                            "A3_20",
                            "A3_21"
                           );
  END;

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( "Портфель акций", false, m_Report.GetTableRange(), 0 );
  END;


  MACRO PrintLine()
    m_Report.PrintTableLine( "A3_1",    A3_1(),       null,
                             "A3_2",    A3_2(),       null,
                             "A3_3",    A3_3(),       null,
                             "A3_4",    A3_4(),       null,
                             "A3_5",    A3_5(),       null,
                             "A3_6",    A3_6(),       null,
                             "A3_7",    A3_7(),       null,
                             "A3_9",    A3_9(),       null,
                             "A3_10",   A3_10(),      null,
                             "A3_11",   A3_11(),      null,
                             "A3_12",   A3_12(),      null,
                             "A3_13",   A3_13(),      null,
                             "A3_14",   A3_14(),      null,
                             "A3_15",   A3_15(),      null,
                             "A3_16",   A3_16(),      null,
                             "A3_17",   A3_17(),      null,
                             "A3_18",   A3_18(),      null,
                             "A3_19",   A3_19(),      null,
                             "A3_20",   A3_20(),      null,
                             "A3_21",   A3_21(),      null
                            );
  END;

  MACRO PrintAvrItogLine()
    m_A3_1_2.SetFirst();
    m_A3_1_3.SetFirst();
    m_A3_1_5.SetFirst();
    m_A3_1_7.SetFirst();
    m_A3_1_9.SetFirst();
    m_A3_1_11.SetFirst();

    while( m_A3_1_2.Next() )  
      m_A3_1_3.Next();
      m_A3_1_5.Next();
      m_A3_1_7.Next();
      m_A3_1_9.Next();
      m_A3_1_11.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A3_1_1",    m_A3_1_1,
                                  "A3_1_2",    m_A3_1_2.GetSum(),
                                  "A3_1_3",    m_A3_1_3.GetSum(),
                                  "A3_1_4",    ПолучитьКодФинИн(m_A3_1_3.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_1_5",    m_A3_1_5.GetSum(),
                                  "A3_1_6",    ПолучитьКодФинИн(m_A3_1_5.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_1_7",    m_A3_1_7.GetSum(),
                                  "A3_1_8",    ПолучитьКодФинИн(m_A3_1_7.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_1_9",    m_A3_1_9.GetSum(),
                                  "A3_1_10",   ПолучитьКодФинИн(m_A3_1_9.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_1_11",   m_A3_1_11.GetSum(),
                                  "A3_1_12",   ПолучитьКодФинИн(m_A3_1_11.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель акций", false, "MainTable_3_1", 0 );
    end;
    m_A3_1_2.Clear();
    m_A3_1_3.Clear();
    m_A3_1_5.Clear();
    m_A3_1_7.Clear();
    m_A3_1_9.Clear();
    m_A3_1_11.Clear();
  END;

  MACRO PrintClientItogLine()
    m_A3_2_1.SetFirst();
    m_A3_2_3.SetFirst();
    m_A3_2_5.SetFirst();
    m_A3_2_7.SetFirst();
    m_A3_2_9.SetFirst();

    while( m_A3_2_1.Next() )  
      m_A3_2_3.Next();
      m_A3_2_5.Next();
      m_A3_2_7.Next();
      m_A3_2_9.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A3_2_1",    m_A3_2_1.GetSum(),
                                  "A3_2_2",    ПолучитьКодФинИн(m_A3_2_1.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_2_3",    m_A3_2_3.GetSum(),
                                  "A3_2_4",    ПолучитьКодФинИн(m_A3_2_3.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_2_5",    m_A3_2_5.GetSum(),
                                  "A3_2_6",    ПолучитьКодФинИн(m_A3_2_5.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_2_7",    m_A3_2_7.GetSum(),
                                  "A3_2_8",    ПолучитьКодФинИн(m_A3_2_7.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A3_2_9",    m_A3_2_9.GetSum(),
                                  "A3_2_10",   ПолучитьКодФинИн(m_A3_2_9.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель акций", false, "MainTable_3_2", 0 );
    end;
    m_A3_2_1.Clear();
    m_A3_2_3.Clear();
    m_A3_2_5.Clear();
    m_A3_2_7.Clear();
    m_A3_2_9.Clear();
  END;

  MACRO BeginReport()
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( "Портфель акций" );
  END;

  MACRO Execute()
    var ExistData = false, whileFlag = false, FIID;
    m_Report.TSOrderList();

    while( m_Report.TsOrderNext() )
       ExistData = InitDataSet();
       whileFlag = ExistData;
       FIID = m_DS.FIID;

       if( ExistData )
          ExistPrintSharePortf = true;
          PrintHeadTable();
          RegisterTable();
       end;

       while( whileFlag )
          m_A3_1_1 = "Итого " + trim(string(m_DS.IssuerName)) + ", " + trim(string(m_DS.FI_Code));
          CalcData();
          PrintLine();
          whileFlag = m_DS.MoveNext();
          if( FIID != m_DS.FIID )
             EndTable();
             PrintAvrItogLine();
             RegisterTable();
             FIID = m_DS.FIID;
          end;
       end;

       if( ExistData )
          EndTable();
          PrintAvrItogLine();
          PrintClientItogLine();
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
    if( ExistPrintSharePortf == true )
       m_Report.AddStandardFooter( "N3_" );
       m_Report.CopyAllSheetInTotalBook( "Портфель акций", false, "H3_Footer", 1 );
    end;
  END;

END;

/********************************************************************************
Класс для шаблона "Портфель облигаций"
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_BondPortf( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_RSD, m_DS, m_TCC, m_TCC_Old, m_OldInterestIncome, m_OldDiscountIncome, m_InterestIncomeOnBuyDate, m_DiscountIncomeOnBuyDate, m_RetInterestIncome, m_RetDiscountIncome, m_AllRetInterestIncome, m_AllRetDiscountIncome, m_NKDAmount;
  VAR m_A4_1_1, m_A4_1_2:TArraySum, m_A4_1_3:TArraySum, m_A4_1_5:TArraySum, m_A4_1_7:TArraySum, m_A4_1_9:TArraySum, m_A4_1_11:TArraySum, m_A4_1_13:TArraySum,
      m_A4_1_15:TArraySum, m_A4_1_17:TArraySum, m_A4_1_19:TArraySum, m_A4_1_21:TArraySum, m_A4_1_23:TArraySum, m_A4_1_25:TArraySum, m_A4_1_27:TArraySum,
      m_A4_1_29:TArraySum;
  VAR m_A4_2_1:TArraySum, m_A4_2_3:TArraySum, m_A4_2_5:TArraySum, m_A4_2_7:TArraySum, m_A4_2_9:TArraySum, m_A4_2_11:TArraySum, m_A4_2_13:TArraySum, 
      m_A4_2_15:TArraySum, m_A4_2_17:TArraySum, m_A4_2_19:TArraySum, m_A4_2_21:TArraySum, m_A4_2_23:TArraySum, m_A4_2_25:TArraySum, m_A4_2_27:TArraySum;


  MACRO A4_1()
    return trim(string(m_DS.IssuerName));
  END;

  MACRO A4_2()
    return trim(string(m_DS.FI_Code));
  END;

  MACRO A4_3()
    return trim(string(m_DS.LSIN));
  END;

  MACRO A4_4()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_5()
    return date(m_DS.DealDate);
  END;

  MACRO A4_6()
    return time(m_DS.Time);
  END;

  MACRO A4_7()
    return m_A4_1_2.Add(m_DS.FaceValueFI, money(m_DS.Amount))
  END;

  MACRO A4_8()
    return "";
  END;

  MACRO A4_9()
    return double(m_DS.Sum/m_DS.Amount);
  END;

  MACRO A4_10()
    return m_A4_2_1.Add(m_DS.FaceValueFI, m_A4_1_3.Add(m_DS.FaceValueFI, money(m_DS.Sum)));
  END;

  MACRO A4_11()
    return ПолучитьКодФинИн(m_DS.Currency, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_12()
    return double(m_TCC);
  END;

  MACRO A4_13()
    return m_A4_2_3.Add(m_DS.FaceValueFI, m_A4_1_5.Add(m_DS.FaceValueFI, money(m_TCC*m_DS.Amount)));
  END;

  MACRO A4_14()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_15()
    return double(m_DS.BalanceCost/m_DS.Amount);
  END;

  MACRO A4_16()
    return m_A4_2_5.Add(m_DS.FaceValueFI, m_A4_1_7.Add(m_DS.FaceValueFI, money(m_DS.BalanceCost)));
  END;

  MACRO A4_17()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_18()
    return m_A4_2_7.Add(m_DS.FaceValueFI, m_A4_1_9.Add(m_DS.FaceValueFI, money(m_DS.OverAmount)));
  END;

  MACRO A4_19()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_20()
    return m_A4_2_9.Add(m_DS.FaceValueFI, m_A4_1_11.Add(m_DS.FaceValueFI, money(m_DS.OverAmount - m_DS.OldOverAmount)));
  END;

  MACRO A4_21()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_22()
    return m_A4_2_11.Add(m_DS.FaceValueFI, m_A4_1_13.Add(m_DS.FaceValueFI, money(m_NKDAmount)));
  END;

  MACRO A4_23()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_24()
    return m_A4_2_13.Add(m_DS.FaceValueFI, m_A4_1_15.Add(m_DS.FaceValueFI, money(m_DS.InterestIncome + m_AllRetInterestIncome - m_InterestIncomeOnBuyDate)));
  END;

  MACRO A4_25()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_26()
    return m_A4_2_15.Add(m_DS.FaceValueFI, m_A4_1_17.Add(m_DS.FaceValueFI, money(m_DS.InterestIncome - m_OldInterestIncome + m_RetInterestIncome)));
  END;

  MACRO A4_27()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_28()
    return m_A4_2_17.Add(m_DS.FaceValueFI, m_A4_1_19.Add(m_DS.FaceValueFI, money(m_RetInterestIncome)));
  END;

  MACRO A4_29()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_30()
    return m_A4_2_19.Add(m_DS.FaceValueFI, m_A4_1_21.Add(m_DS.FaceValueFI, money(m_AllRetInterestIncome)));
  END;

  MACRO A4_31()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_32()
    return m_A4_2_21.Add(m_DS.FaceValueFI, m_A4_1_23.Add(m_DS.FaceValueFI, money(m_DS.DiscountIncome + m_AllRetDiscountIncome)));
  END;

  MACRO A4_33()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_34()
    return m_A4_2_23.Add(m_DS.FaceValueFI, m_A4_1_25.Add(m_DS.FaceValueFI, money(m_DS.DiscountIncome - m_OldDiscountIncome + m_RetDiscountIncome)));
  END;

  MACRO A4_35()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_36()
    return m_A4_2_25.Add(m_DS.FaceValueFI, m_A4_1_27.Add(m_DS.FaceValueFI, money(m_RetDiscountIncome)));
  END;

  MACRO A4_37()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A4_38()
    return m_A4_2_27.Add(m_DS.FaceValueFI, m_A4_1_29.Add(m_DS.FaceValueFI, money(m_AllRetDiscountIncome)));
  END;

  MACRO A4_39()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO InitDataSet()
    m_RSD = RSDCommand( "select issuer.t_Name IssuerName, fi.t_Issuer, fi.t_FIID, fi.t_FI_Code, avr.t_LSIN, fi.t_FaceValueFI, wrtsum.t_Date DealDate, wrtsum.t_Time, " +
                        "       wrtsum.t_Amount, wrtsum.t_Portfolio, wrtsum.t_Sum, wrtsum.t_Currency, (wrtsum.t_BalanceCost - wrtsum.t_NKDAmount - wrtsum.t_InterestIncome) BalanceCost, " +
                        "       (wrtsum.t_BalanceCost - wrtsum.t_NKDAmount - wrtsum.t_InterestIncome - wrtsum.t_DiscountIncome - wrtsum.t_Cost) OverAmount, wrtsum.t_DealID, " +
                        "       NVL((select ((t_BalanceCost - t_NKDAmount - t_InterestIncome - t_DiscountIncome - t_Cost)/t_Amount * wrtsum.t_Amount) " +
                        "              from V_SCWRTHISTEX " +
                        "             where     t_SumID = wrtsum.t_SumID " +
                        "                   and t_Instance = ( select max(t_Instance) " +
                        "                                        from V_SCWRTHIST " +
                        "                                       where     t_SumID = wrtsum.t_SumID " +
                        "                                             and t_ChangeDate <= ? )), 0) t_OldOverAmount, " +
                        "       wrtsum.t_NKDAmount, wrtsum.t_InterestIncome, wrtsum.t_DiscountIncome, wrtsum.t_SumID " +
                        "  from V_SCWRTHISTEX wrtsum, dfininstr_dbt fi, davoiriss_dbt avr, dparty_dbt issuer " +
                        " where     fi.t_FIID = wrtsum.t_FIID " +
                        "       and avr.t_FIID = fi.t_FIID " +
                        "       and issuer.t_PartyID = fi.t_Issuer " + 
                        "       and RSB_FIInstr.FI_AvrKindsGetRoot(fi.t_FI_Kind, fi.t_AvoirKind) = " + AVOIRISSKIND_BOND +
                        "       and wrtsum.t_Trust = '" + SET_CHAR + "' " +
                        "       and wrtsum.t_Instance = ( select max(t_Instance) " +
                        "                                   from V_SCWRTHIST " +
                        "                                  where     t_SumID = wrtsum.t_SumID " +
                        "                                        and t_ChangeDate <= ? ) " +
                        "       and wrtsum.t_Date <= ?  " +
                        "       and wrtsum.t_IsFree = '" + SET_CHAR + "' " +
                        "       and ((wrtsum.T_Party = ?) OR (-1 = ?))" +
                        "       and ((wrtsum.t_Contract = ?) OR (-1 = ?)) " +
                        " order by fi.t_Issuer, fi.t_FIID; " );
    m_RSD.addParam("", RSDBP_IN, m_Report.m_BeginDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.execute();

    m_DS = TRsbDataSet( m_RSD );

    return m_DS.MoveNext();
  END;

  MACRO CalcData()
    VAR rsd, ds;
    VAR ТСС_Kind = ДУ_ПолучитьВидКурса(TS_RATETYPE_TSS);
    m_TCC_Old = GetRateOnDate( m_Report.m_BeginDate, m_DS.FIID, m_DS.FaceValueFI, false, ТСС_Kind );
    m_TCC     = GetRateOnDate( m_Report.m_EndDate, m_DS.FIID, m_DS.FaceValueFI, false, ТСС_Kind );
    rsd = RSDCommand( "select NVL(wrtsum.t_InterestIncome/wrtsum.t_Amount*?, 0) t_OldInterestIncome, NVL(wrtsum.t_DiscountIncome/wrtsum.t_Amount*?, 0) t_OldDiscountIncome" +
                      "  from V_SCWRTHISTEX wrtsum" +
                      " where     wrtsum.t_SumID = ? " +
                      "       and wrtsum.t_Instance = ( select max(t_Instance) " +
                      "                                   from V_SCWRTHIST " +
                      "                                  where     t_SumID = wrtsum.t_SumID " +
                      "                                        and t_ChangeDate < ? )" );                                                                                      
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.SumID);
    rsd.addParam("", RSDBP_IN, m_Report.m_BeginDate);
    rsd.execute();

    ds = TRsbDataSet( rsd );

    if( ds.MoveNext() )
       m_OldInterestIncome = ds.OldInterestIncome;
       m_OldDiscountIncome = ds.OldDiscountIncome;
    else
       m_OldInterestIncome = m_OldDiscountIncome = 0;
    end;

    rsd = RSDCommand( " select (case when w0.t_Amount > 0 then NVL(w0.t_InterestIncome/w0.t_Amount*?,0) else 0 end) OldInterestIncome, " +                                     
                      "        (case when w0.t_Amount > 0 then NVL(w0.t_DiscountIncome/w0.t_Amount*?,0) else 0 end) OldDiscountIncome  " +                                     
                      "  from v_scwrthist w0    "+                                                                                                                             
                      " where w0.t_SumID = ?    "+                                                                                                                             
                      "   AND w0.t_instance = (SELECT min (ws.t_instance) "+                                                                                                   
                      "                          FROM v_scwrthist ws "+                                                                                                        
                      "                         WHERE ws.t_SumID = w0.t_SumID "+                                                                                               
                      "                           AND ws.t_State = 1)"                                                                                                         
                     );                                                                                                                                                        
    rsd.addParam("", RSDBP_IN, m_DS.Amount);                                                                                                                                   
    rsd.addParam("", RSDBP_IN, m_DS.Amount);                                                                                                                                   
    rsd.addParam("", RSDBP_IN, m_DS.SumID);                                                                                                                                    
                                                                                                                
    rsd.execute();

    ds = TRsbDataSet( rsd );

    if( ds.MoveNext() )
       m_InterestIncomeOnBuyDate = ds.OldInterestIncome;
       m_DiscountIncomeOnBuyDate = ds.OldDiscountIncome;
    else
       m_InterestIncomeOnBuyDate = m_DiscountIncomeOnBuyDate = 0;
    end;

    rsd = RSDCommand( "select NVL(SUM(NVL(lnk.t_NKDSaleAmount/lnk.t_Amount*?,0)),0) RetInterestIncome, NVL(SUM(NVL(lnk.t_DiscountIncomeBuy/lnk.t_Amount*?,0) + NVL(lnk.t_DiscountIncomeAdd/lnk.t_Amount*?,0)),0) RetDiscountIncome " +
                      "  from dpmwrtlnk_dbt lnk" +
                      " where     lnk.t_BuyID = ? " +
                      "       and lnk.t_CreateDate >= ? " +
                      "       and lnk.t_CreateDate <= ? " +
                      "       and lnk.t_Kind in (" + PMWRTLINK_KIND_RETCOUPON + ", " + PMWRTLINK_KIND_RETPARTLY + ") " );
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.SumID);
    rsd.addParam("", RSDBP_IN, m_Report.m_BeginDate);
    rsd.addParam("", RSDBP_IN, m_Report.m_EndDate);
    rsd.execute();

    ds = TRsbDataSet( rsd );

    if( ds.MoveNext() )
       m_RetInterestIncome = ds.RetInterestIncome;
       m_RetDiscountIncome = ds.RetDiscountIncome;
    else
       m_RetInterestIncome = m_RetDiscountIncome = 0;
    end;

    rsd = RSDCommand( "select NVL(SUM(NVL(lnk.t_NKDSaleAmount/lnk.t_Amount*?,0)),0) AllRetInterestIncome, NVL(SUM(NVL(lnk.t_DiscountIncomeBuy/lnk.t_Amount*?,0) + NVL(lnk.t_DiscountIncomeAdd/lnk.t_Amount*?,0)),0) AllRetDiscountIncome " +
                      "  from dpmwrtlnk_dbt lnk" +
                      " where     lnk.t_BuyID = ? " +
                      "       and lnk.t_CreateDate <= ? " +
                      "       and lnk.t_Kind in (" + PMWRTLINK_KIND_RETCOUPON + ", " + PMWRTLINK_KIND_RETPARTLY + ") " );
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.SumID);
    rsd.addParam("", RSDBP_IN, m_Report.m_EndDate);
    rsd.execute();

    ds = TRsbDataSet( rsd );

    if( ds.MoveNext() )
       m_AllRetInterestIncome = ds.AllRetInterestIncome;
       m_AllRetDiscountIncome = ds.AllRetDiscountIncome;
    else
       m_AllRetInterestIncome = m_AllRetDiscountIncome = 0;
    end;

    rsd = RSDCommand( "select (CASE WHEN t_Principal > 0 THEN NVL((t_NKD/t_Principal*?), 0) ELSE 0 END) NKDAmount " +
                      "  from ddl_leg_dbt " +
                      " where     t_DealID = ? " +
                      "       and t_LegID = 0 " +
                      "       and t_LegKind = ?"  );
    rsd.addParam("", RSDBP_IN, m_DS.Amount);
    rsd.addParam("", RSDBP_IN, m_DS.DealID);
    rsd.addParam("", RSDBP_IN, LEG_KIND_DL_TICK);
    rsd.execute();

    ds = TRsbDataSet( rsd );

    if( ds.MoveNext() )
       m_NKDAmount = ds.NKDAmount;
    else
       m_NKDAmount = 0;
    end;
  
  END;

  MACRO PrintAvrItogLine()

    m_A4_1_2.SetFirst();
    m_A4_1_3.SetFirst();
    m_A4_1_5.SetFirst();
    m_A4_1_7.SetFirst();
    m_A4_1_9.SetFirst();
    m_A4_1_11.SetFirst();
    m_A4_1_13.SetFirst();
    m_A4_1_15.SetFirst();
    m_A4_1_17.SetFirst();
    m_A4_1_19.SetFirst();
    m_A4_1_21.SetFirst();
    m_A4_1_23.SetFirst();
    m_A4_1_25.SetFirst();
    m_A4_1_27.SetFirst();
    m_A4_1_29.SetFirst();

    while( m_A4_1_2.Next() )  
      m_A4_1_3.Next();
      m_A4_1_5.Next();
      m_A4_1_7.Next();
      m_A4_1_9.Next();
      m_A4_1_11.Next();
      m_A4_1_13.Next();
      m_A4_1_15.Next();
      m_A4_1_17.Next();
      m_A4_1_19.Next();
      m_A4_1_21.Next();
      m_A4_1_23.Next();
      m_A4_1_25.Next();
      m_A4_1_27.Next();
      m_A4_1_29.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A4_1_1",    m_A4_1_1,
                                  "A4_1_2",    m_A4_1_2.GetSum(),
                                  "A4_1_3",    m_A4_1_3.GetSum(),
                                  "A4_1_4",    ПолучитьКодФинИн(m_A4_1_3.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_5",    m_A4_1_5.GetSum(),
                                  "A4_1_6",    ПолучитьКодФинИн(m_A4_1_5.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_7",    m_A4_1_7.GetSum(),
                                  "A4_1_8",    ПолучитьКодФинИн(m_A4_1_7.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_9",    m_A4_1_9.GetSum(),
                                  "A4_1_10",   ПолучитьКодФинИн(m_A4_1_9.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_11",   m_A4_1_11.GetSum(),
                                  "A4_1_12",   ПолучитьКодФинИн(m_A4_1_11.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_13",   m_A4_1_13.GetSum(),
                                  "A4_1_14",   ПолучитьКодФинИн(m_A4_1_13.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_15",   m_A4_1_15.GetSum(),
                                  "A4_1_16",   ПолучитьКодФинИн(m_A4_1_15.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_17",   m_A4_1_17.GetSum(),
                                  "A4_1_18",   ПолучитьКодФинИн(m_A4_1_17.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_19",   m_A4_1_19.GetSum(),
                                  "A4_1_20",   ПолучитьКодФинИн(m_A4_1_19.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_21",   m_A4_1_21.GetSum(),
                                  "A4_1_22",   ПолучитьКодФинИн(m_A4_1_21.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_23",   m_A4_1_23.GetSum(),
                                  "A4_1_24",   ПолучитьКодФинИн(m_A4_1_23.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_25",   m_A4_1_25.GetSum(),
                                  "A4_1_26",   ПолучитьКодФинИн(m_A4_1_25.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_27",   m_A4_1_27.GetSum(),
                                  "A4_1_28",   ПолучитьКодФинИн(m_A4_1_27.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_1_29",   m_A4_1_29.GetSum(),
                                  "A4_1_30",   ПолучитьКодФинИн(m_A4_1_29.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель облигаций", false, "MainTable_4_1", 0 );
    end;
    m_A4_1_2.Clear();
    m_A4_1_3.Clear();
    m_A4_1_5.Clear();
    m_A4_1_7.Clear();
    m_A4_1_9.Clear();
    m_A4_1_11.Clear();
    m_A4_1_13.Clear();
    m_A4_1_15.Clear();
    m_A4_1_17.Clear();
    m_A4_1_19.Clear();
    m_A4_1_21.Clear();
    m_A4_1_23.Clear();
    m_A4_1_25.Clear();
    m_A4_1_27.Clear();
    m_A4_1_29.Clear();
  END;

  MACRO PrintClientItogLine()
    m_A4_2_1.SetFirst();
    m_A4_2_3.SetFirst();
    m_A4_2_5.SetFirst();
    m_A4_2_7.SetFirst();
    m_A4_2_9.SetFirst();
    m_A4_2_11.SetFirst();
    m_A4_2_13.SetFirst();
    m_A4_2_15.SetFirst();
    m_A4_2_17.SetFirst();
    m_A4_2_19.SetFirst();
    m_A4_2_21.SetFirst();
    m_A4_2_23.SetFirst();
    m_A4_2_25.SetFirst();
    m_A4_2_27.SetFirst();
    while( m_A4_2_1.Next() )  
      m_A4_2_3.Next();
      m_A4_2_5.Next();
      m_A4_2_7.Next();
      m_A4_2_9.Next();
      m_A4_2_11.Next();
      m_A4_2_13.Next();
      m_A4_2_15.Next();
      m_A4_2_17.Next();
      m_A4_2_19.Next();
      m_A4_2_21.Next();
      m_A4_2_23.Next();
      m_A4_2_25.Next();
      m_A4_2_27.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A4_2_1",    m_A4_2_1.GetSum(),
                                  "A4_2_2",    ПолучитьКодФинИн(m_A4_2_1.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_3",    m_A4_2_3.GetSum(),
                                  "A4_2_4",    ПолучитьКодФинИн(m_A4_2_3.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_5",    m_A4_2_5.GetSum(),
                                  "A4_2_6",    ПолучитьКодФинИн(m_A4_2_5.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_7",    m_A4_2_7.GetSum(),
                                  "A4_2_8",    ПолучитьКодФинИн(m_A4_2_7.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_9",    m_A4_2_9.GetSum(),
                                  "A4_2_10",   ПолучитьКодФинИн(m_A4_2_9.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_11",   m_A4_2_11.GetSum(),
                                  "A4_2_12",   ПолучитьКодФинИн(m_A4_2_11.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_13",   m_A4_2_13.GetSum(),
                                  "A4_2_14",   ПолучитьКодФинИн(m_A4_2_13.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_15",   m_A4_2_15.GetSum(),
                                  "A4_2_16",   ПолучитьКодФинИн(m_A4_2_15.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_17",   m_A4_2_17.GetSum(),
                                  "A4_2_18",   ПолучитьКодФинИн(m_A4_2_17.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_19",   m_A4_2_19.GetSum(),
                                  "A4_2_20",   ПолучитьКодФинИн(m_A4_2_19.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_21",   m_A4_2_21.GetSum(),
                                  "A4_2_22",   ПолучитьКодФинИн(m_A4_2_21.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_23",   m_A4_2_23.GetSum(),
                                  "A4_2_24",   ПолучитьКодФинИн(m_A4_2_23.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_25",   m_A4_2_25.GetSum(),
                                  "A4_2_26",   ПолучитьКодФинИн(m_A4_2_25.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A4_2_27",   m_A4_2_27.GetSum(),
                                  "A4_2_28",   ПолучитьКодФинИн(m_A4_2_27.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Портфель облигаций", false, "MainTable_4_2", 0 );
    end;
    m_A4_2_1.Clear();
    m_A4_2_3.Clear();
    m_A4_2_5.Clear();
    m_A4_2_7.Clear();
    m_A4_2_9.Clear();
    m_A4_2_11.Clear();
    m_A4_2_13.Clear();
    m_A4_2_15.Clear();
    m_A4_2_17.Clear();
    m_A4_2_19.Clear();
    m_A4_2_21.Clear();
    m_A4_2_23.Clear();
    m_A4_2_25.Clear();
    m_A4_2_27.Clear();
  END;

  MACRO PrintHeadTable()

    m_Report.PrintFormatString( ReportHeader,
                                "H4_1", m_Report.Department(),
                                "H4_2", "Состав портфеля облигаций ДУ " + m_Report.GetPartyName({OurBank}),
                                "H4_3", m_Report.ReportPeriod( true )
                              );
    m_Report.CopyAllSheetInTotalBook( "Портфель облигаций", false, "H4_Head", 1 );

    m_Report.PrintFormatString( ReportHeader,
                                "H4_4", m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Портфель облигаций", false, "H4_Table", 1 );
  END;

  MACRO RegisterTable()
    m_Report.RegisterTable( "MainTable_4", TableHeader,
                            "A4_1",
                            "A4_2",
                            "A4_3",
                            "A4_4",
                            "A4_5",
                            "A4_6",
                            "A4_7",
                            "A4_9",
                            "A4_10",
                            "A4_11",
                            "A4_12",
                            "A4_13",
                            "A4_14",
                            "A4_15",
                            "A4_16",
                            "A4_17",
                            "A4_18",
                            "A4_19",
                            "A4_20",
                            "A4_21",
                            "A4_22",
                            "A4_23",
                            "A4_24",
                            "A4_25",
                            "A4_26",
                            "A4_27",
                            "A4_28",
                            "A4_29",
                            "A4_30",
                            "A4_31",
                            "A4_32",
                            "A4_33",
                            "A4_34",
                            "A4_35",
                            "A4_36",
                            "A4_37",
                            "A4_38",
                            "A4_39"
                           );
  END;

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( "Портфель облигаций", false, m_Report.GetTableRange(), 0 );
  END;

  MACRO PrintLine()
    m_Report.PrintTableLine( "A4_1",     A4_1(),        null,
                             "A4_2",     A4_2(),        null,
                             "A4_3",     A4_3(),        null,
                             "A4_4",     A4_4(),        null,
                             "A4_5",     A4_5(),        null,
                             "A4_6",     A4_6(),        null,
                             "A4_7",     A4_7(),        null,
                             "A4_9",     A4_9(),        null,
                             "A4_10",    A4_10(),       null,
                             "A4_11",    A4_11(),       null,
                             "A4_12",    A4_12(),       null,
                             "A4_13",    A4_13(),       null,
                             "A4_14",    A4_14(),       null,
                             "A4_15",    A4_15(),       null,
                             "A4_16",    A4_16(),       null,
                             "A4_17",    A4_17(),       null,
                             "A4_18",    A4_18(),       null,
                             "A4_19",    A4_19(),       null,
                             "A4_20",    A4_20(),       null,
                             "A4_21",    A4_21(),       null,
                             "A4_22",    A4_22(),       null,
                             "A4_23",    A4_23(),       null,
                             "A4_24",    A4_24(),       null,
                             "A4_25",    A4_25(),       null,
                             "A4_26",    A4_26(),       null,
                             "A4_27",    A4_27(),       null,
                             "A4_28",    A4_28(),       null,
                             "A4_29",    A4_29(),       null,
                             "A4_30",    A4_30(),       null,
                             "A4_31",    A4_31(),       null,
                             "A4_32",    A4_32(),       null,
                             "A4_33",    A4_33(),       null,
                             "A4_34",    A4_34(),       null,
                             "A4_35",    A4_35(),       null,
                             "A4_36",    A4_36(),       null,
                             "A4_37",    A4_37(),       null,
                             "A4_38",    A4_38(),       null,
                             "A4_39",    A4_39(),       null
                            );
  END;

  MACRO BeginReport()
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( "Портфель облигаций" );
  END;

  MACRO Execute()
    var ExistData = false, whileFlag = false, FIID;
    m_Report.TSOrderList();

    while( m_Report.TsOrderNext() )
       ExistData = InitDataSet();
       whileFlag = ExistData;
       FIID = m_DS.FIID;

       if( ExistData )
          ExistPrintBondPortf = true;
          PrintHeadTable();
          RegisterTable();
       end;

       while( whileFlag )
          m_A4_1_1 = "Итого " + trim(string(m_DS.IssuerName)) + ", " + trim(string(m_DS.FI_Code));
          CalcData();
          PrintLine();
          whileFlag = m_DS.MoveNext();
          if( FIID != m_DS.FIID )
             EndTable();
             PrintAvrItogLine();
             RegisterTable();
             FIID = m_DS.FIID;
          end;
       end;

       if( ExistData )
          EndTable();
          PrintAvrItogLine();
          PrintClientItogLine();
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
    if( ExistPrintBondPortf == true )
       m_Report.AddStandardFooter( "N4_" );
       m_Report.CopyAllSheetInTotalBook( "Портфель облигаций", false, "H4_Footer", 1 );
    end;
  END;
END;

/********************************************************************************
Класс для шаблона "Сделки с векселями"
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_VADeal( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_RSD, m_DS, m_DocNumber, m_Group;
  VAR m_A5_1_1:TArraySum, m_A5_1_2:TArraySum;
  VAR m_A5_2_1:TArraySum, m_A5_2_2:TArraySum, m_A5_2_4:TArraySum, m_A5_2_5:TArraySum;
  VAR m_A5_3_1:TArraySum, m_A5_3_2:TArraySum;

  MACRO A5_1()
    return trim(string(m_DS.DealCode));
  END;

  MACRO A5_2()
    return date(m_DS.DealDate);
  END;

  MACRO A5_3()
    return trim(string(m_DS.IssuerName));
  END;

  MACRO A5_4()
    if( m_DS.Formula == VS_IN_DISCONT )
       return "Вексель дисконтный";
    elif( (m_DS.Formula == VS_IN_S_PC) or (m_DS.Formula == VS_IN_M_PC) )
       return "Вексель процентный";
    elif( m_DS.Formula == VS_IN_DISC_PC )
       return "Вексель процентно-дисконтный";
    end;
    return "";
  END;

  MACRO A5_5()
    return trim(string(m_DS.BCNumber) + " " + string(m_DS.BCSeries));
  END;

  MACRO A5_6()
    return date(m_DS.Start);
  END;

  MACRO A5_7()
    if( (m_DS.BCTermFormula == VS_TERMF_FIXEDDAY) OR (m_DS.BCTermFormula == VS_TERMF_INATIME) )
       return date(m_DS.Maturity);
    elif( m_DS.BCTermFormula == VS_TERMF_DURING )
       return date(m_DS.BCPresentationDate) + m_DS.Diff;
    else
       return "По предъявлении";
    end;
  END;

  MACRO A5_8()
    return money(m_DS.Principal);
  END;

  MACRO A5_9()
    if( IsBUY(m_Group) )
       return "Покупка";
    elif( IsSALE(m_Group) )
       return "Продажа"
    end;

    return "Погашение";
  END;

  MACRO A5_10()
    return trim(string(m_DS.ContragentName));
  END;

  MACRO A5_11()
    return trim(string(m_DocNumber));
  END;

  MACRO A5_12()
    if( IsBUY(m_Group) )
       return m_A5_2_1.Add( m_DS.PayFIID, m_A5_1_1.Add( m_DS.PayFIID, 1 ));
    elif( IsSALE(m_Group) )
       return m_A5_2_4.Add( m_DS.PayFIID, m_A5_1_1.Add( m_DS.PayFIID, 1 ));
    end;

    return m_A5_3_1.Add( m_DS.PayFIID, m_A5_1_1.Add( m_DS.PayFIID, 1 ));
  END;

  MACRO A5_13()
    if( IsBUY(m_Group) )
       return m_A5_2_2.Add( m_DS.PayFIID, m_A5_1_2.Add( m_DS.PayFIID, money(m_DS.BCCost)));
    elif( IsSALE(m_Group) )
       return m_A5_2_5.Add( m_DS.PayFIID, m_A5_1_2.Add( m_DS.PayFIID, money(m_DS.BCCost)));
    end;

    return m_A5_3_2.Add( m_DS.PayFIID, m_A5_1_2.Add( m_DS.PayFIID, money(m_DS.BCCost)));
  END;

  MACRO A5_14()
    return ПолучитьКодФинИн(m_DS.PayFIID, NULL, FICK_ISOSTRING);
  END;

  MACRO A5_15()
    return "внебиржевой рынок";
  END;

  MACRO A5_16()
    return string(date(m_DS.DealDate)) + "/" + string(date(m_DS.ValueDateBAi));
  END;

  MACRO A5_17()
    return string(date(m_DS.DealDate)) + "/" + string(date(m_DS.ValueDateCAi));
  END;

  MACRO InitDataSet()
    m_RSD = RSDCommand( "select tk.t_DealCode, tk.t_DealDate, tk.t_DealTime, tk.t_DealType, prtCont.t_ShortName ContragentName," +
                        "       prtIssue.t_Name IssuerName, bnr.t_BCFormKind, bnr.t_BCseries, bnr.t_BCID, vs.t_BCCFI, pm.t_PayFIID, " +
                        "       bnr.t_BCnumber, vs.t_BCCost, vs.t_LinkKind, tk.t_DealID, dl_leg.t_Formula, dl_leg.t_Start, bnr.t_BCPresentationDate," +
                        "       dl_leg.t_Maturity, dl_leg.t_Diff, bnr.t_BCTermFormula, dl_leg.t_Principal, dl_leg.t_PFI, tk.t_BofficeKind, " +
                        "       pm.t_ValueDate ValueDateCAi, pmBA.t_ValueDate ValueDateBAi"
                        "  from dvsordlnk_dbt vs, ddl_tick_dbt tk, dvsbanner_dbt bnr, dparty_dbt prtcont, dparty_dbt prtissue, " + 
                        "       doprkoper_dbt opr, dpmpaym_dbt pm, ddl_leg_dbt dl_leg, dpmpaym_dbt pmBA " +
                        " where     vs.t_ContractID = tk.t_DealID " +
                        "       and opr.t_Kind_Operation = tk.t_DealType " +
                        "       and pm.t_DocKind = tk.t_BOfficeKind " +
                        "       and pm.t_DocumentID = tk.t_DealID " +
                        "       and pm.t_Purpose = DECODE( tk.t_bofficekind," + DL_VATRUST + ", " + CAi + ", " + PM_PURP_PRINC_RET + ") " +
                        "       and pmBA.t_DocKind = tk.t_BOfficeKind " +
                        "       and pmBA.t_DocumentID = tk.t_DealID " +
                        "       and pmBA.t_Purpose = " + BAi + " " +
                        "       and opr.T_SysTypes not in ( 'X', 'XF', 'XW', 'WB', 'WS' ) " +
                        "       and bnr.t_BCID = vs.t_BCID " +
                        "       and prtCont.t_PartyID = tk.t_PartyID " +
                        "       and prtIssue.t_PartyID = vs.t_Issuer " +
                        "       and dl_leg.t_LegKind = " + string(LEG_KIND_VSBANNER) +
                        "       and dl_leg.t_DealID = bnr.t_BCID " + 
                        "       and dl_leg.t_LegID = 0 "
                        "       and tk.t_DealDate >= ? " +
                        "       and tk.t_DealDate <= ? " +
                        "       and tk.t_Department = ? " +
                        "       and bnr.t_BCFormKind = 1 " +
                        "       and tk.t_ClientID = ? " +
                        "       and tk.t_ClientContrID = ? " +
                        "       and tk.t_BOfficeKind in ( " + DL_VATRUST + ", " + DL_VATRREPAY + " ) " +
                        "order by tk.t_BOfficeKind, tk.t_DealDate, tk.T_DealID, vs.t_BCID" );
    m_RSD.addParam("", RSDBP_IN, m_Report.m_BeginDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_Dprt);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.execute();

    m_DS = TRsbDataSet( m_RSD );

    return m_DS.MoveNext();
  END;

  MACRO GetExtData()
    var ds;
    var rsd = RSDCommand( "select ground.t_XLD " +
                          "  from dspgrdoc_dbt doc, dspground_dbt ground " +
                          " where     doc.t_SourceDocKind = ? " + /*tk.t_BofficeKind*/
                          "       and doc.t_SourceDocID = ? " + /*tk.t_DealID*/
                          "       and ground.t_SPGroundID = doc.t_SPGroundID "
                          "       and ground.t_Kind = 26" );
    rsd.addParam("", RSDBP_IN, m_DS.BofficeKind);
    rsd.addParam("", RSDBP_IN, m_DS.DealID);
    rsd.execute();

    ds = TRSBDataSet(rsd);

    if( ds.MoveNext() )
       m_DocNumber = ds.XLD;
    else
       m_DocNumber = "";
    end;

    m_Group = GetOperationGroup(m_DS.DealType);
  END;

  MACRO PrintDealItogLine()
    m_A5_1_1.SetFirst();
    m_A5_1_2.SetFirst();
    while( m_A5_1_1.Next() )  
      m_A5_1_2.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A5_1_1",    m_A5_1_1.GetSum(),
                                  "A5_1_2",    m_A5_1_2.GetSum(),
                                  "A5_1_3",    ПолучитьКодФинИн(m_A5_1_2.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "MainTable_5_1", 0 );
    end;
    m_A5_1_1.Clear();
    m_A5_1_2.Clear();
  END;


  MACRO PrintBSDealsItogLine()
    var IsBuy = false, IsSale = false;

    m_A5_2_1.SetFirst();
    m_A5_2_2.SetFirst();
    m_A5_2_4.SetFirst();
    m_A5_2_5.SetFirst();

    IsBuy = m_A5_2_1.Next();
    IsSale = m_A5_2_4.Next();

    while( IsBuy OR IsSale ) 
 
      if( IsBuy )
         m_A5_2_2.Next();
         if( m_A5_2_2.GetSum() > 0. )                                                                         
            m_Report.PrintFormatString( ReportHeader,                                                         
                                        "A5_2_1",    m_A5_2_1.GetSum(),                                       
                                        "A5_2_2",    m_A5_2_2.GetSum(),                                       
                                        "A5_2_3",    ПолучитьКодФинИн(m_A5_2_2.GetCCy(), NULL, FICK_ISOSTRING)
                                      );                                                                      
            m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "MainTable_5_2_1", 0 );            
         end;                                                                                                 
      end;

      if( IsSale )
         m_A5_2_5.Next();                                                                                     
         if( m_A5_2_5.GetSum() > 0. )                                                                         
            m_Report.PrintFormatString( ReportHeader,                                                         
                                  "A5_2_4",    m_A5_2_4.GetSum(),
                                  "A5_2_5",    m_A5_2_5.GetSum(),
                                  "A5_2_6",    ПолучитьКодФинИн(m_A5_2_5.GetCCy(), NULL, FICK_ISOSTRING)
                                );
            m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "MainTable_5_2_2", 0 );            
         end;                                                                                                 
      end;

      IsBuy = m_A5_2_1.Next();
      IsSale = m_A5_2_4.Next();

    end;
    m_A5_2_1.Clear();
    m_A5_2_2.Clear();
    m_A5_2_4.Clear();
    m_A5_2_5.Clear();
  END;

  MACRO PrintRetDealsItogLine()
    m_A5_3_1.SetFirst();
    m_A5_3_2.SetFirst();
    while( m_A5_3_1.Next() )  
      m_A5_3_2.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A5_3_1",    m_A5_3_1.GetSum(),
                                  "A5_3_2",    m_A5_3_2.GetSum(),
                                  "A5_3_3",    ПолучитьКодФинИн(m_A5_3_2.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "MainTable_5_3", 0 );
    end;
    m_A5_3_1.Clear();
    m_A5_3_2.Clear();
  END;

  MACRO PrintSubHead()
    
    m_Report.PrintFormatString( ReportHeader,
                                "H5_1", m_Report.Department(),
                                "H5_2", "Сделки и операции с векселями за период " + m_Report.ReportPeriod( false )
                              );
    m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "H5_Head", 1 );
    
    m_Report.PrintFormatString( ReportHeader,
                                "H5_3", "Клиент: " + m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "H5_SubHead", 1 );
  END;

  MACRO PrintHeadTable()
    var str;
    if( m_DS.BOfficeKind == DL_VATRUST )
       str = "Внебиржевые сделки с неэмиссионными ценными бумагами ";
    else
       str = "Погашение неэмиссионных ценных бумаг ";
    end;

    m_Report.PrintFormatString( ReportHeader,
                                "H5_7", str + m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "H5_Table", 1 );
  END;

  MACRO RegisterTable()
    m_Report.RegisterTable( "MainTable_5", TableHeader,
                            "A5_1",
                            "A5_2",
                            "A5_3",
                            "A5_4",
                            "A5_5",
                            "A5_6",
                            "A5_7",
                            "A5_8",
                            "A5_9",
                            "A5_10",
                            "A5_11",
                            "A5_12",
                            "A5_13",
                            "A5_14",
                            "A5_15",
                            "A5_16",
                            "A5_17"
                           );
  END;

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, m_Report.GetTableRange(), 0 );
  END;


  MACRO PrintLine()
    m_Report.PrintTableLine( "A5_1",    A5_1(),       null,
                             "A5_2",    A5_2(),       null,
                             "A5_3",    A5_3(),       null,
                             "A5_4",    A5_4(),       null,
                             "A5_5",    A5_5(),       null,
                             "A5_6",    A5_6(),       null,
                             "A5_7",    A5_7(),       null,
                             "A5_8",    A5_8(),       null,
                             "A5_9",    A5_9(),       null,
                             "A5_10",   A5_10(),      null,
                             "A5_11",   A5_11(),      null,
                             "A5_12",   A5_12(),      null,
                             "A5_13",   A5_13(),      null,
                             "A5_14",   A5_14(),      null,
                             "A5_15",   A5_15(),      null,
                             "A5_16",   A5_16(),      null,
                             "A5_17",   A5_17(),      null
                            );
  END;

  MACRO BeginReport()
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( "Сделки с векселями" );
  END;

  MACRO Execute()
    var ExistData = false, whileFlag = false;
    var DealID, BOfficeKind;
    m_Report.TSOrderList();

    while( m_Report.TsOrderNext() )
       ExistData = InitDataSet();
       whileFlag = ExistData;

       if( ExistData )
          ExistPrintVADeal = true;
          PrintSubHead();
          PrintHeadTable();
          RegisterTable();
       end;

       while( whileFlag )
          DealID = m_DS.DealID;
          BOfficeKind = m_DS.BOfficeKind;
          GetExtData();
          PrintLine();
          whileFlag = m_DS.MoveNext();
          if( DealID != m_DS.DealID )
             EndTable();
             PrintDealItogLine();
             if( BOfficeKind != m_DS.BOfficeKind )
                PrintBSDealsItogLine();
                PrintHeadTable();
             end;
             RegisterTable();
          end;
       end;

       if( ExistData )
          EndTable();
          PrintDealItogLine();
          if( BOfficeKind == DL_VATRUST )
             PrintBSDealsItogLine();
          else
             PrintRetDealsItogLine();
          end;
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
    if( ExistPrintVADeal == true )
       m_Report.AddStandardFooter( "N5_" );
       m_Report.CopyAllSheetInTotalBook( "Сделки с векселями", false, "H5_Footer", 1 );
    end;
  END;

END;

/********************************************************************************
Класс для шаблона "Сделки с ценными бумагами"
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_SecurDeal( Report:OBJECT )
  VAR m_Report = Report;
  VAR m_RSD, m_DS, m_Group, m_DocNumber, m_SettlDate, m_PaymDate, m_MinRate, m_MaxRate;
  VAR m_A6_1_2:TArraySum, m_A6_1_4:TArraySum, m_A6_1_7:TArraySum, m_A6_1_9:TArraySum;
  VAR m_A6_2_2:TArraySum, m_A6_2_4:TArraySum, m_A6_2_7:TArraySum, m_A6_2_9:TArraySum;
  VAR m_A6_3_2:TArraySum, m_A6_3_4:TArraySum, m_A6_3_7:TArraySum, m_A6_3_9:TArraySum;

  MACRO A6_1()
    return trim(string(m_DS.DealCode));
  END;

  MACRO A6_2()
    return string(SQL_ConvTypeDate(m_DS.DealDate))+", "+string(SQL_ConvTypeTime(m_DS.DealTime));
  END;

  MACRO A6_3()
    return m_Report.ПолучитьВидЦБ( m_DS.AvoirKind );
  END;

  MACRO A6_4()
    return trim(string(m_DS.Issue)) + " / " + trim(string(m_DS.Series));
  END;

  MACRO A6_5()
    return m_Report.GetPartyName( m_DS.Issuer );
  END;

  MACRO A6_6()
    return trim(string(m_DS.FI_Code));
  END;

  MACRO A6_7()
    if( trim(string(m_DS.LSIN)) )
       return trim(string(m_DS.LSIN));
    else
       return trim(string(m_DS.ISIN));
    end;
  END;

  MACRO A6_8()
    if( IsBUY(m_Group) )
       return "Покупка";
    elif( IsSALE(m_Group) )
       return "Продажа"
    end;

    return "Погашение";
  END;

  MACRO A6_9()
    return iif( m_DS.BofficeKind == DL_TRUSTDOC, m_Report.GetPartyName( m_DS.PartyID, true ), "");
  END;

  MACRO A6_10()
    return trim(string(m_DocNumber));
  END;

  MACRO A6_11()
    return money(m_DS.Principal);
  END;

  MACRO A6_12()
    return double(m_DS.Price);
  END;

  MACRO A6_13()
    return ПолучитьКодФинИн(m_DS.CFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A6_14()
    if( IsBUY(m_Group) )
       m_A6_3_7.Add( m_DS.FaceValueFI, m_A6_2_7.Add( m_DS.FaceValueFI, m_A6_1_7.Add( m_DS.FaceValueFI, $0)));
       return m_A6_3_2.Add( m_DS.FaceValueFI, m_A6_2_2.Add( m_DS.FaceValueFI, m_A6_1_2.Add( m_DS.FaceValueFI, money(m_DS.Principal * m_DS.Price))));
    elif( IsSALE(m_Group) )
       m_A6_3_2.Add( m_DS.FaceValueFI, m_A6_2_2.Add( m_DS.FaceValueFI, m_A6_1_2.Add( m_DS.FaceValueFI, $0)));
       return m_A6_3_7.Add( m_DS.FaceValueFI, m_A6_2_7.Add( m_DS.FaceValueFI, m_A6_1_7.Add( m_DS.FaceValueFI, money(m_DS.Principal * m_DS.Price))));
    else
       return m_A6_3_2.Add( m_DS.FaceValueFI, m_A6_2_2.Add( m_DS.FaceValueFI, m_A6_1_2.Add( m_DS.FaceValueFI, money(m_DS.Principal * m_DS.Price))));
    end;

    return money(m_DS.Principal * m_DS.Price);
  END;

  MACRO A6_15()
    return ПолучитьКодФинИн(NATCUR, NULL, FICK_ISOSTRING); /*пока только наткур тк другое не придусмотено*/
  END;

  MACRO A6_16()
    if( IsBUY(m_Group) )
       m_A6_3_9.Add( m_DS.FaceValueFI, m_A6_2_9.Add( m_DS.FaceValueFI, m_A6_1_9.Add( m_DS.FaceValueFI, $0)));
       return m_A6_3_4.Add( m_DS.FaceValueFI, m_A6_2_4.Add( m_DS.FaceValueFI, m_A6_1_4.Add( m_DS.FaceValueFI, money(m_DS.NKD))));
    elif( IsSALE(m_Group) )
       m_A6_3_4.Add( m_DS.FaceValueFI, m_A6_2_4.Add( m_DS.FaceValueFI, m_A6_1_4.Add( m_DS.FaceValueFI, $0)));
       return m_A6_3_9.Add( m_DS.FaceValueFI, m_A6_2_9.Add( m_DS.FaceValueFI, m_A6_1_9.Add( m_DS.FaceValueFI, money(m_DS.NKD))));
    else
       return m_A6_3_4.Add( m_DS.FaceValueFI, m_A6_2_4.Add( m_DS.FaceValueFI, m_A6_1_4.Add( m_DS.FaceValueFI, money(m_DS.NKD))));
    end;

    return money(m_DS.NKD);
  END;

  MACRO A6_17()
    return ПолучитьКодФинИн(m_DS.FaceValueFI, NULL, FICK_ISOSTRING);
  END;

  MACRO A6_18()
    if( IsEXCHANGE(m_Group) )
       return m_Report.GetPartyName( m_DS.MarketID, true )
    elif( IsOUTEXCHANGE(m_Group) )
       if( m_Report.GetPartyKind(m_DS.PartyID, PTK_MARKETPLASE) )
          return m_Report.GetPartyName( m_DS.PartyID, true )
       else
          return "вне биржи";
       end;
    elif( IsBROKER(m_Group) )
       return "брокер";
    end;

    return "";
  END;

  MACRO A6_19()
    if( m_DS.MaturityIsPrincipal == SET_CHAR)
       return date(m_DS.Maturity) + " / " + m_SettlDate;
    else
       return date(m_DS.Expiry) + " / " + m_SettlDate;
    end;
    return "";
  END;

  MACRO A6_20()
    if( m_DS.MaturityIsPrincipal != SET_CHAR)
       return date(m_DS.Maturity) + " / " + m_PaymDate;
    else
       return date(m_DS.Expiry) + " / " + m_PaymDate;
    end;
    return "";
  END;

  MACRO A6_21()
    return iif( (m_MinRate == 0) and (m_MaxRate == 0), "", m_MinRate + "/" + m_MaxRate);
  END;

  MACRO A6_22()
    return date(m_DS.RejectDate);
  END;

  MACRO БиржеваяПереговорная()
     return (IsEXCHANGE(m_Group) AND (m_DS.PartyId != -1) AND (m_DS.PartyId != m_DS.MarketId));
  END;

  MACRO БиржеваяБезадресная()
     return (IsEXCHANGE(m_Group) AND (not БиржеваяПереговорная()));
  END;
     
  MACRO InitDataSet()
    m_RSD = RSDCommand( "select tk.t_DealCode, tk.t_DealDate, tk.t_DealTime, tk.t_DealType, tk.t_BofficeKind, tk.t_DealID, " +
                        "       (case when (tk.t_PartyId != tk.t_MarketID and tk.t_PartyId != -1) then 1 else 0 end ) TypeDoc, " +
                        "       fi.t_AvoirKind, avr.t_Issue, avr.t_Series, fi.t_Issuer, fi.t_FI_Code, avr.t_ISIN, avr.t_LSIN, tk.t_PartyID, fi.t_FIID, " +
                        "       dl_leg.t_Principal, dl_leg.t_CFI, DECODE(dl_leg.t_RelativePrice, '"+ SET_CHAR+"', RSB_FIInstr.FI_GetNominalOnDate(fi.t_FIID, tk.t_DealDate) * dl_leg.t_Price/100.0 , dl_leg.t_Price) Price, " +
                        "       dl_leg.t_NKD, fi.t_FaceValueFI, tk.t_MarketID,  dl_leg.t_RejectDate, dl_leg.t_Maturity, dl_leg.t_Expiry, dl_leg.t_MaturityIsPrincipal " +
                        "  from ddl_tick_dbt tk, ddl_leg_dbt dl_leg, dfininstr_dbt fi, davoiriss_dbt avr " +
                        " where     tk.t_ClientID = ? " +
                        "       and tk.t_ClientContrID = ? " +
                        "       and tk.t_DealDate >= ? " +
                        "       and tk.t_DealDate <= ? " +
                        "       and tk.t_Department = ? " +
                        "       and tk.t_BOfficeKind in ( " + DL_TRUSTDOC + ", " + DL_TRUSTRETIREMENT + " ) " +
                        "       and dl_leg.t_DealID = tk.t_DealID " + 
                        "       and dl_leg.t_LegKind in ( " + LEG_KIND_DL_TICK + ", " + LEG_KIND_DL_TICK_BACK + " ) " +
                        "       and dl_leg.t_LegID = 0 " + 
                        "       and fi.t_FIID = dl_leg.t_PFI " +
                        "       and avr.t_FIID = fi.t_FIID " +
                        "       AND DECODE(tk.t_BOfficeKind, " + DL_TRUSTRETIREMENT + ", Rsb_Secur.IsRet_Issue( Rsb_Secur.get_OperationGroup(Rsb_Secur.get_OperSysTypes(tk.t_DealType, tk.t_BOfficeKind) ) ), 1) = 1 " +
                        "order by tk.t_BOfficeKind, Rsb_Secur.IsExchange( Rsb_Secur.get_OperationGroup(Rsb_Secur.get_OperSysTypes(tk.t_DealType, tk.t_BOfficeKind) ) ) desc, tk.t_TypeDoc desc, fi.t_Issuer, tk.t_DealDate, tk.T_DealID" );

    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.PartyID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_TSOrders.rec.ID);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_BeginDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_EndDate);
    m_RSD.addParam("", RSDBP_IN, m_Report.m_Dprt);
    m_RSD.execute();

    m_DS = TRsbDataSet( m_RSD );

    return m_DS.MoveNext();
  END;

  MACRO GetExtData()
    var ds;
    var rsd = RSDCommand( "select pm.t_ValueDate " +
                          "  from dpmpaym_dbt pm " +
                          " where     pm.t_DocKind = ? " + /*tk.t_BofficeKind*/
                          "       and pm.t_DocumentID = ? " + /*tk.t_DealID*/
                          "       and pm.t_Purpose = ? "
                          "       and pm.t_PaymStatus in (" + PM_READY_TO_SEND + ", " + PM_FINISHED + ", " + PM_CLOSED_W_M_MOVEMENT + ")" );
    rsd.addParam("", RSDBP_IN, m_DS.BofficeKind);
    rsd.addParam("", RSDBP_IN, m_DS.DealID);
    rsd.addParam("", RSDBP_IN, BAi);
    rsd.execute();

    ds = TRSBDataSet(rsd);
    if( ds.MoveNext() )
       m_SettlDate = date(ds.ValueDate);
    else
       m_SettlDate = date(0,0,0);
    end;

    rsd = RSDCommand( "select pm.t_ValueDate " +
                      "  from dpmpaym_dbt pm " +
                      " where     pm.t_DocKind = ? " + /*tk.t_BofficeKind*/
                      "       and pm.t_DocumentID = ? " + /*tk.t_DealID*/
                      "       and pm.t_Purpose = ? "
                      "       and pm.t_PaymStatus in (" + PM_READY_TO_SEND + ", " + PM_FINISHED + ", " + PM_CLOSED_W_M_MOVEMENT + ")" );
    rsd.addParam("", RSDBP_IN, m_DS.BofficeKind);
    rsd.addParam("", RSDBP_IN, m_DS.DealID);
    rsd.addParam("", RSDBP_IN, CAi);
    rsd.execute();

    ds = TRSBDataSet(rsd);
    if( ds.MoveNext() )
       m_PaymDate = date(ds.ValueDate);
    else
       m_PaymDate = date(0,0,0);
    end;

    m_Group = GetOperationGroup(m_DS.DealType);


    rsd = RSDCommand( "select ground.t_XLD " +
                      "  from dspgrdoc_dbt doc, dspground_dbt ground " +
                      " where     doc.t_SourceDocKind = ? " + /*tk.t_BofficeKind*/
                      "       and doc.t_SourceDocID = ? " + /*tk.t_DealID*/
                      "       and ground.t_SPGroundID = doc.t_SPGroundID "
                      "       and ground.t_Kind in (25,26,320,321)" );
    rsd.addParam("", RSDBP_IN, m_DS.BofficeKind);
    rsd.addParam("", RSDBP_IN, m_DS.DealID);
    rsd.execute();

    ds = TRSBDataSet(rsd);
    if( ds.MoveNext() )
       m_DocNumber = ds.XLD;
    else
       m_DocNumber = "";
    end;

    if( БиржеваяПереговорная() OR IsOUTEXCHANGE(m_Group) )
       m_MinRate = GetRateOnDate( date(m_DS.DealDate), m_DS.FIID, m_DS.FaceValueFI, false, RATETYPE_MIN_PRICE, null, null );
       m_MaxRate = GetRateOnDate( date(m_DS.DealDate), m_DS.FIID, m_DS.FaceValueFI, false, RATETYPE_MAX_PRICE, null, null );
    else
       m_MinRate = 0.0;
       m_MaxRate = 0.0;
    end;

  END;

  MACRO PrintSubHead()
    
    m_Report.PrintFormatString( ReportHeader,
                                "H6_1", m_Report.Department(),
                                "H6_2", "Сделки и операции с эмиссионными ценными бумагами за период " + m_Report.ReportPeriod( false )
                              );
    m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "H6_Head", 1 );
    
    m_Report.PrintFormatString( ReportHeader,
                                "H6_3", "Клиент: " + m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "H6_SubHead", 1 );
  END;

  MACRO PrintHeadTable()
    var str = "";

    if( IsEXCHANGE(m_Group) )
       str = "Биржевые сделки с эмиссионными ценными бумагами ";
    elif( IsOUTEXCHANGE(m_Group) )
       str = "Внебиржевые сделки с эмиссионными ценными бумагами ";
    elif( IsRET_ISSUE(m_Group) )
       str = "Погашение ценных бумаг ";
    end;
    m_Report.PrintFormatString( ReportHeader,
                                "H6_7", str + m_Report.TSOrderString()
                              );
    m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "H6_Table", 1 );
  END;

  MACRO PrintSubTableHead()
    var str = "";

    if( БиржеваяПереговорная() )
       str = "Переговорные сделки";
    else
       str = "Безадресные сделки";
    end;
    m_Report.PrintTableLine( "A6_1",    str,     null,
                             "A6_2",    "",      null,
                             "A6_3",    "",      null,
                             "A6_4",    "",      null,
                             "A6_5",    "",      null,
                             "A6_6",    "",      null,
                             "A6_7",    "",      null,
                             "A6_8",    "",      null,
                             "A6_9",    "",      null,
                             "A6_10",   "",      null,
                             "A6_11",   "",      null,
                             "A6_12",   "",      null,
                             "A6_13",   "",      null,
                             "A6_14",   "",      null,
                             "A6_15",   "",      null,
                             "A6_16",   "",      null,
                             "A6_17",   "",      null,
                             "A6_18",   "",      null,
                             "A6_19",   "",      null,
                             "A6_20",   "",      null,
                             "A6_21",   "",      null,
                             "A6_22",   "",      null
                            );
  END;

  MACRO PrintIssuerItogLine( Issuer, DocKind )
    if( DocKind != DL_TRUSTRETIREMENT)
       m_A6_1_2.SetFirst();
       m_A6_1_4.SetFirst();
       m_A6_1_7.SetFirst();
       m_A6_1_9.SetFirst();
       while( m_A6_1_2.Next() AND (m_A6_1_2.GetCCy() != Issuer) )  
         m_A6_1_4.Next();
         m_A6_1_7.Next();
         m_A6_1_9.Next();
         m_Report.PrintFormatString( ReportHeader,
                                     "A6_1_1",    "Итого сделки покупки: " + m_Report.GetPartyName( Issuer ),
                                     "A6_1_2",    m_A6_1_2.GetSum(),
                                     "A6_1_3",    ПолучитьКодФинИн(m_A6_1_2.GetCCy(), NULL, FICK_ISOSTRING),
                                     "A6_1_4",    m_A6_1_4.GetSum(),
                                     "A6_1_5",    ПолучитьКодФинИн(m_A6_1_2.GetCCy(), NULL, FICK_ISOSTRING),
                                     "A6_1_6",    "Итого сделки продажи: " + m_Report.GetPartyName( Issuer ),
                                     "A6_1_7",    m_A6_1_7.GetSum(),
                                     "A6_1_8",    ПолучитьКодФинИн(m_A6_1_7.GetCCy(), NULL, FICK_ISOSTRING),
                                     "A6_1_9",    m_A6_1_9.GetSum(),
                                     "A6_1_10",   ПолучитьКодФинИн(m_A6_1_7.GetCCy(), NULL, FICK_ISOSTRING)
                                   );
         m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "MainTable_6_1", 0 );
       end;
    else
       m_A6_1_2.SetFirst();
       m_A6_1_4.SetFirst();
       while( m_A6_1_2.Next() )  
         m_A6_1_4.Next();
         m_Report.PrintFormatString( ReportHeader,
                                     "A6_1_1",    "Итого по погашению: " + m_Report.GetPartyName( Issuer ),
                                     "A6_1_2",    m_A6_1_2.GetSum(),
                                     "A6_1_3",    ПолучитьКодФинИн(m_A6_1_2.GetCCy(), NULL, FICK_ISOSTRING),
                                     "A6_1_4",    m_A6_1_4.GetSum(),
                                     "A6_1_5",    ПолучитьКодФинИн(m_A6_1_2.GetCCy(), NULL, FICK_ISOSTRING)
                                   );
         m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "MainTable_6_2", 0 );
       end;
    end;
    m_A6_1_2.Clear(); m_A6_1_4.Clear(); m_A6_1_7.Clear(); m_A6_1_9.Clear();
  END;

  MACRO PrintBSDealsItogLine( TypeDoc )
    var str = "";
    if( IsEXCHANGE(m_Group) )
       m_A6_3_2.SetFirst(); m_A6_3_4.SetFirst(); m_A6_3_7.SetFirst(); m_A6_3_9.SetFirst();
       while( m_A6_3_2.Next() )
         m_A6_3_4.Next(); m_A6_3_7.Next(); m_A6_3_9.Next();

         if( TypeDoc == "N" )
            str = "переговорные";
         else
            str = "безадресные";
         end;
         m_Report.PrintFormatString( ReportHeader,
                                     "A6_1_1",    "Итого " + str + " сделки покупки: ",
                                     "A6_1_2",    m_A6_3_2.GetSum(),
                                     "A6_1_3",    ПолучитьКодФинИн(m_A6_3_2.GetCCy(), NULL, FICK_ISOSTRING),
                                     "A6_1_4",    m_A6_3_4.GetSum(),
                                     "A6_1_5",    ПолучитьКодФинИн(m_A6_3_4.GetCCy(), NULL, FICK_ISOSTRING),
                                     "A6_1_6",    "Итого " + str + " сделки продажи: ",
                                     "A6_1_7",    m_A6_3_7.GetSum(),
                                     "A6_1_8",    ПолучитьКодФинИн(m_A6_3_7.GetCCy(), NULL, FICK_ISOSTRING), 
                                     "A6_1_9",    m_A6_3_9.GetSum(),
                                     "A6_1_10",   ПолучитьКодФинИн(m_A6_3_9.GetCCy(), NULL, FICK_ISOSTRING)
                                   );
         m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "MainTable_6_1", 0 );

       end;
       m_A6_3_2.Clear(); m_A6_3_4.Clear(); m_A6_3_7.Clear(); m_A6_3_9.Clear();
    end;
  END;

  MACRO PrintRetDealsItogLine()
    m_A6_2_2.SetFirst();
    m_A6_2_4.SetFirst();
    while( m_A6_2_2.Next() )  
      m_A6_2_4.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A6_1_1",    "Итого по операциям погашения:",
                                  "A6_1_2",    m_A6_2_2.GetSum(),
                                  "A6_1_3",    ПолучитьКодФинИн(m_A6_2_2.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A6_1_4",    m_A6_2_4.GetSum(),
                                  "A6_1_5",    ПолучитьКодФинИн(m_A6_2_4.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "MainTable_6_2", 0 );
    end;
    m_A6_2_2.Clear();
    m_A6_2_4.Clear();
    /*мухлеж но пройдет*/
    m_A6_3_2.Clear(); m_A6_3_4.Clear(); m_A6_3_7.Clear(); m_A6_3_9.Clear();
  END;

  MACRO PrintDealsItogLine()
    var str = "";

    if( IsEXCHANGE(m_Group) )
       str = "биржевым"
    elif( IsOUTEXCHANGE(m_Group) )
       str = "внебиржевым"
    end;

    m_A6_2_2.SetFirst();
    m_A6_2_4.SetFirst();
    m_A6_2_7.SetFirst();
    m_A6_2_9.SetFirst();
    while( m_A6_2_2.Next() )  
      m_A6_2_4.Next();
      m_A6_2_7.Next();
      m_A6_2_9.Next();
      m_Report.PrintFormatString( ReportHeader,
                                  "A6_1_1",    "Итого по " + str + " сделкам покупки: ",
                                  "A6_1_2",    m_A6_2_2.GetSum(),
                                  "A6_1_3",    ПолучитьКодФинИн(m_A6_2_2.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A6_1_4",    m_A6_2_4.GetSum(),
                                  "A6_1_5",    ПолучитьКодФинИн(m_A6_2_4.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A6_1_6",    "Итого по " + str + " сделкам продажи: ",
                                  "A6_1_7",    m_A6_2_7.GetSum(),
                                  "A6_1_8",    ПолучитьКодФинИн(m_A6_2_7.GetCCy(), NULL, FICK_ISOSTRING),
                                  "A6_1_9",    m_A6_2_9.GetSum(),
                                  "A6_1_10",   ПолучитьКодФинИн(m_A6_2_9.GetCCy(), NULL, FICK_ISOSTRING)
                                );
      m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "MainTable_6_1", 0 );
    end;
    m_A6_2_2.Clear();
    m_A6_2_4.Clear();
    m_A6_2_7.Clear();
    m_A6_2_9.Clear();
    /*мухлеж но пройдет*/
    m_A6_3_2.Clear(); m_A6_3_4.Clear(); m_A6_3_7.Clear(); m_A6_3_9.Clear();
  END;


  MACRO RegisterTable( NotNeedSubHead )
    m_Report.RegisterTable( "MainTable_6", TableHeader,
                            "A6_1",
                            "A6_2",
                            "A6_3",
                            "A6_4",
                            "A6_5",
                            "A6_6",
                            "A6_7",
                            "A6_8",
                            "A6_9",
                            "A6_10",
                            "A6_11",
                            "A6_12",
                            "A6_13",
                            "A6_14",
                            "A6_15",
                            "A6_16",
                            "A6_17",
                            "A6_18",
                            "A6_19",
                            "A6_20",
                            "A6_21",
                            "A6_22"
                           );
    if( not NotNeedSubHead )
       if( IsEXCHANGE(m_Group) )
         PrintSubTableHead();
       end;
    end;
  END;

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, m_Report.GetTableRange(), 0 );
  END;

  MACRO PrintLine()
    m_Report.PrintTableLine( "A6_1",    A6_1(),       null,
                             "A6_2",    A6_2(),       null,
                             "A6_3",    A6_3(),       null,
                             "A6_4",    A6_4(),       null,
                             "A6_5",    A6_5(),       null,
                             "A6_6",    A6_6(),       null,
                             "A6_7",    A6_7(),       null,
                             "A6_8",    A6_8(),       null,
                             "A6_9",    A6_9(),       null,
                             "A6_10",   A6_10(),      null,
                             "A6_11",   A6_11(),      null,
                             "A6_12",   A6_12(),      null,
                             "A6_13",   A6_13(),      null,
                             "A6_14",   A6_14(),      null,
                             "A6_15",   A6_15(),      null,
                             "A6_16",   A6_16(),      null,
                             "A6_17",   A6_17(),      null,
                             "A6_18",   A6_18(),      null,
                             "A6_19",   A6_19(),      null,
                             "A6_20",   A6_20(),      null,
                             "A6_21",   A6_21(),      null,
                             "A6_22",   A6_22(),      null
                            );
  END;

  MACRO BeginReport()
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( "Сделки с ценными бумагами" );
  END;

  MACRO Execute()
    var ExistData = false, whileFlag = false, TypeDoc, LastDocKind, Issuer;
    m_Report.TSOrderList();

    while( m_Report.TsOrderNext() )
       ExistData = InitDataSet();
       whileFlag = ExistData;
       TypeDoc = NULL;

       if( ExistData )
          ExistPrintSecurDeal = true;
          GetExtData();
          PrintSubHead();
          PrintHeadTable();
          RegisterTable();
       end;

       while( whileFlag )
          GetExtData();

          if ( БиржеваяПереговорная() )
            TypeDoc = "N";
          else
            TypeDoc = "T";
          end;

          LastDocKind = m_DS.BOfficeKind;
          Issuer = m_DS.Issuer;
          PrintLine();
          
          whileFlag = m_DS.MoveNext();

          if( (IsEXCHANGE(m_Group) != IsEXCHANGE(GetOperationGroup(m_DS.DealType))) OR
              (IsOUTEXCHANGE(m_Group) != IsOUTEXCHANGE(GetOperationGroup(m_DS.DealType))) OR
              (БиржеваяПереговорная() AND (TypeDoc == "T")) OR
              (БиржеваяБезадресная() AND (TypeDoc == "N"))

            )
             EndTable();
             PrintIssuerItogLine( Issuer, LastDocKind );
             PrintBSDealsItogLine( TypeDoc ); /*здесь еще старый TypeDoc*/
             if( not ( (БиржеваяПереговорная() AND (TypeDoc == "T")) OR
                         (БиржеваяБезадресная() AND (TypeDoc == "N"))
                       ) OR
                 (IsEXCHANGE(m_Group) != IsEXCHANGE(GetOperationGroup(m_DS.DealType))) OR
                 (IsOUTEXCHANGE(m_Group) != IsOUTEXCHANGE(GetOperationGroup(m_DS.DealType)))             
               ) /*здесь еще старый m_Group*/
                PrintDealsItogLine();
             end;
             m_Group = GetOperationGroup(m_DS.DealType);
             if( not ( (БиржеваяПереговорная() AND (TypeDoc == "T")) OR
                         (БиржеваяБезадресная() AND (TypeDoc == "N"))
                       )
                 )
                PrintHeadTable();
             end;
             RegisterTable();
          else
            if( Issuer != m_DS.Issuer )
               EndTable();
               PrintIssuerItogLine( Issuer, LastDocKind );
               RegisterTable( true );
            end;
          end;
       end;

       if( ExistData )
          EndTable();
          PrintIssuerItogLine( Issuer, LastDocKind );
          if( LastDocKind== DL_TRUSTRETIREMENT )
             PrintRetDealsItogLine()
          else
             PrintBSDealsItogLine( TypeDoc );
             PrintDealsItogLine();
          end;
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
    if( ExistPrintSecurDeal == true )
       m_Report.AddStandardFooter( "N6_" );
       m_Report.CopyAllSheetInTotalBook( "Сделки с ценными бумагами", false, "H6_Footer", 1 );
    end;
  END;
END;

/********************************************************************************
Класс для шаблона "Отчет клиента ОФБУ" /*долевой*/
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_ClRep_DOFBU( Report:OBJECT )
  VAR m_Report = Report, m_KindRep, НачалоГода = Date(0,0,0), m_SheetName, m_IsFirstPrint = true;
  VAR m_OrderOFBU:TS_OrderFD;
  var m_RepSign = TS_ReportData();

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Report.GetTableRange(), 0 );
  END;

  PRIVATE MACRO КоличествоПролонгаций():string
     var RetVal:string = "";
     var select, query, DataSet;

     select = " SELECT COUNT(t_ID) AS CountValid " +
              "   FROM dtsvalid_dbt Valid     " +
              "  WHERE Valid.t_OrderID   = :ID" +
              "    AND Valid.t_BeginDate < :BDate";

     query = RSDCommand(select);
     query.addParam("ID", RSDBP_IN, m_Report.m_OrderFD.Order().rec.ID);
     query.addParam("BDate", RSDBP_IN, m_Report.m_BeginDate() );
     query.execute();

     DataSet = TRsbDataSet(query);
     if( DataSet.MoveNext() and (SQL_ConvTypeInteger(DataSet.CountValid) > 1) )
        RetVal = string( int(SQL_ConvTypeInteger(DataSet.CountValid) - 1));
     end;

     return RetVal;
  END;

  PRIVATE MACRO H2_4():string
     var RetVal:string = "";
     if( m_Report.m_ItogReport )
        if( m_Report.m_ItogPeriod == H_PROLONG )
           RetVal = "прол";
        elif( m_Report.m_ItogPeriod == H_CLOSE )
           RetVal = "закр";
        end;
     end;

     return RetVal;
  END;

  PRIVATE MACRO PrintReportHead()
    var Trustor = m_Report.m_OrderFD.Trustor(),
        TrustorName:string      = "",
        TrustorShortName:string = "";
    if( Trustor != NULL )
       TrustorName      = Trustor.rec.Name;
       TrustorShortName = Trustor.rec.ShortName;
    end;
    m_Report.PrintFormatString( ReportHeader,
                                "H7_0",  TS_IIF(m_Report.m_ItogReport, "ИТОГОВЫЙ ОТЧЕТ", "ОТЧЕТ"),
                                "H7_1",  "Учредителю ОФБУ № " + m_OrderOFBU.Number() + " " + m_OrderOFBU.Name(),
                                "H7_2",  TS_IIF(m_Report.m_OrderFD.УчредительФизЛицо(), TrustorName, TrustorShortName),
                                "H7_2_", "№ договора "+ m_OrderOFBU.Order().rec.AccCode + "/" + m_Report.m_OrderFD.Order().rec.AccCode + "/" + КоличествоПролонгаций() + H2_4(),
                                "H7_3",  m_Report.ReportPeriod(false)
                              );
    if( m_IsFirstPrint )
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H7_Head", 0 );
       m_IsFirstPrint = false;
    else
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H7_Head", 1 );
    end;
  END;

  PRIVATE MACRO ПечатьСредВзвКапиталаДругихУчредителей()

     var BeginDate:date, EndDate:date, CurBegDate:date, CurEndDate:date;
     var First:bool = true;

     /*Определим даты периода*/
     BeginDate = m_Report.PanelBeginDate();
     EndDate = m_Report.PanelEndDate();

     CurBegDate = BeginDate;
     while( CurBegDate < EndDate )
        var dd, mm, yyyy;
        DateSplit( CurBegDate, dd, mm, yyyy);
        CurEndDate = Date(1, TS_IIF(mm==12, 1, mm+1), TS_IIF(mm==12, yyyy+1, yyyy)) - 1;
        if( CurEndDate > EndDate )
           CurEndDate = EndDate;
        end;

        m_Report.PrintTableLine( "A7_4_1", TS_IIF(First, "Средневзвешенная по сроку отчетного периода доля других Учредителей в средневзвешенном капитале ОФБУ (руб.)", ""), null,
                                 "A7_4_3", TS_MonthName(mm) + " " + substr(string(yyyy), 3 ,2), null,
                                 "A7_4_4", m_OrderOFBU.СредневзвешенныйКапиталЗаПериод( CurBegDate, CurEndDate, false, false) - m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( CurBegDate, CurEndDate, false, false), null);
        CurBegDate = CurEndDate + 1;
        First = false;
     end;

  END;

  PRIVATE MACRO ПечатьСредВзвКапитала()

     var CurBegDate:date, CurEndDate:date;
     var First:bool = true;

     CurBegDate = m_Report.m_BeginDate();
     while( CurBegDate < m_Report.m_EndDate() )
        var dd, mm, yyyy;
        var Last:bool = false;
        var EndDateMonth, BegDateMonth;
        var H12_2 = $0.0, Дсрвзв = $0.0, Дсрвзв1 = $0.0;
        DateSplit( CurBegDate, dd, mm, yyyy);
        CurEndDate = Date(LastDay(mm, yyyy), mm, yyyy);
        if( m_Report.m_EndDate() < CurEndDate )
           CurEndDate = m_Report.m_EndDate();
           Last = true;
        end;

        if( (First == true) or (Last == true) ) /* сейчас пролонгация договора может быть либо в первом периоде-месяце ОП либо в последнем */
           BegDateMonth = Date(1, mm, yyyy);
           EndDateMonth = Date(LastDay(mm, yyyy), mm, yyyy);
           if( m_Report.m_OrderFD.БылаПролонгация( BegDateMonth, EndDateMonth, true ) )
              Дсрвзв = m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( BegDateMonth, EndDateMonth, false, false );
              Дсрвзв1 = round(Дсрвзв * ( m_Report.m_OrderFD.Valid(BegDateMonth).rec.EndDate - BegDateMonth + 1 ) / (EndDateMonth - BegDateMonth + 1), 2);
              if( First == true )
                 H12_2 = Дсрвзв - Дсрвзв1;
              elif( Last == true )
                 H12_2 = Дсрвзв1;
              end;
           else
              H12_2 = m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( CurBegDate, CurEndDate, false, false);
           end;
        else
           H12_2 = m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( CurBegDate, CurEndDate, false, false);
        end;

        m_Report.PrintTableLine( "A7_6_1", TS_IIF(First, "Средневзвешенная по сроку отчетного периода доля Учредителя в средневзвешенном капитале ОФБУ (руб.)", ""), null,
                                 "A7_6_2", TS_MonthName(mm) + " " + substr(string(yyyy), 3 ,2), null,
                                 "A7_6_3", H12_2, null);
        CurBegDate = CurEndDate + 1;
        First = false;
     end;

  END;

  PRIVATE MACRO СуммаПроводокПоКатегории( CatCode:string, DebKred:integer, BegDate:Date, EndDate:Date )
    var Query, SqlQuery, DataSet;

    SqlQuery = RSDCommand(" select NVL(SUM(arh.t_Sum_Payer),0) as ArhSum                                  " +
                          "   from dacctrn_dbt arh,                                                       " +
                          "        (select distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                          "           from dmcaccdoc_dbt accdoc, dmccateg_dbt categ                       " +
                          "          where accdoc.t_ClientContrID = ?                                     " +
                          "            and accdoc.t_CatID    = categ.t_ID                                 " +
                          "            and categ.t_LevelType = 1                                          " +
                          "            and categ.t_Code      = ?                                          " +
                          "        ) acc                                                                  " +
                          "  where arh.t_FIID_Payer = acc.t_Currency                                   " +
                          "    and arh.t_State = 1 " +
                          "    and arh.t_chapter = acc.t_Chapter                                          " +
                          "    and (case when ? = 1 then arh.t_account_payer else arh.t_account_receiver end) = acc.t_Account " +
                          "    and arh.t_date_carry >= ?                                                  " +
                          "    and arh.t_date_carry <= ?                                                  " );

    SqlQuery.addParam("", RSDBP_IN, m_OrderOFBU.Order().rec.SfcontrID);
    SqlQuery.addParam("", RSDBP_IN, CatCode);
    SqlQuery.addParam("", RSDBP_IN, DebKred);
    SqlQuery.addParam("", RSDBP_IN, BegDate);
    SqlQuery.addParam("", RSDBP_IN, EndDate);
    SqlQuery.execute();                                       

    DataSet = TRsbDataSet(SqlQuery);
    if( DataSet.MoveNext() )
       return DataSet.ArhSum;
    end;

    return $0.;
  END;

  PRIVATE MACRO ПечатьОбщиеДанныеПоОФБУ()

    m_Report.RegisterTable( "MainTable_7_4", TableHeader,
                            "A7_4_1", "A7_4_2", "A7_4_3", "A7_4_4" );

    m_Report.PrintTableLine( "A7_4_1", "Текущая стоимость активов фонда (руб.) на", null,
                             "A7_4_2", (m_Report.PanelEndDate() + 1), null,
                             "A7_4_4", m_OrderOFBU.СтоимостьАктивовФонда( m_Report.PanelEndDate() ), null );

    m_Report.PrintTableLine( "A7_4_1", "Внесено средств Учредителями (руб.) на", null,
                             "A7_4_2", (m_Report.m_EndDate() + 1), null,
                             "A7_4_4", m_OrderOFBU.КапиталУчредителя( m_Report.PanelEndDate() ), null );

    ПечатьСредВзвКапиталаДругихУчредителей();

    var ПолученоДоходов = СуммаПроводокПоКатегории( "Доходы ДУ", SIDE_KRED, m_Report.PanelBeginDate(), m_Report.PanelEndDate() ) + СуммаПроводокПоКатегории( "ДоходыЭцб ДУ", SIDE_KRED, m_Report.PanelBeginDate(), m_Report.PanelEndDate() );
    var ПонесеноРасходов = СуммаПроводокПоКатегории( "Расходы ДУ", SIDE_DEB, m_Report.PanelBeginDate(), m_Report.PanelEndDate() ) + СуммаПроводокПоКатегории( "РасходыЭцб ДУ", SIDE_DEB, m_Report.PanelBeginDate(), m_Report.PanelEndDate() );

    m_Report.PrintTableLine( "A7_4_1", "Получена прибыль (убыток) за отчетный период (руб.)", null,
                             "A7_4_4", ПолученоДоходов - ПонесеноРасходов, null );

    m_Report.PrintTableLine( "A7_4_1", "Получено доходов за отчетный период (руб.)", null,
                             "A7_4_4", ПолученоДоходов, null );

    m_Report.PrintTableLine( "A7_4_1", "Понесено расходов за отчетный период (руб.)", null,
                             "A7_4_4", ПонесеноРасходов, null );
    EndTable();

  END;

  PRIVATE MACRO MakeMoney( Summa:double )
     return Round(money(Summa), 2);
  END;

  PRIVATE CLASS СКПоДатам( Дата_:Date, СК_ )
     VAR Дата = Дата_,
         СК   = СК_;
  END;

  PRIVATE MACRO ПечатьДанныеЗаОтчетныйПериод()

    var RateCom;
    var SqlQuery, DataSet;
    var СК = TArray(), Sum;

    ПолучитьСтавкуКомиссии(m_OrderOFBU.SfContr().rec.ID, ПолучитьНомерКомиссии(m_OrderOFBU.SfContr().rec.ID, "TSM", m_Report.m_EndDate(), null, "NOFBU"), m_Report.m_EndDate(), 1, @RateCom, null);
    m_Report.PrintFormatString( ReportHeader, "H7_4", "5=4*3*" + string(MakeMoney(RateCom)) + "%/" + string(ДУ_ДнейВГоду(m_Report.m_EndDate())) );
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H7_Head2", 0 );

    m_Report.RegisterTable( "MainTable_7_5", TableHeader,
                            "A7_5_1", "A7_5_2", "A7_5_3", "A7_5_4", "A7_5_5" );

    /* создадим массив со значениями СК по датам */
    СК.Size = 0;
    if( ПолучитьИтогДУ( m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, m_Report.m_BeginDate, NULL, NULL, @Sum ) )
       Sum = $0;
    end;
    СК[СК.Size] = СКПоДатам(m_Report.m_BeginDate, Sum);

    SqlQuery = RSDCommand( " select t_BeginDate      " +
                           "   from dtstotal_dbt     " +
                           "  where t_totaltype = ?  " +
                           "    and t_orderid   = ?  " +
                           "    and t_BeginDate < ?  " +
                           "    and t_BeginDate > ?  " +
                           " order by t_BeginDate    " );

    SqlQuery.addParam("", RSDBP_IN, ДУ_ИТОГ_СК                      );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_OrderFD.Order().rec.ID );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate              );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_BeginDate            );
    SqlQuery.execute();
    DataSet = TRsbDataSet(SqlQuery);

    while( DataSet.MoveNext() )
       if( ПолучитьИтогДУ( m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, SQL_ConvTypeDate(DataSet.BeginDate), NULL, NULL, @Sum ) )
          Sum = $0;
       end;
       СК[СК.Size] = СКПоДатам(SQL_ConvTypeDate(DataSet.BeginDate)-1, Sum);
    end;
    СК[СК.Size] = СКПоДатам(TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), 0); /*значение итога нам не надо, поэтому запишем 0*/

    var i=0;
    var ДатаНачала:date;
    var ItogPeriod:integer = 0;
    while(i < (СК.Size-1))
       ДатаНачала = СК[i].Дата + TS_IIF(i==0, 0, 1);
       m_Report.PrintTableLine( "A7_5_1", ДатаНачала,                      null,
                                "A7_5_2", СК[i+1].Дата,                    null,
                                "A7_5_3", (СК[i+1].Дата - ДатаНачала + 1), null,
                                "A7_5_4", СК[i].СК,                        null,
                                "A7_5_5", "",                              null);
       ItogPeriod = ItogPeriod + (СК[i+1].Дата - ДатаНачала + 1);
       i = i+1;
    end;

    var К_beg_add:MONEY = $0.0, К_end_add:MONEY = $0.0;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, m_Report.m_BeginDate-1, @К_beg_add, NULL, NULL))
       К_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), @К_end_add, NULL, NULL))
       К_end_add = $0.0;
    end;
    m_Report.PrintTableLine( "A7_5_1", "Средневзвешенный капитал (руб.)",                                                                           null,
                             "A7_5_3", ItogPeriod,                                                                                                  null,
                             "A7_5_4", m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( m_Report.m_BeginDate, TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), false, false), null,
                             "A7_5_5", К_end_add - К_beg_add,                                                                                       null);
    EndTable();

    m_Report.RegisterTable( "MainTable_7_6", TableHeader,
                            "A7_6_1", "A7_6_2", "A7_6_3" );

    ПечатьСредВзвКапитала();

    var Р_ПУ_beg_add:MONEY = $0.0, Р_ПУ_end_add:MONEY = $0.0;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, m_Report.m_PanelBeginDate-1, @Р_ПУ_beg_add, NULL, NULL))
       Р_ПУ_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Р_ПУ, NULL, 0, NULL, NULL, NULL, TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_PanelEndDate-1,m_Report.m_EndDate), @Р_ПУ_end_add, NULL, NULL))
       Р_ПУ_end_add = $0.0;
    end;
    m_Report.PrintTableLine( "A7_6_1", "Прибыль после удержания всех вознаграждений, причитающихся Доверительному управляющему в отчетном периоде (руб.)", null,
                             "A7_6_3", Р_ПУ_end_add - Р_ПУ_beg_add, null);
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Report.GetTableRange(), 1 );

  END;

  PRIVATE MACRO ПечатьДанныеСНачалаДействия()

    var СК = TArray(), Sum;
    var SqlQuery, DataSet;
    var BegDate = TS_GetLastProlongDate(m_Report.m_OrderFD.Order().rec.ID, m_Report.m_EndDate) + 1;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.ДатаПервичногоВнесения();
    end;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.BeginDate();
    end;

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H7_Head3", 0 );
    m_Report.RegisterTable( "MainTable_7_7", TableHeader,
                            "A7_7_1", "A7_7_2", "A7_7_3", "A7_7_4" );

    /* создадим массив со значениями СК по датам */
    СК.Size = 0;
    if( ПолучитьИтогДУ( m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, BegDate, NULL, NULL, @Sum ) )
       Sum = $0;
    end;
    СК[СК.Size] = СКПоДатам(BegDate, Sum);

    SqlQuery = RSDCommand( " select t_BeginDate      " +
                           "   from dtstotal_dbt     " +
                           "  where t_totaltype = ?  " +
                           "    and t_orderid   = ?  " +
                           "    and t_BeginDate < ?  " +
                           "    and t_BeginDate > ?  " +
                           " order by t_BeginDate    " );

    SqlQuery.addParam("", RSDBP_IN, ДУ_ИТОГ_СК                      );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_OrderFD.Order().rec.ID );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate              );
    SqlQuery.addParam("", RSDBP_IN, BegDate                         );
    SqlQuery.execute();
    DataSet = TRsbDataSet(SqlQuery);

    while( DataSet.MoveNext() )
       if( ПолучитьИтогДУ( m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, SQL_ConvTypeDate(DataSet.BeginDate), NULL, NULL, @Sum ) )
          Sum = $0;
       end;
       СК[СК.Size] = СКПоДатам(SQL_ConvTypeDate(DataSet.BeginDate)-1, Sum);
    end;
    СК[СК.Size] = СКПоДатам(TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), 0); /*значение итога нам не надо, поэтому запишем 0*/

    var i=0;
    var ДатаНачала:date;
    var ItogPeriod:integer = 0;
    while(i < (СК.Size-1))
       ДатаНачала = СК[i].Дата + TS_IIF(i==0, 0, 1);
       m_Report.PrintTableLine( "A7_7_1", ДатаНачала,                      null,
                                "A7_7_2", СК[i+1].Дата,                    null,
                                "A7_7_3", (СК[i+1].Дата - ДатаНачала + 1), null,
                                "A7_7_4", СК[i].СК,                        null );
       ItogPeriod = ItogPeriod + (СК[i+1].Дата - ДатаНачала + 1);
       i = i+1;
    end;

    m_Report.PrintTableLine( "A7_7_1", "Средневзвешенный капитал (руб.)",                                                              null,
                             "A7_7_3", ItogPeriod,                                                                                     null,
                             "A7_5_4", m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( BegDate, TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), false, false), null);
    EndTable();

  END;

  PRIVATE MACRO ПечатьФинансовыйРезультатУчредителя()

    var RateCom, Rate = $0.0, БП = $0.0, ПУ = $0.0, Km = $0.0, Ks = $0.0, Kp = $0.0, СрBзвКапЗаПер = $0.0, КолДней:integer = 0;
    var A7_8_7 = $0.0, A7_8_8 = $0.0, A7_8_9 = $0.0, A7_8_10 = $0.0, A7_8_11 = $0.0, A7_8_12 = $0.0, A7_8_13 = $0.0;
    var MngPlan = TRecHandler( "tsmngpln.dbt" );
    var Km_beg_add:MONEY = $0.0, Km_end_add:MONEY = $0.0;
    var Ks_beg_add:MONEY = $0.0, Ks_end_add:MONEY = $0.0;
    var Kp_beg_add:MONEY = $0.0, Kp_end_add:MONEY = $0.0;
    var PU_beg_add:MONEY = $0.0, PU_end_add:MONEY = $0.0;
    var Nalog_beg_add:MONEY = $0.0, Nalog_end_add:MONEY = $0.0;
    var D_beg_add:MONEY = $0.0, D_end_add:MONEY = $0.0;
    var UseNDFL:bool;
    var BegDate = TS_GetLastProlongDate(m_Report.m_OrderFD.Order().rec.ID, m_Report.m_EndDate) + 1;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.ДатаПервичногоВнесения();
    end;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.BeginDate();
    end;

    ПолучитьСтавкуКомиссии(m_OrderOFBU.SfContr().rec.ID, ПолучитьНомерКомиссии(m_OrderOFBU.SfContr().rec.ID, "TSS", m_Report.m_EndDate(), null, "NDPOFBU"), m_Report.m_EndDate(), 1, @RateCom, null);
    m_Report.PrintFormatString( ReportHeader, "H7_5", "   за успешное управление (Строка №6 * " + string(MakeMoney(RateCom)) + "%)" );

    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, BegDate-1, @Km_beg_add, NULL, NULL))
       Km_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Km_end_add, NULL, NULL))
       Km_end_add = $0.0;
    end;

    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, BegDate-1, @Ks_beg_add, NULL, NULL))
       Ks_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Ks_end_add, NULL, NULL))
       Ks_end_add = $0.0;
    end;

    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, BegDate-1, @Kp_beg_add, NULL, NULL))
       Kp_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Kp_end_add, NULL, NULL))
       Kp_end_add = $0.0;
    end;

    Km = Km_end_add - Km_beg_add;
    Ks = Ks_end_add - Ks_beg_add;
    Kp = Kp_end_add - Kp_beg_add;
    m_Report.PrintFormatString( ReportHeader, "A7_8_1", Km + Ks + Kp );
    m_Report.PrintFormatString( ReportHeader, "A7_8_2", Km );
    m_Report.PrintFormatString( ReportHeader, "A7_8_3", Ks );
    m_Report.PrintFormatString( ReportHeader, "A7_8_4", Kp );

    if( m_Report.m_ItogReport )
       m_Report.PrintFormatString( ReportHeader, "H7_6", "Среднехронологическая ставка ЦБ, в % годовых" );
    else
       m_Report.PrintFormatString( ReportHeader, "H7_6", "Ставка гарантии, в % годовых" );
    end;

    MngPlan = m_OrderOFBU.MngPlan( m_Report.m_EndDate );
    if( MngPlan != NULL )
       if( MngPlan.rec.GBPBaseProfit == TS_BASE_PROFIT_FIX )
          Rate = MngPlan.rec.GBPRate;
       elif( MngPlan.rec.GBPBaseProfit == TS_BASE_PROFIT_MIDDLE )
          Rate = СреднCтавкаРефинансированияЦБР( BegDate, TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), NATCUR );
       end;
    end;

    m_Report.PrintFormatString( ReportHeader, "A7_8_5", Rate );

    if( m_Report.m_ItogReport )
       m_Report.PrintFormatString( ReportHeader, "H7_7", "Прибыль по ставке ЦБ, руб." );
    else
       m_Report.PrintFormatString( ReportHeader, "H7_7", "Прибыль по ставке гарантии, руб." );
    end;

    БП = m_Report.m_OrderFD.СуммаБазовойПрибыли( TS_IIF((m_Report.m_ItogReport and (m_Report.m_ItogPeriod == H_CLOSE)), m_Report.m_EndDate-1,m_Report.m_EndDate), BegDate, false, null );
    m_Report.PrintFormatString( ReportHeader, "A7_8_6", БП );

    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_ПУ, NULL, 0, NULL, NULL, NULL, BegDate-1, @PU_beg_add, NULL, NULL))
       PU_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_ПУ, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @PU_end_add, NULL, NULL))
       PU_end_add = $0.0;
    end;

    ПУ = PU_end_add - PU_beg_add;
    A7_8_7 = max(0, (ПУ - БП - Km));
    m_Report.PrintFormatString( ReportHeader, "A7_8_7", A7_8_7 );

    A7_8_8 = max(0, (ПУ - БП - Km - Ks));
    m_Report.PrintFormatString( ReportHeader, "A7_8_8", A7_8_8 );

    СрBзвКапЗаПер = m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( BegDate, m_Report.m_EndDate, false, false);
    КолДней = (m_Report.m_EndDate - BegDate + 1);
    if( (СрBзвКапЗаПер != $0.0) and (КолДней != 0) )
       A7_8_9 = A7_8_8 / СрBзвКапЗаПер / КолДней * ДУ_ДнейВГоду(BegDate) * 100;
    end;
    m_Report.PrintFormatString( ReportHeader, "A7_8_9", A7_8_9 );

    UseNDFL = TS_IsPayerNPTaxAllCheck( m_Report.m_OrderFD.Order().rec.Trustor, m_Report.m_EndDate );
    if( m_Report.m_ItogReport and UseNDFL )
       if( ПУ >= БП )
          A7_8_10 = max(0, (ПУ - Km - Ks - Kp));
       else
          A7_8_10 = БП;
       end;
    end;
    m_Report.PrintFormatString( ReportHeader, "A7_8_10", A7_8_10 );

    if( m_Report.m_ItogReport and UseNDFL )
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, BegDate-1, @Nalog_beg_add, NULL, NULL))
          Nalog_beg_add = $0.0;
       end;
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Nalog_end_add, NULL, NULL))
          Nalog_end_add = $0.0;
       end;
       A7_8_11 = Nalog_end_add - Nalog_beg_add;
    end;
    m_Report.PrintFormatString( ReportHeader, "A7_8_11", A7_8_11 );

    if( m_Report.m_ItogReport )
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, BegDate-1, @D_beg_add, NULL, NULL))
          D_beg_add = $0.0;
       end;
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @D_end_add, NULL, NULL))
          D_end_add = $0.0;
       end;
       A7_8_12 = D_end_add - D_beg_add;
    end;
    m_Report.PrintFormatString( ReportHeader, "A7_8_12", A7_8_12 );

    if( m_Report.m_ItogReport )
       if( (СрBзвКапЗаПер != $0.0) and (КолДней != 0) )
          A7_8_13 = max(0, (ПУ - Km - Ks - Kp - A7_8_11) / СрBзвКапЗаПер * ДУ_ДнейВГоду(BegDate) / КолДней * 100);
       end;
    end;
    m_Report.PrintFormatString( ReportHeader, "A7_8_13", A7_8_13 );

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H7_Head4", 0 );

  END;
 
  MACRO ПечатьПодвал()
     m_Report.PrintFormatString( ReportHeader,
                                 "H7_29", m_RepSign.TrustRepresPos,
                                 "H7_30", m_RepSign.TrustChiefShortName,
                                 "H7_31", m_RepSign.OurBankShort );
     m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "N7_Footer", 0 );
  END;

  MACRO BeginReport()
    m_SheetName = "Отчет клиента ОФБУ";
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( m_SheetName );
  END;

  MACRO Execute()

    m_Report.TSOrderList_DP(TS_CALCPART_MONEY);

    while( m_Report.TsOrderNext() )
       if( m_Report.m_BeginDate() <= m_Report.m_EndDate() )
          ExistPrintFirstSheet = true;
          m_OrderOFBU = TS_OrderFD(0, m_Report.m_OrderFD.Order().rec.OFBU);
          PrintReportHead();
          ПечатьОбщиеДанныеПоОФБУ();
          ПечатьДанныеЗаОтчетныйПериод();
          ПечатьДанныеСНачалаДействия();
          ПечатьФинансовыйРезультатУчредителя();
          ПечатьПодвал();
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
  END;

END;

/********************************************************************************
Класс для шаблона "Отчет клиента ОФБУ" /*паевой*/
********************************************************************************/
PRIVATE CLASS TS_TrustorRep_ClRep_POFBU( Report:OBJECT )
  VAR m_Report = Report, m_KindRep, НачалоГода = Date(0,0,0), m_SheetName, m_IsFirstPrint = true;
  VAR m_OrderOFBU:TS_OrderFD;
  var m_RepSign = TS_ReportData();

  MACRO EndTable()
    m_Report.EndTable();
    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, m_Report.GetTableRange(), 0 );
  END;

  PRIVATE MACRO PrintReportHead()
    var Trustor = m_Report.m_OrderFD.Trustor(),
        TrustorName:string      = "",
        TrustorShortName:string = "";
    if( Trustor != NULL )
       TrustorName      = Trustor.rec.Name;
       TrustorShortName = Trustor.rec.ShortName;
    end;
    m_Report.PrintFormatString( ReportHeader,
                                "H8_0",  TS_IIF(m_Report.m_ItogReport, "ИТОГОВЫЙ ОТЧЕТ", "ОТЧЕТ"),
                                "H8_1",  m_OrderOFBU.Number() + " " + m_OrderOFBU.Name(),
                                "H8_2",  TS_IIF(m_Report.m_OrderFD.УчредительФизЛицо(), TrustorName, TrustorShortName),
                                "H8_3",  m_Report.ReportPeriod(false)
                              );
    if( m_IsFirstPrint )
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H8_Head", 0 );
       m_IsFirstPrint = false;
    else
       m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H8_Head", 1 );
    end;
  END;

  PRIVATE MACRO СуммаПроводокПоКатегории( CatCode:string, DebKred:integer, BegDate:Date, EndDate:Date )
    var Query, SqlQuery, DataSet;

    SqlQuery = RSDCommand(" select NVL(SUM(arh.t_Sum_Payer),0) as ArhSum                                  " +
                          "   from dacctrn_dbt arh,                                                       " +
                          "        (select distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                          "           from dmcaccdoc_dbt accdoc, dmccateg_dbt categ                       " +
                          "          where accdoc.t_ClientContrID = ?                                     " +
                          "            and accdoc.t_CatID    = categ.t_ID                                 " +
                          "            and categ.t_LevelType = 1                                          " +
                          "            and categ.t_Code      = ?                                          " +
                          "        ) acc                                                                  " +
                          "  where arh.t_FIID_Payer = acc.t_Currency                                   " +
                          "    and arh.t_State = 1 " +
                          "    and arh.t_chapter = acc.t_Chapter                                          " +
                          "    and (case when ? = 1 then arh.t_account_payer else arh.t_account_receiver end) = acc.t_Account " +
                          "    and arh.t_date_carry >= ?                                                  " +
                          "    and arh.t_date_carry <= ?                                                  " );

    SqlQuery.addParam("", RSDBP_IN, m_OrderOFBU.Order().rec.SfcontrID);
    SqlQuery.addParam("", RSDBP_IN, CatCode);
    SqlQuery.addParam("", RSDBP_IN, DebKred);
    SqlQuery.addParam("", RSDBP_IN, BegDate );
    SqlQuery.addParam("", RSDBP_IN, EndDate);
    SqlQuery.execute();                                       

    DataSet = TRsbDataSet(SqlQuery);
    if( DataSet.MoveNext() )
       return DataSet.ArhSum;
    end;

    return $0.;
  END;

  PRIVATE MACRO ПечатьОбщиеДанныеПоОФБУ()

    var СЧА:money = $0.0, ПолученоДоходов:money = $0.0, ПонесеноРасходов:money = $0.0;
    var Кm_beg_add:MONEY = $0.0, Кm_end_add:MONEY = $0.0;
    var Кo_beg_add:MONEY = $0.0, Кo_end_add:MONEY = $0.0;

    m_Report.PrintFormatString( ReportHeader, "H8_4", "Текущая стоимость активов фонда (руб.) на " + string(m_Report.PanelEndDate() + 1) );
    m_Report.PrintFormatString( ReportHeader, "H8_5", "Общее количество номинальных паев ОФБУ на " + string(m_Report.PanelEndDate() + 1) + " в шт." );

    if( ПолучитьИтогДУ(m_OrderOFBU.Order().rec.ID, ДУ_ИТОГ_СЧА, NULL, 0, NULL, NULL, NULL, m_Report.PanelEndDate(), NULL, NULL, @СЧА, 0, 0) )
       СЧА = $0;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_1_1", СЧА );

    m_Report.PrintFormatString( ReportHeader, "A8_1_2", m_OrderOFBU.КоличествоПаев(m_Report.PanelEndDate()) );
    m_Report.PrintFormatString( ReportHeader, "A8_1_3", m_OrderOFBU.СНП(m_Report.PanelEndDate() + 1) ); /*!!! точность*/

    ПолученоДоходов = СуммаПроводокПоКатегории( "Доходы ДУ", SIDE_KRED, m_Report.PanelBeginDate(), m_Report.PanelEndDate() ) + СуммаПроводокПоКатегории( "ДоходыЭцб ДУ", SIDE_KRED, m_Report.PanelBeginDate(), m_Report.PanelEndDate() );
    ПонесеноРасходов = СуммаПроводокПоКатегории( "Расходы ДУ", SIDE_DEB, m_Report.PanelBeginDate(), m_Report.PanelEndDate() ) + СуммаПроводокПоКатегории( "РасходыЭцб ДУ", SIDE_DEB, m_Report.PanelBeginDate(), m_Report.PanelEndDate() );

    m_Report.PrintFormatString( ReportHeader, "A8_1_4", ПолученоДоходов );
    m_Report.PrintFormatString( ReportHeader, "A8_1_5", ПонесеноРасходов );

    if(ПолучитьИтогДУ(m_OrderOFBU.Order().rec.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, m_Report.PanelBeginDate()-1, @Кm_beg_add, NULL, NULL))
       Кm_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_OrderOFBU.Order().rec.ID, ДУ_ИТОГ_Н_Купр, NULL, 0, NULL, NULL, NULL, m_Report.PanelEndDate(), @Кm_end_add, NULL, NULL))
       Кm_end_add = $0.0;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_1_6", Кm_end_add - Кm_beg_add );

    if(ПолучитьИтогДУ(m_OrderOFBU.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, m_Report.PanelBeginDate()-1, @Кo_beg_add, NULL, NULL))
       Кo_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_OrderOFBU.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, m_Report.PanelEndDate(), @Кo_end_add, NULL, NULL))
       Кo_end_add = $0.0;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_1_7", Кo_end_add - Кo_beg_add );

    m_Report.PrintFormatString( ReportHeader, "A8_1_8", ПолученоДоходов - ПонесеноРасходов );

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H8_Head2", 0 );

  END;

  PRIVATE CLASS СКПоДатам( Дата_:Date, СК_ )
     VAR Дата = Дата_,
         СК   = СК_;
  END;

  PRIVATE MACRO ПриростДолиЗаПериод( BegDate:date, EndDate:date ):money
     var RSD, DS;
     var СП1_1= 0.0, RestLot= 0.0,СП2= 0.0, СП1_2_i= 0.0, СП1_2_j= 0.0, СНП= 0.0,
         КУС_79 = TS_DemandEvent("79");

     if( ПолучитьИтогДУ( m_Report.m_OrderFD.ID, ДУ_СтПУ, КУС_79, 0, NULL, 0, 0, BegDate-1, NULL, NULL, @СП1_1 ) )
        MsgBox( "Ошибка при получении итога \"СтПУ\"по договору" );
        return 0;
     end;

     if( ПолучитьИтогДУ( m_Report.m_OrderFD.ID, ДУ_СтПУ, КУС_79, 0, NULL, 0, 0, EndDate+1, NULL, NULL, @СП2 ) )
        MsgBox( "Ошибка при получении итога \"СтПУ\"по договору" );
        return 0;
     end;

     RSD = RSDCommand( "SELECT req.t_Direction, asset.t_Amount "+
                       "  FROM DTSIORQST_DBT req, DTSREQASSETS_DBT asset "+
                       " WHERE req.t_ID = asset.t_RequestID "+
                       "       AND req.t_OrderID = ? "+
                       "       AND req.t_CapitalDate between ? AND ? "+
                       "       AND req.t_Status >= ? "
                     );

     RSD.addParam("", RSDBP_IN, m_Report.m_OrderFD.ID );
     RSD.addParam("", RSDBP_IN, BegDate);
     RSD.addParam("", RSDBP_IN, EndDate);
     RSD.addParam("", RSDBP_IN, TS_IOREQ_STATE_EXEC );
     RSD.execute();

     DS = TRsbDataSet( RSD );

     while( DS.MoveNext() )
        if( DS.Direction == TS_IOREQ_DIRECTION_OUT )
           СП1_2_j = СП1_2_j + DS.Amount;
        else     
           СП1_2_i = СП1_2_i + DS.Amount;
        end;
     end;

     return (СП2-(СП1_1+(СП1_2_i-СП1_2_j) ) );
  END;

  PRIVATE MACRO ПечатьДанныеЗаОтчетныйПериод()

    var FirstRec = true, LastRec = true;
    var SqlQuery, DataSet;

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H8_Head3", 0 );
    m_Report.RegisterTable( "MainTable_8_2", TableHeader,
                            "A8_2_1", "A8_2_2", "A8_2_3", "A8_2_4", "A8_2_5", "A8_2_6", "A8_2_7", "A8_2_8" );

    SqlQuery = RSDCommand( " select tstotal.t_BeginDate, tstotal.t_Sign, " +
                           "        NVL((select tstot.t_RestAmount       " +
                           "               from dtstotal_dbt tstot       " +
                           "              where tstot.t_BeginDate = tstotal.t_BeginDate " +
                           "                and tstot.t_DocKind   = tstotal.t_DocKind   " +
                           "                and tstot.t_DocID     = tstotal.t_DocID     " +
                           "                and tstot.t_TotalType = ?    " +
                           "                and rownum = 1 ), 0) as RestKPU, " +
                           "        NVL((select tstot.t_RestAmount       " +
                           "               from dtstotal_dbt tstot       " +
                           "              where tstot.t_BeginDate = tstotal.t_BeginDate " +
                           "                and tstot.t_DocKind   = tstotal.t_DocKind   " +
                           "                and tstot.t_DocID     = tstotal.t_DocID     " +
                           "                and tstot.t_TotalType = ?    " +
                           "                and rownum = 1 ), 0) as RestStPU " +
                           "   from dtstotal_dbt tstotal     " +
                           "  where tstotal.t_totaltype = ?  " +
                           "    and tstotal.t_orderid   = ?  " +
                           "    and tstotal.t_BeginDate <= ? " +
                           "    and tstotal.t_BeginDate >= ? " +
                           " order by tstotal.t_BeginDate    " );

    SqlQuery.addParam("", RSDBP_IN, ДУ_КПУ                            );
    SqlQuery.addParam("", RSDBP_IN, ДУ_СтПУ                           );
    SqlQuery.addParam("", RSDBP_IN, ДУ_ИТОГ_СК                        );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_OrderFD.Order().rec.ID );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate()              );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_BeginDate()            );
    SqlQuery.execute();
    DataSet = TRsbDataSet(SqlQuery);

    while( DataSet.MoveNext() )

       if( FirstRec and (SQL_ConvTypeDate(DataSet.BeginDate) != m_Report.m_BeginDate()) ) /* первая строка если нет итога */
          m_Report.PrintTableLine( "A8_2_1", m_Report.m_BeginDate(),                                             null,
                                   "A8_2_2", "",                                                                 null,
                                   "A8_2_3", m_Report.m_OrderFD.СНП(m_Report.m_BeginDate()),                     m_OrderOFBU.Order().rec.DP_NominalPrecision,
                                   "A8_2_4", 0,                                                                  m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                   "A8_2_5", 0,                                                                  null,
                                   "A8_2_6", m_Report.m_OrderFD.КоличествоПаев(m_Report.m_BeginDate()),          m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                   "A8_2_7", m_Report.m_OrderFD.СтоимостьПаевУчредителя(m_Report.m_BeginDate()), null,
                                   "A8_2_8", "",                                                                 null );
       end;

       if( SQL_ConvTypeDate(DataSet.BeginDate) == m_Report.m_EndDate() ) /* последняя строка */
          LastRec = false;
       end;

       m_Report.PrintTableLine( "A8_2_1", SQL_ConvTypeDate(DataSet.BeginDate),                                                       null,
                                "A8_2_2", TS_IIF((SQL_ConvTypeInteger(DataSet.Sign) > 0), "ввод средств", "вывод средств"),          null,
                                "A8_2_3", m_Report.m_OrderFD.СНП(SQL_ConvTypeDate(DataSet.BeginDate)),                               m_OrderOFBU.Order().rec.DP_NominalPrecision,
                                "A8_2_4", SQL_ConvTypeSum(DataSet.RestKPU),                                                          m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                "A8_2_5", SQL_ConvTypeSum(DataSet.RestStPU),                                                         null,
                                "A8_2_6", m_Report.m_OrderFD.КоличествоПаев(SQL_ConvTypeDate(DataSet.BeginDate)),                    m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                "A8_2_7", m_Report.m_OrderFD.СтоимостьПаевУчредителя(SQL_ConvTypeDate(DataSet.BeginDate)),           null,
                                "A8_2_8", TS_IIF(LastRec, "", ПриростДолиЗаПериод( m_Report.m_BeginDate(), m_Report.m_EndDate() ) ), null );

       FirstRec = false;
    end;

    if(FirstRec) /* не было первой строки*/
       m_Report.PrintTableLine( "A8_2_1", m_Report.m_BeginDate(),                                             null,
                                "A8_2_2", "",                                                                 null,
                                "A8_2_3", m_Report.m_OrderFD.СНП(m_Report.m_BeginDate()),                     m_OrderOFBU.Order().rec.DP_NominalPrecision,
                                "A8_2_4", 0,                                                                  m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                "A8_2_5", 0,                                                                  null,
                                "A8_2_6", m_Report.m_OrderFD.КоличествоПаев(m_Report.m_BeginDate()),          m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                "A8_2_7", m_Report.m_OrderFD.СтоимостьПаевУчредителя(m_Report.m_BeginDate()), null,
                                "A8_2_8", "",                                                                 null );
    end;

    if(LastRec) /* не было последней строки */
       m_Report.PrintTableLine( "A8_2_1", m_Report.m_EndDate(),                                                null,
                                "A8_2_2", "",                                                                  null,
                                "A8_2_3", m_Report.m_OrderFD.СНП(m_Report.m_EndDate()),                        m_OrderOFBU.Order().rec.DP_NominalPrecision,
                                "A8_2_4", 0,                                                                   m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                "A8_2_5", 0,                                                                   null,
                                "A8_2_6", m_Report.m_OrderFD.КоличествоПаев(m_Report.m_EndDate()),             m_OrderOFBU.Order().rec.DP_AmountPrecision,
                                "A8_2_7", m_Report.m_OrderFD.СтоимостьПаевУчредителя(m_Report.m_EndDate()),    null,
                                "A8_2_8", ПриростДолиЗаПериод( m_Report.m_BeginDate(), m_Report.m_EndDate() ), null );
    end;

    EndTable();

  END;

  PRIVATE MACRO ПечатьДанныеСНачалаДействия()

    var СК = TArray(), Sum;
    var SqlQuery, DataSet;
    var BegDate = TS_GetLastProlongDate(m_Report.m_OrderFD.Order().rec.ID, m_Report.m_EndDate) + 1;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.ДатаПервичногоВнесения();
    end;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.BeginDate();
    end;

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H8_Head4", 0 );
    m_Report.RegisterTable( "MainTable_8_3", TableHeader,
                            "A8_3_1", "A8_3_2", "A8_3_3", "A8_3_4" );

    /* создадим массив со значениями СК по датам */
    СК.Size = 0;
    if( ПолучитьИтогДУ( m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, BegDate, NULL, NULL, @Sum ) )
       Sum = $0;
    end;
    СК[СК.Size] = СКПоДатам(BegDate, Sum);

    SqlQuery = RSDCommand( " select t_BeginDate     " +
                           "   from dtstotal_dbt    " +
                           "  where t_totaltype = ? " +
                           "    and t_orderid   = ? " +
                           "    and t_BeginDate < ? " +
                           "    and t_BeginDate > ? " +
                           " order by t_BeginDate   " );

    SqlQuery.addParam("", RSDBP_IN, ДУ_ИТОГ_СК                        );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_OrderFD.Order().rec.ID );
    SqlQuery.addParam("", RSDBP_IN, m_Report.m_EndDate                );
    SqlQuery.addParam("", RSDBP_IN, BegDate                           );
    SqlQuery.execute();
    DataSet = TRsbDataSet(SqlQuery);

    while( DataSet.MoveNext() )
       if( ПолучитьИтогДУ( m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_СК, NULL, 0, NULL, NULL, NULL, SQL_ConvTypeDate(DataSet.BeginDate), NULL, NULL, @Sum ) )
          Sum = $0;
       end;
       СК[СК.Size] = СКПоДатам(SQL_ConvTypeDate(DataSet.BeginDate)-1, Sum);
    end;
    СК[СК.Size] = СКПоДатам(m_Report.m_EndDate, 0); /*значение итога нам не надо, поэтому запишем 0*/

    var i=0;
    var ДатаНачала:date;
    var ItogPeriod:integer = 0;
    while(i < (СК.Size-1))
       ДатаНачала = СК[i].Дата + TS_IIF(i==0, 0, 1);
       m_Report.PrintTableLine( "A8_3_1", ДатаНачала,                      null,
                                "A8_3_2", СК[i+1].Дата,                    null,
                                "A8_3_3", (СК[i+1].Дата - ДатаНачала + 1), null,
                                "A8_3_4", СК[i].СК,                        null );
       ItogPeriod = ItogPeriod + (СК[i+1].Дата - ДатаНачала + 1);
       i = i+1;
    end;

    m_Report.PrintTableLine( "A8_3_1", "Средневзвешенный капитал (руб.)",                                                                null,
                             "A8_3_3", ItogPeriod,                                                                                       null,
                             "A8_3_4", m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( BegDate, m_Report.m_EndDate(), false, false), null);
    EndTable();

  END;

  PRIVATE MACRO ПечатьФинансовыйРезультатУчредителя()

    var Ks = $0.0, Kp = $0.0, СрBзвКапЗаПер:money = $0.0, КолДней:integer = 0, ПриростДоли:money = $0.0;
    var A8_4_6:money = $0.0, A8_4_7:money = $0.0, A8_4_8:money = $0.0, A8_4_9:money = $0.0, A8_4_10:money = $0.0, A8_4_11:money = $0.0;
    var Ks_beg_add:MONEY = $0.0, Ks_end_add:MONEY = $0.0;
    var Kp_beg_add:MONEY = $0.0, Kp_end_add:MONEY = $0.0;
    var Nalog_beg_add:MONEY = $0.0, Nalog_end_add:MONEY = $0.0;
    var D_beg_add:MONEY = $0.0, D_end_add:MONEY = $0.0;
    var UseNDFL:bool;
    var BegDate = TS_GetLastProlongDate(m_Report.m_OrderFD.Order().rec.ID, m_Report.m_EndDate) + 1;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.ДатаПервичногоВнесения();
    end;
    if( BegDate == date(0,0,0) )
       BegDate = m_Report.m_OrderFD.BeginDate();
    end;

    m_Report.PrintFormatString( ReportHeader, "H8_6", "Прирост (уменьшение) доли за период с " + string(BegDate) + " по " + string(m_Report.m_EndDate()) );
    ПриростДоли = ПриростДолиЗаПериод( BegDate, m_Report.m_EndDate() );
    m_Report.PrintFormatString( ReportHeader, "A8_4_1", ПриростДоли );

    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, BegDate-1, @Ks_beg_add, NULL, NULL))
       Ks_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кусп, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Ks_end_add, NULL, NULL))
       Ks_end_add = $0.0;
    end;
    Ks = Ks_end_add - Ks_beg_add;
    m_Report.PrintFormatString( ReportHeader, "A8_4_3", Ks );

    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, BegDate-1, @Kp_beg_add, NULL, NULL))
       Kp_beg_add = $0.0;
    end;
    if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Кдв, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Kp_end_add, NULL, NULL))
       Kp_end_add = $0.0;
    end;
    Kp = Kp_end_add - Kp_beg_add;
    m_Report.PrintFormatString( ReportHeader, "A8_4_4", Kp );

    СрBзвКапЗаПер = m_Report.m_OrderFD.СредневзвешенныйКапиталЗаПериод( BegDate, m_Report.m_EndDate(), false, false);
    m_Report.PrintFormatString( ReportHeader, "A8_4_5", СрBзвКапЗаПер );

    КолДней = (m_Report.m_EndDate - BegDate + 1);
    m_Report.PrintFormatString( ReportHeader, "A8_4_6", КолДней );

    if( (СрBзвКапЗаПер != $0.0) and (КолДней != 0) )
       A8_4_7 = (ПриростДоли - Ks - Kp) / СрBзвКапЗаПер / КолДней * ДУ_ДнейВГоду(BegDate) * 100;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_4_7", A8_4_7 );

    UseNDFL = TS_IsPayerNPTaxAllCheck( m_Report.m_OrderFD.Order().rec.Trustor, m_Report.m_EndDate );
    if( m_Report.m_ItogReport and UseNDFL )
       A8_4_8 = max(0, (ПриростДоли - Ks - Kp));
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_4_8", A8_4_8 );

    if( m_Report.m_ItogReport and UseNDFL )
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, BegDate-1, @Nalog_beg_add, NULL, NULL))
          Nalog_beg_add = $0.0;
       end;
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Налог, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @Nalog_end_add, NULL, NULL))
          Nalog_end_add = $0.0;
       end;
       A8_4_9 = Nalog_end_add - Nalog_beg_add;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_4_9", A8_4_9 );

    if( m_Report.m_ItogReport )
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, BegDate-1, @D_beg_add, NULL, NULL))
          D_beg_add = $0.0;
       end;
       if(ПолучитьИтогДУ(m_Report.m_OrderFD.Order().rec.ID, ДУ_ИТОГ_Н_Дх, NULL, 0, NULL, NULL, NULL, m_Report.m_EndDate, @D_end_add, NULL, NULL))
          D_end_add = $0.0;
       end;
       A8_4_10 = D_end_add - D_beg_add;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_4_10", A8_4_10 );

    if( m_Report.m_ItogReport )
       if( (СрBзвКапЗаПер != $0.0) and (КолДней != 0) )
          A8_4_11 = (ПриростДоли - Ks - Kp - A8_4_9) / СрBзвКапЗаПер * ДУ_ДнейВГоду(BegDate) / КолДней * 100;
       end;
    end;
    m_Report.PrintFormatString( ReportHeader, "A8_4_11", A8_4_11 );

    m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "H8_Head5", 0 );

  END;
 
  MACRO ПечатьПодвал()
     m_Report.PrintFormatString( ReportHeader,
                                 "H8_29", m_RepSign.TrustRepresPos,
                                 "H8_30", m_RepSign.TrustChiefShortName,
                                 "H8_31", m_RepSign.OurBankShort );
     m_Report.CopyAllSheetInTotalBook( m_SheetName, false, "N8_Footer", 0 );
  END;

  MACRO BeginReport()
    m_SheetName = "Отчет клиента ПОФБУ";
    m_Report.UseNewSheetInTotalBook();
    m_Report.SetActiveSheet( m_SheetName );
  END;

  MACRO Execute()

    m_Report.TSOrderList_DP(TS_CALCPART_NOMINAL);

    while( m_Report.TsOrderNext() )
       if( m_Report.m_BeginDate() <= m_Report.m_EndDate() )
          ExistPrintFirstSheet = true;
          m_OrderOFBU = TS_OrderFD(0, m_Report.m_OrderFD.Order().rec.OFBU);
          PrintReportHead();
          ПечатьОбщиеДанныеПоОФБУ();
          ПечатьДанныеЗаОтчетныйПериод();
          ПечатьДанныеСНачалаДействия();
          ПечатьФинансовыйРезультатУчредителя();
          ПечатьПодвал();
       end;
    end;

    m_Report.TSOrderEnd();
  END;

  MACRO EndReport()
  END;

END;

/********************************************************************************
Общий класс отчета
********************************************************************************/
PRIVATE CLASS (DL_CReportTemplate) TS_TrustorRep_Report
  VAR m_TSOrders, m_RSD_TSOrder, m_Count = 0, m_NumTSOrders;
  VAR m_Dprt, m_OFBU, m_OFBU_ID, m_IDDU, m_OrderID;
  VAR m_ItogReport, m_ItogPeriod, m_ItogPrevPeriod, m_ItogYear, m_Report, m_Period, m_Year;
  VAR m_IsSecurDeal, m_IsVaDeal, m_IsShare, m_IsBond, m_IsVa;
  VAR m_FormClRep, m_FormClRepWithRate;
  VAR m_PanelBeginDate, m_PanelEndDate;
  VAR m_OrderFD:TS_OrderFD;
  VAR BeginDate:date = date(0,0,0), EndDate:date = date(0,0,0);
  VAR m_ArbitraryReport, m_ArbitraryPeriod, m_ArbitraryBegDate, m_ArbitraryEndDate;

  PRIVATE VAR m_NumSheet = NUM_SHEET_CLREP;

  MACRO Department()
    return m_Dprt;
  END;

  MACRO PanelBeginDate():date
     return m_PanelBeginDate;
  END;

  MACRO PanelEndDate():date
     return m_PanelEndDate;
  END;
 
  MACRO m_BeginDate():date
    var RetVal:date;
    if( BeginDate == date(0,0,0) )
       if( m_OrderFD.Order.rec.DocKind == TS_DOC_OFBU )
          /*тк листы-приложения для ОФБУ формируются в целом по ОФБУ, а не ДП, то ОП определяется аналогично ОП_ф*/
          RetVal = BeginDate = m_PanelBeginDate;
       else
          var BeginProlong = date(0,0,0), LastProlongDate = date(0,0,0);
          if( m_ArbitraryReport )
             RetVal = BeginDate = m_ArbitraryBegDate;
          else
             if( m_ItogReport )
                LastProlongDate = TS_GetLastProlongDate(m_TSOrders.rec.TsOrderID, date(31,12,9999));
                if( LastProlongDate != date(0,0,0) )
                   BeginProlong = m_OrderFD.Valid(LastProlongDate).rec.BeginDate;
                end;
             elif( m_Report )
                LastProlongDate = TS_GetLastProlongDate(m_TSOrders.rec.TsOrderID, m_PanelEndDate);
                BeginProlong = LastProlongDate + 1;
             end;
             RetVal = BeginDate = max(max(m_OrderFD.ДатаПервичногоВнесения(), BeginProlong), m_PanelBeginDate);
          end;
       end;
    else
       RetVal = BeginDate;
    end;

    return RetVal;
  END;

  MACRO m_EndDate():date
    var RetVal:date;
    if( EndDate == date(0,0,0) )
       if( m_OrderFD.Order.rec.DocKind == TS_DOC_OFBU )
          /*тк листы-приложения для ОФБУ формируются в целом по ОФБУ, а не ДП, то ОП определяется аналогично ОП_ф*/
          RetVal = m_PanelEndDate;
       else
          if( m_ItogReport )
             if( m_ItogPeriod == H_PROLONG )
                RetVal = TS_GetLastProlongDate(m_TSOrders.rec.TsOrderID, date(31,12,9999));
             else /* m_ItogPeriod == H_CLOSE */
                RetVal = m_OrderFD.ДатаПолногоВывода();
             end;
          elif( m_Report )
             RetVal = m_PanelEndDate;
          elif( m_ArbitraryReport )
             RetVal = m_ArbitraryEndDate;
          end;
       end;
       EndDate = RetVal;
    else
       RetVal = EndDate;
    end;

    return RetVal;
  END;

  MACRO GetPartyKind( PartyID, PartyKind )
    var ds, rsd = RSDCommand( "select t_PartyKind from dpartyown_dbt where t_PartyID = ? and t_PartyKind = ?" );
    rsd.addParam("", RSDBP_IN, PartyID);
    rsd.addParam("", RSDBP_IN, PartyKind);
    rsd.execute();

    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return true;
    end;
    return false;
  END;

  MACRO GetPartyName( PartyID, IsShort )
    var party = TRecHandler("party"), Name = "";
    if( not ПолучитьСубъекта(PartyID, party) )
       if( IsShort )
          Name = party.rec.ShortName;
       else
          Name = party.rec.Name;
       end;
    end;
    return Name;
  END;

  MACRO ПолучитьВидЦБ( AvrKind )
    var ds, rsd = RSDCommand( "select t_Name from davrkinds_dbt where t_AvoirKind = ?" );
    rsd.addParam("", RSDBP_IN, AvrKind);
    rsd.execute();

    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return ds.Name;
    end;
    return "";
  END;

  MACRO ПолучитьВалютуНоминала( FIID )
    var ds, rsd = RSDCommand( "select t_FaceValueFI from dfininstr_dbt where t_FIID = ?" );
    rsd.addParam("", RSDBP_IN, FIID);
    rsd.execute();

    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       return ds.FaceValueFI;
    end;
    return NATCUR;
  END;

  MACRO ReportPeriod( IsPortf )
    if( IsPortf )
       return "по состоянию на " + (m_EndDate + 1);
    end;

    return " с " + m_BeginDate + " по " + m_EndDate;
  END;

  MACRO TSOrderString()
    var party = TRecHandler("party"), Name = "";
    if( m_TSOrders )
       if( not ПолучитьСубъекта(m_TSOrders.rec.PartyID, party) )
          Name = party.rec.Name;
          if(m_TSOrders.rec.ServKindSub == PTSKS_TRUST_OFBU)
            Name = "ОФБУ " + Name;
          end;
       end;
       return Name + " договор № " + m_TSOrders.rec.Number + " от " + Date(m_TSOrders.rec.DateBegin);
    end;
    return "";
  END;

  MACRO TSOrderList_DP( DP_ShareCalc:integer )

    var ds, rsd;
    var Sel1Head = " select count(1) m_Num ";
    var Sel2Head = " select sfcontr.*, tsorder.t_ID TsOrderID ";
    var Sel2Foot = " order by sfcontr.t_ServKindSub, sfcontr.t_PartyID, sfcontr.t_DateBegin, sfcontr.t_ID ";
    var Select = "  from dsfcontr_dbt sfcontr, dtsorder_dbt tsorder " +
                 " where sfcontr.t_ServKind = ? " +
                 "   and sfcontr.t_ServKindSub = ? " +
                 "   and tsorder.t_SfContrID = sfcontr.t_ID " +
                 "   and tsorder.t_OFBU = (case when(? = -1) then tsorder.t_OFBU else ? end) " +
                 "   and tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end) " +
                 "   and exists ( select t_ID from dtsorder_dbt where t_ID = tsorder.t_OFBU and t_DP_ShareCalc = ? ) ";

    if( m_ItogReport )
       if( m_ItogPeriod == H_PROLONG )
          Select = Select + " and ( select count(1) from dtsvalid_dbt where t_OrderID = tsorder.t_ID ) > 1 ";
       else /* m_ItogPeriod == H_CLOSE */
          Select = Select + " and exists ( SELECT t_ID                     " +
                            "                FROM DTSIORQST_DBT            " +
                            "               WHERE T_ORDERID = tsorder.t_ID " + 
                            "                 AND T_DIRECTION = ?          " +
                            "                 AND T_STATUS > ?             " +
                            "                 AND T_TYPE = ? )             ";
       end;
    end;

    rsd = RSDCommand( Sel1Head + Select );

    rsd.addParam("", RSDBP_IN, PTSK_TRUST);
    rsd.addParam("", RSDBP_IN, IIF(m_OFBU, PTSKS_TRUST_DPOFBU/*выпускается по ДП, не по ОФБУ*/, PTSKS_TRUST_IDDU) );
    rsd.addParam("", RSDBP_IN, m_OFBU_ID );
    rsd.addParam("", RSDBP_IN, m_OFBU_ID );
    rsd.addParam("", RSDBP_IN, m_OrderID );
    rsd.addParam("", RSDBP_IN, m_OrderID );
    rsd.addParam("", RSDBP_IN, DP_ShareCalc );
    if( m_ItogReport and (m_ItogPeriod == H_CLOSE) )
       rsd.addParam( "", RSDBP_IN, TS_IOREQ_DIRECTION_OUT );
       rsd.addParam( "", RSDBP_IN, TS_IOREQ_STATE_REG     );
       rsd.addParam( "", RSDBP_IN, TS_KINDDECLAR_FULL     );
    end;
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       m_NumTSOrders = Int(ds.rec.m_Num);
    end;

    m_RSD_TSOrder = RSDCommand( Sel2Head + Select + Sel2Foot );

    m_RSD_TSOrder.addParam("", RSDBP_IN, PTSK_TRUST);
    m_RSD_TSOrder.addParam("", RSDBP_IN, IIF(m_OFBU, PTSKS_TRUST_DPOFBU/*выпускается по ДП, не по ОФБУ*/, PTSKS_TRUST_IDDU) );
    m_RSD_TSOrder.addParam("", RSDBP_IN, m_OFBU_ID );
    m_RSD_TSOrder.addParam("", RSDBP_IN, m_OFBU_ID );
    m_RSD_TSOrder.addParam("", RSDBP_IN, m_OrderID );
    m_RSD_TSOrder.addParam("", RSDBP_IN, m_OrderID );
    m_RSD_TSOrder.addParam("", RSDBP_IN, DP_ShareCalc );
    if( m_ItogReport and (m_ItogPeriod == H_CLOSE) )
       m_RSD_TSOrder.addParam( "", RSDBP_IN, TS_IOREQ_DIRECTION_OUT );
       m_RSD_TSOrder.addParam( "", RSDBP_IN, TS_IOREQ_STATE_REG     );
       m_RSD_TSOrder.addParam( "", RSDBP_IN, TS_KINDDECLAR_FULL     );
    end;
    m_RSD_TSOrder.execute();
    m_TSOrders = TRsbDataSet( m_RSD_TSOrder );

    m_Count = 0;
    InitProgress( m_NumTSOrders, "Обработка договоров доверительного управления", "Обработка договоров доверительного управления" );
  END;

  MACRO TSOrderList(LegalForm)

    var ds, rsd = RSDCommand( "select count(1) m_Num " +
                              "  from dsfcontr_dbt sfcontr, dparty_dbt party, dtsorder_dbt tsorder " +
                              " where sfcontr.t_ServKind = ? " +
                              "   and sfcontr.t_ServKindSub = ? " +
                              "   and tsorder.t_SfContrID = sfcontr.t_ID " +
                              "   and tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end) " +
                              "   and tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end) " +
                              "   and party.t_PartyID = sfcontr.t_PartyID " +
                              "   and ( party.t_LegalForm = ? or -1 = ? ) " );

    rsd.addParam("", RSDBP_IN, PTSK_TRUST);
    rsd.addParam("", RSDBP_IN, IIF(m_OFBU, PTSKS_TRUST_OFBU, PTSKS_TRUST_IDDU) );
    rsd.addParam("", RSDBP_IN, m_OFBU_ID );
    rsd.addParam("", RSDBP_IN, m_OFBU_ID );
    rsd.addParam("", RSDBP_IN, IIF(m_IDDU, m_OrderID, -1) );
    rsd.addParam("", RSDBP_IN, IIF(m_IDDU, m_OrderID, -1) );
    rsd.addParam("", RSDBP_IN, IIF(LegalForm and m_IDDU, LegalForm, -1) );
    rsd.addParam("", RSDBP_IN, IIF(LegalForm and m_IDDU, LegalForm, -1) );
    rsd.execute();
    ds = TRsbDataSet( rsd );
    if( ds.MoveNext() )
       m_NumTSOrders = Int(ds.rec.m_Num);
    end;

    m_RSD_TSOrder = RSDCommand( "select sfcontr.*, party.t_LegalForm, tsorder.t_ID TsOrderID " +
                                "  from dsfcontr_dbt sfcontr, dparty_dbt party, dtsorder_dbt tsorder " +
                                " where sfcontr.t_ServKind = ? " +
                                "   and sfcontr.t_ServKindSub = ? " +
                                "   and tsorder.t_SfContrID = sfcontr.t_ID " +
                                "   and tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end) " +
                                "   and tsorder.t_ID = (case when(? = -1) then tsorder.t_ID else ? end) " +
                                "   and party.t_PartyID = sfcontr.t_PartyID " +
                                "   and ( party.t_LegalForm = ? or -1 = ? ) " +
                                " order by sfcontr.t_ServKindSub, sfcontr.t_PartyID, sfcontr.t_DateBegin, sfcontr.t_ID" );

    m_RSD_TSOrder.addParam("", RSDBP_IN, PTSK_TRUST);
    m_RSD_TSOrder.addParam("", RSDBP_IN, IIF(m_OFBU, PTSKS_TRUST_OFBU, PTSKS_TRUST_IDDU) );
    m_RSD_TSOrder.addParam("", RSDBP_IN, m_OFBU_ID );
    m_RSD_TSOrder.addParam("", RSDBP_IN, m_OFBU_ID );
    m_RSD_TSOrder.addParam("", RSDBP_IN, IIF(m_IDDU, m_OrderID, -1) );
    m_RSD_TSOrder.addParam("", RSDBP_IN, IIF(m_IDDU, m_OrderID, -1) );
    m_RSD_TSOrder.addParam("", RSDBP_IN, IIF(LegalForm and m_IDDU, LegalForm, -1) );
    m_RSD_TSOrder.addParam("", RSDBP_IN, IIF(LegalForm and m_IDDU, LegalForm, -1) );
    m_RSD_TSOrder.execute();
    m_TSOrders = TRsbDataSet( m_RSD_TSOrder );

    m_Count = 0;
    InitProgress( m_NumTSOrders, "Обработка договоров доверительного управления", "Обработка договоров доверительного управления" );
  END;

  MACRO TSOrderNext()
    var RetVal = false;
    UseProgress(m_Count = m_Count + 1);
    if(m_TSOrders.MoveNext())
       m_OrderFD = TS_OrderFD(0, m_TSOrders.rec.TsOrderID);
       BeginDate = EndDate = date(0,0,0); /*обнулим даты*/
       RetVal = true;
    end;
    return RetVal;
  END;

  MACRO TSOrderEnd()
    RemProgress();
  END;

  PRIVATE MACRO PrintMode():INTEGER
     return m_Form.GetFieldValue( PNFLD_TRUSTORREP_PRINTMETHOD );
  END;

  PRIVATE MACRO BeginReport()

    m_Dprt              = m_Form.GetFieldValue( PNFLD_TRUSTORREP_DPRTNUM );
    m_OFBU              = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_OFBU ) == SET_CHAR);
    m_OFBU_ID           = m_Form.GetFieldValue( PNFLD_TRUSTORREP_OFBU_CODE );
    m_IDDU              = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_IDDU ) == SET_CHAR);
    m_OrderID           = m_Form.GetFieldValue( PNFLD_TRUSTORREP_CONTR );
    m_ItogReport        = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ITOGREPORT ) == SET_CHAR);
    m_ItogPeriod        = m_Form.GetFieldValue( PNFLD_TRUSTORREP_ITOGPERIOD );
    m_ItogPrevPeriod    = m_Form.GetFieldValue( PNFLD_TRUSTORREP_ITOGPREVPERIOD );
    m_ItogYear          = m_Form.GetFieldValue( PNFLD_TRUSTORREP_ITOGYEAR );
    m_Report            = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_REPORT ) == SET_CHAR);
    m_Period            = m_Form.GetFieldValue( PNFLD_TRUSTORREP_PERIOD );
    m_Year              = m_Form.GetFieldValue( PNFLD_TRUSTORREP_YEAR );
    m_ArbitraryReport   = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ARBITRARYREPORT ) == SET_CHAR);
    m_ArbitraryPeriod   = m_Form.GetFieldValue( PNFLD_TRUSTORREP_ARBITRARYPERIOD );
    m_ArbitraryBegDate  = m_Form.GetFieldValue( PNFLD_TRUSTORREP_ARBITRARYBEGDATE );
    m_ArbitraryEndDate  = m_Form.GetFieldValue( PNFLD_TRUSTORREP_ARBITRARYENDDATE );
    m_FormClRep         = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_FORMCLREP ) == SET_CHAR);
    m_FormClRepWithRate = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_WITHCALCRATE ) == SET_CHAR);
    m_IsSecurDeal       = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ISSECURDEAL ) == SET_CHAR);
    m_IsVaDeal          = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ISVADEAL ) == SET_CHAR);
    m_IsShare           = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ISSHARE ) == SET_CHAR);
    m_IsBond            = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ISBOND ) == SET_CHAR);
    m_IsVa              = (m_Form.GetFieldValue( PNFLD_TRUSTORREP_ISVA ) == SET_CHAR);

    if( m_ItogReport )
       var Period, Year;
       Period = m_ItogPrevPeriod + 1;
       Year = m_ItogYear;
       if(Period == 13 )
          Period = 1;
          Year = Year + 1;
       end;
       if(Period == 17 )
          Period = 13;
          Year = Year + 1;
       end;
       Period_GetInterval( Period, Year, @m_PanelBeginDate, @m_PanelEndDate, false );
    elif( m_Report )
       Period_GetInterval( m_Period, m_Year, @m_PanelBeginDate, @m_PanelEndDate, false );
    elif( m_ArbitraryReport )
       var mm1, yyyy1, mm2, yyyy2, Quartal1, Quartal2;
       DateSplit( m_ArbitraryBegDate, null, mm1, yyyy1);
       DateSplit( m_ArbitraryEndDate, null, mm2, yyyy2);
       if( m_ArbitraryPeriod == H_MONTH )
          m_PanelBeginDate = date(1, mm1, yyyy1);
          m_PanelEndDate   = date(LastDay(mm2, yyyy2), mm2, yyyy2);
       else /* H_QUARTER */
          Quartal1 = (mm1-1) / 3 + 1;
          Period_GetInterval( Quartal1 + 12, yyyy1, @m_PanelBeginDate, null, false );
          Quartal2 = (mm2-1) / 3 + 1;
          Period_GetInterval( Quartal2 + 12, yyyy2, null, @m_PanelEndDate, false );
       end;
    end;

    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    if( (ExistPrintFirstSheet == false) and (ExistPrintVAPortf == false) and (ExistPrintSharePortf == false) and
        (ExistPrintBondPortf == false) and (ExistPrintVADeal == false) and (ExistPrintSecurDeal == false) )
       UseNewSheetInTotalBook();
       SetActiveSheet( "NoData" );
       PrintFormatString( "", "N9_NoData", "Нет данных для формирования отчета." );
       CopyAllSheetInTotalBook( "NoData", false, "N9_All", 0 );
    end;

    SaveTotalBook();
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    ObjReport.BeginReport();

    ObjReport.Execute();

    ObjReport.EndReport();
  END;

  PRIVATE MACRO Create()
    ExistPrintFirstSheet = false; ExistPrintVAPortf = false; ExistPrintSharePortf = false;
    ExistPrintBondPortf = false; ExistPrintVADeal = false; ExistPrintSecurDeal = false;

    if( m_FormClRep )
       if(m_IDDU)
          m_NumSheet = NUM_SHEET_CLREP;
          ExecuteReport( TS_TrustorRep_ClRep(this, KINDREP_CL) );
          if( m_FormClRepWithRate )
             m_NumSheet = NUM_SHEET_CALCRATE;
             ExecuteReport( TS_TrustorRep_ClRep(this, KINDREP_CLRATE) );
          end;
       else
          m_NumSheet = NUM_SHEET_CLREP_DOFBU;
          ExecuteReport( TS_TrustorRep_ClRep_DOFBU(this) );
          m_NumSheet = NUM_SHEET_CLREP_POFBU;
          ExecuteReport( TS_TrustorRep_ClRep_POFBU(this) );
       end;
    end;
    if( m_IsVa )
       m_NumSheet = NUM_SHEET_VAPORTF;
       ExecuteReport( TS_TrustorRep_VAPortf(this) );
    end;
    if( m_IsShare )
       m_NumSheet = NUM_SHEET_SHAREPORTF;
       ExecuteReport( TS_TrustorRep_SharePortf(this) );
    end;
    if( m_IsBond )
       m_NumSheet = NUM_SHEET_BONDPORTF;
       ExecuteReport( TS_TrustorRep_BondPortf(this) );
    end;
    if( m_IsVaDeal )
       m_NumSheet = NUM_SHEET_VADEAL;
       ExecuteReport( TS_TrustorRep_VADeal(this) );
    end;
    if( m_IsSecurDeal )
       m_NumSheet = NUM_SHEET_SECURDEAL;
       ExecuteReport( TS_TrustorRep_SecurDeal(this) );
    end; 
  END;
  
  initDL_CReportTemplate( TS_TrustorRep_Panel(), "report_tsTrustor.xls" );
END;

TS_TrustorRep_Report().Run();
Exit(1);
