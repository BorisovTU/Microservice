/* IAL XX.11.2008                                               */
/*                                                             */   
/* ДУ (Доверительное управление )                              */
/*                                                             */

/* Операция покупки ц/б на бирже (или через брокера)           */
/*   Шаг - закрытие операции в режиме Offline                  */
import "tssec.mac";

macro ExecuteStep( Doc, FDoc )
  record deal(dl_tick);       
  var    contrID, FD, error; 

  SetBuff( deal, FDoc ); 
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_SALE) );

  if( not FD.ПроверитьКомиссии( FD.pmwrtsum.rec ) )
     return SayErrorBuySale( deal,"Обработаны не все комиссии" );
  end;

  if( not ВыполненыВсеПроводки( FD, error ) )
     return SayErrorBuySale( deal, error );
  end;
  
  if( SvOpIsServiceOper == true )
     SvOpReportLineData[SvOpReportLineData.Size] = SvOpDeal( deal, FD.IsBack );
  end;
  return 0;
end;
