/*******************************************************************************
 DESCRIPTION  :   Отчет "Субрегистр иных операций ДУ"
 PROGRAMMED BY:   Shalygo S.M.
 CREATION DATE:   07.07.09
*******************************************************************************/

IMPORT FIInter,"DLReport_h.mac";
IMPORT "tssregoper_form.mac";

PRIVATE VAR  m_Form = TS_RegOper_Panel();

private const DEALSTATUS_ALL    = -1,  /* Все сделки */
              DEALSTATUS_CLOSED = 20,  /* Закрытые */
              DEALSTATUS_OPENED = 10;  /* Открытые */

PRIVATE MACRO UpdateFormFields():INTEGER
  TSRegOperData.IsIss               = m_Form.GetFieldValue( PNFLD_REGOPER_ISS );
  TSRegOperData.IsNotIss            = m_Form.GetFieldValue( PNFLD_REGOPER_NOT_ISS );
  TSRegOperData.BeginDate           = m_Form.GetFieldValue( PNFLD_REGOPER_BEGINDATE );
  TSRegOperData.EndDate             = m_Form.GetFieldValue( PNFLD_REGOPER_FINISHDATE );
  TSRegOperData.SplitByDates        = m_Form.GetFieldValue( PNFLD_REGOPER_SPLIT_BY_DATES );
  TSRegOperData.SecurKind           = m_Form.GetFieldValue( PNFLD_REGOPER_SECUR_KIND );
  TSRegOperData.Issuer              = m_Form.GetFieldValue( PNFLD_REGOPER_ISSUER );
  TSRegOperData.SecurCode           = m_Form.GetFieldValue( PNFLD_REGOPER_SECUR_CODE );
  TSRegOperData.IsClientOFBU        = m_Form.GetFieldValue( PNFLD_REGOPER_IS_CLIENT_OFBU );
  TSRegOperData.ClientID            = m_Form.GetFieldValue( PNFLD_REGOPER_CLIENT_OFBU );

  TSRegOperData.ClientContr         = m_Form.GetFieldValue( PNFLD_REGOPER_CLIENTCONTR );

  TSRegOperData.isOperClosed        = m_Form.GetFieldValue( PNFLD_REGOPER_DEALTYPE_CLOSED );
  TSRegOperData.isOperOpened        = m_Form.GetFieldValue( PNFLD_REGOPER_DEALTYPE_OPENED );
  TSRegOperData.isOperAll           = m_Form.GetFieldValue( PNFLD_REGOPER_DEALTYPE_ALL );
  TSRegOperData.OperKind            = m_Form.GetFieldValue( PNFLD_REGOPER_OPER_KIND );
  TSRegOperData.DepoID              = m_Form.GetFieldValue( PNFLD_REGOPER_DEPO );
  TSRegOperData.isOnORCB            = m_Form.GetFieldValue( PNFLD_REGOPER_ON_ORCB );
  TSRegOperData.Exchange            = m_Form.GetFieldValue( PNFLD_REGOPER_EXCGANGE );
  TSRegOperData.isNotOnORCB         = m_Form.GetFieldValue( PNFLD_REGOPER_NOT_ON_ORCB );
  TSRegOperData.IsUseOpostrofs      = m_Form.GetFieldValue( PNFLD_REGOPER_WITH_APOSTROFS );
  TSRegOperData.IsExportToExel      = m_Form.GetFieldValue( PNFLD_REGOPER_TO_EXEL );
  TSRegOperData.DepartmentID        = m_Form.GetFieldValue( PNFLD_REGOPER_DEPARTMENT );

  if(TSRegOperData.isOperClosed == "X")
    TSRegOperData.OperStatus = DEALSTATUS_CLOSED;
  elif(TSRegOperData.isOperOpened == "X")
    TSRegOperData.OperStatus = DEALSTATUS_OPENED;
  else
    TSRegOperData.OperStatus = DEALSTATUS_ALL;
  end;
  
END;



macro MakeReports()

  while(m_Form.Run())

     UpdateFormFields();
  
     if (TSRegOperData.IsNotIss == "X" )
        ExecMacroFile("trvasregop.mac", "TRVASubRegistrReport",
                       TSRegOperData.DepartmentID,
                       TSRegOperData.SecurKind,
                       TSRegOperData.Issuer,
                       TSRegOperData.SecurCode,
                       TSRegOperData.IsClientOFBU,
                       TSRegOperData.ClientID,
                       TSRegOperData.ClientContr,
                       TSRegOperData.DepoID,
                       TSRegOperData.OperKind,
                       TSRegOperData.isOnORCB,
                       TSRegOperData.Exchange,
                       TSRegOperData.isNotOnORCB,
                       TSRegOperData.BeginDate,
                       TSRegOperData.EndDate,
                       TSRegOperData.SplitByDates,
                       TSRegOperData.OperStatus,
                       TSRegOperData.IsUseOpostrofs,
                       TSRegOperData.IsExportToExel
                     );
     end;  

     if(TSRegOperData.IsIss == "X" )
        ExecMacroFile("ts_sregop.mac", "SubRegistrReport",
                       TSRegOperData.DepartmentID,
                       TSRegOperData.SecurKind,
                       TSRegOperData.Issuer,
                       TSRegOperData.SecurCode,
                       TSRegOperData.ClientID,
                       TSRegOperData.ClientContr,
                       TSRegOperData.DepoID,
                       TSRegOperData.OperKind,
                       TSRegOperData.isOnORCB,
                       TSRegOperData.Exchange,
                       TSRegOperData.isNotOnORCB,
                       TSRegOperData.BeginDate,
                       TSRegOperData.EndDate,
                       TSRegOperData.SplitByDates,
                       TSRegOperData.OperStatus,
                       TSRegOperData.IsUseOpostrofs,
                       TSRegOperData.IsExportToExel
                     );
     end;
  end;

end;

MakeReports();
exit(1);
