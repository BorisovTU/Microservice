/* IAL 11 November 2008                               */
/*                                                    */   
/* ДУ (Доверительное управление )                     */
/*                                                    */
/* Операция покупки ц/б внебиржевая  ДУ               */
/* Исполнение обязательств: оплата сделки             */

import InsCarryDoc, "tssec.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation )
  
  record deal(dl_tick);
  record fiwarnts(fiwarnts);

  var    FD, dat;


  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  GetOprDate( FD.GetKindDate(DATE_DEALDATE), dat );
  if( dat > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( FD.ВидСрочностиСделки() != СделкаToday )
     if( not ПроводкаПоКатегориямУчета( FD, 
                                        "ДС ДУ", "+Расчеты, ДУ", /* AccDeb , AccCred*/
                                        dat,                            /* Дата */
                                        2,                              /* Глава */
                                        FD.FaceFIID(),                  /* Валюта */
                                        FD.dl_leg.rec.TotalCost,        /* Сумма */
                                        FDoc,                           /* Документ */
                                        INPCARRY,                       /* Result_Carry */
                                        "",                             /* Kind_Oper */
                                        FD.tick.rec.DealCode,           /* Numb_Document */
                                        "Исполнение требований по оплате ц/б",/* Ground */
                                        0, null, FIROLE_CA,
                                        FD.GetPayFIID(), FD.GetPayFIID()
                                      ) )
         return 1;
     end;
  end;

  if( not ПроставитьСтатусНаПлатеж( FD.pm_money.rec, PM_FINISHED ) )
     return 1;
  end;   

  if( not ОбновитьЛот_ЛотОплачен(FD, dat) )
      return 1;
  end;

  /* Внутренний учет */
  if( not ПроводкаПоКатегориямВнутреннегоУчета( 20, 
                                                FD, 
                                                Doc, 
                                                dat, 
                                                FD.GetPayFIID(), 
                                                FD.dl_leg.rec.TotalCost
                                              ) )
      return 1;
  end;

  if( TS_ExecuteDemandSEC( ID_Operation, TS_DemandUserMarkSEC_ByPaym(FD.pm_money, TS_DEMAND_ROLE_REQUEST), dat ) == false )
     return 1;
  end;

  return 0;
end;  
