/*Проверки ограничений*/

import "tscateg.mac";

MACRO TSCheckLimitMP( OrderID:integer, CheckDate:date, CheckVal:double, LimDicNumder:integer ):bool

   var RetVal:bool = true;
   var MngPlan = TRecHandler( "tsmngpln.dbt" );
   var OrderFD:TS_OrderFD = NULL;
   var Select:string = "", Query, DataSet;

   OrderFD = TS_OrderFD( 0, OrderID );
   if( OrderFD )
      MngPlan = OrderFD.MngPlan( CheckDate );
      if(MngPlan)

         Select = " select limdic.t_Kind, doclim.t_Share, doclim.t_Value, limdic.t_Macro as MacroName " +
                  "   from dtsdoclim_dbt doclim, dtslimdic_dbt limdic                    " +
                  "  where doclim.t_DocKind = ?                                          " +
                  "    and doclim.t_DocID = ?                                            " +
                  "    and limdic.t_ID = doclim.t_LimitDictID                            " +
                  "    and limdic.t_Number = ?                                           " +
                  "    and limdic.t_Distrib = 'X'                                        " + /*1 очередь*/
                  "    and limdic.t_Element = 304                                        ";  /*ПУ*/

         Query = RSDCommand(Select);
         Query.addParam( "", RSDBP_IN, TS_DOC_MNGPLN  );
         Query.addParam( "", RSDBP_IN, MngPlan.rec.ID );
         Query.addParam( "", RSDBP_IN, LimDicNumder   );
         Query.execute();

         DataSet = TRSBDataSet(Query);

         while( DataSet.MoveNext() and (RetVal == true) )
            if(SQL_ConvTypeStr(DataSet.rec.MacroName) != "")
               RetVal = ExecMacroFile(SQL_ConvTypeStr(DataSet.rec.MacroName), "TS_CheckLimit",
                                      TS_IIF(SQL_ConvTypeInteger(DataSet.rec.Kind) == 1, double(DataSet.rec.Value), double(DataSet.rec.Share)),
                                      CheckVal, OrderFD, MngPlan);
            else
               MsgBox("Не задан макрос проверки ограничения.");
            end;
         end;

      end;
   end;

   return RetVal;
END;
