/*/*******************************************************************************
 FILE         :   tsprofitofbu.mac
 DESCRIPTION  :   Отчетная форма "Заявления на выплату прибыли в ОФБУ"
 PROGRAMMED BY:   Nikolskaya V.
 CREATION DATE:   25.05.10
*******************************************************************************/
*/
import "dlwreps.mac", "tscateg.mac", "tssec.mac", "tsrepsign.mac";
import RsbDataSet;

var Order:TS_OrderFD;
var RepSign:TS_ReportData;

private var GrTemp   = TRecHandler( "dlgrtemp.dbt" );
private var SpGround = TRecHandler( "spground.dbt" );
private var TsOrder  = TRecHandler( "tsorder.dbt" );

private macro DateToStr(pDate)

  var str = DL_DateToStr(pDate);

  return ДатаСВедущимНулем(substr(str, 1, strlen(str)-3));  /*отсекём " г."*/
end;

private macro PrintContr( ncopy:integer )
  var TempFile;
  var DocName;
  var OrderFD_OFBU;
  var AutRepFull = "";

  /*Шаблон*/
  [#]( GrTemp.rec.File_Name );

  OrderFD_OFBU = TS_OrderFD( 0, Order.Order().rec.OFBU );
  /*Имя выходного файла*/
  DocName = "ЗаявлВыплПриб_" + SpGround.rec.XLD;
  if( ncopy > 1 )
     /*добавить в название номер копии, иначе будет ошибка при создании, т.к. получим
       несколько документов с одинаковыми именами*/
     DocName = DocName + "_"+ string(ncopy);
  end;

  [#.rtf]( DocName );

  /*Наименование ОФБУ*/
  [~NameOFBU];    
  println( OrderFD_OFBU.Order().rec.Name );

  /*Регистрационный номер ОФБУ*/
  [~ContractDUNumb];
  println( OrderFD_OFBU.Order().rec.RegNum );

  [~ClientShort];
  println( RepSign.ClientReprAlt );

  [~City];
  println( RepSign.City );

  /*Дата приема*/                   
  [~StatementDate];
  println( DateToStr(SpGround.rec.RegistrDate) );

  [~ClientFull];
  println( RepSign.ClientFull );

  [~ClPasspSer];                        
  println( RepSign.ClPasspSer );        
                                     
  [~ClPasspNumb];                       
  println( RepSign.ClPasspNumb );       
                                     
  [~ClPasspGive];                       
  println( RepSign.ClPasspGive );       
                                     
  [~ClPasspGiveDate];                   
  println( TS_IIF(RepSign.ClPasspGiveDate!=Date(0,0,0),DateToStr(RepSign.ClPasspGiveDate),"") );   

  [~ClAddrReg]; 
  if( RepSign.IsTrustorFL )
     println( RepSign.ClientFactAddr );        
  else                      
     println( RepSign.ClientAddr );        
     AutRepFull = RepSign.ClientReprAlt;
  end;
                   
  [~AutRepFull];                                                                                    
  println(AutRepFull);                                                                                                                                                                           

  [~Basis];                                                                                         
  println(RepSign.ClientRepresDoc);                                                               

  [~ClientAcc];
  println(RepSign.ClientSPIAcc);

  [~BankFull];
  println(RepSign.ClientSPIBank);

  [~BankBIC];
  println(RepSign.BICClientSPIBank);

  [~BankINN];
  println(RepSign.ClientBankINN);

  [~ClientCorrAcc];
  println(RepSign.ClientSPICorrAcc);
  
  [~ClientRepr];
  println(RepSign.ShortClientRepr);

  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile( TempFile );

end;

macro PrintDocument( SpgroundID ):bool

  var ReportFile, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода для протокола*/

  if(TS_FindGroundByID(SpGroundID,SpGround))
     if( TS_FindOrderBySpGround(SpGround.rec.SpGroundID,904,TsOrder) )
        Order = TS_OrderFD( TsOrder );                                               
        RepSign = TS_ReportData(Order.Order());                                                  
        if(TS_FindGrTemp(SpGround.rec.DocTemplate,GrTemp)) 
           message("Печать договора ...");                                                       
           PrintContr(1); 
        else                                                                                     
          ReportFile = GetTxtFileName( "протокол" );                                             
          if( Open( ReportOutFile, ReportFile ) == false )                                       
             errcode = status( errtext );                                                        
             MsgBox( "Ошибка при открытии файла |"+ ReportFile +"|(" + errcode + ") " + errtext);
             break;                                                                              
          end;                                                                                   
          SetOutput( ReportFile );                                                               
          println( "Не найден шаблон для печати." );                                             
          SetOutput( NULL, true );                                                               
          close( ReportOutFile );                                                                
          ViewFile( ReportOutFile );                                                             
        end; 
     else
        println("Не найден договор ДП ОФБУ по документу с SpGroundID = " + string(SpGroundID));
     end;                                                                                        
  else
     println("Не найден документ с SpGroundID = " + string(SpGroundID));
  end;

  return true;
end;