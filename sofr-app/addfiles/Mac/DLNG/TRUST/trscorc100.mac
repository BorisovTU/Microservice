/* IAL XX.11.2008                                        */
/*                                                       */   
/* ДУ (Доверительное управление )                        */
/*                                                       */
/* Операция покупки ц/б на бирже (или через брокера)     */
/*   Расчет комиссий                                     */

import InsCarryDoc, "tssec.mac", "tscomiss.mac";

macro ExecuteStep( Doc, FDoc, DocKind, OperationID )

  record deal(dl_tick);
  var    FD, dat, Dk, Dp;
  VAR Payment, LastPaymentID;

  SetBuff( deal, FDoc );
  FD = SPFirstDocTrust( deal, IsBackExec(deal, SP_EXECUTE_STEP_BUY) );

  GetOprDate( FD.GetKindDate(DATE_DEALCOMISS), Dk ); /*дата комиссии*/
  GetOprDate( FD.GetKindDate(DATE_DEALSETAVOIRISS), Dp  ); /*дата поставки*/

  if( Dk > {curdate} )
    MsgBox ("Преждевременное выполнение шага запрещено.");
    return 1;
  end;

  if( ИсполнитьПлатежиКомиссий( FD, FDoc, Dk, OperationID ) )
     MsgBox( "Не удалось исполнить платеж оплаты комиссии по сделке." );
     return 1;
  end;

  return 0;
end;

