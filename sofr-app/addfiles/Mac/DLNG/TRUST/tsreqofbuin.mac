/*/*******************************************************************************
 FILE         :   tsrepreqofbu.mac
 DESCRIPTION  :   Отчетная форма "Заявление на внесение доли в ОФБУ"
 PROGRAMMED BY:   Nikolskaya V.
 CREATION DATE:   13.05.10
*******************************************************************************/
*/
import "dlwreps.mac", "tscateg.mac", "tssec.mac", "tsrepsign.mac";
import RsbDataSet;

var Order:TS_OrderFD;
var RepSign:TS_ReportData;

private var GrTemp = TRecHandler( "dlgrtemp.dbt" );
private var SpGround = TRecHandler( "spground.dbt" );
private var IOReq = TRecHandler( "tsiorqst.dbt" );
private var ReqAsset = TRecHandler( "tsreqassets.dbt" );
private var Person = TRecHandler( "person.dbt" );

private macro DateToStr(pDate)

  var str = DL_DateToStr(pDate);

  return ДатаСВедущимНулем(substr(str, 1, strlen(str)-3));  /*отсекём " г."*/
end;

private macro PrintContr( ncopy:integer )
  var TempFile;
  var DocName;
  var OrderFD_OFBU;
  var Summ = 0, totalSumRub = "", SummStr = "";
  var h, m, Oper = "";
  var CertReg = "", GivenOut = "", RegDate = Date(0,0,0), RegPlace = "";

  var party = TRecHandler( "party" );
  var partyreg = TRecHandler("objrgdoc");
  /*Шаблон*/
  [#]( GrTemp.rec.File_Name );

  OrderFD_OFBU = TS_OrderFD( 0, Order.Order().rec.OFBU );
  /*Имя выходного файла*/
  DocName = "ЗаявлВводОФБУ_" + SpGround.rec.XLD;
  if( ncopy > 1 )
     /*добавить в название номер копии, иначе будет ошибка при создании, т.к. получим
       несколько документов с одинаковыми именами*/
     DocName = DocName + "_"+ string(ncopy);
  end;

  [#.rtf]( DocName );

  /*Наименование ОФБУ*/
  [~NameOFBU];    
  println( OrderFD_OFBU.Order().rec.Name );

  /*Регистрационный номер ОФБУ*/
  [~ContractDUNumb];
  println( OrderFD_OFBU.Order().rec.RegNum );

  [~City];
  println( RepSign.City );

  /*Дата документа*/
  [~StatementDate];
  println( DateToStr(SpGround.rec.RegistrDate) );

  [~ClientFull];
  println( RepSign.ClientFull );

  if( RepSign.IsTrustorFL )
     [~ClPasspSer];
     println( RepSign.ClPasspSer );

     [~ClPasspNumb];
     println( RepSign.ClPasspNumb );

     [~ClPasspGive];
     println( RepSign.ClPasspGive );

     [~ClPasspGiveDate];
     println( RepSign.ClPasspGiveDate );

     [~ClAddrReg];
     println( RepSign.ClientAddr );

     [~ClDate];
     println( RepSign.ClBithDate );

     [~ClAddr];
     println( RepSign.ClBithPlace );
  end;

  [~OurBankFull];
  println( RepSign.OurBankFull );

  if( TS_FindReqAssets(IOReq.rec.ID,ReqAsset) )
    Summ = ReqAsset.rec.Amount; 
  end;

  SummStr = ДУ_ЧислоCЗаданнойТочностью(Summ, 2);

  [~Summ];
  println( FormatStrNum( double(substr(SummStr,1,strlen(SummStr)-2)), "", " ", 0 ) );

  RubToStrAlt(Summ, totalSumRub, NULL, NULL);

  [~SummText];
  println( totalSumRub );

  [~ClientAcc];
  println(RepSign.ClientSPIAcc);

  [~BankFull];
  println(RepSign.ClientSPIBank);

  [~BankBIC];
  println(RepSign.BICClientSPIBank);

  [~BankINN];
  println(RepSign.ClientBankINN);

  [~ClientCorrAcc];
  println(RepSign.ClientSPICorrAcc);

  /*только для ЮЛ*/
  if( not RepSign.IsTrustorFL ) 
     [~AutRepFull];                                                                                    
     println(RepSign.ClientRepr);                                                                    
                                                                                                       
     [~Basis];                                                                                         
     println(RepSign.ClientRepresDoc);                                                               
                                                                                                       
     [~ClientShort];                                                                                   
     println(RepSign.ClientShort);                                                                   
                                                                                                       
     /*метки CertReg, GivenOut, RegDate, RegPlace заполняются по параметрам регистрационного документа,
       указанного в анкете учредителя (анкета субъекта п. меню Параметры/ Регистрация)*/               
     if( CB_GetRegistry( OBJTYPE_PARTY, Order.Trustor().rec.PartyID, REGPT_TAXINSTITUTE, OBJKDOC_EVIDENCE_GOS_REG, partyreg, CertReg ) == 0 )
       if( ПолучитьСубъекта(partyreg.rec.RegPartyID,party) == 0 )
          GivenOut = party.rec.Name;
       end;
       RegDate  = partyreg.rec.DocDate;
       RegPlace = partyreg.rec.RegPlace;
     end;
                                                                                                       
     /*Номер регистрационного документа*/                                                              
     [~CertReg];                                                                                       
     println(CertReg);                                                                
                                                                                                       
     /*Наименование регистрационного органа*/                                                          
     [~GivenOut];                                                                                      
     println(GivenOut);                                                           

     if( RegDate != Date(0,0,0) )
        RegDate = DateToStr(RegDate)+" года";
     end;                                                                                            
     /*Дата регистрационного документа*/                                                               
     [~RegDate]; 
     println(RegDate);                                                                
                                                                                                       
     /*Место регистрации регистрационного документа*/                                                  
     [~RegPlace];                                                                                      
     println(RegPlace);                                                               
                                                                                                       
     [~LegAddress];                                                                                    
     println(RepSign.ClientAddr);                                                                    
                                                                                                       
     [~PostAddress];                                                                                   
     println(RepSign.ClientPostAddr);                                                                
                                                                                                       
     [~ConPhone];                                                                                      
     println(RepSign.ClientPhone);                                                                   
                                                                                                       
     [~Email];                                                                                         
     println(RepSign.ClientEmail);                                                                   
                                                                                                       
     [~Fax];                                                                                           
     println(RepSign.ClientFax);                                                                     
  end;
  
  [~ClientRepr];
  println(RepSign.ShortClientRepr);

  /*Для служебных отметок Управления доверительных операций Банка:
   (метки заполняются из параметров документа ВВК)*/
  [~NumbIn];
  println(SpGround.rec.XLD);

  [~Date];
  println(DateToStr(IOReq.rec.Date));

  TimeSplit(SpGround.rec.RegistrTime, h, m);

  if(strlen(string(h)) == 1) 
     h = "0"+string(h);
  end;
        
  [~Hours];
  println(h);

  if(strlen(string(m)) == 1) 
     m = "0"+string(m);
  end;
                                    
  [~Min];
  println(m);

  if( TS_FindPerson(SpGround.rec.Receptionist,Person) )
     Oper = ПолучитьКороткоеИмяСубъектаДУ(Person.rec.PartyID);
  end;

  [~Executor];
  println(Oper);  

  TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
  DLWREPS_PrintReportFromTagFile( TempFile );

end;

macro PrintDocument( SpgroundID ):bool

  var ReportFile, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода для протокола*/

  if(TS_FindGroundByID(SpGroundID,SpGround))
     if(TS_FindIORequest(SpGround.rec.SourceDocID,IOReq))
        Order = TS_OrderFD( 0,IOReq.rec.OrderID );                                               
        RepSign = TS_ReportData(Order.Order());                                                  
                                                                                                 
        if(TS_FindGrTemp(SpGround.rec.DocTemplate,GrTemp))                                          
           message("Печать договора ...");                                                       
           PrintContr(1);                                                                        
        else                                                                                     
          ReportFile = GetTxtFileName( "протокол" );                                             
          if( Open( ReportOutFile, ReportFile ) == false )                                       
             errcode = status( errtext );                                                        
             MsgBox( "Ошибка при открытии файла |"+ ReportFile +"|(" + errcode + ") " + errtext);
             break;                                                                              
          end;                                                                                   
          SetOutput( ReportFile );                                                               
          println( "Не найден шаблон для печати." );                                             
          SetOutput( NULL, true );                                                               
          close( ReportOutFile );                                                                
          ViewFile( ReportOutFile );                                                             
        end;                                                                                     
     end;
  else
     println("Не найден документ с SpGroundID = " + string(SpGroundID));
  end;

  return true;
end;
