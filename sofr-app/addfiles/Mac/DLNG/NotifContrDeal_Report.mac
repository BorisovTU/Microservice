/*
$Name:        NotifContrDeal_Report.mac
$Module:      Ядро Securities
$Description: Отчет "Уведомление о контролируемых сделках"
*/
import DealsInter, DVInter, "NotifContrDeal_Form.mac", "sp_class.mac", "dv_categ.mac";

PRIVATE CONST SIDE_DEB    = 1,
              SIDE_KRED   = 2;
PRIVATE CONST NUMSTR = "STRING'";
PRIVATE CONST NOTEKIND_SECDEAL_INCEXPCONTROLDEAL = 31; /* Доходы/расходы по контролируемой сделке */

PRIVATE VAR   NotifContrDeal_Form;
PRIVATE VAR   NotifContrDeal_Report;
PRIVATE VAR   WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CLASS (CB_CReportTemplate) SC_NotifContrDeal_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )

  private var NumReportLine:integer = 1;
  private var A49:string = "", A50:string = "", A51:string = "";
  private var prevClient = -1, Client_num = 1;

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/

 /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true;                   /*в EW показываем листы всегда*/
    end;
  END; 

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport()
     ReSetUseTotalBook();
     NumReportLine = 1;
  END;

  PRIVATE MACRO EndReport();
     if( NumReportLine > 1 )
        EndTable();
        CopyAllSheetInTotalBook(null, false, GetTableRange(), 0, null);
        SaveTotalBook();
        ReplaceAndCalculate(NUMSTR, "");
     else
        if(not m_IsWebService)
           MsgBox( "Нет данных, удовлетворяющих параметрам отчета." );
        end;
     end;
  END;

  PRIVATE MACRO СуммаПроводокПоКатегории( DocumentID, CatCode:string, DebKred:integer )
     var RetVal:money = $0.0;
     var SqlQuery, DataSet;

     SqlQuery = RSDCommand(" select nvl(sum((case when ? = 1 then arh.t_Sum_Payer else arh.t_Sum_Receiver end)),0) as ArhSum " +
                           "   from dacctrn_dbt arh, doproper_dbt opr, doprdocs_dbt doc, " +
                           "        (select distinct accdoc.t_Account, accdoc.t_Currency, accdoc.t_Chapter " +
                           "           from dmcaccdoc_dbt accdoc, dmccateg_dbt categ " +
                           "          where categ.t_LevelType = 1 " +
                           "            and categ.t_Code      = ? " +
                           "            and accdoc.t_CatID    = categ.t_ID " +
                           "            and accdoc.t_DocKind  = ? " +
                           "            and accdoc.t_DocID    = ? " +
                           "        ) acc " +
                           "  where opr.t_DocKind      = ? " +
                           "    and opr.t_DocumentID   = lpad(?, 34, '0') " +
                           "    and doc.t_ID_Operation = opr.t_ID_Operation " +
                           "    and doc.t_DocKind      = ? " +
                           "    and arh.t_AccTrnID     = doc.t_AccTrnID " +
                           "    and arh.t_State        = 1 " /*фактическая проводка*/
                           "    and (case when ? = 1 then arh.t_Account_Payer else arh.t_Account_Receiver end) = acc.t_Account " +
                           "    and (case when ? = 1 then arh.t_FIID_Payer else arh.t_FIID_Receiver end) = acc.t_Currency " +
                           "    and arh.t_chapter      = acc.t_Chapter " +
                           "    and arh.t_date_carry  >= ? " +
                           "    and arh.t_date_carry  <= ? " );

     SqlQuery.addParam("", RSDBP_IN, DebKred);
     SqlQuery.addParam("", RSDBP_IN, CatCode);
     SqlQuery.addParam("", RSDBP_IN, DL_DVNDEAL);
     SqlQuery.addParam("", RSDBP_IN, DocumentID);
     SqlQuery.addParam("", RSDBP_IN, DL_DVNDEAL);
     SqlQuery.addParam("", RSDBP_IN, DocumentID);
     SqlQuery.addParam("", RSDBP_IN, DLDOC_CARRY);
     SqlQuery.addParam("", RSDBP_IN, DebKred);
     SqlQuery.addParam("", RSDBP_IN, DebKred);
     SqlQuery.addParam("", RSDBP_IN, NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_BEGINDATE ));
     SqlQuery.addParam("", RSDBP_IN, NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_ENDDATE ));
     SqlQuery.execute();                                       

     DataSet = TRsbDataSet(SqlQuery);
     if( DataSet.MoveNext() )
        RetVal = SQL_ConvTypeSum(DataSet.ArhSum);
     end;

     return RetVal;
  END;

  PRIVATE MACRO СуммаКомУплачБанком( BofficeKind:integer, DealID:integer, ExecDate:date ):money
     var Summa = $0, SumValue = $0, DS, cmd;

     cmd = RSDCommand( "select dlcomis.t_Sum, dlcomis.t_NDS, comis.t_FIID_Comm " +
                       "  from ddlcomis_dbt dlcomis, dsfcomiss_dbt comis, dsfcontr_dbt sfcontr " +
                       " where dlcomis.t_DocKind   = ? " +
                       "   and dlcomis.t_DocID     = ? " +
                       "   and dlcomis.t_FeeType   = comis.t_FeeType " +
                       "   and dlcomis.t_ComNumber = comis.t_Number " + 
                       "   and sfcontr.t_ID        = dlcomis.t_Contract " + 
                       "   and sfcontr.t_PartyID   = ? "
                     );

     cmd.addParam("", RSDBP_IN, BofficeKind);
     cmd.addParam("", RSDBP_IN, DealID);
     cmd.addParam("", RSDBP_IN, {OurBank});
     cmd.execute();

     DS = TRsbDataSet(cmd);
     while( DS.MoveNext() )
        if( not SmartConvertSum(SumValue, SQL_ConvTypeSum(DS.Sum) + SQL_ConvTypeSum(DS.NDS), ExecDate, DS.FIID_Comm, NATCUR, true) )
           SumValue = $0.0;
        end;

        Summa = Summa + SumValue;
     end;

     return Summa;
  END;

  PRIVATE MACRO GetDealComis( DocKind:integer, DocID:integer, ExecDate:date )
     var Query, Data, ComissionRub = $0.0;

     Query = RSDCommand( " SELECT Rsb_SCTX.TXGetComissionsSum(?,?,?,?) as ComisSum FROM DUAL " );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, DocID );
     Query.addParam("", RSDBP_IN, DocKind );
     Query.addParam("", RSDBP_IN, ExecDate );
     Query.addParam("", RSDBP_IN, NATCUR );
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() )
        ComissionRub = Data.ComisSum;
     end;

     return ComissionRub;
  END;

  PRIVATE MACRO DaysInYearByBasis( pDate:DATE, Basis:INTEGER ):INTEGER
    VAR NumDays;
    Var year :Integer;
    DateSplit(pDate, NULL, NULL, year);

    if( Basis == DV_BASIS_ACTACT )
       NumDays = DATE(1,1,year+1) - DATE(1,1,year);
    elif( (Basis == DV_BASIS_30360) OR
          (Basis == DV_BASIS_31360) OR
          (Basis == DV_BASIS_ACT360)
        )
       NumDays = 360;
    elif( Basis == DV_BASIS_ACT365 )
       NumDays = 365;
    else
       MsgBox( "Не определен базис для расчета количества дней в году." );
       NumDays = 365;
    end;
    return NumDays;
  END;
 
  /*Eсли конкретно на дату заключения курса нет, то ищем курсы с датой ранее даты заключения и берем из них самый поздний.
    Если таких нет, то ищем курсы с датой позже даты заключения и берем из них самый ранний. */  
                  
  PRIVATE MACRO GetCourse(Rate:@money, OtherFI, FIID, ExecDate)
    var  QLater, DSLater,
         QBefore, DSBefore;
    var IsFind = false;
    record RateRec(ratedef);
    QBefore = RSDCommand(
               "SELECT t_rate, t_point "+
               "  FROM (SELECT * "+
               "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_rate, rate.t_point "+
               "                    FROM dratedef_dbt rate "+
               "                   WHERE rate.t_otherfi = ? "+  
               "                     AND rate.t_FIID    = ? "+  
               "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
               "                                             FROM dratedef_dbt "+
               "                                            WHERE     t_otherfi = rate.t_otherfi "+
               "                                                  AND t_type    = rate.t_type  "+
               "                                                  AND t_sincedate <= ? "+ 
               "                                          ) "+
               "                  UNION "+
               "                    SELECT r.t_rateid, h.t_sincedate, h.t_rate, h.t_point "+
               "                      FROM dratehist_dbt h, dratedef_dbt r "+
               "                     WHERE     r.t_rateid    = h.t_rateid "+
               "                           AND r.t_otherfi   = ? "+   
               "                           AND r.t_FIID      = ? "+  
               "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
               "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
               "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
               "                                                    AND r2.t_otherfi = r.t_otherfi "+
               "                                                    AND h2.t_sincedate <= ?  "+  
               "                                               ) "+
               "                 ) "+
               "        ORDER BY t_sincedate DESC "+
               "       ) "+
               " WHERE ROWNUM = 1 "
                       );

    QBefore.addParam( "", RSDBP_IN, OtherFI );
    QBefore.addParam( "", RSDBP_IN, FIID );    
    QBefore.addParam( "", RSDBP_IN, ExecDate );
    QBefore.addParam( "", RSDBP_IN, OtherFI );
    QBefore.addParam( "", RSDBP_IN, FIID );    
    QBefore.addParam( "", RSDBP_IN, ExecDate );
    QBefore.execute();

    DSBefore = TRsbDataSet( QBefore );
    if( DSBefore.MoveNext() )
      Rate = DSBefore.Rate/pow(10, DSBefore.Point);
      IsFind = true; 
    else 
       
      QLater = RSDCommand(
                  "SELECT t_rate, t_point "+
                  "  FROM (SELECT * "+
                  "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_rate, rate.t_point "+
                  "                    FROM dratedef_dbt rate "+
                  "                   WHERE rate.t_otherfi = ? "+  
                  "                     AND rate.t_FIID    = ? "+ 
                  "                     AND t_sincedate    = (SELECT MIN (t_sincedate) "+
                  "                                             FROM dratedef_dbt "+
                  "                                            WHERE     t_otherfi = rate.t_otherfi "+
                  "                                                  AND t_type    = rate.t_type  "+
                  "                                                  AND t_sincedate > ? "+ 
                  "                                          ) "+
                  "                  UNION "+
                  "                    SELECT r.t_rateid, h.t_sincedate, h.t_rate, h.t_point "+
                  "                      FROM dratehist_dbt h, dratedef_dbt r "+
                  "                     WHERE     r.t_rateid    = h.t_rateid "+
                  "                           AND r.t_otherfi   = ? "+   
                  "                           AND r.t_FIID      = ? "+  
                  "                           AND h.t_sincedate = ( SELECT MIN (h2.t_sincedate) "+
                  "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
                  "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
                  "                                                    AND r2.t_otherfi = r.t_otherfi "+
                  "                                                    AND h2.t_sincedate > ?  "+  
                  "                                               ) "+
                  "                 ) "+
                  "        ORDER BY t_sincedate ASC "+
                  "       ) "+
                  " WHERE ROWNUM = 1 "
                          );
     
       QLater.addParam( "", RSDBP_IN, OtherFI );
       QLater.addParam( "", RSDBP_IN, FIID );    
       QLater.addParam( "", RSDBP_IN, ExecDate );
       QLater.addParam( "", RSDBP_IN, OtherFI );
       QLater.addParam( "", RSDBP_IN, FIID );    
       QLater.addParam( "", RSDBP_IN, ExecDate );
       QLater.execute();
     
       DSLater = TRsbDataSet( QLater );
       if( DSLater.MoveNext() )
         Rate = DSLater.Rate/pow(10, DSLater.Point);
         IsFind = true; 
       else 
         MsgBox("Курс для индекса " + GetFICode( OtherFI ) + " не найден." );     
       end;
    end;
    return IsFind;
  END;

  PRIVATE MACRO GetNameFI( FIID:integer ):string
     var RetVal = "";
     var fininstr = TRecHandler("fininstr");
     if( ПолучитьФинИн(FIID, fininstr) == 0 )
        RetVal = fininstr.rec.Name;
     end;

     return RetVal;
  END;

  PRIVATE MACRO GetKindFI( FIID:integer ):string
     var RetVal = "";
     var fininstr = TRecHandler("fininstr");
     if( ПолучитьФинИн(FIID, fininstr) == 0 )
        if( fininstr.rec.FI_Kind == FIKIND_CURRENCY )
           RetVal = "валюты";
        elif( fininstr.rec.FI_Kind == FIKIND_AVOIRISS )
           RetVal = "ценной бумаги";
        elif( fininstr.rec.FI_Kind == FIKIND_INDEX )
           RetVal = "индекса";
        elif( fininstr.rec.FI_Kind == FIKIND_METAL )
           RetVal = "драгоценного металла";
        elif( fininstr.rec.FI_Kind == FIKIND_ARTICLE )
           RetVal = "товара";
        end;
     end;

     return RetVal;
  END;

  PRIVATE MACRO GetDataSfContr( PartyContrID:integer, Client:integer, ServKind:integer, Number:@string, DateConc:@date )
     var Query, sfc;

     if( PartyContrID > 0 )
        Query = RSDCommand( " select contr.t_Number, contr.t_DateConc " +
                            "   from dsfcontr_dbt contr " +
                            "  where contr.t_ID = ? " );
        Query.addParam("", RSDBP_IN, PartyContrID);
        Query.execute();
        sfc = TRsbDataSet( Query );
        if( sfc.MoveNext() )
           Number   = sfc.Number;
           DateConc = sfc.DateConc;
        end;
     else
        Query = RSDCommand(" select contr.t_Number, contr.t_DateConc " +
                           "   from dsfcontr_dbt contr " +
                           "  where contr.t_ServKind     = ? " +
                           "    and contr.t_ContractorID = ? " +
                           "    and contr.t_PartyID      = ? " +
                           " order by contr.t_DateConc DESC ");
        Query.addParam("", RSDBP_IN, ServKind);
        Query.addParam("", RSDBP_IN, {OurBank});
        Query.addParam("", RSDBP_IN, Client);
        Query.execute();
        sfc = TRsbDataSet( Query );
        if( sfc.MoveNext() )
           Number   = sfc.Number;
           DateConc = sfc.DateConc;
        else
           Query = RSDCommand(" select contr.t_Number, contr.t_DateConc " +
                              "   from dsfcontr_dbt contr " +
                              "  where contr.t_ContractorID = ? " +
                              "    and contr.t_PartyID      = ? " +
                              " order by contr.t_DateConc DESC ");
           Query.addParam("", RSDBP_IN, {OurBank});
           Query.addParam("", RSDBP_IN, Client);
           Query.execute();
           sfc = TRsbDataSet( Query );
           if( sfc.MoveNext() )
              Number   = sfc.Number;
              DateConc = sfc.DateConc;
           end;
        end;
     end;
  END;

  PRIVATE MACRO ReplaceCRLF( Str:@string )
     var index_ = Index(Str, "\n");
     while( (index_ != 0) and (index_ <= strlen(Str)) )
        Str = substr(Str, 1, index_ - 1) + " " + substr(Str, index_ + 1, strlen(Str) - 1);
        index_ = Index(Str, "\n");
     end;
  END;

  PRIVATE MACRO PrintData(A55_SumPrecision,
                          A1,  A92, A2,  A3,  A4,  A5,  A6,  A7,  A8,  A9,  A10, A11, A93, A94, A95, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21, A22, A23, A24,
                          A25, A26, A27, A28, A29, A30, A31, A32, A33, A34, A35, A36, A37, A38, A39, A40, A41, A42, A43, A44, A45, A46, A47, A49, A50, A51, A53, A54, A55, A56,
                          A98, A99, A57, A58, A59, A60, A61, A62, A63, A64, A65, A66, A67, A68, A69, A70, A71, A72, A73, A74, A75, A76, A77, A78, A79, A80, A81, A82, A83, A84,
                          A85, A86, A87, A88, A89, A90, A91
                         )
     PrintTableLine( "N1_А1",  A1,             null,
                     "N1_А92", A92,            null,
                     "N1_А2",  A2,             null,
                     "N1_А3",  A3,             null,
                     "N1_А4",  A4,             null,
                     "N1_А5",  A5,             null,
                     "N1_А6",  A6,             null,
                     "N1_А7",  A7,             null,
                     "N1_А8",  A8,             null,
                     "N1_А9",  A9,             null,
                     "N1_А10", A10,            null,
                     "N1_А11", A11,            null,
                     "N1_А93", A93,            null,
                     "N1_А94", A94,            null,
                     "N1_А95", A95,            null,
                     "N1_А12", A12,            null,
                     "N1_А13", A13,            null,
                     "N1_А14", A14,            null,
                     "N1_А15", A15,            null,
                     "N1_А16", A16,            null,
                     "N1_А17", A17,            null,
                     "N1_А18", A18,            null,
                     "N1_А19", A19,            null,
                     "N1_А20", A20,            null,
                     "N1_А21", A21,            null,
                     "N1_А22", A22,            null,
                     "N1_А23", A23,            null,
                     "N1_А24", A24,            null,
                     "N1_А25", A25,            null,
                     "N1_А26", A26,            null,
                     "N1_А27", A27,            null,
                     "N1_А28", A28,            null,
                     "N1_А29", A29,            null,
                     "N1_А30", A30,            null,
                     "N1_А31", A31,            null,
                     "N1_А32", iif(A32,round(A32,0),A32),   null,
                     "N1_А33", A33,            null,
                     "N1_А34", iif(A34,round(A34,0),A34),   null,
                     "N1_А35", A35,            null,
                     "N1_А36", A36,            null,
                     "N1_А37", A37,            null,
                     "N1_А38", A38,            null,
                     "N1_А39", A39,            null,
                     "N1_А40", A40,            null,
                     "N1_А41", A41,            null,
                     "N1_А42", A42,            null,
                     "N1_А43", A43,            null,
                     "N1_А44", A44,            null,
                     "N1_А45", A45,            null,
                     "N1_А46", A46,            null,
                     "N1_А47", A47,            null,
                     "N1_А49", A49,            null,
                     "N1_А50", A50,            null,
                     "N1_А51", A51,            null,
                     "N1_А53", A53,            null,
                     "N1_А54", A54,            null,
                     "N1_А55", A55,            A55_SumPrecision,
                     "N1_А56", iif(A56,round(A56,0),A56),   null,
                     "N1_А98", A98,            null,
                     "N1_А99", A99,            null,
                     "N1_А57", iif(A57,round(A57,0),A57),   null,
                     "N1_А58", A58,            null,
                     "N1_А59", A59,            null,
                     "N1_А60", A60,            null,
                     "N1_А61", A61,            null,
                     "N1_А62", A62,            null,
                     "N1_А63", A63,            null,
                     "N1_А64", A64,            null,
                     "N1_А65", A65,            null,
                     "N1_А66", A66,            null,
                     "N1_А67", A67,            null,
                     "N1_А68", A68,            null,
                     "N1_А69", A69,            null,
                     "N1_А70", A70,            null,
                     "N1_А71", A71,            null,
                     "N1_А72", A72,            null,
                     "N1_А73", A73,            null,
                     "N1_А74", A74,            null,
                     "N1_А75", A75,            null,
                     "N1_А76", A76,            null,
                     "N1_А77", A77,            null,
                     "N1_А78", A78,            null,
                     "N1_А79", A79,            null,
                     "N1_А80", A80,            null,
                     "N1_А81", A81,            null,
                     "N1_А82", A82,            null,
                     "N1_А83", A83,            null,
                     "N1_А84", A84,            null,
                     "N1_А85", A85,            null,
                     "N1_А86", A86,            null,
                     "N1_А87", A87,            null,
                     "N1_А88", A88,            null,
                     "N1_А89", A89,            null,
                     "N1_А90", A90,            null,
                     "N1_А91", A91,            null
                   );
  END;

  PRIVATE MACRO ExistsOpRetire( pfi, dealDate, retIssue, retPartly, retCoupon, rDealID )
     var exists = false;
     var query = " SELECT deal.t_DealID FROM ddl_tick_dbt deal, ddl_leg_dbt leg, " +
                 "     (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup (t_SysTypes) oGrp FROM doprkoper_dbt) Opr " +
                 "   WHERE     deal.t_DealStatus IN (?, ?) "+
                 "         AND deal.t_BOfficeKind = ? " +
                 "         AND leg.t_LegKind = ? " +
                 "         AND leg.t_DealID = deal.t_DealID " +
                 "         AND leg.t_LegID = 0 " +
                 "         AND deal.t_PFI = ? " +
                 "         AND deal.t_DealDate = ? " +
                 "         AND Opr.t_Kind_Operation = deal.t_DealType " +
                 "         AND Opr.t_DocKind = deal.t_BOfficeKind " +
                 IIF( retIssue, " AND Rsb_Secur.IsRet_Issue(Opr.oGrp) = 1 ", "" ) +
                 IIF( retPartly, " AND Rsb_Secur.IsRet_Partly(Opr.oGrp) = 1 ", "" ) +
                 IIF( retCoupon, " AND Rsb_Secur.IsRet_Coupon(Opr.oGrp) = 1 ", "" );

     var RecSelect = RSDCommand( query );
     RecSelect.NullConversion = true;

     RecSelect.addParam("", RSDBP_IN, DL_READIED);
     RecSelect.addParam("", RSDBP_IN, DL_CLOSED);
     RecSelect.addParam("", RSDBP_IN, DL_RETIREMENT);
     RecSelect.addParam("", RSDBP_IN, LEG_KIND_DL_TICK);
     RecSelect.addParam("", RSDBP_IN, pfi);
     RecSelect.addParam("", RSDBP_IN, dealDate);

     RecSelect.execute();
     var RecData = TRsbDataSet(RecSelect);
     if( RecData.MoveNext() )
        exists = true;
        rDealID = Sql_ConvTypeInteger(RecData.DealID);
     end;

     SetParm( 6, rDealID );

     return exists;
  END;

  PRIVATE MACRO ExistsCitizenship(partyID, CountryCode)
     var exists = false;
     var query = " SELECT 1 " +
                 "   FROM DPERSNCIT_DBT " +
                 "  WHERE T_PERSONID = ? "+
                 IIF(StrLen(CountryCode)>0, " AND T_COUNTRYCODELAT3 = ? ", "");

     var RecSelect = DL_RSDCommand( query );
     RecSelect.addParam(partyID);
     if( StrLen(CountryCode)>0 )
        RecSelect.addParam(CountryCode);
     end;

     RecSelect.execute();
     var RecData = TRsbDataSet(RecSelect);
     if( RecData.MoveNext() )
        exists = true;
     end;

     return exists;
  END;

  PRIVATE MACRO PrintReport( ClientsStr:string )
     var NRec:integer = 0, query;
     var TaxDepMode = CheckTaxDepositoryMode(); // Режим хранилища
     var RepBeginDate = NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_BEGINDATE );
     var RepEndDate = NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_ENDDATE );
     var ClientRec = TRecHandler("party.dbt");
     var ClientAdress = TRecHandler("adress.dbt");
     var PrefTaxation:integer = 0;
     var SfNumber_SP:string = "", SfDateConc_SP:date = date(0,0,0);
     var SfNumber_DV:string = "", SfDateConc_DV:date = date(0,0,0);
     var A1, A2:string = "", A3:string = "0", A41:string = "", A59:string = "", A60:string = "", A61:string = "", A62:string = "", A63:string = "",
         A64:string = "", A65:string = "", A66:string = "", A67:string = "", A68:string = "", A69:string = "", A70:string = "", A71:string = "",
         A72:date = date(0,0,0), A73:string = "", A74:string = "2", A75:string = "", A76:string = "", A77:string = "", A78:string = "",
         A79:date = date(0,0,0), A80:string = "", A81:string = "", A82:string = "", A83:string = "", A84:string = "", A85:string = "",
         A86:string = "", A87:string = "", A88:string = "", A89:string = "", A90:string = "", A91:string = "",
         A6:string = "0", A7:string = "0", A8:string = "0", A9:string = "0", A10:string = "0", A11:string = "0", A12:string = "0",
         A15:string = "0", A16:string = "", A18:string = "", A20:string = "", A22:string = "0", A23:string = "0", A24:string = "0", A25:string = "0",
         A27:string = "0", A28:string = "0", A30:string = "2", A31:string = "", A33:integer = 0, A35:integer = 0, A36:string = "3", A38:string = "0",
         A39:string = "0", A45:string = "", A46:string = "", A47:string = "", A53:string = "", A54:string = "796";
     var RecData, ProgressValue, FD, FD2, fininstr = TRecHandler("fininstr"), avoiriss = TRecHandler("avoiriss"), SumPrecision:integer = 0;
     var A4:string = "0", A5:string = "0", A13:string = "032", A14:string = "052", A17:string = "0", A19:string = "01",
         A21:string = "0", A26:string = "0", A29:string = "0", A32:money = $0.0, A34:money = $0.0, A37:string = "", A40:string = "",
         A42:string = "", A43:date = date(0,0,0), A44:string = "", A55:string = "1.0", A56:money = $0.0, A57:money = $0.0,
         A58:date,
         A92:string = "", A93:string = "0", A94:string = "0", A95:string = "0", A98:string = "", A99:string = "";
     var ExecDate, Exchange, Repo, Sale, Buy, Loan, RetIssue, RetCoupon, RetPartly, RQ32 = null, RQ34 = null, ComSum:money = $0.0;
     var attrID, _A2 = "", SumControl = $0.0, SumControl_REPOLoanExecDate = $0.0, IsBondPFI = false,
         REPOLoanExec = false, REPOLoanExecDate = Date(0,0,0), rq2_p, rq2_d, ExistsOpRetC = false, OpRetCoupID = -1, FD_RetCoup, OpRetCoup_nkd = $0.0,
         ExistsOpRetIssueOrPartly = false, course = 0.0,
         Client, StrTaxDepAdd:string="", StrWhereBOCB:string="", StrBOCBAnd;

     var StrExDate:string = " (CASE WHEN ((deal.t_DVKind = "+DV_FORWARD+") and " +
                            "             (nfi.t_OpenDate = chr(88)) and " +
                            "             (nfi.t_ExecDate = TO_DATE('01.01.0001', 'DD.MM.YYYY'))) " +
                            "       THEN NVL((SELECT step.t_Fact_Date " +
                            "                   FROM doprstep_dbt step, doproper_dbt oper " +
                            "                  WHERE oper.t_DocKind      = "+DL_DVNDEAL +
                            "                    AND oper.t_DocumentID   = lpad(deal.t_ID, 34, '0') " +
                            "                    AND step.t_ID_Operation = oper.t_ID_Operation " +
                            "                    AND step.t_Kind_Action  in("+DV_KINDACTION_EXDELCB+","+DV_KINDACTION_EXDELCUR+","+DV_KINDACTION_EXNOTDELCB+") " +
                            "                    AND step.t_IsExecute    = chr(88) " +
                            "                    AND ROWNUM = 1 ), TO_DATE('01.01.0001', 'DD.MM.YYYY')) " +
                            "       ELSE GREATEST(nfi.t_ExecDate, NVL(nfi2.t_ExecDate, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) END) ";

     var StrClient:string = 
         " ( CASE WHEN ( case when deal.t_BofficeKind = "+DL_RETIREMENT+
                            " then nvl((select t_Issuer from dfininstr_dbt where t_fiid = deal.t_pfi), -1) " +
                            " else deal.t_PartyID " +
                            " end " +
                     " ) > 0 " +
                " THEN ( case when deal.t_BofficeKind = "+DL_RETIREMENT+
                            " then nvl((select t_Issuer from dfininstr_dbt where t_fiid = deal.t_pfi), -1) " +
                            " else deal.t_PartyID " +
                            " end " +
                     " ) " +
                " ELSE case when EXISTS( SELECT 1 " +
                                         " FROM dobjlink_dbt link " +
                                        " WHERE link.t_ObjectType     = "+OBJTYPE_SECDEAL +
                                          " AND link.t_ObjectID       = lpad(deal.t_DealID, 34, '0') " +
                                          " AND link.t_AttrType       = "+OBJTYPE_PARTY +
                                          " AND link.t_GroupID        = "+OBJROLE_DEAL_CLIENTCONTR +
                                          " AND link.t_ValidFromDate <= (CASE WHEN deal.t_BOfficeKind = "+DL_RETIREMENT+
                                                                            " THEN deal.t_DealDate " +
                                                                            " ELSE GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) " +
                                                                            " END " +
                                                                      " ) " +
                                          " AND link.t_ValidToDate   >= (CASE WHEN deal.t_BOfficeKind = "+DL_RETIREMENT+
                                                                            " THEN deal.t_DealDate " +
                                                                            " ELSE GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) " +
                                                                            " END " +
                                                                      " ) " +
                                     " ) " +
                          " then ( SELECT TO_NUMBER(link.t_AttrID) " +
                                   " FROM dobjlink_dbt link " +
                                  " WHERE link.t_ObjectType     = "+OBJTYPE_SECDEAL +
                                    " AND link.t_ObjectID       = lpad(deal.t_DealID, 34, '0') " +
                                    " AND link.t_AttrType       = "+OBJTYPE_PARTY +
                                    " AND link.t_GroupID        = "+OBJROLE_DEAL_CLIENTCONTR +
                                    " AND link.t_ValidFromDate <= (CASE WHEN deal.t_BOfficeKind = "+DL_RETIREMENT+
                                                                      " THEN deal.t_DealDate " +
                                                                      " ELSE GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) " +
                                                                      " END " +
                                                                " ) " +
                                    " AND link.t_ValidToDate   >= (CASE WHEN deal.t_BOfficeKind = "+DL_RETIREMENT+
                                                                      " THEN deal.t_DealDate " +
                                                                      " ELSE GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) " +
                                                                      " END " +
                                                                " ) " +
                                    " AND ROWNUM = 1 " +
                               " ) " +
                          " else - 1 " +
                          " end " +
                " END " +
        " ) ";

     if( TaxDepMode )
        StrTaxDepAdd =
                 "    EXISTS( SELECT 1 " +
                 "              FROM dobjatcor_dbt attr " +
                 "             WHERE attr.t_ObjectType = "+OBJTYPE_PARTY +
                 "               AND attr.t_GroupID    = 58 " + 
                 "               AND attr.t_Object     = LPAD("+StrClient+", 10, '0') " +
                 "               AND (SELECT count(1) " +
                 "                      FROM DOBJATCOR_DBT at " +
                 "                     WHERE at.t_ObjectType = attr.t_ObjectType " +
                 "                       AND at.t_GroupID    = attr.t_GroupID " +
                 "                       AND at.t_Object     = attr.t_Object " +
                 "                       AND ((at.t_ValidFromDate <= deal.t_DealDate and at.t_ValidToDate >= deal.t_DealDate) " +
                 "                        OR (at.t_ValidFromDate <= GREATEST (leg.t_Maturity, leg.t_Expiry, NVL (leg2.t_Maturity, TO_DATE ('01.01.0001', 'DD.MM.YYYY')), NVL (leg2.t_Expiry, TO_DATE ('01.01.0001','DD.MM.YYYY'))) " +
                 "                           and at.t_ValidToDate >= GREATEST (leg.t_Maturity, leg.t_Expiry, NVL (leg2.t_Maturity, TO_DATE ('01.01.0001', 'DD.MM.YYYY')), NVL (leg2.t_Expiry, TO_DATE ('01.01.0001','DD.MM.YYYY')))) " +
                 "                  )) > 0 ) ";
     end;
     if( StrLen(ClientsStr) > 0 )
        StrWhereBOCB = StrClient+" IN ("+ClientsStr+")";
     end;
     if( StrLen(StrTaxDepAdd) > 0 )
        if( StrLen(StrWhereBOCB) > 0 )
           StrWhereBOCB = StrWhereBOCB + " and " + StrTaxDepAdd;
        else
           StrWhereBOCB = StrTaxDepAdd;
        end;
     end;

     StrBOCBAnd =
                 "    AND ( EXISTS( SELECT 1 " +
                 "                    FROM dobjatcor_dbt attr " +
                 "                   WHERE attr.t_ObjectType IN ("+OBJTYPE_SECDEAL+","+OBJTYPE_RETIRE+")" +
                 "                     AND attr.t_GroupID    = 51 " + 
                 "                     AND attr.t_Object     = LPAD(deal.t_DealID, 34, '0') " +
                 "                     AND (SELECT count(1) " +
                 "                            FROM DOBJATCOR_DBT at " +
                 "                           WHERE at.t_ObjectType = attr.t_ObjectType " +
                 "                             AND at.t_GroupID    = attr.t_GroupID " +
                 "                             AND at.t_Object     = attr.t_Object " +
                 "                             AND at.t_AttrID     = 2 " + // 1(Да)
                 "                             AND ((at.t_ValidFromDate <= deal.t_DealDate and at.t_ValidToDate >= deal.t_DealDate) " +
                 "                               OR (at.t_ValidFromDate <= GREATEST (leg.t_Maturity, leg.t_Expiry, NVL (leg2.t_Maturity, TO_DATE ('01.01.0001', 'DD.MM.YYYY')), NVL (leg2.t_Expiry, TO_DATE ('01.01.0001','DD.MM.YYYY'))) " +
                 "                                  and at.t_ValidToDate >= GREATEST (leg.t_Maturity, leg.t_Expiry, NVL (leg2.t_Maturity, TO_DATE ('01.01.0001', 'DD.MM.YYYY')), NVL (leg2.t_Expiry, TO_DATE ('01.01.0001','DD.MM.YYYY')))) " +
                 "                         )) > 0 ) " +
                            IIF( StrLen(StrWhereBOCB) > 0, (" OR ("+StrWhereBOCB+") "), "" ) +
                 "        ) ";

     if( TaxDepMode ) // Режим хранилища вкл.
        query =  /*БОЦБ*/
                 "  SELECT deal.t_DealID AS t_DocID, deal.t_BOfficeKind AS t_DocKind, " +
                 "         (CASE WHEN deal.t_BOfficeKind = "+DL_RETIREMENT+" THEN deal.t_DealDate " +
                 "               ELSE GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) END) AS t_ExecDate, " +
                 "         -1 T_ACCOUNTID_PAYER, -1 T_ACCOUNTID_RECEIVER, -1 AS IsDebet, -1 t_Sum_NatCur, TO_DATE('01.01.0001', 'DD.MM.YYYY') t_date_carry, " +
                           StrClient + " AS t_Client, " +
                 "         (SELECT T_ISO_NUMBER FROM DFININSTR_DBT WHERE T_FIID = leg.t_CFI) AS t_A98 " +
                 "   FROM ddl_tick_dbt deal, ddl_leg_dbt leg, ddl_leg_dbt leg2, " +
                 "        (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup (t_SysTypes) oGrp FROM doprkoper_dbt) Opr " +
                 "  WHERE deal.t_BOfficeKind in("+DL_SECURITYDOC+","+DL_RETIREMENT+") " +
                 "    AND deal.t_ClientID    = -1 " +
                 "    AND leg.t_LegKind      = "+LEG_KIND_DL_TICK +
                 "    AND leg.t_DealID       = deal.t_DealID " +
                 "    AND leg.t_LegID        = 0 " +
                 "    AND leg2.t_LegKind(+)  = "+LEG_KIND_DL_TICK_BACK +
                 "    AND leg2.t_DealID(+)   = deal.t_DealID " +
                 "    AND leg2.t_LegID(+)    = 0 " +
                 "    AND Opr.t_Kind_Operation = deal.t_DealType " +
                 "    AND Opr.t_DocKind = deal.t_BOfficeKind " +
                 "    AND (CASE WHEN Rsb_Secur.IsRepo(Opr.oGrp) = 1 OR Rsb_Secur.IsLoan(Opr.oGrp) = 1 THEN " +
                 "                CASE WHEN ((deal.t_DealDate BETWEEN ? and ?) " +
                 "                            AND GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) > ?)  " +
                 "                      THEN 1 " +
                 "                     WHEN GREATEST(NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) BETWEEN ? AND ? " +
                 "                      THEN 1 " +
                 "                     ELSE 0 END " +
                 "              WHEN (Rsb_Secur.IsRet_Coupon(Opr.oGrp) = 1 or Rsb_Secur.IsRet_Partly(Opr.oGrp) = 1 or Rsb_Secur.IsRet_Issue(Opr.oGrp) = 1) THEN " +
                 "                CASE WHEN deal.t_DealDate BETWEEN ? and ? " +
                 "                      THEN 1 " +
                 "                     ELSE 0 END " +
                 "              WHEN Rsb_Secur.IsRepo(Opr.oGrp) <> 1 and Rsb_Secur.IsLoan(Opr.oGrp) <> 1 and (Rsb_Secur.IsBuy(Opr.oGrp) = 1 or Rsb_Secur.IsSale(Opr.oGrp) = 1) THEN " +
                 "                CASE WHEN RSB_SECUR.GetDealSupplyDate1(leg.t_MaturityIsPrincipal, leg.t_Maturity, leg.t_Expiry ) BETWEEN ? and ? " +
                 "                      THEN 1 " +
                 "                     ELSE 0 END " +
                 "        END) = 1 "
                 +    StrBOCBAnd +
                 "  ORDER BY t_Client, t_DocID, t_ExecDate, t_Date_carry ";
     else // Режим хранилища выкл.
        query =  "  WITH acct  " +
                 "     AS (SELECT t_accountID " +
                 "           FROM daccount_dbt "+
                 "          WHERE t_balance IN ('70601', '70602', '70603', '70604','70605','70606','70607','70608','70609','70610','70611','70612','70613', '70614') " +
                 "            AND t_opucode not IN ( 16305, 25302 ) ) " +
                 /*БОЦБ*/
                 "  SELECT deal.t_DealID AS t_DocID, deal.t_BOfficeKind AS t_DocKind, " +
                 "         (CASE WHEN deal.t_BOfficeKind = "+DL_RETIREMENT+" THEN deal.t_DealDate " +
                 "               ELSE GREATEST(leg.t_Maturity, leg.t_Expiry, NVL(leg2.t_Maturity, TO_DATE('01.01.0001', 'DD.MM.YYYY')), NVL(leg2.t_Expiry, TO_DATE('01.01.0001', 'DD.MM.YYYY'))) END) AS t_ExecDate, " +
                 "         TRN.T_ACCOUNTID_PAYER, TRN.T_ACCOUNTID_RECEIVER, (case when TRN.T_ACCOUNTID_PAYER = acct.t_AccountID then 1 else 0 end) AS IsDebet, trn. t_Sum_NatCur, trn.t_date_carry, " +
                           StrClient + " AS t_Client, " +
                 "         (SELECT T_ISO_NUMBER FROM DFININSTR_DBT WHERE T_FIID = leg.t_CFI) AS t_A98 " +
                 "   FROM ddl_tick_dbt deal, ddl_leg_dbt leg, ddl_leg_dbt leg2,  acct, doproper_dbt opr, doprdocs_dbt docs, dacctrn_dbt trn, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal " +
                 "  WHERE deal.t_DealStatus  in("+DL_READIED+","+DL_CLOSED+") " +
                 "    AND grdoc.t_DocKind    = 1 " +
                 "    AND grdoc.T_GRDEALID   = grdeal.t_ID  " +
                 "    AND grdeal.t_DocKind   = deal.t_BOfficeKind " +
                 "    AND grdeal.t_DocID     = deal.t_DealID" +
                 "    AND deal.t_BOfficeKind in("+DL_SECURITYDOC+","+DL_RETIREMENT+") " +
                 "    AND deal.t_ClientID    = -1 " +
                 "    AND leg.t_LegKind      = "+LEG_KIND_DL_TICK +
                 "    AND leg.t_DealID       = deal.t_DealID " +
                 "    AND leg.t_LegID        = 0 " +
                 "    AND leg2.t_LegKind(+)  = "+LEG_KIND_DL_TICK_BACK +
                 "    AND leg2.t_DealID(+)   = deal.t_DealID " +
                 "    AND leg2.t_LegID(+)    = 0 " +
                 "    AND deal.T_BofficeKind = opr.t_DocKind " +
                 "    AND LPAD (deal.t_DealID, 34, '0') = opr.t_documentid " +
                 "    AND docs.t_id_operation = opr.t_id_operation " +
                 "    AND ( trn.t_acctrnid = docs.t_AccTrnID  OR  trn.t_acctrnid = grdoc.t_DocID ) " +
                 "    AND trn.t_State IN (1, 2, 3) " +
                 "    AND ( trn.t_AccountID_Payer = acct.t_accountID " +
                 "          OR trn.t_AccountID_Receiver = acct.t_AccountID) " +
                 "    AND trn.t_date_carry >= ? " +
                 "    AND trn.t_date_carry <= ? "
                 +    StrBOCBAnd +
                 /*ФИССиКО*/
                 " UNION " +
                 " SELECT deal.t_ID AS t_DocID, "+DL_DVNDEAL+" AS t_DocKind, " + StrExDate + " AS t_ExecDate, " +
                 "        TRN.T_ACCOUNTID_PAYER, TRN.T_ACCOUNTID_RECEIVER, (case when TRN.T_ACCOUNTID_PAYER = acct.t_AccountID then 1 else 0 end) AS IsDebet, trn. t_Sum_NatCur, trn.t_date_carry, " +
                 "        deal.t_Contractor AS t_Client, " +
                 "        (SELECT T_ISO_NUMBER FROM DFININSTR_DBT WHERE T_FIID = nfi.t_PriceFIID) AS t_A98 " +
                 "   FROM ddvndeal_dbt deal, ddvnfi_dbt nfi, ddvnfi_dbt nfi2, acct, doproper_dbt opr, doprdocs_dbt docs, dacctrn_dbt trn " +
                 "  WHERE deal.t_State      in("+DVDEAL_OPEN+","+DVDEAL_CLOSE+") " +
                 "    AND deal.t_Client     = -1 " +
                 "    AND nfi.t_DealID      = deal.t_ID " +
                 "    AND nfi.t_Type        = case when deal.t_Forvard = 'X' then "+DV_NFIType_Forward+" else "+DV_NFIType_BaseActiv+" end " +
                 "    AND nfi2.t_DealID(+)  = deal.t_ID " +
                 "    AND nfi2.t_Type(+)    = "+DV_NFIType_BaseActiv2 +
                 "    AND LPAD (deal.t_ID, 34, '0') = opr.t_documentid " +
                 "    AND docs.t_id_operation = opr.t_id_operation " +
                 "    AND trn.t_acctrnid = docs.t_AccTrnID " +
                 "    AND trn.t_State IN (1, 2, 3) " +
                 "    AND ( trn.t_AccountID_Payer = acct.t_accountID " +
                 "          OR trn.t_AccountID_Receiver = acct.t_AccountID ) " +
                 "    AND trn.t_date_carry >= ? " +
                 "    AND trn.t_date_carry <= ? " +
                 "    AND opr.t_DocKind = "+DL_DVNDEAL +
                 "    AND deal.t_IsPFI = 'X' " +
                 "    AND ( EXISTS( SELECT 1 " +
                 "                    FROM dobjatcor_dbt attr " +
                 "                   WHERE attr.t_ObjectType = "+OBJTYPE_OUTOPER_DV+
                 "                     AND attr.t_GroupID    = 51 " + 
                 "                     AND attr.t_Object     = LPAD(deal.t_ID, 34, '0') " +
                 "                     AND (SELECT count(1) " +
                 "                            FROM DOBJATCOR_DBT at " +
                 "                           WHERE at.t_ObjectType = attr.t_ObjectType " +
                 "                             AND at.t_GroupID    = attr.t_GroupID " +
                 "                             AND at.t_Object     = attr.t_Object " +
                 "                             AND at.t_AttrID     = 2 " + // 1(Да)
                 "                             AND ((at.t_ValidFromDate <= "+StrExDate+" and at.t_ValidToDate >= "+StrExDate+") " +
                 "                         )) > 0 ) " +
                            IIF( StrLen(ClientsStr) > 0, (" OR deal.t_Contractor IN ("+ClientsStr+")"), "" ) +
                 "        ) " +
                 "  ORDER BY t_Client, t_DocID, t_ExecDate, t_Date_carry ";
     end;

     MACRO SetData_TaxDepMode( IsSecondRow )
        if( not IsSecondRow )
           if( Repo )
              rq2_p = FD2.GetRQ(DLRQ_TYPE_PAYMENT);
              rq2_d = FD2.GetRQ(DLRQ_TYPE_DELIVERY);

              if( (rq2_p.rec.State == DLRQ_STATE_EXEC) and (rq2_d.rec.State == DLRQ_STATE_EXEC) )
                 REPOLoanExec = true;
                 REPOLoanExecDate = max(rq2_d.rec.FactDate, rq2_p.rec.FactDate);
                 SumControl_REPOLoanExecDate = readNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick, OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_INCEXPCONTROLDEAL, REPOLoanExecDate);
              end;
           elif( Loan )
              rq2_d = FD2.GetRQ(DLRQ_TYPE_DELIVERY);

              if(rq2_d.rec.State == DLRQ_STATE_EXEC )
                 REPOLoanExec = true;
                 REPOLoanExecDate = rq2_d.rec.FactDate;
                 SumControl_REPOLoanExecDate = readNoteForObject(OBJTYPE_SECDEAL, UniID(FD.tick, OBJTYPE_SECDEAL), NOTEKIND_SECDEAL_INCEXPCONTROLDEAL, REPOLoanExecDate);
              end;
           elif( RetIssue or RetPartly )
              ExistsOpRetC = ExistsOpRetire( FD.Tick.rec.PFI, FD.Tick.rec.DealDate, false, false, true, OpRetCoupID );
              if( OpRetCoupID > 0 )
                 FD_RetCoup = SPFirstDoc(LEG_KIND_DL_TICK, OpRetCoupID);
                 if( OpRetCoupID != -1 )
                    OpRetCoup_nkd = FD_RetCoup.DL_Leg.rec.TotalCost;
                    if (FD_RetCoup.Dl_Leg.rec.CFI != NATCUR)
                       if ( not SmartConvertSum( OpRetCoup_nkd, OpRetCoup_nkd, FD_RetCoup.Tick.rec.DealDate, FD_RetCoup.Dl_Leg.rec.CFI, NATCUR, true) )
                          OpRetCoup_nkd = $0.0;
                       end;
                    end;
                 end;
              end;
           elif( RetCoupon )
              ExistsOpRetIssueOrPartly = ExistsOpRetire( FD.Tick.rec.PFI, FD.Tick.rec.DealDate, true, true, false );
           end;

           // A2
           if( GetMainObjAttr(null, OBJTYPE_PARTY, UniID(ClientRec, OBJTYPE_PARTY), PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, FD.Tick.rec.DealDate) )
              DL_GetObjAttrName(OBJTYPE_PARTY, PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, @A2);
           end;
           if( GetMainObjAttr(null, OBJTYPE_PARTY, UniID(ClientRec, OBJTYPE_PARTY), PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, RecData.ExecDate) )
              DL_GetObjAttrName(OBJTYPE_PARTY, PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, @_A2);
           end;
           if( (A2 == "1") or (A2 == "2") or (A2 == "3") or (_A2 == "1") or (_A2 == "2") or (_A2 == "3") )
              A3 = "1";
           end;
           if( (A2 != "") and (_A2 != "") and (A2 != _A2) )
              A2 = A2 + "," + _A2;
           else
              A2 = _A2;
           end;

           // A13
           if( Repo or Loan )
              A13 = "012";
           elif( (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Sale or Buy) )
              A13 = "015";
           end;

           // A14
           if( (Repo and Sale) or (Loan and Buy) )
              A14 = "020";
           elif( (Repo and Buy) or (Loan and Sale) )
              A14 = "021";
           elif( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and Buy )
              A14 = "026";
           elif( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and Sale )
              A14 = "027";
           end;

           // A19
           if( (Repo or Loan) and (FD.Dl_Leg.rec.CFI != NATCUR) )
              A19 = "01";
           else
              A19 = "08";
           end;

           // A21
           if( (A19 == "08") or (Loan and (FD.Dl_Leg.rec.CFI != NATCUR)) )
              A21 = "0";
           elif( Exchange or Repo or Loan )
              A21 = "1";
           end;

           // A29
           if( Loan and (FD.Dl_Leg.rec.CFI != NATCUR) )
              A29 = 1;
           else
              A29 = 0;
           end;

           // A32
           SumControl = readNoteForObject(FD.tick.rec.bOfficeKind, UniID(FD.tick, FD.tick.rec.bOfficeKind), NOTEKIND_SECDEAL_INCEXPCONTROLDEAL, RepEndDate);
           if( (not Repo) and (not Loan) and (not RetPartly) and (not RetCoupon) and (Sale or RetIssue) and (SumControl > $0.0) )
              A32 = SumControl;
           elif( (Repo or Loan) and (FD.Tick.rec.DealDate >= RepBeginDate) and (FD.Tick.rec.DealDate <= RepEndDate) and (RecData.ExecDate > RepEndDate) and (SumControl > $0.0) )
              A32 = SumControl;
           elif( (Repo or Loan) and REPOLoanExec and (SumControl_REPOLoanExecDate > $0.0) )
              A32 = SumControl_REPOLoanExecDate;
           elif( (RetPartly and (FD.Tick.rec.Number_Coupon == "") and (not ExistsOpRetC)) or (RetCoupon and (not ExistsOpRetIssueOrPartly)) )
              A32 = FD.DL_Leg.rec.TotalCost;
              if (FD.Dl_Leg.rec.CFI != NATCUR)
                 if ( not SmartConvertSum( A32, A32, FD.Tick.rec.DealDate, FD.Dl_Leg.rec.CFI, NATCUR, true) )
                    A32 = $0.0;
                 end;
              end;
           elif( RetPartly and ((FD.Tick.rec.Number_Coupon != "") or ExistsOpRetC) )
              A32 = FD.DL_Leg.rec.TotalCost;
              if (FD.Dl_Leg.rec.CFI != NATCUR)
                 if ( not SmartConvertSum( A32, A32, FD.Tick.rec.DealDate, FD.Dl_Leg.rec.CFI, NATCUR, true) )
                    A32 = $0.0;
                 end;
              end;
              if( FD.Tick.rec.Number_Coupon == "" )
                 A32 = A32 + OpRetCoup_nkd;
              end;
           end;

           // A34
           if( (not Repo) and (not Loan) and (not RetPartly) and (not RetCoupon) and (Sale or RetIssue) and (SumControl < $0.0) )
              A34 = ABS(SumControl);
           elif( (Repo or Loan) and (FD.Tick.rec.DealDate >= RepBeginDate) and (FD.Tick.rec.DealDate <= RepEndDate) and (RecData.ExecDate > RepEndDate) and (SumControl < $0.0) )
              A34 = ABS(SumControl);
           elif( (Repo or Loan) and REPOLoanExec and (SumControl_REPOLoanExecDate < $0.0) )
              A34 = ABS(SumControl_REPOLoanExecDate);
           elif( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and Buy )
              A34 = FD.DL_Leg.rec.TotalCost;
              if (FD.Dl_Leg.rec.CFI != NATCUR)
                 if ( not SmartConvertSum( A34, A34, GetDealSetAvPlanDate(FD.Dl_Leg.rec), FD.Dl_Leg.rec.CFI, NATCUR, true) )
                    A34 = $0.0;
                 end;
                 A34 = A34 + GetDealComis( FD.Tick.rec.BofficeKind, FD.Tick.rec.DealID, GetDealPayPlanDate(FD.Dl_Leg.rec) );
              end;
           end;
        end; // not IsSecondRow

        // A37
        if( Repo )
           A37 = IIF(FD.Dl_Leg.rec.CFI == NATCUR, "", "Валютное ");
           A37 = A37 + "РЕПО. Сделка №" + FD.Tick.rec.DealCodeTS + " от " + FD.Tick.rec.DealDate + ". " + fininstr.rec.Name + ". Ставка " + FD2.Dl_Leg.rec.IncomeRate + "%. Срок " + (GetDealPayPlanDate(FD2.Dl_Leg.rec) - GetDealPayPlanDate(FD.Dl_Leg.rec)) + "д." ;
        elif( Loan )
           A37 = IIF(FD.Dl_Leg.rec.CFI == NATCUR, "", "Валютный ");
           A37 = A37 + "Займ. Сделка №" + FD.Tick.rec.DealCodeTS + " от " + FD.Tick.rec.DealDate + ". " + fininstr.rec.Name + ". Ставка " + FD2.Dl_Leg.rec.IncomeRate + "%. Срок " + (GetDealPayPlanDate(FD2.Dl_Leg.rec) - GetDealSetAvPlanDate(FD.Dl_Leg.rec)) + "д." ;
        elif( (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Buy or Sale) )
           A37 = IIF(IsSecondRow, "НКД по ценной бумаге ", IIF(Buy, "Покупка ", "Продажа "));
           A37 = A37 + fininstr.rec.Name + ". ISIN " + avoiriss.rec.ISIN + ". Сделка №" + FD.Tick.rec.DealCodeTS + " от " + FD.Tick.rec.DealDate;
        elif( (RetIssue or RetPartly) and (not IsSecondRow) )
           A37 = IIF(RetIssue, "Погашение выпуска ", "Частичное погашение ") + fininstr.rec.Name + ". ISIN " + avoiriss.rec.ISIN;
        elif( (RetIssue or RetPartly) and IsSecondRow )
           A37 = "НКД по ценной бумаге" + fininstr.rec.Name + ". ISIN " + avoiriss.rec.ISIN;
        end;

        // A40
        if( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Buy or Sale) )
           A40 = "64.99.1";
        elif( Repo or Loan )
           A40 = NUMSTR + "64.19";
        end;

        // A41
        if( (prevClient != -1) and (prevClient != Client) and (not IsSecondRow) )
           Client_num = Client_num + 1;
        end;
        A41 = string(Client_num);

        // A55
        if( Repo or Loan or
            ((not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Buy or Sale) and IsSecondRow) )
           A55 = 1;
        else
           SumPrecision = fininstr.rec.SumPrecision;
           A55 = ДЛ_ЧислоCЗаданнойТочностью(FD.dl_leg.rec.Principal, SumPrecision );
        end;

        // A56
        if( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Buy or Sale) )
           if( not IsSecondRow )
              A56 = FD.dl_leg.rec.Price;
              if( /*IsBondPFI and*/ (FD.dl_leg.rec.RelativePrice == "X") )
                 var CurNominal;
                 FI_GetCurrentNominal(fininstr.rec.FIID, GetDealSetAvPlanDate(FD.Dl_Leg.rec), CurNominal);
                 A56 = (A56 * CurNominal) / 100;
              end;
              if (FD.Dl_Leg.rec.CFI != NATCUR)
                 course = ПолучитьКурсПостановкиНаБаланс(FD.tick);
                 if( course > 0.0 )
                    A56 = A56 * course;
                 elif ( not SmartConvertSum( A56, A56, GetDealSetAvPlanDate(FD.Dl_Leg.rec), FD.Dl_Leg.rec.CFI, NATCUR, true) )
                    A56 = $0.0;
                 end;
              end;
           else
              A56 = FD.dl_leg.rec.NKD;
              if (FD.Dl_Leg.rec.NKDFIID != NATCUR)
                 course = ПолучитьКурсПостановкиНаБаланс(FD.tick);
                 if( course > 0.0 )
                    A56 = A56 * course;
                 elif ( not SmartConvertSum( A56, A56, GetDealSetAvPlanDate(FD.Dl_Leg.rec), FD.Dl_Leg.rec.NKDFIID, NATCUR, true) )
                    A56 = $0.0;
                 end;
              end;
           end;
        elif( RetIssue or RetPartly or RetCoupon )
           if( not IsSecondRow )
              if( FD.dl_leg.rec.Principal != 0 )
                 A56 = round(FD.dl_leg.rec.TotalCost / FD.dl_leg.rec.Principal, 2);
                 if (FD.Dl_Leg.rec.CFI != NATCUR)
                    if ( not SmartConvertSum( A56, A56, FD.Tick.rec.DealDate, FD.Dl_Leg.rec.CFI, NATCUR, true) )
                       A56 = $0.0;
                    end;
                 end;
              end;
           elif( not RetCoupon )
              A56 = FD.dl_leg.rec.NKD;
              if (FD.Dl_Leg.rec.CFI != NATCUR)
                 if ( not SmartConvertSum( A56, A56, FD.Tick.rec.DealDate, FD.Dl_Leg.rec.CFI, NATCUR, true) )
                    A56 = $0.0;
                 end;
              end;
              if( (FD.Tick.rec.Number_Coupon == "") and (OpRetCoupID > 0) )
                 A56 = A56 + OpRetCoup_nkd;
              end;
           end;
        elif( Repo or Loan )
           A56 = max( A32, A34 );
        end;

        // A57
        if( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Buy or Sale) /*and (not IsSecondRow)*/ )
           if( not IsSecondRow )
              A57 = FD.dl_leg.rec.Cost;
              if (FD.Dl_Leg.rec.CFI != NATCUR)
                 course = ПолучитьКурсПостановкиНаБаланс(FD.tick);
                 if( course > 0.0 )
                    A57 = A57 * course;
                 elif( not SmartConvertSum( A57, A57, GetDealSetAvPlanDate(FD.Dl_Leg.rec), FD.Dl_Leg.rec.CFI, NATCUR, true) )
                    A57 = $0.0;
                 end;
              end;
           else
              A57 = FD.dl_leg.rec.NKD;
              if (FD.Dl_Leg.rec.NKDFIID != NATCUR)
                 course = ПолучитьКурсПостановкиНаБаланс(FD.tick);
                 if( course > 0.0 )
                    A57 = A57 * course;
                 elif ( not SmartConvertSum( A57, A57, GetDealSetAvPlanDate(FD.Dl_Leg.rec), FD.Dl_Leg.rec.NKDFIID, NATCUR, true) )
                    A57 = $0.0;
                 end;
              end;
           end;
        elif( (RetIssue or RetPartly) and (not IsSecondRow) )
           A57 = FD.dl_leg.rec.Cost;
           if (FD.Dl_Leg.rec.CFI != NATCUR)
              if ( not SmartConvertSum( A57, A57, FD.Tick.rec.DealDate, FD.Dl_Leg.rec.CFI, NATCUR, true) )
                 A57 = $0.0;
              end;
           end;
        else
           A57 = A56;
        end;

        // A58
        if( (not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and (Buy or Sale) )
           A58 = GetDealSetAvPlanDate(FD.Dl_Leg.rec);
        elif( Repo or Loan )
           if( (FD.Tick.rec.DealDate >= RepBeginDate) and (FD.Tick.rec.DealDate <= RepEndDate) and (RecData.ExecDate > RepEndDate) )
              A58 = GetDateAfterWorkDays( RepEndDate, -1 );
           else
              A58 = max( GetDealSetAvPlanDate(FD2.Dl_Leg.rec), GetDealPayPlanDate(FD2.Dl_Leg.rec) );
           end;
        elif( RetIssue or RetPartly or RetCoupon )
           A58 = FD.Tick.rec.DealDate;
        end;

     END; // MACRO SetData_TaxDepMode

     var NRecSelect = RSDCommand( "SELECT COUNT(*) nRecs FROM (" + query + ")" );
     NRecSelect.NullConversion = true;
     /*БОЦБ*/
     if( TaxDepMode )
        NRecSelect.addParam("", RSDBP_IN, RepBeginDate); 
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
        NRecSelect.addParam("", RSDBP_IN, RepBeginDate); 
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
        NRecSelect.addParam("", RSDBP_IN, RepBeginDate); 
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
        NRecSelect.addParam("", RSDBP_IN, RepBeginDate); 
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
     else
        NRecSelect.addParam("", RSDBP_IN, RepBeginDate); 
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
     end;
     /*ФИССиКО*/
     if( not TaxDepMode )
        NRecSelect.addParam("", RSDBP_IN, RepBeginDate);     
        NRecSelect.addParam("", RSDBP_IN, RepEndDate);
     end;

     NRecSelect.execute();
     var NRecData = TRsbDataSet(NRecSelect);
     if( (NRecData.MoveNext()) and (SQL_ConvTypeInteger(NRecData.nRecs) != null) )
        NRec = SQL_ConvTypeInteger(NRecData.nRecs);
     end;

     if( NRec > 0 )
        var RecSelect = RSDCommand(query);
        RecSelect.NullConversion = true;
        /*БОЦБ*/
        if( TaxDepMode )
           RecSelect.addParam("", RSDBP_IN, RepBeginDate);
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
           RecSelect.addParam("", RSDBP_IN, RepBeginDate);
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
           RecSelect.addParam("", RSDBP_IN, RepBeginDate);
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
           RecSelect.addParam("", RSDBP_IN, RepBeginDate);
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
        else
           RecSelect.addParam("", RSDBP_IN, RepBeginDate);
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
        end;
        /*ФИССиКО*/
        if( not TaxDepMode )
           RecSelect.addParam("", RSDBP_IN, RepBeginDate);     
           RecSelect.addParam("", RSDBP_IN, RepEndDate);
        end;

        RecData = TRsbDataSet(RecSelect);

        ProgressValue = CTxProgressValue();
        ProgressValue.Maximum = NRec;
        ProgressValue.Current = 0;
        var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

        if( m_IsWebService and (WebMenuItem != null) )
          var header = "Формирование отчета " + WebMenuItem.szNameItem;
          ProgressIndicator.Start(ProgressValue.Maximum, header, header);
        else
          ProgressIndicator.Start(ProgressValue.Maximum, "Отчет: Уведомление о контролируемых сделках", "Просмотр сделок субъекта...");
        end;

        var Num:integer = 0;
        while( RecData.MoveNext() )
           Client = int(RecData.Client);

           if( Client != prevClient )
              ClientRec.Clear();
              ClientAdress.Clear();
              PrefTaxation = 0;
              SfNumber_SP = ""; SfDateConc_SP = date(0,0,0);
              SfNumber_DV = ""; SfDateConc_DV = date(0,0,0);
              A2 = ""; A3 = "0"; A41 = ""; A59 = ""; A60 = ""; A61 = ""; A62 = ""; A63 = "";
              A64 = ""; A65 = ""; A66 = ""; A67 = ""; A68 = ""; A69 = ""; A70 = ""; A71 = "";
              A72 = date(0,0,0); A73 = ""; A74 = "2"; A75 = ""; A76 = ""; A77 = ""; A78 = "";
              A79 = date(0,0,0); A80 = ""; A81 = ""; A82 = ""; A83 = ""; A84 = ""; A85 = "";
              A86 = ""; A87 = ""; A88 = ""; A89 = ""; A90 = ""; A91 = "";
              A6 = "0"; A7 = "0"; A8 = "0"; A9 = "0"; A10 = "0"; A11 = "0"; A12 = "0";
              A15 = "0"; A16 = ""; A18 = ""; A20 = ""; A22 = "0"; A23 = "0"; A24 = "0"; A25 = "0";
              A27 = "0"; A28 = "0"; A30 = "2"; A31 = ""; A33 = 0; A35 = 0; A36 = "3"; A38 = "0";
              A39 = "0"; A45 = ""; A46 = ""; A47 = ""; A53 = ""; A54 = "796";

              if( (Client > 0) and (ПолучитьСубъекта(Client, ClientRec) == 0) )
                 if( not TaxDepMode )
                    DL_GetObjAttrName(OBJTYPE_PARTY, PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, DL_GetMainObjAttr(ClientRec, PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, OBJTYPE_PARTY), null, null, @A2);
                    if( (A2 == "1") or (A2 == "2") or (A2 == "3") )
                       A3 = "1";
                    end;
                 end;
                 PrefTaxation = DL_GetMainObjAttr(ClientRec, PARTY_ATTR_GROUP_PREF_TAXATION, OBJTYPE_PARTY);

                 if( not TaxDepMode )
                    A41 = ПолучитьКодСубъекта(Client, PTCK_CONTRTRANS);
                 end;

                 if( ClientRec.rec.LegalForm == 1/*юр. лицо*/ )
                    if( StrLen(ClientRec.rec.NRCountry) == 0 )
                       A59 = "3";
                    elif( (ClientRec.rec.NRCountry == "RUS") or ExistsCitizenship(Client, "RUS") )
                       A59 = "1";
                    else
                       A59 = "2";
                       if( НайтиЮридическийАдресСубъекта(Client, ClientAdress) )
                          A66 = ClientAdress.rec.Adress;
                          ReplaceCRLF(@A66);
                       end;
                    end;
                    A60 = DL_GetCountryByCodeLat3(ClientRec.rec.NRCountry).CodeNum3;
                    A61 = ClientRec.rec.ShortName;
                    SplitFullINN(ПолучитьКодСубъекта(Client, PTCK_INN), A62, A63);
                    A64 = ПолучитьКодСубъекта(Client, PTCK_STATEREGNUM);
                    A65 = ПолучитьКодСубъекта(Client, PTCK_STATEREGNUM);
                 else
                    var SqlQuery, DataSet, ExPersn:bool = false;
                    SqlQuery = RSDCommand( " select * " +
                                           "   from dpersn_dbt " +
                                           "  where t_PersonID = ? " );
                    SqlQuery.addParam("", RSDBP_IN, Client);
                    SqlQuery.execute();
                    DataSet = TRsbDataSet(SqlQuery);
                    if( DataSet.MoveNext() )
                       ExPersn = true;
                       if( DataSet.IsEmployer == "X" )
                          A67 = "1";
                       end;
                    end;
                    A68 = ПолучитьКодСубъекта(Client, PTCK_INN);

                    if( A68 == "" )
                       if( ExPersn )
                          A69 = DataSet.Name1;
                          A70 = DataSet.Name2;
                          A71 = DataSet.Name3;
                          A72 = SQL_ConvTypeDate(DataSet.Born);
                          A73 = DataSet.BirsPlase;
                          if( ClientRec.rec.NRCountry != "" )
                             A74 = "1";
                             A75 = DL_GetCountryByCodeLat3(ClientRec.rec.NRCountry).CodeNum3;
                          end;

                          var Sql, SqlSet;
                          Sql = RSDCommand( "select kind.t_codedocum, persnidc.t_paperseries, persnidc.t_papernumber, persnidc.t_PaperIssuer, persnidc.t_PaperIssuedDate " +
                                            "  from dpersnidc_dbt persnidc, dpaprkind_dbt kind " +
                                            " where persnidc.t_personid  = ? " +
                                            "   and persnidc.t_ismain    = 'X' " +
                                            "   and persnidc.t_paperkind = kind.t_paperkind " );
                          Sql.addParam("", RSDBP_IN, Client);
                          Sql.execute();
                          SqlSet = TRsbDataSet(Sql);
                          if( SqlSet.movenext() )
                             A76 = SqlSet.CodeDocum;
                             A77 = SqlSet.PaperSeries + " " +SqlSet.PaperNumber;
                             A78 = SqlSet.PaperIssuer;
                             A79 = SqlSet.PaperIssuedDate;
                          end;

                          if( НайтиЮридическийАдресСубъекта(Client, ClientAdress) and (ClientAdress.rec.Country == "RUS") )
                             A80 = "1";
                          elif( НайтиАдресСубъекта(Client, PTADDR_REAL, ClientAdress) and (ClientAdress.rec.Country == "RUS") )
                             A80 = "2";
                          end;

                          if( A80 != "" )
                             A81 = ClientAdress.rec.PostIndex;
                             A82 = ClientAdress.rec.RegionNum;
                             A83 = ClientAdress.rec.Province;
                             A84 = ClientAdress.rec.District;
                             A85 = ClientAdress.rec.Place;
                             A86 = ClientAdress.rec.Street;
                             A87 = ClientAdress.rec.House;
                             A88 = ClientAdress.rec.NumCorps;
                             A89 = ClientAdress.rec.Flat;
                             A91 = DL_GetCountryByCodeLat3(ClientRec.rec.NRCountry).CodeNum3;
                          else
                             if( НайтиЮридическийАдресСубъекта(Client, ClientAdress) or НайтиАдресСубъекта(Client, PTADDR_REAL, ClientAdress) )
                                A90 = ClientAdress.rec.Adress;
                                ReplaceCRLF(@A90);
                                A91 = DL_GetCountryByCodeLat3(ClientRec.rec.NRCountry).CodeNum3;
                             end;
                          end;
                       end;
                    end;
                 end;
              end;
           end;

           if( NumReportLine == 1 ) /* печатаем первую строку */
              CreateTotalBook();
              CopyAllSheetInTotalBook(null, false, "N1_TableHeader", 0, null);

              RegisterTable( "N1_MainTable", null,
                             "N1_А1",  "N1_A92", "N1_А2",  "N1_А3",  "N1_А4",  "N1_А5",  "N1_А6",  "N1_А7",  "N1_А8",  "N1_А9",
                             "N1_А10", "N1_А11", "N1_А93", "N1_А94", "N1_А95", "N1_А96", "N1_А97", "N1_А12", "N1_А13", "N1_А14",
                             "N1_А15", "N1_А16", "N1_А17", "N1_А18", "N1_А19", "N1_А20", "N1_А21", "N1_А22", "N1_А23", "N1_А24",
                             "N1_А25", "N1_А26", "N1_А27", "N1_А28", "N1_А29", "N1_А30", "N1_А31", "N1_А32", "N1_А33", "N1_А34",
                             "N1_А35", "N1_А36", "N1_А37", "N1_А38", "N1_А39", "N1_А40", "N1_А41", "N1_А42", "N1_А43", "N1_А44",
                             "N1_А45", "N1_А46", "N1_А47", "N1_А49", "N1_А50", "N1_А51", "N1_А53", "N1_А54", "N1_А55", "N1_А56",
                             "N1_А98", "N1_А99", "N1_А57", "N1_А58", "N1_А59", "N1_А60", "N1_А61", "N1_А62", "N1_А63", "N1_А64",
                             "N1_А65", "N1_А66", "N1_А67", "N1_А68", "N1_А69", "N1_А70", "N1_А71", "N1_А72", "N1_А73", "N1_А74",
                             "N1_А75", "N1_А76", "N1_А77", "N1_А78", "N1_А79", "N1_А80", "N1_А81", "N1_А82", "N1_А83", "N1_А84",
                             "N1_А85", "N1_А86", "N1_А87", "N1_А88", "N1_А89", "N1_А90", "N1_А91"
                           );
           end;

           FD = null; FD2 = null;
           fininstr.Clear(); avoiriss.Clear();
           SumPrecision = 0;
           A4 = "0"; A5 = "0"; A13 = "032"; A14 = "052"; A17 = "0"; A19 = "01";
           A21 = "0"; A26 = "0"; A29 = "0"; A32 = $0.0; A34 = $0.0; A37 = ""; A40 = "";
           A42 = ""; A43 = date(0,0,0); A44 = ""; A55= "1.0"; A56 = $0.0; A57 = $0.0;
           A99 = "";
           A58 = SQL_ConvTypeDate(RecData.Date_Carry);
           ExecDate = SQL_ConvTypeDate(RecData.ExecDate); 

           if( RecData.DocKind != DL_DVNDEAL ) /*БОЦБ*/
              FD = SPFirstDoc(LEG_KIND_DL_TICK, RecData.DocID);

              Exchange = IsEXCHANGE(FD.Group);
              Repo     = IsREPO(FD.Group);
              Sale     = IsSALE(FD.Group);
              Buy      = IsBUY(FD.Group);
              Loan     = IsLoan(FD.Group);
              RetIssue = IsRET_ISSUE(FD.Group);
              RetCoupon= IsRET_COUPON(FD.Group);
              RetPartly= IsRET_PARTLY(FD.Group);
              RQ32 = null; RQ34 = null; ComSum = $0.0;
              attrID = -1; _A2 = ""; SumControl = $0.0; SumControl_REPOLoanExecDate = $0.0; IsBondPFI = false;
              REPOLoanExec = false; REPOLoanExecDate = Date(0,0,0); rq2_p; rq2_d; ExistsOpRetC = false; OpRetCoupID = -1; FD_RetCoup; OpRetCoup_nkd = $0.0;

              if( Repo or Loan )
                 FD2 = SPFirstDoc(LEG_KIND_DL_TICK_BACK, RecData.DocID);
              end;

              if( ПолучитьФинИн(FD.tick.rec.PFI, fininstr, avoiriss) != 0 )
                 MsgBox("Не найдена ценная бумага с ID = " + string(FD.tick.rec.PFI));
              end;
              if( FI_AvrKindsEQ(FIKIND_AVOIRISS, AVOIRISSKIND_BOND, fininstr.rec.AvoirKind) )
                 IsBondPFI = true;
              end;

              // A92
              GetMainObjAttr(null, OBJTYPE_SECDEAL, UniID(FD.tick, OBJTYPE_SECDEAL), 51, attrID, null, null, RecData.ExecDate);
              A92 = IIF(attrID == 2/*1(Да)*/, "1", "0");

              if( Exchange )
                 A17 = "2";
                 A21 = "1";
              end;

              if( (not Exchange) or RetIssue or RetCoupon or RetPartly)
                 A29 = "1";
              end;

              if( not TaxDepMode )
                 if( Repo )
                    A13 = "012";
                    if(Sale)
                      A14 = "020";
                    else 
                      A14 = "021";
                    end;
                    var RQ_IncREPO = FD.GetRQ(DLRQ_TYPE_INCREPO, 2, null, true);
                    if( (Buy and (FD.dl_leg.rec.IncomeRate > 0)) or
                        (Sale and (FD.dl_leg.rec.IncomeRate < 0)) )
                       RQ32 = RQ_IncREPO;
                    end;
                    if( (Buy and (FD.dl_leg.rec.IncomeRate < 0)) or
                        (Sale and (FD.dl_leg.rec.IncomeRate > 0)) )
                       RQ34 = RQ_IncREPO;
                    end;
                    A40 = NUMSTR + "65.22";
                    if( RQ_IncREPO != null )
                       A56 = RQ_IncREPO.rec.Amount;
                       if( not SmartConvertSum(A57, A56, ExecDate, RQ_IncREPO.rec.FIID, NATCUR, true) )
                          A57 = $0.0;
                       end;
                    end;
                 else
                    var RQ_Payment = FD.GetRQ(DLRQ_TYPE_PAYMENT, null, null, true);
                    if( Sale )
                       RQ32 = RQ_Payment;
                       if(Loan)
                         A14 = "021";
                       end;
                    elif( Buy )
                       RQ34 = RQ_Payment;
                       ComSum = СуммаКомУплачБанком(FD.tick.rec.BofficeKind, FD.tick.rec.DealID, ExecDate);
                       if(Loan)
                         A14 = "020";
                       end;
                    end;
                    if( not TaxDepMode )
                       A40 = "65.23.1";
                    end;
                    SumPrecision = fininstr.rec.SumPrecision;
                    A55 = ДЛ_ЧислоCЗаданнойТочностью(FD.dl_leg.rec.Principal, SumPrecision );                
   
                    if( RQ_Payment != null )
                       if( not SmartConvertSum(A57, RQ_Payment.rec.Amount, ExecDate, RQ_Payment.rec.FIID, NATCUR, true) )
                          A57 = $0.0;
                       end;
                    end;
                 end;

                 A37 = "Ценная бумага '" + fininstr.rec.Name + "'";
              end;

              if( FD.tick.rec.PartyContrID > 0 )
                 GetDataSfContr(FD.tick.rec.PartyContrID, Client, PTSK_STOCKDL, @A42, @A43);
              else
                 if( SfNumber_SP == "" )
                    GetDataSfContr(-1, Client, PTSK_STOCKDL, @SfNumber_SP, @SfDateConc_SP);
                 end;
                 A42 = SfNumber_SP;
                 A43 = SfDateConc_SP;
              end;

              var IssuerRec = TRecHandler("party.dbt");
              if( (ПолучитьСубъекта(fininstr.rec.Issuer, IssuerRec) == 0) and (IssuerRec.rec.NRCountry != "") )
                 A44 = DL_GetCountryByCodeLat3(IssuerRec.rec.NRCountry).CodeNum3;
              end;

              if( RecData.DocKind == DL_SECURITYDOC ) /*сделки*/
                 if( (A2 == "0") and Exchange )
                    var MarketRec = TRecHandler("party.dbt");
                    if( (ПолучитьСубъекта(FD.tick.rec.MarketID, MarketRec) == 0) and (MarketRec.rec.NRCountry != "RUS") )
                       A4 = "1";
                    end;
                 end;

                 if( (not TaxDepMode) and (not Repo) )
                    A56 = FD.dl_leg.rec.Price;
                 end;
              else /*погашения*/
                 if( ((not TaxDepMode)) and (FD.dl_leg.rec.Principal != 0) )
                    A56 = round(FD.dl_leg.rec.TotalCost / FD.dl_leg.rec.Principal, 2);
                 end;
              end;

              if( Repo )
                 A99 = FD.Dl_Leg.rec.IncomeRate;
              end;

           else /*ПИ*/
              FD = DVFirstDocNDeal(DL_DVNDEAL, RecData.DocID);

              // A92
              GetMainObjAttr(null, OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), 51, attrID, null, null, RecData.ExecDate);
              A92 = IIF(attrID == 2/*1(Да)*/, "1", "0");

              A29 = "1";
              if( FD.IsSWAP() )
                 A37 = "Валютный СВОП с базовой валютой '" + GetNameFI(FD.nFI_BaseActiv.rec.FIID) + "' и контрвалютой '" + GetNameFI(FD.nFI_BAOther.rec.FIID) + "'";
              elif( FD.IsPctSWAP() and FD.БазовыеВалютыРавны() )
                 A37 = "Процентный СВОП с базовой валютой '" + GetNameFI(FD.nFI_BaseActiv.rec.FIID) + "' и контрвалютой '" + GetNameFI(FD.nFI_BAOther.rec.FIID) + "'";
              elif( FD.IsPctSWAP() )
                 A37 = "Валютно-процентный СВОП с базовой валютой '" + GetNameFI(FD.nFI_BaseActiv.rec.FIID) + "' и контрвалютой '" + GetNameFI(FD.nFI_BAOther.rec.FIID) + "'";
              elif( FD.IsOption() or FD.IsForward() )
                 if( FD.IsOption() )
                    A37 = "Опцион на ";
                 else
                    A37 = "Форвард на ";
                 end;

                 if( FD.IsBuy() )
                    A37 = A37 + " покупку ";
                 else
                    A37 = A37 + " продажу ";
                 end;

                 if( FD.Deal.rec.Forvard == SET_CHAR )
                    A37 = A37 + "форварда ";
                 else
                    A37 = A37 + GetKindFI(FD.nFI_BaseActiv.rec.FIID) + " '" + GetNameFI(FD.nFI_BaseActiv.rec.FIID) + "' ";
                 end;

                 A37 = A37 + "за '" + GetNameFI(FD.nFI_BaseActiv.rec.PriceFIID) + "' с ценой исполнения " + string(FD.nFI_BaseActiv.rec.Price);
              end;

              A40 = "65.23.4";

              if( SfNumber_DV == "" )
                 GetDataSfContr(-1, Client, PTSK_DV, @SfNumber_DV, @SfDateConc_DV);
              end;
              A42 = SfNumber_DV;
              A43 = SfDateConc_DV;                
              if( FD.IsOption() or FD.IsForward() or FD.IsSWAP() )                
                if( ПолучитьФинИн(FD.nFI_().rec.FIID, fininstr) != 0 )  
                  MsgBox("Не найдена ценная бумага с ID = " + string(FD.nFI_().rec.FIID));
                else
                  SumPrecision = fininstr.rec.SumPrecision; 
                  A55 = ДЛ_ЧислоCЗаданнойТочностью(FD.nFI_().rec.Amount, SumPrecision ); 
                end;                  
              end;
              
              if( FD.IsForward() )
                
                if ( not SmartConvertSum(A56, FD.nFI_BaseActiv.rec.Price, ExecDate, FD.nFI_BaseActiv.rec.PriceFIID, NATCUR, true) )
                  A56 = 0.0;
                end;
                if ( not SmartConvertSum(A57, FD.nFI_BaseActiv.rec.Cost, ExecDate, FD.nFI_BaseActiv.rec.PriceFIID, NATCUR, true) )
                  A57 = 0.0;
                end;
                
              elif( FD.IsOption() )
                if ( not SmartConvertSum(A56, FD.Deal.rec.BonusPrice, ExecDate, FD.nFI_BaseActiv.rec.PriceFIID, NATCUR, true) )
                  A56 = 0.0;
                end;
                if ( not SmartConvertSum(A57, FD.Deal.rec.Bonus, ExecDate, FD.nFI_BaseActiv.rec.PriceFIID, NATCUR, true) )
                  A57 = 0.0;
                end;

              elif( FD.IsSWAP() )
                if(RecData.date_carry <= FD.nFI_BaseActiv.rec.Supldate)
                  if ( not SmartConvertSum(A56, FD.nFI_BaseActiv.rec.Price, SQL_ConvTypeDate(FD.nFI_BaseActiv.rec.Supldate), FD.nFI_BaseActiv.rec.PriceFIID, NATCUR, true) )
                    A56 = 0.0;
                  end;
                  if ( not SmartConvertSum(A57, FD.nFI_BaseActiv.rec.Cost, SQL_ConvTypeDate(FD.nFI_BaseActiv.rec.Supldate), FD.nFI_BaseActiv.rec.PriceFIID, NATCUR, true) )
                    A57 = 0.0;
                  end;
                else
                  if ( not SmartConvertSum(A56, FD.nFI_BAOther.rec.Price, SQL_ConvTypeDate(FD.nFI_BAOther.rec.Supldate), FD.nFI_BAOther.rec.PriceFIID, NATCUR, true) )
                    A56 = 0.0;
                  end;
                  if ( not SmartConvertSum(A57, FD.nFI_BAOther.rec.Cost, SQL_ConvTypeDate(FD.nFI_BAOther.rec.Supldate), FD.nFI_BAOther.rec.PriceFIID, NATCUR, true) )
                    A57 = 0.0;
                  end;
                end;
                
              else
                var SumTreb:money = 0.0,
                    SumOb:money   = 0.0;
                var CountDays1:integer = 0,
                    CountDays2:integer = 0;
                var Rate:money = 0.0;                
  
                CountDays1 = DaysInYearByBasis( ExecDate, FD.nFI_BaseActiv.rec.Basis );
                if(DV_NDealSideFix(ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal))
                  if((CountDays1 > 0) and (FD.nFI_BaseActiv.rec.Rate > 0 ) )
                    SumOb = FD.nFI_BaseActiv.rec.Amount * ( ExecDate - FD.Deal.rec.BeginDate)/ CountDays1 * FD.nFI_BaseActiv.rec.Rate/100; 
                  end;
                else
                  if ( not GetCourse(@Rate, FD.nFI_BaseActiv.rec.RateID, FI_PRICE_POINT, FD.deal.rec.date))
                    Rate = 0.0; 
                  end;
                  if( ( CountDays1 > 0) and (Rate > 0 ) or (FD.nFI_BaseActiv.rec.Spread > 0 ) ) 
                    SumOb = FD.nFI_BaseActiv.rec.Amount *(ExecDate - FD.Deal.rec.BeginDate)/CountDays1 * (Rate + FD.nFI_BaseActiv.rec.Spread)/100;
                  end; 
                end;

                CountDays2 = DaysInYearByBasis( ExecDate, FD.nFI_BAOther.rec.Basis ); 
                if( DV_NDealSideFix(ALG_DV_PMGR_SIDE_DEMAND, FD.Deal))
                  SumTreb= FD.nFI_BAOther.rec.Amount *(ExecDate - FD.Deal.rec.BeginDate)/CountDays2 * FD.nFI_BAOther.rec.Rate/100 ;
                else
                  if (not GetCourse(@Rate, FD.nFI_BAOther.rec.RateID, FI_PRICE_POINT, FD.deal.rec.date))
                      Rate = 0.0; 
                  end;
                  if( ( CountDays2 > 0) and (Rate > 0 ) or (FD.nFI_BAOther.rec.Spread > 0 ) ) 
                    SumTreb = FD.nFI_BAOther.rec.Amount *(ExecDate - FD.Deal.rec.BeginDate)/CountDays2 * (Rate + FD.nFI_BAOther.rec.Spread)/100;
                  end;

                end;
                if ( not SmartConvertSum( SumOb, SumOb, FD.deal.rec.date, FD.nFI_BaseActiv.rec.FIID, NATCUR, true) )
                   SumOb = 0.0;
                end;  

                if ( not SmartConvertSum( SumTreb, SumTreb, FD.deal.rec.date, FD.nFI_BAOther.rec.FIID, NATCUR, true) )
                   SumTreb = 0.0;
                end;

                A56 = A57 = SumTreb - SumOb;    
              end;
           end;
           if( (not TaxDepMode) and (A21 == "0") )
              A26 = "1";
           end;

           if( A2 == "0" )
              if( TaxDepMode OR ((PrefTaxation == 1/*Да*/) and (A4 == "0")) )
                 A5 = "1";
              end;
           end;
           if((not TaxDepMode) and (RecData.IsDebet == 0))
             A32 = RecData.Sum_NatCur;           
           end; 

           if((not TaxDepMode) and (RecData.IsDebet == 1))
             A34 = RecData.Sum_NatCur;
           end;

           A98 = RecData.A98;

           A1 = NumReportLine;

           m_IsDataExist = true;

           if( TaxDepMode )
              SetData_TaxDepMode( false );
           end;

           PrintData(SumPrecision,
                     A1,  A92, A2,  A3,  A4,  A5,  A6,  A7,  A8,  A9,  A10, A11, A93, A94, A95, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21, A22, A23, A24,
                     A25, A26, A27, A28, A29, A30, A31, A32, A33, A34, A35, A36, A37, A38, A39, A40, A41, A42, A43, A44, A45, A46, A47, A49, A50, A51, A53, A54, A55, A56,
                     A98, A99, A57, A58, A59, A60, A61, A62, A63, A64, A65, A66, A67, A68, A69, A70, A71, A72, A73, A74, A75, A76, A77, A78, A79, A80, A81, A82, A83, A84,
                     A85, A86, A87, A88, A89, A90, A91);

           if( TaxDepMode )
              // печатаем вторую строку
              if( ((not Repo) and (not Loan) and (not RetIssue) and (not RetPartly) and (not RetCoupon) and ((Buy or Sale) and IsBondPFI)) or ((RetIssue or RetPartly) and ((FD.Tick.rec.Number_Coupon != "") or ExistsOpRetC)) )

                 SetData_TaxDepMode( true );

                 // графы  100 (<A2>) - 311 (<A35>) заполняются один раз (по строке с основной суммой сделки)
                 PrintData(SumPrecision,
                           A1, A92, ""/*A2*/, ""/*A3*/, ""/*A4*/, ""/*A5*/, ""/*A6*/, ""/*A7*/, ""/*A8*/, ""/*A9*/, ""/*A10*/, ""/*A11*/, ""/*A93*/, ""/*A94*/, ""/*A95*/,
                           ""/*A12*/, ""/*A13*/, ""/*A14*/, ""/*A15*/, ""/*A16*/, ""/*A17*/, ""/*A18*/, ""/*A19*/, ""/*A20*/, ""/*A21*/, ""/*A22*/,
                           ""/*A23*/, ""/*A24*/, ""/*A25*/, ""/*A26*/, ""/*A27*/, ""/*A28*/, ""/*A29*/, ""/*A30*/, ""/*A31*/, ""/*A32*/, ""/*A33*/, ""/*A34*/, ""/*A35*/,
                           A36, A37, A38, A39, A40, A41, A42, A43, A44, A45, A46, A47, A49, A50, A51, A53, A54, A55, A56, A98, A99, A57, A58, A59, A60, A61, A62, A63, A64,
                           A65, A66, A67, A68, A69, A70, A71, A72, A73, A74, A75, A76, A77, A78, A79, A80, A81, A82, A83, A84, A85, A86, A87, A88, A89, A90, A91);
              end;
           end;

           prevClient = Client;
           NumReportLine = NumReportLine + 1;
           ProgressValue.Current = ProgressValue.Current + 1;
           ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); // всего 3 парамера Update(index, count, text)
        end;
        ProgressIndicator.Stop();
     end;
  END;

  PRIVATE MACRO Create()
  
     var OurBankRec = TRecHandler("party.dbt");
     if( ПолучитьСубъекта({OurBank}, OurBankRec) == 0 )
        var OurBankAdress = TRecHandler("adress.dbt");

        A49 = DL_GetCountryByCodeLat3(OurBankRec.rec.NRCountry).CodeNum3;

        if( НайтиЮридическийАдресСубъекта({OurBank}, OurBankAdress) )
           A50 = OurBankAdress.rec.RegionNum;
           A51 = OurBankAdress.rec.District;
        end;
     else
        MsgBox("Не найден субъект с ID = " + string({OurBank}));
        return;
     end;

     var Client = NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_CLIENTCODE ),
         ClientsStr = "";

     if( ((not m_IsWebService) and (ValType(Client) == V_Integer) and (Client != -1))
     or (m_IsWebService and (ValType(Client) == V_String) and (Client != "Все"))
     or (m_IsWebService and (ValType(Client) == 19/*ARRAY*/) and (Client.Size > 0)) )
        if( not m_IsWebService )
           ClientsStr = String(Client);
        elif( (ValType(Client) == 19/*ARRAY*/) and (Client.Size > 0) )
           ClientsStr = String(Client[0]);
           For(var i, 1, Client.size-1)
             ClientsStr = ClientsStr + "," + Client[i];
           end;
        end;
     else // Client == "Все"
        var NRec:integer = 0,
            query = " SELECT party.t_PartyID, " +
                    "        (SELECT o1.t_Code " +
                    "           FROM dobjcode_dbt o1 " +
                    "          WHERE o1.t_CodeKind = "+PTCK_CONTR+" AND o1.t_ObjectID = party.t_PartyID " +
                    "                AND o1.t_BankDate = " +
                    "                       (SELECT MAX (o2.t_BankDate) " +
                    "                          FROM dobjcode_dbt o2 " +
                    "                         WHERE o2.t_CodeKind = "+PTCK_CONTR +
                    "                               AND o2.t_ObjectID = party.t_PartyID " +
                    "                               AND o2.t_BankDate <= ?)) " +
                    "           AS t_PartyCode " +
                    "   FROM dparty_dbt party " +
                    "  WHERE EXISTS( SELECT attr.* " +
                    "                  FROM dobjatcor_dbt attr " +
                    "                 WHERE attr.t_ObjectType = "+OBJTYPE_PARTY +
                    "                   AND attr.t_GroupID    = 58 " + 
                    "                   AND attr.t_Object     = LPAD(party.t_PartyID, 10, '0') " +
                    "                   AND (SELECT count(1) " +
                    "                          FROM DOBJATCOR_DBT at " +
                    "                         WHERE at.t_ObjectType = attr.t_ObjectType " +
                    "                           AND at.t_GroupID    = attr.t_GroupID " +
                    "                           AND at.t_Object     = attr.t_Object " +
                    "                           AND at.t_ValidFromDate <= ? " +
                    "                        ) > 0 " +
                    "              ) "
                    " ORDER BY t_PartyCode ";

        var NRecSelect = RSDCommand( "SELECT COUNT(*) nRecs FROM (" + query + ")" );
        NRecSelect.NullConversion = true;
        NRecSelect.addParam("", RSDBP_IN, NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_ENDDATE ));
        NRecSelect.addParam("", RSDBP_IN, NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_ENDDATE ));
        NRecSelect.execute();
        var NRecData = TRsbDataSet(NRecSelect);
        if( (NRecData.MoveNext()) and (SQL_ConvTypeInteger(NRecData.nRecs) != null) )
           NRec = SQL_ConvTypeInteger(NRecData.nRecs);
        end;

        VAR ProgressValue = CTxProgressValue();
        ProgressValue.Maximum = NRec;
        ProgressValue.Current = 0;

        if (ProgressValue.Maximum > 0)
           var RecSelect = RSDCommand(query);
           RecSelect.NullConversion = true;
           RecSelect.addParam("", RSDBP_IN, NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_ENDDATE ));
           RecSelect.addParam("", RSDBP_IN, NotifContrDeal_Form.GetFieldValue( PNFLD_NCDEAL_ENDDATE ));
           var RecData = TRsbDataSet(RecSelect);

           var ProgressIndicator = CreateProgressIndicator(m_IsWebService);

           if( m_IsWebService and (WebMenuItem != null) )
             var header = "Формирование отчета " + WebMenuItem.szNameItem;
             ProgressIndicator.Start(ProgressValue.Maximum, header);
           else
             ProgressIndicator.Start(ProgressValue.Maximum, "Отчет: Уведомление о контролируемых сделках", "Просмотр субъектов...");
           end;

           if( RecData.MoveNext() )
              ClientsStr = String(RecData.PartyID);
              ProgressValue.Current = ProgressValue.Current + 1;
              ProgressIndicator.Update(ProgressValue.Current);
           end;
           while( RecData.MoveNext() )
              ClientsStr = ClientsStr + "," + RecData.PartyID;
              ProgressValue.Current = ProgressValue.Current + 1;
              ProgressIndicator.Update(ProgressValue.Current);
           end;
           ProgressIndicator.Stop();
        end;
     end;
     PrintReport( ClientsStr );
  END;

  initCB_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
      NotifContrDeal_Form = SC_NotifContrDeal_Panel();
  else
    if( ValType( FormData ) != V_UNDEF )
      NotifContrDeal_Form = WS_NotifContrDeal_Panel( FormData );
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = NotifContrDeal_Form.Run();
    end;

    if( stat )
      NotifContrDeal_Report = SC_NotifContrDeal_Report( null, "Report_NotifContrDeal.xls", null, IsWebService, ReportHashCode );      
      NotifContrDeal_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = NotifContrDeal_Report.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
      end;
    end;
  end;

  return FullReportFileNames;
END;
