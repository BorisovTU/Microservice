/*                                                                                                                                                    
$Name: dl_report701.mac
$Module: Ядро Securities
$Description: <Отчеты> / <Регламентированные> / <Отчет об операциях на валютных и денежных рынках (ф.701)>  
*/
import "dl_report701_form.mac", "mctplprm.mac", "dlquery.mac", "dldlngfun.mac", "param.mac", "bnk_dttmfrmt.mac", "dv_load_701.mac", "scsrvrepfun.mac" /*URS, коммент добавлен при адаптауии 84.2*/;
//import rcbImport; // UPD 84.4 ошибки компиляции (Ошибка rcbZone.mac строка 56[0]: временное необъектное значение не может содержать свойство или метод context)

private const
   OUTASTEXT = "OUTASTEXT";

/*UPD 84.2 Иначе, ошибка компилляции*/
private const 
      RCB_XML_PK_DAYLY     = 0;/**/

private const
   OUTASVOID = "OUTASVOID";

PRIVATE FILE Kliko_F701() txt write;
PRIVATE CONST KLIKO_FORM_F701_V  = 1, //Форма "Конверсионные операции (операции на валютных рынках)"
              KLIKO_FORM_F701_D  = 2, //Форма "Операции на денежных рынках"
              KLIKO_FORM_F701_PD = 3; //Форма "Операции с процентными деривативами"

PRIVATE CONST KLIKO_FILE_VIEW = TRUE; //Вывод сформированых файлов Kliko в терминал

PRIVATE VAR m_DeltaReport;

PRIVATE CONST POI_MODE = TRUE;

PRIVATE VAR Dl_Rep701_Form;

/*USR*/
Private MACRO DL_GetISOCode( FIID:integer ):string
   var sql = RSDCommand("select t_ISO_Number from dfininstr_dbt where t_FIID = ? " );

   sql.addParam( "", RSDBP_IN, FIID );
   sql.execute();

   var fininstr = TRsbDataSet(sql);

   if( fininstr.MoveNext )
      return fininstr.ISO_Number;
   end;

   return 0;
END;/*USR*/


CLASS F701DeltaXML(OKUD:String, ReportKind:String, EndDate:Date, Periodicity:Integer)
   private var m_XmlReport;
   private var m_EndDate = EndDate;
   private var RowNum = 0;
   private var jvm;
   private var m_Protocol;
   private var m_FileName = "";
   private var m_OKUD = OKUD;

   PRIVATE MACRO Delta_Fld( Val:VARIANT ):STRING
      VAR ValStr = "";

      if( Val != NULL ) 
        VAR vt = ValType(Val);
        if( vt == V_DATE )
           if( Val == DATE(0,0,0) )
              ValStr = "0";
           else
              VAlStr = YYYY_MM_DD(Val);
           end;
        elif( vt == V_STRING )
           ValStr = StrSubst( Val, "\"", "''" );
           ValStr = trim(ValStr);
           //if (ValStr == "")
           //    ValStr = "0";
           //end;      
        elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
          if( Val != 0.00)
            ValStr = trim(string(Val:18:3));
          else
            ValStr = "0.000"
          end;
        else
           ValStr = string(Val);
        end;
      else
        ValStr="";
      end;

      return ValStr;
   END;
   
   macro PrintInfo()
      var registrationNumber = repGetPartyCode({OurBank}, PTCK_BANKREGNUM, m_EndDate);
      var party = TRecHandler("party.dbt");
      var kindOrganisation = "КО";
      var OKATO;
      var Name;
      var adress = TRecHandler("adress.dbt");
      var leaderPost:String, leaderName:String;
      var executorPost;
      var executorName;
      var executorPhone;
      var executorEmail;

      ПолучитьСубъекта({OurBank}, party);
      Name = party.rec.Name;

      GetMainObjAttr(NULL,
                     OBJTYPE_PARTY,
                     UniID(party, OBJTYPE_PARTY),
                     12 /*RCB_OBJGROUP_PT_OKATO*/, // 12 /*Адаптация 84.2 константа не определена, выдает ошибку при компилляции*/
                     NULL,
                     NULL,
                     OKATO,
                     m_EndDate
                    );

      if(OKATO == NULL)
         var OkatoQuery = "select adress.t_OKATO " +
                          "from dadress_dbt adress " +
                          "where adress.t_Type = 1 " +
                          "  and adress.t_PartyID = " + string({OurBank});

         var OkatoSelect = DL_RSDCommand(OkatoQuery);
         var OkatoDS = OkatoSelect.Execute();
         if(OkatoDS.MoveNext())
            OKATO = OkatoDS.OKATO;
         end;
      end;

      OKATO = IIF(OKATO != NULL, OKATO, "");

      var leaderQuery = "select off.t_Post, " +
                        "       party.t_Name " +
                        "from dofficer_dbt off, dparty_dbt party " +
                        "where off.t_IsFirstPerson = 'X' " +
                        "  and off.t_PartyID = " + string({OurBank}) +
                        "  and party.t_PartyID = off.t_PersonID ";

      var leaderSelect = DL_RSDCommand(leaderQuery);
      var leaderDS = leaderSelect.Execute();

      if(leaderDS.MoveNext())
         leaderPost = leaderDS.Post;
         leaderName = leaderDS.Name;
      else
         leaderPost = leaderName = "";
      end;
      
      var executorQuery = 
              "select off.t_Post,                                                              " +
              "       persn.t_Name1 || ' ' || persn.t_Name2 || ' ' || persn.t_Name3 as t_Name, " +
              "       nvl(                                                                     " +
              "        (                                                                       " +
              "              select q_Phone.t_Value                                            " +
              "              from (                                                            " +
              "                    select Phone.t_Value                                        " +
              "                    from dcontact_dbt Phone                                     " +
              "                    where Phone.t_PartyID = person.t_PartyID                    " +
              "                          and Phone.t_ContactKind = 1                           " +
              "                          and Phone.t_ContactType = 2                           " +
              "                          order by Phone.t_IsMain DESC                          " +
              "                    ) q_Phone                                                   " +
              "              where ROWNUM = 1                                                  " +
              "              ), chr(1)                                                         " +
              "           ) as t_Phone,                                                        " +
              "        nvl(                                                                    " +
              "        (                                                                       " +
              "          select q_Email.t_Value                                                " +
              "          from (                                                                " +
              "                select Email.t_Value                                            " +
              "                from dcontact_dbt Email                                         " +
              "                where Email.t_PartyID = person.t_PartyID                        " +
              "                      and Email.t_ContactKind = 5                               " +
              "                      and Email.t_ContactType = 8                               " +
              "                      order by Email.t_IsMain DESC                              " +
              "                ) q_Email                                                       " +
              "          where ROWNUM = 1                                                      " +
              "          ), chr(1)                                                             " +
              "        )                                                                       " +
              "        as t_Email                                                              " +
              "from dofficer_dbt off,                                                          " +
              "     dpersOn_dbt  persOn,                                                       " +
              "     dpersn_dbt   persn                                                         " +
              "where persOn.t_Oper = "     + string({oper})                                      +
              "      and off.t_PartyID = " + string({OurBank})                                   +
              "      and off.t_PersonID = persOn.t_PartyID                                     " +
              "      and persn.t_PersonID = persOn.t_PartyID                                   ";
                         
                        
      var executorSelect = DL_RSDCommand(executorQuery);
      var executorDS = executorSelect.Execute();

      if(executorDS.MoveNext())
         executorPost  = executorDS.Post;
         executorName  = executorDS.Name;//{Name_Oper}
         executorPhone = executorDS.Phone;
         executorEmail = executorDS.Email;
      else
         executorPost = executorName = executorPhone = executorEmail = "";
      end;  	  
      var Compiler = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var OrgType  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ВидОрг", Delta_Fld(kindOrganisation));
      Compiler.add(OrgType);
      var Rnumb  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодОрг", Delta_Fld(registrationNumber));
      Compiler.add(Rnumb);
      var attrOKATO  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКАТО", Delta_Fld(OKATO));
      Compiler.add(attrOKATO);
      var DSign  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаПодписания", Delta_Fld(Date()));
      Compiler.add(DSign);
      m_XmlReport.beginPart("Составитель",Compiler);
      
        var Supervisor = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var LPost  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Должность", Delta_Fld(leaderPost));
        Supervisor.add(LPost);
        var LName  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ФИО", Delta_Fld(leaderName));
        Supervisor.add(LName);
        m_XmlReport.addLine("Руководитель", Supervisor, "");
        
        var Executor = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var EPost  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Должность", Delta_Fld(executorPost));
        Executor.add(EPost);
        var EName  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ФИО",       Delta_Fld(executorName));
        Executor.add(EName);
        var EPhone  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Телефон",  Delta_Fld(executorPhone));
        Executor.add(EPhone);
        var EEmail  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЭлПочта",  Delta_Fld(executorEmail));
        Executor.add(EEmail);
        m_XmlReport.addLine("Исполнитель", Executor, "");
        
      m_XmlReport.finishPart();
      
      m_Protocol = m_XmlReport.getProtocol();
   end;

   macro BeginData701()
      var Макет = "4";
      if (m_EndDate <= date (31,3,2016))
        Макет = "0";
      elif (m_EndDate <= date (30,6,2016))
        Макет = "1";
      elif (m_EndDate <= date (31,12,2016))
        Макет = "2";
      elif (m_EndDate <= date (31,3,2021))
        Макет = "3";
      end;
      var IdAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Макет", Макет);
      var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var NullAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

      Attributes.add(IdAttribute);
      m_XmlReport.beginPart("Данные701", Attributes);
      //m_XmlReport.beginPart("Данные_Формы", NullAttributes);

      RowNum = 1;
   end;
   
   macro BeginLine(str)
     var NullAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
     m_XmlReport.beginPart(str,NullAttributes);
   end;

   macro ResidentPr(BankcontrAgent, TypeContr, PRegNum, BIC, DLKind)
       //|Резидент (ОРФ?, РегНом?, ПрефРегНом?, БИК? ) 
       var Resident = jvm.createJavaObject("java.util.ArrayList", "<init>");
       var attrORF;
       if( (TypeContr == 1) or ((TypeContr == 5) or ((TypeContr == 11) or ((TypeContr == 7) 
          or ((TypeContr == 8) or ((TypeContr == 9) or ((TypeContr == 10) or (TypeContr == 6))))))))
         attrORF = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОРФ", Delta_Fld(BankcontrAgent));
         Resident.add(attrORF);
       end;
       var Ind = Index(BankcontrAgent, "-");
       BankcontrAgent = IIF(Ind > 0, SubStr(BankcontrAgent, 1, Ind - 1), BankcontrAgent);

       var РегНом = IIF(TypeContr == 2, BankcontrAgent, "" );
       if (РегНом != "")
         var attrRegNum  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РегНом", РегНом);
         Resident.add(attrRegNum);
       end;
       if (PRegNum != "")
         var attrPRegNum = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПрефРегНом", Delta_Fld(PRegNum) );
         Resident.add(attrPRegNum);
       end;

       var БИК = IIF(BankcontrAgent == "", Delta_Fld(BIC), "" );
       if (БИК != "")
         var attrBIC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "БИК", БИК);
         Resident.add(attrBIC);
       end;
       m_XmlReport.addLine("Резидент", Resident, "");
   end;
   
   macro NoResidentPr(Country, SWIFT, NKO)
       
       //|Нерезидент (Страна, СВИФТ?, НаимКО? ) 
       var NoResident = jvm.createJavaObject("java.util.ArrayList", "<init>");
       var attrCountry = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Страна", Country );
       var attrSWIFT = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СВИФТ"   , SWIFT );
       NoResident.add(attrCountry);
       NoResident.add(attrSWIFT);
       if (NKO != "")
         var attrNKO = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НаимКО"    , NKO  );
         NoResident.add(attrNKO);
       end;
       
       m_XmlReport.addLine("Нерезидент", NoResident, "");
   end;
   
   macro ContrPr (Contrstr, TypeContr, BankcontrAgent, PRegNum, BIC, Country, SWIFT, NKO, ISRESIDENT, DLKind)
        if ((TypeContr == "") or (TypeContr == 0) or (TypeContr == NULL))
         return;
        end;
        var attrCntr = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var tCntr  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипКонтр", Delta_Fld(TypeContr));
        attrCntr.add(tCntr);
        
        m_XmlReport.beginPart(Contrstr, attrCntr, PRegNum, BIC);
          //|Резидент (ОРФ?, РегНом?, ПрефРегНом?, БИК? ) 
          if(ISRESIDENT=="R")
            ResidentPr(BankcontrAgent, TypeContr, PRegNum, BIC, DLKind);
          end;
          //|Нерезидент (Страна, СВИФТ?, НаимКО? ) 
          if(ISRESIDENT=="N")
            NoResidentPr(Country, SWIFT, NKO);
          end;
        m_XmlReport.finishPart();
   end;
   
   macro AddLineDC(StrCounter, Data)
      
      var leaderDC = jvm.createJavaObject("java.util.ArrayList", "<init>");
      
      var attrRowNum = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Номер", string(StrCounter));
      leaderDC.add(attrRowNum);
      var attrDateSDC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаЗаклСделки", Delta_Fld(SQL_ConvTypeDate(Data.DealDate)));
      leaderDC.add(attrDateSDC);
      var attrDateCDC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаРасчета", Delta_Fld(SQL_ConvTypeDate(Data.CalcDate)));
      leaderDC.add(attrDateCDC);
      
      m_XmlReport.beginPart("СделкаВР",leaderDC);
      
        var attrOVR = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var codValOVR  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЦКодВалТреб", Delta_Fld(IIF( Data.ReqFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(Data.ReqFIID)) )));
        attrOVR.add(codValOVR);
        var sumOVR     = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СуммаТреб",   Delta_Fld(Data.ReqSum));
        attrOVR.add(sumOVR);
        var codrODR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЦКодВалОбяз", Delta_Fld(IIF( Data.ComFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(Data.ComFIID)) )));
        attrOVR.add(codrODR);
        var sumrOVR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СуммаОбяз ",  Delta_Fld(Data.ComSum));
        attrOVR.add(sumrOVR);
        m_XmlReport.addLine("УсловияОВР", attrOVR, "");
        
        var attrkRN = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var pRN  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризнакРН", Delta_Fld(Data.ISRESIDENT));
        attrkRN.add(pRN);
        m_XmlReport.addLine("КонтрРН", attrkRN, "");
        
        var TypeContr = Data.t_TypeContr;
        if (TypeContr == 0)
          TypeContr = "";
        end;
        if (not (((Data.ISRESIDENT == "R") AND (Data.MARKETCONTRAGENT == "MMVB")) OR ((Data.OTHER == "C") OR (Data.OTHER == "K") OR (Data.OTHER == "E") OR (Data.OTHER == "F") OR (Data.OTHER == "I"))))
         ContrPr("КонтрагентОВР", TypeContr, Data.T_BANKCONTRAGENT, Data.T_PREGNUM, Data.T_BIC, Data.OKCMCODE, IIF(Data.IsSWIFTCode==SET_CHAR, Data.T_BANKCONTRAGENT, ""), 
         IIF( Data.IsSWIFTCode!=SET_CHAR, IIF(Data.OKCMCODE!="",SubStr(Data.BANKCONTRAGENT,1,Index(Data.BANKCONTRAGENT,Data.OKCMCODE)-1),Data.BANKCONTRAGENT), ""), Data.ISRESIDENT, Data.DLKind);
        end;

        var attrOrg = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var AbbName  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "АббревНаим", Delta_Fld(Data.MARKETCONTRAGENT));
        attrOrg.add(AbbName);
        m_XmlReport.addLine("Организатор", attrOrg, "");
      
        var attrSegment = jvm.createJavaObject("java.util.ArrayList", "<init>");
        if (Data.OTHER != "")
         var CodO  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодОперации", Delta_Fld(Data.OTHER));
         attrSegment.add(CodO);
        end;
        if (Data.DEALADDINFO != "")
         var Codi  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ВидОперации", Delta_Fld(Data.DEALADDINFO));
         attrSegment.add(Codi);
        end;
        m_XmlReport.addLine("СегментРынка", attrSegment, "");
      
        if((Data.DLKIND==5)or(Data.DLKIND==6))
          var attrADD = jvm.createJavaObject("java.util.ArrayList", "<init>");
          var TddInf = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипОпциона", Delta_Fld(SubStr(Data.TYPEADDINFO,1,1)));
          attrADD.add(TddInf);
          var pddInf = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПремияОпциона", Delta_Fld(Data.TYPEADDINFO,1,1));
          attrADD.add(pddInf);
          var DddInf = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СрокФК", Delta_Fld(SubStr(Data.TYPEADDINFO,2,StrLen(Data.TYPEADDINFO)-1)));
          attrADD.add(DddInf);
          var DfddInf = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДлитФК", "");
          attrADD.add(DfddInf);
          m_XmlReport.addLine("Опцион", attrADD, ""); 
        end;
        
        if((Data.DLKIND!=5)and(Data.DLKIND!=6)and(Data.TYPEADDINFO!=""))
          var attrkac = jvm.createJavaObject("java.util.ArrayList", "<init>");
          var TypeAddInfo  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипФА", Delta_Fld(Data.TYPEADDINFO));
          attrkac.add(TypeAddInfo);  
          m_XmlReport.addLine("ФинАктив", attrkac, "");          
        end;
        
        var attrkInf = jvm.createJavaObject("java.util.ArrayList", "<init>");
         
        var ПрСторСделки = IIF( ((Data.T_DEALSIDE==UNSET_CHAR) OR (Data.TYPEADDINFO=="") OR (not ((Data.DLKIND==5)OR(Data.DLKIND==6)))), "", Delta_Fld(Data.T_DEALSIDE) );
        if (ПрСторСделки != "")
         var DealSide  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПрСторСделки", ПрСторСделки);
         attrkInf.add(DealSide);
        end;
        var mInfo = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "МетодЗакСделки ", Delta_Fld(Data.T_METHODADDINFO));
        attrkInf.add(mInfo);
        m_XmlReport.addLine("ДопИнф", attrkInf, "");
        
      m_XmlReport.finishPart();
   end;
   
   macro AddLineMM(StrCounter, Data)
      var leaderDC = jvm.createJavaObject("java.util.ArrayList", "<init>");
      
      var attrRowNum = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Номер", string(StrCounter));
      leaderDC.add(attrRowNum);
      var attrDateSDC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаПривл", Delta_Fld(SQL_ConvTypeDate(Data.DealDate)));
      leaderDC.add(attrDateSDC);
      var attrDateCDC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаВозвр", Delta_Fld(SQL_ConvTypeDate(Data.CalcDate)));
      leaderDC.add(attrDateCDC);
      
      m_XmlReport.beginPart("СделкаДР",leaderDC);
      
        var attrOVR = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var codValOVR  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЦКодВал1", Delta_Fld(IIF( Data.ReqFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(Data.ReqFIID)) )));
        attrOVR.add(codValOVR);
        var sumOVR     = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Сумма1",   Delta_Fld(IIF( Data.ReqFIID==-1, "", Data.ReqSum )));
        attrOVR.add(sumOVR);
        var codrODR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЦКодВал2", Delta_Fld(IIF( Data.ComFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(Data.ComFIID)) )));
        attrOVR.add(codrODR);
        var sumrOVR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Сумма2 ",  Delta_Fld(IIF( Data.ComFIID==-1, "", Data.ComSum )));
        attrOVR.add(sumrOVR);
        m_XmlReport.addLine("УсловияОДР", attrOVR, "");
        
        
        var attrkRN = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var pRN  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризнакРН", Delta_Fld(Data.ISRESIDENT));
        attrkRN.add(pRN);
        m_XmlReport.addLine("КонтрРН", attrkRN, "");
        
        ContrPr("КонтрагентОДР", Data.t_TypeContr, Data.T_BANKCONTRAGENT, Data.T_PREGNUM, Data.T_BIC, Data.OKCMCODE, IIF(Data.IsSWIFTCode==SET_CHAR, Data.T_BANKCONTRAGENT, ""), 
        IIF( Data.IsSWIFTCode!=SET_CHAR, IIF(Data.OKCMCODE!="",SubStr(Data.BANKCONTRAGENT,1,Index(Data.BANKCONTRAGENT,Data.OKCMCODE)-1),Data.BANKCONTRAGENT), ""), Data.ISRESIDENT, Data.DLKind);
        
        var attrOrg = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var AbbName  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "АббревНаим", Delta_Fld(Data.MARKETCONTRAGENT));
        attrOrg.add(AbbName);
        m_XmlReport.addLine("Посредник", attrOrg, "");
        //ДопСведОДР (РасшТипа?, РасшСтавки?, ТипОперДР, ПСтавкаОДР? ) 
        var attrSegment = jvm.createJavaObject("java.util.ArrayList", "<init>");
        if (Data.OTHER != "")
         var CodO    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РасшТипа", Delta_Fld(Data.OTHER));
         attrSegment.add(CodO);
        end;
        if (Data.DEALADDINFO != "")
         var Codi    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РасшСтавки", Delta_Fld(Data.DEALADDINFO));
         attrSegment.add(Codi);
        end;
        var TypeOP  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ТипОперДР", Delta_Fld(Data.TYPEADDINFO));
        attrSegment.add(TypeOP);
        var sODR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПСтавкаОДР", IIF( ((Data.RATEADDINFO==$0) OR (Data.DEALADDINFO!="")) , "0.0000", trim(string(Data.RATEADDINFO:14:4))));
        attrSegment.add(sODR);
        m_XmlReport.addLine("ДопСведОДР", attrSegment, "");
        //ДопИнф (ПрСторСделки, МетодЗакСделки ) 
        var attrkInf = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var DealSide  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПрСторСделки", Delta_Fld(IIF( ((Data.T_DEALSIDE==UNSET_CHAR) OR (Data.T_TYPEADDINFO=="")), "", Data.T_DEALSIDE )));
        attrkInf.add(DealSide);
        var mInfo = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "МетодЗакСделки ", Delta_Fld(Data.T_METHODADDINFO));
        attrkInf.add(mInfo);
        m_XmlReport.addLine("ДопИнф", attrkInf, "");
        
      m_XmlReport.finishPart();
      
   end;
   
   macro AddLinePRD(StrCounter, Data)
      var leaderDC = jvm.createJavaObject("java.util.ArrayList", "<init>");
      
      var attrRowNum = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Номер", string(StrCounter));
      leaderDC.add(attrRowNum);
      var attrDateSDC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НачалоСрока", Delta_Fld(SQL_ConvTypeDate(Data.DealDate)));
      leaderDC.add(attrDateSDC);
      var attrDateCDC = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОкончСрока", Delta_Fld(SQL_ConvTypeDate(Data.CalcDate)));
      leaderDC.add(attrDateCDC);
      
      m_XmlReport.beginPart("СделкаДР",leaderDC);  
        
        //УсловияОПД (ЦКодВал1?, Сумма1?, ЦКодВал2?, Сумма2? ) 
        var attrOVR = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var codValOVR  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЦКодВал1", Delta_Fld(SQL_ConvTypeInteger(Data.ReqFIID)));
        attrOVR.add(codValOVR);
        var sumOVR     = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Сумма1",   Delta_Fld( Data.ReqSum ));
        attrOVR.add(sumOVR);
        var codrODR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЦКодВал2", Delta_Fld( DL_GetISOCode(SQL_ConvTypeInteger(Data.ComFIID)) ));
        attrOVR.add(codrODR);
        var sumrOVR    = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Сумма2 ",  Delta_Fld( Data.ComSum ));
        attrOVR.add(sumrOVR);
        m_XmlReport.addLine("УсловияОДР", attrOVR, "");
        //КонтрРН (ПризнакРН ) 
        var attrkRN = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var pRN  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризнакРН", Delta_Fld(Data.ISRESIDENT));
        attrkRN.add(pRN);
        m_XmlReport.addLine("КонтрРН", attrkRN, "");
        
        //КонтрагентОПД? (ТипКонтр ) 
        ContrPr("КонтрагентОДР", Data.t_TypeContr, Data.T_BANKCONTRAGENT, Data.T_PREGNUM, Data.T_BIC, Data.OKCMCODE, IIF(Data.IsSWIFTCode==SET_CHAR, Data.T_BANKCONTRAGENT, ""), 
        IIF( Data.IsSWIFTCode!=SET_CHAR, IIF(Data.OKCMCODE!="",SubStr(Data.BANKCONTRAGENT,1,Index(Data.BANKCONTRAGENT,Data.OKCMCODE)-1),Data.BANKCONTRAGENT), ""), Data.ISRESIDENT, Data.DLKind);
        
        //Организатор (АббревНаим ) 
        var attrOrg = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var AbbName  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "АббревНаим", Delta_Fld(Data.MARKETCONTRAGENT));
        attrOrg.add(AbbName);
        m_XmlReport.addLine("Организатор", attrOrg, "");
        //ДопСведПД (СегментРынка?, РасшППСтавки?, РасшВидаПД, СтавкаОПД? ) 
        var attrSegment = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var CodO  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СегментРынка", Delta_Fld(Data.OTHER));
        attrSegment.add(CodO);
        var DecrypPP  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РасшППСтавки", Delta_Fld(IIF( Data.DEALADDINFO!="", SubStr(Data.DEALADDINFO,1,Index(Data.DEALADDINFO,"-")-1), "" )));
        attrSegment.add(DecrypPP);
        var Decryp  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "РасшВидаПД", Delta_Fld(Data.TYPEADDINFO));
        attrSegment.add(Decryp);
        var Codi  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СтавкаОПД", Delta_Fld( IIF( Data.RATEADDINFO==$0, "", string(Data.RATEADDINFO:14:4) )));
        attrSegment.add(Codi);
        m_XmlReport.addLine("ДопСведПД", attrSegment, "");
     
        //ДопИнф (ПрСторСделки?, МетодЗакСделки ) 
        var attrkInf = jvm.createJavaObject("java.util.ArrayList", "<init>");
        var DealSide  = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПрСторСделки", Delta_Fld(IIF( ((Data.T_DEALSIDE==UNSET_CHAR) OR (Data.T_TYPEADDINFO=="")), "", Data.T_DEALSIDE )));
        attrkInf.add(DealSide);
        var mInfo = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "МетодЗакСделки ", Delta_Fld(Data.T_METHODADDINFO));
        attrkInf.add(mInfo);
        m_XmlReport.addLine("ДопИнф", attrkInf, "");
      m_XmlReport.finishPart();
   end;

   macro EndLine()
   m_XmlReport.finishPart();
   end;

   macro FinishData701()
      //m_XmlReport.finishPart();
      m_XmlReport.finishPart();
   end;

   macro NoData()
      var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrCode = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодНепредставления", "1");

      attributes.add(attrCode);
      m_XmlReport.addLine("НетДанных", attributes, "");
   end;

   macro PrintPCInfo()
      var rec = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var atr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ИмяПК", "Дельта");

      rec.add(atr);
      m_XmlReport.addLine("ИнфПК", rec, ""); 
   end;

   macro PrintProtocol()
      m_Protocol = m_XmlReport.getProtocol();

      var Notes = m_Protocol.getNotesText();
      var Errors = m_Protocol.getErrorsText();
      var Fails = m_protocol.getFailsText();
      var atrtibutesNotes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusNotes = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "0");
      atrtibutesNotes.add(attrStatusNotes);
      var atrtibutesErrors = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusErrors = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "1");
      atrtibutesErrors.add(attrStatusErrors);
      var atrtibutesFails = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusFails = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "2");
      atrtibutesFails.add(attrStatusFails);

      if((Notes != "") or (Errors != "") or (Fails != ""))
         m_XmlReport.beginPart("ПротоколКонтроля");
         if(Notes != "")
            m_XmlReport.addLine("Сообщение", atrtibutesNotes, Notes);
         end;
         if(Errors != "")
            m_XmlReport.addLine("Сообщение", atrtibutesErrors, Errors);
         end;
         if(Fails != "")
            m_XmlReport.addLine("Сообщение", atrtibutesFails, Fails);
         end;
         m_XmlReport.finishPart();
      end;
   end;

   macro GetFileName()
      return m_FileName;
   end;

   macro CreateXMLFile()
      return m_XmlReport.export(m_FileName);
   end;

   var DepCode;
   var DepCodeQuery = "select dp_dep.t_Name " +
                      "from ddp_dep_dbt dp_dep " +
                      "where dp_dep.t_Code = " + string({OperDprt});

   var DepCodeSelect = DL_RSDCommand(DepCodeQuery);
   var DepCodeDS = DepCodeSelect.Execute();
   if(DepCodeDS.MoveNext())
      DepCode = DepCodeDS.Name;
   else
      DepCode = "";
   end;

   private var dd;
   private var mm;
   DateSplit(m_EndDate, dd, mm, NULL);

   var len = strlen(DepCode);
   if(len < 4)
      var i = len;
      while(i < 4)
         DepCode = "0" + DepCode;
         i = i + 1;
      end;
   elif(len > 4)
      DepCode = SubStr(DepCode, 1, 4);
   end;

   m_FileName = "..\\TxtFile\\" + m_OKUD + "_" + string(dd:o:2) + string(mm:o:2) + DepCode + ".xml";

   jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   m_XmlReport = jvm.createJavaObject("XMLReportExporter.XMLReport", "<init>", "2.0.4.5", "701", OKUD, ReportKind, String(EndDate : f), Periodicity);
   m_Protocol = m_XmlReport.getProtocol();
END;



PRIVATE CLASS (DL_CReportTemplate) Dl_Rep701_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )

   PRIVATE VAR m_Date = Date(0,0,0), 
               m_BySC_Own = false,
               m_BySC_Client = false,
               m_ByDV_DerivOwn = false,
               m_ByDV_DerivClient = false,
               m_ByDV_CurOwn = false,
               m_ByDV_CurClient = false,
               m_ByDV_Other = false,
               m_ByMBK = false,
               m_ALLBank = false,
               m_OnlyHead = false,
               m_OnlyFilial = false,
               m_FilialCode = -1,
               m_InExcel = false,
               m_InKliko = false,
               m_InDelta = false,
               m_IsExistsData = false,
               m_FIID_840 = -1,
               m_Intermediate = 0;
               
   PRIVATE VAR m_NumStr = 30;
   PRIVATE VAR m_RS;

   PRIVATE VAR m_HeadBankCode = 0;

   PRIVATE VAR m_KlikoForm = 0;

   PRIVATE MACRO PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   END;

   PRIVATE MACRO BeginReport( NumCopy:INTEGER )
      m_Date = Dl_Rep701_Form.GetFieldValue(PNFLD_701_DATE);
      m_BySC_Own = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_SC_OWN) == SET_CHAR, true, false );
      m_BySC_Client = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_SC_CLIENT) == SET_CHAR, true, false );
      m_ByDV_DerivOwn = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_DERIV_OWN) == SET_CHAR, true, false );
      m_ByDV_DerivClient = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_DERIV_CLIENT) == SET_CHAR, true, false );
      m_ByDV_CurOwn = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_CUR_OWN) == SET_CHAR, true, false );
      m_ByDV_CurClient = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_CUR_CLIENT) == SET_CHAR, true, false );
      m_ByDV_Other = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_DV_OTHER) == SET_CHAR, true, false );
      m_ByMBK = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_BY_MBK) == SET_CHAR, true, false );
      m_ALLBank = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_ALL_BANK) == SET_CHAR, true, false );
      m_OnlyHead = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_ONLY_HEAD) == SET_CHAR, true, false );
      m_OnlyFilial = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_ONLY_FILIAL) == SET_CHAR, true, false );
      m_FilialCode = Dl_Rep701_Form.GetFieldValue(PNFLD_701_FILIAL_CODE);
      m_InExcel = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_IN_EXCEL) == SET_CHAR, true, false );
      m_InKliko = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_IN_KLIKO) == SET_CHAR, true, false );
      m_InDelta = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_IN_DELTA) == SET_CHAR, true, false );
      m_Intermediate = iif( Dl_Rep701_Form.GetFieldValue(PNFLD_701_INTERMEDIATE) == SET_CHAR, 1, 0 );
      SetActiveSheet( "Отчет" );
   END;

/****************************************** Функции экспорта в kliko ********************************************************/
  PRIVATE MACRO Kliko_InsertInTxtFile( Str:STRING ):BOOL
    if( insert( Kliko_F701, Str ) == false )
       MsgBox( "Ошибка при вставке записи в файл Kliko" );
       return false;
    end;
    return true;
  END;

  PRIVATE MACRO Kliko_TxtFileName( RepDate:DATE ):STRING
    var Day, Month, Year;
    datesplit( RepDate, Day, Month, Year );
    Year = SubStr( string(Year), strlen(string(Year))-1 );

    var ExtName = IIF( m_KlikoForm == KLIKO_FORM_F701_V, "_V4", IIF(m_KlikoForm == KLIKO_FORM_F701_D, "_D4", "_PD4") );

    return GetTxtFileName( string(Day:2:o)+string(Month:2:o)+string(Year:2:o)+"_F701"+ExtName );
  END;

  PRIVATE MACRO Kliko_TxtFileExt( filename:string )
    return SubStr( filename, 1, Index(filename,"4.")+1 ) + "txt";
  END;

  PRIVATE MACRO Kliko_OpenTxtFile( RepDate:DATE )
    VAR errcode, errtext;
    VAR fName = Kliko_TxtFileExt( Kliko_TxtFileName(RepDate) );
    if( not Open(Kliko_F701, fName, "rsoem") )
      errcode = status(errtext);
      RunError( "Ошибка при открытии файла для экспорта в kliko|"+fName+"|(" + errcode + ") " + errtext );
      return false;
    end;
    return true;
  END;

  PRIVATE MACRO Kliko_CloseTxtFile()
    var KlikoFileName, KlikoExtName;
    var  reg_path, errcode;
     GetRegistryValue("РСХБ\\ДИРЕКТОРИИ\\KLIKO_701_OUT", V_STRING, reg_path, errcode );
      if ( errcode != 0 )
        reg_path = "";
      end; 

    splitfile(FileName(Kliko_F701), KlikoFileName, KlikoExtName);
    close( Kliko_F701 );
    copyfile(FileName(Kliko_F701), reg_path + KlikoFileName + KlikoExtName);
    if( KLIKO_FILE_VIEW )
      ViewFile( Kliko_F701 );
    end;
  END;

  PRIVATE MACRO Kliko_Fld( Val:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL )
      VAR vt = ValType(Val);
      if( vt == V_DATE )
         if( Val == DATE(0,0,0) )
            ValStr = "";
         else
            ValStr = string(Val:f);
         end;
      elif( vt == V_STRING )
        if( Val != "0")
          ValStr = trim( string(Replace(Val, "\"", "~^")) );
        else
          ValStr = "";
        end;
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        if( Val != 0.00 )
          ValStr = trim( string(Val:14:3) ); // В случае, если хотим 14:4, заранее преобразуем в строку
        end;
      elif( vt == V_INTEGER )
        if( Val != 0 )
          ValStr = string(Val);
        else
          ValStr = "0";
        end;
      else
         ValStr = string(Val);
      end;
    end;
    return "\""+ValStr+"\"";
  END;

  PRIVATE MACRO PrintLineKliko( N1,N2,N3,N4,N5,N6,N7,N8,N9,N10,N11,N12,N13,N14,N15,N16,N17,N18,N19,N20,N21,N22,N23,N24,N25,N26,X,Y )

    var s:string = Kliko_Fld( N1  ) +","+
                   Kliko_Fld( N2  ) +","+
                   Kliko_Fld( N3  ) +","+
                   Kliko_Fld( N4  ) +","+ 
                   Kliko_Fld( N5  ) +","+
                   Kliko_Fld( N6  ) +","+
                   Kliko_Fld( N7  ) +","+
                   Kliko_Fld( N8  ) +","+ 
                   Kliko_Fld( N9  ) +","+
                   Kliko_Fld( N10 ) +","+
                   Kliko_Fld( N11 ) +","+
                   Kliko_Fld( N12 ) +","+ 
                   Kliko_Fld( N13 ) +","+
                   Kliko_Fld( N14 ) +","+
                   Kliko_Fld( N15 ) +","+
                   Kliko_Fld( N16 ) +","+
                   Kliko_Fld( N17 ) +","+ 
                   Kliko_Fld( N18 ) +","+
                   Kliko_Fld( N19 ) +","+
                   Kliko_Fld( N20 ) +","+
                   Kliko_Fld( N21 ) +","+
                   Kliko_Fld( N22 ) +","+
                   Kliko_Fld( N23 );
    if( (m_KlikoForm == KLIKO_FORM_F701_D) or (m_KlikoForm == KLIKO_FORM_F701_PD) )
       s = s +","+ Kliko_Fld( N24 ); 
    end;
    if( m_KlikoForm == KLIKO_FORM_F701_PD )
       s = s +","+ Kliko_Fld( N25 ) +","+
                   Kliko_Fld( N26 );  
    end;
       s = s +","+ Kliko_Fld(  X  ) +","+
                   Kliko_Fld(  Y  ) +","+
                   Kliko_Fld( "0" ); 
    return Kliko_InsertInTxtFile(s);   
  END;

/****************************************************************************************************************************/

    MACRO GetOkud():String
       return "0409701";
    END;
    
    MACRO GetReportKind():String
       return "КО";
    END;
    
    MACRO GetPeriodicity():Integer
       return RCB_XML_PK_DAYLY;
    END;

   private macro Bank_PartyID( _BankCode )                                               
     var ret = _BankCode;                                                                
     var cmd, rs;                                                                        
     cmd = RsdCommand( "select D.T_PARTYID as idp from ddp_dep_dbt d where d.t_code=?" );
     cmd.addParam( "brn", RSDBP_IN );                                                    
     cmd.value( "brn" ) = _BankCode;                                                     
     cmd.execute;                                                                        
     rs = RsdRecordset( cmd );                                                           
     if ( rs.moveNext )                                                                  
       ret = Int( rs.value( "idp" ) );                                                   
     end;                                                                                
     return ret;                                                                         
   end;                                                                                  

   PRIVATE MACRO PrintReportHead()
     record RecAddress("adress.dbt");
     var recBank = TRecHandler("party.dbt");
     if( not m_IsExistsData )
        var BankID = Bank_PartyID(iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, {HeadBankID}));
        if( ПолучитьСубъекта(BankID, recBank) != 0 )
           msgbox("Не найдена анкета субъекта с ID = "+string(BankID));
           return;
        end;
        PrintFormatString( "",
                           "N1_ОКАТО",   DL_GetOkatoCode(recBank, m_Date),
                           "N1_ОКПО",    recBank.rec.OKPO,
                           "N1_РегНом",  ПолучитьКодСубъекта(BankID, PTCK_BANKREGNUM),
                           "N1_H1",      DL_DateToStr(m_Date,true),
                           "N1_H2",      recBank.rec.ShortName,
                           "N1_H3",      DL_GetRealAddress(BankID)
                         );
        RegisterTable( "N1_MainTable", "#",
                       "N1_A1", 
                       "N1_A2", 
                       "N1_A3", 
                       "N1_A4", 
                       "N1_A5", 
                       "N1_A6", 
                       "N1_A7", 
                       "N1_A8", 
                       "N1_A9", 
                       "N1_A10",
                       "N1_A11",
                       "N1_A12",
                       "N1_A13",
                       "N1_A14",
                       "N1_A15",
                       "N1_A16"
                     );
     end;
   END;

   PRIVATE MACRO PrintTableLine_()
      PrintTableLine( "N1_A1", OUTASTEXT+string(m_NumStr-29), null,
                      "N1_A2", SQL_ConvTypeDate(m_RS.DealDate), null, 
                      "N1_A3", SQL_ConvTypeDate(m_RS.CalcDate), null, 
                      "N1_A4", iif(m_RS.ReqFIID==-1,OUTASVOID,DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ReqFIID))), null, 
                      "N1_A5", iif(m_RS.ReqFIID==-1,OUTASVOID,ВыводЧерезФормулу(m_RS.ReqSum,3)), null,
                      "N1_A6", iif(m_RS.ComFIID==-1,OUTASVOID,DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ComFIID))), null,
                      "N1_A7", iif(m_RS.ComFIID==-1,OUTASVOID,ВыводЧерезФормулу(m_RS.ComSum,3)), null,
                      "N1_A8", m_RS.ISRESIDENT, null,
                      "N1_A9", iif(m_RS.T_BANKCONTRAGENT=="",OUTASVOID,m_RS.T_BANKCONTRAGENT), null,  
                      "N1_A10",iif(m_RS.T_MARKETCONTRAGENT=="",OUTASVOID,m_RS.T_MARKETCONTRAGENT), null, 
                      "N1_A11",iif(m_RS.T_OTHER=="",OUTASVOID,m_RS.T_OTHER), null, 
                      "N1_A12",iif(m_RS.T_DEALADDINFO=="",OUTASVOID,m_RS.T_DEALADDINFO), null, 
                      "N1_A13",iif(m_RS.T_TYPEADDINFO=="",OUTASVOID,m_RS.T_TYPEADDINFO), null,
                      "N1_A14",iif(((m_RS.T_RATEADDINFO==$0) AND (m_RS.T_TYPEADDINFO != "REPO")),OUTASVOID,m_RS.T_RATEADDINFO), iif((m_RS.dlkind==5)or(m_RS.dlkind==6),3,4), //Chesnokov D.S. Для REPO всегда ставка, даже если ноль
                      //"N1_A14",iif(m_RS.T_RATEADDINFO==$0,OUTASVOID,m_RS.T_RATEADDINFO), iif((m_RS.dlkind==5)or(m_RS.dlkind==6),3,4) 
                      "N1_A15",iif(((m_RS.T_DEALSIDE==UNSET_CHAR) OR (m_RS.T_TYPEADDINFO=="")),OUTASVOID,m_RS.T_DEALSIDE), null, 
                      "N1_A16",iif(m_RS.T_METHODADDINFO=="",OUTASVOID,m_RS.T_METHODADDINFO), null
                    );
      m_NumStr = m_NumStr + 1;
   END;

   MACRO GetHeadBank()
     var cmd, rs;                                                                        
     cmd = RsdCommand( "select t_Code from ddp_dep_dbt where t_PartyID = " + {HeadBankID} + " order by t_code" );
     cmd.execute();
     rs = TRsbDataSet(cmd);                                                                        
     if ( rs.moveNext() )                                                                  
       m_HeadBankCode = Int(rs.Code);                                                   
     end;                                                                                                                                                         
   END;

   MACRO CreateData_SC( CodeType:INTEGER )
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"Бэк-офис ценных бумаг\"", "Подготовка данных по сделкам модуля \"Бэк-офис ценных бумаг\"");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701.CreateData_SC(?,?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, iif(m_OnlyHead,m_HeadBankCode,-1)) );
      exec.AddParam( "", RSDBP_IN, m_Date);
      exec.AddParam( "", RSDBP_IN, m_FIID_840);
      exec.AddParam( "", RSDBP_IN, CodeType);
      exec.AddParam( "", RSDBP_IN, m_Intermediate);
      exec.execute();

      RemProgress();
   END;

   MACRO CreateData_DV( MarketKind:INTEGER, CodeType:INTEGER)
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"ФИССиКО\"", "Подготовка данных по сделкам модуля \"ФИССиКО\"");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701.CreateData_DV(?,?,?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, iif(m_OnlyHead,m_HeadBankCode,-1)) );
      exec.AddParam( "", RSDBP_IN, m_Date);
      exec.AddParam( "", RSDBP_IN, m_FIID_840);
      exec.AddParam( "", RSDBP_IN, MarketKind);
      exec.AddParam( "", RSDBP_IN, CodeType);
      exec.AddParam( "", RSDBP_IN, m_Intermediate);
      exec.execute();

      RemProgress();
   END;

   MACRO CreateData_MBK()
      var sql, exec;
      InitProgress(-1, "Подготовка данных по сделкам модуля \"Межбанк. кредиты\"", "Подготовка данных по сделкам модуля \"Межбанк. кредиты\"");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701.CreateData_MBK(?,?,?,?);"
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.AddParam( "", RSDBP_IN, iif(m_OnlyFilial and (m_FilialCode > 0), m_FilialCode, iif(m_OnlyHead,m_HeadBankCode,-1)) );
      exec.AddParam( "", RSDBP_IN, m_Date);
      exec.AddParam( "", RSDBP_IN, m_FIID_840);
      exec.AddParam( "", RSDBP_IN, m_Intermediate);
      exec.execute();

      RemProgress();
   END;

   MACRO CorrectData()
      var sql, exec;
      InitProgress(-1, "Корректировка отобранных данных", "Корректировка отобранных данных");
       sql =  "DECLARE "
           + "BEGIN "
           + "    rsb_dlrep701.CorrectData; "
           + "END; ";
       
      exec = RSDCommand(sql);
      exec.execute();

      RemProgress();
   END;

   MACRO PrintData()
      var query, cnt = 0;
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand();
      query = "select tmp.* from ddlrep701_tmp tmp "
             +"  order by case when tmp.T_DLKind = 1 then 0 "
             +"                when tmp.T_DLKind = 2 then 1 "
             +"                when tmp.T_DLKind = 9 then 3 "
             +"                else 2 end, "
             +"           tmp.T_IsMarket desc, tmp.T_DLKind, "
             +"           case when tmp.T_DLKind in(1,9) then tmp.T_DEALDATE else to_date('01.01.0001','DD.MM.YYYY') end, "
             +"           tmp.T_DEALID, TMP.T_OTHER, tmp.T_DEALPART, " /*PNV*/
             +"           case when tmp.T_DLKind not in(1,9) then tmp.T_DEALDATE else to_date('01.01.0001','DD.MM.YYYY') end, "
             +"           case when tmp.T_DLKind = 8 then tmp.T_OTHER else chr(1) end";
      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "Вывод данных в отчет", "Вывод данных в отчет");
         PrintReportHead();
         m_IsExistsData = true;
         m_RS = cmd.execute(query);
     
         while( m_RS.MoveNext() )
            PrintTableLine_();
            ProgressIndicator.Use;
         end;
     
         ProgressIndicator.Remove;
      end;
   END;

   MACRO PrintKlikoDeltaData_Conversion( StrCounter:@integer, IsVnesh /*USR*/)
      var query, cnt = 0;
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand(), filcode =  ""/*USR*/;
      query = "select tmp.* from ddlrep701_tmp tmp "
             +" where tmp.T_DLKind not in(1,8,9) "
             +"  order by case when tmp.T_DLKind = 2 then 1 else 2 end, "
             +"           tmp.T_IsMarket desc, tmp.T_DLKind, tmp.T_DEALID, tmp.T_DEALPART, tmp.T_DEALDATE ";
                                                                                 
      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях на валютных рынках", "Вывод в Kliko данных об операциях на валютных рынках");
         m_RS = cmd.execute(query);
         if(m_InDelta)
           m_DeltaReport.BeginLine("ВалютныйРынок");
         end;
         while( m_RS.MoveNext() )
            StrCounter = StrCounter + 1;

/* Для международных финансовых организаций, имеющих в коде SWIFT первые четыре символа INEA, IIBM или IBEC в качестве цифрового кода страны места нахождения в графе 9_4 <Контрагент - код страны нерезидента> указывается значение <998>*/
            If( (m_RS.ISRESIDENT=="N") ) 
               If( (index(m_RS.BANKCONTRAGENT, "INEA")!=0) OR (index(m_RS.BANKCONTRAGENT, "IIBM")!=0) OR (index(m_RS.BANKCONTRAGENT, "IBEC")!=0) )
                  filcode = "998";
               else
                  filcode = m_RS.OKCMCODE;
               end;
            else
               filcode =  "";
            end;

            if(m_InKliko)
              PrintLineKliko( StrCounter, 
                            SQL_ConvTypeDate(m_RS.DealDate), 
                            SQL_ConvTypeDate(m_RS.CalcDate), 
                            IIF( m_RS.ReqFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ReqFIID)) ), 
                            IIF( m_RS.ReqFIID==-1, "", m_RS.ReqSum ), 
                            IIF( m_RS.ComFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ComFIID)) ), 
                            IIF( m_RS.ComFIID==-1, "", m_RS.ComSum ), 
                            m_RS.ISRESIDENT, 
                            IIF( m_RS.ISRESIDENT=="R", m_RS.BANKCONTRAGENT, "" ),
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode==SET_CHAR)), SubStr(m_RS.BANKCONTRAGENT,1,8), "" ),
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode==SET_CHAR)), SubStr(m_RS.BANKCONTRAGENT,9,3), "" ),
                            IIF( m_RS.ISRESIDENT=="N", filcode/*m_RS.OKCMCODE*/, "" ),/*USR*/
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode!=SET_CHAR)), IIF(m_RS.OKCMCODE!="",SubStr(m_RS.BANKCONTRAGENT,1,Index(m_RS.BANKCONTRAGENT,m_RS.OKCMCODE)-1),m_RS.BANKCONTRAGENT), "" ), /*если код ОКСМ заполнен, то отрезаем его от наименования с кодом*/
                            IIF(m_RS.MARKETCONTRAGENT == "MMVB", "1" ,"2"), /*USR*/
                            m_RS.MARKETCONTRAGENT,
                            m_RS.OTHER,
                            m_RS.DEALADDINFO,
                            IIF( ((m_RS.DLKIND==5)or(m_RS.DLKIND==6)), SubStr(m_RS.TYPEADDINFO,1,1), "" ),
                            IIF( ((m_RS.DLKIND==5)or(m_RS.DLKIND==6)), SubStr(m_RS.TYPEADDINFO,2,StrLen(m_RS.TYPEADDINFO)-1), "" ), 
                            IIF( ((m_RS.DLKIND!=5)and(m_RS.DLKIND!=6)), m_RS.TYPEADDINFO, "" ),
                            IIF( m_RS.RATEADDINFO==$0, "", m_RS.T_RATEADDINFO),  
                            IIF( ((m_RS.T_DEALSIDE==UNSET_CHAR) OR (IIF( ((m_RS.DLKIND!=5)and(m_RS.DLKIND!=6)), m_RS.TYPEADDINFO, "" )=="")), "", m_RS.T_DEALSIDE ), 
                            m_RS.T_METHODADDINFO,
                            null,null,null,1,1
                          );
            end; //GAA
            if(m_InDelta)
              m_DeltaReport.AddLineDC(StrCounter,m_RS);
            end;
            ProgressIndicator.Use;
         end;
         if(m_InDelta)
           m_DeltaReport.EndLine();
         end;
         ProgressIndicator.Remove;

	 /*KD добавление данных от внешних источников */ 
         If(IsVnesh)
            query = "select tmp.* from User701_SSP_dbt tmp where SSP13 is null and RepDate = " + getSqlDate(m_date);
                                                                                       
            cnt = cmd.GetCount(query);
            if( cnt > 0 )
               ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях на валютных рынках из внешних источников", "Вывод в Kliko данных об операциях на валютных рынках из внешних источников");
               m_RS = cmd.execute(query);

               while( m_RS.MoveNext() )
                  StrCounter = StrCounter + 1;
                  PrintLineKliko( StrCounter, 
                                  SQL_ConvTypeDate(m_RS.SSP2), 
                                  SQL_ConvTypeDate(m_RS.SSP3), 
                                  m_RS.SSP4, 
                                  m_RS.SSP5, 
                                  m_RS.SSP6, 
                                  m_RS.SSP7, 
                                  m_RS.SSP8, 
                                  ""/*m_RS.SSP9*/,
                                  ""/*m_RS.SSP10*/,
                                  ""/*m_RS.SSP11*/,
                                  ""/*m_RS.SSP12*/,
                                  ""/*m_RS.SSP13*/,
                                  "2"/*m_RS.SSP14*/,
                                  m_RS.SSP10,
                                  m_RS.SSP11,
                                  m_RS.SSP12,
                                  ""/*m_RS.SSP18*/,
                                  ""/*m_RS.SSP19*/, 
                                  ""/*m_RS.SSP20*/,
                                  m_RS.SSP14,  
                                  m_RS.SSP15,  
                                  m_RS.SSP16,
                                  null,null,null,1,1
                                );
                  ProgressIndicator.Use;
               end;
               ProgressIndicator.Remove;
            end;
         end;
      else
	 /*KD добавление данных от внешних источников */ 
         If(IsVnesh)
            query = "select tmp.* from User701_SSP_dbt tmp where SSP13 is null and RepDate = " + getSqlDate(m_date);
                                                                                       
            cnt = cmd.GetCount(query);
            if( cnt > 0 )
               ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях на валютных рынках из внешних источников", "Вывод в Kliko данных об операциях на валютных рынках из внешних источников");
               m_RS = cmd.execute(query);

               while( m_RS.MoveNext() )
                  StrCounter = StrCounter + 1;
                  PrintLineKliko( StrCounter, 
                                  SQL_ConvTypeDate(m_RS.SSP2), 
                                  SQL_ConvTypeDate(m_RS.SSP3), 
                                  m_RS.SSP4, 
                                  m_RS.SSP5, 
                                  m_RS.SSP6, 
                                  m_RS.SSP7, 
                                  m_RS.SSP8, 
                                  ""/*m_RS.SSP9*/,
                                  ""/*m_RS.SSP10*/,
                                  ""/*m_RS.SSP11*/,
                                  ""/*m_RS.SSP12*/,
                                  ""/*m_RS.SSP13*/,
                                  "2"/*m_RS.SSP14*/,
                                  m_RS.SSP10,
                                  m_RS.SSP11,
                                  m_RS.SSP12,
                                  ""/*m_RS.SSP18*/,
                                  ""/*m_RS.SSP19*/, 
                                  ""/*m_RS.SSP20*/,
                                  m_RS.SSP14,  
                                  m_RS.SSP15,  
                                  m_RS.SSP16,
                                  null,null,null,1,1
                                );
                  ProgressIndicator.Use;
               end;
               ProgressIndicator.Remove;
            else
               PrintLineKliko( "","","","","","","","","","", "","","","","","","","","","", "","","",null,null,null,1,1 );  
            end;
         else
         PrintLineKliko( "","","","","","","","","","", "","","","","","","","","","", "","","",null,null,null,1,1 );  
         end;

      end;
   END;

   MACRO PrintKlikDeltaoData_MoneyMarket( StrCounter:@integer, isvnesh /*USR*/ )
      var query, cnt = 0;
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand();
      var BankContragent = "", filcode = "", atr9_1= "", atr9_2= "", atr9_3= ""; /*USR*/
      query = "select tmp.* from ddlrep701_tmp tmp "
             +" where tmp.T_DLKind in(1,9) "
             +"  order by tmp.T_DLKind, tmp.T_IsMarket desc, tmp.T_DLKind, tmp.T_DEALDATE, tmp.T_DEALID, tmp.T_DEALPART ";
                                                                                 
      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях на денежных рынках", "Вывод в Kliko данных об операциях на денежных рынках");
         m_RS = cmd.execute(query);
         if(m_InDelta)
           m_DeltaReport.BeginLine("ДенежныйРынок");
         end;
         while( m_RS.MoveNext() )
            StrCounter = StrCounter + 1;
            BankContragent = m_RS.BANKCONTRAGENT;

             /*   KD убрано по новым требованиям
            If(BankContragent == "3466-ЦК")
               BankContragent = "3466";
            end;
            */

             /* Для международных финансовых организаций, имеющих в коде SWIFT первые четыре символа INEA, IIBM или IBEC в качестве цифрового кода страны места нахождения в графе 9_4 <Контрагент - код страны нерезидента> указывается значение <998>*/
            If( (m_RS.ISRESIDENT=="N") ) 
               If( (index(m_RS.BANKCONTRAGENT, "INEA")!=0) OR (index(m_RS.BANKCONTRAGENT, "IIBM")!=0) OR (index(m_RS.BANKCONTRAGENT, "IBEC")!=0) )
                  filcode = "998";
               else
                  filcode = m_RS.OKCMCODE;
               end;
            else
               filcode =  "";
            end;
            if(m_InKliko)
              PrintLineKliko( StrCounter,                                                                                                     
                            SQL_ConvTypeDate(m_RS.DealDate),                                                                                
                            SQL_ConvTypeDate(m_RS.CalcDate),                                                                                
                            IIF( m_RS.ReqFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ReqFIID)) ),                                  
                            IIF( m_RS.ReqFIID==-1, "", m_RS.ReqSum ),                                                                       
                            IIF( m_RS.ComFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ComFIID)) ),                                  
                            IIF( m_RS.ComFIID==-1, "", m_RS.ComSum ),                                                                       
                            m_RS.ISRESIDENT,                                                                                                
                            IIF( m_RS.ISRESIDENT=="R", BankContragent/*m_RS.BANKCONTRAGENT*/, "" ),   /*USR*/                                                       
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode==SET_CHAR)), SubStr(m_RS.BANKCONTRAGENT,1,8), "" ),
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode==SET_CHAR)), SubStr(m_RS.BANKCONTRAGENT,9,3), "" ),
                            IIF( m_RS.ISRESIDENT=="N", filcode/*m_RS.OKCMCODE*/, "" ), /*USR*/
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode!=SET_CHAR)), IIF(m_RS.OKCMCODE!="",SubStr(m_RS.BANKCONTRAGENT,1,Index(m_RS.BANKCONTRAGENT,m_RS.OKCMCODE)-1),m_RS.BANKCONTRAGENT), "" ),
                            IIF(m_RS.MARKETCONTRAGENT == "MMVB", "1" ,"2"), /*USR*/
                            m_RS.MARKETCONTRAGENT,                                                                                        
                            m_RS.OTHER,                                                                                                   
                            IIF( ((m_RS.DLKind==9)and(m_RS.DEALADDINFO!="")), SubStr(m_RS.DEALADDINFO,1,Index(m_RS.DEALADDINFO,"-")-1), "" ),                                                                       
                            IIF( ((m_RS.DLKind==9)and(m_RS.DEALADDINFO!="")), m_RS.RATENAME, "" ),                                                                       
                            "",   //в текущей реализации "*" не может быть знаком спреда
                            IIF( ((m_RS.DLKind==9)and(m_RS.DEALADDINFO!="")), string(m_RS.RATESPREAD:14:4), "" ),                                                                       
                            m_RS.TYPEADDINFO,
                            IIF( m_RS.RATEADDINFO==$0, "", string(m_RS.RATEADDINFO:14:4) ),                                                                                               
                            IIF( ((m_RS.T_DEALSIDE==UNSET_CHAR) OR (m_RS.T_TYPEADDINFO=="")), "", m_RS.T_DEALSIDE ), 
                            m_RS.T_METHODADDINFO,
                            null,null,1,1
                          );                                                                                           
            end; 
            if(m_InDelta)
              m_DeltaReport.AddLineMM(StrCounter,m_RS);
            end;                          
            ProgressIndicator.Use;
         end;
         if(m_InDelta)
           m_DeltaReport.EndLine();
         end;
         ProgressIndicator.Remove;

	 /*KD добавление данных от внешних источников */ 
         If(IsVnesh)
            query = "select tmp.* from User701_SSP_dbt tmp where ssp13 = 'DEPO' and RepDate = " + getSqlDate(m_date);
                                                                                       
            cnt = cmd.GetCount(query);
            if( cnt > 0 )
               ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях на денежных рынках из внешних источников", "Вывод в Kliko данных об операциях на денежных рынках из внешних источников");
               m_RS = cmd.execute(query);

               while( m_RS.MoveNext() )
                  StrCounter = StrCounter + 1;
                  If(m_RS.SSP8 == "R")
                      atr9_1 = m_RS.SSP9;
                      atr9_2 = "";
                      atr9_3 = "";
                  elif(m_RS.SSP8 == "N")
                      atr9_1 = "";
                      atr9_2 = SubStr(m_RS.SSP9,1,8);
                      atr9_3 = SubStr(m_RS.SSP9,9,3);
                  end;
                  PrintLineKliko( StrCounter, 
                                  SQL_ConvTypeDate(m_RS.SSP2), 
                                  SQL_ConvTypeDate(m_RS.SSP3), 
                                  m_RS.SSP4, 
                                  m_RS.SSP5, 
                                  m_RS.SSP6, 
                                  m_RS.SSP7, 
                                  m_RS.SSP8, 
                                  atr9_1/*m_RS.SSP9*/,
                                  atr9_2/*m_RS.SSP10*/,
                                  atr9_3/*m_RS.SSP11*/,
                                  ""/*m_RS.SSP12*/,
                                  ""/*m_RS.SSP13*/,
                                  2/*m_RS.SSP14*/,
                                  m_RS.SSP10,
                                  m_RS.SSP11,
                                  ""/*m_RS.SSP17*/,
                                  ""/*m_RS.SSP18*/,
                                  ""/*m_RS.SSP19*/, 
                                  ""/*m_RS.SSP20*/,
                                  m_RS.SSP13,  
                                  m_RS.SSP14,
                                  m_RS.SSP15,  
                                  m_RS.SSP16,
                                  null,null,1,1
                                );
                  ProgressIndicator.Use;
               end;
               ProgressIndicator.Remove;
            end;
         end;
      else

         /*KD добавление данных от внешних источников */ 
         If(IsVnesh)
            query = "select tmp.* from User701_SSP_dbt tmp where ssp13 = 'DEPO' and RepDate = " + getSqlDate(m_date);
                                                                                       
            cnt = cmd.GetCount(query);
            if( cnt > 0 )
               ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях на денежных рынках из внешних источников", "Вывод в Kliko данных об операциях на денежных рынках из внешних источников");
               m_RS = cmd.execute(query);

               while( m_RS.MoveNext() )
                  StrCounter = StrCounter + 1;
                  If(m_RS.SSP8 == "R")
                      atr9_1 = m_RS.SSP9;
                      atr9_2 = "";
                      atr9_3 = "";
                  elif(m_RS.SSP8 == "N")
                      atr9_1 = "";
                      atr9_2 = SubStr(m_RS.SSP9,1,8);
                      atr9_3 = SubStr(m_RS.SSP9,9,3);
                  end;

                  PrintLineKliko( StrCounter, 
                                  SQL_ConvTypeDate(m_RS.SSP2), 
                                  SQL_ConvTypeDate(m_RS.SSP3), 
                                  m_RS.SSP4, 
                                  m_RS.SSP5, 
                                  m_RS.SSP6, 
                                  m_RS.SSP7, 
                                  m_RS.SSP8, 
                                  atr9_1/*m_RS.SSP9*/,
                                  atr9_2/*m_RS.SSP10*/,
                                  atr9_3/*m_RS.SSP11*/,
                                  ""/*m_RS.SSP12*/,
                                  ""/*m_RS.SSP13*/,
                                  2/*m_RS.SSP14*/,
                                  m_RS.SSP10,
                                  m_RS.SSP11,
                                  ""/*m_RS.SSP17*/,
                                  ""/*m_RS.SSP18*/,
                                  ""/*m_RS.SSP19*/, 
                                  ""/*m_RS.SSP20*/,
                                  m_RS.SSP13,  
                                  m_RS.SSP14,
                                  m_RS.SSP15,
                                  m_RS.SSP16,
                                  null,null,1,1
                                );
                  ProgressIndicator.Use;
               end;
               ProgressIndicator.Remove;
            else
               PrintLineKliko( "","","","","","","","","","", "","","","","","","","","","", "","","","",null,null,1,1 );  
            end;
/*USR*/
         else
           PrintLineKliko( "","","","","","","","","","", "","","","","","","","","","", "","","","",null,null,1,1 );  
         end;

      end; /*USR*/
   END;

   PRIVATE MACRO GetXValue( StrTag:string, PrSwType:string )
      if( StrTag == "S1" )
         return "1";
      elif( PrSwType == "CS float/float" )
         return "2";
      elif( (PrSwType == "CS fix/float") or (PrSwType == "CS float/fix") )
         return "3";
      elif( PrSwType == "CS fix/fix" )
         return "4";
      elif( PrSwType == "IRS float/float" )
         return "6";
      /*остальные типы в системе не реализованы*/
      elif( PrSwType == "Collar" )     
         return "5";
      elif( PrSwType == "C_CS fix/fix" )
         return "7";
      elif( (PrSwType == "C_CS fix/float") or (PrSwType == "C_CS float/fix") )
         return "8";
      elif( PrSwType == "C_CS float/float" )
         return "9";
      elif( PrSwType == "C_IRS float/float" )
         return "10";
      elif( PrSwType == "P_CS fix/fix" )
         return "11";
      elif( (PrSwType == "P_CS fix/float") or (PrSwType == "P_CS float/fix") )
         return "12";
      elif( PrSwType == "P_CS float/float" )
         return "13";
      elif( PrSwType == "P_IRS float/float" )
         return "14"; 
      end;
   END;

   MACRO PrintKlikoDeltaData_PercentageRateDeriv( StrCounter:@integer, isvnesh /*USR*/ )
      var query, cnt = 0;
      var ProgressIndicator = TProgressBar();
      var cmd = DL_RSDCommand();
      var StrTag:string, filcode =  "" /*USR*/;
      query = "select tmp.* from ddlrep701_tmp tmp "
             +" where tmp.T_DLKind = 8 "
             +"  order by tmp.T_IsMarket desc, tmp.T_DLKind, tmp.T_DEALID, tmp.T_DEALPART, tmp.T_DEALDATE, tmp.T_OTHER ";
                                                                                 
      cnt = cmd.GetCount(query);
      if( cnt > 0 )
         ProgressIndicator.init(cnt, "Вывод в Kliko данных об операциях с процентными деривативами", "Вывод в Kliko данных об операциях с процентными деривативами");
         m_RS = cmd.execute(query);
         if(m_InDelta)
           m_DeltaReport.BeginLine("Деривативы");
         end;
         while( m_RS.MoveNext() )
            StrTag = IIF( m_RS.ISSINGLEPCSW==SET_CHAR, "S1", IIF(((m_RS.DEALPART==1)or(m_RS.DEALPART==3)),"S2","S21") ); 
            StrCounter = StrCounter + 1;

/* Для международных финансовых организаций, имеющих в коде SWIFT первые четыре символа INEA, IIBM или IBEC в качестве цифрового кода страны места нахождения в графе 9_4 <Контрагент - код страны нерезидента> указывается значение <998>*/
            If( (m_RS.ISRESIDENT=="N") ) 
               If( (index(m_RS.BANKCONTRAGENT, "INEA")!=0) OR (index(m_RS.BANKCONTRAGENT, "IIBM")!=0) OR (index(m_RS.BANKCONTRAGENT, "IBEC")!=0) )
                  filcode = "998";
               else
                  filcode = m_RS.OKCMCODE;
               end;
            else
               filcode =  "";
            end;

            if(m_InKliko)
              PrintLineKliko( StrCounter,
                            StrTag,
                            SQL_ConvTypeDate(m_RS.DealDate),                                                                                
                            SQL_ConvTypeDate(m_RS.CalcDate),                                                                                
                            IIF( m_RS.ReqFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ReqFIID)) ),                                  
                            IIF( m_RS.ReqFIID==-1, "", m_RS.ReqSum ),                                                                       
                            IIF( m_RS.ComFIID==-1, "", DL_GetISOCode(SQL_ConvTypeInteger(m_RS.ComFIID)) ),                                  
                            IIF( m_RS.ComFIID==-1, "", m_RS.ComSum ),                                                                       
                            m_RS.ISRESIDENT,                                                                                                
                            IIF( m_RS.ISRESIDENT=="R", m_RS.BANKCONTRAGENT, "" ),                                                          
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode==SET_CHAR)), SubStr(m_RS.BANKCONTRAGENT,1,8), "" ),
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode==SET_CHAR)), SubStr(m_RS.BANKCONTRAGENT,9,3), "" ),
                            IIF( m_RS.ISRESIDENT=="N", filcode/*m_RS.OKCMCODE*/, "" ),/*USR*/
                            IIF( ((m_RS.ISRESIDENT=="N")and(m_RS.IsSWIFTCode!=SET_CHAR)), IIF(m_RS.OKCMCODE!="",SubStr(m_RS.BANKCONTRAGENT,1,Index(m_RS.BANKCONTRAGENT,m_RS.OKCMCODE)-1),m_RS.BANKCONTRAGENT), "" ),
                            IIF(m_RS.MARKETCONTRAGENT == "MMVB", "1" ,"2"),/*USR*/
                            m_RS.MARKETCONTRAGENT,                                                                                        
                            m_RS.OTHER,
                            IIF( m_RS.DEALADDINFO!="", SubStr(m_RS.DEALADDINFO,1,Index(m_RS.DEALADDINFO,"-")-1), "" ), 
                            IIF( m_RS.DEALADDINFO!="", m_RS.RATECCY, "" ),                                                                                                                                             
                            IIF( m_RS.DEALADDINFO!="", m_RS.RATENAME, "" ),                                                                       
                            "",   //в текущей реализации "*" не может быть знаком спреда
                            IIF( m_RS.DEALADDINFO!="", string(m_RS.RATESPREAD:14:4), "" ),                                                                       
                            m_RS.TYPEADDINFO,
                            IIF( m_RS.RATEADDINFO==$0, "", string(m_RS.RATEADDINFO:14:4) ),                                                                                               
                            IIF( ((m_RS.T_DEALSIDE==UNSET_CHAR) OR (m_RS.T_TYPEADDINFO=="")), "", m_RS.T_DEALSIDE ), 
                            m_RS.T_METHODADDINFO,
                            GetXValue( StrTag, trim(m_RS.TYPEADDINFO) ),   
                            IIF( StrTag=="S21", "2", "1" )
                          );                                                                                           
            end; 
            if(m_InDelta)
              m_DeltaReport.AddLinePRD(StrCounter,m_RS);
            end;                          
            ProgressIndicator.Use;
         end;
         if(m_InDelta)
           m_DeltaReport.EndLine();
         end;
         ProgressIndicator.Remove;


	 /*KD добавление данных от внешних источников */ 
         If(IsVnesh)
            query = "select tmp.* from User701_SSP_dbt tmp where ssp13 != 'DEPO' and ssp13 is not null and RepDate = " + getSqlDate(m_date);
                                                                                       
            cnt = cmd.GetCount(query);
            if( cnt > 0 )
               MsgBoxex("В файле от ССП есть строки, у которых гр.13 не равна пустому и/или не равна DEPO.|Данные по этим строкам не обработаны.|Отчет по этим строкам заполняется/корректируется в Клико вручную");
            end;
         end;
         
      else

        If(IsVnesh)
          query = "select tmp.* from User701_SSP_dbt tmp where ssp13 != 'DEPO' and ssp13 is not null and RepDate = " + getSqlDate(m_date);
                                                                                     
          cnt = cmd.GetCount(query);
          if( cnt > 0 )
             MsgBoxex("В файле от ССП есть строки, у которых гр.13 не равна пустому и/или не равна DEPO.|Данные по этим строкам не обработаны.|Отчет по этим строкам заполняется/корректируется в Клико вручную");
          end;
         end;

        PrintLineKliko( "","","","","","","","","","", "","","","","","","","","","", "","","","","","",1,1 );  
      end;
   END;

   MACRO PrintInKlikoDelta(isvnesh/*USR*/)
      var StrCounter = 0;

      if(m_InDelta)
         m_DeltaReport = F701DeltaXML(GetOKUD(), GetReportKind(), m_Date, GetPeriodicity());
         m_DeltaReport.PrintInfo();
         m_DeltaReport.BeginData701();
      end;
      
      /****************************************** Конверсионные операции (операции на валютных рынках) ********************************************************/
      if(m_InKliko)
        m_KlikoForm = KLIKO_FORM_F701_V;
        if( not Kliko_OpenTxtFile( m_Date ) )
           return;
        end;
        Kliko_InsertInTxtFile("<F701_V4>");
      end;
      PrintKlikoDeltaData_Conversion( @StrCounter, isvnesh /*USR*/);
      if(m_InKliko)
        Kliko_CloseTxtFile();
      end;
      /****************************************** Операции на денежных рынках ********************************************************/
      if(m_InKliko)
        m_KlikoForm = KLIKO_FORM_F701_D;
        if( not Kliko_OpenTxtFile( m_Date ) )
           return;
        end;
        Kliko_InsertInTxtFile("<F701_D4>");
      end;
      PrintKlikDeltaoData_MoneyMarket( @StrCounter, isvnesh /*USR*/);
      if(m_InKliko)
        Kliko_CloseTxtFile();
      end;
      /****************************************** Операции с процентными деривативами ********************************************************/
      if(m_InKliko)
        m_KlikoForm = KLIKO_FORM_F701_PD;
        if( not Kliko_OpenTxtFile( m_Date ) )
           return;
        end;
        Kliko_InsertInTxtFile("<F701_PD4>");
      end;
      PrintKlikoDeltaData_PercentageRateDeriv( @StrCounter, isvnesh /*USR*/);
      if(m_InKliko)
        Kliko_CloseTxtFile();
      end;
      
      if(m_InDelta)
        m_DeltaReport.FinishData701();
        if(not StrCounter)
           m_DeltaReport.NoData();
        end;
        m_DeltaReport.PrintPCInfo();
        m_DeltaReport.PrintProtocol();
        
        if(m_DeltaReport.CreateXMLFile())
          msgbox("Создан файл " + m_DeltaReport.GetFileName());
        else
          msgbox("Ошибка экспорта в Delta");
        end;

        var delta_file_name_term = "$" + SC_GetFullPath(true) + m_DeltaReport.GetFileName();
        if(ExistFile(delta_file_name_term))
          RemoveFile(delta_file_name_term);
        end;
        if (not copyFile(m_DeltaReport.GetFileName(),delta_file_name_term,true,"Копирование на терминал"))
          msgbox("Ошибка при копировании " + m_DeltaReport.GetFileName() + " на терминал");
        else
          RemoveFile(m_DeltaReport.GetFileName());
        end;
      end;
      
   END;

   MACRO Create()
      var fin = TRecHandler("fininstr.dbt");
      var IsVnesh = false;/*USR*/
      m_IsExistsData = false;
      SQL_Truncate( "DDLREP701_TMP" );
      if( ПолучитьФинИн("840", fin, null, null, null, FICK_ISONUMBER) == 0 )
         m_FIID_840 = fin.rec.FIID;
      else
         msgbox("Не найден финансовый инструмент по коду ISO: \"840\"");
         return;
      end;
      if (m_date == date (0,0,0))
         return;
      end;
      if( m_OnlyHead )
         GetHeadBank();
      end;
      if( m_BySC_Own )
         CreateData_SC( ALG_SP_MONEY_SOURCE_OWN );
      end;
      if( m_BySC_Client )
         CreateData_SC( ALG_SP_MONEY_SOURCE_CLIENT );
      end;
      if( m_ByDV_DerivOwn )
         CreateData_DV( DV_MARKETKIND_DERIV, ALG_SP_MONEY_SOURCE_OWN );
      end;
      if( m_ByDV_DerivClient )
         CreateData_DV( DV_MARKETKIND_DERIV, ALG_SP_MONEY_SOURCE_CLIENT );
      end;
      if( m_ByDV_CurOwn )
         CreateData_DV( DV_MARKETKIND_CURRENCY, ALG_SP_MONEY_SOURCE_OWN );
      end;
      if( m_ByDV_CurClient )
         CreateData_DV( DV_MARKETKIND_CURRENCY, ALG_SP_MONEY_SOURCE_CLIENT );
      end;
      if( m_ByDV_Other )
         CreateData_DV( -1, 0 );  
      end;
      if( m_ByMBK )
         CreateData_MBK();
      end;

      CorrectData();
      PrintData();

      if( m_InKliko OR m_InDelta)
/*USR*/
         Gettrue(IsVnesh, "Загружать данные внешних источников для выгрузки в Клико?");
         If(IsVnesh)
            OpLoad701(m_date);
         end;
/*USR*/
         Dl_CallInsertStat( DL_OUTREPORT_KLIKO );
         PrintInKlikoDelta(IsVnesh /*USR*/);
      end;
      
   END;

   MACRO EndReport()
      if( m_IsExistsData )
         EndTable();
         AddStandardFooter( "N1_" );
         ReplaceAndCalculate( OUTASTEXT, " " );/*добавляем пробел - тогда сможем вывести номера строк в строковые ячейки как текст с точкой-разделителем.*/
         ReplaceAndCalculate( OUTASVOID, "" );/*для того, чтобы в 14 ячейке в случае отсутствия заполнения инструмент автоматом не заполнял пробелами*/
         ReplaceFormulaAndCalculate();
      elif (m_date == date (0,0,0))
         msgbox("Неверно задана дата отчета 00.00.0000");
      else
         msgbox("Нет данных для формирования отчета.");
      end;
   END;

   initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );  

END;

MACRO RunReport()

  var stat = true;

     Dl_Rep701_Form = DL_REP701_Panel();
   
  while(stat)
     stat = Dl_Rep701_Form.Run();
   
     // Проверяем можем ли мы делать отчет по предоставленным данным
     if (not stat)
        break;
     end;
   
     if( stat )
        var Dl_Rep701 = Dl_Rep701_Report( null, "Report_701.xls", null, null, null, POI_MODE );      
        Dl_Rep701.Run();
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
     end;
  end;

END;

RunReport();
exit(1); 