/*
$Name:        linkReqDealSchduler.mac
$Module:      БОЦБ
$Description: Связка несвязанных заявок и сделок
*/
import globals, RSD,"gtconst.inc", Календарь;

private macro WriteLog(StrErr)
  if(IsShedulerRunning())
    WriteShedulerLog(StrErr);
  end;
end;

macro linkReqDealSchduler()
  var query =" DECLARE "
            +" BEGIN "
            +"    FOR i "
            +"       IN (SELECT tick.t_dealid, "
            +"                  obj.t_objectid, "
            +"                  dc.t_stringval ord, "
            +"                  tick.t_dealcode, "
            +"                  REQ.T_ID, "
            +"                  gr.t_spgroundid "
            +"             FROM ddl_tick_dbt tick, "
            +"                  dgtcode_dbt gc, "
            +"                  dgtrecord_dbt rec, "
            +"                  dgtobject_dbt obj, "
            +"                  dgtrecprm_dbt dc, "
            +"                  ddl_req_dbt req, "
            +"                  dspgrdoc_dbt gr "
            +"            WHERE     dc.t_recordid = rec.t_recordid "
            +"                  AND rec.t_objectid = obj.t_objectid "
            +"                  AND dc.t_koprmid IN (SELECT t_koprmid "
            +"                                         FROM dgtkoprm_dbt "
            +"                                        WHERE t_name = 'RGDLTC_ORDERNOM') "
            +"                  AND obj.t_objectkind IN ( " + RG_SECURDEAL + " ) "
            +"                  AND OBJ.T_OBJECTID = gc.t_objectid "
            +"                  AND GC.T_APPLICATIONID = " + GT_APP_RSBANKV6R20_TGT    
            +"                  AND gc.t_objectcode = TO_CHAR (tick.t_dealid) "
            +"                  AND gc.t_objectkind =" + RG_SECURDEAL
            +"                  AND NOT EXISTS "
            +"                             (SELECT 1 "
            +"                                FROM dspgrdoc_dbt g, dspgrdoc_dbt gr "
            +"                               WHERE     g.t_sourcedocid = tick.t_dealid "
            +"                                     AND G.T_SOURCEDOCKIND = " + DL_SECURITYDOC  
            +"                                     AND Gr.T_SOURCEDOCKIND = " + DL_REQDOC
            +"                                     AND gr.t_spgroundid = G.t_spgroundid) "
            +"                  AND tick.t_bofficekind = " + DL_SECURITYDOC
            +"                  AND Tick.T_CLIENTCONTRID > 0 "
            +"                  AND REQ.T_CODE = dc.t_stringval "
            +"                  AND req.t_id = gr.t_sourcedocid "
            +"                  AND gr.t_sourcedockind =  "+ DL_REQDOC
            +"                  AND tick.t_dealdate >= ?  "
            +"          ) "
            +"    LOOP "
            +"       INSERT INTO DSPGRDOC_DBT (T_SOURCEDOCKIND, "
            +"                                 T_SOURCEDOCID, "
            +"                                 T_SPGROUNDID, "
            +"                                 T_ORDER, "
            +"                                 T_DEBITCREDIT, "
            +"                                 T_STATUS, "
            +"                                 T_VERSION) "
            +"            VALUES ( " +  DL_SECURITYDOC  + ", "
            +"                    i.t_dealid, "
            +"                    i.t_spgroundid, "
            +"                    2, "
            +"                    0, "
            +"                    CHR (0), "
            +"                    0); "
            +"    END LOOP; "
            +" END; "
            ;
  var cmd = RSDCommand(query);
  cmd.addParam("", RSDBP_IN, date(GetDateAfterWorkDays({curdate},-5)));
  cmd.execute();

OnError(ErObj)
  msgbox(string(ErObj.Code));
end;

ReplaceMacro( "msgbox", "WriteLog" );
linkReqDealSchduler();
ReplaceMacro( "msgbox", NULL );

