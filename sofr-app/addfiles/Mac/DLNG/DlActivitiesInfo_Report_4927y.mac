/*
$Name:             DlActivitiesInfo_Report_4927y.mac
$Module:           Ценные бумаги
$Description:      Отчет "Сведения об осуществлении брокерской, депозитарной деятельности, деятельности по управлению ценными бумагами и инвестиционному консультированию"
*/

import "DLReport_h.mac", "DlActivitiesInfo_Form.mac", "ws_txreportform.mac", "cb_sql.mac", "dv_const.mac", "dvrepfun.mac", "dvserv.mac", "dv_ground.mac", "dlquery.mac";

PRIVATE FILE Kliko_F707() txt write;

PRIVATE VAR Form707;
PRIVATE VAR Report707;
PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CONST DEBUG_OUTPUT       = FALSE;
PRIVATE CONST DEBUG_NO_CALC      = FALSE;
PRIVATE CONST DEBUG_TMP_TABLE    = FALSE;

PRIVATE CONST RATETYPE_REASONED_PRICE = 1001;//Мотивированное суждение
PRIVATE CONST RATETYPE_BLOOMBERG_PRICE = 1002;//Bloomberg
PRIVATE CONST MOEX_CALENDAR_ID = 20;// id календаря Мосбиржи
//PRIVATE CONST BROKERCONTR_GROUP_RISKLEVEL = 103;

PRIVATE CONST POI_MODE = FALSE;

var tmp_table = "DAIDECR_TMP";
if (DEBUG_TMP_TABLE)
   tmp_table = "DAIDECR_DBT";
end;

var dbg_time = null;
var dbg_num = 0;

private macro dbg(msg)
  if (msg == null)
    dbg_num = dbg_num + 1;
    msg = string(dbg_num);
  end;
  if (DEBUG_OUTPUT)
    if (dbg_time != null)
      msg = string(time() - dbg_time) + " " + string(msg);
    end;
    println(msg);
    dbg_time = time();
  end;
end;

PRIVATE CONST PTSK_STOCKDL = 1,
              PTSK_DV = 15,
              PTSK_VEKSACC = 14,
              PTSK_DEPOS = 7,
              PTSK_CM = 21;

PRIVATE CONST PTK_CLIENT = 1;

PRIVATE CONST SC_SPDRAFT_STATUS_PREP   = 1;  /* отложенное поручение депо */
PRIVATE CONST OBJTYPE_TRN_CONT_BUYSELL = 1;  /* Содержание транзакции: Купля-продажа*/

PRIVATE CONST ЮРИДИЧЕСКОЕ_ЛИЦО = 1,
              ФИЗИЧЕСКОЕ_ЛИЦО = 2;

PRIVATE CONST CALCTYPE_COUNTRY = 1,
              CALCTYPE_NOCOUNTRY = 2,
              CALCTYPE_INTERNATIONAL = 3,
              CALCTYPE_SIMPLE = 4;

/* Golovkin 19.10.2020 Для категории 103 на дбо(207) другие значения */
PRIVATE CONST RISKLEVEL_NOTINSTALL = 0,
              RISKLEVEL_USUAL = 1,
              RISKLEVEL_ELEVATED = 2,
              RISKLEVEL_SPECIAL = 3;
/*

PRIVATE CONST RISKLEVEL_NOTINSTALL = 0,
              RISKLEVEL_USUAL = 2,
              RISKLEVEL_ELEVATED = 1,
              RISKLEVEL_SPECIAL = 3;
*/
PRIVATE CONST REPORT_FORM_CHAPTER_F707N_1 = 0; // Разделы Формы отчета <F707N_1>

PRIVATE MACRO _GetRate(d, from_fi, to_fi)
   var err, sincedate;
   var rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, 1, err, sincedate);
   if ((rate == NULL) or (rate == 0.0) or (iif(IsWorkDay(d), d, GetDateAfterWorkDays(d, -1)) > sincedate))
     rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, 23, err, sincedate);
     if ((rate == NULL) or (rate == 0.0))
       rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, 1001, err, sincedate);
       if ((rate == NULL) or (rate == 0.0))
         return NULL;
       end;
     end;
   end;
   return rate;
END;
/*Ищем курс заданного вида действующий и заданный на последний рабочий день периода отчета*/
PRIVATE MACRO _GetRateU(d, from_fi, to_fi, type)
   var err, sincedate;
   var rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, type, err, sincedate);
   if ((rate == NULL) or (rate == 0.0))
     return NULL;
   end;
  if (sincedate != iif( iif( type == RATETYPE_MARKET_PRICE, IsWorkDay(d, MOEX_CALENDAR_ID), IsWorkDay(d)), d, GetDateAfterWorkDays(d, -1))) //GAA:520551,если тип = рыночная цена, используем календарь биржи, иначе основной системный календарь
 //old:  if (sincedate != iif(IsWorkDay(d, MOEX_CALENDAR_ID), d, GetDateAfterWorkDays(d, -1)))
     return NULL;
   end;
   return rate;
END;

PRIVATE macro GetOkatoCode(pt:variant,OnDate:Date)
   var party = TRecHandler ("party.dbt");
   var okatoCode, lenght_okato_code = 5;

   if( ValType(pt)==V_INTEGER )
      ПолучитьСубъекта(pt, party);
   elif( ValType(pt)==V_GENOBJ )
      party = pt;
   end;

   getMainObjAttr (null,
                   OBJTYPE_PARTY,
                   uniID(party, OBJTYPE_PARTY),
                   12,
                   null,
                   null,
                   okatoCode,
                   OnDate);

   if (okatoCode==null)
      getMainObjAttr (null,
                   OBJTYPE_PARTY,
                   uniID(party, OBJTYPE_PARTY),
                   12,
                   null,
                   null,
                   okatoCode);
   end;
   return DL_IIF(okatoCode==null,"",okatoCode);
end;

PRIVATE MACRO ПолучитьЛюбойПоследнийКурсНаДату( p_RateDate:DATE, p_fiid:INTEGER, p_Course:@money ):bool
  VAR v_Data, v_Query, IsExistCurse = false;

  p_Course = $0;

  v_Query = RSDCommand(
             "SELECT t_rateid, t_type, t_fiid "+
             "  FROM (SELECT t_rateid, t_type, t_fiid "+
             "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_type, rate.t_fiid "+
             "                    FROM dratedef_dbt rate "+
             "                   WHERE rate.t_otherfi = ? "+ /*string(Fiid_from) */
             "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
             "                                             FROM dratedef_dbt "+
             "                                            WHERE     t_otherfi = rate.t_otherfi "+
             "                                                  AND t_type    = rate.t_type  "+
             "                                                  AND t_sincedate <= ? "+ /*RateDate*/
             "                                          ) "+
             "                  UNION "+
             "                    SELECT r.t_rateid, h.t_sincedate, r.t_type, r.t_fiid  "+
             "                      FROM dratehist_dbt h, dratedef_dbt r "+
             "                     WHERE     r.t_rateid    = h.t_rateid "+
             "                           AND r.t_otherfi   = ? "+  /*string(Fiid_from) */
             "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
             "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
             "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
             "                                                    AND r2.t_otherfi = r.t_otherfi "+
             "                                                    AND r2.t_type    = r.t_type  "+
             "                                                    AND h2.t_sincedate <= ?  "+ /*RateDate*/
             "                                               ) "+
             "                 ) "+
             "        ORDER BY t_sincedate DESC "+
             "       ) "+
             " WHERE ROWNUM = 1 "
                     );

  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.execute();

  v_Data = TRsbDataSet( v_Query );
  if( v_Data.MoveNext() )
     if( ПолучитьКурсЗаданногоTипа(@p_Course, p_fiid, v_Data.fiid, v_Data.Type, p_RateDate, false) == true )
        if( (int(v_Data.fiid) != NATCUR) and (ConvSum(p_Course, p_Course, p_RateDate, v_Data.fiid, NATCUR)) )
           msgbox(GetCurrencyConvertErrorMsg(v_Data.fiid,NATCUR,p_RateDate));
           IsExistCurse = false;
        else
           IsExistCurse = true;
        end;
     else
        msgbox(GetCurrencyConvertErrorMsg(p_fiid, v_Data.fiid, p_RateDate));
        IsExistCurse = false;
     end;
  end;

  return IsExistCurse;
END;

PRIVATE MACRO ПолучитьПоследнийКурсНаДатуТипа( p_RateDate:DATE, p_fiid:INTEGER, p_Type:INTEGER, p_OtherFi:@INTEGER ):bool
  VAR v_Data, v_Query, IsExistCurse = false;

  v_Query = RSDCommand(
             "SELECT t_rateid, t_fiid "+
             "  FROM (SELECT t_rateid, t_fiid "+
             "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_type, rate.t_fiid, rate.T_ISRELATIVE, rate.t_otherfi "+
             "                    FROM dratedef_dbt rate "+
             "                   WHERE rate.t_otherfi = ? "+ /*string(Fiid_from) */
             "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
             "                                             FROM dratedef_dbt "+
             "                                            WHERE     t_otherfi = rate.t_otherfi "+
             "                                                  AND t_type    = rate.t_type  "+
             "                                                  AND t_sincedate <= ? "+ /*RateDate*/
             "                                          ) "+
             "                  UNION "+
             "                    SELECT r.t_rateid, h.t_sincedate, r.t_type, r.t_fiid, r.T_ISRELATIVE, r.t_otherfi "+
             "                      FROM dratehist_dbt h, dratedef_dbt r "+
             "                     WHERE     r.t_rateid    = h.t_rateid "+
             "                           AND r.t_otherfi   = ? "+  /*string(Fiid_from) */
             "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
             "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
             "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
             "                                                    AND r2.t_otherfi = r.t_otherfi "+
             "                                                    AND r2.t_type    = r.t_type  "+
             "                                                    AND h2.t_sincedate <= ?  "+ /*RateDate*/
             "                                               ) "+
             "                 ) WHERE t_type IN (?)"+
             // Golovkin 17.05.2019 для относительных курсов берём в первую очередь валюту номинала
             "         ORDER BY t_sincedate DESC,                                            " +
             "                  (CASE                                                        " +
             "                      WHEN T_ISRELATIVE != CHR (88) THEN 1                     " +
             "                      WHEN T_ISRELATIVE = CHR (88)                             " +
             "                           AND t_fiid = (SELECT fin.t_facevaluefi              " +
             "                                           FROM dfininstr_dbt fin              " +
             "                                          WHERE fin.t_fiid = t_otherfi) THEN 1 " +
             "                      ELSE 0                                                   " +
             "                   END) DESC,                                                  " +
             "                  t_type ASC                                                   " +
             //"        ORDER BY t_sincedate DESC, t_type ASC "+
             "       ) "+
             " WHERE ROWNUM = 1 "
                     );

  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_Type );
  v_Query.execute();

  v_Data = TRsbDataSet( v_Query );
  if( v_Data.MoveNext() )
    p_OtherFi = v_Data.fiid;
    IsExistCurse = true;
  end;

  return IsExistCurse;
END;

PRIVATE MACRO GetRiskName(RiskLevel):String
   var RiskName = "";

   if( RiskLevel == RISKLEVEL_NOTINSTALL )
      RiskName = "Без уровня";
   elif( RiskLevel == RISKLEVEL_USUAL )
      RiskName = "Стандартный";
   elif( RiskLevel == RISKLEVEL_ELEVATED )
      RiskName = "Повышенный";
   elif( RiskLevel == RISKLEVEL_SPECIAL )
      RiskName = "Особый";
   end;

   return RiskName;
END;

PRIVATE MACRO hasOGRN(PartyID):Bool
  var Query = "begin ? := RSI_RSBPARTY.GetPartyCode(?, 27); end;";
  var cmd = RSDCommand(Query);
  cmd.addParam("pReturn",  RSDBP_OUT, V_STRING,    10000);
  cmd.addParam("PPARTYID", RSDBP_IN, PartyID);
  cmd.execute();

  return iif((cmd.value(0) == ""), false, true);
END;

PRIVATE CLASS (DL_CReportTemplate) DlActivitiesInfo_Report707( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
  var m_BegDate, m_EndDate, m_IsSecur:bool, m_IsDV:bool, m_IsVA:bool, m_IsDepo:bool, m_DepNum = 0;
  private var m_IsApp;
  private var m_ClientData;


  private var ALL_CLIENTS_SUBREPORT = 0;
  private var ACTIVE_CLIENTS_SUBREPORT = 1;

  private var ALL_COUNT_CLIENTS_HEADER = "Всего клиентов: ";
  private var ACTIVE_CLIENTS_HEADER = "В том числе, активных: ";

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
  PRIVATE VAR m_InKliko = UNSET_CHAR;

  PRIVATE VAR kliko_file_name;

/****************************************** Функции экспорта в kliko ********************************************************/
  PRIVATE MACRO Kliko_InsertInTxtFile( Str:STRING ):BOOL

    if( insert( Kliko_F707, Str ) == false )
       MsgBox( "Ошибка при вставке записи в файл Kliko" );
       return false;
    end;
    return true;
  END;

  /* ДДММГГ_F116, где ДДММГГ - дата, по состоянию на которую выпускается отчет. Расширение файла - номер операциониста в сети.*/
  PRIVATE MACRO Kliko_TxtFileName( RepDate:DATE ):STRING
    var Day, Month, Year;
    datesplit( RepDate, Day, Month, Year );
    Year = SubStr( string(Year), strlen(string(Year))-1 );

    kliko_file_name = string(Day:2:o)+string(Month:2:o)+string(Year:2:o)+"_F707";

    return GetTxtFileName( kliko_file_name );
  END;

  PRIVATE MACRO Kliko_CloseTxtFile(fileview:bool)
    var Day, Month, Year, stat = -1;
    datesplit( m_EndDate+1, Day, Month, Year );
    var kliko_dir_dt_name = string(Day:2:o)+string(Month:2:o)+string(Year:4:o);
    kliko_dir_dt_name = "\\\\go.rshbank.ru\\dfsroot\\OTHER\\SOFR_for_ETL\\inbox\\export\\KLIKO\\0409707\\"+kliko_dir_dt_name;
    //var kliko_file_name_term = "$C:\\SOFR\\EXPORT\\"+kliko_file_name+".dat";
    var kliko_file_name_term = kliko_dir_dt_name+"\\"+kliko_file_name+".dat";
    
    close( Kliko_F707 );
 
    stat = ExistDir(kliko_dir_dt_name);
     
    if(stat == 2)//нет директории
      if(not MakeDir(kliko_dir_dt_name))
        msgbox("Не могу создать директорию "+kliko_dir_dt_name);
      end;
    elif (stat == 1) //нет прав доступа
      msgbox("Нет прав на запись в директорию "+kliko_dir_dt_name);
    elif (stat == 0) //директория есть и права на запись есть
      
    end;

    if(ExistFile(kliko_file_name_term))
      RemoveFile(kliko_file_name_term);
    end;

    copyFile(FileName(Kliko_F707),kliko_file_name_term,true,"Копирование на терминал"); // Golovkin 28.06.2019
    
    if(fileview)
      ViewFile( Kliko_F707 );
    end;
  END;

  PRIVATE MACRO Kliko_TxtFileExt(filename:string)
    return SubStr(filename,1,Index(filename,"7.") + 1) + "dat";
  END;

  PRIVATE MACRO Kliko_OpenTxtFile( RepDate:DATE )
    VAR errcode, errtext;

    VAR fName = Kliko_TxtFileExt(Kliko_TxtFileName( RepDate ));

    if( not Open( Kliko_F707, fName, "rsoem" ) )
      errcode = status(errtext);
      msgbox( "Ошибка при открытии файла для экспорта в kliko|"+fName+"|(" + errcode + ") " + errtext );
      return false;
    end;

    return true;
  END;

  /** Golovkin 10.05.2021 SD6630971 */
  private macro ЧислоСЗаданнойТочностью( _var, _point:integer, _parm:string ) 
      var TmpStr:string;
      if( (valtype (_var) == V_DOUBLE) OR (valtype (_var) == V_MONEY) )
        if((valtype (_parm) == V_UNDEF) OR (_parm == ""))
          TmpStr = "String(_var:0" + ":" + string(_point) + ")";
        else
          TmpStr = "String(_var:0" + ":" + string(_point) + ":" + _parm + ")";
        end;
        return ExecExp(TmpStr);
      else
        return String(_var);
      end;
  end;


  PRIVATE MACRO Kliko_Fld( Val:VARIANT, _point:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL )
      VAR vt = ValType(Val);
      if( vt == V_DATE )
         if( Val == DATE(0,0,0) )
            ValStr = "";
         else
            ValStr = string(Val:f);
         end;
      elif( vt == V_STRING )
        if( Val != "0")
          ValStr = string(Val);
        else
          ValStr = "";
        end;
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        if( Val != 0.00)
          //ValStr = trim(string(Val:18:5));
          if(_point != null)
             ValStr = ЧислоСЗаданнойТочностью(Val, _point); // Golovkin 10.05.2021 SD6630971
          else
             ValStr = ЧислоСЗаданнойТочностью(Val, 2);
          end;
        end;
      elif( vt == V_INTEGER )
        if( Val != 0)
          ValStr = string(Val);
        else
          ValStr = "0";
        end;
      else
         ValStr = string(Val);
      end;
    end;
    return "\""+ValStr+"\"";
  END;

/****************************************************************************************************************************/

  /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true; /*в EW показываем листы всегда*/
    end;
  END;

  macro GetBegEndDateByPeriod():Date
     var NumQuartal, Month,
         Year = Form707.GetFieldValue(PNFLD_FORM707_YEAR),
         Period = Form707.GetFieldValue(PNFLD_FORM707_PERIOD);

     if(Period < 13)   /*Задан месяц*/
       m_BegDate = Date(1, Period, Year);
       m_EndDate = DateAfterCalenMonths(m_BegDate, 1) - 1;
     else                   /*Задан квартал*/
       NumQuartal = Period - 12;
       Month = (NumQuartal - 1) * 3 + 1;
       m_BegDate = Date(1, Month, Year);
       m_EndDate = DateAfterCalenMonths(m_BegDate, 3) - 1;
     end;
  end;

  PRIVATE MACRO PrintMode():INTEGER
    if(Form707.GetFieldValue( PNFLD_FORM707_EXCEL) == SET_CHAR )
      return DL_OUTREPORT_EXCEL;
    /*Текстовый вид пока не раелизуем
    elif (Form707.GetFieldValue( PNFLD_FORM707_STD) == SET_CHAR)
      return DL_OUTREPORT_STD;*/
    end;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )

    CreateTotalBook();
    GetBegEndDateByPeriod();
    m_IsSecur = iif(Form707.GetFieldValue(PNFLD_FORM707_ISSECUR) == SET_CHAR,true,false);
    m_IsDV    = iif(Form707.GetFieldValue(PNFLD_FORM707_ISDV) == SET_CHAR,true,false);
    m_IsVA    = iif(Form707.GetFieldValue(PNFLD_FORM707_ISVA) == SET_CHAR,true,false);
    m_IsDepo  = iif(Form707.GetFieldValue(PNFLD_FORM707_ISDEPO) == SET_CHAR,true,false);
    m_IsApp   = iif(Form707.GetFieldValue(PNFLD_FORM707_APP) == SET_CHAR,true,false);
    m_InKliko = iif(Form707.GetFieldValue(PNFLD_FORM707_KLIKO) == SET_CHAR,true,false);

    //SetActiveSheet( "Отчет" );
  END;

  MACRO PrintKlikoHead(header:STRING)
     if (m_InKliko)
       Kliko_InsertInTxtFile(String(header));
     end;
  END;

  MACRO PrintKlikoTitle(ReportChapter:Integer, StrName, X, _StCount:@INTEGER)
     
        private macro __insertLine(_StrName, _EmptyCount, _X, _Y)
          var i = 0;
     
          var s:string = Kliko_Fld( _StrName ) +",";
          while( i < _EmptyCount )
            s = s + Kliko_Fld( "" ) +",";
            i = i + 1;
          end;
          s = s + Kliko_Fld( _X ) +","+
                  Kliko_Fld( _Y ) +","+
                  Kliko_Fld( "" );
          return Kliko_InsertInTxtFile(s);
        end;

     if (m_InKliko)
       var StrCount = "";
       if (_StCount != null)
         StrCount = _StCount + 1;
         _StCount = StrCount;
       end;

       var EmptyCount;
       if ( (ReportChapter != null) and (ReportChapter == REPORT_FORM_CHAPTER_F707N_1) )
         EmptyCount = 14;
       else
         EmptyCount = 6;
       end;

       return __insertLine(StrName, EmptyCount, X, StrCount);
     end;
  END;

  MACRO PrintReportHead()
     var recOurBank = TRecHandler("party.dbt");
     ПолучитьСубъекта({OurBank}, recOurBank);

     PrintFormatString( "#",
                        "H1_ОКАТО",      GetOkatoCode(recOurBank, this.H1_ReportDate()),
                        "H1_ОКПО",       recOurBank.rec.OKPO,
                        "H1_РегНом",     ПолучитьКодСубъекта({OurBank}, PTCK_BANKREGNUM),
                        "H1_ЛицЦБ",      ПолучитьКодСубъекта({OurBank}, PTCK_ORCBLICENSE),
                        "H1_ДатаСРО",    DL_ДатаВключенияВСРО(),
                        "H1_НаимСРО",    DL_НаименованиеСРО(),
                        "H1_ReportDate", date_as_string(1, this.H1_ReportDate() + 1),
                        "H1_ShortName",  string(GetPartyShortNameByID({OurBank})),
                        "H1_Adress",     string(GetPartyAddress({OurBank}, false, false, PTADDR_REAL))
                      );
     if( m_InKliko )
//        Kliko_InsertInTxtFile(String("<F707_1>"));
     end;
  END;

  MACRO H1_ReportDate():date
     return m_EndDate;
  end;

  MACRO H1_EndWorkDate():date
     return iif(IsWorkDay(m_EndDate), m_EndDate, GetDateAfterWorkDays(m_EndDate, -1));
  end;

  MACRO PrintDepoOneTableHeader(Text)
    PrintFormatString( NULL, "N1_D_Subtitle", Text);
    CopyAllSheetInTotalBook("Отчет", false, "N1_D_Subtitle_1", 0, false);
  END;

  MACRO PrintOneTableHeader(Text)
    PrintFormatString( NULL, "N1_A_Subtitle", Text);
    CopyAllSheetInTotalBook("Отчет", false, "N1_A_Subtitle_1", 0, false);
  END;

  MACRO PrintDepoRepTableLine(CountryCode, PersnCount, OrgCount):BOOL
    if((PersnCount > 0) or (OrgCount > 0))
        PrintFormatString( NULL, "N1_D01", CountryCode,
                                 "N1_D02", PersnCount + OrgCount,
                                 "N1_D03", PersnCount,
                                 "N1_D04", OrgCount
                         );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable3", 0, "Отчет");
        return true;
    elif(CountryCode == "")
        PrintFormatString( NULL, "N1_D01", "",
                                 "N1_D02", "",
                                 "N1_D03", "",
                                 "N1_D04", ""
                         );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable3", 0, "Отчет");
        return true;
    else
        return false;
    end;
  END;

  MACRO PrintRepTableLine(CountryCode, ClientsCount, 
                          InAccPlus, SecurPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,
                          InAccMinus, SecurMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus):BOOL
    if(ClientsCount > 0)
        PrintFormatString(null,"N1_A01", CountryCode, 
                               "N1_A02", ClientsCount,
                               "N1_A03", InAccPlus,
                               "N1_A04", SecurPlus,
                               "N1_A05", RestMoneyPlus,
                               "N1_A06", RestSecurPlus,
                               "N1_A07", RestOtherPlus,
                               "N1_A08", InAccMinus,
                               "N1_A09", SecurMinus,
                               "N1_A10", RestMoneyMinus,
                               "N1_A11", RestSecurMinus,
                               "N1_A12", RestOtherMinus
                               );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable1", 0, "Отчет");
        return true;
    elif(CountryCode == "")
        PrintFormatString(null,"N1_A01", "", 
                               "N1_A02", "",
                               "N1_A03", "",
                               "N1_A04", "",
                               "N1_A05", "",
                               "N1_A06", "",
                               "N1_A07", "",
                               "N1_A08", "",
                               "N1_A09", "",
                               "N1_A10", "",
                               "N1_A11", "",
                               "N1_A12", ""
                               );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable1", 0, "Отчет");
        return true;
    else
        return false;
    end;
  END;

  PRIVATE MACRO GetDepoClients()
     return " Exists(select 1 "
            "          from ddepoacnt_dbt root, ddepoacnt_dbt part "+
            "         where root.t_Code = sfcontr.t_Object "+
            "           and part.t_Root = root.t_AutoKey "+
            "           and (Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_PayerAccount = part.t_BriefCode "+
            "                          and pmpaym.t_PayerBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN ? AND ? "+
            "                      ) "+
            "             or Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_ReceiverAccount = part.t_BriefCode "+
            "                          and pmpaym.t_ReceiverBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN ? AND ? "+
            "                      ) "+
            "               ) "+
            "       ) ";
  END;

  PRIVATE MACRO GetVAClientsFilled(DealDate1,DealDate2)
     return " exists(SELECT 1 " +
            "    FROM ddl_tick_dbt tick " +
            "   WHERE TICK.T_BOFFICEKIND = " + string(DL_VEKSELACCOUNTED) +
            "     AND tick.t_DealStatus > 0 " +
            "     AND tick.t_ClientContrID = sfcontr.t_ID" +
            "     AND tick.t_DealDate BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "     AND Tick.t_ClientID = t.t_partyID ) ";
  END;

  PRIVATE MACRO GetSecurClientsFilled(DealDate1,DealDate2)
     return " exists (SELECT 1 " +
            "         FROM ddl_tick_dbt tick " +
            "         WHERE TICK.T_BOFFICEKIND = " + string(DL_SECURITYDOC) +
            "         AND tick.t_DealStatus > 0 " +
            "         AND (Tick.t_ClientContrID = sfcontr.t_ID OR (Tick.t_PartyContrID = sfcontr.t_ID AND Tick.t_IsPartyClient = 'X')) " +
            "         AND tick.t_DealDate BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "         AND (Tick.t_ClientID = t.t_partyID OR (Tick.t_PartyID = t.t_partyID AND Tick.t_IsPartyClient = 'X'))) ";
  END;

  PRIVATE MACRO GetDVClientsFilled(DealDate1,DealDate2)
     return " (exists(SELECT 1 " +
            "         FROM DDVNDEAL_DBT dvndeal " +
            "         WHERE DVNDEAL.T_CLIENT = T.T_PARTYID " +
            "           AND DVNDEAL.T_DATE BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "           AND DVNDEAL.T_STATE > 0) " +
            "      OR " +
            " exists (SELECT 1 " +
            "         FROM DDVDEAL_DBT dvdeal" +
            "         WHERE DVDEAL.T_CLIENT = T.T_PARTYID " +
            "         AND DVDEAL.T_DATE BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "         AND DVDEAL.T_STATE > 0)) ";
  END;

  PRIVATE MACRO GetDepoClientsFilled(DealDate1,DealDate2)
     return " Exists(select 1 "
            "          from ddepoacnt_dbt root, ddepoacnt_dbt part "+
            "         where root.t_Code = sfcontr.t_Object "+
            "           and part.t_Root = root.t_AutoKey "+
            "           and (Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_PayerAccount = part.t_BriefCode "+
            "                          and pmpaym.t_PayerBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" "+
            "                      ) "+
            "             or Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_ReceiverAccount = part.t_BriefCode "+
            "                          and pmpaym.t_ReceiverBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" "+
            "                      ) "+
            "               ) "+
            "       ) ";
  END;

  PRIVATE MACRO GetCountResident(IsNotResident, LegalForm)
    var Query = "select COUNT(0) as t_Count from (select distinct t.t_PartyID  " +
                "  from dparty_dbt t, dclient_dbt cl " +
                " where t_LegalForm = " + string(LegalForm) + " and t_NotResident " + IIF(IsNotResident, "=", "<>") + " 'X'" +
                "   and t.t_PartyID <> " + string({OurBank}) +
                "   and cl.t_PartyID = t.t_PartyID " +
  IIF(m_IsDepo, "   and cl.t_ServiceKind = " + string(PTSK_DEPOS), "") +
                "   and exists(select 1" +
                "               from dsfcontr_dbt sfcontr" +
                "               where sfcontr.t_PartyID = t.t_PartyID" +
                "                 and (" +
                "                           (sfcontr.t_DateClose > ?" +
                "                               or" +
                "                           sfcontr.t_DateClose = ?)" +
                "                           and" +
                "                           sfcontr.t_DateBegin <= ?" +
                "                       )" +
  IIF(m_IsDepo, "                 and sfcontr.t_ServKind = " + string(PTSK_DEPOS), "") +
                "                 and sfcontr.t_Department = cl.t_Department)" +
                "   and cl.t_StartDate <= ?" +
                "   and (cl.t_FinishDate > ? or cl.t_FinishDate = ?))";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    var DS = Select.execute();
    DS.MoveNext();
    return DS.Count;
  END;

  PRIVATE MACRO GetRestInAccResidentVA(SubQueryForContrId)
    var totalCount = 0;
    var Query = "select RSI_RSB_FIInstr.ConvSum(rsi_rsb_account.RestAC(acdoc.t_account, acdoc.t_currency, ?, acdoc.t_chapter, 0)"+
                ", acdoc.t_currency, ?, ?, 0 ) as t_rest " +
                "  from ddl_tick_dbt t, dmcaccdoc_dbt acdoc " +
                " where acdoc.t_catnum = (select T_NUMBER from DMCCATEG_DBT where T_CODE = ?) "+
                "  and t.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")" +
                "   and acdoc.t_docid = t.t_dealid "+
                "   and acdoc.t_iscommon = CHR(0) "+
                "   and t.t_clientcontrid in " + SubQueryForContrId;
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(NATCUR);
    Select.AddParam(H1_ReportDate()-1);
    Select.AddParam("ДС Клиента, ВУ");
    var DS = Select.execute();
    while (DS.MoveNext())
      totalCount = (totalCount + ABS(DS.Rest / 1000));
    end;
    return Int(totalCount);
  END;

  PRIVATE MACRO GetSecurInAccResidentVA(SubQueryForContrId)
    var totalCount = 0,buf=0,pfi=0;
    var Query = "select t.t_Name as t_FiidName, t.T_FIID as t_fiid, t.t_facevaluefi as t_pfi, rsi_rsb_account.RestAC(acdoc.t_account, acdoc.t_currency, ?, acdoc.t_chapter, 0) as t_rest " +
                "  from dfininstr_dbt t, dmcaccdoc_dbt acdoc, dvsbanner_dbt bnr, ddl_leg_dbt leg " +
                " where bnr.t_contrid in " + SubQueryForContrId +
                "   and t.t_FIID = bnr.t_FIID and bnr.t_BCID = leg.t_DealId and leg.t_LegId = 0 and leg.t_LegKind = 1 " +
                "   and acdoc.t_catnum IN (select T_NUMBER from DMCCATEG_DBT where T_CODE IN (?,?,?)) "+
                "   and acdoc.t_dockind = " + string(DL_VSBANNER) +
                "   and acdoc.t_docid = bnr.T_BCID " +
                "   and acdoc.t_iscommon = CHR(0) ";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam("ЦБ Клиента, ВУ");
    Select.AddParam("НЦБ Клиента, ВУ");
    Select.AddParam("ФО Клиента, ВУ");
    var DS = Select.execute();
    while (DS.MoveNext())
      pfi = IIF(DS.PFI==-1,NATCUR,DS.PFI);
      if (ПолучитьКурсЗаданногоTипа( @buf, DS.Fiid, pfi, 1, H1_ReportDate(), false))
        buf = buf * ABS(DS.Rest);
        if (ConvSum (buf, money(buf), H1_ReportDate()-1, pfi, NATCUR, 0) != 0)
          buf = 0.0;
        end;
        totalCount = totalCount + (buf / 1000);
      else
        msgbox("Не определена рыночная стоимость ц/б "+DS.FiidName);
      end;
    end;
    return Int(totalCount);
  END;

  PRIVATE MACRO GetRestMoneyResidentVA(SubQueryForContrId)
    var totalCount = $0;
    var Query = "select (RSI_RSB_FIInstr.ConvSum(pm.t_baseamount, pm.t_basefiid, ?, ?, 0 ) * (CASE WHEN pm.t_receiver = t.t_ClientId THEN 1 ELSE -1 END)) as t_rest " +
                "  from ddl_tick_dbt t, dpmpaym_dbt pm " +
                " where t.t_clientcontrid in " +SubQueryForContrId+
                "   and t.t_dealstatus = " + string(DL_READIED) +
                "   and pm.t_dockind = t.t_bofficekind " +
                "   and pm.t_documentid = t.t_dealid " +
                "   and pm.t_paymstatus = " + string(PM_READIED) +
                "   and pm.T_PURPOSE in ("+string(CAi)+","+string(PM_PURP_VSBARTERDIFF)+","+string(PM_PURP_PRINC_RET)+","+string(PM_PURP_PERCENT)+") "+
                "   and t.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(NATCUR);
    Select.AddParam(H1_ReportDate()-1);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    var DS = Select.execute();
    while (DS.MoveNext())
      totalCount = totalCount + (DS.Rest / 1000);
    end;
    return Int(totalCount);
  END;

  PRIVATE MACRO GetRestSecurResidentVA(SubQueryForContrId)
    var totalCount = $0,buf=0,pfi=0;
    var Query = "select t.t_Name as t_FiidName, t.t_facevaluefi as t_pfi, pm.t_baseamount as t_baseamount, pm.t_basefiid as t_fiid, CASE WHEN pm.t_receiver = tick.t_ClientId THEN 1 ELSE -1 END as t_coef " +
                "  from dfininstr_dbt t, ddl_tick_dbt tick, dpmpaym_dbt pm " +
                " where tick.t_clientcontrid IN "+SubQueryForContrId+
                "   and pm.t_basefiid = t.t_FIID "+
                "   and tick.t_dealstatus = " + string(DL_READIED) +
                "   and pm.t_dockind = tick.t_bofficekind " +
                "   and pm.t_documentid = tick.t_dealid " +
                "   and pm.t_paymstatus = " + string(PM_READIED) +
                "   and pm.T_PURPOSE in ("+string(BAi)+") "+
                "   and tick.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    var DS = Select.execute();
    while (DS.MoveNext())
      pfi = IIF(DS.PFI==-1,NATCUR,DS.PFI);
      if (ПолучитьКурсЗаданногоTипа( @buf, DS.Fiid, pfi, 1, H1_ReportDate(), false))
        buf = buf * DS.BaseAmount * DS.Coef;
        if (ConvSum (buf, money(buf), H1_ReportDate()-1, pfi, NATCUR, 0) != 0)
          buf = 0.0;
        end;
        totalCount = totalCount + (buf / 1000);
      else
        msgbox("Не определена рыночная стоимость ц/б "+DS.FiidName);
      end;
    end;
    return Int(totalCount);
  END;

  MACRO PrintLineDecription(ClientCode, Client, ClientFull, A01, ResidenceStatus, RegisterType, Activity, QualifedInvestor, ContractNumber, ContractOpenDate, ContractCloseDate, Industry, Account, CrNom, A05, NumDEPO, SecQnty, MarketSecCost, A06, A07, A08, A09, Itog, RiskName)
    if (ContractCloseDate == null)
      ContractCloseDate = date(01,01,2000);
    end;
    PrintTableLine("N2_ClientCode", ClientCode, null, 
                   "N2_Client", Client, null, 
                   "N2_ClientFull", ClientFull, null, 
                   "N2_A01", string(A01), null, 
                   "N2_ResidenceStatus", IIF(ResidenceStatus == "X", "нерезидент", iif(ResidenceStatus != "", "резидент","")), null, 
                   "N2_RegisterType", IIF(RegisterType == "X", "физ.лицо", iif(RegisterType == "0", "юр.лицо","")), null, 
                   "N2_Activity", iif(Activity == "X", "Да", iif(Activity != "", "Нет","")), null, 
                   "N2_QualifiedInvestor", iif(QualifedInvestor == "X", "Да", iif(QualifedInvestor != "", "Нет","")), null, 
                   "N2_ContractNumber", ContractNumber, null, 
                   "N2_ContractOpenDate", ContractOpenDate, null, 
                   "N2_ContractCloseDate", iif(ContractCloseDate > date(01,01,2000), ContractCloseDate, ""), null, 
                   "N2_Industry", Industry, null, 
                   "N2_Account", Account, null, 
                   "N2_CrNom", iif(CrNom == 0, "", CrNom), null, 
                   //"N2_A05", iif(A05 == null, 0.0, money(A05)), 2,
                   "N2_A05", iif(A05 == null, 0.0, A05), 5, // Golovkin 2 -> 5
                   "N2_NumDEPO", "", null, 
                   "N2_SecQnty", "", null,
                   "N2_MarketSecCost", A06, null, 
                   "N2_A06", A06, null, 
                   "N2_A07", iif((Itog >= 0), A07, ""), null, 
                   "N2_A08", iif((Itog >= 0), A08, ""), null, 
                   "N2_A09", iif((Itog >= 0), A09, ""), null,
                   "N2_A10", iif((Itog >= 0), Itog, ""), null,
                   "N2_A11", RiskName, null,
                   "N2_A12", iif((Itog < 0), A07, ""), null,
                   "N2_A13", iif((Itog < 0), A08, ""), null,
                   "N2_A14", iif((Itog < 0), A09, ""), null,
                   "N2_A15", iif((Itog < 0), Itog, ""), null,
                   "N2_S0.", Itog, null);
  end;

  MACRO PrintLineAvoiriss(ClientCode, Client, A01, ContractNumber, AvrKind, AvrType, FI_Name, ISIN, SecQnty, Nominal, Fiid, MarketPrice, Rate, TotalCost)
    PrintTableLine("N3_ClientCode", ClientCode, null,
                   "N3_Client", Client, null,
                   "N3_A01", string(A01), null,
                   "N3_ContractNumber", ContractNumber, null,
                   "N3_KindAvr", AvrKind, null,
                   "N3_TypeAvr", AvrType, null,
                   "N3_FIName", FI_Name, null,
                   "N3_ISIN", ISIN, null,
                   "N3_SecQnty", SecQnty, null,
                   "N3_Nominal", Nominal, null,
                   "N3_FiID", ПолучитьКодФинИн(int(Fiid)), null,
                   "N3_MarketPrice", MarketPrice, null,
                   "N3_Rate", Rate, null,
                   "N3_TotalCost", TotalCost, null);
  END;

  private class DecrAcc(_ContractNumber, _ContractOpenDate, _ContractCloseDate, _Industry, _Account, _CrNom, _A05, _NumDEPO, _SecQnty, _MarketSecCost, _A06, _A07, _A08, _A09)
    var ContractNumber = _ContractNumber;
    var ContractOpenDate = _ContractOpenDate;
    var ContractCloseDate = _ContractCloseDate;
    var Industry = _Industry;
    var Account = _Account;
    var CrNom = _CrNom;
    var A05 = _A05;
    var NumDEPO = _NumDEPO;
    var SecQnty = _SecQnty;
    var MarketSecCost = _MarketSecCost;
    var A06 = _A06;
    var A07 = _A07;
    var A08 = _A08;
    var A09 = _A09;
  end;


  macro CheckPartyType( PartyId, PartyType )
    var partyown = TBFile("partyown");
    var isPartyType = false;

    partyown.KeyNum = 0;
    partyown.rec.PartyID   = PartyId;
    partyown.rec.PartyKind = PartyType;
    if (GetEQ(partyown))
      isPartyType = true;
    end;

    return isPartyType;
  end;

  macro GetCountryCode(PartyCode):string
    var q = "select t_codenum3 code from dcountry_dbt where t_CodeLat3 = ? ";
    var cmd = DL_RSDCommand(q);
    cmd.AddParam(PartyCode);
    var rs = cmd.execute();

    if (rs.MoveNext())
      return string(rs.code);
    end;

    return "999";
  end;

  PRIVATE CLASS Cals_Sums(H1_ReportDate, p_IsSecur, p_IsDV, p_IsVA, p_IsDepo, num, LegalForm, CodeCountry, IsQualified, IsActive, State, BegDate, EndDate, DealDate1, DealDate2, H1_EndWorkDate)

    VAR m_IsSecur = p_IsSecur;
    VAR m_IsDV = p_IsDV;
    VAR m_IsVA = p_IsVA;
    VAR m_IsDepo = p_IsDepo;

    //Перечисление подразделов таблицы 1, используется для удобства и оптимизации кода
    PRIVATE CONST SUBSECTION_ALL    = 1,  
                  SUBSECTION_FL     = 2,
                  SUBSECTION_UL     = 3,
                  SUBSECTION_KI     = 4,
                  SUBSECTION_ACTIVE = 5,
                  SUBSECTION_RISK   = 6;

    private macro PrintSubsectionTable_1( SubTitle, SubSection, IsNotResident, RiskLevel, StCount:@integer, PrCount:@integer )
      var q, cmd, rs, q1, cmd1, rs1;
      var q0, cmd0, rs0, nr, c29, c45, c61, c89, c92, cc;
      const ReportChapter = REPORT_FORM_CHAPTER_F707N_1;
      var IsNotEmpty = false;

      dbg(SubTitle);
      Report707.PrintOneTableHeader(SubTitle + ":");
      Report707.PrintKlikoTitle(ReportChapter, SubTitle + ":", "1", @StCount);

      if( this.m_IsSecur or this.m_IsDV or this.m_IsVA )
        if( (SubSection == SUBSECTION_FL) or (SubSection == SUBSECTION_UL) )
          q = "select nvl(sum(sub_cnt), 0) cnt, " + // Golovkin 07.05.2021 + nvl
              "       sum(round(a5_pl,0)) a5_plus, " + 
              "       sum(a6_pl) a6_plus, " + 
              "       sum(round(a7_pl/1000,2)) a7_plus, " + 
              "       sum(round(a8_pl/1000,2)) a8_plus, " + 
              "       sum(round(a9_pl/1000,2)) a9_plus, " + 
              "       sum(round(a5_min,0)) a5_minus, " + 
              "       sum(a6_min) a6_minus, " + 
              "       sum(round(a7_min/1000,2)) a7_minus, " + 
              "       sum(round(a8_min/1000,2)) a8_minus, " + 
              "       sum(round(a9_min/1000,2)) a9_minus " + 
              "  from ( select T_COUNTRY, count(T_CLIENTCODE) sub_cnt, " + 
              "                sum(case when itog >= 0 then a5 else 0 end) a5_pl, " + 
              "                sum(case when itog >= 0 then a6 else 0 end) a6_pl, " +
              "                sum(case when itog >= 0 then a7 else 0 end) a7_pl, " +   
              "                sum(case when itog >= 0 then a8 else 0 end) a8_pl, " +   
              "                sum(case when itog >= 0 then a9 else 0 end) a9_pl, " +
              "                sum(case when itog < 0 then a5 else 0 end) a5_min, " + 
              "                sum(case when itog < 0 then a6 else 0 end) a6_min, " +
              "                sum(case when itog < 0 then a7 else 0 end) a7_min, " +   
              "                sum(case when itog < 0 then a8 else 0 end) a8_min, " +   
              "                sum(case when itog < 0 then a9 else 0 end) a9_min " + 
              "           from ( select T_COUNTRY, T_CLIENTCODE, " +
              "                         NVL(sum(T_A5), 0) a5, " +
              "                         NVL(sum(T_A6), 0) a6, " +
              "                         NVL(sum(T_A7), 0) a7, " +
              "                         NVL(sum(T_A8), 0) a8, " +
              "                         NVL(sum(T_A9), 0) a9, " + 
              "                         NVL(sum(T_ITOG), 0) itog " +
              "                    from " + tmp_table +
              "                   where T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + 
              "                     and T_FL " + IIF(SubSection == SUBSECTION_FL, " = 'X' ", " != 'X' ") + 
              "                   group by T_CLIENTCODE, T_COUNTRY ) " +
              "     group by T_COUNTRY )";     
        else
          q = "select count(T_CLIENTCODE) cnt, " + 
              "       round(sum(case when itog >= 0 then a5 else 0 end), 0) a5_plus, " + 
              "       sum(case when itog >= 0 then a6 else 0 end) a6_plus, " +
              "       round(sum(case when itog >= 0 then a7 else 0 end)/1000, 2) a7_plus, " +   
              "       round(sum(case when itog >= 0 then a8 else 0 end)/1000, 2) a8_plus, " +   
              "       round(sum(case when itog >= 0 then a9 else 0 end)/1000, 2) a9_plus, " +
              "       round(sum(case when itog < 0 then a5 else 0 end), 0) a5_minus, " + 
              "       sum(case when itog < 0 then a6 else 0 end) a6_minus, " +
              "       round(sum(case when itog < 0 then a7 else 0 end)/1000, 2) a7_minus, " +   
              "       round(sum(case when itog < 0 then a8 else 0 end)/1000, 2) a8_minus, " +   
              "       round(sum(case when itog < 0 then a9 else 0 end)/1000, 2) a9_minus " + 
              "  from ( select T_CLIENTCODE, " +
              "                NVL(sum(T_A5), 0) a5, " +
              "                NVL(sum(T_A6), 0) a6, " +
              "                NVL(sum(T_A7), 0) a7, " +
              "                NVL(sum(T_A8), 0) a8, " +
              "                NVL(sum(T_A9), 0) a9, " + 
              "                NVL(sum(T_ITOG), 0) itog " +
              "           from " + tmp_table;

          if( SubSection == SUBSECTION_KI )
            q = q + " where T_KI = 'X' ";
          elif( SubSection == SUBSECTION_ACTIVE )
            q = q + " where T_ACTIVE = 'X' ";
          elif( SubSection == SUBSECTION_RISK )
            q = q + " where T_RISKLEVEL = " + RiskLevel;
          end;
          q = q + " group by T_CLIENTCODE ) " ; //Обязательная группировка вконце
        end;
     
        cmd = DL_RSDCommand(q);
        rs = cmd.execute();
        dbg(q);

        // Golovkin 17.09.2020 Адаптация 4927у
        nr = 0; c29 = 0; c45 = 0; c61 = 0; c89 = 0; c92 = 0; cc = 0;
        if( not (SubSection == SUBSECTION_UL))
           q0 = "select count(1) cnt from (select T_PARTYID from " + tmp_table + " t where T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + " and T_FL = 'X' "+iif(SubSection == SUBSECTION_ACTIVE,"and T_ACTIVE = 'X'","")+" "+iif(SubSection == SUBSECTION_KI,"and T_KI = 'X'","")+" "+iif(SubSection == SUBSECTION_RISK,"and T_RISKLEVEL = " + RiskLevel,"")+" group by T_PARTYID)   where t_partyid in (115148, 127823)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c45 = c45 + 1; end;
           q0 = "select count(1) cnt from (select T_PARTYID from " + tmp_table + " t where T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + " and T_FL = 'X' "+iif(SubSection == SUBSECTION_ACTIVE,"and T_ACTIVE = 'X'","")+" "+iif(SubSection == SUBSECTION_KI,"and T_KI = 'X'","")+" "+iif(SubSection == SUBSECTION_RISK,"and T_RISKLEVEL = " + RiskLevel,"")+" group by T_PARTYID)   where t_partyid in (115856, 127824)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c92 = c92 + 1;  end;
           q0 = "select count(1) cnt from (select T_PARTYID from " + tmp_table + " t where T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + " and T_FL = 'X' "+iif(SubSection == SUBSECTION_ACTIVE,"and T_ACTIVE = 'X'","")+" "+iif(SubSection == SUBSECTION_KI,"and T_KI = 'X'","")+" "+iif(SubSection == SUBSECTION_RISK,"and T_RISKLEVEL = " + RiskLevel,"")+" group by T_PARTYID)   where t_partyid in (116478, 127825)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c92 = c92 + 1; end;
           q0 = "select count(1) cnt from (select T_PARTYID from " + tmp_table + " t where T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + " and T_FL = 'X' "+iif(SubSection == SUBSECTION_ACTIVE,"and T_ACTIVE = 'X'","")+" "+iif(SubSection == SUBSECTION_KI,"and T_KI = 'X'","")+" "+iif(SubSection == SUBSECTION_RISK,"and T_RISKLEVEL = " + RiskLevel,"")+" group by T_PARTYID)   where t_partyid in (119746, 127826)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c89 = c89 + 1; end;
           q0 = "select count(1) cnt from (select T_PARTYID from " + tmp_table + " t where T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + " and T_FL = 'X' "+iif(SubSection == SUBSECTION_ACTIVE,"and T_ACTIVE = 'X'","")+" "+iif(SubSection == SUBSECTION_KI,"and T_KI = 'X'","")+" "+iif(SubSection == SUBSECTION_RISK,"and T_RISKLEVEL = " + RiskLevel,"")+" group by T_PARTYID)   where t_partyid in (118520, 127827)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c89 = c89 + 1; end;
           q0 = "select count(1) cnt from (select T_PARTYID from " + tmp_table + " t where T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + " and T_FL = 'X' "+iif(SubSection == SUBSECTION_ACTIVE,"and T_ACTIVE = 'X'","")+" "+iif(SubSection == SUBSECTION_KI,"and T_KI = 'X'","")+" "+iif(SubSection == SUBSECTION_RISK,"and T_RISKLEVEL = " + RiskLevel,"")+" group by T_PARTYID)   where t_partyid in (118993, 127837)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c29 = c29 + 1; end;
        end;

        if( rs.MoveNext() and (rs.cnt > 0) )           
          cc = rs.cnt - nr; // Golovkin 17.09.2020 Адаптация 4927у
          Report707.PrintRepTableLine("", cc, //rs.cnt, // Golovkin 17.09.2020 Адаптация 4927у
                                      rs.a5_plus, rs.a6_plus, rs.a7_plus, rs.a8_plus, rs.a9_plus, 
                                      rs.a5_minus, rs.a6_minus, rs.a7_minus, rs.a8_minus, rs.a9_minus);

          Report707.PrintKlikoValLine("", "", cc/*rs.cnt*/,
                                      rs.a5_plus, rs.a6_plus, rs.a7_plus, rs.a8_plus, rs.a9_plus, 
                                      rs.a5_minus, rs.a6_minus, rs.a7_minus, rs.a8_minus, rs.a9_minus,
                                      "1", @StCount, @PrCount, false);
          IsNotEmpty = true;
        end
      end;
      if( IsNotEmpty == false )
          Report707.PrintRepTableLine("", 0);
          Report707.PrintKlikoValLine("", "", "", // EMPTY LINE
                                      "", "", "", "", "", 
                                      "", "", "", "", "", 
                                      "1", @StCount, @PrCount, false);
      end;

      if( (SubSection == SUBSECTION_FL) or (SubSection == SUBSECTION_UL) )
        dbg(IIF(IsNotResident, "В том числе по странам", "В том числе по субъектам"));
        Report707.PrintOneTableHeader(IIF(IsNotResident, "В том числе по странам:", "В том числе по субъектам:"));
         Report707.PrintKlikoTitle(ReportChapter,IIF(IsNotResident, "в том числе по странам:", "в том числе по субъектам:"), "1", @StCount);
  
         if( IsNotEmpty )  
            q1 = "select T_COUNTRY, count(T_CLIENTCODE) cnt, " + 
                 "       round(sum(case when itog >= 0 then a5 else 0 end), 0) a5_plus, " + 
                 "       sum(case when itog >= 0 then a6 else 0 end) a6_plus, " +
                 "       round(sum(case when itog >= 0 then a7 else 0 end)/1000, 2) a7_plus, " +   
                 "       round(sum(case when itog >= 0 then a8 else 0 end)/1000, 2) a8_plus, " +   
                 "       round(sum(case when itog >= 0 then a9 else 0 end)/1000, 2) a9_plus, " +
                 "       round(sum(case when itog < 0 then a5 else 0 end), 0) a5_minus, " + 
                 "       sum(case when itog < 0 then a6 else 0 end) a6_minus, " +
                 "       round(sum(case when itog < 0 then a7 else 0 end)/1000, 2) a7_minus, " +   
                 "       round(sum(case when itog < 0 then a8 else 0 end)/1000, 2) a8_minus, " +   
                 "       round(sum(case when itog < 0 then a9 else 0 end)/1000, 2) a9_minus " + 
                 "  from ( select T_COUNTRY, T_CLIENTCODE, " +
                 "                NVL(sum(T_A5), 0) a5, " +
                 "                NVL(sum(T_A6), 0) a6, " +
                 "                NVL(sum(T_A7), 0) a7, " +
                 "                NVL(sum(T_A8), 0) a8, " +
                 "                NVL(sum(T_A9), 0) a9, " + 
                 "                NVL(sum(T_ITOG), 0) itog " +
                 "           from " + tmp_table +
                 "          where T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + 
                 "            and T_FL " + IIF(SubSection == SUBSECTION_FL, " = 'X' ", " != 'X' ") + 
                 "          group by T_CLIENTCODE, T_COUNTRY ) " +
                 " group by T_COUNTRY order by T_COUNTRY asc";     

            cmd1 = DL_RSDCommand(q1);
            rs1 = cmd1.execute();
            dbg(q1);

            var CountCountry = 0;
            while( rs1.MoveNext() )
              dbg("Country: " + string(rs1.t_country));
              
              // Golovkin 17.09.2020 Адаптация 4927у
              if (rs1.t_country == "29") cc = rs1.cnt - c29;
              elif (rs1.t_country == "45") cc = rs1.cnt - c45;
              elif (rs1.t_country == "61") cc = rs1.cnt - c61;
              elif (rs1.t_country == "89") cc = rs1.cnt - c89;
              elif (rs1.t_country == "92") cc = rs1.cnt - c92;
              else  cc = rs1.cnt; end;

              Report707.PrintRepTableLine(rs1.t_country, cc, //rs1.cnt, // Golovkin 17.09.2020 Адаптация 4927у
                                          rs1.a5_plus, rs1.a6_plus, rs1.a7_plus, rs1.a8_plus, rs1.a9_plus, 
                                          rs1.a5_minus, rs1.a6_minus, rs1.a7_minus, rs1.a8_minus, rs1.a9_minus);

              Report707.PrintKlikoValLine(IIF(IsNotResident,"",rs1.t_country), IIF(IsNotResident,rs1.t_country,""), cc/*rs.cnt*/,   
                                          rs1.a5_plus, rs1.a6_plus, rs1.a7_plus, rs1.a8_plus, rs1.a9_plus, 
                                          rs1.a5_minus, rs1.a6_minus, rs1.a7_minus, rs1.a8_minus, rs1.a9_minus,
                                          "1", @StCount, @PrCount, (CountCountry > 0));
              CountCountry = CountCountry + 1;
            end;
         else
            Report707.PrintRepTableLine("", 0);
            Report707.PrintKlikoValLine("", "", "", // EMPTY LINE
                                        "", "", "", "", "", 
                                        "", "", "", "", "", 
                                        "1", @StCount, @PrCount, false);
        end;
      end;

      return PrCount;
    end;

    private macro PrintTable_1()
      var StCount = 0; //сквозная нумерация строк данных для kliko
      var PrCount = 0; //сквозная нумерация пунктов для kliko
      var DS_ProgressIndicator = TProgressBar();
      var DS_Nrec = 11;
      DS_ProgressIndicator.init(DS_Nrec, "Печать сведений о брокерской деятельности", "Печать сведений о брокерской деятельности" );

      PrintSubsectionTable_1("Всего", SUBSECTION_ALL, NULL, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Физические лица - резиденты", SUBSECTION_FL, false, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Физические лица - нерезиденты", SUBSECTION_FL, true, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Юридические лица - резиденты", SUBSECTION_UL, false, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Юридические лица - нерезиденты", SUBSECTION_UL, true, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты, являющиеся квалифицированными инвесторами", SUBSECTION_KI, NULL, NULL, @StCount, @PrCount); 
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Активные клиенты", SUBSECTION_ACTIVE, NULL, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты со стандартным уровнем риска", SUBSECTION_RISK, NULL, RISKLEVEL_USUAL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты с повышенным уровнем риска", SUBSECTION_RISK, NULL, RISKLEVEL_ELEVATED, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты с особым уровнем риска", SUBSECTION_RISK, NULL, RISKLEVEL_SPECIAL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты без установленного уровня риска", SUBSECTION_RISK, NULL, RISKLEVEL_NOTINSTALL, @StCount, @PrCount);
      DS_ProgressIndicator.Remove; 
    end;

    private macro getRate90(bo, fiid, d, fiid_nom, dealcode:@STRING, deal_fi:@string, deal_price:@string)
      var q, cmd, rs, mp, rate;
      //цену сделки считаем без НКД, НКД потом посчитаем отдельно
      q =   " select NVL(chg.t_oldcost1, leg.t_cost) /NVL(chg.t_oldprincipal, leg.t_principal) mp, leg.t_cfi as fiid, t.t_dealcode code " +
            "   from ddl_tick_dbt t, ddlrq_dbt rq, ddl_leg_dbt leg, dsptkchng_dbt chg " +
               " where t.t_bofficekind = ? " +
               " and t.t_dealstatus !=  " + DL_PREPARING + 
               " and t.t_dealid = rq.t_docid  " +
               " and t.t_bofficekind = rq.t_DocKind   " +
               " and rq.t_fiid = ? " +
               " and ? - t.t_dealdate <= 90  " +
               " and ? - t.t_dealdate >= 0  " +
               " and leg.t_dealid = t.t_dealid  " +
               " and leg.t_legkind = 0  " +
            "     and chg.t_dealid(+) = t.t_dealid " +
            "     and chg. t_oldinstance(+) = 0 " +
               " order by t.t_dealdate desc ";
      cmd = DL_RSDCommand(q);
      cmd.AddParam(bo);
      cmd.AddParam(fiid);
      cmd.AddParam(d);
      cmd.AddParam(d);
      rs = cmd.execute();

      if (not rs.MoveNext)
         return NULL;
      end;

      rate = 1.0;

      if (int(rs.fiid) != NATCUR)
         /*Если валюта номинала отличается от валюты сделки, то пересчитаем в валюту номинала*/
         if (rs.fiid != fiid_nom)
           rate = GetRateOnDateCrossDbl(d, rs.fiid, fiid_nom, false);
         else
           rate = GetRateOnDateCrossDbl(d, rs.fiid, NATCUR, false);
         end;
         if ((rate == NULL) or (rate == 0.0))
            return NULL;
         end;
      end;
      
      /*Если валюта сделки отличается от валюты номинала, то тогда умножаем на курс*/
      if (/*(rs.is_persent == "X") or */(rs.fiid != fiid_nom))
        mp = rate * rs.mp;
      else
        mp = rs.mp;
      end;
      
      dealcode = rs.code;
      deal_fi = rs.fiid;
      deal_price = rs.mp;
      
      return mp;
    end;

    PRIVATE MACRO InsTMP(PartyId, ContrID, ClientCode, Client, ClientFull, A01, ResidenceStatus, RegisterType, Activity, QualifedInvestor, ContractNumber, ContractOpenDate, ContractCloseDate, Industry, SubKind, Account, CR, A05, A06, A07, A08, A09, Itog, RiskLevel)
      var insq = "INSERT INTO " + tmp_table + " (T_PARTYID, T_CONTRID, T_CLIENTCODE, T_CLIENT, T_CLIENTFULL, T_COUNTRY, T_NOTRESIDENT, T_FL, T_ACTIVE, T_KI, T_NUMBER, T_DATEBEGIN, T_DATECLOSE, T_INDUSTRY, T_SUBKIND, T_ACCOUNT, T_CR, T_A5, T_A6, T_A7, T_A8, T_A9, T_ITOG, T_RISKLEVEL) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
      var inscmd;
      inscmd = RSDCommand (insq);
      inscmd.NullConversion = false;
      inscmd.addParam( "", RSDBP_IN, PartyId);
      inscmd.addParam( "", RSDBP_IN, ContrID);
      inscmd.addParam( "", RSDBP_IN, ClientCode);
      inscmd.addParam( "", RSDBP_IN, Client);
      inscmd.addParam( "", RSDBP_IN, ClientFull);
      inscmd.addParam( "", RSDBP_IN, A01);
      inscmd.addParam( "", RSDBP_IN, iif(ResidenceStatus == "X", "X", "0"));
      inscmd.addParam( "", RSDBP_IN, iif(RegisterType == "X", "X", "0"));
      inscmd.addParam( "", RSDBP_IN, iif(Activity == "X", "X", "0"));
      inscmd.addParam( "", RSDBP_IN, iif(QualifedInvestor == "X", "X", "0"));
      inscmd.addParam( "", RSDBP_IN, ContractNumber);
      inscmd.addParam( "", RSDBP_IN, ContractOpenDate);
      inscmd.addParam( "", RSDBP_IN, ContractCloseDate);
      inscmd.addParam( "", RSDBP_IN, Industry);
      inscmd.addParam( "", RSDBP_IN, SubKind);
      inscmd.addParam( "", RSDBP_IN, Account);
      inscmd.addParam( "", RSDBP_IN, CR);
      inscmd.addParam( "", RSDBP_IN, round(A05/1000, 5));/*для расшифровки округлим в тыс. до 2-ух знаков*/ // Golovkin до 5-ти
      inscmd.addParam( "", RSDBP_IN, round(A06/1000, 2));/*для расшифровки округлим в тыс. до 2-ух знаков*/
      inscmd.addParam( "", RSDBP_IN, A07);
      inscmd.addParam( "", RSDBP_IN, A08);
      inscmd.addParam( "", RSDBP_IN, A09);
      inscmd.addParam( "", RSDBP_IN, Itog);
      inscmd.addParam( "", RSDBP_IN, RiskLevel);
      inscmd.execute();
    end;

    PRIVATE MACRO InsDealTMP(PartyId, ContrID, ClientCode, ClientFull, A01, ContractNumber, AvrKind, AvrType, FiName, ISIN, SecQnty, Nominal, FIID, Price, Rate, Cost, NKD)
      var insq = "INSERT INTO D707DEAL_TMP (T_PARTYID, T_CONTRID, T_CLIENTCODE, T_CLIENTFULL, T_COUNTRY, T_NUMBER, T_AVRKIND, T_AVRTYPE, "
                 "                           T_FINAME, T_ISIN, T_SECQNTY, T_NOMINAL, T_FIID, T_MARKETPRICE, T_RATE, T_TOTALCOST, T_NKD) "
                 "                  VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
      var inscmd;
      inscmd = RSDCommand (insq);
      inscmd.NullConversion = false;
      inscmd.addParam( "", RSDBP_IN, PartyId);
      inscmd.addParam( "", RSDBP_IN, ContrID);
      inscmd.addParam( "", RSDBP_IN, ClientCode);
      inscmd.addParam( "", RSDBP_IN, ClientFull);
      inscmd.addParam( "", RSDBP_IN, string(A01));
      inscmd.addParam( "", RSDBP_IN, ContractNumber);
      inscmd.addParam( "", RSDBP_IN, AvrKind);
      inscmd.addParam( "", RSDBP_IN, AvrType);
      inscmd.addParam( "", RSDBP_IN, FiName);
      inscmd.addParam( "", RSDBP_IN, ISIN);
      inscmd.addParam( "", RSDBP_IN, SecQnty);
      inscmd.addParam( "", RSDBP_IN, Nominal);
      inscmd.addParam( "", RSDBP_IN, FIID);
      inscmd.addParam( "", RSDBP_IN, Price);
      inscmd.addParam( "", RSDBP_IN, Rate);
      inscmd.addParam( "", RSDBP_IN, Cost);
      inscmd.addParam( "", RSDBP_IN, NKD);
      inscmd.execute();
    END;

    private macro CheckPartyType( PartyId, PartyType )
      var partyown = TBFile("partyown");
      var isPartyType = false;

      partyown.KeyNum = 0;
      partyown.rec.PartyID   = PartyId;
      partyown.rec.PartyKind = PartyType;
      if (GetEQ(partyown))
        isPartyType = true;
      end;

      return isPartyType;
    end;

    private macro GetCountryCode(PartyCode):string
      var q = "select t_codenum3 code from dcountry_dbt where t_CodeLat3 = ? ";
      var cmd = DL_RSDCommand(q);
      cmd.AddParam(PartyCode);
      var rs = cmd.execute();

      if (rs.MoveNext())
        return string(rs.code);
      end;

      return "999";
    end;

    VAR Query;
    var ClientCode, Client, ClientFull, A01, ResidenceStatus, RegisterType, Activity, QualifedInvestor, ContractNumber, ContractOpenDate, ContractCloseDate, Industry, Account, CrNom, A05, NumDEPO, SecQnty, MarketSecCost, A06, A07, A08, A09;
    var money_sum = 0;
    var avr_sum = 0;
    var tmp_sum = 0;
    var nkd_sum = 0;
    var f7_secur_sum = 0;
    var f7_dv_sum = 0;
    var f8 = 0;
    var f8_secur_sum = 0;
    var f8_dv_sum = 0;
    var f9 = 0;
    var f9_secur_sum = 0;
    var f9_dv_sum = 0;
    var Select;
    var find, CourceSinceDate, rate, market_price, pfi;
    var vn, q_amount, cmd_amount, rs_amount, pos_amount = $0.0, NRec = 0;
    var cf_price, mf_price, fw_price, fw_ba_price, op_price, op_ba_price, other_price, q_other, cmd_other, rs_other;
    var RS_ProgressIndicator = TProgressBar();
    var da = TArray;
    var da_num = 0;
    var q_acc, cmd_acc, rs_acc;
    var q_cntr, cmd_cntr, rs_cntr;
    var q_cl, cmd_cl, rs_cl;
    var avr_q, avr_cmd, avr_rs;
    var A5 = $0.0, A6 = $0.0, A7 = $0.0, A8 = $0.0, A9 = $0.0, Itog = $0.0;
    var ok, cr = $0, i; 

if (not DEBUG_NO_CALC)

    /***********************************************************************************************/
    Query = "select t.t_partyid as party, t.t_shortname sname, t.t_name name, Rsb_Secur.DL_GetNotResidentForBrokClientRep(t.t_partyid, ?) rsdnt, t.t_LegalForm legal, t.t_NRCountry t_NameObject, sfcontr.t_ID, sfcontr.t_number sfnum, sfcontr.t_datebegin sfbeg, sfcontr.t_dateclose sfcls, sfcontr.t_servkind sfsk, sfcontr.t_ServKindSub subkind, " +       
            " RSI_RSBPARTY.GetPartyCode(t.t_PartyID, 1) as ClientCode, "
            " case when "
                    "( EXISTS (SELECT 1 " +
                    "  FROM DV_SCQINVHIST hist " +
                    " WHERE hist.t_PartyID   = t.t_PartyID" +
                    "   AND hist.t_State     = 1 " +
                    "   AND hist.t_BegDate  <= ? " +
                    "   AND (hist.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY') OR hist.t_EndDate > ?))) then 1 else 0 end as qi, "
                    " case when ("
                        "exists(select 1" +
                        "         from dsfcontr_dbt sf " +
                        "        where sf.t_PartyID = t.t_PartyID and sf.t_id = sfcontr.t_id and (" +
                        "              sf.t_ServKind = " + string(PTSK_STOCKDL) + " AND " +
                                      " exists (SELECT /*+ index(tick DDL_TICK_DBT_IDX_u1)*/ 1 " +
                                      "         FROM ddl_tick_dbt tick " +
                                      "         WHERE TICK.T_BOFFICEKIND = " + string(DL_SECURITYDOC) +
                                      "         AND tick.t_DealStatus > 0 " +
                                      "         AND (Tick.t_ClientContrID = sf.t_ID /*OR (Tick.t_PartyContrID = sf.t_ID AND Tick.t_IsPartyClient = 'X')*/) " +
                                      "         AND tick.t_DealDate BETWEEN ? AND ? " +
                                      "         AND (Tick.t_ClientID = t.t_partyID /*OR (Tick.t_PartyID = t.t_partyID AND Tick.t_IsPartyClient = 'X')*/))) " +
                    ") or "+ // Golovkin 15.04.2021 ID : 526738 Разбил на два подзапроса, чтобы подтягивались два индекса
                        "exists(select 1" +
                        "         from dsfcontr_dbt sf " +
                        "        where sf.t_PartyID = t.t_PartyID and sf.t_id = sfcontr.t_id and (" +
                        "              sf.t_ServKind = " + string(PTSK_STOCKDL) + " AND " +
                                      " exists (SELECT /*+ index(tick DDL_TICK_DBT_IDX_u2)*/ 1 " +
                                      "         FROM ddl_tick_dbt tick " +
                                      "         WHERE TICK.T_BOFFICEKIND = " + string(DL_SECURITYDOC) +
                                      "         AND tick.t_DealStatus > 0 " +
                                      "         AND (/*Tick.t_ClientContrID = sf.t_ID OR*/ (Tick.t_PartyContrID = sf.t_ID AND Tick.t_IsPartyClient = 'X')) " +
                                      "         AND tick.t_DealDate BETWEEN ? AND ? " +
                                      "         AND (/*Tick.t_ClientID = t.t_partyID OR*/ (Tick.t_PartyID = t.t_partyID AND Tick.t_IsPartyClient = 'X')))) " +
                    ") or "+
                        "exists(select 1" +
                        "         from dsfcontr_dbt sf " +
                        "        where sf.t_PartyID = t.t_PartyID and sf.t_id = sfcontr.t_id and (" +
                        "              sf.t_ServKind in (" + string(PTSK_DV) + "," + string(PTSK_CM) + ") AND " +
                                " (exists(SELECT 1 " +
                                "         FROM DDVNDEAL_DBT dvndeal " +
                                "         WHERE DVNDEAL.T_CLIENT = T.T_PARTYID " +
                                "           AND DVNDEAL.T_CLIENTCONTR = sf.t_ID " +
                                "           AND DVNDEAL.T_DATE BETWEEN ? AND ? " +
                                "           AND DVNDEAL.T_STATE > 0) " +
                                "      OR " +
                                " exists (SELECT /*+ index(dvdeal DDVDEAL_DBT_IDX_u1)*/ 1 " +
                                "         FROM DDVDEAL_DBT dvdeal" +
                                "         WHERE DVDEAL.T_CLIENT = T.T_PARTYID " +
                                "         AND DVDEAL.T_CLIENTCONTR = sf.t_ID " +
                                "         AND DVDEAL.T_DATE BETWEEN ? AND ? " +
                                "         AND DVDEAL.T_STATE > 0)) " +
                    "))) then 1 else 0 end as is_active, " +
            " sfc.t_number prime_contr, " +
            " NVL(Rsb_Secur.GetMainObjAttr(" + OBJTYPE_PARTY + ", LPAD(t.t_partyid, 10, '0'), " + PARTY_ATTR_GROUP_RISKLEVEL + ", ?), 0) as risklevel " +
            //" NVL(Rsb_Secur.GetMainObjAttr(" + OBJTYPE_BROKERCONTR_DL + ", LPAD(dlc.t_dlcontrid, 34, '0'), " + BROKERCONTR_GROUP_RISKLEVEL + ", ?), 0) as risklevel " +
            "  from dparty_dbt t, dsfcontr_dbt sfcontr, ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sfc " +
            " where t.t_PartyID <> " + string({OurBank}) + 
            " and mp.t_sfcontrid = sfcontr.t_id" +
            " and dlc.t_dlcontrid = mp.t_dlcontrid" +
            " and sfc.t_id = dlc.t_sfcontrid " +
//"and t.t_PartyID = 114800 and sfcontr.t_Id = 24795 " + 
//"and t.t_PartyID = 137586 " +  
//"and t.t_PartyID = 115864 " + 
              " and sfcontr.t_PartyID = t.t_PartyID" +
              " and (" +
              "         (sfcontr.t_DateClose > ?" +
              "             or" +
              "         sfcontr.t_DateClose = ?)" +
              "         and" +
              "         sfcontr.t_DateBegin <= ?" +
              "     )" +
              " and (" +
IIF(m_IsSecur, "          sfcontr.t_ServKind = " + string(PTSK_STOCKDL), "") +
IIF(m_IsDV and m_IsSecur, " or ", "") +
IIF(m_IsDV,    "          sfcontr.t_ServKind in (" + string(PTSK_DV) +","+ string(PTSK_CM) +")", "") + 
IIF(m_IsVA and (m_IsDV or m_IsSecur), " or ", "") +
IIF(m_IsVA,    "          sfcontr.t_ServKind = " + string(PTSK_VEKSACC) + " and not exists(select 1 from ddlcontr_dbt dlcontr where dlcontr.t_SfContrID = sfcontr.t_ID)", "") +
IIF(m_IsDepo and (m_IsDV or m_IsSecur or m_IsVA), " and ", "") +
IIF(m_IsDepo,  "          sfcontr.t_ServKind = " + string(PTSK_DEPOS), "") +
              "     ) " +
              " ORDER BY t.t_PartyID, sfc.t_number, 15 desc "; /*GAA:527609, old: 16  */
              //" ORDER BY t.t_PartyID";
              //" ORDER BY t.t_PartyID ) s  where o.t_objecttype = 3 and o.t_groupid = 12 and o.t_attrid in (18, 11, 60, 53, 56) and o.t_object = s.party";
      Select = DL_RSDCommand(Query);
      Select.AddParam(H1_ReportDate());
      Select.AddParam(H1_ReportDate());
      Select.AddParam(H1_ReportDate());
      Select.AddParam(Report707.m_BegDate);
      Select.AddParam(H1_ReportDate());
      Select.AddParam(Report707.m_BegDate); // Golovkin 15.04.2021 ID : 526738
      Select.AddParam(H1_ReportDate());
      Select.AddParam(Report707.m_BegDate);
      Select.AddParam(H1_ReportDate());
      Select.AddParam(Report707.m_BegDate);
      Select.AddParam(H1_ReportDate());
      Select.AddParam(H1_ReportDate());
      Select.AddParam(H1_ReportDate());
      Select.AddParam(date(0, 0, 0));
      Select.AddParam(H1_ReportDate());
/*******************************************************************************
********************************************************************************
********************************************************************************/

    var DS_ProgressIndicator = TProgressBar();
    var DS_Nrec = Select.GetCount();
    var q, cmd, rs;
    var old_party = -1;
    var group;
    var IfNeedNKD = false, FindCourseFi = 0.0, DealCode = "", DealFiid = NULL, DealPrice = NULL, НКД = 0.0;
    var old_prime_contr = "";

    if (DEBUG_TMP_TABLE)
        execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE TABLE DAIDECR_DBT (T_PARTYID NUMBER, T_CONTRID NUMBER, T_CLIENTCODE VARCHAR(35), T_CLIENT VARCHAR(60), T_CLIENTFULL VARCHAR(320), T_COUNTRY VARCHAR(5), T_NOTRESIDENT CHAR, T_FL CHAR, T_ACTIVE CHAR, T_KI CHAR, T_NUMBER VARCHAR(20), T_DATEBEGIN DATE, T_DATECLOSE DATE, T_INDUSTRY NUMBER, T_SUBKIND NUMBER, T_ACCOUNT VARCHAR(25), T_CR NUMBER, T_A5 NUMBER, T_A6 NUMBER, T_A7 NUMBER, T_A8 NUMBER, T_A9 NUMBER, T_ITOG NUMBER, T_RISKLEVEL NUMBER)'; EXCEPTION WHEN OTHERS THEN NULL; END; ");
    else
        execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE DAIDECR_TMP (T_PARTYID NUMBER, T_CONTRID NUMBER, T_CLIENTCODE VARCHAR(35), T_CLIENT VARCHAR(60), T_CLIENTFULL VARCHAR(320), T_COUNTRY VARCHAR(5), T_NOTRESIDENT CHAR, T_FL CHAR, T_ACTIVE CHAR, T_KI CHAR, T_NUMBER VARCHAR(20), T_DATEBEGIN DATE, T_DATECLOSE DATE, T_INDUSTRY NUMBER, T_SUBKIND NUMBER, T_ACCOUNT VARCHAR(25), T_CR NUMBER, T_A5 NUMBER, T_A6 NUMBER, T_A7 NUMBER, T_A8 NUMBER, T_A9 NUMBER) ON COMMIT PRESERVE ROWS'; EXCEPTION WHEN OTHERS THEN NULL; END; ");
        execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE D707DEAL_TMP (T_PARTYID NUMBER, T_CONTRID NUMBER, T_CLIENTCODE VARCHAR2(35 BYTE), T_CLIENTFULL VARCHAR2(320 BYTE), T_NUMBER VARCHAR2(20 BYTE), T_COUNTRY  VARCHAR2 (5 BYTE), T_AVRKIND VARCHAR2 (35 BYTE), T_AVRTYPE VARCHAR2 (35 BYTE), T_FINAME VARCHAR2(50 BYTE), T_ISIN VARCHAR2(25 BYTE), T_SECQNTY NUMBER, T_NOMINAL NUMBER, T_FIID NUMBER(10), T_MARKETPRICE NUMBER, T_RATE NUMBER, T_TOTALCOST NUMBER, T_NKD NUMBER) ON COMMIT PRESERVE ROWS'; EXCEPTION WHEN OTHERS THEN NULL; END;");
    end;
    execSQL("DELETE FROM " + tmp_table);
    execSQL("DELETE FROM D707DEAL_TMP");

    if(DS_Nrec > 0)
      DS_ProgressIndicator.init(DS_Nrec, "Сбор данных по договорам клиентов", "Сбор данных по договорам клиентов" );

      var DS = Select.execute();
      while (ds.MoveNext())
        if (old_party != int(ds.party))
          ClientCode = Client = ClientFull = A01 = ResidenceStatus = RegisterType = Activity = QualifedInvestor = ContractNumber = ContractOpenDate = ContractCloseDate = Industry = Account = CrNom = A05 = NumDEPO = SecQnty = MarketSecCost = A06 = A07 = A08 = A09 = "";
          ClientCode = string(ds.ClientCode);
          Client = ds.sname;
          ClientFull = ds.name;

          ResidenceStatus = ds.rsdnt;
          RegisterType = IIF(ds.legal != 1, "X", 0);

          if (ResidenceStatus == "X")
            if (CheckPartyType(ds.party, PTK_INTERNATIONAL_ORG) == true)
              if(hasOGRN(ds.party))
                A01 = "996";
              else
                A01 = "998";
              end;
            else
              A01 = GetCountryCode(ds.t_NameObject);
            end;
          else
            A01 = GetOkatoCode(ds.party, H1_ReportDate());
            if (A01 == "")
              A01 = "00";
            end;
          end;
          if ((A01 == "") or (A01 == null))
            A01 = "999";
          end;

          Activity = 0;
/*// Golovkin перенес
          if (ds.is_active)
            Activity = "X";
          end;
*/
          if (ds.qi)
            QualifedInvestor = "X";
          else
            QualifedInvestor = 0;
          end;
        end;
        old_party = int(ds.party);

        A5 = $0.0;
        A6 = $0.0;
        A7 = $0.0;
        A8 = $0.0;
        A9 = $0.0;
        Itog = $0.0;

        if (old_prime_contr != ds.prime_contr)
          if (ds.is_active)
            Activity = "X";
          else
            Activity = 0;
          end;
        end;

        old_prime_contr = ds.prime_contr;

        if (ds.sfsk == PTSK_STOCKDL)

           q = " select mc.t_account, mc.t_currency vn, fin.t_fiid fiid, fin.t_name fi_name, rsb_account.restac(mc.t_account, mc.t_currency, ?, mc.t_Chapter, null) count, " 
               " acc.t_Kind_Account ka, fin.t_facevaluefi fvfi, a.t_isin, av_k.t_name as avr_kind, "
               "        RSI_RSB_FIInstr.FI_GetNominalOnDate(fin.t_fiid, ?) as nominal, "
               " NVL(rsb_secur.GetObjAttrName(12, 1, NVL(rsb_secur.GetMainObjAttr(12, LPAD (fin.t_fiid , 10, '0'), 1, ?), 0)),'') as avr_type "              
               "   from dmcaccdoc_dbt mc, dfininstr_dbt fin, daccount_dbt acc, davoiriss_dbt a, davrkinds_dbt av_k "
               "  where  mc.t_owner = ?  and mc.t_clientcontrid = ? "
               "    and mc.t_Chapter = 22 "
               "    and mc.t_CatID IN (352, 364, 365) "
               "    and mc.t_iscommon = CHR(88)"
               "    and fin.t_fiid = mc.t_fiid  "
               "    and fin.t_fiid = a.t_fiid  "
               "    and acc.t_account = mc.t_account  "
               "    and acc.t_chapter =  mc.t_Chapter "
               "    and fin.t_avoirkind = av_k.t_avoirkind "
               "    and av_k.t_fi_kind = fin.t_fi_kind"
               "    and acc.t_code_currency = mc.t_currency ";

           cmd = DL_RSDCommand(q);
           cmd.AddParam(H1_ReportDate());
           cmd.AddParam(H1_EndWorkDate());//номинал смотрим на последний рабочий день
           cmd.AddParam(H1_ReportDate());
           cmd.AddParam(ds.party);
           cmd.AddParam(ds.ID);
           rs = cmd.execute();

           while (rs.MoveNext())
             /*Алгоритм определения стоимости:
               1. Рыночная цена;
               2. Котировка Bloomberg;
               //3. По сделке за последние 90 дней + НКД;
               4. Мотивированное суждение */
             IfNeedNKD = false;
             FindCourseFi = 0.0;
             market_price = NULL;
             DealCode = "";
             DealFiid = NULL;
             DealPrice = NULL;
             НКД = 0.0;
             
             //find = ПолучитьКурсЗаданногоTипа(@market_price, rs.FIID, rs.vn, RATETYPE_MARKET_PRICE, H1_ReportDate(), true, @CourceSinceDate);
             if (rs.count == 0)
               continue;
             end;

             rate = 1.0;
             if (int(rs.fvfi) != NATCUR)
               rate = GetRateOnDateCrossDbl(H1_ReportDate(), rs.fvfi, NATCUR, false);
             end;
             if ((rate != NULL) and (rate != 0.0))
                if (int(rs.vn) != NATCUR)
                  /*Рыночная цена*/
                  if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_MARKET_PRICE, @FindCourseFi))
                    market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_MARKET_PRICE);
                    if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                      rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                    end;
                  end;
                  /*Котировка Bloomberg*/
                  if ((market_price == NULL) or (market_price == 0.0))
                    if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_BLOOMBERG_PRICE, @FindCourseFi))
                      market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_BLOOMBERG_PRICE);
                      if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                        rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                      end;
                    end;
                  end;
                  if ((market_price == NULL) or (market_price == 0.0))
                    msgbox(rs.fi_name + ";" + rs.isin + ";" + H1_EndWorkDate() +";"+ H1_EndWorkDate() +";;BLOOMBERG;1700" );
                  end;
                  /*Последняя сделка за 90 дней*/
                  //if ((market_price == NULL) or (market_price == 0.0))
                  //  market_price = getRate90(101, rs.vn, H1_ReportDate(), rs.fvfi/*валюта номинала*/, @DealCode, @DealFiid, @DealPrice);
                  //  if (market_price != NULL)
                  //    msgbox("1770 : Котировку для ц/б " + rs.fi_name + " равную " + market_price + " определил по сделке " + DealCode);
                  //    IfNeedNKD = true;
                  //  end;
                  //end;
                  /*Мотивированное суждение*/
                  if ((market_price == NULL) or (market_price == 0.0))
                    if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_REASONED_PRICE, @FindCourseFi))
                      market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_REASONED_PRICE);
                      if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                        rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                      end;
                      if (market_price != NULL)
                        msgbox("1782 : Котировку для ц/б " + rs.fi_name + " равную " + market_price + " определил по курсу \"Мотивированное суждение\"");
                      end;
                    end;
                  end;
                  if ((market_price == NULL) or (market_price == 0.0))
                  msgbox("1700 : Не задана котировка для ц/б " + rs.fi_name + " на " + H1_EndWorkDate());
                    continue;
                  end;
                else
                  market_price = 1.0;
                end;
                tmp_sum = rate * market_price * iif(rs.ka == "А", -rs.count, rs.count);
                if (IfNeedNKD)
                  НКД = rate * СуммаКупона(rs.vn, iif(rs.ka == "А", -rs.count, rs.count), H1_ReportDate());
                  tmp_sum = tmp_sum + НКД;
                end;
              else
                tmp_sum = 0.0;
                msgbox("1714 : Не определен курс для ФИ " + rs.fvfi);
              end;
              InsDealTMP(ds.party, ds.ID, ClientCode, ClientFull, A01, string(ds.sfnum), rs.avr_kind, rs.avr_type, rs.fi_name, rs.isin, abs(rs.count),
                         rs.nominal, IIF(DealFiid == NULL, FindCourseFi, DealFiid), IIF(DealPrice == NULL, market_price, DealPrice),
                         IIF(DealFiid == NULL, rate, GetRateOnDateCrossDbl(H1_ReportDate(), DealFiid, NATCUR, false)), tmp_sum,
                         НКД);
              A6 = A6 + tmp_sum;
            end;

          q =
            "select tick.t_pfi pfi, rq.t_kind kind, rq.t_amount amount, rq1.t_fiid vn, Rsb_Secur.IsSale(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) IsSale, Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) IsRepo, rq1.t_type type " +/*CHVA*/
            "  from ddl_tick_dbt tick, V_RQHIST rq, dfininstr_dbt fin, ddlrq_dbt rq1 " +
            " where tick.t_clientid = ? " +
            "   and tick.t_clientcontrid = ? " +
            "   and tick.t_bofficekind = " + DL_SECURITYDOC + " " +
            "   and tick.t_dealstatus != " + DL_PREPARING + " " +
            "   and tick.t_dealid = rq1.t_docid " +
            "   and tick.t_bofficekind = rq1.t_DocKind " +
            "   AND rq.t_rqid = rq1.t_id "
            "   and tick.t_dealdate <= ? " +
            "   and rq1.t_type in (" + DLRQ_TYPE_PAYMENT + "," + DLRQ_TYPE_INCREPO + "," + DLRQ_TYPE_COMISS + ")" + 
            "   AND 1 = CASE WHEN  rq1.t_type = " + DLRQ_TYPE_COMISS + " then 1 WHEN rq.t_state NOT IN (" + DLRQ_STATE_EXEC + "," + DLRQ_STATE_REJECT + ") THEN 1 ELSE 0 END "
            "   and rq.t_instance = (select MAX(h1.t_instance) from V_RQHIST h1 where h1.t_rqid = rq.t_rqid AND 1 = CASE WHEN  rq1.t_type = 6 then 1 WHEN h1.t_changedate <= ? THEN 1 ELSE 0 END) " +
            "   and (rq1.t_factdate > ? or rq1.t_factdate = to_date('01010001', 'ddmmyyyy')) " +
            "   and fin.t_fiid = rq1.t_fiid ";

          cmd = DL_RSDCommand(q);
          cmd.AddParam(ds.party);
          cmd.AddParam(ds.ID);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          rs = cmd.execute();

          while (rs.MoveNext)
            if ((iif(rs.IsRepo, iif(rs.IsSale, 0, 1), rs.IsSale) == rs.kind)  and (rs.type ==  DLRQ_TYPE_PAYMENT))
               continue;
            end;
            tmp_sum = 0;
            if (Int(rs.vn) != NATCUR)
              cr = GetRateOnDateCrossDbl(H1_ReportDate(), int(rs.vn), NATCUR, true);
              tmp_sum = cr * rs.amount;
            else
              tmp_sum = ABS(money(rs.amount));
            end;
            A7 = A7 + iif(rs.kind == DLRQ_KIND_REQUEST, tmp_sum, -tmp_sum);
          end;
/*
           q = " select mc.acc, mc.cur, rsb_account.restac(mc.acc, mc.cur, ?, mc.t_Chapter, null) sum, acc.t_Kind_Account ka   " +
                 "       from " +
                 "           (select m.t_account acc, m.t_currency cur, m.t_Chapter " +
                 "              from dmcaccdoc_dbt m " +
                 "            where m.t_CatNum = 5087  " +
                 "                and m.t_owner = ? " +
                 "                and m.t_clientcontrid = ? " +
                 "             group by m.t_account, m.t_currency, m.t_Chapter " +
                 "           ) mc, daccount_dbt acc " +
                 "     where acc.t_account = mc.acc  "
                 "       and acc.t_chapter =  mc.t_Chapter "
                 "       and acc.t_code_currency = mc.cur ";
           cmd = DL_RSDCommand(q);
           cmd.AddParam(H1_ReportDate());
           cmd.AddParam(ds.party);
           cmd.AddParam(ds.ID);
           rs = cmd.execute();

           while (rs.MoveNext)
               if (money(rs.sum) != 0)
                  rs.sum = iif(rs.ka == "А", -rs.sum, rs.sum);
                  tmp_sum = 0;
                  if (Int(rs.cur) != NATCUR)
                    cr = GetRateOnDateCrossDbl(H1_ReportDate(), int(rs.cur), NATCUR, true);
                    tmp_sum = cr * money(rs.sum);
                  else
                    tmp_sum = money(rs.sum);
                  end;
                  A7 = A7 - tmp_sum;
               end;
            end;
*/
        end;

        if ((ds.sfsk == PTSK_VEKSACC) /*AND (0)*/)/*PNV 518846*/
           q = "select (RSI_RSB_FIInstr.ConvSum(pm.t_baseamount, pm.t_basefiid, ?, ?, 0 ) * (CASE WHEN pm.t_receiver = t.t_ClientId THEN 1 ELSE -1 END)) as t_rest " +
               "  from ddl_tick_dbt t, dpmpaym_dbt pm " +
               " where t.t_clientid = ? " +
               "   and t.t_clientcontrid = ? " +
               "   and t.t_dealstatus = " + string(DL_READIED) +
               "   and pm.t_dockind = t.t_bofficekind " +
               "   and t.t_dealdate <= ? " +
               "   and (t.t_closedate > ? or t.t_closedate = to_date('01010001', 'ddmmyyyy')) " +
               "   and pm.t_documentid = t.t_dealid " +
               "   and pm.t_valuedate > ? " +
               "   and pm.t_paymstatus <> "+PM_REJECTED +
               "   and pm.T_PURPOSE in ("+string(CAi)+","+string(PM_PURP_VSBARTERDIFF)+","+string(PM_PURP_PRINC_RET)+","+string(PM_PURP_PERCENT)+") "+
               "   and t.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")";
          cmd = DL_RSDCommand(q);
          cmd.AddParam(NATCUR);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(ds.party);
          cmd.AddParam(ds.ID);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          rs = cmd.execute();
          while (rs.MoveNext)
            A7 = A7 + rs.rest;
          end;
        end;

        if ((ds.sfsk == PTSK_DV) or (ds.sfsk == PTSK_CM))
          q =
            " select dvn.t_dvkind kind,  " +
            "        dvn.t_id id, " +
            "        dvn.t_dockind dockind, " +
            "        dvn.t_type type, " +
            "        dvn.t_optiontype ot, " +
            "        dvn.t_optionstyle os, " +
            "        fin.t_name name, " +
            "        fin.t_fiid base_fiid, " +
            "        fin.t_fi_code fi_code, " +
            "        fin.t_fi_kind fi_kind, " +
            "        fin.t_facevaluefi vn, " +
            "        dvnfi.t_amount amount, " +
            "        -1 fiid, " +
            "        dvnfi.t_price price, " +
            "        dvnfi.t_pricefiid price_fiid, " +
            "        0 t_MaxLastPrice " +
            "   from ddvndeal_dbt dvn, ddvnfi_dbt dvnfi, doproper_dbt o, dfininstr_dbt fin " +
            "  where " +
            "     dvn.t_client = ? " +
            " and dvn.t_ClientContr = ? " +
            " and o.t_kind_operation = dvn.t_kind " +
            " and o.t_documentid = dvn.t_id " +
            " and dvn.t_date <= ? " +
            " and dvn.t_state > 0 " +
            " and exists (select 1 " +
            "               from dpmpaym_dbt p " +
            "              where p.t_dockind = dvn.t_dockind " +
            "                and p.t_documentid = dvn.t_id " +
            "                and p.t_valuedate > ? " +
            "                and p.t_paymstatus <> "+PM_REJECTED+") " +
            " and dvn.t_dvkind not in ("+DV_PCTSWAP+", "+DV_BANKNOTE_FX+") " +
            " and dvnfi.t_dealid = dvn.t_id " +
            " and dvnfi.t_type = case when dvn.T_Forvard = 'X' then "+DV_NFIType_Forward+" else "+DV_NFIType_BaseActiv+" end " +
            " and fin.t_fiid = dvnfi.t_fiid " ;
            /*" union " +
            " select fin.t_AvoirKind kind, " +
            "        dv.t_id id, " +
                     DL_DVDEAL + " dockind, " +
            "        case when dv.t_type = 'B' then 1 else 2 end type, " +
            "        0 ot, " +
            "        0 os, " +
            "        base.t_name name, " +
            "        base.t_fiid base_fiid, " +
            "        base.t_fi_code fi_code, " +
            "        base.t_fi_kind fi_kind, " +
            "        base.t_facevaluefi vn, " +
            "        dv.t_amount amount, " +
            "        dv.t_fiid fiid,  " +
            "        case when fin.t_AvoirKind = "+DERIVATIVE_FUTURES+" then dv.t_price else fd.t_strike end price, " +
            "        case when fin.t_AvoirKind = "+DERIVATIVE_FUTURES+" then fd.t_tickfiid else fd.t_strikefiid end price_fiid, " +
            "        FIRST_VALUE(DV.T_price) OVER (partition by DV.T_FIID ORDER BY DV.T_FIID, dv.t_date desc, DV.T_TIME desc) t_MaxLastPrice " +
            "   from ddvdeal_dbt dv, dfininstr_dbt fin, dfininstr_dbt base, dfideriv_dbt fd " +
            "  where  " +
            "        dv.t_client = ? " +
            "    and dv.t_ClientContr = ? " +
            "    and dv.t_type in('B','S') " +
            "    and DV.T_DATE <= ? " +
            "    and fin.t_fiid = dv.t_fiid " +
            "    and fin.t_fiid = fd.t_fiid  " +
            "    and base.t_fiid = case when nvl((select f2.T_FI_KIND from dfininstr_dbt f2 where f2.T_FIID = FIN.T_FACEVALUEFI),-1) = " + FIKIND_DERIVATIVE +
            "                           then nvl((select f2.T_FACEVALUEFI from dfininstr_dbt f2 where f2.T_FIID = FIN.T_FACEVALUEFI),-1) " +
            "                           else fin.t_facevaluefi end " +
            "    and fd.t_incirculationdate <= ? " +
            "    and exists (select 1 from ddvfipos_dbt p " +
            "                 where  " +
            "                       p.t_fiid = dv.t_fiid " +
            "                   and p.t_client = dv.t_client " +
            "                   and p.t_broker = dv.t_broker " +
            "                   and p.t_clientcontr = dv.t_clientcontr " +
            "                   and p.t_brokercontr = dv.t_brokercontr " +
            "                   and p.t_department = dv.t_department " +
            "                   and p.t_genagrid = dv.t_genagrid " +
            "                   and (p.t_closedate is null or p.t_closedate < ?)) ";*/

          cmd = DL_RSDCommand(q);
          cmd.AddParam(ds.party);
          cmd.AddParam(ds.ID);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          /*
          cmd.AddParam(ds.party);
          cmd.AddParam(ds.ID);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          */
          rs = cmd.execute();
          while (rs.MoveNext)
            if ( (rs.dockind == DL_DVDEAL) and (rs.kind == DERIVATIVE_FUTURES) )
              if (Int(rs.price_fiid) != NATCUR)
                if (ConvSum(cf_price, rs.price, H1_ReportDate(), rs.price_fiid, NATCUR))
                   msgbox(GetCurrencyConvertErrorMsg(rs.price_fiid,NATCUR,H1_ReportDate()));
                   continue;
                end;
                if (ConvSum(mf_price, rs.MaxLastPrice, H1_ReportDate(), rs.price_fiid, NATCUR))
                   msgbox(GetCurrencyConvertErrorMsg(rs.price_fiid,NATCUR,H1_ReportDate()));
                   continue;
                end;
              else
                cf_price = rs.price;
                mf_price = rs.MaxLastPrice;
              end;

              pos_amount = $0;

              q_amount =
                "select abs(t.t_LongPosition - t.t_ShortPosition) amount from ddvfiturn_dbt t, ddvdeal_dbt dv " +
                " where  " +
                "       dv.t_id = ? " +
                "   and dv.t_fiid = t.t_fiid " +
                "   and dv.t_broker = t.t_broker " +
                "   and dv.t_clientcontr = t.t_clientcontr " +
                "   and dv.t_brokercontr = t.t_brokercontr " +
                "   and dv.t_department = t.t_department " +
                "   and dv.t_genagrid = t.t_genagrid" +
                "   and t.t_date <= ?";
              cmd_amount = DL_RSDCommand(q_amount);
              cmd_amount.Addparam(rs.id);
              cmd_amount.AddParam(H1_ReportDate());
              rs_amount = cmd_amount.execute();
              if (rs_amount.MoveNext())
                pos_amount = rs.amount;
              end;

              tmp_sum = (mf_price - cf_price) * pos_amount;
              if (rs.type == 1)
                tmp_sum = - tmp_sum;
              end;

              if(( rs.fi_kind == FIKIND_CURRENCY ) or ( rs.fi_kind == FIKIND_INDEX)) /*PNV */
                 A7 = A7 + tmp_sum;
              elif( rs.fi_kind == FIKIND_AVOIRISS )
                 A8 = A8 + tmp_sum;
              else
                 A9 = A9 + tmp_sum;
              end;

            elif ((rs.dockind == DL_DVNDEAL) and (rs.kind == DV_FORWARD)) // FORWARD

              if (Int(rs.price_fiid) != NATCUR)
                if (ConvSum(fw_price, rs.price, H1_ReportDate(), rs.price_fiid, NATCUR))
                   msgbox(GetCurrencyConvertErrorMsg(rs.price_fiid,NATCUR,H1_ReportDate()));
                   continue;
                end;
              else
                fw_price = rs.price;
              end;

              if( rs.fi_kind == FIKIND_CURRENCY )
                 if (ConvSum(fw_ba_price, $1, H1_ReportDate(), rs.base_FIID, NATCUR))
                    msgbox(GetCurrencyConvertErrorMsg(rs.base_FIID,NATCUR,H1_ReportDate()));
                    continue;
                 end;
              elif( rs.fi_kind == FIKIND_AVOIRISS )
                 if (ПолучитьКурсЗаданногоTипа(@market_price, rs.base_FIID, rs.vn, RATETYPE_MARKET_PRICE, H1_ReportDate(), false, @CourceSinceDate) == true)
                   if ( (Int(rs.vn) != NATCUR) and ConvSum(rate, $1, H1_ReportDate(), rs.vn, NATCUR) )
                      msgbox(GetCurrencyConvertErrorMsg(rs.vn,NATCUR,H1_ReportDate()));
                      continue;
                   else
                      rate = 1;
                   end;
                   fw_ba_price = rate * market_price;
                 else
                   fw_ba_price = 0;
                   msgbox("Не определена рыночная стоимость ц/б \"" + rs.name +"\"");
                   continue;
                 end;
              else
                 if( ПолучитьЛюбойПоследнийКурсНаДату(H1_ReportDate(),rs.base_FIID,@fw_ba_price) == false )
                    continue;
                 end;
              end;

              tmp_sum = (fw_ba_price - fw_price) * rs.amount;
              if (rs.type == ALG_DV_BUY)
                tmp_sum = - tmp_sum;
              end;

              if(( rs.fi_kind == FIKIND_CURRENCY ) or ( rs.fi_kind == FIKIND_INDEX)) /*PNV */
                 A7 = A7 + tmp_sum;
              elif( rs.fi_kind == FIKIND_AVOIRISS )
                 A8 = A8 + tmp_sum;
              else
                 A9 = A9 + tmp_sum;
              end;
            elif (((rs.dockind == DL_DVDEAL) and (rs.kind == DERIVATIVE_OPTION)) or ((rs.dockind == DL_DVNDEAL) and (rs.kind == DV_OPTION))) // OPTION

              if (Int(rs.price_fiid) != NATCUR)
                if (ConvSum(op_price, rs.price, H1_ReportDate(), rs.price_fiid, NATCUR))
                   msgbox(GetCurrencyConvertErrorMsg(rs.price_fiid,NATCUR,H1_ReportDate()));
                   continue;
                end;
              else
                op_price = rs.price;
              end;

              if( rs.fi_kind == FIKIND_CURRENCY )
                 if (ConvSum(op_ba_price, $1, H1_ReportDate(), rs.base_fiid, NATCUR))
                    msgbox(GetCurrencyConvertErrorMsg(rs.base_fiid,NATCUR,H1_ReportDate()));
                    continue;
                 end;
              elif( rs.fi_kind == FIKIND_AVOIRISS )
                 if (ПолучитьКурсЗаданногоTипа(@market_price, rs.base_FIID, rs.vn, RATETYPE_MARKET_PRICE, H1_ReportDate(), false, @CourceSinceDate) == true)
                   if ( (Int(rs.vn) != NATCUR) and ConvSum(rate, $1, H1_ReportDate(), rs.vn, NATCUR) )
                      msgbox(GetCurrencyConvertErrorMsg(rs.vn,NATCUR,H1_ReportDate()));
                      continue;
                   else
                      rate = 1;
                   end;
                   op_ba_price = rate * market_price;
                 else
                   op_ba_price = 0;
                   msgbox("Не определена рыночная стоимость ц/б \"" + rs.name + "\"");
                   continue;
                 end;
              else
                 if( ПолучитьЛюбойПоследнийКурсНаДату(H1_ReportDate(),rs.base_FIID,@op_ba_price) == false )
                    continue;
                 end;
              end;

              tmp_sum = (op_ba_price - op_price) * rs.amount;
              if (((rs.dockind == DL_DVDEAL) and (rs.type == 1)) or ((rs.dockind == DL_DVNDEAL) and (rs.type == ALG_DV_BUY)))
                tmp_sum = - tmp_sum;
              end;

              if(( rs.fi_kind == FIKIND_CURRENCY ) or ( rs.fi_kind == FIKIND_INDEX)) /*PNV */
                 A7 = A7 + tmp_sum;
              elif( rs.fi_kind == FIKIND_AVOIRISS )
                 A8 = A8 + tmp_sum;
              else
                 A9 = A9 + tmp_sum;
              end;

            else

              q_other = "select p.t_amount amount, p.t_payfiid fiid, f.t_facevaluefi vn, f.t_fi_kind, f.t_name, "
                       +"       case when p.t_payer = ? then 0 else 1 end IsReq "
                       +"  from dpmpaym_dbt p, dfininstr_dbt f "
                       +" where p.t_dockind = ? and p.t_documentid = ? and p.t_payfiid = f.t_fiid "
                       + "  and p.t_valuedate > ? " 
                       + "  and p.t_paymstatus <> "+PM_REJECTED;

              cmd_other = DL_RSDCommand(q_other);
              cmd_other.AddParam(ds.party);
              cmd_other.AddParam(rs.dockind);
              cmd_other.AddParam(rs.id);
              cmd_other.AddParam(H1_ReportDate());
              rs_other = cmd_other.execute();

              while (rs_other.MoveNext())

                if( rs_other.fi_kind == FIKIND_CURRENCY )
                   if (Int(rs_other.fiid) != NATCUR)
                     if (ConvSum(other_price, rs_other.amount, H1_ReportDate(), rs_other.fiid, NATCUR))
                        msgbox(GetCurrencyConvertErrorMsg(rs_other.fiid,NATCUR,H1_ReportDate()));
                        continue;
                     end;
                   else
                     other_price = rs_other.amount;
                   end;
                elif( rs_other.fi_kind == FIKIND_AVOIRISS )
                   if (ПолучитьКурсЗаданногоTипа(@market_price, rs_other.FIID, rs_other.vn, RATETYPE_MARKET_PRICE, H1_ReportDate(), false, @CourceSinceDate) == true)
                     if ( (Int(rs_other.vn) != NATCUR) and ConvSum(rate, $1, H1_ReportDate(), rs_other.vn, NATCUR) )
                        msgbox(GetCurrencyConvertErrorMsg(rs_other.vn,NATCUR,H1_ReportDate()));
                        continue;
                     else
                        rate = 1;
                     end;
                     other_price = rate * market_price * rs_other.amount;
                   else
                     other_price = 0;
                     msgbox("Не определена рыночная стоимость ц/б \"" + rs_other.name + "\"");
                     continue;
                   end;
                else
                   if( ПолучитьЛюбойПоследнийКурсНаДату(H1_ReportDate(),rs_other.FIID,@other_price) == false )
                      continue;
                   end;
                   other_price = other_price * rs_other.amount;
                end;

                if (rs_other.IsReq == 0)
                  tmp_sum = - other_price;
                else
                  tmp_sum = other_price;
                end;

                if(( rs.fi_kind == FIKIND_CURRENCY ) or ( rs.fi_kind == FIKIND_INDEX)) /*PNV */
                  A7 = A7 + tmp_sum;
                elif( rs_other.fi_kind == FIKIND_AVOIRISS )
                  A8 = A8 + tmp_sum;
                else
                  A9 = A9 + tmp_sum;
                end;
              end;
            end;
          end;
        end;

        if (ds.sfsk == PTSK_STOCKDL)
          /*Chesnokov D.S. Добавил определение стоимости аналогично в графой 5 и запрос неправильный*/
          q = "select rq.t_kind kind, rq.t_amount amount, fin.t_fiid vn, fin.t_faceValueFi fvfi, fin.t_name fi_name, " +
              "       Rsb_Secur.IsSale(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) IsSale, " +
              "       Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) IsRepo, " +
              "       TO_CHAR(avr.t_begplacementdate, 'dd.mm.yyyy') as bpldate, avr.t_isin as isin" +
              "  from ddl_tick_dbt tick, v_rqhist rq, dfininstr_dbt fin, ddlrq_dbt rq1, davoiriss_dbt avr " +
              " where tick.t_clientid = ? " +
              "   and tick.t_clientcontrid = ? " +
              "   and tick.t_bofficekind = " + DL_SECURITYDOC + " " +
              "   and tick.t_dealstatus != " + DL_PREPARING + " " +
              "   and tick.t_dealid = rq1.t_docid " +
              "   and tick.t_bofficekind = rq1.t_DocKind " +
              "   and rq.t_rqid = rq1.t_id " +
              "   and tick.t_dealdate <= ? " +
              "   and rq1.t_type = " + DLRQ_TYPE_DELIVERY + " " +
              "   and rq.t_state not in (" + DLRQ_STATE_EXEC + "," + DLRQ_STATE_REJECT + ") " +
              "   and rq.t_instance = (select MAX(h1.t_instance) from v_rqhist h1 where h1.t_rqid = rq.t_rqid and h1.t_changedate <= ?) " +
              "   and (rq1.t_factdate > ? or rq1.t_factdate = to_date('01010001', 'ddmmyyyy')) " +
              "   and fin.t_fiid = rq1.t_fiid " +
              "   and avr.t_fiid = fin.t_fiid ";

          cmd = DL_RSDCommand(q);
          cmd.AddParam(ds.party);
          cmd.AddParam(ds.ID);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
//          cmd.AddParam(H1_ReportDate());
          rs = cmd.execute();

          while (rs.MoveNext)
            /*Алгоритм определения стоимости:
            Если сделка не по первичному размещению, то 
              1. Рыночная цена;
              2. Котировка Bloomberg;
              //3. По сделке за последние 90 дней + НКД;
              4. Мотивированное суждение */
            
            IfNeedNKD = false;
            FindCourseFi = 0.0;
            market_price = NULL;
            DealCode = "";
            НКД = 0.0;
            
            if (rs.amount == 0)
               continue;
            end;

            rate = 1;
            
            if (iif(rs.IsRepo, iif(rs.IsSale, 0, 1), rs.IsSale) != rs.kind) 
               continue;
            end;

            if (int(rs.fvfi) != NATCUR)
              rate = GetRateOnDateCrossDbl(H1_ReportDate(), rs.fvfi, NATCUR, false);
            end;

            if ((rate != NULL) and (rate != 0.0))
              if (int(rs.vn) != NATCUR)
                if (date(rs.bpldate) <= H1_ReportDate())//дата начала размещения цб
                  /*Рыночная цена*/
                  if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_MARKET_PRICE, @FindCourseFi))
                    market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_MARKET_PRICE);
                    if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                      rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                    end;
                  end;
                  /*Котировка Bloomberg*/
                  if ((market_price == NULL) or (market_price == 0.0))
                    if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_BLOOMBERG_PRICE, @FindCourseFi))
                      market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_BLOOMBERG_PRICE);
                      if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                        rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                      end;
                    end;
                    if ((market_price == NULL) or (market_price == 0.0))
                      msgbox(rs.fi_name + ";" + rs.isin + ";" + H1_EndWorkDate() +";"+ H1_EndWorkDate() +";;BLOOMBERG;2275" );
                    end;
                  end;
                  /*Последняя сделка за 90 дней*/
                  //if ((market_price == NULL) or (market_price == 0.0))
                  //  market_price = getRate90(101, rs.vn, H1_ReportDate(), rs.fvfi/*валюта номинала*/, @DealCode);
                  //  if (market_price != NULL)
                  //    msgbox("2260 : Котировку для ц/б " + rs.fi_name + " равную " + market_price + " определил по сделке " + DealCode);
                  //    IfNeedNKD = true;
                  //  end;
                  //end;
                  /*Мотивированное суждение*/
                  if ((market_price == NULL) or (market_price == 0.0))
                    if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_REASONED_PRICE, @FindCourseFi))
                      market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_REASONED_PRICE);
                      if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                        rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                      end;
                    end;
                  end;
                else
                  /*Котировка Bloomberg*/
                  if ((market_price == NULL) or (market_price == 0.0))
                    if (ПолучитьПоследнийКурсНаДатуТипа(H1_ReportDate(), rs.vn, RATETYPE_BLOOMBERG_PRICE, @FindCourseFi))
                      market_price = _GetRateU(H1_ReportDate(), rs.vn, FindCourseFi, RATETYPE_BLOOMBERG_PRICE);
                      if ((market_price != NULL) and (rs.fvfi != FindCourseFi))
                        rate = GetRateOnDateCrossDbl(H1_ReportDate(), FindCourseFi, NATCUR, false);
                      end;
                    end;
                  end;
                  if ((market_price == NULL) or (market_price == 0.0))
                    msgbox(rs.fi_name + ";" + rs.isin + ";" + H1_EndWorkDate() +";"+ H1_EndWorkDate() +";;BLOOMBERG;2275" );
                  end;
                end;
                if ((market_price == NULL) or (market_price == 0.0))
                  //msgbox("2275 : Не задана котировка для ц/б " + rs.fi_name + " на " + iif(IsWorkDay(H1_ReportDate()), H1_ReportDate(), GetDateAfterWorkDays(H1_ReportDate(), -1)));
                  //msgbox(rs.fi_name + ";" + rs.isin + ";" + H1_EndWorkDate() +";"+ H1_EndWorkDate() +";;BLOOMBERG;2275" );
                 continue;
                end;
              else
                  market_price = 1;
              end;

              tmp_sum = rate * market_price * rs.amount;
              if (IfNeedNKD)
                НКД = rate * СуммаКупона(rs.vn, rs.amount, H1_ReportDate());
                tmp_sum = tmp_sum + НКД;
              end;
            else
              tmp_sum = 0;
              msgbox("2286 : Не определен курс для ФИ " + rs.fvfi);
            end;
            A8 = A8 + iif(rs.kind == DLRQ_KIND_REQUEST, tmp_sum, -tmp_sum);
          end;
        end; 

        if ((ds.sfsk == PTSK_VEKSACC) /*AND (0)*/) /*PNV 518846*/
          q = "select t.t_Name as t_FiidName, t.t_facevaluefi as t_pfi, pm.t_baseamount as t_baseamount, pm.t_basefiid as t_fiid, CASE WHEN pm.t_receiver = tick.t_ClientId THEN 1 ELSE -1 END as t_coef " +
                      "  from dfininstr_dbt t, ddl_tick_dbt tick, dpmpaym_dbt pm " +
                      " where tick.t_clientid = ? "+
                      "   and tick.t_clientcontrid = ? " +
                      "   and tick.t_dealdate <= ? " +
                      "   and pm.t_basefiid = t.t_FIID "+
                      "   and tick.t_dealstatus = " + string(DL_READIED) +
                      "   and (tick.t_closedate > ? or tick.t_closedate = to_date('01010001', 'ddmmyyyy')) " +
                      "   and pm.t_dockind = tick.t_bofficekind " +
                      "   and pm.t_documentid = tick.t_dealid " +
                      "   and pm.t_valuedate > ? " +
                      "   and pm.t_paymstatus <> "+PM_REJECTED +
                      "   and pm.T_PURPOSE in ("+string(BAi)+") "+
                      "   and tick.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")";
          cmd = DL_RSDCommand(q);
          cmd.AddParam(ds.party);
          cmd.AddParam(ds.ID);
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          cmd.AddParam(H1_ReportDate());
          rs = cmd.execute();
          while (rs.MoveNext)
            pfi = IIF(rs.PFI==-1,NATCUR,rs.PFI);
            find = ПолучитьКурсЗаданногоTипа(@market_price, rs.FIID, pfi, RATETYPE_MARKET_PRICE, H1_ReportDate(), true, @CourceSinceDate);
            if (find == true)
              if (int(pfi) != NATCUR)
                rate = GetRateOnDateCrossDbl(H1_ReportDate(), pfi, NATCUR, true);
                if ((rate == NULL) or (rate == 0.0))
                  rate = 1;
                end;
              else
                rate = 1;
              end;
              tmp_sum = rate * market_price * rs.BaseAmount * rs.Coef;
            else
              tmp_sum = 0;
              msgbox("Не определена рыночная стоимость ц/б \"" + rs.FiidName + "\"");
            end;
            A8 = A8 + tmp_sum;
          end;
        end;

        q = " select mc2.acc, mc2.cur, rsb_account.restac(mc2.acc, mc2.cur, ?, mc2.t_Chapter, null) sum " +
                "   from (select mc.acc, mc.cur, mc.t_Chapter                                               " +
                "           from                                                                            " +
                "                ( select ac.t_account acc, ac.t_code_currency cur, ac.t_Chapter            " +
                "                    from daccount_dbt ac, dsettacc_dbt sa, dSfssi_dbt ss                   " +
                "                   where sa.t_settaccid = ss.t_setaccid                                    " +
                "                     and ss.t_objecttype = 659                                             " +
                "                     and ss.t_objectid = LPAD(?, 10, '0')                                  " +
                "                     and ac.t_Balance in ('30601', '30606')                                " +
                "                     and ac.t_account = sa.t_account                                       " +
                "                     and ac.t_chapter = sa.t_chapter                                       " +
                "                     and ac.t_code_currency = sa.t_fiid                                    " +
                "                ) mc                                                                       " +
                "                group by mc.acc, mc.cur, mc.t_Chapter                                      " +
                "        ) mc2                                                                              ";

         cmd = DL_RSDCommand(q);
         cmd.AddParam(H1_ReportDate());
         cmd.AddParam(int(ds.ID));
         rs = cmd.execute();

        while (rs.MoveNext())
          if (Int(rs.cur) != NATCUR)
            cr = GetRateOnDateCrossDbl(H1_ReportDate(), int(rs.cur), NATCUR, true);
            tmp_sum = cr * rs.sum;
            //tmp_sum = iif(rs.ka == "А", - tmp_sum, tmp_sum);
            //ConvSum(tmp_sum, iif(rs.ka == "А", -rs.sum, rs.sum), H1_ReportDate(), rs.cur, NATCUR);
          else
            //tmp_sum = iif(rs.ka == "А", -rs.sum, rs.sum);
            tmp_sum = rs.sum;
          end;
          A5 = A5 + tmp_sum;
        end;
        Itog = A5 + A6 + A7 + A8 + A9;

        InsTMP(ds.party, ds.ID, ClientCode, Client, ClientFull, A01, ResidenceStatus, RegisterType, Activity, QualifedInvestor, string(ds.sfnum), Date(ds.sfbeg), Date(ds.sfcls), int(ds.sfsk), int(ds.subkind), "", 0, A5, A6, A7, A8, A9, Itog, int(ds.risklevel));
///////////////////////////////////////////////////////////////////////////////////
        DS_ProgressIndicator.Use;
      end;
      DS_ProgressIndicator.Remove;
    end;
end;

///////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////
        Report707.SetActiveSheet("Отчет");
        Report707.PrintReportHead();
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_ReportHead", 0, "Отчет");
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_TableHead1", 0, "Отчет");

        //@Kliko
        Report707.PrintKlikoHead("<F707N_1>");
  
        PrintTable_1();

        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_Table2", 0, "Отчет");
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_TableHead3", 0, "Отчет");
       
        //@Kliko
        Report707.PrintKlikoHead("<F707N_2_1>");    
        Report707.PrintKlikoHead("<F707_2_N2>");    
        Report707.PrintKlikoHead("<F707N_3N>");        
        dbg("Start DEPO");

        if( m_IsDepo ) 
           Report707.GetInfoByDepo();
        end;
        Report707.PrintTable_3();

        //@Kliko
        Report707.PrintKlikoHead("<F707_3>");
        Report707.PrintKlikoHead("<F707_4>");
        dbg("Finish DEPO");

        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_Table4", 0, "Отчет");
        Report707.AddStandardFooter("N_");
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_Footer", 0, "Отчет");

        if (m_IsSecur or m_IsDV or m_IsVA)
          var ServKind:string = "";
          dbg("Start DECRIPTION");
          Report707.SetActiveSheet("Расшифровка");
          Report707.PrintFormatString(NULL, "N2_H1", "по состоянию на " + H1_ReportDate() + " г.");

          //Report707.PrintFormatString(NULL, "N2_H1", "по состоянию на " + date_as_string(1, H1_ReportDate() + 1, false) + " г.");
          Report707.CopyAllSheetInTotalBook("Расшифровка", false, "N2_ReportHead", 0, "Расшифровка");
          Report707.CopyAllSheetInTotalBook("Расшифровка", false, "N2_TableHead", 0, "Расшифровка");

          q_cl = "select * from " + tmp_table + " Order by T_CLIENTCODE";
          cmd_cl = DL_RSDCommand(q_cl);

          DS_ProgressIndicator = TProgressBar();
          DS_Nrec = cmd_cl.GetCount();
          DS_ProgressIndicator.init(DS_Nrec, "Печать листа расшифровок", "Печать листа расшифровок" );
          rs_cl = cmd_cl.execute();
          Report707.RegisterTable("N2_TableLine", "", "N2_ClientCode", "N2_Client", "N2_ClientFull", "N2_A01", "N2_ResidenceStatus", "N2_RegisterType", "N2_Activity", "N2_QualifiedInvestor", "N2_ContractNumber", "N2_ContractOpenDate", "N2_ContractCloseDate", "N2_Industry", "N2_Account", "N2_CrNom", "N2_A05", "N2_NumDEPO", "N2_SecQnty", "N2_MarketSecCost", "N2_A06", "N2_A07", "N2_A08", "N2_A09", "N2_A10");
  
          while (rs_cl.MoveNext)
            dbg("Client " + rs_cl.T_CLIENT);
            // перебор счетов по договору. 
            q = " select mc2.acc, mc2.cur, rsb_account.restac(mc2.acc, mc2.cur, ?, mc2.t_Chapter, null) sum " +
                "   from (select mc.acc, mc.cur, mc.t_Chapter                                               " +
                "           from                                                                            " +
                "                ( select ac.t_account acc, ac.t_code_currency cur, ac.t_Chapter            " +
                "                    from daccount_dbt ac, dsettacc_dbt sa, dSfssi_dbt ss                   " +
                "                   where sa.t_settaccid = ss.t_setaccid                                    " +
                "                     and ss.t_objecttype = 659                                             " +
                "                     and ss.t_objectid = LPAD(?, 10, '0')                                  " +
                "                     and ac.t_Balance in ('30601', '30606')                                " +
                "                     and ac.t_account = sa.t_account                                       " +
                "                     and ac.t_chapter = sa.t_chapter                                       " +
                "                     and ac.t_code_currency = sa.t_fiid                                    " +
                "                ) mc                                                                       " +
                "                group by mc.acc, mc.cur, mc.t_Chapter                                      " +
                "        ) mc2                                                                              ";

            cmd = DL_RSDCommand(q);
            cmd.AddParam(H1_ReportDate());
            cmd.AddParam(int(rs_cl.ContrID));
            rs = cmd.execute();
            ok = rs.MoveNext;
            if (ok == false)
              msgbox("Счетов для ДО " + string(rs_cl.Number) + " не найдено");
              if(rs_cl.INDUSTRY == PTSK_STOCKDL)
                 ServKind = iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок");
              elif(rs_cl.INDUSTRY == PTSK_VEKSACC)
                 ServKind = "Учтенные векселя";  
              else
                 ServKind = iif(rs_cl.INDUSTRY == PTSK_DV, "Срочный рынок", "Валютный рынок");
              end;
              //выведем строку без счетов
              Report707.PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, date(rs_cl.DATEBEGIN), date(rs_cl.DATECLOSE), iif(rs_cl.INDUSTRY == PTSK_STOCKDL, iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок"), iif(rs_cl.INDUSTRY == PTSK_DV, "Срочный рынок", "Валютный рынок")), "", "", "", NumDEPO, SecQnty, MarketSecCost, rs_cl.A6, Round(rs_cl.A7/ 1000, 2), Round(rs_cl.A8/ 1000, 2), Round(rs_cl.A9/ 1000, 2), Round(rs_cl.Itog/ 1000, 2), GetRiskName(rs_cl.RiskLevel));
            else
              i = 1;
              while (ok)
               tmp_sum = 0;
                if (Int(rs.cur) != NATCUR)
                  //ConvSum(tmp_sum, rs.sum, H1_ReportDate(), int(rs.cur), NATCUR);
                  cr = GetRateOnDateCrossDbl(H1_ReportDate(), int(rs.cur), NATCUR, true);
                  tmp_sum = cr * rs.sum;
                else
                  tmp_sum = rs.sum;
                  cr = $1;
                end;
                //tmp_sum = Round(tmp_sum/ 1000, 0);
                if((index(string(rs_cl.NUMBER), "_v") > 0) and (rs_cl.T_ACTIVE == 0) and (tmp_sum == 0))
                  //Chesnokov D.S. Если договор заканчивается на _v и неактивный и нет средств, то не печатаем
                  ok = rs.MoveNext;
                  i = i + 1;
                  continue;
                end;
                if(i == 1)
                  if(rs_cl.INDUSTRY == PTSK_STOCKDL)
                     ServKind = iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок");
                  elif(rs_cl.INDUSTRY == PTSK_VEKSACC)
                     ServKind = "Учтенные векселя";  
                  else
                     ServKind = iif(rs_cl.INDUSTRY == PTSK_DV, "Срочный рынок", "Валютный рынок");
                  end;

                  Report707.PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, date(rs_cl.DATEBEGIN), date(rs_cl.DATECLOSE), iif(rs_cl.INDUSTRY == PTSK_STOCKDL, iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок"), iif(rs_cl.INDUSTRY == PTSK_DV, "Срочный рынок", "Валютный рынок")), rs.acc, cr, round(tmp_sum/1000, 5), NumDEPO, SecQnty, MarketSecCost, rs_cl.A6, Round(rs_cl.A7/ 1000, 2), Round(rs_cl.A8/ 1000, 2), Round(rs_cl.A9/ 1000, 2), Round(rs_cl.Itog/ 1000, 0), GetRiskName(rs_cl.RiskLevel));
                else
                  Report707.PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, date(rs_cl.DATEBEGIN), date(rs_cl.DATECLOSE), "", rs.acc, cr, round(tmp_sum/1000, 5), "", "", "", "", "", "", "", "", GetRiskName(rs_cl.RiskLevel));
                end;
                ok = rs.MoveNext;
                i = i + 1;
              end;
            end;
            DS_ProgressIndicator.Use;
          end;
          Report707.EndTable();
          Report707.CopyAllSheetInTotalBook("Расшифровка", false, Report707.GetTableRange(), 0, "Расшифровка");      
          DS_ProgressIndicator.Remove;
          dbg("Finish DECRIPTION");
        end;
        
        /**/
        Report707.SetActiveSheet("Бумаги");
        Report707.PrintFormatString(NULL, "N3_H1", "по состоянию на " + date_as_string(1, H1_ReportDate() + 1, false) + " г.");

        Report707.CopyAllSheetInTotalBook("Бумаги", false, "N3_ReportHead", 0, "Бумаги");
        Report707.CopyAllSheetInTotalBook("Бумаги", false, "N3_TableHead", 0, "Бумаги");
        
        avr_q = "select * from D707DEAL_TMP Order by T_CLIENTCODE";
        avr_cmd = DL_RSDCommand(avr_q);

        DS_ProgressIndicator = TProgressBar();
        DS_Nrec = avr_cmd.GetCount();
        DS_ProgressIndicator.init(DS_Nrec, "Печать листа ценных бумаг", "Печать листа ценных бумаг" );
        avr_rs = avr_cmd.execute();
        Report707.RegisterTable("N3_TableLine", "", "N3_ClientCode", "N3_Client", "N3_A01", "N3_ContractNumber", "N3_KindAvr", "N3_TypeAvr", "N3_FIName", "N3_ISIN", "N3_SecQnty", "N3_Nominal", "N3_FiID", "N3_MarketPrice", "N3_Rate", "N3_TotalCost");
        
        while (avr_rs.MoveNext)
          Report707.PrintLineAvoiriss(avr_rs.T_CLIENTCODE, avr_rs.T_CLIENTFULL, avr_rs.T_COUNTRY, avr_rs.T_NUMBER, avr_rs.T_AVRKIND, avr_rs.T_AVRTYPE, avr_rs.T_FINAME, avr_rs.T_ISIN, avr_rs.T_SecQnty, avr_rs.T_Nominal, avr_rs.T_FIID, avr_rs.T_MARKETPRICE, avr_rs.T_Rate, avr_rs.T_TotalCost);
          DS_ProgressIndicator.Use;
        end;
        
        Report707.EndTable();
        Report707.CopyAllSheetInTotalBook("Бумаги", false, Report707.GetTableRange(), 0, "Бумаги");
        DS_ProgressIndicator.Remove;
        //msgbox("Завершение отчета: " + Time());

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
  end;

  MACRO PrintKlikoValLine(SubjectCode:STRING, CountryCode:STRING, Val1,   
                          RestInAccPlus, SecurInAccPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,
                          RestInAccMinus,SecurInAccMinus,RestMoneyMinus,RestSecurMinus,RestOtherMinus,
                          t1:integer, _StrCount:@INTEGER, _PrCount:@INTEGER, _substr:BOOL)
   
        private macro __insertLine(A1,A2,A3,A4, A5,A6,A7,A8,A9, A10,A11,A12,A13,A14, A15,A16,A17,A18)
          var s:string =  Kliko_Fld( A1  ) +","+
                          Kliko_Fld( A2  ) +","+
                          Kliko_Fld( A3  ) +","+
                          Kliko_Fld( A4, 0  ) +","+ // Golovkin 10.05.2021 SD6630971
                          Kliko_Fld( A5, 0  ) +","+
                          Kliko_Fld( A6  ) +","+      
                          Kliko_Fld( A7  ) +","+
                          Kliko_Fld( A8 ) +","+
                          Kliko_Fld( A9 ) +","+
                          Kliko_Fld( A10 ) +","+
                          Kliko_Fld( A11 ) +","+
                          Kliko_Fld( A12 ) +","+
                          Kliko_Fld( A13 ) +","+
                          Kliko_Fld( A14 ) +","+
                          Kliko_Fld( A15 ) +","+
                          Kliko_Fld( A16 ) +","+
                          Kliko_Fld( A17 ) +","+
                          Kliko_Fld( A18 );

          return Kliko_InsertInTxtFile(s);   
        end;
    var StrCount = "";
    if (_StrCount != null)
      if (_substr != true)
        StrCount=_StrCount+1;
      else
        StrCount=_StrCount;
      end;
      _StrCount = StrCount;
    end;

    var PrCount = "";
    if (_PrCount != null)
      if (_substr != true)
        PrCount = _PrCount + 1;
      else
        PrCount = _PrCount;
      end;
      _PrCount = PrCount;
    end;

    if ( _substr != true )
      return __insertLine( "", SubJectCode, CountryCode, Val1,  RestInAccPlus, SecurInAccPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,  
                           RestInAccMinus, SecurInAccMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus,  PrCount, t1, StrCount, "");
    else
      return __insertLine( "", SubJectCode, CountryCode, Val1,  RestInAccPlus, SecurInAccPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,  
                           RestInAccMinus, SecurInAccMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus,  PrCount, t1, 0, StrCount);
    end;
  END;

MACRO PrintKlikoValLineDepo(SubjectCode:STRING, CountryCode:STRING, ValSum, Val1, Val2,  
                              t1:integer, _StrCount:@INTEGER, _PrCount:@INTEGER, _substr: BOOL)
   
        private macro __insertLine(A1,A2,A3,A4,A5,A6, A7,A8,A9,A10)
          var s:string =  Kliko_Fld( A1  ) +","+
                          Kliko_Fld( A2  ) +","+
                          Kliko_Fld( A3  ) +","+
                          Kliko_Fld( A4  ) +","+ 
                          Kliko_Fld( A5  ) +","+
                          Kliko_Fld( A6  ) +","+ 
                          Kliko_Fld( A7  ) +","+
                          Kliko_Fld( A8  ) +","+
                          Kliko_Fld( A9  ) +","+
                          Kliko_Fld( A10 );
          return Kliko_InsertInTxtFile(s);   
        end;
    
    var StrCount = "";
    if (_StrCount != null)
      if (_substr != true)
        StrCount=_StrCount+1;
      else
        StrCount=_StrCount;
      end;
      _StrCount = StrCount;
    end;

    var PrCount = "";
    if (_PrCount != null)
      if (_substr != true)
        PrCount = _PrCount + 1;
      else
        PrCount = _PrCount;
      end;
      _PrCount = PrCount;
    end;

    if ( _substr != true )
      return __insertLine( "", SubJectCode, CountryCode, ValSum, Val1, Val2,  PrCount, t1, StrCount, "");
    else
      return __insertLine( "", SubJectCode, CountryCode, ValSum, Val1, Val2,  PrCount, t1, 0, StrCount);
    end;
  END;

  MACRO InsDepoTMP(PartyId, Country, IsNotResident, IsFL, IsActive)
    var insq = "INSERT INTO D707DEPO_TMP (T_PARTYID, T_COUNTRY, T_NOTRESIDENT, T_FL, T_ACTIVE) VALUES (?,?,?,?,?)";
    var inscmd;
    inscmd = RSDCommand (insq);
    inscmd.NullConversion = false;
    inscmd.addParam( "", RSDBP_IN, PartyId);
    inscmd.addParam( "", RSDBP_IN, Country);
    inscmd.addParam( "", RSDBP_IN, iif(IsNotResident == "X", "X", "0"));
    inscmd.addParam( "", RSDBP_IN, iif(IsFL == "X", "X", "0"));
    inscmd.addParam( "", RSDBP_IN, iif(IsActive == "X", "X", "0"));
    inscmd.execute();
  END;

  PRIVATE MACRO PrintSubsectionTable_3( SubTitle, SubTitleNumber, IsNotResident, IsOnlyActive, StCount:@integer, PrCount:@integer )
    var q, cmd, rs;
    var IsNotEmpty = false;
                                       
    PrintDepoOneTableHeader( SubTitle + " [" + SubTitleNumber + "]" );

    var KlikoTitleStr = IIF((not IsNotResident) and (not IsOnlyActive), SubTitle, SubTitle+":"); // Ошибка в описателе, требующая, чтобы в первом названии не было двоеточия
    PrintKlikoTitle(null, KlikoTitleStr, IIF(IsNotResident, "2","1"), @StCount);
         
    if( m_IsDepo )
       q = "select count(case when T_FL = 'X' then 1 else null end) cntFL, " + 
           "       count(case when T_FL != 'X' then 1 else null end) cntUL " + 
           "  from D707DEPO_TMP " + 
           " where T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + IIF(IsOnlyActive," and T_ACTIVE = 'X' ", "");
     
       cmd = DL_RSDCommand(q);
       rs = cmd.execute();

       if( rs.MoveNext() and ((rs.cntFL > 0) or (rs.cntUL > 0)) )           
          PrintDepoRepTableLine("", rs.cntFL, rs.cntUL);
          PrintKlikoValLineDepo("", "", rs.cntFL+rs.cntUL, rs.cntFL, rs.cntUL,  IIF(IsNotResident, "2","1"), @StCount, @PrCount, false);
          IsNotEmpty = true;
       end;
    end;
    if( IsNotEmpty == false )
       PrintDepoRepTableLine("", 0, 0);
       PrintKlikoValLineDepo("", "", "", "", "",  IIF(IsNotResident, "2","1"), @StCount, @PrCount, false);
    end;

    PrintDepoOneTableHeader(IIF(IsNotResident, "В том числе по странам [" + SubTitleNumber + ".1]", "В том числе по субъектам [" + SubTitleNumber + ".1]"));
    PrintKlikoTitle(null, IIF(IsNotResident, "в том числе по странам:", "в том числе по субъектам:"), IIF(IsNotResident, "2","1"), @StCount);

    if( IsNotEmpty )
       q = "select T_COUNTRY, " + 
           "       count(case when T_FL = 'X' then 1 else null end) cntFL, " + 
           "       count(case when T_FL != 'X' then 1 else null end) cntUL " + 
           "  from D707DEPO_TMP " + 
           " where T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + IIF(IsOnlyActive," and T_ACTIVE = 'X' ", "") +
           " group by T_COUNTRY order by T_COUNTRY asc";     

       cmd = DL_RSDCommand(q);
       rs = cmd.execute();

       var CountCountry = 0;
       while( rs.MoveNext() )
          PrintDepoRepTableLine(rs.t_Country, rs.cntFL, rs.cntUL);
          PrintKlikoValLineDepo(IIF(IsNotResident,"",rs.t_Country), IIF(IsNotResident,rs.t_Country,""), 
                                rs.cntFL+rs.cntUL, rs.cntFL, rs.cntUL,
                                IIF(IsNotResident, "2","1"), @StCount, @PrCount, (CountCountry > 0)
                           );
         CountCountry = CountCountry + 1;
       end;
    else
       PrintDepoRepTableLine("", 0, 0);
       PrintKlikoValLineDepo("", "", "", "", "",  IIF(IsNotResident, "2","1"), @StCount, @PrCount, false);
    end;

    return PrCount;
  END;

  MACRO PrintTable_3()
    var StCount = 0; //сквозная нумерация строк данных для kliko
    var PrCount = 0; //сквозная нумерация пунктов для kliko
    var DS_ProgressIndicator = TProgressBar();

    if( m_IsDepo )
       DS_ProgressIndicator.init(4, "Печать сведений о депозитарной деятельности", "Печать сведений о депозитарной деятельности" );
    end;
    PrintSubsectionTable_3("Клиентов - резидентов", "1", false, false, @StCount, @PrCount);
    DS_ProgressIndicator.Use;
    PrintSubsectionTable_3("Активных клиентов - резидентов", "1.2",false, true, @StCount, @PrCount);
    DS_ProgressIndicator.Use;
    StCount = 0; //Нумерация для нерезидентов идет заново
    PrintSubsectionTable_3("Клиентов - нерезидентов", "2", true, false, @StCount, @PrCount);
    DS_ProgressIndicator.Use;
    PrintSubsectionTable_3("Активных клиентов - нерезидентов", "2.2", true, true, @StCount, @PrCount);
    DS_ProgressIndicator.Remove; 
  END;

  MACRO GetInfoByDepo()
    var DS_ProgressIndicator = TProgressBar();

    execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE D707DEPO_TMP (T_PARTYID NUMBER, T_COUNTRY VARCHAR2(5), T_NOTRESIDENT CHAR, T_FL CHAR, T_ACTIVE CHAR) ON COMMIT PRESERVE ROWS'; EXCEPTION WHEN OTHERS THEN NULL; END;");
    execSQL("DELETE FROM D707DEPO_TMP");

    var Query = "select t.t_PartyID, t.t_NRCountry, Rsb_Secur.DL_GetNotResidentForBrokClientRep(t.t_PartyID, ?) rsdnt, t.t_LegalForm, " +
                "case when exists(select 1 " +
                "                   from dsfcontr_dbt sfcontr " +
                "                  where sfcontr.t_PartyID = t.t_PartyID " +
                "                    and (sfcontr.t_DateClose > ? or sfcontr.t_DateClose = ?) " +
                "                    and sfcontr.t_DateBegin <= ? " +
                "                    and sfcontr.t_ServKind = " + string(PTSK_DEPOS) +
                "                    and sfcontr.t_Department = cl.t_Department " +
                "                    and " + GetDepoClients() + ") then 'X' else '0' end active " +
                "  from dparty_dbt t, dclient_dbt cl " +
                " where cl.t_PartyID = t.t_PartyID " +
                "   and t.t_PartyID <> " + string({OurBank}) +
                "   and cl.t_ServiceKind = " + string(PTSK_DEPOS) +
                "   and exists(select 1 " +
                "                from dsfcontr_dbt sfcontr " +
                "               where sfcontr.t_PartyID = t.t_PartyID " +
                "                 and (sfcontr.t_DateClose > ? or sfcontr.t_DateClose = ?) " +
                "                 and sfcontr.t_DateBegin <= ? " +
                "                 and sfcontr.t_ServKind = " + string(PTSK_DEPOS) +
                "                 and sfcontr.t_Department = cl.t_Department) " +
                "   and cl.t_StartDate <= ? " +
                "   and (cl.t_FinishDate > ? or cl.t_FinishDate = ?) "; 

    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());

    //Передаются в GetDepoClients()
    Select.AddParam(m_BegDate);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(m_BegDate);
    Select.AddParam(H1_ReportDate());

    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));

    var DS_Nrec = Select.GetCount();    
    if( DS_Nrec > 0 )
       DS_ProgressIndicator.init(DS_Nrec, "Сбор данных о депозитарной деятельности", "Сбор данных о депозитарной деятельности" );

       var rs = Select.execute();
       while( rs.MoveNext() )

         var ResidenceStatus = rs.rsdnt;
         var A01 = "";
         if( ResidenceStatus == "X" )
            if( CheckPartyType(rs.partyID, PTK_INTERNATIONAL_ORG) == true )
              if( hasOGRN(rs.partyID) )
                A01 = "996";
              else
                A01 = "998";
              end;
            else
              A01 = GetCountryCode( rs.NRCountry );
            end;
          else
            A01 = GetOkatoCode( rs.partyID, H1_ReportDate() );
            if( A01 == "" )
              A01 = "00";
            end;
          end;
          if( (A01 == "") or (A01 == null) )
            A01 = "999";
          end;

          InsDepoTMP(rs.partyID, A01, ResidenceStatus, IIF(rs.legalForm != 1, "X", 0), rs.active);
          DS_ProgressIndicator.Use;
       end;
       DS_ProgressIndicator.Remove;
    end;
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    var Pr; //Обработанных разделов
    if ( m_InKliko )
      Kliko_OpenTxtFile(this.H1_ReportDate());
    end;

    Cals_Sums(H1_ReportDate, m_IsSecur, m_IsDV, m_IsVA, m_IsDepo, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, H1_EndWorkDate);
  END;

  MACRO Create()
    /*m_ClientData = ReportClientData();
    if( m_InKliko )
      Dl_CallInsertStat (DL_OUTREPORT_KLIKO);
      if( not Kliko_OpenTxtFile(this.H1_ReportDate()) )
        return;
      end;
    end;*/
    //SetXLSXFormat();
    ExecuteReport();
  END;

  MACRO EndReport()
    if( m_InKliko )
      Kliko_CloseTxtFile( true );
    end;
    SaveTotalbook();
  END;

  macro GetAuditMsg(panel:DL_CPanel):String
    var msg:string = "";
    var period:string = "";
    var deals1:string = "";
    var deals2:string = "";
    var deals3:string = "";
    var deals4:string = "";

    period = PeriodName_GetMonthsAndQuart(
                panel.GetFieldValue(PNFLD_FORM707_PERIOD),
                panel.GetFieldValue(PNFLD_FORM707_YEAR));

    deals1 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISSECUR) == "X",
                 "Модуля \"Бэк-офис ценных бумаг\"\n",
                 "");

    deals2 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISVA) == "X",
                 "Модуля \"Учтенные векселя\"\n",
                 "");

    deals3 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISDV) == "X",
                 "Модуля \"ФИСС и КО\"\n",
                 "");

    deals4 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISDEPO) == "X",
                 "Модуля \"Депозитарий\"\n",
                 "");

    msg =
    "Отчет:              Сведения об осуществляемой деятельности (ф.707)\n\n" +
    "Отчет за:           " + period + "\n" +
    "По договорам:\n"  +
    deals1 + deals2 + deals3 + deals4 +
    "\n----------------------------------------\n";

    return msg;
  end;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)

  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    Form707 = DL_ActivitiesInfo_Form707();
/*TODO:
   else
    if( ValType( FormData ) != V_UNDEF )
      Form707 = WS_Pane707( FormData );
    else
      stat = false;
    end;*/
  end;

  while( stat )
    if( not IsWebService )
      stat = Form707.Run();
    end;

    if( stat )
      Report707 = DlActivitiesInfo_Report707( null, "Report_ActivitiesInfo_4927y.xls", null, IsWebService, ReportHashCode, POI_MODE );
      Report707.Run(null, Report707.GetAuditMsg(Form707));

      if( IsWebService )
        Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = Report707.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
      end;
    end;
  end;

  return FullReportFileNames;
END;
