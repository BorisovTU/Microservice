/*
$Name:        dlsubjrn.mac
$Module:      Ядро Securities
$Description: Отчет " Субрегистр спорных сделок (для БО и УВ)"
*/
import DealsInter;
import "dlmisc.mac";
import "dlsubjrn_form.mac";

var m_Form= DL_SubJrnlRep_Panel();

private const DEALSTATUS_ALL    = -1, /* Все сделки */
              DEALSTATUS_CLOSED = 20,  /* Закрытые */
              DEALSTATUS_OPENED = 10;  /* Открытые */

PRIVATE MACRO UpdateFormFields():INTEGER

    SubRepFormData.DepartmentID        = m_Form.GetFieldValue( PNFLD_DLSUBJRN_Dprt );
    SubRepFormData.IsBODeals           = m_Form.GetFieldValue( PNFLD_DLSUBJRN_BODeals );
    SubRepFormData.IsVADeals           = m_Form.GetFieldValue( PNFLD_DLSUBJRN_VADeals);
    
    SubRepFormData.FIAvrKindID         = m_Form.GetFieldValue( PNFLD_DLSUBJRN_FIAvrKind );
    SubRepFormData.EmiID               = m_Form.GetFieldValue( PNFLD_DLSUBJRN_EmiCode );
    SubRepFormData.AvrKindID           = m_Form.GetFieldValue( PNFLD_DLSUBJRN_AvrCode );
    SubRepFormData.DealType            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_DealType );
    SubRepFormData.ClientID            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_ClientCode );

    SubRepFormData.IsForm              = m_Form.GetFieldValue( PNFLD_DLSUBJRN_ISFORM );
    SubRepFormData.FormSub             = m_Form.GetFieldValue( PNFLD_DLSUBJRN_FORMSUB );
    SubRepFormData.IsVid               = m_Form.GetFieldValue( PNFLD_DLSUBJRN_ISVID );
    SubRepFormData.VidSub              = m_Form.GetFieldValue( PNFLD_DLSUBJRN_VIDSUB );
    SubRepFormData.Noresident          = m_Form.GetFieldValue( PNFLD_DLSUBJRN_NORESIDENT );

    SubRepFormData.IsMarket            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_IsMarket );
    SubRepFormData.MarketID            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_MarketCode );
    SubRepFormData.IsOutMkt            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_IsOutMkt );
    SubRepFormData.IsBroker            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_IsBroker );
    SubRepFormData.BrokerID            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_BrokerCode );

    SubRepFormData.BeginDate           = m_Form.GetFieldValue( PNFLD_DLSUBJRN_DateBegin );
    SubRepFormData.EndDate             = m_Form.GetFieldValue( PNFLD_DLSUBJRN_DateEnd );

    SubRepFormData.isDealClosed        = m_Form.GetFieldValue( PNFLD_DLSUBJRN_DealClosed );
    SubRepFormData.isDealOpened        = m_Form.GetFieldValue( PNFLD_DLSUBJRN_DealReadied );
    SubRepFormData.isDealAll           = m_Form.GetFieldValue( PNFLD_DLSUBJRN_DealAll );
    
    SubRepFormData.IsUseApp            = m_Form.GetFieldValue( PNFLD_DLSUBJRN_Apostr );
    SubRepFormData.IsExportToExel      = m_Form.GetFieldValue( PNFLD_DLSUBJRN_EXCEL );
    
    if (SubRepFormData.isDealClosed == "X")
      SubRepFormData.DealStatus = DEALSTATUS_CLOSED;
    elif(SubRepFormData.isDealOpened == "X")
      SubRepFormData.DealStatus = DEALSTATUS_OPENED;
    else
      SubRepFormData.DealStatus = DEALSTATUS_ALL;
    end;

END;

macro DLSubJrnl()
                   
   var stat = 0;
        
   stat = m_Form.Run();
   
   if (stat == 0)
      Exit(1);
   end;
   
   UpdateFormFields();
   Dl_CallInsertStat( IIF( SubRepFormData.IsExportToExel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   if( SubRepFormData.IsBODeals == "X" )
      ExecMacroFile("scdljr.mac", "DealSubRegisterReport", SubRepFormData );  
   end;

   if( SubRepFormData.IsVADeals == "X" )
      ExecMacroFile("vasubjrn.mac", "VASubRegisterReport", SubRepFormData );
   end;

   DLSubJrnl();

end;

DLSubJrnl();
Exit(1);
