/*
  nontrading_orders_transfer_journal.mac
  Ошибки обработки неторговых поручений
*/

import "it_utils.mac";

private const CS_IT_LOG_OBJECT_NAME = "NONTRADING_ORDERS_LOAD_FROM_FILE.MAC";

private macro StartGurnal ()
  var panel = GetPeriodPanel("Ошибки загрузки поручений",date,date);
  var count = 0;

  if (not panel.run) 
    return 1;
  end;

  println( );
  println( "             Журнал ошибок загрузки неторговых поручений за период с "+ string(panel.BDate)+" по "+string(panel.EDate));
  println( );

  var rool1 = "+---------------------+---------------------------------------------------------------------------" ;
  
  var sql = " select to_char(l.create_sysdate,'dd.mm.yyyy hh24:mi:ss') as dt,l.msg from itt_log l \n"
          + " where l.object_name= ? \n"
          + " and l.msg_type = 'ERROR' and l.create_sysdate >= ? and l.create_sysdate < ? +1 \n"
          + " order by l.create_sysdate desc ";

  sql = ExecSqlSelect(sql, MakeArray(SqlParam("object_name", CS_IT_LOG_OBJECT_NAME), SqlParam("datebegin", panel.BDate), SqlParam("dateend", panel.EDate)), false);

  while (sql.MoveNext() )
    count = count + 1;
    if (count == 1)
      println(rool1);
      println( "|    Дата     Время   |   Ошибки чтения файлов ");
      println(rool1);
    end;
    println("| "+sql.value("dt") + " | "+sql.value("msg"));
  end;

  if (count != 0)
    println(rool1);
  else
    println("Незагруженных файлов из-за ошибки формата нет"); 
  end;
onerror()
  RemProgress();
  MsgBox("Ошибка при выполнении процедуры");
End;

StartGurnal();
