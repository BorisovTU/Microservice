IMPORT DealsInter, SPInter, PTInter, globals;
IMPORT RsbDataSet, "dlquery.mac";
import bnk_common;

import "sp_categ.mac";

/* Уже заполненные структуры, все изменения отразятся в базах */
PRIVATE VAR Документ         = TRecHandler( "nptxop" );
PRIVATE VAR СтарыйДокумент   = TRecHandler( "nptxop" ); /* заполняется при редактировании */

private macro GetMesType(Type)
  if( Type == 10 )
    return "Ошибка";
  elif( Type == 20 )
    return "Предупреждение";
  elif( Type == 30 )
    return "Отладка";
  end;

  return "Сообщение";
end;

class CodeChangeScroll(_ID)
  private const F_OPERATION  = 0,
                F_CLIENT     = 1,
                F_ALL        = 2;
  var Columns = TArray();
  var rs = null;
  var NumColumns = 0;
  var ID = _ID;
  var FilterType = F_OPERATION;
  var PrmArr = makeArray(SqlParam("1", ID));
  var Ext = false;

  /* атрибуты полей */
  macro AddColumn( ind, fld, head, width )
     Columns.value( ind * 6 + 0 ) = fld;  // fieldName
     Columns.value( ind * 6 + 1 ) = head; // header 
     Columns.value( ind * 6 + 2 ) = width; // width
     Columns.value( ind * 6 + 3 ) = 2;    // fldType (2 = FBT)
     Columns.value( ind * 6 + 4 ) = null; // decPoint
     Columns.value( ind * 6 + 5 ) = 0;    // reserv
     NumColumns = NumColumns + 1;
  end;

  macro BuildSQL()
    IF(FilterType == F_OPERATION)
      PrmArr = makeArray(SqlParam("1", ID));
      return 
      "SELECT T_ACCOUNTNUMBER, T_BEGINDATE, T_CHANGECODE, " +
      "       T_CLIENTID, T_CODE_AFTER, T_CODE_BEFOR,  " +
      "       T_CONTRACTID, T_ENDDATE, T_ERRORTEXT, " +
      "       T_FIID, T_GROUP, T_ID, T_UNKD " +
      "       T_INCDATE, T_INCTIME, T_ISCHANGEFLAG, " +
      "       case when T_ISCIRC = 1 then 'Обращающаяся'  " +
      "            when T_ISCIRC = 2 then 'Необращающаяся'  " +
      "            when T_ISCIRC = 3 then 'Потеря обращаемости'  " +
      "            else 'Не удалось определить обращаемость цб' end T_CIRC, " +
      "       T_ISIN, T_ISSUEDDATE,  " +
      "       T_KBK_AFTER, T_KBK_BEFOR, T_NOBAMOUNT,  " +
      "       (select t_code from DNPTXOP_DBT where t_id = T_OPERATIONID) T_OPERATION, T_OPERDATE, T_PAYMENTDATE,  " +
      "       T_PAYMENTRECORDSNOBID, T_PAYRECEIVEDDATE, T_RECORDPAYMENTID,  " +
      "       T_RECORDSNOBID, T_SALE, T_SUM_FOR_CHANGE,  " +
      "       T_TAXBASE, T_TAXPERIOD, T_TAXRATE,  " +
      "       NVL((SELECT CODE.T_CODE " +
      "          FROM DOBJCODE_DBT CODE " +
      "         WHERE CODE.T_OBJECTID = T_CLIENTID " +
      "           AND CODE.T_OBJECTTYPE = 3 " +
      "           AND CODE.T_CODEKIND = 101 " +
      "           AND CODE.t_state = 0),'') T_CFTID" +
      "  FROM DNPTXCODECHANGE_DBT where T_OPERATIONID = :1 ";
    elif(FilterType == F_CLIENT)
      PrmArr = makeArray(SqlParam("1", ID));
      return 
      "SELECT T_ACCOUNTNUMBER, T_BEGINDATE, T_CHANGECODE, " +
      "       T_CLIENTID, T_CODE_AFTER, T_CODE_BEFOR,  " +
      "       T_CONTRACTID, T_ENDDATE, T_ERRORTEXT, " +
      "       T_FIID, T_GROUP, T_ID, T_UNKD " +
      "       T_INCDATE, T_INCTIME, T_ISCHANGEFLAG, " +
      "       case when T_ISCIRC = 1 then 'Обращающаяся'  " +
      "            when T_ISCIRC = 2 then 'Необращающаяся'  " +
      "            when T_ISCIRC = 3 then 'Потеря обращаемости'  " +
      "            else 'Не удалось определить обращаемость цб' end T_CIRC, " +
      "       T_ISIN, T_ISSUEDDATE,  " +
      "       T_KBK_AFTER, T_KBK_BEFOR, T_NOBAMOUNT,  " +
      "       (select t_code from DNPTXOP_DBT where t_id = T_OPERATIONID) T_OPERATION, T_OPERDATE, T_PAYMENTDATE,  " +
      "       T_PAYMENTRECORDSNOBID, T_PAYRECEIVEDDATE, T_RECORDPAYMENTID,  " +
      "       T_RECORDSNOBID, T_SALE, T_SUM_FOR_CHANGE,  " +
      "       T_TAXBASE, T_TAXPERIOD, T_TAXRATE,  " +
      "       NVL((SELECT CODE.T_CODE " +
      "          FROM DOBJCODE_DBT CODE " +
      "         WHERE CODE.T_OBJECTID = T_CLIENTID " +
      "           AND CODE.T_OBJECTTYPE = 3 " +
      "           AND CODE.T_CODEKIND = 101 " +
      "           AND CODE.t_state = 0),'') T_CFTID" +
      "  FROM DNPTXCODECHANGE_DBT where T_CLIENTID = (select ch.T_CLIENTID from DNPTXCODECHANGE_DBT ch where ch.T_OPERATIONID = :1 AND ROWNUM = 1) ";
    elif(FilterType == F_ALL)
      PrmArr = TArray();
      return 
      "SELECT T_ACCOUNTNUMBER, T_BEGINDATE, T_CHANGECODE, " +
      "       T_CLIENTID, T_CODE_AFTER, T_CODE_BEFOR,  " +
      "       T_CONTRACTID, T_ENDDATE, T_ERRORTEXT, " +
      "       T_FIID, T_GROUP, T_ID, T_UNKD " +
      "       T_INCDATE, T_INCTIME, T_ISCHANGEFLAG, " +
      "       case when T_ISCIRC = 1 then 'Обращающаяся'  " +
      "            when T_ISCIRC = 2 then 'Необращающаяся'  " +
      "            when T_ISCIRC = 3 then 'Потеря обращаемости'  " +
      "            else 'Не удалось определить обращаемость цб' end T_CIRC, " +
      "       T_ISIN, T_ISSUEDDATE,  " +
      "       T_KBK_AFTER, T_KBK_BEFOR, T_NOBAMOUNT,  " +
      "       (select t_code from DNPTXOP_DBT where t_id = T_OPERATIONID) T_OPERATION, T_OPERDATE, T_PAYMENTDATE,  " +
      "       T_PAYMENTRECORDSNOBID, T_PAYRECEIVEDDATE, T_RECORDPAYMENTID,  " +
      "       T_RECORDSNOBID, T_SALE, T_SUM_FOR_CHANGE,  " +
      "       T_TAXBASE, T_TAXPERIOD, T_TAXRATE,  " +
      "       NVL((SELECT CODE.T_CODE " +
      "          FROM DOBJCODE_DBT CODE " +
      "         WHERE CODE.T_OBJECTID = T_CLIENTID " +
      "           AND CODE.T_OBJECTTYPE = 3 " +
      "           AND CODE.T_CODEKIND = 101 " +
      "           AND CODE.t_state = 0),'') T_CFTID" +
      "  FROM DNPTXCODECHANGE_DBT ";
    end;
    
    PrmArr = TArray();
    return 
      "SELECT T_ACCOUNTNUMBER, T_BEGINDATE, T_CHANGECODE, " +
      "       T_CLIENTID, T_CODE_AFTER, T_CODE_BEFOR,  " +
      "       T_CONTRACTID, T_ENDDATE, T_ERRORTEXT, " +
      "       T_FIID, T_GROUP, T_ID, T_UNKD " +
      "       T_INCDATE, T_INCTIME, T_ISCHANGEFLAG, " +
      "       case when T_ISCIRC = 1 then 'Обращающаяся'  " +
      "            when T_ISCIRC = 2 then 'Необращающаяся'  " +
      "            when T_ISCIRC = 3 then 'Потеря обращаемости'  " +
      "            else 'Не удалось определить обращаемость цб' end T_CIRC, " +
      "       T_ISIN, T_ISSUEDDATE,  " +
      "       T_KBK_AFTER, T_KBK_BEFOR, T_NOBAMOUNT,  " +
      "       (select t_code from DNPTXOP_DBT where t_id = T_OPERATIONID) T_OPERATION, T_OPERDATE, T_PAYMENTDATE,  " +
      "       T_PAYMENTRECORDSNOBID, T_PAYRECEIVEDDATE, T_RECORDPAYMENTID,  " +
      "       T_RECORDSNOBID, T_SALE, T_SUM_FOR_CHANGE,  " +
      "       T_TAXBASE, T_TAXPERIOD, T_TAXRATE,  " +
      "       NVL((SELECT CODE.T_CODE " +
      "          FROM DOBJCODE_DBT CODE " +
      "         WHERE CODE.T_OBJECTID = T_CLIENTID " +
      "           AND CODE.T_OBJECTTYPE = 3 " +
      "           AND CODE.T_CODEKIND = 101 " +
      "           AND CODE.t_state = 0),'') T_CFTID" +
      "  FROM DNPTXCODECHANGE_DBT ";
  end;

  macro BuildRS()
    var sql = BuildSQL();
    rs =  execSQLselect(sql, PrmArr, true, RSDVAL_CLIENT, RSDVAL_STATIC);
    return rs;
  end;

  macro EvProc(recset, cmd, id, key)
    /*Обработчик*/
    if(cmd == DLG_KEY)
      if(key == 376) /* Alt-1 */
        Ext = false;
        FilterType = F_OPERATION;
        return   CM_SELECT;
        return CM_CANCEL;
      elif(key == 377) /* Alt-2 */
        Ext = false;
        FilterType = F_CLIENT;
        return   CM_SELECT;
      elif(key == 378) /* Alt-3 */
        Ext = false;
        FilterType = F_ALL;
        return   CM_SELECT;
      end;
    end;
  end;

  macro ShowScroll()
    while(Ext != true)
      Ext = true;
      RunScroll (BuildRS(), NumColumns, Columns, "NPTXCODECHANGE",  R2M(this,"EvProc"), "Таблица замены кодов доходов", 
                 "~Esc~ Выход ~Alt-Shift-F11~ Экспорт в Excel ~Alt-1~ Фильтрация по операции ~Alt-2~ Фильтрация по клиенту ~Alt-3~ Вывод всех записей", true, -1, -1);
    end;
    return;
  end;

  AddColumn(0, "T_ID", "ID записи", 8);
  AddColumn(1, "T_OPERATION", "ID операции", 8);
  AddColumn(2, "T_OPERDATE", "Дата операции", 10);
  AddColumn(3, "T_SALE", "Учитывать сделки продажи", 2);
  AddColumn(4, "T_CHANGECODE", "Изменять код дохода", 2);
  AddColumn(5, "T_CLIENTID", "ID клиента", 10);
  AddColumn(6, "T_CFTID", "ID ЦФТ клиента", 14);
  AddColumn(7, "T_CONTRACTID", "Номер договора", 14);// !!
  AddColumn(8, "T_TAXPERIOD", "Налоговый период", 4);
  AddColumn(9, "T_BEGINDATE", "Дата начала налогового периода", 10);
  AddColumn(10, "T_ENDDATE", "Дата окончания налогового периода", 10);
  AddColumn(11, "T_RECORDPAYMENTID", "ID выплаты в Диасофте", 20);
  AddColumn(12, "T_PAYMENTDATE", "Дата выплаты дохода клиенту", 10);
  AddColumn(13, "T_PAYRECEIVEDDATE", "Дата выплаты дохода эмитенту", 10);
  AddColumn(14, "T_FIID", "ID ценной бумаги", 10);
  AddColumn(15, "T_ISIN", "ISIN ценной бумаги", 25);
  AddColumn(16, "T_ACCOUNTNUMBER", "Счет выплаты дохода", 25);
  AddColumn(17, "T_CIRC", "Обращаемость цб", 20);
  AddColumn(18, "T_ISSUEDDATE", "Дата выпуска цб эмитентом", 10);
  AddColumn(19, "T_GROUP", "Группа", 2);
  AddColumn(20, "T_CODE_BEFOR", "Код ДО замены", 8);
  AddColumn(21, "T_CODE_AFTER", "Код ПОСЛЕ замены", 8);
  AddColumn(22, "T_ISCHANGEFLAG", "Замена кода", 2);
  AddColumn(23, "T_TAXBASE", "Сумма НОБ по текущей выплате", 16);
  AddColumn(24, "T_UNKD", "Сумма уплаченного НКД", 16);
  AddColumn(25, "T_SUM_FOR_CHANGE", "Сумма дохода, для которой необходимо изменить код дохода", 16);
  AddColumn(26, "T_PAYMENTRECORDSNOBID", "ID СНОБ (выпл.)", 50);
  AddColumn(27, "T_RECORDSNOBID", "ID СНОБ (Диас.)", 10);
  AddColumn(28, "T_INCDATE", "Дата события СНОБ", 10);
  AddColumn(29, "T_INCTIME", "Время события СНОБ", 20);
  AddColumn(30, "T_NOBAMOUNT", "Сумма НОБ по данным СНОБ", 16);
  AddColumn(31, "T_TAXRATE", "Ставка НДФЛ", 5);
  AddColumn(32, "T_KBK_BEFOR", "KБK до замены", 22);
  AddColumn(33, "T_KBK_AFTER", "КБК после замены", 22); 
  AddColumn(34, "T_ERRORTEXT", "Комментарий", 100); 
end;

/* Макрофункция инициализации новой записи 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ()
  return 0;
END;

PRIVATE MACRO Проверить_Документ( Режим:integer )
  return 0;
END;

/* Установка подсказки для скролингов из макроса */
PRIVATE MACRO УстановитьПодсказку( TableName:string, IndexNum:integer, DefaultHint:string, ScrolStatus:integer, ScrolKind:integer ):string
  //пример
  //return "/*+FIRST_ROWS LEADING(t) INDEX(t dnptxtretconf_dbt_idx1)*/";
  return DefaultHint;
END;

/* Вызывается по CTRL+Z из скроллинга */
PRIVATE MACRO Функция_Пользователя()
  return 0;
END;

MACRO runScrollTableChange( ID )
  var m_ClientScroll = CodeChangeScroll(ID);
  m_ClientScroll.ShowScroll();
  return 0;
END;

MACRO makeReportForOp( ID )
  VAR errcode, errtext;
  VAR ReportFileName, Query, Query_m, select, select_m, Oper = TRecHandler( "nptxop.dbt" );
  FILE ReportOutFile() txt write; /*файл вывода для отчета*/
  var nptxopF =  Tbfile("nptxop.dbt");
  nptxopF.Clear();
  nptxopF.rec.ID = ID;
  nptxopF.GetEQ();

  Copy (Oper, nptxopF); 

  if(Oper.rec.status == 0 )
    return 0;
  end;

  ReportFileName = GetTxtFileName( "nptxop_" + Oper.rec.DocKind + "_" + Oper.rec.Code );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "Ошибка при создании файла|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  select_m = RSDCommand( " SELECT * FROM DNPTXMES_DBT WHERE ((t_Type=10) or (t_Type=20)) and t_DocID = ? order by t_id " );

  select_m.addParam( "", RSDBP_IN, Oper.rec.ID );
  select_m.execute();
  Query_m = TRsbDataSet( select_m );

  Var sum=0;
  while( Query_m.MoveNext() )
     sum=sum+1;
  end;

  select = RSDCommand( " SELECT * FROM DNPTXMES_DBT WHERE t_DocID = ? order by t_id " );

  select.addParam( "", RSDBP_IN, Oper.rec.ID );
  select.execute();

  Query = TRsbDataSet( select );

  println("                         Протокол выполнения операции Id " + Oper.rec.Code );

  println();

  if (sum>0)
    println("Сообщения:");
  else 
    println("Сообщения: Операция выполнена успешно.");
  end;

  while( Query.MoveNext() )
     if ((Query.t_Type==10) or (Query.t_Type==20) or (Query.t_Type==21))
       println( SQL_ConvTypeDate(Query.t_Date):f, ", " + SQL_ConvTypeTime(Query.t_Time), ", ", GetMesType(Query.t_Type), ": ", Query.t_Message );
     elif (Query.t_Type==50)
       println( Query.t_Message );
     end;
  end;

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );
  return 0;
END;