/*
$Name:         dlgenagrsc.mac
$Module:       Ядро Securities
$Description:  Макрос скроллинга генеральных соглашений
*/

import BankInter;
import TSInter;
import "dlmisc.mac";

//Rogl add
import corsparm_lib; 

/* Уже заполненные структуры, все изменения отразятся в базах */
private var Документ         = TRecHandler( "dl_genagr" );
private var СтарыйДокумент   = TRecHandler( "dl_genagr" ); /* заполняется при редактировании */

/* Макрофункция инициализации нового актива 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
private macro Связанные_сделки()  
  var res = 0;
  var querySql, query;
  var GenAgrId = СтарыйДокумент.rec.GenAgrId;
  querySql = "SELECT COUNT(*) AS t_cnt FROM DV_ALLDEAL deals, DDL_GENAGR_DBT genagr"
            +" WHERE genagr.T_GENAGRID = deals.T_GENAGRID"
            +" AND   genagr.T_GENAGRID = ? ";

  query = RSDCommand(querySql);
  query.addParam("", RSDBP_IN, GenAgrId);
  query.Execute();

  var dataSet = TRsbDataSet(query);

  if ( dataSet.MoveNext() ) 
    res =  dataSet.cnt;
  end;

  return res;
end;

private macro Новый_Документ()
    return 0;
end;

/* Макрофункция проверки операции при вводе, редактировании, удалении, выполнении
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/

private macro checkCodeInAccout(): Integer
    // по ГС и содердит цифры
    var msgIsNumber = "Поле 'Код в номере л/с' должно содержать только цифры!";
    if ( (2 == Документ.rec.AccMode)   and  (not StrIsNumber(Документ.rec.CodeInAccount)) )   
           msgBox(msgIsNumber);
        return 1;
    end;
    return 0;
end;

private macro Проверить_Документ( Режим:Integer )
    var err = 0;

    if( Режим == TS_DELETE ) //удаление
        if ( Связанные_сделки() > 0 )          
          MsgBox("Удаление ГС невозможно. Есть связанные сделки");
          err = 1;
        end;
    elif( Режим == TS_INSERT ) //вставка
        //здесь должны быть проверки при вставке
        err =  checkCodeInAccout(); 
    elif( Режим == TS_EDIT ) //редактирование
        //здесь должны быть проверки при редактировании
        err =  checkCodeInAccout(); 
    elif( Режим == TS_EXECUTE ) //выполнение
        //здесь должны быть проверки при выполнение
    elif( Режим == TS_AFTER_DELETE) 
    end;

    return err;
end;

/* Вызывается по CTRL+Z из скроллинга */
private macro Функция_Пользователя()

    //MsgBox( "Выполняется макрофункция \"dlgenagrsc.mac\\ Функция_Пользователя\"." );  //Rogl comment 
    //Rogl add

    var m = TArray();
    m(m.Size) = "Схемы расчетов для генсоглашения.";
    m(m.Size) = "Установить тип и форму обеспечения для репозитария";

    var choice = menu(m);
    if(choice < 0) //Выход из меню
       return 0;
    elif(m(choice) ==  "Схемы расчетов для генсоглашения.")  
       genObject ("CCoshemParm_by_gs").run (1, Документ.rec); 
    elif(m(choice) ==  "Установить тип и форму обеспечения для репозитария")  
       ExecMacroFile ("SetGRTypeSecur.mac","SetTypeSecur", Документ.rec);     
    end;
    return 0;
end;
