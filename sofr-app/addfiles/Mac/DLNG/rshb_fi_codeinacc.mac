/*
$Name:         rshb_fi_codeinacc.mac
$Module:       Ядро Securities
$Description:  Генерация кода в номере счета по ценным бумагам
*/

import rsd, FIInter;

PRIVATE CONST USR_SEQ_FICODEINACC = 363; //Номер последовательности "Код в номере счета Ценной бумаги"

/*Проверка наличичия записей, где код в номере счета равнен полученному коду*/  
private macro CheckExistsCodeInAcc(CodeInAcc:string):bool
   var cmd, rs;
   cmd = RsdCommand("select 1 from dfininstr_dbt where t_FI_Kind = 2 and t_CodeInAccount = ?");
   cmd.addParam("", RSDBP_IN, CodeInAcc);
   rs = RsdRecordSet(cmd);
   if(rs.MoveNext())
      return true;
   end;
   return false;
end;

/*Генерация следующешл кода последовательности*/
private macro GetNextVal():integer
   var cmd = RsdCommand("begin ? := RSI_RSB_REFER.WldGetSequenceValue(?,?,?,?,CHR(0),1); end;");
  
   cmd.addParam("p_RetVal", RSDBP_RETVAL, V_INTEGER);
   cmd.addParam("p_SeqID",  RSDBP_IN,  USR_SEQ_FICODEINACC);  
   cmd.addParam("p_SeqVal", RSDBP_OUT, V_STRING);  
   cmd.addParam("p_Date",   RSDBP_IN,  Date());    
   cmd.addParam("p_Time",   RSDBP_IN,  Time());
   cmd.execute();

   return int(cmd.value("p_SeqVal"));
end;

/*Функция генерации единого кода на бирже в субдоговорах*/
macro GetCodeInAcc(SeqValue, ObjKind, ObjAddr):string
   var CodeInAcc:string = "";
   var IsFound:bool = true;

   while(IsFound)
      CodeInAcc = string(SeqValue:5:o);
      CodeInAcc = SubStr(CodeInAcc, StrLen(CodeInAcc)-4);  
      if(not CheckExistsCodeInAcc(CodeInAcc))
         IsFound = false;
      else
         SeqValue = GetNextVal();  
      end;
   end;

   return CodeInAcc;
end;