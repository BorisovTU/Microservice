/*
$Name:        dldlreq_report.mac
$Module:      Ядро Securities
$Description: Печать заявок-поручений
*/

import SFInter, "dlwreps.mac", "dlreport.mac", "dldlngfun.mac";

MACRO PrintDL_REQ( _Req:MEMADDR )

  record sfcontr(sfcontr);
  var ContrNumber:string = "";

  var Req = TRecHandler("dl_req.dbt");
  Req.SetRecordAddr( _Req );

  /*Шаблон*/
  [#]("dldlreq.dot");
  /*Имя выходного файла*/
  [#.rtf]("Заявка №" + Req.rec.Code);

  [~S01];
  println(Req.rec.Code);

  [~S02];
  println(string(Req.rec.Date:f));

  [~S03];
  println(string(Req.rec.Time:f));

  [~S04];
  println(DL_GetNameAlg(ALG_DL_REQ_STATUS, DL_GetReqStatus(Req)));
  

  [~S051];
  println(ПолучитьКодСубъекта(Req.rec.Client, PTCK_CONTR) + " " + DL_getPartyShortName(Req.rec.Client));

  if( SfGetContr(Req.rec.ClientContr, sfcontr) )
     ContrNumber = sfcontr.Number;
  end;

  [~S052];
  println(ContrNumber);

  [~S06];
  println(ПолучитьКодСубъекта(Req.rec.Party, PTCK_CONTR) + " " + DL_getPartyShortName(Req.rec.Party));

  [~S07];
  println(DL_GetNameAlg(ALG_DL_REQ_PLACEEXEC, IIF(Req.rec.IsExchange == "X", DL_REQ_PLACEEXEC_EXCHANGE, DL_REQ_PLACEEXEC_OUTEXCHANGE)));

  [~S071];
  println(DL_GetNameAlg(ALG_DV_MARKETKIND, Req.rec.MarketKind));

  var IsPFI:string = " ", PFIKind:string = "";
  if( Req.rec.PFIKind > 0 )
     IsPFI = "X";
     PFIKind = DL_GetNameAlg(ALG_DL_REQ_PFIKIND, Req.rec.PFIKind);
  end;

  [~S08];
  println(PFIKind);

  [~S09];
  println(DL_GetNameAlg(ALG_DL_REQ_DIRECTION, Req.rec.Direction));

  [~S10];
  println(IsPFI);

  [~S11];
  println(ЧислоCЗаданнойТочностью(Req.rec.RepoRate, 4));

  var FICode:string = "", FIName:string = "";
  var Fininstr = TRecHandler( "fininstr.dbt" );
  if( ПолучитьФинИн(Req.rec.FIID, Fininstr) == 0 )
     FICode = Fininstr.rec.FI_Code;
     FIName = Fininstr.rec.Name;
  end;

  [~S121];
  println(FICode);

  [~S122];
  println(FIName);

  [~S13];
  println(ЧислоCЗаданнойТочностью(Req.rec.Amount, 6));

  var PriceType:string = "", PriceCcy:string = "";
  if( Req.rec.PriceType == DL_REQ_PRICETYPE_CASH )
     PriceType = "Валюта расчетов";
     PriceCcy  = ПолучитьКодФинИн(Req.rec.CurrencyID, null, FICK_ISOSTRING);
  else
     PriceType = "%";
  end;
  //PriceType = DL_GetNameAlg(ALG_DL_REQ_PRICETYPE, Req.rec.PriceType);

  [~S14];
  println(PriceType);

  [~S15];
  println(PriceCcy);

  [~S16];
  println(ЧислоCЗаданнойТочностью(Req.rec.Price, 4));

  DLWREPS_PrintReportFromTagFile(SetOutPut(GetTxtFileName("tmpout"), FALSE));
END;
