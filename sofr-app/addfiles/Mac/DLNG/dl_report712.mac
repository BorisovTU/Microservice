
/*
$Name: dl_report712.mac
$Module: Ядро Securities
$Description: <Отчеты\ Регламентированные\ Указание № 4212-У\ Сведения об ИИС(ф. 712)> - тело отчета 
*/
import "dl_report712_form.mac", "mctplprm.mac", "dlquery.mac", "bnk_dttmfrmt.mac", "dldlngfun.mac", "scsrvrepfun.mac";
import "ws_txreportform.mac", "param.mac", "DLReport_h.mac";
import RcbProtocolView;

PRIVATE CONST
   RCB_XML_PK_MONTHLY   = 4,
   RCB_XML_PK_QUARTERLY = 5;

PRIVATE VAR Dl_IIS712_Form;
PRIVATE FILE Kliko_F712() txt write;
PRIVATE FILE TextProtocol() txt write;

PRIVATE CONST CODE_A = 0,
              CODE_B = 1,
              CODE_X = 2;

PRIVATE CONST
   XML_ATTR_OPTIONAL = 1,
   XML_ATTR_REQ      = 2,
   XML_ATTR_EMPTY    = 3;

PRIVATE CONST POI_MODE = TRUE;
PRIVATE CONST BIGREPORT_MODE = TRUE;

VAR m_SessionID = 0;

PRIVATE MACRO GetSessionID():Integer
  var id:Integer = -1;
  var sql = "SELECT SYS_CONTEXT('USERENV','SESSIONID') SessionID FROM DUAL";
  var cmd = DL_RSDCommand(sql);
  var ds = cmd.execute();
  if( ds.MoveNext() )
    id = int(ds.SessionID);
  end;
  return id;
END;

CLASS F712DeltaXML(OKUD:String, ReportKind:String, BegDate:Date, EndDate:Date, Periodicity:Integer)
   private var m_XmlReport;
   private var m_BegDate = BegDate;
   private var m_EndDate = EndDate;
   private var RowNum = 0;
   private var jvm;
   private var m_Protocol;
   private var m_ExecutorName = "";
   private var m_FileName = "";
   private var m_OKUD = OKUD;

   macro atrAddToNode(XMLNode, Name: string, Val:VARIANT, AttrType:INTEGER, ParentElemName: string)
       VAR vt = ValType(Val), err = "";
       if (vt == V_STRING)
         Val = StrSubst( Val, "-", "" );
       end;
       if((Val == NULL) OR ((vt == V_DATE) and (Val == DATE(0,0,0))) OR ((vt == V_STRING) and (Val == "")) OR (((vt == V_DOUBLE) OR (vt == V_MONEY)) AND (Val == 0.00)))
         if (AttrType == XML_ATTR_OPTIONAL)
            return;
         else
            if (AttrType == XML_ATTR_REQ)
               err = "Не заполнен обязательный атрибут '" + Name + "'";
               if (ParentElemName != NULL)
                  err = err + " элемента '" + ParentElemName + "'";
               end;
               m_Protocol.Error(err);
            end;
         end;
       end;

      XMLNode.addAttribute(Name, Val);
   end;

   macro PrintInfo()

      var registrationNumber = repGetPartyCode({OurBank}, PTCK_BANKREGNUM, m_EndDate);
      var BIC = repGetPartyCode({OurBank}, PTCK_BIC, m_EndDate);
      var party = TRecHandler("party.dbt");
      var OKATO;
      var OKPO;
      var OGRN = repGetPartyCode({OurBank}, PTCK_OGRN, m_EndDate);
      var Name;
      var PostalAdress;
      var adress = TRecHandler("adress.dbt");
      var leaderPost:String, leaderName:String;
      var executorPost;
      var executorName;
      var executorPhone;
      var executorEmail;
      var executorFax;
      var signers = jvm.createJavaObject("java.util.ArrayList", "<init>");

      ПолучитьСубъекта({OurBank}, party);
      OKPO = IIF(party.rec.OKPO != NULL, party.rec.OKPO, "");
      Name = party.rec.ShortName;

      GetMainObjAttr(NULL,
                     OBJTYPE_PARTY,
                     UniID(party, OBJTYPE_PARTY),
                     RCB_OBJGROUP_PT_OKATO, // 12
                     NULL,
                     NULL,
                     OKATO,
                     m_EndDate
                    );

      if(OKATO == NULL)
         var OkatoQuery = "select adress.t_OKATO " +
                          "from dadress_dbt adress " +
                          "where adress.t_Type = 1 " +
                          "  and adress.t_PartyID = " + string({OurBank});

         var OkatoSelect = DL_RSDCommand(OkatoQuery);
         var OkatoDS = OkatoSelect.Execute();
         if(OkatoDS.MoveNext())
            OKATO = OkatoDS.OKATO;
         end;
      end;

      OKATO = IIF(OKATO != NULL, OKATO, "");

      if(найтиАдресСубъекта({OurBank}, PTADDR_REAL, adress))
         PostalAdress = adress.rec.Adress;
      end;

      var leaderQuery = "select off.t_Post, " +
                        "       persn.t_name1 || ' ' || persn.t_name2 || ' ' || persn.t_name3 as t_Name " +
                        "from dofficer_dbt off, dpersn_dbt persn " +
                        "where off.t_IsFirstPerson = 'X' " +
                        "  and off.t_PartyID = " + string({OurBank}) +
                        "  and persn.t_PersonID = off.t_PersonID ";

      var leaderSelect = DL_RSDCommand(leaderQuery);
      var leaderDS = leaderSelect.Execute();

      if(leaderDS.MoveNext())
         leaderPost = leaderDS.Post;
         leaderName = leaderDS.Name;
      else
         leaderPost = leaderName = "";
      end;

      var executorQuery = 
              "select off.t_Post,                                                              " +
              "       persn.t_name1 || ' ' || persn.t_name2 || ' ' || persn.t_name3 as t_Name, " +                                          
              "       nvl(                                                                     " +
              "        (                                                                       " +
              "          select q_Phone.t_Value                                                " +
              "          from (                                                                " +
              "                select Phone.t_Value                                            " +
              "                from dcontact_dbt Phone                                         " +
              "                where Phone.t_PartyID = person.t_PartyID                        " +
              "                      and Phone.t_ContactKind = 1                               " +
              "                      and Phone.t_ContactType = 2                               " +
              "                      and ROWNUM = 1                                            " +
              "                      order by Phone.t_IsMain DESC                              " +
              "                ) q_Phone                                                       " +
              "          where ROWNUM = 1                                                      " +
              "          ), chr(1)                                                             " +
              "        )  as t_Phone,                                                          " +
              "       nvl(                                                                     " +
              "        (                                                                       " +
              "              select q_Fax.t_Value                                              " +
              "              from (                                                            " +
              "                      select Fax.t_Value                                        " +
              "                      from dcontact_dbt Fax                                     " +
              "                      where Fax.t_PartyID = person.t_PartyID                    " +
              "                        and Fax.t_ContactKind = 3                               " +
              "                      order by Fax.t_IsMain DESC                                " +
              "                   ) q_Fax                                                      " +
              "              where ROWNUM = 1                                                  " +
              "              ), chr(1)                                                         " +
              "           ) as t_Fax,                                                          " +
              "        nvl(                                                                    " +
              "        (                                                                       " +
              "          select q_Email.t_Value                                                " +
              "          from (                                                                " +
              "                select Email.t_Value                                            " +
              "                from dcontact_dbt Email                                         " +
              "                where Email.t_PartyID = person.t_PartyID                        " +
              "                      and Email.t_ContactKind = 5                               " +
              "                      and Email.t_ContactType = 8                               " +
              "                      order by Email.t_IsMain DESC                              " +
              "                ) q_Email                                                       " +
              "          where ROWNUM = 1                                                      " +
              "          ), chr(1)                                                             " +
              "        )                                                                       " +
              "        as t_Email                                                              " +
              "from dofficer_dbt off,                                                          " +
              "     dpersOn_dbt  persOn,                                                       " +
              "     dpersn_dbt   persn,                                                        " +
              "     dparty_dbt   party                                                         " +
              "where persOn.t_Oper = "     + string({oper})                                      +
              "      and off.t_PartyID = " + string({OurBank})                                   +
              "      and off.t_PersonID = persOn.t_PartyID                                     " +
              "      and persn.t_PersonID = persOn.t_PartyID                                   " +
              "      and party.t_PartyID = off.t_PersonID ";   
      var executorSelect = DL_RSDCommand(executorQuery);
      var executorDS = executorSelect.Execute();
      if(executorDS.MoveNext())
         executorPost  = executorDS.Post;
         executorName  = m_executorName = executorDS.Name;//{Name_Oper}
         executorPhone = executorDS.Phone;
         executorEmail = executorDS.Email;
         executorFax   = executorDS.Fax;
      else
         executorPost = executorName = executorPhone = executorEmail = executorFax = "";
      end;    

      var leaderNodeName = "Руководитель";
      var leaderNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", leaderNodeName);
      atrAddToNode(leaderNode, "Должность", leaderPost, XML_ATTR_REQ, leaderNodeName);
      atrAddToNode(leaderNode, "ФИО",       leaderName, XML_ATTR_REQ, leaderNodeName);
      signers.add(leaderNode);
      
      var controllerNodeName = "Контролер";
      var controllerNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", controllerNodeName);
      atrAddToNode(controllerNode, "Должность", executorPost, XML_ATTR_REQ, controllerNodeName);
      atrAddToNode(controllerNode, "ФИО",       executorName, XML_ATTR_REQ, controllerNodeName);
      signers.add(controllerNode);

      var executorNodeName = "Исполнитель";
      var executorNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", executorNodeName);
      atrAddToNode(executorNode, "Должность", executorPost,  XML_ATTR_REQ, executorNodeName);
      atrAddToNode(executorNode, "ФИО",       executorName,  XML_ATTR_REQ, executorNodeName);
      atrAddToNode(executorNode, "Телефон",   executorPhone, XML_ATTR_REQ, executorNodeName);
      atrAddToNode(executorNode, "Факс",      executorFax,   XML_ATTR_OPTIONAL);
      atrAddToNode(executorNode, "ЭлПочта",   executorEmail, XML_ATTR_OPTIONAL);
      signers.add(executorNode);

      m_xmlReport.addInfoPart(registrationNumber,
                              BIC,
                              OKATO,
                              OKPO,
                              OGRN,
                              Name,
                              PostalAdress,
                              signers
                             );

      m_Protocol = m_XmlReport.getProtocol();
   end;

   macro BeginData712()
      var IdAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Ид", "1");
      var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var NullAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

      Attributes.add(IdAttribute);
      m_XmlReport.beginPart("Данные0409712", Attributes);
      m_XmlReport.beginPart("ДанныеФормы", NullAttributes);

      RowNum = 1;
   end;

   PRIVATE MACRO Delta_Fld( Val:VARIANT ):STRING
      VAR ValStr = "";

      if( Val != NULL ) 
        VAR vt = ValType(Val);
        if( vt == V_DATE )
           if( Val == DATE(0,0,0) )
              ValStr = "0";
           else
              VAlStr = YYYY_MM_DD(Val);
           end;
        elif( vt == V_STRING )
           ValStr = StrSubst( Val, "\"", "''" );
           ValStr = StrSubst( ValStr, "-", "0" );
           if (ValStr == "")
               ValStr = "0";
           end;      
        elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
          if( Val != 0.00)
            ValStr = trim(string(Val:18:2));
          else
            ValStr = "0.00";
          end;
        else
           ValStr = string(Val);
        end;
      else
        ValStr="0";
      end;

      return ValStr;
   END;

   macro AddLine(A1:String, A2:String, A3:Integer, A4:Integer, A5:Integer, A6:Money, A7:Money, A8:Integer, A9:Money, A10:Money, A11:Money,
                   A12:Money, A13:Money, A14:Money, A15:Money, A16:Money, A17:Money, A18:Money, A19:Money, A20:Money, A21:Money, A22:Money, A23:Money,
                   A24:Money, A25:Money, A26:Money, A27:Money, A28:Money, A29:Money
                  )
      var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrRowNum = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Номер_Строки", string(RowNum));
      attributes.add(attrRowNum);
      var attrA1 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Деятельность", Delta_Fld(A1));
      attributes.add(attrA1);
      var attrA2 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Налоговый_Вычет", Delta_Fld(A2));
      attributes.add(attrA2);
      var attrA3 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Договоров_Всего", Delta_Fld(A3));
      attributes.add(attrA3);
      var attrA4 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Договоров_Активных", Delta_Fld(A4));
      attributes.add(attrA4);
      var attrA5 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Договоров_Заключенных", Delta_Fld(A5));
      attributes.add(attrA5);
      var attrA6 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Средства_Всего", Delta_Fld(A6));
      attributes.add(attrA6);
      var attrA7 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Средства_Брокер", Delta_Fld(A7));
      attributes.add(attrA7);
      var attrA8 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Договоров_Прекращенных", Delta_Fld(A8));
      attributes.add(attrA8);
      var attrA9 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Средства_Возвр_Всего", Delta_Fld(A9));
      attributes.add(attrA9);
      var attrA10 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Средства_Возвр_Втч", Delta_Fld(A10));
      attributes.add(attrA10);
      var attrA11 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Руб", Delta_Fld(A11));
      attributes.add(attrA11);
      var attrA12 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Долл", Delta_Fld(A12));
      attributes.add(attrA12);
      var attrA13 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Евро", Delta_Fld(A13));
      attributes.add(attrA13);
      var attrA14 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_ИнВал", Delta_Fld(A14));
      attributes.add(attrA14);
      var attrA15 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Деп", Delta_Fld(A15));
      attributes.add(attrA15);
      var attrA16 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Об_Эмит", Delta_Fld(A16));
      attributes.add(attrA16);
      var attrA17 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Об_Рез", Delta_Fld(A17));
      attributes.add(attrA17);
      var attrA18 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Об_Нерез", Delta_Fld(A18));
      attributes.add(attrA18);
      var attrA19 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Деп_Серт", Delta_Fld(A19));
      attributes.add(attrA19);
      var attrA20 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Сбер_Серт", Delta_Fld(A20));
      attributes.add(attrA20);
      var attrA21 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Акции_Об", Delta_Fld(A21));
      attributes.add(attrA21);
      var attrA22 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Акции_Прив", Delta_Fld(A22));
      attributes.add(attrA22);
      var attrA23 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Акции_Нерез", Delta_Fld(A23));
      attributes.add(attrA23);
      var attrA24 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Паи_Нерез", Delta_Fld(A24));
      attributes.add(attrA24);
      var attrA25 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Паи_Рез", Delta_Fld(A25));
      attributes.add(attrA25);
      var attrA26 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Векс_Рез", Delta_Fld(A26));
      attributes.add(attrA26);
      var attrA27 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Деп_Расп", Delta_Fld(A27));
      attributes.add(attrA27);
      var attrA28 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_КлирСерт", Delta_Fld(A28));
      attributes.add(attrA28);
      var attrA29 = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Стр_Иное", Delta_Fld(A29));
      attributes.add(attrA29);

      m_XmlReport.addLine("Строки", attributes, "");

      RowNum = RowNum + 1;
   end;

   macro FinishData712()
      m_XmlReport.finishPart();
      m_XmlReport.finishPart();
   end;

   macro NoData()
      var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrCode = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодНепредоставления", "1");

      attributes.Add(attrCode);
      m_XmlReport.addLine("НетДанных", attributes);
   end;

   macro PrintProtocol()
      m_Protocol = m_XmlReport.getProtocol();

      var Errors = m_Protocol.getErrorsText();
      var attributesErrors = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusErrors = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "2");
      attributesErrors.add(attrStatusErrors);

      if(Errors != "")
         var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
         m_XmlReport.beginPart("ПротоколКонтроля", Attributes);
         var errs = SplitString(Errors, "\n"), i = 0;
         while(i < errs.Size)
            m_XmlReport.addLine("Сообщение", attributesErrors, errs[i]);
            i = i + 1;
         end;
         m_XmlReport.finishPart();
      end;
   end;
   

   MACRO GetXMLVer()
      return "0.1.4.5";
   END;

   macro GetFileName()
      return m_FileName;
   end;

   macro CreateXMLFile()
      return m_XmlReport.export(m_FileName);
   end;

   macro CreateTextProtocol()
      var errcode, errtext, Errors = "", ProtocolFileName = GetTxtFileName("expx_706");

      if( not Open( TextProtocol, ProtocolFileName, "rsoem" ) )
         errcode = status(errtext);
         RunError( "Ошибка при открытии файла протокола экспорта в ПК Дельта|"+ProtocolFileName+"|(" + errcode + ") " + errtext );
         return false;
      end;

      insert(TextProtocol, "Форма " + m_OKUD + ". Протокол экспорта в ПК ДЕЛЬТА");
      insert(TextProtocol, "");
      insert(TextProtocol, "Период отчета с " + m_BegDate + " по " + m_EndDate);
      insert(TextProtocol, "Дата и время выполнения процедуры " + date() + " " + strSubst(String(Time()), " ", "0"));
      insert(TextProtocol, "Исполнитель " + {oper} + " " + m_ExecutorName);
      insert(TextProtocol, "");
      insert(TextProtocol, "Режим Банк");
      insert(TextProtocol, "Версия XML-формата: urn:cbr-ru:rep" + m_OKUD + ":" + GetXMLVer());
      insert(TextProtocol, "Файл экспорта: " + m_FileName);

      Errors = m_XmlReport.getProtocol().getErrorsText();
      if (Errors == "")
         insert(TextProtocol, "Экспорт в xml-формате для формы " + m_OKUD + " выполнен успешно");
      else
         insert(TextProtocol, "При выполнении экспорта возникли ошибки:");
         insert(TextProtocol, Errors);
      end;

      close( TextProtocol );

      ViewFile( TextProtocol );

      return true;
   end;

   var DepCode;
   var DepCodeQuery = "select dp_dep.t_Name " +
                      "from ddp_dep_dbt dp_dep " +
                      "where dp_dep.t_Code = " + string({OperDprt});

   var DepCodeSelect = DL_RSDCommand(DepCodeQuery);
   var DepCodeDS = DepCodeSelect.Execute();
   if(DepCodeDS.MoveNext())
      DepCode = DepCodeDS.Name;
   else
      DepCode = "";
   end;

   private var dd;
   private var mm;
   DateSplit(m_EndDate, dd, mm, NULL);

   var len = strlen(DepCode);
   if(len < 4)
      var i = len;
      while(i < 4)
         DepCode = "0" + DepCode;
         i = i + 1;
      end;
   elif(len > 4)
      DepCode = SubStr(DepCode, 1, 4);
   end;

   m_FileName = "..\\txtFile\\" + m_OKUD + "_" + string(dd:o:2) + string(mm:o:2) + DepCode + ".xml";

   jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   m_XmlReport = jvm.createJavaObject("XMLReportExporter.XMLReport", "<init>", GetXMLVer(), OKUD, OKUD, ReportKind, String(EndDate : f), Periodicity);
   m_Protocol = m_XmlReport.getProtocol();
END;

PRIVATE CLASS RepLine()
   var A1, A2, A3 = 0, A4 = 0, A5 = 0, A6 = 0, A7 = 0, A8 = 0, A9 = $0,
       A10 = $0, A11 = $0, A12 = $0, A13 = $0, A14 = $0, A15 = $0, A16 = $0, A17 = $0, A18 = $0, A19 = $0,
       A20 = $0, A21 = $0, A22 = $0, A23 = $0, A24 = $0, A25 = $0, A26 = $0, A27 = $0, A28 = $0, A29 = $0;
END;

PRIVATE CLASS WrtInOut(pOUTKIND, pClient, pDate, pSum, pFiveWorkDayAfterOut)
   var OUTKIND=pOUTKIND, Client=pClient, WrtDate=pDate, Sum=pSum, FiveWorkDayAfterOut=pFiveWorkDayAfterOut;
END;

PRIVATE CLASS (DL_CReportTemplate) Dl_IIS712_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReport:BOOL )

   PRIVATE VAR m_BegDate = Date(0,0,0), m_EndDate = Date(0,0,0), m_IsExistsData = false, m_FIID_840 = -1, m_FIID_978 = -1, m_InKliko=false;
   PRIVATE VAR m_Array = TArray();
   PRIVATE VAR m_WrtIn = TArray();
   PRIVATE VAR m_WrtOut = TArray();
   PRIVATE VAR m_InDelta = false;
   PRIVATE VAR m_DeltaReport;

   PRIVATE VAR kliko_file_name; /*USR*/

   PRIVATE VAR M_PANEL_PERIOD;

/****************************************** Функции экспорта в kliko ********************************************************/ 
  PRIVATE MACRO Kliko_InsertInTxtFile( Str:STRING ):BOOL
    
    if( insert( Kliko_F712, Str ) == false )
       MsgBox( "Ошибка при вставке записи в файл Kliko" );
       return false;
    end;
    return true;
  END;

  /* ДДММГГ_F116, где ДДММГГ - дата, по состоянию на которую выпускается отчет. Расширение файла - номер операциониста в сети.*/
  PRIVATE MACRO Kliko_TxtFileName( RepDate:DATE ):STRING
    var Day, Month, Year;
    datesplit( RepDate, Day, Month, Year );
    Year = SubStr( string(Year), strlen(string(Year))-1 );

    kliko_file_name = string(Day:2:o)+string(Month:2:o)+string(Year:2:o)+"_F712";

    return GetTxtFileName( kliko_file_name );
  END;

  PRIVATE MACRO Kliko_CloseTxtFile(fileview:bool)
    //var kliko_file_name_term = "$C:\\SOFR\\EXPORT\\"+kliko_file_name+".dat";
    var kliko_file_name_term = "$txtfile\\"+kliko_file_name+".dat";
    
    close( Kliko_F712 );

    if(ExistFile(kliko_file_name_term))
        RemoveFile(kliko_file_name_term);
    end;

    copyFile(FileName(Kliko_F712),kliko_file_name_term,true,"Копирование на терминал"); 

    if(fileview)
      ViewFile( Kliko_F712 );
    end;
 
  END;

  PRIVATE MACRO Kliko_TxtFileExt(filename:string)
    return SubStr(filename,1,Index(filename,"2.") + 1) + "dat";  
  END;

  PRIVATE MACRO Kliko_OpenTxtFile( RepDate:DATE )
    VAR errcode, errtext;

    VAR fName = Kliko_TxtFileExt ( Kliko_TxtFileName( RepDate ) );

    if( not Open( Kliko_F712, fName, "rsoem" ) )
      errcode = status(errtext);
      RunError( "Ошибка при открытии файла для экспорта в kliko|"+fName+"|(" + errcode + ") " + errtext );
      return false;
    end;

    return true;
  END;

  PRIVATE MACRO Kliko_Fld( Val:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL ) 
      VAR vt = ValType(Val);
      if( vt == V_DATE )
         if( Val == DATE(0,0,0) )
            ValStr = "0";
         else
            ValStr = string(Val:f);
         end;
      elif( vt == V_STRING )
         ValStr = StrSubst( Val, "\"", "''" );
     ValStr = StrSubst( ValStr, "-", "0" );
         if (ValStr == "")
             ValStr = "0";
         end;      
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        if( Val != 0.00)
          ValStr = trim(string(Val:18:2));
        else
          ValStr = "0.00";    
        end;
      else
         ValStr = string(Val);
      end;
    else
      ValStr="0";
    end;

    return "\""+ValStr+"\"";
  END;

  PRIVATE MACRO PrintLineKliko(StrNum, A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21, A22, A23, A24, A25, A26, A27, A28, A29)


    return Kliko_InsertInTxtFile( Kliko_Fld( StrNum ) +","+
                                  Kliko_Fld( A1  ) +","+
                                  Kliko_Fld( A2  ) +","+
                                  Kliko_Fld( A3  ) +","+
                                  Kliko_Fld( A4  ) +","+ 
                                  Kliko_Fld( A5  ) +","+
                                  Kliko_Fld( A6  ) +","+
                                  Kliko_Fld( A7  ) +","+
                                  Kliko_Fld( A8  ) +","+
                                  Kliko_Fld( A9  ) +","+
                                  Kliko_Fld( A10 ) +","+
                                  Kliko_Fld( A11 ) +","+
                                  Kliko_Fld( A12 ) +","+
                                  Kliko_Fld( A13 ) +","+
                                  Kliko_Fld( A14 ) +","+
                                  Kliko_Fld( A15 ) +","+
                                  Kliko_Fld( A16 ) +","+
                                  Kliko_Fld( A17 ) +","+
                                  Kliko_Fld( A18 ) +","+
                                  Kliko_Fld( A19 ) +","+
                                  Kliko_Fld( A20 ) +","+
                                  Kliko_Fld( A21 ) +","+
                                  Kliko_Fld( A22 ) +","+
                                  Kliko_Fld( A23 ) +","+
                                  Kliko_Fld( A24 ) +","+
                                  Kliko_Fld( A25 ) +","+
                                  Kliko_Fld( A26 ) +","+
                                  Kliko_Fld( A27 ) +","+
                                  Kliko_Fld( A28 ) +","+
                                  Kliko_Fld( A29 )
                                );                   
  END;
/****************************************************************************************************************************/

   MACRO GetEndDate():DATE
      return m_EndDate;
   END;

   MACRO GetOkud():String
      return "0409712";
   END;

   MACRO GetReportKind():String
      return "КО";
   END;

   MACRO GetPeriodicity():Integer
      return RCB_XML_PK_QUARTERLY;
   END;

   /*только ексель*/
   PRIVATE MACRO PrintMode():INTEGER
      return DL_OUTREPORT_EXCEL;
   END;

   PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();
      var Month = 0,
          Year  = int(Dl_IIS712_Form.GetFieldValue(PNFLD_IIS712_YEAR)),
          NumQuartal = int(Dl_IIS712_Form.GetFieldValue(PNFLD_IIS712_PERIOD, @M_PANEL_PERIOD));

      m_InKliko = IIF( Dl_IIS712_Form.GetFieldValue(PNFLD_IIS712_KLIKO) == SET_CHAR, true, false );
      m_InDelta = IIF( Dl_IIS712_Form.GetFieldValue(PNFLD_IIS712_DELTA) == SET_CHAR, true, false );

      Month = (NumQuartal - 1) * 3 + 1;

      m_BegDate = Date(1, Month, Year);
      if( Month == 10 )
         m_EndDate = DATE(31,12,Year);
      else
         m_EndDate = Date(1, Month+3, Year)-1;
      end;

      m_Array[CODE_A] = RepLine();
      m_Array[CODE_B] = RepLine();
      m_Array[CODE_X] = RepLine();

      m_Array[CODE_A].A1 = "BR";
      m_Array[CODE_B].A1 = "BR";
      m_Array[CODE_X].A1 = "BR";

      m_Array[CODE_A].A2 = "A";
      m_Array[CODE_B].A2 = "B";
      m_Array[CODE_X].A2 = "X";

   END;

   MACRO RegisterTable_Report()
      SetActiveSheet( "Отчет" );
      PrintFormatString( NULL,
                         "N1_D0",  this.D0(),
                         "N1_H01", this.H01(),
                         "N1_H02", this.H02()
                       );
    CopyAllSheetInTotalBook("Отчет", false, "N1_Header", 0, "Отчет"); 
      RegisterTable( "N1_MainTable", "",
                     "N1_A1", 
                     "N1_A2", 
                     "N1_A3", 
                     "N1_A4", 
                     "N1_A5", 
                     "N1_A6", 
                     "N1_A7", 
                     "N1_A8", 
                     "N1_A9", 
                     "N1_A10",
                     "N1_A11",
                     "N1_A12",
                     "N1_A13",
                     "N1_A14",
                     "N1_A15",
                     "N1_A16",
                     "N1_A17",
                     "N1_A18",
                     "N1_A19",
                     "N1_A20",
                     "N1_A21",
                     "N1_A22",
                     "N1_A23",
                     "N1_A24",
                     "N1_A25",
                     "N1_A26",
                     "N1_A27",
                     "N1_A28",
                     "N1_A29" 
                   );

     if( m_InKliko )
       Kliko_InsertInTxtFile(String("<F712>"));
     end;

     if(m_InDelta)
       m_DeltaReport = F712DeltaXML(GetOKUD(), GetReportKind(), m_BegDate, m_EndDate, GetPeriodicity());
     end;

   END;

   MACRO SumIn1000(Sum:variant)
      return (Sum/1000);
   END;
 

MACRO AddFooter( CellPrefix:STRING, IsCurDate:BOOL, NoBook:BOOL )
  MACRO НачальникОтдела()
         var RS = TRsbDataSet("SELECT party.t_Name " +
                              "  FROM dofficer_dbt officer, dparty_dbt party " +
                              " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                              "       officer.t_OfficeID = " + string(SelfDivision) + " AND " +
                              "       officer.t_IsFirstOfficePerson = 'X' AND "
                              "       party.t_PartyID = officer.t_PersonID "
                             );

         if( RS.MoveNext() )
            return RS.Name;
         end;
         return "";
     END;

     MACRO Операционист()
         var RS = TRsbDataSet("SELECT person.t_Name " +
                              "  FROM dperson_dbt person " +
                              " WHERE person.t_Oper = " + string({oper})
                             );

         if( RS.MoveNext() )
            return RS.Name;
         end;
         return "";
     END;

     MACRO ДолжностьОперациониста()
         return "Исполнитель";
         var RS = TRsbDataSet("SELECT officer.t_Post " +
                              "  FROM dofficer_dbt officer, dperson_dbt person " +
                              " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                              "       person.t_Oper = " + string({oper}) + " AND " +
                              "       officer.t_PersonID = person.t_PartyID "
                             );

         if( RS.MoveNext() )
            return RS.Post;
         end;
         return "Ответственный сотрудник";
     END;

     MACRO ТелефонОперациониста()
         var PhoneNumber = "";
         var RS = TRsbDataSet("SELECT person.t_PartyID "
                              "  FROM dperson_dbt person " +
                              " WHERE person.t_Oper = " + string({oper})
                             );

         if( ( RS.MoveNext() ) and ( FindAdressContactValue( RS.PartyID, PTADDR_LEGAL, CNTADR_PHONENUMBER, PhoneNumber ) == 0 ) )
            return PhoneNumber;
         end;
         return "";
     END;

     var RepDate, PostBoss, PostBook;

     if( m_UseTemplate )
        if( CellPrefix == null )
           CellPrefix = "";
        end;

        if( IsCurDate )
           RepDate = {curdate};
        else
           RepDate = Date();
        end;

        if( {Name_Boss} )
           PostBoss = {Name_Boss};
        else
           PostBoss = "Директор банка";
        end;

        if( {Name_Book} )
           PostBook = {Name_Book};
        else
           PostBook = "Главный бухгалтер банка"
        end;
      SetActiveSheet( "Отчет" );
      PrintFormatString( NULL,
                         "N1_ДолжностьДиректора",     PostBoss + " _____________ ",
                         "N1_Директор",               {FIO_Boss},
                         "N1_ДолжностьГлавБух",       PostBook + " _____________ ",
                         "N1_ГлавБух",                {FIO_Book},
                         "N1_НачальникОтдела",        НачальникОтдела(),
                         "N1_ДолжностьОперациониста", ДолжностьОперациониста() + " _____________ ",
                         "N1_Операционист",           Операционист(),
                         "N1_ТелефонОперациониста",   ТелефонОперациониста(),
                         "N1_ДатаСоставления",        DL_DateToStr( RepDate )
                       );
     end;
     CopyAllSheetInTotalBook("Отчет", false, "N1_footer", 0, "Отчет");
  END;

   MACRO PrintTableLine_Report()
      var i = 0;

      if( m_IsExistsData == false )
         this.RegisterTable_Report();
         m_IsExistsData = true;
      end;

      if(m_InDelta)
         m_DeltaReport.PrintInfo();
         m_DeltaReport.BeginData712();
      end;
      SetActiveSheet( "Отчет" );
      while( i < m_Array.Size() )

         PrintTableLine( "N1_A1",  m_Array[i].A1,               null,
                         "N1_A2",  m_Array[i].A2,               null,
                         "N1_A3",  m_Array[i].A3,               null,
                         "N1_A4",  m_Array[i].A4,               null,
                         "N1_A5",  m_Array[i].A5,               null,
                         "N1_A6",  SumIn1000(m_Array[i].A6),    null,
                         "N1_A7",  SumIn1000(m_Array[i].A7),    null,
                         "N1_A8",  m_Array[i].A8,               null, 
                         "N1_A9",  SumIn1000(m_Array[i].A9),    null,
                         "N1_A10", SumIn1000(m_Array[i].A10),   null,
                         "N1_A11", SumIn1000(m_Array[i].A11),   null,
                         "N1_A12", SumIn1000(m_Array[i].A12),   null,
                         "N1_A13", SumIn1000(m_Array[i].A13),   null,
                         "N1_A14", SumIn1000(m_Array[i].A14),   null,  
                         "N1_A15", m_Array[i].A15,              null,/*Не заполняется.*/
                         "N1_A16", SumIn1000(m_Array[i].A16),   null,
                         "N1_A17", SumIn1000(m_Array[i].A17),   null,
                         "N1_A18", SumIn1000(m_Array[i].A18),   null,
                         "N1_A19", m_Array[i].A19,              null,/*Не заполняется.*/
                         "N1_A20", m_Array[i].A20,              null,/*Не заполняется.*/
                         "N1_A21", SumIn1000(m_Array[i].A21),   null,
                         "N1_A22", SumIn1000(m_Array[i].A22),   null,
                         "N1_A23", SumIn1000(m_Array[i].A23),   null,
                         "N1_A24", SumIn1000(m_Array[i].A24),   null,
                         "N1_A25", SumIn1000(m_Array[i].A25),   null,
                         "N1_A26", m_Array[i].A26,              null,/*Не заполняется.*/
                         "N1_A27", SumIn1000(m_Array[i].A27),   null,
                         "N1_A28", m_Array[i].A28,              null,/*Не заполняется.*/
                         "N1_A29", m_Array[i].A29,              null/*Не заполняется.*/
                       );
   
         if (m_InKliko == true)
            PrintLineKliko(i+1,
                            m_Array[i].A1,        
                            m_Array[i].A2,         
                            m_Array[i].A3,           
                            m_Array[i].A4,           
                            m_Array[i].A5,           
                            SumIn1000(m_Array[i].A6),
                            SumIn1000(m_Array[i].A7),
                            m_Array[i].A8,            
                            SumIn1000(m_Array[i].A9), 
                            SumIn1000(m_Array[i].A10),
                            SumIn1000(m_Array[i].A11),
                            SumIn1000(m_Array[i].A12),
                            SumIn1000(m_Array[i].A13),
                            SumIn1000(m_Array[i].A14),
                            m_Array[i].A15,           
                            SumIn1000(m_Array[i].A16),
                            SumIn1000(m_Array[i].A17),
                            SumIn1000(m_Array[i].A18),
                            m_Array[i].A19,
                            m_Array[i].A20,
                            SumIn1000(m_Array[i].A21),
                            SumIn1000(m_Array[i].A22),
                            SumIn1000(m_Array[i].A23),
                            SumIn1000(m_Array[i].A24),
                            SumIn1000(m_Array[i].A25),
                            m_Array[i].A26,
                            SumIn1000(m_Array[i].A27),
                            m_Array[i].A28,
                            m_Array[i].A29
                          );
         end;

         if(m_InDelta == true)
            m_DeltaReport.AddLine(m_Array[i].A1,        
                                  m_Array[i].A2,         
                                  m_Array[i].A3,           
                                  m_Array[i].A4,           
                                  m_Array[i].A5,           
                                  SumIn1000(m_Array[i].A6),
                                  SumIn1000(m_Array[i].A7),
                                  m_Array[i].A8,            
                                  SumIn1000(m_Array[i].A9), 
                                  SumIn1000(m_Array[i].A10),
                                  SumIn1000(m_Array[i].A11),
                                  SumIn1000(m_Array[i].A12),
                                  SumIn1000(m_Array[i].A13),
                                  SumIn1000(m_Array[i].A14),
                                  m_Array[i].A15,           
                                  SumIn1000(m_Array[i].A16),
                                  SumIn1000(m_Array[i].A17),
                                  SumIn1000(m_Array[i].A18),
                                  m_Array[i].A19,
                                  m_Array[i].A20,
                                  SumIn1000(m_Array[i].A21),
                                  SumIn1000(m_Array[i].A22),
                                  SumIn1000(m_Array[i].A23),
                                  SumIn1000(m_Array[i].A24),
                                  SumIn1000(m_Array[i].A25),
                                  m_Array[i].A26,
                                  SumIn1000(m_Array[i].A27),
                                  m_Array[i].A28,
                                  m_Array[i].A29
                                 );
         end;

         i = i + 1;
      end;
      EndTable();

      CopyAllSheetInTotalBook("Отчет", false, GetTableRange(), 0, "Отчет");  
      AddFooter( "N1_" );
       
      if(m_InDelta == true)
         if(i > 0)
            m_DeltaReport.FinishData712();
         else
            m_DeltaReport.NoData();
         end;

         m_DeltaReport.PrintProtocol();
      end;
   END;                         

   MACRO D0():string
      return "по состоянию на "+DL_DateToStr(m_EndDate+1);
   END;

   MACRO H01():string
      return {Name_Bank};
   END;

   MACRO H02():string
      return {Real_Addr};
   END;

   /*Количество договоров на ведение индивидуальных инвестиционных счетов на отчетную дату*/
   MACRO Load_A3()
     var cmd, DataSet;
     cmd = DL_RSDCommand( "select count(1) Q, T_OUTKIND "
                         +"  from ( select t.T_PartyID, t.T_DLCONTRID, t.T_OUTKIND " 
                         +"           from DDLIIS712_TMP t "
                         +"          where t.T_DATECLOSE > ? "
                         +"         group by t.T_OUTKIND, t.T_PartyID, t.T_DLCONTRID "
                         +"       ) "                  
                         +" group by T_OUTKIND"
                        );

     cmd.addParam( m_EndDate );

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
       if( DataSet.OUTKIND == 1 )
          m_Array[CODE_A].A3 = m_Array[CODE_A].A3 + SQL_ConvTypeSum(DataSet.Q);
       elif( DataSet.OUTKIND == 2 )
          m_Array[CODE_B].A3 = m_Array[CODE_b].A3 + SQL_ConvTypeSum(DataSet.Q);
       else
          m_Array[CODE_X].A3 = m_Array[CODE_x].A3 + SQL_ConvTypeSum(DataSet.Q);
       end;
     end;
   END;

   /*Количество договоров на ведение индивидуальных инвестиционных счетов на отчетную дату, шт._в том числе активных*/
   MACRO Load_A4()
     var cmd, DataSet;
     var sql_date_begin = GetSQLDate(m_BegDate);
     var sql_date_end   = GetSQLDate(m_EndDate);
 
     var q = " SELECT COUNT(frm.ID) AS Q,"
           + "        frm.OutKind   AS OutKind"
           + "   FROM (SELECT DISTINCT * from ( /*+ parallel( t 8)*/ SELECT t.T_DLCONTRID     AS ID,"
           + "                t.t_OutKind AS OutKind"
           + "           FROM dsfcontr_dbt sf,"
           + "                DDLIIS712_TMP t,"
           + "                ddl_tick_dbt  tick"
           + "          WHERE     sf.t_ID            = t.t_SFContrID"
           + "                AND t.t_DateClose      > " + sql_date_end
           + "                AND tick.t_ClientID    = t.t_PartyID"
           + "                AND tick.t_BofficeKind = " + DL_SECURITYDOC
           + "                AND tick.t_DealStatus  > 0"
           + "                AND (   tick.t_ClientContrID = sf.t_ID"
           + "                     OR EXISTS (SELECT 1"
           + "                                  FROM dsfcontr_dbt   rel,"
           + "                                       ddlcontrmp_dbt mp"
           + "                                 WHERE     mp.t_SFContrID       = rel.t_ID"
           + "                                       AND mp.t_DLContrID       = t.t_DLContrID"
           + "                                       AND tick.t_ClientContrID = rel.t_id))"
           + "                AND tick.t_DealDate BETWEEN " + sql_date_begin + " AND " + sql_date_end
           + "         UNION ALL"
           + "         SELECT /*+ parallel( t 8)*/ t.T_DLCONTRID      AS ID,"
           + "                t.t_OutKind AS OutKind"
           + "           FROM dsfcontr_dbt sf,"
           + "                DDLIIS712_TMP t,"
           + "                ddl_tick_dbt  tick"
           + "          WHERE     sf.t_ID              = t.t_SFContrID"
           + "                AND t.t_DateClose        > " + sql_date_end
           + "                AND tick.t_PartyID       = t.t_PartyID"
           + "                AND tick.t_IsPartyClient = 'X'"
           + "                AND tick.t_BofficeKind   = " + DL_SECURITYDOC
           + "                AND tick.t_DealStatus    > 0"
           + "                AND (   tick.t_PartyContrID = sf.t_ID"
           + "                     OR EXISTS (SELECT 1"
           + "                                  FROM dsfcontr_dbt   rel,"
           + "                                       ddlcontrmp_dbt mp"
           + "                                 WHERE     mp.t_SFContrID      = rel.t_ID"
           + "                                       AND mp.t_DLContrID      = t.t_DLContrID"
           + "                                       AND tick.t_PartyContrID = rel.t_id))"
           + "                AND tick.t_DealDate BETWEEN " + sql_date_begin + " AND " + sql_date_end
           + "         UNION ALL"
           + "         SELECT /*+ parallel( t 8)*/ t.T_DLCONTRID      AS ID,"
           + "                t.t_OutKind AS OutKind"
           + "           FROM dsfcontr_dbt sf,"
           + "                DDLIIS712_TMP t,"
           + "                ddvndeal_dbt  dvn"
           + "          WHERE     sf.t_ID       = t.t_SFContrID"
           + "                AND t.t_DateClose > " + sql_date_end
           + "                AND dvn.t_Client  = t.t_PartyID"
           + "                AND dvn.t_State   > 0"
           + "                AND (   dvn.t_ClientContr = sf.t_ID"
           + "                     OR EXISTS (SELECT 1"
           + "                                  FROM dsfcontr_dbt   rel,"
           + "                                       ddlcontrmp_dbt mp"
           + "                                 WHERE     mp.t_SFContrID    = rel.t_ID"
           + "                                       AND mp.t_DLContrID    = t.t_DLContrID"
           + "                                       AND dvn.t_ClientContr = rel.t_id))"
           + "                AND dvn.t_Date BETWEEN " + sql_date_begin + " AND " + sql_date_end
           + "         UNION ALL"
           + "         SELECT /*+ parallel( t 8)*/ t.T_DLCONTRID      AS ID,"
           + "                t.t_OutKind AS OutKind"
           + "           FROM dsfcontr_dbt sf,"
           + "                DDLIIS712_TMP t,"
           + "                ddvdeal_dbt  dv"
           + "          WHERE     sf.t_ID       = t.t_SFContrID"
           + "                AND t.t_DateClose > " + sql_date_end
           + "                AND dv.t_Client   = t.t_PartyID"
           + "                AND dv.t_State    > 0"
           + "                AND (   dv.t_ClientContr = sf.t_ID"
           + "                     OR EXISTS (SELECT 1"
           + "                                  FROM dsfcontr_dbt   rel,"
           + "                                       ddlcontrmp_dbt mp"
           + "                                 WHERE     mp.t_SFContrID   = rel.t_ID"
           + "                                       AND mp.t_DLContrID   = t.t_DLContrID"
           + "                                       AND dv.t_ClientContr = rel.t_id))"
           + "                AND dv.t_Date BETWEEN " + sql_date_begin + " AND " + sql_date_end
           + "        ) ) frm"
           + " GROUP BY frm.OutKind";

     cmd = DL_RSDCommand(q);

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
       if( DataSet.OUTKIND == 1 )
          m_Array[CODE_A].A4 = m_Array[CODE_A].A4 + SQL_ConvTypeSum(DataSet.Q);
       elif( DataSet.OUTKIND == 2 )
          m_Array[CODE_B].A4 = m_Array[CODE_B].A4 + SQL_ConvTypeSum(DataSet.Q);
       else
          m_Array[CODE_X].A4 = m_Array[CODE_X].A4 + SQL_ConvTypeSum(DataSet.Q);
       end;
     end;
   END;

   MACRO Load_A5()
     var cmd, DataSet;
     cmd = DL_RSDCommand( "select count(1) Q, T_OUTKIND "
                         +"  from ( select t.T_PartyID, t.T_DLCONTRID, t.T_OUTKIND " 
                         +"           from DDLIIS712_TMP t "
                         +"          where t.T_DATECONC >= ? and t.T_DATECONC <= ? "
                         +"         group by t.T_OUTKIND, t.T_PartyID, t.T_DLCONTRID "
                         +"       ) "                  
                         +" group by T_OUTKIND"
                        );

     cmd.addParam( m_BegDate );
     cmd.addParam( m_EndDate );

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
       if( DataSet.OUTKIND == 1 )
          m_Array[CODE_A].A5 = m_Array[CODE_A].A5 + SQL_ConvTypeSum(DataSet.Q);
       elif( DataSet.OUTKIND == 2 )
          m_Array[CODE_B].A5 = m_Array[CODE_B].A5 + SQL_ConvTypeSum(DataSet.Q);
       else
          m_Array[CODE_X].A5 = m_Array[CODE_X].A5 + SQL_ConvTypeSum(DataSet.Q);
       end;
     end;
   END;

   MACRO Load_A6_A9()
     var cmd, DataSet;
     var Sum = $0;
   
     var sql_date_begin = GetSQLDate(m_BegDate);
     var sql_date_end   = GetSQLDate(m_EndDate);
                                  
     var query = "    SELECT /*+ parallel( t 8)*/ NVL(SUM(RSB_FIInstr.ConvSum(pm.t_Amount, pm.t_FIID, " + NATCUR + ", " + sql_date_end + ")), 0) AS InOutSum,"
           + "           t.t_OutKind,"
           + "           op.t_SubKind_Operation"
           + "      FROM dnptxop_dbt op,"
           + "           dpmpaym_dbt pm,"
           + "           DDLIIS712_TMP t"
           + "     WHERE     op.t_DocKind     = " + DL_WRTMONEY
           + "           AND op.t_OperDate   <= " + sql_date_end
           + "           AND op.t_Client      = t.t_PartyID"
           + "           AND op.t_Contract    = t.T_SFCONTRID"
           + "           AND pm.t_DocKind     = op.t_DocKind"
           + "           AND pm.t_DocumentID  = op.t_ID"
           + "           AND pm.t_Purpose     = " + BAi
           + "           AND pm.T_PAYMSTATUS <> 0 "  
           + "           AND pm.t_ValueDate  >= " + sql_date_begin
           + "           AND pm.t_ValueDate  <= " + sql_date_end
           + "  GROUP BY t.t_OutKind,"
           + "           op.t_SubKind_Operation"
           + " UNION ALL"
           + "    SELECT /*+ parallel( t 8)*/ NVL(SUM(RSB_FIInstr.ConvSum(rq.t_Amount, rq.t_FIID, " + NATCUR + ", " + sql_date_end + ")), 0) AS InOutSum,"
           + "           t.T_OutKind,"
           + "           op.t_SubKind_Operation"
           + "      FROM dnptxop_dbt op,"
           + "           ddlrq_dbt rq,"
           + "           DDLIIS712_TMP t"
           + "     WHERE     op.t_DocKind   = " + DL_WRTMONEY
           + "           AND op.t_OperDate <= " + sql_date_end
           + "           AND op.t_Client    = t.t_PartyID"
           + "           AND op.t_Contract  = t.T_SFCONTRID"
           + "           AND rq.t_DocKind   = op.t_DocKind"
           + "           AND rq.t_DocID     = op.t_ID"
           + "           AND rq.t_Kind      = CASE WHEN op.t_SubKind_Operation = " + DL_NPTXOP_WRTKIND_ENROL
           + "                                     THEN " + DLRQ_KIND_COMMIT
           + "                                     ELSE " + DLRQ_KIND_REQUEST
           + "                                 END"
           + "           AND rq.t_FactDate >= " + sql_date_begin
           + "           AND rq.t_FactDate <= " + sql_date_end
           + "  GROUP BY t.T_OutKind,"
           + "           op.t_SubKind_Operation";

       cmd = DL_RSDCommand(query);

       DataSet = cmd.Execute();
       while(DataSet.moveNext())
         if( DataSet.SubKind_Operation == DL_NPTXOP_WRTKIND_ENROL )/*зачисление*/
           if( DataSet.OUTKIND == 1 )
              m_Array[CODE_A].A6 = m_Array[CODE_A].A6 + SQL_ConvTypeSum(DataSet.InOutSum);
           elif( DataSet.OUTKIND == 2 )
              m_Array[CODE_B].A6 = m_Array[CODE_B].A6 + SQL_ConvTypeSum(DataSet.InOutSum);
           else
              m_Array[CODE_X].A6 = m_Array[CODE_X].A6 + SQL_ConvTypeSum(DataSet.InOutSum);
           end;
         else/*списание*/
           if( DataSet.OUTKIND == 1 )
              m_Array[CODE_A].A9 = m_Array[CODE_A].A9 + SQL_ConvTypeSum(DataSet.InOutSum);
           elif( DataSet.OUTKIND == 2 )
              m_Array[CODE_B].A9 = m_Array[CODE_B].A9 + SQL_ConvTypeSum(DataSet.InOutSum);
           else
              m_Array[CODE_X].A9 = m_Array[CODE_X].A9 + SQL_ConvTypeSum(DataSet.InOutSum);
           end;
         end;
       end;
   END;

   MACRO Load_A7()
   END;

   MACRO Load_A8()
     var cmd, DataSet;
     cmd = DL_RSDCommand( "select count(1) Q, T_OUTKIND "
                         +"  from ( select t.T_PartyID, t.T_DLCONTRID, t.T_OUTKIND " 
                         +"           from DDLIIS712_TMP t "
                         +"          where t.T_DATECLOSE >= ? and t.T_DATECLOSE <= ? "
                         +"         group by t.T_OUTKIND, t.T_PartyID, t.T_DLCONTRID "
                         +"       ) "                  
                         +" group by T_OUTKIND"
                        );

     cmd.addParam( m_BegDate );
     cmd.addParam( m_EndDate );

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
       if( DataSet.OUTKIND == 1 )
          m_Array[CODE_A].A8 = m_Array[CODE_A].A8 + SQL_ConvTypeSum(DataSet.Q);
       elif( DataSet.OUTKIND == 2 )
          m_Array[CODE_B].A8 = m_Array[CODE_B].A8 + SQL_ConvTypeSum(DataSet.Q);
       else
          m_Array[CODE_X].A8 = m_Array[CODE_X].A8 + SQL_ConvTypeSum(DataSet.Q);
       end;
     end;
   END;

   MACRO Load_A10()
   END;                               

   MACRO Load_A_11_12_13()
     var cmd, DataSet;

     var query = "   SELECT NVL(SUM(RSB_ACCOUNT.RestAC(t_Account, t_FIID, " + GetSQLDate(m_EndDate) + ", t_Chapter, NULL)), 0) AS t_Rest,"
               + "          t_OutKind,"
               + "          t_FIID"
               + "     FROM (  SELECT t.t_OutKind,"
               + "                    sett.t_Account,"
               + "                    sett.T_Chapter,"
               + "                    sett.t_FIID"
               + "               FROM DDLIIS712_TMP t,"
               + "                    dsfssi_dbt    sfsi,"
               + "                    dsettacc_dbt  sett"
               + "              WHERE     sfsi.t_ObjectType = " + OBJTYPE_SFCONTR
               + "                    AND sfsi.t_ObjectID   = TO_CHAR(T.t_SfContrID, 'FM0999999999')"
               + "                    AND sfsi.t_FIKind     = " + FIKIND_CURRENCY
               + "                    AND sett.t_SettAccID  = sfsi.t_SetAccID"
               + "                    AND sett.t_FIID IN (" + NATCUR + ", " + m_FIID_840 + ", " + m_FIID_978 + ")"
               + "                    AND SUBSTR(sett.t_Account, 1, 5) IN ('30601', '30606')"
               + "           GROUP BY t.t_OutKind,"
               + "                    sett.t_Account,"
               + "                    sett.t_Chapter,"
               + "                    sett.t_FIID"
               + "              UNION "
               + "             SELECT t.t_OutKind,"
               + "                    acc.t_Account,"
               + "                    acc.t_Chapter,"
               + "                    acc.t_Code_Currency AS t_FIID"
               + "               FROM DDLIIS712_TMP   t,"
               + "                    ddlcontracc_dbt dlacc,"
               + "                    daccount_dbt    acc"
               + "              WHERE     t.t_DLContrID     > 0"
               + "                    AND dlacc.t_DLContrID = t.t_DLContrID"
               + "                    AND acc.t_AccountID   = dlacc.t_AccountID"
               + "                    AND acc.t_Code_Currency IN (" + NATCUR + ", " + m_FIID_840 + ", " + m_FIID_978 + ")"
               + "           GROUP BY t.t_OutKind,"
               + "                    acc.t_Account,"
               + "                    acc.t_Chapter,"
               + "                    acc.t_Code_Currency)"
               + " GROUP BY t_OutKind,"
               + "          t_FIID";

     cmd = DL_RSDCommand(query);

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
       if( DataSet.FIID == NATCUR )
          if( DataSet.OUTKIND == 1 )
             m_Array[CODE_A].A11 = m_Array[CODE_A].A11 + SQL_ConvTypeSum(DataSet.Rest);
          elif( DataSet.OUTKIND == 2 )
             m_Array[CODE_B].A11 = m_Array[CODE_B].A11 + SQL_ConvTypeSum(DataSet.Rest);
          else
             m_Array[CODE_X].A11 = m_Array[CODE_X].A11 + SQL_ConvTypeSum(DataSet.Rest);
          end;
       elif( DataSet.FIID == m_FIID_840 )
          if( DataSet.OUTKIND == 1 )
             m_Array[CODE_A].A12 = m_Array[CODE_A].A12 + SQL_ConvTypeSum(DataSet.Rest);
          elif( DataSet.OUTKIND == 2 )
             m_Array[CODE_B].A12 = m_Array[CODE_B].A12 + SQL_ConvTypeSum(DataSet.Rest);
          else
             m_Array[CODE_X].A12 = m_Array[CODE_X].A12 + SQL_ConvTypeSum(DataSet.Rest);
          end;
       else/*m_FIID_978*/
          if( DataSet.OUTKIND == 1 )
             m_Array[CODE_A].A13 = m_Array[CODE_A].A13 + SQL_ConvTypeSum(DataSet.Rest);
          elif( DataSet.OUTKIND == 2 )
             m_Array[CODE_B].A13 = m_Array[CODE_B].A13 + SQL_ConvTypeSum(DataSet.Rest);
          else
             m_Array[CODE_X].A13 = m_Array[CODE_X].A13 + SQL_ConvTypeSum(DataSet.Rest);
          end;
       end;
     end;

   END;

   MACRO Load_A14()
     var cmd, DataSet;
     cmd = DL_RSDCommand( " SELECT Nvl(sum(RSB_FIInstr.ConvSum(rsb_account.restac(t_Account, t_FIID, ?, T_CHAPTER, null), t_FIID, ?, ?)),0) as t_Rest, T_OUTKIND "
                         +"  FROM ( SELECT T.T_OUTKIND, sett.t_Account, sett.T_CHAPTER, sett.t_FIID "
                         +"           FROM DDLIIS712_TMP t, dsfssi_dbt sfsi, dsettacc_dbt sett "
                         +"          WHERE T.T_DLCONTRID = 0 "
                         +"            and sfsi.t_ObjectType = " + OBJTYPE_SFCONTR
                         +"            and sfsi.t_ObjectID = TO_CHAR(T.T_SFCONTRID ,'FM0999999999') "     
                         +"            and SFSI.T_FIKIND = ? "
                         +"            and sett.t_SettAccID = sfsi.t_SetAccID "
                         +"            and sett.t_FIID not in(?,?,?) "                   
                         +"            and substr(sett.t_Account, 1,5) IN ('30601', '30606') "
                         +"        group by T.T_OUTKIND, sett.t_Account, sett.T_CHAPTER, sett.t_FIID "
                         +"       union all "                                                               
                         +"        SELECT T.T_OUTKIND, ACC.T_ACCOUNT, ACC.T_CHAPTER, ACC.T_CODE_CURRENCY t_FIID "
                         +"          FROM DDLIIS712_TMP t, ddlcontracc_dbt DLACC, daccount_dbt acc, dfininstr_dbt fin "    
                         +"         WHERE T.T_DLCONTRID > 0 "                                             
                         +"           and DLACC.T_DLCONTRID = T.T_DLCONTRID "                            
                         +"           and DLACC.T_ACCOUNTID > 0 "
                         +"           and ACC.T_ACCOUNTID = DLACC.T_ACCOUNTID "                         
                         +"           and ACC.T_CODE_CURRENCY not in(?,?,?) "
                         +"           and fin.t_FIID = ACC.T_CODE_CURRENCY " 
                         +"           and fin.t_FI_Kind = ? "
                         +"        group by T.T_OUTKIND, ACC.T_ACCOUNT, ACC.T_CHAPTER, ACC.T_CODE_CURRENCY "                
                         +"       ) "
                         +" group by T_OUTKIND"                                               
                        );                                        

     cmd.addParam( m_EndDate );
     cmd.addParam( NATCUR );
     cmd.addParam( m_EndDate );
     cmd.addParam( FIKIND_CURRENCY );
     cmd.addParam( NATCUR );
     cmd.addParam( m_FIID_840 );
     cmd.addParam( m_FIID_978 );
     cmd.addParam( NATCUR );
     cmd.addParam( m_FIID_840 );
     cmd.addParam( m_FIID_978 );
     cmd.addParam( FIKIND_CURRENCY );

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
        if( DataSet.OUTKIND == 1 )
           m_Array[CODE_A].A14 = m_Array[CODE_A].A14 + SQL_ConvTypeSum(DataSet.Rest);
        elif( DataSet.OUTKIND == 2 )
           m_Array[CODE_B].A14 = m_Array[CODE_B].A14 + SQL_ConvTypeSum(DataSet.Rest);
        else
           m_Array[CODE_X].A14 = m_Array[CODE_X].A14 + SQL_ConvTypeSum(DataSet.Rest);
        end;
     end;

   END;

   MACRO ErrorMsgsForA16_A27(Cost, FI_Code, HasNominal, NominalDate)
      if( Cost == 0.0 )
         msgbox("Для ц/б с кодом \"" + FI_Code + "\" не задан ни один из курсов вида \"Средневзвешенная цена\" и \"Цена закрытия\"");
      end;

      if (HasNominal == 0)
         if (NominalDate != null)
            var nom_date_str = substr(string(NominalDate), 1, 10);
            msgbox("По ц/б c кодом \"" + FI_Code + "\" не задан номинал на дату отчета. В расчете использован номинал за прошлую дату: " + nom_date_str);
         else
            msgbox("По ц/б c кодом \"" + FI_Code + "\" не задан номинал на дату отчета.");
         end;
      end;
   END;

   MACRO DelD712SumByFIID()
     var cmd = RSDCommand("call RSB_712.DelD712SumByFIID(?)"); 
       cmd.addParam( "", RSDBP_IN, m_SessionID);
       cmd.execute();
   END;

   MACRO LoadSumByFIID()
     var cmd, DataSet, i = 0, Cost = $0;
     var NRec = 0, ProgressIndicator = TProgressBar();

     var sql_date_end = GetSqlDate(m_EndDate);

      var q = "  INSERT INTO D712SumByFIID_DBT  "
           + "   SELECT frm.t_FIID,"
           + "        frm.t_FI_Code,"
           + "        frm.t_AvoirKind,"
           + "        frm.t_AvrKindRoot,"
           + "        frm.t_OutKind,"
           + "        frm.t_EmiID,"
           + "        CASE WHEN (    frm.t_AvrKindRoot = " + AVOIRISSKIND_BOND // Облигация (17)
           + "                   AND EXISTS (SELECT 1"
           + "                                 FROM dpartyown_dbt partyown"
           + "                                WHERE     partyown.t_PartyID = frm.t_EmiID"
           + "                                      AND partyown.t_PartyKind IN (" + PTK_FEDJUR + ", "             // Федеральный орган исполнительной власти (55)
           +                                                                         PTK_LOCALGOVERNINGINST + ", " // Местный орган исполнительной власти (26)
           +                                                                         PTK_CENTRBANK + ")))"         // Центральный банк (29)
           + "                   OR frm.isGos = 1 OR frm.isMuni = 1 "
           + "             THEN 1"
           + "             ELSE 0"
           + "         END t_IsEmiKind,"
           + "        (SELECT CASE pt.t_NotResident WHEN 'X' THEN 1 ELSE 0 END"
           + "           FROM dparty_dbt pt"
           + "          WHERE pt.t_PartyID = frm.t_EmiID) t_EmiNotRes, frm.t_Amount , frm.t_MarketId,frm.t_FI_Kind, 0,0 , TO_DATE('01.01.0001', 'DD.MM.YYYY'), "+m_SessionID+" "
           + "   FROM (SELECT fin.t_FIID,"
           + "                fin.t_FI_Code,"
           + "                fin.t_FI_Kind,"
           + "                fin.t_AvoirKind,"
           + "                lots.t_OutKind,"
           + "                lots.t_Amount,"
           + "                RSI_RSB_FIINSTR.FI_GetIssuerOnDate(fin.t_FIID, " + sql_date_end + ") t_EmiID, "
           + "                RSI_RSB_FIINSTR.FI_AvrKindsGetRoot(fin.t_FI_Kind, fin.t_AvoirKind) t_AvrKindRoot,"
           + "                (SELECT mp.t_MarketId "
           + "                   FROM dsfcontr_dbt sfcontr, ddlcontrmp_dbt mp "
           + "                  WHERE sfcontr.t_Id = lots.t_SFContrID "
           + "                    AND sfcontr.t_ServKindSub = 8 "
           + "                    AND mp.t_SFContrID = sfcontr.t_Id) t_MarketId, "
           + "                RSB_FIInstr.FI_AvrKindsEQ(fin.t_fi_kind,21,fin.T_AVOIRKIND) isGos, "
           + "                RSB_FIInstr.FI_AvrKindsEQ(fin.t_fi_kind,31,fin.T_AVOIRKIND) isMuni "
           + "           FROM dfininstr_dbt fin,"
           + "                (  SELECT SUM(lot.t_Amount) t_Amount,"
           + "                          lot.t_FIID,"
           + "                          t.t_OutKind,"
           + "                          t.t_SFContrID "
           + "                     FROM dpmwrtcl_dbt  lot,"
           + "                          DDLIIS712_TMP t"
           + "                    WHERE     lot.t_Contract  = t.t_SFContrID"
           + "                          AND lot.t_BegDate  <= " + sql_date_end
           + "                          AND lot.t_EndDate  >= " + sql_date_end
           + "                 GROUP BY t.t_OutKind,"
           + "                          lot.t_FIID,"
           + "                          t.t_SFContrID) lots"
           + "          WHERE fin.t_FIID = lots.t_FIID) frm"
           + " ORDER BY frm.t_OutKind,"
           + "          frm.t_AvrKindRoot,"
           + "          frm.t_AvoirKind,"
           + "          frm.t_FIID";

     DelD712SumByFIID();
     var cmdI = RSDCommand(q);
     cmdI.execute();

     cmd = DL_RSDCommand("select * from D712SumByFIID_DBT where SessionID = " + m_SessionID + " ");

     NRec = cmd.GetCount();
     if( NRec > 0 )
        ProgressIndicator.init(NRec, "Расчет рыночной стоимости ц/б для каждого из договоров в группе", "Расчет рыночной стоимости ц/б для каждого из договоров в группе");

        var cmdC = RSDCommand("call RSB_712.DS712SumByFIID(?,?)"); 
        cmdC.addParam( "", RSDBP_IN, m_SessionID);
        cmdC.addParam( "", RSDBP_IN, GetSQLDate(m_EndDate) );
        cmdC.execute();

        DataSet = cmd.execute();

        while(DataSet.MoveNext())
       
           if( DataSet.OUTKIND == 1 )
              i = CODE_A;
           elif( DataSet.OUTKIND == 2 )
              i = CODE_B;
           else
              i = CODE_X;
           end;
       
           Cost = SQL_ConvTypeSum(DataSet.Cost);
       
           if( DataSet.AvrKindRoot == AVOIRISSKIND_BOND )
              if( (DataSet.IsEmiKind == 1) and (DataSet.EmiNotRes == 0) )
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A16 = m_Array[i].A16 + Cost;
              elif( DataSet.EmiNotRes == 0 )
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A17 = m_Array[i].A17 + Cost;
              else
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A18 = m_Array[i].A18 + Cost;
              end;
           elif( DataSet.AvrKindRoot == AVOIRISSKIND_SHARE )
              if( (DataSet.AVOIRKIND == AVOIRISSKIND_EQUITY_SHARE) and (DataSet.EmiNotRes == 0) )
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A21 = m_Array[i].A21 + Cost;
              elif( (DataSet.AVOIRKIND == AVOIRISSKIND_PREFERENCE_SHARE) and (DataSet.EmiNotRes == 0)  )
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A22 = m_Array[i].A22 + Cost;
              elif( DataSet.EmiNotRes == 1 )
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A23 = m_Array[i].A23 + Cost;
              end;
           elif( DataSet.AvrKindRoot == AVOIRISSKIND_INVESTMENT_SHARE )
              if( DataSet.EmiNotRes == 1 )
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A24 = m_Array[i].A24 + Cost;
              else
                 ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
                 m_Array[i].A25 = m_Array[i].A25 + Cost;
              end;
           elif( DataSet.AvrKindRoot == AVOIRISSKIND_DEPOSITORY_RECEIPT )
              ErrorMsgsForA16_A27(Cost, DataSet.FI_CODE, DataSet.HasNominal, DataSet.NominalDate);
              m_Array[i].A27 = m_Array[i].A27 + Cost;
           end;
       
           ProgressIndicator.Use;
        end;
        ProgressIndicator.Remove;
     end;
     DelD712SumByFIID();
   END;

   PRIVATE MACRO QueryFrom_7_10(pIs7:bool)

     return  " from (select NVL(sum(RSB_FIInstr.ConvSum(rq.t_Amount, rq.T_FIID, 0, ?)), 0) as t_Sum,"
                  +"        rq.t_FactDate t_Date,"
                  +"        OP.T_CLIENT   t_Client,"
                  +"        T.T_OUTKIND   t_OutKind"
                  +"   from DDLIIS712_TMP t,"
                  +"        dnptxop_dbt op,"
                  +"        ddlrq_dbt rq "
                  +"        where op.t_DocKind = ? " 
                  +"          and op.t_OperDate <= ? "
                  +"          and op.t_Contract = t.T_SfContrID "
                  +"          and rq.t_DocKind = op.t_DocKind "
                  +"          and rq.t_DocID = op.t_ID "
                  +"          and op.t_SubKind_Operation = ? "
                  +"          and rq.t_Kind = ? "
                  +"          and RQ.T_SUBKIND = 0 "
                  +"          and rq.t_FactDate >= ? "
                  +"          and rq.t_FactDate <= ? "
                  +"        group by T.T_OUTKIND, OP.T_CLIENT, rq.t_FactDate " 
                  +" union all"
                  +" select NVL(sum(RSB_FIInstr.ConvSum(paym.t_Amount, paym.T_FIID, 0, ?)), 0) as T_Sum,"
                  +"         paym.t_ValueDate T_Date,"
                  +"         OP.T_CLIENT      t_Client,"
                  +"         t.T_OUTKIND      t_OutKind"
                  +"    from DDLIIS712_TMP t,"
                  +"         dnptxop_dbt op,"
                  +"         dpmpaym_dbt paym"
                  +"   where     op.t_DocKind = ?"
                  +"         and op.t_OperDate <= ?"
                  +"         and op.t_Contract = t.T_SfContrID "
                  +"         and op.t_SubKind_Operation = ?"
                  +"         and paym.t_DocKind    = op.t_DocKind"
                  +"         and paym.t_DocumentID = op.t_ID"
                  +"         and paym.t_Purpose    = " + BAi
                  +"         and paym.t_ValueDate >= ?"
                  +"         and paym.t_ValueDate <= ?"
                  +"  group by t.T_OUTKIND, op.t_Client, paym.t_ValueDate"
                  +"  order by T_OUTKIND, T_CLIENT, t_Date) "+iif(pIs7,"OpIn","OpOut")+", "
                  +"      (with op as(select OP.*  "
                  +"                    from dnptxop_dbt op "
                  +"                   where op.t_DocKind = ? " 
                  +"                     and op.t_OperDate <= ? "
                  +"                     and op.t_SubKind_Operation = ? "
                  +"                     and (exists(select 1 "
                  +"                                   from ddlcontr_dbt dlcontr, ddlcontrmp_dbt mp "
                  +"                                  where MP.T_DLCONTRID = dlcontr.T_DLCONTRID "                                          
                  +"                                    and MP.T_SFCONTRID = op.t_Contract "
                  +"                                    and DLCONTR.T_IIS = 'X') or "
                  +"                           (not exists(select 1 "
                  +"                                         from ddlcontrmp_dbt mp "
                  +"                                        where MP.T_SFCONTRID = op.t_Contract) "
                  +"                                 and NPTO.CheckContrIIS(op.t_Contract) != 1 "
                  +"                              ) "
                  +"                         ) "
                  +"                 ) "
                  +"       select NVL(sum(RSB_FIInstr.ConvSum(rq.t_Amount, rq.T_FIID, 0, ?)), 0) as T_Sum,"
                  +"              rq.t_FactDate T_Date,"
                  +"              OP.T_CLIENT t_Client"
                  +"         from op, ddlrq_dbt rq "
                  +"        where rq.t_DocKind = op.t_DocKind "
                  +"          and rq.t_DocID = op.t_ID "
                  +"          and rq.t_Kind = ? "
                  +"          and RQ.T_SUBKIND = 0 "
                  +"          and rq.t_FactDate >= ? "
                  +"          and rq.t_FactDate <= ? "
                  +"       group by OP.T_CLIENT, rq.t_FactDate "
                  +"      union all"
                  +"       select NVL(sum(RSB_FIInstr.ConvSum(paym.t_Amount, paym.T_FIID, 0, ?)), 0) as T_Sum,"
                  +"              paym.t_ValueDate T_Date,"
                  +"              OP.T_CLIENT t_Client"
                  +"         from op, dpmpaym_dbt paym"
                  +"        where paym.t_DocKind    = op.t_DocKind"
                  +"          and paym.t_DocumentID = op.t_ID"
                  +"          and paym.t_Purpose    = " + BAi
                  +"          and paym.t_ValueDate >= ?"
                  +"          and paym.t_ValueDate <= ?"
                  +"       group by OP.T_CLIENT, paym.t_ValueDate"
                  +"       order by t_CLIENT, t_Date) "+iif(pIs7,"OpOut","OpIn")
                  +" where OpIn.T_CLIENT = OpOut.T_CLIENT "
                  +"   and OpIn.t_Date > OpOut.t_Date "
                  +"   and OpIn.t_Date <= RSI_RsbCalendar.GetDateAfterWorkDay(OpOut.t_Date, 5)";

   END;

   PRIVATE MACRO LoadDataForA7(pIsIn:bool)
     var cmd, DataSet, query_from, query_select, query_order, IsExist = false;

     if( pIsIn )
        query_select = "select distinct OpIn.T_OUTKIND, OpIn.t_Client, OpIn.t_Sum, OpIn.t_Date ";
     else
        query_select = "select distinct OpOut.t_Client, OpOut.t_Date, OpOut.t_Sum, "
                      +"       RSI_RsbCalendar.GetDateAfterWorkDay(OpOut.t_Date, 5) T_FiveWorkDayAfterOut ";
     end;
                  
     query_from = QueryFrom_7_10(true);

     if( pIsIn )
        query_order = " order by OpIn.t_Client, OpIn.t_Date, OpIn.T_OUTKIND";
     else
        query_order = " order by OpOut.t_Client, OpOut.t_Date";
     end;

     cmd = DL_RSDCommand(query_select+query_from+query_order);

     cmd.AddParam(m_EndDate);
     cmd.AddParam(DL_WRTMONEY);
     cmd.AddParam(m_EndDate);
     cmd.AddParam(DL_NPTXOP_WRTKIND_ENROL);
     cmd.AddParam(DLRQ_KIND_COMMIT);
     cmd.AddParam(m_BegDate);
     cmd.AddParam(m_EndDate);

     cmd.AddParam(m_EndDate);
     cmd.AddParam(DL_WRTMONEY);
     cmd.AddParam(m_EndDate);
     cmd.AddParam(DL_NPTXOP_WRTKIND_ENROL);
     cmd.AddParam(m_BegDate);
     cmd.AddParam(m_EndDate);

     cmd.AddParam(DL_WRTMONEY);
     cmd.AddParam(m_EndDate);
     cmd.AddParam(DL_NPTXOP_WRTKIND_WRTOFF);

     cmd.AddParam(m_EndDate);
     cmd.AddParam(DLRQ_KIND_REQUEST);
     cmd.AddParam(m_BegDate);
     cmd.AddParam(m_EndDate);

     cmd.AddParam(m_EndDate);
     cmd.AddParam(m_BegDate);
     cmd.AddParam(m_EndDate);

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
        if( pIsIn )
           m_WrtIn[m_WrtIn.Size()] = WrtInOut(DataSet.OUTKIND, DataSet.Client, SQL_ConvTypeDate(DataSet.Date), SQL_ConvTypeSum(DataSet.Sum));
        else
           m_WrtOut[m_WrtOut.Size()] = WrtInOut(null,DataSet.Client, SQL_ConvTypeDate(DataSet.Date), SQL_ConvTypeSum(DataSet.Sum), DataSet.FiveWorkDayAfterOut);
        end;
        IsExist = true;
     end;

     return IsExist;
   END;

   PRIVATE MACRO LoadA7()


     var query_select = "  select /*+ leading(t) */ NVL(sum(RSB_FIInstr.ConvSum(acctrn.t_sum_receiver, acctrn.t_fiid_receiver, 0, ACCTRN.T_DATE_CARRY)), 0) sum_a7, T.T_OUTKIND              " +
                        "  from dnptxop_dbt nptxop, doprdocs_dbt oprd, doproper_dbt oproper, dacctrn_dbt acctrn, ddlcontr_dbt dlcontr, ddlcontrmp_dbt mp, DDLIIS712_TMP t  " +
                        "  where  acctrn.t_account_payer = '30102810700000000001'                                                                                          " +
                        "    AND nptxop.t_SubKind_Operation = 10                                                                                                           " +
                        "    AND nptxop.t_status = 2                                                                                                                       " +
                        "    AND nptxop.t_operdate BETWEEN ? AND ?                                                                                                         " +
                        "    and oproper.t_kind_operation = nptxop.t_kind_operation                                                                                        " +
                        "    and oproper.t_documentid = nptxop.t_id                                                                                                        " +
                        "    and oprd.t_id_operation = oproper.t_id_operation                                                                                              " +
                        "    and oprd.t_dockind = 1                                                                                                                        " +
                        "    and acctrn.t_acctrnid = oprd.t_acctrnid                                                                                                       " +
                        "    and acctrn.t_chapter = 1                                                                                                                      " +
                        "    and acctrn.t_account_receiver = nptxop.t_account                                                                                              " +
                        "    and mp.t_sfcontrid =  nptxop.t_contract                                                                                                       " +
                        "    and mp.t_dlcontrid = dlcontr.t_dlcontrid                                                                                                      " +
                        "    and dlcontr.t_iistransfer = chr(88)                                                                                                           " +
                        "    and t.t_sfcontrid = nptxop.t_contract                                                                                                         " +
                        "  group by  T.T_OUTKIND;                                                                                                                          ";   
     var cmd = DL_RSDCommand(query_select);
         cmd.AddParam(m_BegDate);
         cmd.AddParam(m_EndDate);
     
     var DataSet = cmd.execute();

     while(DataSet.MoveNext())
       if( DataSet.OUTKIND == 1 )
          m_Array[CODE_A].A7 = m_Array[CODE_A].A7+DataSet.sum_a7;
       elif( DataSet.OUTKIND == 2 )
          m_Array[CODE_B].A7 = m_Array[CODE_B].A7+DataSet.sum_a7;
       else
          m_Array[CODE_X].A7 = m_Array[CODE_X].A7+DataSet.sum_a7;
       end;
     end;
   END;

   PRIVATE MACRO LoadDataForA10(pIsIn:bool)
     var cmd, DataSet, query_from, query_select, query_order, IsExist = false;

     if( pIsIn )
       query_select = "   SELECT DISTINCT OpIn.t_Client,"
                    + "          OpIn.t_Sum,"
                    + "          OpIn.t_Date";
       query_order  = " ORDER BY OpIn.t_Client,"
                    + "          OpIn.t_Date";
     else
       query_select = "   SELECT DISTINCT OpOut.t_OutKind,"
                    + "          OpOut.t_Client,"
                    + "          OpOut.t_Date,"
                    + "          OpOut.t_Sum,"
                    + "          RSI_RsbCalendar.GetDateAfterWorkDay(OpOut.t_Date, 5) T_FiveWorkDayAfterOut";
       query_order  = " ORDER BY OpOut.t_Client,"
                    + "          OpOut.t_Date,"
                    + "          OpOut.t_OutKind";
     end;

     var sql_date_begin = GetSQLDate(m_BegDate);
     var sql_date_end   = GetSQLDate(m_EndDate);

     query_from = "     FROM (  SELECT NVL(SUM(RSB_FIInstr.ConvSum(rq.t_Amount, rq.T_FIID, 0, " + sql_date_end + ")), 0) AS t_Sum,"
                + "                    rq.t_FactDate AS t_Date,"
                + "                    op.T_CLIENT   AS t_Client,"
                + "                    t.t_OutKind   AS t_OutKind"
                + "               FROM DDLIIS712_TMP t,"
                + "                    dnptxop_dbt   op,"
                + "                    ddlrq_dbt     rq"
                + "              WHERE     op.t_DocKind            = " + DL_WRTMONEY
                + "                    AND op.t_OperDate          <= " + sql_date_end
                + "                    AND op.t_Contract           = t.t_SfContrID"
                + "                    AND op.t_SubKind_Operation  = " + DL_NPTXOP_WRTKIND_WRTOFF
                + "                    AND rq.t_DocKind            = op.t_DocKind"
                + "                    AND rq.t_DocID              = op.t_ID"
                + "                    AND rq.t_Kind               = " + DLRQ_KIND_REQUEST
                + "                    AND rq.T_SubKind            = 0"
                + "                    AND rq.t_FactDate          >= " + sql_date_begin
                + "                    AND rq.t_FactDate          <= " + sql_date_end
                + "           GROUP BY t.t_OutKind,"
                + "                    op.t_Client,"
                + "                    rq.t_FactDate"
                + "              UNION ALL"
                + "             SELECT NVL(SUM(RSB_FIInstr.ConvSum(paym.t_Amount, paym.T_FIID, 0, " + sql_date_end + ")), 0) AS t_Sum,"
                + "                    paym.t_ValueDate AS T_Date,"
                + "                    op.t_Client      AS t_Client,"
                + "                    t.t_OutKind      AS t_OutKind"
                + "               FROM DDLIIS712_TMP t,"
                + "                    dnptxop_dbt   op,"
                + "                    dpmpaym_dbt   paym"
                + "              WHERE     op.t_DocKind            = " + DL_WRTMONEY
                + "                    AND op.t_OperDate          <= " + sql_date_end
                + "                    AND op.t_Contract           = t.T_SfContrID"
                + "                    AND op.t_SubKind_Operation  = " + DL_NPTXOP_WRTKIND_WRTOFF
                + "                    AND paym.t_DocKind          = op.t_DocKind"
                + "                    AND paym.t_DocumentID       = op.t_ID"
                + "                    AND paym.t_Purpose          = " + BAi
                + "                    AND paym.t_ValueDate       >= " + sql_date_begin
                + "                    AND paym.t_ValueDate       <= " + sql_date_end
                + "           GROUP by t.t_OutKind,"
                + "                    op.t_Client,"
                + "                    paym.t_ValueDate"
                + "           ORDER BY t_OutKind,"
                + "                    t_Client,"
                + "                    t_Date) OpOut,"
                + "          (  SELECT NVL(SUM(RSB_FIInstr.ConvSum(rq.t_Amount, rq.t_FIID, 0, " + sql_date_end + ")), 0) AS t_Sum,"
                + "                    rq.t_FactDate AS t_Date,"
                + "                    op.t_Client   AS t_Client"
                + "               FROM dnptxop_dbt op,"
                + "                    ddlrq_dbt   rq "
                + "              WHERE     op.t_DocKind            = " + DL_WRTMONEY
                + "                    AND op.t_OperDate          <= " + sql_date_end
                + "                    AND NPTO.CheckContrIIS(op.t_Contract) != 1"
                + "                    AND op.t_SubKind_Operation  = " + DL_NPTXOP_WRTKIND_ENROL
                + "                    AND rq.t_DocKind            = op.t_DocKind"
                + "                    AND rq.t_DocID              = op.t_ID"
                + "                    AND rq.t_Kind               = " + DLRQ_KIND_COMMIT
                + "                    AND rq.t_SubKind            = 0"
                + "                    AND rq.t_FactDate          >= " + sql_date_begin
                + "                    AND rq.t_FactDate          <= " + sql_date_end
                + "           GROUP BY op.t_Client,"
                + "                    rq.t_FactDate"
                + "              UNION ALL"
                + "             SELECT NVL(SUM(RSB_FIInstr.ConvSum(paym.t_Amount, paym.T_FIID, 0, " + sql_date_end + ")), 0) AS t_Sum,"
                + "                    paym.t_ValueDate AS t_Date,"
                + "                    op.t_Client      AS t_Client"
                + "               FROM dnptxop_dbt op,"
                + "                    dpmpaym_dbt paym"
                + "              WHERE     op.t_DocKind            = " + DL_WRTMONEY
                + "                    AND op.t_OperDate          <= " + sql_date_end
                + "                    AND NPTO.CheckContrIIS(op.t_Contract) != 1"
                + "                    AND op.t_SubKind_Operation  = " + DL_NPTXOP_WRTKIND_ENROL
                + "                    AND paym.t_DocKind          = op.t_DocKind"
                + "                    AND paym.t_DocumentID       = op.t_ID"
                + "                    AND paym.t_Purpose          = " + BAi
                + "                    AND paym.t_ValueDate       >= " + sql_date_begin
                + "                    AND paym.t_ValueDate       <= " + sql_date_end
                + "           GROUP BY op.t_Client,"
                + "                    paym.t_ValueDate"
                + "           ORDER BY t_Client,"
                + "                    t_Date) OpIn"
                + "    WHERE     OpIn.t_Client  = OpOut.t_Client"
                + "          AND OpIn.t_Date   >  OpOut.t_Date"
                + "          AND OpIn.t_Date   <= RSI_RsbCalendar.GetDateAfterWorkDay(OpOut.t_Date, 5)";

     cmd = DL_RSDCommand(query_select + query_from + query_order);

     DataSet = cmd.execute();

     if (pIsIn)
        while (DataSet.MoveNext())
           m_WrtIn[m_WrtIn.Size()] = WrtInOut(null, DataSet.Client, SQL_ConvTypeDate(DataSet.Date), SQL_ConvTypeSum(DataSet.Sum));
           IsExist = true;
        end;
     else
        while (DataSet.MoveNext())
           m_WrtOut[m_WrtOut.Size()] = WrtInOut(DataSet.OUTKIND, DataSet.Client, SQL_ConvTypeDate(DataSet.Date), SQL_ConvTypeSum(DataSet.Sum), DataSet.FiveWorkDayAfterOut);
           IsExist = true;
        end;
     end;

     return IsExist;
   END;

   PRIVATE MACRO LoadA10()
      var i = 0, j = 0, MinSum = $0;

      m_WrtIn.Size = 0;
      m_WrtOut.Size = 0;

      if( LoadDataForA10(true) and LoadDataForA10(false) )

         while( i < m_WrtOut.Size() )

            j = 0;
            while( j < m_WrtIn.Size() )

               if ((m_WrtIn[j].Client  == m_WrtOut[i].Client)
               and (m_WrtIn[j].WrtDate >  m_WrtOut[i].WrtDate)
               and (m_WrtIn[j].WrtDate <= m_WrtOut[i].FiveWorkDayAfterOut))

                  MinSum = min(m_WrtOut[i].Sum,m_WrtIn[j].Sum);

                  m_WrtOut[i].Sum = max(m_WrtOut[i].Sum - MinSum,0);
                  m_WrtIn[j].Sum = max(m_WrtIn[j].Sum - MinSum,0);

                  if( m_WrtOut[i].OUTKIND == 1 )
                     m_Array[CODE_A].A10 = m_Array[CODE_A].A10+MinSum;
                  elif( m_WrtOut[i].OUTKIND == 2 )
                     m_Array[CODE_B].A10 = m_Array[CODE_B].A10+MinSum;
                  else
                     m_Array[CODE_X].A10 = m_Array[CODE_X].A10+MinSum;
                  end;

               end;

               if( m_WrtOut[i].Sum == $0 )
                  break;
               end;
               
               j = j + 1;

            end;

            i = i + 1;

         end;
      end;

   END;

  MACRO DelD712IIS_DBT()
    var cmd = RSDCommand("call RSB_712.DelD712IIS(?)"); 
      cmd.addParam( "", RSDBP_IN, m_SessionID);
      cmd.execute();
  END;

  PRIVATE MACRO PrintList_Contr()
    SetActiveSheet("Договора ИИС");

    PrintFormatString(NULL, "N2_H01", this.H01(),
                            "N2_D0",  this.D0(),
                            "N2_TimeOfReport", time());
    CopyAllSheetInTotalBook( "Договора ИИС", false, "N2_Header", 0, "Договора ИИС");
    RegisterTable("N2_Line", "", "N2_1", "N2_2", "N2_3", "N2_4", "N2_5", "N2_6", "N2_7", "N2_8", "N2_9", "N2_10", "N2_11","N2_12");

    var sql_date_begin = GetSqlDate(m_BegDate);
    var sql_date_end   = GetSqlDate(m_EndDate);

    var q = "insert into D712IIS_DBT "
          + "SELECT mc2.acc AS account,"
          + "       mc2.cur,"
          + "       rsb_account.restac(mc2.acc, mc2.cur, " + sql_date_end + ", mc2.t_Chapter, NULL) AS sum,"
          + "       mc2.cn AS cn,"
          + "       mc2.sfbeg,"
          + "       mc2.sfcls,"
          + "       mc2.name,"
          + "       mc2.acc_open,"
          + "       mc2.acc_close,"
          + "       fin.t_name AS curname,"
          + "       '', 0, 0, mc2.pID, mc2.SfID , mc2.DlID,"+m_SessionID+" "
          + "  FROM (  SELECT mc.acc,"
          + "                 mc.cur,"
          + "                 mc.t_Chapter,"
          + "                 mc.cn,"
          + "                 mc.sfbeg,"
          + "                 mc.sfcls,"
          + "                 mc.name,"
          + "                 mc.acc_open,"
          + "                 mc.acc_close,"
          + "                 mc.dlid,"
          + "                 mc.sfid,"
          + "                 mc.pid"
          + "            FROM (   SELECT ac.t_account       AS acc,"
          + "                            ac.t_code_currency AS cur,"
          + "                            ac.t_Chapter,"
          + "                            sf.t_number        AS cn,"
          + "                            sf.t_datebegin     AS sfbeg,"
          + "                            sf.t_dateclose     AS sfcls,"
          + "                            p.t_name           AS name,"
          + "                            ac.t_open_date     AS acc_open,"
          + "                            ac.t_close_date    AS acc_close,"
          + "                            sf.t_id            AS sfid,"
          + "                            0                  AS dlid,"
          + "                            p.t_partyid        AS pid"
          + "                       FROM ddliis712_tmp t,"
          + "                            daccount_dbt  ac,"
          + "                            dsettacc_dbt  sa,"
          + "                            dSfssi_dbt    ss,"
          + "                            dsfcontr_dbt  sf,"
          + "                            dparty_dbt    p"
          + "                      WHERE     sa.t_SettAccID      = ss.t_setaccid"
          + "                            AND ss.t_ObjectType     = " + OBJTYPE_SFCONTR
          + "                            AND t.t_SfContrID       = sf.t_ID"
          + "                            AND p.t_PartyID         = sf.t_PartyID"
          + "                            AND ss.t_ObjectID       = LPAD(t.t_SfContrID, 10, '0')"
          + "                            AND ss.t_FIKind         = " + FIKIND_CURRENCY
          + "                            AND ac.t_Balance       IN ('30601', '30606')"
          + "                            AND ac.t_Account        = sa.t_Account"
          + "                            AND ac.t_Chapter        = sa.t_Chapter"
          + "                            AND ac.t_Code_Currency  = sa.t_FIID"
          + "                  UNION ALL"
          + "                     SELECT ac.t_Account       AS acc,"
          + "                            ac.t_Code_Currency AS cur,"
          + "                            ac.t_Chapter,"
          + "                            sf.t_Number        AS cn,"
          + "                            sf.t_DateBegin     AS sfbeg,"
          + "                            sf.t_DateClose     AS sfcls,"
          + "                            p.t_Name           AS name,"
          + "                            ac.t_Open_Date     AS acc_open,"
          + "                            ac.t_Close_Date    AS acc_close,"
          + "                            sf.t_ID            AS sfid,"
          + "                            dlc.t_DlContrID    AS dlid,"
          + "                            p.t_PartyID        AS pid"
          + "                       FROM ddliis712_tmp   t,"
          + "                            ddlcontracc_dbt da,"
          + "                            daccount_dbt    ac,"
          + "                            ddlcontr_dbt    dlc,"
          + "                            dsfcontr_dbt    sf,"
          + "                            dparty_dbt      p"
          + "                      WHERE     t.t_DlContrID    = da.t_DlContrID"
          + "                            AND da.t_MPID        = 0"
          + "                            AND da.t_AccountID   > 0"
          + "                            AND ac.t_AccountID   = da.t_AccountID"
          + "                            AND ac.t_Balance    IN ('30601', '30606')"
          + "                            AND t.t_DlContrID    = dlc.t_DlContrID"
          + "                            AND p.t_PartyID      = sf.t_PartyID"
          + "                            AND dlc.t_SfContrID  = sf.t_ID"
          + "                      UNION ALL"
          + "                     SELECT ''                                  AS acc,"
          + "                            0                                   AS cur,"
          + "                            1                                   AS t_Chapter,"
          + "                            sf.t_number                         AS cn,"
          + "                            sf.t_datebegin                      AS sfbeg,"
          + "                            sf.t_dateclose                      AS sfcls,"
          + "                            p.t_name                            AS name,"
          + "                            TO_DATE('01.01.0001', 'DD.MM.YYYY') AS acc_open,"
          + "                            TO_DATE('01.01.0001', 'DD.MM.YYYY') AS acc_close,"
          + "                            sf.t_id                             AS sfid,"
          + "                            0                                   AS dlid,"
          + "                            p.t_partyid                         AS pid"
          + "                       FROM ddliis712_tmp t,"
          + "                            dsfcontr_dbt  sf,"
          + "                            dparty_dbt    p"
          + "                      WHERE     t.t_SfContrID = sf.t_ID"
          + "                            AND p.t_PartyID   = sf.t_PartyID"
          + "                            AND NOT EXISTS (SELECT 1"
          + "                                              FROM daccount_dbt ac,"
          + "                                                   dsettacc_dbt sa,"
          + "                                                   dsfssi_dbt   ss"
          + "                                             WHERE     sa.t_SettAccID      = ss.t_SetAccID"
          + "                                                   AND ss.t_ObjectType     = " + OBJTYPE_SFCONTR
          + "                                                   AND ss.t_ObjectID       = LPAD(t.t_SfContrID, 10, '0')"
          + "                                                   AND ss.t_FIKind         = " + FIKIND_CURRENCY
          + "                                                   AND ac.t_Balance       IN ('30601', '30606')"
          + "                                                   AND ac.t_Account        = sa.t_Account"
          + "                                                   AND ac.t_Chapter        = sa.t_Chapter"
          + "                                                   AND ac.t_Code_Currency  = sa.t_FIID)"
          + "                            AND NOT EXISTS (SELECT 1"
          + "                                              FROM ddlcontracc_dbt da"
          + "                                             WHERE t.t_DlContrID = da.t_DlContrID)) mc"
          + "        GROUP BY mc.acc,"
          + "                 mc.cur,"
          + "                 mc.t_Chapter,"
          + "                 mc.cn,"
          + "                 mc.sfbeg,"
          + "                 mc.sfcls,"
          + "                 mc.name,"
          + "                 mc.acc_open,"
          + "                 mc.acc_close,"
          + "                 mc.dlid,"
          + "                 mc.sfid,"
          + "                 mc.pid) mc2,"
          + "       dfininstr_dbt fin"
          + " WHERE fin.t_FIID = mc2.cur";

    DelD712IIS_DBT();
    var cmdI = RSDCommand(q); cmdI.execute();


    var cmdC = RSDCommand("call RSB_712.DS712IIS_RSHB(?,?,?)"); 
    cmdC.addParam( "", RSDBP_IN, m_SessionID);
    cmdC.addParam( "", RSDBP_IN, m_BegDate );
    cmdC.addParam( "", RSDBP_IN, m_EndDate );
    cmdC.execute();



    var cmd = DL_RSDCommand("select * from D712IIS_DBT where SessionID = " + m_SessionID + " ");

    var ProgressIndicator = TProgressBar();
    var NRec = cmd.GetCount();
    ProgressIndicator.init(NRec, "Заполнение вкладки 'Договора ИИС'",  "Заполнение вкладки 'Договора ИИС'");
    var ds = cmd.execute();

    while (ds.MoveNext())
      var sum_in = ds.sum_in, sum_out = ds.sum_out;

      PrintTableLine("N2_1",  ds.cn, null,
                     "N2_2",  date(ds.sfbeg), null,
                     "N2_3",  date(ds.sfcls), null,
                     "N2_4",  ds.is_active, null,
                     "N2_5",  ds.name, null,
                     "N2_6",  ds.Account, null,
                     "N2_7",  ds.curname, null,
                     "N2_8",  date(ds.acc_open), null,
                     "N2_9",  date(ds.acc_close), null,
                     "N2_10", sum_in, null,
                     "N2_11", sum_out, null,
                     "N2_12", ds.sum, null);
      ProgressIndicator.Use;
    end;

    ProgressIndicator.Remove;

    EndTable();
          CopyAllSheetInTotalBook("Договора ИИС", false,  GetTableRange(), 0, "Договора ИИС");  
  END;
  
  PRIVATE MACRO PrintList_In()
    SetActiveSheet("Проводки ввода ДС");
  
    PrintFormatString(NULL, "N3_H01", this.H01(),
                            "N3_D0",  this.D0(),
                            "N3_TimeOfReport", time());
    PrintFormatString(NULL, "N3_D0D1", "Бухгалтерские проводки ввода ДС за " + M_PANEL_PERIOD + " " + this.D0());
   CopyAllSheetInTotalBook("Проводки ввода ДС", false, "N3_Header", 0, "Проводки ввода ДС");

    RegisterTable("N3_Line", "", "N3_1", "N3_2", "N3_3", "N3_4", "N3_5", "N3_6");

    var q = "select /*+ leading(d) parallel( d 8)*/ count(*) over() as Rec_count, t_SubKind_Operation as T_DIRECTION, d.T_CN as T_NUMBER, nptxop.t_account as T_ACCOUNT, acctrn.t_account_payer as T_ACCOUNT_2, acctrn.t_date_carry as T_DATE, acctrn.t_sum_receiver as T_SUM, acctrn.t_ground as T_GROUND"
        + " from dnptxop_dbt nptxop, doprdocs_dbt oprd, doproper_dbt oproper, dacctrn_dbt acctrn,  D712IIS_DBT d "
        + " where nptxop.t_account = d.T_ACCOUNT  "
        + "  AND nptxop.t_SubKind_Operation = 10 "
        + "  AND nptxop.t_status = 2  "
        + "  AND nptxop.t_operdate BETWEEN ? AND ? "
        + "  and oproper.t_kind_operation = nptxop.t_kind_operation "
        + "  and oproper.t_documentid = nptxop.t_id "
        + "  and oprd.t_id_operation = oproper.t_id_operation "
        + "  and oprd.t_dockind = 1 "
        + "  and acctrn.t_acctrnid = oprd.t_acctrnid "
        + "  and acctrn.t_chapter = 1 "
        + "  and acctrn.t_account_receiver = nptxop.t_account "
        + "  and d.SessionID = " + m_SessionID + " "  ;

    var cmd = DL_RSDCommand(q);
        cmd.addParam(m_BegDate);
        cmd.addParam(m_EndDate);


    var ProgressIndicator = TProgressBar();
    var NRec = 0;

    var rs = cmd.execute();

    while (rs.MoveNext())
      if (NRec == 0)
        NRec = int(rs.Rec_count);
        ProgressIndicator.init(NRec, "Заполнение вкладки 'Бухгалтерские проводки ввода ДС'",  "Заполнение вкладки 'Бухгалтерские проводки ввода ДС'");
      end;
      PrintTableLine("N3_1",  rs.T_NUMBER, null,
                     "N3_2",  rs.T_ACCOUNT, null,
                     "N3_3",  rs.T_ACCOUNT_2, null,
                     "N3_4",  date(rs.T_DATE), null,
                     "N3_5",  rs.T_SUM, null,
                     "N3_6",  rs.T_GROUND, null);
      ProgressIndicator.Use;
    end;

    ProgressIndicator.Remove;

    EndTable();
    CopyAllSheetInTotalBook("Проводки ввода ДС", false, GetTableRange(), 0, "Проводки ввода ДС");  
    DelD712IIS_DBT();
  END;
  
  PRIVATE MACRO PrintList_Out()
    SetActiveSheet("Проводки вывода ДС");

    PrintFormatString(NULL, "N4_H01", this.H01(),
                            "N4_D0",  this.D0(),
                            "N4_TimeOfReport", time());
    PrintFormatString(NULL, "N4_D0D1", "Бухгалтерские проводки вывода ДС за " + M_PANEL_PERIOD + " " + this.D0());
        CopyAllSheetInTotalBook("Проводки вывода ДС", false, "N4_Header", 0, "Проводки вывода ДС"); 
    RegisterTable("N4_Line", "", "N4_1", "N4_2", "N4_3", "N4_4", "N4_5", "N4_6");
 
    var q = "   SELECT /*+ parallel( tmp 8)*/ sf.t_number,                                                                                 " +
            "          nptxop.t_account,                                                                                                   " +
            "          LISTAGG (acctrn.t_account_receiver, ' ') WITHIN GROUP (ORDER BY acctrn.t_account_receiver) T_ACCOUNT_2,             " +
            "          acctrn.t_date_carry t_date,                                                                                         " +
            "          SUM (acctrn.t_sum_payer) as T_SUM,                                                                                  " +
            "          'Списание денежных средств по заявлению № '||nptxop.t_code t_ground                                                 " +
            "     FROM dnptxop_dbt nptxop, doprdocs_dbt oprd, doproper_dbt oproper, dacctrn_dbt acctrn, DDLIIS712_TMP tmp, dsfcontr_dbt sf " +
            "    WHERE nptxop.t_SubKind_Operation = 20 AND nptxop.t_status = 2                                                             " +
            "          AND nptxop.t_operdate BETWEEN ? AND ?                                                                               " +
            "          AND oproper.t_kind_operation = nptxop.t_kind_operation                                                              " +
            "          AND oproper.t_documentid = nptxop.t_id                                                                              " +
            "          AND oprd.t_id_operation = oproper.t_id_operation                                                                    " +
            "          AND oprd.t_dockind = 1                                                                                              " +
            "          AND acctrn.t_acctrnid = oprd.t_acctrnid                                                                             " +
            "          AND acctrn.t_chapter = 1                                                                                            " +
            "          AND acctrn.t_account_payer = nptxop.t_account                                                                       " +
            "          AND NPTXOP.T_CONTRACT = TMP.T_SFCONTRID                                                                             " +
            "          AND SF.T_ID = TMP.T_SFCONTRID                                                                                       " +
            " GROUP BY sf.t_number, nptxop.t_id, nptxop.t_code, nptxop.t_account, acctrn.t_date_carry                                      ";
    var cmd = DL_RSDCommand(q);
        cmd.addParam(m_BegDate);
        cmd.addParam(m_EndDate);

    var ProgressIndicator = TProgressBar();

    var NRec = cmd.GetCount();
    ProgressIndicator.init(NRec, "Заполнение вкладки 'Бухгалтерские проводки вывода ДС'",  "Заполнение вкладки 'Бухгалтерские проводки вывода ДС'");

    var rs = cmd.execute();

    while (rs.MoveNext())
      PrintTableLine("N4_1",  rs.T_NUMBER, null,
                     "N4_2",  rs.T_ACCOUNT, null,
                     "N4_3",  rs.T_ACCOUNT_2, null,
                     "N4_4",  date(rs.T_DATE), null,
                     "N4_5",  rs.T_SUM, null,
                     "N4_6",  rs.T_GROUND, null);
      ProgressIndicator.Use;
    end;

    ProgressIndicator.Remove;

    EndTable();
   CopyAllSheetInTotalBook("Проводки вывода ДС", false, GetTableRange(), 0, "Проводки вывода ДС"); 
  END;
  
  MACRO DelD712MOVE()
    var cmd = RSDCommand("call RSB_712.DelD712MOVE(?)"); 
      cmd.addParam( "", RSDBP_IN, m_SessionID);
      cmd.execute();
  END;

  PRIVATE MACRO PrintList_Move()


    SetActiveSheet("Движение ЦБ");

    PrintFormatString(NULL, "N5_H01", this.H01(),
                            "N5_D0",  this.D0(),
                            "N5_TimeOfReport", time());

    PrintFormatString(NULL, "N5_D0D1", "Движение ц/б, связанным с договорами ИИС за " + M_PANEL_PERIOD + " " + this.D0());
    CopyAllSheetInTotalBook("Движение ЦБ", false, "N5_Header", 0, "Движение ЦБ"); 
    RegisterTable("N5_Line", "", "N5_1", "N5_2", "N5_3", "N5_4", "N5_5", "N5_6", "N5_7", "N5_8", "N5_9", "N5_10", "N5_11");


     var sql_date_begin = GetSQLDate(m_BegDate);
     var sql_date_end   = GetSQLDate(m_EndDate);
    var q = 
    "INSERT INTO D712MOVE_DBT  " +
    "select /*+ parallel(8) */ q1.t_id, q1.t_number, q1.t_kind, q1.t_name, q1.fiid, q1.vn, q1.t_ccy, q1.t_isin, sum(q1.t_sum) as t_sum, t_SubKind, t_AvoirKind, t_FI_Kind , chr(1), 0,0, "+m_SessionID+" " +
    "   from                                                                                                                              " +
    " (SELECT sf.t_id, sf.t_number, rq.t_kind, fi.t_name, rq.t_fiid fiid, vn.t_fiid vn, vn.t_ccy, avr.t_isin, rq.t_amount as t_sum        " +
    "        ,fi.t_FI_Kind, fi.t_AvoirKind                                                                                                " +
    "        ,sf.t_ServKindSub t_SubKind                                                                                                  " +
    "    FROM DDLIIS712_TMP d712, dsfcontr_dbt sf, ddl_tick_dbt tick, ddlrq_dbt rq, dfininstr_dbt fi, dfininstr_dbt vn, davoiriss_dbt avr " +
    "   where sf.t_id = d712.t_sfcontrid                                                                                                  " +
    "     and tick.t_clientcontrid = d712.t_sfcontrid                                                                                     " +
    "     and rq.t_docid = tick.t_dealid                                                                                                  " +
    "     and rq.t_type in (8, 9)                                                                                                         " +
    "     and rq.t_factdate between "+sql_date_begin+" and "+sql_date_end+"                                                               " +
    "     and fi.t_fiid = rq.t_fiid                                                                                                       " +
    "     and vn.t_fiid = fi.t_facevaluefi                                                                                                " +
    "     and avr.t_fiid = rq.t_fiid                                                                                                      " +
    "  UNION ALL                                                                                                                          " +
    "  SELECT t_id, t_number, t_kind, t_name, fiid, vn, t_ccy, t_isin, t_sum                                                              " +
    "        ,t_FI_Kind, t_AvoirKind                                                                                                      " +
    "        ,t_SubKind                                                                                                                   " +
    "    FROM (WITH wrtcl                                                                                                                 " +
    "            AS (  SELECT /*+ parallel(8) use_hash(t,wrt)*/ wrt.T_FIID, T.T_SFCONTRID                                                                                   " +
    "                    FROM V_SCWRTHISTEX wrt, DDLIIS712_TMP t                                                                          " +
    "                   WHERE    t_portfolio = 0                                                                                          " +
    "                         AND t_changedate <= "+sql_date_end+"                                                                        " +
    "                         AND t_state = 1                                                                                             " +
    "                         AND wrt.t_amount != 0                                                                                       " +
    "                         AND wrt.T_CONTRACT = T.T_SFCONTRID                                                                          " +
    "                         AND t_instance =                                                                                            " +
    "                            (SELECT MAX (t_instance)                                                                                 " +
    "                               FROM V_SCWRTHISTEX wrt2                                                                               " +
    "                              WHERE     wrt2.t_sumid = wrt.t_sumid                                                                   " +
    "                                    AND wrt2.t_changedate <= "+sql_date_end+")                                                       " +
    "              group by wrt.T_FIID, T.T_SFCONTRID)                                                                                    " + 
    "            SELECT /*+ leading(wrtcl)*/ sf.t_id, sf.t_number, 0 AS t_kind, fin.t_name, FIN.T_FIID fiid, vn.t_fiid vn, vn.t_ccy, avr.t_isin, 0 AS T_SUM    " +
    "                  ,fin.t_FI_Kind, fin.t_AvoirKind                                                                                    " +
    "                  ,sf.t_ServKindSub t_SubKind                                                                                        " +
    "              FROM dfininstr_dbt fin, wrtcl, davoiriss_dbt avr, dsfcontr_dbt sf, dfininstr_dbt vn                                    " +
    "             WHERE     FIN.T_FIID = WRTCL.T_FIID                                                                                     " +
    "                   AND fin.t_fiid = avr.t_fiid                                                                                       " +
    "                   AND sf.t_id = wrtcl.t_sfcontrid                                                                                   " +
    "                   AND vn.t_fiid = fin.t_facevaluefi)                                                                                " +
    " ) q1 GROUP BY t_id, t_number, t_SubKind, t_kind, t_name, fiid, vn, t_ccy, t_isin, t_FI_Kind, t_AvoirKind order by t_id, t_name, t_kind " ;

    DelD712MOVE();
    var cmdI = RSDCommand(q);
    cmdI.execute();

    var cmd = DL_RSDCommand("select * from D712MOVE_DBT where SessionID = " + m_SessionID + " ");

    var loop = true;
    var cn = "", mkind = -1, finame = "", ccy = "", isin = "", sum = -1, sectype = -1, qnty = -1, crnom = -1, rt_med, rt_cls, rate_otherfi = 0, rate_error = false, crsec = 0.0;
    var step = false;
    var next = true;

    GetRegistryValue("SECUR\\ВИД КУРСА СРЕДНЕВЗВЕШЕННАЯ ЦЕНА", V_INTEGER, rt_med);
    GetRegistryValue("SECUR\\ВИД КУРСА ЦЕНА ЗАКРЫТИЯ", V_INTEGER, rt_cls);

    var ProgressIndicator = TProgressBar();

    var NRec = cmd.GetCount();
    ProgressIndicator.init(NRec, "Заполнение вкладки 'Движение ЦБ'", "Заполнение вкладки 'Движение ЦБ'");

    var cmdC = RSDCommand( "call RSB_712.DS712MOVE( ?,? )");
    cmdC.addParam( "", RSDBP_IN, m_SessionID);
    cmdC.addParam( "", RSDBP_IN, GetSQLDate(m_EndDate) );
    cmdC.execute();

    var rs = cmd.execute();

    while (loop)
      if (step)
        step = false;
        next = rs.MoveNext();
        if (next == false)
          PrintTableLine("N5_1",  cn, null,
                         "N5_2",  finame, null,
                         "N5_3",  ccy, null,
                         "N5_4",  isin, null,
                         "N5_5",  sectype, null,
                         "N5_6",  sum, null,
                         "N5_7",  0, null,
                         "N5_8",  qnty, null,
                         "N5_9",  crnom, null,
                         "N5_10", crsec, null,
                         "N5_11", qnty * crsec, null);
          break;
        end;
        if ((rs.t_number == cn) and (rs.t_name == finame))
          PrintTableLine("N5_1",  cn, null,
                         "N5_2",  finame, null,
                         "N5_3",  ccy, null,
                         "N5_4",  isin, null,
                         "N5_5",  sectype, null,
                         "N5_6",  sum, null,
                         "N5_7",  rs.sum, null,
                         "N5_8",  qnty, null,
                         "N5_9",  crnom, null,
                         "N5_10", crsec, null,
                         "N5_11", qnty * crsec, null);
          next = true;
        else
          PrintTableLine("N5_1",  cn, null,
                         "N5_2",  finame, null,
                         "N5_3",  ccy, null,
                         "N5_4",  isin, null,
                         "N5_5",  sectype, null,
                         "N5_6",  sum, null,
                         "N5_7",  0, null,
                         "N5_8",  qnty, null,
                         "N5_9",  crnom, null,
                         "N5_10", crsec, null,
                         "N5_11", qnty * crsec, null);
          next = false;
        end;
      else

        if (next == true)
          next = rs.MoveNext();
          if (next == false)
            break;
          end;
        end;

        cn = rs.t_number;
        finame = rs.t_name;
        mkind = rs.t_kind;
        ccy = rs.t_ccy;
        isin = rs.t_isin;
        sum = rs.sum;
        sectype = rs.sectype;

        qnty = rs.qnty;
        crnom = GetRateOnDateCrossDbl(m_EndDate, rs.vn, NATCUR, true);

        crsec = rs.secrate; 

        if (mkind == 0)
          step = true;
          continue;
        else
          PrintTableLine("N5_1",  cn, null,
                         "N5_2",  finame, null,
                         "N5_3",  ccy, null,
                         "N5_4",  isin, null,
                         "N5_5",  sectype, null,
                         "N5_6",  0, null,
                         "N5_7",  sum, null,
                         "N5_8",  qnty, null,
                         "N5_9",  crnom, null,
                         "N5_10", crsec, null,
                         "N5_11", qnty * crsec, null);
         next = true;
        end;
      end;

      ProgressIndicator.Use;
    end;

    ProgressIndicator.Remove;

   // DelD712MOVE();

    EndTable();

   CopyAllSheetInTotalBook("Движение ЦБ", false, GetTableRange(), 0, "Движение ЦБ");
  END;
  
   /*по договорам не ДБО*/
   PRIVATE MACRO CheckAndCorrectSfContrNotDBO()
     var cmd, DataSet, query;

     cmd = DL_RSDCommand( " select t.T_PARTYID, PT.T_SHORTNAME "
                         +"   from ( select T.T_OUTKIND, T.T_PARTYID "  
                         +"            from DDLIIS712_TMP t "             
                         +"           where T.T_DLCONTRID = 0 "        
                         +"             and T.T_OUTKIND > 0 "            
                         +"         group by T.T_PARTYID, T.T_OUTKIND "
                         +"        ) t, dparty_dbt pt "
                         +" where PT.T_PARTYID = t.T_PARTYID "
                         +" group by t.T_PARTYID, PT.T_SHORTNAME "               
                         +" having count(t.T_OUTKIND) > 1"      
                        );

     DataSet = cmd.execute();

     while(DataSet.MoveNext())
        msgbox("Для клиента \""+DataSet.SHORTNAME+"\" заданы разные типы вычетов");
        /*убираем все договоры, у которых заданы разные типы вычетов*/
        SQL_Execute("delete from DDLIIS712_TMP where T_DLCONTRID = 0 and T_PARTYID = "+DataSet.PARTYID,"Корректировка информации по отобранным договорам",true);
     end;

     /*если на одном из договоров или на нескольких задан один и тот же тип вычета, то его действие распространяется на остальные договоры, на которых тип вычета не задан*/
     query = " update DDLIIS712_TMP t "
            +"    set t.T_OUTKIND = nvl((select max(T2.T_OUTKIND) from DDLIIS712_TMP t2 where T2.T_PARTYID = T.T_PARTYID and T2.T_DLCONTRID = 0),0) "
            +"  where t.T_DLCONTRID = 0 "
            +"    and t.T_OUTKIND = 0";

     SQL_Execute(query,"Корректировка информации по отобранным договорам",true);

   END;

   PRIVATE MACRO LoadDataInTMP()
     SQL_Truncate( "DDLIIS712_TMP" );
    
     var sql_date_begin = GetSQLDate(m_BegDate);
     var sql_date_end   = GetSQLDate(m_EndDate);

     var query = " INSERT INTO DDLIIS712_TMP"
               + " SELECT sf.t_ID,"
               + "        sf.t_ServKind,"
               + "        dl.t_DLContrID AS t_DLContrID,"
               + "        sf.t_PartyID,"
               + "        MIN(sf.t_DateConc) OVER(PARTITION BY dl.t_DLContrID) t_DateConc," 
               + "        MAX(CASE sf.t_DateClose WHEN TO_DATE('01.01.0001', 'DD.MM.YYYY')"
               + "                                THEN TO_DATE('31.12.9999', 'DD.MM.YYYY')"
               + "                                ELSE sf.t_DateClose"
               + "             END) OVER (PARTITION BY dl.t_DLContrID) t_DateClose,"
               + "        CASE WHEN dl.t_IISDedFinRes = 'X'"
               + "             THEN 2"
               + "             WHEN EXISTS (SELECT 1"
               + "                            FROM ddlcontrtp_dbt tp"
               + "                           WHERE     tp.t_DLContrID  = dl.t_DLContrID"
               + "                                 AND tp.t_TaxCompens = 'X')"
               + "             THEN 1"
               + "             ELSE 0"
               + "         END t_OutKind"
               + "   FROM ddlcontr_dbt dl,"
               + "        dsfcontr_dbt sf"
               + "  WHERE     dl.t_IIS = 'X'"
               + "        AND ( "
               + "              EXISTS (SELECT 1"
               + "                          FROM ddlcontrmp_dbt mp"
               + "                         WHERE     mp.t_SFContrID = sf.t_ID"
               + "                               AND mp.t_DLContrID = dl.t_DLContrID))"
               + "        AND sf.t_ServKind IN (" + PTSK_STOCKDL + ", " + PTSK_DV + ", " + PTSK_CM + ")"
               + "        AND sf.t_DateConc <= " + sql_date_end
               + "        AND (   sf.t_DateClose  = TO_DATE('01.01.0001', 'DD.MM.YYYY')"
               + "             OR sf.t_DateClose >= " + sql_date_begin + ")"
               + " UNION ALL"
               + " SELECT sf.t_ID,"
               + "        sf.t_ServKind,"
               + "        0 t_DLContrID,"
               + "        sf.t_PartyID,"
               + "        MIN(sf.t_DateConc) OVER(PARTITION BY sf.t_PartyID) t_DateConc,"
               + "        MAX(CASE sf.t_DateClose WHEN TO_DATE('01.01.0001', 'DD.MM.YYYY')"
               + "                                THEN TO_DATE('31.12.9999', 'DD.MM.YYYY')"
               + "                                ELSE sf.t_DateClose"
               + "             END) OVER (PARTITION BY sf.t_PartyID) t_DateClose,"
               + "        NVL((SELECT TO_NUMBER(attr.t_NumInList)"
               + "               FROM dobjatcor_dbt atcor,"
               + "                    dobjattr_dbt  attr"
               + "              WHERE     atcor.t_ObjectType = " + OBJTYPE_SFCONTR
               + "                    AND atcor.t_GroupID    = " + OBJGROUP_SFCONTR_DEDIIS
               + "                    AND atcor.t_Object     = LPAD(sf.t_ID, 10, '0')"
               + "                    AND attr.t_AttrID      = atcor.t_AttrID"
               + "                    AND attr.t_ObjectType  = atcor.t_ObjectType"
               + "                    AND attr.t_GroupID     = atcor.t_GroupID"
               + "            ), 0) t_OutKind"
               + "   FROM dsfcontr_dbt sf"
               + "  WHERE     sf.t_ServKind IN (" + PTSK_STOCKDL + ", " + PTSK_DV + ", " + PTSK_CM + ")"
               + "        AND sf.t_DateConc <= " + sql_date_end
               + "        AND (   sf.t_DateClose  = TO_DATE('01.01.0001', 'DD.MM.YYYY')"
               + "             OR sf.t_DateClose >= " + sql_date_begin + ")"
               + "        AND NOT EXISTS (SELECT 1"
               + "                          FROM ddlcontr_dbt   dl,"
               + "                               ddlcontrmp_dbt mp"
               + "                         WHERE     mp.t_SFContrID = sf.t_ID"
               + "                               AND mp.t_DLContrID = dl.t_DLContrID"
               + "                               AND dl.t_IIS       = 'X')"
               + "        AND RSI_NPTO.CheckContrIIS(sf.t_ID) = 1";

     SQL_Execute(query, "Отбор договоров ИИС", true);
   END;

   MACRO Create()
    SetXLSXFormat();
      var fin = TRecHandler("fininstr.dbt");
      var ProgressIndicator = TProgressBar();

      if( ПолучитьФинИн("840", fin, null, null, null, FICK_ISONUMBER) == 0 )
         m_FIID_840 = fin.rec.FIID;
      else
         msgbox("Не найден финансовый инструмент по коду ISO: \"840\"");
      end;

      if( ПолучитьФинИн("978", fin, null, null, null, FICK_ISONUMBER) == 0 )
         m_FIID_978 = fin.rec.FIID;
      else
         msgbox("Не найден финансовый инструмент по коду ISO: \"978\"");
      end;

      if(m_InKliko)
        Dl_CallInsertStat (DL_OUTREPORT_KLIKO);
          if( not Kliko_OpenTxtFile( this.GetEndDate() ) )
            return;
        end;
      end;

      SQL_Execute("commit");
      SQL_Execute("alter session enable parallel dml");

      m_SessionID = GetSessionID();

      LoadDataInTMP();
      CheckAndCorrectSfContrNotDBO();

      ProgressIndicator.init(10, "Формирование отчета", "Формирование строк отчета по отобранным данным");

      Load_A3();
      ProgressIndicator.Use;
      Load_A4();
      ProgressIndicator.Use;
      Load_A5();
      ProgressIndicator.Use;
      LoadA7();
      ProgressIndicator.Use;
      Load_A8();
      ProgressIndicator.Use;
      Load_A6_A9();
      ProgressIndicator.Use;
      LoadA10();
      ProgressIndicator.Use;
      Load_A_11_12_13();
      ProgressIndicator.Use;
      Load_A14();
      ProgressIndicator.Use;
      LoadSumByFIID();
      ProgressIndicator.Use;

      ProgressIndicator.Remove;

      PrintTableLine_Report();

      ProgressIndicator.init(4, "Печать отчета", "Печать отчета по отобранным данным");

      PrintList_Contr();
      ProgressIndicator.Use;
      PrintList_In();
      ProgressIndicator.Use;
      PrintList_Out();
      ProgressIndicator.Use;
      PrintList_Move();
      ProgressIndicator.Use;
      ProgressIndicator.Remove;

   END;

  MACRO EndReport()
        if ( m_IsExistsData )
      SaveTotalbook();
      if (m_InKliko == true)
        Kliko_CloseTxtFile(true);
      end;

      if(m_InDelta)
        m_DeltaReport.CreateXMLFile();
        /*
        if(m_DeltaReport.CreateXMLFile())
          msgbox("Создан файл " + m_DeltaReport.GetFileName());
        else
          msgbox("Ошибка экспорта в Delta");
        end;*/

        var delta_file_name_term = "$" + SC_GetFullPath(true) + m_DeltaReport.GetFileName();
        if(ExistFile(delta_file_name_term))
          RemoveFile(delta_file_name_term);
        end;
        if (not copyFile(m_DeltaReport.GetFileName(),delta_file_name_term,true,"Копирование на терминал"))
          msgbox("Ошибка при копировании " + m_DeltaReport.GetFileName() + " на терминал");
        else
          RemoveFile(m_DeltaReport.GetFileName());
        end;

        if (not m_DeltaReport.createTextProtocol())
          msgbox("Ошибка при создании протокола экспорта в ПК Дельта");
        end;
      end;
    else
      msgbox("Нет данных для формирования отчета.");
    end;
  
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReport );  
END;

MACRO RunReport()

  var stat = true;

  while(stat)
     Dl_IIS712_Form = Dl_IIS712_Panel();
   
     stat = Dl_IIS712_Form.Run();
   
     // Проверяем можем ли мы делать отчет по предоставленным данным
     if (not stat)
        break;
     end;
   
     if( stat )
       var Dl_IIS712 = Dl_IIS712_Report( null, "Report_IIS712.xls", null, null, null, POI_MODE, BIGREPORT_MODE );
       Dl_IIS712.Run();
       Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
     end;
  end;

END;

RunReport();
exit(1);