/* 
$Name:        dlcontrmsg_mmvb.mac
$Module:      Ядро Securities
$Description: Формирование сообщений ДБО для ММВБ
*/
import "dlcontrfunc.mac", "moex_client.mac", "Rs_json.mac", "FuncObj.mac";
/*ak*/
import Nptxmfns_form;
/*~ak*/
/*>bpv*/
import rsbformsinter;
/*<*/
import "u_common_email_utils.mac";

// Настраиваемые константы //////////
private const LoadToTE      = 1;   // Импорт сведений в торговую систему в режиме онлайн (1 - да, 0 - нет)
private const LKU           = 4;   // 4 Собственный клиент Участника
private const SENDER_NAME   = "";  // Краткое наименование нашего банка
private const FO_MQ_MSG     = 610; // Задание funcobj, добавляющее сообщение в очередь отправки
private const FOFUNC_MQ_MSG = 610; // Функция обработки задания funcobj
private const C_CONTRACT_EMAIL_GRP = 16;

private macro GetRiskLevel(p_mpcode,dateconc)

 var query,cmd,rs,risklevel;

 query = " SELECT "+
         "   (SELECT t_attrid                                                     "+
         "      FROM dobjatcor_dbt                                                "+
         "        WHERE     t_objecttype = 207                                    "+
         "         AND t_groupid = 103                                            "+
         "         AND t_object = LPAD (mp.t_dlcontrid, 34, '0')) AS RiskLevel    "+
         "            FROM ddlcontrmp_dbt mp                                      "+
         "                WHERE mp.t_mpcode =  '" + p_mpcode + "'"+
         "                  and mp.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy')";

 cmd = RsdCommand(query);
 rs = RSDRecordSet(cmd);
 if(rs.movenext)
    if(rs.value("RiskLevel") == 1)
       return 3;
    elif (rs.value("RiskLevel") == 2)
       return 2;
    elif (rs.value("RiskLevel") == 3)
       return 4;
    elif (rs.value("RiskLevel") == 4)
       return 1;
    else 
       if(dateconc >= date(01,04,2025))
          return 1;
       else 
       return 2;
    end;
    end;
 else
    return 2;
 end;

end;

private macro GetClientCodeSE(mpcode)

 var query,cmd,rs;

 query = "  SELECT                                             "+ 
         "  (SELECT mp1.t_mpcode                               "+ 
         "   FROM ddlcontrmp_dbt mp1, dsfcontr_dbt sf          "+ 
         "     WHERE mp1.t_dlcontrid = mp.t_dlcontrid          "+ 
         "         AND mp1.t_marketid = 2                      "+ 
         "         AND mp1.t_mpclosedate = to_date('01.01.0001','dd.mm.yyyy')"+
         "         AND sf.t_id = mp1.t_sfcontrid               "+ 
         "         AND sf.t_servkind = 1                       "+
         "         AND sf.t_servkindsub = 8) AS ClientCodeSE   "+
         "    FROM ddlcontrmp_dbt mp                           "+
         "    WHERE mp.t_mpcode = '" + mpcode + "'";

 cmd = RsdCommand(query);
 rs = RSDRecordSet(cmd);
 if(rs.movenext)
    if(valtype(rs.value("ClientCodeSE"))!=26);
      return rs.value("ClientCodeSE");
    else
      return "";
    end;
 end;

 return "";
END;

// массив для протокола сводных сообщений (заполняется в функции "СформироватьСводноеСообщенияДБО()")
private var arrProtocolSvod = TDlMsgProtocol();

private macro GetFormatDate(_date)
   var y, mon, d;
   DateSplit (_date,d,mon,y);
   return string(L_Z(y, 4)) + "-" + string(L_Z(mon,2)) + "-" + string(L_Z(d,2));
end;

private macro GetFormatTime(_time)
   var h, m, s;
   TimeSplit(Time(),h,m,s);
   return string(L_Z(h,2)) + ":" + string(L_Z(m,2)) + ":" + string(L_Z(s, 2));
end;

private macro GetExchangeCode(exchangeCode:@variant, MmvbCode, DlContrID)
  var stat = 0;
  exchangeCode.clear();
  exchangeCode.KeyNum = 2;
  exchangeCode.rec.MmvbCode = MmvbCode;
  if(not GetEQ(exchangeCode))
    stat = 1;
    MsgBox("Не удалось найти запись с биржевым кодом ММВБ " + MmvbCode);
  elif((DlContrID != null) and (DlContrID > 0) and (exchangeCode.rec.DlContrID != DlContrID))
    stat = 1;
    MsgBox("Не удалось найти запись с биржевым кодом ММВБ " + MmvbCode + " и DlContrID = " + DlContrID);
  end;
  return stat;
end;

private class (DL_XML) TDlClientXML(DlContr, SfContr)
   private var m_MainNode,
               m_DlContr, m_SfContr, m_Kind,
               m_Client = TRecHandler("party.dbt"),
               m_UniClientCode, m_UniOurBankCode,
               m_stat = 0;

   macro GetClientXML()
      return m_MainNode.xml;
   end;

  macro Getxml()
      return m_MainNode;
   end;

   macro GetStat()
      return m_stat;
   end;

   private macro GetUniClientCode()
      var CodeKind;
      if(m_UniClientCode == null)
         CodeKind = ПолучитьВидКодаДБОДляБиржи(2);
         if(CodeKind > 0)
           m_UniClientCode = DL_GetDlObjCodeOnDate(OBJTYPE_BROKERCONTR_DL, CodeKind, m_DlContr.rec.DlContrID/*, m_SfContr.rec.DateBegin*/);
         end;
      end;
      return m_UniClientCode;
   end;

   private macro GetUniOurBankCode()
      if(m_UniOurBankCode == null)
         m_UniOurBankCode = ПолучитьКодСубъекта({OurBank}, PTCK_MICEX);
         if(substr(m_UniOurBankCode,1,2) == "MC")
           m_UniOurBankCode = substr(m_UniOurBankCode,3);
         end;
      end;
      return m_UniOurBankCode;
   end;

   private macro GetClientOperation()
      var ClientOperation = "";
      if(m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG)
         ClientOperation = "A";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_MPREG)
         ClientOperation = "L";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_MPCLOSE)
         ClientOperation = "R";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_MARKETCLOSE)
         ClientOperation = "D";
      elif(m_Kind == OBJTYPE_DLCONTRMSG_CHNGPERSDATA)
         ClientOperation = "U";
      end;

      return ClientOperation;
   end;

   private macro GetMarketID(SfContr)
      var MarketID = "";

      if(SfContr.rec.ServKind == PTSK_STOCKDL)
         MarketID = "SE"; // Фондовый рынок
      elif(SfContr.rec.ServKind == PTSK_DV)
         MarketID = "FO"; // Срочный рынок
      elif(SfContr.rec.ServKind == PTSK_CM)
         MarketID = "CU"; // Валютный рынок
      end;

      return MarketID;
   end;

   private macro GetClient()
      if(m_Client.rec.PartyID == 0)
         m_Client.clear();
         ПолучитьСубъекта(m_SfContr.rec.PartyID, m_Client);
      end;

      return m_Client;
   end;

   private macro GetClientIDC(RecFromSelect:TRecHandler, PartyID:integer, PaperKind:integer) :bool
      return DL_GetRecHandler(RecFromSelect,
                              "SELECT * FROM DPERSNIDC_DBT WHERE T_PERSONID = ? " + DL_IIF(PaperKind != null, " AND T_PAPERKIND = ? ", ""),
                              PartyID, PaperKind);
   end;

   private macro GetIsIISContract()
      if(m_DlContr.rec.IIS == SET_CHAR)
         return "Y";
      else
         return "N";
      end;
   end;

   private macro GetClientCodeDescr() :STRING
      var ret = "", query, cmd, ds;
      if(GetClient().rec.PartyID > 0)
         query = " SELECT RSB_SECUR.Translit(replace(replace(trim(t_Name1 "+
                                                     " || CASE WHEN NVL(t_Name2, CHR(1)) = CHR(1) "+
                                                             " THEN '' "+
                                                             " ELSE substr(t_Name2, 1, 1) "+
                                                         " END "+
                                                     " || CASE WHEN NVL(t_Name3, CHR(1)) = CHR(1) "+
                                                             " THEN '' "+
                                                             " ELSE substr(t_Name3, 1, 1) "+
                                                         " END  "+
                                                       " ), '-', ''), ' ', '')) as FIO " +
                   " FROM DPERSN_DBT " +
                  " WHERE t_PersonID = ? ";

         cmd = DL_RSDCommand(query);
         cmd.AddParam(GetClient().rec.PartyID);

         ds = cmd.Execute();
         if(ds.moveNext())
            ret = SQL_ConvTypeStr(ds.FIO);
         end;
      end;
      return ret;
   end;

   private macro Create_CLIENT_MARKETS(DlContrMp)
      var SfContr = TRecHandler("sfcontr.dbt");
      var CLIENT_MARKETS = CreateNode("CLIENT_MARKETS");

      if(DL_GetSfContrRH(SfContr, DlContrMp.rec.SfContrID))
         CLIENT_MARKETS.setAttribute("ClientCode", DlContrMp.rec.MpCode);
         CLIENT_MARKETS.setAttribute("MarketId", GetMarketID(SfContr));

         if(((GetMarketID(SfContr) == "SE") or (GetMarketID(SfContr) == "FO")) and (GetClient().rec.LegalForm == PTLEGF_PERSN))
            CLIENT_MARKETS.setAttribute("isIISContract", GetIsIISContract());

            if((GetMarketID(SfContr) == "SE") and 
               ((m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG) or
                (m_Kind == OBJTYPE_DLCONTRMSG_MPREG))
              )
              if(ИспользоватьСправочникКодов() and (m_stat == 0))
                var exchangeCode = Tbfile("exchangecode.dbt", "W", 2);
                if((m_stat = GetExchangeCode(exchangeCode, DlContrMp.rec.MpCode, DlContrMp.rec.DlContrID)) == 0)
                  exchangeCode.rec.MmvbDate = {curdate};
                  exchangeCode.rec.MmvbTime = time();
                  if(not exchangeCode.Update())
                    m_stat = 1;
                  end;
                end;
                if(m_stat != 0)
                  MsgBox("Не удалось найти/обновить дату исп. кода на фондовой секции, на записи с биржевым кодом ММВБ " + exchangeCode.rec.MmvbCode + " и DlContrID = " + DlContrMp.rec.DlContrID);
                end;
              end;
            end;
         end;

      end;
      CLIENT_MARKETS.setAttribute("isCrossTrades", "N");

      if (GetMarketID(SfContr) == "FO")
          CLIENT_MARKETS.setAttribute("RiskLevel", ""+GetRiskLevel(DlContrMp.rec.mpcode,SfContr.rec.dateconc)+"");
          if(GetClientCodeSE(DlContrMp.rec.mpcode) != "")
             CLIENT_MARKETS.setAttribute("ClientCodeSEStatus", "U");
             CLIENT_MARKETS.setAttribute("ClientCodeSE", ""+GetClientCodeSE(DlContrMp.rec.mpcode)+"");
          end; 
      end;

      if((GetMarketID(SfContr) == "FO") and (GetClient().rec.LegalForm == PTLEGF_PERSN))
         CLIENT_MARKETS.setAttribute("ClientCodeDescr", GetClientCodeDescr());
      end;

      return CLIENT_MARKETS;
   end;

   private macro Create_CLIENT_CODE()
      var query, cmd, ds, DlContrMp = TRecHandler("dlcontrmp.dbt"),
          select  = " SELECT MP.* ",
          from    = " FROM DDLCONTRMP_DBT MP, dsfcontr_dbt sf ",
          where   = " WHERE MP.T_dlcontrID = "+m_DlContr.rec.dlcontrid + " and mp.t_sfcontrid = sf.t_id and sf.t_servkind = 15 and sf.t_dateclose = to_date('01.01.0001','dd.mm.yyyy')";
      var CLIENT_CODE = CreateNode("CLIENT_CODE");

      CLIENT_CODE.setAttribute("UniClientCode", GetUniClientCode());

         query = select + from + where;
         cmd = DL_RSDCommand(query);
         ds = cmd.Execute();
         while((not m_stat) and ds.moveNext() and (ds.ID > 0))
            DlContrMp.clear();
            ds.GetRecord().CopyTo( DlContrMp.rec );
            CLIENT_CODE.appendChild(Create_CLIENT_MARKETS(DlContrMp));
         end;

      return CLIENT_CODE;
   end;

   private macro GetObjLink_cmd(ObjectType, ObjectID, AttrType/*, GroupID*/)
      var query, vGroupID = "", GroupID, i = 4;

      while (GetParm(i, GroupID))
         if(vGroupID != "")
            vGroupID = vGroupID + ",";
         end;
         vGroupID = vGroupID + GroupID;
         i = i + 1;
      end;

      query = " SELECT T_ATTRID FROM DOBJLINK_DBT WHERE T_OBJECTTYPE = " + ObjectType +
              "                                     AND T_OBJECTID = " + ObjectID +
              "                                     AND T_ATTRTYPE = " + AttrType +
              "                                     AND T_GROUPID IN (" + vGroupID +")";

      return DL_RSDCommand(query);
   end;

   // получить представителя субъекта
   private macro GetRepresentativePers(PartyID)
      var PersPartyID = UnknownParty, query, cmd, ds, pBuf = TRecHandler("party.dbt"), existsDefault = false, existsInDate = false;

      // Если субъект несовершеннолетний, то ищем его законных представителей:
      // 1. Мать/отца, через связанные объекты на субъекте 
      cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, OBJROLE_PARTY_FATHER, OBJROLE_PARTY_MOTHER);
      ds = cmd.Execute();
      if(ds.moveNext())
         pBuf.Clear();
         if(RestoreFromUniID(ds.AttrID, pBuf, OBJTYPE_PARTY) and (pBuf.rec.PartyID > 0))
            PersPartyID = pBuf.rec.PartyID;
         end;
      // 2. иначе ищем представителя, который вызывается на субъекте по Alt+Y
      else
         query = " SELECT T_PROXYID, T_DOCDATE, T_VALIDITYDATE, T_ISDEFAULT FROM DPTPROXY_DBT WHERE T_PARTYID = " + PartyID;
         cmd = DL_RSDCommand(query);
         ds = cmd.Execute();
         while(ds.moveNext())
            if(PersPartyID == UnknownParty)
               PersPartyID = ds.ProxyID;
            end;

            if(({curdate} >= SQL_ConvTypeDate(ds.DocDate)) and ({curdate} <= SQL_ConvTypeDate(ds.ValidityDate)))
               if(not existsInDate)
                  PersPartyID = ds.ProxyID;
                  existsInDate = true;
               end;
               
               if(ds.IsDefault == SET_CHAR)
                  PersPartyID = ds.ProxyID;
                  break;
               end;
            elif((ds.IsDefault == SET_CHAR) and (not existsDefault))
               PersPartyID = ds.ProxyID;
               existsDefault = true;
            end;
         end;
      end;

      return PersPartyID;
   end;

   private macro SetNodesIn_CLIENT_INDIVIDUAL(PartyID, IsRepresentative, ParentNode)
      var stat = false;
      var ClientIDC = TRecHandler("persnidc.dbt"), node, DocNo, PersPartyID,
          existsDoc = false, PaperSeries = "";

      if(GetClientIDC(ClientIDC, PartyID, DOC_PASSPORT))
         PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
         if((strlen(PaperSeries) > 0) and (strlen(ClientIDC.rec.PaperNumber) > 0))
            if(strlen(PaperSeries) > 3)
               DocNo = SubStr(PaperSeries, 1, 2) + " " + SubStr(PaperSeries, 3, 2) + " " + ClientIDC.rec.PaperNumber;
               node = CreateNode("PASSPORT_RF");
               node.setAttribute("DocNo", DocNo);
               ParentNode.appendChild(node);
               existsDoc = true;
               stat = true;
            end;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      elif(GetClientIDC(ClientIDC, PartyID, DOC_USSRPASS))
         PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
         if((strlen(PaperSeries) > 0) and (strlen(ClientIDC.rec.PaperNumber) > 0))
            DocNo = PaperSeries + " " + ClientIDC.rec.PaperNumber;
            node = CreateNode("PASSPORT_USSR");
            node.setAttribute("DocNo", DocNo);
            ParentNode.appendChild(node);
            existsDoc = true;
            stat = true;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      elif(GetClientIDC(ClientIDC, PartyID, DOC_BIRTH_CERTIFICATE) and (not IsRepresentative))
         PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
         if((strlen(PaperSeries) > 0) and (strlen(ClientIDC.rec.PaperNumber) > 0))
            DocNo = PaperSeries + " " + ClientIDC.rec.PaperNumber;
            node = CreateNode("BIRTH_CERTIFICATE");
            node.setAttribute("DocNo", DocNo);
            ParentNode.appendChild(node);
            stat = true;

            var REPRESENTATIVE_PERS = CreateNode("REPRESENTATIVE_PERS");
            PersPartyID = GetRepresentativePers(PartyID);
            if(PersPartyID != UnknownParty)
               if(SetNodesIn_CLIENT_INDIVIDUAL(PersPartyID, true, REPRESENTATIVE_PERS))
                  ParentNode.appendChild(REPRESENTATIVE_PERS);
               end;
            end;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      elif(GetClientIDC(ClientIDC, PartyID))
         if(strlen(ClientIDC.rec.PaperNumber) > 0)
            PaperSeries = StrSubst(ClientIDC.rec.PaperSeries, " ", "");
            DocNo = DL_IIF(strlen(PaperSeries) > 0, (PaperSeries + " "), "") + ClientIDC.rec.PaperNumber;
            node = CreateNode("OTHER_DOC");
            node.setAttribute("DocNo", DocNo);
            ParentNode.appendChild(node);
            existsDoc = true;
            stat = true;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не заданы параметры документа");
         end;
      end;

      if( (not m_stat) and (not existsDoc) )
         m_stat = 1;
         MsgBox("Для субъекта \"" + DL_GetPartyShortName(PartyID) + "\" не задан документ, удостоверяющий личность");
      end;

      return stat;
   end;

   private macro Create_CLIENT_INDIVIDUAL(PartyID, IsClient)
      var ClientIDC = TRecHandler("persnidc.dbt"), node;
      var CLIENT_INDIVIDUAL = CreateNode("CLIENT_INDIVIDUAL");

      if(IsClient)
         CLIENT_INDIVIDUAL.setAttribute("isIISContract", GetIsIISContract());
      end;

      SetNodesIn_CLIENT_INDIVIDUAL(PartyID, false, CLIENT_INDIVIDUAL);

      return CLIENT_INDIVIDUAL;
   end;

   private macro GetIsSelfFirm()
      if( (GetClient().rec.PartyID == {OurBank} ) AND
          (DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER))
         return true;
      end;
      return false;
   end;

   private macro GetIsMainSingleDU()
      if((GetClient().rec.NotResident == UNSET_CHAR) AND
         (DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER))
         var cmd, ds, cnt = 0;
         cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 8/*Учредитель ДУ*/);
         ds = cmd.Execute();
         while(ds.moveNext())
            cnt = cnt + 1;
         end;

         if(cnt > 1)
            return true;
         end;
      end;

      return false;
   end;

   private macro GetIsMainPF()
      if((GetClient().rec.NotResident == UNSET_CHAR) AND
         (DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER))
         var cmd, ds;
         cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 9/*Фонд ДУ*/);
         ds = cmd.Execute();
         if(ds.moveNext())
            return true;
         end;
      end;

      return false;
   end;

   private macro Create_INN(val)
      var INN = CreateNode("INN");
      INN.setAttribute("DocNo", val);
      return INN;
   end;

   private macro Create_KIO(val)
      var KIO = CreateNode("KIO");
      KIO.setAttribute("DocNo", val);
      return KIO;
   end;

   private macro GetINN(PartyID, PTCK_Kind)
      var inn, slashInd, innNotKPP;

      inn = ПолучитьКодСубъекта(PartyID, PTCK_Kind);
      slashInd = Index(inn, "/");
      innNotKPP = DL_IIF(slashInd > 0, SubStr(inn, 1, slashInd - 1), inn);

      return innNotKPP;
   end;

   private macro Create_CLIENT_LEGAL_PERS(PartyID, IsClient)
      var innNotKPP, KIO, party = TRecHandler("party.dbt");
      var CLIENT_LEGAL_PERS = CreateNode("CLIENT_LEGAL_PERS");

      if(ПолучитьСубъекта(PartyID, party) == 0)
         if(IsClient)
            if(GetIsSelfFirm())
               CLIENT_LEGAL_PERS.setAttribute("isSelfFirm", "Y");
            end;
      
            if(GetIsMainSingleDU())
               CLIENT_LEGAL_PERS.setAttribute("isMainSingleDU", "Y");
               CLIENT_LEGAL_PERS.setAttribute("isMainGroupDU", "Y");
            end;
      
            if(GetIsMainPF())
               CLIENT_LEGAL_PERS.setAttribute("isMainPF", "Y");         
            end;
         end;
   
         innNotKPP = GetINN(PartyID, DL_IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));
   
         if((innNotKPP != null) and (innNotKPP != ""))
            innNotKPP = L_Z(innNotKPP, 10);
            CLIENT_LEGAL_PERS.appendChild(Create_INN(innNotKPP));
         else
            if(party.rec.NotResident == UNSET_CHAR)
               m_stat = 1;
               MsgBox("Для субъекта \"" + Party.rec.ShortName + "\" не задан ИНН");
            else
               KIO = ПолучитьКодСубъекта(party.rec.PartyID, PTCK_INN /*если ИНН = 5 символов, то это КИО*/);
               if((KIO != null) and (strlen(KIO) == 5))
                  CLIENT_LEGAL_PERS.appendChild(Create_KIO(KIO));
               else
                  m_stat = 1;
                  MsgBox("Для субъекта \"" + Party.rec.ShortName + "\" не задан ИНН/КИО");
               end;
            end;
         end;
      end;

      return CLIENT_LEGAL_PERS;
   end;

   private macro Create_CLIENT_SIMPLE()
      var CLIENT_SIMPLE = CreateNode("CLIENT_SIMPLE");
      var TradingRestrictionsAttr = DL_GetMainObjAttr(m_DlContr, 125/*TRD_RESTR*/, OBJTYPE_BROKERCONTR_DL);

      CLIENT_SIMPLE.setAttribute("CountryCode", DL_GetCountryByCodeLat3(GetClient().rec.NrCountry).CodeNum3);
      CLIENT_SIMPLE.setAttribute("isQualInvestor", DL_IIF(IsQI(GetClient().rec.PartyID, m_DlContr.rec.SfContrID), "Y", "N" ));

      if (TradingRestrictionsAttr > 0)
        CLIENT_SIMPLE.setAttribute("TRD_RESTR", String(TradingRestrictionsAttr));
      end;

      if(GetClient().rec.LegalForm == PTLEGF_INST)
         CLIENT_SIMPLE.appendChild(Create_CLIENT_LEGAL_PERS(GetClient().rec.PartyID, true));
      else
         CLIENT_SIMPLE.appendChild(Create_CLIENT_INDIVIDUAL(GetClient().rec.PartyID, true));
      end;

      return CLIENT_SIMPLE;
   end;

   private macro Create_CLIENT_DU(Party)
      var CLIENT_DU = CreateNode("CLIENT_DU");      
      
      if(ПолучитьСубъекта(Party.rec.PartyID, Party) == 0)
         CLIENT_DU.setAttribute("CountryCode", DL_GetCountryByCodeLat3(Party.rec.NrCountry).CodeNum3);

         if(IsQI(Party.rec.PartyID, m_DlContr.rec.SfContrID))
            CLIENT_DU.setAttribute("isQualInvestor", "Y");
         end;

         if(Party.rec.LegalForm == PTLEGF_PERSN)
            CLIENT_DU.appendChild(Create_CLIENT_INDIVIDUAL(Party.rec.PartyID, false));
         else
            CLIENT_DU.appendChild(Create_CLIENT_LEGAL_PERS(Party.rec.PartyID, false));
         end;
      end;

      return CLIENT_DU;
   end;

   private macro Create_PIF(val)
      var PIF = CreateNode("PIF");
      PIF.setAttribute("RegNum", val);
      return PIF;
   end;

   private macro Create_NPF_Reserv(val)
      var NPF_Reserv = CreateNode("NPF_Reserv");
      NPF_Reserv.setAttribute("INN", val);
      return NPF_Reserv;
   end;

   private macro Create_NPF_Save(val)
      var NPF_Save = CreateNode("NPF_Save");
      NPF_Save.setAttribute("INN", val);
      return NPF_Save;
   end;

   private macro Create_NPF_Ustav(val)
      var NPF_Ustav = CreateNode("NPF_Ustav");
      NPF_Ustav.setAttribute("INN", val);
      return NPF_Ustav;
   end;

   private macro Create_PF(inn, PartyID)
      var party = TRecHandler("party.dbt"), InfoIP;
      var PF = CreateNode("PF");
      PF.setAttribute("INN", inn);

      party.rec.PartyID = PartyID;
      InfoIP = ReadNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 72/*Код инвестиционного портфеля*/);
      if(InfoIP != null)
         PF.setAttribute("InfoIP", InfoIP);
      end;

      return PF;
   end;

   private macro Create_HomeMilitary(inn, PartyID)
      var party = TRecHandler("party.dbt"), InfoIP;
      var HomeMilitary = CreateNode("HomeMilitary");
      HomeMilitary.setAttribute("INN", inn);

      party.rec.PartyID = PartyID;
      InfoIP = ReadNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 72/*Код инвестиционного портфеля*/);
      if(InfoIP != null)
         HomeMilitary.setAttribute("InfoIP", InfoIP);
      end;

      return HomeMilitary;
   end;

   private macro Create_CLIENT_PF(Party)
      var FSFR, innNotKPP;
      var CLIENT_PF = CreateNode("CLIENT_PF");      

      if(IsQI(Party.rec.PartyID, m_DlContr.rec.SfContrID))
         CLIENT_PF.setAttribute("isQualInvestor", "Y");
      end;

      if( ВидСубъекта( Party.rec.PartyID, PTK_UNIT_INVESTMENT_FUND ) )
         FSFR = ПолучитьКодСубъекта(Party.rec.PartyID, PTCK_FSFR);
         if(FSFR != "")
            CLIENT_PF.appendChild(Create_PIF(FSFR));
         end;
      else
         innNotKPP = GetINN(Party.rec.PartyID, DL_IIF(party.rec.NotResident == UNSET_CHAR, PTCK_INN, PTCK_FOREIGN_INN));

         if((innNotKPP != null) and (innNotKPP != ""))
            if( ВидСубъекта( Party.rec.PartyID, PTK_NPF ) )
               CLIENT_PF.appendChild(Create_NPF_Save(innNotKPP));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_FUNDRESERVENPF ) )
               CLIENT_PF.appendChild(Create_NPF_Reserv(innNotKPP));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_PROPERTYFUNDNPF ) )
               CLIENT_PF.appendChild(Create_NPF_Ustav(innNotKPP));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_PENSFOND ) )
               CLIENT_PF.appendChild(Create_PF(innNotKPP, Party.rec.PartyID));
            elif( ВидСубъекта( Party.rec.PartyID, PTK_ACCUMULATIONFUND ) )
               CLIENT_PF.appendChild(Create_HomeMilitary(innNotKPP, Party.rec.PartyID));
            end;
         else
            m_stat = 1;
            MsgBox("Для субъекта \"" + Party.rec.ShortName + "\" фонда ДУ не задан ИНН");
         end;
      end;

      return CLIENT_PF;
   end;

   private macro Create_CLIENT_INFO()
      var cmd, ds, pBuf = TRecHandler("party.dbt"), existsDU = false;
      var CLIENT_INFO = CreateNode("CLIENT_INFO");

      if( ВидСубъекта( GetClient().rec.PartyID, PTK_CLIENT ) )
         if(DL_GetMainObjAttr( GetClient(), PARTY_ATTR_GROUP_PTTYPE, OBJTYPE_PARTY ) == PARTY_ATTR_PTTYPE_TRUSTMANAGER)
            cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 8/*Учредитель ДУ*/);
            ds = cmd.Execute();
            while((not m_stat) and (ds.moveNext()))
               pBuf.Clear();
               if(RestoreFromUniID(ds.AttrID, pBuf, OBJTYPE_PARTY) and (pBuf.rec.PartyID > 0))
                  CLIENT_INFO.appendChild(Create_CLIENT_DU(pBuf));
                  existsDU = true;
               end;
            end;

            cmd = GetObjLink_cmd(OBJTYPE_PARTY, UniID(GetClient(), OBJTYPE_PARTY), OBJTYPE_PARTY, 9/*Фонд ДУ*/);
            ds = cmd.Execute();
            while((not m_stat) and (ds.moveNext()))
               pBuf.Clear();
               if(RestoreFromUniID(ds.AttrID, pBuf, OBJTYPE_PARTY) and (pBuf.rec.PartyID > 0))
                  CLIENT_INFO.appendChild(Create_CLIENT_PF(pBuf));
                  existsDU = true;
               end;
            end;

            if(not existsDU)
               m_stat = 1;
               MsgBox("Для доверительного управляющего \"" + GetClient().rec.ShortName + "\" не заполнены учредители и фонды ДУ.");
            end;
         else
            CLIENT_INFO.appendChild(Create_CLIENT_SIMPLE());
         end;
      end;

      return CLIENT_INFO;
   end;

   private macro Create_CLIENT()
      var CLIENT = CreateNode("CLIENT");

      CLIENT.setAttribute("ClientOperation", GetClientOperation());
      CLIENT.setAttribute("OperationId", 1);
      CLIENT.setAttribute("LKU", LKU);
      
      CLIENT.appendChild(Create_CLIENT_CODE());
      if( (not m_stat) and ((m_Kind == OBJTYPE_DLCONTRMSG_MARKETREG) or (m_Kind == OBJTYPE_DLCONTRMSG_CHNGPERSDATA)) )
        CLIENT.appendChild(Create_CLIENT_INFO());
      end;

      m_MainNode = CLIENT;

   OnError(er)
      if(er.Code != 0)
         m_stat = er.Code;
      else
         m_stat = 1;
      end;
   end;

   macro Construct( DlContr, SfContr, DlContrMsg );
      m_DlContr = DlContr;
      m_SfContr = SfContr;
      m_Kind = OBJTYPE_DLCONTRMSG_MPREG;
      m_MainNode = null;
      CreateXML("utf-8");

      Create_CLIENT();
   end;

   initDL_XML();
   this.Construct( DlContr, SfContr );
END;

private class (DL_XML) TDlFileClientsXML(IndividualFile:Bool,MSGID,BegID,EndID)
   private var m_MainNode,
               m_UniOurBankCode, m_UniClientCode,
               m_IndividualFile;
   private var dl_msgid = MSGID, dl_begid = BegID, dl_endid = EndID;

   private macro GetFileName()
      var y, mon, d, h, m, s;

      if(m_FileName == NULL)
         m_FileName = "ECLIENTS_" + this.GetUniOurBankCode() + "_";

         DateSplit ({curdate},d,mon,y);
         TimeSplit(Time(),h,m,s);
         m_FileName = m_FileName + GetFormatDate({curdate}) + "_" + string(L_Z(h,2)) + string(L_Z(m,2)) + string(L_Z(s, 2));
      end;

      return m_FileName;
   end;

   macro GetDataXML()
      return m_MainNode.xml;
   end;


   macro SaveXml()
      var NamePath = "", NameFile = "", NamePathFile = "";

      if(m_MainNode != null)
         AddMainNode(m_MainNode);

         NamePath = DL_GetFullPath("..\\txtFile");

         NameFile = GetFileName(); 
         NamePathFile = NamePath + NameFile + ".xml";
         m_xml.save(NamePathFile);
      end;

      return NamePathFile;
   end;

   macro GetUniOurBankCode()
      if(m_UniOurBankCode == null)
         m_UniOurBankCode = ПолучитьКодСубъекта({OurBank}, PTCK_MICEX);
         if(substr(m_UniOurBankCode,1,2) == "MC")
           m_UniOurBankCode = substr(m_UniOurBankCode,3);
         end;
      end;
      return m_UniOurBankCode;
   end;

   macro GetUniClientCode()
      if(m_UniClientCode == null)
         m_UniClientCode = "";
      end;
      return m_UniClientCode;
   end;

   private macro SetUniClientCode(xmlClient)
      if(xmlClient != null)
         var CLIENT_CODE = xmlClient.getElementsByTagName( "CLIENT_CODE" );
         if((CLIENT_CODE != null) and (CLIENT_CODE.Length > 0))
            if(CLIENT_CODE.item(0).attributes.Length > 0)
               var UniClientCode = CLIENT_CODE.item(0).getAttribute("UniClientCode");
               if((UniClientCode != null) and (ValType(UniClientCode) != V_SPECVAL))
                  m_UniClientCode = UniClientCode;
               end;
            end;
         end;
      end;
   end;

   private macro GetSfContrRH(xmlClient, RecFromSelect)
      if(xmlClient != null)
         var CLIENT = xmlClient.getElementsByTagName( "CLIENT" );
         if((CLIENT != null) and (CLIENT.Length > 0))
            if(CLIENT.Item(0).attributes.Length > 0)
               var ClientCodeXml = DL_XMLReader();
               if(ClientCodeXml.Load_xml(CLIENT.Item(0).xml))
                  var CLIENT_CODE = ClientCodeXml.getXML().getElementsByTagName( "CLIENT_CODE" );
                  var UniClientCode = CLIENT_CODE.Item(0).getAttribute("UniClientCode");
                  if(StrLen(UniClientCode) > 0)
                     var Query = "SELECT msf.* \n" +
                                 "  FROM ddlcontrmp_dbt contr, \n" +
                                 "       dsfcontr_dbt sf, \n" +
                                 "       dsfcontr_dbt msf, \n" +
                                 "       ddlcontr_dbt d \n" +
                                 " WHERE     sf.t_ID = contr.t_SfContrID \n" +
                                 "       AND d.t_dlcontrid = contr.t_dlcontrid \n" +
                                 "       AND msf.t_id = d.t_sfcontrid \n" +
                                 "       AND contr.t_mpcode = '" + UniClientCode + "' \n" ;

                     RecFromSelect.Clear();
                     if(DL_GetRecHandler(RecFromSelect, Query))
                        return true;
                     end;
                  end;
               end;
            end;
         end;
      end;
      return false;
   end;

   private macro GetClientOperation(xmlClient)
      var ClientOperationName = "";

      if(xmlClient != null)
         var CLIENT = xmlClient.getElementsByTagName( "CLIENT" );
         if((CLIENT != null) and (CLIENT.Length > 0))
            if(CLIENT.Item(0).attributes.Length > 0)
               var ClientOperation = CLIENT.Item(0).getAttribute("ClientOperation");
               ClientOperation = SQL_ConvTypeStr(ClientOperation);
               if(ClientOperation == "A")
                  ClientOperationName = "\"A\" - добавление информации о новом клиенте";
               elif(ClientOperation == "L")
                  ClientOperationName = "\"L\" - добавление клиенту новых кратких кодов";
               elif(ClientOperation == "R")
                  ClientOperationName = "\"R\" - удаление кратких кодов клиента на рынках";
               elif(ClientOperation == "D")
                  ClientOperationName = "\"D\" - полное удаление информации о клиенте";
               elif(ClientOperation == "U")
                  ClientOperationName = "\"U\" - изменение информации о личных данных клиента";
               end;
            end;
         end;
      end;

      return ClientOperationName;
   end;

   private macro AddMessToProtocolSvod(xmlClient)
      var SfContr = TRecHandler("sfcontr.dbt");

      GetSfContrRH(xmlClient, SfContr);
      if(SfContr.rec.ID > 0)
         arrProtocolSvod.Add(SfContr.rec.Number,
                             DL_getPartyShortName(SfContr.rec.PartyID),
                             GetClientOperation(xmlClient));
      end;
   end;

   private macro Create_CLIENTS()
      var query, cmd, ds, query1, cmd1, ds1, xmlClient;
      var dlcontr = TRecHandler("dlcontr.dbt"), sfcontr = TRecHandler("sfcontr.dbt");
      var stat = 0;
      var CLIENTS = CreateNode("CLIENTS");

      CLIENTS.setAttribute("UniFirmId", GetUniOurBankCode());

      CLIENTS.setAttribute("LoadToTE", LoadToTE);
      CLIENTS.setAttribute("DocDate", GetFormatDate(date)); 

      query = "SELECT DL.* FROM DDLCONTR_DBT DL, DSFCONTR_DBT SF, DPARTY_DBT PT " +
              " WHERE DL.T_SFCONTRID = SF.T_ID AND SF.T_DATECLOSE = TO_DATE('01/01/0001','DD/MM/YYYY') " +
              " AND PT.T_PARTYID = SF.T_PARTYID AND PT.T_LEGALFORM = 2 " +
              " AND exists(select 1 FROM ddlcontrmp_dbt mp, dsfcontr_dbt sf1 WHERE mp.t_sfcontrid = sf1.t_id AND sf1.t_servkind = 15 AND sf1.t_dateclose = to_date('01.01.0001','dd.mm.yyyy')) " +
              " AND dl.t_dlcontrid >= ? AND dl.t_dlcontrid < ? ";

      cmd = DL_RSDCommand(query);
      cmd.AddParam(dl_BegID);
      cmd.AddParam(dl_EndID);

      ds = cmd.Execute();

      while(ds.moveNext())
        dlcontr.Clear();
        ds.GetRecord().CopyTo(dlcontr.rec);

        query1 = "SELECT * FROM DSFCONTR_DBT WHERE T_ID = ? ";

        cmd1 = DL_RSDCommand(query1);
        cmd1.AddParam(dlcontr.rec.SfContrID);

        ds1 = cmd1.Execute();

        if(ds1.moveNext())
          sfcontr.Clear();
          ds1.GetRecord().CopyTo(sfcontr.rec);

          // сформировать, в зависимости от вида сообщения, xml-узел CLIENT
          xmlClient = TDlClientXML(DlContr, SfContr);
          stat = xmlClient.GetStat();

          if((stat == 0) and (strlen(xmlClient.GetClientXML()) > 0))
            CLIENTS.appendChild(xmlClient.GetXML());
          end;
        end;
      end;
     
      return CLIENTS;
   end;

   private macro Create_DOC_REQUISITES()
      var DOC_REQUISITES = CreateNode("DOC_REQUISITES");

      DOC_REQUISITES.setAttribute("DOC_DATE", GetFormatDate({curdate}));
      DOC_REQUISITES.setAttribute("DOC_TIME", GetFormatTime(Time()));

      var RefID, RefNum;
      if(DL_GenerateNumberByReference( 207, 5, @RefID, @RefNum ))
         DOC_REQUISITES.setAttribute("DOC_NO", RefNum);
      else
         RefNum = "";
      end;

      DOC_REQUISITES.setAttribute("DOC_TYPE_ID", "ECLIENTS");
      DOC_REQUISITES.setAttribute("SENDER_ID", GetUniOurBankCode());
      var sn = SENDER_NAME;
      if(sn == "")
        sn = "АО Россельхозбанк"/*GetPartyShortNameByID({OurBank})*/;
      end;      
      DOC_REQUISITES.setAttribute("SENDER_NAME", sn);
      DOC_REQUISITES.setAttribute("RECEIVER_ID", "MM0000100000");
      DOC_REQUISITES.setAttribute("REMARKS", "Клиенты");

      var cmd, rs;
      StartCaptureOutput();
      [ 
        select substr(sys_guid(),9,12-length(?))||? t_guid from dual
      ];
      cmd = RsdCommand(EndCaptureOutput());
      cmd.AddParam("n1", RSDBP_IN, string(RefNum));
      cmd.AddParam("n2", RSDBP_IN, string(RefNum));
      rs = RSDRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
      rs.movenext();
      DOC_REQUISITES.setAttribute("DOC_NO", rs.value("t_guid"));
      DOC_REQUISITES.setAttribute("DOC_TIME", GetFormatTime(Time()));
      DOC_REQUISITES.setAttribute("DOC_DATE", GetFormatDate(date));  

      return DOC_REQUISITES;
   end;

   private macro Create_FileCLIENT()
      m_MainNode = CreateNode("MICEX_DOC");

      m_MainNode.setAttribute("xsi:noNamespaceSchemaLocation", "MoexClients.xsd");
      m_MainNode.setAttribute("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");

      m_MainNode.appendChild(Create_DOC_REQUISITES());
      m_MainNode.appendChild(Create_CLIENTS());
   end;

   macro Construct(IndividualFile);
      m_MainNode = null;
      m_IndividualFile = IndividualFile;
      CreateXML("utf-8");

      Create_FileCLIENT();
   end;

   initDL_XML();
   this.Construct(IndividualFile);
end;


private macro ФормФайлБиржСообщДБО(IndividualFile:Bool, MSGID, BegID, EndID)
   var XMLFileName = "", DataXML = "", fileClients;
   fileClients = TDlFileClientsXML(IndividualFile, MSGID, BegID, EndID);
   DataXML = fileClients.GetDataXML();

   if(strlen(DataXML) > 0)
      XMLFileName = fileClients.SaveXml();
   end;

   return XMLFileName;
   
OnError(er)
   return "";
end;

private macro Run()
   var cntDBO = 0;
   var c = DL_RSDCommand("select count(1) cnt from DDLCONTR_DBT");
   var d = c.Execute();
   if(d.moveNext())
     cntDBO = d.cnt;
   end;
 
   var i = 0;
   var chunk = 10000;
   GetInt(chunk, "Введите размер пачки");
 
   InitProgress(int(cntDBO/chunk)+1, "Формирование пачек сообщений", "Формирование пачек сообщений");
   while(i < cntDBO)   
     var fullPathName = ФормФайлБиржСообщДБО(true, 0, i, i + chunk);
     println(fullPathName);
     i = i + chunk;
     UseProgress(i/chunk)
   end;
   RemProgress();
end;

Run();
Exit(1);