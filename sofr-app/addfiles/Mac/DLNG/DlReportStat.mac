/*
$Name:             DlReportStat.mac
$Module:           Ÿ¤à® Securities
$Description:      Žâç¥â"‘â â¨áâ¨ª  ¨á¯®«ì§®¢ ­¨ï ®âç¥â®¢ ¢ á¨áâ¥¬¥"
*/
/******************************************************************/
/* PROGRAMMED BY:   Movsesyan S.                                  */
/* CREATION DATE:   March 2014                                    */      
/******************************************************************/

import "sprepfun.mac";

private var
  Table = "ÚÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
          "³„¨áâà.³   ‚¨¤  ³     ¨¬¥­®¢ ­¨¥    ³                ã­ªâ ¬¥­î               ³     „ â     ³  Š®«¨ç¥áâ¢® ³\n" +
          "³      ³ ®âç¥â  ³       ®âç¥â        ³                                         ³  ¯®á«¥¤­¥£® ³   § ¯ãáª®¢  ³\n" +
          "³      ³        ³                    ³                                         ³    § ¯ãáª   ³             ³\n" + 
          "ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
          "³   1  ³    2   ³          3         ³                    4                    ³      5      ³       6     ³\n" +
          "ÃÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
private var 
  ReportHeader = "                               ‘’€’ˆ‘’ˆŠ€ ˆ‘Ž‹œ‡Ž‚€ˆŸ Ž’—…’Ž‚ ‚ ‘ˆ‘’…Œ…\n\n ®¤á¨áâ¥¬ : ###################################\n",
  ReportSubHeader = "\n\n ®¤á¨áâ¥¬ : ###################################\n";

PRIVATE CLASS ( DL_CReportTemplate ) StatReport

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_STD;
  END;

  MACRO GetNameModule(ident_program)
    var ret  = "";

    if( ident_program == CodeFor("S") )
      ret = "–¥­­ë¥ ¡ã¬ £¨"; 
    elif( ident_program == CodeFor("Y") )
      ret = "‚¥ªá¥«ï ¡ ­ª ";
    elif( ident_program == CodeFor("Z") )
      ret = "„¥¯®§¨â à¨©"; 
    elif( ident_program == CodeFor("N") )
      ret = "“çâ¥­­ë¥ ¢¥ªá¥«ï"; 
    elif( ident_program == CodeFor("ž") )
      ret = "à®¨§¢®¤­ë¥ ¨­áâàã¬¥­âë";
    elif( ident_program == CodeFor("T") )
      ret = "Web  «®£®¢ë© ãç¥â";
    else 
      ret = StrFor(ident_program); 
    end;
    return ret;

  END; 
   
  PRIVATE MACRO PrintHeader( ident_program, FirstPrint )
    PrintFormatString( IIF(FirstPrint, ReportHeader, ReportSubHeader), "N1_A0", GetNameModule( ident_program ) );
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    CreateTotalBook();     
    SetActiveSheet( "0101" );
    
  END;
  
   
  PRIVATE MACRO PrintReport( IdentProgram )
    var Query = " SELECT t_IdentProgram, t_ReportKind, t_ReportName, t_Menu, max(t_sysdate) maxdate, count(1) count "+
                " FROM ddl_report_stat_dbt " +
                " WHERE t_IdentProgram = '" + string(IdentProgram) + "' " +
                " GROUP BY  t_IdentProgram, t_ReportKind, t_ReportName, t_Menu " +
                " ORDER BY count desc ";
    var Sql = RSDCommand( Query );
    Sql.Execute();
    var Data = TRSBDataSet( Sql );

    InitProgressBar( SQL_GetNRecs(Query), "‚ë¯ãáª ®âç¥â  \"‘â â¨áâ¨ª  ¨á¯®«ì§®¢ ­¨ï ®âç¥â®¢ \"", "¥ç âì ®âç¥â " );   
    while( Data.MoveNext )
      UseProgressBar;
      PrintTableLine( "N1_A1",  IIF( Data.ReportKind > 999, "X", "" ),   null,
                      "N1_A2",  Data.ReportKind,                         null,
                      "N1_A3",  Data.ReportName,                         null,
                      "N1_A4",  Data.Menu,                               null,
                      "N1_A5",  date(Data.MaxDate),                      null,
                      "N1_A6",  Data.Count,                              null 
                    );    
      
    end;
    CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
    RemProgressBar;
  END;

   
  PRIVATE MACRO EndReport( NumCopy:INTEGER )
    SaveTotalBook();
  END;
   
      
  PRIVATE MACRO Create( NumCopy:INTEGER )
    var Query = " SELECT DISTINCT t_IdentProgram FROM ddl_report_stat_dbt ";
    var Sql = RSDCommand( Query );
    Sql.Execute();
    var Data = TRSBDataSet( Sql );
    var FirstPrint : Bool = true;

    while( Data.MoveNext )
      PrintHeader( CodeFor(Data.IdentProgram), FirstPrint );

      if( FirstPrint )
        RegisterTable( "N1_MainTable", Table, 
                       "N1_A1",
                       "N1_A2", 
                       "N1_A3", 
                       "N1_A4", 
                       "N1_A5",
                       "N1_A6" );
      end;
   
      PrintReport( Data.IdentProgram );
      FirstPrint = false;
    end;

    if( not FirstPrint )
      EndTable();
    end;
  END;  
  initDL_CReportTemplate( NULL, "Report_RepStat.xls" );

END;
StatReport().Run();
