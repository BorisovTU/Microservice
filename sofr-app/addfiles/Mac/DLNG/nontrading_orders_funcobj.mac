/*
  nontrading_orders_funcobj.mac
  Выполнение операций списания/зачисления/перевод ДС через funcobj
*/
import DealsInter, "FuncObj.mac", oralib, likepy, "cblogger2.mac";

macro RunOperation(objectType, objectID, paramString)
  var err = 0;
  var ErrStr = "";
  var ReturnObj = FuncObjResult(FUNCOBJ_RESULT_OK, "", 0);
  var logger = NewLogger(c_logger.IT_LOG_TYPE, "NONTRADING_ORDERS_FUNCOBJ.MAC");

  err = DL_ExecuteNptxOp(objectID, true, ErrStr);

  if (    ((err != 0 ) OR (ErrStr != ""))
      and (err != 1380) //"Отсутствует шаг требуемого вида" - возникает, когда операция уже была закрыта
      )
    ReturnObj.state = FUNCOBJ_RESULT_ERROR;
    ReturnObj.errorText = ErrStr;
    ReturnObj.errorCode = err;
    ExecStoredFunc("nontrading_orders_utils.set_status_wait", V_UNDEF, MakeArray(SqlParam("p_nptxop_id", objectID)));
    logger.Error("id = " + objectID + "; errcode = " + err + "; errstr = " + ErrStr);
  end;

  return ReturnObj;

end;