/*
$Name:         nptxfun.mac
$Module:       Ядро Securities
$Description: Константы, общие функции НДФЛ
*/

import "dlreport.mac", FIInter;
import "dlquery.mac";

//Дата нового НДФЛ
const NPTX_NEW_TIPI_DATE_2015 = date(1,1,2015);
const NPTX_NEW_TIPI_DATE_2018 = date(31,12,2017);
const NPTX_LIMINCOME_MAX15 = 5000000; //Сумма дохода ФЛ, после превышения которой начинает действовать повышенная ставка НДФЛ (с 01.02.2021)

/*Константы видов объектов НДР, по таблице dnptxkind_dbt*/
const TXOBJ_MAIN             = 10; 
const TXOBJ_NKD              = 20; 
const TXOBJ_COM              = 30; 
const TXOBJ_MATERIAL         = 40; 
const TXOBJ_DIF              = 50; 
const TXOBJ_VAR              = 60; 
const TXOBJ_PREM             = 70; 
const TXOBJ_PAY              = 80; 
const TXOBJ_PROCREPOPAY      = 90; 
const TXOBJ_FR_DERIV         = 100; 
const TXOBJ_MAINB            = 110;
const TXOBJ_MAINB_0          = 115;
const TXOBJ_NKDB             = 120;
const TXOBJ_COMB             = 130;
const TXOBJ_COMB_0           = 135;
const TXOBJ_MATERIALB        = 140;
const TXOBJ_TAXPM_LINK       = 150;
const TXOBJ_DIFB             = 160;
const TXOBJ_MAINS            = 170;
const TXOBJ_MAINS_0          = 175;
const TXOBJ_NKDS             = 180;
const TXOBJ_COMS             = 190;
const TXOBJ_COMS_0           = 195;
const TXOBJ_DIFS             = 200;
const TXOBJ_MAINB_TS         = 210;
const TXOBJ_MAINB_TS_0       = 215;
const TXOBJ_COMB_TS          = 220;
const TXOBJ_COMB_TS_0        = 225;
const TXOBJ_MATERIALB_TS     = 230;
const TXOBJ_TAXPM_TS         = 240;
const TXOBJ_DIFB_TS          = 250;
const TXOBJ_MAINS_TS         = 260;
const TXOBJ_MAINS_TS_0       = 265;
const TXOBJ_NKDS_TS          = 270;
const TXOBJ_COMS_TS          = 280;
const TXOBJ_COMS_TS_0        = 285;
const TXOBJ_DIFS_TS          = 290;
const TXOBJ_DISCB            = 300;
const TXOBJ_DISCS            = 310;
const TXOBJ_DISCS_0          = 315;
const TXOBJ_DISCOUNT_LINK    = 320;
const TXOBJ_PROCFACT         = 330; 
const TXOBJ_COST             = 340;
const TXOBJ_PROCNORM         = 350;
const TXOBJ_PROCSEC_Link     = 360;
const TXOBJ_PROCSEC_TS       = 370;
const TXOBJ_PROCSEC_TS_35    = 375;
const TXOBJ_FR_LINK          = 380;
const TXOBJ_TAX_LINK         = 385; // ФР  по связи, включаемый в НОБ
const TXOBJ_TAX_LINK_0       = 386; // ФР по связи, не включаемый в НОБ
const TXOBJ_FR_TS            = 390;
const TXOBJ_PROCREPOTAX      = 400;
const TXOBJ_PLUSI            = 402;
const TXOBJ_FR_SEC_3Y        = 407; // Финансовый результат по ц/б в собственности более 3-х лет
const TXOBJ_FR_SEC           = 410;
const TXOBJ_EXP_SEC          = 420;
const TXOBJ_PROC_SEC         = 430;
const TXOBJ_PROC_SEC_SHORT   = 435;
const TXOBJ_MATERIAL_SEC     = 450;
const TXOBJ_MINUS_SEC        = 460;
const TXOBJ_MINUS_SEC_SHORT  = 461;
const TXOBJ_PLUS_SEC         = 470;
const TXOBJ_PLUS_SEC_SHORT   = 471;
const TXOBJ_DIV_SEC          = 480;
const TXOBJ_DIVPAY_SEC       = 490;
const TXOBJ_OTHER_SEC        = 510;
const TXOBJ_GENERAL          = 520;
const TXOBJ_GENERAL_IIS      = 525;
const TXOBJ_PREVIOUSYEAR     = 530;
const TXOBJ_PLUS_SEC0        = 535; // Доходы, не включаемые в НОБ
const TXOBJ_MINUS_SEC0       = 536; // Расходы, не включаемые в НОБ
const TXOBJ_DIVPAY_SEC_0     = 537; // Уплаченный налог на дивиденды покупателем 1 ч. РЕПО
const TXOBJ_EXP_GROUP        = 540;
const TXOBJ_COUP0_GROUP      = 550;
const TXOBJ_PLUS9_1110       = 560;
const TXOBJ_PLUS9_1110_IIS   = 565;
const TXOBJ_PLUSG_1110       = 570;
const TXOBJ_PLUSG_1010       = 580;
const TXOBJ_PLUS15_1010      = 590;
const TXOBJ_PLUSG_1011       = 600;
const TXOBJ_PLUSG_1011_1     = 601;
const TXOBJ_PLUSG_1011_2     = 602;
const TXOBJ_PLUSG_1011_1_IIS = 603;
const TXOBJ_PLUSG_1011_2_IIS = 604;
const TXOBJ_PLUSG_1011_IIS   = 605;
const TXOBJ_PLUSG_1011_3     = 606;
const TXOBJ_PLUSG_1011_3_IIS = 607;
const TXOBJ_PLUSG_3023       = 608;
const TXOBJ_PLUSG_3023_IIS   = 609;
const TXOBJ_PLUSG_1530       = 610;
const TXOBJ_PLUSG_1544       = 615;
const TXOBJ_PLUSG_1531       = 620;
const TXOBJ_PLUSG_1533       = 625;
const TXOBJ_PLUSG_1547       = 626;
const TXOBJ_PLUSG_1545       = 623;
const TXOBJ_PLUSG_1536       = 630;
const TXOBJ_PLUSG_1537       = 631;
const TXOBJ_PLUSG_1539       = 632;
const TXOBJ_PLUSG_1549       = 633;
const TXOBJ_PLUSG_1551       = 634;
const TXOBJ_PLUSG_1553       = 635;
const TXOBJ_PLUS35_3023      = 636;
const TXOBJ_PLUSG_1532       = 640;
const TXOBJ_PLUSG_1546       = 645;
const TXOBJ_PLUSG_1535       = 650;
const TXOBJ_PLUSG_1548       = 655;
const TXOBJ_PLUSG_2640       = 660;
const TXOBJ_PLUSG_2640_IIS   = 665;
const TXOBJ_PLUSG_2641       = 670;
const TXOBJ_PLUSG_2641_IIS   = 671;
const TXOBJ_MINUSG_601       = 680;
const TXOBJ_MINUS15_601      = 690;
const TXOBJ_MINUSG_201       = 700;
const TXOBJ_MINUSG_225       = 705;
const TXOBJ_MINUSG_202       = 710;
const TXOBJ_MINUSG_226       = 715;
const TXOBJ_MINUSG_203       = 720;
const TXOBJ_MINUSG_227       = 725;
const TXOBJ_MINUSG_206       = 730;
const TXOBJ_MINUSG_228       = 735;
const TXOBJ_MINUSG_229       = 739;
const TXOBJ_MINUSG_207       = 740;
const TXOBJ_MINUSG_211       = 741;
const TXOBJ_MINUSG_212       = 742;
const TXOBJ_MINUSG_213       = 743;
const TXOBJ_MINUSG_214       = 744;
const TXOBJ_MINUSG_620_3     = 745;
const TXOBJ_MINUSG_620_2     = 746;
const TXOBJ_MINUSG_230       = 747;
const TXOBJ_MINUSG_231       = 748;
const TXOBJ_MINUSG_214_IIS   = 749;
const TXOBJ_FULLMINUS_201    = 750;
const TXOBJ_FULLMINUS_225    = 755;
const TXOBJ_FULLMINUS_203    = 760;
const TXOBJ_FULLMINUS_227    = 765;
const TXOBJ_FULLMINUS_206    = 770;
const TXOBJ_FULLMINUS_228    = 775;
const TXOBJ_FULLMINUS_207    = 780;
const TXOBJ_FULLMINUS_229    = 781;
const TXOBJ_FULLMINUS_618    = 785; // Полный инвестиционный вычет по ц/б в собственности более 3-х лет
const TXOBJ_MINUSG_204       = 790;
const TXOBJ_MINUSG_205       = 800;
const TXOBJ_MINUSG_250       = 805;
const TXOBJ_MINUSG_208       = 810;
const TXOBJ_MINUSG_251       = 815;
const TXOBJ_MINUSG_209       = 820;
const TXOBJ_MINUSG_210       = 821;
const TXOBJ_MINUSG_620_1     = 822;
const TXOBJ_MINUSG_252       = 823;
const TXOBJ_MINUSG_241       = 824;
const TXOBJ_MINUSG_224       = 825;
const TXOBJ_MINUSG_236       = 826;
const TXOBJ_LIMIT_618        = 827; // Предельное значение инвестиционного вычета по ц/б в собственности более 3-х лет
const TXOBJ_MINUSG_618       = 829; // Инвестиционный вычет по ц/б в собственности более 3-х лет
const TXOBJ_BASEMATERIAL     = 830;
const TXOBJ_BASEMATERIAL_IIS = 835;
const TXOBJ_BASEGENERAL      = 840;
const TXOBJ_BASEGENERAL_IIS  = 845;
const TXOBJ_BASESPECIAL      = 850;
const TXOBJ_BASESPECIAL_IIS  = 855;
const TXOBJ_BASE_35          = 856;
const TXOBJ_BASESPECIAL_DIV  = 851;
const TXOBJ_PAIDMATERIAL     = 860;
const TXOBJ_PAIDMATERIAL_IIS = 865;
const TXOBJ_PAIDGENERAL      = 870;
const TXOBJ_PAIDGENERAL_IIS  = 875;
const TXOBJ_PAIDSPECIAL      = 880;
const TXOBJ_PAID_35          = 881;
const TXOBJ_PAIDSPECIAL_IIS  = 885;
const TXOBJ_TAXPM            = 890;
const TXOBJ_MAINB_SHORT      = 900;
const TXOBJ_NKDB_SHORT       = 910;
const TXOBJ_COMB_SHORT       = 920;
const TXOBJ_MATERIALB_SHORT  = 930;
const TXOBJ_TAXPM_LINK_SHORT = 940;
const TXOBJ_DIFB_SHORT       = 950;
const TXOBJ_MAINS_SHORT      = 960;
const TXOBJ_NKDS_SHORT       = 970;
const TXOBJ_COMS_SHORT       = 980;
const TXOBJ_DIFS_SHORT       = 990;
const TXOBJ_MINUSG_222       = 1000;
const TXOBJ_MINUSG_239       = 1005;
const TXOBJ_MINUSG_223       = 1010;
const TXOBJ_MINUSG_240       = 1015;
const TXOBJ_MINUSG_218       = 1020;
const TXOBJ_MINUSG_233       = 1025;
const TXOBJ_MINUSG_219       = 1030;
const TXOBJ_MINUSG_234       = 1035;
const TXOBJ_MINUS9_218       = 1040;
const TXOBJ_MINUS9_233       = 1045;
const TXOBJ_MINUS9_219       = 1050;
const TXOBJ_MINUS9_234       = 1055;
const TXOBJ_MINUSG_218_1     = 1060;
const TXOBJ_MINUSG_219_1     = 1070;
const TXOBJ_MINUSG_220       = 1080;
const TXOBJ_MINUSG_235       = 1085;
const TXOBJ_FULLMINUS_221    = 1090;
const TXOBJ_FULLPLUS_1543    = 1100;
const TXOBJ_MINUSG_619       = 1110;
const TXOBJ_DUETAX           = 1111;
const TXOBJ_NKDB_TS          = 1115;
const TXOBJ_FR_TS_0          = 1120;
const TXOBJ_PROCBILL         = 1140; // Процентно-дисконтные доходы по векселям
const TXOBJ_PLUSG_2800	     = 1141; // Проценты (дисконт), полученные при оплате предъявленного к платежу векселя
const TXOBJ_BASEBILL         = 1142; // Налоговая база по векселям
const TXOBJ_PAIDBILL         = 1143; // Сумма удержанного налога по каждой проводке
const TXOBJ_PAIDGENERAL_0    = 1144; // Уплаченный налог по общей ставке по купону с покупателя 1 ч. РЕПО
const TXOBJ_PAIDSPECIAL_0    = 1145; // Уплаченный налог по ставке 9 (15)% по купону с покупателя 1 ч. РЕПО
const TXOBJ_PAID35_0         = 1146; // Уплаченный налог по ставке 35 % для резидентов по купону с покупателя 1 ч. РЕПО
const TXOBJ_PAIDGENERAL_15     = 1150;
const TXOBJ_PAIDGENERAL_15_IIS = 1151;
const TXOBJ_BASEG1           = 1152;
const TXOBJ_BASEG2           = 1153;
const TXOBJ_BASEG3           = 1154;
const TXOBJ_BASEG4           = 1155;
const TXOBJ_BASEG5           = 1156;
const TXOBJ_BASEG6           = 1157;
const TXOBJ_BASEG7           = 1158;
const TXOBJ_BASEG8           = 1159;
const TXOBJ_BASEG9           = 1160;
const TXOBJ_PAIDGENERAL_15_1 = 1161;
const TXOBJ_PAIDGENERAL_15_2 = 1162;
const TXOBJ_PAIDGENERAL_15_9 = 1163;
const TXOBJ_PAIDGENERAL_15_1_0 = 1164;
const TXOBJ_BASESPECIAL_DIV_15 = 1165;
const TXOBJ_BASEG1_13          = 1166;
const TXOBJ_BASEG1_15          = 1167;
const TXOBJ_PLUSG_4800         = 1170;
const TXOBJ_PAIDCOMP           = 1171;
const TXOBJ_PAIDCOMP_15        = 1172;
const TXOBJ_FULLMINUS_233      = 1173;
const TXOBJ_FULLMINUS_239      = 1174;
const TXOBJ_FULLMINUS_226      = 1175;
const TXOBJ_FULLMINUS_234      = 1176;
const TXOBJ_FULLMINUS_240      = 1177;
const TXOBJ_FULLMINUS_236      = 1178;
const TXOBJ_FULLMINUS_235      = 1179;
const TXOBJ_FULLMINUS_230      = 1180;
const TXOBJ_FULLMINUS_231      = 1181;
const TXOBJ_PAIDGENERAL_18_9   = 1182;
const TXOBJ_PAIDGENERAL_20_9   = 1183;
const TXOBJ_PAIDGENERAL_22_9   = 1184;
const TXOBJ_PROCSEC_CHANGE     = 1185;
const TXOBJ_MINUSG_517         = 1186;
const TXOBJ_FULLMINUS_517      = 1187;
const TXOBJ_LIMIT_517          = 1188;
const TXOBJ_DUEMATERIAL        = 1189;
const TBOBJ_BASECOMP           = 1190;
//!!!При добавлении новых видов объектов НДР добавлять также и в RSI_NPTXC


//Константы видов аналитик объектов НДР
const TXOBJ_KIND1010 = 1010; // Сделка
const TXOBJ_KIND1020 = 1020; // Погашение
const TXOBJ_KIND1030 = 1030; // Конвертация
const TXOBJ_KIND1040 = 1040; // Расчет по ПИ
const TXOBJ_KIND1050 = 1050; // Номер купона
const TXOBJ_KIND1060 = 1060; // Номер ЧП
const TXOBJ_KIND1070 = 1070; // Зачисление/списание
const TXOBJ_KIND1080 = 1080; // Виртуальная        
const TXOBJ_KIND1090 = 1090; // Сделка ПИ
const TXOBJ_KIND1095 = 1095; // Купон в депозитарии
const TXOBJ_KIND1098 = 1098; // Дивиденды
const TXOBJ_KIND1100 = 1100; // Возврат дивидендов
const TXOBJ_KIND1110 = 1110; // Биржевая сделка ПИ
const TXOBJ_KIND1115 = 1115; // Выкуп собственных векселей банка
const TXOBJ_KIND1120 = 1120; // Мена собственных векселей банка
const TXOBJ_KIND1125 = 1125; // Зачет взаимных требований
const TXOBJ_KIND1130 = 1130; // Погашение векселя
const TXOBJ_KIND1135 = 1135; // Соглашение об урегулировании претензий
const TXOBJ_KIND2010 = 2010; // Связь
const TXOBJ_KIND2020 = 2020; // ТС
const TXOBJ_KIND2030 = 2030; // Номер купона
const TXOBJ_KIND2040 = 2040; // КБК
const TXOBJ_KIND3010 = 3010; // ЦБ
const TXOBJ_KIND3020 = 3020; // ПИ
const TXOBJ_KIND4010 = 4010; // Категория ФИ
const TXOBJ_KIND5010 = 5010; // Налоговая группа
const TXOBJ_KIND6010 = 6010; // Договор ДУ
const TXOBJ_KIND6020 = 6020; // Договор обслуживания
const TXOBJ_KIND6030 = 6030; // Закрытие последнего ДБО

//Константы уровней аналитик
const TXOBJ_LEVEL1 = "1"; 
const TXOBJ_LEVEL2 = "2"; 
const TXOBJ_LEVEL3 = "3"; 
const TXOBJ_LEVEL4 = "4"; 
const TXOBJ_LEVEL5 = "5"; 
const TXOBJ_LEVEL6 = "6"; 
const TXOBJ_LEVEL7 = "7"; 
const TXOBJ_LEVEL8 = "8"; 

//Константы направлений
const TXOBJ_DIR_ALL = 0; // Не задано
const TXOBJ_DIR_IN  = 1; // Доход 
const TXOBJ_DIR_OUT = 2; // Расход

//Константы видов лотов
const NPTXLOTS_UNDEF     = 0; // не определено
const NPTXLOTS_BUY       = 1; // Покупка
const NPTXLOTS_SALE      = 2; // Продажа
const NPTXLOTS_REPO      = 3; // Репо прямое
const NPTXLOTS_BACKREPO  = 4; // Репо обратное
const NPTXLOTS_LOANPUT   = 5; // Займ размещение
const NPTXLOTS_LOANGET   = 6; // Займ привлечение

//Константы типов лотов
const NPTXDEAL_UNDEF     = 0; // не определено
const NPTXDEAL_REAL      = 1; // Реальная сделка
const NPTXDEAL_MARKET    = 2; // Виртуальная рыночного типа
const NPTXDEAL_CALC      = 3; // Виртуальная расчетная сделка
const NPTXDEAL_COMP      = 4; // Посткомпенсационный лот
                        
//Константы типов проис хождения лотов
const NPTXLOTORIGIN_DEAL = 0; // Сделка
const NPTXLOTORIGIN_GO   = 1; // ГО: Глобальная конвертация
const NPTXLOTORIGIN_IN   = 2; // ИН: Изменение номинала

//Константы типов связей
const NPTXLNK_UNDEF      = 0; // не определено
const NPTXLNK_DELIVER    = 1; // Поставка
const NPTXLNK_REPO       = 2; // Прямое Репо
const NPTXLNK_SUBSTREPO  = 3; // Подстановка Репо
const NPTXLNK_OPPOS      = 4; // Открытие короткой позиции
const NPTXLNK_CLPOS      = 5; // Закрытие короткой позиции

//Константы типов записей ТС
const NPTXTS_UNDEF       = 0; // не определено
const NPTXTS_REST        = 1; // Остатки         
const NPTXTS_INVST       = 2; // Размещения      
const NPTXTS_SHPOS       = 3; // Короткая позиция

//Константы видов периода
const NPTXCALC_UNDEF     = 0; // не определено
const NPTXCALC_CALCLINKS = 1; // Расчет связей         
const NPTXCALC_CALCNDFL  = 2; // Расчет НДФЛ
const NPTXCALC_CLOSE     = 3; // Закрытие
const NPTXCALC_CALCLUCRE = 4; // Расчет матвыгоды

//Резидентность субъектов
const NPTXPARTY_UNDEF       = 0; //не определено
const NPTXPARTY_RESIDENT    = 1; //для резидентов
const NPTXPARTY_NOTRESIDENT = 2; //для нерезидентов

//Ставки налогооблажения для инвесторов
const NPTXGENTAXRATE_RESIDENT    = 0.13; //для резидентов
const NPTXGENTAXRATE_RESIDENT_15 = 0.15; //для резидентов повышенная
const NPTXGENTAXRATE_NOTRESIDENT = 0.30; //для нерезидентов
const NPTXGENTAXRATE_RESIDENT_18 = 0.18; //для резидентов повышенная
const NPTXGENTAXRATE_RESIDENT_20 = 0.20; //для резидентов повышенная
const NPTXGENTAXRATE_RESIDENT_22 = 0.22; //для резидентов повышенная

//Очередность удержания налога с клиента
const NPTXPRIORITYTAX_UNDEF      = 0; //не определено
const NPTXPRIORITYTAX_FIRST915   = 1; //Сначала по ставке 9 (15) %
const NPTXPRIORITYTAX_FIRSTTOTAL = 2; //Сначала по общей ставке

//Константы видов обращаемости бумаги
const NPTX_FI_CIRCULATE     = 1; // Обращается
const NPTX_FI_NOCIRCULATE   = 2; // Не обращается
const NPTX_FI_LOSTCIRCULATE = 3; // Потеряла обращаемость

//Константы групп НУ
const TXGROUP_10    = 10; // Акции 
const TXGROUP_20    = 20; // Облигации обыкновенные
const TXGROUP_30    = 30; // Облигации с ипотечным покрытием (ставка 9%)
const TXGROUP_40    = 40; // Облигации льготные (ставка 0% по ПКД) 
const TXGROUP_50    = 50; // Облигации льготные (ставка 0% по погашению и ПКД)
const TXGROUP_60    = 60; // Векселя
const TXGROUP_70    = 70; // Сертификаты
const TXGROUP_80    = 80; // ФИСС фондовые
const TXGROUP_90    = 90; // ФИСС не фондовые
const TXGROUP_100   = 100; // Клиринговые сертификаты участия

CLASS TInsertTaxObject()
  var m_TaxObjectsArr = TArray();

  macro Clear()
    m_TaxObjectsArr.size = 0;
  end;

  macro IsEmpty(): bool
    return 0 == m_TaxObjectsArr.size;
  end;

  macro Add(FunctionKind,
            Date, 
            Client,
            Direction,
            Level, 
            User,
            Kind,
            Sum,
            Cur,
            AnaliticKind1,
            Analitic1,
            AnaliticKind2,
            Analitic2,
            AnaliticKind3,
            Analitic3,
            AnaliticKind4,
            Analitic4,
            AnaliticKind5,
            Analitic5,
            AnaliticKind6,
            Analitic6,
            Comment,
            DocID,
            Step,
            SumReestr,
            Technical,
            FromOutSyst,
            OutSystCode,
            OutObjID,
            TransfDate,
            TransfKind,
            ChangeCode
            )

    var nptxobj = TRecHandler("nptxobj.tmp");

      nptxobj.Clear();

      nptxobj.rec.ID            = 0;
      nptxobj.rec.FUNCTIONKIND  = FunctionKind;
      nptxobj.rec.DATE          = Date;           
      nptxobj.rec.CLIENT        = Client;         
      nptxobj.rec.DIRECTION     = Direction;      
      nptxobj.rec.LEVEL         = Level;          
      nptxobj.rec.USER          = User;           
      nptxobj.rec.KIND          = Kind;           
      nptxobj.rec.SUM           = Sum;            
      nptxobj.rec.CUR           = Cur;            
      nptxobj.rec.ANALITICKIND1 = AnaliticKind1;  
      nptxobj.rec.ANALITIC1     = Analitic1;      
      nptxobj.rec.ANALITICKIND2 = AnaliticKind2;  
      nptxobj.rec.ANALITIC2     = Analitic2;      
      nptxobj.rec.ANALITICKIND3 = AnaliticKind3;  
      nptxobj.rec.ANALITIC3     = Analitic3;      
      nptxobj.rec.ANALITICKIND4 = AnaliticKind4;  
      nptxobj.rec.ANALITIC4     = Analitic4;      
      nptxobj.rec.ANALITICKIND5 = AnaliticKind5;
      nptxobj.rec.ANALITIC5     = Analitic5;      
      nptxobj.rec.ANALITICKIND6 = AnaliticKind6;  
      nptxobj.rec.ANALITIC6     = Analitic6;      
      nptxobj.rec.COMMENT       = Comment;        
      nptxobj.rec.DOCID         = DocID;          
      nptxobj.rec.STEP          = Step;
      nptxobj.rec.ReestrSum     = SumReestr;

      nptxobj.rec.Technical = UNSET_CHAR;
      if(Technical != NULL)
        nptxobj.rec.Technical = Technical;
      end;
      
      nptxobj.rec.FromOutSyst   = UNSET_CHAR;
      if(FromOutSyst != NULL)
        nptxobj.rec.FromOutSyst = FromOutSyst;
      end;

      nptxobj.rec.OutSystCode   = "";
      if(OutSystCode != NULL)
        nptxobj.rec.OutSystCode = OutSystCode;
      end;
      
      nptxobj.rec.OutObjID      = "";
      if(OutObjID != NULL)
        nptxobj.rec.OutObjID = OutObjID;
      end;

      nptxobj.rec.TransfDate      = ZeroDate;
      if(TransfDate != NULL)
        nptxobj.rec.TransfDate = TransfDate;
      end;

      nptxobj.rec.TransfKind      = 0;
      if(TransfKind != NULL)
        nptxobj.rec.TransfKind = TransfKind;
      end;

      nptxobj.rec.ChangeCode     = UNSET_CHAR;
      if(ChangeCode != NULL)
        nptxobj.rec.ChangeCode = ChangeCode;
      end;

      m_TaxObjectsArr[m_TaxObjectsArr.size] = nptxobj;

      if(m_TaxObjectsArr.size >= 500)
        this.Save();
      end;
  end;

  macro Save()
    var nptxobjCache = RsbSQLInsert("nptxobj.tmp");

    nptxobjCache.AddRecordArray(m_TaxObjectsArr);
          
    nptxobjCache.Insert();

    Clear();      
  end;

  Clear();

END;


macro ПолучитьСписокЗначенийПримечанияЗаПериодПоКлиенту(clientID, noteKind, DateFrom, DateTo, NoteValArr:@TArray)
  //включая значение, действующее на начало периода просмотра
  var notetext:TBFile = TBFile("notetext.dbt", "R", 5);/*по автоинкременту*/  
  var _Party = TRecHandler("party.dbt");  
  
  var stat = 0;
  var strSql : string;
  var rs : RsdRecordset;
  if( not ПолучитьСубъекта(clientID, _Party) )
    
    /* все значения, введённые в просматриваемый период*/
    strSql = "SELECT t1.t_ID, t1.t_Date t_Date FROM dnotetext_dbt t1 " + 
             " WHERE t1.t_ObjectType = 3 "        + 
             "   AND t1.t_DocumentID = '" + UniID(_Party, OBJTYPE_PARTY) + "' " + 
             "   AND t1.t_NoteKind = ? "          +
             "   AND t1.t_Date >= ? "             + //DateFrom
             "   AND t1.t_Date <= ? "             + //DateTo             
             
             " UNION " +
    /* а так же, введённые до периода, но действующие в нём*/         
             "SELECT t2.t_ID, t2.t_Date t_Date FROM dnotetext_dbt t2 " + 
             " WHERE t2.t_ObjectType = 3 "   + 
             "   AND t2.t_DocumentID = '" + UniID(_Party, OBJTYPE_PARTY) + "' " + 
             "   AND t2.t_NoteKind = ? "     +
             "   AND t2.t_Date <= ? "        + //DateFrom
             "   AND t2.t_ValidToDate >= ? " + //DateFrom             
             " ORDER BY t_Date DESC ";
    var cmd = RsdCommand(strSql);
    cmd.addParam( "", RSDBP_IN, noteKind );
    cmd.addParam( "", RSDBP_IN, DateFrom );
    cmd.addParam( "", RSDBP_IN, DateTo );
    cmd.addParam( "", RSDBP_IN, noteKind );
    cmd.addParam( "", RSDBP_IN, DateFrom );
    cmd.addParam( "", RSDBP_IN, DateFrom );    
             
    rs = RsdRecordset(cmd);
    stat = -1;
    while(rs.MoveNext())
      ClearRecord(notetext);
      notetext.rec.ID = rs.value(0);
    
      if(getEQ(notetext))
        /*значения примечания могут повторяться. добавляем только уникальные*/
        var noteVal = GetNoteValue(notetext);
        var AlreadyExists; AlreadyExists = false;        
        var index; index = 0;
        while ( index < NoteValArr.size )
          if ( /*(NoteValArr[index] != NULL ) and */(  NoteValArr[index] == noteVal ) )
            AlreadyExists = true;
          end;
          index = index + 1;
        end;
        if (not AlreadyExists)
          NoteValArr[NoteValArr.size] = GetNoteValue(notetext);
        end;
        stat = 0;
      else
        stat = 1;
      end;
    end;
  else
    stat = 1;
  end;
  return stat;          
end;


/**/
macro ПолучитьЗначениеПримечанияНаДату(clientID, noteKind, date, noteVal:@variant)
  
  var notetext:TBFile = TBFile("notetext.dbt", "R", 5);/*по автоинкременту*/  
  var _Party = TRecHandler("party.dbt");  
  
  var retval = "";
  var stat = 0;
  var strSql : string;
  var rs : RsdRecordset;

  if( not ПолучитьСубъекта(clientID, _Party) )
    
    strSql = "SELECT t_ID FROM dnotetext_dbt " + 
             " WHERE t_ObjectType = " + OBJTYPE_PARTY +
             "   AND t_DocumentID = ? " + 
             "   AND t_NoteKind = ? " +
             "   AND t_Date <= ? " + 
             "   AND t_ValidToDate >= ? " +
             " ORDER BY t_Date DESC ";
    var cmd = RsdCommand(strSql);
    cmd.addParam( "", RSDBP_IN, UniID(_Party, OBJTYPE_PARTY) );
    cmd.addParam( "", RSDBP_IN, noteKind );
    cmd.addParam( "", RSDBP_IN, date );
    cmd.addParam( "", RSDBP_IN, date );
             
    rs = RsdRecordset(cmd);
    stat = -1;
    if(rs.MoveNext())
      ClearRecord(notetext);
      notetext.rec.ID = rs.value(0);
    
      if(getEQ(notetext))
        retval = GetNoteValue(notetext);
        stat = 0;
      else
        stat = 1;
      end;
    end;
    
    noteVal = retval;
  else
    stat = 1;
  end;
  return stat;      
end;

//получить общую ставку налога для субъекта
MACRO DL_GetClientTaxRateGeneral(ClientID, onDate)
  var party = TBFile("party.dbt");
  var NumInList = "";
  var TaxRate = NPTXGENTAXRATE_RESIDENT; //для резидента (по умолчанию)

  party.rec.PartyID = ClientID;

  if( GetMainObjAttr( null, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), 42/*Является плательщиком НДФЛ*/, null, null, NumInList))
    if(NumInList == "1")
      TaxRate = NPTXGENTAXRATE_RESIDENT; //для резидента
    elif(NumInList == "2")

      
      
      if (onDate != NULL)
        if  ( (ПолучитьЗначениеПримечанияНаДату(ClientID, PARTY_NOTE_KIND_NPTX_RATE_NOTRES, onDate, @TaxRate) ) != 0 )
          TaxRate = NPTXGENTAXRATE_NOTRESIDENT; //для нерезидента      
        else 
          TaxRate = TaxRate / 100;//ПолучитьЗначениеПримечанияНаДату вернёт кол-во процентов, а DL_GetClientTaxRateGeneral должна вернуть коэффициент от единицы
        end;
      else
        TaxRate = NPTXGENTAXRATE_NOTRESIDENT;
      end;

    
      
    else
      TaxRate = 0.0;
    end;
  else
    //считается резидентом    
  end;

  return TaxRate;
END;

//получить сумму по всем объектам НДР сделки заданного вида на дату
//ObjID - ID-шник объекта, по которому получить сумму. Например, DealID или FIID.
//StrLevel - номер уровня аналитики - строка
//AnaliticKind - вид аналитики. 
//StrKind - строка видов объектов НДР. 
//          Например, если 2 вида, то передать string(TXOBJ_MAIN) + ", " + string(TXOBJ_NKD). 
//          Для одного вида будет например string(TXOBJ_MAIN).
//MinDate - дата "начиная с", включительно. Если null - не проверять этот параметр.
//MaxDate - дата "по"       , включительно. Если null - не проверять этот параметр.
//Direction - направление. Если null - не проверять этот параметр.
//SumVal - возвращаемая сумма в валюте
//SumRub - возвращаемая сумма в рублях
//vCount - возвращаемое кол-во объектов
//ClientID - клиент
//ArrayOfKinds - массив с видами аналитик - проверяются его элементы с 1 до 6
//ArrayOfValues - массив со значениями аналитик - проверяются его элементы с 1 до 6
//OperDocKind - вид операции, в которой создан объект (если равно 0, то значит отбираем только пользовательские). NULL для игнорирования
//OperPrevDate - начальная дата налгового года (только если OperDocKind задан)
//FromDepo - только объекты, созданные в операции "Расчет и начисление дохода" в депозитарии
//IIS
//NoRound
//ToFIIDConv
//AddWhereCond - дополнительные условия
//FromVeksel - объекты созданные оп операциям Выкупа,Погашения,Мены и зачёта взаимных требований из ПС "Векселя Банка"
//PartyNoteKind      - вид примечания     , использующийся при создании НДР
//PartyNoteVal       - значение примечания, использующеяся при создании НДР
//PartyNoteDisable   - Признак отсутствия PartyNoteKind в период между MinDate, MaxDate
MACRO DL_GetNPTXOBJSum(ObjID:integer, 
                       StrLevel:string, 
                       AnaliticKind:integer, 
                       StrKind:string, 
                       MinDate:date, 
                       MaxDate:date, 
                       Direction:integer, 
                       SumVal:@variant, 
                       SumRub:@variant,
                       vCount:@variant,
                       ClientID:integer,
                       ArrayOfKinds:TArray,
                       ArrayOfValues:TArray,
                       OperID:integer,
                       OperDocKind:integer,
                       OperPrevDate:date,
                       FromDepo:bool, 
                       IIS:integer,
                       NoRound:bool,
                       ToFIIDConv:integer,
                       AddWhereCond:string,
                       FromVeksel:bool,
                       VekselOperDocKindStr:string,
                       PartyNoteKind:integer,
                       PartyNoteVal:variant,
                       PartyNoteDisable:bool,
                       NotRoundPaid:bool, //для 1011, 2800
                       Rate: integer,
                       ExcludeTechnical:bool
                      )
   var Query, sql, rsd, i = 1;

   SumVal = 0;
   SumRub = 0;
   vCount = 0;
   var IsNotRoundPaid = false;

   if( (NotRoundPaid != NULL) AND (NotRoundPaid == true) AND (Rate!=NULL) AND (Rate != 0))
     IsNotRoundPaid = true;
   end;

   if(IsNotRoundPaid)
      // ToFIIDConv == NULL (вызываем в отчете 2НДФЛ, для LoadPSnnnLoadPSnnn ToFIIDConv == NULL)
      Query = " select NVL ( SUM (  ROUND ( (ROUND ( (obj.t_Sum * " + Rate + " )/100, 0) * 100) / " + Rate + " , 2)  ), 0) as S ";
   
      Query = Query + ", NVL ( SUM (  ROUND ( (ROUND ( (obj.t_Sum0 * " + Rate + " )/100, 0) * 100) / " + Rate + " , 2)  ), 0) as S0, count(1) as vCount "
              + "  from dnptxobj_dbt obj "                                                         
              + " where obj.t_Kind IN ( " + StrKind + " )";
   else
      if( (ToFIIDConv != NULL) and (ToFIIDConv != ALLFININSTR) )
         Query = " select NVL(sum(RSB_FIInstr.ConvSum(obj.t_Sum, obj.t_Cur, ?, obj.t_Date)),0) as S ";
      else
         Query = " select NVL(sum(obj.t_Sum),0) as S ";
      end;
   
      Query = Query + ", NVL(sum(obj.t_Sum0),0) as S0, count(1) as vCount "
              + "  from dnptxobj_dbt obj "                                                         
              + " where obj.t_Kind IN ( " + StrKind + " )";
   end;
   if((StrLevel != null) and (StrLevel != ""))
     if((AnaliticKind != null) and (AnaliticKind > 0))
       Query = Query + "   and obj.t_AnaliticKind" + StrLevel + " = ? ";
     end;
     if((ObjID != null) and (ObjID > 0))
       Query = Query + "   and obj.t_Analitic" + StrLevel + " = ? ";
     end;
   end;

   if ((MinDate != null) and (MinDate != Date (0,0,0)))
      Query = Query + "   and obj.t_Date >= ? ";
   end;

   if ((MaxDate != null) and (MaxDate != Date (0,0,0)))
      Query = Query + "   and obj.t_Date <= ? ";
   end;

   if ((Direction != null) and (Direction != TXOBJ_DIR_ALL))
      Query = Query + "   and obj.t_Direction = ? ";
   end;

   if( (ClientID != null) and (ClientID > 0))
      Query = Query + "   and obj.t_Client = ? ";

      if( IIS != null )      
        Query = Query + " AND RSI_NPTO.CheckObjIIS ( " + TXOBJ_KIND6020 + ", obj.t_Analitic6 )  = ? ";
      end;
   end;

   if ( (ArrayOfKinds  != null) and (ArrayOfKinds.size  != 0) and
        (ArrayOfValues != null) and (ArrayOfValues.size != 0)
      )
      while( i < 7 )

         if( (ArrayOfKinds(i)  != null) and (ArrayOfKinds(i)  > 0) and
             (ArrayOfValues(i) != null) and (ArrayOfValues(i) > 0)
           )
            Query = Query + "   and obj.t_AnaliticKind" + string(i) + " = " + string(ArrayOfKinds(i));
            Query = Query + "   and obj.t_Analitic" + string(i) + " = " + string(ArrayOfValues(i));
         end;

         i = i + 1;
      end;
   end;

   if( (OperID != null) and (OperID > 0))
      Query = Query + "   and Exists( select 1 "+
                      "                 from dnptxobdc_dbt odc "+
                      "                where odc.t_ObjID = obj.t_ObjID "+
                      "                  and odc.t_DocID = ? )";
   end;

   if(OperDocKind != null)
     if(OperDocKind == 0) //т.е. нужны пользовательские
       Query = Query + "   and obj.t_User = 'X'";
     else
       Query = Query + "   and obj.t_User <> 'X' ";
       if(OperDocKind == DL_RETIREMENT_OWN)
         Query = Query + " and obj.t_AnaliticKind1 = 1020 "
                       + " and exists( select 1 from ddl_tick_dbt dl_tick "
                       + "             where dl_tick.t_DealID = obj.t_Analitic1 "
                       + "               and dl_tick.t_BOfficeKind = ?";
       elif(OperDocKind == DL_NPTXSTBOP)
         Query = Query + " and Exists (select 1 "
                       + "               from dnptxobdc_dbt dc, doproper_dbt opr "
                       + "              where dc.t_ObjID = obj.t_ObjID "
                       + "                and opr.t_ID_Operation = dc.t_DocID "
                       + "                and opr.t_DocKind = " + DL_NPTXSTBOP
                       + "             ";
       else
         Query = Query + "   and Exists( select 1 from dnptxobdc_dbt odc, dnptxop_dbt txop "
                       + "                where odc.t_ObjID = obj.t_ObjID "
                       + "                  and txop.t_ID = odc.t_DocID "
                       + "                  and txop.t_DocKind = ? ";
       end;
       if ((OperDocKind == DL_HOLDNDFL) AND (MinDate != null) and (MinDate != Date (0,0,0)) AND ((IIS != null) AND (IIS == 0)))
          Query = Query + "               and EXTRACT( YEAR FROM txop.t_prevdate )=  EXTRACT (YEAR FROM ?) "
       end;
       if ((OperPrevDate != null) and (OperPrevDate != Date (0,0,0)))
          Query = Query + "               and txop.t_PrevDate = ? ";
       end;

       Query = Query + "             ) ";
     end;
   end;

   if(FromDepo == true)
     Query = Query + " and (Exists (select 1 "
                   + "               from dnptxobdc_dbt dc, doproper_dbt opr "
                   + "              where dc.t_ObjID = obj.t_ObjID "
                   + "                and opr.t_ID_Operation = dc.t_DocID "
                   + "                and opr.t_DocKind = " + SP_DEPOPER_DEPOACNT
                   + "            ) "
                   + " or  Exists (select 1 from DDPPMOBJ_DBT dp "
                   + "             where dp.t_objid = obj.t_ObjID "
                   + "                   and dp.t_objkind = "+OBJTYPE_NPTXOBJ+"))";
   end;
   
   if( ( FromVeksel!=NULL ) and ( FromVeksel == true ) )
     Query = Query + " and (Exists (select 1 "
                   + "               from dnptxobdc_dbt dc, doproper_dbt opr "
                   + "              where dc.t_ObjID = obj.t_ObjID "
                   + "                and opr.t_ID_Operation = dc.t_DocID "
                   + "                and opr.t_DocKind in ("+VekselOperDocKindStr+") "
                   + "            ) ) ";

   end;   

   if ( ( ClientID !=NULL ) and ( PartyNoteKind != NULL ) and ( PartyNoteVal != NULL ) and ( (PartyNoteDisable == NULL) or (PartyNoteDisable == false) ) )
     Query = Query + " and 1 = CASE WHEN rsi_rsb_kernel.getNote(3, rsb_rep_pt.makePartyId(?), ?, obj.t_Date ) IS NULL ";
     Query = Query + "              THEN 0 ";
     Query = Query + "              ELSE CASE WHEN ? = rep_utl.castRawToDouble ( rsi_rsb_kernel.getNote(3, rsb_rep_pt.makePartyId(?), ?, obj.t_Date ) ) ";
     Query = Query + "                        THEN 1 ";
     Query = Query + "                        ELSE 0 ";
     Query = Query + "                   END ";
     Query = Query + "         END ";
   end;
   
   if ( ( ClientID != NULL ) and ( PartyNoteKind != NULL ) and ( PartyNoteDisable != NULL ) and ( PartyNoteDisable == true )  )
     Query = Query + " and rsi_rsb_kernel.getNote(3,  "
                   + "                            rsb_rep_pt.makePartyId(?), "
                   + "                            ?, "
                   + "                            obj.t_Date ) is NULL";
   end;

   if(ExcludeTechnical)
      Query = Query + " and ((obj.t_Technical <> chr(88)) or (obj.t_Technical is null)) ";
   end;
   
   
   if( (AddWhereCond != null) and (ValType(AddWhereCond) == V_STRING) and (Trim(AddWhereCond) != "") )
      Query = Query + " and " + AddWhereCond;
   end;

   sql =  RsdCommand(Query);

   if( (ToFIIDConv != NULL) and (ToFIIDConv != ALLFININSTR) )
      sql.addParam("", RSDBP_IN, ToFIIDConv);
   end;

   if((StrLevel != null) and (StrLevel != ""))
     if((AnaliticKind != null) and (AnaliticKind != ""))
       sql.addParam( "", RSDBP_IN, AnaliticKind );
     end;
     if((ObjID != null) and (ObjID > 0))
       sql.addParam( "", RSDBP_IN, ObjID );
     end;
   end;

   if ((MinDate != null) and (MinDate != Date (0,0,0)))
      sql.addParam( "", RSDBP_IN, MinDate );
   end;

   if ((MaxDate != null) and (MaxDate != Date (0,0,0)))
      sql.addParam( "", RSDBP_IN, MaxDate );
   end;

   if ((Direction != null) and (Direction != TXOBJ_DIR_ALL))
      sql.addParam( "", RSDBP_IN, Direction );
   end;

   if( (ClientID != null) and (ClientID > 0))
      sql.addParam( "", RSDBP_IN, ClientID );
      if(IIS != null)
        sql.addParam( "", RSDBP_IN, IIS );
      end;                
   end;

   if( (OperID != null) and (OperID > 0))
      sql.addParam( "", RSDBP_IN, OperID );
   end;

   if((OperDocKind != null) and (OperDocKind != 0))
      sql.addParam( "", RSDBP_IN, OperDocKind );

      if ((OperDocKind == DL_HOLDNDFL) AND (MinDate != null) and (MinDate != Date (0,0,0)) AND ((IIS != null) AND (IIS == 0)))
        sql.addParam( "", RSDBP_IN, MinDate );
      end;
      if ((OperPrevDate != null) and (OperPrevDate != Date (0,0,0)))
        sql.addParam( "", RSDBP_IN, OperPrevDate );
      end;
   end;

   if ( ( ClientID !=NULL ) and ( PartyNoteKind != NULL ) and ( PartyNoteVal != NULL ) and ( (PartyNoteDisable == NULL) or (PartyNoteDisable == false) )  )     
     sql.addParam( "", RSDBP_IN, ClientID );
     sql.addParam( "", RSDBP_IN, PartyNoteKind );
     sql.addParam( "", RSDBP_IN, PartyNoteVal );
     sql.addParam( "", RSDBP_IN, ClientID );
     sql.addParam( "", RSDBP_IN, PartyNoteKind );
   end;

   if ( ( ClientID != NULL ) and ( PartyNoteKind != NULL ) and ( PartyNoteDisable != NULL ) and ( PartyNoteDisable == true )  )
     sql.addParam( "", RSDBP_IN, ClientID );
     sql.addParam( "", RSDBP_IN, PartyNoteKind );
   end;
   sql.execute();

   rsd = TRsbDataSet(sql);
   if(rsd.moveNext())
      if((ValType(NoRound) == V_BOOL) and (NoRound == true))
        SumVal = money(rsd.S);
        SumRub = money(rsd.S0);
      else
        SumVal = Round(money(rsd.S));
        SumRub = Round(money(rsd.S0));
      end;
      vCount = rsd.vCount;
   end;
END;


/**
  @brief Возвращает сумму объектов НДР заданного(ых) вида(ов), созданных по сделке
  @param [in] DealID идентификатор сделки
  @param [in] StrKind Строка с видами объектов НДР
  @param [in] MinDate Дата начала периода
  @param [in] MaxDate Дата окончания периода
  @param [in] Direcion Направление объекта НДР
  @param [out] SumVal Сумма в валюте
  @param [out] SumRub Сумма в рублях
  @param [out] vCount Количество объектов НДР
  @param [in] ClientID ID клиента
  @param [in] ToFIIDConv Валюта, в которую конвертируется сумма
  @param [in] ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ
*/
MACRO DL_GetNPTXOBJSumByDeal(DealID:integer, 
                             StrKind:string, 
                             MinDate:date, 
                             MaxDate:date, 
                             Direction:integer, 
                             SumVal:@variant, 
                             SumRub:@variant,
                             vCount:@variant,
                             ClientID:integer,
                             ToFIIDConv:integer,
                             ExcludeTechnical:bool
                            )
   var query, cmd, DataSet;
   var AnaliticKind1;

   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;

   AnaliticKind1 = TXOBJ_KIND1010;

   cmd = DL_RSDCommand();

   query = "select t_BOfficeKind from ddl_tick_dbt where t_DealID = " + cmd.AddParam(DealID);

   DataSet = cmd.Execute(query);
   if(DataSet.moveNext())
     if(DataSet.BOfficeKind == DL_AVRWRT)
       AnaliticKind1 = TXOBJ_KIND1070;
     end;
   end;

   DL_GetNPTXOBJSum(DealID, TXOBJ_LEVEL1, AnaliticKind1, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, ClientID, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ToFIIDConv, NULL, NULL, NULL, NULL,
                    NULL, NULL, NULL, NULL, ExcludeTechnical);
END;

/**
  @brief Возвращает сумму объектов НДР заданного(ых) вида(ов), созданных по ПИ
  @param [in] FiturnID идентификатор ПИ
  @param [in] StrKind Строка с видами объектов НДР
  @param [in] MinDate Дата начала периода
  @param [in] MaxDate Дата окончания периода
  @param [in] Direcion Направление объекта НДР
  @param [out] SumVal Сумма в валюте
  @param [out] SumRub Сумма в рублях
  @param [out] vCount Количество объектов НДР
  @param [in] ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ
*/
MACRO DL_GetNPTXOBJSumByFiTurn(FiturnID:integer, 
                               StrKind:string, 
                               MinDate:date, 
                               MaxDate:date, 
                               Direction:integer, 
                               SumVal:@variant, 
                               SumRub:@variant,
                               vCount:@variant,
                               ExcludeTechnical:bool
                              )
   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;
                              
   DL_GetNPTXOBJSum(FiturnID, TXOBJ_LEVEL1, TXOBJ_KIND1040, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,
                    NULL, NULL, NULL, ExcludeTechnical);
END;

/**
  @brief Возвращает сумму объектов НДР заданного(ых) вида(ов), созданных по сделке с ПИ
  @param [in] NDealID идентификатор сделки
  @param [in] StrKind Строка с видами объектов НДР
  @param [in] MinDate Дата начала периода
  @param [in] MaxDate Дата окончания периода
  @param [in] Direcion Направление объекта НДР
  @param [out] SumVal Сумма в валюте
  @param [out] SumRub Сумма в рублях
  @param [out] vCount Количество объектов НДР
  @param [in] ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ
*/
MACRO DL_GetNPTXOBJSumByNDeal( NDealID:integer,
                               StrKind:string,
                               MinDate:date,
                               MaxDate:date,
                               Direction:integer,
                               SumVal:@variant,
                               SumRub:@variant,
                               vCount:@variant,
                               ExcludeTechnical:bool
                             )
   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;

   DL_GetNPTXOBJSum(NDealID, TXOBJ_LEVEL1, TXOBJ_KIND1090, StrKind, MinDate, MaxDate, Direction, @SumVal, @SumRub, @vCount, NULL, NULL, NULL, NULL,
                    NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ExcludeTechnical);
END;

/**
 @brief Получить сумму объектов НДР с видом(ами) StrKind по связи LinkID
 @param [in] LinkID ID налоговой связи, указанной в аналитике 2
 @param [in] StrKind вид(ы) объекта(ов) НДР
 @param [in] MinDate Дата начала периода
 @param [in] MaxDate Дата окончания периода
 @param [in] Direction Направление
 @param [out] SumVal Сумма в валюте
 @param [out] SumRub Сумма в рублях
 @param [out] vCount Количество объектов НДР, по которым посчиталась сумма
 @param [in] NoRound Не округлять
 @param [in] AddWhereCond Добавочное условие отбора объектов НДР
 */
MACRO DL_GetNPTXOBJSumByLink(LinkID:integer, 
                             StrKind:string, 
                             MinDate:date, 
                             MaxDate:date, 
                             Direction:integer, 
                             SumVal:@variant, 
                             SumRub:@variant,
                             vCount:@variant,
                             NoRound:bool,
                             ExcludeTechnical:bool
                            )
   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;

   DL_GetNPTXOBJSum(LinkID, TXOBJ_LEVEL2, TXOBJ_KIND2010, StrKind, MinDate, MaxDate,
                    Direction, @SumVal, @SumRub, @vCount,
                    null, null, null, null,null, null, null, null, NoRound, null, null, null, null, null, null, null, null, null, ExcludeTechnical);
END;

/**
  @brief Получить сумму объектов НДР по клиенту
  @param [in] ClientID ID клиента
  @param [in] StrKind Строка с видами объектов НДР
  @param [in] MinDate Дата начала периода
  @param [in] MaxDate Дата окончания периода
  @param [in] Direcion Направление объекта НДР
  @param [out] SumVal Сумма в валюте
  @param [out] SumRub Сумма в рублях
  @param [out] vCount Количество объектов НДР
  @param [in] IIS Параметр "Расчет для ИИС" (0 или 1)
  @param [in] NoRound Не округлять суммы 
  @param [in] AddWhereCond Добавочное условие
  @param [in] NotRoundPaid Не округлять суммы
  @param [in] Rate Ставка налога
  @param [in] ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ
*/
MACRO DL_GetNPTXOBJSumByClient( ClientID:integer, 
                                StrKind:string, 
                                MinDate:date, 
                                MaxDate:date, 
                                Direction:integer, 
                                SumVal:@variant, 
                                SumRub:@variant,
                                vCount:@variant,
                                IIS:integer,
                                NoRound:bool,
                                AddWhereCond:string,
                                NotRoundPaid:bool,
                                Rate:integer,
                                ExcludeTechnical:bool
                              )

   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;

   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, ClientID,
                    null, null, null, null, null, null, IIS, NoRound, null, AddWhereCond, NULL, NULL, NULL, NULL, NULL, NotRoundPaid, Rate, ExcludeTechnical );
END;

//получить сумму объектов НДР по клиенту и группе НУ
MACRO DL_GetNPTXOBJSumByClientAndGroup( ClientID:integer, 
                                        TaxGroup:integer, 
                                        StrKind:string, 
                                        MinDate:date, 
                                        MaxDate:date, 
                                        Direction:integer, 
                                        SumVal:@variant, 
                                        SumRub:@variant,
                                        vCount:@variant,
                                        IIS:integer,
                                        AddWhereCond:string
                                      )

   DL_GetNPTXOBJSum(TaxGroup, TXOBJ_LEVEL5, TXOBJ_KIND5010, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, ClientID, null, null, null, 
                    null, null, null, IIS, null, null, AddWhereCond);
END;

/**
  @brief Получить сумму объектов НДР по клиенту
  @param [in] ClientID ID клиента
  @param [in] StrKind Строка с видами объектов НДР
  @param [in] MinDate Дата начала периода
  @param [in] MaxDate Дата окончания периода
  @param [in] Direcion Направление объекта НДР
  @param [in] OperDocKind Вид операции
  @param [in] OperPrevDate Дата предыдущей операции
  @param [out] SumVal Сумма в валюте
  @param [out] SumRub Сумма в рублях
  @param [out] vCount Количество объектов НДР
  @param [in] IIS Параметр "Расчет для ИИС" (0 или 1)
  @param [in] AddWhereCond Добавочное условие
  @param [in] ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ
*/
MACRO DL_GetNPTXOBJSumByClientAndDocKind( ClientID:integer, 
                                       StrKind:string, 
                                       MinDate:date, 
                                       MaxDate:date, 
                                       Direction:integer,
                                       OperDocKind:integer, 
                                       OperPrevDate:date,
                                       SumVal:@variant, 
                                       SumRub:@variant,
                                       vCount:@variant, 
                                       IIS:integer,
                                       AddWhereCond:string,
                                       ExcludeTechnical:bool
                                     )
   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;

   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, ClientID, NULL, NULL, NULL, OperDocKind, OperPrevDate, 
                    null, IIS, null, null, AddWhereCond, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ExcludeTechnical);
END;

//получить сумму объектов НДР по клиенту и по значению вида примечания в нём
MACRO DL_GetNPTXOBJSumByClientAndDocKindAndNoteKindAndNoteVal( ClientID:integer, 
                                       StrKind:string, 
                                       MinDate:date, 
                                       MaxDate:date, 
                                       Direction:integer,
                                       OperDocKind:integer, 
                                       OperPrevDate:date,
                                       SumVal:@variant, 
                                       SumRub:@variant,
                                       vCount:@variant, 
                                       IIS:integer, 
                                       PartyNoteKind:integer, 
                                       PartyNoteVal:variant,
                                       PartyNoteDisable:bool
                                     )
                                     
   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, ClientID, NULL, NULL, NULL, OperDocKind, OperPrevDate, 
                    null, IIS, null, null, null, null, null,
                    PartyNoteKind, PartyNoteVal, PartyNoteDisable);
END;

/**
  @brief Функция вычисления суммы объектов НДР по клиенту
  @param [in] ClientID Идентификатор клиента
  @param [in] StrKind Вид(ы) объекта(ов) НДР
  @param [in] MinDate Дата начала периода
  @param [in] MaxDate Дата окончания периода
  @param [in] Direction Направление объекта НДР
  @param [in] OperID ID операции
  @param [out] SumVal Сумма в валюте
  @param [out] SumRub Сумма в рублях
  @param [out] vCount Количество объектов НДР
  @param [in] IIS Параметр "Расчет для ИИС" из панели операции (0 или 1)
*/
MACRO GetRubSumByClient(ClientID:integer, StrKind:string, MinDate:date, MaxDate:date, Direction:integer, IIS:integer, NoRound:bool, AddWhereCond:string, ExcludeTechnical:bool)
   var SVal, SRub;

   DL_GetNPTXOBJSumByClient(ClientID, StrKind, MinDate, MaxDate, 
                            Direction, @SVal, @SRub, null, IIS, NoRound, AddWhereCond, NULL, NULL, ExcludeTechnical);
   return SRub;
END;

MACRO DL_GetNPTXOBJSumByClientAndOper(ClientID:integer, 
                                      StrKind:string, 
                                      MinDate:date, 
                                      MaxDate:date,
                                      Direction:integer,
                                      OperID:integer,
                                      SumVal:@variant, 
                                      SumRub:@variant,
                                      vCount:@variant,
                                      IIS:integer,
                                      AddWhereCond:string
                                     )

   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, 
                    Direction, @SumVal, @SumRub, @vCount, ClientID, null, null, OperID, NULL, NULL, NULL, IIS, null, null, AddWhereCond);
END;

/**
  @brief Получить рублёвую сумму объектов НДР по клиенту и виду документа
  @param ClientID Идентификатор клиента
  @param StrKind Строка с видом(ами) объектов НДР
  @param MinDate Дата начала периода
  @param MaxDate Дата окончания периода
  @param OperDocKind Вид документа
  @param OperPrevDate Дата предыдущей операции
  @param IIS Признак "Расчет для ИИС" из операции (0 или 1)
  @param AddWhereCond Добавочное условие
  @param ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ

  @return Рублёвая сумма объектов НДР
*/
MACRO GetRubSumByClientOperDocKind(ClientID:integer, StrKind:string, MinDate:date, MaxDate:date, OperDocKind:integer,
                                    OperPrevDate:date, IIS:integer, AddWhereCond:string, ExcludeTechnical:bool)
   var SVal, SRub;
   
   DL_GetNPTXOBJSumByClientAndDocKind(ClientID, StrKind, MinDate, MaxDate, null, OperDocKind, OperPrevDate,
                                      @SVal, @SRub, null, IIS, AddWhereCond, ExcludeTechnical);
   return SRub;
END;

MACRO GetRubSumByClientOperDocKindAndNotetextKindVal(ClientID:integer, StrKind:string, MinDate:date, MaxDate:date, OperDocKind:integer,
                                    OperPrevDate:date, IIS:integer, PartyNoteKind:integer, PartyNoteVal:variant, PartyNoteDisable:bool )
   var SVal, SRub;
   
   DL_GetNPTXOBJSumByClientAndDocKindAndNoteKindAndNoteVal(ClientID, StrKind, MinDate, MaxDate, null, OperDocKind, OperPrevDate,
                                      @SVal, @SRub, null, IIS, PartyNoteKind, PartyNoteVal, PartyNoteDisable);
   return SRub;
END;


MACRO GetRubSumByClientOper(ClientID:integer, StrKind:string, MinDate:date, MaxDate:date, OperDocKind:integer, OperID:integer,
                            OperPrevDate:date, IIS:integer, AddWhereCond:string, ExcludeTechnical:bool)
   var SVal, SRub, vCount;

   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;

   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, 
                    null, @SVal, @SRub, @vCount, ClientID, NULL, NULL, OperID, OperDocKind, OperPrevDate, 
                    null, IIS, null, null, AddWhereCond, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ExcludeTechnical);
   return SRub;
END;



/**
  @brief Получить рублёвую сумму объектов НДР по клиенту из депозитария
  @param ClientID Идентификатор клиента
  @param StrKind Строка с видом(ами) объектов НДР
  @param MinDate Дата начала периода
  @param MaxDate Дата окончания периода
  @param IIS Признак "Расчет для ИИС" из операции (0 или 1)
  @param AddWhereCond Добавочное условие
  @param ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ

  @return Рублёвая сумма объектов НДР
*/
MACRO GetRubSumByClientFromDepo(ClientID:integer, StrKind:string, MinDate:date, MaxDate:date, IIS:integer, AddWhereCond, ExcludeTechnical:bool)
   var SVal, SRub, vCount;

   if(ExcludeTechnical == NULL)
      ExcludeTechnical = false;
   end;
   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, null, @SVal, @SRub, @vCount, ClientID, null, null, null, null, null, true, IIS,
                    null, null, AddWhereCond, null, null, null, null, null, null, null, ExcludeTechnical);

   return SRub;
END;

/**
  @brief Получить рублёвую сумму объектов НДР по клиенту из "Векселей банка"
  @param ClientID Идентификатор клиента
  @param StrKind Строка с видом(ами) объектов НДР
  @param MinDate Дата начала периода
  @param MaxDate Дата окончания периода
  @param StrDocKind Вид документа
  @param ExcludeTechnical Исключить объекты НДР, созданные в операциях технического расчета НОБ

  @return Рублёвая сумма объектов НДР
*/
MACRO GetRubSumByClientFromVeksel(ClientID:integer, StrKind:string, MinDate:date, MaxDate:date, StrDocKind:string, ExcludeTechnical:bool)
   var SVal, SRub, vCount;
   
   DL_GetNPTXOBJSum(null, null, null, StrKind, MinDate, MaxDate, null, @SVal, @SRub, @vCount, ClientID, null, null, null, null, null, null, null,
                    null, null, null, true, StrDocKind, null, null, null, null, null, ExcludeTechnical);

   return SRub;
END;

//получить налоговую группу ц/б для НДФЛ
MACRO DL_GetNPTXSecType(FIID , flag, IsDerivative)

  /*Если flag = true, а для бумаги нет указанной группы НДФЛ, то функция вернет код группы НЖФЛ,
    соответствующий данному виду бумаг. Если же flag = false то в аналогичном случае вернет 0*/
  if((flag != null) AND (flag == true))
     var sql;

     if( IsDerivative != null )
        sql = RSDCommand("Select npto.GetPaperTaxGroupNPTX(?, ?) NumInList from dual");
     else
        sql = RSDCommand("Select npto.GetPaperTaxGroupNPTX(?) NumInList from dual");
     end;

     sql.addParam( "", RSDBP_IN, FIID );
     if( IsDerivative != null )
        sql.addParam( "", RSDBP_IN, IsDerivative );
     end;
     sql.execute();

     var DataSet = TRsbDataSet(sql);
     if( DataSet.MoveNext() )
        if( DataSet.NumInList > 0 )
           return DataSet.NumInList;
        end;
     end;
  else
     var NumInList = 0;
     var avoiriss = Trechandler( "avoiriss.dbt" ); /* бумага*/
     avoiriss.rec.FIID = FIID;

     if( GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(avoiriss, OBJTYPE_AVOIRISS), OBJGROUP_AVRNPTXGROUP, null, null, NumInList) )
        return NumInList;
     end;
  end;

  return null;
END;

//обращается для целей НДФЛ
MACRO DL_NPTX_IfMarket(FIID:integer, Ondate:date)

  var sql = RSDCommand("select NPTO.IfMarket(?,?) IfMarket from dual");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, Ondate );
  sql.execute();

  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
     if( SQL_ConvTypeStr(DataSet.IfMarket) == "X" )
        return true;
     end;
  end;

  return false;
END;
                                                
//Корп. облиг. с 2018
MACRO DL_NPTX_IsCorpBondAfter2018(FIID:integer, WarrantNum:string)
                               
  var sql = RSDCommand("select NPTO.IsCorpBondAfter2018(?,?) vIsCorpBondAfter2018 from dual");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, WarrantNum );
  sql.execute();

  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
     if( SQL_ConvTypeInteger(DataSet.vIsCorpBondAfter2018) == 1 )
        return true;
     end;
  end;

  return false;
END;

MACRO DL_NPTX_GetTaxBaseCorpBondAfter2018(FIID:integer, WarrantNum:string, Quantity:variant)
  var TaxBase = $0;                             
  var sql = RSDCommand("select NPTO.GetTaxBaseCorpBondAfter2018(?,?,?) TaxBase from dual");

  sql.addParam( "", RSDBP_IN, FIID );
  sql.addParam( "", RSDBP_IN, WarrantNum );
  sql.addParam( "", RSDBP_IN, Quantity );
  sql.execute();

  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
     TaxBase = SQL_ConvTypeSum(DataSet.TaxBase);
  end;

  return TaxBase;
END;



//получить очередность удержания налога
MACRO DL_GetClientTaxPriority(ClientID)
  var party = TBFile("party.dbt");
  var TaxPriority = NPTXPRIORITYTAX_FIRST915; //по умолчанию считается, что это "сначала по ставке 9(15)%"
  var NumInList = "";

  party.rec.PartyID = ClientID;

  if(GetMainObjAttr( null, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), 45/*Очередность удержания налога*/, null, null, NumInList))
    if(NumInList == "1")
      TaxPriority = NPTXPRIORITYTAX_FIRSTTOTAL;
    elif(NumInList == "2")
      TaxPriority = NPTXPRIORITYTAX_FIRST915;
    end;
  end;

  return TaxPriority;
END;

//получить резидентность для субъекта
MACRO DL_GetPartyResident(ClientID, OnDate:Date)
  var party = TBFile("party.dbt");
  var NumInList = "", PtIsRes = NPTXPARTY_UNDEF;

  party.rec.PartyID = ClientID;

  if( GetMainObjAttr( null, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), 42/*Является плательщиком НДФЛ*/, null, null, NumInList, OnDate))
     if(NumInList == "1")
        PtIsRes = NPTXPARTY_RESIDENT; //для резидента
     elif( NumInList != "" )
        PtIsRes = NPTXPARTY_NOTRESIDENT; //для нерезидента
     end;
  end;

  if (PtIsRes == NPTXPARTY_UNDEF)
     // смотрим по анкете
     party.rec.PartyID = ClientID;
     if(Party.getEQ())
        if(party.rec.NotResident == SET_CHAR)
           PtIsRes = NPTXPARTY_NOTRESIDENT; //для нерезидента
        else
           PtIsRes = NPTXPARTY_RESIDENT; //для резидента
        end;
     end;
  end;

  return PtIsRes;
END;


//получить ставку налогообложения процентов
MACRO DL_GetClientTaxRateProcent(ClientID, FIID, onDate)
  var PtIsRes;
  var NumInList = "";
  var TaxRate = null; //для резидента (по умолчанию)
  var SecType = null;

  PtIsRes = DL_GetPartyResident(ClientID);

  if( PtIsRes == NPTXPARTY_RESIDENT)
    SecType = DL_GetNPTXSecType(FIID);

    if ((SecType == 40) OR (SecType == 50))
      TaxRate = 0.0;
    elif (SecType == 30)
      TaxRate = 0.09;
    elif (SecType == 20)
      TaxRate = 0.13;
    end;
  elif(PtIsRes == NPTXPARTY_NOTRESIDENT) //нерезидент
    SecType = DL_GetNPTXSecType(FIID);

    if ((SecType == 40) OR (SecType == 50))
      TaxRate = 0.0;
    elif ((SecType == 20) OR (SecType == 30))
      var stat = 1;
      if (onDate != null)
        if ( ПолучитьЗначениеПримечанияНаДату(ClientID, PARTY_NOTE_KIND_NPTX_RATE_NOTRES /*налоговая ставка физикаНерезидента по общим доходам*/, onDate, @TaxRate) != 0 );
          TaxRate = 0.30;
        else
          TaxRate = TaxRate / 100;//ПолучитьЗначениеПримечанияНаДату вернёт кол-во процентов, а вернуть макрофункция DL_GetClientTaxRateProcent должна коэффициент
        end;
      else
        TaxRate = 0.30;
      end;      
    end;
    
  end;

  return TaxRate;
END;

//получить максимальную дату периода расчета НОБ для НДФЛ
MACRO DL_GetCalcPeriodDate(Kind:integer, ClientID:integer, IIS, Contract):date
  var CalcDate = date(0,0,0);

  if(ValType( Contract ) == V_UNDEF)
    Contract = 0;
  end;

  var sql = RSDCommand("Select npto.GetCalcPeriodDate(?,?,chr(?), ?) CalcDate from dual");
  sql.addParam( "", RSDBP_IN, Kind );
  sql.addParam( "", RSDBP_IN, ClientID );
  sql.addParam( "", RSDBP_IN, DL_IIF(IIS,88,0));
  sql.addParam( "", RSDBP_IN, Contract);
  
  sql.execute();

  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
    CalcDate = date(DataSet.CalcDate);
  end;

  return CalcDate;
END;

//получить доходы клиента по любым ставкам
MACRO DL_GetClientIncomeForAnyRates(ClientID:integer, MinDate:date, MaxDate:date, Direction:integer, IIS:integer)
  var Sum = 0, i = 5, val;

  while( GetParm(i, val) )
    Sum = Sum + GetRubSumByClient(ClientID, string(val), MinDate, MaxDate, Direction, IIS);
    i = i + 1;
  end;

  return Sum;
END;

private var IsIncludeComInCalc = NULL;
//Найти дату начала первого договора ИИС 
macro GetFirstDateIIS(pClient, pDlContrID)
  var query, cmd, DataSet;
  var FirstDate = date(0,0,0);
  
  if(pDlContrID == NULL)
    pDlContrID = 0;
  end;

  query = " select RSI_NPTO.GetFirstDateIIS( ?, ? ) as FirstDate FROM DUAL";
  
  cmd = DL_RSDCommand(query);
  cmd.addParam(pCLient );
  cmd.addParam(pDlContrID );

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    FirstDate = date(DataSet.FirstDate);
  end;

  return FirstDate;
end;

MACRO GetFirstDateIIS_old(pClient)
  var Select, Query, DataSet, dateBegin;

  Select = 
   " SELECT NVL(min(t_dateBegin), TO_DATE('01.01.0001','DD.MM.YYYY')) dateBegin "+
   "    FROM DSFCONTR_DBT "+
   "   WHERE T_ServKind    =  " + PTSK_STOCKDL +
   "     AND T_PartyID     =  ? " + // pClient 
   "     AND RSI_NPTO.CheckContrIIS(T_ID) = 1 "; //Является договором ИИС

   Query = RSDCommand(Select);
   Query.addParam( "", RSDBP_IN, pClient );
   Query.execute();

   DataSet = TRsbDataSet(Query);
   if( DataSet.MoveNext()  )
     if (date(DataSet.dateBegin) > date(1, 1, 2016))
        dateBegin = date(DataSet.dateBegin);
     else
        dateBegin = date(1, 1, 2016);
     end;
   end;

  return dateBegin;
END;

//Процедура пересчета льготного кол-ва ц\б в связях КП (вызывается перед расчетом НДР 2 уровня)
//без отката (каждый раз пересчитываем)
MACRO DL_ReCalcPrivAmountByLink(pBegDate:DATE, pEndDate:DATE, pClientID:integer, pIIS:integer, pFIID:integer)
  var sql = RSDCommand("begin RSI_NPTX.ReCalcPrivAmountByLink(?,?,?,?,?); end;");
  sql.addParam( "", RSDBP_IN, pBegDate );
  sql.addParam( "", RSDBP_IN, pEndDate );
  sql.addParam( "", RSDBP_IN, pClientID );
  sql.addParam( "", RSDBP_IN, pIIS);
  sql.addParam( "", RSDBP_IN, pFIID);

  sql.execute();
END;

//Получить кол-во льготных по данной записи остатков для НДФЛ
MACRO DL_GetPrivAmountByTS(pID:integer, pCalcDate:DATE, pDDS:DATE)
  var PrivAmount = $0;
  var sql = RSDCommand("Select RSI_NPTX.GetPrivAmountByTS(?,?,?) PrivAmount from dual");
  sql.addParam( "", RSDBP_IN, pID );
  sql.addParam( "", RSDBP_IN, pCalcDate );
  sql.addParam( "", RSDBP_IN, pDDS );

  sql.execute();

  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
     PrivAmount = SQL_ConvTypeSum(DataSet.PrivAmount);
  end;

  return PrivAmount;
END;

PRIVATE MACRO ПолучитьНОБиНалогДЕПО(ClientID:integer, Year:integer, KBK:string, AddWhere:string, НОБ_ДЕПО:@money, Налог_ДЕПО:@money)
  var query, cmd, DataSet;

  НОБ_ДЕПО   = $0;
  Налог_ДЕПО = $0;

  query =   " select NVL(SUM(t_TaxByPay), 0) as SumTaxByPay, "
          + "        NVL(SUM(t_TaxBase), 0) as SumTaxBase "
          + "   from dnptxdias_dbt "
          + "  where t_ClientID = ? "
          + "    and t_Year = ? "
          + "    and t_IIS = CHR(0) "
          + "    and t_KBK = ? "
          + AddWhere;

  cmd = DL_RSdCommand(query);

  cmd.AddParam(ClientID);
  cmd.AddParam(Year);
  cmd.AddParam(KBK);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    НОБ_ДЕПО   = DataSet.SumTaxBase;
    Налог_ДЕПО = DataSet.SumTaxByPay
  end;

END;

MACRO ПолучитьСтавкиНалога(ClientID:integer, ClientResident:bool, EndDate:date, Rg:@double, Rp:@double, Rs:@double)
  Rg = 0.0;
  Rs = 0.0;
  Rp = 0.0;

  if(ClientResident) //резидент
     Rg = 0.13;
     Rs = 0.09;

     if(EndDate >= date(01,01,2021))
       Rp = 0.15;
     end;
  else
     //Если вдруг на клиенте физлице нерезиденте задано примечание "Налоговая ставка для физического лица - нерезидента по общим доходам"
     var stat = ПолучитьЗначениеПримечанияНаДату(ClientID, PARTY_NOTE_KIND_NPTX_RATE_NOTRES /*налоговая ставка физикаНерезидента*/, EndDate, @Rg);
     if (stat != 0)
       Rg = 0.30;
     else
       Rg = Rg / 100; //Примечание вернёт целочисленные проценты, нам нужен коэффициент
     end;
     
     var noteTaxRate = ReadNoteForObject(OBJTYPE_PARTY, L_Z(ClientID, 10), 57);
     if(noteTaxRate > 0)
       Rs = noteTaxRate / 100;
     else
       Rs = 0.15;
     end;
  end;
END;

MACRO ПолучитьЗначенияДЕПО_СОФР_2022(ClientID:integer,
                                     ClientResident:bool,
                                     Year:integer,
                                     BegDate:date,
                                     EndDate:date,
                                     IIS:integer,
                                     НОБ_СОФР:@money, НОБ15_СОФР:@money,
                                     Налог_СОФР:@money, Налог15_СОФР:@money,
                                     НОБ_ДЕПО:@money, НОБ_ДЕПО_КБК1:@money, НОБ_ДЕПО_КБК2:@money, НОБ_ДЕПО_КБК3:@money,
                                     Налог_ДЕПО_КБК1:@money, Налог_ДЕПО_КБК2:@money, Налог_ДЕПО_КБК3:@money,
                                     Налог_КБК1:@money, Налог_КБК2:@money, Налог_КБК3:@money, ExcludeTechnical:bool
                                    )
   var AddWhereNotOut = " obj.t_FromOutSyst <> 'X'";

   var КБК1 = "18210102010011000110";
   var КБК2 = "18210102070011000110";
   var КБК3 = "18210102080011000110"; 

   var NpTxKindsStr = "";

   var Rg, Rp, Rs;
   var Bg2, Bg3, Bg9;

   НОБ_ДЕПО        = $0; 
   НОБ_ДЕПО_КБК1   = $0;
   НОБ_ДЕПО_КБК2   = $0;
   НОБ_ДЕПО_КБК3   = $0;
   Налог_ДЕПО_КБК1 = $0; 
   Налог_ДЕПО_КБК2 = $0; 
   Налог_ДЕПО_КБК3 = $0; 
   НОБ_СОФР        = $0; 
   НОБ15_СОФР      = $0; 
   Налог_СОФР      = $0; 
   Налог15_СОФР    = $0;
   Налог_КБК1      = $0; 
   Налог_КБК2      = $0; 
   Налог_КБК3      = $0;

   ПолучитьСтавкиНалога(ClientID, ClientResident, EndDate, @Rg, @Rp, @Rs);
                                                                                       
   ПолучитьНОБиНалогДЕПО(ClientID, Year, КБК1, " and t_TaxRate <> 15 ", @НОБ_ДЕПО_КБК1, @Налог_ДЕПО_КБК1);
   ПолучитьНОБиНалогДЕПО(ClientID, Year, КБК2, " and t_TaxRate <> 15 ", @НОБ_ДЕПО_КБК2, @Налог_ДЕПО_КБК2);
   ПолучитьНОБиНалогДЕПО(ClientID, Year, КБК3, " and t_TaxRate = 15 ",  @НОБ_ДЕПО_КБК3, @Налог_ДЕПО_КБК3);

   НОБ_ДЕПО = НОБ_ДЕПО_КБК1 + НОБ_ДЕПО_КБК2;
    
   Bg2 = GetRubSumByClient(ClientID, string(TXOBJ_BASEG2), BegDate, EndDate, null, IIS, null, AddWhereNotOut, ExcludeTechnical);
   Bg3 = GetRubSumByClient(ClientID, string(TXOBJ_BASEG3), BegDate, EndDate, null, IIS, null, AddWhereNotOut, ExcludeTechnical);
   Bg9 = GetRubSumByClient(ClientID, string(TXOBJ_BASEG9), BegDate, EndDate, null, IIS, null, AddWhereNotOut, ExcludeTechnical);

   if(ClientResident == true)
     НОБ_СОФР = (min(Bg2+НОБ_ДЕПО, NPTX_LIMINCOME_MAX15) - НОБ_ДЕПО) + min(Bg3, NPTX_LIMINCOME_MAX15) + min(Bg9, NPTX_LIMINCOME_MAX15); 
   else
     НОБ_СОФР = GetRubSumByClient(ClientID, string(TXOBJ_BASEGENERAL), BegDate, EndDate, null, IIS, null, AddWhereNotOut, ExcludeTechnical);
   end;

   НОБ15_СОФР = Bg2 + Bg3 + Bg9 - НОБ_СОФР;

   NpTxKindsStr = TXOBJ_PAIDGENERAL + ", " + TXOBJ_PAIDBILL;
   Налог_СОФР =  GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_CALCNDFL, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях расчета НОБ
                 GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, 0 /*только пользовательские*/,null, 0, AddWhereNotOut, ExcludeTechnical) +
                 GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, NULL, DL_HOLDNDFL, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
                 GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_WRTMONEY, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях списания/зачисления денежных средств
                 GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_RETIREMENT_OWN, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях погашения ОЭБ
                 /*плюс операции в ПС <Векселя банка>*/
                 GetRubSumByClientFromVeksel(ClientID, string(NpTxKindsStr), BegDate, EndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                               string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                               string(DL_VSINTERCHANGE),        //зачет взаимных требований
                                             ExcludeTechnical);


   NpTxKindsStr = TXOBJ_PAIDGENERAL_15_2 + ", " + TXOBJ_PAIDGENERAL_15_9;
   Налог15_СОФР = GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_CALCNDFL, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях расчета НОБ
                  GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, 0 /*только пользовательские*/,null, 0, AddWhereNotOut, ExcludeTechnical) +
                  GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, NULL, DL_HOLDNDFL, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях удержания НДФЛ с T_PREVDATE такой же, как и текушей операции
                  GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_WRTMONEY, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях списания/зачисления денежных средств
                  GetRubSumByClientOperDocKind(ClientID, string(NpTxKindsStr), BegDate, EndDate, DL_RETIREMENT_OWN, null, 0, AddWhereNotOut, ExcludeTechnical) + //созданные в операциях погашения ОЭБ
                  /*плюс операции в ПС <Векселя банка>*/
                  GetRubSumByClientFromVeksel(ClientID, string(NpTxKindsStr), BegDate, EndDate, string(DL_VEKSELDRAWORDER)+", "+ //погашение сюда же входит выкуп
                                                                                                string(DL_VSBARTERORDER)  +", "+ //мена
                                                                                                string(DL_VSINTERCHANGE),        //зачет взаимных требований
                                             ExcludeTechnical);


   Налог_КБК1 = round((НОБ_СОФР + НОБ_ДЕПО_КБК1 + НОБ_ДЕПО_КБК2)*Rg, 0) - Налог_СОФР - Налог_ДЕПО_КБК1 - round(НОБ_ДЕПО_КБК2*Rg, 0); 

   Налог_КБК2 = round(НОБ_ДЕПО_КБК2*Rg, 0) - Налог_ДЕПО_КБК2;

   Налог_КБК3 = round((НОБ15_СОФР + НОБ_ДЕПО_КБК3)*Rp, 0) - Налог15_СОФР - Налог_ДЕПО_КБК3;
END;

macro GetTaxRegValue(FullPath:string, OnDate:date, Val:@variant, ErrCode:@integer)
   var query, cmd, DataSet;
   var KeyID = 0;
   var find = false;

   ErrCode = 0;

   cmd = DL_RSDCommand();
   query = "select RSB_Common.RSI_GetRegParm(trim("+cmd.AddParam(FullPath)+")) as KeyID from dual";

   DataSet = cmd.Execute(query);
   if((DataSet.moveNext()) and (DataSet.KeyID > 0))
     KeyID = DataSet.KeyID;

     cmd = DL_RSDCommand();
     query =   " select rg.t_Type, st.* "
             + "   from dregparm_dbt rg, dregparmtag_dbt tg, dregparmstory_dbt st "
             + "  where rg.t_KeyID = "+cmd.AddParam(KeyID)
             + "    and tg.t_KeyID = rg.t_KeyID "
             + "    and tg.t_Tag1 = 'TAX' "
             + "    and st.t_KeyID = tg.t_KeyID "
             + "    and st.t_DateBegin <= " + cmd.AddParam(OnDate)
             + "    and st.t_DateEnd >= " + cmd.AddParam(OnDate);

     DataSet = cmd.Execute(query);
     if(DataSet.moveNext())
       if(DataSet.Type == 0 /*REG_INT_TYPE*/)
         Val = int(DataSet.IntValue);
       elif(DataSet.Type == 1 /*REG_DOUBLE_TYPE*/)
         Val = double(DataSet.DoubleValue);
       elif(DataSet.Type == 2 /*REG_STRING_TYPE*/)
         Val = string(DataSet.StringValue);
       elif(DataSet.Type == 4 /*REG_FLAG_TYPE*/)
         Val = false;
         if(DataSet.BoolValue == SET_CHAR)
           Val = true;
         end;
       else
         ErrCode = 1;
         msgbox("Неизвестный тип настройки \""+FullPath+"\"");
       end;

       find = true;
     end;

   else
     ErrCode = 1;
     msgbox("Не найдена настройка \""+FullPath+"\"");
   end;

   if((ErrCode == 0) and (find == false))
     GetRegistryValue( FullPath, V_INTEGER, Val, ErrCode );
     if( ErrCode != 0 )
        MsgBox( "Ошибка при получении значения настройки \""+FullPath+"\"");
     end;
   end;
end;

macro ПолучателиОтчетаУНКДДиасофт()
   var ErrCode = 0, CodeStr = "";

   GetRegistryValue( "SECUR\\ПОЛУЧАТЕЛИ_ОТЧЕТА_УНКД_ДИАСОФТ", V_STRING, CodeStr, ErrCode );
   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"SECUR\\ПОЛУЧАТЕЛИ_ОТЧЕТА_УНКД_ДИАСОФТ\"");
   end;

   return CodeStr;
end;

macro НаправлятьОтчетУНКДДиасофт()
   var ErrCode = 0;
   var Val = false;
   var RegPath = "SECUR\\НАПРАВЛЯТЬ_ОТЧЕТ_УНКД_ДИАСОФТ";

   GetRegistryValue( RegPath, V_BOOL, Val, ErrCode );

   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"");
   end;

   return Val;
end;

macro СрокОбработкиВыплатыПриПогашенииЦБ()
   var ErrCode = 0, Val = 0;

   GetRegistryValue( "SECUR\\СРОК_ОБРАБОТКИ_ВЫПЛАТЫ_ПО_ПОГАШ", V_INTEGER, Val, ErrCode );
   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"SECUR\\СРОК_ОБРАБОТКИ_ВЫПЛАТЫ_ПО_ПОГАШ\"");
   end;

   return Val;
end;

macro АвтоматОбработВыплатИИСДдиас()
   var ErrCode = 0;
   var Val = false;
   var RegPath = "SECUR\\АВТОМАТ_ОБРАБОТ_ВЫПЛАТ_ИИС_ДИАС";

   GetRegistryValue( RegPath, V_BOOL, Val, ErrCode );

   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"");
   end;

   return Val;
end;

macro ПериодОбработкиУНКД()
   var ErrCode = 0, Val = 0;

   GetRegistryValue( "SECUR\\ПЕРИОД_ОБРАБОТКИ_УНКД", V_INTEGER, Val, ErrCode );
   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"SECUR\\ПЕРИОД_ОБРАБОТКИ_УНКД\"");
   end;

   return Val;
end;

macro УчетКупДепоПриРасчНОБ()
   var ErrCode = 0;
   var Val = false;
   var RegPath = "COMMON\\НДФЛ\\УЧЕТ_КУП_ДЕПО_ПРИ_РАСЧ_НОБ";

   GetRegistryValue( RegPath, V_BOOL, Val, ErrCode );

   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"");
   end;

   return Val;
end;

macro ПредельныйСрокВозвратаНалога(OnDate)
   var ErrCode = 0, Val = 0;

   if(OnDate == NULL)
     OnDate = {curdate};
   end;

   GetTaxRegValue("COMMON\\НДФЛ\\ПРЕДЕЛЬНЫЙ_СРОК_ВОЗВРАТА_НАЛОГА", OnDate, @Val, @ErrCode);

   return Val;
end;

macro АвтоЗаменаКодовДоходовIntr(OnDate)
   var ErrCode = 0, Val = false;

   if(OnDate == NULL)
     OnDate = {curdate};
   end;

   GetTaxRegValue("COMMON\\НДФЛ\\АВТО_ЗАМЕНА_КОДОВ_ДОХОДОВ_INTR", OnDate, @Val, @ErrCode);

   return Val;
end;

macro НПВводаДоработокМатВыгода():integer
   var ErrCode = 0, Val = 0;

   GetTaxRegValue("COMMON\\НДФЛ\\НП_ВВОДА_ДОРАБОТОК_МАТ.ВЫГОДА", {curdate}, @Val, @ErrCode);

   return Val;
end;

macro CheckTaxTeriodToLucre(TaxPeriod)
  VAR StartLucreTaxPeriod = НПВводаДоработокМатВыгода();

  if(TaxPeriod < StartLucreTaxPeriod)
    return false;
  end;

  return true;
end;

MACRO DL_CheckContrIIS(pContrId)
  var isIIS = false;
  var sql = RSDCommand("Select RSI_NPTO.CheckContrIIS(?) as t_iis from dual");
  sql.addParam( "", RSDBP_IN, pContrId );
  sql.execute();
  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
     isIIS = SQL_ConvTypeInteger(DataSet.iis) == 1;
  end;

  return isIIS;
END;