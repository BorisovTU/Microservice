/*
$Name:         dl711avoir.mac
$Module:       Депозитарий
$Description:  Выборка данных для Ф711 Ч1
*/
import BankInter, PTInter, FIInter, PaymInter, DealsInter, DPInter,
       "globals.mac", "or_hdr_h.mac", "cb_sql.mac", "dlquery.mac", "dlreport.mac", "dpstdrep.mac", "spRepFun.mac";

private const BO_VA   = "N";  //Учтенные векселя
private const BO_VS   = "Y";  //Собственные векселя

private const LLCLASS_KIND_BLOCK_CB_ENCUMBER711 = 1842; //Обременённые для формы 711
private const LLBLOCK_OBOSOBL = 54; //Обособленный учет
private const LLBLOCK_OBOSOBBR = 56; //Обособленны по требованию ЦБ РФ
private const LLBLOCK_ESCROW = 124; //Эскроу

// Подразделы отчета
const LORO_PART    = 0; // ц/б номинального держателя
const CLIENT_PART  = 1; // ц/б клиентов
const BANK_PART    = 2; // ц/б банка
const BALANCE_PART = 3; // балансовая стоимость вложений в ц/б
const CLIENT_PART_2_1  = 5; // ц/б клиентов для раздела 2_1
const LD_BANK_PART = 6; // ранее загруженные закладные

/* ********************** */
/*         Фильтр         */
/* ********************** */
private class TFilter
  var Departments:string = string({OperDprt}), // Список филиалов по которым выбираются ц/б
      BegDate:date       = {curdate},          // Дата начала отчетного периода
      RepDate:date       = {curdate},          // Дата окончания отчетного периода
      RepPart:integer    = 0;                  // Подраздел отчета
end;

/* Полезные функции */
class C_711Tools()
  const OUR_COUNTRY_CODE_LAT       = "RUS",  //Код нашей страны, латиница
        INTERNATIONAL_COUNTRY_CODE_290FZ = "996",  //Код для международных организаций по 290 ФЗ
        INTERNATIONAL_COUNTRY_CODE = "998",  //Код для международных организаций
        UNKNOWN_COUNTRY_CODE       = "999";  //Код страны неизвестен
  const UNKNOW_INN_RES_PHYS = "000000000000",
        UNKNOW_INN_RES_YUR  = "0000000000",
        UNKNOW_INN_NOTRES_PHYS = "00000",
        UNKNOW_INN_NOTRES_YUR  = "000";

  macro GetSQLStr(str:String)
    var sqlstr = "";

    if((ValType(str) == V_UNDEF) or (str == ""))
      sqlstr = "CHR(1)";
    else
      sqlstr = "'"+StrSubst(str, "'", "''")+"'";
    end;

    return sqlstr;
  end;

  macro CheckPartyType( PartyId, PartyType )
    var partyown = TBFile("partyown");
    var isPartyType = false;

    partyown.KeyNum = 0;
    partyown.rec.PartyID   = PartyId;
    partyown.rec.PartyKind = PartyType;
    if (GetEQ(partyown))
      isPartyType = true;
    end;

    return isPartyType;
  end;

  macro CheckPartyIsSubjType(PartyId, SubjType, Num)
    var party = TBFile("party");
    var res:bool = false;
    party.rec.PartyID = PartyId;
    if (party.GetEQ())
      CheckObjAttrPresence(res, OBJTYPE_PARTY, UniID( party, OBJTYPE_PARTY), PARTY_ATTR_GROUP_PTTYPE, SubjType, null, Num);
    end;
    return res;
  end;


  /* Получить ИНН */
  macro CorrectINN(pt:TRecHandler, inn:@string, tin:@string, notrescode:@string, chkzeros:bool, intercomp_290FZ:bool)
    if(pt.rec.NotResident == "X")
      if(chkzeros == null)
        chkzeros = true;
      end;
      tin = GetCodeParty(pt.rec.PartyID, PTCK_FOREIGN_INN);
      notrescode = "TIN";
      if((tin == "") or (chkzeros and (StrSubst(tin, "0", "") == "")))
        // LEI (Legal Entity Identifier)
        tin = GetCodeParty(pt.rec.PartyID, PTCK_LEI);
        notrescode = "LEI";
        if((tin == "") or (chkzeros and (StrSubst(tin, "0", "") == "")))
          // Регистрационный номер в стране регистрации
          tin = GetCodeParty(pt.rec.PartyID, PTCK_STATEREGNUM);
          notrescode = "RN";
          if((tin == "") or (chkzeros and (StrSubst(tin, "0", "") == "")))
            // Если не заполнен или запонен нулями
            notrescode = "NN";
          end;
        end;
      end;
      if((intercomp_290FZ == true) AND (CheckPartyIsSubjType(pt.rec.PartyID, null, "14.1" /*Международная компания по 290-ФЗ*/) or (CheckPartyIsSubjType(pt.rec.PartyID, null, "14.2" /*Международная компания по 290-ФЗ*/))))
        notrescode = "";
      else
        inn = tin;
      end;
      inn = tin;
      if(inn == "")
        if(pt.rec.LegalForm != PTLEGF_PERSN)
          inn = UNKNOW_INN_NOTRES_YUR;
        else
          inn = UNKNOW_INN_NOTRES_PHYS;
        end;
      end;
    else
      if(inn == "")
        if(pt.rec.LegalForm != PTLEGF_PERSN)
          inn = UNKNOW_INN_RES_YUR; //для юрлиц 10 нулей
        else
          inn = UNKNOW_INN_RES_PHYS; //для физлиц 12 нулей
        end;
      end;
    end;
  end;

  /* Получить ИНН и КПП*/
  macro SplitINN_KPP(pt:TRecHandler, inn_kpp:string, inn:@string, kpp:@string, tin:@string, notrescode:@string, chkzeros, _intercomp_290FZ:bool)
    var intercomp_290FZ = false;
    if( ( ValType(_intercomp_290FZ) != V_UNDEF ) AND _intercomp_290FZ == True)
      intercomp_290FZ = true;
    end;
    SplitFullINN(inn_kpp, inn, kpp);
    CorrectINN(pt, @inn, @tin, @notrescode, chkzeros, intercomp_290FZ);
  end;

  /* Код страны */
  macro GetCountryCode(pt:TRecHandler):string
    var countryCode = "";

    if((pt.rec.LegalForm != PTLEGF_PERSN) and CheckPartyType(pt.rec.PartyID, 34 /*Международная организация*/ ))
      countryCode = INTERNATIONAL_COUNTRY_CODE;
    elif ((pt.rec.LegalForm != PTLEGF_PERSN) and CheckPartyIsSubjType(pt.rec.PartyID, 14 /*Международная компания по 290-ФЗ*/ ))
      countryCode = INTERNATIONAL_COUNTRY_CODE_290FZ;
    else
      if (pt.rec.NotResident == "X")
        countryCode = DP_GetCountryByCodeLat3(pt.rec.NRCountry).CodeNum3;
        if(countryCode == "")
          countryCode = UNKNOWN_COUNTRY_CODE;
        end;
      else
        countryCode = {ResidentCountryCodeNum};
      end;
    end;
    return countryCode;
  end;

  /* Получить признак корреспондента*/
  macro GetCorrespMark(pt:TRecHandler):string
    var mark = "";
    if (pt.rec.NotResident == "X")
      mark = "И";
    else
      var cmd, dataSet;

      cmd = DL_RSDCommand("SELECT t_isRegistrar, t_isIssuer, t_isDepositary, t_isBank, t_isvnesheconombank FROM drepparty_vw WHERE t_ID = ?");

      cmd.AddParam(pt.rec.PartyID);
      dataSet = cmd.Execute();

      if (dataSet.moveNext())
        if ((dataSet.isRegistrar == 1) and (dataSet.isIssuer == 1))
          mark = "Э";
        elif ((dataSet.isRegistrar == 1) and (dataSet.isIssuer == 0))
          mark = "Р";
        elif ((dataSet.isDepositary == 1) and (dataSet.isBank == 1) and (dataSet.isvnesheconombank == 0))
          mark = "К";
        elif ((dataSet.isDepositary == 1) and ((dataSet.isBank == 0) or (dataSet.isvnesheconombank == 1)))// Внешэкономбанк - некредитная организация
          mark = "Н";
        end;
      end;
    end;
    return mark;
  end;

  /*Признак места хранения*/
  macro GetStoragePlaceMark(pt:TRecHandler, fiid:integer):string
    var markArr = TArray(),
        mark = "";
    var cmd, dataSet;

    cmd = DL_RSDCommand("SELECT t_isResident, t_isRegistrar, t_isIssuer, t_isDepositary, t_isBank, t_isvnesheconombank FROM drepparty_vw WHERE t_ID = ?");
    cmd.addParam(pt.rec.PartyID);

    dataSet = cmd.Execute();

    if (dataSet.moveNext())
      if (dataSet.isResident == 0) // нерезидент
        markArr[markArr.size] = "И";
      end;
      if ((dataSet.isRegistrar == 1) and (dataSet.isIssuer == 1))
        markArr[markArr.size] = "Э";
      end;
      if ((dataSet.isRegistrar == 1) and (dataSet.isIssuer == 0))
        markArr[markArr.size] = "Р";
      end;
      if ((dataSet.isDepositary == 1) and (dataSet.isBank == 1) and (dataSet.isvnesheconombank == 0))
        markArr[markArr.size] = "К";
      end;
      if ((dataSet.isDepositary == 1) and ((dataSet.isBank == 0) or (dataSet.isvnesheconombank == 1)))
        markArr[markArr.size] = "Н";
      end;
    end;

    /*1. Если у Субъекта только один атрибут, то определяется и выводится он.
      2. Иначе, для Ценной бумаги  проверяется значение связанного объекта Реестродержатель активного счета депо.
           Если Реестродержатель равен Владельцу активного счета депо, то для графа заполняется значением "Э" или "Р".
           Иначе графа заполняется значениями "И" или "Н".
    */
    if (markArr.size == 1)
      mark = markArr[0];
    else
      var registrPartyID = TRecHandler("party.dbt");
      GetLinkedObject(11, OBJTYPE_AVOIRISS, L_Z(fiid, 10), OBJTYPE_PARTY, registrPartyID);
      for (mark, markArr)
        if (registrPartyID.rec.partyID == pt.rec.PartyID)
          if ((mark=="Э") or (mark=="Р"))
            break;
          end;
        else
          if ((mark=="И") or (mark=="Н") or (mark=="К"))
            break;
          end;
        end;
        mark = "";
      end;
    end;

    return mark;
  end;

  // Получить псевдоним заданного вида
  private macro GetPartyPseudoName(PartyID, NameTypeID)
    var Name = "";
    var NameArr = GetPartyNames(PartyID, NameTypeID);
    if(NameArr.size > 0)
      Name = NameArr[0];
    end;
    return Name;
  end;

  // Golovkin 26.03.2019 Используем примечание 21 "Наименование банка для отчетов"
  macro GetReportPartyName(pt:TRecHandler)
    var note = "";
    note = readNoteForObject(OBJTYPE_PARTY, L_Z(pt.rec.PartyID, 10), 21);
    return note; 
  end;

  macro GetPartyName(pt:TRecHandler, _only_short:bool):string
    var name = "";
    var only_short = false;

    // Golovkin 07.10.2019 ID : 496373 Используем примечание 21 "Наименование банка для отчетов"
    var ReportPartyName = GetReportPartyName(pt);
    if(ReportPartyName != "")
       return ReportPartyName; // Если есть наименование в примечании, то сразу его возвращаем
    end;

    if(_only_short != NULL)
      only_short = _only_short;
    end;

    // Для нерезидента на англ. языке
    if ((pt.rec.NotResident == "X") and (pt.rec.Latname!=""))
      name = pt.rec.Latname;
    end;

    if((name == "") AND (NOT only_short))
      name = GetPartyPseudoName(pt.rec.PartyID, PTKN_BANKNAME);
    end;

    if(name == "")
      name = GetPartyPseudoName(pt.rec.PartyID, PTKN_SHORTBANKNAME);
    end;

    if((name == "") AND (NOT only_short))
      name = GetPartyPseudoName(pt.rec.PartyID, PTKN_FULLNAME);
    end;

    if( name == "")
      name = GetPartyPseudoName(pt.rec.PartyID, PTKN_SHORTNAME);
    end;

    return name;
  end;

  /* Наименование ПИФА */
  private macro GetNameInvstName(fiid:integer):string
    var cmd, dataSet;

    cmd = DL_RSDCommand("SELECT t_Name FROM davrinvst_dbt fin WHERE t_FIID = ?");

    cmd.addParam(fiid);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      return dataSet.Name;
    end;

    return "";
  end;

  private macro GetIssuerNameForDepository(fiid:integer):string
    var cmd, dataSet;
    var ReportPartyName = "";

    cmd = DL_RSDCommand("SELECT finParent.t_Issuer FROM dfininstr_dbt fin, dfininstr_dbt finParent WHERE fin.t_FIID = ? AND finParent.t_FIID = fin.t_ParentFI");

    cmd.addParam(fiid);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      var pt = TRecHandler("party.dbt");

      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        
        // Golovkin 26.03.2019 Используем примечание 21 "Наименование банка для отчетов"
        ReportPartyName = GetReportPartyName(pt);
        if(ReportPartyName != "")
           return ReportPartyName;
        else
           return GetPartyName(pt);
        end;
      end;
    end;

    return "";
  end;

  /* Наименование субъекта*/
  macro GetIssuerName(pt:TRecHandler, fiid:integer):string
    var name = GetPartyName(pt);
    var ReportPartyName = "";
    var cmd, dataSet;
    var avoirKindRoot = 0;
    var note = "";

    // Golovkin 26.03.2019 Используем примечание 21 "Наименование банка для отчетов"
    ReportPartyName = GetReportPartyName(pt);
    if(ReportPartyName != "")
       name = ReportPartyName;
    end;

    cmd = DL_RSDCommand("SELECT RSI_RSB_FIInstr.fi_avrkindsgetroot(2, fin.t_AvoirKind) as t_AvoirKindRoot FROM dfininstr_dbt fin WHERE fin.t_FIID = ?");

    cmd.addParam(fiid);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      avoirKindRoot = dataSet.AvoirKindRoot;
    end;

    if (avoirKindRoot == AVOIRISSKIND_INVESTMENT_SHARE) // Инвестиционный пай
      if(ReportPartyName == "")
        name = pt.rec.name;
      end;
      name = name + " ("+GetNameInvstName(fiid)+")";
    elif (avoirKindRoot == AVOIRISSKIND_HYPOTHECARY_CERT) //ИСУ
      //name = pt.rec.name;
      if(ReportPartyName == "")
        name = pt.rec.name;
      end;
      note = readNoteForObject(OBJTYPE_AVOIRISS, L_Z(fiid, 10), 18);//Индивидуальное обозначение
      if(note != "")
        name = name + " (" + note + ")";
      end;
    elif (avoirKindRoot == AVOIRISSKIND_KSU) //КСУ
      //name = pt.rec.name;
      if(ReportPartyName == "")
        name = pt.rec.name;
      end;
      note = readNoteForObject(OBJTYPE_AVOIRISS, L_Z(fiid, 10), 18);//Индивидуальное обозначение
      if(note != "")
        name = name + " (" + note + ")";
      end;
    elif (avoirKindRoot == AVOIRISSKIND_DEPOSITORY_RECEIPT) // депозитарные расписки
      name = GetIssuerNameForDepository(fiid);
    end;

    return name;
  end;

  /* Эмиссионная бумага? */
  macro IsEmissive(avoirKind:integer):bool
    var cmd, dataSet;

    cmd = DL_RSDCommand("SELECT ak.t_IsEmissive FROM DAVRKINDS_DBT ak WHERE ak.t_FI_Kind = 2 AND ak.t_AvoirKind = ?");

    cmd.addParam(avoirKind);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      return (dataSet.IsEmissive == "X");
    end;

    return false;
  end;

  /* Номер лицензии */
  macro GetStoragePlaceLicense(pt:TRecHandler, Code711FI:string):string
    var licNum = "";
    if ((Code711FI == "SHS7") or (Code711FI == "SHS71") or (Code711FI == "SHS8"))
      licNum = GetCodeParty(pt.rec.PartyID, 57); // спецдепозит.
    end;

    if (licNum == "")
      licNum = GetCodeParty(pt.rec.PartyID, 17); // № лицензии учатсника ОРЦБ
    end;

    return licNum;
  end;

  macro ПолучитьДатуПолученияЛицензии(PartyID, DateRep)
    var cmd, dataSet;

    cmd = DL_RSDCommand("SELECT code.T_BankDate BankDate FROM DOBJCODE_DBT code WHERE code.T_OBJECTTYPE = 3 AND code.t_CODEKIND = 17 AND code.T_STATE = 0 AND code.T_OBJECTID = ? AND code.T_BankDate < ? ORDER BY code.T_BankDate DESC ");

    cmd.addParam(PartyID);
    cmd.addParam(DateRep);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      return  string( date(dataSet.BankDate) ) ;
    end;
    return "";
  end;

  /* Получить вид счета */
  macro GetDepoAccKind(depoAccKind:string):string
    var IsTrade = false;
    var AccKind;

    if((depoAccKind != "") and (substr(depoAccKind, 1, 1) == "X"))
      IsTrade = true;
      AccKind = int(substr(depoAccKind, 2));
    else
      AccKind = int(depoAccKind);
    end;

    if (AccKind == OBJTYPE_DEPOKINDTYPE_DEPONENT) //счет владельца
      return "OWNER";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_DEPOSITORYPROGRAM) //депозитарных программ
      return "DEPOPROG";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_ISSUER) //счет доверительного правляющего
      return "TRUSTEE";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_EMISSEMIT) //эмиссионный счет эмитента
      return "ISSUER";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_EMITFIID) //счет эмитента для выкупа погашения ЦБ
      return "EMISSION";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_DEPOSIT) //Депозитный счёт депо
      return "DEPOSIT";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_SUBOWNER) //Субсчет клирингового счета депо, открытого владельцам
      return "SUBOWNER";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_SUBTRUSTEE) //Субсчет клирингового счета депо, открытого доверительному управляющему
      return "SUBTRUSTEE";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_TRANSIT) //транзитный
      return "TRANSIT";
    elif (   (AccKind == OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER) //счет номинального держателя
          OR (AccKind == OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER)) //иностранного номинального держателя
      return "HOLDER";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_FOREIGNAUTHKEEPER)//иностранного уполномоченного держателя
      return "FAUTHOLDER";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_FIIDFACE) //счет <Ценные бумаги не установленных лиц>
      return "NONE";
    elif (AccKind == OBJTYPE_DEPOKINDTYPE_ALLOTHER) //все прочие
      return "OTHER";
    end;
    return "";
  end;

  /*Скорректировать номинал и валюту*/
  macro CorrectFaceValue(code711:string, faceValue:@numeric, faceValueFiCode:@string, faceValuePoint:@integer)
    if ((code711 == "OPN") or (code711 == "SHS7") or (code711 == "SHS71") or (code711 == "SHS8") or (code711 == "DR") or (code711 == "DR1") or (code711 == "DR2"))
      faceValue = $0.0;
    end;

    if (faceValue == $0.0)
      faceValueFiCode = "";
      faceValuePoint  = 0;
    end;
  end;

  /*Получить RULESREGXID инвестиционного пая или ISU*/
  macro GetRULESREGXID(FIID:integer):string
    var cmd, dataSet;
    var XID = "";

    cmd = DL_RSDCommand("SELECT T_RULESREGXID FROM davrinvst_dbt WHERE t_FIID = ?");

    cmd.addParam(fiid);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      XID = dataSet.RulesRegXID;
    end;
    return XID;
  end;

  /*Получить LSIN инвестиционного пая*/
  macro CorrectLSINInvst(FIID:integer, LSIN:string):string
    // если не задан LSIN, то регистрационный номер правил фонда с закладки "Описание фонда" анкеты пая.
    if (LSIN=="")
      LSIN = GetRULESREGXID(FIID);
    end;
    return LSIN;
  end;

  /* Получить номер гос. регистрации для депозитарной расписки */
  macro GetLSINDEPO(fiid)
    // берем номер гос. рег. из базового выпуска
    var cmd, dataSet;
    var LSIN = "";
    var IssuerCountryCode;

    cmd = DL_RSDCommand("SELECT baseAvr.t_LSIN, baseAvr.t_ISIN, baseFin.t_Issuer FROM dfininstr_dbt fin, davoiriss_dbt baseAvr, dfininstr_dbt baseFin WHERE fin.t_FIID = ? AND baseAvr.t_FIID = fin.t_ParentFI AND baseFin.t_FIID = baseAvr.t_FIID");

    cmd.addParam(fiid);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      var pt = TRecHandler("party.dbt");
      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        var tools = C_711Tools;
        IssuerCountryCode = tools.GetCountryCode(pt);
      end;

      if(IssuerCountryCode == "643")
        LSIN = dataSet.LSIN;
      else
        LSIN = dataSet.ISIN;
      end;
    end;
    return LSIN;
  end;

  /* Получить признак депозитария-корреспондента*/
  macro GetCorrespINN_Mark(pt:TRecHandler):string
    var mark = "";
    if ((pt.rec.LegalForm == PTLEGF_INST) and (pt.rec.NotResident != "X"))
      mark = "1";
    elif ((pt.rec.LegalForm == PTLEGF_INST) and (pt.rec.NotResident == "X"))
      mark = "2";
    end;
    return mark;
  end;

  /* Получить признак эмитента*/
  macro GetIssuerINN_Mark(pt:TRecHandler):string
    var mark = "";
    if ((pt.rec.LegalForm == PTLEGF_INST) and (pt.rec.NotResident != "X"))
      mark = "1";
    elif ((pt.rec.LegalForm == PTLEGF_INST) and (pt.rec.NotResident == "X"))
      mark = "2";
    elif ((pt.rec.LegalForm == PTLEGF_PERSN) and (pt.rec.NotResident != "X"))
      mark = "3";
    elif ((pt.rec.LegalForm == PTLEGF_PERSN) and (pt.rec.NotResident == "X"))
      mark = "4";
    end;
    return mark;
  end;

  /* Получить признак организации */
  macro GetStoragePlaceINN_Mark(pt:TRecHandler):string
    var mark = "";
    if ((pt.rec.LegalForm == PTLEGF_INST) and (pt.rec.NotResident != "X"))
      mark = "1";
    elif ((pt.rec.LegalForm == PTLEGF_INST) and (pt.rec.NotResident == "X"))
      mark = "2";
    end;
    return mark;
  end;

  /* Наш банк (для многофилиального банка условие (Место хранения = Наш Банк) истинно и для всех нижележащих филиалов из территориальной структуры.)*/
  macro IsOurBank(partyID)
    var dataSet, cmd;

    cmd = DL_RSDCommand("SELECT t_PartyID FROM ddp_dep_dbt WHERE t_PartyID = ?");
    cmd.AddParam(partyID);
    dataSet = cmd.execute();

    return dataSet.MoveNext();
  end;

  macro GetCFI(fiid)
    var cmd, dataSet, query;
    var CFI = "";

    query = 
      " SELECT t_Code "
     +"   FROM DOBJCODE_DBT "
     +"  WHERE t_ObjectType = ? AND t_CodeKind = ? AND t_ObjectID = ? AND t_state=0 ";

    cmd = DL_RSDCommand(query);
    cmd.addParam(OBJTYPE_FININSTR);
    cmd.addParam(FICK_CFIC);
    cmd.addParam(fiid);

    dataSet = cmd.Execute();
    if (dataSet.moveNext())
      CFI = dataSet.Code;
    end;
    return CFI;
  end;
end;

private const SQL_QueryIssuer =  " (SELECT CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
                               + "                       THEN (SELECT finParent.t_Issuer"
                               + "                               FROM dfininstr_dbt finParent"
                               + "                              WHERE finParent.t_FIID = fin2.t_ParentFI)"
                               + "                    ELSE fin2.t_Issuer"
                               + "                END AS t_Issuer,"
                               + "             fin2.t_FIID"
                               + "             FROM dfininstr_dbt fin2 )";

private const BLOCKAMOUNT_DATE = date(1,7,2017);
private const BLOCKARREST_DATE = date(30,6,2017);
private const DATE_01_04_2018 = date(1,4,2018);
private const DATE_01_01_2019 = date(1,1,2019);

////////////   для 23/50/88
private macro GetQueryForTradeSub(OnDate:date, BlockDate:date, RepDateSQL:string)

  var query = " SUM(0) ";

  if(OnDate >= BlockDate)
    query = " SUM(DECODE(dpac.t_IsTrade, 'X', rsi_rsb_account.restsa(accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1), 0)) ";
  end;

  return query;
end;

private macro GetQueryForTradeAcc(OnDate:date, BlockDate:date, RepDateSQL:string)

  var query = " SUM(0) ";

  if(OnDate >= BlockDate)
    query = " SUM(DECODE(dpac.t_IsTrade, 'X', RSI_RSB_ACCOUNT.RestAC( acc.T_ACCOUNT, acc.T_CODE_CURRENCY,  "+RepDateSQL+", acc.T_CHAPTER, null ), 0)) ";
  end;

  return query;
end;

private macro GetQueryForTradeCert(OnDate:date, BlockDate:date)

  var query = " SUM(0) ";

  if(OnDate >= BlockDate)
    query = " SUM(DECODE(dpac.t_IsTrade, 'X', vficert.t_Copies, 0)) ";
  end;

  return query;
end;

////////////
//часть sql-запроса для определения сумму ц/б на счетах с блокировкой
private macro GetQueryForBlockSub(OnDate:date, BlockDate:date, RepDateSQL:string, BlockClass:integer, OnlyIssuerResident:bool)

  var query = " SUM(0) ";

  if(OnDate >= BlockDate)
    query = "                 SUM(CASE WHEN ";

    if(BlockClass == LLCLASS_KIND_BLOCK_CB_ENCUMBER711)
      query = query + " ( dpac.t_IsTrade = 'X' OR ";
    end;

    query = query + "                                EXISTS(SELECT 1 "
                  + "                                            FROM ddepoatvl_dbt atvl "
                  + "                                           WHERE atvl.t_IsType = CHR(0) "
                  + "                                             AND atvl.t_ID = dacntPart.t_AutoKey "
                  + "                                             AND atvl.t_AttrNum = 6 " //DEPOATTR_ATTNUM_BLOCK
                  + "                                             AND atvl.t_Value IN (SELECT TO_CHAR(clsv.t_Element) "
                  + "                                                                    FROM dllclsval_dbt clsv "
                  + "                                                                   WHERE clsv.t_Classificator = "+BlockClass+")"
                  + "                                         ) ";

    if(BlockClass == LLCLASS_KIND_BLOCK_CB_ENCUMBER711)
      query = query + " )";
    end;

    if(OnlyIssuerResident)
      query = query + "                          AND NOT EXISTS(SELECT 1 "
                    + "                                           FROM dfininstr_dbt fin2, dparty_dbt ptiss "
                    + "                                          WHERE fin2.t_FIID = acc.t_Code_Currency "
                    + "                                            AND ptiss.t_PartyID = (CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
                    + "                                                                             THEN (SELECT finParent.t_Issuer"
                    + "                                                                                     FROM dfininstr_dbt finParent"
                    + "                                                                                    WHERE finParent.t_FIID = fin2.t_ParentFI)"
                    + "                                                                        ELSE fin2.t_Issuer END) "
                    + "                                            AND ptiss.t_NotResident = 'X') ";
    end;

    query = query + "                               THEN rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 ) "
                  + "                          ELSE 0 END "
                  + "                    ) " ;
  end;

  return query;
end;

private macro GetQueryForValBlockSub(OnDate:date, BlockDate:date, RepDateSQL:string, Block, OnlyIssuerResident:bool)

  var query = " SUM(0) ";

  if(OnDate >= BlockDate)
    query = "                 SUM(CASE WHEN ";

    query = query + "                                EXISTS(SELECT 1 "
                  + "                                            FROM ddepoatvl_dbt atvl "
                  + "                                           WHERE atvl.t_IsType = CHR(0) "
                  + "                                             AND atvl.t_ID = dacntPart.t_AutoKey "
                  + "                                             AND atvl.t_AttrNum = 6 " //DEPOATTR_ATTNUM_BLOCK
                  + "                                             AND atvl.t_Value = TO_CHAR("+Block+"))";

    if(OnlyIssuerResident)
      query = query + "                          AND NOT EXISTS(SELECT 1 "
                    + "                                           FROM dfininstr_dbt fin2, dparty_dbt ptiss "
                    + "                                          WHERE fin2.t_FIID = acc.t_Code_Currency "
                    + "                                            AND ptiss.t_PartyID = (CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
                    + "                                                                             THEN (SELECT finParent.t_Issuer"
                    + "                                                                                     FROM dfininstr_dbt finParent"
                    + "                                                                                    WHERE finParent.t_FIID = fin2.t_ParentFI)"
                    + "                                                                        ELSE fin2.t_Issuer END) "
                    + "                                            AND ptiss.t_NotResident = 'X') ";
    end;

    query = query + "                               THEN rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 ) "
                  + "                          ELSE 0 END "
                  + "                    ) " ;
  end;

  return query;
end;

private macro GetQueryForBlockAcc(OnDate:date, BlockDate:date, RepDateSQL:string, BlockClass:integer, OnlyIssuerResident:bool)

  var query = " SUM(0) ";

  if(OnDate >= BlockDate)
    query = "                 SUM(CASE WHEN ";

    if(BlockClass == LLCLASS_KIND_BLOCK_CB_ENCUMBER711)
      query = query + " ( dpac.t_IsTrade = 'X' OR ";
    end;

    query = query + "                                EXISTS(SELECT 1 "
                  + "                                            FROM ddepoatvl_dbt atvl "
                  + "                                           WHERE atvl.t_IsType = CHR(0) "
                  + "                                             AND atvl.t_ID = dacntPart.t_AutoKey "
                  + "                                             AND atvl.t_AttrNum = 6 " //DEPOATTR_ATTNUM_BLOCK
                  + "                                             AND atvl.t_Value IN (SELECT TO_CHAR(clsv.t_Element) "
                  + "                                                                    FROM dllclsval_dbt clsv "
                  + "                                                                   WHERE clsv.t_Classificator = "+BlockClass+")"
                  + "                                         ) ";

    if(BlockClass == LLCLASS_KIND_BLOCK_CB_ENCUMBER711)
      query = query + " )";
    end;

    if(OnlyIssuerResident)
      query = query + "                          AND NOT EXISTS(SELECT 1 "
                    + "                                           FROM dfininstr_dbt fin2, dparty_dbt ptiss "
                    + "                                          WHERE fin2.t_FIID = acc.t_Code_Currency "
                    + "                                            AND ptiss.t_PartyID = (CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
                    + "                                                                             THEN (SELECT finParent.t_Issuer"
                    + "                                                                                     FROM dfininstr_dbt finParent"
                    + "                                                                                    WHERE finParent.t_FIID = fin2.t_ParentFI)"
                    + "                                                                        ELSE fin2.t_Issuer END) "
                    + "                                            AND ptiss.t_NotResident = 'X') ";
    end;

    query = query + "                               THEN RSI_RSB_ACCOUNT.RestAC( acc.T_ACCOUNT, acc.T_CODE_CURRENCY,  "+RepDateSQL+", acc.T_CHAPTER, null ) "
                  + "                          ELSE 0 END "
                  + "                    ) " ;
  end;

  return query;
end;

private macro GetQueryForBlockCert(OnDate:date, BlockDate:date, BlockClass:integer, OnlyIssuerResident:bool, NotSum:bool)
  var query = " SUM(0) ";
  var NotSum_ = false;

  if( ( ValType(NotSum) != V_UNDEF ) AND NotSum == True)
    NotSum_ = true;
  end;
  if(NotSum_)
    query = " (0) ";
  end;

  if(OnDate >= BlockDate)
    query = "                 SUM(CASE WHEN ";
    if(NotSum_)
      query = "                 (CASE WHEN ";
    end;

    if(BlockClass == LLCLASS_KIND_BLOCK_CB_ENCUMBER711)
      query = query + " ( dpac.t_IsTrade = 'X' OR ";
    end;

    query = query + "                               EXISTS(SELECT 1 "
                  + "                                            FROM ddepoatvl_dbt atvl "
                  + "                                           WHERE atvl.t_IsType = CHR(0) "
                  + "                                             AND atvl.t_ID = dacntPart.t_AutoKey "
                  + "                                             AND atvl.t_AttrNum = 6 " //DEPOATTR_ATTNUM_BLOCK
                  + "                                             AND atvl.t_Value IN (SELECT TO_CHAR(clsv.t_Element) "
                  + "                                                                    FROM dllclsval_dbt clsv "
                  + "                                                                   WHERE clsv.t_Classificator = "+BlockClass+")"
                  + "                                         ) ";

    if(OnlyIssuerResident)
      query = query + "                          AND NOT EXISTS(SELECT 1 FROM dparty_dbt ptiss WHERE ptiss.t_PartyID = rsb_deals.GetFicertIssuer(vficert.t_FiCertID) AND ptiss.t_NotResident = 'X') ";
    end;

    if(BlockClass == LLCLASS_KIND_BLOCK_CB_ENCUMBER711)
      query = query + " )";
    end;

    query = query + "                               THEN vficert.t_Copies "
                  + "                          ELSE 0 END "
                  + "                    ) " ;
  end;

  return query;
end;

private macro GetQueryForValBlockCert(OnDate:date, BlockDate:date, Block:integer, OnlyIssuerResident:bool, NotSum:bool)
  var query = " SUM(0) ";
  var NotSum_ = false;
//DebugBreak;
  if( ( ValType(NotSum) != V_UNDEF ) AND NotSum == True)
    NotSum_ = true;
  end;
  if(NotSum_)
    query = " (0) ";
  end;

  if(OnDate >= BlockDate)
    query = "                 SUM(CASE WHEN ";
    if(NotSum_)
      query = "                 (CASE WHEN ";
    end;

    query = query + "                               EXISTS(SELECT 1 "
                  + "                                            FROM ddepoatvl_dbt atvl "
                  + "                                           WHERE atvl.t_IsType = CHR(0) "
                  + "                                             AND atvl.t_ID = dacntPart.t_AutoKey "
                  + "                                             AND atvl.t_AttrNum = 6 " //DEPOATTR_ATTNUM_BLOCK
                  + "                                             AND atvl.t_Value  = TO_CHAR("+Block+"))";
                                                                    
    if(OnlyIssuerResident)
      query = query + "                          AND NOT EXISTS(SELECT 1 FROM dparty_dbt ptiss WHERE ptiss.t_PartyID = rsb_deals.GetFicertIssuer(vficert.t_FiCertID) AND ptiss.t_NotResident = 'X') ";
    end;

    query = query + "                               THEN vficert.t_Copies "
                  + "                          ELSE 0 END "
                  + "                    ) " ;
  end;

  return query;
end;

/* ************************************************************** */
/* Класс сбора ранее загруженных данных по закладным (раздел 1.3) */
/* ************************************************************** */
private class C_711Bank_Loaded(flt_)
  private var fltr = flt_;
  private var tools = C_711Tools();

  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var LoadingDateSQL = GetSQLDate(fltr.RepDate+1);

    query = "INSERT /*+ parallel (8) */ INTO d711avoir_tmp (" +
                            "  T_ISSUERNAME" +
                            ", T_ISSUERINN" +
                            ", T_ISSUERINN_TIN" +
                            ", T_ISSUERINN_MARK" +
                            ", T_ISSUERNOTRESCODE" +
                            ", T_CFI" +
                            ", T_ISSUEROGRN" +
                            ", T_ISSUERCOUNTRYCODE" +
                            ", T_CODE711" +
                            ", T_LSIN" +
                            ", T_FACEVALUEFICODE" +
                            ", T_FACEVALUE" +
                            ", T_OURAMOUNT" +
                            ", T_ISSUERAMOUNT" +
                                       ")" +
                        " (SELECT /*+ parallel (8) */"                                                        
                            "  T_ISSUERNAME" +
                            ", T_ISSUERINN" +
                            ", T_ISSUERINN_TIN" +
                            ", T_ISSUERINN_MARK" +
                            ", T_ISSUERNOTRESCODE" +
                            ", T_CFI" +
                            ", T_ISSUEROGRN" +
                            ", T_ISSUERCOUNTRYCODE" +
                            ", T_CODE711" +
                            ", T_LSIN" +
                            ", T_FACEVALUEFICODE" +
                            ", T_FACEVALUE" +
                            ", T_OURAMOUNT" +
                            ", T_ISSUERAMOUNT" +
                       "    FROM D711AVOIR_MORTGAGE_DBT WHERE T_LOADINGDATE = " + LoadingDateSQL + ")";

    SQL_Execute(query, "Сбор данных по закладным, ранее загруженным в систему", true );
  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    return "SELECT * FROM d711avoir_tmp";
  end;
end;

/* ********************************************** */
/* Класс сбора данных на счетах номинального держателя (раздел 1.1) */
/* ********************************************** */
private class C_711LORO(flt_)
  private var fltr = flt_;
  private var tools = C_711Tools();

  private macro InsertNote(autoKeyAvoir, flag, column, note)
    var query = "INSERT INTO d711avoir_prot_tmp (t_autokeyavoir, t_flag, t_column, t_note) VALUES("
               +String(autoKeyAvoir)+",'"+flag+"','"+column+"','"+note+"')";

    SQL_Execute(query, "Протокол");
  end;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "";
    var pt:TRecHandler;
    var count = 0;
    var CorrespName = "", CorrespINN = "", CorrespKPP = "", CorrespCountryCode = "", CorrespMark = "", CorrespINN_Mark = "", CorrespINN_TIN = "", CorrespNotResCode = "",
        IssuerName = "", IssuerINN = "", IssuerKPP = "", IssuerCountryCode = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "", Code711 = "", LSIN = "", ISIN = "", FaceValueFiCode = "",
        StoragePlaceName = "", StoragePlaceCountryCode = "", StoragePlaceINN = "", StoragePlaceKPP = "", StoragePlaceOGRN = "", StoragePlaceLicense = "", StoragePlaceMark = "", StoragePlaceINN_Mark = "", StoragePlaceINN_TIN = "", StoragePlaceNotResCode = "",
        FaceValue = $0.0, FaceValuePoint = 0, IsEmissive = false, CFI = "", note;

    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_Corresp, t_CorrespINN, "
                        +" t_Issuer, t_FIID, t_Code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint, "
                        +" t_StoragePlace, t_StoragePlaceINN, t_StoragePlaceOGRN, t_OurAmount, t_RepoAmount, t_IssuerOGRN, t_CorrespOGRN FROM d711avoir_tmp");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      CorrespName             = "";
      CorrespINN              = dataSet.CorrespINN;
      CorrespINN_Mark         = "";
      CorrespINN_TIN          = "";
      CorrespNotResCode       = "";
      CorrespKPP              = "";
      CorrespCountryCode      = "";
      CorrespMark             = "";
      IssuerName              = "";
      IssuerINN               = dataSet.IssuerINN;
      IssuerINN_Mark          = "";
      IssuerINN_TIN           = "";
      IssuerNotResCode        = "";
      IssuerKPP               = "";
      IssuerCountryCode       = "";
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      StoragePlaceName        = "";
      StoragePlaceCountryCode = "";
      StoragePlaceINN         = "";
      StoragePlaceINN_Mark    = "";
      StoragePlaceINN_TIN     = "";
      StoragePlaceNotResCode  = "";
      StoragePlaceOGRN        = "";
      StoragePlaceKPP         = "";
      StoragePlaceLicense     = "";
      StoragePlaceMark        = "";
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;

      count = count + 1;

      if((fltr.BegDate < DATE_01_04_2018) and (Code711 != "") and (Index("SN1,SN2,SN3,SN4", Code711) != 0))
        Code711 = "";
      end;

      pt = TRecHandler("party.dbt");
      // Корреспондент
      if (ПолучитьСубъекта(dataSet.Corresp, pt) == 0)
        CorrespName = tools.GetPartyName(pt, true);
        tools.SplitINN_KPP(pt, CorrespINN, @CorrespINN, @CorrespKPP, @CorrespINN_TIN, @CorrespNotResCode);
        CorrespCountryCode = tools.GetCountryCode(pt);
        CorrespMark = tools.GetCorrespMark(pt);
        CorrespINN_Mark = tools.GetCorrespINN_Mark(pt);

        if ((dataSet.CorrespOGRN == "") and (pt.rec.NotResident != "X"))
          note = "Для субъекта " + GetCodeParty(pt.rec.PartyID, 1) + " " + pt.rec.ShortName + " не найден код ОГРН";
          InsertNote(dataSet.AutoKey, "?", "4", note);
        end;
      end;
      // Эмитент
      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotResCode);
        IssuerCountryCode = tools.GetCountryCode(pt);
        IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);
        

        if ((dataSet.IssuerOGRN == "") and (pt.rec.NotResident != "X"))
          note = "Для субъекта " + GetCodeParty(pt.rec.PartyID, 1) + " " + pt.rec.ShortName + " не найден код ОГРН";
          InsertNote(dataSet.AutoKey, "?", "10", note);
        end;
      end;
      
      // Выпуск
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if (ПолучитьФинИн(dataSet.FIID, Fininstr) == 0)
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
        elif (not IsEmissive)
          if(FI_IsISU(Fininstr))
            LSIN = tools.GetRULESREGXID(dataSet.FIID);
          else
            LSIN = "";
          end;

          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

      if((IssuerCountryCode != "") AND (IssuerCountryCode != "643"))
        LSIN = "";
      end;

      if((Code711 == "DR") OR (Code711 == "DR1") OR (Code711 == "DR2")) // депозитарная расписка
        LSIN = tools.GetLSINDEPO(dataSet.FIID);
      end;

      // Mесто Xранения
      // Если вид ц/б = документарная И место хранения ц/б = 'Наш банк', то НЕ заполняется
      if ((dataSet.FIID == -1) or (Fininstr.rec.Settlement_Code != 1) or not tools.IsOurBank(dataSet.StoragePlace))
        if (ПолучитьСубъекта(dataSet.StoragePlace, pt) == 0)
          StoragePlaceName = tools.GetPartyName(pt);
          tools.SplitINN_KPP(pt, dataSet.StoragePlaceINN, @StoragePlaceINN, @StoragePlaceKPP, @StoragePlaceINN_TIN, @StoragePlaceNotResCode);
          StoragePlaceOGRN = dataSet.StoragePlaceOGRN;
          StoragePlaceCountryCode = tools.GetCountryCode(pt);

          if ((Fininstr.rec.Issuer == dataSet.StoragePlace) or (pt.rec.NotResident == "X"))
            StoragePlaceLicense = "";
          else
            StoragePlaceLicense = tools.GetStoragePlaceLicense(pt, Code711);
          end;

          StoragePlaceMark = tools.GetStoragePlaceMark(pt, dataSet.FIID);
          StoragePlaceINN_Mark = tools.GetStoragePlaceINN_Mark(pt);
        end;
      end;

      queryUpd = "UPDATE d711avoir_tmp SET "
                + " t_CorrespName = " + tools.GetSQLStr(CorrespName) + ", "
                + " t_CorrespINN = " + tools.GetSQLStr(CorrespINN) + ", "
                + " t_CorrespINN_Mark = " + tools.GetSQLStr(CorrespINN_Mark) + ", "
                + " t_CorrespINN_TIN = " + tools.GetSQLStr(CorrespINN_TIN) + ", "
                + " t_CorrespNotResCode = " + tools.GetSQLStr(CorrespNotResCode) + ", "
                + " t_CorrespKPP = " + tools.GetSQLStr(CorrespKPP) + ", "
                + " t_CorrespCountryCode = " + tools.GetSQLStr(CorrespCountryCode) + ", "
                + " t_CorrespMark = " + tools.GetSQLStr(CorrespMark) + ", "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_Code711 = " + tools.GetSQLStr(Code711) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + IIF(FaceValue == $0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + " t_StoragePlaceName = " + tools.GetSQLStr(StoragePlaceName) + ", "
                + " t_StoragePlaceCountryCode = " + tools.GetSQLStr(StoragePlaceCountryCode) + ", "
                + " t_StoragePlaceINN = " + tools.GetSQLStr(StoragePlaceINN) + ", "
                + " t_StoragePlaceINN_Mark = " + tools.GetSQLStr(StoragePlaceINN_Mark) + ", "
                + " t_StoragePlaceINN_TIN = " + tools.GetSQLStr(StoragePlaceINN_TIN) + ", "
                + " t_StoragePlaceNotResCode = " + tools.GetSQLStr(StoragePlaceNotResCode) + ", "
                + " t_StoragePlaceKPP = " + tools.GetSQLStr(StoragePlaceKPP) + ", "
                + " t_StoragePlaceOGRN = " + tools.GetSQLStr(StoragePlaceOGRN) + ", "
                + " t_StoragePlaceLicense = " + tools.GetSQLStr(StoragePlaceLicense) + ", "
                + " t_StoragePlaceMark = " + tools.GetSQLStr(StoragePlaceMark)+ ","
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных на счетах номинальных держателей, " + String(count), false );
    end;
  end;

  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);

    query = "INSERT INTO d711avoir_tmp ("
                                      + " T_CORRESP,"
                                      + " T_CORRESPNAME,"
                                      + " T_CORRESPINN,"
                                      + " T_CORRESPINN_MARK,"
                                      + " T_CORRESPINN_TIN,"
                                      + " T_CORRESPNOTRESCODE,"
                                      + " T_CORRESPKPP,"
                                      + " T_CORRESPOGRN,"
                                      + " T_CORRESPCOUNTRYCODE,"
                                      + " T_CORRESPLICENSE,"
                                      + " T_CORRESPMARK,"
                                      + " T_CORRESPBRIEFCODE,"
                                      + " T_AMOUNT,"
                                      + " T_ISSUER,"
                                      + " T_ISSUERNAME,"
                                      + " T_ISSUERINN,"
                                      + " T_ISSUERINN_MARK,"
                                      + " T_ISSUERINN_TIN,"
                                      + " T_ISSUERNOTRESCODE,"
                                      + " T_ISSUERKPP,"
                                      + " T_ISSUEROGRN,"
                                      + " T_ISSUERCOUNTRYCODE,"
                                      + " T_FIID,"
                                      + " T_CODE711,"
                                      + " T_LSIN,"
                                      + " T_ISIN,"
                                      + " T_FACEVALUEFICODE,"
                                      + " T_FACEVALUE,"
                                      + " T_FACEVALUEPOINT,"
                                      + " T_STORAGEPLACE,"
                                      + " T_STORAGEPLACENAME,"
                                      + " T_STORAGEPLACEINN,"
                                      + " T_STORAGEPLACEINN_MARK,"
                                      + " T_STORAGEPLACEINN_TIN,"
                                      + " T_STORAGEPLACENOTRESCODE,"
                                      + " T_STORAGEPLACEKPP,"
                                      + " T_STORAGEPLACEOGRN,"
                                      + " T_STORAGEPLACECOUNTRYCODE,"
                                      + " T_STORAGEPLACELICENSE,"
                                      + " T_STORAGEPLACEMARK,"
                                      + " T_STORAGEPLACEBRIEFCODE,"
                                      + " T_PAWNAMOUNT,"
                                      + " T_TRADEAMOUNT,"
                                      + " T_CORPRESTRAMOUNT,"
                                      + " T_OPERBANAMOUNT,"
                                      + " T_ARRESTAMOUNT, "
                                      + " T_ENCUMBERAMOUNT, "
                                      + " T_ESCROWAMOUNT, "
                                      + " T_OBOSOBFZAMOUNT, "
                                      + " T_OBOSOBBRAMOUNT "
                                      + ")"
                      + " (SELECT stor.t_OwnerCorp, "                                                              // T_CORRESP
                      + "         CHR(1), "                                                                        // T_CORRESPNAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_OwnerCorp, 16), "                               // T_CORRESPINN
                      + "         CHR(1),"                                                                         // T_CORRESPINN_MARK
                      + "         CHR(1),"                                                                         // T_CORRESPINN_TIN
                      + "         CHR(1),"                                                                         // T_CORRESPNOTRESCODE
                      + "         CHR(1),"                                                                         // T_CORRESPKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_OwnerCorp, 27), "                               // T_CORRESPOGRN
                      + "         CHR(1),"                                                                         // T_CORRESPCOUNTRYCODE
                      + "         case when corparty.t_NotResident != chr(0)"
                      + "              then chr(1)"
                      + "              else rsi_rsbparty.GetPartyCode(stor.t_OwnerCorp, 17)"
                      + "           end, "                                                                         // T_CORRESPLICENSE
                      + "         CHR(0),"                                                                         // T_CORRESPMARK
                      + "         stor.t_BriefCodeCorp, "                                                          // T_CORRESPBRIEFCODE
                      + "         stor.t_Rest,"                                                                    // T_AMOUNT
                      + "         issuer.t_Issuer,"                                                                // T_ISSUER
                      + "         CHR(1),"                                                                         // T_ISSUERNAME
                      + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16), "                                // T_ISSUERINN
                      + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
                      + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
                      + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
                      + "         CHR(1),"                                                                         // T_ISSUERKPP
                      + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27), "                                // T_ISSUEROGRN
                      + "         CHR(1),"                                                                         // T_ISSUERCOUNTRYCODE
                      + "         avr.t_FIID, "                                                                    // T_FIID
                      + "         rsb_secur.GetObjAttrName(12, 1,"
                      + "                                  rsb_secur.GetMainObjAttr(12,"
                      + "                                                           LPAD(avr.t_FIID, 10, '0'),"
                      + "                                                           1, "+RepDateSQL+")),"          // T_CODE711
                      + "         avr.T_LSIN, "                                                                    // T_LSIN
                      + "         avr.T_ISIN, "                                                                    // T_ISIN
                      + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), "
                      + "             CHR(1)), "                                                                   // T_FACEVALUEFICODE
                      + "         NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+" ), 0.0),"         // T_FACEVALUE
                      + "         fin.T_POINT+2, "                                                                 // T_FACEVALUEPOINT
                      + "         stor.t_StoragePlace,"                                                            // T_STORAGEPLACE
                      + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                             // T_STORAGEPLACEINN
                      + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
                      + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
                      + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
                      + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                             // T_STORAGEPLACEOGRN
                      + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
                      + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
                      + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
                      + "         NVL((SELECT corchem.t_CorAccount FROM dcorschem_dbt corchem"
                      + "               WHERE corchem.t_Account = stor.t_BriefCode"
                      + "                 AND corchem.t_FIID = -1"
                      + "                 AND corchem.t_Department = stor.t_Department), CHR(1)),"                 // T_STORAGEPLACEBRIEFCODE
                      + "         stor.t_RestPawn,"                                                                // T_PAWNAMOUNT
                      + "         stor.t_RestTrade,"                                                               // T_TRADEAMOUNT
                      + "         stor.t_RestCorpRestr,"                                                           // T_CORPRESTRAMOUNT
                      + "         stor.t_RestOperBan,"                                                             // T_OPERBANAMOUNT
                      + "         stor.t_RestArrest, "                                                             // T_ARRESTAMOUNT
                      + "         stor.t_EncumberRest, "                                                           // T_ENCUMBERAMOUNT
                      + "         stor.t_Escrow, "                                                                 // T_ESCROW
                      + "         stor.t_ObosobFZRest, "                                                           // T_OBOSOBFZAMOUNT
                      + "         stor.t_ObosobBRRest "                                                            //T_OBOSOBBRAMOUNT
                      + "    FROM davoiriss_dbt avr, dfininstr_dbt fin, dparty_dbt corparty,"
                      + "         (SELECT SUM(rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) as T_Rest,"
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
                      +                   GetQueryForBlockSub(fltr.RepDate, BLOCKARREST_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
                      +                   GetQueryForBlockSub(BLOCKAMOUNT_DATE, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
                      +                   GetQueryForTradeSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL) + " as T_RestTrade, "
                      +                   GetQueryForValBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_ESCROW, false) + " as T_Escrow, "
                      +                   GetQueryForValBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_OBOSOBL, false) + " as t_ObosobFZRest, "
                      +                   GetQueryForValBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_OBOSOBBR, false) + " as t_ObosobBRRest, "
                      + "                 dacnt.T_OWNER as t_OwnerCorp,"
                      + "                 dacnt.t_BriefCode as t_BriefCodeCorp,"
                      + "                 acc.t_Code_Currency as T_FIID,"
                      + "                 dacntAct.t_Owner as t_StoragePlace,"
                      + "                 dacnt.t_Department as t_Department,"
                      + "                 dacntAct.t_BriefCode as t_BriefCode"
                      + "            FROM ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, daccvanl_dbt accvanl, daccsub_dbt accsub, daccount_dbt accAct, ddepoacnt_dbt dacntAct"
                      + "           WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
                      + "             AND dacnt.t_opendate <= "+RepDateSQL
                      + "             AND dacnt.t_department IN ("+fltr.Departments+")"
                      + "             AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+") != 1 " // НЕ закрытые"
                      + "             AND rsb_depo.depokindtype(dacnt.T_AUTOKEY) IN ("+String(OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER)+", "+String(OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER)+")" // Номинального держателя
                      + "             AND dacnt.T_KIND = 2 " // passive
                      + "             AND dpac.t_ID = dacnt.t_Type "
                      + "             AND acc.t_deporoot = dacnt.T_AUTOKEY"
                      + "             AND acc.t_chapter = 5"
                      + "             AND dacntPart.t_AutoKey = acc.t_DepoAcc "
                      //             ----------- Место хранения ---
                      + "             AND accvanl.t_Account = acc.t_Account"
                      + "             AND accvanl.t_AnaliticsID = 2"
                      + "             AND accvanl.t_FIID = acc.t_Code_Currency"
                      + "             AND accvanl.t_Chapter = acc.t_Chapter"
                      + "             AND accsub.t_AccAnaliticsID = accvanl.t_AccAnaliticsID"
                      + "             AND accsub.t_SpecialType = 0"
                      + "             AND accAct.t_Chapter = acc.t_Chapter"
                      + "             AND accAct.t_Code_Currency = acc.t_Code_Currency"
                      + "             AND accAct.t_Account = accsub.t_SubAccountCode"
                      + "             AND accAct.t_Open_Date <= "+RepDateSQL
                      + "             AND dacntAct.t_autokey = accAct.t_deporoot"
                      + "          GROUP BY dacnt.T_OWNER, dacnt.t_BriefCode, dacnt.t_Department, acc.t_Code_Currency, dacntAct.t_Owner, dacntAct.t_BriefCode) stor,"
                      +           SQL_QueryIssuer+" issuer"
                      + "  WHERE avr.t_FIID = stor.t_FIID"
                      + "    AND fin.T_FIID = avr.T_FIID"
                      + "    AND corparty.T_PARTYID=stor.t_OwnerCorp"
                      + "    AND issuer.t_FIID = fin.T_FIID)"
                      + "UNION ALL"
                      + " (SELECT stor.t_OwnerCorp, "                                                              // T_CORRESP
                      + "         CHR(1), "                                                                        // T_CORRESPNAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_OwnerCorp, 16), "                               // T_CORRESPINN
                      + "         CHR(1),"                                                                         // T_CORRESPINN_MARK
                      + "         CHR(1),"                                                                         // T_CORRESPINN_TIN
                      + "         CHR(1),"                                                                         // T_CORRESPNOTRESCODE
                      + "         CHR(1),"                                                                         // T_CORRESPKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_OwnerCorp, 27), "                               // T_CORRESPOGRN
                      + "         CHR(1),"                                                                         // T_CORRESPCOUNTRYCODE
                      + "         case when corparty.t_NotResident != chr(0)"
                      + "              then chr(1)"
                      + "              else rsi_rsbparty.GetPartyCode(stor.t_OwnerCorp, 17)"
                      + "           end, "                                                                         // T_CORRESPLICENSE
                      + "         CHR(0),"                                                                         // T_CORRESPMARK
                      + "         stor.t_BriefCodeCorp, "                                                          // T_CORRESPBRIEFCODE
                      + "         stor.t_Rest,"                                                                    // T_AMOUNT
                      + "         stor.t_Issuer, "                                                                 // T_ISSUER
                      + "         CHR(1),"                                                                         // T_ISSUERNAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_Issuer, 16), "                                  // T_ISSUERINN
                      + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
                      + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
                      + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
                      + "         CHR(1),"                                                                         // T_ISSUERKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_Issuer, 27), "                                  // T_ISSUEROGRN
                      + "         CHR(1),"                                                                         // T_ISSUERCOUNTRYCODE
                      + "         avr.t_FIID, "                                                                    // T_FIID
                      + "         rsb_secur.GetObjAttrName(12, 1,"
                      + "                                  rsb_secur.GetMainObjAttr(12,"
                      + "                                                           LPAD(avr.t_FIID, 10, '0'),"
                      + "                                                           1, "+RepDateSQL+")),"          // T_CODE711
                      + "         avr.T_LSIN, "                                                                    // T_LSIN
                      + "         avr.T_ISIN, "                                                                    // T_ISIN
                      + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = stor.T_FACEVALUEFI),"
                      + "             CHR(1)), "                                                                   // T_FACEVALUEFICODE
                      + "         stor.T_FACEVALUE,"                                                               // T_FACEVALUE
                      + "         2, "                                                                             // T_FACEVALUEPOINT
                      + "         stor.t_StoragePlace,"                                                            // T_STORAGEPLACE
                      + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                             // T_STORAGEPLACEINN
                      + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
                      + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
                      + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
                      + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                             // T_STORAGEPLACEOGRN
                      + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
                      + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
                      + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
                      + "         NVL((SELECT corchem.t_CorAccount FROM dcorschem_dbt corchem"
                      + "               WHERE corchem.t_Account = stor.t_BriefCode"
                      + "                 AND corchem.t_FIID = -1"
                      + "                 AND corchem.t_Department = stor.t_Department), CHR(1)),"                 // T_STORAGEPLACEBRIEFCODE
                      + "         stor.t_RestPawn,"                                                                // T_PAWNAMOUNT
                      + "         stor.t_RestTrade,"                                                               // T_TRADEAMOUNT
                      + "         stor.t_RestCorpRestr,"                                                           // T_CORPRESTRAMOUNT
                      + "         stor.t_RestOperBan,"                                                             // T_OPERBANAMOUNT
                      + "         stor.t_RestArrest, "                                                             // T_ARRESTAMOUNT
                      + "         stor.t_EncumberRest,"                                                            // T_ENCUMBERAMOUNT
                      + "         stor.t_Escrow, "                                                                 // T_ESCROW
                      + "         stor.t_ObosobFZRest, "                                                           // T_OBOSOBFZAMOUNT
                      + "         stor.t_ObosobBRRest "                                                            //T_OBOSOBBRAMOUNT
                      + "   FROM davoiriss_dbt avr, dparty_dbt corparty,"
                      + "        (SELECT SUM(vficert.t_Copies) as T_Rest,"
                      + "                SUM (rsb_depo.icnominal(ic.t_InvCardID,"+RepDateSQL+", 1)) AS T_FaceValue, "
                      +                  GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
                      +                  GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
                      +                  GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
                      +                  GetQueryForBlockCert(fltr.RepDate, BLOCKARREST_DATE, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
                      +                  GetQueryForBlockCert(BLOCKAMOUNT_DATE, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
                      +                  GetQueryForTradeCert(fltr.BegDate, BLOCKAMOUNT_DATE) + " as T_RestTrade, "
                      +                  GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_ESCROW, false) + " as T_Escrow, "
                      +                  GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_OBOSOBL, false) + " as t_ObosobFZRest, "
                      +                  GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_OBOSOBBR, false) + " as t_ObosobBRRest, "
                      + "                dacnt.T_OWNER as t_OwnerCorp,"
                      + "                dacnt.t_BriefCode as t_BriefCodeCorp,"
                      + "                vficert.t_FIID as T_FIID,"
                      + "                vficert.t_FaceValueFI as T_FaceValueFI,"
                      + "                rsb_deals.GetFicertIssuer(vficert.t_FiCertID) as T_Issuer,"
                      + "                dacnt.t_Department as t_Department,"
                      + "                dacntAct.t_Owner as t_StoragePlace,"
                      + "                dacntAct.t_BriefCode as t_BriefCode"
                      + "          FROM ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, dinvcard_dbt ic, dv_ficert_dbt vficert, daccount_dbt accAct, ddepoacnt_dbt dacntAct, dfininstr_dbt fin"
                      + "         WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
                      + "           AND dacnt.t_opendate <= "+RepDateSQL
                      + "           AND dacnt.t_department IN ("+fltr.Departments+")"
                      + "           AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+" ) != 1 " // НЕ закрытые"
                      + "           AND rsb_depo.depokindtype(dacnt.T_AUTOKEY) IN ("+String(OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER)+", "+String(OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER)+")" //  Номинального держателя
                      + "           AND dacnt.T_KIND = 2 " // passive
                      + "           AND dpac.t_ID = dacnt.t_Type "
                      + "           AND acc.t_deporoot = dacnt.T_AUTOKEY"
                      + "           AND acc.t_chapter = 5"
                      + "           AND dacntPart.t_AutoKey = acc.t_DepoAcc "
                      //           ----------- Место хранения ---
                      + "           AND rsb_depo.icstatus(ic.t_InvCardID, "+RepDateSQL+") = " + INVCARD_STATUS_INCUSTODY // на хранении
                      + "           AND rsb_depo.icaccountid(ic.t_InvCardID, 2, "+RepDateSQL+") = acc.t_AccountID "
                      + "           AND vficert.t_FiCertID = ic.t_FiCertID "
                      + "           AND accAct.t_Chapter = acc.t_Chapter"
                      + "           AND accAct.t_Code_Currency = acc.t_Code_Currency"
                      + "           AND accAct.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 1, "+RepDateSQL+")"
                      + "           AND accAct.t_Open_Date <= "+RepDateSQL
                      + "           AND dacntAct.t_autokey = accAct.t_deporoot"
                      + "           AND fin.t_FIID = vficert.t_FIID"
                      + "        GROUP BY dacnt.T_OWNER, dacnt.t_BriefCode, vficert.t_FIID, fin.t_AvoirKind, rsb_deals.GetFicertIssuer(vficert.t_FiCertID), dacntAct.t_Owner, vficert.t_FaceValueFI, dacntAct.t_BriefCode, dacnt.t_Department) stor"
                      + "  WHERE avr.t_FIID = stor.t_FIID"
                      + "    AND corparty.T_PARTYID=stor.t_OwnerCorp )";

    //println("1.1: " + query);
    SQL_Execute(query, "Сбор данных о цб, учитываемых на междепозитарных счетах номинальных держателей", true );

    SQL_Execute("DELETE FROM d711avoir_tmp WHERE T_AMOUNT = 0", "Удаление информации о лишних записях", false );

    PostProcess();
  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    var query = "SELECT group711.T_AMOUNT as t_Amount, "
              + "       group711.t_TradeAmount as t_TradeAmount, "
              + "       group711.t_CorpRestrAmount as t_CorpRestrAmount, "
              + "       group711.t_OperBanAmount as t_OperBanAmount, "
              + "       group711.t_ArrestAmount as t_ArrestAmount, "
              + "       group711.t_PawnAmount as t_PawnAmount, "
              + "       group711.t_EncumberAmount as t_EncumberAmount, "
              + "       t.* "
              + "  FROM (SELECT min(t_autokey) t_autokey, "
              + "               SUM(T_AMOUNT) as t_amount, "
              + "               SUM(T_TRADEAMOUNT) AS t_TradeAmount, "
              + "               SUM(T_CORPRESTRAMOUNT) AS t_CorpRestrAmount, "
              + "               SUM(T_OPERBANAMOUNT) AS t_OperBanAmount, "
              + "               SUM(T_ARRESTAMOUNT) AS t_ArrestAmount, "
              + "               SUM(T_PAWNAMOUNT) AS t_PawnAmount, "
              + "               SUM(T_ENCUMBERAMOUNT) as t_EncumberAmount, "
              //     Счет номинального держателя
              + "               T_CORRESP,"
              + "               T_CORRESPBRIEFCODE,"
              //     Выпуск
              + "               T_FIID,"
              + "               T_ISSUER,T_FACEVALUEFICODE, T_FACEVALUE," // добавил эмитента, т.к. для ИК он берется не из выпуска, а из ИК
              //     Место хранение
              + "               T_STORAGEPLACE,"
              + "               T_STORAGEPLACEBRIEFCODE"
              + "          FROM d711avoir_tmp "
              + "         GROUP BY T_CORRESP, T_CORRESPBRIEFCODE, T_FIID, T_ISSUER, T_FACEVALUEFICODE, T_FACEVALUE, T_STORAGEPLACE, T_STORAGEPLACEBRIEFCODE ) group711,"
              + "        d711avoir_tmp t"
              + " WHERE t.t_autokey = group711.t_autokey"
              + " ORDER BY t.t_CorrespName, t.t_IssuerName, t.t_Code711, t.t_LSIN, t.t_ISIN, t.t_FaceValueFICode, t.t_StoragePlaceName";
    return query;
  end;
end;

/* ********************************************** */
/* Класс сбора данных ц/б клиентов (раздел 1.2)   */
/* ********************************************** */
private class C_711Client(flt_)
  private var fltr = flt_;
  private var tools = C_711Tools();

  private macro InsertNote(autoKeyAvoir, flag, column, note)
    var query = "INSERT INTO d711avoir_prot_tmp (t_autokeyavoir, t_flag, t_column, t_note) VALUES("
               +String(autoKeyAvoir)+",'"+flag+"','"+column+"','"+note+"')";

    SQL_Execute(query, "Протокол");
  end;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "";
    var pt:TRecHandler;
    var count = 0;
    var IssuerName = "", IssuerINN = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "", IssuerKPP = "", IssuerCountryCode = "", Code711 = "", LSIN = "", ISIN = "", FaceValueFiCode = "", DepoAccKind = "", Sector = "",
        StoragePlaceName = "", StoragePlaceCountryCode = "", StoragePlaceINN = "", StoragePlaceKPP = "", StoragePlaceLicense = "", StoragePlaceMark = "", StoragePlaceINN_Mark = "", StoragePlaceINN_TIN = "", StoragePlaceNotResCode = "",
        StoragePlaceOGRN = "", FaceValue = $0.0, FaceValuePoint = 0, CorrespCountryCode = "", NotResLicenseDate = "", OrganGiveLicense = "", CFI = "", IsEmissive = false;

    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_IssuerName, t_Issuer, t_IssuerCountryCode, t_FIID, t_Code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint, "
                        +" t_StoragePlace, t_StoragePlaceINN, t_StoragePlaceOGRN, t_DepoAccKind, T_Sector, t_Corresp, t_IssuerOGRN FROM d711avoir_tmp");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      IssuerName              = dataSet.IssuerName;
      IssuerINN               = dataSet.IssuerINN;
      IssuerINN_Mark          = "";
      IssuerINN_TIN           = "";
      IssuerNotResCode        = "";
      IssuerKPP               = "";
      IssuerCountryCode       = dataSet.IssuerCountryCode;
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      StoragePlaceName        = "";
      StoragePlaceCountryCode = "";
      StoragePlaceINN         = "";
      StoragePlaceINN_Mark    = "";
      StoragePlaceINN_TIN     = "";
      StoragePlaceNotResCode  = "";
      StoragePlaceOGRN        = "";
      StoragePlaceKPP         = "";
      StoragePlaceLicense     = "";
      StoragePlaceMark        = "";
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;
      DepoAccKind             = dataSet.DepoAccKind;
      Sector                  = dataSet.Sector;
      CorrespCountryCode      = "";
      NotResLicenseDate       = "";
      OrganGiveLicense        = "";

      count = count + 1;

      if((fltr.BegDate < DATE_01_04_2018) and (Code711 != "") and (Index("SN1,SN2,SN3,SN4", Code711) != 0))
        Code711 = "";
      end;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (IssuerName == "Физические лица")
        if (IssuerCountryCode == tools.OUR_COUNTRY_CODE_LAT)
          IssuerINN = tools.UNKNOW_INN_RES_PHYS;
          IssuerINN_Mark = 3;
        else
          IssuerINN = tools.UNKNOW_INN_NOTRES_PHYS;
          IssuerINN_Mark = 4;
        end;
        IssuerCountryCode = DP_GetCountryByCodeLat3(IssuerCountryCode).CodeNum3;
      elif (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotResCode);
        IssuerCountryCode = tools.GetCountryCode(pt);
        IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);

        if ((dataSet.IssuerOGRN == "") and (pt.rec.NotResident != "X"))
          var note = "Для субъекта " + GetCodeParty(pt.rec.PartyID, 1) + " " + pt.rec.ShortName + " не найден код ОГРН";
          InsertNote(dataSet.AutoKey, "?", "4", note);
        end;
      end;

      // Владелец
      if (ПолучитьСубъекта(dataSet.Corresp, pt) == 0)
        CorrespCountryCode = tools.GetCountryCode(pt);
      end;

      // Выпуск
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if ((dataSet.FIID != -1) and (ПолучитьФинИн(dataSet.FIID, Fininstr) == 0))
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
        elif (not IsEmissive)
          if(FI_IsISU(Fininstr))
            LSIN = tools.GetRULESREGXID(dataSet.FIID);
          else
            LSIN = "";
          end;
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

      if((IssuerCountryCode != "") AND (IssuerCountryCode != "643"))
        LSIN = "";
      end;

      if((Code711 == "DR") OR (Code711 == "DR1") OR (Code711 == "DR2")) // депозитарная расписка
        LSIN = tools.GetLSINDEPO(dataSet.FIID);
      end;

      // Mесто Xранения
      if( ((dataSet.FIID == -1) or (Fininstr.rec.Settlement_Code == 1)) and (tools.IsOurBank(dataSet.StoragePlace)))
        // Если вид ц/б = документарная И место хранения ц/б = 'Наш банк', то НЕ заполняется
      else
        if (ПолучитьСубъекта(dataSet.StoragePlace, pt) == 0)
          StoragePlaceName = tools.GetPartyName(pt);
          tools.SplitINN_KPP(pt, dataSet.StoragePlaceINN, @StoragePlaceINN, @StoragePlaceKPP, @StoragePlaceINN_TIN, @StoragePlaceNotResCode);
          StoragePlaceOGRN = dataSet.StoragePlaceOGRN;
          StoragePlaceCountryCode = tools.GetCountryCode(pt);
          if(pt.rec.NotResident == "X")
             NotResLicenseDate  = tools.ПолучитьДатуПолученияЛицензии(pt.rec.PartyID,fltr.RepDate);
             OrganGiveLicense  = ReadNoteForObject(OBJTYPE_PARTY, UniID(pt, OBJTYPE_PARTY), 86/*Орган, выдавший лицензию*/);
          end;

          if (Fininstr.rec.Issuer == dataSet.StoragePlace)
            StoragePlaceLicense = "";
          elif(pt.rec.NotResident == "X")
            StoragePlaceLicense = tools.GetStoragePlaceLicense(pt, ""); //номер лицензии на право осуществления учета и перехода прав на ценные бумаги, указывается в "№ лицензии участника ОРЦБ"
          else
            StoragePlaceLicense = tools.GetStoragePlaceLicense(pt, Code711);
          end;
          StoragePlaceMark = tools.GetStoragePlaceMark(pt, dataSet.FIID);
          StoragePlaceINN_Mark = tools.GetStoragePlaceINN_Mark(pt);
        end;
      end;

      //
      DepoAccKind = tools.GetDepoAccKind(DepoAccKind);

      if((DepoAccKind != "OWNER")
     and (DepoAccKind != "DEPOPROG")
     and (DepoAccKind != "TRUSTEE")
     and (DepoAccKind != "HOLDER")
     and (DepoAccKind != "FAUTHOLDER")
     and (DepoAccKind != "SUBOWNER")
     and (DepoAccKind != "SUBTRUSTEE"))
        Sector = "000";
      end;

      queryUpd = "UPDATE d711avoir_tmp SET "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_Code711 = " + tools.GetSQLStr(Code711) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + IIF(FaceValue == $0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint) + ", "
                + " t_StoragePlaceName = " + tools.GetSQLStr(StoragePlaceName) + ", "
                + " t_StoragePlaceCountryCode = " + tools.GetSQLStr(StoragePlaceCountryCode) + ", "
                + " t_StoragePlaceINN = " + tools.GetSQLStr(StoragePlaceINN) + ", "
                + " t_StoragePlaceINN_Mark = " + tools.GetSQLStr(StoragePlaceINN_Mark) + ", "
                + " t_StoragePlaceINN_TIN = " + tools.GetSQLStr(StoragePlaceINN_TIN) + ", "
                + " t_StoragePlaceNotResCode = " + tools.GetSQLStr(StoragePlaceNotResCode) + ", "
                + " t_StoragePlaceKPP = " + tools.GetSQLStr(StoragePlaceKPP) + ", "
                + " t_StoragePlaceOGRN = " + tools.GetSQLStr(StoragePlaceOGRN) + ", "
                + " t_StoragePlaceLicense = " + tools.GetSQLStr(StoragePlaceLicense) + ", "
                + " t_StoragePlaceMark = " + tools.GetSQLStr(StoragePlaceMark) + ", "
                + " t_DepoAccKind = " + tools.GetSQLStr(DepoAccKind) + ", "
                + " t_Sector = " + tools.GetSQLStr(Sector) + ", "
                + " t_CorrespCountryCode = " + tools.GetSQLStr(CorrespCountryCode) + ", "
                + " t_NotResLicenseDate = " + tools.GetSQLStr(NotResLicenseDate) + ", "
                + " t_OrganGiveLicense = " + tools.GetSQLStr(OrganGiveLicense)+ ","
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных ц/б клиентов, " + String(count), false );
    end;
  end;

  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);

    query = "INSERT INTO d711avoir_tmp ( T_AMOUNT,"
                                      +" T_ISSUER,"
                                      +" T_ISSUERNAME,"
                                      +" T_ISSUERINN,"
                                      +" T_ISSUERINN_MARK, "
                                      +" T_ISSUERINN_TIN,"
                                      +" T_ISSUERNOTRESCODE,"
                                      +" T_ISSUERKPP,"
                                      +" T_ISSUEROGRN,"
                                      +" T_ISSUERCOUNTRYCODE,"
                                      +" T_FIID,"
                                      +" T_CODE711,"
                                      +" T_LSIN,"
                                      +" T_ISIN,"
                                      +" T_FACEVALUEFICODE,"
                                      +" T_FACEVALUE,"
                                      +" T_FACEVALUEPOINT,"
                                      +" T_STORAGEPLACE,"
                                      +" T_STORAGEPLACENAME,"
                                      +" T_STORAGEPLACEINN,"
                                      +" T_STORAGEPLACEINN_MARK,"
                                      +" T_STORAGEPLACEINN_TIN,"
                                      +" T_STORAGEPLACENOTRESCODE,"
                                      +" T_STORAGEPLACEKPP,"
                                      +" T_STORAGEPLACEOGRN,"
                                      +" T_STORAGEPLACECOUNTRYCODE,"
                                      +" T_STORAGEPLACELICENSE,"
                                      +" T_STORAGEPLACEMARK,"
                                      +" T_DEPOACCKIND,"
                                      +" T_SECTOR,"
                                      +" T_PAWNAMOUNT,"
                                      +" T_TRADEAMOUNT,"
                                      +" T_CORPRESTRAMOUNT,"
                                      +" T_OPERBANAMOUNT,"
                                      +" T_ARRESTAMOUNT, "
                                      +" T_ENCUMBERAMOUNT, "
                                      +" T_CORRESP, "
                                      +" T_CORRESPCOUNTRYCODE, "
                                      +" T_NOTRESLICENSEDATE, "
                                      +" T_ORGANGIVELICENSE, "
                                      +" T_ESCROWAMOUNT, "
                                      + " T_OBOSOBFZAMOUNT, "
                                      + " T_OBOSOBBRAMOUNT "
                                      + ")"
                      + " (SELECT stor.T_Rest,"                                                                                       // T_AMOUNT
                      + "         issuer.t_Issuer,"                                                                                   // T_ISSUER
                      + "         CHR(1),"                                                                                            // T_ISSUERNAME,
                      + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16),"                                                    // T_ISSUERINN
                      + "         CHR(1),"                                                                                            // T_ISSUERINN_MARK
                      + "         CHR(1),"                                                                                            // T_ISSUERINN_TIN
                      + "         CHR(1),"                                                                                            // T_ISSUERNOTRESCODE
                      + "         CHR(1),"                                                                                            // T_ISSUERKPP,
                      + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27),"                                                    // T_ISSUEROGRN
                      + "         CHR(1),"                                                                                            // T_ISSUERCOUNTRYCODE,
                      + "         avr.t_FIID as T_FIID,"                                                                              // T_FIID
                      + "         rsb_secur.GetObjAttrName(12, 1,"
                      + "                                  rsb_secur.GetMainObjAttr(12,"
                      + "                                                           LPAD(avr.t_FIID, 10, '0'),"
                      + "                                                           1, "+RepDateSQL+")),"                             // T_CODE711
                      + "         avr.T_LSIN,"                                                                                        // T_LSIN
                      + "         avr.T_ISIN,"                                                                                        // T_ISIN
                      + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI),"
                      + "             CHR(1)),"                                                                                       // T_FACEVALUEFICODE
                      + "         NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+" ), 0.0),"                            // T_FACEVALUE
                      + "         fin.T_POINT+2, "                                                                                    // T_FACEVALUEPOINT
                      + "         stor.t_StoragePlace,"                                                                               // T_STORAGEPLACE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACENAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                                                // T_STORAGEPLACEINN
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEINN_MARK
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEINN_TIN
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACENOTRESCODE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEKPP,
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                                                // T_STORAGEPLACEOGRN
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACECOUNTRYCODE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACELICENSE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEMARK
                      + "         (case when stor.t_IsTrade = 'X' then 'X'||TO_CHAR(stor.T_DepoAccKind) else TO_CHAR(stor.T_DepoAccKind) end), " // T_DEPOACCKIND
                      + "         NVL(rcb_objattr.getObjAttr(3, 61, rcb_objattr.makePartyId(stor.t_Owner), "+RepDateSQL+"), CHR(1))," // T_SECTOR
                      + "         stor.t_RestPawn,"                                                                                   // T_PAWNAMOUNT
                      + "         stor.t_RestTrade,"                                                                                  // T_TRADEAMOUNT
                      + "         stor.t_RestCorpRestr,"                                                                              // T_CORPRESTRAMOUNT
                      + "         stor.t_RestOperBan,"                                                                                // T_OPERBANAMOUNT
                      + "         stor.t_RestArrest, "                                                                                // T_ARRESTAMOUNT
                      + "         stor.t_EncumberRest, "                                                                              // T_ENCUMBERAMOUNT
                      + "         stor.t_Owner, "                                                                                     // T_CORRESP
                      + "         CHR(1), "                                                                                           // T_CORRESPCOUNTRYCODE
                      + "         CHR(1), "                                                                                           // T_NOTRESLICENSEDATE
                      + "         CHR(1), "                                                                                           // T_ORGANGIVELICENSE
                      + "         stor.t_Escrow, "                                                                                    // T_ESCROW
                      + "         stor.t_ObosobFZRest, "                                                                              // T_OBOSOBFZAMOUNT
                      + "         stor.t_ObosobBRRest "                                                                               // T_OBOSOBBRAMOUNT
                      + "    FROM davoiriss_dbt avr, dfininstr_dbt fin,"
                      + "         (SELECT SUM(rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) as T_Rest,"
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
                      +                   GetQueryForBlockSub(fltr.RepDate, BLOCKARREST_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
                      +                   GetQueryForBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
                      +                   GetQueryForTradeSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL) + " as T_RestTrade, "
                      +                   GetQueryForValBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_ESCROW, false) + " as T_Escrow, "
                      +                   GetQueryForValBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_OBOSOBL, false) + " as T_ObosobFZRest, "
                      +                   GetQueryForValBlockSub(fltr.BegDate, BLOCKAMOUNT_DATE, RepDateSQL, LLBLOCK_OBOSOBBR, false) + " as T_ObosobBRRest, "
                      + "                 acc.t_Code_Currency as T_FIID,"
                      + "                 rsb_depo.depokindtype(dacnt.T_AUTOKEY) as T_DepoAccKind,"
                      + "                 dacntAct.t_Owner as t_StoragePlace,"
                      + "                 dacnt.t_Owner as t_Owner, "
                      + "                 dpac.t_IsTrade as t_IsTrade "
                      + "            FROM ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, daccvanl_dbt accvanl, daccsub_dbt accsub, daccount_dbt accAct, ddepoacnt_dbt dacntAct"
                      + "           WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
                      + "             AND dacnt.t_opendate <= "+RepDateSQL
                      + "             AND dacnt.t_department IN ("+fltr.Departments+")"
                      + "             AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+") != 1 "// НЕ закрытые
                      + "             AND rsi_rsb_account.restac( acc.t_Account, acc.T_CODE_CURRENCY, "+RepDateSQL+", acc.t_Chapter, null ) != 0"
                      + "             AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) NOT IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) "
                      + "             AND rsb_depo.depokindtype(dacnt.T_AUTOKEY) NOT IN ("+String(OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER)+", "+String(OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER)+")"
                      + "             AND dacnt.T_KIND = 2" // passive
                      + "             AND dpac.t_ID = dacnt.t_Type "
                      + "             AND acc.t_deporoot = dacnt.T_AUTOKEY"
                      + "             AND acc.t_chapter = 5"
                      + "             AND dacntPart.t_AutoKey = acc.t_DepoAcc "
                      //                  ----------- Место хранения ---
                      + "             AND accvanl.t_Account = acc.t_Account"
                      + "             AND accvanl.t_AnaliticsID = 2"
                      + "             AND accvanl.t_FIID = acc.t_Code_Currency"
                      + "             AND accvanl.t_Chapter = acc.t_Chapter"
                      + "             AND accsub.t_AccAnaliticsID = accvanl.t_AccAnaliticsID"
                      + "             AND accsub.t_SpecialType = 0"
                      + "             AND accAct.t_Chapter = acc.t_Chapter"
                      + "             AND accAct.t_Code_Currency = acc.t_Code_Currency"
                      + "             AND accAct.t_Account = accsub.t_SubAccountCode"
                      + "             AND accAct.t_Open_Date <= "+RepDateSQL
                      + "             AND dacntAct.t_autokey = accAct.t_deporoot"
                      + "             AND rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 ) > 0"
                      + "          GROUP BY acc.t_Code_Currency, dacntAct.t_Owner, rsb_depo.depokindtype(dacnt.T_AUTOKEY), dacnt.t_Owner, dpac.t_IsTrade) stor,"
                      +           SQL_QueryIssuer+" issuer"
                      + "   WHERE avr.t_FIID = stor.t_FIID"
                      + "     AND fin.T_FIID = avr.t_FIID"
                      + "     AND issuer.t_FIID = fin.T_FIID)"
                      // ИК
                      + " UNION ALL"
                      + " (SELECT stor.T_Rest,"                                                                                       // T_AMOUNT
                      + "         stor.t_Issuer,"                                                                                     // T_ISSUER
                      + "         CHR(1),"                                                                                            // T_ISSUERNAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_Issuer, 16),"                                                      // T_ISSUERINN
                      + "         CHR(1),"                                                                                            // T_ISSUERINN_MARK
                      + "         CHR(1),"                                                                                            // T_ISSUERINN_TIN
                      + "         CHR(1),"                                                                                            // T_ISSUERNOTRESCODE
                      + "         CHR(1),"                                                                                            // T_ISSUERKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_Issuer, 27),"                                                      // T_ISSUEROGRN
                      + "         CHR(1),"                                                                                            // T_ISSUERCOUNTRYCODE
                      + "         -1,"                                                                                                // T_FIID
                      + "         rsb_secur.GetObjAttrName(12, 1, stor.t_Code711),"                                                   // T_CODE711
                      + "         CHR(1),"                                                                                            // T_LSIN
                      + "         CHR(1),"                                                                                            // T_ISIN
                      + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = stor.T_FACEVALUEFI),"
                      + "             CHR(1)),"                                                                                       // T_FACEVALUEFICODE
                      + "         stor.T_FACEVALUE,"                                                                                  // T_FACEVALUE
                      + "         2,"                                                                                                 // T_FACEVALUEPOINT
                      + "         stor.t_StoragePlace,"                                                                               // T_STORAGEPLACE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACENAME
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                                                // T_STORAGEPLACEINN
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEINN_MARK
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEINN_TIN
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACENOTRESCODE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEKPP
                      + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                                                // T_STORAGEPLACEOGRN
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACECOUNTRYCODE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACELICENSE
                      + "         CHR(1),"                                                                                            // T_STORAGEPLACEMARK
                      + "         (case when stor.t_IsTrade = 'X' then 'X'||TO_CHAR(stor.T_DepoAccKind) else TO_CHAR(stor.T_DepoAccKind) end), " // T_DEPOACCKIND
                      + "         NVL(rcb_objattr.getObjAttr(3, 61, rcb_objattr.makePartyId(stor.t_Owner), "+RepDateSQL+"), CHR(1))," // T_SECTOR
                      + "         stor.t_RestPawn,"                                                                                   // T_PAWNAMOUNT
                      + "         stor.t_RestTrade,"                                                                                  // T_TRADEAMOUNT
                      + "         stor.t_RestCorpRestr,"                                                                              // T_CORPRESTRAMOUNT
                      + "         stor.t_RestOperBan,"                                                                                // T_OPERBANAMOUNT
                      + "         stor.t_RestArrest, "                                                                                // T_ARRESTAMOUNT
                      + "         stor.t_EncumberRest, "                                                                              // T_ENCUMBERAMOUNT
                      + "         stor.t_Owner, "                                                                                     // T_CORRESP
                      + "         CHR(1), "                                                                                           // T_CORRESPCOUNTRYCODE
                      + "         CHR(1), "                                                                                           // T_NOTRESLICENSEDATE
                      + "         CHR(1), "                                                                                           // T_ORGANGIVELICENSE
                      + "         stor.t_Escrow, "                                                                                    // T_ESCROW
                      + "         stor.t_ObosobFZRest, "                                                                              // T_OBOSOBFZAMOUNT
                      + "         stor.t_ObosobBRRest "                                                                               //T_OBOSOBBRAMOUNT
                      + "     FROM (SELECT SUM(vficert.t_Copies) as T_Rest,"
                      + "                  rsb_depo.icnominal(ic.t_InvCardID,"+RepDateSQL+", 1) AS T_FaceValue, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
                      +                    GetQueryForBlockCert(fltr.RepDate, BLOCKARREST_DATE, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
                      +                    GetQueryForTradeCert(fltr.BegDate, BLOCKAMOUNT_DATE) + " as T_RestTrade, "
                      +                    GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLBLOCK_ESCROW, false) + " as T_Escrow, "
                      +                    GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLBLOCK_OBOSOBL, false) + " as t_ObosobFZRest, "
                      +                    GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLBLOCK_OBOSOBBR, false) + " as t_ObosobBRRest, "
                      + "                  vficert.t_FaceValueFI as T_FaceValueFI,"
                      + "                  part.t_PartyID as T_Issuer,"
                      + "                  rsb_depo.depokindtype(dacnt.T_AUTOKEY) as T_DepoAccKind,"
                      + "                  dacntAct.t_Owner as t_StoragePlace,"
                      + "                  dacnt.t_Owner as t_Owner,"
                      + "                  rsb_secur.GetMainObjAttr(12, LPAD(fin.t_FIID, 10, '0'), 1, "+RepDateSQL+") AS t_Code711, "
                      + "                  dpac.t_IsTrade as t_IsTrade "
                      + "            FROM ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, dinvcard_dbt ic, dv_ficert_dbt vficert, daccount_dbt accAct, ddepoacnt_dbt dacntAct, dparty_dbt part, dfininstr_dbt fin"
                      + "           WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
                      + "             AND dacnt.t_opendate <= "+RepDateSQL
                      + "             AND dacnt.t_department IN ("+fltr.Departments+")"
                      + "             AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+") != 1" // НЕ закрытые
                      + "             AND rsi_rsb_account.restac( acc.t_Account, acc.T_CODE_CURRENCY, "+RepDateSQL+", acc.t_Chapter, null ) != 0"
                      + "             AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) NOT IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) "
                      + "             AND rsb_depo.depokindtype(dacnt.T_AUTOKEY) NOT IN ("+String(OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER)+", "+String(OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER)+")"
                      + "             AND dacnt.T_KIND = 2 " // passive
                      + "             AND dpac.t_ID = dacnt.t_Type "
                      + "             AND acc.t_deporoot = dacnt.T_AUTOKEY"
                      + "             AND acc.t_chapter = 5"
                      + "             AND dacntPart.t_AutoKey = acc.t_DepoAcc "
                      //              ----------- Место хранения ---
                      + "             AND rsb_depo.icstatus(ic.t_InvCardID, "+RepDateSQL+") = " + INVCARD_STATUS_INCUSTODY // на хранении
                      + "             AND rsb_depo.icaccountid(ic.t_InvCardID, 2, "+RepDateSQL+") = acc.t_AccountID "
                      + "             AND vficert.t_FiCertID = ic.t_FiCertID "
                      + "             AND vficert.t_FIID = acc.t_Code_Currency"
                      + "             AND part.T_PartyID = rsb_deals.GetFicertIssuer(vficert.t_FiCertID) "
                      + "             AND part.t_LegalForm =  " + PTLEGF_INST
                      + "             AND accAct.t_Chapter = acc.t_Chapter"
                      + "             AND accAct.t_Code_Currency = acc.t_Code_Currency"
                      + "             AND accAct.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 1, "+RepDateSQL+")"
                      + "             AND accAct.t_Open_Date <= "+RepDateSQL
                      + "             AND dacntAct.t_autokey = accAct.t_deporoot"
                      + "             AND fin.t_FIID = vficert.t_FIID"
                      + "             AND RSI_RSB_FIInstr.FI_IsSecurIndividual(fin.t_FIID) <> 0"
                      + "            GROUP BY part.t_PartyID, vficert.t_FaceValueFI, rsb_depo.icnominal(ic.t_InvCardID,"+RepDateSQL+", 1)," // в разрезе номинала
                      + "                     fin.t_AvoirKind, rsb_secur.GetMainObjAttr(12, LPAD(fin.t_FIID, 10, '0'), 1, "+RepDateSQL+"),"
                      + "                     dacntAct.t_Owner, rsb_depo.depokindtype(dacnt.T_AUTOKEY), dacnt.t_Owner, dpac.t_IsTrade"
                      + "   ) stor"
                      + " )"
                      + " UNION ALL"
                      // Закладные
                      + "  (SELECT stor.T_Rest,"                                                                                        // T_AMOUNT
                      + "          -1,   "                                                                                              // T_ISSUER
                      + "          'Физические лица',"                                                                                  // T_ISSUERNAME,
                      + "          CHR(1),"                                                                                             // T_ISSUERINN
                      + "          CHR(1),"                                                                                             // T_ISSUERINN_MARK
                      + "          CHR(1),"                                                                                             // T_ISSUERINN_TIN
                      + "          CHR(1),"                                                                                             // T_ISSUERNOTRESCODE
                      + "          CHR(1),"                                                                                             // T_ISSUERKPP,
                      + "          CHR(1),"                                                                                             // T_ISSUEROGRN
                      + "          stor.t_countryPhis,"                                                                                 // T_ISSUERCOUNTRYCODE
                      + "          -1,"                                                                                                 // T_FIID
                      + "          'ENC',"                                                                                              // T_CODE711,
                      + "          CHR(1),"                                                                                             // T_LSIN
                      + "          CHR(1),"                                                                                             // T_ISIN
                      + "          NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = stor.T_FACEVALUEFI),"
                      + "              CHR(1)),"                                                                                        // T_FACEVALUEFICODE
                      + "          stor.T_FACEVALUE,"                                                                                   // T_FACEVALUE
                      + "          2,"                                                                                                  // T_FACEVALUEPOINT
                      + "          stor.t_StoragePlace,"                                                                                // T_STORAGEPLACE
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACENAME
                      + "          rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                                                 // T_STORAGEPLACEINN
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACEINN_MARK
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACEINN_TIN
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACENOTRESCODE
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACEKPP
                      + "          rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                                                 // T_STORAGEPLACEOGRN
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACECOUNTRYCODE
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACELICENSE
                      + "          CHR(1),"                                                                                             // T_STORAGEPLACEMARK
                      + "         (case when stor.t_IsTrade = 'X' then 'X'||TO_CHAR(stor.T_DepoAccKind) else TO_CHAR(stor.T_DepoAccKind) end), " // T_DEPOACCKIND
                      + "          NVL(rcb_objattr.getObjAttr(3, 61, rcb_objattr.makePartyId(stor.t_Owner), "+RepDateSQL+"), CHR(1)),"  // T_SECTOR
                      + "          stor.t_RestPawn,"                                                                                    // T_PAWNAMOUNT
                      + "          stor.t_RestTrade,"                                                                                   // T_TRADEAMOUNT
                      + "          stor.t_RestCorpRestr,"                                                                               // T_CORPRESTRAMOUNT
                      + "          stor.t_RestOperBan,"                                                                                 // T_OPERBANAMOUNT
                      + "          stor.t_RestArrest, "                                                                                 // T_ARRESTAMOUNT
                      + "          stor.t_EncumberRest, "                                                                               // T_ENCUMBERAMOUNT
                      + "          stor.t_Owner, "                                                                                      // T_CORRESP
                      + "          CHR(1), "                                                                                            // T_CORRESPCOUNTRYCODE
                      + "          CHR(1), "                                                                                            // T_NOTRESLICENSEDATE
                      + "          CHR(1), "                                                                                            // T_ORGANGIVELICENSE
                      + "          stor.t_Escrow, "                                                                                     // T_ESCROW
                      + "          stor.t_ObosobFZRest, "                                                                                // T_OBOSOBFZAMOUNT
                      + "          stor.t_ObosobBRRest "                                                                                 //T_OBOSOBBRAMOUNT
                      + "     FROM "
                      + "          (SELECT DECODE(part.t_NotResident,chr(88), part.t_NRCountry, 'RUS') as t_countryPhis, "
                      + "                  SUM(vficert.t_Copies) as T_Rest,"
                      + "                  SUM (mort.T_AMOUNT) AS T_FaceValue, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
                      +                    GetQueryForBlockCert(fltr.RepDate, BLOCKARREST_DATE, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
                      +                    GetQueryForBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
                      +                    GetQueryForTradeCert(fltr.BegDate, BLOCKAMOUNT_DATE) + " as T_RestTrade, "
                      +                    GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLBLOCK_ESCROW, false) + " as T_Escrow, "
                      +                    GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLBLOCK_OBOSOBL, false) + " as t_ObosobFZRest, "
                      +                    GetQueryForValBlockCert(fltr.BegDate, BLOCKAMOUNT_DATE, LLBLOCK_OBOSOBBR, false) + " as t_ObosobBRRest, "
                      + "                  vficert.t_FaceValueFI as T_FaceValueFI,"
                      + "                  rsb_depo.depokindtype(dacnt.T_AUTOKEY) as T_DepoAccKind,"
                      + "                  dacntAct.t_Owner as t_StoragePlace,"
                      + "                  dacnt.t_Owner as t_Owner, "
                      + "                  dpac.t_IsTrade as t_IsTrade "
                      + "            FROM ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, dinvcard_dbt ic, dv_ficert_dbt vficert, dmortgage_dbt mort, daccount_dbt accAct, ddepoacnt_dbt dacntAct, dparty_dbt part,"
                      + "                 (SELECT atc.t_object, att.t_name"
                      + "                     FROM dobjattr_dbt att,"
                      + "                          (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
                      + "                                  DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
                      + "                                  atc.t_objectType AS t_realObjectType,"
                      + "                                  atc.t_groupId AS t_realGroupId,"
                      + "                                  atc.t_attrId t_attrId,"
                      + "                                  atc.t_object t_object,"
                      + "                                  atc.t_validToDate t_validToDate,"
                      + "                                  atc.t_validFromDate t_validFromDate"
                      + "                             FROM dobjatcor_dbt atc,"
                      + "                                  dobjgroup_dbt grp"
                      + "                            WHERE atc.t_groupId = grp.t_groupId"
                      + "                              AND atc.t_objectType = grp.t_objectType"
                      + "                              AND atc.t_general = 'X') atc"
                      + "                    WHERE atc.t_attrId = att.t_attrId"
                      + "                      AND atc.t_objectType = att.t_objectType"
                      + "                      AND atc.t_groupId = att.t_groupId"
                      + "                      AND " +RepDateSQL+ " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
                      + "                      AND atc.t_realObjectType = 24 " // Сертификат документарной ц/б
                      + "                      AND atc.t_realGroupId = 1) objCert711"
                      + "            WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
                      + "              AND dacnt.t_opendate <= "+RepDateSQL
                      + "              AND dacnt.t_department IN ("+fltr.Departments+")"
                      + "              AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+") != 1" // НЕ закрытые
                      + "              AND rsi_rsb_account.restac( acc.t_Account, acc.T_CODE_CURRENCY, "+RepDateSQL+", acc.t_Chapter, null ) != 0"
                      + "              AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) NOT IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) "
                      + "              AND rsb_depo.depokindtype(dacnt.T_AUTOKEY) NOT IN ("+String(OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER)+", "+String(OBJTYPE_DEPOKINDTYPE_FOREIGNNOMKEEPER)+")"
                      + "              AND dacnt.T_KIND = 2 " // passive
                      + "              AND dpac.t_ID = dacnt.t_Type "
                      + "              AND acc.t_deporoot = dacnt.T_AUTOKEY"
                      + "              AND acc.t_chapter = 5"
                      + "              AND dacntPart.t_AutoKey = acc.t_DepoAcc "
                      //               ----------- Место хранения ---
                      + "              AND vficert.t_FiCertID = ic.t_FiCertID "
                      + "              AND RSB_FIInstr.FI_AvrKindsEQ(2, "+AVOIRISSKIND_MORTGAGE+", vficert.t_AvoirKind) > 0 "
                      + "              AND mort.t_MortgageID = vficert.t_CertID "
                      + "              AND part.t_PartyID = rsb_deals.GetFicertIssuer(vficert.t_FiCertID) "
                      + "              AND part.t_LegalForm =  " + PTLEGF_PERSN  // Физ.лица
                      + "              AND objCert711.t_object = vficert.t_FiCertID"
                      + "              AND objCert711.t_Name = 'ENC'"
                      + "              AND rsb_depo.icstatus(ic.t_InvCardID, "+RepDateSQL+") = " + INVCARD_STATUS_INCUSTODY // на хранении
                      + "              AND rsb_depo.icaccountid(ic.t_InvCardID, 2, "+RepDateSQL+") = acc.t_AccountID"
                      + "              AND vficert.t_FIID = acc.t_Code_Currency"
                      + "              AND accAct.t_Chapter = acc.t_Chapter"
                      + "              AND accAct.t_Code_Currency = acc.t_Code_Currency"
                      + "              AND accAct.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 1, "+RepDateSQL+")"
                      + "              AND accAct.t_Open_Date <= "+RepDateSQL
                      + "              AND dacntAct.t_autokey = accAct.t_deporoot"
                      + "           GROUP BY dacntAct.t_Owner, vficert.t_FaceValueFI, rsb_depo.depokindtype(dacnt.T_AUTOKEY), dacnt.t_Owner, DECODE(part.t_NotResident,chr(88), part.t_NRCountry, 'RUS'), dpac.t_IsTrade) stor"
                      + " )";

    //println("1.2: " + query);
    SQL_Execute(query, "Сбор данных о цб, учитываемых на счетах клиентов депозитария", true );

    SQL_Execute("DELETE FROM d711avoir_tmp WHERE T_AMOUNT = 0", "Удаление информации о лишних записях", false );

    PostProcess();
  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    var query = "SELECT group711.T_AMOUNT as t_Amount, "
              + "       group711.t_TradeAmount as t_TradeAmount, "
              + "       group711.t_CorpRestrAmount as t_CorpRestrAmount, "
              + "       group711.t_OperBanAmount as t_OperBanAmount, "
              + "       group711.t_ArrestAmount as t_ArrestAmount, "
              + "       group711.t_PawnAmount as t_PawnAmount, "
              + "       group711.t_EncumberAmount as t_EncumberAmount, "
              + "       t.* "
              + "  FROM (SELECT min(t_autokey) t_autokey, "
              + "               SUM(T_AMOUNT) as t_amount, "
              + "               SUM(T_TRADEAMOUNT) AS t_TradeAmount, "
              + "               SUM(T_CORPRESTRAMOUNT) AS t_CorpRestrAmount, "
              + "               SUM(T_OPERBANAMOUNT) AS t_OperBanAmount, "
              + "               SUM(T_ARRESTAMOUNT) AS t_ArrestAmount, "
              + "               SUM(T_PAWNAMOUNT) AS t_PawnAmount, "
              + "               SUM(T_ENCUMBERAMOUNT) AS t_EncumberAmount, "
              + "               T_FIID,"
              + "               T_ISSUER,T_FACEVALUEFICODE, T_FACEVALUE," // добавил, т.к. для ИК он берется не из выпуска, а из ИК
              + "               T_STORAGEPLACE,"
              + "               T_DEPOACCKIND,"
              + "               T_SECTOR "
              + "          FROM d711avoir_tmp "
              + "         GROUP BY T_FIID, T_ISSUER, T_FACEVALUEFICODE, T_FACEVALUE, T_STORAGEPLACE, T_DEPOACCKIND, T_SECTOR ) group711,"
              + "        d711avoir_tmp t"
              + " WHERE t.t_autokey = group711.t_autokey"
              + " ORDER BY t.t_IssuerName, t.t_Code711, t.t_LSIN, t.t_ISIN, t.t_FaceValueFICode, t.t_StoragePlaceName";
    return query;
  end;
end;

/* ********************************************** */
/* Класс сбора данных ц/б клиентов (раздел 1.2.1) */
/* ********************************************** */
private class C_711Client21(flt_)
  private var fltr = flt_;
  private var tools = C_711Tools();

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "";
    var pt:TRecHandler;
    var count = 0;
    var IssuerName = "", IssuerINN = "", IssuerKPP = "", IssuerCountryCode = "", Code711 = "", LSIN = "",
        ISIN = "", FaceValueFiCode = "", FaceValue = $0.0, FaceValuePoint = 0, CFI = "", IsEmissive = false;

    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_IssuerName, t_Issuer, t_IssuerCountryCode, t_FIID, t_Code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint "
                        +"  FROM d711avoir_tmp");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      IssuerName              = dataSet.IssuerName;
      IssuerINN               = dataSet.IssuerINN;
      IssuerKPP               = "";
      IssuerCountryCode       = dataSet.IssuerCountryCode;
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;

      count = count + 1;
      
      if((fltr.BegDate < DATE_01_04_2018) and (Code711 != "") and (Index("SN1,SN2,SN3,SN4", Code711) != 0))
        Code711 = "";
      end;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (IssuerName == "Физические лица")
        if (IssuerCountryCode == tools.OUR_COUNTRY_CODE_LAT)
          IssuerINN = tools.UNKNOW_INN_RES_PHYS;
        else
          IssuerINN = tools.UNKNOW_INN_NOTRES_PHYS;
        end;
        IssuerCountryCode = DP_GetCountryByCodeLat3(IssuerCountryCode).CodeNum3;
      elif (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, NULL, NULL);
        IssuerCountryCode = tools.GetCountryCode(pt);
      end;

      // Выпуск
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if ((dataSet.FIID != -1) and (ПолучитьФинИн(dataSet.FIID, Fininstr) == 0))
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
        elif (not IsEmissive)
          if(FI_IsISU(Fininstr))
            LSIN = tools.GetRULESREGXID(dataSet.FIID);
          else
            LSIN = "";
          end;
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

 
      queryUpd = "UPDATE d711avoir_tmp SET "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_Code711 = " + tools.GetSQLStr(Code711) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + IIF(FaceValue == $0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ","
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о о объеме произведенных депозитарных операций с учитываемыми ценными бумагами, " + String(count), false );

    end;
  end;

  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);

    query = "INSERT INTO d711avoir_tmp ( T_ISSUER,"
                                      +" T_ISSUERNAME,"
                                      +" T_ISSUERINN,"
                                      +" T_ISSUERINN_MARK, "
                                      +" T_ISSUERKPP,"
                                      +" T_ISSUEROGRN,"
                                      +" T_ISSUERCOUNTRYCODE,"
                                      +" T_FIID,"
                                      +" T_CODE711,"
                                      +" T_LSIN,"
                                      +" T_ISIN,"
                                      +" T_FACEVALUEFICODE,"
                                      +" T_FACEVALUE,"
                                      +" T_RECEPTIONCB,"
                                      +" T_WITHDRAWALCB,"
                                      +" T_TRANSFERCB,"
                                      +" T_RECEPTIONCBCount,"
                                      +" T_WITHDRAWALCBCount,"
                                      +" T_TRANSFERCBCount"
                                      + ")"
                      + " (SELECT issuer.t_Issuer,"                                                                                   // T_ISSUER
                      + "         CHR(1),"                                                                                            // T_ISSUERNAME,
                      + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16),"                                                    // T_ISSUERINN
                      + "         CHR(1),"                                                                                            // T_ISSUERINN_MARK
                      + "         CHR(1),"                                                                                            // T_ISSUERKPP,
                      + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27),"                                                    // T_ISSUEROGRN
                      + "         CHR(1),"                                                                                            // T_ISSUERCOUNTRYCODE,
                      + "         avr.t_FIID as T_FIID,"                                                                              // T_FIID
                      + "         rsb_secur.GetObjAttrName(12, 1,"
                      + "                                  rsb_secur.GetMainObjAttr(12,"
                      + "                                                           LPAD(avr.t_FIID, 10, '0'),"
                      + "                                                           1, "+RepDateSQL+")),"                             // T_CODE711
                      + "         avr.T_LSIN,"                                                                                        // T_LSIN
                      + "         avr.T_ISIN,"                                                                                        // T_ISIN
                      + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI),"
                      + "             CHR(1)),"                                                                                       // T_FACEVALUEFICODE
                      + "         NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+" ), 0.0),"                            // T_FACEVALUE
                      + "         stor.T_RECEPTIONCB, "                                                                               // T_RECEPTIONCB
                      + "         stor.T_WITHDRAWALCB, "                                                                              // T_WITHDRAWALCB
                      + "         stor.T_TRANSFERCB, "                                                                                // T_TRANSFERCB
                      + "         stor.T_RECEPTIONCBCount, "                                                                          // T_RECEPTIONCBCount
                      + "         stor.T_WITHDRAWALCBCount, "                                                                         // T_WITHDRAWALCBCount
                      + "         stor.T_TRANSFERCBCount "                                                                            // T_TRANSFERCBCount
                      + "    FROM davoiriss_dbt avr, dfininstr_dbt fin,"
                      + "  (SELECT SUM ( CASE "
                      + "             WHEN (    trn.t_account_Receiver = sub.t_account "
                      + "                   AND accD.t_Kind_Account = 'А') "
                      + "             THEN  trn.t_SUM_PAYER  ELSE  0 END) T_RECEPTIONCB, "
                      + "         SUM (CASE WHEN (    trn.t_account_Payer = sub.t_account "
                      + "                   AND accC.t_Kind_Account = 'А') "                        
                      + "             THEN trn.t_SUM_PAYER ELSE 0 END) T_WITHDRAWALCB, "
                      + "         SUM (CASE WHEN   ( (    trn.t_account_Receiver = sub.t_account "
                      + "                      AND accD.t_Kind_Account = 'П') "
                      + "                  OR (    trn.t_account_Payer = sub.t_account "
                      + "                      AND accC.t_Kind_Account = 'П')) "
                      + "                  AND accd.t_DepoRoot <> accc.t_DepoRoot "
                      + "             THEN trn.t_SUM_PAYER ELSE 0  END) T_TRANSFERCB, "
                      + "         SUM ( CASE "
                      + "             WHEN (    trn.t_account_Receiver = sub.t_account "
                      + "                   AND accD.t_Kind_Account = 'А') "
                      + "             THEN  1  ELSE  0 END) T_RECEPTIONCBCount, "
                      + "         SUM (CASE WHEN (    trn.t_account_Payer = sub.t_account "
                      + "                   AND accC.t_Kind_Account = 'А') "                        
                      + "             THEN 1 ELSE 0 END) T_WITHDRAWALCBCount, "
                      + "         SUM (CASE WHEN   ( (    trn.t_account_Receiver = sub.t_account "
                      + "                      AND accD.t_Kind_Account = 'П') "
                      + "                  OR (    trn.t_account_Payer = sub.t_account "
                      + "                      AND accC.t_Kind_Account = 'П')) "
                      + "                  AND accd.t_DepoRoot <> accc.t_DepoRoot "
                      + "             THEN 1 ELSE 0  END) T_TRANSFERCBCount, "
                      + "         trn.t_FIID_PAYER t_FIID "
                      + "    FROM dacctrn_dbt trn, "
                      + "         daccount_dbt accD, "
                      + "         daccount_dbt accC, "
                      + "         (SELECT DISTINCT acc.* "
                      + "            FROM ddepoacnt_dbt dacnt, daccount_dbt acc "
                      + "           WHERE     dacnt.T_AUTOKEY = dacnt.t_Root "
                      + "                 AND dacnt.t_opendate <= "+ RepDateSQL
                      + "                 AND dacnt.t_department IN ("+fltr.Departments+")"
                      + "                 AND dacnt.T_KIND = 2 "
                      + "                 AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) NOT IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) "
                      + "                 AND acc.t_deporoot = dacnt.T_AUTOKEY "
                      + "                 AND acc.t_chapter = 5) sub "
                      + "   WHERE     (   trn.t_account_Payer = sub.t_account "
                      + "              OR trn.t_account_Receiver = sub.t_account) "
                      + "         AND trn.t_STATE = 1 " //фактические
                      + "         AND trn.t_DATE_CARRY BETWEEN "  + GetSQLDate(fltr.BegDate) + " AND " + RepDateSQL
                      + "         AND trn.t_account_Payer = accD.t_account "
                      + "         AND trn.t_account_Receiver = accC.t_account "
                      + "         AND accC.t_chapter = 5 "
                      + "         AND accD.t_chapter = 5 "
                      + "         AND sub.t_CODE_CURRENCY = accC.t_CODE_CURRENCY "
                      + "         AND sub.t_CODE_CURRENCY = accD.t_CODE_CURRENCY "
                      + "   GROUP BY trn.t_FIID_PAYER )stor,  "
                      +           SQL_QueryIssuer+" issuer"
                      + "   WHERE avr.t_FIID = stor.t_FIID"
                      + "     AND fin.T_FIID = avr.t_FIID"
                      + "     AND issuer.t_FIID = fin.T_FIID)"
                      ;

    SQL_Execute(query, "Сбор данных о объеме произведенных депозитарных операций с учитываемыми ценными бумагами", true );


    PostProcess();
  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    var query = "SELECT t.* "
              + "  FROM  d711avoir_tmp t"
              + " ORDER BY t.t_IssuerName, t.t_Code711, t.t_LSIN, t.t_ISIN, t.t_FaceValueFICode";
    return query;
  end;
end;

/* ********************************************** */
/* Класс сбора данных ц/б банка (раздел 1.3)      */
/* ********************************************** */
private class C_711Bank(flt_)
  private var fltr = flt_;
  private var tools = C_711Tools();

  private macro GetSumRepoStorageAll(fiid:integer, amount:@numeric, count:@integer);
    var cmd, dataSet;

    amount = $0.0;
    count  = 0;

    cmd = DL_RSDCommand( "SELECT t_Fiid, Sum(t_RepoAmount) as t_amount, count(*) as t_count from d711avoir_tmp WHERE t_fiid = ? Group By t_fiid");
    cmd.addParam(fiid);

    dataSet = cmd.execute();
    if (dataSet.moveNext())
      amount = dataSet.amount;
      count  = dataSet.count;
    end;
  end;
  /* Были ли перемещения по ЦБ за дату большей даты 1 части РЕПО?*/
  private macro wasMovement(fiid:integer):bool
    var retVal = false;
    var cmd, dataSet;
    // запрос по поиску даты 1 части аналогичен поиску суммы по РЕПО
    // ищем проводки с активного на активный счет
    cmd = DL_RSDCommand( "SELECT count(*) as count "
                        +"  FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, (SELECT t_Kind_Operation, t_DocKind, "
                        +"       rsb_secur.get_OperationGroup (t_SysTypes) oGrp FROM doprkoper_dbt) Opr, "
                        +"     dspdrprop_dbt drprop1, dspdrmove_dbt dmove1, dpmpaym_dbt pm_dp1,ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal1, dacctrn_dbt actrn, daccount_dbt accPayer, daccount_dbt accReceiver"
                        +"  WHERE actrn.t_chapter = 5 "
                        +"    AND actrn.t_Date_Carry >= rq_sp1.t_FactDate "
                        +"    AND actrn.t_FIID_Receiver = actrn.t_FIID_PAYER "
                        +"    AND actrn.t_FIID_Receiver = ? "
                        +"    AND accPayer.t_Account =actrn.t_Account_Payer"
                        +"    AND accPayer.t_chapter =actrn.t_chapter"
                        +"    AND accPayer.t_Code_Currency = actrn.t_FIID_PAYER"
                        +"    AND accPayer.t_Kind_Account = 'А'"
                        +"    AND accReceiver.t_Account =actrn.t_Account_Receiver"
                        +"    AND accReceiver.t_chapter =actrn.t_chapter"
                        +"    AND accReceiver.t_Code_Currency = actrn.t_FIID_Receiver"
                        +"    AND accReceiver.t_Kind_Account = 'А'"
                        // --------------------------------------------------------------
                        +"    AND rq_sp1.t_State = 2"
                        +"    AND rq_sp1.t_Type = 8"
                        +"    AND rq_sp1.t_DealPart = 1"
                        +"    AND rq_sp1.t_FIID = actrn.t_FIID_Receiver"
                        +"    AND Tick.t_ClientID = -1"
                        +"    AND Tick.t_DealID = rq_sp1.t_DocID"
                        +"    AND Tick.t_BOfficeKind = rq_sp1.t_DocKind"
                        +"    AND rq_sp2.t_Type = 8"
                        +"    AND rq_sp2.t_DealPart = 2"
                        +"    AND rq_sp2.t_FIID = rq_sp1.t_FIID"
                        +"    AND rq_sp2.t_DocID = Tick.t_DealID"
                        +"    AND rq_sp2.t_DocKind = Tick.t_BOfficeKind"
                        +"    AND Opr.t_Kind_Operation = Tick.t_DealType"
                        +"    AND Opr.t_DocKind = Tick.t_BOfficeKind"
                        +"    AND Tick.t_DealStatus > 0"
                        +"    AND (Rsb_Secur.IsRepo (Opr.oGrp) = 1 AND Rsb_Secur.IsBuy (Opr.oGrp) = 1)"
                        +"    AND grdoc.t_DocKind = 4725"
                        +"    AND grdeal1.t_ID = grdoc.t_GrDealID"
                        +"    AND grdeal1.t_DocKind = rq_sp1.t_DocKind"
                        +"    AND grdeal1.t_DocID = rq_sp1.t_DocID"
                        +"    AND grdeal1.t_TemplNum IN (37, 39)"
                        +"    AND drprop1.t_PaymentID = drprop1.t_DocumentID"
                        +"    AND drprop1.t_DocumentKind = 4724"
                        +"    AND drprop1.t_DocumentID = grdeal1.t_ID"
                        +"    AND dmove1.t_DraftID = drprop1.t_DraftID"
                        +"    AND pm_dp1.t_PaymentID = dmove1.t_PaymentID "
                        +"    AND pm_dp1.t_ValueDate <= ? "
                        +"    AND pm_dp1.t_PaymStatus = 32000 "
                        +"    AND rsi_dlrq.RSI_GetRQStateOnDate (rq_sp2.t_ID, ?) <> 2 "
                        +"    AND ROWNUM <= 1" // кол-во не важно, поэтому берем первый
                       );

    cmd.addParam(fiid);
    cmd.addParam(fltr.RepDate);
    cmd.addParam(fltr.RepDate);

    dataSet = cmd.execute();
    if (dataSet.moveNext())
      retVal = (dataSet.count>0);
    end;
    
    // Golovkin проверим перемещения в КДУ
    if(not retVal)
      cmd = DL_RSDCommand(" SELECT count(*) as count "
                        + "   FROM ddl_comm_dbt t, dscqracc_dbt EnrlQRACC, dscqracc_dbt WrtQRACC "
                        + "  WHERE     WrtQRACC.t_QRID = t.t_DEPSETID "
                        + "        AND EnrlQRACC.t_QRID = t.t_DEPSETID_2 "
                        + "        AND WrtQRACC.t_STORAGEID != EnrlQRACC.t_STORAGEID "
                        + "        AND t.t_commstatus = 2"
                        + "        AND t.t_fiid = :fiid "
                        + "        AND t.t_COMMDATE <= :date_end ");
      cmd.addParam(fiid);
      cmd.addParam(fltr.RepDate);

      dataSet = cmd.execute();
      if (dataSet.moveNext())
        retVal = (dataSet.count>0);
      end;      
    end;

    return retVal;
  end;

  private macro InsertNote(autoKeyAvoir, flag, column, note)
    var query = "INSERT INTO d711avoir_prot_tmp (t_autokeyavoir, t_flag, t_column, t_note) VALUES("
               +String(autoKeyAvoir)+",'"+flag+"','"+column+"','"+note+"')";

    SQL_Execute(query, "Протокол");
  end;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "", queryIns = "";
    var pt:TRecHandler;
    var count = 0;
    var saveAmountRepoAvr = $0.0;
    var prevFIID = -1, wasMovementFIID = false;
    var IssuerName = "", IssuerINN = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "", IssuerKPP = "", IssuerCountryCode = "", Code711 = "", LSIN = "", ISIN = "", FaceValueFiCode = "",
        StoragePlaceName = "", StoragePlaceOGRN = "", StoragePlaceCountryCode = "", StoragePlaceINN = "", StoragePlaceKPP = "", StoragePlaceLicense = "", StoragePlaceMark = "", StoragePlaceINN_Mark = "", StoragePlaceINN_TIN = "", StoragePlaceNotResCode = "",
        NotResLicenseDate = "", OrganGiveLicense = "",
        FaceValue = $0.0, FaceValuePoint = 0, OurAmount = $0.0, RepoAmount = $0.0, RepoAmountAvr = $0.0, CFI = "", IsEmissive = false, note, IssuerOGRN = "";

    var regVal=1;
    GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 711\\КОРРЕКТИРОВКА_ПЕРЕМЕЩ_ОРЕПО", V_INTEGER, regVal);
    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_IssuerName, t_Issuer, t_IssuerCountryCode, t_FIID, t_Code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint,"
                        +" t_StoragePlace, t_StoragePlaceINN, t_StoragePlaceOGRN, t_OurAmount, t_RepoAmount, t_RepoAmountAVR, T_FISCALISSUERAMOUNT, T_ISSUERAMOUNT, T_ISSUEROGRN FROM d711avoir_tmp"
                        +" ORDER BY T_FIID, t_OurAmount " + IIF(regVal==1, "ASC", "DESC"));

    dataSet = cmd.ExecuteStat();
    while (dataSet.moveNext())
      IssuerName              = dataSet.IssuerName;
      IssuerINN               = dataSet.IssuerINN;
      IssuerOGRN              = dataSet.IssuerOGRN;
      IssuerINN_Mark          = "";
      IssuerINN_TIN           = "";
      IssuerNotResCode        = "";
      IssuerKPP               = "";
      IssuerCountryCode       = dataSet.IssuerCountryCode;
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      StoragePlaceName        = "";
      StoragePlaceCountryCode = "";
      StoragePlaceINN         = "";
      StoragePlaceINN_Mark    = "";
      StoragePlaceINN_TIN     = "";
      StoragePlaceNotResCode  = "";
      StoragePlaceOGRN        = "";
      StoragePlaceKPP         = "";
      StoragePlaceLicense     = "";
      StoragePlaceMark        = "";
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;
      OurAmount               = dataSet.OurAmount;
      RepoAmount              = dataSet.RepoAmount;
      RepoAmountAvr           = dataSet.RepoAmountAvr;
      NotResLicenseDate       = "";
      OrganGiveLicense        = "";

      count = count + 1;

      if((fltr.BegDate < DATE_01_04_2018) and (Code711 != "") and (Index("SN1,SN2,SN3,SN4", Code711) != 0))
        Code711 = "";
      end;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (IssuerName == "Физические лица")
        if (IssuerCountryCode == tools.OUR_COUNTRY_CODE_LAT)
          IssuerINN = tools.UNKNOW_INN_RES_PHYS;
          IssuerINN_Mark = 3;
        else
          IssuerINN = tools.UNKNOW_INN_NOTRES_PHYS;
          IssuerINN_Mark = 4;
        end;
        IssuerCountryCode = DP_GetCountryByCodeLat3(IssuerCountryCode).CodeNum3;
      elif (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotResCode, true);
        IssuerCountryCode = tools.GetCountryCode(pt);
        IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);

        if ((pt.rec.NotResident == "X") AND (tools.CheckPartyIsSubjType(pt.rec.PartyID, null, "14.1" /*Международная компания по 290-ФЗ*/) or (tools.CheckPartyIsSubjType(pt.rec.PartyID, null, "14.2" /*Международная компания по 290-ФЗ*/))))
          IssuerOGRN = "";
        end;

        if ((IssuerOGRN == "") and (pt.rec.NotResident != "X"))
          note = "Для субъекта " + GetCodeParty(pt.rec.PartyID, 1) + " " + pt.rec.ShortName + " не найден код ОГРН";
          InsertNote(dataSet.AutoKey, "?", "4", note);
        end;
      end;
      // Выпуск
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if ((dataSet.FIID != -1) and (ПолучитьФинИн(dataSet.FIID, Fininstr) == 0))
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
        elif (not IsEmissive)
          if(FI_IsISU(Fininstr))
            LSIN = tools.GetRULESREGXID(dataSet.FIID);
          else
            LSIN = "";
          end;
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

      if((IssuerCountryCode != "") AND (IssuerCountryCode != "643"))
        LSIN = "";
      end;

      if((Code711 == "DR") OR (Code711 == "DR1") OR (Code711 == "DR2")) // депозитарная расписка
        LSIN = tools.GetLSINDEPO(dataSet.FIID);
      end;

      // Mесто Xранения
      // Если вид ц/б = вексель ИЛИ (если вид ц/б != вексель И место хранения ц/б = 'Наш банк'), то НЕ заполняется
      if (((dataSet.FIID == -1) or not FI_AvrKindsEQ(FIKIND_AVOIRISS, AVOIRISSKIND_BILL, Fininstr.rec.AvoirKind))
      and ((dataSet.FIID != -1) or (Code711 == "") or (Index(Code711, "BIL") == 0))
      and not tools.IsOurBank(dataSet.StoragePlace))
        if (ПолучитьСубъекта(dataSet.StoragePlace, pt) == 0)
          StoragePlaceName = tools.GetPartyName(pt);
          tools.SplitINN_KPP(pt, dataSet.StoragePlaceINN, @StoragePlaceINN, @StoragePlaceKPP, @StoragePlaceINN_TIN, @StoragePlaceNotResCode, false);
          StoragePlaceOGRN = dataSet.StoragePlaceOGRN;
          StoragePlaceCountryCode = tools.GetCountryCode(pt);
          if(pt.rec.NotResident == "X")
            NotResLicenseDate  = tools.ПолучитьДатуПолученияЛицензии(pt.rec.PartyID,fltr.RepDate);
            OrganGiveLicense  = ReadNoteForObject(OBJTYPE_PARTY, UniID(pt, OBJTYPE_PARTY), 86/*Орган, выдавший лицензию*/);
          end;

          if ((Fininstr.rec.Issuer == dataSet.StoragePlace) or (pt.rec.NotResident == "X"))
            StoragePlaceLicense = "";
          else
            StoragePlaceLicense = tools.GetStoragePlaceLicense(pt, Code711);
          end;

          StoragePlaceMark = tools.GetStoragePlaceMark(pt, dataSet.FIID);
          StoragePlaceINN_Mark = tools.GetStoragePlaceINN_Mark(pt);
        end;
      end;

      // слишком сложный алгоритм с работой с предыд. строками. Ищем перемещение по каждой строке!
      if (prevFIID != dataSet.FIID)
        if (RepoAmountAvr > $0.0)
          wasMovementFIID = wasMovement(dataSet.FIID);
          saveAmountRepoAvr = RepoAmountAvr;
        else
          wasMovementFIID = false;
          saveAmountRepoAvr = $0.0;
        end;
        prevFIID = dataSet.FIID;
      end;
      if (wasMovementFIID)
        var oldOurAmount = OurAmount - RepoAmount;
        RepoAmount = IIF(saveAmountRepoAvr > OurAmount, OurAmount, saveAmountRepoAvr);
        saveAmountRepoAvr = saveAmountRepoAvr - RepoAmount;
        // Примечание
        note = "По выпуску выполнялись операции перемещения, были скорректированы графы 62 (старое: "+String(oldOurAmount)+", новое: "+String(OurAmount - RepoAmount)+
                   "), 63 (бумаг в ОРЕПО всего: "+String(RepoAmountAvr)+", в этой строке: "+String(RepoAmount)+")";
        InsertNote(dataSet.AutoKey, "?", "62, 63", note);
      end;
      //
      OurAmount = OurAmount - RepoAmount;
      OurAmount = OurAmount - dataSet.FISCALISSUERAMOUNT;// Golovkin казначейский счет
      OurAmount = OurAmount - dataSet.ISSUERAMOUNT;// Golovkin эмиссионный счет
      if(OurAmount < 0)
        OurAmount = 0;
      end;

      queryUpd = "UPDATE d711avoir_tmp SET "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_Code711 = " + tools.GetSQLStr(Code711) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + IIF(FaceValue == $0.0, " t_FaceValue = " + FaceValue + ", ", "") // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + " t_StoragePlaceName = " + tools.GetSQLStr(StoragePlaceName) + ", "
                + " t_StoragePlaceCountryCode = " + tools.GetSQLStr(StoragePlaceCountryCode) + ", "
                + " t_StoragePlaceINN = " + tools.GetSQLStr(StoragePlaceINN) + ", "
                + " t_StoragePlaceINN_Mark = " + tools.GetSQLStr(StoragePlaceINN_Mark) + ", "
                + " t_StoragePlaceINN_TIN = " + tools.GetSQLStr(StoragePlaceINN_TIN) + ", "
                + " t_StoragePlaceNotResCode = " + tools.GetSQLStr(StoragePlaceNotResCode) + ", "
                + " t_StoragePlaceOGRN = " + tools.GetSQLStr(StoragePlaceOGRN) + ", "
                + " t_StoragePlaceKPP = " + tools.GetSQLStr(StoragePlaceKPP) + ", "
                + " t_StoragePlaceLicense = " + tools.GetSQLStr(StoragePlaceLicense) + ", "
                + " t_StoragePlaceMark = " + tools.GetSQLStr(StoragePlaceMark) + ", "
                + " t_OurAmount = " + String(OurAmount:0:12) + ", " // поставим большую точность
                + " t_RepoAmount = " + String(RepoAmount:0:12) + ", " // поставим большую точность
                + " t_NotResLicenseDate = " + tools.GetSQLStr(NotResLicenseDate) + ", "
                + " t_OrganGiveLicense = " + tools.GetSQLStr(OrganGiveLicense)+ ","
                + " t_CFI =" + tools.GetSQLStr(CFI)+ ","
                + " t_issuerogrn =" + tools.GetSQLStr(IssuerOGRN)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных ц/б банка, " + String(count), false );
    end;

    var LoadingDateSQL = GetSQLDate(fltr.RepDate+1);
    queryIns = "INSERT /*+ parallel (8) */ INTO d711avoir_tmp (" +
                            "  T_ISSUERNAME" +
                            ", T_ISSUERINN" +
                            ", T_ISSUERINN_TIN" +
                            ", T_ISSUERINN_MARK" +
                            ", T_ISSUERNOTRESCODE" +
                            ", T_CFI" +
                            ", T_ISSUEROGRN" +
                            ", T_ISSUERCOUNTRYCODE" +
                            ", T_CODE711" +
                            ", T_LSIN" +
                            ", T_FACEVALUEFICODE" +
                            ", T_FACEVALUE" +
                            ", T_OURAMOUNT" +
                            ", T_ISSUERAMOUNT" +
                                       ")" +
                        " (SELECT /*+ parallel (8) */"                                                        
                            "  T_ISSUERNAME" +
                            ", T_ISSUERINN" +
                            ", T_ISSUERINN_TIN" +
                            ", T_ISSUERINN_MARK" +
                            ", T_ISSUERNOTRESCODE" +
                            ", T_CFI" +
                            ", T_ISSUEROGRN" +
                            ", T_ISSUERCOUNTRYCODE" +
                            ", T_CODE711" +
                            ", T_LSIN" +
                            ", T_FACEVALUEFICODE" +
                            ", T_FACEVALUE" +
                            ", T_OURAMOUNT" +
                            ", T_ISSUERAMOUNT" +
                       "    FROM D711AVOIR_MORTGAGE_DBT WHERE T_LOADINGDATE = " + LoadingDateSQL + ")";

    SQL_Execute(queryIns, "Сбор данных по закладным, ранее загруженным в систему", false );
  end;

  /*Сумма по сделкам РЕПО в разрезе мест хранения, по которым не формировалось поручение в Депозитарий*/
  private macro GetQuerySumRepoNotDepo(RepDateSQL:string):string
    var query = "";

    query = "( cast( NVL( (SELECT SUM((SELECT SUM(v.t_Amount)"
          + "                           FROM v_scwrthistex v "
          + "                          WHERE v.t_DealID = rq_sp1.t_DocID "
          + "                            AND v.t_Buy_Sale <> " + PM_WRITEOFF_SUM_SALE
          + "                            AND v.t_State = " + PM_WRTSUM_FORM
          + "                            AND v.t_Portfolio in (" + KINDPORT_BACK_KSU +"," + KINDPORT_BACK + ")"
          + "                            AND v.t_FIID = rq_sp1.t_FIID "
          + "                            AND v.t_ChangeDate <= " +RepDateSQL
          + "                            AND v.t_Instance = (SELECT MAX(v2.t_Instance)"
          + "                                                  FROM v_scwrthistex v2"
          + "                                                 WHERE v2.t_SumID = v.t_SumID "
          + "                                                   AND v2.t_ChangeDate <= " +RepDateSQL
          + "                                               )"
          + "                         )) as t_Amount"
          + "              FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, "
          + "                   (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup(t_SysTypes) oGrp FROM doprkoper_dbt) Opr "

          + "             WHERE rq_sp1.t_State = " + DLRQ_STATE_EXEC /*ТО по 1-й части д.б. исполнено*/
          + "               AND rq_sp1.t_Type  = " + DLRQ_TYPE_DELIVERY
          + "               AND rq_sp1.t_DealPart = 1 "
          + "               AND rq_sp1.t_FIID = avr.t_FIID "
          + "               AND rq_sp1.t_FactDate <= " + RepDateSQL
          + "               AND rq_sp1.t_PlaceID = stor.t_StoragePlace "
          + "               AND Tick.t_DealID = rq_sp1.t_DocID "
          + "               AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "

          + "               AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY /*ТО по 2-й части */
          + "               AND rq_sp2.t_DealPart = 2 "
          + "               AND rq_sp2.t_FIID = avr.t_FIID "
          + "               AND rq_sp2.t_DocID = Tick.t_DealID "
          + "               AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "

          + "               AND rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, " + RepDateSQL + ") <> " + DLRQ_STATE_EXEC /*ТО по 2-й части РЕПО не исполнено*/

          + "               AND Opr.t_Kind_Operation = Tick.t_DealType "
          + "               AND Tick.t_DealStatus > " + DL_PREPARING
          + "               AND Rsb_Secur.IsRepo(Opr.oGrp)=1 "
          + "               AND Rsb_Secur.IsBuy(Opr.oGrp)=1 "
          + "               AND GRDEAL.T_DOCID = Tick.t_DealID "
          + "               AND GRDEAL.T_DOCKIND = TICK.T_BOFFICEKIND "
          + "               AND RSI_DLRQ.RSI_GetRQByDepoGrDeal(GRDEAL.T_ID, rq_sp1.t_FIID) = rq_sp1.t_ID "
          + "               AND gracc.t_GrDealID = grdeal.t_ID "
          + "               AND gracc.t_AccNum = " + DLGR_ACCKIND_CUSTODY
          + "               AND gracc.t_State = " + DLGRACC_STATE_FACTEXEC
          + "               AND NOT EXISTS (SELECT 1 "
          + "                                 FROM dspdrprop_dbt prop "
          + "                                WHERE prop.t_DocumentKind = " + DL_DLGRDEAL
          + "                                  AND prop.t_DocumentID = GRDEAL.T_ID "
          + "                              )"
          + "            ),0) "
          + "   as NUMBER(32,12) )"
          + " ) ";

    return query;
  end;

  /* Сумма по РЕПО (для МХ и ц/б)*/
  private macro GetQuerySumRepo(isStorage:bool, RepDateSQL:string):string
    var query = "";

    if(isStorage)
       query =
             "( cast( NVL((SELECT SUM((SELECT SUM(v.t_Amount)"
           + "                           FROM v_scwrthistex v "
           + "                          WHERE v.t_DealID = rq_sp1.t_DocID "
           + "                            AND v.t_Buy_Sale <> " + PM_WRITEOFF_SUM_SALE
           + "                            AND v.t_State = " + PM_WRTSUM_FORM
           + "                            AND v.t_Portfolio in (" + KINDPORT_BACK_KSU +"," + KINDPORT_BACK + ")"
           + "                            AND v.t_FIID = rq_sp1.t_FIID "
           + "                            AND v.t_ChangeDate <= " +RepDateSQL
           + "                            AND v.t_Instance = (SELECT MAX(v2.t_Instance)"
           + "                                                  FROM v_scwrthistex v2"
           + "                                                 WHERE v2.t_SumID = v.t_SumID "
           + "                                                   AND v2.t_ChangeDate <= " +RepDateSQL
           + "                                               )"
           + "                         ))"
           + "                  FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, "
           + "                       (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup(t_SysTypes) oGrp "
           + "                          FROM doprkoper_dbt) Opr, "
           + "                       dspdrprop_dbt drprop1, dspdrmove_dbt dmove1, dpmpaym_dbt pm_dp1, ddlgrdoc_dbt grdoc, ddlgrdeal_dbt grdeal1 "
           + "                 WHERE rq_sp1.t_State = 2"
           + "                   AND rq_sp1.t_Type = " + DLRQ_TYPE_DELIVERY
           + "                   AND rq_sp1.t_DealPart = 1 "
           + "                   AND rq_sp1.t_FIID = avr.t_FIID"
           + "                   AND rq_sp1.t_FactDate <= " +RepDateSQL
           + "                   AND rq_sp1.t_PlaceID = stor.t_StoragePlace "
           + "                   AND Tick.t_ClientID = -1 " // отсекаем клиентские сделки
           + "                   AND Tick.t_DealID = rq_sp1.t_DocID "
           + "                   AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "
           + "                   AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY
           + "                   AND rq_sp2.t_DealPart = 2 "
           + "                   AND rq_sp2.t_FIID = avr.t_FIID"
           + "                   AND rq_sp2.t_DocID = Tick.t_DealID "
           + "                   AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "
           + "                   AND Opr.t_Kind_Operation = Tick.t_DealType "
           + "                   AND Opr.t_DocKind = Tick.t_BOfficeKind "
           + "                   AND Tick.t_DealStatus > 0"
           + "                   AND (Rsb_Secur.IsRepo(Opr.oGrp)=1 AND Rsb_Secur.IsBuy(Opr.oGrp)=1)"  /*ОР*/
           + "                   AND grdoc.t_DocKind = " + DL_DEPODRAFT
           + "                   AND grdeal1.t_ID = grdoc.t_GrDealID "
           + "                   AND grdeal1.t_DocKind = rq_sp1.t_DocKind "
           + "                   AND grdeal1.t_DocID = rq_sp1.t_DocID "
           + "                   AND grdeal1.t_TemplNum IN ("+DLGR_TEMPL_DEPODRAFT+","+DLGR_TEMPL_DEPODRAFTCONTR+") "
           + "                   AND drprop1.t_PaymentID = drprop1.t_DocumentID"
           + "                   AND drprop1.t_DocumentKind = " + DL_DLGRDEAL
           + "                   AND drprop1.t_DocumentID = grdeal1.t_ID"
           + "                   AND dmove1.t_DraftID = drprop1.t_DraftID "
           + "                   AND pm_dp1.t_PaymentID = dmove1.t_PaymentID "
           + "                   AND pm_dp1.t_ValueDate <= "+RepDateSQL
           + "                   AND pm_dp1.t_PaymStatus = 32000 "/*депозитарный платеж по 1-й части д.б. закрыт*/
           + "                   AND rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, "+RepDateSQL+") <> 2" /*платеж по 2-й части РЕПО не закрыт*/
           + "                ), 0)  "
           + "   as NUMBER(32,12) )"
           + " )";
    else
       //просто бумаги в ОРЕПО ищем без ориентира на поручения
       query =
             "( cast( NVL((SELECT SUM((SELECT SUM(v.t_Amount)"
           + "                           FROM v_scwrthistex v "
           + "                          WHERE v.t_DealID = rq_sp1.t_DocID "
           + "                            AND v.t_Buy_Sale <> " + PM_WRITEOFF_SUM_SALE
           + "                            AND v.t_State = " + PM_WRTSUM_FORM
           + "                            AND v.t_Portfolio in (" + KINDPORT_BACK_KSU +"," + KINDPORT_BACK + ")"
           + "                            AND v.t_FIID = rq_sp1.t_FIID "
           + "                            AND v.t_ChangeDate <= " +RepDateSQL
           + "                            AND v.t_Instance = (SELECT MAX(v2.t_Instance)"
           + "                                                  FROM v_scwrthistex v2"
           + "                                                 WHERE v2.t_SumID = v.t_SumID "
           + "                                                   AND v2.t_ChangeDate <= " +RepDateSQL
           + "                                               )"
           + "                         ))"
           + "                  FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, "
           + "                       (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup(t_SysTypes) oGrp "
           + "                          FROM doprkoper_dbt) Opr "
           + "                 WHERE rq_sp1.t_State = 2"
           + "                   AND rq_sp1.t_Type = " + DLRQ_TYPE_DELIVERY
           + "                   AND rq_sp1.t_DealPart = 1 "
           + "                   AND rq_sp1.t_FIID = avr.t_FIID"
           + "                   AND rq_sp1.t_FactDate <= " +RepDateSQL
           + "                   AND Tick.t_ClientID = -1 " // отсекаем клиентские сделки
           + "                   AND Tick.t_DealID = rq_sp1.t_DocID "
           + "                   AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "
           + "                   AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY
           + "                   AND rq_sp2.t_DealPart = 2 "
           + "                   AND rq_sp2.t_FIID = avr.t_FIID"
           + "                   AND rq_sp2.t_DocID = Tick.t_DealID "
           + "                   AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "
           + "                   AND Opr.t_Kind_Operation = Tick.t_DealType "
           + "                   AND Opr.t_DocKind = Tick.t_BOfficeKind "
           + "                   AND Tick.t_DealStatus > 0"
           + "                   AND (Rsb_Secur.IsRepo(Opr.oGrp)=1 AND Rsb_Secur.IsBuy(Opr.oGrp)=1)"  /*ОР*/
           + "                   AND rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, "+RepDateSQL+") <> 2" /*платеж по 2-й части РЕПО не закрыт*/
           + "                ), 0) as NUMBER(32,12) )"
           + " )";
    end;

    return query;
  end;

  // Golovkin 10.09.2019 ID : 494320 
  macro GetSqlKDUNote(NoteKind:string, RepDateSQL:string)
    var query = " (SELECT note FROM (  " +
                "   SELECT NVL(RTRIM(rsb_struct.getChar(note.t_text), CHR(0)), CHR(0)) note, NOTE.T_NOTEKIND " +
                "     FROM dscqracc_dbt scq, davoiriss_dbt avr, dnotetext_dbt note " +
                "    WHERE     scq.t_fiid = avr.t_fiid " +
                "          AND LPAD (scq.T_QRID, 10, 0) = note.t_documentid " +
                "          AND NOTE.T_OBJECTTYPE = "+OBJTYPE_QRACC+" " +
                "          AND scq.t_depoacccode = QrAcc.t_depoacccode " +
                "          AND scq.t_depopartcode = QrAcc.t_depopartcode " +
                "          AND scq.t_storageid = QrAcc.t_storageid " + //Golovkin 10.09.2020 ID : 514303
                "          AND NOTE.T_NOTEKIND = "+NoteKind+" " +
                "          AND "+RepDateSQL+" between note.t_Date and note.t_ValidToDate " +
                " GROUP BY scq.t_depoacccode, scq.t_depopartcode, NOTE.T_NOTEKIND, NVL(RTRIM(rsb_struct.getChar(note.t_text), CHR(0)), CHR(0))) " +
                " WHERE ROWNUM = 1) ";
    return query;
  end;

  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var BegDateSQL = GetSQLDate(fltr.BegDate), RepDateSQL = GetSQLDate(fltr.RepDate);
    var err = 0, OurBannersInDepository = false;
    var depoMode = 0;

    var workWithDepo; //Работаем с депозитарием
    var isQDA; //Ведём квазидепозитарный учет
    GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_DEPOSITARY", V_BOOL, workWithDepo);
    GetRegistryValue("SECUR\\ВЕДЕНИЕ КДУ", V_BOOL, isQDA);

    if ( (workWithDepo == true) and (isQDA == false))
      depoMode = 1;
    elif ( (workWithDepo == false) and (isQDA == true) )
      depoMode = 2;
    else
      depoMode = 0;
    end;

    if(depoMode > 0)
      query =  "INSERT INTO d711avoir_tmp ("
             + "    T_ISSUER,"
             + "    T_ISSUERNAME,"
             + "    T_ISSUERINN,"
             + "    T_ISSUERINN_MARK,"
             + "    T_ISSUERINN_TIN,"
             + "    T_ISSUERNOTRESCODE,"
             + "    T_ISSUERKPP,"
             + "    T_ISSUEROGRN,"
             + "    T_ISSUERCOUNTRYCODE,"
             + "    T_FIID,"
             + "    T_CODE711,"
             + "    T_LSIN,"
             + "    T_ISIN,"
             + "    T_FACEVALUEFICODE,"
             + "    T_FACEVALUE,"
             + "    T_FACEVALUEPOINT,"
             + "    T_OURAMOUNT,"
             + "    T_REPOAMOUNT,"
             + "    T_REPOAMOUNTAVR,"
             + "    T_WRONGAMOUNT,"
             + "    T_DUAMOUNT,"
             + "    T_FISCALISSUERAMOUNT,"
             + "    T_LOANAMOUNT,"
             + "    T_ISSUERAMOUNT,"
             + "    T_STORAGEPLACE,"
             + "    T_STORAGEPLACENAME,"
             + "    T_STORAGEPLACEINN,"
             + "    T_STORAGEPLACEINN_MARK,"
             + "    T_STORAGEPLACEINN_TIN,"
             + "    T_STORAGEPLACENOTRESCODE,"
             + "    T_STORAGEPLACEKPP,"
             + "    T_STORAGEPLACEOGRN,"
             + "    T_STORAGEPLACECOUNTRYCODE,"
             + "    T_STORAGEPLACELICENSE,"
             + "    T_STORAGEPLACEMARK,"
             + "    T_PAWNAMOUNT,"
             + "    T_TRADEAMOUNT,"
             + "    T_CORPRESTRAMOUNT,"
             + "    T_OPERBANAMOUNT,"
             + "    T_ARRESTAMOUNT,"
             + "    T_ENCUMBERAMOUNT,"
             + "    T_NOTRESLICENSEDATE, "
             + "    T_ORGANGIVELICENSE, "
             + "    T_ESCROWAMOUNT, "
             + "    T_OBOSOBFZAMOUNT, "
             + "    T_OBOSOBBRAMOUNT "
             + "   )";

             if(depoMode == 1) //Депозитарный учёт
               query = query + "WITH ourOwner AS (SELECT count(1) as t_IsOur, t_PartyID FROM ddp_dep_dbt GROUP BY t_PartyID) ";
             end;

             query = query
             + "( SELECT issuer.t_Issuer,"                                                                // T_ISSUER
             + "         CHR(1),"                                                                         // T_ISSUERNAME
             + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16),"                                 // T_ISSUERINN
             + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
             + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
             + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
             + "         CHR(1),"                                                                         // T_ISSUERKPP
             + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27),"                                 // T_ISSUEROGRN
             + "         CHR(1),"                                                                         // T_ISSUERCOUNTRYCODE
             + "         avr.t_FIID as T_FIID,"                                                           // T_FIID
             + "         rsb_secur.GetObjAttrName(12, 1,"
             + "                                  rsb_secur.GetMainObjAttr(12,"
             + "                                                           LPAD(avr.t_FIID, 10, '0'),"
             + "                                                           1, "+RepDateSQL+")),"          // T_CODE711
             + "         avr.T_LSIN,"                                                                     // T_LSIN
             + "         avr.T_ISIN,"                                                                     // T_ISIN
             + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI),"
             + "             CHR(1)),"                                                                    // T_FACEVALUEFICODE
             + "         NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+" ), 0.0),"         // T_FACEVALUE
             + "         fin.T_POINT+2, "                                                                 // T_FACEVALUEPOINT
             + "         stor.t_Rest01,"                                                                  // T_OURAMOUNT
             +           GetQuerySumRepo(true, RepDateSQL)+"+"+GetQuerySumRepoNotDepo(RepDateSQL)+","     // T_REPOAMOUNT
             +           GetQuerySumRepo(false, RepDateSQL)+","                                           // T_REPOAMOUNTAVR
             + "         stor.t_Rest07,"                                                                  // T_WRONGAMOUNT
             + "         stor.t_Rest03,"                                                                  // T_DUAMOUNT
             + "         stor.t_Rest05,"                                                                  // T_FISCALISSUERAMOUNT
             + "         stor.t_Rest04,"                                                                  // T_LOANAMOUNT
             + "         stor.t_Rest06,"                                                                  // T_ISSUERAMOUNT
             + "         stor.t_StoragePlace,"                                                            // T_STORAGEPLACE
             + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
             + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                             // T_STORAGEPLACEINN
             + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
             + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
             + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
             + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
             + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                             // T_STORAGEPLACEOGRN
             + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
             + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
             + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
             + "         stor.t_RestPawn,"                                                                // T_PAWNAMOUNT
             + "         stor.t_RestTrade,"                                                               // T_TRADEAMOUNT
             + "         stor.t_RestCorpRestr,"                                                           // T_CORPRESTRAMOUNT
             + "         stor.t_RestOperBan,"                                                             // T_OPERBANAMOUNT
             + "         stor.t_RestArrest,"                                                              // T_ARRESTAMOUNT
             + "         stor.t_EncumberRest,"                                                            // T_ENCUMBERAMOUNT
             + "         CHR(1), "                                                                        // T_NOTRESLICENSEDATE
             + "         CHR(1), "                                                                        // T_ORGANGIVELICENSE
             + "         stor.t_Escrow, "                                                                 // T_ESCROW
             + "         stor.t_ObosobFZRest, "                                                           // T_OBOSOBFZAMOUNT
             + "         stor.t_ObosobBRRest  "                                                           // T_OBOSOBBRAMOUNT
             + "    FROM davoiriss_dbt avr, dfininstr_dbt fin,";

             if(depoMode == 2) //КДУ
               query = query 
               + "         (SELECT SUM( qr.AccRest ) as T_Rest01," //T_OURAMOUNT
               + "                 0 as T_Rest03, "                                                                 //T_DUAMOUNT 
               + "                 0 as T_Rest04, "                                                                 //T_LOANAMOUNT
               + "                 SUM(CASE WHEN qr.IsRestFiscal <> CHR(0) THEN "
               + "                               qr.AccRest "                                                       //T_FISCALISSUERAMOUNT 
               + "                     ELSE 0 "
               + "                 END) as T_Rest05, "
               + "                 SUM(CASE WHEN qr.IsRestIssuer <> CHR(0) THEN "
               + "                               qr.AccRest "                                                       //T_FISCALISSUERAMOUNT 
               + "                     ELSE 0 "
               + "                 END) as T_Rest06, "                                                              //T_ISSUERAMOUNT
               + "                 0 as T_Rest07, "                                                                 //T_WRONGAMOUNT
               + "                 SUM((CASE WHEN qr.IsRestPawn <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_RestPawn, "
               + "                 SUM((CASE WHEN qr.IsRestCorp <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_RestCorpRestr, "
               + "                 SUM((CASE WHEN qr.IsRestOperBan <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_RestOperBan, "
               + "                 SUM((CASE WHEN qr.IsRestArrest <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_RestArrest, "
               + "                 SUM((CASE WHEN qr.IsRestTrade    <> CHR(0) OR "
               + "                                qr.IsRestArrest   <> CHR(0) OR "
               + "                                qr.IsRestOperBan  <> CHR(0) OR "
               + "                                qr.IsRestCorp     <> CHR(0) OR "
               + "                                qr.IsRestPawn     <> CHR(0) OR "
               + "                                qr.IsRestEncumber <> CHR(0) " // Golovkin 22.04.2019
               + "                           THEN qr.AccRest ELSE 0 END)) as T_EncumberRest, "           
               + "                 SUM((CASE WHEN qr.IsRestTrade <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_RestTrade, "
               + "                 SUM((CASE WHEN qr.IsEscrow <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_Escrow, "
               + "                 SUM((CASE WHEN qr.IsObosobFZ <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_ObosobFZRest, "
               + "                 SUM((CASE WHEN qr.IsObosobBR <> CHR(0) THEN qr.AccRest ELSE 0 END)) as T_ObosobBRRest, "
               + "                 qr.t_FIID as T_FIID, "
               + "                 qr.t_storageid AS t_StoragePlace "
               + "            FROM ( SELECT ABS(rsi_rsb_account.restac( acc.T_ACCOUNT, acc.T_CODE_CURRENCY,  "+RepDateSQL+", acc.t_CHAPTER, null )) as AccRest, "
/*
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 1, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestPawn, "     //Залог
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 2, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestTrade, "    //Торговый/клиринговый счет
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 3, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestCorp, "     //Ограничение в связи с КД
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 4, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestOperBan, "  //Запрет на операции
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 5, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestArrest, "   //Арест
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 101, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestFiscal, "   //Казначейский счет
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 102, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestIssuer, "   //Эмиссионный счет
               + "                          NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 103, "+RepDateSQL+")), CHR(0)), CHR(0)) as IsRestEncumber, " //Обременённые ц/б для формы 711
*/
               // Golovkin 10.09.2019 ID : 494320 Пока так
               +                            GetSqlKDUNote(1,   RepDateSQL) + " as IsRestPawn,     " //Залог 
               +                            GetSqlKDUNote(2,   RepDateSQL) + " as IsRestTrade,    " //Торговый/клиринговый счет
               +                            GetSqlKDUNote(3,   RepDateSQL) + " as IsRestCorp,     " //Ограничение в связи с КД
               +                            GetSqlKDUNote(4,   RepDateSQL) + " as IsRestOperBan,  " //Запрет на операции
               +                            GetSqlKDUNote(5,   RepDateSQL) + " as IsRestArrest,   " //Арест
               +                            GetSqlKDUNote(101, RepDateSQL) + " as IsRestFiscal,   " //Казначейский счет
               +                            GetSqlKDUNote(102, RepDateSQL) + " as IsRestIssuer,   " //Эмиссионный счет
               +                            GetSqlKDUNote(103, RepDateSQL) + " as IsRestEncumber, " //Обременённые ц/б для формы 711
               +                            GetSqlKDUNote(3,   RepDateSQL) + " as IsEscrow,       " //Ограничение в связи с КД
               +                            GetSqlKDUNote(3,   RepDateSQL) + " as IsObosobFZ,     " //Ограничение в связи с КД
               +                            GetSqlKDUNote(3,   RepDateSQL) + " as IsObosobBR,     " //Ограничение в связи с КД               
               + "                          QrAcc.t_FIID, QrAcc.t_storageid, QrAcc.t_depoacccode "
               + "                     FROM dscqracc_dbt QrAcc, daccount_dbt acc "
               + "                    WHERE QrAcc.t_accountid = acc.t_accountid "
               + "                      AND acc.t_chapter = 5"
               + "                 ) qr "
               + "           WHERE qr.AccRest != 0"
               + "          GROUP BY qr.t_FIID, qr.t_storageid"
               + "         ) stor,"
               +           SQL_QueryIssuer+" issuer"
               + "  WHERE avr.t_FIID = stor.t_FIID"
               + "    AND fin.T_FIID = avr.t_FIID"
               + "    AND issuer.t_FIID = fin.T_FIID)"
             elif(depoMode == 1) //Депозитарный учёт
               query = query
               + "         (SELECT SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 1 THEN (rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) ELSE 0 END) as T_Rest01,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 3 THEN (rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) ELSE 0 END) as T_Rest03," //T_DUAMOUNT
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 4 THEN (rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) ELSE 0 END) as T_Rest04," //
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 5 THEN (rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) ELSE 0 END) as T_Rest05," //T_FISCALISSUERAMOUNT
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 6 THEN (rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) ELSE 0 END) as T_Rest06," //T_ISSUERAMOUNT
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 7 THEN (rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 )) ELSE 0 END) as T_Rest07," //T_WRONGAMOUNT
               +                   GetQueryForBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
               +                   GetQueryForBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
               +                   GetQueryForBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
               +                   GetQueryForBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
               +                   GetQueryForBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
               +                   GetQueryForTradeSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL) + " as T_RestTrade, "
               +                   GetQueryForValBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLBLOCK_ESCROW, false) + " as T_Escrow, "
               +                   GetQueryForValBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLBLOCK_OBOSOBL, false) + " as t_ObosobFZRest, "
               +                   GetQueryForValBlockSub(fltr.BegDate, DATE_01_04_2018, RepDateSQL, LLBLOCK_OBOSOBBR, false) + " as t_ObosobBRRest, "
               + "                 acc.t_Code_Currency as T_FIID,"
               + "                 DECODE(NVL(ourOwner.t_IsOur, 0), 0, dacntAct.t_Owner, "+String({OurBank})+") AS t_StoragePlace"
               + "            FROM ourOwner, ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, daccvanl_dbt accvanl, daccsub_dbt accsub, daccount_dbt accAct, ddepoacnt_dbt dacntAct"
               + "          WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
               + "            AND dacnt.t_opendate <= "+RepDateSQL
               + "            AND dacnt.t_department IN ("+fltr.Departments+")"
               + "            AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+") != 1"  // НЕ закрытые
               + "            AND rsi_rsb_account.restac( acc.t_Account, acc.T_CODE_CURRENCY, "+RepDateSQL+", acc.t_Chapter, null ) != 0"
               + "            AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) "
               + "            AND rsb_depo.depokindtype( dacnt.T_AUTOKEY ) NOT IN (0, 98)"
               + "            AND dacnt.T_KIND = 2" // passive
               + "            AND dpac.t_ID = dacnt.t_Type"
               + "            AND acc.t_deporoot = dacnt.T_AUTOKEY"
               + "            AND acc.t_chapter = 5"
               + "            AND dacntPart.t_AutoKey = acc.t_DepoAcc"
               //             ----------- Место хранения ---
               + "            AND accvanl.t_Account = acc.t_Account"
               + "            AND accvanl.t_AnaliticsID = 2"
               + "            AND accvanl.t_FIID = acc.t_Code_Currency"
               + "            AND accvanl.t_Chapter = acc.t_Chapter"
               + "            AND accsub.t_AccAnaliticsID = accvanl.t_AccAnaliticsID"
               + "            AND accsub.t_SpecialType = 0"
               + "            AND accAct.t_Chapter = acc.t_Chapter"
               + "            AND accAct.t_Code_Currency = acc.t_Code_Currency"
               + "            AND accAct.t_Account = accsub.t_SubAccountCode"
               + "            AND accAct.t_Open_Date <= "+RepDateSQL
               + "            AND dacntAct.t_autokey = accAct.t_deporoot"
               + "            AND rsi_rsb_account.restsa( accsub.t_AccAnaliticsID, accsub.t_SubAccountID, "+RepDateSQL+", 1 ) > 0"
               + "            AND ourOwner.t_PartyID (+)= dacntAct.t_Owner "
               + "          GROUP BY acc.t_Code_Currency, DECODE(NVL(ourOwner.t_IsOur, 0), 0, dacntAct.t_Owner, "+String({OurBank})+")) stor,"
               +           SQL_QueryIssuer+" issuer"
               + "  WHERE avr.t_FIID = stor.t_FIID"
               + "    AND fin.T_FIID = avr.t_FIID"
               + "    AND issuer.t_FIID = fin.T_FIID)"
               // ИК
               + "UNION ALL"
               + "( SELECT stor.t_Issuer,"                                                                  // T_ISSUER
               + "         CHR(1),"                                                                         // T_ISSUERNAME
               + "         rsi_rsbparty.GetPartyCode(stor.t_Issuer, 16),"                                   // T_ISSUERINN
               + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
               + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
               + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
               + "         CHR(1),"                                                                         // T_ISSUERKPP,
               + "         rsi_rsbparty.GetPartyCode(stor.t_Issuer, 27),"                                   // T_ISSUEROGRN
               + "         CHR(1),"                                                                         // T_ISSUERCOUNTRYCODE
               + "         -1,"                                                                             // T_FIID
               + "         rsb_secur.GetObjAttrName(12, 1, stor.t_Code711),"                                // T_CODE711
               + "         CHR(1),"                                                                         // T_LSIN
               + "         CHR(1),"                                                                         // T_ISIN
               + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = stor.T_FACEVALUEFI),"
               + "             CHR(1)),"                                                                    // T_FACEVALUEFICODE
               + "         stor.T_FACEVALUE,"                                                               // T_FACEVALUE
               + "         2, "                                                                             // T_FACEVALUEPOINT
               + "         stor.t_Rest01,"                                                                  // T_OURAMOUNT
               + "         0.0,"                                                                            // T_REPOAMOUNT
               + "         0.0,"                                                                            // T_REPOAMOUNTAVR
               + "         stor.t_Rest07,"                                                                  // T_WRONGAMOUNT
               + "         stor.t_Rest03,"                                                                  // T_DUAMOUNT
               + "         stor.t_Rest05,"                                                                  // T_FISCALISSUERAMOUNT
               + "         stor.t_Rest04,"                                                                  // T_LOANAMOUNT
               + "         stor.t_Rest06,"                                                                  // T_ISSUERAMOUNT
               + "         stor.t_StoragePlace,"                                                            // T_STORAGEPLACE
               + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
               + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                             // T_STORAGEPLACEINN
               + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
               + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
               + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
               + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
               + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                             // T_STORAGEPLACEOGRN
               + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
               + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
               + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
               + "         stor.t_RestPawn,"                                                                // T_PAWNAMOUNT
               + "         stor.t_RestTrade,"                                                               // T_TRADEAMOUNT
               + "         stor.t_RestCorpRestr,"                                                           // T_CORPRESTRAMOUNT
               + "         stor.t_RestOperBan,"                                                             // T_OPERBANAMOUNT
               + "         stor.t_RestArrest,"                                                              // T_ARRESTAMOUNT
               + "         stor.t_EncumberRest,"                                                            // T_ENCUMBERAMOUNT
               + "         CHR(1), "                                                                        // T_NOTRESLICENSEDATE
               + "         CHR(1), "                                                                        // T_ORGANGIVELICENSE
               + "         stor.t_Escrow, "                                                                 // T_ESCROW
               + "         stor.t_ObosobFZRest, "                                                           // T_OBOSOBFZAMOUNT
               + "         stor.t_ObosobBRRest  "                                                           //T_OBOSOBBRAMOUNT
               + "    FROM "
               + "(SELECT SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 1 THEN vficert.t_Copies ELSE 0 END) as T_Rest01,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 3 THEN vficert.t_Copies ELSE 0 END) as T_Rest03,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 4 THEN vficert.t_Copies ELSE 0 END) as T_Rest04,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 5 THEN vficert.t_Copies ELSE 0 END) as T_Rest05,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 6 THEN vficert.t_Copies ELSE 0 END) as T_Rest06,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 7 THEN vficert.t_Copies ELSE 0 END) as T_Rest07,"
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
               +                   GetQueryForValBlockCert(fltr.BegDate, DATE_01_04_2018, LLBLOCK_ESCROW, false) + " as T_Escrow, "
               +                   GetQueryForValBlockCert(fltr.BegDate, DATE_01_04_2018, LLBLOCK_OBOSOBL, false) + " as t_ObosobFZRest, "
               +                   GetQueryForValBlockCert(fltr.BegDate, DATE_01_04_2018, LLBLOCK_OBOSOBBR, false) + " as t_ObosobBRRest, "
               +                   GetQueryForTradeCert(fltr.BegDate, DATE_01_04_2018) + " as T_RestTrade, "
               + "                 rsb_depo.icnominal(ic.t_InvCardID,"+RepDateSQL+", 1) AS t_FaceValue, "
               + "                 vficert.t_FaceValueFI as T_FaceValueFI,"
               + "                 part.T_PartyID as T_Issuer,"
               + "                 DECODE(NVL(ourOwner.t_IsOur, 0), 0, dacntAct.t_Owner, "+String({OurBank})+") AS t_StoragePlace,"
               + "                 rsb_secur.GetMainObjAttr(12, LPAD(fin.t_FIID, 10, '0'), 1, "+RepDateSQL+") AS t_Code711"
               + "           FROM ourOwner, ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, dinvcard_dbt ic, dv_ficert_dbt vficert, daccount_dbt accAct, ddepoacnt_dbt dacntAct , dparty_dbt part, dfininstr_dbt fin"
               + "          WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
               + "            AND dacnt.t_opendate <= "+RepDateSQL
               + "            AND dacnt.t_department IN ("+fltr.Departments+")"
               + "            AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+") != 1" // НЕ закрытые
               + "            AND rsi_rsb_account.restac( acc.t_Account, acc.T_CODE_CURRENCY, "+RepDateSQL+", acc.t_Chapter, null ) != 0"
               + "            AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) AND rsb_depo.depokindtype( dacnt.T_AUTOKEY ) NOT IN (0, 98)"
               + "            AND dacnt.T_KIND = 2" // passive
               + "            AND dpac.t_ID = dacnt.t_Type"
               + "            AND acc.t_deporoot = dacnt.T_AUTOKEY"
               + "            AND acc.t_chapter = 5"
               + "            AND dacntPart.t_AutoKey = acc.t_DepoAcc"
               //             ----------- Место хранения ---
               + "            AND rsb_depo.icstatus(ic.t_InvCardID, "+RepDateSQL+") = " + INVCARD_STATUS_INCUSTODY // на хранении
               + "            AND rsb_depo.icaccountid(ic.t_InvCardID, 2, "+RepDateSQL+") = acc.t_AccountID"
               + "            AND vficert.t_FiCertID = ic.t_FiCertID "
               + "            AND vficert.t_FIID = acc.t_Code_Currency"
               + "            AND part.t_PartyID = rsb_deals.GetFicertIssuer(vficert.t_FiCertID) "
               + "            AND part.t_LegalForm = " + PTLEGF_INST
               + "            AND accAct.t_Chapter = acc.t_Chapter"
               + "            AND accAct.t_Code_Currency = acc.t_Code_Currency"
               + "            AND accAct.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 1, "+RepDateSQL+")"
               + "            AND accAct.t_Open_Date <= "+RepDateSQL+""
               + "            AND dacntAct.t_autokey = accAct.t_deporoot"
               + "            AND fin.t_FIID = vficert.t_FIID "
               + "            AND ourOwner.t_PartyID (+)= dacntAct.t_Owner "
               + "            AND RSI_RSB_FIInstr.FI_IsSecurIndividual(fin.t_FIID) <> 0"
               + "        GROUP BY part.t_PartyID, vficert.t_FaceValueFI, rsb_depo.icnominal(ic.t_InvCardID,"+RepDateSQL+", 1),"
               + "                 DECODE(NVL(ourOwner.t_IsOur, 0), 0, dacntAct.t_Owner, "+String({OurBank})+"), fin.t_AvoirKind,"
               + "                 rsb_secur.GetMainObjAttr(12, LPAD(fin.t_FIID, 10, '0'), 1, "+RepDateSQL+")"
               + "         ) stor"
               + ")"
               // Закладные
               + "UNION ALL"
               + "( SELECT "
               + "         -1,  "                                                                           // T_ISSUER
               + "         'Физические лица',"                                                              // T_ISSUERNAME
               + "         CHR(1),"                                                                         // T_ISSUERINN
               + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
               + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
               + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
               + "         CHR(1),"                                                                         // T_ISSUERKPP
               + "         CHR(1),"                                                                         // T_ISSUEROGRN
               + "         stor.t_countryPhis,"                                                             // T_ISSUERCOUNTRYCODE
               + "         -1,"                                                                             // T_FIID
               + "         'ENC',"                                                                          // T_CODE711
               + "         CHR(1),"                                                                         // T_LSIN
               + "         CHR(1),"                                                                         // T_ISIN
               + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = stor.T_FACEVALUEFI),"
               + "             CHR(1)),"                                                                    // T_FACEVALUEFICODE
               + "         stor.T_FACEVALUE,"                                                               // T_FACEVALUE
               + "         2, "                                                                             // T_FACEVALUEPOINT
               + "         stor.t_Rest01,"                                                                  // T_OURAMOUNT
               + "         0.0, "                                                                           // T_REPOAMOUNT
               + "         0.0, "                                                                           // T_REPOAMOUNTAVR
               + "         stor.t_Rest07,"                                                                  // T_WRONGAMOUNT
               + "         stor.t_Rest03,"                                                                  // T_DUAMOUNT
               + "         stor.t_Rest05,"                                                                  // T_FISCALISSUERAMOUNT
               + "         stor.t_Rest04,"                                                                  // T_LOANAMOUNT
               + "         stor.t_Rest06,"                                                                  // T_ISSUERAMOUNT
               + "         stor.t_StoragePlace,"                                                            // T_STORAGEPLACE
               + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
               + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 16),"                             // T_STORAGEPLACEINN
               + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
               + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
               + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
               + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
               + "         rsi_rsbparty.GetPartyCode(stor.t_StoragePlace, 27),"                             // T_STORAGEPLACEOGRN
               + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
               + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
               + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
               + "         stor.t_RestPawn,"                                                                // T_PAWNAMOUNT
               + "         stor.t_RestTrade,"                                                               // T_TRADEAMOUNT
               + "         stor.t_RestCorpRestr,"                                                           // T_CORPRESTRAMOUNT
               + "         stor.t_RestOperBan,"                                                             // T_OPERBANAMOUNT
               + "         stor.t_RestArrest,"                                                              // T_ARRESTAMOUNT
               + "         stor.t_EncumberRest,"                                                            // T_ENCUMBERAMOUNT
               + "         CHR(1), "                                                                        // T_NOTRESLICENSEDATE
               + "         CHR(1), "                                                                        // T_ORGANGIVELICENSE
               + "         stor.t_Escrow, "                                                                 // T_ESCROW
               + "         stor.t_ObosobFZRest, "                                                           // T_OBOSOBFZAMOUNT
               + "         stor.t_ObosobBRRest  "                                                           // T_OBOSOBBRAMOUNT
               + "    FROM (SELECT DECODE(part.t_NotResident,chr(88), part.t_NRCountry, 'RUS') as t_countryPhis, "
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 1 THEN vficert.t_Copies ELSE 0 END) as T_Rest01,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 3 THEN vficert.t_Copies ELSE 0 END) as T_Rest03,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 4 THEN vficert.t_Copies ELSE 0 END) as T_Rest04,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 5 THEN vficert.t_Copies ELSE 0 END) as T_Rest05,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 6 THEN vficert.t_Copies ELSE 0 END) as T_Rest06,"
               + "                 SUM(case WHEN rsb_depo.depokindtype(dacnt.T_AUTOKEY) = 7 THEN vficert.t_Copies ELSE 0 END) as T_Rest07,"
               + "                 0.0 as t_RestREPO,"
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_PAWN, false) + " as T_RestPawn, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_CORPRESTRICT, true) + " as T_RestCorpRestr, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_OPERBAN, false) + " as T_RestOperBan, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_ARREST, false) + " as T_RestArrest, "
               +                   GetQueryForBlockCert(fltr.BegDate, DATE_01_04_2018, LLCLASS_KIND_BLOCK_CB_ENCUMBER711, false) + " as T_EncumberRest, "
               +                   GetQueryForValBlockCert(fltr.BegDate, DATE_01_04_2018, LLBLOCK_ESCROW, false/*true*/, true) + " as T_Escrow, "
               +                   GetQueryForValBlockCert(fltr.BegDate, DATE_01_04_2018, LLBLOCK_OBOSOBL, false/*true*/, true) + " as t_ObosobFZRest, "
               +                   GetQueryForValBlockCert(fltr.BegDate, DATE_01_04_2018, LLBLOCK_OBOSOBBR, false/*true*/, true) + " as t_ObosobBRRest, "
               +                   GetQueryForTradeCert(fltr.BegDate, DATE_01_04_2018) + " as T_RestTrade, "
               + "                 SUM (mort.T_AMOUNT) AS T_FaceValue, "
               + "                 vficert.t_FaceValueFI as T_FaceValueFI,"
               + "                 DECODE(NVL(ourOwner.t_IsOur, 0), 0, dacntAct.t_Owner, "+String({OurBank})+") AS t_StoragePlace"
               + "            FROM ourOwner,  ddepoacnt_dbt dacnt, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, dinvcard_dbt ic, dv_ficert_dbt vficert, dmortgage_dbt mort, daccount_dbt accAct, ddepoacnt_dbt dacntAct, dparty_dbt part,"
               + "                 (SELECT atc.t_object, att.t_name"
               + "                     FROM dobjattr_dbt att,"
               + "                          (SELECT DECODE(t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
               + "                                  DECODE(t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
               + "                                  atc.t_objectType AS t_realObjectType,"
               + "                                  atc.t_groupId AS t_realGroupId,"
               + "                                  atc.t_attrId t_attrId,"
               + "                                  atc.t_object t_object,"
               + "                                  atc.t_validToDate t_validToDate,"
               + "                                  atc.t_validFromDate t_validFromDate"
               + "                             FROM dobjatcor_dbt atc,"
               + "                                  dobjgroup_dbt grp"
               + "                            WHERE atc.t_groupId = grp.t_groupId"
               + "                              AND atc.t_objectType = grp.t_objectType"
               + "                              AND atc.t_general = 'X') atc"
               + "                    WHERE atc.t_attrId = att.t_attrId"
               + "                      AND atc.t_objectType = att.t_objectType"
               + "                      AND atc.t_groupId = att.t_groupId"
               + "                      AND "  +RepDateSQL+ " BETWEEN atc.t_validFromDate AND atc.t_validToDate"
               + "                      AND atc.t_realObjectType = 24 " // Сертификат документарной ц/б
               + "                      AND atc.t_realGroupId = 1) objCert711"
               + "          WHERE dacnt.T_AUTOKEY = dacnt.t_Root"
               + "            AND dacnt.t_opendate <= "+RepDateSQL+""
               + "            AND dacnt.t_department IN ("+fltr.Departments+")"
               + "            AND rsb_depo.depostatus( dacnt.T_AUTOKEY, "+RepDateSQL+" ) != 1" // НЕ закрытые
               + "            AND rsi_rsb_account.restac( acc.t_Account, acc.T_CODE_CURRENCY, "+RepDateSQL+", acc.t_Chapter, null ) != 0"
               + "            AND DECODE(dacnt.t_owner, 0, "+String({OurBank})+", dacnt.t_owner) IN (SELECT dp.t_PartyID from ddp_dep_dbt dp) "
               + "            AND rsb_depo.depokindtype( dacnt.T_AUTOKEY ) NOT IN (0, 98)"
               + "            AND dacnt.T_KIND = 2" // passive
               + "            AND dpac.t_ID = dacnt.t_Type"
               + "            AND acc.t_deporoot = dacnt.T_AUTOKEY"
               + "            AND acc.t_chapter = 5"
               + "            AND dacntPart.t_AutoKey = acc.t_DepoAcc"
               //             ----------- Место хранения ---
               + "            AND vficert.t_FiCertID = ic.t_FiCertID "
               + "            AND RSB_FIInstr.FI_AvrKindsEQ(2, "+AVOIRISSKIND_MORTGAGE+", vficert.t_AvoirKind) > 0 "
               + "            AND mort.t_MortgageID = vficert.t_CertID "
               + "            AND part.T_PartyID = rsb_deals.GetFicertIssuer(vficert.t_FiCertID) "
               + "            AND part.t_LegalForm = " + PTLEGF_PERSN
               + "            AND objCert711.t_object = vficert.t_FiCertID"
               + "            AND objCert711.t_Name = 'ENC'"
               + "            AND rsb_depo.icstatus(ic.t_InvCardID, "+RepDateSQL+") = " + INVCARD_STATUS_INCUSTODY // на хранении
               + "            AND rsb_depo.icaccountid(ic.t_InvCardID, 2, "+RepDateSQL+") = acc.t_AccountID"
               + "            AND vficert.t_FIID = acc.t_Code_Currency"
               + "            AND accAct.t_Chapter = acc.t_Chapter"
               + "            AND accAct.t_Code_Currency = acc.t_Code_Currency"
               + "            AND accAct.t_AccountID = rsb_depo.icaccountid(ic.t_InvCardID, 1, "+RepDateSQL+")"
               + "            AND accAct.t_Open_Date <= "+RepDateSQL+""
               + "            AND dacntAct.t_autokey = accAct.t_deporoot"
               + "            AND ourOwner.t_PartyID (+)= dacntAct.t_Owner "
               + "        GROUP BY DECODE(NVL(ourOwner.t_IsOur, 0), 0, dacntAct.t_Owner, "+String({OurBank})+"),  vficert.t_FaceValueFI, DECODE(part.t_NotResident,chr(88), part.t_NRCountry, 'RUS')) stor"
               + ")";
            end;

      //println("1.3: " + query);
      SQL_Execute(query, "Сбор данных о цб, учитываемых на счетах кредитной организации", true );
    end;

    if(depoMode == 2) //КДУ
      //Добавить бумаги, которые учитываются в сторонних депозитариях (есть лоты, но нет в регистре КДУ)
      query =  "INSERT INTO d711avoir_tmp ("
             + "    T_ISSUER,"
             + "    T_ISSUERNAME,"
             + "    T_ISSUERINN,"
             + "    T_ISSUERINN_MARK,"
             + "    T_ISSUERINN_TIN,"
             + "    T_ISSUERNOTRESCODE,"
             + "    T_ISSUERKPP,"
             + "    T_ISSUEROGRN,"
             + "    T_ISSUERCOUNTRYCODE,"
             + "    T_FIID,"
             + "    T_CODE711,"
             + "    T_LSIN,"
             + "    T_ISIN,"
             + "    T_FACEVALUEFICODE,"
             + "    T_FACEVALUE,"
             + "    T_FACEVALUEPOINT,"
             + "    T_OURAMOUNT,"
             + "    T_REPOAMOUNT,"
             + "    T_REPOAMOUNTAVR,"
             + "    T_WRONGAMOUNT,"
             + "    T_DUAMOUNT,"
             + "    T_FISCALISSUERAMOUNT,"
             + "    T_LOANAMOUNT,"
             + "    T_ISSUERAMOUNT,"
             + "    T_STORAGEPLACE,"
             + "    T_STORAGEPLACENAME,"
             + "    T_STORAGEPLACEINN,"
             + "    T_STORAGEPLACEINN_MARK,"
             + "    T_STORAGEPLACEINN_TIN,"
             + "    T_STORAGEPLACENOTRESCODE,"
             + "    T_STORAGEPLACEKPP,"
             + "    T_STORAGEPLACEOGRN,"
             + "    T_STORAGEPLACECOUNTRYCODE,"
             + "    T_STORAGEPLACELICENSE,"
             + "    T_STORAGEPLACEMARK,"
             + "    T_PAWNAMOUNT,"
             + "    T_TRADEAMOUNT,"
             + "    T_CORPRESTRAMOUNT,"
             + "    T_OPERBANAMOUNT,"
             + "    T_ARRESTAMOUNT,"
             + "    T_ENCUMBERAMOUNT,"
             +"     T_NOTRESLICENSEDATE, "
             +"     T_ORGANGIVELICENSE, "
             +"     T_ESCROWAMOUNT, "
             + "    T_OBOSOBFZAMOUNT, "
             + "    T_OBOSOBBRAMOUNT "
             + "   )"
             + "  SELECT /*+ leading(t)*/ issuer.t_Issuer,"                                                                // T_ISSUER
             + "         CHR(1),"                                                                         // T_ISSUERNAME
             + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16),"                                 // T_ISSUERINN
             + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
             + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
             + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
             + "         CHR(1),"                                                                         // T_ISSUERKPP
             + "         rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27),"                                 // T_ISSUEROGRN
             + "         CHR(1),"                                                                         // T_ISSUERCOUNTRYCODE
             + "         t.t_FIID as T_FIID,"                                                             // T_FIID
             + "         rsb_secur.GetObjAttrName(12, 1,"
             + "                                  rsb_secur.GetMainObjAttr(12,"
             + "                                                           LPAD(t.t_FIID, 10, '0'),"
             + "                                                           1, "+RepDateSQL+")),"          // T_CODE711
             + "         avr.T_LSIN,"                                                                     // T_LSIN
             + "         avr.T_ISIN,"                                                                     // T_ISIN
             + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI),"
             + "             CHR(1)),"                                                                    // T_FACEVALUEFICODE
             + "         NVL(rsb_fiinstr.FI_GetNominalOnDate(t.t_FIID, "+RepDateSQL+" ), 0.0),"           // T_FACEVALUE
             + "         fin.T_POINT+2, "                                                                 // T_FACEVALUEPOINT
             + "         t.t_Amount,"                                                                     // T_OURAMOUNT
             +           GetQuerySumRepo(false, RepDateSQL)+","                                           // T_REPOAMOUNT
             +           GetQuerySumRepo(false, RepDateSQL)+","                                           // T_REPOAMOUNTAVR
             + "         0,"                                                                              // T_WRONGAMOUNT
             + "         0,"                                                                              // T_DUAMOUNT
             + "         0,"                                                                              // T_FISCALISSUERAMOUNT
             + "         0,"                                                                              // T_LOANAMOUNT
             + "         0,"                                                                              // T_ISSUERAMOUNT
             + "         rq.t_PlaceID,"                                                                   // T_STORAGEPLACE
             + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
             + "         rsi_rsbparty.GetPartyCode(rq.t_PlaceID, 16),"                                    // T_STORAGEPLACEINN
             + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
             + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
             + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
             + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
             + "         rsi_rsbparty.GetPartyCode(rq.t_PlaceID, 27),"                                    // T_STORAGEPLACEOGRN
             + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
             + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
             + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
             + "         0,"                                                                              // T_PAWNAMOUNT
             + "         0,"                                                                              // T_TRADEAMOUNT
             + "         0,"                                                                              // T_CORPRESTRAMOUNT
             + "         0,"                                                                              // T_OPERBANAMOUNT
             + "         0,"                                                                              // T_ARRESTAMOUNT
             + "         0,"                                                                              // T_ENCUMBERAMOUNT
             + "         CHR(1), "                                                                        // T_NOTRESLICENSEDATE
             + "         CHR(1), "                                                                        // T_ORGANGIVELICENSE
             + "         0, "                                                                             // T_ESCROW
             + "         0, "                                                                             // T_OBOSOBFZAMOUNT
             + "         0  "                                                                             // T_OBOSOBBRAMOUNT
             + "  FROM v_scwrthistex t, davoiriss_dbt avr, dfininstr_dbt fin, ddlrq_dbt rq, "
             +         SQL_QueryIssuer+" issuer"
             + " WHERE t.t_buy_sale = " + PM_WRITEOFF_SUM_BUY
             + "   AND t.t_party = -1 "
             + "   AND t.t_dockind = " + DLDOC_PAYMENT
             + "   AND t.t_dealid > 0 "
             + "   AND t.t_kind in(20,210,40,110,130,90)"
             + "   AND t.t_Amount != 0"
             + "   AND (t.t_state = "+PM_WRTSUM_FORM
                 + " OR t.t_state = "+PM_WRTSUM_SALE_BPP+") "
             + "   AND NOT EXISTS(SELECT 1 FROM dscqracc_dbt QrAcc WHERE QrAcc.T_FIID = t.t_FIID)"
             + "   AND t.t_instance = (SELECT MAX (t_instance)"
             + "                         FROM v_scwrthistex "
             + "                        WHERE t_sumid = t.t_sumid "
             + "                          AND t_changedate <= "+RepDateSQL
             + "                          AND t.t_Portfolio in ("+KINDPORT_TRADE+","+KINDPORT_SALE+","+KINDPORT_CONTR+","+KINDPORT_PROMISSORY+","+KINDPORT_RETIRE+"))"
             + "   AND avr.t_FIID = t.t_FIID"
             + "   AND issuer.t_FIID = avr.t_FIID"
             + "   AND fin.t_FIID = avr.t_FIID"
             + "   AND rq.t_ID = t.t_DocID";

      SQL_Execute(query, "Сбор данных о цб, учитываемых на счетах кредитной организации", true );
    end;

    //добавить бумаги, по которым есть РЕПО, но нет никакой информации в Депозитарии
    query =  "INSERT INTO d711avoir_tmp ("
           + "    T_ISSUER,"
           + "    T_ISSUERNAME,"
           + "    T_ISSUERINN,"
           + "    T_ISSUERINN_MARK,"
           + "    T_ISSUERINN_TIN,"
           + "    T_ISSUERNOTRESCODE,"
           + "    T_ISSUERKPP,"
           + "    T_ISSUEROGRN,"
           + "    T_ISSUERCOUNTRYCODE,"
           + "    T_FIID,"
           + "    T_CODE711,"
           + "    T_LSIN,"
           + "    T_ISIN,"
           + "    T_FACEVALUEFICODE,"
           + "    T_FACEVALUE,"
           + "    T_FACEVALUEPOINT,"
           + "    T_OURAMOUNT,"
           + "    T_REPOAMOUNT,"
           + "    T_REPOAMOUNTAVR,"
           + "    T_WRONGAMOUNT,"
           + "    T_DUAMOUNT,"
           + "    T_FISCALISSUERAMOUNT,"
           + "    T_LOANAMOUNT,"
           + "    T_ISSUERAMOUNT,"
           + "    T_STORAGEPLACE,"
           + "    T_STORAGEPLACENAME,"
           + "    T_STORAGEPLACEINN,"
           + "    T_STORAGEPLACEINN_MARK,"
           + "    T_STORAGEPLACEINN_TIN,"
           + "    T_STORAGEPLACENOTRESCODE,"
           + "    T_STORAGEPLACEKPP,"
           + "    T_STORAGEPLACEOGRN,"
           + "    T_STORAGEPLACECOUNTRYCODE,"
           + "    T_STORAGEPLACELICENSE,"
           + "    T_STORAGEPLACEMARK,"
           + "    T_PAWNAMOUNT,"
           + "    T_TRADEAMOUNT,"
           + "    T_CORPRESTRAMOUNT,"
           + "    T_OPERBANAMOUNT,"
           + "    T_ARRESTAMOUNT,"
           + "    T_ENCUMBERAMOUNT,"
           + "    T_NOTRESLICENSEDATE, "
           + "    T_ORGANGIVELICENSE, "
           + "    T_ESCROWAMOUNT, "
           + "    T_OBOSOBFZAMOUNT, "
           + "    T_OBOSOBBRAMOUNT "
           + "   )"
           + "WITH ourOwner AS (SELECT count(1) as t_IsOur, t_PartyID FROM ddp_dep_dbt GROUP BY t_PartyID) "
           + "( SELECT q.t_Issuer,"                                                                     // T_ISSUER
           + "         CHR(1),"                                                                         // T_ISSUERNAME
           + "         rsi_rsbparty.GetPartyCode(q.t_Issuer, 16),"                                      // T_ISSUERINN
           + "         CHR(1),"                                                                         // T_ISSUERINN_MARK
           + "         CHR(1),"                                                                         // T_ISSUERINN_TIN
           + "         CHR(1),"                                                                         // T_ISSUERNOTRESCODE
           + "         CHR(1),"                                                                         // T_ISSUERKPP
           + "         rsi_rsbparty.GetPartyCode(q.t_Issuer, 27),"                                      // T_ISSUEROGRN
           + "         CHR(1),"                                                                         // T_ISSUERCOUNTRYCODE
           + "         q.t_FIID as T_FIID,"                                                             // T_FIID
           + "         rsb_secur.GetObjAttrName(12, 1,"
           + "                                  rsb_secur.GetMainObjAttr(12,"
           + "                                                           LPAD(q.t_FIID, 10, '0'),"
           + "                                                           1, "+RepDateSQL+")),"          // T_CODE711
           + "         q.T_LSIN,"                                                                       // T_LSIN
           + "         q.T_ISIN,"                                                                       // T_ISIN
           + "         NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = q.T_FACEVALUEFI),"
           + "             CHR(1)),"                                                                    // T_FACEVALUEFICODE
           + "         NVL(rsb_fiinstr.FI_GetNominalOnDate(q.t_FIID, "+RepDateSQL+" ), 0.0),"           // T_FACEVALUE
           + "         q.T_POINT+2, "                                                                   // T_FACEVALUEPOINT
           + "         q.t_RestRepo,"                                                                   // T_OURAMOUNT
           + "         q.t_RestRepo,"                                                                   // T_REPOAMOUNT
           + "         q.t_RestRepo, "                                                                  // T_REPOAMOUNTAVR
           + "         0,"                                                                              // T_WRONGAMOUNT
           + "         0,"                                                                              // T_DUAMOUNT
           + "         0,"                                                                              // T_FISCALISSUERAMOUNT
           + "         0,"                                                                              // T_LOANAMOUNT
           + "         0,"                                                                              // T_ISSUERAMOUNT
           + "         q.t_PlaceID,"                                                                    // T_STORAGEPLACE
           + "         CHR(1),"                                                                         // T_STORAGEPLACENAME
           + "         rsi_rsbparty.GetPartyCode(q.t_PlaceID, 16),"                                     // T_STORAGEPLACEINN
           + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_MARK
           + "         CHR(1),"                                                                         // T_STORAGEPLACEINN_TIN
           + "         CHR(1),"                                                                         // T_STORAGEPLACENOTRESCODE
           + "         CHR(1),"                                                                         // T_STORAGEPLACEKPP
           + "         rsi_rsbparty.GetPartyCode(q.t_PlaceID, 27),"                                     // T_STORAGEPLACEOGRN
           + "         CHR(1),"                                                                         // T_STORAGEPLACECOUNTRYCODE
           + "         CHR(1),"                                                                         // T_STORAGEPLACELICENSE
           + "         CHR(0),"                                                                         // T_STORAGEPLACEMARK
           + "         0,"                                                                              // T_PAWNAMOUNT
           + "         0,"                                                                              // T_TRADEAMOUNT
           + "         0,"                                                                              // T_CORPRESTRAMOUNT
           + "         0,"                                                                              // T_OPERBANAMOUNT
           + "         0,"                                                                              // T_ARRESTAMOUNT
           + "         0,"                                                                              // T_ENCUMBERAMOUNT
           + "         CHR(1), "                                                                        // T_NOTRESLICENSEDATE
           + "         CHR(1), "                                                                        // T_ORGANGIVELICENSE
           + "         0, "                                                                             // T_ESCROW
           + "         0, "                                                                             // T_OBOSOBFZAMOUNT
           + "         0  "                                                                             // T_OBOSOBBRAMOUNT
           + "    FROM (SELECT issuer.t_Issuer, avr.t_FIID, avr.T_LSIN, avr.T_ISIN, fin.T_POINT, fin.T_FACEVALUEFI,  "
           +              GetQuerySumRepo(false, RepDateSQL) +" t_RestRepo,"
           + "            f.t_PlaceID "
           + "            FROM davoiriss_dbt avr, dfininstr_dbt fin,"
           + "                 (SELECT rq_sp1.t_FIID, rq_sp1.t_PlaceID "
           + "                    FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, "
           + "                     (SELECT t_Kind_Operation, t_DocKind, rsb_secur.get_OperationGroup(t_SysTypes) oGrp FROM doprkoper_dbt) Opr "
           + "                   WHERE rq_sp1.t_State = " + DLRQ_STATE_EXEC /*ТО по 1-й части д.б. исполнено*/
           + "                     AND rq_sp1.t_Type  = " + DLRQ_TYPE_DELIVERY
           + "                     AND rq_sp1.t_DealPart = 1 "
           + "                     AND rq_sp1.t_FactDate <= " + RepDateSQL
           + "                     AND Tick.t_DealID = rq_sp1.t_DocID "
           + "                     AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "

           + "                     AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY /*ТО по 2-й части */
           + "                     AND rq_sp2.t_DealPart = 2 "
           + "                     AND rq_sp2.t_FIID = rq_sp1.t_FIID "
           + "                     AND rq_sp2.t_DocID = Tick.t_DealID "
           + "                     AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "

           + "                     AND rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, " + RepDateSQL + ") <> " + DLRQ_STATE_EXEC /*ТО по 2-й части РЕПО не исполнено*/

           + "                     AND Opr.t_Kind_Operation = Tick.t_DealType "
           + "                     AND Opr.t_DocKind = Tick.t_BOfficeKind "
           + "                     AND Tick.t_DealStatus > " + DL_PREPARING
           + "                     AND Rsb_Secur.IsRepo(Opr.oGrp)=1 "
           + "                     AND Rsb_Secur.IsBuy(Opr.oGrp)=1 "
           + "                     AND GRDEAL.T_DOCID = Tick.t_DealID "
           + "                     AND GRDEAL.T_DOCKIND = TICK.T_BOFFICEKIND "
           + "                     AND RSI_DLRQ.RSI_GetRQByDepoGrDeal(GRDEAL.T_ID, rq_sp1.t_FIID) = rq_sp1.t_ID "
           + "                     AND gracc.t_GrDealID = grdeal.t_ID "
           + "                     AND gracc.t_AccNum = " + DLGR_ACCKIND_CUSTODY
           + "                     AND gracc.t_State = " + DLGRACC_STATE_FACTEXEC
           + "                     AND NOT EXISTS (SELECT 1 "
           + "                                       FROM dspdrprop_dbt prop "
           + "                                      WHERE prop.t_DocumentKind = " + DL_DLGRDEAL
           + "                                        AND prop.t_DocumentID = GRDEAL.T_ID "
           + "                                    )"
           + "                   GROUP BY rq_sp1.t_FIID, rq_sp1.t_PlaceID"
           + "                 ) f, "
           +                   SQL_QueryIssuer+" issuer"
           + "          WHERE avr.t_FIID NOT IN (SELECT DISTINCT t_FIID FROM d711avoir_tmp) "
           + "            AND avr.t_FIID = f.t_FIID "
           + "            AND fin.T_FIID = avr.t_FIID "
           + "            AND issuer.t_FIID = fin.T_FIID "
           + "         ) q"
           + "  WHERE q.t_RestRepo > 0 )";

    SQL_Execute(query, "Сбор данных о цб, учитываемых на счетах кредитной организации", true );
    
    /*
    //данные по УВ
    GetRegistryValue("УЧТЕННЫЕ ВЕКСЕЛЯ\\РЕЖИМ РАБОТЫ\\УВ В ДЕПОЗИТАРИИ", V_BOOL, OurBannersInDepository, err);
    if((err == 0) and not OurBannersInDepository)
      query = " INSERT INTO "
                + " d711avoir_tmp(t_Issuer "
                             + " ,t_IssuerName "
                             + " ,t_IssuerINN "
                             + " ,t_IssuerINN_Mark "
                             + " ,t_IssuerINN_TIN "
                             + " ,t_IssuerNotResCode "
                             + " ,t_IssuerKPP "
                             + " ,t_IssuerOGRN "
                             + " ,t_IssuerCountryCode "
                             + " ,t_FIID "
                             + " ,t_Code711 "
                             + " ,t_LSIN "
                             + " ,t_ISIN "
                             + " ,t_FaceValueFICode "
                             + " ,t_FaceValue "
                             + " ,t_FaceValuePoint "
                             + " ,t_OurAmount "
                             + " ,t_RepoAmount "
                             + " ,t_RepoAmountAvr "
                             + " ,t_WrongAmount "
                             + " ,t_DuAmount "
                             + " ,t_FiscalIssuerAmount "
                             + " ,t_LoanAmount "
                             + " ,t_IssuerAmount "
                             + " ,t_StoragePlace "
                             + " ,t_StoragePlaceName "
                             + " ,t_StoragePlaceINN "
                             + " ,t_StoragePlaceINN_Mark "
                             + " ,t_StoragePlaceINN_TIN "
                             + " ,t_StoragePlaceNotResCode "
                             + " ,t_StoragePlaceKPP "
                             + " ,t_StoragePlaceOGRN "
                             + " ,t_StoragePlaceCountryCode "
                             + " ,t_StoragePlaceLicense "
                             + " ,t_StoragePlaceMark "
                             + " ,t_PawnAmount "
                             + " ,t_TradeAmount "
                             + " ,t_CorpRestrAmount "
                             + " ,t_OperBanAmount "
                             + " ,t_ArrestAmount "
                             + " ,t_EncumberAmount "
                             + " ,T_NOTRESLICENSEDATE "
                             + " ,T_ORGANGIVELICENSE
                             + " ,T_ESCROWAMOUNT )"
                             + " ,t_ObosobFZAmount )"
                             + " ,t_ObosobBRAmount )"
                + " (SELECT "
                     + " bnr.t_Issuer AS t_Issuer "
                    + " ,CHR(1) AS t_IssuerName "
                    + " ,RSI_RSBPARTY.GetPartyCode(bnr.t_Issuer, " + PTCK_INN + ") AS t_IssuerINN "
                    + " ,CHR(1) AS t_IssuerINN_Mark "
                    + " ,CHR(1) AS t_IssuerINN_TIN "
                    + " ,CHR(1) AS t_IssuerNotResCode "
                    + " ,CHR(1) AS t_IssuerKPP "
                    + " ,RSI_RSBPARTY.GetPartyCode(bnr.t_Issuer, " + PTCK_OGRN + ") AS t_IssuerOGRN "
                    + " ,CHR(1) AS t_IssuerCountryCode "
                    + " ,-1 AS t_FIID "
                    + " ,RSB_SECUR.GetObjAttrName(" + OBJTYPE_AVOIRISS + ", 1, RSB_SECUR.GetMainObjAttr(" + OBJTYPE_AVOIRISS + ", LPAD(bnr.t_FIID, 10, '0'), 1, " + RepDateSQL + ")) AS t_Code711 "
                    + " ,CHR(1) AS t_LSIN "
                    + " ,CHR(1) AS t_ISIN "
                    + " ,(SELECT "
                          + " NVL(fi.t_ISO_Number, CHR(1)) "
                      + " FROM "
                          + " dfininstr_dbt fi "
                      + " WHERE "
                          + " fi.t_FIID = leg.t_PFI) AS t_FaceValueFICode "
                    + " ,leg.t_Principal AS t_FaceValue "
                    + " ,fi.t_Point + 2 AS t_FaceValuePoint "
                    + " ,COUNT(1) AS t_OurAmount "
                    + " ,0 AS t_RepoAmount "
                    + " ,0 AS t_RepoAmountAvr "
                    + " ,0 AS t_WrongAmount "
                    + " ,0 AS t_DuAmount "
                    + " ,0 AS t_FiscalIssuerAmount "
                    + " ,0 AS t_LoanAmount "
                    + " ,0 AS t_IssuerAmount "
                    + " ,-1 AS t_StoragePlace "
                    + " ,CHR(1) AS t_StoragePlaceName "
                    + " ,CHR(1) AS t_StoragePlaceINN "
                    + " ,CHR(1) AS t_StoragePlaceINN_Mark "
                    + " ,CHR(1) AS t_StoragePlaceINN_TIN "
                    + " ,CHR(1) AS t_StoragePlaceNotResCode "
                    + " ,CHR(1) AS t_StoragePlaceKPP "
                    + " ,CHR(1) AS t_StoragePlaceOGRN "
                    + " ,CHR(1) AS t_StoragePlaceCountryCode "
                    + " ,CHR(1) AS t_StoragePlaceLicense "
                    + " ,CHR(0) AS t_StoragePlaceMark "
                    + " ,0 AS t_PawnAmount "
                    + " ,0 AS t_TradeAmount "
                    + " ,0 AS t_CorpRestrAmount "
                    + " ,0 AS t_OperBanAmount "
                    + " ,0 AS t_ArrestAmount "
                    + " ,0 AS t_EncumberAmount "
                    + " ,CHR(1) AS T_NOTRESLICENSEDATE "            
                    + " ,CHR(1) AS T_ORGANGIVELICENSE "   
                    + " ,0 AS t_EscrowAmount "
                    + " ,0 AS t_ObosobFZRest "
                    + " ,0 AS t_ObosobBRRest "					
                 + " FROM "
                    + " dvsbanner_dbt bnr "
                   + " ,ddl_leg_dbt leg "
                   + " ,dfininstr_dbt fi "
                 + " WHERE "
                    + " bnr.t_RegistrationDate <= " + RepDateSQL + " "
                + " AND bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE + " "
                + " AND NOT EXISTS (SELECT "
                                    + " 1 "
                                + " FROM "
                                    + " ddp_dep_dbt dp_dep "
                                + " WHERE "
                                    + " dp_dep.t_PartyID = bnr.t_Issuer) "
                + " AND bnr.t_Department IN (" + fltr.Departments + ") "
                + " AND (RSB_BILL.GetVABnrStatusOnDate(bnr.t_BCID, " + RepDateSQL + ") = " + VABANNER_STATUS_ACCOUNT + " "
                  + " OR EXISTS (SELECT "
                                 + " 1 "
                             + " FROM "
                                 + " dvsbnrbck_dbt bck "
                             + " WHERE "
                                 + " bck.t_BCID = bnr.t_BCID "
                             + " AND bck.t_ChangeDate BETWEEN " + BegDateSQL + " AND " + RepDateSQL + " "
                             + " AND bck.t_OldABCStatus = " + VABANNER_STATUS_ACCOUNT + " "
                             + " AND bck.t_NewABCStatus <> " + VABANNER_STATUS_ACCOUNT + "))"
                + " AND RSB_BILL.GetVABnrClientOnDate(bnr.t_BCID, " + RepDateSQL + ") = -1 "
                + " AND RSB_FIINSTR.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", fi.t_AvoirKind) = 1 "
                + " AND RSB_BILL.GetVABnrBOOnDate(bnr.t_BCID, " + RepDateSQL + ") = '" + BO_VA + "' "
                + " AND RSB_SECUR.GetMainObjAttr(" + OBJTYPE_AVOIRISS + ", LPAD(bnr.t_FIID, 10, '0'), 1, " + RepDateSQL + ") <> 0 "
                + " AND leg.t_LegKind = " + LEG_KIND_VSBANNER + " "
                + " AND leg.t_DealID = bnr.t_BCID "
                + " AND leg.t_LegID = 0 "
                + " AND fi.t_FIID = bnr.t_FIID "
                + " GROUP BY "
                    + " bnr.t_Issuer "
                   + " ,leg.t_PFI "
                   + " ,leg.t_Principal "
                   + " ,RSB_SECUR.GetMainObjAttr(" + OBJTYPE_AVOIRISS + ", LPAD(bnr.t_FIID, 10, '0'), 1, " + RepDateSQL + ") "
                   + " ,fi.t_Point) ";

      SQL_Execute(query, "Сбор данных об учтенных векселях принадлежащих банку", true); //больше не требуется по #285346
    end;

    //данные по СВ
    if(err == 0)
      query = " INSERT INTO "
                + " d711avoir_tmp(t_Issuer "
                             + " ,t_IssuerName "
                             + " ,t_IssuerINN "
                             + " ,t_IssuerINN_Mark "
                             + " ,t_IssuerINN_TIN "
                             + " ,t_IssuerNotResCode "
                             + " ,t_IssuerKPP "
                             + " ,t_IssuerOGRN "
                             + " ,t_IssuerCountryCode "
                             + " ,t_FIID "
                             + " ,t_Code711 "
                             + " ,t_LSIN "
                             + " ,t_ISIN "
                             + " ,t_FaceValueFICode "
                             + " ,t_FaceValue "
                             + " ,t_FaceValuePoint "
                             + " ,t_OurAmount "
                             + " ,t_RepoAmount "
                             + " ,t_RepoAmountAvr "
                             + " ,t_WrongAmount "
                             + " ,t_DuAmount "
                             + " ,t_FiscalIssuerAmount "
                             + " ,t_LoanAmount "
                             + " ,t_IssuerAmount "
                             + " ,t_StoragePlace "
                             + " ,t_StoragePlaceName "
                             + " ,t_StoragePlaceINN "
                             + " ,t_StoragePlaceINN_Mark "
                             + " ,t_StoragePlaceINN_TIN "
                             + " ,t_StoragePlaceNotResCode "
                             + " ,t_StoragePlaceKPP "
                             + " ,t_StoragePlaceOGRN "
                             + " ,t_StoragePlaceCountryCode "
                             + " ,t_StoragePlaceLicense "
                             + " ,t_StoragePlaceMark "
                             + " ,t_PawnAmount "
                             + " ,t_TradeAmount "
                             + " ,t_CorpRestrAmount "
                             + " ,t_OperBanAmount "
                             + " ,t_ArrestAmount "
                             + " ,t_EncumberAmount "
                             + " ,T_NOTRESLICENSEDATE "
                             + " ,T_ORGANGIVELICENSE 
                             + " ,t_EscrowAmount "
                             + " ,t_ObosobFZAmount "
                             + " ,t_ObosobBRAmount "
                + " (SELECT "
                     + " bnr.t_Issuer AS t_Issuer "
                    + " ,CHR(1) AS t_IssuerName "
                    + " ,RSI_RSBPARTY.GetPartyCode(bnr.t_Issuer, " + PTCK_INN + ") AS t_IssuerINN "
                    + " ,CHR(1) AS t_IssuerINN_Mark "
                    + " ,CHR(1) AS t_IssuerINN_TIN "
                    + " ,CHR(1) AS t_IssuerNotResCode "
                    + " ,CHR(1) AS t_IssuerKPP "
                    + " ,RSI_RSBPARTY.GetPartyCode(bnr.t_Issuer, " + PTCK_OGRN + ") AS t_IssuerOGRN "
                    + " ,CHR(1) AS t_IssuerCountryCode "
                    + " ,-1 AS t_FIID "
                    + " ,RSB_SECUR.GetObjAttrName(" + OBJTYPE_AVOIRISS + ", 1, RSB_SECUR.GetMainObjAttr(" + OBJTYPE_AVOIRISS + ", LPAD(bnr.t_FIID, 10, '0'), 1, " + RepDateSQL + ")) AS t_Code711 "
                    + " ,CHR(1) AS t_LSIN "
                    + " ,CHR(1) AS t_ISIN "
                    + " ,(SELECT "
                          + " NVL(fi.t_ISO_Number, CHR(1)) "
                      + " FROM "
                          + " dfininstr_dbt fi "
                      + " WHERE "
                          + " fi.t_FIID = leg.t_PFI) AS t_FaceValueFICode "
                    + " ,leg.t_Principal AS t_FaceValue "
                    + " ,fi.t_Point + 2 AS t_FaceValuePoint "
                    + " ,COUNT(1) AS t_OurAmount "
                    + " ,0 AS t_RepoAmount "
                    + " ,0 AS t_RepoAmountAvr "
                    + " ,0 AS t_WrongAmount "
                    + " ,0 AS t_DuAmount "
                    + " ,0 AS t_FiscalIssuerAmount "
                    + " ,0 AS t_LoanAmount "
                    + " ,0 AS t_IssuerAmount "
                    + " ,-1 AS t_StoragePlace "
                    + " ,CHR(1) AS t_StoragePlaceName "
                    + " ,CHR(1) AS t_StoragePlaceINN "
                    + " ,CHR(1) AS t_StoragePlaceINN_Mark "
                    + " ,CHR(1) AS t_StoragePlaceINN_TIN "
                    + " ,CHR(1) AS t_StoragePlaceNotResCode "
                    + " ,CHR(1) AS t_StoragePlaceKPP "
                    + " ,CHR(1) AS t_StoragePlaceOGRN "
                    + " ,CHR(1) AS t_StoragePlaceCountryCode "
                    + " ,CHR(1) AS t_StoragePlaceLicense "
                    + " ,CHR(0) AS t_StoragePlaceMark "
                    + " ,COUNT(1) AS t_PawnAmount "
                    + " ,0 AS t_TradeAmount "
                    + " ,0 AS t_CorpRestrAmount "
                    + " ,0 AS t_OperBanAmount "
                    + " ,0 AS t_ArrestAmount "
                    + " ,COUNT(1) AS t_EncumberAmount "
                    + " ,CHR(1) AS T_NOTRESLICENSEDATE "            
                    + " ,CHR(1) AS T_ORGANGIVELICENSE "      
                    + " ,0 AS t_EscrowAmount "
                    + " ,0 AS t_ObosobFZAmount "
                    + " ,0 AS t_ObosobBRAmount "				
                 + " FROM "
                    + " dvsbanner_dbt bnr "
                   + " ,ddl_leg_dbt leg "
                   + " ,dfininstr_dbt fi "
                 + " WHERE "
                    + " bnr.t_RegistrationDate <= " + RepDateSQL + " "
                + " AND bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE + " "
                + " AND EXISTS (SELECT "
                                    + " 1 "
                                + " FROM "
                                    + " ddp_dep_dbt dp_dep "
                                + " WHERE "
                                    + " dp_dep.t_PartyID = bnr.t_Issuer) "
                + " AND bnr.t_Department IN (" + fltr.Departments + ") "
                + " AND RSB_BILL.GetVSBnrStatusOnDate(bnr.t_BCID, " + RepDateSQL + ") = " + VSBANNER_STATUS_PAWN + " "
                + " AND RSB_FIINSTR.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", fi.t_AvoirKind) = 1 "
                + " AND BNR.T_BACKOFFICE = '" + BO_VS + "' "
                + " AND RSB_SECUR.GetMainObjAttr(" + OBJTYPE_AVOIRISS + ", LPAD(bnr.t_FIID, 10, '0'), 1, " + RepDateSQL + ") <> 0 "
                + " AND leg.t_LegKind = " + LEG_KIND_VSBANNER + " "
                + " AND leg.t_DealID = bnr.t_BCID "
                + " AND leg.t_LegID = 0 "
                + " AND fi.t_FIID = bnr.t_FIID "
                + " GROUP BY "
                    + " bnr.t_Issuer "
                   + " ,leg.t_PFI "
                   + " ,leg.t_Principal "
                   + " ,RSB_SECUR.GetMainObjAttr(" + OBJTYPE_AVOIRISS + ", LPAD(bnr.t_FIID, 10, '0'), 1, " + RepDateSQL + ") "
                   + " ,fi.t_Point) ";

      //SQL_Execute(query, "Сбор данных об собственных векселях принадлежащих банку", true); //больше не требуется по #285346
    end;
    */
    PostProcess();
  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    return "SELECT * FROM d711avoir_tmp ORDER BY t_IssuerName, t_Code711, t_LSIN, t_ISIN, t_FaceValueFICode, t_StoragePlaceName";
  end;
end;

/* ********************************************** */
/* Класс сбора данных ц/б банка (раздел 1.4)      */
/* ********************************************** */
private class C_711Balance(flt_)
  private var fltr = flt_;
  private var tools = C_711Tools();

  private macro InsertNote(autoKeyAvoir, flag, column, note)
    var query = "INSERT INTO d711avoir_prot_tmp (t_autokeyavoir, t_flag, t_column, t_note) VALUES("
               +String(autoKeyAvoir)+",'"+flag+"','"+column+"','"+note+"')";

    SQL_Execute(query, "Протокол");
  end;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "", query = "";
    var pt:TRecHandler;
    var pmwrtsum = TRecHandler("pmwrtsum.dbt");
    var dl_tick = TRecHandler("dl_tick.dbt");
    var account  = TRecHandler( "account" );
    var count = 0;
    var IssuerName = "", IssuerINN = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "",
        IssuerKPP = "", IssuerCountryCode = "", Code711 = "", LSIN = "", ISIN = "", IssuerOKVED = "", ReservPrc = "", CFI = "", IsEmissive = false;
    var FaceValue = 0, FaceValueFiCode = "", FaceValuePoint = 0;
    var NegOverValue = $0, PosOverValue = $0, CorrValue = $0, QualityCateg = "", FairValueLevel = "", ReserveSum = $0, CorrEstReserve = $0, IssuerOGRN = ""; // Golovkin ОГРН
    var FD = NULL;
    var i = 0, cnt = 0;

    cmd = DL_RSDCommand(   " SELECT lot.*, avr.t_AutoKey, "
                         + "        hs.t_Portfolio as HsPortfolio, hs.t_State as HsState "
                         + "   FROM d711avoir_tmp avr, dpmwrtsum_dbt lot, v_scwrthistex hs "
                         + "  WHERE lot.t_SumID = avr.t_SumID "
                         + "    AND hs.t_SumID = lot.t_SumID "
                         + "    AND hs.t_Instance = (SELECT MAX (t_instance)"
                         + "                           FROM v_scwrthistex "
                         + "                          WHERE t_sumid = hs.t_sumid "
                         + "                            AND t_changedate <= ? "
                         + "                        )"
                         + "  ORDER BY lot.t_FIID, hs.t_Portfolio, hs.t_State"
                       );
    
    cmd.AddParam(fltr.RepDate);
    
    cnt = cmd.GetCount();
    if(cnt > 0)
      var prevFIID = -1, prevPortfolio = 0, prevState = -1, prevBalance = "";
      var Balance = "";

      dataSet = cmd.Execute();
      while (dataSet.moveNext())

        //DataSet.GetRecord().CopyTo( pmwrtsum.rec );  DEF-107643 

        pmwrtsum.rec.SumID = dataSet.SumID;
        pmwrtsum.rec.DocKind = dataSet.DocKind;
        pmwrtsum.rec.DocID = dataSet.DocID;
        pmwrtsum.rec.PartNum = dataSet.PartNum;
        pmwrtsum.rec.Party = dataSet.Party;
        pmwrtsum.rec.Contract = dataSet.Contract;
        pmwrtsum.rec.Portfolio = dataSet.Portfolio;
        pmwrtsum.rec.FIID = dataSet.FIID;
        pmwrtsum.rec.GroupID = dataSet.GroupID;
        pmwrtsum.rec.Buy_Sale = dataSet.Buy_Sale;
        pmwrtsum.rec.Kind = dataSet.Kind;
        pmwrtsum.rec.Date = dataSet.Date;
        pmwrtsum.rec.Time = dataSet.Time;
        pmwrtsum.rec.Amount = dataSet.Amount;
        pmwrtsum.rec.AmountBD = dataSet.AmountBD;
        pmwrtsum.rec.Sum = dataSet.Sum;
        pmwrtsum.rec.Currency = dataSet.Currency;
        pmwrtsum.rec.Cost = dataSet.Cost;
        pmwrtsum.rec.BalanceCost = dataSet.BalanceCost;
        pmwrtsum.rec.BalanceCostBD = dataSet.BalanceCostBD;
        pmwrtsum.rec.NKDAmount = dataSet.NKDAmount;
        pmwrtsum.rec.InterestIncome = dataSet.InterestIncome;
        pmwrtsum.rec.NotCarryInterest = dataSet.NotCarryInterest;
        pmwrtsum.rec.InterestDate = dataSet.InterestDate;
        pmwrtsum.rec.BegDate = dataSet.BegDate;
        pmwrtsum.rec.BegDiscount = dataSet.BegDiscount;
        pmwrtsum.rec.OldBegDate = dataSet.OldBegDate;
        pmwrtsum.rec.OldBegDiscount = dataSet.OldBegDiscount;
        pmwrtsum.rec.BegBonusDate = dataSet.BegBonusDate;
        pmwrtsum.rec.BegBonus = dataSet.BegBonus;
        pmwrtsum.rec.DiscountIncome = dataSet.DiscountIncome;
        pmwrtsum.rec.NotCarryDiscount = dataSet.NotCarryDiscount;
        pmwrtsum.rec.DiscountDate = dataSet.DiscountDate;
        pmwrtsum.rec.Bonus = dataSet.Bonus;
        pmwrtsum.rec.OldBonus = dataSet.OldBonus;
        pmwrtsum.rec.BonusDate = dataSet.BonusDate;
        pmwrtsum.rec.Outlay = dataSet.Outlay;
        pmwrtsum.rec.ReservAmount = dataSet.ReservAmount;
        pmwrtsum.rec.ReservDate = dataSet.ReservDate;
        pmwrtsum.rec.OverAmount = dataSet.OverAmount;
        pmwrtsum.rec.OverAmountBD = dataSet.OverAmountBD;
        pmwrtsum.rec.OverDate = dataSet.OverDate;
        pmwrtsum.rec.Coupon = dataSet.Coupon;
        pmwrtsum.rec.Partly = dataSet.Partly;
        pmwrtsum.rec.Department = dataSet.Department;
        pmwrtsum.rec.DealID = dataSet.DealID;
        pmwrtsum.rec.DealDate = dataSet.DealDate;
        pmwrtsum.rec.State = dataSet.State;
        pmwrtsum.rec.EnterDate = dataSet.EnterDate;
        pmwrtsum.rec.StateDate = dataSet.StateDate;
        pmwrtsum.rec.Instance = dataSet.Instance;
        pmwrtsum.rec.BonusDate = dataSet.BonusDate;
        pmwrtsum.rec.ChangeDate = dataSet.ChangeDate;
        pmwrtsum.rec.Action = dataSet.Action;
        pmwrtsum.rec.ID_Operation = dataSet.ID_Operation;
        pmwrtsum.rec.ID_Step = dataSet.ID_Step;
        pmwrtsum.rec.IsFree = dataSet.IsFree;
        pmwrtsum.rec.Trust = dataSet.Trust;
        pmwrtsum.rec.Parent = dataSet.Parent;
        pmwrtsum.rec.Source = dataSet.Source;
        pmwrtsum.rec.IncomeReserv = dataSet.IncomeReserv;
        pmwrtsum.rec.BegInterestDate = dataSet.BegInterestDate;
        pmwrtsum.rec.BegDiscountDate = dataSet.BegDiscountDate;
        pmwrtsum.rec.DiscountCorr = dataSet.DiscountCorr;
        pmwrtsum.rec.OldBegBonus = dataSet.OldBegBonus;
        pmwrtsum.rec.RecalcDate = dataSet.RecalcDate;
        pmwrtsum.rec.IsEdit = dataSet.IsEdit;
        pmwrtsum.rec.NotWrtBonus = dataSet.NotWrtBonus;
        pmwrtsum.rec.CostPFI = dataSet.CostPFI;
        pmwrtsum.rec.SortCode = dataSet.SortCode;
        pmwrtsum.rec.ActivateDate = dataSet.ActivateDate;
        pmwrtsum.rec.ActivateTime = dataSet.ActivateTime;
        pmwrtsum.rec.BlockAmount = dataSet.BlockAmount;
        pmwrtsum.rec.BegDefDiff = dataSet.BegDefDiff;
        pmwrtsum.rec.AccountedDefDiff = dataSet.AccountedDefDiff;
        pmwrtsum.rec.DefDiffDate = dataSet.DefDiffDate;
        pmwrtsum.rec.WrtOutLay = dataSet.WrtOutLay;
        pmwrtsum.rec.WrtOutLayDate = dataSet.WrtOutLayDate;
        pmwrtsum.rec.VatOutLay = dataSet.VatOutLay;
        pmwrtsum.rec.WrtVatOutlay = dataSet.WrtVatOutlay;
        pmwrtsum.rec.EffectInterestRate = dataSet.EffectInterestRate;
        pmwrtsum.rec.FairValue = dataSet.FairValue;
        pmwrtsum.rec.AmortCost = dataSet.AmortCost;
        pmwrtsum.rec.AmortCostDate = dataSet.AmortCostDate;
        pmwrtsum.rec.CorrValue = dataSet.CorrValue;
        pmwrtsum.rec.AccBalanceCost = dataSet.AccBalanceCost;
        pmwrtsum.rec.AccFi = dataSet.AccFi;
        pmwrtsum.rec.AmortCalcKind = dataSet.AmortCalcKind;
        pmwrtsum.rec.EstReserve = dataSet.EstReserve;
        pmwrtsum.rec.EstReserveDate = dataSet.EstReserveDate;
        pmwrtsum.rec.CorrInttoeir = dataSet.CorrInttoeir;
        pmwrtsum.rec.CorrInttoeirDate = dataSet.CorrInttoeirDate;
        pmwrtsum.rec.CorrestReserve = dataSet.CorrestReserve;
        pmwrtsum.rec.CorrestReserveDate = dataSet.CorrestReserveDate;
        pmwrtsum.rec.BegDefDiffDate = dataSet.BegDefDiffDate;
        pmwrtsum.rec.AddIncomeOwn = dataSet.AddIncomeOwn;
        pmwrtsum.rec.AddIncomeOwnDate = dataSet.AddIncomeOwnDate;
        pmwrtsum.rec.HedgCorr = dataSet.HedgCorr;
        pmwrtsum.rec.HedgCorrDate = dataSet.HedgCorrDate;
        pmwrtsum.rec.AmortHedgCorr = dataSet.AmortHedgCorr;
        pmwrtsum.rec.AmortHedgCorrDate = dataSet.AmortHedgCorrDate;

          if( ((DataSet.HsPortfolio == KINDPORT_TRADE) or
               (DataSet.HsPortfolio == KINDPORT_SALE) or
               (DataSet.HsPortfolio == KINDPORT_RETIRE) or
               (DataSet.HsPortfolio == KINDPORT_CONTR) or
               (DataSet.HsPortfolio == KINDPORT_PROMISSORY))
              and (DataSet.HsState == PM_WRTSUM_FORM)
              and (prevFIID == pmwrtsum.rec.FIID)
              and (prevPortfolio == DataSet.HsPortfolio)
              and (prevState == DataSet.HsState)
            )
            Balance = prevBalance;
          else
          
            Balance = "";
            if( ПолучитьСделкуПоЛоту( pmwrtsum.rec, dl_tick, false, false ) )

              var Group   = GetOperationGroup( dl_tick.rec.DealType );
              var LegKind = GetLegKindByLotDeal( pmwrtsum.rec, dl_tick.rec);
              var IsBack  = (LegKind == LEG_KIND_DL_TICK_BACK);

              FD = SPFirstDoc(dl_tick, IsBack);

              account = ЛСчетНаКоторомУчитываетсяЛот( pmwrtsum.rec, fltr.RepDate, FD );

              Balance = account.Balance;
            end;
          end;

          prevFIID      = pmwrtsum.rec.FIID;
          prevPortfolio = DataSet.HsPortfolio;
          prevState     = DataSet.HsState;
          prevBalance   = Balance;

          if(((fltr.BegDate < DATE_01_01_2019) and
              ((Balance == 47901) or
               (Balance == 50104) or
               (Balance == 50105) or
               (Balance == 50106) or
               (Balance == 50107) or
               (Balance == 50108) or
               (Balance == 50109) or
               (Balance == 50110) or
               (Balance == 50111) or
               (Balance == 50112) or
               (Balance == 50113) or
               (Balance == 50114) or
               (Balance == 50115) or
               (Balance == 50116) or
               (Balance == 50118) or
               (Balance == 50205) or
               (Balance == 50206) or
               (Balance == 50207) or
               (Balance == 50208) or
               (Balance == 50209) or
               (Balance == 50210) or
               (Balance == 50211) or
               (Balance == 50212) or
               (Balance == 50213) or
               (Balance == 50214) or
               (Balance == 50218) or
               (Balance == 50305) or
               (Balance == 50306) or
               (Balance == 50307) or
               (Balance == 50308) or
               (Balance == 50309) or
               (Balance == 50310) or
               (Balance == 50311) or
               (Balance == 50312) or
               (Balance == 50313) or
               (Balance == 50318) or
               (Balance == 50505) or
               (Balance == 50605) or
               (Balance == 50606) or
               (Balance == 50607) or
               (Balance == 50608) or
               (Balance == 50618) or
               (Balance == 50705) or
               (Balance == 50706) or
               (Balance == 50707) or
               (Balance == 50708) or
               (Balance == 50709) or
               (Balance == 50718) or
               (Balance == 60101) or
               (Balance == 60102) or
               (Balance == 60103) or
               (Balance == 60104) or
               (Balance == 60106) or
               (Balance == 60118)
              )
             )
             or
             (
              (fltr.BegDate >= DATE_01_01_2019) and
              ((Balance == 47901) or
               (Balance == 50104) or
               (Balance == 50105) or
               (Balance == 50106) or
               (Balance == 50107) or
               (Balance == 50108) or
               (Balance == 50109) or
               (Balance == 50110) or
               (Balance == 50111) or
               (Balance == 50112) or
               (Balance == 50113) or
               (Balance == 50114) or
               (Balance == 50115) or
               (Balance == 50116) or
               (Balance == 50118) or
               (Balance == 50205) or
               (Balance == 50206) or
               (Balance == 50207) or
               (Balance == 50208) or
               (Balance == 50209) or
               (Balance == 50210) or
               (Balance == 50211) or
               (Balance == 50212) or
               (Balance == 50213) or
               (Balance == 50214) or
               (Balance == 50218) or
               (Balance == 50401) or
               (Balance == 50402) or
               (Balance == 50403) or
               (Balance == 50404) or
               (Balance == 50405) or
               (Balance == 50406) or
               (Balance == 50407) or
               (Balance == 50408) or
               (Balance == 50418) or
               (Balance == 50505) or
               (Balance == 50605) or
               (Balance == 50606) or
               (Balance == 50607) or
               (Balance == 50608) or
               (Balance == 50618) or
               (Balance == 50705) or
               (Balance == 50706) or
               (Balance == 50707) or
               (Balance == 50708) or
               (Balance == 50718) or
               (Balance == 60101) or
               (Balance == 60102) or
               (Balance == 60103) or
               (Balance == 60104) or
               (Balance == 60106) or
               (Balance == 60118)
              )
             )
            )
            queryUpd = "UPDATE d711avoir_tmp SET "
                      + " t_Balance = '" + Balance +"' "
                      + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

            SQL_Execute(queryUpd, "Обновление информации о данных по балансовой стоимости вложений "+(i=i+1)+" из "+cnt, false );
          else
            SQL_Execute("DELETE FROM d711avoir_tmp WHERE t_AutoKey = " + DataSet.t_AutoKey, "Обновление информации о данных по балансовой стоимости вложений "+(i=i+1)+" из "+cnt, false );
          end;
      end;
    end;

    query =  "INSERT INTO d711avoir_tmp ("
           + "    T_ISSUER,"
           + "    T_ISSUERNAME,"
           + "    T_ISSUERINN,"
           + "    T_ISSUERINN_MARK,"
           + "    T_ISSUERINN_TIN,"
           + "    T_ISSUERNOTRESCODE,"
           + "    T_ISSUERKPP,"
           + "    T_ISSUEROGRN,"
           + "    T_ISSUERCOUNTRYCODE,"
           + "    T_FIID,"
           + "    T_CODE711,"
           + "    T_LSIN,"
           + "    T_ISIN,"
           + "    T_FACEVALUEFICODE, "
           + "    T_FACEVALUE, "
           + "    T_FACEVALUEPOINT, "
           + "    T_VOLUME,"
           + "    T_BALANCE,"
           + "    T_ISSUEROKVED,"
           + "    T_UNSOLDAMOUNT,"
           + "    T_NKD,"
           + "    T_NEGOVERVALUE,"
           + "    T_POSOVERVALUE,"
           + "    T_CORRVALUE,"
           + "    T_FAIRVALUELEVEL,"
           + "    T_QUALITYCATEG,"
           + "    T_RESERVESUM,"
           + "    T_CORRESTRESERVE"
           + "   )"
           + "SELECT "
           + "    T_ISSUER,"
           + "    T_ISSUERNAME,"
           + "    T_ISSUERINN,"
           + "    T_ISSUERINN_MARK,"
           + "    T_ISSUERINN_TIN,"
           + "    T_ISSUERNOTRESCODE,"
           + "    T_ISSUERKPP,"
           + "    T_ISSUEROGRN,"
           + "    T_ISSUERCOUNTRYCODE,"
           + "    T_FIID,"
           + "    T_CODE711,"
           + "    T_LSIN,"
           + "    T_ISIN,"
           + "    T_FACEVALUEFICODE, "
           + "    T_FACEVALUE, "
           + "    T_FACEVALUEPOINT, "
           + "    SUM(T_VOLUME),"
           + "    T_BALANCE,"
           + "    T_ISSUEROKVED,"
           + "    SUM(T_UNSOLDAMOUNT),"
           + "    SUM(T_NKD),"
           + "    SUM(T_NEGOVERVALUE),"
           + "    SUM(T_POSOVERVALUE),"
           + "    SUM(T_CORRVALUE),"
           + "    T_FAIRVALUELEVEL,"
           + "    T_QUALITYCATEG,"
           + "    SUM(T_RESERVESUM),"
           + "    SUM(T_CORRESTRESERVE)"
           + "  FROM d711avoir_tmp "
           + " GROUP BY T_ISSUER,"
           + "          T_ISSUERNAME,"
           + "          T_ISSUERINN,"
           + "          T_ISSUERINN_MARK,"
           + "          T_ISSUERINN_TIN,"
           + "          T_ISSUERNOTRESCODE,"
           + "          T_ISSUERKPP,"
           + "          T_ISSUEROGRN,"
           + "          T_ISSUERCOUNTRYCODE,"
           + "          T_FIID,"
           + "          T_CODE711,"
           + "          T_LSIN,"
           + "          T_ISIN,"
           + "          T_FACEVALUEFICODE, "
           + "          T_FACEVALUE, "
           + "          T_FACEVALUEPOINT, "
           + "          T_BALANCE,"
           + "          T_ISSUEROKVED,"
           + "          T_FAIRVALUELEVEL,"
           + "          T_QUALITYCATEG";

    SQL_Execute(query, "Сбор данных по балансовой стоимости вложений", true );

    query =   " DELETE FROM d711avoir_tmp"
            + "  WHERE T_SUMID > 0";

    SQL_Execute(query, "Сбор данных по балансовой стоимости вложений", false );


    // Golovkin дополнительно удалим записи с T_SUMID = -1. Бумаги в ДУ до группировки
    query =   " DELETE FROM d711avoir_tmp"
            + "  WHERE T_SUMID = -1";

    SQL_Execute(query, "Сбор данных по балансовой стоимости вложений", false );

    cmd = DL_RSDCommand(   " SELECT t_AutoKey, t_IssuerName, t_Issuer, t_FIID, t_Code711, t_IssuerINN, t_LSIN, t_ISIN, "
                         + "        t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint, t_SumID, t_IssuerOKVED, "
                         + "        t_NegOverValue, t_PosOverValue, t_CorrValue, t_QualityCateg, t_FairValueLevel, t_ReserveSum, t_CorrEstReserve, T_ISSUEROGRN " // Golovkin ОГРН
                         + "   FROM d711avoir_tmp");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      IssuerName              = dataSet.IssuerName;
      IssuerINN               = dataSet.IssuerINN;
      IssuerINN_Mark          = "";
      IssuerINN_TIN           = "";
      IssuerNotResCode        = "";
      IssuerKPP               = "";
      IssuerCountryCode       = "";
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;
      IssuerOKVED             = dataSet.IssuerOKVED;
      NegOverValue            = dataSet.NegOverValue;
      PosOverValue            = dataSet.PosOverValue;
      CorrValue               = dataSet.CorrValue;
      QualityCateg            = dataSet.QualityCateg;
      FairValueLevel          = dataSet.FairValueLevel;
      ReserveSum              = dataSet.ReserveSum;
      CorrEstReserve          = dataSet.CorrEstReserve;
      ReservPrc               = "";
      IssuerOGRN              = dataSet.IssuerOGRN;

      count = count + 1;

      if((fltr.BegDate < DATE_01_04_2018) and (Code711 != "") and (Index("SN1,SN2,SN3,SN4", Code711) != 0))
        Code711 = "";
      end;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotResCode, true);
        IssuerCountryCode = tools.GetCountryCode(pt);
        IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);

        if ((pt.rec.NotResident == "X") AND (tools.CheckPartyIsSubjType(pt.rec.PartyID, null, "14.1" /*Международная компания по 290-ФЗ*/) or (tools.CheckPartyIsSubjType(pt.rec.PartyID, null, "14.2" /*Международная компания по 290-ФЗ*/))))
          IssuerOGRN = "";
        end;
        
        if ((dataSet.IssuerOGRN == "") and (pt.rec.NotResident != "X"))
          var note = "Для субъекта " + GetCodeParty(pt.rec.PartyID, 1) + " " + pt.rec.ShortName + " не найден код ОГРН";
          InsertNote(dataSet.AutoKey, "?", "4", note);
        end;
      end;
      // Выпуск
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if (ПолучитьФинИн(dataSet.FIID, Fininstr) == 0)
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
        elif (not IsEmissive)
          if(FI_IsISU(Fininstr))
            LSIN = tools.GetRULESREGXID(dataSet.FIID);
          else
            LSIN = "";
          end;
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;

        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
        if(fltr.BegDate >= DATE_01_04_2018)
          ReservPrc = string(readNoteForObject( OBJTYPE_AVOIRISS, L_Z( DataSet.FIID, 10 ), NOTEKIND_RSK_PERCENT, fltr.BegDate ));
        end;
      end;

      if((IssuerCountryCode != "") AND (IssuerCountryCode != "643"))
        LSIN = "";
      end;

      if((Code711 == "DR") OR (Code711 == "DR1") OR (Code711 == "DR2")) // депозитарная расписка
        LSIN = tools.GetLSINDEPO(dataSet.FIID);
      end;

      if((Code711 == "BON2") or (Code711 == "BON5") or (Code711 == "SHS7") or (Code711 == "SHS8"))
        IssuerOKVED = "";
      end;

      if(NegOverValue > $0)
        NegOverValue = $0;
      end;

      if(PosOverValue < $0)
        PosOverValue = $0;
      end;

      if((NegOverValue == $0) AND (PosOverValue == $0))
        FairValueLevel = "";
      end;

      if(fltr.BegDate < DATE_01_01_2019)
        CorrValue      = $0;
        CorrEstReserve = $0;
      end;

      queryUpd = "UPDATE d711avoir_tmp SET "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_Code711 = " + tools.GetSQLStr(Code711) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + IIF(FaceValue==$0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + " t_IssuerOKVED = " + tools.GetSQLStr(IssuerOKVED)  + ", "
                + " t_NegOverValue = " + NegOverValue + ", "
                + " t_PosOverValue = " + PosOverValue + ", "
                + " t_CorrValue = " + CorrValue + ", "
                + " t_QualityCateg = " + tools.GetSQLStr(QualityCateg) + ", "
                + " t_FairValueLevel = " + tools.GetSQLStr(FairValueLevel) + ", "
                + " t_ReserveSum = " + ReserveSum + ", "
                + " t_CorrEstReserve = " + CorrEstReserve + ", "
                + " t_ReservPrc = " + tools.GetSQLStr(ReservPrc) + ", "
                + " T_ISSUEROGRN = " + tools.GetSQLStr(IssuerOGRN) + ", " // Golovkin ОГРН
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных по балансовой стоимости вложений, " + String(count), false );
    end;
  end;

  /*Подготовить данные*/
  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);

    query =  "INSERT INTO d711avoir_tmp ("
           + "    T_ISSUER,"
           + "    T_ISSUERNAME,"
           + "    T_ISSUERINN,"
           + "    T_ISSUERINN_MARK,"
           + "    T_ISSUERINN_TIN,"
           + "    T_ISSUERNOTRESCODE,"
           + "    T_ISSUERKPP,"
           + "    T_ISSUEROGRN,"
           + "    T_ISSUERCOUNTRYCODE,"
           + "    T_FIID,"
           + "    T_CODE711,"
           + "    T_LSIN,"
           + "    T_ISIN,"
           + "    T_FACEVALUEFICODE, "
           + "    T_FACEVALUE, "
           + "    T_FACEVALUEPOINT, "
           + "    T_VOLUME,"
           + "    T_SUMID,"
           + "    T_BALANCE,"
           + "    T_ISSUEROKVED,"
           + "    T_UNSOLDAMOUNT,"
           + "    T_NKD,"
           + "    T_NEGOVERVALUE,"
           + "    T_POSOVERVALUE,"
           + "    T_FAIRVALUELEVEL,"
           + "    T_QUALITYCATEG,"
           + "    T_RESERVESUM, "
           + "    T_CORRVALUE, "
           + "    T_CORRESTRESERVE"
           + "   )"
           + "SELECT /*+ leading(t)*/ issuer.t_Issuer,"                                                                                                // T_ISSUER
           + "       CHR(1),"                                                                                                         // T_ISSUERNAME
           + "       rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16),"                                                                 // T_ISSUERINN
           + "       CHR(1),"                                                                                                         // T_ISSUERINN_MARK
           + "       CHR(1),"                                                                                                         // T_ISSUERINN_TIN
           + "       CHR(1),"                                                                                                         // T_ISSUERNOTRESCODE
           + "       CHR(1),"                                                                                                         // T_ISSUERKPP
           + "       rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27),"                                                                 // T_ISSUEROGRN
           + "       CHR(1),"                                                                                                         // T_ISSUERCOUNTRYCODE
           + "       t.t_FIID,"                                                                                                       // T_FIID
           + "       rsb_secur.GetObjAttrName(12, 1,"
           + "                                rsb_secur.GetMainObjAttr(12,"
           + "                                                         LPAD(t.t_FIID, 10, '0'),"
           + "                                                         1, "+RepDateSQL+")),"                                          // T_CODE711
           + "       avr.T_LSIN,"                                                                                                     // T_LSIN
           + "       avr.T_ISIN,"                                                                                                     // T_ISIN
           + "       NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR(1)), "                        // T_FACEVALUEFICODE
           + "       NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+" ), 0.0), "                                        // T_FACEVALUE
           + "       fin.T_POINT+2, "                                                                                                 // T_FACEVALUEPOINT
/* Golovkin 26.02.2019
           + "       CASE WHEN t.t_Portfolio = "+KINDPORT_CONTR
           + "            THEN t.t_BalanceCost "
           + "            ELSE RSB_FIInstr.ConvSum(t.t_BalanceCost - t.t_NotCarryDiscount, "
           + "                                     fin.t_FaceValueFI, "+NATCUR+", "+RepDateSQL+") END"
           + "     - RSB_FIInstr.ConvSum((t.t_InterestIncome-t.t_NotCarryInterest), fin.t_FaceValueFI, "+NATCUR+", "+RepDateSQL+")"
           + "     - CASE WHEN t_OverAmount > 0 THEN t_OverAmount ELSE 0 END "
           + "     + CASE WHEN t_OverAmount < 0 THEN -t_OverAmount ELSE 0 END, "                                                      // T_VOLUME
*/

           + "       CASE WHEN t.t_Portfolio = "+KINDPORT_CONTR
           + "            THEN t.t_BalanceCost "
           + "            ELSE RSB_FIInstr.ConvSum(t.t_Cost + t.T_DISCOUNTINCOME + t.t_costpfi, fin.t_FaceValueFI, "+NATCUR+", "+RepDateSQL+") END,"// T_VOLUME
           + "       t.t_SumID, "                                                                                                     // T_SUMID
           + "       CHR(1), ";                                                                                                       // T_BALANCE
      if(fltr.BegDate >= DATE_01_04_2018)
        query = query +
             "       rsb_secur.GetObjAttrNumber("+OBJTYPE_PARTY+", 64,"
           + "                                  rsb_secur.GetGeneralMainObjAttr("+OBJTYPE_PARTY+","
           + "                                                           LPAD(issuer.t_Issuer, 10, '0'),"
           + "                                                           64, "+RepDateSQL+")),"                                       // T_ISSUEROKVED
           + "       t.t_Amount, "                                                                                                    // T_UNSOLDAMOUNT
           + "       (t.t_InterestIncome-t.t_NotCarryInterest+ t.T_NKDAMOUNT), "                                                      // T_NKD
           + "       t_OverAmount, "                                                                                                  // T_NEGOVERVALUE
           + "       t_OverAmount, "                                                                                                  // T_POSOVERVALUE
           + "       rsb_secur.GetObjAttrNumber("+OBJTYPE_AVOIRISS+", 55,"
           + "                                  rsb_secur.GetMainObjAttr("+OBJTYPE_AVOIRISS+","
           + "                                                           LPAD(t.t_FIID, 10, '0'),"
           + "                                                           55, "+RepDateSQL+")),"                                       // T_FAIRVALUELEVEL
           + "       rsb_secur.GetObjAttrNumber("+OBJTYPE_AVOIRISS+", 13,"
           + "                                  rsb_secur.GetMainObjAttr("+OBJTYPE_AVOIRISS+","
           + "                                                           LPAD(t.t_FIID, 10, '0'),"
           + "                                                           13, "+RepDateSQL+")),"                                       // T_QUALITYCATEG
           + "       t_ReservAmount + t_IncomeReserv, "                                                                               // T_RESERVESUM
           + "       t_CorrValue + t_CorrInttoEIR, "                                                                                  // T_CORRVALUE
           + "       t_CorrEstReserve + t_EstReserve";                                                                                // T_CORRESTRESERVE
      else
        query = query +
             "       CHR(1), "                                                                                                        // T_ISSUEROKVED
           + "       0, "                                                                                                             // T_UNSOLDAMOUNT
           + "       0, "                                                                                                             // T_NKD
           + "       0, "                                                                                                             // T_NEGOVERVALUE
           + "       0, "                                                                                                             // T_POSOVERVALUE
           + "       CHR(1), "                                                                                                        // T_FAIRVALUELEVEL
           + "       CHR(1), "                                                                                                        // T_BALANCE
           + "       0, "                                                                                                             // T_QUALITYCATEG
           + "       0, "                                                                                                             // T_CORRVALUE
           + "       0 ";                                                                                                             // T_CORRESTRESERVE
      end;
      query = query +
             "  FROM v_scwrthistex t, davoiriss_dbt avr, dfininstr_dbt fin, "
           +         SQL_QueryIssuer+" issuer"
           + " WHERE t.t_buy_sale = " + PM_WRITEOFF_SUM_BUY
           + "   AND t.t_party = -1 "
           + "   AND t.t_dockind in(" + DLDOC_PAYMENT+","+DL_ISSUE_UNION+","+DL_MOVINGDOC+")"
           + "   AND t.t_dealid > 0 "
           + "   AND t.t_kind in(20,210,40,110,130,90)"
           + "   AND t.t_Amount != 0"
           + "   AND (t.t_state = "+PM_WRTSUM_FORM
               + " OR t.t_state = "+PM_WRTSUM_SALE_BPP+") "
           + "   AND t.t_instance = (SELECT MAX (t_instance)"
           + "                         FROM v_scwrthistex "
           + "                        WHERE t_sumid = t.t_sumid "
           + "                          AND t_changedate <= "+RepDateSQL
           + "                          AND t.t_Portfolio in ("+KINDPORT_TRADE+","+KINDPORT_SALE+","+KINDPORT_CONTR+","+KINDPORT_PROMISSORY+","+KINDPORT_RETIRE+"))"
           + "   AND avr.t_FIID = t.t_FIID"
           + "   AND issuer.t_FIID = avr.t_FIID"
           + "   AND fin.t_FIID = avr.t_FIID";

    //println("1.4: " + query);
    SQL_Execute(query, "Сбор данных по балансовой стоимости вложений", true );

    // Golovkin 26.03.2019 Переданные в ДУ
    query =  "INSERT INTO d711avoir_tmp ("
           + "    T_ISSUER,"
           + "    T_ISSUERNAME,"
           + "    T_ISSUERINN,"
           + "    T_ISSUERINN_MARK,"
           + "    T_ISSUERINN_TIN,"
           + "    T_ISSUERNOTRESCODE,"
           + "    T_ISSUERKPP,"
           + "    T_ISSUEROGRN,"
           + "    T_ISSUERCOUNTRYCODE,"
           + "    T_FIID,"
           + "    T_CODE711,"
           + "    T_LSIN,"
           + "    T_ISIN,"
           + "    T_FACEVALUEFICODE, "
           + "    T_FACEVALUE, "
           + "    T_FACEVALUEPOINT, "
           + "    T_VOLUME,"
           + "    T_SUMID,"
           + "    T_BALANCE,"
           + "    T_ISSUEROKVED,"
           + "    T_UNSOLDAMOUNT,"
           + "    T_NKD,"
           + "    T_NEGOVERVALUE,"
           + "    T_POSOVERVALUE,"
           + "    T_FAIRVALUELEVEL,"
           + "    T_QUALITYCATEG,"
           + "    T_RESERVESUM, "
           + "    T_CORRVALUE, "
           + "    T_CORRESTRESERVE"
           + "   )"
           + "SELECT issuer.t_Issuer,"                                                                         // T_ISSUER
           + "       CHR(1),"                                                                                  // T_ISSUERNAME
           + "       rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 16),"                                          // T_ISSUERINN
           + "       CHR(1),"                                                                                  // T_ISSUERINN_MARK
           + "       CHR(1),"                                                                                  // T_ISSUERINN_TIN
           + "       CHR(1),"                                                                                  // T_ISSUERNOTRESCODE
           + "       CHR(1),"                                                                                  // T_ISSUERKPP
           + "       rsi_rsbparty.GetPartyCode(issuer.t_Issuer, 27),"                                          // T_ISSUEROGRN
           + "       CHR(1),"                                                                                  // T_ISSUERCOUNTRYCODE
           + "       t.t_FIID,"                                                                                // T_FIID
           + "       rsb_secur.GetObjAttrName(12, 1,"
           + "                                rsb_secur.GetMainObjAttr(12,"
           + "                                                         LPAD(t.t_FIID, 10, '0'),"
           + "                                                         1, "+RepDateSQL+")),"                   // T_CODE711
           + "       avr.T_LSIN,"                                                                              // T_LSIN
           + "       avr.T_ISIN,"                                                                              // T_ISIN
           + "       NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR(1)), " // T_FACEVALUEFICODE
           + "       NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+" ), 0.0), "                 // T_FACEVALUE
           + "       fin.T_POINT+2, "                                                                          // T_FACEVALUEPOINT
           + "       RSB_FIInstr.ConvSum(t.t_Cost, fin.t_FaceValueFI, "+NATCUR+", "+RepDateSQL+"),"            // T_VOLUME
           + "       -1, "                                                                                     // T_SUMID
           + "       '47901',";                                                                                // T_BALANCE
      if(fltr.BegDate >= DATE_01_04_2018)
        query = query +
             "       rsb_secur.GetObjAttrNumber("+OBJTYPE_PARTY+", 64,"
           + "                                  rsb_secur.GetGeneralMainObjAttr("+OBJTYPE_PARTY+","
           + "                                                           LPAD(issuer.t_Issuer, 10, '0'),"
           + "                                                           64, "+RepDateSQL+")),"                // T_ISSUEROKVED
           + "       t.t_Amount, "                                                                             // T_UNSOLDAMOUNT
           + "       t.T_NKDAMOUNT, "                                                                          // T_NKD
           + "       0, "                                                                                      // T_NEGOVERVALUE
           + "       0, "                                                                                      // T_POSOVERVALUE
           + "       rsb_secur.GetObjAttrNumber("+OBJTYPE_AVOIRISS+", 55,"
           + "                                  rsb_secur.GetMainObjAttr("+OBJTYPE_AVOIRISS+","
           + "                                                           LPAD(t.t_FIID, 10, '0'),"
           + "                                                           55, "+RepDateSQL+")),"                // T_FAIRVALUELEVEL
           + "       rsb_secur.GetObjAttrNumber("+OBJTYPE_AVOIRISS+", 13,"
           + "                                  rsb_secur.GetMainObjAttr("+OBJTYPE_AVOIRISS+","
           + "                                                           LPAD(t.t_FIID, 10, '0'),"
           + "                                                           13, "+RepDateSQL+")),"                // T_QUALITYCATEG
           + "       0, "                                                                                      // T_RESERVESUM
           + "       0, "                                                                                      // T_CORRVALUE
           + "       0";                                                                                       // T_CORRESTRESERVE
      else
        query = query +
             "       CHR(1), "                                                                                 // T_ISSUEROKVED
           + "       0, "                                                                                      // T_UNSOLDAMOUNT
           + "       0, "                                                                                      // T_NKD
           + "       0, "                                                                                      // T_NEGOVERVALUE
           + "       0, "                                                                                      // T_POSOVERVALUE
           + "       CHR(1), "                                                                                 // T_FAIRVALUELEVEL
           + "       CHR(1), "                                                                                 // T_BALANCE
           + "       0, "                                                                                      // T_QUALITYCATEG
           + "       0, "                                                                                      // T_CORRVALUE
           + "       0 ";                                                                                      // T_CORRESTRESERVE
      end;
      query = query +
             "  FROM DAVR_IN_TRUST_DBT t, davoiriss_dbt avr, dfininstr_dbt fin, "
           +         SQL_QueryIssuer+" issuer"
           + " WHERE avr.t_FIID = t.t_FIID"
           + "   AND t.T_REPDATE = " + RepDateSQL
           + "   AND issuer.t_FIID = avr.t_FIID"
         //+ "   AND fin.T_FIID = 5565 " // debug
           + "   AND fin.t_FIID = avr.t_FIID ";

    //println("1.4: " + query);
    SQL_Execute(query, "Сбор данных по балансовой стоимости вложений переданных в ДУ", true );

    // Golovkin 08.09.2020 ID : 515552
    //SQL_Execute("DELETE FROM d711avoir_tmp WHERE T_VOLUME = 0", "Удаление информации о лишних записях", false );

    PostProcess();
  end;

  /* Запрос для SELECT'а */
  macro GetQuerySelect()
    return "SELECT * FROM d711avoir_tmp ORDER BY t_IssuerName, t_Code711, t_LSIN, t_ISIN, t_Balance";
  end;
end;

/* ********************************************** */
/* Клас данных по 711 форме (1 раздел)            */
/* ********************************************** */
class C_711avoir()
  var КорреспНаим:string                = "",       // Владелец счета ЛОРО
      КорреспИНН:string                 = "",       // ИНН владельца счета ЛОРО
      КорреспКПП:string                 = "",       // КПП владельца счета ЛОРО
      КорреспОГРН:string                = "",       // ОГРН владельца счета ЛОРО
      КорреспОКСМ:string                = "",       // Страна владельца счета ЛОРО
      КорреспНомерЛицензии:string       = "",       // Лицензия владельца счета ЛОРО
      КорреспПризнак:string             = "",       // Признак депозитария владельца счета ЛОРО
      КорреспНомерСчета:string          = "",       // Номер счета ЛОРО
      КорреспИНН_TIN:string             = "",       // для ИНН TIN корреспондента
      КорреспИНН_Признак:string         = "",       // для ИНН признак депозитария - корреспондента
      ПризнакКодаНерез:string           = "",       // Признак кода нерезидента владелеца счета НД
      КоличествоПоСчету:numeric         = $0.0,     // Количество ц/б на счете владельца
      ЭмитентНаименование:string        = "",       // Наименование эмитента
      ЭмитентИНН:string                 = "",       // ИНН эмитента
      ЭмитентКПП:string                 = "",       // КПП эмитента
      ЭмитентОГРН:string                = "",       // ОГРН эмитента
      ЭмитентОКСМ:string                = "",       // ОКСМ эмитента
      ЭмитентИНН_TIN:string             = "",       // для ИНН TIN - эмитента
      ЭмитентИНН_Признак:string         = "",       // для ИНН признак эмитента
      ПризнакКодаЭмНерез:string         = "",       // Признак кода нерезидента эмитента
      ЦБКод:integer                     = 0,        // FIID ц/б (для протокола)
      ЦБКодТипа:string                  = "",       // Код ц/б для Ф711
      ЦБНомерГосРег:string              = "",       // Номер гос. рег. ц/б
      ЦБISIN:string                     = "",       // ISIN ц/б
      ЦБВалюта:string                   = "",       // Код валюты номинала ц/б
      ЦБНоминал:numeric                 = $0.0,     // Номинал ц/б
      ЦБНоминалТочность:integer         = 0,        // Точность номинала ц/б
      СвоиЦБ_ОснБаланс:numeric          = $0.0,     // Ц/б, принадлежащие банку
      СвоиЦБ_РЕПО_БПП:numeric           = $0.0,     // Ц/б РЕПО
      СвоиЦБ_ЗачислОшибочно:numeric     = $0.0,     // Ц/б неустановленных владельцев
      СвоиЦБ_ДУ:numeric                 = $0.0,     // Ц/б в ДУ
      СвоиЦБ_КазнСчета:numeric          = $0.0,     // Ц/б казначейского счета эмитента
      СвоиЦБ_Залог:numeric              = $0.0,     // Ц/б в залоге
      СвоиЦБ_Эмисс:numeric              = $0.0,     // Ц/б эмитента
      МХНаименование:string             = "",       // Наименование места хранения
      МХИНН:string                      = "",       // ИНН места хранения
      МХКПП:string                      = "",       // КПП места хранения
      МХОГРН:string                     = "",       // ОГРН места хранения
      МХОКСМ:string                     = "",       // Страна места хранения
      МХНомерЛицензии:string            = "",       // Лицензия места хранения
      МХПризнак:string                  = "",       // Признак депозитария места хранения
      МХНомерСчёта:string               = "",       // Номер счета места хранения
      МХИНН_TIN:string                  = "",       // для ИНН МХ TIN
      МХИНН_Признак:string              = "",       // для ИНН МХ признак организации
      ПризнакКодаМХНерез:string         = "",       // Признак кода нерезидента места хранения
      ВидСчётаДепо:string               = "",       // Вид счета депо
      ВидСчётаДепо_Код:string           = "",       // Вид счета депо - код
      Владелец_СекторЭкономики:string   = "",       // Код сектора экономики
      ОбъемВложений:numeric             = $0.0,     // Объем вложений
      Залог:numeric                     = $0.0,     // Ц/б на счетах с блокировкой классификатора "Блокировки заложенных ц/б"
      ТогрСчета:numeric                 = $0.0,     // Ц/б на торговых счетах
      ОгранКД:numeric                   = $0.0,     // Ц/б на счетах с блокировкой классификатора "Блокировки цб, ограниченных по кор. действ."
      ЗапретОпер:numeric                = $0.0,     // Ц/б на счетах с блокировкой классификатора "Блокировка цб запрета на операции"
      Арест:numeric                     = $0.0,     // Ц/б на счетах с блокировкой классификатора "Блокировки арестованных ц/б"
      ЦБЭскроуАгента:numeric            = $0.0,     // Ц/б на счетах эскроу-агента
      ОбособФЗ                          = $0.0,     // Ц/б учет которых обособлен на основании федераль-ных законов и норматив-ных правовых актов Рос-сийской Федерации
      ОбособТреб                        = $0.0,     // Ц/б учет которых обособ-лен на основании предписаний (требова-ний) Банка России
      ВсегоОбрем:numeric                = $0.0,     // Совокупное количество ценных бумаг, в отношении которых зафиксировано обременение и (или) ограничение распоряжения
      СВ_ОКМС:string                    = "",       // Код страны по классификатору ОКСМ для владельца счета депо
      БалансСчет:string                 = "",       // Номер балансового
      ЭмитентОКВЭД:string               = "",       // Код ОКВЭД эмитента
      КоличествоЦБ:numeric              = $0.0,     // Количество ц/б по непроданным лотам
      НКД:numeric                       = $0.0,     // Накопленный купонный доход
      ОтрицПереоценка:numeric           = $0.0,     // Отрицательная переоценка
      ПоложПереоценка:numeric           = $0.0,     // Положительная переоценка
      ОтрицПоложПереоценка:numeric      = $0.0,     // Переоценка ценных бумаг - отрицательная (положительная) разница
      Корр_СС_ПП:numeric                = $0.0,     // Корректировка, увеличивающая (уменьшающая) стоимость долговых ценных бумаг или изменения справедливой стоимости при первоначальном признании долевых ценных бумаг
      УровеньИДвиерархииСС:string       = "",       // Уровень исходных данных в иерархии справедливой стоимости
      КатКачества:string                = "",       // Категория качества
      Резерв:numeric                    = $0.0,     // Резерв
      Корр_резерва_ВП:numeric           = $0.0,     // Корректировка резерва на возможные потери до оценочного резерва под ожидаемые кредитные убытки
      НРезДатаВыдачиЛицензии:string     = "",       // Дата выдачи лицензии на право осуществления учета и перехода прав на ценные бумаги (для организации-нерезидента)
      НРезКемВыданаЛицензия:string      = "",       // Лицензирующий орган, выдавший лицензии на право осуществления учета и перехода прав на ценные бумаги (для организации-нерезидента)
      ПриемЦБ:numeric                   = $0.0,     // Объем проведенных операций с учитываемыми ценными бумагами, прием
      СнятиеЦБ:numeric                  = $0.0,     // Объем проведенных операций с учитываемыми ценными бумагами, снятие
      ПереводЦБ:numeric                 = $0.0,     // Объем проведенных операций с учитываемыми ценными бумагами, перевод
      ПриемЦБКоличество:numeric         = 0,        // Количество проведенных операций с учитываемыми ценными бумагами, прием
      СнятиеЦБКоличество:numeric        = 0,        // Количество проведенных операций с учитываемыми ценными бумагами, снятие
      ПереводЦБКоличество:numeric       = 0,        // Количество проведенных операций с учитываемыми ценными бумагами, перевод
      РезервПроцент:string              = "",       // Процент резерва
      КодCFI:string                     = "",       // Код CFI

      Протокол:TArray                   = TArray(), // Протокол
	  ОшибкаНетОГРН:string              = "";

  /* Строка протокола */
  class TProtocol(_Флаг, _ЦБКод, _Графа, _ЛицСчет, _КолЦБЛицСч, _ТипСчетаДЕПО, _Владелец, _Нерезидент, _Примечание)
    var Флаг:string         = _Флаг,
        ЦБКод:string        = _ЦБКод,
        Графа:string        = _Графа,
        ЛицСчет:string      = _ЛицСчет,
        КолЦБЛицСч:string   = _КолЦБЛицСч,
        ТипСчетаДЕПО:string = _ТипСчетаДЕПО,
        Владелец:string     = _Владелец,
        Нерезидент:string   = _Нерезидент,
        Примечание:string   = _Примечание;
  end;

  private var flt = TFilter;
  private var objData = null;
  private var DataRec = null;

  private macro GetProtocol(autoKey):TArray
    var prot = TArray();
    var cmd, dataSet;

    cmd = DL_RSDCommand("SELECT * FROM d711avoir_prot_tmp WHERE t_autokeyAvoir = ?");
    cmd.addParam(autoKey);

    dataSet = cmd.execute();
    while (dataSet.moveNext())
      prot[prot.size] = TProtocol(dataSet.Flag, this.ЦБКодТипа, dataSet.Column, "", "", "", "", "", dataSet.Note);
    end;

    return prot;
  end;
  
  private macro GetProtocolColumn(autoKey, Column:string):string
    var err_ogrn = "";
    var cmd, dataSet;
	var que = "SELECT * FROM d711avoir_prot_tmp WHERE t_autokeyAvoir = ? and t_column = ?";
	var is_first = true;

    cmd = DL_RSDCommand(que);
    cmd.addParam(autoKey);
	cmd.addParam(Column);

    dataSet = cmd.execute();
    while (dataSet.moveNext())
	  if(not is_first)
        err_ogrn = err_ogrn + " \n ";
	  end;
		
      err_ogrn = err_ogrn + dataSet.Note;
	  is_first = false;
    end;

    return err_ogrn;
  end;

  private macro getDepoAccountKind(value)
      if (value == "OWNER")
          return "01";
      elif (value == "DEPOPROG")
          return "02";
      elif (value == "TRUSTEE")
          return "03";
      elif (value == "ISSUER")
          return "04";
      elif (value == "EMISSION")
          return "05";
      elif (value == "DEPOSIT")
          return "06";
      elif (value == "TRANSIT")
          return "07";
      elif (value == "NOMINEE")
          return "08";
      elif (value == "FNOMINEE")
          return "09";
      elif (value == "FAUTHOLDER")
          return "10";
      elif (value == "NONE")
          return "11";
      elif (value == "OTHER")
          return "12";
      elif (value == "HOLDER")
          return "13";
      elif (value == "SUBOWNER")
          return "14";
      elif (value == "SUBTRUSTEE")
          return "15";
      end;

      return "";
  end;

  private macro SetValues()
    КорреспНаим                 = DataRec.CorrespName;                      // Владелец счета НД
    КорреспИНН                  = DataRec.CorrespINN;                       // ИНН владельца счета НД
    КорреспИНН_TIN              = DataRec.CorrespINN_TIN;                   // для ИНН TIN корреспондента
    КорреспИНН_Признак          = DataRec.CorrespINN_Mark;                  // для ИНН признак депозитария - корреспондента
    ПризнакКодаНерез            = DataRec.CorrespNotResCode;                // Признак кода нерезидента владелеца счета НД
    КорреспКПП                  = DataRec.CorrespKPP;                       // КПП владельца счета НД
    КорреспОГРН                 = DataRec.CorrespOGRN;                      // ОГРН владельца счета НД
    КорреспОКСМ                 = DataRec.CorrespCountryCode;               // Страна владельца счета НД
    КорреспНомерЛицензии        = DataRec.CorrespLicense;                   // Лицензия владельца счета НД
    КорреспПризнак              = DataRec.CorrespMark;                      // Признак депозитария владельца счета НД
    КорреспНомерСчета           = DataRec.CorrespBriefCode;                 // Номер счета НД
    КоличествоПоСчету           = DataRec.Amount;                           // Количество ц/б на счете владельца
    ЭмитентНаименование         = DataRec.IssuerName;                       // Наименование эмитента
    ЭмитентИНН                  = DataRec.IssuerINN;                        // ИНН эмитента
    ЭмитентКПП                  = DataRec.IssuerKPP;                        // КПП эмитента
    ЭмитентОГРН                 = DataRec.IssuerOGRN;                       // ОГРН эмитента
    ЭмитентОКСМ                 = DataRec.IssuerCountryCode;                // ОКСМ эмитента
    ЭмитентИНН_TIN              = DataRec.IssuerINN_TIN;                    // для ИНН TIN - эмитента
    ЭмитентИНН_Признак          = DataRec.IssuerINN_Mark;                   // для ИНН признак эмитента
    ПризнакКодаЭмНерез          = DataRec.IssuerNotResCode;                 // Признак кода нерезидента эмитента
    ЦБКод                       = DataRec.FIID;                             // FIID ц/б (для протокола)
    ЦБКодТипа                   = DataRec.Code711;                          // Код ц/б для Ф711
    ЦБНомерГосРег               = DataRec.LSIN;                             // Номер гос. рег. ц/б
    ЦБISIN                      = DataRec.ISIN;                             // ISIN ц/б
    ЦБВалюта                    = DataRec.FaceValueFICode;                  // Код валюты номинала ц/б
    ЦБНоминал                   = DataRec.FaceValue;                        // Номинал ц/б
    ЦБНоминалТочность           = DataRec.FaceValuePoint;                   // Точность номинала ц/б
    СвоиЦБ_ОснБаланс            = DataRec.OurAmount;                        // Ц/б, принадлежащие банку
    СвоиЦБ_РЕПО_БПП             = DataRec.REPOAmount;                       // Ц/б РЕПО
    СвоиЦБ_ЗачислОшибочно       = DataRec.WrongAmount;                      // Ц/б неустановленных владельцев
    СвоиЦБ_ДУ                   = DataRec.DUAmount;                         // Ц/б в ДУ
    СвоиЦБ_КазнСчета            = DataRec.FiscalIssuerAmount;               // Ц/б казначейского счета эмитента
    СвоиЦБ_Залог                = DataRec.LoanAmount;                       // Ц/б в залоге
    СвоиЦБ_Эмисс                = DataRec.IssuerAmount;                     // Ц/б эмитента
    МХНаименование              = DataRec.StoragePlaceName;                 // Наименование места хранения
    МХИНН                       = DataRec.StoragePlaceINN;                  // ИНН места хранения
    МХКПП                       = DataRec.StoragePlaceKPP;                  // КПП места хранения
    МХОГРН                      = DataRec.StoragePlaceOGRN;                 // ОГРН места хранения
    МХОКСМ                      = DataRec.StoragePlaceCountryCode;          // Страна места хранения
    МХНомерЛицензии             = DataRec.StoragePlaceLicense;              // Лицензия места хранения
    МХПризнак                   = DataRec.StoragePlaceMark;                 // Признак депозитария места хранения
    МХНомерСчёта                = DataRec.StoragePlaceBriefCode;            // Номер счета места хранения
    МХИНН_TIN                   = DataRec.StoragePlaceINN_TIN;              // для ИНН МХ TIN
    МХИНН_Признак               = DataRec.StoragePlaceINN_Mark;             // для ИНН МХ признак организации
    ПризнакКодаМХНерез          = DataRec.StoragePlaceNotResCode;           // Признак кода нерезидента места хранения
    ВидСчётаДепо                = DataRec.DepoAccKind;                      // Вид счета депо
    ВидСчётаДепо_Код            = getDepoAccountKind(DataRec.DepoAccKind);  // Вид счета депо - код
    Владелец_СекторЭкономики    = DataRec.Sector;                           // Код сектора экономики
    ОбъемВложений               = DataRec.Volume;                           // Объем вложений
    Залог                       = DataRec.PawnAmount;                       // Ц/б на счетах с блокировкой классификатора "Блокировки заложенных ц/б"
    ТогрСчета                   = DataRec.TradeAmount;                      // Ц/б на торговых счетах
    ОгранКД                     = DataRec.CorpRestrAmount;                  // Ц/б на счетах с блокировкой классификатора "Блокировки цб, ограниченных по кор. действ."
    ЗапретОпер                  = DataRec.OperBanAmount;                    // Ц/б на счетах с блокировкой классификатора "Блокировка цб запрета на операции"
    Арест                       = DataRec.ArrestAmount;                     // Ц/б на счетах с блокировкой классификатора "Блокировки арестованных ц/б"
    ЦБЭскроуАгента              = DataRec.EscrowAmount;                     // Ц/б на счетах эскроу-агента
    ОбособФЗ                    = DataRec.ObosobFZAmount;                   // Ц/б учет которых обособлен на основании федераль-ных законов и норматив-ных правовых актов Рос-сийской Федерации
    ОбособТреб                  = DataRec.ObosobBRAmount;                   // Ц/б учет которых обособ-лен на основании предписаний (требова-ний) Банка России
    ВсегоОбрем                  = DataRec.EncumberAmount;                   // Совокупное количество ценных бумаг, в отношении которых зафиксировано обременение и (или) ограничение распоряжения
    СВ_ОКМС                     = DataRec.CorrespCountryCode;               // Код страны по классификатору ОКСМ для владельца счета депо
    БалансСчет                  = DataRec.Balance;                          // Номер балансового
    ЭмитентОКВЭД                = DataRec.IssuerOKVED;                      // Код ОКВЭД эмитента
    КоличествоЦБ                = DataRec.UnsoldAmount;                     // Количество ц/б по непроданным лотам
    НКД                         = DataRec.NKD;                              // Накопленный купонный доход
    ОтрицПереоценка             = DataRec.NegOvervalue;                     // Отрицательная переоценка
    ПоложПереоценка             = DataRec.PosOvervalue;                     // Положительная переоценка
    НРезДатаВыдачиЛицензии      = DataRec.NotResLicenseDate;                // Дата выдачи лицензии на право осуществления учета и перехода прав на ценные бумаги (для организации-нерезидента)
    НРезКемВыданаЛицензия       = DataRec.OrganGiveLicense;                 // Лицензирующий орган, выдавший лицензии на право осуществления учета и перехода прав на ценные бумаги (для организации-нерезидента)
    ПриемЦБ                     = DataRec.RECEPTIONCB;                      // Объем проведенных операций с учитываемыми ценными бумагами, прием
    СнятиеЦБ                    = DataRec.WithdrawalCB;                     // Объем проведенных операций с учитываемыми ценными бумагами, снятие
    ПереводЦБ                   = DataRec.TransferCB;                       // Объем проведенных операций с учитываемыми ценными бумагами, перевод
    ПриемЦБКоличество           = DataRec.RECEPTIONCBCount;                 // Количество проведенных операций с учитываемыми ценными бумагами, прием
    СнятиеЦБКоличество          = DataRec.WithdrawalCBCount;                // Количество проведенных операций с учитываемыми ценными бумагами, снятие
    ПереводЦБКоличество         = DataRec.TransferCBCount;                  // Количество проведенных операций с учитываемыми ценными бумагами, перевод
    РезервПроцент               = DataRec.ReservPrc;                        // Процент резерва
    КодCFI                      = DataRec.CFI;                              // Код CFI

    ОтрицПоложПереоценка = $0.0;                                            // Ф711_Отриц_Полож_Переоценка_1_4
    if(ОтрицПереоценка != NULL)
      ОтрицПоложПереоценка = ОтрицПоложПереоценка + ОтрицПереоценка;
    end;
    if(ПоложПереоценка != NULL)
      ОтрицПоложПереоценка = ОтрицПоложПереоценка + ПоложПереоценка;
    end;

    Корр_СС_ПП                  = DataRec.CorrValue;                        // Ф711_Корр_СС_ПП_1_4
    УровеньИДвиерархииСС        = DataRec.FairValueLevel;                   // Уровень исходных данных в иерархии справедливой стоимости
    КатКачества                 = DataRec.QualityCateg;                     // Категория качества
    Резерв                      = DataRec.ReserveSum;                       // Резерв
    Корр_резерва_ВП             = DataRec.CorrEstReserve;                   // Ф711_Корр_резерва_ВП_1_4
    // протокол
    if (CLIENT_PART_2_1 == flt.RepPart)
       Протокол                    = GetProtocol(DataRec.AutoKey);             // Протокол
    end;
    ОшибкаНетОГРН               = GetProtocolColumn(DataRec.AutoKey, "4");
    ОшибкаНетОГРН               = ОшибкаНетОГРН + IIF(ОшибкаНетОГРН != "", "\n", "") + GetProtocolColumn(DataRec.AutoKey, "10");
  end;

  private macro PrepareData()
    SQL_Truncate("d711avoir_tmp");
    SQL_Truncate("d711avoir_prot_tmp");

    if (LORO_PART == flt.RepPart)
      objData = C_711LORO(flt);
    elif (CLIENT_PART == flt.RepPart)
      objData = C_711Client(flt);
    elif (CLIENT_PART_2_1 == flt.RepPart)
      objData = C_711Client21(flt);
    elif (BANK_PART == flt.RepPart)
      objData = C_711Bank(flt);
    elif (LD_BANK_PART == flt.RepPart)
      objData = C_711Bank_Loaded(flt);
    elif (BALANCE_PART == flt.RepPart)
      objData = C_711Balance(flt);
    end;

    if (null != objData)
      objData.PrepareData();
    end;
  end;

  // Установить фильтр
  macro SetFilter(_Departments:TArray, _BegDate:date, _RepDate:date, _RepPart:integer)
    if (ValType(_Departments) != V_UNDEF)
      flt.Departments = "";
      for(var dep, _Departments)
        if (flt.Departments != "")
          flt.Departments = flt.Departments + ",";
        end;
        flt.Departments = string(flt.Departments) + string(dep);
      end;
    end;
    if (ValType(_BegDate) != V_UNDEF)
      flt.BegDate = _BegDate;
    end;
    if (ValType(_RepDate) != V_UNDEF)
      flt.RepDate = _RepDate;
    end;
    if (ValType(_RepPart) != V_UNDEF)
      flt.RepPart = _RepPart;
    end;
  end;

  // Формирование выборки и получение первой записи
  macro GetFirst():bool
    var stat = 0;
    PrepareData();

    DataRec = TRsbDataSet(objData.GetQuerySelect());

    stat = DataRec.moveNext();
    if(stat)
      SetValues();
    end;

    return stat;
  end;
  // Получение следующей записи
  macro GetNext():bool
    var stat = 0;
    stat = DataRec.moveNext();
    if(stat)
      SetValues();
    end;

    return stat;
  end;
end;

/*
var deps = TArray();
var parts = TArray(), i = 0;
var obj = null;
var stat = false;
var empty = true;
var fields = null, widths = null, j = 0;
var head = null;
var rep = null;
var old = -1;
var style = "ex_B(rlb)";
deps[deps.size] = {OperDprt};
parts[parts.size] = LORO_PART;
parts[parts.size] = CLIENT_PART;
parts[parts.size] = BANK_PART;
parts[parts.size] = BALANCE_PART;
while(i < parts.size)
  obj = C_711avoir();
  obj.SetFilter(deps, date(00,00,0000), date(31,12,9999), parts[i]);
  stat = obj.GetFirst();
  while(stat)
    if(empty)
      fields = GetObjProps(obj);
      widths = TArray();
      head = CHeader();
      j = 0;
      while(j < fields.Size)
        widths[j] = StrLen(fields[j]);
        head.AddChild(fields[j], widths[j]);
        j = j + 1;
      end;
      rep = CMakeReport("", SEP_DEFAULT, 99999);
      rep.AutoScan("[\n" + head.CreateHeader() + "]");
      empty = false;
    end;
    if(old != parts[i])
      rep.AddPrintCell(parts[i] + 1, widths[0], 0, style);
      j = 1;
      while(j < fields.Size)
        rep.AddPrintCell("", widths[j], 0, style);
        j = j + 1;
      end;
      rep.AddStr();
      old = parts[i];
    end;
    j = 0;
    while(j < fields.Size)
      if(GenPropID(obj, fields[j]) != -1)
        rep.AddPrintCell(String(GenGetProp(obj, fields[j])), widths[j], 0, style);
      else
        rep.AddPrintCell("", widths[j], 0, style);
      end;
      j = j + 1;
    end;
    rep.AddStr();
    stat = obj.GetNext();
  end;
  obj = null;
  i = i + 1;
end;
if(not empty)
  rep.PrintRep();
else
  PrintLn("Нет данных")
end;
*/

