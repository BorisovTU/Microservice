import vaovernvpi, vacateg, InsCarryDoc, OprInter, PaymInter, vaservop, vaprdec, vaprdeca;

PRIVATE RECORD tick(dl_tick);

MACRO ExecuteStep(Buffer, FirstDoc)
  var stat = 0;
  var Дата={curdate};
  var ObjType = OverObjType;
  
  SetBuff( tick, FirstDoc );

  if((ValType(OprServDoc) != V_UNDEF) and (OprServDoc.ValueDate > date(0,0,0)))
    Дата = OprServDoc.ValueDate;
  end;
  
  if(ValType(ObjType) == V_UNDEF) //не из сервисной операции
    if(СделкаДляПереоценкиНВПИНаБалансе(tick, Дата))
      ObjType = VAOVER_OBJTYPE_BALANCEDEAL;
    elif(СделкаДляПереоценкиНВПИНаВнебалансе(tick, Дата))
      ObjType = VAOVER_OBJTYPE_OFFBALANCEDEAL;
    end;
  end;

  stat = ПереоценкаНВПИСделки(tick, ObjType, Дата);
  
  return stat;

END;


/*
Функция печати распоряжений
*/
PRIVATE MACRO PrintDec(ManPr, ID_Operation, ID_Step)
VAR CDate;

    if((NOT (ManPr > 0)) AND (NOT (AutoPrint())))
        return FALSE;
    end;

    CDate = GetPlanDate(ID_Operation, ID_Step);

    InitDecType(DecType);
    InitDecPurp(DecPurp);
    InitOpType(OpType);

    record dl_t (dl_tick);

/* Attributs begin */
    if (NOT ПолучитьСделку(ID_Operation, dl_t))
       return FALSE;
    end;

    if(not VA_IsExchange(dl_t.DealType))
      СформироватьРаспоряжениеВБухгалтерию(CDate, OpType[15], dl_t, "OF16.dot", DecType[14], DecPurp[20], ID_Operation, ID_Step);
    else
      СформироватьРаспоряжениеВБухгалтерию(CDate, OpType[15], dl_t, "OF17.dot", DecType[14], DecPurp[21], ID_Operation, ID_Step);
    end;
/* Attributs end */

    return TRUE;
END;

/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    PrintDec(MAN_PRINT, ID_Operation, ID_Step);

    PrintDecAccOpen(MAN_PRINT, ID_Operation, ID_Step, Kind_Operation, OpAccTemplName);

    exit(1);

END;
