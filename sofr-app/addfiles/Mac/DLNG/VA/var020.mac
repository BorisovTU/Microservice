/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : var020.mac
                                va-вексель
                                 r-операция погашения векселей (repayment)
                               020-номер (соответствующий шагу)
  Programmer  : Велигжанин А.В.
  Операция    : Погашение векселей
  Шаг         : К.оплата комиссий.
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
IMPORT PaymInter, vacateg, vacomis1, vaprdeca;


/* Заполняет счет в платеже. Засунул это сюда. потому что больше некуда (#97589)
*/
PRIVATE MACRO FillPaymentAcc(tick)
var fd, stat = 0, Счет,
    pm_obj = RsbPayment( tick.BofficeKind, tick.DealID, PM_PURP_PRINC_RET, 0 );

   if( pm_obj.PaymentID == 0 )
     stat = VA_Err("Не найден платеж с назначением \"Возврат принципала\"");
   else
     if(pm_obj.ReceiverAccount == "")
       Счет = Unkn_GetAccountPassive( {OperDprt}, pm_obj.ReceiverFIID); //Получить счет "НевПоступления"
       pm_obj.SetReceiverAccount( pm_obj.ReceiverFIID, 1, Счет );
     end;
   end;

   return (stat == 0);
END;


/* Запуск шага
     Для каждой комиссии, оплачиваемой на данном шаге (функция ПЗО),
     сформировать проводки "Ком" и "КомНДС", если соответствующая сумма <> 0 .
*/
MACRO ExecuteStep(Buffer, dl_tick)
var
    stat = 0;

    record tick( dl_tick );
    SetBuff( tick, dl_tick );

    if(not ВзятьКомиссиюПоСделке(tick, 16, tick.DealDate))
       stat = 1;
   //N.E. Убрал заполнение счате по запросу (163666) - не нужен он нам здесь
   // elif(not FillPaymentAcc(tick))
   //    stat = 1;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    PrintDecAccOpen(AUTO_PRINT, ID_Operation, ID_Step, Kind_Operation, OpAccTemplName);
    
    return 1;

END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    PrintDecAccOpen(MAN_PRINT, ID_Operation, ID_Step, Kind_Operation, OpAccTemplName);

    exit(1);

END;
