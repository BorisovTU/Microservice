/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vaxchgbk.mac
  Операция    : Мена учтенных векселей
  Comment     : Проводки операции
└───────────────────────────────────────────────────────────────────────────*/
IMPORT CTInter, vaacc, va4each, vatickfd;

PRIVATE VAR
           BnrGroups = null;

/* Класс: группы векселей по ВН
*/
CLASS BnrGroupsClass (_tick, _BkpDate)
 var 
  stat = 0,
  tick = _tick,
  BkpDate = _BkpDate,
  ArrGrp = TArray; /* Массив ВН  */

  ArrGrp.size = 0;

  PRIVATE MACRO newGrp(leg)
   var fd, Счет1, Счет2;

   ArrGrp[ArrGrp.size] = leg.rec.PFI;

   if((fd = VATickFD(tick)) == null)
      stat = VA_Err("Ошибка при определении первичного документа сделки");
   elif(not VA_GetAccount("+Форвард, расчеты", fd, Счет1, MC_OPENACC_CREATE, leg.rec.PFI, FIROLE_FIREQ, null, BkpDate))
      stat = 1;
   elif(not VA_GetAccount("-Форвард, расчеты", fd, Счет2, MC_OPENACC_CREATE, leg.rec.PFI, FIROLE_FICOM, null, BkpDate))
      stat = 1;
   end;
  END;

  PRIVATE MACRO find(leg)
   var i = 0;
    while (i < ArrGrp.size)
      if(ArrGrp[i] == leg.rec.PFI)
        return i;
      end;
      i = i + 1;
    end;
    return -1;
  END;

  MACRO group(leg)
   var i = find(leg);
     if(i == -1)
        newGrp(leg);
     end;
     return stat;
  END;

END;

/* Группирует векселя по валютам номинала.
*/
PRIVATE MACRO GroupsByPFI(bnr, leg, tick, numOrd, lnk)
   return BnrGroups.group(leg);
END;

/* Актуализируем счета категорий "+-Форвард, расчеты" в валюте номинала
*/
MACRO VA_ExchgActuate1(tick, role, BkpDate)
var
   stat = 0;

   BnrGroups = BnrGroupsClass(tick, BkpDate);
   stat = VA_ForEachBanner(tick, @GroupsByPFI, role, NULL, "L");
   
   return (stat == 0);
END;
