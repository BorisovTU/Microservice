/**
 @file vabnrattr_va.mac
 @brief Отчет "Сторонние векселя"

 Отчёт формируется по данным модуля ?Учтенные векселя?. 

 # menu
 - Учтенные векселя\Отчеты\Сторонние векселя

 # tag
 - functional_block:Отчетность утенных векселей
 - code_type:report
 - Отчет 
 - Сторонние векселя
 
 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |19.09.22   |Пономарева К.В.|BIQ-8458 "Отчеты по векселям"                   |Реализация отчетов по BIQ-8458: Залоги, собственные, учтенные
 |           |               |                                                |

*/

IMPORT "DLReport_h.mac", vabnrattr_va_form, vslib, vsbnrfd, vsacc, dlmisc, vspmfutu, vamisc, vareslib;

/**
@brief Класс с генерацией отчета: отбор данных, расчеты, выпуск в excel
*/
PRIVATE CLASS ( DL_CReportTemplate ) VA_BnrAttr()
    VAR
    m_BeginDate:DATE, ///< Дата начала отчета
    m_EndDate:DATE, ///< Дата окончания отчета
    m_Date, ///< Дата окончания отчета

    m_Buy:STRING, ///< Параметр:Приобритение
    m_Repay:STRING, ///< Параметр:Продажа/Погашение
    m_DataQuery:STRING, ///< Строка для селекта с отбором данных для векселей
    m_RS, ///< Параметр:Продажа/Погашение
    m_NRecs:INTEGER, ///< Количество отобранных строк
    m_Num:INTEGER, ///< 
    m_CurrSheetName:STRING, ///< Название листа в книге excel
    m_A12, ///< Номер договора (при покупке)
    m_A13, ///< Дата договора
    m_A20, ///< Цена приобретения
    m_A22, ///< Валюта цены приобретения (id ФИ)
    m_A23, ///< Балансовая стоимость, руб.
    m_A24, ///< Балансовая стоимость в валюте
    m_A38, ///< Дата покупки
    m_A39, ///< Дата постановки на баланс
    m_A52, ///< Ставка по созданному резерву 
    m_A58, ///< Балансовый счет
    m_A59, ///< Счет второго порядка по учету векселя
    m_A66, ///< Категория качества
    m_A68, ///< Корректировки увеличивающие (уменьшающие) стоимость векселя, руб
    m_A70, ///< Счет корректировки по стоимости векселя
    FirstHolder     = TRecHandler( "party.dbt" ), ///< Запись из party.dbt о первом векселедержателе
    isПросроч; ///< Признак, просрочен ли вексель

    /**
    @brief Идентификационный номер цб
    @return Идентификационный номер цб
    */
    PRIVATE MACRO A1():INTEGER // 
        return m_Rs.t_bcid;
    END;

    /**
    @brief Филиал
    @return Филиал
    */
    PRIVATE MACRO A2():STRING //
        if(m_Rs.Branch_CODE == "0000")
          return "Головной";
        elif(m_Rs.Branch_CODE == "7900")
          return "ЦКБ";
        elif(m_Rs.Branch_CODE == "6300")
          return "ЦРМБ";
        end;
        return m_Rs.Branch_Name;
    END;

    /**
    @brief Векселедатель
    @return Векселедатель
    */
    PRIVATE MACRO A3():STRING //
        return m_Rs.ISSUERNAME;
    END;

    /**
    @brief ИНН векселедателя
    @return ИНН векселедателя
    */
    PRIVATE MACRO A4():STRING //
        return m_RS.INN;
    END;

    /**
    @brief ОГРН векселедателя
    @return ОГРН векселедателя
    */
    PRIVATE MACRO A5():STRING // 
        return m_RS.OGRN;
    END;

    /**
    @brief Статус векселедателя
    @return Статус векселедателя
    */
    PRIVATE MACRO A6():STRING // 
        var S = "";
        if (m_RS.ISSUER_RES == SET_CHAR)
            S = "Нерезидент";
        else
            S = "Резидент";
        end;
        return S;
    END;

    /**
    @brief ОКСМ векселедателя
    @return ОКСМ векселедателя
    */
    PRIVATE MACRO A7():STRING // 
        return m_RS.OKSM;
    END;

    /**
    @brief Тип векселедателя
    @return Тип векселедателя
    */
    PRIVATE MACRO A8():STRING // 
        var S = "";
        var Kind;
        var DataSet;
        if (m_Rs.ISSUER_LEGALFORM == 1)
            Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
            Kind.addParam( "", RSDBP_IN, m_RS.ISSUER );
            Kind.addParam( "", RSDBP_IN, PTK_BANK );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Кредитная организация";
            else
                S = "Юридическое лицо";
            end;
        else
            Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
            Kind.addParam( "", RSDBP_IN, m_RS.ISSUER );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Индивидуальный предприниматель";
            else
                S = "Физическое лицо";
            end;
        end;
        return S;
    END;

    /**
    @brief TIN векселедателя
    @return TIN векселедателя
    */
    PRIVATE MACRO A9():STRING // 
        return m_RS.TIN;
    END;

    /**
    @brief Серия векселя
    @return Серия векселя
    */
    PRIVATE MACRO A10():STRING // 
        return m_RS.T_BCSERIES;
    END;

    /**
    @brief Номер векселя
    @return Номер векселя
    */
    PRIVATE MACRO A11():STRING // 
        return trim(m_RS.T_BCNUMBER);
    END;

    /**
    @brief Выполняет поиск/расчет полей отчета:Номер договора (при покупке),Дата договора,Цена приобретения,Валюта цены приобретения (id ФИ),Дата покупки,Дата постановки на баланс
    */
    PRIVATE MACRO A12_13_20_22_38_39()// 
      var DealID = 0, BCCost = 0.0, BCCost_FI = 0;
      var BalanceDate = date(0,0,0);
      var tick = TBFile("dl_tick");
      m_A12 = "";
      m_A13 = date(0,0,0);
      m_A20 = 0.0;
      m_A22 = 0;
      m_A38 = m_A39 = date(0,0,0);
      if(VA_GetBalanceDate(m_Rs.T_BCID, SQL_ConvTypeDate( m_Date ), @BalanceDate, @DealID, @BCCost, @BCCost_FI))
        tick.rec.DealID = DealID;
        tick.GetEQ();
        m_A13 = tick.rec.DealDate;
        m_A12 = tick.rec.DealCode;
        m_A20 = BCCost;
        m_A22 = BCCost_FI;
        m_A38 = m_A39 = BalanceDate;
      end;
    END;

    /**
    @brief Место составления векселя
    @return Место составления векселя
    */
    PRIVATE MACRO A14():STRING // 
        return m_RS.T_ISSUEPLACE;
    END;

    /**
    @brief Дата составления векселя
    @return Дата составления векселя
    */
    PRIVATE MACRO A15():DATE // 
        return SQL_ConvTypeDate( m_RS.T_ISSUEDATE );
    END;

    /**
    @brief Процентная ставка
    @return Процентная ставка
    */
    PRIVATE MACRO A16():MONEY // 
        return m_RS.RATE;
    END;

    /**
    @brief Номинал векселя
    @return Номинал векселя
    */
    PRIVATE MACRO A17():MONEY // 
        return m_RS.T_PRINCIPAL;
    END;

    /**
    @brief Номинал векселя, руб.
    @return Номинал векселя, руб.
    */
    PRIVATE MACRO A18():MONEY
        VAR M = $0;
        if(m_RS.T_PFI == NATCUR)
          M = m_RS.T_PRINCIPAL;
        else
          ConvSum (M, money(m_RS.T_PRINCIPAL), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
        end;
        return M;
    END;

    /**
    @brief  Валюта номинала
    @return  Валюта номинала
    */
    PRIVATE MACRO A19():STRING // 
        return m_RS.CURRENCY;
    END;

    /**
    @brief Цена приобретения, руб.
    @return Цена приобретения, руб.
    */
    PRIVATE MACRO A21():MONEY // 
      VAR M = $0;
      if(m_A22 == NATCUR)
          M = m_A20;
      else
        ConvSum (M, money(m_A20), m_A13, m_A22, NATCUR);
      end;
      return M;
    END;

    /**
    @brief Валюта цены приобретения
    @return Валюта цены приобретения (код)
    */
    PRIVATE MACRO A22():STRING // 
      var fi = TRecHandler("fininstr");
      if(not ПолучитьФинИн(m_A22, fi))
          return fi.rec.ccy;
      end;
      return "";
    END;

    /**
    @brief Тип векселя
    @return Тип векселя
    */
    PRIVATE MACRO A27():STRING // 
        return m_RS.INCOMETYPE;
    END;

    /**
    @brief Сумма наращенного процента в валюте
    @return Сумма наращенного процента в валюте
    */
    PRIVATE MACRO A55():MONEY // 
      if (A27() != "П")
        return 0;
      end;

      var Account = "";
      var rest = $0;
      var cmd;
      var DataSet;
      var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
      
      if (isПросроч)
        Account = MC_GetExistAccount("Просроч_вексель", FD.kind, FD.id, FIROLE_PERCENT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      else
        Account = MC_GetExistAccount("Начисл.ПДД, УВ", FD.kind, FD.id, FIROLE_PERCENT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      end;

      if(Account != "")
          rest = abs(RestA (Account, SQL_ConvTypeDate(m_Date)));
      end;
      return rest;
    END;

    /**
    @brief Сумма наращенного дисконта в валюте
    @return Сумма наращенного дисконта в валюте
    */
    PRIVATE MACRO A53():MONEY // 
      if (A27() != "Д")
        return 0;
      end;

      var Account = "";
      var rest = $0;
      var cmd;
      var DataSet;
      var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
      
      if (isПросроч)
        Account = MC_GetExistAccount("Просроч_вексель", FD.kind, FD.id, FIROLE_DISCOUNT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      else
        Account = MC_GetExistAccount("Начисл.ПДД, УВ", FD.kind, FD.id, FIROLE_DISCOUNT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      end;

      if(Account != "")
          rest = abs(RestA (Account, SQL_ConvTypeDate(m_Date)));
      end;
      return rest;
    END;

    /**
    @brief Выполняет поиск/расчет полей: Балансовая стоимость, руб.,Балансовая стоимость в валюте, Балансовый счет, Счет второго порядка по учету векселя
    */
    PRIVATE MACRO A23_24_58_59() // 
      m_A23 = $0;
      m_A24 = $0;
      m_A58 = "";
      m_A59 = "";
      var cmd;
      var ds;
      var Account = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
      var rest = $0;
      var fi = TRecHandler("fininstr");

      if(isПросроч)
        Account = MC_GetExistAccount("Просроч_вексель", fd.kind, fd.id, FIROLE_FIDOC, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      else
        Account = MC_GetExistAccount("Учтенные векселя", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      end;
      if((Account != NULL))
        rest = abs(RestA (Account, SQL_ConvTypeDate(m_Date)));
      else
        rest = 0;
      end;
      if ((Account != NULL))
        m_A24 = rest + A53() + A55();
        if (fd.ОпределитьВалютуУчета() == NATCUR)
          m_A23 = m_A24;
        ELSE
          ConvSum (m_A23, money(m_A24), SQL_ConvTypeDate( m_Date ), fd.ОпределитьВалютуУчета(), NATCUR);
        end;
        m_A58 = Account;
        m_A59  = SubStr(Account, 1, 5);
      end;
    END;

    /**
    @brief Дата предъявления
    @return Дата предъявления
    */
    PRIVATE MACRO A25():STRING //
        VAR S = "";
        S = VS_TermFormula(m_RS.t_BCTermFormula, SQL_ConvTypeDate( m_RS.t_Maturity ), SQL_ConvTypeDate( m_RS.t_Expiry ));
        return S;
    END;

    /**
    @brief Дата 1 срока платежа
    @return Дата 1 срока платежа
    */
    PRIVATE MACRO A28():DATE // 
        var RepaymentDate = date(0,0,0);
        if((m_RS.t_BCTermFormula == VS_TERMF_FIXEDDAY) OR (m_RS.t_BCTermFormula == VS_TERMF_INATIME) OR // срочные
            ((m_RS.t_BCTermFormula == VS_TERMF_ATSIGHT) and (SQL_ConvTypeDate(m_RS.t_Maturity) >= SQL_ConvTypeDate(m_RS.t_Start)))) // По предъявлении, но не ранее
            RepaymentDate = SQL_ConvTypeDate(m_RS.t_Maturity);
        elif((m_RS.t_BCTermFormula == VS_TERMF_DURING) and (SQL_ConvTypeDate(m_RS.t_BCPresentationDate) > date(0,0,0))) // от предъявления, уже предъявленные
            RepaymentDate = SQL_ConvTypeDate(m_RS.t_BCPresentationDate) + int(m_RS.t_Diff);
        else
            RepaymentDate = SQL_ConvTypeDate(m_RS.t_Start) + DaysInYearByBasis(m_RS.t_Basis,SQL_ConvTypeDate(m_RS.t_Start), true);
        end;
        return RepaymentDate;
    END;

    /**
    @brief Дата погашения
    @return Дата погашения
    */
    PRIVATE MACRO A26():DATE //
        return A28();
    END;

    /**
    @brief Дата 2 срока платежа
    @return Дата 2 срока платежа
    */
    PRIVATE MACRO A29():DATE // 
        if(m_RS.t_BCTermFormula == VS_TERMF_ATSIGHT)
            if( ( SQL_ConvTypeDate( m_RS.t_Expiry ) < SQL_ConvTypeDate( m_RS.t_Start ) ) and 
                ( SQL_ConvTypeDate( m_RS.t_Maturity ) >= SQL_ConvTypeDate( m_RS.t_Start ) ) )
                    return date(0,0,0);
            elif( ( SQL_ConvTypeDate( m_RS.t_Expiry ) >= SQL_ConvTypeDate( m_RS.t_Start ) ) and // По предъявлении, но не позднее 
                  ( SQL_ConvTypeDate( m_RS.t_Maturity ) < SQL_ConvTypeDate( m_RS.t_Start ) ) )
                    return SQL_ConvTypeDate( m_RS.t_Expiry );
            else // По предъявлении, но не ранее и не позднее
                return SQL_ConvTypeDate( m_RS.t_Expiry );
            end;
        end;
        return date(0,0,0);
    END;

    /**
    @brief Дата окончания срока по векселю
    @return Дата окончания срока по векселю
    */
    PRIVATE MACRO A30():DATE 
        VAR D = 0, FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
        if( FD != null )
            D = DL_GetBnrPlanRepayDate(FD.GetBnr(), FD.GetLeg());
        end;
        return D;
    END;

    /**
    @brief Поиск первого векселедержателя
    */
    PRIVATE MACRO FIND_FIRSTHOLDER()
        VAR FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
        if( FD != null )
          ПолучитьСубъекта( FD.GetBnr().rec.Holder, FirstHolder );
        end;
    END;

    /**
    @brief Первый векселедержатель
    @return Первый векселедержатель
    */
    PRIVATE MACRO A31():STRING // 
        return FirstHolder.rec.ShortName;
    END;

    /**
    @brief ИНН первого векселедержателя
    @return ИНН первого векселедержателя
    */
    PRIVATE MACRO A32():STRING // 
      if (FirstHolder.rec.NotResident != SET_CHAR)
        return ПолучитьКодСубъекта( FirstHolder.rec.PartyID, PTCK_INN );
      end;
      return "";
    END;

    /**
    @brief ОГРН первого векселедержателя
    @return ОГРН первого векселедержателя
    */
    PRIVATE MACRO A33():STRING // 
        return ПолучитьКодСубъекта( FirstHolder.rec.PartyID, PTCK_OGRN );
    END;

    /**
    @brief Статус первого векселедержателя
    @return Статус первого векселедержателя
    */
    PRIVATE MACRO A34():STRING // 
      var S = "";
      if (FirstHolder.rec.NotResident == SET_CHAR)
        S = "Нерезидент";
      else
        S = "Резидент";
      end;
      return S;
    END;

    /**
    @brief ОКСМ первого векселедержателя
    @return ОКСМ первого векселедержателя
    */
    PRIVATE MACRO A35():STRING // 
      var rs, cmd;
      if( (FirstHolder.rec.NRCOUNTRY != "") AND (FirstHolder.rec.NRCOUNTRY != NULL))
        cmd = RsdCommand( "SELECT t_codenum3 FROM dcountry_dbt WHERE t_codelat3 = ?" );
        cmd.addParam( "", RSDBP_IN, FirstHolder.rec.NRCOUNTRY );
        cmd.execute();
        rs = RsdRecordset( cmd );
        if ( rs.moveNext )
            return rs.value( "t_codenum3" );
        end;
      end;
      return "";
    END;

    /**
    @brief Тип первого векселедержателя
    @return Тип первого векселедержателя
    */
    PRIVATE MACRO A36():STRING // 
      var S = "";
      var Kind;
      var DataSet;
        if (FirstHolder.rec.LegalForm == 1)
            Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
            Kind.addParam( "", RSDBP_IN, FirstHolder.rec.PartyID );
            Kind.addParam( "", RSDBP_IN, PTK_BANK );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Кредитная организация";
            else
                S = "Юридическое лицо";
            end;
        else
            Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
            Kind.addParam( "", RSDBP_IN, FirstHolder.rec.PartyID );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Индивидуальный предприниматель";
            else
                S = "Физическое лицо";
            end;
        end;
      return S;
    END;

    /**
    @brief TIN первого векселедержателя
    @return TIN первого векселедержателя
    */
    PRIVATE MACRO A37():STRING // 
      if (FirstHolder.rec.NotResident == SET_CHAR)
        return ПолучитьКодСубъекта( FirstHolder.rec.PartyID, PTCK_FOREIGN_INN );
      end;
      return "";
    END;

    /**
    @brief Дисконт в валюте
    @return Дисконт в валюте
    */
    PRIVATE MACRO A41():MONEY // Сумма дисконта
       if(m_Rs.INCOMETYPE == "Д")
        return m_RS.T_PRINCIPAL - m_A20;
      end;
      return 0;
    END;

    /**
    @brief Дисконт, руб.
    @return Дисконт, руб.
    */
    PRIVATE MACRO A40():MONEY // Сумма дисконта
      VAR M = $0;
      if(m_RS.T_PFI == NATCUR)
        M = A41();
      else
        ConvSum (M, money(A41()), SQL_ConvTypeDate( m_Date ), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    
    /**
    @brief Контрагент по покупке
    @return Контрагент по покупке
    */
    PRIVATE MACRO A42():STRING //
        return m_Rs.CONTR_NAME;
    END;

    /**
    @brief ИНН контрагента по покупке
    @return ИНН контрагента по покупке
    */
    PRIVATE MACRO A43():STRING //
        return m_RS.CONTR_INN;
    END;

    /**
    @brief ОГРН контрагента по покупке
    @return ОГРН контрагента по покупке
    */
    PRIVATE MACRO A44():STRING // 
        return m_RS.CONTR_OGRN;
    END;

    /**
    @brief Статус контрагента по покупке
    @return Статус контрагента по покупке
    */
    PRIVATE MACRO A45():STRING // 
        var S = "";
        if (m_RS.CONTR_RES == SET_CHAR)
            S = "Нерезидент";
        else
            S = "Резидент";
        end;
        return S;
    END;

    /**
    @brief ОКСМ контрагента по покупке
    @return ОКСМ контрагента по покупке
    */
    PRIVATE MACRO A46():STRING // 
        return m_RS.CONTR_OKSM;
    END;

    /**
    @brief Тип контрагента по покупке
    @return Тип контрагента по покупке
    */
    PRIVATE MACRO A47():STRING // 
        var S = "";
        var Kind;
        var DataSet;
        if (m_Rs.CONTR_LEGALFORM == 1)
            Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
            Kind.addParam( "", RSDBP_IN, m_RS.CONTR_ID );
            Kind.addParam( "", RSDBP_IN, PTK_BANK );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Кредитная организация";
            else
                S = "Юридическое лицо";
            end;
        else
            Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
            Kind.addParam( "", RSDBP_IN, m_RS.CONTR_ID );
            Kind.execute();
            DataSet = TRsbDataSet(Kind);
            if(DataSet.moveNext())
                S = "Индивидуальный предприниматель";
            else
                S = "Физическое лицо";
            end;
        end;
        return S;
    END;

    /**
    @brief TIN контрагента по покупке
    @return TIN контрагента по покупке
    */
    PRIVATE MACRO A48():STRING // 
        return m_RS.CONTR_TIN;
    END;

    /**
    @brief Цель приобретения
    @return Цель приобретения
    */
    PRIVATE MACRO A49():STRING // 
        var r_ficert = TRecHandler("ficert.dbt");
        var ObjectID;
        var cmd = DL_RSDCommand(" SELECT ficert.* FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin "+
                          " WHERE  bnr.t_BCID = ? " +
                          "   and fin.t_FIID = bnr.t_FIID" +
                          "   and ficert.t_CertID = bnr.t_BCID" +
                          "   and ficert.t_AvoirKind = fin.t_AvoirKind");
        cmd.AddpAram(m_Rs.T_BCID);
        var DataSet = cmd.Execute();

        if (DataSet.moveNext())
            DataSet.GetRecord().CopyTO(r_ficert.rec);

            ObjectID = UniID(r_ficert, OBJTYPE_FICERT);
            return string(readNoteForObject(OBJTYPE_FICERT, ObjectID, 26));
        end;
        return "";
    END;

    /**
    @brief Процентная ставка дисконта от номинала
    @return Процентная ставка дисконта от номинала
    */
    PRIVATE MACRO A50():MONEY // 
      return 100.0 - (m_A20 / m_Rs.T_PRINCIPAL) * 100.0;
    END;

    /**
    @brief Сумма резерва, руб.
    @return Сумма резерва, руб.
    */
    PRIVATE MACRO A51():MONEY
      var reslnk = TBfile("dlreslnk.dbt");
      if(GetResLnk(reslnk, m_Rs.T_BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_AVR, SQL_ConvTypeDate( m_Date ), true))
        return reslnk.rec.ReserveAmount;
      end;
      return 0;
    END;

    /**
    @brief Выполняется поиск/расчет полей:Ставка по созданному резерву, Категория качества
    @return 
    */
    PRIVATE MACRO A52_66()
      m_A52 = $0;
      m_A66 = 0;
      var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
      if(CalcAndCheckReserveParams(FD.GetBnr().rec, SQL_ConvTypeDate( m_Date ), @m_A66, VARES_SUBKIND_AVR, @m_A52))
        m_A66 = 0;
        m_A52 = 0.0;
      end;
      if (A51() == 0)
        m_A52 = 0.0;
      end;
    END;

    /**
    @brief Сумма наращенного дисконта, руб.
    @return Сумма наращенного дисконта, руб.
    */
    PRIVATE MACRO A54():MONEY // 
      var M = $0;
      if (A27() != "Д")
        return 0;
      end;
      if (m_RS.T_PFI == NATCUR)
        M = A53();
      else
        ConvSum (M, money(A53()), SQL_ConvTypeDate(m_Date), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    /**
    @brief Сумма наращенного процента, руб.
    @return Сумма наращенного процента, руб.
    */
    PRIVATE MACRO A56():MONEY // 
      var M = $0;
      if (A27() != "П")
        return 0;
      end;
      if (m_RS.T_PFI == NATCUR)
        M = A55();
      else
        ConvSum (M, money(A55()), SQL_ConvTypeDate(m_Date), m_RS.T_PFI, NATCUR);
      end;
      return M;
    END;

    /**
    @brief Категория МСФО
    @return Сейчас поле не заполняем, пустое значение
    */
    PRIVATE MACRO A57 ()
      return "";
    END;

    /**
    @brief Счет наращенного дисконта
    @return Счет наращенного дисконта
    */
    MACRO A60():STRING
      var Account = "";
      var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
      
      if(A27() == "Д")
        if (isПросроч)
          Account = MC_GetExistAccount("Просроч_вексель", FD.kind, FD.id, FIROLE_DISCOUNT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        else
          Account = MC_GetExistAccount("Начисл.ПДД, УВ", FD.kind, FD.id, FIROLE_DISCOUNT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        end;
      end;
      return Account;
    END;

    /**
    @brief Счет наращенного процента
    @return Счет наращенного процента
    */
    MACRO A61():STRING
      var Account = "";
      var FD = VSBannerFD( DL_VSBANNER, m_RS.T_BCID );
      if(A27() == "П")
        if (isПросроч)
          Account = MC_GetExistAccount("Просроч_вексель", FD.kind, FD.id, FIROLE_PERCENT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        else
          Account = MC_GetExistAccount("Начисл.ПДД, УВ", FD.kind, FD.id, FIROLE_PERCENT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        end;
      end;
      return Account;
    END;

    /**
    @brief Счет по учету резерва
    @return Счет по учету резерва
    */
    MACRO A62():STRING
      var Account = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      if (isПросроч)
        Account = MC_GetExistAccount("РезервПросроч, вексель", FD.kind, FD.id, FIROLE_FIDOC, NATCUR, SQL_ConvTypeDate(m_Date));
      else
        Account = MC_GetExistAccount("Резерв, вексель", fd.kind, fd.id, FIROLE_FIDOC, NATCUR, SQL_ConvTypeDate(m_Date));
      end;
      return Account;
    END;

    /**
    @brief Срок векселя в днях с покупки до погашения
    @return Срок векселя в днях с покупки до погашения
    */
    MACRO A63():STRING
      return string(A26() - m_A38);
    END;

    /**
    @brief Доходность к покупке
    @return Доходность к покупке
    */
    PRIVATE MACRO A64():MONEY // 
      var c365:double, c366:double;

      GetDaysCoef(m_A38, SQL_ConvTypeDate(A26()) , @c365, @c366);

      return (m_Rs.T_PRINCIPAL - m_A20) / m_A20 / (c365+c366) * 100;
    END;

    /**
    @brief Доходность за период
    @return Доходность за период
    */
    PRIVATE MACRO A65():MONEY 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        var c365:double, c366:double;

        GetDaysCoef(m_A38, SQL_ConvTypeDate(m_Date) , @c365, @c366);


        return (m_Rs.T_BCCOST - m_A20) / m_A20 / (c365+c366) * 100;
      end;
      return 0.0;
    END;

    /**
    @brief Котировка по покупке
    @return Сейчас поле не заполняем, пустое значение
    */
    PRIVATE MACRO A67():STRING // 
        return "";
    END;

    /**
    @brief Выполняется поиск/расчет полей: Корректировки увеличивающие (уменьшающие) стоимость векселя, руб, Счет корректировки по стоимости векселя
    */
    PRIVATE MACRO A68_70() // 
      m_A68 = $0;
      m_A70 = "";
      var Account1 = "", Account2 = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      var rest1 = $0, rest2 = $0;
      Account1 = MC_GetExistAccount("КорСт_Увеличение, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      if((Account1 != ""))
        m_A70 = Account1 + " ";
        rest1 = abs(RestA (Account1, SQL_ConvTypeDate(m_Date)));
      end;
      Account2 = MC_GetExistAccount("КорСт_Уменьшение, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
      if((Account2 != ""))
        m_A70 = Account2 + " ";
        rest2 = abs(RestA (Account2, SQL_ConvTypeDate(m_Date)));
      end;
      m_A68 = rest1 + rest2;
    END;

    /**
    @brief Корректировка резервов на возможные потери, руб
    @return Корректировка резервов на возможные потери, руб
    */
    PRIVATE MACRO A69():MONEY
      var reslnk = TBfile("dlreslnk.dbt");
      if(GetResLnk(reslnk, m_Rs.T_BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_OR, SQL_ConvTypeDate( m_Date ), true))
        return reslnk.rec.ReserveAmount;
      end;
      return 0;
    END;

    /**
    @brief Счет корректировки по стоимости векселя
    @return Счет корректировки по стоимости векселя
    */
    PRIVATE MACRO A71() // 
      var Account1 = "", Account2 = "";
      var res = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      var rest1 = $0, rest2 = $0;
      Account1 = MC_GetExistAccount("+Кор_Резерв, вексель", fd.kind, fd.id, FIROLE_FIDOC, NATCUR, SQL_ConvTypeDate(m_Date));
      if((Account1 != ""))
        res = Account1 + " ";
      end;
      Account2 = MC_GetExistAccount("-Кор_Резерв, вексель", fd.kind, fd.id, FIROLE_FIDOC, NATCUR, SQL_ConvTypeDate(m_Date));
      if((Account2 != ""))
        res = Account2 + " ";
      end;
      return res;
    END;

    /**
    @brief Состояние векселя
    @return Состояние векселя
    */
    PRIVATE MACRO A72():STRING // 
      if(m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ACCOUNT)
        return "Учтен";
      elif(m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED)
        return "Погашен";
      elif(m_Rs.Sold == 1)
        return "Продан";
      end;
      return "";
    END;

    /**
    @brief Местонахождение векселя
    @return Местонахождение векселя
    */
    PRIVATE MACRO A73():STRING // 
      var r_ficert = TRecHandler("ficert.dbt");
        var ObjectID;
        var cmd = DL_RSDCommand(" SELECT ficert.* FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin "+
                          " WHERE  bnr.t_BCID = ? " +
                          "   and fin.t_FIID = bnr.t_FIID" +
                          "   and ficert.t_CertID = bnr.t_BCID" +
                          "   and ficert.t_AvoirKind = fin.t_AvoirKind");
        cmd.AddpAram(m_Rs.T_BCID);
        var DataSet = cmd.Execute();

        if (DataSet.moveNext())
            DataSet.GetRecord().CopyTO(r_ficert.rec);

            ObjectID = UniID(r_ficert, OBJTYPE_FICERT);
            return string(readNoteForObject(OBJTYPE_FICERT, ObjectID, 24));
        end;
        return "";
    END;

    /**
    @brief Филиал при продаже векселя
    @return Филиал при продаже векселя
    */
    PRIVATE MACRO B1():STRING // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if(m_Rs.DEP_CODE == "0000")
          return "Головной";
        elif(m_Rs.DEP_CODE == "7900")
          return "ЦКБ";
        elif(m_Rs.DEP_CODE == "6300")
          return "ЦРМБ";
        end;
        return m_Rs.DEP_NAME;
      end;
      return "";
    END;

    /**
    @brief Цена продажи
    @return Цена продажи
    */
    PRIVATE MACRO B2():MONEY // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_Rs.T_BCCOST;
      end;
      return "";
    END;

    /**
    @brief Цена продажи, руб.
    @return Цена продажи, руб.
    */
    PRIVATE MACRO B3():STRING // 
      var M = $0;
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if (m_RS.T_PFI == NATCUR)
          M = m_Rs.T_BCCOST;
        else
          ConvSum (M, money(m_Rs.T_BCCOST), SQL_ConvTypeDate(m_Date), m_RS.T_PFI, NATCUR);
        end;
      end;
      return M;
    END;

    /**
    @brief Валюта цены продажи
    @return Валюта цены продажи
    */
    PRIVATE MACRO B4():STRING // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_Rs.BCCOST_FI;
      end;
      return "";
    END;

    /**
    @brief Контрагент по продаже
    @return Контрагент по продаже
    */
    PRIVATE MACRO B5():STRING //
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_Rs.SOLD_NAME;
      end;
      return "";
    END;

    /**
    @brief ИНН контрагента по продаже
    @return ИНН контрагента по продаже
    */
    PRIVATE MACRO B6():STRING //
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_RS.SOLD_INN;
      end;
      return "";
    END;

    /**
    @brief ОГРН контрагента по продаже
    @return ОГРН контрагента по продаже
    */
    PRIVATE MACRO B7():STRING // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_RS.SOLD_OGRN;
      end;
      return "";
    END;

    /**
    @brief Статус контрагента по продаже
    @return Статус контрагента по продаже
    */
    PRIVATE MACRO B8():STRING // 
        var S = "";
        if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
          if (m_RS.SOLD_RES == SET_CHAR)
              S = "Нерезидент";
          else
              S = "Резидент";
          end;
        end;
        return S;
    END;

    /**
    @brief ОКСМ контрагента по продаже
    @return ОКСМ контрагента по продаже
    */
    PRIVATE MACRO B9():STRING // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_RS.SOLD_OKSM;
      end;
      return "";
    END;

    /**
    @brief Тип контрагента по продаже
    @return Тип контрагента по продаже
    */
    PRIVATE MACRO B10():STRING // 
        var S = "";
        var Kind;
        var DataSet;
        if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
          if (m_Rs.SOLD_LEGALFORM == 1)
              Kind = RSDCommand( "SELECT ptown.T_PARTYID FROM DPARTYOWN_DBT ptown WHERE ptown.T_PARTYID = ?  AND ptown.T_PARTYKIND = ?" );
              Kind.addParam( "", RSDBP_IN, m_RS.SOLD_ID );
              Kind.addParam( "", RSDBP_IN, PTK_BANK );
              Kind.execute();
              DataSet = TRsbDataSet(Kind);
              if(DataSet.moveNext())
                  S = "Кредитная организация";
              else
                  S = "Юридическое лицо";
              end;
          else
              Kind = RSDCommand( "SELECT 1 FROM DPERSN_DBT ptown WHERE ptown.T_PERSONID = ? AND ptown.t_isemployer = 'X' ");
              Kind.addParam( "", RSDBP_IN, m_RS.SOLD_ID );
              Kind.execute();
              DataSet = TRsbDataSet(Kind);
              if(DataSet.moveNext())
                  S = "Индивидуальный предприниматель";
              else
                  S = "Физическое лицо";
              end;
          end;
        end;
        return S;
    END;

    /**
    @brief TIN контрагента по продаже
    @return TIN контрагента по продаже
    */
    PRIVATE MACRO B11():STRING // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_RS.SOLD_TIN;
      end;
      return "";
    END;

    /**
    @brief Проверка, что вексель продан на дату
    @param[out] Дата, когда был продан (смена состояния на "Продан")
    @return true - продан, false - не продан
    */
    PRIVATE MACRO Продан(DateOut:@DATE):BOOL // 
      var DataSet;
      var cmd = DL_RSDCommand("  SELECT t_ChangeDate "
                            + "    FROM dvsbnrbck_dbt "
                            + "   WHERE     t_bcid = ? "
                            + "     AND  T_ISBCSTATE = 'A' AND INSTR(T_NEWBCSTATE, 'Р') > 0 AND INSTR(T_OLDBCSTATE, 'Р') = 0 "
                            + "     AND t_ChangeDate >= ? "
                            + "ORDER BY t_ChangeDate DESC, t_id DESC");
      cmd.AddpAram(m_Rs.T_BCID);
      cmd.AddpAram(SQL_ConvTypeDate(m_Rs.T_CHANGEDATE));
      DataSet = cmd.Execute();
      if (DataSet.moveNext())
        DateOut = SQL_ConvTypeDate(DataSet.ChangeDate);
        return true;
      end;
      return false;
    END;

    /**
    @brief Дата продажи
    @return Дата продажи
    */
    PRIVATE MACRO B12():DATE // 
      var DateOut:DATE = date(0,0,0);
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return SQL_ConvTypeDate(m_Rs.T_CHANGEDATE);
      elif(SQL_ConvTypeDate(m_Rs.T_CLOSED) != date(0,0,0))
        return SQL_ConvTypeDate(m_Rs.T_CLOSED);
      elif(Продан(@DateOut))
        return DateOut;
      end;
      return date(0,0,0);
    END;

    /**
    @brief Условия выбытия
    @return Условия выбытия
    */
    PRIVATE MACRO B13():STRING // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        var r_ficert = TRecHandler("ficert.dbt");
        var ObjectID;
        var cmd = DL_RSDCommand(" SELECT ficert.* FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin "+
                          " WHERE  bnr.t_BCID = ? " +
                          "   and fin.t_FIID = bnr.t_FIID" +
                          "   and ficert.t_CertID = bnr.t_BCID" +
                          "   and ficert.t_AvoirKind = fin.t_AvoirKind");
        cmd.AddpAram(m_Rs.T_BCID);
        var DataSet = cmd.Execute();

        if (DataSet.moveNext())
            DataSet.GetRecord().CopyTO(r_ficert.rec);

            ObjectID = UniID(r_ficert, OBJTYPE_FICERT);
            return string(readNoteForObject(OBJTYPE_FICERT, ObjectID, 25));
        end;
      end;
      return "";
    END;

    /**
    @brief Балансовый счет при реализации векселя
    @return Балансовый счет при реализации векселя
    */
    PRIVATE MACRO B14():STRING
      var Account = "";
      var fd;
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        fd = VATickFD (m_Rs.DOCKIND, m_Rs.TICKID);
        Account = MC_GetExistAccount("Реализация, УВ", fd.kind, fd.id, FIROLE_UNDEF, NATCUR, SQL_ConvTypeDate(m_Date));
      end;
      return Account;
    END;

    /**
    @brief Счет второго порядка по учету векселя при реализации
    @return Счет второго порядка по учету векселя при реализации
    */
    PRIVATE MACRO B15():STRING
      var Account = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        Account = MC_GetExistAccount("Учтенные векселя", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        Account = SubStr(Account, 1, 5);
      end;
      return Account;
    END;

    /**
    @brief Счет наращенного дисконта при реализации векселя
    @return Счет наращенного дисконта при реализации векселя
    */
    PRIVATE MACRO B16():STRING
      var Account = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if (isПросроч)
          Account = MC_GetExistAccount("Просроч_вексель", fd.kind, fd.id, FIROLE_DISCOUNT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        else
          Account = MC_GetExistAccount("Начисл.ПДД, УВ", fd.kind, fd.id, FIROLE_DISCOUNT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        end;
      end;
      return Account;
    END;

    /**
    @brief Счет наращенного процента при реализации векселя
    @return Счет наращенного процента при реализации векселя
    */
    PRIVATE MACRO B17():STRING
      var Account = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID);
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if (isПросроч)
          Account = MC_GetExistAccount("Просроч_вексель", fd.kind, fd.id, FIROLE_PERCENT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        else
          Account = MC_GetExistAccount("Начисл.ПДД, УВ", fd.kind, fd.id, FIROLE_PERCENT, fd.ОпределитьВалютуУчета(), SQL_ConvTypeDate(m_Date));
        end;
      end;
      return Account;
    END;

    /**
    @brief Счет по учету резерва при реализации векселя
    @return Счет по учету резерва при реализации векселя
    */
    PRIVATE MACRO B18():STRING
      var Account = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if (isПросроч)
          Account = MC_GetExistAccount("РезервПросроч, вексель", fd.kind, fd.id, FIROLE_FIDOC, NATCUR, SQL_ConvTypeDate(m_Date));
        else
          Account = MC_GetExistAccount("Резерв, вексель", fd.kind, fd.id, FIROLE_FIDOC, NATCUR, SQL_ConvTypeDate(m_Date));
        end;
      end;
      return Account;
    END;

    /**
    @brief Номер и дата договора при выбытии
    @return Номер и дата договора при выбытии
    */
    PRIVATE MACRO B19():STRING
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return m_Rs.T_DEALCODE + " от " + date_as_string( 1, SQL_ConvTypeDate( m_RS.T_DEALDATE ), false );
      end;
      return "";
    END;

    /**
    @brief Доход по счету 70601, руб.
    @return Доход по счету 70601, руб.
    */
    PRIVATE MACRO B20():MONEY
      var Account1 = "", Account2 = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      var rest1 = $0, rest2 = $0;
      var cmd;
      var DataSet;
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        Account1 = MC_GetExistAccount("+КорЭПС_%вексель", fd.kind, fd.id, FIROLE_UNDEF, NATCUR, SQL_ConvTypeDate(m_Date));
        if((Account1 != ""))
           cmd = DL_RSDCommand("select nvl(sum(arh.t_sum_natcur), 0) summ" +
                                  " from dacctrn_dbt arh" +
                                  "                              where arh.t_State = 1  /*фактическая проводка*/ " +
                                  "                                and arh.T_ACCOUNT_RECEIVER = ?" +
                                  "                                and arh.T_ACCOUNT_PAYER like ?" +
                                  "                              order by arh.t_AccTrnID desc");
          cmd.AddpAram(Account1);
          cmd.AddpAram("%" + m_Rs.ACCCODE);
          DataSet = cmd.Execute();

          if (DataSet.moveNext())
            rest1 = abs(DataSet.summ);
          end;
        end;
        Account2 = MC_GetExistAccount("+%, вексель", fd.kind, fd.id, FIROLE_UNDEF, NATCUR, SQL_ConvTypeDate(m_Date));
        if((Account2 != ""))
          cmd = DL_RSDCommand("select nvl(sum(arh.t_sum_natcur), 0) summ" +
                                  " from dacctrn_dbt arh" +
                                  "                              where arh.t_State = 1  /*фактическая проводка*/ " +
                                  "                                and arh.T_ACCOUNT_RECEIVER = ?" +
                                  "                                and arh.T_ACCOUNT_PAYER like ?" +
                                  "                              order by arh.t_AccTrnID desc");
          cmd.AddpAram(Account2);
          cmd.AddpAram("%" + m_Rs.ACCCODE);
          DataSet = cmd.Execute();

          if (DataSet.moveNext())
            rest2 = abs(DataSet.summ);
          end;
        end;
        return rest1 + rest2;
      end;
      return 0.0;
    END;

    /**
    @brief Расход по счету 70606, руб.
    @return Расход по счету 70606, руб.
    */
    PRIVATE MACRO B21():MONEY
      var Account1 = "", Account2 = "";
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      var rest1 = $0, rest2 = $0;
      var cmd;
      var DataSet;
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        Account1 = MC_GetExistAccount("-Премия, вексель", fd.kind, fd.id, FIROLE_BONUS, NATCUR, SQL_ConvTypeDate(m_Date));
        if((Account1 != ""))
          cmd = DL_RSDCommand("select nvl(sum(arh.t_sum_natcur), 0) summ" +
                                  " from dacctrn_dbt arh" +
                                  "                              where arh.t_State = 1  /*фактическая проводка*/ " +
                                  "                                and arh.T_ACCOUNT_PAYER = ?" +
                                  "                                and arh.T_ACCOUNT_RECEIVER like ?" +
                                  "                              order by arh.t_AccTrnID desc");
          cmd.AddpAram(Account1);
          cmd.AddpAram("%" + m_Rs.ACCCODE);
          DataSet = cmd.Execute();

          if (DataSet.moveNext())
            rest1 = abs(DataSet.summ);
          end;
        end;
        Account2 = MC_GetExistAccount("-КорЭПС_%вексель", fd.kind, fd.id, FIROLE_UNDEF, NATCUR, SQL_ConvTypeDate(m_Date));
        if((Account2 != ""))
          cmd = DL_RSDCommand("select nvl(sum(arh.t_sum_natcur), 0) summ" +
                                  " from dacctrn_dbt arh" +
                                  "                              where arh.t_State = 1  /*фактическая проводка*/ " +
                                  "                                and arh.T_ACCOUNT_PAYER = ?" +
                                  "                                and arh.T_ACCOUNT_RECEIVER like ?" +
                                  "                              order by arh.t_AccTrnID desc");
          cmd.AddpAram(Account2);
          cmd.AddpAram("%" + m_Rs.ACCCODE);
          DataSet = cmd.Execute();

          if (DataSet.moveNext())
            rest2 = abs(DataSet.summ);
          end;
        end;
        return rest1 + rest2;
      end;
      return 0.0;
    END;

    /**
    @brief Срок в днях на балансе
    @return Срок в днях на балансе
    */
    PRIVATE MACRO B22():INTEGER // 
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        return B12() - m_A38;
      end;
      return 0;
    END;

    /**
    @brief 
    @return 
    */
    PRIVATE MACRO GetCalcPeriodDates(BuyDate, RepaymentDate, BeginCalcDate:@date, EndCalcDate:@date, fd)
      if((fd.GetBnr().rec.BCTermFormula == VS_TERMF_FIXEDDAY))
        BeginCalcDate = BuyDate;
        EndCalcDate = RepaymentDate - 1;
      else
        BeginCalcDate = BuyDate + 1;
        EndCalcDate = RepaymentDate;
      end;
    END;

    /**
    @brief Поиск ставка рефинансирования ЦБ в %, действующая на дату
    @param[in] SaleDate Дата продажи
    @param[out] Rate Ставка
    @return 0 - поиск выполнили без ошибки, >0 - есть ошибка
    */
    PRIVATE MACRO GetCBRate(SaleDate:date, Rate:@variant)
      var CbrfRate, Select;
      var stat = 0;

      Select = DL_RsdCommand("select t_Rate from dCBrfrate_dbt where t_FIID ="+NATCUR+" and t_EffectiveDate <= ? order by t_EffectiveDate desc");

      Select.addParam(SaleDate);

      CbrfRate = Select.execute();
      stat = CbrfRate.moveNext();
      if(stat)
        Rate = CbrfRate.Rate;
      end;

      return stat;
    END;

    /**
    @brief Расчет коэффициента
    @return Возращает коэффициент
    */
    PRIVATE MACRO Get_d(StartDate, fd)
      var d = 0.0;
      var F; //ставка рефинансирования ЦБ в %, действующая на дату
      var E; //процент резерва, указанный в форме "Резервы по ценной бумаге",
      var msg;

      if(not GetCBRate(StartDate, @F))
        F = 0.0;
      end;

      if(CalcAndCheckReserveParams(fd.GetBnr().rec, StartDate, null, VARES_SUBKIND_AVR, @E) != 0)
        E = 0.0;
      end;

      d = F*(1 + E/100.0)/100.0;

      return d;
    END;

    /**
    @brief Поиск даты окончания процентной ставки
    @return Дата окончания
    */
    PRIVATE MACRO GetPrcHstEndDate(BCID, BeginDate):date
      var sqlQuery = "";
      var rsdCmd = null;
      var dataSet = null;

      sqlQuery =
        " SELECT "
        + " NVL( MIN( vsprchst.t_BegDate ) - 1, TO_DATE( '01.01.0001', 'DD.MM.YYYY' ) ) AS t_EndDate "
        + " FROM "
        + " dvsprchst_dbt vsprchst "
        + " WHERE "
        + " vsprchst.t_BCID = ? "
        + " AND vsprchst.t_BegDate > ? ";

      rsdCmd = RSDCommand(sqlQuery);
      rsdCmd.NullConversion = true;
      rsdCmd.AddParam("", RSDBP_IN, BCID);
      rsdCmd.AddParam("", RSDBP_IN, BeginDate);
      rsdCmd.Execute();

      dataSet = TRsbDataSet(rsdCmd);
      dataSet.MoveNext();

      return dataSet.EndDate;
    END;

    /**
    @brief Расчет доходности
    @return Сумму дохода
    */
    PRIVATE MACRO GetCalcCost(N, Rate, BuyOrSaleDate, RepaymentDate, fd)
      var d = 0.0;
      var Dn = date(0,0,0);
      var Do = date(0,0,0);
      var Пр = 0.0;
      var Dni = date(0,0,0);
      var Doi = date(0,0,0);
      var Прi = 0.0;
      var Ai = 0.0;
      var isDisc = false;
      var isPrc = false;
      var CalcCost = $0;

      d = Get_d(BuyOrSaleDate, fd);

      GetCalcPeriodDates(BuyOrSaleDate, RepaymentDate, @Dn, @Do, fd);
      Пр = РассчитатьКоэффОбращения(Dn, Do, fd.GetLeg().rec.Basis);

      isDisc = ВексельДисконтный(fd.GetLeg());
      isPrc = ВексельПроцентный(fd.GetLeg());

      if(isDisc and isPrc) // процентно-дисконтный
        CalcCost = N*(1.0 - d*Пр) + N/(1.0 + d*Пр);
      elif(isDisc) // дисконтный
        CalcCost = N*(1.0 - d*Пр);
      elif(isPrc) // процентный или депозитный сертификат
        CalcCost = N/(1.0 + d*Пр);
      end;

      if(isPrc)
        Dni = Dn;
        Doi = GetPrcHstEndDate(fd.GetBnr().rec.BCID, Dni);
        if(Doi == date(0,0,0))
          Doi = Do;
        end;

        while((Dni <= Do) and (Doi <= Do))
          Прi = РассчитатьКоэффОбращения(Dni, Doi, fd.GetLeg().rec.Basis);
             Ai = DL_VAGetBnrRateOnDate(fd.GetBnr().rec.BCID, Dni) / pow(10, fd.GetLeg().rec.Point);

          CalcCost = CalcCost + N*Ai*Прi/100.0/(1.0 + d*Пр);

          Dni = Doi + 1;
          Doi = GetPrcHstEndDate(fd.GetBnr().rec.BCID, Dni);
          if(Doi == date(0,0,0))
            Doi = Do;
          end;
        end;
      end;

      return round(double(CalcCost), 4);
    END;

    /**
    @brief Доход фактически полученный в валюте
    @return Доход фактически полученный в валюте
    */
    PRIVATE MACRO B24():MONEY // 
      var CostBuy = $0, CostSold = $0;
      var v1 = $0, v2 = $0, X = $0, Y = $0;
      var fd = VSBannerFD (DL_VSBANNER, m_Rs.T_BCID, DL_VARESERVE, VARES_SUBKIND_AVR);
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if (m_Rs.INCOMETYPE == "Б")
          return B2() - m_A20;
        end;
        CostSold = GetCalcCost(m_Rs.T_PRINCIPAL, IIF(m_Rs.INCOMETYPE == "Д", A50(), m_Rs.RATE), SQL_ConvTypeDate(m_Date), A28(), fd);
        CostBuy = GetCalcCost(m_Rs.T_PRINCIPAL, IIF(m_Rs.INCOMETYPE == "Д", A50(), m_Rs.RATE), m_A13, A28(), fd);

        if ((CostSold != 0) and (m_Rs.T_BCCOST != 0))
          if ( m_Rs.T_BCCOST < CostSold * (1 - 0.2))
            v1 = CostSold * (1 - 0.2) - m_Rs.T_BCCOST;
          end;
        end;

        if(v1 != 0)
          X = (1.0 - 0.2) * m_A20;
        else
          X = m_Rs.T_BCCOST;
        end;

        if(m_A20 > (1.0 + 0.2)*CostBuy)
          v2 = (1.0 + 0.2)*CostBuy - m_A20;
        end;

        if(v2 != 0)
          Y = (1.0 + 0.2)*CostBuy;
        else
          Y = m_A20;
        end;

        return X - Y;
      end;
      return 0;
    END;

    /**
    @brief Доход фактически полученный, руб.
    @return Доход фактически полученный, руб.
    */
    PRIVATE MACRO B23():MONEY // 
      var M = $0;
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        if(m_RS.T_PFI == NATCUR)

          M = B24();
        else
          ConvSum (M, money(B24()), SQL_ConvTypeDate(m_Date), m_RS.T_PFI, NATCUR);
        end;
      end;
      return M;
    END;

    /**
    @brief Метод печати отчета
    @return Метод Excel
    */
    PRIVATE MACRO PrintMode():INTEGER
        return DL_OUTREPORT_EXCEL;
    END;

    /**
    @brief Проверка, что есть данные для отчета
    @return true/false
    */
    PRIVATE MACRO CReport_DataExist()
        return m_NRecs > 0;
    END;

    /**
    @brief Вывод сообщения отсутствия данных для отчета
    */
    PRIVATE MACRO CReport_NoDataMsg()
        msgbox( "Нет данных для формирования отчета" );
    END;

    /**
    @brief Возвращает сгенерированное название view, где хранятся отобранные вексели по условиям
    @return Название view
    */
    PRIVATE MACRO GetViewName( Name ) // возвращает имя представления
        return StrUpr( String( "v", {oper}, Name ) );
    END;

    /**
    @brief Удаление view
    @return Название view
    */
    PRIVATE MACRO DropViewIfExist( Name )
        VAR ViewName = GetViewName( Name );
        SQL_Drop( " DROP VIEW " + ViewName + " " );
        return ViewName;
    END;

    /**
    @brief Создание view с отобранными векселями по условиям
    @return Название view
    */
    PRIVATE MACRO CreateView_OnPeriod( Name:STRING )
        VAR ViewName = DropViewIfExist( Name );
        var Cond = "";
        var Cond2 = "";

        if (m_BeginDate < m_EndDate)
          if ((m_Buy == SET_CHAR) AND (m_Repay == UNSET_CHAR))
            Cond = " AND t_ABCStatus = 'X' AND t_OldABCStatus <> t_NewABCStatus AND t_NewABCStatus = "  + VABANNER_STATUS_ACCOUNT + " ";
          elif ((m_Buy == UNSET_CHAR) AND (m_Repay == SET_CHAR))
            Cond = " AND ( t_ABCStatus = 'X' AND t_OldABCStatus <> t_NewABCStatus AND t_NewABCStatus = " + 
                    VABANNER_STATUS_ENDED + " OR T_ISBCSTATE = 'A' AND INSTR(T_NEWBCSTATE, 'Р') > 0 AND INSTR(T_OLDBCSTATE, 'Р') = 0 )";
          else
            Cond = " AND ( t_ABCStatus = 'X' AND t_OldABCStatus <> t_NewABCStatus AND t_NewABCStatus in ( " + VABANNER_STATUS_ENDED + " , " + VABANNER_STATUS_ACCOUNT + 
                    ") OR T_ISBCSTATE = 'A' AND INSTR(T_NEWBCSTATE, 'Р') > 0 AND INSTR(T_OLDBCSTATE, 'Р') = 0 )";
          end;
          Cond = Cond + "                               AND t_ChangeDate >= " + GetSQLDate( m_BeginDate )
                      + "                               AND t_ChangeDate <= " + GetSQLDate( m_EndDate );
        elif (m_BeginDate == m_EndDate)
          Cond = Cond = " AND ( t_ABCStatus = 'X' AND t_OldABCStatus <> t_NewABCStatus AND t_NewABCStatus in ( " + VABANNER_STATUS_ENDED + " , " + VABANNER_STATUS_ACCOUNT + 
                    ") OR T_ISBCSTATE = 'A' AND INSTR(T_NEWBCSTATE, 'Р') > 0 AND INSTR(T_OLDBCSTATE, 'Р') = 0 )"
               + " AND t_ChangeDate <= " + GetSQLDate( m_BeginDate );
          Cond2 = " AND vsbnrbck.t_NewABCStatus = "  + VABANNER_STATUS_ACCOUNT;
        end;

        SQL_Execute(  "CREATE VIEW " + ViewName
                    + " AS "
                    + "   SELECT vsbnrbck.t_ID, "
                    + "          vsbnrbck.t_BCID, "
                    + "          vsbnrbck.t_ChangeDate, "
                    + "          vsbnrbck.t_OldABCStatus, "
                    + "          vsbnrbck.t_NewABCStatus, "
                    + "          case when INSTR(vsbnrbck.T_NEWBCSTATE, 'Р') > 0 then 1 else 0 end Sold"
                    + "     FROM dvsbnrbck_dbt vsbnrbck "
                    + "    WHERE vsbnrbck.t_id = "
                    + "             (SELECT * "
                    + "                FROM (  SELECT t_ID "
                    + "                          FROM dvsbnrbck_dbt "
                    + "                         WHERE     t_bcid = vsbnrbck.t_bcid "
                    +                                 Cond
                    + "                      ORDER BY t_ChangeDate DESC, t_id DESC) "
                    + "               WHERE ROWNUM = 1) "
                    + Cond2);

        return ViewName;
    END;

    /**
    @brief Отбор данных для векселей из view
    */
    PRIVATE MACRO GetDataQuery()
        VAR Q;

        Q = CreateView_OnPeriod("vsb_attr_va"); 
        

        m_DataQuery = "SELECT A.T_BCID, "
        + "        C1.T_PARTYID ISSUER, "
        + "        NVL ( (SELECT T_SHORTNAME "
        + "                 FROM DPARTY_DBT PAR "
        + "                WHERE     PAR.T_PARTYID = B.T_DEPARTMENT "
        + "                      AND EXISTS "
        + "                             (SELECT 1 "
        + "                                FROM DDP_DEP_DBT "
        + "                               WHERE T_CODE = B.T_DEPARTMENT)), "
        + "             '') "
        + "           BRANCH_NAME, "
        + "NVL ( (SELECT T_NAME "
        + "                FROM DDP_DEP_DBT DEP "
        + "               WHERE     DEP.T_CODE = B.T_DEPARTMENT ), "
        + "            '') "
        + "          BRANCH_CODE, "
        + "        C1.T_SHORTNAME ISSUERNAME, "
        + "        (CASE "
        + "            WHEN C1.T_NOTRESIDENT <> 'X' "
        + "            THEN "
        + "               RSI_RSBPARTY.GETPARTYCODE (C1.T_PARTYID, 16) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           INN, "
        + "        RSI_RSBPARTY.GETPARTYCODE (C1.T_PARTYID, 27) OGRN, "
        + "        C1.T_NOTRESIDENT ISSUER_RES, "
        + "        (CASE "
        + "            WHEN C1.T_NRCOUNTRY <> CHR (0) AND C1.T_NRCOUNTRY IS NOT NULL "
        + "            THEN "
        + "               (SELECT T_CODENUM3 "
        + "                  FROM DCOUNTRY_DBT DC "
        + "                 WHERE DC.T_CODELAT3 = C1.T_NRCOUNTRY) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           OKSM, "
        + "        C1.T_LEGALFORM ISSUER_LEGALFORM, "
        + "        (CASE "
        + "            WHEN C1.T_NOTRESIDENT = 'X' "
        + "            THEN "
        + "               RSI_RSBPARTY.GETPARTYCODE (C1.T_PARTYID, 62) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           TIN, "
        + "        B.T_BCSERIES, "
        + "        B.T_BCNUMBER, "
        + "        B.T_ACCCODE, "
        + "        G.T_DEALCODE, "
        + "        G.T_DEALDATE, "
        + "        B.T_ISSUEPLACE, "
        + "        B.T_ISSUEDATE, "
        + "        B.T_BCTERMFORMULA, "
        + "        B.T_BCPRESENTATIONDATE, "
        + "        D.T_MATURITY, "
        + "        D.T_START, "
        + "        D.T_DIFF, "
        + "        D.T_BASIS, "
        + "        D.T_EXPIRY, "
        + "        D.T_PRINCIPAL, "
        + "        D.T_RECEIPTAMOUNT, "
        + "        D.T_FORMULA, "
        + "        D.T_PRICE, "
        + "        D.T_DEALID, "
        + "        D.T_CLOSED, "
        + "        H.T_BCCOST, "
        + "        (SELECT T_CCY "
        + "           FROM DFININSTR_DBT "
        + "          WHERE T_FIID = H.T_BCCFI) "
        + "           BCCOST_FI, "
        + "        H.T_TAXBASEAMOUNT, "
        + "        H.T_TAXAMOUNT, "
        + "        D.T_PFI, "
        + "        (SELECT T_CCY "
        + "           FROM DFININSTR_DBT "
        + "          WHERE T_FIID = D.T_PFI) "
        + "           CURRENCY, "
        + "        CASE "
        + "           WHEN D.T_FORMULA = 1 "
        + "           THEN "
        + "              'П' "
        + "           WHEN D.T_FORMULA = 0 AND CASE WHEN D.T_RECEIPTAMOUNT = 0 THEN D.T_PRINCIPAL - H.T_BCCOST ELSE D.T_PRINCIPAL - D.T_RECEIPTAMOUNT end <> 0 "
        + "           THEN "
        + "              'Д' "
        + "           ELSE "
        + "              'Б' "
        + "        END "
        + "           INCOMETYPE, "
        + "        D.T_DURATION, "
        + "        (CASE "
        + "            WHEN D.T_FORMULA IN (" + VS_IN_S_PC 
        + "                                  , " + VS_IN_M_PC 
        + "                                     , " + VS_IN_DISC_PC 
        + "                                        ) AND D.T_PRICE > 0 "
        + "            THEN "
        + "               D.T_PRICE / POWER (10, D.T_POINT) "
        + "            ELSE "
        + "               0 "
        + "         END) "
        + "           RATE, "
        + "        A.T_NEWABCSTATUS, "
        + "        A.T_OLDABCSTATUS, "
        + "        A.T_CHANGEDATE, "
        + "        B.T_DISCOUNTREMAINDER, "
        + "        C3.T_PARTYID CONTR_ID, "
        + "        C3.T_SHORTNAME CONTR_NAME, "
        + "        (CASE "
        + "            WHEN C3.T_NOTRESIDENT <> 'X' "
        + "            THEN "
        + "               RSI_RSBPARTY.GETPARTYCODE (C3.T_PARTYID, 16) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           CONTR_INN, "
        + "        RSI_RSBPARTY.GETPARTYCODE (C3.T_PARTYID, 27) CONTR_OGRN, "
        + "        (CASE "
        + "            WHEN C3.T_NRCOUNTRY <> CHR (0) AND C3.T_NRCOUNTRY IS NOT NULL "
        + "            THEN "
        + "               (SELECT T_CODENUM3 "
        + "                  FROM DCOUNTRY_DBT DC "
        + "                 WHERE DC.T_CODELAT3 = C3.T_NRCOUNTRY) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           CONTR_OKSM, "
        + "        C3.T_NOTRESIDENT CONTR_RES, "
        + "        C3.T_LEGALFORM CONTR_LEGALFORM, "
        + "        (CASE "
        + "            WHEN C3.T_NOTRESIDENT = 'X' "
        + "            THEN "
        + "               RSI_RSBPARTY.GETPARTYCODE (C3.T_PARTYID, 62) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           CONTR_TIN, "
        + "        (SELECT t_shortname "
        + "           FROM dparty_dbt dp "
        + "          WHERE dp.t_partyid = (SELECT t_partyid "
        + "                FROM DDP_DEP_DBT DEP "
        + "               WHERE     DEP.T_CODE = G.T_DEPARTMENT )) "
        + "           DEP_NAME, "
        + "NVL ( (SELECT T_NAME "
        + "                FROM DDP_DEP_DBT DEP "
        + "               WHERE     DEP.T_CODE = G.T_DEPARTMENT ), "
        + "            '') "
        + "          DEP_CODE, "
        + "        C4.T_PARTYID SOLD_ID, "
        + "        C4.T_SHORTNAME SOLD_NAME, "
        + "        (CASE "
        + "            WHEN C4.T_NOTRESIDENT <> 'X' "
        + "            THEN "
        + "               RSI_RSBPARTY.GETPARTYCODE (C4.T_PARTYID, 16) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           SOLD_INN, "
        + "        RSI_RSBPARTY.GETPARTYCODE (C4.T_PARTYID, 27) SOLD_OGRN, "
        + "        (CASE "
        + "            WHEN C4.T_NRCOUNTRY <> CHR (0) AND C4.T_NRCOUNTRY IS NOT NULL "
        + "            THEN "
        + "               (SELECT T_CODENUM3 "
        + "                  FROM DCOUNTRY_DBT DC "
        + "                 WHERE DC.T_CODELAT3 = C4.T_NRCOUNTRY) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           SOLD_OKSM, "
        + "        C4.T_NOTRESIDENT SOLD_RES, "
        + "        C4.T_LEGALFORM SOLD_LEGALFORM, "
        + "        (CASE "
        + "            WHEN C4.T_NOTRESIDENT = 'X' "
        + "            THEN "
        + "               RSI_RSBPARTY.GETPARTYCODE (C4.T_PARTYID, 62) "
        + "            ELSE "
        + "               '' "
        + "         END) "
        + "           SOLD_TIN, "
        + "        F.T_KIND_OPERATION, "
        + "        G.T_DEALCODE, "
        + "        G.T_DEALDATE, "
        + "        G.T_DEALID TICKID, "
        + "        G.T_BOFFICEKIND DOCKIND, "
        + "        A.Sold "
        + "   FROM " + Q + " A, "
        + "        DVSBANNER_DBT B, "
        + "        DPARTY_DBT C1, "
        + "        DPARTY_DBT C3, "
        + "        DPARTY_DBT C4, "
        + "        DDL_LEG_DBT D, "
        + "        DOPRDOCS_DBT E, "
        + "        DOPROPER_DBT F, "
        + "        DDL_TICK_DBT G, "
        + "        DVSORDLNK_DBT H "
        + "  WHERE     LPAD (A.T_ID, 10, '0') = E.T_DOCUMENTID "
        + "        AND E.T_DOCKIND =  " + DL_VSBNRBCK 
        + "        AND E.T_ID_OPERATION = F.T_ID_OPERATION "
        + "        AND F.T_DOCKIND IN ( " + DL_VEKSELACCOUNTED
        + "                               ,  " + DL_VAREPAY
        + "                                    ) "
        + "        AND F.T_DOCUMENTID = LPAD (G.T_DEALID, 34, '0') "
        + "        AND A.T_BCID = B.T_BCID "
        + "        AND B.T_BCID = D.T_DEALID "
        + "        AND D.T_LEGKIND =  " + LEG_KIND_VSBANNER
        + "        AND H.T_CONTRACTID = G.T_DEALID"
        + "        AND H.T_DOCKIND = G.T_BOFFICEKIND"
        + "        AND A.T_BCID = H.T_BCID "
        + "        AND C1.T_PARTYID = B.T_ISSUER "
        + "        AND C3.T_PARTYID = "
        + "               (SELECT * "
        + "                  FROM (  SELECT tick.t_partyid "
        + "                            FROM dvsordlnk_dbt ordlnk, DDL_TICK_DBT tick "
        + "                           WHERE     ordlnk.T_BCID = B.T_BCID "
        + "                                 AND ordlnk.t_linkkind =  " + VSORDLNK_K_BUY
        + "                                 AND ORDLNK.T_INTERESTCHARGEDATE <= "
        + "                                        H.T_INTERESTCHARGEDATE "
        + "                                 AND tick.T_DEALID = ORDLNK.T_CONTRACTID "
        + "                                 AND tick.T_BOFFICEKIND = ORDLNK.T_DOCKIND "
        + "                        ORDER BY ORDLNK.T_INTERESTCHARGEDATE DESC) "
        + "                 WHERE ROWNUM = 1) "
        + "        AND C4.T_PARTYID = G.T_PARTYID ";
    END;

    /**
    @brief Очистка данных отчета
    */
    PRIVATE MACRO ClearDataQuery()
        DropViewIfExist( "vsb_attr_va" );
    END;

    /**
    @brief Начало работы отчета: получение парметров, отбор данных, переход на нужную страницу excel
    */
    PRIVATE MACRO BeginReport( NumCopy:INTEGER )
        Dl_CallInsertStat( PrintMode() );

        m_BeginDate = m_Form.GetFieldValue( PNFLD_REGBNRVA_BEGINDATE );
        m_EndDate   = m_Form.GetFieldValue( PNFLD_REGBNRVA_ENDDATE );
        m_Buy   = m_Form.GetFieldValue( PNFLD_REGBNRVA_BUY );
        m_Repay  = m_Form.GetFieldValue( PNFLD_REGBNRVA_REPAY );

        GetDataQuery();
        m_NRecs = SQL_GetNRecs( m_DataQuery );

        if( CReport_DataExist() )
            SetActiveSheet( "Сторонние векселя" );
            CreateTotalBook();
        end;
    END;

    /**
    @brief Печать строки отчета
    */
    PRIVATE MACRO PrintLine(  )
      m_Date = m_EndDate;
      if((m_Rs.Sold == 1) OR (m_Rs.T_NEWABCSTATUS == VABANNER_STATUS_ENDED))
        m_Date = m_Rs.T_CHANGEDATE;
      end;
      isПросроч = СостояниеВекселяНаДату(m_Rs.T_BCID, SQL_ConvTypeDate(m_Date),"Ч");
      FIND_FIRSTHOLDER();
      A12_13_20_22_38_39();
      A23_24_58_59();
      A52_66();
      A68_70();
        PrintTableLine(     "N1_A1", A1(), null,
                            "N1_A2", A2(), null,
                            "N1_A3", A3(), null,
                            "N1_A4", A4(), null,
                            "N1_A5", A5(), null,
                            "N1_A6", A6(), null,
                            "N1_A7", A7(), null,
                            "N1_A8", A8(), null,
                            "N1_A10", A10(), null,
                            "N1_A11", A11(), null,
                            "N1_A12", m_A12, null,
                            "N1_A13", m_A13, null,
                            "N1_A14", A14(), null,
                            "N1_A15", A15(), null,
                            "N1_A16", A16(), null,
                            "N1_A17", A17(), null,
                            "N1_A18", A18(), null,
                            "N1_A19", A19(), null,
                            "N1_A20", m_A20, null,
                            "N1_A21", A21(), null,
                            "N1_A22", A22(), null,
                            "N1_A23", m_A23, null,
                            "N1_A24", m_A24, null,
                            "N1_A25", A25(), null,
                            "N1_A26", A26(), null,
                            "N1_A27", A27(), null,
                            "N1_A28", A28(), null,
                            "N1_A29", A29(), null,
                            "N1_A30", A30(), null,
                            "N1_A31", A31(), null,
                            "N1_A32", A32(), null,
                            "N1_A33", A33(), null,
                            "N1_A34", A34(), null,
                            "N1_A35", A35(), null,
                            "N1_A36", A36(), null,
                            "N1_A37", A37(), null,
                            "N1_A38", m_A38, null,
                            "N1_A39", m_A39, null,
                            "N1_A40", A40(), null,
                            "N1_A41", A41(), null,
                            "N1_A42", A42(), null,
                            "N1_A43", A43(), null,
                            "N1_A44", A44(), null,
                            "N1_A45", A45(), null,
                            "N1_A46", A46(), null,
                            "N1_A47", A47(), null,
                            "N1_A48", A48(), null,
                            "N1_A49", A49(), null,
                            "N1_A50", A50(), null,
                            "N1_A51", A51(), null,
                            "N1_A52", m_A52, null,
                            "N1_A53", A53(), null,
                            "N1_A54", A54(), null,
                            "N1_A55", A55(), null,
                            "N1_A56", A56(), null,
                            "N1_A57", A57(), null,
                            "N1_A58", m_A58, null,
                            "N1_A59", m_A59, null,
                            "N1_A60", A60(), null,
                            "N1_A61", A61(), null,
                            "N1_A62", A62(), null,
                            "N1_A63", A63(), null,
                            "N1_A64", A64(), null,
                            "N1_A65", A65(), null,
                            "N1_A66", m_A66, null,
                            "N1_A67", A67(), null,
                            "N1_A68", m_A68, null,
                            "N1_A69", A69(), null,
                            "N1_A70", m_A70, null,
                            "N1_A71", A71(), null,
                            "N1_A72", A72(), null,
                            "N1_A73", A73(), null,
                            "N1_B1",  B1(), null,
                            "N1_B2",  B2(), null,
                            "N1_B3",  B3(), null,
                            "N1_B4",  B4(), null,
                            "N1_B5",  B5(), null,
                            "N1_B6",  B6(), null,
                            "N1_B7",  B7(), null,
                            "N1_B8",  B8(), null,
                            "N1_B9",  B9(), null,
                            "N1_B10", B10(), null,
                            "N1_B11", B11(), null,
                            "N1_B12", B12(), null,
                            "N1_B13", B13(), null,
                            "N1_B14", B14(), null,
                            "N1_B15", B15(), null,
                            "N1_B16", B16(), null,
                            "N1_B17", B17(), null,
                            "N1_B18", B18(), null,
                            "N1_B19", B19(), null,
                            "N1_B20", B20(), null,
                            "N1_B21", B21(), null,
                            "N1_B22", B22(), null,
                            "N1_B23", B23(), null,
                            "N1_B24", B24(), null
                             );

    END;

    /**
    @brief Создание отчета: получение отборанных данных, регистрация таблицы 
    */
    PRIVATE MACRO Create( NumCopy:INTEGER )
        VAR RecordCount = 0;

        if( CReport_DataExist() )
            InitProgress( m_NRecs, "Идет формирование отчета", "Сторонние векселя" );

            m_RS = TRsbDataSet( m_DataQuery );
            while( m_RS.MoveNext() )
                if( RecordCount == 0 )
                    CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_TableHeader", 0, m_CurrSheetName, true );
                    RegisterTable( "N1_TableData", null,
                                   "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A5", "N1_A6", "N1_A7", "N1_A8", "N1_A9",
                                   "N1_A10", "N1_A11", "N1_A12", "N1_A13", "N1_A14", "N1_A15",
                                   "N1_A16", "N1_A17", "N1_A18", "N1_A19", "N1_A20", "N1_A21", "N1_A22", "N1_A23",
                                   "N1_A24", "N1_A25", "N1_A26", "N1_A27", "N1_A28", "N1_A29", "N1_A30", "N1_A31", "N1_A32", "N1_A33", 
                                   "N1_A34", "N1_A35", "N1_A36", "N1_A37", "N1_A38", "N1_A39", "N1_A40", "N1_A41", "N1_A42", "N1_A43", "N1_A44",
                                   "N1_A45", "N1_A46", "N1_A47", "N1_A48", "N1_A49", "N1_A50", "N1_A51", "N1_A52", "N1_A53", "N1_A54", "N1_A55",
                                   "N1_A56", "N1_A57", "N1_A58", "N1_A59", "N1_A60", "N1_A61", "N1_A62", "N1_A63", "N1_A64", "N1_A65", "N1_A66", 
                                   "N1_A67", "N1_A68", "N1_A69", "N1_A70", "N1_A71", "N1_A72", "N1_A73", 
                                   "N1_B1",  "N1_B2",  "N1_B3",  "N1_B4",  "N1_B5",  "N1_B6",  "N1_B7",  "N1_B8",  "N1_B9",  "N1_B10", "N1_B11", 
                                   "N1_B12", "N1_B13", "N1_B14", "N1_B15", "N1_B16", "N1_B17", "N1_B18", "N1_B19", "N1_B20", "N1_B21",
                                   "N1_B22", "N1_B23", "N1_B24");
                end;

                PrintLine();
                UseProgress( RecordCount = RecordCount + 1 );
            end;

            EndTable();
            CopyAllSheetInTotalBook( m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true );

            RemProgress();
        end;
    END;

    /**
    @brief Завершение отчета: сохрание excel, очистка данных
    */
    PRIVATE MACRO EndReport( NumCopy:INTEGER )
        if( CReport_DataExist() )
            SaveTotalBook();
        end;
        ClearDataQuery();
    END;

    initDL_CReportTemplate( VA_BnrAttr_Panel(), "report_attr_va.xls" );
END;

/**
@brief Запуск работы отчета: панель с параметрами, расчет и заполнение отчета
*/
VA_BnrAttr().Run();
exit( 1 );
