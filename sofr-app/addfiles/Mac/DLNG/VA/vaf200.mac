/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vaf200.mac
                                va-вексель
                                 f-операция мены векселей УВ<->СВ
                               200-номер (соответствующий шагу)
  Programmer  : Чижик К.Н.
  Операция    : Мена векселей УВ<->СВ
  Шаг         : З.закрытие
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
IMPORT PaymInter, vacateg, valib, vapaym, dlclose, vafdates, vsaccclose, vaopr;


/* Запуск шага
   Алгоритм:
     Если статус хотя бы одного платежа с назначениями "актив" < 
     $(Готов к отправке), то выход по ошибке 
     "Требования по сделке не исполнены".

     Если статус хотя бы одного платежа с назначениями "контрактив" < 
     $(Готов к отправке), то выход по ошибке 
     "Обязательства по сделке не исполнены".

     Если статус хотя бы одного платежа с назначениями "оплата разницы" < 
     $(Готов к отправке), то выход по ошибке 
     "Обязательства по оплате разницы не исполнены" (если платит банк) или
     "Требования по оплате разницы не исполнены" (если платит контрагент).
*/
MACRO ExecuteStep(Buffer, dl_tick, DocKind, ID_Operation, ID_Step)
var
    stat = 0, StepDate = {curdate};

    record tick( dl_tick );
    SetBuff( tick, dl_tick );

    GetOprDate( DATE_XF_CLOSE, @StepDate );

    if  (not DL_TestAllSteps(ID_Operation, ID_Step))
       stat = VA_Err("Не все шаги операции выполнены.|Выполните все шаги операции.");
    elif(not VA_ArePaymsClosed(tick, BAi))     /* проверка платежей по активу */
       stat = VA_Err("Требования по сделке не исполнены");
    elif(not VA_ArePaymsClosed(tick, CAi))   /* проверка платежей по контрактиву */
       stat = VA_Err("Обязательства по сделке не исполнены");
    elif(not CheckAllStepsExecuted(ID_Operation))   /* проверка что все шаги выполнены */
       stat = VA_Err("Перед закрытием операции все шаги должны быть исполнены!");
    elif(not VA_ArePaymsClosed(tick, PM_PURP_VSBARTERDIFF))   /* проверка платежей по оплате разницы */
       stat = VA_Err("Платеж по оплате разницы не исполнен");
    end;

    if (stat == 0)
        if(not ЗакрытьСчетаВекселя(tick, StepDate)) 
           stat = 1;
        end;
    end;

    return stat;

END;


