/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vaf175.mac
                                va-вексель
                                 f-операция мены векселей УВ<->СВ
                               175-номер (соответствующий шагу)
  Programmer  : Чижик К.Н.
  Операция    : Мена векселей УВ<->СВ
  Шаг         : Есть векселя к погашению ?
└───────────────────────────────────────────────────────────────────────────*/

IMPORT OprInter, vafdates, vamisc;

PRIVATE var 
   ПервыйПогВексель=false,
   StepDate;

PRIVATE MACRO ПоикПогВекс(bnr, leg, tick, numOrd, lnk)

 if (lnk.rec.IsPartycular == "X")
   ПервыйПогВексель=true;
 end;
   return 0;
END;


PRIVATE MACRO ПоискВексДляПогаш(tick)
var stat = VA_ForEachBanner(tick, @ПоикПогВекс, VSORDLNK_K_DRAW, null,  null);
    return (stat==0);
END;


/* Запуск шага
*/
MACRO ExecuteCaseStep(OperationKind, StepNumber, FDoc, KindDoc )
   record tick("dl_tick");

   SetBuff( tick, FDoc );
   ПервыйПогВексель = false;

   GetOprDate( DATE_XF_NEW, @StepDate );

   if( StepDate > {curdate} )
      MsgBox ("Преждевременное выполнение шага запрещено.");
      return 1;
   end;

   if( not ПоискВексДляПогаш(tick) )
      msgbox("Ошибка при поиске векселей для погашения");
   end;
   if (ПервыйПогВексель)
      return "180";   /* есть */
   elif(not ПоискШагаЗакрытие(tick))
      return "200";   /* нет */
   end;

   return "";
END;
