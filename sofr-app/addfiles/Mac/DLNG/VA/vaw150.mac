/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vaw150.mac
                                va-вексель
                                 w-операция мены векселей СВ<->УВ
                               150-номер (соответствующий шагу)
  Programmer  : Чижик К.Н.
  Операция    : Мена векселей СВ<->УВ
  Шаг         : Оформление сертификатов векселей
  Comment     : сделано по образцу vsb080cl.mac
└───────────────────────────────────────────────────────────────────────────*/
IMPORT vatickfd, vawdates, vsform2;


/* Счета, остатки на счетах и характеристики векселя и т.п.
   сохраняются в глобальных переменных.
   Вычисляются на наиболее ранних этапах шага
   (в тот момент, когда их уже можно определить).
   Используются далее в функциях. Как правило, функции
   нижнего уровня не имеют параметров (применяют глобальные переменные).
*/
PRIVATE VAR
            StepDate = {curdate};


/* Запуск шага
*/
MACRO ExecuteStep(Buffer, dl_tick)
var stat=0;

    record tick( dl_tick );
    SetBuff( tick, dl_tick );

    VA_GetStepDate( DATE_XW_OLD, @StepDate );

    if(not ОформлСертВекселей(tick, StepDate, VATickFD(tick)))
       stat = 1;
    end;

    return stat;
END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    Печать(true, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПО"); /* Счета, Проводки, мем.Ордера */
 
    return 1;
END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    Печать(false, "vsrep", ID_Operation, ID_step, isOprMultiExec, "СПО"); /* Счета, Проводки, мем.Ордера */
 
    exit(1) ;
END;
