/*
$Name:         vaf140.mac
$Module:       Учтенные векселя
$Description:  Т.исполнение требований

            va-вексель
           f-операция мены векселей УВ<->СВ
            140-номер (соответствующий шагу)
*/
IMPORT DealsInter,  
       vaacc, va4each, vafdates, vatickfd, vamisc, vapaym, vaxutils,
       vsbnrfd, vslib, vsrepay2, vscarry, vsrepay3, vsrepay;

PRIVATE VAR
           StepDate = {curdate},           // Дата выполнения шага
           DealDate = {curdate},           // дата сделки
           СчетРеализация,                 // Счет по категории "Реализация, УВ"
           ВЦоб,                           // Валюта цены обязательств
           РежимДоначислПроц,              // true - с расходов, false - стандартный
           fdTick;                         // Первичный док-т сделки


PRIVATE MACRO BkpForEachBanner(bnr, leg, tick, numOrd, lnk, prm)
var
  fd,
  stat = 0;

  fd = VSBannerFD(bnr, leg, tick.BofficeKind, tick);
  //if( not ВыполнитьПереоценкуНВПИ(bnr.rec.BCID, StepDate, StepDate, fd.ОпределитьВалютуУчета(), fd) )
  //  stat = VA_Err("Ошибка при выполнении НВПИ");
  //end;

  if( stat == 0 )
    stat = VS_ОформитьВыкупВекселя(bnr, leg, tick, lnk, prm);
  end;

  return stat;

END;

/* Установить статус "закрыт" всем платежам по контрактиву. 
     Если init == true, делаем платежам Actuate, 
     иначе - устанавливаем статус
*/
PRIVATE MACRO ClosePayments(tick, init)
    if(init == true)
       return VA_ActuatePayms(tick, CAi, StepDate);
    else
       return VA_SetStatOfPayms(tick, CAi, PM_FINISHED, StepDate);
    end;
    return true;
END;

/* Запуск шага
   Алгоритм: см. диаграмму.
*/
MACRO ExecuteStep(Buffer, dl_tick)
var
    prm = RepPrm(),
    stat = 0;

    record tick( dl_tick );
    SetBuff( tick, dl_tick );

    DealDate = tick.DealDate;
    GetOprDate( DATE_XF_NEW, @StepDate );

    if( StepDate > {curdate} )
       return VA_Err ("Преждевременное выполнение шага запрещено.");
    end;
    
    РежимДоначислПроц = VS_GetSetting("РЕЖИМ РАБОТЫ\\ДОНАЧИСЛЕНИЕ ПРОЦЕНТОВ");

    prm.СчетЗачисления = "";
    prm.flag = РежимДоначислПроц;


    ВЦоб = VA_GetComCostFI(tick); // Получаем валюту цены обязательств
    if(ВЦоб == -1)
      stat = VA_Err("Ошибка при получении валюты цены обязательств по сделке");
    elif((fdTick = VATickFD(tick)) == null)
       stat = VA_Err("Ошибка при определении первичного документа сделки");
    elif(not VA_GetAccount("Реализация, УВ", fdTick, СчетРеализация, MC_OPENACC_CREATE, NATCUR, FIROLE_FIREQ, null, StepDate))
       stat = 1;
    end;
    if( stat == 0 )
      prm.СчетЗачисления = СчетРеализация;
      prm.Режим = 2;

      if(not ClosePayments(tick, true))
        stat = 1;
      elif(NOT ПриемВексКПогаш(tick, null, null, StepDate, VATickFD(tick)))
        stat = 1;
      elif(VA_ForEachBanner(tick, @BkpForEachBanner, VSORDLNK_K_BUY, prm) != 0)
        stat = 1;
      elif(not ПереводВекселейВПогашенные(tick, StepDate)) // Изменение статуса погашаемых векселей.
        stat = 1;
      elif(not ПереводВекселейВВыкупленные(tick, StepDate, false)) // Изменение статуса выкупаемых векселей.
        stat = 1;
      elif(not ClosePayments(tick, false))
        stat = 1;
      end;
    end;

    return stat;
END;


//печать через vaprstvs.mac

/*
MACRO PostStep (...)
MACRO PrintStepDocs (...)
*/

