/*
$Name:         vaperdisc.mac
$Module:       Учтенные векселя
$Description:  Макрос запуска сервисной операции начисления ПДД по векселю
*/

IMPORT OprInter, VSInter, "vsbnrfd.mac", "vaprdslib.mac", "vaservop.mac", "vaprdec.mac";

PRIVATE MACRO SayPerDiscError( bnr, stat, Err )
  SvOpInsertError( DL_VSBANNER, OprServDoc, bnr, stat, err );
  return stat;
END;

MACRO ExecuteStep(Buffer, FirstDoc, DocKind, ID_Operation, ID_Step)
  RECORD bnr(vsbanner);

  SetBuff( bnr, FirstDoc );

  var fd = VSBannerFD (DL_VSBANNER, bnr.BCID), Err = 0, ErrMsg = "";

  if( fd == null )
     MsgBox("Ошибка при определении счета");
     return 1;
  end;
    
  if( OprServDoc.ExecutionDate > {curdate} )
     MsgBox("Преждевременное выполнение шага запрещено.");
     return 1;
  end;

  Err = УВ_НачислениеПроцентовИДисконта(fd, OprServDoc.ExecutionDate, OprServDoc.ValueDate, OprServDoc.Flag2, ID_Operation, ID_Step, @ErrMsg);
  if( ErrMsg != "" )
     SayPerDiscError(bnr, 1, ErrMsg);
  end;
  if( Err != 0 )
     return 1;
  end;

  return 0;
END;

/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

var TempFile;
var vssrvdoc;
var query,DataSet;
var stat = 0;
var StrType,StrOpr,StrPurp;

    
    if (errTrn or (CommitOrRollback == 2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    return 1;
END;
