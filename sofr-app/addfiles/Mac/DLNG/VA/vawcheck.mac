/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vawcheck.mac
                                va-вексель
                                 w-операция мены векселей СВ<->УВ

  Programmer  : Чижик К.Н.
  Операция    : Мена векселей СВ<->УВ
  Шаг         : 
  Comment     : Проверки в макросе первичного документа.
└───────────────────────────────────────────────────────────────────────────*/
IMPORT PaymInter, globals, valib, va4each, vaxcheck, vamisc;
       
PRIVATE VAR Currency, VeksNum;

/*
   Для события "начало операции":
   1. Проверить заполнение обязательных атрибутов сделки.
   2. Если в сделке указан способ расчетов "платежи", то 
      счет плательщика платежа по контрактиву должен быть 
      указан не в нашем банке.
   3. Если в сделке указан способ расчетов "безакцептное списание", 
      то счет плательщика платежа по контрактиву должен быть указан 
      в нашем банке.
   4. Если существует платеж по оплате разницы, то проверить, 
      что плановая дата платежа задана и она не меньше дат 
      поставки векселей по требованиям и обязательствам.
   5. Цена всех передаваемых векселей должна быть выражена в одной валюте.
   6. Цена всех принимаемых векселей должна быть выражена в одной валюте.
   7. Дата поставки принимаемых и передаваемых векселей совпадает.
   8. Клиент в сделке не указан. В противном случае сообщение об ошибке
      "Операция не поддерживает сделки для клиента".
   9. По сделке нет ни одного векселя с ролью продажа и сброшенным признаком 
      "особая связь". Иначе - ошибка: "Операция не поддерживает мену выкупленных
      векселей".
  10. Векселедержатели у новых векселей должны соответствовать контрагенту по сделке
*/

PRIVATE MACRO CheckLink(bnr, leg, tick, numOrd, lnk, IsPartycular:@bool)

   if(lnk.rec.IsPartycular != "X")
      IsPartycular = false;
      return 1;
   end;

   return 0;
END;

PRIVATE MACRO ПроверитьВекселедержателя(bnr, leg, tick, numOrd, lnk)

    if(lnk.rec.IsPartycular == "X")
      if (bnr.rec.Holder !=tick.PartyID)
           msgbox(string("Векселедержатель ",
                  "векселя номер ", trim(bnr.rec.BCNumber), " серия ", bnr.rec.BCSeries, " не соответствует контрагенту по договору"));        
           return 1;
      end;
    end;  

    return 0;
    
END; 

/* Проверки для мены СВ<->УВ
*/
MACRO VA_CheckXWDeal_StartOpr( УВДоговор )
var
   OldDate = date(0,0,0),
   NewDate = date(0,0,0),
   IsPartycular = true;


   /* 1-7 */
   if(VA_CheckBarterDeal_StartOpr(УВДоговор))
      return 1;
   end;

   /* 8 */
   if(VA_IsClient(УВДоговор))
      /* клиент указан */
      MsgBox("Операция не поддерживает сделки для клиента.");
      return 1;
   end;

   /* 9 */
   
   VA_ForEachBanner(УВДоговор, @CheckLink, VSORDLNK_K_SALE, @IsPartycular, null, null);
   if(IsPartycular == false)
      MsgBox("Операция не поддерживает мену выкупленных векселей.");
      return 1;
   end;

   /* 10 */

   if (VA_ForEachBanner(УВДоговор, @ПроверитьВекселедержателя, VSORDLNK_K_SALE, null, "B"))
      return 1;
   end; 

   return 0;
END;
