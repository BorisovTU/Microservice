/*
$Name:         vadealfinres.mac
$Module:       ìÁ‚•≠≠Î• ¢•™·•´Ô
$Description:  é‚Á•‚ "î®≠†≠·Æ¢Î• ‡•ß„´Ï‚†‚Î ·§•´Æ™"
*/
import DealsInter, VAInter, dlmisc, vamisc, "vsbnrfd.mac", "vadealfinres_form.mac", "or_rep_h.mac", "dlerr_log.mac";


PRIVATE VAR MsgNotData = "###################################################################\n\n";

PRIVATE VAR ReportHeader =
"\në¢•§•≠®Ô Æ ‰®≠†≠·Æ¢ÎÂ ‡•ß„´Ï‚†‚†Â ·§•´Æ™ · „Á‚•≠≠Î¨® ¢•™·•´Ô¨®  ® §•ØÆß®‚≠Î¨® ·•‡‚®‰®™†‚†¨® ß† #### £Æ§\n"+
"á† Ø•‡®Æ§: · ########## ØÆ ##########";

private var TableHeader  = 
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
"≥ î†™‚. §†‚† ≥   ë•‡®Ô, ¸   ≥ Ç•™·•´•§†‚•´Ï ≥   çÆ¨®≠†´  ≥ Ç†´Ó‚† ≥    Ñ†‚†     ≥    Ñ†‚†     ≥   ñ•≠†    ≥Ç†´Ó‚†≥   ñ•≠†    ≥  ¸ ·§•´™®/  ≥   Ç®§    ≥    Ñ†‚†     ≥   ñ•≠†    ≥Ç†´Ó‚†≥   ñ•≠†    ≥   äÆ¨®··®Ô   ≥   äÆ¨®··®Ô   ≥ëØ‡†¢•§´®¢†Ô ≥ëØ‡†¢•§´®¢†Ô ≥   ÑÆÂÆ§ Æ‚   ≥\n"+
"≥  Ø‡Æ§†¶®   ≥   ¢•™·•´Ô    ≥   (Ì¨®‚•≠‚)   ≥            ≥≠Æ¨®≠†´†≥ ·Æ·‚†¢´•≠®Ô ≥  ØÆ£†Ë•≠®Ô  ≥  Ø‡Æ§†¶®  ≥ Ê•≠Î ≥  Ø‡Æ§†¶®  ≥  ÆØ•‡†Ê®®   ≥ ÆØ•‡†Ê®® ≥   ØÆ™„Ø™®   ≥  ØÆ™„Ø™®  ≥ Ê•≠Î ≥  ØÆ™„Ø™®  ≥ Ø‡® ØÆ™„Ø™•, ≥ Ø‡® Ø‡Æ§†¶•, ≥·‚Æ®¨Æ·‚Ï èîà≥·‚Æ®¨Æ·‚Ï èîà≥  ‡•†´®ß†Ê®®  ≥\n"+
"≥            ≥(·•‡‚®‰®™†‚†) ≥               ≥            ≥        ≥             ≥             ≥           ≥      ≥   ¢ ‡„°.  ≥  ØÆ™„Ø™®    ≥ ØÆ™„Ø™®  ≥             ≥           ≥      ≥   ¢ ‡„°.  ≥   ¢ ‡„°´ÔÂ   ≥   ¢ ‡„°´ÔÂ   ≥Ø‡® ØÆ™„Ø™•, ≥Ø‡® Ø‡Æ§†¶•, ≥   ¢ ‡„°´ÔÂ   ≥\n"+         
"≥            ≥              ≥               ≥            ≥        ≥             ≥             ≥           ≥      ≥           ≥             ≥          ≥             ≥           ≥      ≥           ≥              ≥              ≥     ‡„°.    ≥     ‡„°.    ≥              ≥\n"+
"√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n"+
"≥     1      ≥      2       ≥       3       ≥     4      ≥    5   ≥      6      ≥      7      ≥     8     ≥   9  ≥     10    ≥      11     ≥    12    ≥      13     ≥    14     ≥  15  ≥    16     ≥      17      ≥      18      ≥      19     ≥      20     ≥      21      ≥\n"+
"√ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

PRIVATE CLASS RepItogData()
  var m_SaleCostRUR;
  var m_BuyCostRUR;
  var m_SaleComRUR;
  var m_BuyComRUR;
  var m_FinResRUR;
  var m_FairValueBuy; 
  var m_FairValueSale;

  var m_ObjectValue;

  macro add(SaleCostRUR, BuyCostRUR, SaleComRUR, BuyComRUR, FinResRUR, FairValueBuy, FairValueSale)
    m_SaleCostRUR = m_SaleCostRUR + SaleCostRUR;
    m_BuyCostRUR  = m_BuyCostRUR + BuyCostRUR; 
    m_SaleComRUR  = m_SaleComRUR + SaleComRUR; 
    m_BuyComRUR   = m_BuyComRUR + BuyComRUR;  
    m_FinResRUR   = m_FinResRUR + FinResRUR;
    m_FairValueBuy  = m_FairValueBuy  + FairValueBuy;
    m_FairValueSale = m_FairValueSale + FairValueSale;
  end;

  macro clear()
    m_SaleCostRUR = $0;
    m_BuyCostRUR  = $0;
    m_SaleComRUR  = $0;
    m_BuyComRUR   = $0;
    m_FinResRUR   = $0;
    m_FairValueBuy  = $0;
    m_FairValueSale = $0;

    m_ObjectValue = "";
  end;

  macro new(ObjectValue)
    clear();
    m_ObjectValue = ObjectValue;
  end;

  macro SaleCostRUR()
    return m_SaleCostRUR;
  end;

  macro BuyCostRUR()
    return m_BuyCostRUR;
  end;

  macro SaleComRUR()
    return m_SaleComRUR;
  end;

  macro BuyComRUR()
    return m_BuyComRUR;
  end;

  macro FinResRUR()
    return m_FinResRUR;
  end;

  macro FairValueBuy()
    return m_FairValueBuy;
  end;

  macro FairValueSale()
    return m_FairValueSale;
  end;

  macro ObjectValue()
    return m_ObjectValue;
  end;

  clear();
END;

PRIVATE MACRO GetDealComissSum(DealID, ConvDate, ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ:@variant)
  var query, Select, DataSet;
  var NewSum = $0;
  var ErrMsg = "";

  ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ = $0;

  query =   " select sfcom.t_FIID_Sum, sfcom.t_Sum, sfcom.t_SumNDS, tick.t_ClientID"
          + "   from doproper_dbt opr, ddl_tick_dbt tick, doprsfcom_dbt sfcom "
          + "  where tick.t_DealID = ? /*1*/"
          + "    and TO_NUMBER(opr.t_DocumentID) = tick.t_DealID"
          + "    and opr.t_DocKind = tick.t_BOfficeKind"
          + "    and sfcom.t_ID_Operation = opr.t_ID_Operation";

  Select = RSDCommand( query );
  Select.AddParam("", RSDBP_IN, DealID );  /*1*/
  Select.Execute();

  DataSet = TRsbDataSet(Select);
  while(DataSet.moveNext())
    NewSum = $0;
    if(DataSet.FIID_Sum == NATCUR)
      NewSum = DataSet.Sum;
      if(DataSet.ClientID > 0)
        NewSum = NewSum + DataSet.SumNDS;
      end;
    else  
      NewSum = VA_Convert(DataSet.Sum, ConvDate, DataSet.FIID_Sum, NATCUR, null, @ErrMsg);
      if(ErrMsg != "")
        msgbox(ErrMsg);
        return 1;
      end;
      if(DataSet.ClientID > 0)
        NewSum = NewSum + VA_Convert(DataSet.SumNDS, ConvDate, DataSet.FIID_Sum, NATCUR, null, @ErrMsg);
        if(ErrMsg != "")
          msgbox(ErrMsg);
          return 1;
        end;
      end;
    end;

    ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ = ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ + NewSum;

  end;

  return 0;
END;

PRIVATE MACRO GetDealSumRUR(DealID, ConvDate, LinkKind, ë„¨¨†ë§•´™®Çê„°´ÔÂ:@variant)
  var query, Select, DataSet;
  var NewSum = $0;
  var ErrMsg = "";

  query =   " select lnk.t_BCCost, lnk.t_BCCFI"
          + "   from dvsordlnk_dbt lnk, ddl_tick_dbt tick "
          + "  where tick.t_DealID = ? /*1*/"
          + "    and lnk.t_ContractID = tick.t_DealID"
          + "    and lnk.t_DocKind = tick.t_BOfficeKind"
          + "    and lnk.t_LinkKind = ? /*2*/";

  Select = RSDCommand( query );
  Select.AddParam("", RSDBP_IN, DealID );    /*1*/
  Select.AddParam("", RSDBP_IN, LinkKind );  /*2*/
  Select.Execute();

  DataSet = TRsbDataSet(Select);

  while(DataSet.moveNext())
    NewSum = $0;
    if(DataSet.BCCFI == NATCUR)
      NewSum = DataSet.BCCost;
    else  
      NewSum = VA_Convert(DataSet.BCCost, ConvDate, DataSet.BCCFI, NATCUR, null, @ErrMsg);
      if(ErrMsg != "")
        msgbox(ErrMsg);
        return 1;
      end;
    end;

    ë„¨¨†ë§•´™®Çê„°´ÔÂ = ë„¨¨†ë§•´™®Çê„°´ÔÂ + NewSum;
  end;

  return 0;
END;


PRIVATE CLASS (DL_CReportTemplate) VA_DealFinRes_Report
  var m_Period = 0, m_Year = 0, m_BeginDate = date(0,0,0), m_EndDate = date(0,0,0),
      m_IsGrowth = UNSET_CHAR, m_Department = 0, m_ClientID = -1, m_CurrClientID = -1, m_IsApp = UNSET_CHAR,
      m_NeedDepCert = UNSET_CHAR, m_NeedBill = UNSET_CHAR;
  var m_RS = null;
  var m_CurrSheetName = "";
  var m_PrevBuyDate, m_PrevBuyID, m_PrevBuyCost, m_PrevBuyFI, m_PrevBuyType, m_PrevBuyCode;
  var m_BuyComBnrRUR, m_SaleComBnrRUR;
  var m_FairValueBuy, m_FairValueSale;
  var m_ClientItog = RepItogData(), m_DealItog = RepItogData();


  PRIVATE MACRO PrintMode():INTEGER
    if(m_Form.GetFieldValue( PNFLD_DEALFINRES_PRINTEXCEL ) == SET_CHAR)
      return DL_OUTREPORT_EXCEL;
    end;

    return DL_OUTREPORT_STD;
  END;
  
  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    Dl_CallInsertStat(PrintMode());
    CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
    SaveTotalBook();
  END;

  PRIVATE MACRO Apostr()
    if(m_IsApp == SET_CHAR)
      return ":a";
    else
      return "";
    end;
  END;

  PRIVATE MACRO PrintHeader()
    PrintFormatString( ReportHeader,
                       "N1_H0_1", m_Year,      // £Æ§
                       "N1_H0_2", m_BeginDate, // §†‚† ≠†Á†´† Ø•‡®Æ§†
                       "N1_H0_3", m_EndDate    // §†‚† Æ™Æ≠Á†≠®Ô Ø•‡®Æ§†
                     );

    CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_RepHeader", 0, m_CurrSheetName, true );
  END;

  PRIVATE MACRO PrintClientLine()

    merge("N1_F1", "N1_F21");
    PrintTableLine( "N1_F1:l",  "ä´®•≠‚  "+èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(m_CurrClientID, PTCK_CONTR)+"  "+m_RS.CLientName, null);
  END;

  PRIVATE MACRO PrintDealLine()
    merge("N1_F1", "N1_F21");
    PrintTableLine( "N1_F1:l",  "éØ•‡†Ê®Ô  "+m_RS.OprKindName+"  "+m_RS.DealCode, null);
  END;

  PRIVATE MACRO PrintMainTableLine()
 
    
    PrintTableLine( "N1_F1",             this.ValueDate(),          null,
                    "N1_F2",             this.BCSeriesAndNumber(),  null,
                    "N1_F3",             this.IssuerName(),         null,
                    "N1_F4"+Apostr(),    this.BnrNom(),             null,
                    "N1_F5",             this.BnrNomFICode(),       null,
                    "N1_F6",             this.StartDate(),          null,
                    "N1_F7",             this.PlanRepDate(),        null,
                    "N1_F8"+Apostr(),    this.SaleBCCost(),         null,
                    "N1_F9",             this.SaleBCCostFICode(),   null,
                    "N1_F10"+Apostr(),   this.SaleBCCostRUR(),      null,
                    "N1_F11",            this.PrevBuyCode(),        null,
                    "N1_F12",            this.PrevBuyType(),        null,
                    "N1_F13",            this.PrevBuyDate(),        null,
                    "N1_F14"+Apostr(),   this.PrevBuyCost(),        null,
                    "N1_F15",            this.PrevBuyCostFICode(),  null,
                    "N1_F16"+Apostr(),   this.PrevBuyCostRUR(),     null,
                    "N1_F17"+Apostr(),   this.PrevBuyComBnrRUR(),   null,
                    "N1_F18"+Apostr(),   this.SaleComBnrRUR(),      null,
                    "N1_F19"+Apostr(),   this.FairValueBuy(),       null,
                    "N1_F20"+Apostr(),   this.FairValueSale(),      null,
                    "N1_F21"+Apostr(),   this.FinRes(),             null
                  );

    m_ClientItog.add(this.SaleBCCostRUR(), this.PrevBuyCostRUR(), this.SaleComBnrRUR(), this.PrevBuyComBnrRUR(), this.FinRes(), this.FairValueBuy(), this.FairValueSale());
    m_DealItog.add(this.SaleBCCostRUR(), this.PrevBuyCostRUR(), this.SaleComBnrRUR(), this.PrevBuyComBnrRUR(), this.FinRes(), this.FairValueBuy(), this.FairValueSale());
  END;

  PRIVATE MACRO PrintClientItogLine()
    SetCurrentLineFont( 8, true, false );
    
    merge("N1_F1", "N1_F9"); 
    merge("N1_F11", "N1_F15");
                                                                         
    PrintTableLine( "N1_F1",    "à‚Æ£Æ ØÆ ™´®•≠‚„  "+èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(m_ClientItog.ObjectValue(), PTCK_CONTR), null,
                    "N1_F10"+Apostr(),   m_ClientItog.SaleCostRUR(), null,
                    "N1_F16"+Apostr(),   m_ClientItog.BuyCostRUR(),  null,
                    "N1_F17"+Apostr(),   m_ClientItog.BuyComRUR(),   null,
                    "N1_F18"+Apostr(),   m_ClientItog.SaleComRUR(),  null,
                    "N1_F19"+Apostr(),   m_ClientItog.FairValueBuy(),  null,
                    "N1_F20"+Apostr(),   m_ClientItog.FairValueSale(),  null,
                    "N1_F21"+Apostr(),   m_ClientItog.FinResRUR(),   null
                  ); 
  END;

  PRIVATE MACRO PrintDealItogLine()
    SetCurrentLineFont( 8, true, false );

    merge("N1_F1", "N1_F9"); 
    merge("N1_F11", "N1_F15");

    PrintTableLine( "N1_F1",    "à‚Æ£Æ ØÆ ÆØ•‡†Ê®®  "+m_DealItog.ObjectValue(), null,
                    "N1_F10"+Apostr(),   m_DealItog.SaleCostRUR(), null,
                    "N1_F16"+Apostr(),   m_DealItog.BuyCostRUR(),  null,
                    "N1_F17"+Apostr(),   m_DealItog.BuyComRUR(),   null,
                    "N1_F18"+Apostr(),   m_DealItog.SaleComRUR(),  null,
                    "N1_F19"+Apostr(),   m_DealItog.FairValueBuy(),  null,
                    "N1_F20"+Apostr(),   m_DealItog.FairValueSale(),  null,
                    "N1_F21"+Apostr(),   m_DealItog.FinResRUR(),   null
                  );

  END;

  MACRO ValueDate():DATE
    return date(m_RS.ValueDate);
  END;

  MACRO BCSeriesAndNumber():STRING
    return (m_RS.BCSeries+" ¸"+m_RS.BCNumber);
  END;

  MACRO IssuerName():STRING
    return m_RS.IssuerName;
  END;

  MACRO BnrNom():MONEY
    return money(m_RS.Principal);
  END;

  MACRO BnrNomFICode():STRING
    var PFI_Ccy = VA_GetFI_ISO_Code(m_RS.PFI);
    return PFI_Ccy;
  END;

  MACRO StartDate():DATE
    return date(m_RS.StartDate);
  END;

  MACRO PlanRepDate():DATE
    var Z = DaysInYearByBasis(m_RS.Basis, this.StartDate(), true);
    var PlanRepDate = this.StartDate() + Z;
    
    if(m_RS.AvoirKind == AVOIRISSKIND_DEPOSIT_CERTIFICATE)
      PlanRepDate = m_RS.Maturity;
    else
      if((m_RS.BCTermFormula == VS_TERMF_FIXEDDAY) OR (m_RS.BCTermFormula == VS_TERMF_INATIME))
        PlanRepDate = m_RS.Maturity;
      elif((m_RS.BCTermFormula == VS_TERMF_DURING) and (date(m_RS.BCPresentationDate) > date(0,0,0)))
        PlanRepDate = date(m_RS.BCPresentationDate) + m_RS.Diff;
      elif(m_RS.BCTermFormula == VS_TERMF_ATSIGHT) //ØÆ Ø‡•§ÍÔ¢´•≠®®
        if(m_RS.Expiry >= this.StartDate()) //≠Æ ≠• ØÆß§≠••
          if(m_RS.Expiry < PlanRepDate)
            PlanRepDate = m_RS.Expiry;
          end;
        elif((m_RS.Expiry < this.StartDate()) and (m_RS.Maturity >= this.StartDate())) //≠Æ ≠• ‡†≠••
          PlanRepDate = m_RS.Maturity;
        end;
      end;
    end;

    return PlanRepDate;
  END; 

  MACRO SaleBCCost():MONEY
    return money(m_RS.SaleBCCost);
  END;

  MACRO SaleBCCostFICode():STRING
    var SaleBCCOST_Ccy = VA_GetFI_ISO_Code(m_RS.SaleBCCFI);
    return SaleBCCOST_Ccy;
  END;

  MACRO SaleBCCostRUR():MONEY
    if(m_RS.SaleBCCFI != NATCUR)
      return VA_Convert(m_RS.SaleBCCost, this.ValueDate(), m_RS.SaleBCCFI, NATCUR);
    else
      return m_RS.SaleBCCost;
    end;
  END;

  MACRO PrevBuyDate():DATE
    return date(this.m_PrevBuyDate);
  END;

  MACRO PrevBuyType():STRING
    var OprType = "";
    var opr = TBFile("oprkoper.dbt");

    opr.rec.Kind_Operation = m_PrevBuyType;
    if(opr.GetEQ())
      OprType = opr.rec.Name;
    end;

    return OprType;
  END;

  MACRO PrevBuyCode():STRING
    return this.m_PrevBuyCode;
  END;

  MACRO PrevBuyCost():MONEY
    return money(m_PrevBuyCost);
  END;

  MACRO PrevBuyCostFICode():STRING
    var BuyCost_Ccy = VA_GetFI_ISO_Code(m_PrevBuyFI);
    return BuyCost_Ccy;
  END;

  MACRO PrevBuyCostRUR():MONEY
    if(m_PrevBuyFI != NATCUR)
      return VA_Convert(m_PrevBuyCost, this.ValueDate(), m_PrevBuyFI, NATCUR);
    else
      return m_PrevBuyCost;
    end;
  END;

  MACRO PrevBuyComBnrRUR():MONEY
    var tick = TBFile("dl_tick.dbt");
    var ComSum = $0;
    var ë„¨¨†ë§•´™®Çê„°´ÔÂ = $0;
    var ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ = $0;

    if(m_BuyComBnrRUR == NULL)
      m_BuyComBnrRUR = $0;
      tick.rec.DealID = m_PrevBuyID;
      if(tick.GetEQ())
        if(not GetDealSumRUR(tick.rec.DealID, this.ValueDate(), VSORDLNK_K_BUY, @ë„¨¨†ë§•´™®Çê„°´ÔÂ))
          if(ë„¨¨†ë§•´™®Çê„°´ÔÂ > 0)
            if(not GetDealComissSum(tick.rec.DealID, this.ValueDate(), @ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ))
              m_BuyComBnrRUR = ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ * this.PrevBuyCostRUR()/ë„¨¨†ë§•´™®Çê„°´ÔÂ; 
            end;
          end;
        end;
      end;
    end;

    return m_BuyComBnrRUR;
  END;

  MACRO SaleComBnrRUR():MONEY
    var tick = TBFile("dl_tick.dbt");
    var ComSum = $0;
    var ë„¨¨†ë§•´™®Çê„°´ÔÂ = $0;
    var ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ = $0;
    
    if(m_SaleComBnrRUR == NULL)
      m_SaleComBnrRUR = $0;
      tick.rec.DealID = m_RS.DealID;
      if(tick.GetEQ())
        if(not GetDealSumRUR(tick.rec.DealID, this.ValueDate(), VSORDLNK_K_SALE, @ë„¨¨†ë§•´™®Çê„°´ÔÂ))
          if(ë„¨¨†ë§•´™®Çê„°´ÔÂ > 0)
            if(not GetDealComissSum(tick.rec.DealID, this.ValueDate(), @ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ))
              m_SaleComBnrRUR = ë„¨¨†äÆ¨®··®©Çê„°´ÔÂ * this.PrevBuyCostRUR()/ë„¨¨†ë§•´™®Çê„°´ÔÂ; 
            end;
          end;
        end;
      end;
    end;

    return m_SaleComBnrRUR;
  END;

  MACRO FairValueBuy():MONEY
    if(m_FairValueBuy == null)
      m_FairValueBuy = ìÇ_èÆ´„Á®‚ÏìÁ‚•≠≠„Óëë(m_RS.BCID, m_PrevBuyID, m_EndDate);
    end;

    return m_FairValueBuy;
  END;

  MACRO FairValueSale():MONEY
    if(m_FairValueSale == null)
      m_FairValueSale = ìÇ_èÆ´„Á®‚ÏìÁ‚•≠≠„Óëë(m_RS.BCID, m_RS.DealID, m_EndDate);
    end;

    return m_FairValueSale;
  END;

  MACRO FinRes():MONEY
    return this.SaleBCCostRUR() + this.FairValueSale() - (this.PrevBuyCostRUR() + this.FairValueBuy()) - this.PrevBuyComBnrRUR() - this.SaleComBnrRUR();
  END;

  MACRO ClearData()
    m_PrevBuyDate = date(0,0,0);
    m_PrevBuyID   = 0;          
    m_PrevBuyCost = $0;         
    m_PrevBuyFI   = -1;         
    m_PrevBuyType = 0;          
    m_PrevBuyCode = "";         
    m_BuyComBnrRUR = null;      
    m_SaleComBnrRUR = null;
    m_FairValueBuy = null;
    m_FairValueSale = null;     
  END;

  //ÇÎÁ®·´®‚Ï ™´®•≠‚† ØÆ ·§•´™•
  PRIVATE MACRO GetDealClientID()
    var ClientID = m_RS.ClientID;

    if((m_RS.IsPartyClient == SET_CHAR) AND (m_RS.LinkKind == VSORDLNK_K_BUY)) //Ö·´® Ì‚Æ ØÆ™„Ø™† „ ™´®•≠‚†-™Æ≠‚‡†£•≠‚†, ‚Æ ‰†™‚®Á•·™® Ì‚Æ Ø‡Æ§†¶† ™´®•≠‚Æ¨-™Æ≠‚‡†£•≠‚Æ¨
      ClientID = m_RS.PartyID;
    end;

    if(ClientID == -1)
      ClientID = {OurBank};
    end;

    return ClientID;
  END;

  PRIVATE MACRO Create()
    var query;
    var PrevDepart = 0, PrevClientID = -1, PrevDealID = 0;
    var stat = 0;
    var cnt, i;
    
    m_Period       = m_Form.GetFieldValue( PNFLD_DEALFINRES_PERIOD );
    m_Year = m_Form.GetFieldValue( PNFLD_DEALFINRES_YEAR );
    Period_GetInterval( m_Period, m_Year, @m_BeginDate, @m_EndDate );

    m_IsGrowth = m_Form.GetFieldValue( PNFLD_DEALFINRES_GROWTH );
    if(m_IsGrowth == SET_CHAR)
      m_BeginDate = date(1, 1, m_Year);
    end;

    m_Department  = m_Form.GetFieldValue( PNFLD_DEALFINRES_DEPARTCODE );
    m_ClientID    = m_Form.GetFieldValue( PNFLD_DEALFINRES_CLIENTCODE );
    m_IsApp       = m_Form.GetFieldValue( PNFLD_DEALFINRES_APOSTR );
    m_NeedDepCert = m_Form.GetFieldValue( PNFLD_DEALFINRES_DEPCERT );
    m_NeedBill    = m_Form.GetFieldValue( PNFLD_DEALFINRES_BILL );

    SetActiveSheet( "é‚Á•‚" );


    query =   "with q as (select distinct opr.t_DocKind, opr.t_DocumentID "
            + "             from dvsbnrbck_dbt bck, doprdocs_dbt oprdocs, doproper_dbt opr "
            + "            where bck.t_ABCStatus = 'X' "
            + "              and bck.t_OldABCStatus = " + VABANNER_STATUS_ACCOUNT
            + "              and bck.t_ChangeDate BETWEEN "+GetSQLDate(m_BeginDate)+" and "+GetSQLDate(m_EndDate)
            + "              and oprdocs.t_DocKind = " + DL_VSBNRBCK //®ß¨•≠•≠®• „Á‚•≠≠Æ£Æ ¢•™·•´Ô
            + "              and oprdocs.t_DocumentID = LTRIM(TO_CHAR (bck.t_ID, '0000000000')) "
            + "              and opr.t_ID_Operation = oprdocs.t_ID_Operation "
            + "          )"
              " select tick.t_Department, tick.t_DealID, tick.t_ClientID, dp.t_Name as DepartCode, "
            + "        (case when tick.t_ClientID > 0 then (select pt.t_ShortName from dparty_dbt pt where pt.t_PartyID = tick.t_ClientID)"
            + "              else CHR(1) end ) as ClientName, "
            + "        oprk.t_Name as OprKindName, tick.t_DealCode, pm.t_ValueDate, issuer.t_ShortName as IssuerName, "
            + "        bnr.t_BCID, bnr.t_BCSeries, trim(bnr.t_BCNumber) as BCNumber, "
            + "        leg.t_Principal, leg.t_PFI, leg.t_PFI, leg.t_Start as StartDate, "
            + "        lnk.t_BCCost as SaleBCCost, lnk.t_BCCFI as SaleBCCFI, "
            + "        tick.t_AvoirKind, " //‚.™. ¢ ·§•´™• ¨Æ¶≠Æ ‡•†´®ßÆ¢†‚Ï ‚Æ´Ï™Æ Ê/° Æ§≠Æ£Æ ¢®§†, ‚Æ ØÆß¢Æ´®¨ ·•°• ß†¢Ôß†‚Ï·Ô ≠† Ì‚Æ ØÆ´•
            + "        leg.t_Expiry, leg.t_Maturity, leg.t_Basis, leg.t_Diff, "
            + "        bnr.t_BCTermFormula, bnr.t_BCPresentationDate, "
            + "        lnk.t_LinkKind, tick.t_IsPartyClient, tick.t_PartyID "

            + "   from dvsordlnk_dbt lnk, ddl_tick_dbt tick, dvsbanner_dbt bnr, ddp_dep_dbt dp, "
            + "        doprkoper_dbt oprk, dpmpaym_dbt pm, dparty_dbt issuer, ddl_leg_dbt leg, q "
            + "  where tick.t_BOfficeKind = q.t_DocKind "
            + "    and LPAD( tick.t_DealID, 34,'0' ) = q.t_DocumentID "
            + "    and lnk.t_ContractID = tick.t_DealID "
            + "    and lnk.t_DocKind in ("+DL_VEKSELACCOUNTED+", "+DL_VAENWR+")"
            + "    and bnr.t_BCID = lnk.t_BCID "
            + "    and bnr.t_Issuer not in (select dpp.t_PartyID from ddp_dep_dbt dpp)"
            + "    and leg.t_DealID = bnr.t_BCID "
            + "    and leg.t_LegKind = " + LEG_KIND_VSBANNER
            + "    and leg.t_LegID = 0"
            + "    and pm.t_DocKind = tick.t_BOfficeKind "
            + "    and pm.t_DocumentID = tick.t_DealID "
            + "    and pm.t_Purpose = " + BAi
            + "    and pm.t_FIID = bnr.t_FIID "
            + "    and pm.t_ValueDate BETWEEN "+GetSQLDate(m_BeginDate)+" and "+GetSQLDate(m_EndDate)
            + "    and pm.t_PaymStatus in ("+PM_FINISHED+","+PM_READY_TO_SEND+")"
            + "    and dp.t_Code = tick.t_Department"
            + "    and oprk.t_Kind_Operation = tick.t_DealType"
            + "    and issuer.t_PartyID = bnr.t_Issuer";

     if(m_Department > 0)
       query = query + " and tick.t_Department = " + m_Department;
     end;

     if(m_ClientID > 0)
       query = query + " and tick.t_ClientID = " + m_ClientID;
     end;

     if((m_NeedDepCert == SET_CHAR) and (m_NeedBill == UNSET_CHAR))
       query = query + " and tick.t_AvoirKind = " + AVOIRISSKIND_DEPOSIT_CERTIFICATE;
     elif((m_NeedDepCert == UNSET_CHAR) and (m_NeedBill == SET_CHAR))
       query = query + " and tick.t_AvoirKind = " + AVOIRISSKIND_BILL;
     end;

     query = query + " order by tick.t_Department asc, tick.t_ClientID desc, tick.t_DealID desc";

     
     InitProgress( SQL_GetNRecs(query), "à§•‚ ‰Æ‡¨®‡Æ¢†≠®• Æ‚Á•‚†", "ë¢•§•≠®Ô Æ ‰®≠†≠·Æ¢ÎÂ ‡•ß„´Ï‚†‚†Â ·§•´Æ™");
     m_RS = TRsbDataSet(query);
     stat = m_RS.moveNext();
     if(stat)
       i = 0;
       while(stat)
         this.ClearData(); 

         if(PrevDepart != m_RS.Department)
           //®¨Ô ≠Æ¢Æ© ¢™´†§™®
           m_CurrSheetName = m_RS.DepartCode;
           UseNewSheetInTotalBook();
           //Ø•Á†‚Ï ß†£Æ´Æ¢™†
           PrintHeader();
           //‡•£®·‚‡®‡„•¨ ‚†°´®Ê„
           RegisterTable( "N1_MainTable", TableHeader,
                           "N1_F1",
                           "N1_F2",
                           "N1_F3",
                           "N1_F4",
                           "N1_F5",
                           "N1_F6",
                           "N1_F7",
                           "N1_F8",
                           "N1_F9",
                           "N1_F10",
                           "N1_F11",
                           "N1_F12",
                           "N1_F13",
                           "N1_F14",
                           "N1_F15",
                           "N1_F16",
                           "N1_F17",
                           "N1_F18",
                           "N1_F19",
                           "N1_F20",
                           "N1_F21" 
                         );
         end;

         m_CurrClientID = GetDealClientID();

         if((PrevClientID != m_CurrClientID) and (m_CurrClientID > 0))
           //®ß¨•≠®´·Ô ™´®•≠‚ - ≠†Ø•Á†‚†•¨ ·ÆÆ‚¢•‚·‚¢„ÓÈ„Ó ·‚‡Æ™„
           PrintClientLine();
           m_ClientItog.new(m_CurrClientID);
         end;

         if(PrevDealID != m_RS.DealID)
           PrintDealLine();
           m_DealItog.new(m_RS.DealCode);
         end;

         
         if(not VA_GetBalanceDate(m_RS.BCID, this.ValueDate(), @m_PrevBuyDate, @m_PrevBuyID, @m_PrevBuyCost, @m_PrevBuyFI, @m_PrevBuyType, @m_PrevBuyCode, 0, m_CurrClientID, m_RS.DealID))
           msgbox("ç• ≠†©§•≠† ·§•´™† ØÆ™„Ø™® Ê/°|·•‡®Ô "+this.BCSeriesAndNumber());
         end;

         //Æ·≠Æ¢≠†Ô ·‚‡Æ™†
         PrintMainTableLine();

         PrevDepart   = m_RS.Department;
         PrevClientID = m_CurrClientID; 
         PrevDealID   = m_RS.DealID;

         stat = m_RS.moveNext();

         if((not stat) or (PrevDealID != m_RS.DealID))
           PrintDealItogLine();
         end;

         if(((not stat) or (PrevClientID != GetDealClientID())) and (PrevClientID > 0))
           PrintClientItogLine();
         end;

         if((not stat) or (PrevDepart != m_RS.Department))
           EndTable();
           CopyAllSheetInTotalBook( m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true );

           AddStandardFooter( "N1_" );
           CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_Footer", 1, m_CurrSheetName, true );
         end;

         UseProgress(i = i + 1);

       end;
     else
       PrintFormatString( MsgNotData, "N1_MsgNotData", "ç•‚ §†≠≠ÎÂ, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†", null);
       CopyAllSheetInTotalBook( NULL, false, "N1_MsgNotData", 0 );
     end;

     RemProgress();

  END;

  initDL_CReportTemplate( VA_DealFinRes_Panel(), "Report_DealFinRes.xls" );
END;

VA_DealFinRes_Report().Run();
Exit(1);