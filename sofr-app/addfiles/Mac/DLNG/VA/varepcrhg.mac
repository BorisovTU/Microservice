/*
$Name:        varepcrhg.mac
$Module:      Учтенные векселя
$Description: Протокол операции Амортизация корректировок хеджирования.
*/

IMPORT RsbDataSet, FIInter, CTInter, VAInter, vsbnrfd, vaacc, vaconv, vaprdec, vamisc, cb_sql, vaprord, dlquery;

private macro ДополнениеДатыНулем(_Дата)
var day, month, year; 
    DateSplit(_Дата, day, month, year);
    return string(day:2:o, ".", month:2:o, ".", year:4);
end;

private macro PrintReportTable(ID)

  var query, DataSet, Select, N = 0;
  var ВидЦБ = "";
  var q1 = "", DataSum, Select1;
  var q, carry;
  var count = 0;
  var stat = 0;
  
  query =   " SELECT bnr.t_BCSeries, bnr.t_BCNumber, bnr.t_BCID, doc.t_AvoirKind, bnr.t_IssuerName, leg.t_Principal, leg.t_PFI, "
          + " doc.t_ExecutionDate, doc.t_DocKind, doc.t_ID, "
          + " bnr.t_AgentName as AgentName" 
          + " FROM dvsbanner_dbt bnr, dvssrvdoc_dbt doc, ddl_leg_dbt leg "
          + " WHERE doc.t_ID = ? /*1*/ " 
          + "   AND bnr.t_BCID in (select opr.t_DocumentID from doproper_dbt opr, doprstep_dbt step where step.t_ServDocKind = doc.t_DocKind and step.t_ServDocID = doc.t_ID and opr.t_ID_Operation = step.t_ID_Operation ) "
          + "   AND leg.t_LegKind = ? /*2*/ " 
          + "   AND leg.t_DealID = bnr.t_BCID AND leg.T_LEGID = 0 ";


  Select = DL_RSDCommand(query);
  Select.AddParam(ID); /*1*/
  Select.AddParam(LEG_KIND_VSBANNER); /*2*/
          
  DataSet = Select.Execute();
  stat = DataSet.moveNext();

  
  while(stat)
      
    N = N+1;
    
    

    //проводки по операции
    Select1 = DL_RSDCommand("   select * from dacctrn_dbt arh, doprdocs_dbt doc, doproper_dbt opr "
                             + " where doc.t_ServDocKind = ? /*1*/ "
                             + "   and doc.t_ServDocID = ? /*2*/ "
                             + "   and doc.t_DocKind = ? /*3*/ "
                             + "   and doc.t_ID_Operation = opr.t_ID_Operation "
                             + "   and opr.t_DocKind = ? /*4*/ "
                             + "   and opr.t_DocumentID = ? /*5*/ "
                             + "   and arh.t_AccTrnID = doc.t_AccTrnID "
                             + "   and arh.t_State = 1 " /*фактическая проводка*/
                             + " order by arh.t_AccTrnID desc");


    Select1.AddParam(DataSet.DocKind);
    Select1.AddParam(DataSet.ID);
    Select1.AddParam(DLDOC_CARRY);
    Select1.AddParam(DL_VSBANNER);
    Select1.AddParam(DataSet.BCID);
    count = Select1.GetCount();

    carry = Select1.Execute();


    [~MultipleRow];
    println(1);
    println(count-1);
    while(carry.moveNext())
      if (DataSet.AvoirKind == AVOIRISSKIND_BILL)
       ВидЦБ = "Вексель" 
      end;

      println("~M1_" + N);
      println(string(ВидЦБ+", "+DataSet.BCSeries+" №"+DataSet.BCNumber));

      println("~M2_" + N);
      println(DataSet.IssuerName);

      println("~M3_" + N);
      println(DataSet.AgentName);

      println("~M4_" + N);
      println(carry.Sum_NatCur);

      println("~M5_" + N);
      println(VA_GetFI_ISO_Code(DataSet.PFI));

      println("~M9_" + N);
      println(carry.Account_Payer);

      println("~M10_" + N);
      println(carry.Account_Receiver);

      println("~M11_" + N);
      println(carry.Ground);
    end;

    

    stat = DataSet.MoveNext();

  end;

end;

/****************************************************************************/
/* Функция печати                                                           */
/****************************************************************************/
private macro PrintDec(ID, DocKind, ПечататьПротокол)
   var TempFile;
   var vssrvdoc, Дата;

   InitDecType(DecType);
   InitDecPurp(DecPurp);
   InitOpType(OpType);

   vssrvdoc = Tbfile("vssrvdoc", "R", 0);
   vssrvdoc.rec.ID = ID;
   vssrvdoc.GetEQ();
   Дата = vssrvdoc.rec.ValueDate; /* Дата выполнения операции */
     
   if( ПечататьПротокол )
      println("PRT_CorHedge.dot");
      println(GenFileName());

      println("~M0");
      println(ДополнениеДатыНулем(Дата));
      
      PrintReportTable(ID);
      
      TempFile = SetOutPut(GetTxtFileName("tmpout"), false);
      DLWREPS_PrintReportFromTagFile (TempFile);
      
      SetOutput(null, false);
   end;
   /*печать распоряжения в бухгалтерию по завершении операции*/
   /*PrintPDD(ID,DecType[13],OpType[14],DecPurp[18],Дата);

   TempFile = SetOutPut(GetTxtFileName("tmpout"), false);
   DLWREPS_PrintReportFromTagFile (TempFile);

   SetOutput(null, false);*/

   return true;
end;


/****************************************************************************/
/* Точка входа                                                                    */
/****************************************************************************/
macro VA_PrintRepCorHedge(ID, DocKind, УчитыватьНастройкуАвтоПечати, ПечататьПротокол)
var flag, stat = 0,
    НастройкаАвтоПечать;
    
    if(УчитыватьНастройкуАвтоПечати == true)

       НастройкаАвтоПечать = "УЧТЕННЫЕ ВЕКСЕЛЯ\\РЕЖИМ РАБОТЫ\\АВТОМАТИЧЕСКАЯ ПЕЧАТЬ";
       GetRegistryValue(НастройкаАвтоПечать, V_BOOL, flag, stat);
       if(stat)
          msgbox("Не задана настройка в реестре банка:|", НастройкаАвтоПечать);
          return;
       end;
    else
       flag = true;
    end;

    if(flag == true)
       PrintDec(ID, DocKind, ПечататьПротокол);
    end; 

end;
/****************************************************************************/
