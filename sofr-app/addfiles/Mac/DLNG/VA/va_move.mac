/*
$Name:         va_move.mac
$Module:       Учтенные векселя
$Description:  Проводка переноса по срокам. П.перенос по срокам. Покупка, продажа, мены (3 шт.), РЕПО-пок., РЕПО-прод.
*/

/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : va_move.mac
  Операция    : Покупка, продажа, мены (3 шт.), РЕПО-пок., РЕПО-прод.
  Шаг         : П.перенос по срокам
  Comment     : Проводка переноса по срокам
└───────────────────────────────────────────────────────────────────────────*/
IMPORT BankInter, CurrInter, vacateg, vaacc, dlreport;


MACRO ПереносПоСрокам(category, fd, fiid, role, purpose, MoveDate, ActionDate)
var
   СчетДебет = "", СчетКредит = "", oldAcc, newAcc, sum = $0, stat = 0, СчетКорГлаваГ = "", roleG = 0;


   if(not VA_GetAccount(category, fd, oldAcc, MC_OPENACC_CHECKEXIST, fiid, role, null, ActionDate, MoveDate))
     stat = 1;
   elif(not VA_GetAccount(category, fd, newAcc, MC_OPENACC_CHECKPERIOD, fiid, role, null, ActionDate, MoveDate))
     stat = 1;
   elif(oldAcc != newAcc)
      OprGetAccountRest( 4, fiid, oldAcc, MoveDate, sum );
      if(category == "+Форвард, дрейф")
         СчетДебет = newAcc;
         СчетКредит = oldAcc;
         roleG = FIROLE_CORACC_ACTIVE;
      elif(category == "-Форвард, дрейф")
         СчетДебет = oldAcc;
         СчетКредит = newAcc;
         roleG = FIROLE_CORACC_PASSIVE;
      end;

      if ((КОРРЕСП_ГЛАВА_Г() == true) OR fd.IsSale())
         stat = VA_Bookpass(СчетДебет, 
                            СчетКредит, 
                            Abs( sum ),
                            purpose,
                            0, 0,               /* Платеж */
                            fiid,
                            4,                  /* Глава: срочные операции */
                            null, MoveDate
                           );
      else
         
         fd.SetFIIDForCorAccNum(fiid);
         if(not VA_GetAccount("СчКорреспГлаваГ", fd, СчетКорГлаваГ, MC_OPENACC_CREATE, NATCUR, roleG, null, MoveDate))
            return 1;
         end;
         stat = VA_Bookpass(СчетДебет, 
                            СчетКорГлаваГ, 
                            Abs( sum ),
                            purpose,
                            0, 0,               /* Платеж */
                            fiid,
                            4,                  /* Глава: срочные операции */
                            null, MoveDate, null,
                            2                   // сумма кредита в нац.валюте
                           );
         if (not stat)
             stat = VA_Bookpass(СчетКорГлаваГ, 
                                СчетКредит,
                                Abs( sum ),
                                purpose,
                                0, 0,               /* Платеж */
                                fiid,
                                4,                  /* Глава: срочные операции */
                                null, MoveDate, null,
                                1                   // сумма дебета в нац. вал
                               );
         end;
         
      end;
   end;

   return stat;
END;
