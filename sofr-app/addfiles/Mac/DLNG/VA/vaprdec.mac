/*
$Name:         vaprdec.mac
$Module:       Учтенные векселя
$Description:  Печать распоряжений в УВ
*/
IMPORT RsbDataSet, vadpkind, vaprord, vasale, vamisc, vsbnrfd, dlquery, dlvaprds, vaprdslib;

VAR DecType,OpType,
VsSeq,
DecPurp,
Итоги, Итоги_ЦенаПокупки, Итоги_Номинал, 
Итоги_Дисконт, Итоги_Проценты, 
Итоги_Донач_Дисконта,Итоги_Донач_Процента,
Итоги_Цена_ПокВН, Итоги_Доход,
Итоги_ПереоцСтоимости,
Итоги_ПереоцДисконта,
Итоги_ПереоцПроцентов,
Итоги_ПереоцПремии,
Итоги_ПремияКСписанию,
Итоги_ВалУч,
Итоги_ВалЦен,
Итоги_ВалТреб,
Итоги_ВалОбяз,
Итоги_ПереоцТребования,
Итоги_ПереоцОбязательства,
Итоги_Премия,
ДатаВыполненияШага,статус_шаблона:bool;


CONST 
/* признак печати */
MAN_PRINT = 1,/* мануальная печать */
AUTO_PRINT = 0,/* автоматическая печать */
МенаПринимаемые = 1,
МенаПередаваемые = 0,
Z_DATE = date(0,0,0);


DecType = TArray;
DecPurp = TArray;
OpType = TArray;

VsSeq = TArray;
const fld_count      = 19;
const fld_BCID       =  0;
const fld_BCCost     =  1;
const fld_BCCFI      =  2;
const fld_Issuer     =  3;
const fld_Formula    =  4;
const fld_LegPFI     =  5;
const fld_IssuerName =  6;
const fld_BCNumber   =  7;
const fld_BCSeries   =  8;
const fld_BCTermForm =  9;
const fld_BCPresDate = 10;
const fld_Principal  = 11;
const fld_Start      = 12;
const fld_Maturity   = 13;
const fld_Expiry     = 14;
const fld_Diff       = 15;
const fld_AgentName  = 16;
const fld_AccFI      = 17;
const fld_LinkKind   = 18;

/* контейнер итоговых данных по валюте
  _Sum - Сумма
  _PFI - Валюта */
CLASS ДанныеПоВекселям(_Sum, _PFI)
  var Sum = _Sum;
  var PFI = _PFI;
END;

CLASS ИтогПоВекселям()
  var Данные = TArray;

  PRIVATE MACRO НоваяВалютнаяГруппа(_Sum, _PFI)
    Данные[Данные.size] = ДанныеПоВекселям(_Sum, _PFI);
  END;

  PRIVATE MACRO ДобавитьСуммуВГруппу(i, _Sum)
    Данные[i].Sum = Данные[i].Sum + _Sum;
  END;

  PRIVATE MACRO ПоискПоВалюте(_PFI)
    var i = 0;

    while(i < Данные.size)
      if((Данные[i].PFI == _PFI))
        return i;
      end;

      i = i + 1;
    end;

    return -1;
  END;

  MACRO Итого(_Sum, _PFI)
    var i = ПоискПоВалюте(_PFI);

    if(i == -1)
      НоваяВалютнаяГруппа(_Sum, _PFI);
    else
      ДобавитьСуммуВГруппу(i, _Sum);
    end;
  END;

  MACRO GetSize()
    return Данные.size;
  END;

  MACRO GetData(i, _Sum:@variant, _PFI:@variant) 
    _Sum = 0;
    _PFI = -1;

    if(ValType(Данные[i]) != V_UNDEF)
      _Sum = Данные[i].Sum;
      _PFI = Данные[i].PFI;
    end;
  END;

  MACRO SetDataNull()          
    Данные.size = 0;
  END;

  Данные.size = 0;
END;

/****************************************************************************/
/* Инициализация массива назначений распоряжений                            */
/****************************************************************************/
MACRO InitDecPurp(DecPurp)
DecPurp[0] = "Отразить в бухгалтерском учете заключение наличной сделки";
DecPurp[1] = "Отразить в бухгалтерском учете заключение срочной сделки";
DecPurp[2] = "Отразить в бухгалтерском учете перенос требований (обязательств) по срочной сделке";
DecPurp[3] = "Отразить в бухгалтерском учете начало расчетов по сделке";
DecPurp[4] = "Произвести оплату векселей (депозитных сертификатов)";
DecPurp[5] = "Отразить полученные векселя (депозитных сертификатов) в бухгалтерском учете";
DecPurp[6] = "Отразить в бухгалтерском учете передачу векселей (депозитных сертификатов)";
DecPurp[7] = "Отразить в бухгалтерском учете финансовый результат";
DecPurp[8] = "Отразить в бухгалтерском учете перенос векселей на счета до востребования";
DecPurp[9] = "Отразить в бухгалтерском учете перенос векселей на счета по сроку в связи с предъявлением";
DecPurp[10] = "Отразить в бухгалтерском учете оплату векселей (депозитных сертификатов) и финансовый результат";
DecPurp[11] = "Произвести оплату разницы в стоимости принимаемых и передаваемых векселей";
DecPurp[12] = "Отразить в бухгалтерском учете принятые в залог векселя";
DecPurp[13] = "Отразить в бухгалтерском учете возврат векселей (депозитных сертификатов) из залога";
DecPurp[14] = "Отразить в бухгалтерском учете передачу в залог векселей (депозитных сертификатов)";
DecPurp[15] = "Отразить в бухгалтерском учете передачу векселей (депозитных сертификатов) на баланс филиала";
DecPurp[16] = "Отразить в бухгалтерском учете передачу векселей (депозитных сертификатов) на баланс головного офиса";
DecPurp[17] = "Отразить в бухгалтерском учете списание требований (обязательств) в связи с наступлением даты расчетов";
DecPurp[18] = "Отразить в бухгалтерском учете начисление ПДД";
DecPurp[19] = "Отразить в бухгалтерском учете начисление дисконта";
DecPurp[20] = "Отразить в бухгалтерском учете списание переоценки по НВПИ требований (обязательств) в связи с наступлением даты расчетов";
DecPurp[21] = "Отразить в бухгалтерском учете переоценку по НВПИ";
DecPurp[22] = "Отразить в бухгалтерском учете списание переоценки балансовой стоимости требований (обязательств) в связи с наступлением даты расчетов";
DecPurp[23] = "Отразить в бухгалтерском учете переоценку балансовой стоимости";
END;
/****************************************************************************/
/* Инициализация массива видов распоряжений                                 */
/****************************************************************************/

MACRO InitDecType(DecType)
DecType[0] = "Междепозитарный перевод"; 
DecType[1] = "Прием документарных ц.б.";
DecType[2] = "Списание документарных ц.б.";
DecType[3] = "Зачисление бездокументных ц.б.";
DecType[4] = "Списание бездокументных ц.б.";
DecType[5] = "Передача в залог ц.б.";
DecType[6] = "Возврат из залога ц.б.";
DecType[7] = "Прием в залог";
DecType[8] = "Возврат из залога";
DecType[9] = "Внутридепозитный перевод";
DecType[10] = "Погашение";
DecType[11] = "Распоряжение в бухгалтерию на отражение операций в бухучете";
DecType[12] = "Распоряжение в бухгалтерию на отражение операций зачисления/списания и переноса по срокам";
DecType[13] = "Распоряжение в бухгалтерию на отражение операций начисления ПДД";
DecType[14] = "Распоряжение в бухгалтерию на отражение операций переоценки НВПИ";
DecType[15] = "Распоряжение в бухгалтерию на отражение операций переоценки балансовой стоимости";
END;


/****************************************************************************/
/* Инициализация массива видов операций                                     */
/****************************************************************************/
MACRO InitOpType(OpType)

OpType[0] = "покупка ц/б";
OpType[1] = "продажа ц/б";
OpType[2] = "погашение ц/б";
OpType[3] = "РЕПО/покупка (1 часть)";
OpType[4] = "РЕПО/покупка (2 часть)";
OpType[5] = "РЕПО/продажа (1 часть)";
OpType[6] = "РЕПО/продажа ( 2 часть)";
OpType[7] = "мена векселей";
OpType[8] = "прием ц/б в залог";
OpType[9] = "передача ц/б в залог";
OpType[10] = "перенос векселей на счета до востребования";
OpType[11] = "предъявление векселей";
OpType[12] = "списание ц/б";
OpType[13] = "зачисление ц/б";
OpType[14] = "начисление ПДД";
OpType[15] = "переоценка, связанная с применением НВПИ";
OpType[16] = "переоценка балансовой стоимости";


END;

MACRO VA_RateStr()
var ret,
    parm,
    pType,
    число,
    точность;

    GetParm(0, parm);
    pType = ValType(parm);
    if(pType == V_STRUC)
      число = parm.Price;
      точность = parm.Point;
    elif(pType == V_GENOBJ)
      число = parm.rec.Price;
      точность = parm.rec.Point;
    else
      число = parm;
      GetParm(1, точность);
    end;

    if (ПолучитьСтрокуЗначенияКурса(число, точность, ret) !=0 )
       ret = "";
    end;
    return ret;
END;


/****************************************************************************/
/* Добавление в массив                                                      */
/****************************************************************************/
PRIVATE MACRO AddVsSeq(mas, lnk, frm)
    mas[mas.Size] = lnk.rec.BCID;
    mas[mas.Size] = lnk.rec.BCCost;
    mas[mas.Size] = lnk.rec.BCCFI;
    mas[mas.Size] = lnk.rec.Issuer;
    mas[mas.Size] = frm;
END;

/* Ищет период срочности
*/
PRIVATE MACRO FindPeriod(ID, period)
    period.KeyNum = 0;
    period.rec.ID = ID;
    return period.GetEQ();
END;

private macro КоличествоДнейДоПогашения(CDate:date, bnr_BCTermFormula, bnr_BCPresentationDate:date, leg_Diff, leg_maturity:date, flagNumber)
    var ДнейДоПогашения = 0; 
    if(bnr_BCTermFormula == VS_TERMF_DURING)
       if(bnr_BCPresentationDate != Z_DATE)
          ДнейДоПогашения = (bnr_BCPresentationDate + leg_Diff) - CDate;
       else
          if(flagNumber)
             return 0;
          end;
       end;
    else
       ДнейДоПогашения = leg_maturity - CDate;
    end;
    
    if (ДнейДоПогашения < 0 ) // #91674
        return 0;
    else
        return ДнейДоПогашения;
    end;
    
    return "\n";
end;

private macro НомерДиапазонаСрочности(КолвоДней)
var
     McperiodNumber = 0;

     if(КолвоДней == 0)
        McperiodNumber = 1;
     elif((КолвоДней > 0) and (КолвоДней < 31)) 
        McperiodNumber = 2;
     elif((КолвоДней > 30) and (КолвоДней < 91)) 
        McperiodNumber = 3;
     elif((КолвоДней > 90) and (КолвоДней < 181)) 
        McperiodNumber = 4;
     elif((КолвоДней > 180) and (КолвоДней < 366)) 
        McperiodNumber = 5;
     elif((КолвоДней > 365) and (КолвоДней < 3*366)) 
        McperiodNumber = 6;
     elif(КолвоДней > 3*365)
        McperiodNumber = 7;
     end;

     return McperiodNumber;
end;

/* Получить диапазон срочности счета категории "Учтенные векселя"
*/
PRIVATE MACRO GetDiapason( bnr_BCID, bnr_BCTermFormula, bnr_BCPresentationDate )
var
    КолвоДней,
    categ = TRecHandler ("mccateg"),
    accdoc = TRecHandler ("mcaccdoc"),
    leg    = TBfile ("dl_leg"),
    period = TBfile("mcperiod"),
    fd = VSBannerFD (DL_VSBANNER, bnr_BCID);


    if (not VA_FindLeg(leg, bnr_BCID))
       /* stat = VA_Err("Не найдены ценовые условия векселя ",BCID);*/
    elif (not MC_FindMCCATEG ("Учтенные векселя", categ)) 
       /* не найдена категория */;
    elif(not MC_FindUseMCACCDOC(DL_VSBANNER,  bnr_BCID,    categ.rec.ID, 
                                FIROLE_FIDOC, fd.ОпределитьВалютуУчета(), accdoc, 
                                fd.GetParametr(MC_TYPE_PARAMETR_DEPARTMENT)))
       /* не найден счет */;

       КолвоДней = КоличествоДнейДоПогашения(ДатаВыполненияШага,
            bnr_BCTermFormula, bnr_BCPresentationDate, leg.rec.Diff, leg.rec.maturity, true);
       return НомерДиапазонаСрочности(КолвоДней);

    elif(not FindPeriod(accdoc.rec.PeriodID, period))
       /* не найден период */;
    elif(period.rec.Number > 0)
       return period.rec.Number;
    end;

    return 0;
END;

/* добавление к запросу условия отбора векселей, сменивших статус на этом шаге
*/
PRIVATE MACRO BillsForStep(query, DocKind, ID_Operation, ID_Step)
    // считаем, что в исходном запросе есть табличка 'bnr'
    
    if(DocKind != DL_VAPAWN)
       return; // нигде, кроме залога, частичного пополнения/вывода векселей нет!
    end;

    if ((ID_Operation != null) and (ID_Step != null))
        query.AddFrom(", DVSBNRBCK_DBT bc, DOPRDOCS_DBT od");
        query.AddWhere(
            "AND od.t_DocKind = " + DL_VSBNRBCK + " AND TO_NUMBER(od.t_DocumentID) = bc.t_ID "
            "AND od.t_ID_Operation = :op AND od.t_ID_Step = :step AND bc.t_BCID = BNR.t_BCID");
    
        query.AddParam("op",    RSDBP_IN, ID_Operation);
        query.AddParam("step",  RSDBP_IN, ID_Step);
    end;
END;

/****************************************************************************/
/* Создание последовательности печатаемых векселей                          */
/****************************************************************************/
PRIVATE MACRO CreateVsSeq(DocKind, ContractID, LinkKind, ID_Operation, ID_Step)
VAR stat = 0, MoveSt = 0,
    arr = TArray, arr0 = TArray,  arr1 = TArray,  arr2 = TArray,  arr3 = TArray,  arr4 = TArray,  arr5 = TArray,  arr6 = TArray, arr7 = TArray,
    j, k, n, c = 0,
    DataSet,
    dp = 0,
    query = DL_Select,
    OldCIssuer = -1,
    OldCPFI = -1, OldCBCCFI = -1,
    CBCID, CBCCOST, CBCCFI, CIssuer, CPFI, CBCTermForm, CBCPresDate, CIssuerName, CBCNumber, CBCSeries,
    CPrincipal, CStart, CMaturity, CExpiry, CDiff, CAgentName, CAccFI, CLinkKind;/* текущие значения, получаемые из запроса */

    VsSeq = TArray;

    arr[0] = arr0;
    arr[1] = arr1;
    arr[2] = arr2;
    arr[3] = arr3;
    arr[4] = arr4;
    arr[5] = arr5;
    arr[6] = arr6;
    arr[7] = arr7;

    query.select = 
        "BNR.T_ISSUER, LEG.T_PFI, LNK.T_BCCFI, LNK.T_BCID, LNK.T_BCCOST, LNK.T_LINKKIND, BNR.T_BCTERMFORMULA, " +
        "BNR.T_BCPRESENTATIONDATE, BNR.T_ISSUERNAME, BNR.T_BCNUMBER, BNR.T_BCSERIES, " +
        "LEG.T_PRINCIPAL, LEG.T_START, LEG.T_MATURITY, LEG.T_EXPIRY, LEG.T_DIFF, BNR.T_AGENTNAME, "+
        "RSB_BILL.GetVABnrPayFIID(BNR.t_BCID) as AccFI ";
    query.from = 
        "DVSORDLNK_DBT LNK, DDL_LEG_DBT LEG, DVSBANNER_DBT BNR";
    query.where = 
        "LNK.T_DOCKIND = :DocKind AND LNK.T_CONTRACTID = :DocID  AND LEG.T_DEALID = LNK.T_BCID " +
        "AND LEG.T_LEGKIND = " + LEG_KIND_VSBANNER + " AND LEG.T_LEGID = 0 " +
        "AND BNR.T_BCID = LNK.T_BCID";
    query.order = 
        "BNR.T_ISSUER, LEG.T_PFI, LNK.T_BCCFI";

    query.AddParam("DocKind",   RSDBP_IN, DocKind);
    query.AddParam("DocID",     RSDBP_IN, ContractID);

    if(linkKind != -1)
        query.AddWhere("AND LNK.T_LINKKIND = :linkkind");
        query.AddParam("LinkKind",  RSDBP_IN, LinkKind);
    end;

    BillsForStep(query, DocKind, ID_Operation, ID_Step);


/* создаем временный файл */
    DataSet = query.Execute();

    while(DataSet.MoveNext)
        MoveSt = 1;

        CIssuer = DataSet.Issuer;
        CPFI    = DataSet.PFI;
        CBCCFI  = DataSet.BCCFI;


        // Докопируем недостающие поля 
        CBCID       = DataSet.BCID;
        CBCCOST     = DataSet.BCCost;
        CBCTermForm = DataSet.BCTermFormula;
        CBCPresDate = date(DataSet.BCPresentationDate);
        CIssuerName = DataSet.IssuerName;
        CBCNumber   = DataSet.BCNumber;
        CBCSeries   = DataSet.BCSeries;
        CPrincipal  = DataSet.Principal;
        CStart      = date(DataSet.Start);
        CMaturity   = date(DataSet.Maturity);
        CExpiry     = date(DataSet.Expiry);
        CDiff       = DataSet.Diff;
        CAgentName  = DataSet.AgentName;
        CAccFI      = DataSet.AccFI;
        CLinkKind   = DataSet.LinkKind;

        dp = GetDiapason(CBCID, CBCTermForm, CBCPresDate);

        // заполняем массивы 
        arr[dp][arr[dp].Size] = CBCID;
        arr[dp][arr[dp].Size] = CBCCost;
        arr[dp][arr[dp].Size] = CBCCFI;
        arr[dp][arr[dp].Size] = CIssuer;
        arr[dp][arr[dp].Size] = dp;
        arr[dp][arr[dp].Size] = CPFI;
        arr[dp][arr[dp].Size] = CIssuerName;
        arr[dp][arr[dp].Size] = CBCNumber;
        arr[dp][arr[dp].Size] = CBCSeries;
        arr[dp][arr[dp].Size] = CBCTermForm;
        arr[dp][arr[dp].Size] = CBCPresDate;
        arr[dp][arr[dp].Size] = CPrincipal;
        arr[dp][arr[dp].Size] = CStart;
        arr[dp][arr[dp].Size] = CMaturity;
        arr[dp][arr[dp].Size] = CExpiry;
        arr[dp][arr[dp].Size] = CDiff;
        arr[dp][arr[dp].Size] = CAgentName;
        arr[dp][arr[dp].Size] = CAccFI;
        arr[dp][arr[dp].Size] = CLinkKind;


        OldCIssuer = CIssuer;
        OldCPFI = CPFI;
        OldCBCCFI = CBCCFI;

    end;    

    if(MoveSt)// Если что-то было...
        k = 0;
        while(k <= 7)
            n = 0;
            while(ValType(arr[k][n]) != V_UNDEF)
                j = 0;
                while (j < fld_count)
                    VsSeq[c + j] = arr[k][n + j];
                    j = j + 1;
                end;

                n = n + fld_count;
                c = c + fld_count;
            end;
            k = k + 1;
        end;
    end;
END;
/****************************************************************************/
/* Печать вида распоряжения                                                 */
/****************************************************************************/
MACRO DecreeType(ВидРаспоряжения, depo_contract)
VAR i = 0;

    while(i < DecType.Size)
       println("~M5" + string(i + 1));
       if(ВидРаспоряжения == DecType[i])
          println("X");
       else
          println(" ");
       end;
       i = i + 1;
    end;

    [~M58_1];
    if ((ВидРаспоряжения == DecType[7]) and (depo_contract))
        println(" по депозитарному договору");
    else
        println(" ");
    end;

    [~M59_1];
    if ((ВидРаспоряжения == DecType[8]) and (depo_contract))
        println(" по депозитарному договору");
    else
        println(" ");
    end;

END;
/****************************************************************************/
/* Возвращает тип поручения в депозитарий                                   */
/****************************************************************************/
MACRO GetDepoKindStr(tick, str:@variant)
var
   Kind,
   payms,
   stat = 0;

   payms = Tbfile("pmpaym.dbt", "R", 1);
   payms.Clear();
   payms.rec.DocKind = tick.BofficeKind;
   payms.rec.DocumentID = tick.DealID;
   payms.rec.Purpose = BAi;

   payms.AddFilter(" t_DocKind = " + tick.BofficeKind + " and t_DocumentID = " + tick.DealID + " and t_Purpose = " + BAi);
   payms.GetGE();

   VA_GetDepoKind(tick, payms, @Kind);

   payms.DropFilter();
   
    if(Kind == 840)
      str = DecType[1]; /* 840 - Поручение на прием на хранение документарных ц/б */
    elif(Kind == 845)
      str = DecType[2]; /* 845 - Поручение на списание документарных ц/б */
    elif(Kind == 800)
      str = DecType[9]; /* 800 - Поручение на книжный перевод */
    else
      stat = 1;
    end;

   return (stat == 0);
END;
/****************************************************************************/
/* Получить название валюты в родительном падеже                            */
/****************************************************************************/
MACRO VA_CurrencyWr(pr, cur)
VAR str = "", tmp, rub, kop, Fininstr;

    VA_ByDefault(pr, $0);
    VA_ByDefault(cur, -1);

    Fininstr = TRsbDataSet("select t_FI_Code from dfininstr_dbt where t_FIID="+cur);

    if(Fininstr.MoveNext())
       str = CurToStrAlt(pr, rub, kop, int(Fininstr.FI_Code));
       tmp = StrLen(rub) + 1;
       str = SubStr(str, tmp, Index(str, kop) - tmp);
    end;
    return trim(str);
END;
/****************************************************************************/
/* Получить референс                                                        */
/****************************************************************************/
MACRO GenRef(TypeDoc, Num)
  var refID, Ref;
  if(GetReferenceIDByType(TypeDoc, Num, refID))
    return 0;
  elif(GenerateReference( refID, Ref))
    return 0;
  end;
  return Ref;
END;
/****************************************************************************/
/* Получить сделку                                                          */
/* ID_Operation - номер экземпляра операции                                 */
/* d - структура dl_tick                                                    */
/****************************************************************************/
MACRO ПолучитьСделку(ID_Operation, d)
VAR stat = 0,
    oproper,
    dl_tick;

    record d_t ( dl_tick ) ;
    oproper = Tbfile("oproper.dbt", "R", 0);
    oproper.Clear();
    oproper.rec.ID_Operation = ID_Operation;
    stat = oproper.GetEQ();
    if (stat)
        DealsRestoreDocumentID(d_t, oproper.rec.DocumentID, DL_VEKSELACCOUNTED);
            dl_tick = Tbfile("dl_tick.dbt", "R", 0);
        dl_tick.Clear();
        dl_tick.rec.DealID = d_t.DealID;
        if(dl_tick.GetEQ())
        copy(d, dl_tick);
        return TRUE;        
        end;
    end;
return FALSE
END;

/****************************************************************************/
/* Автоматическая печать разрешена?                                         */
/****************************************************************************/
MACRO AutoPrint()
var val, stat;

    GetRegistryValue("УЧТЕННЫЕ ВЕКСЕЛЯ\\РЕЖИМ РАБОТЫ\\АВТОМАТИЧЕСКАЯ ПЕЧАТЬ",
                     V_BOOL, val, stat);
    
    if(stat != 0) 
       VA_Err("Ошибка при определении настройки| \"УЧТЕННЫЕ ВЕКСЕЛЯ\\РЕЖИМ РАБОТЫ\\АВТОМАТИЧЕСКАЯ ПЕЧАТЬ\"");
       return false;
    end;
    
    return val;
END;

/****************************************************************************/
/* Получить плановую дату                                                   */
/****************************************************************************/
MACRO GetPlanDate(ID_Operation, ID_Step)
VAR oprstep = TRsbDataSet("select t_Plan_Date from doprstep_dbt where t_ID_Operation="+ID_Operation+" and t_ID_Step="+ID_Step);

    if(oprstep.MoveNext)
        return oprstep.rec.Plan_Date;
    end;

    return date(0,0,0);
END;

PRIVATE MACRO CountTableRows()
var n_rows = 1, //for last result row
    current = 0,
    CIssuer = -1, CFormula = -1, CPFI = -1, CBCCFI = -1;

    if (ValType(VsSeq[0]) == V_UNDEF)
        return 0;
    end;

    while(ValType(VsSeq[current + fld_BCID]) != V_UNDEF)
       n_rows = n_rows + 1;    //строка векселя

       CIssuer  = VsSeq[current + fld_Issuer];
       CFormula = VsSeq[current + fld_Formula];
       CPFI     = VsSeq[current + fld_LegPFI];
       CBCCFI   = VsSeq[current + fld_BCCFI];

       current = current + fld_count;
    end;

    if((VsSeq.size/fld_count+1) == n_rows) // одна группа - подъитоги не нужны
       n_rows = n_rows - 1;
    end;

    return n_rows;
END;

MACRO ПолучитьДатуПоследнейПереоценкиСделки(DealDate, ID_Operation, OnDate)
  var PrevOberDate = DealDate;
  var Select, DataSet;
  
  Select = DL_RSDCommand(  " select os.t_Plan_Date "
                         + "   from doprstep_dbt os "
                         + "  where os.t_ID_Operation = ? "
                         + "    and os.t_Symbol = 'Н' "
                         + "    and os.t_IsExecute = ? " 
                         + "    and os.t_Plan_Date < ? "
                         + "  order by os.t_Plan_Date desc"
                        );

  Select.AddParam(ID_Operation);
  Select.AddParam(SET_CHAR);
  Select.AddParam(OnDate);
  DataSet = Select.execute();
  if(DataSet.moveNext())
    PrevOberDate = date(DataSet.Plan_Date);
  end;

  return PrevOberDate;
END;

/****************************************************************************/
/* Параметры векселей для бухгалтерии                                       */
/****************************************************************************/
PRIVATE MACRO ПараметрыВекселейБух(tickfd, ВидОперации, Шаблон, ВидРаспоряжения, Назначение, CDate:date, ID_Operation, ID_Step)
VAR stat = 0, 
N = 0, 
current = 0,
TBCCost = 0,  // тек. сумма (для мены это итог)
TPrevSum = 0, TFaceSum = 0, TC,
ICost = 0, IPrevSum = 0,
IPrinc = 0,
CIssuer = -1, CFormula = -1, CPFI = -1, CBCCFI = -1,
PrevDate, PrevBuy, PrevSum = 0, PrevFI,
rub,kop, income,
rsdqr, DataSet,
pm_Payer, pm_BaseAmount, pm_BaseFIID, AccFI, 
data_row, have_cost = true, PrevOverDate,

СуммаТребования,
СуммаОбязательства,
СуммаПереоцТребования,
СуммаПереоцОбязательства,
ВалютаТребования,
ВалютаОбязательства,
ВалютаТребованияСтр,
ВалютаОбязательстваСтр,

ОстатокПремии,
ПерваяСуммаПереоцОбязательства = true,
ПерваяСуммаПереоцТребования = true,
ИтогСуммаПереоцТребования=$0,
ИтогСуммаПереоцОбязательства=$0,
ИтогВалютаТребования=-1,
ИтогВалютаОбязательства=-1,

ИтогоПремияКСписанию,       ИтогоВалютаПремииКСписанию,

ИтогоСумма,                 ИтогоВалюта,
НоминалИтого,               НоминалВалюта,

СчетчВалУч,                 КолвоВалУч,
СчетчВалЦен,                КолвоВалЦен,
КолвоВалТреб,               КолвоВалОбяз,
СчетВалТребОбяз,            КолвоВалТребОбяз,

ИтогоСуммаПереоцСтоимости,  ИтогоВалютаПереоцСтоимости,
ИтогоСуммаПереоцПроцентов,  ИтогоВалютаПереоцПроцентов,
ИтогоСуммаПереоцДисконта,   ИтогоВалютаПереоцДисконта,
ИтогоСуммаПереоцПремии,     ИтогоВалютаПереоцПремии,
ИтогоСуммаДоначДисконта,    ИтогоВалютаДисконта,
ИтогоСуммаДоначПроцента,    ИтогоВалютаПроцентов,
ИтогоСуммаПокупки,          ИтогоВалютаПокупки,
ИтогоСуммаПремии,           ИтогоВалютаПремии,
ИтогоСуммаДисконта,
ИтогоСуммаПроцентов,
ИтогоСуммаПроцентовВН,      ИтогоВалютаПроцентовВН,
ИтогоСуммаДохода,           ИтогоВалютаДохода;

var C1,C2,CDD1,CDD2,M43_buf,M44_buf,M49_buf,M50_buf,CostVN;
var leg    = TBfile ("dl_leg");
var fd,pcacc,SumP;
var dl_tick = tickfd.GetTick();
var CurShift = 0;

Итоги                   = ИтогПоВекселям();
Итоги_ЦенаПокупки       = ИтогПоВекселям();
Итоги_Номинал           = ИтогПоВекселям();
Итоги_Дисконт           = ИтогПоВекселям();
Итоги_Проценты          = ИтогПоВекселям();
Итоги_Донач_Дисконта    = ИтогПоВекселям();
Итоги_Донач_Процента    = ИтогПоВекселям();
Итоги_Доход             = ИтогПоВекселям();
Итоги_Цена_ПокВН        = ИтогПоВекселям();
Итоги_ПереоцСтоимости   = ИтогПоВекселям();
Итоги_ПереоцПроцентов   = ИтогПоВекселям();
Итоги_ПереоцДисконта    = ИтогПоВекселям();
Итоги_ПереоцПремии      = ИтогПоВекселям();
Итоги_ПремияКСписанию   = ИтогПоВекселям();
Итоги_Премия            = ИтогПоВекселям();

Итоги_ВалУч                 = ИтогПоВекселям();
Итоги_ВалЦен                = ИтогПоВекселям();
Итоги_ВалТреб               = ИтогПоВекселям();
Итоги_ВалОбяз               = ИтогПоВекселям();
Итоги_ПереоцТребования      = ИтогПоВекселям();
Итоги_ПереоцОбязательства   = ИтогПоВекселям();

var err, errMsg;

C1 = money(0);
C2 = money(0);
CDD1 = money(0);
CDD2 = money(0);
CostVN = money(0);
M43_buf = money(0);
M44_buf = money(0);
M49_buf = money(0);
M50_buf = money(0);

InitOpType(OpType);

 if( VA_IsBuy(dl_tick.DealType) OR
    VA_IsSale(dl_tick.DealType) OR
    (dl_tick.BofficeKind == DL_VAREPAY) OR
    VA_IsExchange(dl_tick.DealType))

    data_row = 4;
    if(ВидРаспоряжения == DecType[13])
      data_row = 3; 
    end;
    
    if(VA_IsSale(dl_tick.DealType) OR VA_IsBuy(dl_tick.DealType))
        if(ВидОперации == OpType[0])
            CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_BUY, ID_Operation, ID_Step);
        elif(ВидОперации == OpType[1])
            CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_SALE, ID_Operation, ID_Step);
        else
            CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_ALL, ID_Operation, ID_Step);
            if((ВидРаспоряжения == DecType[14]) and (Назначение == DecPurp[21]))
                data_row = 3;
            end;
        end;
    elif (VA_IsExchange(dl_tick.DealType))
        if(ВидРаспоряжения == DecType[13])
          CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_SALE, ID_Operation, ID_Step);
        elif(ВидРаспоряжения == DecType[14])
          CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_BUY, ID_Operation, ID_Step);
          if(Назначение == DecPurp[21])
            data_row = 3;
          else
            data_row = 5;
          end;
        else
          CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_BUY, ID_Operation, ID_Step);
          data_row = 5;
        end;
    else
        CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_ALL, ID_Operation, ID_Step);
    end;

    println("~MultipleRow");
    println(1);
    println(CountTableRows() - 1);  //одна строка уже есть в шаблоне
    println("#");
    println(data_row);
 
    while(ValType(VsSeq[current]) != V_UNDEF)
        N = N + 1;
             
        if(CIssuer != -1)
            if((CIssuer != VsSeq[current + fld_Issuer]) OR 
                (CFormula != VsSeq[current + fld_Formula]) OR
                (CPFI != VsSeq[current + fld_LegPFI]) OR
                (CBCCFI != VsSeq[current + fld_BCCFI]))
            
                CIssuer  = VsSeq[current + fld_Issuer];
                CFormula = VsSeq[current + fld_Formula];
                CPFI     = VsSeq[current + fld_LegPFI];
                CBCCFI   = VsSeq[current + fld_BCCFI];

                ICost = 0; IPrevSum = 0; 
                IPrinc = 0;
            end;
        else
            CIssuer  = VsSeq[current + fld_Issuer];
            CFormula = VsSeq[current + fld_Formula];
            CPFI     = VsSeq[current + fld_LegPFI];
            CBCCFI   = VsSeq[current + fld_BCCFI];
        end;

        TC    = VsSeq[current + fld_BCCFI];
        AccFI = VsSeq[current + fld_AccFI];

        // Нужно посчитать количество валюты учета
        Итоги_ВалУч.Итого(0, AccFI);

        println("~M11_" + string(N));
        println(VsSeq[current + fld_IssuerName]);

        println("~M59_" + string(N));
        println(VsSeq[current + fld_AgentName]);

        println("~M12_" + string(N));
        println(trim(VsSeq[current + fld_BCNumber]));
    
        println("~M13_" + N);
        println(VsSeq[current + fld_BCSeries]);

        println("~M14_" + N);
        println(VsSeq[current + fld_Principal]);
        IPrinc = IPrinc + VsSeq[current + fld_Principal];
        Итоги_Номинал.Итого(VsSeq[current + fld_Principal], CPFI);
        println("~M14C_" + N);
        println(VA_CurrencyWr(VsSeq[current + fld_Principal],VsSeq[current + fld_LegPFI]));

        println("~M16_" + N);
        println(VsSeq[current + fld_Start]);
    
        println("~M17_" + N);
        println(ПолучитьСрокПлатежаПоВекселю(VsSeq[current + fld_BCTermForm],
            VsSeq[current + fld_Maturity], VsSeq[current + fld_Start], VsSeq[current + fld_Expiry], VsSeq[current + fld_Diff]));

        println("~M18_" + N);
        println(VsSeq[current + fld_BCCost]);
        // Нужно посчитать количество валюты цены
        Итоги_ВалЦен.Итого(0, VsSeq[current + fld_BCCost]);
        println("~M18C_" + N);
        println(VA_CurrencyWr(VsSeq[current + fld_BCCost], VsSeq[current + fld_BCCFI]));

        //--------------------------------------------------------------------------
                
        if(NOT ((VA_IsExchange(dl_tick.DealType)) AND (ВидРаспоряжения == DecType[11])))
          if (VA_FindLeg(leg, VsSeq[current + fld_BCID]))
            if(dl_tick.avoirkind == AVOIRISSKIND_BILL)

              println("~M43_" + N);
              if(ВексельДисконтный(leg))
                M43_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})) - 1, FIROLE_DISCOUNT),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
              else
                M43_buf = $0;
              end;
              println(M43_buf);
              Итоги_Дисконт.Итого(M43_buf, AccFI);
              println("~M43C_" + N);
              println(VA_CurrencyWr(M43_buf, AccFI));

              println("~M44_" + N);
              if(ВексельПроцентный(leg))
                M44_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})) - 1, FIROLE_PERCENT),{CurDate},VsSeq[current + fld_LegPFI], AccFI, err, errMsg, true));
              else
                M44_buf = $0;
              end;
              println(M44_buf);
              Итоги_Проценты.Итого(M44_buf, AccFI);
              println("~M44C_" + N);
              println(VA_CurrencyWr(M44_buf, AccFI));

            elif(dl_tick.avoirkind == AVOIRISSKIND_DEPOSIT_CERTIFICATE)

              println("~M43_" + N);
              M43_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})) - 1, FIROLE_DISCOUNT),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
              Итоги_Дисконт.Итого(M43_buf, AccFI);
              println(M43_buf);
              println("~M43C_" + N);
              println(VA_CurrencyWr(M43_buf, AccFI));

              println("~M44_" + N);
              M44_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})) - 1, FIROLE_PERCENT),{CurDate},VsSeq[current + fld_BCCFI], AccFI, err, errMsg, true));
              println(M44_buf);
              Итоги_Проценты.Итого(M44_buf, AccFI);
              println("~M44C_" + N);
              println(VA_CurrencyWr(M44_buf, AccFI));

            end;
          end;
        end;

        if((ВидРаспоряжения == DecType[13]) OR (ВидРаспоряжения == DecType[11]))
          //----Сумма к доначислению дисконта---------------------------------------
          println("~M49_" + N);
          if(ВексельДисконтный(leg))                                                            
            M49_buf = money(VA_Convert(ПолучитьСуммуПДДШага(VsSeq[current + fld_BCID], FIROLE_DISCOUNT, ID_Operation, ID_Step),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
          else
            M49_buf = $0;
          end;
          println(M49_buf);
          Итоги_Донач_Дисконта.Итого(M49_buf, AccFI);
          println("~M49C_" + N);
          println(VA_CurrencyWr(M49_buf, AccFI));            

          //----Сумма к доначислению процента-------------------------------------               
          println("~M50_" + N);
          if(ВексельПроцентный(leg))               
            M50_buf = ПолучитьСуммуПДДШага(VsSeq[current + fld_BCID], FIROLE_PERCENT, ID_Operation, ID_Step);
            M50_buf = VA_Convert(M50_buf,{CurDate},VsSeq[current + fld_BCCFI], AccFI, err, errMsg, true);
          else
            M50_buf = $0;
          end;
          Итоги_Донач_Процента.Итого(M50_buf, AccFI);
          println(M50_buf);
          println("~M50C_" + N);
          println(VA_CurrencyWr(M50_buf, AccFI));
        end;

        if((ВидРаспоряжения == DecType[13]) OR (ВидРаспоряжения == DecType[11]) OR (ВидРаспоряжения == DecType[12]))
          println("~M47_" + N);
          println(VA_RateStr(leg.rec.Price, leg.rec.Point));

          println("~M53_" + N);
          CostVN = ПолучитьЦенуПокупкиБезПремииВУ(VsSeq[current + fld_BCID], CDate);
          println(money(CostVN));
          Итоги_Цена_ПокВН.Итого(CostVN, AccFI);
          println("~M53C_" + N);
          println(VA_CurrencyWr(CostVN, AccFI));
        end;

        //-----------------------------------

        println("~M20_" + N);
        println(КоличествоДнейДоПогашения(CDate,
            VsSeq[current + fld_BCTermForm], VsSeq[current + fld_BCPresDate],
            VsSeq[current + fld_Diff], VsSeq[current + fld_Maturity], false));

        TBCCost = VsSeq[current + fld_BCCost];
        Итоги.Итого(TBCCost, TC);
        ICost = ICost + TBCCost;
        if (VsSeq[current + fld_BCCost] == 0)
            have_cost = false;
        end;

        if(NOT ((VA_IsExchange(dl_tick.DealType)) AND (ВидРаспоряжения == DecType[11])))
          println("~M53_" + N);
          if(VA_IsBuy(dl_tick.DealType) OR VA_IsSale(dl_tick.DealType) OR (dl_tick.BofficeKind == DL_VAREPAY)) 
            PrevSum = ПолучитьЦенуПокупкиБезПремииВУ(VsSeq[current + fld_BCID], CDate);
          end;
          println(money(PrevSum));
          println("~M53C_" + N);
          println(VA_CurrencyWr(PrevSum, VsSeq[current + fld_AccFI]));

          println("~M23_" + N);
          income = VA_Convert(VsSeq[current + fld_BCCost],{CurDate},VsSeq[current + fld_BCCFI],VsSeq[current + fld_AccFI], err, errMsg, true);
          income = money(income) - PrevSum - M43_buf - M44_buf;
          Итоги_Доход.Итого(VA_Convert(income,{CurDate},VsSeq[current + fld_AccFI],NATCUR, err, errMsg, true), NATCUR);
          println(VA_Convert(income,{CurDate},VsSeq[current + fld_AccFI],NATCUR, err, errMsg, true));
          println("~M23C_" + N);
          println(VA_CurrencyWr(income,NATCUR));
        end;

        ОстатокПремии = ПолучитьОстатокПремииНаДатуВУ(VsSeq[current + fld_BCID], CDate-1);
        println("~M55_" + N);
        println(ОстатокПремии);
        println("~M55C_" + N);
        println(VA_CurrencyWr(ОстатокПремии, VsSeq[current + fld_AccFI]));

        PrevSum = ПолучитьЦенуПокупкиБезПремииВУ(VsSeq[current + fld_BCID], CDate-1);
        CostVN  = ПолучитьЦенуПокупкиБезПремииВН(VsSeq[current + fld_BCID], CDate-1);
        income  = PrevSum - VA_Convert(CostVN,CDate,VsSeq[current + fld_LegPFI],VsSeq[current + fld_AccFI], err, errMsg, true);
        println("~M60_" + N);
        println(income);
        println("~M60C_" + N);
        println(VA_CurrencyWr(income, VsSeq[current + fld_AccFI]));
        Итоги_ПереоцСтоимости.Итого(income, VsSeq[current + fld_AccFI]);

        income  = ПолучитьСуммуПереоценкиШагаВУ(VsSeq[current + fld_BCID], FIROLE_DISCOUNT, ID_Operation, ID_Step);
        println("~M61_" + N);
        println(income);
        println("~M61C_" + N);
        println(VA_CurrencyWr(income, VsSeq[current + fld_AccFI]));
        Итоги_ПереоцДисконта.Итого(income, VsSeq[current + fld_AccFI]);

        income  = ПолучитьСуммуПереоценкиШагаВУ(VsSeq[current + fld_BCID], FIROLE_PERCENT, ID_Operation, ID_Step);
        println("~M62_" + N);
        println(income);
        println("~M62C_" + N);
        println(VA_CurrencyWr(income, VsSeq[current + fld_AccFI]));
        Итоги_ПереоцПроцентов.Итого(income, VsSeq[current + fld_AccFI]);

        PrevSum = ПолучитьОстатокПремииНаДатуВУ(VsSeq[current + fld_BCID], CDate-1);
        CostVN  = ПолучитьОстатокПремииНаДатуВН(VsSeq[current + fld_BCID], CDate-1);
        income  = PrevSum - VA_Convert(CostVN,CDate,VsSeq[current + fld_LegPFI],VsSeq[current + fld_AccFI], err, errMsg, true);
        println("~M63_" + N);
        println(income);
        println("~M63C_" + N);
        println(VA_CurrencyWr(income, VsSeq[current + fld_AccFI]));
        Итоги_ПереоцПремии.Итого(income, VsSeq[current + fld_AccFI]);

        income = ОстатокПремии - income - ПолучитьСуммуПДДШагаВУ(VsSeq[current + fld_BCID], FIROLE_BONUS, ID_Operation, ID_Step);
        println("~M56_" + N);
        println(income);
        println("~M56C_" + N);
        println(VA_CurrencyWr(income, VsSeq[current + fld_AccFI]));
        Итоги_ПремияКСписанию.Итого(income, VsSeq[current + fld_AccFI]);

        PrevOverDate = ПолучитьДатуПоследнейПереоценкиСделки(dl_tick.DealDate, ID_Operation, CDate);
        if(VsSeq[current + fld_LinkKind] == VSORDLNK_K_BUY)

          ВалютаТребования    = VsSeq[current + fld_AccFI];
          ВалютаОбязательства = tickfd.GetDealPayFI();

          // Нужно подсчитать число валют требования и обязательств
          Итоги_ВалТреб.Итого(0, ВалютаТребования);
          Итоги_ВалОбяз.Итого(0, ВалютаОбязательства);

          //сумма требования
          СуммаТребования = VA_Convert(VsSeq[current + fld_BCCost],CDate,VsSeq[current + fld_BCCFI],ВалютаТребования, err, errMsg, true);
          ВалютаТребованияСтр = VA_CurrencyWr(СуммаТребования, ВалютаТребования);
          println("~M68_" + N);
          println(СуммаТребования);
          println("~M68C_" + N);
          println(ВалютаТребованияСтр);
          
          //сумма переоценки требования
          if(not VA_IsBarterF(tickfd.GetTick().DealType))
            СуммаПереоцТребования = СуммаТребования - VA_Convert(VsSeq[current + fld_BCCost],PrevOverDate,VsSeq[current + fld_BCCFI],ВалютаТребования, err, errMsg, true); 
            ВалютаТребованияСтр = VA_CurrencyWr(abs(СуммаПереоцТребования), ВалютаТребования);
            Итоги_ПереоцТребования.Итого(СуммаПереоцТребования, ВалютаТребования);
            Итоги_ПереоцТребования.Итого($0, ВалютаОбязательства);
          else
            СуммаПереоцТребования = "";
            ВалютаТребованияСтр = "";
          end;
          println("~M72_" + N);
          println(СуммаПереоцТребования);
          println("~M72C_" + N);
          println(ВалютаТребованияСтр);
          
          //сумма обязательства
          СуммаОбязательства = VA_Convert(VsSeq[current + fld_BCCost],CDate,VsSeq[current + fld_BCCFI],ВалютаОбязательства, err, errMsg, true);
          ВалютаОбязательстваСтр = VA_CurrencyWr(СуммаОбязательства, ВалютаОбязательства);
          println("~M70_" + N);
          println(СуммаОбязательства);
          println("~M70C_" + N);
          println(ВалютаОбязательстваСтр);

          //сумма переоценки обязательства
          if(not VA_IsExchange(tickfd.GetTick().DealType))
            СуммаПереоцОбязательства = СуммаОбязательства - VA_Convert(VsSeq[current + fld_BCCost],PrevOverDate,VsSeq[current + fld_BCCFI],ВалютаОбязательства, err, errMsg, true);
            ВалютаОбязательстваСтр   = VA_CurrencyWr(abs(СуммаПереоцОбязательства), ВалютаОбязательства);
            Итоги_ПереоцОбязательства.Итого($0, ВалютаТребования);
            Итоги_ПереоцОбязательства.Итого(СуммаПереоцОбязательства, ВалютаОбязательства);
          else
            СуммаПереоцОбязательства = "";
            ВалютаОбязательстваСтр   = "";
          end;
          println("~M73_" + N);
          println(СуммаПереоцОбязательства);
          println("~M73C_" + N);
          println(ВалютаОбязательстваСтр);

        elif(VsSeq[current + fld_LinkKind] == VSORDLNK_K_SALE)

          ВалютаТребования    = tickfd.GetDealPayFI();
          ВалютаОбязательства = VsSeq[current + fld_AccFI];

          // Нужно подсчитать число валют требования и обязательств
          Итоги_ВалТреб.Итого(0, ВалютаТребования);
          Итоги_ВалОбяз.Итого(0, ВалютаОбязательства);

          //сумма требования
          СуммаТребования = VA_Convert(VsSeq[current + fld_BCCost],CDate,VsSeq[current + fld_BCCFI],ВалютаТребования, err, errMsg, true);
          ВалютаТребованияСтр = VA_CurrencyWr(СуммаТребования, ВалютаТребования);
          println("~M68_" + N);
          println(СуммаТребования);
          println("~M68C_" + N);
          println(ВалютаТребованияСтр);

          //сумма переоценки требования
          if(not VA_IsExchange(tickfd.GetTick().DealType))
            СуммаПереоцТребования = СуммаТребования - VA_Convert(VsSeq[current + fld_BCCost],PrevOverDate,VsSeq[current + fld_BCCFI],ВалютаТребования, err, errMsg, true);
            ВалютаТребованияСтр   = VA_CurrencyWr(abs(СуммаПереоцТребования), ВалютаТребования);
            Итоги_ПереоцТребования.Итого(СуммаПереоцТребования, ВалютаТребования);
            Итоги_ПереоцТребования.Итого($0, ВалютаОбязательства);
          else
            СуммаПереоцТребования = "";
            ВалютаТребованияСтр   = "";
          end;
          println("~M72_" + N);
          println(СуммаПереоцТребования);
          println("~M72C_" + N);
          println(ВалютаТребованияСтр);

          //сумма обязательства
          СуммаОбязательства = VA_Convert(VsSeq[current + fld_BCCost],CDate,VsSeq[current + fld_BCCFI],ВалютаОбязательства, err, errMsg, true);
          ВалютаОбязательстваСтр = VA_CurrencyWr(СуммаОбязательства, ВалютаОбязательства);
          println("~M70_" + N);
          println(СуммаОбязательства);
          println("~M70C_" + N);
          println(ВалютаОбязательстваСтр);

          //сумма переоценки обязательства
          if(not VA_IsBarterW(tickfd.GetTick().DealType))
            СуммаПереоцОбязательства = СуммаОбязательства - VA_Convert(VsSeq[current + fld_BCCost],PrevOverDate,VsSeq[current + fld_BCCFI],ВалютаОбязательства, err, errMsg, true); 
            ВалютаОбязательстваСтр = VA_CurrencyWr(abs(СуммаПереоцОбязательства), ВалютаОбязательства);
            Итоги_ПереоцОбязательства.Итого($0, ВалютаТребования);
            Итоги_ПереоцОбязательства.Итого(СуммаПереоцОбязательства, ВалютаОбязательства);
          else
            СуммаПереоцОбязательства = "";
            ВалютаОбязательстваСтр = "";
          end;
          println("~M73_" + N);
          println(СуммаПереоцОбязательства);
          println("~M73C_" + N);
          println(ВалютаОбязательстваСтр);
        end;

      current = current + fld_count;
    end; // while()

    N = N + 1;
    
    //для операций залога с незаданной оценочной стоимостью хотя бы одного веселя
    //вытаскиваем оценочную стоимость из самой операции
    if ((dl_tick.BofficeKind == DL_VAPAWN) and (not have_cost))
       Итоги.SetDataNull();
       
       DataSet = TRsbDataSet("SELECT t_cfi, t_Cost FROM ddl_leg_dbt " +
                            " WHERE t_dealid = " + dl_tick.dealid +
                              " and t_legkind = " + LEG_KIND_DL_TICK +
                              " and t_legid = 0");

       if (DataSet.MoveNext())
           TC = DataSet.CFI;
           Итоги.Итого(DataSet.Cost, TC);
       end;
    end;

    // -------------------------------------------------------------------------------
    // Вывод итоговых строк. Начало
    // -------------------------------------------------------------------------------

    if((Шаблон == "OF1.dot") or (Шаблон == "OF12.dot"))
      if(not (ВидОперации == OpType[10]) or (ВидОперации == OpType[11]))
        КолвоВалЦен = Итоги_ВалЦен.GetSize();

        // Множим итоговую строку по количеству валют учета
        println("~MultipleRow");
        println(1);
        println(КолвоВалЦен - 1);
        println("#");
        println(-1);

        СчетчВалЦен = 0;
        while(СчетчВалЦен < КолвоВалЦен)
          СчетчВалЦен = СчетчВалЦен + 1;

          println("~M21_" + СчетчВалЦен);
          Итоги.GetData(СчетчВалЦен - 1, @ИтогоСумма, @ИтогоВалюта); 
          println(ИтогоСумма);
          println("~M21C_" + СчетчВалЦен);
          println(VA_CurrencyWr(ИтогоСумма, ИтогоВалюта));
        end;
      else
        println("~M21_" + 1);
        println("");
        println("~M21C_" + 1);
        println("");
      end;
    end; // if(Шаблон == "OF1.dot")

    if(Шаблон == "OF11.dot")
      println("~M25_" + 1);
      Итоги_Доход.GetData(0, @ИтогоСуммаДохода, @ИтогоВалютаДохода);
      println(ИтогоСуммаДохода);
      println("~M25C_" + 1);
      println(VA_CurrencyWr(ИтогоСуммаДохода, ИтогоВалютаДохода));
    end;

    if((Шаблон == "OF13.dot") or (Шаблон == "OF14.dot") or (Шаблон == "OF15.dot"))
      КолвоВалУч = Итоги_ВалУч.GetSize();

      // Множим итоговую строку по количеству валют учета
      println("~MultipleRow");
      println(1);
      println(КолвоВалУч - 1);
      println("#");
      println(-1);

      СчетчВалУч = 0;
      while(СчетчВалУч < КолвоВалУч)
        СчетчВалУч = СчетчВалУч + 1;

        println("~M481_1");
        Итоги_Цена_ПокВН.GetData(0, @ИтогоСуммаПроцентовВН, @ИтогоВалютаПроцентовВН);
        println(money(ИтогоСуммаПроцентовВН));
        println("~M481C_1");
        println(VA_CurrencyWr(ИтогоСуммаПроцентовВН, ИтогоВалютаПроцентовВН));

        println("~M45_1");
        Итоги_Дисконт.GetData(0, @ИтогоСуммаДисконта, @ИтогоВалютаДисконта);
        println(money(ИтогоСуммаДисконта));
        println("~M45C_1");
        println(VA_CurrencyWr(ИтогоСуммаДисконта, ИтогоВалютаДисконта));

        println("~M46_1");
        Итоги_Проценты.GetData(0, @ИтогоСуммаПроцентов, @ИтогоВалютаПроцентов);
        println(money(ИтогоСуммаПроцентов));
        println("~M46C_1");
        println(VA_CurrencyWr(ИтогоСуммаПроцентов, ИтогоВалютаПроцентов));

        println("~M51_" + СчетчВалУч);
        Итоги_Донач_Дисконта.GetData(СчетчВалУч - 1, @ИтогоСуммаДоначДисконта, @ИтогоВалютаДисконта);
        println(money(ИтогоСуммаДоначДисконта));
        println("~M51C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоСуммаДоначДисконта, ИтогоВалютаДисконта));

        println("~M52_" + СчетчВалУч);
        Итоги_Донач_Процента.GetData(СчетчВалУч - 1, @ИтогоСуммаДоначПроцента, @ИтогоВалютаПроцентов);
        println(money(ИтогоСуммаДоначПроцента));
        println("~M52C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоСуммаДоначПроцента, ИтогоВалютаПроцентов));

        println("~M57_" + СчетчВалУч);
        Итоги_ПремияКСписанию.GetData(СчетчВалУч - 1, @ИтогоПремияКСписанию, @ИтогоВалютаПремииКСписанию);
        println(ИтогоПремияКСписанию); 
        println("~M57C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоПремияКСписанию, ИтогоВалютаПремииКСписанию));

        println("~M64_" + СчетчВалУч);
        Итоги_ПереоцСтоимости.GetData(СчетчВалУч - 1, @ИтогоСуммаПереоцСтоимости, @ИтогоВалютаПереоцСтоимости);
        println(ИтогоСуммаПереоцСтоимости); 
        println("~M64C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоСуммаПереоцСтоимости, ИтогоВалютаПереоцСтоимости));

        println("~M65_" + СчетчВалУч);
        Итоги_ПереоцДисконта.GetData(СчетчВалУч - 1, @ИтогоСуммаПереоцДисконта, @ИтогоВалютаПереоцДисконта);
        println(ИтогоСуммаПереоцДисконта); 
        println("~M65C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоСуммаПереоцДисконта, ИтогоВалютаПереоцДисконта));

        println("~M66_" + СчетчВалУч);
        Итоги_ПереоцПроцентов.GetData(СчетчВалУч - 1, @ИтогоСуммаПереоцПроцентов, @ИтогоВалютаПереоцПроцентов);
        println(ИтогоСуммаПереоцПроцентов); 
        println("~M66C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоСуммаПереоцПроцентов, ИтогоВалютаПереоцПроцентов));

        println("~M67_" + СчетчВалУч);
        Итоги_ПереоцПремии.GetData(СчетчВалУч - 1, @ИтогоСуммаПереоцПремии, @ИтогоВалютаПереоцПремии);
        println(ИтогоСуммаПереоцПремии); 
        println("~M67C_" + СчетчВалУч);
        println(VA_CurrencyWr(ИтогоСуммаПереоцПремии, ИтогоВалютаПереоцПремии)); 

      end;
    end; // if((Шаблон == "OF13.dot") or (Шаблон == "OF14.dot") or (Шаблон == "OF15.dot"))

    if((Шаблон == "OF16.dot") or (Шаблон == "OF17.dot"))
      КолвоВалТреб = Итоги_ВалТреб.GetSize();
      КолвоВалОбяз = Итоги_ВалОбяз.GetSize();

      КолвоВалТребОбяз = КолвоВалОбяз;

      if(КолвоВалТреб > КолвоВалОбяз)
        КолвоВалТребОбяз = КолвоВалТреб;
      end;

      println("~MultipleRow");
      println(1);
      println(КолвоВалТребОбяз - 1);
      println("#");
      println(-1);

      if(Шаблон == "OF17.dot")
        println("~MultipleRow");
        println(2);
        println(КолвоВалТребОбяз - 1);
        println("#");
        println(-1);
      end;

      СчетВалТребОбяз = 0;
      while(СчетВалТребОбяз < КолвоВалТребОбяз)
        СчетВалТребОбяз = СчетВалТребОбяз + 1;

        Итоги_ПереоцТребования.GetData(СчетВалТребОбяз - 1, @ИтогСуммаПереоцТребования, @ИтогВалютаТребования);
        if(ИтогВалютаТребования != -1)
          println("~M74_" + СчетВалТребОбяз);
          println(ИтогСуммаПереоцТребования);
          println("~M74C_" + СчетВалТребОбяз);
          println(VA_CurrencyWr(abs(ИтогСуммаПереоцТребования),ИтогВалютаТребования));
        else
          println("~M74_" + СчетВалТребОбяз);
          println("");
          println("~M74C_" + СчетВалТребОбяз);
          println("");
        end;

        Итоги_ПереоцОбязательства.GetData(СчетВалТребОбяз - 1, @ИтогСуммаПереоцОбязательства, @ИтогВалютаОбязательства);
        if(ИтогВалютаОбязательства != -1)
          println("~M75_" + СчетВалТребОбяз);
          println(ИтогСуммаПереоцОбязательства);
          println("~M75C_" + СчетВалТребОбяз);
          println(VA_CurrencyWr(abs(ИтогСуммаПереоцОбязательства),ИтогВалютаОбязательства));
        else
          println("~M75_" + СчетВалТребОбяз);
          println("");
          println("~M75C_" + СчетВалТребОбяз);
          println("");
        end;
      end;
    end;

    // -------------------------------------------------------------------------------
    // Вывод итоговых строк. Конец
    // -------------------------------------------------------------------------------

 end; // if( VA_IsBuy(dl_tick.DealType) OR ...

 /* M31 вынесена в общ. функцию */
 if (VA_IsExchange(dl_tick.DealType) AND ((ВидРаспоряжения == DecType[11]) or (ВидРаспоряжения == DecType[14]))) /* для мены */

    /* передаваемые векселя */
    N = 0;
    ICost = 0; IPrevSum = 0;
    TBCCost = 0;
    TPrevSum = 0;
    TFaceSum = 0;
    IPrinc = 0;
    CIssuer = -1;
    CFormula = -1;
    CPFI = -1;
    current = 0;
    Итоги_Дисконт.SetDataNull();
    Итоги_Проценты.SetDataNull();
    Итоги_ПереоцОбязательства.SetDataNull();

    CreateVsSeq(dl_tick.BofficeKind, dl_tick.DealID, VSORDLNK_K_SALE, ID_Operation, ID_Step);

    println("~MultipleRow");
    println(2);
    println(CountTableRows() - 1);  //one row already in template
    println("#");
    println(3);

    while(ValType(VsSeq[current]) != V_UNDEF)

        N = N + 1;

        if(CIssuer != -1)
            if((CIssuer != VsSeq[current + fld_Issuer]) OR 
                (CFormula != VsSeq[current + fld_Formula]) OR
                (CPFI != VsSeq[current + fld_LegPFI]) OR
                (CBCCFI != VsSeq[current + fld_BCCFI]))

                CIssuer  = VsSeq[current + fld_Issuer];
                CFormula = VsSeq[current + fld_Formula];
                CPFI     = VsSeq[current + fld_LegPFI];
                CBCCFI   = VsSeq[current + fld_BCCFI];

                ICost = 0;IPrevSum = 0;
                IPrinc = 0;
            end;
        else
            CIssuer  = VsSeq[current + fld_Issuer];
            CFormula = VsSeq[current + fld_Formula];
            CPFI     = VsSeq[current + fld_LegPFI];
            CBCCFI   = VsSeq[current + fld_BCCFI];
        end;

        TC = VsSeq[current + fld_BCCFI];
        AccFI = VsSeq[current + fld_AccFI];

        println("~M111_" + string(N));
        println(VsSeq[current + fld_IssuerName]);

        println("~M591_" + string(N));
        println(VsSeq[current + fld_IssuerName]);

        println("~M121_" + string(N));
        println(trim(VsSeq[current + fld_BCNumber]));
    
        println("~M131_" + N);
        println(VsSeq[current + fld_BCSeries]);

        println("~M141_" + N);
        println(VsSeq[current + fld_Principal]);
        IPrinc = IPrinc + VsSeq[current + fld_Principal];
        TFaceSum = TFaceSum + VsSeq[current + fld_Principal];
        println("~M14C1_" + N);
        println(VA_CurrencyWr(VsSeq[current + fld_Principal], CPFI));

        println("~M161_" + N);
        println(VsSeq[current + fld_Start]);
    
        println("~M171_" + N);
        println(ПолучитьСрокПлатежаПоВекселю(VsSeq[current + fld_BCTermForm],
            VsSeq[current + fld_Maturity], VsSeq[current + fld_Start], VsSeq[current + fld_Expiry], VsSeq[current + fld_Diff]));
 
        println("~M181_" + N);
        println(VsSeq[current + fld_BCCost]);
        TBCCost = TBCCost + VsSeq[current + fld_BCCost];
        ICost = ICost + VsSeq[current + fld_BCCost];
        println("~M18C1_" + N);
        println(VA_CurrencyWr(VsSeq[current + fld_BCCost], VsSeq[current + fld_BCCFI]));

        println("~M53_" + N);
        PrevSum = ПолучитьЦенуПокупкиБезПремииВУ(VsSeq[current + fld_BCID], CDate);
        TPrevSum = TPrevSum + PrevSum;
        println(money(PrevSum));
        println("~M53C_" + N);
        println(VA_CurrencyWr(PrevSum, VsSeq[current + fld_AccFI]));

        if (VA_FindLeg(leg, VsSeq[current + fld_BCID]))
          if(dl_tick.avoirkind == AVOIRISSKIND_BILL)

            println("~M43_" + N);
            if(ВексельДисконтный(leg))
              M43_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})), FIROLE_DISCOUNT),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
            else
              M43_buf = $0;
            end;
            Итоги_Дисконт.Итого(M43_buf, AccFI);
            println(M43_buf);
            println("~M43C_" + N);
            println(VA_CurrencyWr(M43_buf, AccFI));

            println("~M44_" + N);
            if(ВексельПроцентный(leg))
              M44_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})), FIROLE_PERCENT),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
            else
              M44_buf = $0;
            end;
            Итоги_Проценты.Итого(M44_buf, AccFI);
            println(M44_buf);
            println("~M44C_" + N);
            println(VA_CurrencyWr(M44_buf, AccFI));

            ОстатокПремии = ПолучитьОстатокПремииНаДатуВУ(VsSeq[current + fld_BCID], CDate-1);
            Итоги_Премия.Итого(ОстатокПремии, AccFI);
            println("~M55_" + N);
            println(ОстатокПремии);
            println("~M55C_" + N);
            println(VA_CurrencyWr(ОстатокПремии, VsSeq[current + fld_AccFI]));

          elif(dl_tick.avoirkind == AVOIRISSKIND_DEPOSIT_CERTIFICATE)
            println("~M43_" + N);
            M43_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})), FIROLE_DISCOUNT),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
            Итоги_Дисконт.Итого(M43_buf, AccFI);
            println(M43_buf);
            println("~M43C_" + N);
            println(VA_CurrencyWr(M43_buf, AccFI));

            println("~M44_" + N);
            M44_buf = money(VA_Convert(ПолучитьСуммуПДДНаДату(VsSeq[current + fld_BCID], date(Min(CDate, {CurDate})), FIROLE_PERCENT),{CurDate},VsSeq[current + fld_LegPFI],AccFI, err, errMsg, true));
            println(M44_buf);
            Итоги_Проценты.Итого(M44_buf, AccFI);
            println("~M44C_" + N);
            println(VA_CurrencyWr(M44_buf, AccFI));

            println("~M55_" + N);
            println(" ");
            println("~M55C_" + N);
            println(" ");
          end;
        end;

        println("~M23_" + N);
        income = money(VA_Convert(VsSeq[current + fld_BCCost],{CurDate},VsSeq[current + fld_BCCFI],VsSeq[current + fld_AccFI]) - PrevSum - M43_buf - M44_buf - ОстатокПремии, err, errMsg, true);
        println(income);
        println("~M23C_" + N);
        println(VA_CurrencyWr(income, NATCUR));

        PrevOverDate = ПолучитьДатуПоследнейПереоценкиСделки(dl_tick.DealDate, ID_Operation, CDate);

        ВалютаОбязательства = tickfd.GetDealPayFI();

        //сумма обязательства
        СуммаОбязательства = VA_Convert(VsSeq[current + fld_BCCost],CDate,VsSeq[current + fld_BCCFI],ВалютаОбязательства, err, errMsg, true);
        ВалютаОбязательстваСтр = VA_CurrencyWr(СуммаОбязательства, ВалютаОбязательства);
        println("~M70_" + N);
        println(СуммаОбязательства);
        println("~M70C_" + N);
        println(ВалютаОбязательстваСтр);

        //сумма переоценки обязательства
        if(not VA_IsBarterW(tickfd.GetTick().DealType))
          СуммаПереоцОбязательства = СуммаОбязательства - VA_Convert(VsSeq[current + fld_BCCost],PrevOverDate,VsSeq[current + fld_BCCFI],ВалютаОбязательства, err, errMsg, true); 
          ВалютаОбязательстваСтр = VA_CurrencyWr(abs(СуммаПереоцОбязательства), ВалютаОбязательства);
          Итоги_ПереоцОбязательства.Итого(СуммаПереоцОбязательства, ВалютаОбязательства);
        else
          СуммаПереоцОбязательства = "";
          ВалютаОбязательстваСтр = "";
        end;
        println("~M73_" + N);
        println(СуммаПереоцОбязательства);
        println("~M73C_" + N);
        println(ВалютаОбязательстваСтр);

        current = current + fld_count;
    end; // while()

    N = N + 1;

    // -------------------------------------------------------------------------------
    // Вывод итоговых строк. Начало
    // -------------------------------------------------------------------------------

    Итоги_Дисконт.GetData(0, @ИтогоСуммаДисконта, @ИтогоВалютаДисконта);
    Итоги_Проценты.GetData(0, @ИтогоСуммаПроцентов, @ИтогоВалютаПроцентов);
    Итоги_Премия.GetData(0, @ИтогоСуммаПремии, @ИтогоВалютаПремии);

    println("~M25_1");
    println(money(TBCCost-TPrevSum-ИтогоСуммаДисконта-ИтогоСуммаПроцентов-ИтогоСуммаПремии));
    println("~M25C_1");
    if(income != 0);
      println(VA_CurrencyWr(income,NATCUR));
    else
      println(" ");
    end;

    if(ВидРаспоряжения == DecType[14])
      Итоги_ПереоцОбязательства.GetData(0, @ИтогСуммаПереоцОбязательства, @ИтогВалютаОбязательства);
      if(ИтогВалютаОбязательства != -1)
        println("~M75_1");
        println(ИтогСуммаПереоцОбязательства);
        println("~M75C_1");
        println(VA_CurrencyWr(abs(ИтогСуммаПереоцОбязательства), ИтогВалютаОбязательства));
      else
        println("~M75_1");
        println("");
        println("~M75C_1");
        println("");
      end;
    end;

    // -------------------------------------------------------------------------------
    // Вывод итоговых строк. Конец
    // -------------------------------------------------------------------------------

    rsdqr = " SELECT pm.t_Payer, pm.t_BaseAmount, pm.t_BaseFIID " +
        " FROM dpmpaym_dbt pm " +
        " WHERE pm.t_DocKind = " + dl_tick.BofficeKind + " and pm.t_DocumentID = " + dl_tick.DealID +
        " and pm.t_Purpose = " + PM_PURP_VSBARTERDIFF +
        " ORDER BY pm.t_SubPurpose ";
    DataSet = TRsbDataSet(rsdqr);

    [~M27];
    println(" ");
    [~M28];
    println(" ");
    [~M29];
    println(" ");
    [~M30];
    println(" ");

    while (DataSet.MoveNext)
       pm_Payer      = DataSet.Payer;
       pm_BaseAmount = DataSet.BaseAmount;
       pm_BaseFIID   = DataSet.BaseFIID;

       if (pm_Payer == {OurBank})
         if(pm_BaseAmount != 0)
           [~M27];
           println(pm_BaseAmount);

           if(pm_BaseAmount != 0)
              [~M28];
              println(VA_CurrencyWr(pm_BaseAmount, pm_BaseFIID));
           end;
         end;
       elif(pm_Payer == dl_tick.PartyID)
         if(pm_BaseAmount != 0)
            [~M29];
            println(pm_BaseAmount);
            if(pm_BaseAmount != 0)
               [~M30];
               println(VA_CurrencyWr(pm_BaseAmount, pm_BaseFIID));
            end;
         end;
       end;
    end; // while
    
end;/* End global IF */

END;
/****************************************************************************/
/* Распоряжение в бухгалтерию                                               */
/****************************************************************************/
MACRO СформироватьРаспоряжениеВБухгалтерию(ДатаШага, ВидОперации, Dl_tick, Шаблон,
                                           ВидРаспоряжения, Назначение, ID_Operation, ID_Step)
VAR TempFile,
    DocType, /* Вид документа */
    party,
    rsdqr,
    DataSet;

    ДатаВыполненияШага = ДатаШага;

    DocType = ПолучитьВидДокумента(dl_tick.BofficeKind, dl_tick.DealType);

    party = Tbfile("party.dbt", "R", 0);
    party.Clear();
    party.rec.PartyID = {OurBank};
    party.GetEQ();

    println(Шаблон);
    println(GenFileName());
    статус_шаблона = true;

    [~M0];
    println(party.rec.Name);

    [~M1];
    println(date(ДатаШага) : m);

    [~M2];
    println(GenRef(1050, 3));

    [~M3];
    println(ВидРаспоряжения);

    [~M4];
    println(ВидОперации);

    [~M5];
    println(Назначение);

    [~M6];
    println(date(Min(ДатаШага, {CurDate})));


    rsdqr = " SELECT lv.t_name, sr.t_AltXld, sr.t_SignedDate " + 
        " FROM dspgrdoc_dbt sd, dspground_dbt sr, dllvalues_dbt lv " + 
        " WHERE sd.t_SourceDocKind = " + dl_tick.BofficeKind + " and sd.t_SourceDocID = " + dl_tick.DealID +
        " and sr.t_SpgroundID = sd.t_SpgroundID and sr.t_Kind = " + DocType + " and lv.t_list = " + OBJTYPE_KINDDOC +
        " and lv.t_element = sr.t_Kind " +
        " ORDER BY sd.t_Order ";
    DataSet = TRsbDataSet(rsdqr);

            [~M7];
            println("________________________");

            [~M8];
            println("______");

            [~M9];
            println("__________");    
       
    while(DataSet.MoveNext())

       [~M7];
       println(DataSet.name);

       [~M8];
       println(DataSet.AltXld);

       [~M9];
       println(date(DataSet.SignedDate) : m);
    end;

    party.Clear();
    party.rec.PartyID = dl_tick.PartyID;
    party.GetEQ();

    [~M10];
    println(party.rec.ShortName);


    ПараметрыВекселейБух(VATickFD(dl_tick), ВидОперации, Шаблон, ВидРаспоряжения, Назначение, ДатаШага, ID_Operation, ID_Step);
    
    
    if(dl_tick.avoirkind == AVOIRISSKIND_BILL) 
       [~M40];
       println("Векселедатель");
       [~M41];
       println("Номер векселя");
       [~M42];
       println("Дата составления");
    elif(dl_tick.avoirkind == AVOIRISSKIND_DEPOSIT_CERTIFICATE)  
       [~M40];
       println("Эмитент");
       [~M41];
       println("Номер депозитного сертификата");
       [~M42];
       println("Дата внесения депозита");
    end;

    [~M58];
    println("Агент ВО");

    [~M31];
    if((StrLwr(ВидОперации) == OpType[8]) OR (StrLwr(ВидОперации) == OpType[9]))
       println("Оценочная стоимость");
    else
       println("Цена");
    end;

     /* Завершение вывода */
    TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
    DLWREPS_PrintReportFromTagFile (TempFile);

    SetOutput(NULL, false);
 END;

/****************************************************************************/
/* Печать шапки                                                             */
/****************************************************************************/

PRIVATE MACRO PrHead(ДатаШага, Dl_tick, ВидРаспоряжения, Шаблон, DocType)
VAR flag = TRUE, DealKind, ShortName = "",
    SelfPartyShortName = "", 
    SelfPartyName = "",
    party = Tbfile("party.dbt", "R", 0),
    cmd, DataSet, rsdqr;

    party.Clear();
    party.rec.PartyID = {OurBank};
    if(party.GetEQ())
       SelfPartyName      = party.rec.Name;
       SelfPartyShortName = party.rec.ShortName;
    end;

    [~M0];
    println(SelfPartyShortName);

    [~M1];
    println(GenRef(1050, 4));

    [~M2];
    println(date(ДатаШага));

    [~M3];
    println(date(ДатаШага));

    if(VA_IsClient(dl_tick))
       party.Clear();
       party.rec.PartyID = dl_tick.ClientID;
       if(party.GetEQ())
          ShortName = party.rec.ShortName;
       end;
    else
       ShortName = SelfPartyShortName;
    end;

    [~M4];
    println(ShortName);

    DecreeType(ВидРаспоряжения, dl_tick.flag4);

    if(VA_IsSale(dl_tick.DealType) OR VA_IsBuy(dl_tick.DealType) OR (dl_tick.BofficeKind == DL_VAREPAY))
      DealKind = Bai;
    elif(VA_IsExchange(dl_tick.DealType))
      if (ВидРаспоряжения == DecType[2])
         DealKind = Cai;
      else
         DealKind = Bai;
      end;
    end;

    rsdqr = "SELECT pm.t_PayerBankID, pm.t_ReceiverBankID, pm.t_PayerAccount, pm.t_ReceiverAccount, " +
        "pt_p.t_ShortName PayerName, pt_r.t_ShortName ReceiverName " +
        "FROM dpmpaym_dbt pm, dparty_dbt pt_p, dparty_dbt pt_r " +
        "WHERE pm.t_DocKind = ? and pm.t_DocumentID = ? " +
            " and pm.t_Purpose = ? and pt_p.t_PartyID = pm.t_Payer and pt_r.t_PartyID = pm.t_Receiver " +
        " ORDER BY pm.t_SubPurpose ";
    cmd = RSDCommand(rsdqr);

    cmd.addParam("dk",  RSDBP_IN, dl_tick.BofficeKind);
    cmd.addParam("did", RSDBP_IN, dl_tick.DealID);
    cmd.addParam("pr",  RSDBP_IN, DealKind);
    cmd.execute();
    DataSet = TRsbDataSet(cmd);

    while(DataSet.MoveNext())

      if (flag)
          [~M20];
          party.Clear();
          if((ВидРаспоряжения == DecType[1]) OR (ВидРаспоряжения == DecType[6]) OR (ВидРаспоряжения == DecType[7]))
              party.rec.PartyID = DataSet.PayerBankID;
          elif((ВидРаспоряжения == DecType[2]) OR (ВидРаспоряжения == DecType[5]) OR (ВидРаспоряжения == DecType[8]) OR (ВидРаспоряжения == DecType[10]))
              party.rec.PartyID = DataSet.ReceiverBankID;
          end;    
          if(party.rec.PartyID == {OurBank})
             println(SelfPartyName);
          else
             party.GetEQ();
             println(Party.rec.Name);
          end;
          flag = FALSE;
      end;

      [~M6];
      println(DataSet.PayerAccount);

      [~M8];
      println(DataSet.ReceiverAccount);

      [~M7];
      println(DataSet.PayerName);

      [~M9];
      println(DataSet.ReceiverName);

        
      if(dl_tick.avoirkind == AVOIRISSKIND_BILL) 
         [~M40];
         println("Векселедатель");       
         [~M41];
         println("Вексель");
         [~M42];
         println("Дата составления");
         [~M44];
         println("Для векселей");
      elif(dl_tick.avoirkind == AVOIRISSKIND_DEPOSIT_CERTIFICATE)  
         [~M40];
         println("Эмитент");
         [~M41];
         println("Депозитный сертификат");
         [~M42];
         println("Дата внесения депозита");
         [~M44];
         println("Для депозитных сертификатов");
      end;

      [~M58];
      println("Агент ВО");
    end;

END;
/****************************************************************************/
/* Печать подошвы                                                           */
/****************************************************************************/

PRIVATE MACRO PrFoot(ДатаШага, Dl_tick, ВидРаспоряжения, Шаблон, DocType, КолВек)
VAR stat = 0, TempFile, rsdqr, DataSet;

    [~M10];
    println(КолВек); 
    
    rsdqr = "SELECT sr.t_AltXld, sr.t_SignedDate " + 
        "FROM dspgrdoc_dbt sd, dspground_dbt sr " + 
        "WHERE sd.t_SourceDocKind = " + dl_tick.BofficeKind + " and sd.t_SourceDocID = " + dl_tick.DealID +
        " and sr.t_SpgroundID = sd.t_SpgroundID and sr.t_Kind = " + DocType +
        " ORDER BY sd.t_Order ";
    DataSet = TRsbDataSet(rsdqr);

    [~M18];
    println("______");
    [~M19];
    println("__________");        
    
    while(DataSet.MoveNext())

        [~M18];
        println(DataSet.AltXld);

        [~M19];
        println(date(DataSet.SignedDate));

        /* [~M20] Извлекается из первого векселя. См. выше */

    end;    

    [~M21];
    println(date(ДатаШага));

    /* Завершение вывода */
    TempFile = SetOutPut(GetTxtFileName("tmpout"), FALSE);
    DLWREPS_PrintReportFromTagFile (TempFile);

    SetOutput(NULL, false);
END;
/****************************************************************************/
/* Распоряжение в депозитарий                                               */
/****************************************************************************/

MACRO СформироватьРаспоряжениеВДепозитарий(ДатаШага, ВидОперации, Dl_tick, ВидРаспоряжения, Шаблон,
                                           МенаТипСвязи, ID_Operation, ID_Step)
VAR link_kind = -1,
    N = 0, n_iss = 0,
    iss_size,
    CIssuer = "",/* текущий векселедатель */
    DocType, /* Вид документа */
    query = DL_Select, DataSet;
    статус_шаблона = false;

    DocType = ПолучитьВидДокумента(dl_tick.BofficeKind, dl_tick.DealType);

    if(VA_IsExchange(dl_tick.DealType))
      if(ValType(МенаТипСвязи) == V_UNDEF)
          RETURN 0;
      end;
      link_kind = МенаТипСвязи;
    end;

    iss_size = TArray;

    query.from = 
        "dvsordlnk_dbt lnk, dvsbanner_dbt bnr, ddl_leg_dbt leg, dparty_dbt pt";
    query.where = 
        "bnr.t_BCID = lnk.t_BCID and leg.t_DealID = bnr.t_BCID and leg.t_LegID = 0 and " +
        " leg.t_LegKind = " + LEG_KIND_VSBANNER + " and lnk.t_DocKind = ? /*1*/ " +
        " and lnk.t_ContractID = ? /*2*/ and bnr.t_issuer = pt.t_partyid";

    query.AddParam("DocKind",   RSDBP_IN, dl_tick.BofficeKind);
    query.AddParam("DocID",     RSDBP_IN, dl_tick.DealID);

    query.order = 
        "lnk.t_LinkKind, lnk.t_Issuer";
    if (link_kind != VSORDLNK_K_ALL)
        query.AddWhere(" and lnk.t_LinkKind = ? /*3*/ ");
        query.AddParam("LinkKind",  RSDBP_IN, link_kind);
    end;


    BillsForStep(query, dl_tick.BofficeKind, ID_Operation, ID_Step);

    //количество векселей для каждого векселедателя
    query.select = "count(*) as cnt";
    DataSet = query.Execute();

    DataSet.MoveNext();

    n_iss = DataSet.cnt;
    
var lnk_Issuer, bnr_IssuerName, bnr_BCSeries, bnr_BCNumber, bnr_BCID, bnr_BCTermFormula,
    leg_Principal, leg_PFI, leg_Maturity, leg_Start, leg_Expiry, leg_diff, bnr_AgentName, r;

    query.select = 
        "lnk.t_Issuer, pt.t_ShortName IssuerName, bnr.t_BCSeries, bnr.t_BCNumber, bnr.t_BCID, " +
        "bnr.t_BCTermFormula, leg.t_Principal, leg.t_PFI, leg.t_Maturity, leg.t_Start, leg.t_Expiry, " +
        "leg.t_diff, bnr.t_AgentName ";
    query.group = "";
    query.order = 
        "lnk.t_LinkKind, lnk.t_Issuer, lnk.t_IssueDate, lnk.t_BCID, lnk.t_Start";

    DataSet = query.Execute();

    println(Шаблон);
    println(GenFileName());
    статус_шаблона = true;       
    [~MultipleRow];
    [4];
    println(n_iss - 1);
    PrHead(ДатаШага, Dl_tick, ВидРаспоряжения, Шаблон, DocType);


    while(DataSet.MoveNext() AND статус_шаблона == true)
        N = N + 1;

        lnk_Issuer        = DataSet.Issuer;
        bnr_IssuerName    = DataSet.IssuerName;
        bnr_BCSeries      = DataSet.BCSeries;
        bnr_BCNumber      = DataSet.BCNumber;
        bnr_BCID          = DataSet.BCID;
        bnr_BCTermFormula = DataSet.BCTermFormula;
        leg_Principal     = DataSet.Principal;
        leg_PFI           = DataSet.PFI;
        leg_Maturity      = date(DataSet.Maturity);
        leg_Start         = date(DataSet.Start);
        leg_Expiry        = date(DataSet.Expiry);
        leg_diff          = DataSet.Diff;
        bnr_AgentName     = DataSet.AgentName;
        
        println("~M11_" + N);
        println(bnr_IssuerName);

        println("~M59_" + string(N));
        println(bnr_AgentName);

        println("~M12_" + N);
        println(bnr_BCSeries);

        println("~M13_" + N);
        println(trim(bnr_BCNumber));

        println("~M14_" + N);
        println(leg_Principal);

        println("~M15_" + N);
        println(VA_CurrencyWr(leg_principal, leg_PFI));

        println("~M16_" + N);
        println(leg_Start);

        println("~M17_" + N);
        println(ПолучитьСрокПлатежаПоВекселю(bnr_BCTermFormula,
            leg_Maturity, leg_Start, leg_Expiry, leg_diff));
    end;    

    if(статус_шаблона == true)
    PrFoot(ДатаШага, Dl_tick, ВидРаспоряжения, Шаблон, DocType, N);
    end;
   

RETURN 1;    
END;

/****************************************************************************/
/* END END END END END END END END END END END END END END END END END END E*/
/****************************************************************************/
