/*
$Name:             vaaccreg.mac
$Module:           ñ•≠≠Î• °„¨†£®
$Description:      é‚Á•‚ "ê•£®·‚‡ ¢≠„‚‡•≠≠•£Æ „Á•‚† §•≠•¶≠ÎÂ ·‡•§·‚¢ ® ‡†·Á•‚Æ¢ ØÆ ·§•´™†¨ ® ÆØ•‡†Ê®Ô¨ · Ê•≠≠Î¨® °„¨†£†¨®"
*/

/*******************************************************************************
 DESCRIPTION  :   é‚Á•‚ " ê•£®·‚‡ ¢≠„‚‡•≠≠•£Æ „Á•‚† §•≠•¶≠ÎÂ ·‡•§·‚¢ ® 
                  ‡†·Á•‚Æ¢ ØÆ ·§•´™†¨ ® ÆØ•‡†Ê®Ô¨ · Ê•≠≠Î¨® °„¨†£†¨®"
 PROGRAMMED BY:   ë¢®‡®§•≠™† A.à.
 CREATION DATE:   23.01.07
*******************************************************************************/

// Ñ´Ô WinRep
import "dlRepFun.mac";
import "or_rep_h.mac";
import CurrInter, VAInter, valib, vareport;

import "dlerr_log.mac";

PRIVATE CONST POI_MODE = true;

private VAR
   IsMoneyClient = false,
   IsBank = false, IsClient = false;


PRIVATE CONST BankMF = 21; // É´†¢† Ñë Å†≠™†  

private CONST ALL_ITEM = -1;

private VAR FirstSheet = "";
private var IsBankPrint;
private VAR RepKind = "";
private VAR RepName = "ê•£®·‚‡ ¢≠„‚‡•≠≠•£Æ „Á•‚† §•≠•¶≠ÎÂ ·‡•§·‚¢ ® ‡†·Á•‚Æ¢ ØÆ ÆØ•‡†Ê®Ô¨ · Ê•≠≠Î¨® °„¨†£†¨®";


/*PRIVATE VAR TableHeader =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
"≥ ç†®¨•≠Æ¢†≠®• ≥     Ç®§ ® N        ≥  Ç®§ ® N   ≥  ÇÂÆ§. Æ·‚†‚Æ™ ≥      ë„¨¨† ÆØ•‡†Ê®®     ≥ äÆ¨®··®Ô °†≠™† ≥ê†·ÂÆ§Î ØÆ ≥à·Â.            ≥\n" +
"≥  ‡†·Á•‚≠Æ•©  ≥ ·§•´™®/ÆØ•‡†Ê®®    ≥ Ø•‡¢®Á≠Æ£Æ ≥                ≥         °„¨†£®          ≥                ≥  ·§•´™•   ≥é·‚†‚Æ™         ≥\n" +
"≥   ÆØ•‡†Ê®®   ≥      · Ê/°         ≥  §Æ™„¨•≠‚† ≥                √ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¥                ≥           ≥                ≥\n" +
"≥              ≥                    ≥            ≥                ≥            ≥            ≥                ≥           ≥                ≥\n" +
"≥              ≥                    ≥            ≥                ≥   ë„¨¨†    ≥Ç ‚.Á ™„‡·. ≥                ≥           ≥                ≥\n" +
"≥              ≥                    ≥            ≥                ≥  ÆØ•‡†Ê®®  ≥  ‡†ß≠®Ê†   ≥                ≥           ≥                ≥\n" +
"≥              ≥                    ≥            ≥                ≥            ≥            ≥                ≥           ≥                ≥\n" +
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
"≥    1         ≥          2         ≥      3     ≥      4         ≥     5      ≥      6     ≥        7       ≥     8     ≥        9       ≥\n" +
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";
*/

private VAR TableHeader1 =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
"≥ ç†®¨•≠Æ¢†≠®• ‡†·Á•‚≠Æ©  ≥      Ç®§        ≥        ¸        ≥      Ç®§        ≥       ¸         ≥ ÇÂÆ§. Æ·‚†‚Æ™ ≥        ë„¨¨† ÆØ•‡†Ê®®         ≥ äÆ¨®··®Ô °†≠™† ≥ ê†·ÂÆ§Î ØÆ ≥ à·Â. Æ·‚†‚Æ™ ≥\n"+
"≥       ÆØ•‡†Ê®®          ≥ ·§•´™®/ÆØ•‡†Ê®® ≥ ·§•´™®/ÆØ•‡†Ê®® ≥ ØÆ§‚¢•‡¶§†ÓÈ•£Æ ≥ ØÆ§‚¢•‡¶§†ÓÈ•£Æ ≥               √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥                ≥  ·§•´™•    ≥              ≥\n"+
"≥                         ≥     · Ê/°       ≥     · Ê/°       ≥   §Æ™„¨•≠‚†     ≥    §Æ™„¨•≠‚†    ≥               ≥ ë„¨¨† ÆØ•‡†Ê®® ≥ Ç ‚.Á. ™„‡·. ≥                ≥            ≥              ≥\n"+
"≥                         ≥                 ≥                 ≥                 ≥                 ≥               ≥                ≥  ‡†ß≠®Ê†     ≥                ≥            ≥              ≥\n"+
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private VAR TableHeader2 =
"⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
"≥ ç†®¨•≠Æ¢†≠®• ‡†·Á•‚≠Æ©  ≥      Ç®§        ≥        ¸        ≥       Ç®§       ≥       ¸         ≥ÇÂÆ§. Æ·‚†‚Æ™ ØÆ≥ÇÂÆ§. Æ·‚†‚Æ™ ØÆ≥        ë„¨¨† ÆØ•‡†Ê®®         ≥ äÆ¨®··®Ô °†≠™† ≥ ê†·ÂÆ§Î ØÆ ≥ à·Â. Æ·‚†‚Æ™ ØÆ≥ à·Â. Æ·‚†‚Æ™ ØÆ≥\n"+
"≥       ÆØ•‡†Ê®®          ≥ ·§•´™®/ÆØ•‡†Ê®® ≥ ·§•´™®/ÆØ•‡†Ê®® ≥ ØÆ§‚¢•‡¶§†ÓÈ•£Æ ≥ ØÆ§‚¢•‡¶§†ÓÈ•£Æ ≥ ß†§Æ´¶•≠≠Æ·‚®  ≥ Æ°Ôß†‚•´Ï·‚¢†¨ √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥                ≥  ·§•´™•    ≥ ß†§Æ´¶•≠≠Æ·‚®  ≥ Æ°Ôß†‚•´Ï·‚¢†¨ ≥\n"+
"≥                         ≥     · Ê/°       ≥     · Ê/°       ≥   §Æ™„¨•≠‚†     ≥    §Æ™„¨•≠‚†    ≥ °†≠™† Ø•‡•§    ≥ ™´®•≠‚† Ø•‡•§  ≥ ë„¨¨† ÆØ•‡†Ê®® ≥ Ç ‚.Á. ™„‡·. ≥                ≥            ≥ °†≠™† Ø•‡•§    ≥ ™´®•≠‚† Ø•‡•§  ≥\n"+
"≥                         ≥                 ≥                 ≥                 ≥                 ≥ ™´®•≠‚Æ¨       ≥ °†≠™Æ¨         ≥                ≥  ‡†ß≠®Ê†     ≥                ≥            ≥ ™´®•≠‚Æ¨       ≥ °†≠™Æ¨         ≥\n"+
"√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";


private macro DateToStr( ADate, LongFormat )
   if( LongFormat )
      return string(ADate:f);
   else
      return date_as_string( 1, ADate );
   end;
end;

private macro GetAccount( Chapter, FIID, Account, AccBuf )
   file AccR( "account.dbt" );

   if( Chapter == null ) Chapter = 1; end;
   if( FIID == null ) FIID = 0; end;

   ClearRecord( AccR );
   AccR.Chapter       = Chapter;
   AccR.Code_Currency = FIID;
   AccR.Account       = Account;
   if( GetEQ(AccR) )
      Copy( AccBuf, AccR);
      return true;
   end;
   
   return false;
end;

private macro  èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†( PartyID )
   var _rParty     = TRecHandler( "party.dbt" );
   var party_name = "";
   if( PartyID >= 0 )
     if( not èÆ´„Á®‚Ïë„°Í•™‚†( PartyID, _rParty ) )
        party_name = _rParty.rec.ShortName;
     end;
   end;
   return party_name;
end;

private class (DL_CReportTemplate) va_accreg (_Data)

   private VAR DlRepFormData = _Data, IsFirstUse = true;
   
   private macro PrintMode():INTEGER
      if(DlRepFormData.IsExportToExel)
         return DL_OUTREPORT_EXCEL;
      else
         return DL_OUTREPORT_STD;
      end;
   end;
   
   private macro EndCopyTable()
      EndTable();
      CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
   end;
   
   private macro EndReport()
      SaveTotalBook();
   end;
   
   private macro Register_Table()
      if(IsBankPrint)
         RegisterTable(
            "N1_TableLine", TableHeader1,
            "N1_A2",    "N1_A3",    "N1_A4",    "N1_A5",    "N1_A6",
            "N1_A7",    "N1_A8",    "N1_A9",    "N1_A10",   "N1_A11",   "N1_A12"
         );
      else
         RegisterTable(
            "N1_TableLine", TableHeader2,
            "N1_A2",    "N1_A3",    "N1_A4",    "N1_A5",    "N1_A6",
            "N1_A7",    "N1_A8",    "N1_A9",    "N1_A10",   "N1_A11",
            "N1_A12",   "N1_A12_1", "N1_A12"
         );
      end;
   end;
   
   private macro PrintTitle(s:string, movTo)
      
      if( ValType(movTo) == V_UNDEF )
         movTo = 0;
      end;
      
      PrintFormatString(
         "#",
         "N1_Title", s
      );
      CopyAllSheetInTotalBook(NULL, false, "N1_Title", movTo);
   end;

   private macro PrintSubTitle(s:string, movTo)
      
      if( ValType(movTo) == V_UNDEF )
         movTo = 0;
      end;
      
      PrintFormatString(
         "#",
         "N1_SubTitle", s
      );
      CopyAllSheetInTotalBook(NULL, false, "N1_SubTitle", movTo);
   end;

   private macro PrintHead0(FirstSheet, DepName, onDate) /*Ø•Á†‚Ï ≠† ≠Æ¢Æ© ¢™´†§™•*/

      PrintTitle("î®´®†´: " + DepName,VA_IIF(IsFirstUse,0,1));

      if( IsFirstUse )
         IsFirstUse = false;
      end;

      PrintTitle(RepName);
      
      if( IsBankPrint )
         PrintTitle("ëÁ•‚† „Á•‚† §•≠•¶≠ÎÂ ·‡•§·‚¢");
      else
         PrintTitle("ëÁ•‚† „Á•‚† ‡†·Á•‚Æ¢ · ™´®•≠‚†¨® ØÆ §•≠•¶≠Î¨ ·‡•§·‚¢†¨");
      end;
      
      if(ValType(onDate) == V_UNDEF)
         if( DlRepFormData.BeginDate != DlRepFormData.EndDate )
            PrintTitle(
               "é‚Á•‚≠Î© Ø•‡®Æ§ c " + String(DlRepFormData.BeginDate) + 
               " ØÆ " + String(DlRepFormData.EndDate)
            );            
         else
            PrintTitle(
               "é‚Á•‚≠Î© Ø•‡®Æ§: " + String(DlRepFormData.BeginDate)
            );
         end;
      else
         PrintTitle(
               "é‚Á•‚≠Î© Ø•‡®Æ§: " + String(onDate)
         );
      end;
      
   end;

   private macro PrintHead1( IsClient )
      if( IsMoneyClient != true )
         if( IsClient != false )
            PrintSubTitle("Ñ•≠•¶≠Î• ·‡•§·‚¢† ™´®•≠‚Æ¢", 1);
         else
            PrintSubTitle("ëÆ°·‚¢•≠≠Î• §•≠•¶≠Î• ·‡•§·‚¢† °†≠™†", 1);
         end;
         PrintSubTitle("ë§•´™® · Ê•≠≠Î¨® °„¨†£†¨®");
      else
         PrintSubTitle("ë§•´™® · Ê•≠≠Î¨® °„¨†£†¨®", 1);
      end;
      
   end;

   private macro PrintHead2( IsClient, AccNum, Curency, ClientName, ClientConc, Place, Broker, BrokerContr, NameAcc )
      
      if( IsClient != false )
         PrintSubTitle("ä´®•≠‚: " + string(ClientName) + " / §Æ£Æ¢Æ‡ ¸ " + string(ClientConc),1);
      end;
      
      PrintSubTitle("ã®Ê•¢Æ© ·Á•‚: " + string(AccNum) + "  " + string(NameAcc),1);
      PrintSubTitle("Ç†´Ó‚† ·Á•‚†: " + string(Curency));
      
      if( IsMoneyClient != true )
         PrintSubTitle("å•·‚Æ „Á•‚† ·‡•§·‚¢: " + string(Place));
         
         if( (IsClient != true) AND (Broker != null) )
            PrintSubTitle("ÑÆ£Æ¢Æ‡ · " + string(Broker) + " ¸ " + string(BrokerContr));
         end;
      end;
      
      CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 1 );
      
      Register_Table();
      
   end;

   private macro PrintLineDate( DDate:date )
      var i = 0, count;
      
      if( (DlRepFormData.DivideByDates) OR (DlRepFormData.BeginDate == DlRepFormData.EndDate) )
         return;
      end;
      
      if( IsBankPrint )
         if (DlRepFormData.IsExportToExel)
            Merge("N1_A2", "N1_A12");
         end;
         
         PrintTableLine(
            "N1_A2",    " " + DateToStr(DDate), null,
            "N1_A3",    "",      null,
            "N1_A4",    "",      null,
            "N1_A5",    "",      null,
            "N1_A6",    "",      null,
            "N1_A7",    "",      null,
            "N1_A8",    "",      null,
            "N1_A9",    "",      null,
            "N1_A10",   "",      null,
            "N1_A11",   "",      null,
            "N1_A12",   "",      null
         );
      else
         if (DlRepFormData.IsExportToExel)
            Merge("N1_A2", "N1_A12_1"); //≠†§Æ °Î "N1_A12_2", ≠Æ ≠† ¢·Ó ´®≠®Ó ØÆÁ•¨„-‚Æ ≠• Æ°Í•§®≠Ô•‚
         end;
         
         PrintTableLine(
            "N1_A2",    " " + DateToStr(DDate), null,
            "N1_A3",    "",      null,
            "N1_A4",    "",      null,
            "N1_A5",    "",      null,
            "N1_A6",    "",      null,
            "N1_A7",    "",      null,
            "N1_A8",    "",      null,
            "N1_A9",    "",      null,
            "N1_A10",   "",      null,
            "N1_A11",   "",      null,
            "N1_A12",   "",      null,
            "N1_A12_1", "",      null,
            "N1_A12_2", "",      null
         );
      end;
   end;

   private macro IsPrintNVL( Sum:money, IsPrint:bool )
     if( (not IsPrint) and (Sum == $0) )
        return "";
     end;
     return Sum;
   end;

   private macro PrintLine(
         NameOperation:string,
         NumOperation:string,
         KindOperation:string,
         NumFirstDoc:string,
         KindFirstDoc:string,
         InRest1:money,
         InRest2:money,
         SumOperation:money,
         RateSum:money,
         BankComiss:money,
         PaymDeal:money,
         OutRest1:money,
         OutRest2:money
      )
      
      if( NumFirstDoc == null )
         NumFirstDoc = " ";
      end;
      
      if( KindFirstDoc == null )
         KindFirstDoc = " ";
      end;
      
      if( IsBankPrint )
         PrintTableLine(
            "N1_A2",    NameOperation,                      null,
            "N1_A3",    KindOperation,                      null,
            "N1_A4",    NumOperation,                       null,
            "N1_A5",    KindFirstDoc,                       null,
            "N1_A6",    NumFirstDoc,                        null,
            "N1_A7",    IsPrintNVL( InRest1, true ),        null,
            "N1_A8",    IsPrintNVL( SumOperation, false ),  null,
            "N1_A9",    IsPrintNVL( RateSum, false ),       null,
            "N1_A10",   IsPrintNVL( BankComiss, false ),    null,
            "N1_A11",   IsPrintNVL( PaymDeal, false ),      null,
            "N1_A12",   IsPrintNVL( OutRest1, true ),       null
         );
      else
         PrintTableLine(
            "N1_A2",    NameOperation,                      null,
            "N1_A3",    KindOperation,                      null,
            "N1_A4",    NumOperation,                       null,
            "N1_A5",    KindFirstDoc,                       null,
            "N1_A6",    NumFirstDoc,                        null,
            "N1_A7",    IsPrintNVL( InRest1, true ),        null,
            "N1_A8",    IsPrintNVL( InRest2, true ),        null,
            "N1_A9",    IsPrintNVL( SumOperation, false ),  null,
            "N1_A10",   IsPrintNVL( RateSum, false ),       null,
            "N1_A11",   IsPrintNVL( BankComiss, false ),    null,
            "N1_A12",   IsPrintNVL( PaymDeal, false ),      null,
            "N1_A12_1", IsPrintNVL( OutRest1, true ),       null,
            "N1_A12_2", IsPrintNVL( OutRest2, true ),       null
         );
      end;

   end;

   private macro ExecuteReports(Dep)
     var DataQuery, PrevDep = "", PrevAcc = "", PrevProDate = Date(0, 0, 0), PrevPlace, PrevContr,
         PrevClient = "", PrevCurr, PrintClient = false,
         NameFDoc, NumFDoc, NumOperation, KindOperation,
         PaymDeal, ComissBank, IsPrintRepKind = false,
         InRest = $0, OutRest = $0, QueryDep, DataDep, InRest2 = $0, OutRest2 = $0,
         ExistInfo = false, IsInfo = false, Num = 0,
         continue_cicle = false, select_count, NRec = 0, NRecInAcc = 0;
     var i=0;
     var IsForm, FormSub, IsVid, VidSub, NoResident;

     private macro GetData(DepID, onDate, NRec:@Integer)
       var Query, Data, Categ, ClientCode, NRecData;

       if(IsBank)
         Categ = "530";/*"Ñë Å†≠™†, Çì"*/
       else
          if( IsMoneyClient != true )
             ClientCode = DlRepFormData.SubjectID;
             Categ = "531";/*"Ñë ™´®•≠‚†, Çì"*/
             IsForm = DlRepFormData.IsForm1;
             FormSub =  DlRepFormData.FormSub1;
             IsVid = DlRepFormData.IsVid1;
             VidSub = DlRepFormData.VidSub1;
             NoResident = DlRepFormData.NoResident1;
          else
             ClientCode = DlRepFormData.ClientID;
             Categ = "533";/*"Ñë, ê†·Á•‚Î · ™´®•≠‚Æ¨, Çì"*/
             IsForm = DlRepFormData.IsForm2;
             FormSub =  DlRepFormData.FormSub2;
             IsVid = DlRepFormData.IsVid2;
             VidSub = DlRepFormData.VidSub2;
             NoResident = DlRepFormData.NoResident2;

          end;

          if( ClientCode == {OurBank} )
             IsBank = true;
             IsClient = false;
             Categ = "530";/*"Ñë Å†≠™†, Çì"*/
          end;

       end;

       query =
               " SELECT acc.T_DEPARTMENTID DepID, acc.t_Account Acc, acc.t_Currency Curr," 
             + "        inacc.t_Sum Sum, inacc.t_RateSum RateSum, lvalues.T_NAME OperName, acc.t_Place Place, " 
             + "        fin.t_CCY CurrName, inacc.t_GroundKind, inacc.t_GroundNum, " 
             + "        inacc.t_Date ProDate, inacc.t_DocumentID DocID, inacc.t_DocumentKind DocKind, "  
             + "        inacc.t_Opertype Opertype, inacc.t_DealKind DealKind, oprName.t_Name as tick_name, " 
             + "        utl_raw.cast_to_varchar2(dbms_lob.substr(inacc.t_FmtBlobData_XXXX,2000)) DealNumber, "

             +        " (SELECT dacc.t_nameaccount "
             +           " FROM daccount_dbt dacc "
             +          " WHERE dacc.t_account = acc.t_account "
             +            " AND dacc.t_chapter = acc.t_chapter "
             +            " AND dacc.t_code_currency = acc.t_currency) nameacc, ";

       if( (IsClient) AND (NOT IsBank) )
         query = query + " acc.t_ClientcontrID ClientcontrID, acc.t_Owner Owner,";
       end;

       if( IsBank )
         query = query + " acc.t_BankContrID BankContrID, ";
       end;

       query = query +
              "        DECODE(inacc.t_DealKind,159,DECODE(inacc.t_DebAcc,acc.t_Account,4,1),DECODE(inacc.t_DebAcc,acc.t_Account,3,2)) IsOut "+
              " FROM   ddlinacc_dbt inacc, dfininstr_dbt fin, dllvalues_dbt lvalues, ddl_tick_dbt tk, doprkoper_dbt oprName, " +
              "        (SELECT acc.T_DEPARTMENTID, acc.t_Account, acc.t_Place, ";

       if( IsBank )
          query = query + " acc.t_BankContrID, ";
       end;

       query = query + " acc.t_Currency ";

       if( (IsClient) AND (NOT IsBank) )
          query = query + ", acc.t_Owner, acc.t_ClientcontrID ";
       end;

       query = query + " , acc.t_chapter ";

       query = query + 
              "         FROM   dmcaccdoc_dbt acc";

       if( (IsClient) AND (NOT IsBank) )
          query = query + ", dsfcontr_dbt contr  , dparty_dbt Pt ";
       end;

       query = query +
              "         WHERE  acc.t_CatNum in(" + string(Categ) + ")";

       if( (IsClient) AND (NOT IsBank) )
          if( ClientCode != ALL_ITEM )
             query = query + "AND acc.t_Owner = " + string(ClientCode);
          else
             query = query + "AND ((acc.t_Owner != -1) OR (acc.t_Owner != " + string({OurBank}) + "))";
          end;
          query = query + " AND contr.T_PartyID = Pt.T_PARTYID  ";

          if( (IsForm > 0) and (FormSub != 0) )
             if(IsForm == 1)
               query = query + "    and   Pt.T_LEGALFORM =   " + String (FormSub);
             end;
             if(IsForm == 2)            	
               query = query + "    and   Pt.T_LEGALFORM !=   " + String (FormSub);
             end;
          end;

          if( (IsVid > 0) and (VidSub != 0) )            
             if(IsVid == 1)
               query = query + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (VidSub) +" and Pt.T_PARTYID = Pto.T_PARTYID)  " ;
             end;
             if(IsVid == 2)            	
               query = query + "    and   NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (VidSub)+ " and Pt.T_PARTYID = Pto.T_PARTYID)  " ;
             end;
          end;
      
          if(NoResident)
             query = query + " and  Pt.T_NOTRESIDENT = 'X'  ";
          end;

        else
          query = query + "AND acc.t_Owner = -1 ";
       end;

       query = query +
                       "AND acc.T_DEPARTMENTID = " + string(DepID) + " " +
                       "AND acc.t_Chapter = 21 ";

       if( (IsMoneyClient != true) AND (IsBank))

          if( DlRepFormData.IsFundsOnExchange == SET_CHAR )
             query = query + "AND acc.t_Place ";
             if( DlRepFormData.ExchangeID != ALL_ITEM )
                query = query + " = " + string(DlRepFormData.ExchangeID);
             else
                query = query + "in (SELECT T_PARTYID " +
                             "    FROM DPARTYOWN_DBT " +
                             "    WHERE T_PARTYKIND = 46)";/*PTK_RC_ORCB = 46*/
             end;  
          elif( DlRepFormData.IsFundsInBroker == SET_CHAR )
             query = query + "AND acc.t_Place ";
             if( DlRepFormData.BrokerID != ALL_ITEM )
                query = query + " = " + string(DlRepFormData.BrokerID);
             else
                query = query + "in (SELECT T_PARTYID " +
                             "    FROM DPARTYOWN_DBT " +
                             "    WHERE T_PARTYKIND = " + string(PTCK_INDEPO) + ")";
             end;
          end;
          if( (IsClient) AND (NOT IsBank) )
             query = query + "AND acc.t_ClientcontrID = contr.t_ID " +
                       "AND contr.t_ServKind = " + string(PTSK_VEKSACC);
          end;
       else
          if( DlRepFormData.ContractID != ALL_ITEM )
             query = query + "AND acc.t_ClientcontrID = " + string(DlRepFormData.ContractID);
          else
             query = query + "AND acc.t_ClientcontrID = contr.t_ID " +
                       "AND contr.t_ServKind = " + string(PTSK_VEKSACC);
          end;
       end;

       query = query +
              " GROUP BY  acc.T_DEPARTMENTID, ";

       If( (IsClient) AND (NOT IsBank) )
         query = query +
              " acc.t_Owner, acc.t_ClientcontrID, ";
       end;
       query = query + "acc.t_Account, acc.t_Place,";

       if( IsBank )
         query = query + " acc.t_BankContrID, ";
       end;

       query = query + " acc.t_Currency, acc.t_chapter) acc ";
      


       query = query + "  WHERE (    inacc.T_DEBACC = acc.t_Account "
                     + "          OR inacc.T_KREDACC = acc.t_Account )"
                     + "    AND inacc.T_DEPARTMENT = "+DepID;


       if(ValType(onDate) == V_UNDEF)
          query = query + 
              "   AND inacc.t_Date <=" + GetSQLDate(DlRepFormData.EndDate) +
              "   AND inacc.t_Date >=" + GetSQLDate(DlRepFormData.BeginDate);
       else
          query = query +
              "   AND inacc.t_Date =" + GetSQLDate(onDate);
       end;



       query = query + "  AND inacc.t_DealKind in (141,142,143,144) " 
                     + "  AND (case when inacc.t_opertype in (8,9,10,11,12,13,14,15) then (select count(1) recc "   /*Æ‚°®‡†•¨ Ø‡Æ¢Æ§™® ØÆ ™Æ¨®··®Ô¨, ≠• ·¢Ôß†≠≠Î• · ÆØ´†‚Æ©\†¢†≠·Æ¨*/
                     + "                                               from  ddlinacc_dbt com" 
                     + "                                              where  com.t_Date = inacc.t_date  " 
                     + "                                                and  com.t_DocumentID = inacc.t_DocumentID " 
                     + "                                                and  com.t_DealKind = inacc.t_DealKind " 
                     + "                                                and  ((com.t_DebAcc = acc.t_Account) or (com.t_KredAcc = acc.t_Account))" 
                     + "                                                and  com.t_Opertype in(20,21)) else 0 end ) = 0 " 

                     + "  AND acc.t_Currency = fin.t_FIID ";


       query = query + "  AND tk.t_DealID = inacc.t_DocumentID "
                     + "  AND oprName.t_Kind_Operation = tk.t_DealType ";


       query = query + "   AND lvalues.T_LIST = " + string(OBJTYPE_CALCOPKIND)  
                     + "   AND lvalues.T_ELEMENT = inacc.t_Opertype " 
                     + "   AND (select count(1) from dacctrn_dbt acctrn " 
                     + "         where acctrn.t_AccTrnID = inacc.t_AccTrnID " 
                     + "           and acctrn.t_State = 1) > 0 ";

       query = query + " ORDER BY acc.T_DEPARTMENTID,"; 

       if( (IsClient) AND (NOT IsBank) )
         query = query + " acc.t_Owner, acc.t_ClientcontrID, ";
       end;

       query = query + " acc.t_Account, inacc.t_Date, IsOut ";

       NRecData = TRsbDataSet("select count(1) NRec from ("+query+")");

       Data = TRsbDataSet(query);
       if( Data.MoveNext() )
         if( NRecData.MoveNext() )
           NRec = int(NRecData.NRec);
         end;
         return Data;
       else
         return null;
       end;
     end;

     macro GetInRest( ProDate:date, Currency, Acc)
       var Rest = $0;
       var AccBuf = TRecHandler("account"); 
       ClearRecord( AccBuf );
       if( GetAccount( 21, Currency, Acc, AccBuf ) )/*ØÆ 21 Chapter*/
          OprGetAccountRest( AccBuf.rec.Chapter, AccBuf.rec.Code_Currency, AccBuf.rec.Account, ProDate-1, Rest );
       end;
       return Rest;
     end;

     macro GetOutRest( InRest:money, Sum:money, Comiss:money, IsOut:integer, IsBank:bool )
       var Rest = $0;

       if( (IsOut == 1) or (IsOut == 2) )
          Rest = InRest + Sum;/*•·´® Ø‡Æ®ß¢Æ§®‚·Ô ß†Á®·´•≠®• ≠† ·Á•‚*/
       else
          Rest = InRest - Sum;/*•·´® Ø‡Æ®ß¢Æ§®‚·Ô ·Ø®·†≠®• ·Æ ·Á•‚†*/
       end;

       if( IsBank )
          Rest = Rest + Comiss;
       else
          Rest = Rest - Comiss;
       end;

       return Rest; 
     end;

     macro GetPositivRest( SumAcc )
       if( SumAcc > $0 )
          return SumAcc;
       else
          return $0;
       end;
     end;

     macro GetAbsRest( SumAcc )
       if( SumAcc < $0 )
          return Abs( SumAcc );
       else
          return $0;
       end;
     end;

     private macro èÆ´„Á®‚ÏÑÆ£Æ¢Æ‡( ContrID:integer )
       var Select, Data;
          Select = RSDCommand( "select t_Number NumConc from dsfcontr_dbt where t_id = ?" +
                         " and t_servkind = ?");
          Select.addParam("id", RSDBP_IN, ContrID);
          Select.addParam("servkind", RSDBP_IN, PTSK_VEKSACC);
          Select.execute();
          Data = TRsbDataSet(Select);
          if( Data.MoveNext() )
             return Data.NumConc;
          end;
          return "";
     end;

     private macro GetFirstDoc( GroundKind, XLD)
        var query, Firstdoc, Doc = "";

        query = RSDCommand(" select t_Name from dllvalues_dbt " +
                          "  where t_List = " + string(OBJTYPE_KINDDOC) +
                          "    and t_element = ?"
                         );

        query.addParam("", RSDBP_IN, GroundKind);

        query.execute();

        Firstdoc = TRsbDataSet(query);

        if( Firstdoc.MoveNext() )
           Doc = string(FirstDoc.Name);
        end;

        return Doc;
     end;

     private macro GetDlAcc(OperID)
       var Query, Data;

       Query = RSDCommand("SELECT * " +
                          "FROM ddl_acc_dbt " +
                          "WHERE t_ID = ?");

       Query.addParam("", RSDBP_IN, OperID);
       Query.execute();

       Data  = TRsbDataSet(Query);

       if( Data.MoveNext() )
          return  Data;
       end;

       msgbox("ç• ≠†©§•≠† êé Çì · ID = " + string(OperID));
       return "";
     end;

     private macro GetPaymDeal( DocID:integer, DocKind:integer, Account:string, ProDate:date)/*·„¨¨† Ø‡Æ¢Æ§™®  ØÆ ÆØ´†‚• ™Æ¨®··®® °®‡¶• ®´® ØÆ·‡•§≠®™„*/
        VAR Select, Data, Comiss = $0;
        Select = RSDCommand("select NVL(Sum(inacc.t_Sum),0) PaymDeal " + 
                            "from   ddlinacc_dbt inacc " +
                            " where  inacc.t_Date = ? " + 
                            "   and  inacc.t_DocumentID = ? " + 
                            "   and  inacc.t_DealKind = ? " +
                            "   and  (inacc.t_DebAcc = ? or inacc.t_KredAcc = ?) " +
                            "   and  inacc.t_Opertype in(9,10,12,14,15) " +
                            "   AND (select count(1) from dacctrn_dbt acctrn " +
                            "         where acctrn.t_AccTrnID = inacc.t_AccTrnID " +
                            "           and acctrn.t_State = 1) > 0 ");/*™Æ¨®··®Ô ØÆ·‡•§≠®™„*/

        Select.addParam("", RSDBP_IN, ProDate);
        Select.addParam("", RSDBP_IN, DocID);
        Select.addParam("", RSDBP_IN, DocKind);
        Select.addParam("", RSDBP_IN, Account);
        Select.addParam("", RSDBP_IN, Account);
        Select.execute();

        Data = TRsbDataSet(Select);
        if( Data.MoveNext() )
           Comiss = Comiss + Data.PaymDeal;
        end;
        return Comiss;
     end;

     private macro GetComissBank( DocID:integer, DocKind:integer, Account:string, ProDate:date)/*·„¨¨† Ø‡Æ¢Æ§™® ØÆ ÆØ´†‚• ™Æ¨®··®® °†≠™„*/
        VAR Select, Data, Comiss = $0;
        Select = RSDCommand( "select NVL(Sum(inacc.t_Sum),0) ComissBank " +
                             "from   ddlinacc_dbt inacc " +
                             " where  inacc.t_Date = ? " + 
                             "   and  inacc.t_DocumentID = ? " + 
                             "   and  inacc.t_DealKind = ? " + 
                             "   and  (inacc.t_DebAcc = ? or inacc.t_KredAcc = ?) " +
                             "   and  inacc.t_Opertype in(8,11,13) " +
                             "   AND (select count(1) from dacctrn_dbt acctrn " +
                             "         where acctrn.t_AccTrnID = inacc.t_AccTrnID " +
                             "           and acctrn.t_State = 1) > 0 "); /*™Æ¨®··®Ô °†≠™„*/

        Select.addParam("", RSDBP_IN, ProDate);
        Select.addParam("", RSDBP_IN, DocID);
        Select.addParam("", RSDBP_IN, DocKind);
        Select.addParam("", RSDBP_IN, Account);
        Select.addParam("", RSDBP_IN, Account);
        Select.execute();

        Data = TRsbDataSet(Select);
        if( Data.MoveNext() )
           Comiss = Comiss + Data.ComissBank;
        end;
        return Comiss;
     end;


     macro FormDataString()
       var Client = "", ClientContr = "", Place, Broker, BrokerContr;
       if( IsBank != false)
          if( DataQuery.BankContrID != -1 )/*ä†‚•£Æ‡®Ô "Ñë „ Å‡Æ™•‡†, Çì"*/
             Broker = èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†(DataQuery.Place);
             BrokerContr = èÆ´„Á®‚ÏÑÆ£Æ¢Æ‡( DataQuery.BankContrID );
          else
             Broker = BrokerContr = null;
          end;
       else
          Client = èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†(DataQuery.Owner);/*®¨Ô ® §Æ£Æ¢Æ‡ ™´®•≠‚†*/
          ClientContr = èÆ´„Á®‚ÏÑÆ£Æ¢Æ‡( DataQuery.ClientcontrID ); 
       end;

       InRest = OutRest;

       Place = èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†(DataQuery.Place);

       if( (IsBank != false) and  (IsClient == false) and ( (PrevAcc != DataQuery.Acc) or 
                  (PrevPlace != DataQuery.Place) or (PrevCurr != DataQuery.Curr))
                )
                  if(ExistInfo == true)
                     EndCopyTable();
                  end;

                  PrintHead2( false, DataQuery.Acc, DataQuery.CurrName, null, null, Place, Broker, BrokerContr, DataQuery.NameAcc );
                  PrevProDate = Date(0,0,0);
                  PrevAcc = DataQuery.Acc;
                  PrevCurr = DataQuery.Curr;
                  PrevPlace = DataQuery.Place;
                  InRest = GetInRest( DataQuery.ProDate, DataQuery.Curr, DataQuery.Acc);
       elif( (IsBank == false) and  (IsClient == true) and (IsMoneyClient == false) and
                ((PrevClient != DataQuery.Owner) or (PrevContr != DataQuery.ClientcontrID) or (PrevAcc != DataQuery.Acc) or 
                   (PrevPlace != DataQuery.Place) or (PrevCurr != DataQuery.Curr))
                 )

                  if(ExistInfo == true)
                     EndCopyTable();
                  end;

                  if( (PrevClient != DataQuery.Owner) or (PrevContr != DataQuery.ClientcontrID) )
                       PrintClient = true;
                  end;

                  PrintHead2( PrintClient, DataQuery.Acc, DataQuery.CurrName, Client, ClientContr, Place, null, null, DataQuery.NameAcc );
                  PrevProDate = Date(0,0,0);
                  PrevAcc = DataQuery.Acc;
                  PrevCurr = DataQuery.Curr;
                  PrevClient = DataQuery.Owner;
                  PrevContr = DataQuery.ClientcontrID;
                  PrevPlace = DataQuery.Place;
                  InRest = GetInRest( DataQuery.ProDate, DataQuery.Curr, DataQuery.Acc);

                  PrintClient = false;
       elif( (IsBank == false) and  (IsClient == true) and (IsMoneyClient == true) and 
               ( (PrevClient != DataQuery.Owner) or (PrevContr != DataQuery.ClientcontrID) or (PrevAcc != DataQuery.Acc) or
                   (PrevCurr != DataQuery.Curr)))

                  if(ExistInfo == true)
                     EndCopyTable();
                  end;

                  if( (PrevClient != DataQuery.Owner) or (PrevContr != DataQuery.ClientcontrID) )
                       PrintClient = true;
                  end;

                  PrintHead2( PrintClient, DataQuery.Acc, DataQuery.CurrName, Client, ClientContr, null, null, null, DataQuery.NameAcc);
                  PrevProDate = Date(0,0,0);
                  PrevAcc = DataQuery.Acc;
                  PrevCurr = DataQuery.Curr;
                  PrevClient = DataQuery.Owner;
                  PrevContr = DataQuery.ClientcontrID;
                  PrevPlace = DataQuery.Place;

                  InRest = GetInRest( DataQuery.ProDate, DataQuery.Curr, DataQuery.Acc);

                  PrintClient = false;
       end;

       if( PrevProDate != DataQuery.ProDate )
          PrintLineDate( DataQuery.ProDate );
          PrevProDate = DataQuery.ProDate;
       end;

       NameFDoc = GetFirstDoc( DataQuery.GroundKind, DataQuery.GroundNum );
       NumFdoc = DataQuery.GroundNum;

       KindOperation = DataQuery.tick_name;

       if( DataQuery.DealKind == 159 )
          NumOperation = GetDlAcc(DataQuery.DocID).Code;
       elif( DataQuery.DealKind == DL_STOCKCONTR )
          NumOperation = èÆ´„Á®‚ÏÑÆ£Æ¢Æ‡(DataQuery.DocID);
       else
          NumOperation = DataQuery.DealNumber;
       end;

       if( (DataQuery.Opertype == 20) OR (DataQuery.Opertype == 21) )/*ÆØ´†‚† ·§•´™® ®´® †¢†≠·†*/
          PaymDeal = GetPaymDeal( DataQuery.DocID, DataQuery.DealKind, DataQuery.Acc, DataQuery.ProDate);
          if( IsBank != true)
             ComissBank = GetComissBank( DataQuery.DocID, DataQuery.DealKind, DataQuery.Acc, DataQuery.ProDate);
          else
             ComissBank = $0;
          end;
       else
          PaymDeal = $0;
          ComissBank = $0;
       end;

       if( (IsMoneyClient == true) AND (IsClient == true) ) /*ëÁ•‚† „Á•‚† ‡†·Á•‚Æ¢ · ™´®•≠‚†¨® ØÆ §•≠•¶≠Î¨ ·‡•§·‚¢†¨*/

          OutRest = GetOutRest( InRest, DataQuery.Sum, (ComissBank + PaymDeal), DataQuery.IsOut, false );  

          PrintLine( 
             DataQuery.OperName, 
             NumOperation, KindOperation, 
             NumFDoc,  NameFDoc, 
             GetPositivRest(InRest), GetAbsRest(InRest), DataQuery.Sum, 
             DataQuery.RateSum, ComissBank, 
             PaymDeal, 
             GetPositivRest(OutRest), GetAbsRest(OutRest)
          );
       else /*§•≠•¶≠Î• ·‡•§·‚¢† °†≠™†*/
          OutRest = GetOutRest( InRest, DataQuery.Sum, (ComissBank + PaymDeal), DataQuery.IsOut, true );

          PrintLine( 
             DataQuery.OperName, 
             NumOperation, KindOperation, 
             NumFDoc, NameFDoc, 
             InRest, null, 
             DataQuery.Sum, DataQuery.RateSum, 
             ComissBank, PaymDeal, OutRest, null
          );
       end;         
       ExistInfo = true;
       IsInfo = true;
     end;


     macro PrintDep( DepCode, IsPrintClient:bool, onDate:date )
       var j=0;
       if( DataQuery )
          if( PrevDep != DepCode )

             if(ExistInfo == true)
                ExistInfo = false;
                EndCopyTable();
             end;

             PrintHead0( DepCode, DL_GetDepartmentNameByCode( DepCode ), onDate );
             PrevDep = DepCode;
          end;

          if( IsPrintRepKind )
             if(ExistInfo == true)
                ExistInfo = false;
                EndCopyTable();
             end;
             PrintHead1(IsPrintClient);
             IsPrintRepKind = false;
          end;

          continue_cicle = true;

          InitProgress( NRecInAcc, "é‚Á•‚: " + RepName, "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚† " + RepKind );
          while( continue_cicle )
             FormDataString();
             continue_cicle = DataQuery.MoveNext();
             UseProgress(j=j+1);
          end;

          RemProgress();
       end;
     end;
     

     macro FormBankClientMoneyOnDate(DepCode,IsClientCalc:bool,onDate:date)
       if( not IsClientCalc )

          if( DlRepFormData.IsBankAccounts == SET_CHAR )
             IsBank = true;
             IsClient = false;
             IsMoneyClient = false;
             IsPrintRepKind = true;
             DataQuery = GetData( DepCode, onDate, @NRecInAcc );
             PrintDep(DepCode, IsClient, onDate);
          end;

          if( DlRepFormData.IsClientsAccounts == SET_CHAR )
             IsBank = false;
             IsClient = true;
             IsMoneyClient = false;
             IsPrintRepKind = true;
             DataQuery = GetData( DepCode, onDate, @NRecInAcc);
             PrintDep(DepCode, IsClient, onDate);
          end;

       else
          IsBank = false;
          IsClient = true;
          IsMoneyClient = true;
          IsPrintRepKind = true;
          DataQuery = GetData( DepCode, onDate, @NRecInAcc);
          PrintDep(DepCode, IsClient, onDate);

       end;
     end;
     

     macro FormBankClientMoney(DepCode, IsClientCalc:bool)
       var onDate:date;

       if(DlRepFormData.DivideByDates)
          onDate = DlRepFormData.BeginDate;
          while(onDate <= GetDateAfterWorkDays(DlRepFormData.EndDate,0))
             PrevDep = "";
             PrevAcc = "";
             PrevProDate = Date(0, 0, 0);
             PrevClient = "";
             FormBankClientMoneyOnDate(DepCode,IsClientCalc,onDate);
             onDate = GetDateAfterWorkDays(onDate,1); 
          end;
       else
          FormBankClientMoneyOnDate(DepCode,IsClientCalc);
       end;

       if(ExistInfo)
          EndCopyTable();
       end;
     end;
     
     macro FormDepartment(DepCode)
       /*ëÁ•‚† „Á•‚† §•≠•¶≠ÎÂ ·‡•§·‚¢*/
       if( ((IsBankPrint) AND (DlRepFormData.IsMakeMF_Report == SET_CHAR)) AND ((DlRepFormData.IsBankAccounts == SET_CHAR) OR /*§•≠. ·‡-¢† °†≠™†*/
            (DlRepFormData.IsClientsAccounts == SET_CHAR) ) /*§•≠. ·‡-¢† ™´®•≠‚Æ¢*/
         )
          ExistInfo = false;
          FormBankClientMoney(DepCode,false);
       end;
       /*ëÁ•‚† „Á•‚† ‡†·Á•‚Æ¢ · ™´®•≠‚†¨® ØÆ §•≠•¶≠Î¨ ·‡•§·‚¢†¨*/
       if( (not IsBankPrint) AND (DlRepFormData.IsMakeClientsSA_Report == SET_CHAR) ) 
          ExistInfo = false;
          FormBankClientMoney(DepCode,true);
       end;
     end;
     
     if( (DlRepFormData.IsMakeMF_Report == SET_CHAR) OR (DlRepFormData.IsMakeClientsSA_Report == SET_CHAR) )
         if( Dep == ALL_ITEM )
            QueryDep =
                     "select t_code Code " +
                     "from   ddp_dep_dbt";

            DataDep = TRsbDataSet(QueryDep);

            select_count = TRsbDataSet("select count(1) NRec from ("+QueryDep+")");

            if( select_count.MoveNext() )
               NRec = int( select_count.NRec );
            end;

            InitProgress(  NRec, "è‡Æ·¨Æ‚‡ ‰®´®†´Æ¢ ", "è‡Æ·¨Æ‚‡ ‰®´®†´Æ¢ " );
            while( DataDep.MoveNext() )
               UseProgress(i = i + 1);
               FormDepartment(DataDep.Code);
            end;
            RemProgress();
         else
            FormDepartment(Dep);
         end;
      end;
      return IsInfo;
   end;

   private macro BeginReport()
      var noData = "ç•‚ §†≠≠ÎÂ, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†.";

      CreateTotalBook();
      SetActiveSheet( "L1" );
      
      if( not ExecuteReports(DlRepFormData.DepartmentID) )
         PrintFormatString("#\n","N1_NoData", noData);
         
         CopyAllSheetInTotalBook( NULL, false, "N1_NoData", 0 );
      else
         AddStandardFooter("N1_");
         CopyAllSheetInTotalBook(NULL, false, "N1_Footer", 1);
      end;
   end;
   
   if(IsBankPrint)
      initDL_CReportTemplate(NULL, "Report_regmoney1.xlsx", NULL, NULL, NULL, true, true);
   else
      initDL_CReportTemplate(NULL, "Report_regmoney2.xlsx", NULL, NULL, NULL, true, true);
   end;

end;

macro MakeReport1( DataFromForm )

  VAR Dep;
   
  if( DataFromForm.ContractID == 0 )
     DataFromForm.ContractID = -1;
  end;
  RepKind = "ëÁ•‚† „Á•‚† §•≠•¶≠ÎÂ ·‡•§·‚¢";
  
  IsBankPrint = true;
  va_accreg(DataFromForm).Run();

end;

macro MakeReport2( DataFromForm )
   VAR Dep;
   
   RepKind = "ëÁ•‚† „Á•‚† ‡†·Á•‚Æ¢ · ™´®•≠‚†¨® ØÆ §•≠•¶≠Î¨ ·‡•§·‚¢†¨";

   IsBankPrint = false;
   va_accreg(DataFromForm).Run();
end;

