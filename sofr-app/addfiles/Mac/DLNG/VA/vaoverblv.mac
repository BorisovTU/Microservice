/*
$Name:         vaoverblv.mac
$Module:       Учтенные векселя
$Description:  Переоценка балансовой стоимости
*/
IMPORT OprInter, VSInter, vsdisc, vscateg, vsrep, vsconv, vaoverblval, vaprdec, vaprdeca;

VAR srvdoc = 0; /* В эту переменную будет передан сервисный документ 
                   (TRecHandler, структура vssrvdoc) */

MACRO ExecuteStep(Buffer, FirstDoc)
  var stat = 0;
  var Дата={curdate};
  var ObjType = OverObjType;
  record bnr (vsbanner);
  record tick(dl_tick);
  record ntg( dl_nett );

  if((ObjType == VAOVER_OBJTYPE_BALANCEDEAL)) //переоценка Т/О сделки на балансе
   SetBuff( tick, FirstDoc );
   stat = ПереоценкаБССделки(tick, ObjType, Дата);
  elif((ObjType == VAOVER_OBJTYPE_AVOIRISS)) //переоценка Т/О сделки на балансе
   SetBuff( bnr, FirstDoc );
   stat = ПереоценкаБСВекселя(bnr.BCID, Дата)
  elif((ObjType == VAOVER_OBJTYPE_ENDORSEMENT)) //переоценка Т/О сделки на балансе
    SetBuff( bnr, FirstDoc );
    stat = ПереоценкаБСИндоссамента(bnr.BCID, Дата)
  elif((ObjType == VAOVER_OBJTYPE_NETTING)) //переоценка Т/О сделки на балансе
    SetBuff( ntg, FirstDoc );
    ПереоценкаБСНеттинга(ntg, Doc)
  end;


  return stat;
END;

/*
Функция печати распоряжений
*/
PRIVATE MACRO PrintDec(ManPr, ID_Operation, ID_Step)
VAR CDate;
    if((NOT (ManPr > 0)) AND (NOT (AutoPrint())))
        return FALSE;
    end;

    CDate = GetPlanDate(ID_Operation, ID_Step);

    InitDecType(DecType);
    InitDecPurp(DecPurp);
    InitOpType(OpType);

    record dl_t (dl_tick);

/* Attributs begin */
    if (NOT ПолучитьСделку(ID_Operation, dl_t))
       return FALSE;
    end;

    if(not VA_IsExchange(dl_t.DealType))
      СформироватьРаспоряжениеВБухгалтерию(CDate, OpType[16], dl_t, "OF16.dot", DecType[15], DecPurp[22], ID_Operation, ID_Step);
    else
      СформироватьРаспоряжениеВБухгалтерию(CDate, OpType[16], dl_t, "OF17.dot", DecType[15], DecPurp[23], ID_Operation, ID_Step);
    end;
/* Attributs end */

    return TRUE;
END;

/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    PrintDec(MAN_PRINT, ID_Operation, ID_Step);

    PrintDecAccOpen(MAN_PRINT, ID_Operation, ID_Step, Kind_Operation, OpAccTemplName);

    exit(1);

END;