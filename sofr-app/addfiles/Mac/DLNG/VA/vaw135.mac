/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vax135.mac
  Programmer  : Nikonorov Evgeny
  Операция    : Мена векселей
  Шаг         : Оформление дисконта по принимаемым векселям

  !!! начиная c 2030.43 не используется
└───────────────────────────────────────────────────────────────────────────*/
IMPORT VAInter, DealsInter, Календарь,
       vacateg, vaacc, vaopr, va4each, vsbnrfd, vatickfd, vawdates, vadepo, varepay, vamisc, vaprdeca, vaprdslib;

PRIVATE var StepDate = {curdate};

MACRO ExecuteStep(Buffer, dl_tick, DocKind, ID_Operation, ID_Step)
  
  var err = 0;
  var IncGroup, PrDsParm;

  record tick("dl_tick");
  SetBuff( tick, dl_tick );

  GetOprDate( DATE_XW_NEW, @StepDate );

  IncGroup = VACollectIncome(StepDate);
  PrDsParm = VAPrDsParm(@IncGroup, ID_Operation, ID_Step);

  err = VA_ForEachBanner(tick, @ВыполнитьДоначислениеДисконтаОднойЦБ, VSORDLNK_K_BUY, PrDsParm, "BL");

  return err;

END;


/* Функция печати распоряжений
*/
PRIVATE MACRO PrintDec(ManPr, ID_Operation, ID_Step)
VAR CDate;

    if((NOT (ManPr > 0)) AND (NOT (AutoPrint())))
        return FALSE;
    end;

    CDate = GetPlanDate(ID_Operation, ID_Step);

    InitDecType(DecType);
    InitDecPurp(DecPurp);
    InitOpType(OpType);

    record dl_t (dl_tick);

    if (NOT ПолучитьСделку(ID_Operation, dl_t))
       return FALSE;
    end;
    
    СформироватьРаспоряжениеВБухгалтерию(date(CDate), OpType[0], dl_t, "OF13.dot", DecType[13], DecPurp[19], ID_Operation, ID_Step);

    return TRUE;
END;

/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */
    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    PrintDec(AUTO_PRINT, ID_Operation, ID_Step);

    PrintDecAccOpen(AUTO_PRINT, ID_Operation, ID_Step, Kind_Operation, OpAccTemplName);

    return 1;

END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    PrintDec(MAN_PRINT, ID_Operation, ID_Step);

    PrintDecAccOpen(MAN_PRINT, ID_Operation, ID_Step, Kind_Operation, OpAccTemplName);

    exit(1);
END;
