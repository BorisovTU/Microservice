/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  File Name   : vaopr.mac
  Programmer  : Велигжанин А.В.
  Module      : Учтенные векселя
  Comment     : Работа с операциями
  Функции     : 
└───────────────────────────────────────────────────────────────────────────*/
IMPORT RsbDataSet, CTInter;

/* Возвращает дату исполнения шага с символом 'symb'
*/
MACRO VA_GetPerformDate(symb, oprid, retdate:@variant)
var
   Ok, oprstep = TBfile("oprstep.dbt");

   oprstep.KeyNum = 8;
   oprstep.rec.ID_Operation = oprid;
   oprstep.rec.IsExecute = "X";   /* выполненный шаг */
   oprstep.rec.Symbol = symb;
   Ok = oprstep.GetEQ;

   if(Ok)
     retdate = oprstep.rec.Plan_date;
   else
     retdate = date(0,0,0);
   end;

   return Ok;
END;


//MACRO ПолучитьОперациюПоСделке( dl_tick, oproper )
// Функция ищет экземпляр операции, начатой по сделке
MACRO VA_GetOperationByTick( dl_tick, oproper )
var tick = TRecHandler("dl_tick.dbt");

    Copy( tick, dl_tick);

    oproper.KeyNum = 1;
    oproper.rec.DocKind    = tick.rec.BofficeKind;   
    oproper.rec.DocumentID = UniID( tick, OBJTYPE_VEKSELACCOUNTED );
    oproper.rec.Start_Date = tick.rec.DealDate; 

    if( not oproper.GetEQ )
       return false;
    end;

    return true;
END;

// Проверяем все ли шаги операции выполнены (кроме шага закрытия) #94138
MACRO CheckAllStepsExecuted(ID_Operation)
var DataSet, stat, notExecutedStepsCount;

    stat = true;

    DataSet = TRsbDataSet("SELECT count(t_id_step) FROM doprstep_dbt " +
        " Where T_ID_Operation = " + ID_Operation +
        " and T_isexecute<>'X'" );
   
    notExecutedStepsCount = -1;

    if(DataSet.MoveNext())
      notExecutedStepsCount = DataSet.value(0);
    end;
    
    // Если ошибка или более одного невыполненного шага  возвращаем ошибку
    if (notExecutedStepsCount != 1 )
     stat = false;
    end;

  return stat;
END;
