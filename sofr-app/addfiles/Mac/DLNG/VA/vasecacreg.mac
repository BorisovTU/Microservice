/*
 $Name:          vasecacreg.mac
 $Module:        Учтённые векселя
 $Description:   Отчет " Регистр внутреннего учета денежных средств и расчетов по сделкам и операциям с ценными бумагами"
*/
import RsbDataSet;
import "spRepFun.mac";
import "or_rep_h.mac";

PRIVATE VAR TableHeader1 =
"┌──────────────┬────────────┬────────────┬─────────────────┬─────────────────┬────────┬────────┬────────┐\n" +
"│ Наименование │    Вид     │      N     │       Вид       │        N        │  Вход. │ Кол-во │  Исх.  │\n" +
"│  расчетноей  │   сделки   │   сделки   │ подтверждающего │ подтверждающего │остаток,│   ц/б  │остаток,│\n" +
"│   операции   │ (операции) │ (операции) │    документа    │    документа    │   шт.  │        │   шт.  │\n" +
"│              │   с ц/б    │   с ц/б    │                 │                 │        │        │        │\n" +
"│              │            │            │                 │                 │        │        │        │\n" +
"│              │            │            │                 │                 │        │        │        │\n" +
"│              │            │            │                 │                 │        │        │        │\n" +
"├──────────────┼────────────┼────────────┼─────────────────┼─────────────────┼────────┼────────┼────────┤";
                                   
                                   
PRIVATE VAR TableHeader2 =
"┌──────────────┬────────────┬────────────┬─────────────────┬─────────────────┬────────┬────────────┬────────┬─────────────┬────────┐\n" +
"│ Наименование │    Вид     │      N     │       Вид       │        N        │  Вход. │Вход.остаток│ Кол-во │ Исх.остаток │  Исх.  │\n" +
"│  расчетноей  │   сделки   │   сделки   │ подтверждающего │ подтверждающего │остаток,│  по обяза- │   ц/б  │  по обяза-  │остаток,│\n" +
"│   операции   │ (операции) │ (операции) │    документа    │    документа    │   шт.  │  тельсвам  │        │  тельсвам   │   шт.  │\n" +
"│              │   с ц/б    │   с ц/б    │                 │                 │        │  клиента   │        │  клиента    │        │\n" +
"│              │            │            │                 │                 │        │перед банком│        │ перед банком│        │\n" +
"│              │            │            │                 │                 │        │            │        │             │        │\n" +
"│              │            │            │                 │                 │        │            │        │             │        │\n" +
"├──────────────┼────────────┼────────────┼─────────────────┼─────────────────┼────────┼────────────┼────────┼─────────────┼────────┤";

PRIVATE CONST ALL_ITEM = -1; // Пункт Меню: ВСЕ

PRIVATE CONST BANKACC   = 0,
              CLIENTACC = 1;

PRIVATE VAR RKIND = TArray();
RKIND[BANKACC] = "Счета учета ценных бумаг";
RKIND[CLIENTACC] = "Счета расчетов с клиентами по ценным бумагам";

PRIVATE VAR RTABLE = TArray();
RTABLE[BANKACC] = TableHeader1;
RTABLE[CLIENTACC] = TableHeader2;

/////////////////////////////////////////////////////////////////////////////////////////////////////////

private var DlAccountsFormData;
private var Rep;
var Sec_Accounts;
var IsNotEof;
var RepKind;
var IsNeedAddSheet = false;

const FontBold =  "ex_FS(b)";
const FontTitle = "ex_FS(b):ex_FN(Arial):ex_FZ(12)";

var TotalCount = 0;
var sqlQuery;

/////////////////////////////////////////////////////////////////////////////////////////////////////////
private macro AddNewSheet(StrRep, Table)
   Rep.AddNewSheetBreak( StrRep, Table );
   Rep.SetExecute("iBook.Sheets("+(Rep.CurSheet+1)+").PageSetup.zoom=100");
end;
/*<H1.1>*/
private macro DigitIsApp(Digit)
  if(Digit)
    if(DlAccountsFormData.IsUseOpostrofs)
      return string(Digit:a);
    else
      return string(Digit);
    end;
  else
    return "";
  end;
end;

/*Тело отчета*/                                                                      
////////////////////////////////////////////////////////////////////////////////////////////////////////
macro GetAccounts_1()
   var categ;
     if(DlAccountsFormData.SubjectID == {OurBank})
        categ = " = 551 ";
     else                                                                                   
       if(DlAccountsFormData.SubjectID != ALL_ITEM)
         categ = " = 561 ";
       else
         if(DlAccountsFormData.SubjectID == ALL_ITEM)
           categ = " in (551, 561) ";
         end;
       end;
     end;                                                                                   
     sqlQuery = " SELECT acc.t_Account Acc, inacc.t_DebAcc DebAcc, acc.t_DepartmentID DepID, acc.t_Owner Owner, " +
    "        acc.t_Place Place, acc.t_Fiid Fiid, acc.t_Clientcontrid Clientcontrid, acc.t_Currency Currency, " +
                "        inacc.t_Opertype Opertype, inacc.t_DealKind DealKind, " +
      "        inacc.t_Date ProDate,  inacc.t_GroundKind, inacc.t_GroundNum," +
    "        inacc.t_DocumentKind DocKind, inacc.t_DocumentID DocID, inacc.t_Sum Sum, inacc.t_Chapter Chapter, " +
    "        sf.t_number numconc, sf.t_dateconc dateconc, opr.t_Name as OprName, " +
    "        party.T_SHORTNAME IssuerName, lvalues.T_NAME OperationName, " +
    "        tk.t_DealCode, fin.t_Name AvrName, fin.t_FI_Code AvrCode, avrk.t_AvoirKind AvoirKind, avrk.t_Name as AvrkName, " +
    "        bnr.t_FIID BnrFIID, bnr.t_BCSeries, trim(bnr.t_BCNumber) as BCNumber, " +
    "        pt.t_ShortName as DepartmentName, " +
    "        ( select " +
    "            (select a2.t_NameAccount from daccount_dbt a2 where a2.t_Account = acc.t_Account and a2.t_Chapter = acc.t_Chapter and a2.t_Code_Currency = acc.t_Currency) " +
    "          from dual " +
    "        ) as NameAccount " +
    " FROM   ddlinacc_dbt inacc, dparty_dbt party, dllvalues_dbt lvalues, ddp_dep_dbt dp, dparty_dbt pt, " +
    "        dvsordlnk_dbt lnk, dvsbanner_dbt bnr, ddl_tick_dbt tk, doprkoper_dbt opr, dfininstr_dbt fin, davrkinds_dbt avrk, ";
     sqlQuery =sqlQuery +
    "        (SELECT acc.t_Account, acc.t_DepartmentID, acc.t_Place, " + 
                "                acc.t_Owner, acc.t_Fiid, acc.t_Clientcontrid, acc.t_Currency, acc.t_Chapter, acc.t_DocID " +
                "        FROM   dmcaccdoc_dbt acc " +
                "        WHERE  acc.t_CatNum" + categ +
                "          AND  acc.t_Chapter = 22 " +
                "        GROUP BY acc.t_DepartmentID, acc.t_Owner, acc.t_Place, acc.t_Fiid, acc.t_Account, " +
    "        acc.t_Clientcontrid, acc.t_Currency, acc.t_Chapter, acc.t_DocID) acc left join dsfcontr_dbt sf on sf.t_id = acc.t_Clientcontrid " +    

             "   left outer join dparty_dbt Pty " +
             "     on  Pty.T_PARTYID =  case when acc.T_Owner  = -1 then " + {OurBank} +"   else acc.T_Owner end "+

    " WHERE ((inacc.t_DebAcc = acc.t_Account) or (inacc.t_KredAcc = acc.t_Account)) " +
      "        AND inacc.t_DealKind in (141,142,143,144) "  +
    "          AND lnk.t_ContractID = inacc.t_DocumentID " +
    "          AND lnk.t_DocKind = inacc.t_DocumentKind " +
    "          AND lnk.t_BCID = acc.t_DocID " +
    "          AND bnr.t_BCID = lnk.t_BCID " +
    "          AND bnr.t_Issuer NOT IN (select t_PartyID from ddp_dep_dbt)" +
    "          AND party.t_PartyID = bnr.t_Issuer " +
    "          AND tk.t_DealID = lnk.t_ContractID "
    "          AND tk.t_BOfficeKind = lnk.t_DocKind "
    "          AND opr.t_Kind_Operation = tk.t_DealType "+
    "          AND fin.t_FIID = bnr.t_FIID " +
    "          AND avrk.t_FI_Kind = fin.t_FI_Kind " +
    "          AND avrk.t_AvoirKind = fin.t_AvoirKind " +
    "          AND lvalues.T_LIST = " + OBJTYPE_CALCOPKIND + ""
    "          AND lvalues.T_ELEMENT = inacc.t_Opertype " +
    "          AND inacc.t_Date <=" + GetSQLDate(DlAccountsFormData.EndDate) +
    "          AND inacc.t_Date >=" + GetSQLDate(DlAccountsFormData.BeginDate) +
    "          AND dp.t_Code = acc.t_DepartmentID " +
    "          AND pt.t_PartyID = dp.t_PartyID ";

     if( DlAccountsFormData.DepartmentID != ALL_ITEM )
       sqlQuery = sqlQuery + "AND acc.t_DepartmentID = " + String( DlAccountsFormData.DepartmentID );
     end;
     if( DlAccountsFormData.SubjectID != ALL_ITEM )
         sqlQuery = sqlQuery + "AND acc.t_Owner = " + String( DlAccountsFormData.SubjectID );
     end;

     if(DlAccountsFormData.SubjectID != {OurBank} )

     if( (DlAccountsFormData.IsForm1 > 0) and (DlAccountsFormData.FormSub1 != 0) )
       if(DlAccountsFormData.IsForm1 == 1)
         sqlQuery = sqlQuery + "    and   ((Pty.T_LEGALFORM = " + String (DlAccountsFormData.FormSub1)+ " ) or (acc.T_Owner  = -1)) " ;
       end;
       if(DlAccountsFormData.IsForm1 == 2)            	
         sqlQuery = sqlQuery + "    and   ((Pty.T_LEGALFORM != " + String (DlAccountsFormData.FormSub1)+ " ) or (acc.T_Owner  = -1)) " ;
       end;
     end;

     if( (DlAccountsFormData.IsVid1 > 0) and (DlAccountsFormData.VidSub1 != 0) )            
       if(DlAccountsFormData.IsVid1 == 1)
         sqlQuery = sqlQuery + "   and   (( EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (DlAccountsFormData.VidSub1) +" and Pty.T_PARTYID = Pto.T_PARTYID)) or (acc.T_Owner  = -1) )  " ;
       end;
       if(DlAccountsFormData.IsVid1 == 2)            	
         sqlQuery = sqlQuery + "    and  (( NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (DlAccountsFormData.VidSub1)+ " and Pty.T_PARTYID = Pto.T_PARTYID)) or ( acc.T_Owner  = -1) )  " ;
       end;
     end;

     if(DlAccountsFormData.NoResident1)
       sqlQuery = sqlQuery + " and  ((Pty.T_NOTRESIDENT = 'X') or (acc.T_Owner  = -1) )  ";
     end;

     end;

     if( DlAccountsFormData.AccountingPlace != ALL_ITEM )
       sqlQuery = sqlQuery + "AND acc.t_Place = " + String( DlAccountsFormData.AccountingPlace );
     end;
     if( DlAccountsFormData.SecurIssue != ALL_ITEM )
       sqlQuery = sqlQuery + "AND fin.T_FIID = " + String( DlAccountsFormData.SecurIssue );
     end;
     if( DlAccountsFormData.Issuer_1 != ALL_ITEM )
       sqlQuery = sqlQuery + "AND party.T_PARTYID = " + String( DlAccountsFormData.Issuer_1 );  
     end;
     if( DlAccountsFormData.SecurKind_1 != ALL_ITEM )
       sqlQuery = sqlQuery + "AND avrk.T_AVOIRKIND = " + String( DlAccountsFormData.SecurKind_1 );
     end;

     sqlQuery = sqlQuery +    "   AND (select count(1) from dacctrn_dbt acctrn " +
                              "         where acctrn.t_AccTrnID = inacc.t_AccTrnID " +
                              "           and acctrn.t_State = 1) > 0 ";

     if( DlAccountsFormData.IsSeparatelyDate == "X" )
        sqlQuery = sqlQuery + "ORDER BY acc.t_DepartmentID, inacc.t_Date, acc.t_Owner, bnr.t_FIID, acc.t_Account, inacc.t_DebAcc";
     else
        sqlQuery = sqlQuery + "ORDER BY acc.t_DepartmentID, acc.t_Owner, bnr.t_FIID, acc.t_Account, inacc.t_Date, inacc.t_DebAcc";
     end;

     Sec_Accounts = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );   
     if( Sec_Accounts.MoveLast() )
        return true;
     else
        return false;
     end;
end;

macro GetAccounts_2()
    sqlQuery = " SELECT acc.t_Account Acc, inacc.t_DebAcc DebAcc, acc.t_DepartmentID DepID, acc.t_Owner Owner, " +
    "        acc.t_Fiid Fiid, acc.t_Clientcontrid Clientcontrid, acc.t_Currency Currency,  " +
                "        inacc.t_Opertype Opertype, inacc.t_DealKind DealKind, " +
      "        inacc.t_Date ProDate,  inacc.t_GroundKind, inacc.t_GroundNum, " +
    "        inacc.t_DocumentKind DocKind, inacc.t_DocumentID DocID, inacc.t_Sum Sum, inacc.t_Chapter Chapter, " +
    "        sf.t_number numconc, sf.t_dateconc dateconc, opr.t_Name as OprName, " +
    "        party.T_SHORTNAME IssuerName, lvalues.T_NAME OperationName, " +
    "        tk.t_DealCode, fin.t_Name AvrName, fin.t_FI_Code AvrCode, avrk.t_AvoirKind AvoirKind, avrk.t_Name as AvrkName, avrk.t_Name as AvrkName, " +
    "        bnr.t_FIID BnrFIID, bnr.t_BCSeries, trim(bnr.t_BCNumber) as BCNumber, " +
    "        pt.t_ShortName as DepartmentName, " +
    "        (select a2.t_NameAccount from daccount_dbt a2 where a2.t_Account = acc.t_Account and a2.t_Chapter = acc.t_Chapter and a2.t_Code_Currency = acc.t_Currency) " +
    "         as NameAccount " +
    " FROM   ddlinacc_dbt inacc, dparty_dbt party, dllvalues_dbt lvalues, ddp_dep_dbt dp, dparty_dbt pt, dparty_dbt pty," +
    "        dvsordlnk_dbt lnk, dvsbanner_dbt bnr, ddl_tick_dbt tk, doprkoper_dbt opr, dfininstr_dbt fin, davrkinds_dbt avrk, "
    "        (SELECT acc.t_Account, acc.t_DepartmentID, " + 
                "                acc.t_Owner, acc.t_Fiid, acc.t_Clientcontrid, acc.t_Currency, acc.t_Chapter, acc.t_DocID " +
                "        FROM   dmcaccdoc_dbt acc " +
                "        WHERE  acc.t_CatNum = 581 " + //НЦБ, Расч. с клиентом, ВУ
                "          AND  acc.t_Chapter = 22 " +
                "        GROUP BY acc.t_DepartmentID, acc.t_Owner, acc.t_Fiid, acc.t_Account, " +
    "        acc.t_Clientcontrid, acc.t_Currency, acc.t_Chapter, acc.t_DocID) acc left join dsfcontr_dbt sf on sf.t_id = acc.t_Clientcontrid " +    
    " WHERE ((inacc.t_DebAcc = acc.t_Account) or (inacc.t_KredAcc = acc.t_Account)) " +
    "   AND inacc.t_DealKind in (141,142,143,144) "  +
    "   AND lnk.t_ContractID = inacc.t_DocumentID " +
    "   AND lnk.t_DocKind = inacc.t_DocumentKind " +
    "   AND lnk.t_BCID = acc.t_DocID " +
    "   AND bnr.t_BCID = lnk.t_BCID " +
    "   AND bnr.t_Issuer NOT IN (select t_PartyID from ddp_dep_dbt)" +
    "   AND party.t_PartyID = bnr.t_Issuer " +
    "   AND tk.t_DealID = lnk.t_ContractID "
    "   AND tk.t_BOfficeKind = lnk.t_DocKind "
    "   AND opr.t_Kind_Operation = tk.t_DealType "+
    "   AND fin.t_FIID = bnr.t_FIID " +
    "   AND avrk.t_FI_Kind = fin.t_FI_Kind " +
    "   AND avrk.t_AvoirKind = fin.t_AvoirKind " +
    "   AND lvalues.T_LIST = " + OBJTYPE_CALCOPKIND + ""
    "   AND lvalues.T_ELEMENT = inacc.t_Opertype " +
    "   AND inacc.t_Date <=" + GetSQLDate(DlAccountsFormData.EndDate) +
    "   AND inacc.t_Date >=" + GetSQLDate(DlAccountsFormData.BeginDate) +
    "   AND dp.t_Code = acc.t_DepartmentID " +
    "   AND pty.t_PartyID = acc.T_OWNER " +
    "   AND pt.t_PartyID = dp.t_PartyID ";

     if( DlAccountsFormData.DepartmentID != ALL_ITEM )
       sqlQuery = sqlQuery + " AND acc.t_DepartmentID = " + String( DlAccountsFormData.DepartmentID );
     end;
     if( DlAccountsFormData.ClientID != ALL_ITEM )
         sqlQuery = sqlQuery + " AND acc.t_Owner = " + String( DlAccountsFormData.ClientID );
     end;

     if( (DlAccountsFormData.IsForm2 > 0) and (DlAccountsFormData.FormSub2 != 0) )
       if(DlAccountsFormData.IsForm2 == 1)
         sqlQuery = sqlQuery + "    and   pty.T_LEGALFORM = " + String (DlAccountsFormData.FormSub2) ;
       end;
       if(DlAccountsFormData.IsForm2 == 2)            	
         sqlQuery = sqlQuery + "    and   pty.T_LEGALFORM !=   " + String (DlAccountsFormData.FormSub2);
       end;
     end;

     if( (DlAccountsFormData.IsVid2 > 0) and (DlAccountsFormData.VidSub2 != 0) )            
       if(DlAccountsFormData.IsVid2 == 1)
         sqlQuery = sqlQuery + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (DlAccountsFormData.VidSub2) +" and pty.T_PARTYID = Pto.T_PARTYID)  " ;
       end;
       if(DlAccountsFormData.IsVid2 == 2)            	
         sqlQuery = sqlQuery + "    and   NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (DlAccountsFormData.VidSub2)+ " and pty.T_PARTYID = Pto.T_PARTYID)  " ;
       end;
     end;

     if(DlAccountsFormData.NoResident2)
       sqlQuery = sqlQuery + " and  pty.T_NOTRESIDENT = 'X'  ";
     end;


     if( DlAccountsFormData.ContractID != ALL_ITEM )
         sqlQuery = sqlQuery + " AND acc.t_Clientcontrid = " + String( DlAccountsFormData.ContractID );
     end;
     if( DlAccountsFormData.SecurCode != ALL_ITEM )
       sqlQuery = sqlQuery + " AND fin.T_FIID = " + String( DlAccountsFormData.SecurCode );
     end;
     if( DlAccountsFormData.Issuer_2 != ALL_ITEM )
       sqlQuery = sqlQuery + " AND party.T_PARTYID = " + String( DlAccountsFormData.Issuer_2 );  
     end;
     if( DlAccountsFormData.SecurKind_2 != ALL_ITEM )
       sqlQuery = sqlQuery + " AND avrk.T_AVOIRKIND = " + String( DlAccountsFormData.SecurKind_2 );
     end;

     sqlQuery = sqlQuery +    "   AND (select count(1) from dacctrn_dbt acctrn " +
                              "         where acctrn.t_AccTrnID = inacc.t_AccTrnID " +
                              "           and acctrn.t_State = 1) > 0 ";

     if( DlAccountsFormData.IsSeparatelyDate == "X" )
        sqlQuery = sqlQuery + "ORDER BY acc.t_DepartmentID, inacc.t_Date, acc.t_Owner, bnr.t_FIID, acc.t_Account, inacc.t_DebAcc";
     else
        sqlQuery = sqlQuery + "ORDER BY acc.t_DepartmentID, acc.t_Owner, bnr.t_FIID, acc.t_Account, inacc.t_Date, inacc.t_DebAcc";
     end;

     Sec_Accounts = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
     
     if( Sec_Accounts.MoveLast() )
        return true;
     else
        return false;
     end;
end;


PRIVATE MACRO GetFirstDoc( GroundKind)
  var query, Firstdoc, Doc = "";

  query = RSDCommand(" select t_Name from dllvalues_dbt " +
                     "  where t_List = " + string(OBJTYPE_KINDDOC) +
                     "    and t_element = ?"
                    );

  query.addParam("", RSDBP_IN, GroundKind);

     query.execute();

  Firstdoc = TRsbDataSet(query);

  if( Firstdoc.MoveNext() )
     Doc = Doc + string(FirstDoc.Name);
   end;

  return Doc;
END;

macro PrintDep( PreDepartment, IsClientAccount )
  if( PreDepartment != Sec_Accounts.DepID )
     Rep.PrintHead0( Sec_Accounts.DepID, Sec_Accounts.DepartmentName, IsClientAccount, true );
  end;
end;

macro PrintClient( PreClient, IsClientAccount )
  var Subject;
  if( PreClient != Sec_Accounts.Owner )
    if( IsClientAccount == 0 )
      if( (DlAccountsFormData.SubjectID == {OurBank}) OR (Sec_Accounts.Owner == -1) )
        Rep.PrintHead1_11();
      else
        Subject = ПолучитьКороткоеИмяСубъекта( Sec_Accounts.Owner );
        Rep.PrintHead1_12( Subject, Sec_Accounts.numconc, Sec_Accounts.dateconc );
      end;
    else
      Subject = ПолучитьКороткоеИмяСубъекта( Sec_Accounts.Owner );
      Rep.PrintHead1_2( Subject, Sec_Accounts.numconc, Sec_Accounts.dateconc );
    end;
  end;
end;

private macro GetRest( Account, Currency, Chapter, ProDate:date, BegDay )
  var Rest = $0;
   OprGetAccountRest( Chapter, Currency, Account, ProDate, Rest );
   Rest = abs( Rest );
   return Rest; 
end;

macro PrintAccount_1( PreAccount, PreProDate, Rest, Out:@money )
  var In = 0;

  Out  = 0;
  if( PreAccount != Sec_Accounts.Acc )
    In = GetRest( Sec_Accounts.Acc, Sec_Accounts.Currency, Sec_Accounts.Chapter, date(Sec_Accounts.ProDate)-1);   
    Rep.PrintHead4( Sec_Accounts.Acc, Sec_Accounts.NameAccount );
    Rep.PrintLineDate1( Sec_Accounts.ProDate );
  else
    if( PreProDate != Sec_Accounts.ProDate )
      Rep.PrintLineDate1( Sec_Accounts.ProDate );
    end;
    In = Rest;
  end;
  if( Sec_Accounts.Acc == Sec_Accounts.DebAcc ) 
    Out = In + Sec_Accounts.Sum;
  else
    Out = In - Sec_Accounts.Sum;
  end;                

  Rep.PrintLine1( Sec_Accounts.OperationName,
              Sec_Accounts.OprName,
              Sec_Accounts.DealCode,
              GetFirstDoc( Sec_Accounts.GroundKind),
              Sec_Accounts.GroundNum,
              In,
              Sec_Accounts.Sum,
              Out, true );
end;                


macro PrintAccount_2( PreAccount, PreProDate, Rest, Out:@money )
  var In = $0;

  Out  = 0;
  if( PreAccount != Sec_Accounts.Acc )
    In = GetRest( Sec_Accounts.Acc, Sec_Accounts.Currency, Sec_Accounts.Chapter, date(Sec_Accounts.ProDate)-1);   
    Rep.PrintHead4( Sec_Accounts.Acc, Sec_Accounts.NameAccount );
    Rep.PrintLineDate2( Sec_Accounts.ProDate );
  else
    if( PreProDate != Sec_Accounts.ProDate )
      Rep.PrintLineDate2( Sec_Accounts.ProDate );
    end;
    In = Rest;
  end;
  
  if( Sec_Accounts.Acc == Sec_Accounts.DebAcc ) 
    Out = In - Sec_Accounts.Sum;
  else
    Out = In + Sec_Accounts.Sum;
  end;

  Rep.PrintLine2( Sec_Accounts.OperationName,  
              Sec_Accounts.OprName,        
              Sec_Accounts.DealCode,       
              GetFirstDoc( Sec_Accounts.GroundKind), 
              Sec_Accounts.GroundNum,
              In, 
              0, 
              Sec_Accounts.Sum, 
              0, 
              Out, true );  

end;

PRIVATE MACRO ExcRep( IsBank:bool)
  var PreDepartment = "";                                                                   
  var PreClient = "";
  var PrePlace = "";
  var PreBnrFIID = -1;
  var PreAccount = "";
  var PreProDate = date(0,0,0);
  var In = 0, Out = 0;

  if( ((IsBank) and (GetAccounts_1() != false)) or ((not IsBank) and (GetAccounts_2() != false)) )

      TotalCount = Sec_Accounts.GetRecCount();
      InitProgressBar(  TotalCount, "Отчет: Регистр внутреннего учета ценных бумаг", 
                   "Формирование отчета " + RKIND[Rep.RepKind] );
      IsNotEof = Sec_Accounts.moveFirst();
      while( IsNotEof )

        PrintDep( PreDepartment, IIF(IsBank,0,1) );
        if(DlAccountsFormData.IsSeparatelyDate == "X" )
          if( Rep.PrintHead0_1( PreProDate ) )
            PreClient = "";
            PrePlace = "";
            PreBnrFIID = -1;
            PreAccount = "";
          end;
        else
          if( PreDepartment != Sec_Accounts.DepID )
            Rep.PrintHead0_2( DlAccountsFormData.BeginDate, DlAccountsFormData.EndDate );
          end;
        end;

        PrintClient(PreClient, IIF(IsBank,0,1));
        PreClient = Sec_Accounts.Owner;

        if( PreDepartment != Sec_Accounts.DepID )
          Rep.PrintHead2( IIF(IsBank,0,1), true );
        end;
        
        PreDepartment = Sec_Accounts.DepID;
        
        if( PreBnrFIID != Sec_Accounts.BnrFIID )
          Rep.PrintHead3( Sec_Accounts.AvoirKind, Sec_Accounts.AvrName, Sec_Accounts.AvrCode, Sec_Accounts.IssuerName, Sec_Accounts.AvrkName, Sec_Accounts.BCSeries, Sec_Accounts.BCNumber, true );
          PreProDate = date(0,0,0);
        end;

        PreBnrFIID = Sec_Accounts.BnrFIID;

        if(IsBank)
           PrintAccount_1( PreAccount, PreProDate, In, @Out );
        else
           PrintAccount_2( PreAccount, PreProDate, In, @Out );
        end;

        In = Out;
        PreAccount = Sec_Accounts.Acc;
        PreProDate = Sec_Accounts.ProDate;
        IsNotEof = Sec_Accounts.MoveNext();
        UseProgressBar;
      end;
      RemProgressBar;

      Rep.PrintRepFooter();
    else
      Rep.PrintErrorMessage("Не найдено данных для формирования отчета " + RKIND[Rep.RepKind] + " с неэмиссионными ц/б");
    end;
END;

macro MakeReport( DataFromForm, _Rep:@variant )
  Rep = _Rep;

  DlAccountsFormData = DataFromForm;
  if( DlAccountsFormData.IsSAccounts_Report == "X" )
     Rep.RepKind = BANKACC;
     Rep.SetActiveSheet( "Отчёт" );
     Rep.SetPrefix("N1_");
     ExcRep(true);
  end;

  if( DlAccountsFormData.IsCL_SAccounts_Report == "X" )
     Rep.RepKind = CLIENTACC;
     Rep.SetActiveSheet( "Отчёт_Кл" );
     Rep.SetPrefix("N2_");
     ExcRep(false);
  end;

  _Rep = Rep;
end;
