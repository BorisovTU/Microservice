/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  Description : Печать отчета о массовом удалении векселей

└───────────────────────────────────────────────────────────────────────────*/

//RECORD bnr (vsbanner);
record lnk (vsordlnk);
PRIVATE VAR StringArray = TArray();
PRIVATE const
        Ошибка     = 0,
        Первый     = 1,
        Последний  = 2;

// В firstdoc может лежать запись vsordlnk или vsbanner, т.к.
//   и там и там первое поле - BCID. Но другие поля из firstdoc доставать нельзя!!!
macro Печать_ОтчетСканирования_Удаление( Вызов, firstdoc, Статус, Сообщение )
var bnr = Tbfile("vsbanner.dbt", "R", 0);
//  setbuff (bnr, firstdoc);
  setbuff (lnk, firstdoc);

  bnr.Clear();
  bnr.rec.BCID = lnk.BCID;
  bnr.GetEQ;

  if( Вызов == Первый )
[                  Отчет о групповом удалении векселей.
+--------------------+------+------------------------------------------------+
| Серия и номер      |Номер |                 Сообщение                      |
| векселя            |ошибки|                                                |
+--------------------+------+------------------------------------------------+];
  elif( Вызов==Ошибка )
    if( Статус == 0 )
      if (bnr.rec.BCFormKind == 1)
        Сообщение = "Вексель удален успешно";
      else
        Сообщение = "БС удален успешно";
      end;
    end;

    StringArray = StrSplit2(StrSubst(Сообщение, "|", " " ), 1024, 48);
[|####################|######|################################################|](bnr.rec.BCSeries,Статус,StringArray[0]);

    if( StringArray[1] != null )
[|####################|      |################################################|](trim(bnr.rec.BCNumber),StringArray[1]:w);
      if( StringArray[2] != null )
[|                    |      |################################################|](StringArray[2]:w);
      end;
    else
[|####################|      |                                                |](trim(bnr.rec.BCNumber));
    end;

  elif( Вызов == Последний )
[+--------------------+------+------------------------------------------------+];
  end;
end;


// В firstdoc запись vsbanner
macro Печать_ОтчетСканирования_НомерПартии( Вызов, firstdoc, Статус, Сообщение )
  file Party( "party" );
  record bnr ("vsbanner");
  var IssuerShortName = "";

  setbuff( bnr, firstdoc );

  if( Вызов == Первый )
[                  Отчет о групповом назначении номера партии для ц/б
+------------+--------------------+--------------------+------+------------------------------------------------+
| ID         | Эмитент            | Серия и номер      |Номер |                 Сообщение                      |
| ц/б        |                    |                    |ошибки|                                                |
+------------+--------------------+--------------------+------+------------------------------------------------+];
  elif( Вызов==Ошибка )
    if( Статус == 0 )
      if(bnr.BCFormKind == 1)
        Сообщение = "Номер партии для векселя успешно установлен";
      else
        Сообщение = "Номер партии для БС успешно установлен";
      end;
    end;

    if( bnr.Issuer > 0 )
      Party.PartyID = bnr.Issuer;
      if(GetEQ(Party))
        IssuerShortName = Party.ShortName;
      end;
    end;


    StringArray = StrSplit2( StrSubst( Сообщение, "|", " " ), 1024, 48 );
[|############|####################|####################|######|################################################|]( bnr.BCID:l, IssuerShortName:l, bnr.BCSeries, Статус, StringArray[0] );

    if( StringArray[1] != null )
[|            |                    |####################|      |################################################|]( bnr.BCID:l, IssuerShortName:l, trim( bnr.BCNumber ), StringArray[1]:w );
      if( StringArray[2] != null )
[|            |                    |                    |      |################################################|]( bnr.BCID:l, IssuerShortName:l, StringArray[2]:w );
      end;
    else
[|            |                    |####################|      |                                                |]( trim( bnr.BCNumber ) );
    end;

  elif( Вызов == Последний )
[+------------+--------------------+--------------------+------+------------------------------------------------+];
  end;
end;


// В firstdoc может лежать запись vsordlnk или vsbanner, т.к.
// и там и там первое поле - BCID. Но другие поля из firstdoc доставать нельзя!!!
macro Печать_ОтчетСканирования_СтоимостьВекселя( Вызов, firstdoc, Статус, Сообщение )
  var bnr = Tbfile( "vsbanner.dbt", "R", 0 );
  var pt = Tbfile( "party.dbt", "R", 0 );
  var IssuerShortName = "";

  setbuff( lnk, firstdoc );

  bnr.Clear();
  bnr.rec.BCID = lnk.BCID;
  bnr.GetEQ();

  if( Вызов == Первый )
[                              Отчет о групповом указании стоимости ценных бумаг                                 ];
[+------------+--------------------+--------------------+------+------------------------------------------------+];
[| ID         | Эмитент            | Серия и номер      |Номер |                 Сообщение                      |];
[| ц/б        |                    |                    |ошибки|                                                |];
[+------------+--------------------+--------------------+------+------------------------------------------------+];
  elif( Вызов == Ошибка )
    if( Статус == 0 )
      if( bnr.rec.BCFormKind == 1 )
        Сообщение = "Стоимость векселя указана успешно";
      else
        Сообщение = "Стоимость банковского сертификата указана успешно";
      end;
    end;

    if( bnr.rec.Issuer > 0 )
      pt.rec.PartyID = bnr.rec.Issuer;
      if( pt.GetEQ() )
        IssuerShortName = pt.rec.ShortName;
      end;
    end;

    StringArray = StrSplit2( StrSubst( Сообщение, "|", " " ), 1024, 48 );
[|############|####################|####################|######|################################################|]( bnr.rec.BCID:l, IssuerShortName:l, bnr.rec.BCSeries, Статус, StringArray[0] );

    if( StringArray[1] != null )
[|            |                    |####################|      |################################################|]( bnr.rec.BCID:l, IssuerShortName:l, trim( bnr.rec.BCNumber ), StringArray[1]:w );
      if( StringArray[2] != null )
[|            |                    |                    |      |################################################|]( bnr.rec.BCID:l, IssuerShortName:l, StringArray[2]:w );
      end;
    else
[|            |                    |####################|      |                                                |]( trim( bnr.rec.BCNumber ) );
    end;

  elif( Вызов == Последний )
[+------------+--------------------+--------------------+------+------------------------------------------------+];
  end;
end;

macro Печать_ОтчетСканирования ( Вызов, firstdoc, Статус, Сообщение, Режим )
  if(Режим == 1)
    return Печать_ОтчетСканирования_Удаление( Вызов, firstdoc, Статус, Сообщение );
  elif(Режим == 2)
    return Печать_ОтчетСканирования_НомерПартии( Вызов, firstdoc, Статус, Сообщение );
  elif(Режим == 3)
    return Печать_ОтчетСканирования_СтоимостьВекселя( Вызов, firstdoc, Статус, Сообщение );
  end;
end;
