/*
$Name:         vaprfltr.mac
$Module:       Учтенные векселя
$Description:  Сервисная операция предъявления векселя. Макрос фильтрации

            va-вексель учтенный (veksel accounted)
            pr-предъявление (present)
          fltr-макрос фильтрации
*/

import RsbDataSet, DealsInter, VAInter, vamisc;

var fltr_bnr, /*TRecHandler(vsbanner) - текущая запись для фильтрации*/
    fltr_srv; /*TRecHandler(vssrvdoc) - сервисный документ*/

/*  true - пропустить через фильтр, false - не пропускать
    @param НужноГоворитьПричину - OneBnr ( флаг. показывающий. одну или несколько записей будет обрабатывать фильтр )
*/
macro fltr_macro(СимволЦепочки, НужноГоворитьПричину, Action)
var zero_date = Date(0,0,0);

    if((fltr_srv.rec.PartyID != -1) and (fltr_srv.rec.PartyID != fltr_bnr.rec.AgentID)) // если операция для конкретного Агента ВО счета, отбираем только его вексели
        return false;
    elif((fltr_bnr.rec.BCTermFormula != VA_TERMF_DURING)
      or (fltr_bnr.rec.ABCStatus != VABANNER_STATUS_ACCOUNT)
      or (СостояниеВекселяНаДату(fltr_bnr.rec.BCID, fltr_srv.rec.ExecutionDate, "З") != 0)
      or (СостояниеВекселяНаДату(fltr_bnr.rec.BCID, fltr_srv.rec.ExecutionDate, "Н") != 0))
        MsgBox("Вексель ", fltr_bnr.rec.BCSeries, " № ", trim(fltr_bnr.rec.BCNumber), " не подлежит предъявлению.");

        return false;
    elif(fltr_bnr.rec.BCPresentationDate != zero_date)
        MsgBox("Вексель ", fltr_bnr.rec.BCSeries, " № ", trim(fltr_bnr.rec.BCNumber), " уже предъявлен.");

        return false;
    end;

    SetParm(0, "А");

    return true;
end;
