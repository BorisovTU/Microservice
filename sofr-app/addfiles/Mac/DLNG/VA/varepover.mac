/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  Description : Протокол операции переоценки НВПИ

└───────────────────────────────────────────────────────────────────────────*/
IMPORT RsbDataSet, FIInter, CTInter, VAInter, vsbnrfd, vaacc, vaconv, vaprdec, vamisc, cb_sql, vaprord, dlquery;


private macro PrintReportTable(vssrvdoc)
  var query, Select, DataSet;
  var count = 0;
  var stat = 0, N = 0;
  
  query =   " SELECT opr.t_DocKind, TO_NUMBER(opr.t_DocumentID) as DocID, doc.t_AutoKey, "
          + "        (CASE WHEN opr.t_DocKind = "+DL_VSBANNER+" THEN (SELECT TO_CHAR(bnr.t_BCSeries||' '||Trim(bnr.t_BCNumber)) FROM dvsbanner_dbt bnr WHERE bnr.t_BCID = TO_NUMBER(opr.t_DocumentID))"
          + "              ELSE CHR(1) END) as AvrCode, "
          + "        (CASE WHEN opr.t_DocKind = "+DL_VEKSELACCOUNTED+" THEN (SELECT tick.t_DealCode FROM ddl_tick_dbt tick WHERE tick.t_DealID = TO_NUMBER(opr.t_DocumentID)) "
          + "              WHEN opr.t_DocKind = "+DL_NTGDOC+" THEN (SELECT ntg.t_DealNumber FROM ddl_nett_dbt ntg WHERE ntg.t_NettingID = TO_NUMBER(opr.t_DocumentID))"
          + "              ELSE CHR(1) END) as DealCode, "
          + "        arh.t_Account_Payer, arh.t_Account_Receiver, arh.t_Sum_Payer, arh.t_FIID_Payer, arh.t_Sum_Receiver, arh.t_FIID_Receiver, arh.t_Ground "
          + "   FROM doprdocs_dbt doc, doproper_dbt opr, dacctrn_dbt arh "
          + "  WHERE doc.t_ServDocKind = ? /*1*/ "
          + "    AND doc.t_ServDocID = ? /*2*/ "
          + "    AND doc.t_DocKind = ? /*3*/ "
          + "    AND opr.t_ID_Operation = doc.t_ID_Operation"
          + "    AND arh.t_AccTrnID = doc.t_AccTrnID "
          + " order by doc.t_AutoKey asc";

  Select = DL_RSDCommand(query);

  Select.AddParam(vssrvdoc.rec.DocKind); /*1*/
  Select.AddParam(vssrvdoc.rec.ID);      /*2*/
  Select.AddParam(DLDOC_CARRY);          /*3*/

  count = Select.GetCount();

  if ( count > 0 )
    DataSet = Select.Execute();
    stat = DataSet.moveNext();

    [~MultipleRow];
    println(1);
    println(count - 1);

    while(stat)
      N = N + 1;

      println("~M1_" + N);
      println(DataSet.AvrCode);

      println("~M2_" + N);
      println(DataSet.DealCode);

      println("~M3_" + N);
      println(DataSet.Account_Payer);

      println("~M4_" + N);
      println(string(DataSet.Sum_Payer) + " " + VA_GetFI_ISO_Code(DataSet.FIID_Payer));

      println("~M5_" + N);
      println(DataSet.Account_Receiver);

      println("~M6_" + N);
      println(string(DataSet.Sum_Receiver) + " " + VA_GetFI_ISO_Code(DataSet.FIID_Receiver));

      println("~M7_" + N);
      println(DataSet.Ground);

      stat = DataSet.MoveNext();
    end;
  end;

  return count > 0;
end;

private macro GetSecurBuyCount(ID)
  var SQLQueryStr = "";
  var SecurBuyCountSelect;
  var SecurBuyCountData;
  var SecurBuyCount = 0;

  SQLQueryStr = " SELECT "
              + "     COUNT(lnk2.t_LinkKind) SecurBuyCount "
              + "  FROM "
              + "     dvssrvdoc_dbt doc, "
              + "     dvsordlnk_dbt lnk1, "
              + "     dvsbanner_dbt bnr, "
              + "     doproper_dbt opr, "
              + "     doprstep_dbt step, "
              + "     doprkoper_dbt kopr, "
              + "     ddl_tick_dbt tick, "
              + "     dvsordlnk_dbt lnk2, "
              + "     ddl_leg_dbt leg "
              + " WHERE "
              + "     doc.t_ID = " + ID + " "
              + " AND lnk1.t_DocKind = doc.t_DocKind "
              + " AND lnk1.t_ContractID = doc.t_ID "
              + " AND lnk1.t_LinkKind = " + VSORDLNK_K_OVER_OFFBALANCEDEAL + " "
              + " AND INSTR(kopr.t_SysTypes, 'X') > 0 "
              + " AND tick.t_DealID = lnk1.t_BCID "
              + " AND opr.t_DocKind = tick.t_BOfficeKind "
              + " AND opr.t_DocumentID = LPAD(tick.t_DealID, 34, '0') "
              + " AND lnk2.t_DocKind = tick.t_BOfficeKind "
              + " AND lnk2.t_ContractID = tick.t_DealID "
              + " AND lnk2.t_LinkKind = " + VSORDLNK_K_BUY + " "
              + " AND bnr.t_BCID = lnk2.t_BCID "
              + " AND leg.t_DealID = lnk2.t_BCID "
              + " AND kopr.t_Kind_Operation = tick.t_DealType "
              + " AND leg.t_LegKind = " + LEG_KIND_VSBANNER + " "
              + " AND leg.t_LegID = 0 "
              + " AND opr.t_id_operation = step.t_id_operation "
              + " AND step.t_ServDocKind = doc.t_DocKind "
              + " AND step.t_ServdocID = doc.t_ID "
              + " GROUP BY "
              + "     lnk2.t_LinkKind ";

  SecurBuyCountSelect = DL_RSDCommand(SQLQueryStr);

  SecurBuyCountData = SecurBuyCountSelect.Execute();

  if(SecurBuyCountData.MoveNext())
    SecurBuyCount = SecurBuyCountData.SecurBuyCount;
  end;

  return SecurBuyCount;
end;

// --------------------------------------------------------------------------
// Печать распоряжения в бухгалтерию всвязи с переоценкой по НВПИ
// --------------------------------------------------------------------------
private macro PrintNVPI(ID, DocKind, OpDate, Template, _OpType, _DecType, _DecPurp)
  var SQLQueryStr = "";
  var SecuritiesSelect;
  var SecuritiesData;

  var DataExist = 0;
  var SecurCount = 0;
  var SecurBuyNum = 0;
  var SecurSaleNum = 0;
  var SecurNum = 0;

  var TempFile;
  var ExecutionDate = date(0,0,0);
  var fd;
  var party = Tbfile("party.dbt", "R", 0);

  var CurrNom = -1;
  var CurrAcnt = -1;
  var M43_buf = $0;
  var M44_buf = $0;
  var M53_buf = $0;
  var M55_buf = $0;
  var M60_buf = $0;
  var M61_buf = $0;
  var M62_buf = $0;
  var M63_buf = $0;

  var CurrAcntRes = ИтогПоВекселям();
  var M64_res = ИтогПоВекселям();
  var M65_res = ИтогПоВекселям();
  var M66_res = ИтогПоВекселям();
  var M67_res = ИтогПоВекселям();

  var CurrAcntCount = 0;
  var CurrAcntNum = 0;
  var M64_buf = $0;
  var M65_buf = $0;
  var M66_buf = $0;
  var M67_buf = $0;

  var PrevOverDate = date(0,0,0);
  var CurrRequir = -1;
  var CurrOblig = -1;

  var M68_buf = $0;
  var M70_buf = $0;
  var M72_buf = $0;
  var M73_buf = $0;

  var tickfd;
  var PrevDealID = 0;
  var CurrRequirRes = ИтогПоВекселям();
  var CurrObligRes = ИтогПоВекселям();
  var M74_res = ИтогПоВекселям();
  var M75_res = ИтогПоВекселям();

  var CurrRequirCount = 0;
  var CurrObligCount = 0;
  var CurrRequirNum = 0;
  var CurrObligNum = 0;
  var CurrRequirObligCount = 0;
  var CurrRequirObligNum = 0;
  var M74_buf = $0;
  var M75_buf = $0;

  SQLQueryStr = " SELECT "
              + "     doc.t_ExecutionDate, "
              + "     doc.t_DocNumber, "
              + "     doc.t_ValueDate, "
              + "     doc.t_PartyID, "
              + "     opr.t_ID_Operation, "
              + "     step.t_ID_Step, ";

  if((Template == "OF16.dot") or (Template == "OF17.dot"))

    SQLQueryStr = SQLQueryStr
              + "     tick.t_DealID, "
              + "     tick.t_DealType, "
              + "     tick.t_DealDate, "
              + "     tick.t_BOfficeKind, "
              + "     lnk2.t_BCCFI, "
              + "     lnk2.t_BCID, "
              + "     lnk2.t_BCCost, "
              + "     lnk2.t_LinkKind, ";

  elif(Template == "OF15.dot")

    SQLQueryStr = SQLQueryStr
              + "     lnk1.t_BCCFI, "
              + "     lnk1.t_BCID, "
              + "     lnk1.t_BCCost, "
              + "     lnk1.t_LinkKind, ";
  end;

  SQLQueryStr = SQLQueryStr
              + "     bnr.t_Issuer, "
              + "     bnr.t_BCTermFormula, "
              + "     bnr.t_BCPresentationDate, "
              + "     bnr.t_IssuerName, "
              + "     bnr.t_BCNumber, "
              + "     bnr.t_BCSeries, "
              + "     bnr.t_AgentName, "
              + "     leg.t_PFI, "
              + "     leg.t_Principal, "
              + "     leg.t_Start, "
              + "     leg.t_Maturity, "
              + "     leg.t_Expiry, "
              + "     leg.t_Diff, "
              + "     RSB_BILL.GetVABnrPayFIID(BNR.t_BCID) as AccFI "
              + " FROM "
              + "     dvssrvdoc_dbt doc, "
              + "     dvsordlnk_dbt lnk1, "
              + "     dvsbanner_dbt bnr, "
              + "     doproper_dbt opr, "
              + "     doprstep_dbt step, ";

  if((Template == "OF16.dot") or (Template == "OF17.dot"))

    SQLQueryStr = SQLQueryStr
              + "     ddl_tick_dbt tick, "
              + "     dvsordlnk_dbt lnk2, "
              + "     doprkoper_dbt kopr, ";
  end;

  SQLQueryStr = SQLQueryStr
              + "     ddl_leg_dbt leg "
              + " WHERE "
              + "     doc.t_ID = " + ID + " "
              + " AND lnk1.t_DocKind = doc.t_DocKind "
              + " AND lnk1.t_ContractID = doc.t_ID ";

  if((Template == "OF16.dot") or (Template == "OF17.dot"))

    if(Template == "OF16.dot")

      SQLQueryStr = SQLQueryStr
              + " AND (lnk1.t_LinkKind = " + VSORDLNK_K_OVER_BALANCEDEAL + " "
              + " OR (lnk1.t_LinkKind = " + VSORDLNK_K_OVER_OFFBALANCEDEAL + " "
              + " AND INSTR(kopr.t_SysTypes, 'X') = 0)) ";

    elif(Template == "OF17.dot")

      SQLQueryStr = SQLQueryStr
              + " AND lnk1.t_LinkKind = " + VSORDLNK_K_OVER_OFFBALANCEDEAL + " "
              + " AND INSTR(kopr.t_SysTypes, 'X') > 0 ";

    end;

    SQLQueryStr = SQLQueryStr
              + " AND tick.t_DealID = lnk1.t_BCID "
              + " AND opr.t_DocKind = tick.t_BOfficeKind "
              + " AND opr.t_DocumentID = LPAD(tick.t_DealID, 34, '0') "
              + " AND lnk2.t_DocKind = tick.t_BOfficeKind "
              + " AND lnk2.t_ContractID = tick.t_DealID "
              + " AND bnr.t_BCID = lnk2.t_BCID "
              + " AND leg.t_DealID = lnk2.t_BCID "
              + " AND kopr.t_Kind_Operation = tick.t_DealType ";

  elif(Template == "OF15.dot")

    SQLQueryStr = SQLQueryStr
              + " AND (lnk1.t_LinkKind = " + VSORDLNK_K_OVER_AVOIRISS + " "
              + " OR lnk1.t_LinkKind = " + VSORDLNK_K_OVER_ENDORSEMENT + ") "
              + " AND bnr.t_BCID = lnk1.t_BCID "
              + " AND opr.t_DocKind = " + DL_VSBANNER + " "
              + " AND opr.t_DocumentID = bnr.t_BCID "
              + " AND leg.t_DealID = lnk1.t_BCID ";
  end;

  SQLQueryStr = SQLQueryStr
              + " AND leg.t_LegKind = " + LEG_KIND_VSBANNER + " "
              + " AND leg.t_LegID = 0 "
              + " AND opr.t_id_operation = step.t_id_operation "
              + " AND step.t_ServDocKind = doc.t_DocKind "
              + " AND step.t_ServdocID = doc.t_ID "
              + " ORDER BY ";

  if((Template == "OF16.dot") or (Template == "OF17.dot"))
    SQLQueryStr = SQLQueryStr
              + "     lnk2.t_LinkKind DESC, "
              + "     tick.t_DealID ASC, ";
  end;

  SQLQueryStr = SQLQueryStr
              + "     bnr.t_Issuer ASC, "
              + "     bnr.t_BCSeries ASC, "
              + "     bnr.t_BCNumber ASC ";

  SecuritiesSelect = DL_RSDCommand(SQLQueryStr);

  SecurNum = SecuritiesSelect.GetCount();
  SecuritiesData = SecuritiesSelect.Execute();

  DataExist = SecuritiesData.MoveNext();

  if(DataExist)
    println(Template);
    println(GenFileName());

    party.Clear();
    party.rec.PartyID = {OurBank};
    party.GetEQ();

    println("~M0");
    println(party.rec.Name);

    println("~M1");
    println(date(OpDate) : m);

    println("~M2");
    println(GenRef(1050, 3));

    println("~M3");
    println(_DecType);

    println("~M4");
    println(_OpType);

    println("~M5");
    println(_DecPurp);

    ExecutionDate = SQL_ConvTypeDate(SecuritiesData.ExecutionDate);
    println("~M6");
    println(ExecutionDate);

    println("~M7");
    println("Сервисная операция переоценки по НВПИ");

    println("~M8");
    println(SecuritiesData.DocNumber);

    println("~M9");
    println(SQL_ConvTypeDate(SecuritiesData.Valuedate));

    println("~M10");
    if(SecuritiesData.PartyID != -1)
      party.Clear();
      party.rec.PartyID = SecuritiesData.PartyID;
      party.GetEQ();
      println(party.rec.ShortName);
    else
      println("");
    end;

    println("~M40");
    println("Векселедатель");

    println("~M58");
    println("Агент ВО");

    println("~M41");
    println("Номер векселя");

    println("~M42");
    println("Дата составления");

    if((Template == "OF15.dot") or (Template == "OF16.dot"))

      println("~MultipleRow");
      println(1);
      println(SecurNum - 1);
      println("#");
      if(Template == "OF15.dot")
        println(3);
      elif(Template == "OF16.dot")
        println(4);
      end;

    elif(Template == "OF17.dot")

      SecurBuyNum = int(GetSecurBuyCount(ID));
      SecurSaleNum = SecurNum - SecurBuyNum;

      println("~MultipleRow");
      println(1);
      println(SecurBuyNum - 1);
      println("#");
      println(5);

      println("~MultipleRow");
      println(2);
      println(SecurSaleNum - 1);
      println("#");
      println(3);

    end;
  end;

  while(DataExist)
    SecurCount = SecurCount + 1;

    if((Template == "OF15.dot") or (Template == "OF16.dot") or ((Template == "OF17.dot") and (SecuritiesData.LinkKind == VSORDLNK_K_BUY)))

      println("~M11_" + string(SecurCount));
      println(SecuritiesData.IssuerName);

      println("~M59_" + string(SecurCount));
      println(SecuritiesData.AgentName);

      println("~M12_" + string(SecurCount));
      println(trim(SecuritiesData.BCNumber));

      println("~M13_" + string(SecurCount));
      println(SecuritiesData.BCSeries);

      println("~M14_" + string(SecurCount));
      println(SecuritiesData.Principal);
      CurrNom = SecuritiesData.PFI;
      println("~M14C_" + string(SecurCount));
      println(VA_CurrencyWr(SecuritiesData.Principal, CurrNom));

      println("~M16_" + string(SecurCount));
      println(SQL_ConvTypeDate(SecuritiesData.Start));

      println("~M17_" + string(SecurCount));
      println(ПолучитьСрокПлатежаПоВекселю(SecuritiesData.BCTermFormula, SQL_ConvTypeDate(SecuritiesData.Maturity), SQL_ConvTypeDate(SecuritiesData.Start), SQL_ConvTypeDate(SecuritiesData.Expiry), SecuritiesData.Diff));

    elif((Template == "OF17.dot") and (SecuritiesData.LinkKind == VSORDLNK_K_SALE))

      println("~M111_" + string(SecurCount - SecurBuyNum));
      println(SecuritiesData.IssuerName);

      println("~M591_" + string(SecurCount - SecurBuyNum));
      println(SecuritiesData.AgentName);

      println("~M121_" + string(SecurCount - SecurBuyNum));
      println(trim(SecuritiesData.BCNumber));

      println("~M131_" + string(SecurCount - SecurBuyNum));
      println(SecuritiesData.BCSeries);

      println("~M141_" + string(SecurCount - SecurBuyNum));
      println(SecuritiesData.Principal);
      CurrNom = SecuritiesData.PFI;
      println("~M14C1_" + string(SecurCount - SecurBuyNum));
      println(VA_CurrencyWr(SecuritiesData.Principal, CurrNom));

      println("~M161_" + string(SecurCount - SecurBuyNum));
      println(SQL_ConvTypeDate(SecuritiesData.Start));

      println("~M171_" + string(SecurCount - SecurBuyNum));
      println(ПолучитьСрокПлатежаПоВекселю(SecuritiesData.BCTermFormula, SQL_ConvTypeDate(SecuritiesData.Maturity), SQL_ConvTypeDate(SecuritiesData.Start), SQL_ConvTypeDate(SecuritiesData.Expiry), SecuritiesData.Diff));

    end;

    fd = VSBannerFD(DL_VSBANNER, SecuritiesData.BCID);
    CurrAcnt = fd.ОпределитьВалютуУчета();
    // Считаем количество видов валюты учета
    CurrAcntRes.Итого(1, CurrAcnt);

    if(Template == "OF15.dot")

      println("~M53_" + string(SecurCount));
      M53_buf = ПолучитьЦенуПокупкиБезПремииВУ(SecuritiesData.BCID, ExecutionDate);
      println(M53_buf);
      println("~M53C_" + string(SecurCount));
      println(VA_CurrencyWr(M53_buf, CurrAcnt));

      println("~M43_" + string(SecurCount));
      if(ВексельДисконтный(fd.GetLeg()))
        M43_buf = money(ПолучитьСуммуПДДНаДату(SecuritiesData.BCID, ExecutionDate - 1, FIROLE_DISCOUNT));
        M43_buf = money(VA_Convert(M43_buf, ExecutionDate, CurrNom, CurrAcnt));
      else
        M43_buf = $0;
      end;
      println(M43_buf);
      println("~M43C_" + string(SecurCount));
      println(VA_CurrencyWr(M43_buf, CurrAcnt));

      println("~M44_" + string(SecurCount));
      if(ВексельПроцентный(fd.GetLeg()))
        M44_buf = money(ПолучитьСуммуПДДНаДату(SecuritiesData.BCID, ExecutionDate - 1, FIROLE_PERCENT));
        M44_buf = money(VA_Convert(M44_buf, ExecutionDate, CurrNom, CurrAcnt));
      else
        M44_buf = $0;
      end;
      println(M44_buf);
      println("~M44C_" + string(SecurCount));
      println(VA_CurrencyWr(M44_buf, CurrAcnt));

      println("~M55_" + string(SecurCount));
      M55_buf = money(ПолучитьОстатокПремииНаДатуВУ(SecuritiesData.BCID, ExecutionDate - 1));
      println(M55_buf);
      println("~M55C_" + string(SecurCount));
      println(VA_CurrencyWr(M55_buf, CurrAcnt));

      println("~M60_" + string(SecurCount));
      M60_buf = money(ПолучитьЦенуПокупкиБезПремииВУ(SecuritiesData.BCID, ExecutionDate - 1));
      M60_buf  = M60_buf - money(VA_Convert(money(ПолучитьЦенуПокупкиБезПремииВН(SecuritiesData.BCID, ExecutionDate - 1)), ExecutionDate, CurrNom, CurrAcnt));
      println(M60_buf);
      M64_res.Итого(M60_buf, CurrAcnt);
      println("~M60C_" + string(SecurCount));
      println(VA_CurrencyWr(M60_buf, CurrAcnt));

      println("~M61_" + string(SecurCount));
      M61_buf = money(ПолучитьСуммуПереоценкиШагаВУ(SecuritiesData.BCID, FIROLE_DISCOUNT, SecuritiesData.ID_Operation, SecuritiesData.ID_Step));
      println(M61_buf);
      M65_res.Итого(M61_buf, CurrAcnt);
      println("~M61C_" + string(SecurCount));
      println(VA_CurrencyWr(M61_buf, CurrAcnt));

      println("~M62_" + string(SecurCount));
      M62_buf = money(ПолучитьСуммуПереоценкиШагаВУ(SecuritiesData.BCID, FIROLE_PERCENT, SecuritiesData.ID_Operation, SecuritiesData.ID_Step));
      println(M62_buf);
      M66_res.Итого(M62_buf, CurrAcnt);
      println("~M62C_" + string(SecurCount));
      println(VA_CurrencyWr(M62_buf, CurrAcnt));

      println("~M63_" + string(SecurCount));
      M63_buf = money(ПолучитьОстатокПремииНаДатуВУ(SecuritiesData.BCID, ExecutionDate - 1));
      M63_buf  = M63_buf - money(VA_Convert(money(ПолучитьОстатокПремииНаДатуВН(SecuritiesData.BCID, ExecutionDate - 1)), ExecutionDate, CurrNom, CurrAcnt));
      println(M63_buf);
      M67_res.Итого(M63_buf, CurrAcnt);
      println("~M63C_" + string(SecurCount));
      println(VA_CurrencyWr(M63_buf, CurrAcnt));

    elif((Template == "OF16.dot") or (Template == "OF17.dot"))

      PrevOverDate = SQL_ConvTypeDate(ПолучитьДатуПоследнейПереоценкиСделки(SecuritiesData.DealDate, SecuritiesData.ID_Operation, ExecutionDate));

      if(SecuritiesData.DealID != PrevDealID)
        tickfd = VATickFD(SecuritiesData.BOfficeKind, SecuritiesData.DealID);
      end;

      if(SecuritiesData.LinkKind == VSORDLNK_K_BUY)

        CurrRequir = SecuritiesData.AccFI;
        CurrOblig = tickfd.GetDealPayFI();

        CurrRequirRes.Итого(0, CurrRequir);
        CurrObligRes.Итого(0, CurrOblig);

        println("~M68_" + string(SecurCount));
        M68_buf = money(VA_Convert(SecuritiesData.BCCost, ExecutionDate, SecuritiesData.BCCFI, CurrRequir));
        println(M68_buf);
        println("~M68C_" + string(SecurCount));
        println(VA_CurrencyWr(M68_buf, CurrRequir));

        println("~M72_" + string(SecurCount));
        if(not VA_IsBarterF(SecuritiesData.DealType))
          M72_buf = M68_buf - money(VA_Convert(SecuritiesData.BCCost, PrevOverDate, SecuritiesData.BCCFI, CurrRequir));
        else
          M72_buf = $0;
        end;
        println(M72_buf);
        M74_res.Итого(M72_buf, CurrRequir);
        M74_res.Итого($0, CurrOblig);
        println("~M72C_" + string(SecurCount));
        println(VA_CurrencyWr(M72_buf, CurrRequir));

        if(Template == "OF16.dot")
          println("~M70_" + string(SecurCount));
          M70_buf = money(VA_Convert(SecuritiesData.BCCost, ExecutionDate, SecuritiesData.BCCFI, CurrOblig));
          println(M70_buf);
          println("~M70C_" + string(SecurCount));
          println(VA_CurrencyWr(M70_buf, CurrOblig));

          println("~M73_" + string(SecurCount));
          if(not VA_IsExchange(SecuritiesData.DealType))
            M73_buf = M70_buf - money(VA_Convert(SecuritiesData.BCCost, PrevOverDate, SecuritiesData.BCCFI, CurrOblig));
          else
            M73_buf = $0;
          end;
          println(M73_buf);
          M75_res.Итого($0, CurrRequir);
          M75_res.Итого(M73_buf, CurrOblig);
          println("~M73C_" + string(SecurCount));
          println(VA_CurrencyWr(M73_buf, CurrOblig));
        end;

      elif(SecuritiesData.LinkKind == VSORDLNK_K_SALE)

        CurrRequir = tickfd.GetDealPayFI();
        CurrOblig = SecuritiesData.AccFI;

        CurrRequirRes.Итого(0, CurrRequir);
        CurrObligRes.Итого(0, CurrOblig);

        if(Template == "OF16.dot")

          println("~M68_" + string(SecurCount));
          M68_buf = money(VA_Convert(SecuritiesData.BCCost, ExecutionDate, SecuritiesData.BCCFI, CurrRequir));
          println(M68_buf);
          println("~M68C_" + string(SecurCount));
          println(VA_CurrencyWr(M68_buf, CurrRequir));

          println("~M72_" + string(SecurCount));
          if(not VA_IsExchange(SecuritiesData.DealType))
            M72_buf = M68_buf - money(VA_Convert(SecuritiesData.BCCost, PrevOverDate, SecuritiesData.BCCFI, CurrRequir));
          else
            M72_buf = $0;
          end;
          println(M72_buf);
          M74_res.Итого(M72_buf, CurrRequir);
          M74_res.Итого($0, CurrOblig);
          println("~M72C_" + string(SecurCount));
          println(VA_CurrencyWr(M72_buf, CurrRequir));

          println("~M70_" + string(SecurCount));
          M70_buf = money(VA_Convert(SecuritiesData.BCCost, ExecutionDate, SecuritiesData.BCCFI, CurrOblig));
          println(M70_buf);
          println("~M70C_" + string(SecurCount));
          println(VA_CurrencyWr(M70_buf, CurrOblig));

          println("~M73_" + string(SecurCount));
          if(not VA_IsBarterW(SecuritiesData.DealType))
            M73_buf = M70_buf - money(VA_Convert(SecuritiesData.BCCost, PrevOverDate, SecuritiesData.BCCFI, CurrOblig));
          else
            M73_buf = $0;
          end;
          println(M73_buf);
          M75_res.Итого($0, CurrRequir);
          M75_res.Итого(M73_buf, CurrOblig);
          println("~M73C_" + string(SecurCount));
          println(VA_CurrencyWr(M73_buf, CurrOblig));

        elif(Template == "OF17.dot")

          println("~M70_" + string(SecurCount - SecurBuyNum));
          M70_buf = money(VA_Convert(SecuritiesData.BCCost, ExecutionDate, SecuritiesData.BCCFI, CurrOblig));
          println(M70_buf);
          println("~M70C_" + string(SecurCount - SecurBuyNum));
          println(VA_CurrencyWr(M70_buf, CurrOblig));

          println("~M73_" + string(SecurCount - SecurBuyNum));
          if(not VA_IsBarterW(SecuritiesData.DealType))
            M73_buf = M70_buf - money(VA_Convert(SecuritiesData.BCCost, PrevOverDate, SecuritiesData.BCCFI, CurrOblig));
          else
            M73_buf = $0;
          end;
          println(M73_buf);
          M75_res.Итого($0, CurrRequir);
          M75_res.Итого(M73_buf, CurrOblig);
          println("~M73C_" + string(SecurCount - SecurBuyNum));
          println(VA_CurrencyWr(M73_buf, CurrOblig));

        end;

      end;

      PrevDealID = SecuritiesData.DealID;

    end;

    DataExist = SecuritiesData.MoveNext();
  end;

  if(SecurCount > 0)

    if(Template == "OF15.dot")

      CurrAcntNum = CurrAcntRes.GetSize();

      println("~MultipleRow");
      println(1);
      println(CurrAcntNum - 1);
      println("#");
      println(-1);

      while(CurrAcntCount < CurrAcntNum)
        CurrAcntCount = CurrAcntCount + 1;

        println("~M64_" + string(CurrAcntCount));
        M64_res.GetData(CurrAcntCount - 1, @M64_buf, @CurrAcnt);
        println(M64_buf);
        println("~M64C_" + string(CurrAcntCount));
        println(VA_CurrencyWr(M64_buf, CurrAcnt));

        println("~M65_" + string(CurrAcntCount));
        M65_res.GetData(CurrAcntCount - 1, @M65_buf, @CurrAcnt);
        println(M65_buf);
        println("~M65C_" + string(CurrAcntCount));
        println(VA_CurrencyWr(M65_buf, CurrAcnt));

        println("~M66_" + string(CurrAcntCount));
        M66_res.GetData(CurrAcntCount - 1, @M66_buf, @CurrAcnt);
        println(M66_buf);
        println("~M66C_" + string(CurrAcntCount));
        println(VA_CurrencyWr(M66_buf, CurrAcnt));

        println("~M67_" + string(CurrAcntCount));
        M67_res.GetData(CurrAcntCount - 1, @M67_buf, @CurrAcnt);
        println(M67_buf);
        println("~M67C_" + string(CurrAcntCount));
        println(VA_CurrencyWr(M67_buf, CurrAcnt));
      end;

    elif(Template == "OF16.dot")

      CurrRequirNum = CurrRequirRes.GetSize();
      CurrObligNum = CurrObligRes.GetSize();

      CurrRequirObligNum = CurrRequirNum;

      if(CurrRequirNum > CurrRequirNum)
        CurrRequirObligNum = CurrRequirNum;
      end;

      println("~MultipleRow");
      println(1);
      println(CurrRequirObligNum - 1);
      println("#");
      println(-1);

      CurrRequirObligCount = 0;
      while(CurrRequirObligCount < CurrRequirObligNum)
        CurrRequirObligCount = CurrRequirObligCount + 1;

        println("~M74_" + CurrRequirObligCount);
        M74_res.GetData(CurrRequirObligCount - 1, @M74_buf, @CurrRequir);
        if(CurrRequir != -1)
          println("~M74_" + CurrRequirObligCount);
          println(M74_buf);
          println("~M74C_" + CurrRequirObligCount);
          println(VA_CurrencyWr(M74_buf, CurrRequir));
        else
          println("~M74_" + CurrRequirObligCount);
          println("");
          println("~M74C_" + CurrRequirObligCount);
          println("");
        end;

        M75_res.GetData(CurrRequirObligCount - 1, @M75_buf, @CurrOblig);
        if(CurrOblig != -1)
          println("~M75_" + CurrRequirObligCount);
          println(M75_buf);
          println("~M75C_" + CurrRequirObligCount);
          println(VA_CurrencyWr(M75_buf, CurrOblig));
        else
          println("~M75_" + CurrRequirObligCount);
          println("");
          println("~M75C_" + CurrRequirObligCount);
          println("");
        end;
      end;

    elif(Template == "OF17.dot")

      CurrRequirNum = CurrRequirRes.GetSize();
      CurrObligNum = CurrObligRes.GetSize();

      println("~MultipleRow");
      println(1);
      println(CurrRequirNum - 1);
      println("#");
      println(-1);

      println("~MultipleRow");
      println(2);
      println(CurrObligNum - 1);
      println("#");
      println(-1);

      CurrRequirCount = 0;
      while(CurrRequirCount < CurrRequirNum)
        CurrRequirCount = CurrRequirCount + 1;

        println("~M74_" + CurrRequirCount);
        M74_res.GetData(CurrRequirCount - 1, @M74_buf, @CurrRequir);
        if(CurrRequir != -1)
          println("~M74_" + CurrRequirCount);
          println(M74_buf);
          println("~M74C_" + CurrRequirCount);
          println(VA_CurrencyWr(M74_buf, CurrRequir));
        else
          println("~M74_" + CurrRequirCount);
          println("");
          println("~M74C_" + CurrRequirCount);
          println("");
        end;

      end;

      CurrObligCount = 0;
      while(CurrObligCount < CurrObligNum)
        CurrObligCount = CurrObligCount + 1;

        M75_res.GetData(CurrObligCount - 1, @M75_buf, @CurrOblig);
        if(CurrOblig != -1)
          println("~M75_" + CurrObligCount);
          println(M75_buf);
          println("~M75C_" + CurrObligCount);
          println(VA_CurrencyWr(M75_buf, CurrOblig));
        else
          println("~M75_" + CurrObligCount);
          println("");
          println("~M75C_" + CurrObligCount);
          println("");
        end;
      end;

      println("~M27");
      println("");
      println("~M28");
      println("");

      println("~M29");
      println("");
      println("~M30");
      println("");

    end;
  end;

  TempFile = SetOutPut(GetTxtFileName("tmpout"), false);
  if(SecurCount > 0)
    DLWREPS_PrintReportFromTagFile(TempFile);
  end;
  SetOutput(null, false);

end;

/****************************************************************************/
/* Функция печати                                                           */
/****************************************************************************/
private macro PrintRep(ID, DocKind)
   var TempFile;
   var vssrvdoc, Дата;
   var person  = TBFile("person");
   var OperName = "";
   var DataExist = false;

   person.rec.oper = {oper};
   if (person.GetEQ)
     OperName = person.rec.Name;
   end;

   InitDecType(DecType);
   InitDecPurp(DecPurp);
   InitOpType(OpType);

   println("PRT_overvalue.dot");
   println(GenFileName());

   vssrvdoc = Tbfile("vssrvdoc", "R", 0);
   vssrvdoc.rec.ID = ID;
   vssrvdoc.GetEQ();
   Дата = vssrvdoc.rec.ValueDate; /* Дата выполнения операции */
     
   DataExist = PrintReportTable(vssrvdoc);

   println("~OperName");
   println(OperName);

   println("~OperDate");
   println(Дата:f);

   TempFile = SetOutPut(GetTxtFileName("tmpout"), false);
   if( DataExist )
     DLWREPS_PrintReportFromTagFile (TempFile);
   end;
   SetOutput(null, false);

   // Переоценка по НВПИ вложений в ценные бумаги
//   PrintNVPI(ID, DocKind, Дата, "OF15.dot", OpType[15], DecType[14], DecPurp[21]);

   // Переоценка Т/О по поставке срочных сделок на внебалансе (кроме мен), балансе
//   PrintNVPI(ID, DocKind, Дата, "OF16.dot", OpType[15], DecType[14], DecPurp[21]);

   // Переоценка Т/О по поставке срочных сделок на внебалансе (для мен)
//   PrintNVPI(ID, DocKind, Дата, "OF17.dot", OpType[15], DecType[14], DecPurp[21]);

   return true;
end;


/****************************************************************************/
/* Точка входа                                                                    */
/****************************************************************************/
macro VA_PrintRepOverValue(ID, DocKind, УчитыватьНастройкуАвтоПечати)
  var flag, stat = 0,
      НастройкаАвтоПечать;
    
  if(УчитыватьНастройкуАвтоПечати == true)

     НастройкаАвтоПечать = "УЧТЕННЫЕ ВЕКСЕЛЯ\\РЕЖИМ РАБОТЫ\\АВТОМАТИЧЕСКАЯ ПЕЧАТЬ";
     GetRegistryValue(НастройкаАвтоПечать, V_BOOL, flag, stat);
     if(stat)
        msgbox("Не задана настройка в реестре банка:|", НастройкаАвтоПечать);
        return;
     end;
  else
     flag = true;
  end;

  if(flag == true)
    PrintRep(ID, DocKind);
  end; 
end;
