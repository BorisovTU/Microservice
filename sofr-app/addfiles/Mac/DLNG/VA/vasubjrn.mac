/*
$Name:             vasubjrn.mac
$Module:           –¥­­ë¥ ¡ã¬ £¨
$Description:      Žâç¥â "‘ã¡à¥£¨áâà á¯®à­ëå á¤¥«®ª"
*/

/*******************************************************************************
 FILE         :   vasubjrn.mac

 DESCRIPTION  :   Žâç¥âë "‘ã¡à¥£¨áâà á¯®à­ëå á¤¥«®ª" (”Š–)
 PROGRAMMED BY:   Nikonorov Evgeny

 CREATION DATE:   29.01.2009
*******************************************************************************/
import BankInter, DealsInter, CTInter, PTInter, "valib.mac";


private var  TableHead  = "ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                          "³          ³          ³          ³   Œ¥áâ®    ³          ‚¨¤         ³                  ³                   ³    ü    ³    ü      ³                    ³       ³                ³                    ³       ³                        ³‚ - ³  ‘â ¢ª   ³       ³                    ³‚ «îâ ³‚ «îâ ³   ¥à¥-  ³  ¥à¥-   ³   „ â    ³   „ â    ³      ®¤â¢¥à¦¤ îé¨© ¤®ªã¬¥­â      ³    Žâª §     ³ Žá­®¢ ­¨¥  ³  à¨­ïâë¥  ³\n"+
                          "³ ü á¤¥«ª¨ ³   „ â    ³   ‚à¥¬ï  ³ á®¢¥àè¥­¨ï ³        á¤¥«ª¨        ³    Š®­âà £¥­â    ³       Š«¨¥­â      ³¯®àãç¥­¨ï³ ¤®£®¢®à   ³      ¬¨â¥­â       ³‚¨¤ æ/¡³     Š®¤ æ/¡    ³      ‘¥à¨ï, ü      ³ ’à ­è ³          –¥­           ³«îâ ³   …Ž   ³Š®«-¢® ³   ‘ã¬¬  á¤¥«ª¨     ³ æ¥­ë ³à áç¥-³ à¥£¨áâà. ³ à¥£¨áâà. ³  ®¯« âë  ³  ®¯« âë  ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´              ³¤«ï ¢­¥á¥­¨ï³  ¬¥àë ¯®   ³\n"+
                          "³          ³          ³          ³   á¤¥«ª¨   ³                      ³                  ³                   ³         ³           ³                    ³       ³                ³                    ³       ³                        ³æ¥­ë³          ³       ³                    ³á¤¥«ª¨³ â®¢  ³   ¯« ­.  ³  ä ªâ.   ³   ¯« ­.  ³   ä ªâ.  ³  ‚¨¤ ¤®ª-â  ³ ü ¤®ª-â  ³   „ â    ³              ³ á¢¥¤¥­¨© ¢ ³  à §à¥è¥­¨î³\n"+         
                          "³          ³          ³          ³            ³                      ³                  ³                   ³         ³           ³                    ³       ³                ³                    ³       ³                        ³    ³          ³       ³                    ³      ³      ³          ³          ³          ³          ³             ³          ³          ³              ³ áã¡à¥£¨áâà ³  ¯à¥â¥­§¨© ³\n"+
                          "ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄ´";

private var SubRep = CMakeReport(TableHead);
private const FontStyleTitel =  "ex_FS(b)";

private record r_sfcontr(sfcontr);
private record rParty( party );
private record rFininstr( "fininstr" );

private const DEALTYPE_BROKER = 0,  /* ¡à®ª¥àáª¨¥ á¤¥«ª¨ */
              DEALTYPE_OWN    = 1,  /* á®¡áâ¢¥­­ë¥ á¤¥«ª¨ */
              DEALTYPE_DU     = 3;  /* ¤®¢¥à¨â¥«ì­®¥ ã¯à ¢«¥­¨¥*/


/* ‘âàãªâãà  á ¨áå®¤­ë¬¨ ¤ ­­ë¬¨ */
private class SourceData(
                  _DprtID:integer, _AvrTypeID: integer, _EmiID: integer,
                  _AvrID: integer, _DealType: integer,  _ClientID: integer, 
                  _IsFormID:integer, _FormSubID:integer, _IsVidID:integer, _VidSubID:integer, _NoResident:bool, 
                  _DealMarket:bool,_MarketID:integer, _DealNotMarket:bool, _DealBroker:bool,
                  _BrokerID:integer, _dateMin: date,  _dateMax: date,
                  _IsPartDate:bool,_DealStatus:integer, _Qualified:integer, _apostrSum: bool )

   var
      PrintHead,
      DprtID        =  _DprtID,
      AvrTypeID     =  _AvrTypeID,
      EmiID         =  _EmiID,
      AvrID         =  _AvrID,
      DealType      =  _DealType,
      ClientID      =  _ClientID,

      IsForm      = _IsFormID,
      FormSub     = _FormSubID,
      IsVid       = _IsVidID,
      VidSub      = _VidSubID,
      NoResident    = _NoResident,

      DealMarket    =  _DealMarket,
      MarketID      =  _MarketID,
      DealNotMarket =  _DealNotMarket,
      DealBroker    =  _DealBroker,
      BrokerID      =  _BrokerID,
      dateMin       =  _dateMin,
      dateMax       =  _dateMax,
      IsPartDate    =  _IsPartDate,
      DealStatus    =  _DealStatus,
      Qualified     =  _Qualified,
      IsApp         =  _apostrSum;

   var  AgentId = -1;

   var ReportName = "‘ã¡à¥£¨áâà á¯®à­ëå á¤¥«®ª á ­¥í¬¨áá¨®­­ë¬¨ æ¥­­ë¬¨ ¡ã¬ £ ¬¨";
end;

/*ˆ¬ï ¢¨¤  æ/¡*/
private macro AvoirKindName(AvoirKind);
   file avrkind ("avrkinds");   
   avrkind.FI_Kind = FIKIND_AVOIRISS;
   avrkind.AvoirKind = AvoirKind;
   if(not GetEQ(avrkind))
      msgbox("¥¨§¢¥áâ­ë© ¢¨¤ æ¥­­®© ¡ã¬ £¨ ", AvoirKind);
   end;
   return avrkind.Name;
end;

private var party_name  = TArray();
private var _rParty     = TRecHandler( "party.dbt" );

private macro  ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( PartyID )
   var _rParty     = TRecHandler( "party.dbt" );
   var party_name = "";
   if( PartyID >= 0 )
     if( not ®«ãç¨âì‘ã¡ê¥ªâ ( PartyID, _rParty ) )
        party_name = _rParty.rec.ShortName;
     end;
   end;
   return party_name;
END;

private macro PrintHead(Data, ReportDate, Department)
   
   var H = TArray; /*®¤ª ç¨¢ ¥¬ë¥ ¯®«ï (¨¬¥­  ¨ ­ §¢ ­¨ï), ®¤¨­ ª®¢ë¥ ¤«ï ¢á¥å 
                    á¤¥«®ª. Ž¯à¥¤¥«ïîâáï ¯à¨ ¯¥ç â¨ è ¯ª¨ ®âç¥â . */
   file Dprt( dp_dep );
   var  DprtName = "";
   //”¨«¨ «
   Dprt.Code = Department;
   if( GetEQ( Dprt ) )
     DprtName = ®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( Dprt.PartyID ); 
   end;

   /*‚¨¤ –*/
   if( Data.AvrTypeID != -1 )
      H[0] = AvoirKindName( Data.AvrTypeID );
   else H[0] = "";
   end;

   /*í¬¨â¥­â*/
   if( (Data.EmiID != -1) AND (not ®«ãç¨âì‘ã¡ê¥ªâ ( Data.EmiID, rParty )) )
      H[1] = rParty.ShortName;
   else H[1] = "";
   end;

   /*Š®¤ –*/
   if( (Data.AvrID > 0) AND (not ®«ãç¨âì”¨­ˆ­( Data.AvrID, rFininstr )) )
      H[2] = rFininstr.FI_Code;
   else H[2] = "";
   end;

   /*Š«¨¥­â*/
   if( (Data.ClientID != -1) AND (not ®«ãç¨âì‘ã¡ê¥ªâ ( Data.ClientID, rParty ) ))
      H[3] = rParty.ShortName;
   else H[3] = "";
   end;

   /*¨à¦ */
   H[4] = "";
   if( Data.DealMarket == true )
      H[4] = H[4] + "¨à¦¥¢ë¥ ";
      if ( Data.DealNotMarket == true )
         H[4] = H[4] + "¨ ¢­¥¡¨à¦¥¢ë¥ ";
      else H[4] = H[4] + "";
      end;
   else 
      if ( Data.DealNotMarket == true )
         H[4] = H[4] + "‚­¥¡¨à¦¥¢ë¥ ";
      else H[4] = H[4] + "";
      end;
   end;

   if( H[4] != "" )
      H[4] = H[4] + "á¤¥«ª¨";
   end;

   if( Data.DealBroker == true ) 
      if ( H[4] == "" )
         H[4] = H[4] + "‘¤¥«ª¨ ç¥à¥§ ¡à®ª¥à ";
      else 
         H[4] = H[4] + " ¨ á¤¥«ª¨ ç¥à¥§ ¡à®ª¥à ";
      end;
   end;

 
   if( (ValType(ReportDate) == V_DATE) and (Data.IsPartDate == true) )
      SubRep.AddPrintCell("                                       " + Data.ReportName + " §  ¤ âã " + ReportDate, SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   end;
   SubRep.AddStr();
   SubRep.AddPrintCell("‚¨¤ æ/¡:   " + H[0], SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
   SubRep.AddPrintCell("¬¨â¥­â:   " + H[1], SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
   SubRep.AddPrintCell("–¥­­ ï ¡ã¬ £ :  " + H[2], SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
   SubRep.AddPrintCell("Š«¨¥­â:    " + H[3], SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
   SubRep.AddPrintCell(H[4], SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
   SubRep.AddPrintCell("                                    ”¨«¨ «    " + DprtName, SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
   SubRep.AddEmptyStr();

end;

private macro StartPartition(PartName)
   SubRep.AddPrintCell(PartName, SubRep.GetHeaderWidth(), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   SubRep.AddStr();
end;

private macro PrintLine(DataSet, ReportDate, IsApp)
   var DealTypeName = "";
   var AvoirKindName = "";
   var DocDataSet, PmDataSet, query;
   var DocKindName = "";
   var DocNumber = "";
   var DocDate = "";
   var Note2="", Note3 = "";
   var BFactDate = "", CFactDate = "";

   //¢¨¤ á¤¥«ª¨
   if(VA_IsSale(DataSet.DealType))
     DealTypeName = "¯à®¤ ¦ ";
   elif(VA_IsBuy(DataSet.DealType))
     DealTypeName = "¯®ªã¯ª ";
   end;

   //¢¨¤ æ/¡
   if(FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BILL, DataSet.AvoirKind ))
     AvoirKindName = "‚¥ªá.¯à®áâ.";
   else 
     AvoirKindName = "„¥¯.á¥àâ.";
   end;

   //ä ªâ¨ç¥áª ï ¤ â  ¯®áâ ¢ª¨
   query =   " select pm.t_ValueDate from dpmpaym_dbt pm, dpmlink_dbt pl "
           + "  where pl.t_InitialPayment = " + DataSet.BPaymentID
           + "    and pm.t_PaymentID = pl.t_PurposePayment";

   PmDataSet = TRsbDataSet(query);
   if(PmDataSet.moveNext())
     BFactDate = date(PmDataSet.ValueDate);
   end;
   //ä ªâ¨ç¥áª ï ¤ â  ®¯« âë
   query =   " select pm.t_ValueDate from dpmpaym_dbt pm, dpmlink_dbt pl "
           + "  where pl.t_InitialPayment = " + DataSet.CPaymentID
           + "    and pm.t_PaymentID = pl.t_PurposePayment";

   PmDataSet = TRsbDataSet(query);
   if(PmDataSet.moveNext())
     CFactDate = date(PmDataSet.ValueDate);
   end;

   //¤®£®¢®à ªã¯«¨-¯à®¤ ¦¨
   query = "SELECT ground.T_XLD, ground.T_SIGNEDDATE "
            "FROM DSPGRDOC_DBT doc,DDL_TICK_DBT tk,DSPGROUND_DBT ground "
            "WHERE "
            "tk.T_DEALID = "+ DataSet.DealID+" " 
            "AND doc.T_SOURCEDOCKIND = tk.T_BOFFICEKIND "
            "AND doc.T_SOURCEDOCID = tk.T_DEALID "
            "AND ground.T_SPGROUNDID = doc.T_SPGROUNDID "
            "AND ground.t_Kind = 26";

   DocDataSet = TRSBDataSet(query);
   if(DocDataSet.moveNext())
     DocKindName = "¤®£®¢®à";
     DocNumber = "ü"+DocDataSet.XLD;
     DocDate = date(DocDataSet.SIGNEDDATE);
   end;

   Note2 = readNoteForObject( OBJTYPE_VEKSELACCOUNTED, string(L_Z(DataSet.DealID, 34)), 2, date(ReportDate));
   Note3 = readNoteForObject( OBJTYPE_VEKSELACCOUNTED, string(L_Z(DataSet.DealID, 34)), 3, date(ReportDate));


 /*A1*/   SubRep.AddPrintCell(DataSet.DealCode, 0, 0, "l:" + FontStyleTitel);
 /*A2*/   SubRep.AddPrintCell(date(DataSet.DealDate), 0, 0, "l:" + FontStyleTitel);
 /*A3*/   SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A4*/   SubRep.AddPrintCell("¢­¥ ¡¨à¦¨", 0, 0, "l:" + FontStyleTitel);
 /*A5*/   SubRep.AddPrintCell(DealTypeName, 0, 0, "l:" + FontStyleTitel);
 /*A6*/   SubRep.AddPrintCell(®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( DataSet.PartyID ), 0, 0, "l:" + FontStyleTitel);
 /*A7*/   SubRep.AddPrintCell(®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( DataSet.ClientID ), 0, 0, "l:" + FontStyleTitel);
 /*A8*/   SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A9*/   SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A10*/  SubRep.AddPrintCell(®«ãç¨âìŠ®à®âª®¥ˆ¬ï‘ã¡ê¥ªâ ( DataSet.Issuer ), 0, 0, "l:" + FontStyleTitel);
 /*A11*/  SubRep.AddPrintCell(AvoirKindName, 0, 0, "l:" + FontStyleTitel);
 /*A12*/  SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A13*/  SubRep.AddPrintCell(string(DataSet.BCSeries) + " ü"+string(DataSet.BCNumber), 0, 0, "l:" + FontStyleTitel);
 /*A14*/  SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A15*/  SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A16*/  SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*A17*/  SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);
 /*N18*/  SubRep.AddPrintCell("1", 0, 0, "l:" + FontStyleTitel); //¯® ª ¦¤®¬ã ¢¥ªá¥«î - ¢¥ªá¥«ì ¢á¥£¤  1
          if(IsApp)
 /*Œ19*/  SubRep.AddPrintCell(DataSet.BCCost, 0, 0, "l:a:" + FontStyleTitel);
          else
 /*Œ19*/  SubRep.AddPrintCell(DataSet.BCCost, 0, 0, "l:" + FontStyleTitel); 
          end; 
 /*A16*/  SubRep.AddPrintCell(DataSet.bccostfi_iso_number, 0, 0, "l:" + FontStyleTitel);
 /*A20*/  SubRep.AddPrintCell(DataSet.cmp_iso_number, 0, 0, "l:" + FontStyleTitel);
 /*D21*/  SubRep.AddPrintCell(date(DataSet.BPlanDate), 0, 0, "l:" + FontStyleTitel);
 /*D22*/  SubRep.AddPrintCell(date(BFactDate), 0, 0, "l:" + FontStyleTitel);
 /*D23*/  SubRep.AddPrintCell(date(DataSet.CPlanDate), 0, 0, "l:" + FontStyleTitel);
 /*D24*/  SubRep.AddPrintCell(date(CFactDate), 0, 0, "l:" + FontStyleTitel);
 /*A25*/  SubRep.AddPrintCell(DocKindName, 0, 0, "l:" + FontStyleTitel);                     
 /*A26*/  SubRep.AddPrintCell(DocNumber, 0, 0, "l:" + FontStyleTitel);
 /*A27*/  SubRep.AddPrintCell(DocDate, 0, 0, "l:" + FontStyleTitel);
 /*D28*/  SubRep.AddPrintCell("", 0, 0, "l:" + FontStyleTitel);                     
 /*A29*/  SubRep.AddPrintCell(Note2, 0, 0, "l:" + FontStyleTitel);
 /*A30*/  SubRep.AddPrintCell(Note3, 0, 0, "l:" + FontStyleTitel);
          SubRep.AddStr();
end;

private macro RunReport( Data:SourceData, IsExcel:bool )
   var DataSet, query;
   var isPrintOur = false;
   var isPrintClient = false;
   var isPrintTrust = false;
   var prevDep = 0;
   var count = 0;
   var realMinDate = Data.dateMin;
   var cDate = realMinDate;
   var isPrint = false;

   VAR ReportFileName, TblName = "vasubjrn", errcode, errtext;
   FILE ReportOutFile() txt write; /*ä ©« ¢ë¢®¤  ¤«ï ®âç¥â */

   //¯®«ãç¨âì ¬¨­¨¬ «ì­ãî ¤ âã á¤¥«ª¨
   query =   "select min(nt.t_Date) as DealDate"
           + "  from ddl_tick_dbt tk, dnotetext_dbt nt "
           + " where (tk.t_BOfficeKind = 141 or tk.t_BOfficeKind = 147)"
           + "    and (tk.t_CloseDate >= " + GetSQLDate(Data.dateMin) + " or tk.t_CloseDate = " +GetSQLDate(date(0,0,0))+ ")"
           + "    and nt.t_ObjectType = " + OBJTYPE_VEKSELACCOUNTED
           + "    and (nt.t_NoteKind = 2 or nt.t_NoteKind = 3)" 
           + "    and nt.t_DocumentID = LTRIM(TO_CHAR (tk.t_DealID, '0000000000000000000000000000000000')) ";
   DataSet = TRsbDataSet(query);
   if(DataSet.moveNext())
     realMinDate = date(DataSet.DealDate);
     if(realMinDate < Data.dateMin)
       realMinDate = Data.dateMin;
     end;
   end;

   cDate = realMinDate;
   InitProgress(Data.dateMax-realMinDate, "ˆ¤¥â ä®à¬¨à®¢ ­¨¥ ®âç¥â ...", "”®à¬¨à®¢ ­¨¥ ®âç¥â " );

   //®âç¥â §  ª ¦¤ãî ¤ âã ¯¥à¨®¤ 
   while(cDate <= Data.dateMax)

     isPrintOur = false;   
     isPrintClient = false;
     isPrintTrust = false; 

     prevDep = 0;
     
     //¢ë¡à âì ¢á¥ á¤¥«ª¨
     query =   " select NVL(ts.t_SfContrID,0) as sID, tk.t_ClientID, tk.t_Department, tk.t_DealID, "
             + " tk.t_DealCode, tk.t_DealDate, tk.t_DealType, tk.t_PartyID, lnk.t_BCCost, cfi.t_CCY as bccostfi_iso_number, "
             + " pcfi.t_CCY as cmp_iso_number, cpm.t_ValueDate as CPlanDate, bpm.t_ValueDate as BPlanDate, "
             + " bnr.t_Issuer, bnr.t_FIID, bnr.t_BCSeries, TRIM(bnr.t_BCNumber) as BCNumber, fin.t_AvoirKind, "
             + " cpm.t_PaymentID as CPaymentID, bpm.t_PaymentID as BPaymentID"
             + "   from dvsbanner_dbt bnr, dvsordlnk_dbt lnk, ddl_tick_dbt tk " 
             + " , dparty_dbt Pty  "
 
             + " , dnotetext_dbt nt, dtsorder_dbt ts, "
             + "        dfininstr_dbt fin, dfininstr_dbt cfi, dpmpaym_dbt cpm, "
             + "        dfininstr_dbt pcfi, dpmpaym_dbt bpm, doprkoper_dbt opr"
             + "  where bnr.t_BCID = lnk.t_BCID "

             + "    AND Pty.T_PARTYID (+) =  case when tk.T_CLIENTID  = -1 then " + {OurBank} +"   else tk.T_CLIENTID end  " 

             + "    and lnk.t_ContractID = tk.t_DealID "
             + "    and lnk.t_DocKind = tk.t_bofficekind "
             + "    and fin.t_FIID = bnr.t_FIID "
             + "    and cfi.t_FIID = lnk.t_BCCFI "
             + "    and (tk.t_CloseDate >= " + GetSQLDate(cDate) + " or tk.t_CloseDate = " +GetSQLDate(date(0,0,0))+ ")"
             + "    and (tk.t_BOfficeKind = 141 or tk.t_BOfficeKind = 147)"
             + "    and nt.t_ObjectType = " + OBJTYPE_VEKSELACCOUNTED
             + "    and (nt.t_NoteKind = 2 or nt.t_NoteKind = 3)" 
             + "    and nt.t_DocumentID = LTRIM(TO_CHAR (tk.t_DealID, '0000000000000000000000000000000000')) "
             + "    and nt.t_Date <= " + GetSQLDate(cDate)
             + "    and nt.t_ValidToDate >= " + GetSQLDate(cDate)
             + "    and cpm.t_DocKind = tk.t_BOfficeKind "
             + "    and cpm.t_DocumentID = tk.t_DealID "
             + "    and cpm.t_Purpose = " + Cai
             + "    and cpm.t_OrderFIID = lnk.t_BCCFI "
             + "    and cpm.t_OrderAmount = lnk.t_BCCost "
             + "    and pcfi.t_FIID = cpm.t_FIID "
             + "    and bpm.t_DocKind = tk.t_BOfficeKind "
             + "    and bpm.t_DocumentID = tk.t_DealID "
             + "    and bpm.t_Purpose = " + Bai
             + "    and ts.t_SfContrID (+)= tk.t_clientcontrid "
             + "    and opr.t_kind_operation = tk.t_dealtype and opr.T_SysTypes <> 'X' and opr.T_SysTypes <> 'XF' and opr.T_SysTypes <> 'XW' and opr.T_SysTypes <> 'WB' and opr.T_SysTypes <> 'WS'";
     if(Data.DprtID != -1)
       query = query + " and tk.t_Department = " + Data.DprtID;
     end;

     if(Data.DealStatus != -1)
       query = query + " and tk.t_DealStatus = " + Data.DealStatus;
     end;

     if(Data.AvrTypeID != -1)
       query = query + " and fin.t_AvoirKind = " + Data.AvrTypeID;
     end;

     if(Data.EmiID > 0)
       query = query + " and bnr.t_Issuer = " + Data.EmiID;
     end;

     if(Data.ClientID != -1)
       query = query + " and tk.t_ClientID = " + Data.ClientID;
     end;

     if( (Data.IsForm > 0) and (Data.FormSub != 0) )
       if(Data.IsForm == 1)
         query = query + "    and (Pty.T_LEGALFORM = " + String (Data.FormSub) + ")" ;
       end;
       if(Data.IsForm == 2)            	
         query = query + "    and  (Pty.T_LEGALFORM !=   " + String (Data.FormSub) + " )";
       end;
     end;

     if( (Data.IsVid > 0) and (Data.VidSub != 0) )            
       if(Data.IsVid == 1)
         query = query + "   and   ( EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub) +" and Pty.T_PARTYID = Pto.T_PARTYID)) " ;
       end;
       if(Data.IsVid == 2)            	
         query = query + "    and   (NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (Data.VidSub)+ " and Pty.T_PARTYID = Pto.T_PARTYID)) " ;
       end;
     end;

     if(Data.NoResident)
       query = query + " and ( Pty.T_NOTRESIDENT = 'X')";
     end;


     if(Data.DealType != -1)
       if(Data.DealType == DEALTYPE_OWN)
         query = query + " and tk.t_ClientID = -1 ";
       elif(Data.DealType == DEALTYPE_BROKER)
         query = query + " and tk.t_ClientID > -1 and (ts.t_SfContrID = 0 or ts.t_SfContrID is null)";
       elif(Data.DealType == DEALTYPE_DU)
         query = query + " and tk.t_ClientID > -1 and ts.t_SfContrID > 0";
       end;
     end;

     query = query + "  order by tk.t_Department asc, sID asc, tk.t_ClientID asc, tk.t_DealID asc "; //áà §ã á®àâ¨àã¥¬ ¯® à §¤¥« ¬

     DataSet = TRsbDataSet(query);
     while(DataSet.moveNext())
       
       if(prevDep != DataSet.Department)
         PrintHead(Data, cDate, DataSet.Department);
         isPrint = true;
       end;

       if((isPrintOur == false) and (DataSet.sID == 0) and (DataSet.ClientID == -1))
         StartPartition("‘®¡áâ¢¥­­ë¥ á¤¥«ª¨");
         isPrintOur = true;
       end;

       if((isPrintClient == false) and (DataSet.sID == 0) and (DataSet.ClientID > -1))
         StartPartition("à®ª¥àáª¨¥ á¤¥«ª¨");
         isPrintClient = true;
       end;

       if((isPrintTrust == false) and (DataSet.sID > 0) and (DataSet.ClientID > -1))
         StartPartition("„®¢¥à¨â¥«ì­®¥ ã¯à ¢«¥­¨¥");
         isPrintTrust = true;
       end;

       PrintLine(DataSet, cDate, Data.IsApp);

       prevDep = DataSet.Department;
     end;

     if((isPrintOur) or (isPrintClient) or (isPrintTrust))
       after_44_footer(SubRep);
     end;

     cDate = cDate + 1;
     UseProgress(count = count + 1);
   end;

   RemProgress();

   if( isPrint == false )
     msgbox( "\n ‚ ãª § ­­ë© ¯¥à¨®¤ á¤¥«®ª c ­¥í¬¨áá¨®­­ë¬¨ æ/¡, á®®â¢¥âáâ¢ãîé¨å ¯ à ¬¥âà ¬ ®âç¥â , ­¥ ¯à®¢®¤¨«®áì.\n");
     return;
   else
     if( IsExcel )
        SubRep.PrintWinRep();
        SubRep.ShowWinRep();
     else
        ReportFileName = GetTxtFileName( TblName );
        
        if( Open( ReportOutFile, ReportFileName ) == false )
           errcode = status( errtext );
           MsgBox( "Žè¨¡ª  ¯à¨ ®âªàëâ¨¨ ä ©«  ®âç¥â |"+ ReportFileName +"|(" + errcode + ") " + errtext);
           break;
        end;
        
        SetOutput( ReportFileName );
        SubRep.PrintRep();
        SetOutput( NULL, true );
        close( ReportOutFile );
        ViewFile( ReportOutFile );    
     end;
   end;
   
end;

/*‡ ¯ãáª ®âç¥â  "‘ã¡à¥£¨áâà á¯®à­ëå á¤¥«®ª"*/
macro VASubRegisterReport( DataFromPan:DlSubJrnFormData )

   var Data = SourceData(  DataFromPan.DepartmentID,  DataFromPan.FIAvrKindID, DataFromPan.EmiID, DataFromPan.AvrKindID, 
                           DataFromPan.DealType, DataFromPan.ClientID,
                           DataFromPan.IsForm, DataFromPan.FormSub, DataFromPan.IsVid, DataFromPan.VidSub, DataFromPan.NoResident,
                           DataFromPan.IsMarket, DataFromPan.MarketID, 
                           DataFromPan.IsOutMkt, DataFromPan.IsBroker, DataFromPan.BrokerID,
                           DataFromPan.BeginDate, DataFromPan.EndDate, true, DataFromPan.DealStatus, NULL, DataFromPan.IsUseApp ); 
   RunReport( Data, DataFromPan.IsExportToExel );
end;
