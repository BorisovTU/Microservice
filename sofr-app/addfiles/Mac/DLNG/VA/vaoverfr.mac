/*
$Name:         vaoverfr.mac
$Module:       Учтенные векселя
$Description:  Переоценка СС
*/

import vafrfun, InsCarryDoc, OprInter, PaymInter, vaservop, vaprdec, vaprdeca;

MACRO ExecuteStep(Buffer, FirstDoc)
  var stat = 0;
  var Дата={curdate};
  var ObjType = OverObjType;
  record tick("dl_tick");
  var tickFd;
  
  SetBuff( tick, FirstDoc );

  if((ValType(OprServDoc) != V_UNDEF) and (OprServDoc.ValueDate > date(0,0,0)))
    Дата = OprServDoc.ValueDate;
  end;

  if((tickFd = VATickFD(tick)) == null)
    return VA_Err("Ошибка при определении первичного документа сделки");
  end;

  if(УВ_ЕстьУчтеннаяСС(0, tickFd.GetTick().DealID, Дата) != 0)
    stat = УВ_ВыполнитьПереоценкуСС(tickFd, Дата);
  else
    stat = УВ_ВыполнитьУчётСС(tickFd, tick.DealDate);
  end;
  
  return stat;

END;