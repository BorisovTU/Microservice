/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : vap010.mac
                                va-вексель
                                 p-операция залога векселей (pawn)
                               010-номер (соответствующий шагу)
  Programmer  : Чижик К.Н.
  Операция    : Залог векселей
  Шаг         : Инициализация
  Comment     :
└───────────────────────────────────────────────────────────────────────────*/
IMPORT InsCarryDoc, vapawn, valib;


/* Запуск шага
   Алгоритм:
   Проинициализировать даты операции:
   Dп = dl_leg.Start         (Дата передачи в залог)
   Dв = dl_leg.Maturity      (Дата возврата из залога)
*/
MACRO ExecuteParamStep(OperationKind, DocKind, Document)

    record  tick(dl_tick);
    var     stat = 0, TransferDate, ReturnDate,
            leg0 = TBfile ("dl_leg");    /* Транш 1 части сделки */

    SetBuff(tick, Document); 

    if(not VA_FindLeg_ForTick(leg0, tick.DealID, 0))
       stat = VA_Err("Не найдены ценовые условия сделки");
       return stat;
    end;

    TransferDate = leg0.rec.Start;
    ReturnDate   = leg0.rec.Maturity;

    DefineOprDate( DATE_PAWN_TRANSFER,  TransferDate);    /* Дата передачи в залог */
    DefineOprDate( DATE_PAWN_RETURN,    ReturnDate);      /* Дата возврата из залога */

    return stat;

END;


/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    return 1;

END;


/* Макрос печати 
*/
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */

    exit(1);

END;


