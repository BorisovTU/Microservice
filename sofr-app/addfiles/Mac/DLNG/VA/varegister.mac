/*
$Name:         varegister.mac
$Module:       Учтенные векселя
$Description:  Отчет_Регистр по учтенным векселям
$Autor:        Романов С.А.
*/
IMPORT "ws_txreportform.mac", "dlregister_form.mac", "ws_dprt.mac";
Import dlmisc, vslib, vaprdslib;

private const NoDataTxt = "ДАННЫХ НЕТ";

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_rshb = 12;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb = 13;
PRIVATE CONST НОМЕР_СТРОКИ_ИТОГОВЫХ_СУММ_rshb = 7;

PRIVATE CONST SHEET_VAREGISTER  = "АР-07-19";

///// Column Names
private const	C_dummy	=	"A";
private const	C_A1	=	"B";
private const	C_A2	=	"C";
private const	C_A3	=	"D";
private const	C_A4	=	"E";
private const	C_A5	=	"F";
private const	C_A6	=	"G";
private const	C_A7	=	"H";
private const	C_A8	=	"I";
private const	C_A9	=	"J";
private const	C_A10	=	"K";
private const	C_A11	=	"L";
private const	C_A12	=	"M";
private const	C_A13	=	"N";
private const	C_A14	=	"O";
private const	C_A15	=	"P";
private const	C_A16	=	"Q";
private const	C_A17	=	"R";
private const	C_A18	=	"S";
private const	C_A19	=	"T";
private const	C_A20	=	"U";
private const	C_A21	=	"V";
private const	C_A22	=	"W";
private const	C_A23	=	"X";
private const	C_A24	=	"Y";
private const	C_A25	=	"Z";
private const	C_A26	=	"AA";
private const	C_A27	=	"AB";
private const	C_A28	=	"AC";
private const	C_A29	=	"AD";
private const	C_A30	=	"AE";
private const	C_A31	=	"AF";
private const	C_A32	=	"AG";
private const	C_A33	=	"AH";
private const	C_A34	=	"AI";
private const	C_A35	=	"AJ";
private const	C_A36	=	"AK";
private const	C_A37	=	"AL";
private const	C_A38	=	"AM";
private const	C_A39	=	"AN";
private const	C_A40	=	"AO";
private const	C_A41	=	"AP";
private const	C_A42	=	"AQ";
private const	C_A43	=	"AR";
private const	C_A44	=	"AS";
private const	C_A45	=	"AT";
private const	C_A46	=	"AU";
private const	C_A47	=	"AV";
private const	C_A48	=	"AW";
private const	C_A49	=	"AX";
private const	C_A50	=	"AY";
private const	C_A50_1	=	"AZ";
private const	C_A51	=	"BA";
private const	C_A52	=	"BB";
private const	C_A52_1	=	"BC";
private const	C_A53	=	"BD";
private const	C_A54	=	"BE";
private const	C_A55	=	"BF";
private const	C_A56	=	"BG";
private const	C_A57	=	"BH";
private const	C_A58	=	"BI";
private const	C_A59	=	"BJ";
private const	C_A60	=	"BK";
private const	C_A61	=	"BL";
private const	C_A62	=	"BM";
private const	C_A63	=	"BN";
private const	C_A64	=	"BO";
private const	C_A65	=	"BP";
private const	C_A66	=	"BQ";
private const	C_A67	=	"BR";
////

PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб
PRIVATE VAR WebFormData;
PRIVATE VAR VARegister_Form;

  var PeriodTypeOpen  = 1;
  var PeriodTypeClose = 2;
  var i = 0; 

PRIVATE VAR ALG_PC_BASIS = 2317;

PRIVATE MACRO NameAlg(type, num)
  var alg = TBfile("namealg");
  alg.KeyNum = 0;
  alg.rec.iTypeAlg = type;
  alg.rec.iNumberAlg = num;
  if( not GetEq(alg) )
    return "";
  else
    return alg.rec.szNameAlg;
  end;
END;

PRIVATE MACRO Операционист()
  var RS = TRsbDataSet("SELECT person.t_Name " +
                       "  FROM dperson_dbt person " +
                       " WHERE person.t_oper = " + string({oper})
                      );

  if( RS.MoveNext() )
     return RS.Name;
  end;
  return "";
END;

//DL_VEKSELACCOUNTED = 141 сделка с УВ

/* Статусы
  VABANNER_STATUS_ALL     = -1,   // любой
  VABANNER_STATUS_INPUT   =  0 ,  // введен
  VABANNER_STATUS_ACCOUNT =  100, // учтен
  VABANNER_STATUS_ENDED   =  200, // погашен
  VABANNER_STATUS_MAX     =  300  // максимальная планка (в случае добавления элементов сдвигать)
*/
PRIVATE CONST 
  ANAME = "valA",
  A01 = 1,
  A02 = 2,
  A03 = 3,
  A04 = 4,
  A05 = 5,
  A06 = 6,
  A07 = 7,
  A08 = 8,
  A09 = 9,
  A10 = 10,
  A11 = 11,
  A12 = 12,
  A13 = 13,
  A14 = 14,
  A15 = 15,
  A16 = 16,
  A17 = 17,
  A18 = 18,
  A19 = 19,
  A20 = 20,
  A21 = 21,
  A22 = 22,
  A23 = 23,
  A24 = 24,
  A25 = 25,
  A26 = 26,
  A27 = 27,
  A28 = 28,
  A29 = 29,
  A30 = 30,
  A31 = 31,
  A32 = 32,
  A33 = 33,
  A34 = 34,
  A35 = 35,
  A36 = 36,
  A37 = 37,
  A38 = 38,
  A39 = 39,
  A40 = 40,
  A41 = 41,
  A42 = 42,
  A43 = 43,
  A44 = 44,
  A45 = 45,
  A46 = 46,
  A47 = 47,
  A48 = 48,
  A49 = 49,
  A50 = 50,
  A50_1 = 51,
  A51 = 52,
  A52 = 53,
  A52_1 = 54,
  A53 = 55,
  A54 = 56,
  A55 = 57,
  A56 = 58,
  A57 = 59,
  A58 = 60,
  A59 = 61,
  A60 = 62,
  A61 = 63,
  A62 = 64,
  A63 = 65,
  A64 = 66,
  A65 = 67,
  A66 = 68,
  A67 = 69,
  AMAX = 70; //Верхняя граница при добавление/удаление сдвигать

CLASS BnrPeriodInfo(DataSet)
  var ID_Operation,
      lnk_BCCost,
      lnk_BCCFI,
      Client_ShortName,
      ClientID,
      Country_FullName,
      tick_DealId,
      tick_DocKind,
      tick_DealCode,
      tick_DealDate,
      tick_ClientID,
      FirstDate,
      Department;

  MACRO Constructor(DataSet)
    ID_Operation = DataSet.ID_Operation;
    lnk_BCCost = DataSet.lnk_BCCost;
    lnk_BCCFI = DataSet.lnk_BCCFI;
    Client_ShortName = DataSet.Client_ShortName;
    ClientID = DataSet.ClientID;
    Country_FullName = DataSet.Country_FullName;
    tick_DealId = DataSet.tick_DealId;
    tick_DocKind = DataSet.tick_DocKind;
    tick_DealCode = DataSet.tick_DealCode;
    FirstDate = DataSet.FirstDate;
    tick_DealDate = SQL_ConvTypeDate(DataSet.tick_DealDate);
    tick_ClientID = SQL_ConvTypeInteger(DataSet.tick_ClientID);
    Department = DataSet.Department;
  END;

  Constructor(DataSet);
END;

CLASS RegistryPeriod ( src_VekselID, src_PeriodDateBegin, src_PeriodDateEnd, src_PeriodType, src_InfoBuy, src_InfoRep) 
  var
  VekselID:INTEGER,
  PeriodDateBegin:DATE,
  PeriodDateEnd:DATE,
  PeriodType:INTEGER,
  InfoBuy:BnrPeriodInfo,
  InfoRep:BnrPeriodInfo;

  VekselID = src_VekselID;
  PeriodDateBegin = src_PeriodDateBegin;
  PeriodDateEnd = src_PeriodDateEnd ;
  PeriodType = src_PeriodType;
  InfoBuy = src_InfoBuy;
  InfoRep = src_InfoRep;
END;

private macro Oper_rshb():string
  var fio = GetPersnFIOByID(GetOperRecByID({oper}).PartyID);
  if(fio == "")
     return GetOperRecByID({oper}).Name;
  else
     return ConvetFIO_Report(fio);
  end;  
end;


CLASS ReportData()
  var 
      valA1,  
      valA2,  
      valA3,  
      valA4,  
      valA5,  
      valA6,  
      valA7,  
      valA8,  
      valA9,  
      valA10, 
      valA11, 
      valA12, 
      valA13, 
      valA14, 
      valA15, 
      valA16, 
      valA17, 
      valA18, 
      valA19, 
      valA20, 
      valA21, 
      valA22, 
      valA23, 
      valA24, 
      valA25, 
      valA26, 
      valA27, 
      valA28, 
      valA29, 
      valA30, 
      valA31, 
      valA32, 
      valA33, 
      valA34, 
      valA35, 
      valA36, 
      valA37, 
      valA38, 
      valA39, 
      valA40, 
      valA41, 
      valA42, 
      valA43, 
      valA44, 
      valA45, 
      valA46, 
      valA47, 
      valA48, 
      valA49, 
      valA50, 
      valA51,
      valA52, 
      valA53, 
      valA54,
      valA55, 
      valA56, 
      valA57, 
      valA58, 
      valA59, 
      valA60, 
      valA61, 
      valA62, 
      valA63, 
      valA64, 
      valA65, 
      valA66, 
      valA67, 
      valA68, 
      valA69;

  macro set_A(Num, val, err)
    var stat = 0;
    if(Num < AMAX)
      GenSetProp(this, ANAME + Num, val);
    else 
      stat = 1;
    end; 
    SetParm( 3, stat );
  end;

  macro get_A(Num, err)
    var stat = 0;

    if(Num < AMAX)
      SetParm( 1, stat );
      return IIF( VALTYPE(GenGetProp(this, ANAME + Num)) != V_UNDEF, GenGetProp(this, ANAME + Num), "");
    else
      stat = 1;
    end;
    SetParm( 2, stat );
  end;

  macro ClearData()
    var i = 1;
    
    while (i < AMAX)
      GenSetProp(this,ANAME+i,NULL);
      i=i+1;
    end;
  end;

  private macro Constructor()
    ClearData();
  end;

  Constructor();
END;

PRIVATE CLASS ( DL_CReportTemplate ) VA_Register_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL )
  PRIVATE CONST
    LineTypeData  = 0,
    LineTypeTotal = 2,
    LineType3     = 3;//в том числе
  private const LineTypeNoData = 4;

  var
    m_BeginDate:DATE,                //дата начала отчётного периода
    m_EndDate:DATE,                  //дата окончания отчётного периода
    m_CurCurrencyList,
    m_SelectedDepartamentList,
    m_Query:STRING,
    m_DataSetBanners,
    m_CmdQuery,
    m_CmdQueryFinnaly,
    m_NRecsBNRS:INTEGER,
    m_QueryFinnaly:STRING,    
    m_SubQueryFinnaly:STRING,    
    m_RegistryPeriodArray,
    m_fd,
    m_leg,
    m_bnr,
    m_leg_Price,
    m_DepartmentName,
    m_isВексельДисконтный:BOOL,
    m_isВексельПроцентный:BOOL,
    m_IncomeDateType,
    m_Data,
    m_DataSize = 0;

  var
    m_N1_A07_TOTAL = 0.0,
    m_N1_A15_TOTAL = 0.0,
    m_N1_A17_TOTAL = 0.0,
    m_N1_A21_TOTAL = 0.0,
    m_N1_A23_TOTAL = 0.0,
    m_N1_A24_TOTAL = 0.0,
    m_N1_A25_TOTAL = 0.0,
    m_N1_A26_TOTAL = 0.0,
    m_N1_A27_TOTAL = 0.0,
    m_N1_A28_TOTAL = 0.0,
    m_N1_A29_TOTAL = 0.0,
    m_N1_A30_TOTAL = 0.0,
    m_N1_A31_TOTAL = 0.0,
    m_N1_A32_TOTAL = 0.0,
    m_N1_A34_TOTAL = 0.0,
    m_N1_A37_TOTAL = 0.0,
    m_N1_A39_TOTAL = 0.0,
    m_N1_A40_TOTAL = 0.0,
    m_N1_A41_TOTAL = 0.0,
    m_N1_A42_TOTAL = 0.0,
    m_N1_A43_TOTAL = 0.0,
    m_N1_A45_TOTAL = 0.0,
    m_N1_A46_TOTAL = 0.0,
    m_N1_A47_TOTAL = 0.0,
    m_N1_A48_TOTAL = 0.0,
    m_N1_A49_TOTAL = 0.0,
    m_N1_A60_TOTAL = 0.0;
    
  var m_CountDataStr = 0;  
    
  PRIVATE MACRO InitVariables()
    if( m_IsWebService )
      m_BeginDate = WebFormData.BeginDate;
      m_EndDate   = WebFormData.EndDate;
      m_CurCurrencyList = WebFormData.CurFIIDList;
      m_SelectedDepartamentList = WebFormData.CurDepartmentList;
    else
      m_BeginDate = VARegister_Form.GetFieldValue(PNFLD_DLREGREP_BEGINDATE);
      m_EndDate   = VARegister_Form.GetFieldValue(PNFLD_DLREGREP_ENDDATE);
      if (VARegister_Form.GetFieldValue(PNFLD_DLREGREP_FI) != ALLFININSTR)
        m_CurCurrencyList = TArray();
        var fininstr = Tbfile("fininstr.dbt", "R", 0);
        fininstr.Clear();
        fininstr.rec.FIID = VARegister_Form.GetFieldValue(PNFLD_DLREGREP_FI);
        fininstr.GetEQ();
        m_CurCurrencyList[m_CurCurrencyList.size] = TWsFinInstr(fininstr.rec.fiid, null, fininstr.rec.fi_code, fininstr.rec.fi_kind, null, fininstr.rec.name);
      end;
      if (VARegister_Form.GetFieldValue(PNFLD_DLREGREP_DEPARTCODE) != -1)
        m_SelectedDepartamentList = TArray();
        var Dprt:TWsDepartment;
        Dprt.Code = VARegister_Form.GetFieldValue(PNFLD_DLREGREP_DEPARTCODE);
        Dprt.PartyName = DL_GetDepartmentNameByCode(Dprt.Code);
        m_SelectedDepartamentList[m_SelectedDepartamentList.size] = Dprt;
      end;
    end;
    m_RegistryPeriodArray = TArray();
    m_Data = TArray;

    m_NRecsBNRS = 0;
    m_CountDataStr = 0;
  END;
 
  PRIVATE MACRO VA_DataExist()
    return m_NRecsBNRS > 0;
  END;
 
  PRIVATE MACRO CReport_DataExist()
    return true;
  END;

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO ПолучитьКороткоеИмяСубъекта( PartyID )
     var _rParty     = TRecHandler( "party.dbt" );
     var party_name = "";
     if( PartyID >= 0 )
       if( not ПолучитьСубъекта( PartyID, _rParty ) )
          party_name = _rParty.rec.ShortName;
       end;
     end;
     return party_name;
  END;

  PRIVATE MACRO ПолучитьИмяСубъекта( PartyID )
     var _rParty     = TRecHandler( "party.dbt" );
     var party_name = "";
     if( PartyID >= 0 )
       if( not ПолучитьСубъекта( PartyID, _rParty ) )
          party_name = _rParty.rec.Name;
       end;
     end;
     return party_name;
  END;

  PRIVATE MACRO GetDepartmentName(Department)
    var Dep = TBfile("dp_dep");
    var DpCode = "";

    if ( Department == Dep.rec.Code)
        DpCode = Dep.rec.Name;
    elif ( Department != 0 )
      Dep.KeyNum = 0;
      Dep.rec.Code = m_bnr.rec.Department;
      if ( Dep.GetEQ )
        DpCode = Dep.rec.Name;//ПолучитьИмяСубъекта(Dep.rec.PartyID);
      end;
    end;

    return DpCode;
  END;

  MACRO VA_GetFI_ISO_Code(FIID)
    VAR fininstr = Tbfile("fininstr.dbt", "R", 0);
  
    VA_ByDefault(FIID, 0);

    fininstr.rec.FIID = FIID;
    if(fininstr.GetEQ)
        return(fininstr.rec.Ccy);
    end;

    return "";
  END;

  PRIVATE MACRO _getINN(INN)
     var ind_slash = Index(INN,"/");
     if ( ind_slash != 0 ) return SubStr(INN, 1, ind_slash-1); end;
     return INN;
  END;
  
  PRIVATE MACRO _getKPP(INN)
     var ind_slash = Index(INN,"/");
     if ( ind_slash != 0 ) return SubStr(INN, ind_slash+1); end;
     return "";
  END;

  PRIVATE MACRO SetSqlDataQuery()
    /***********************************************************/
    /* берём векселя, не погашенные к началу отчётного периода */
    /* и имеющие на конец отчётного периода статусы:           */
    /* "Выдан", "Выкуплен" или "Погашен"                       */
    /***********************************************************/
    var _index = 0;
    var DepStr = "";
    if ( ( m_SelectedDepartamentList != NULL ) and ( m_SelectedDepartamentList.size > 0 ) )
      while  (_index < m_SelectedDepartamentList.size)
        if (_index > 0 )
          DepStr = DepStr + ",";
        end;
        DepStr = DepStr + m_SelectedDepartamentList[_index].Code;
        _index = _index + 1;
      end;
    end;

    var PFIStr = "";
    var _indexPFI = 0;
    if ( ( m_CurCurrencyList != NULL ) and ( m_CurCurrencyList.size > 0 ) )
      while  (_indexPFI < m_CurCurrencyList.size)
        if (_indexPFI > 0 )
          PFIStr = PFIStr + ",";
        end;
        PFIStr = PFIStr + m_CurCurrencyList[_indexPFI].FIID;
        _indexPFI = _indexPFI + 1;
      end;
    end;
    
    m_Query =           " SELECT Bnr.t_BCID, legbnr.t_PFI, rsb_bill.GetBNRFirstDate (bnr.t_bcid, lnk.t_ContractID) FirstDate ";
    m_Query = m_Query + "     FROM dvsbanner_dbt Bnr, dvsordlnk_dbt lnk, ddl_leg_dbt legbnr ";
    m_Query = m_Query + "    WHERE     RSB_BILL.GetVABnrStatusOnDate ( Bnr.t_BCID, ? ) != ? ";//m_BeginDate VABANNER_STATUS_ENDED
    m_Query = m_Query + "          AND (   RSB_BILL.GetVABnrStatusOnDate ( Bnr.t_BCID, ?) IN (?, ?) ";//m_EndDate VABANNER_STATUS_ENDED VABANNER_STATUS_ACCOUNT
    m_Query = m_Query + "               OR (INSTR (RSB_BILL.GetVABnrStateOnDate(Bnr.t_BCID, ?), 'Р') > 0  ";
    m_Query = m_Query + "                   AND LENGTH(RSB_BILL.GetVABnrStateOnDate(Bnr.t_BCID, ?)) = 1)) ";
    m_Query = m_Query + "          AND lnk.t_BCID = bnr.t_BCID"; 
    m_Query = m_Query + "          AND lnk.t_DocKind IN (?, ?) "; //DL_VEKSELACCOUNTED, DL_VAENWR 
    m_Query = m_Query + "          AND lnk.t_linkkind = 1 ";
    m_Query = m_Query + "          AND legbnr.t_DealId = Bnr.t_bcid ";
    m_Query = m_Query + "          AND legbnr.t_LegKind = 1 ";
    m_Query = m_Query + "          AND lnk.t_ContractID IN (SELECT TO_NUMBER(opr.T_DOCUMENTID) AS T_DOCUMENTID                           ";
    m_Query = m_Query + "                                     FROM doprdocs_dbt odoc, DOPROPER_DBT opr ";
    m_Query = m_Query + "                                    WHERE     odoc.t_DocumentID = (select CASE  ";
    m_Query = m_Query + "                                             WHEN RSB_BILL.GetVABnrStatusOnDate (Bnr.t_bcid, ?) = 100 "; //m_BeginDate
    m_Query = m_Query + "                                             THEN  ";
    m_Query = m_Query + "                                                (SELECT LTRIM (TO_CHAR (MAX (BnrHist.t_id), '0000000000')) DocID ";
    m_Query = m_Query + "                                                   FROM dvsbnrbck_dbt BnrHist ";
    m_Query = m_Query + "                                                  WHERE     BnrHist.t_BCID = Bnr.t_bcid ";
    m_Query = m_Query + "                                                        AND BnrHist.t_ABCStatus = 'X' ";
    m_Query = m_Query + "                                                        AND BnrHist.t_NewabcStatus = 100 ";
    m_Query = m_Query + "                                                        AND BnrHist.t_OldabcStatus = 0 ";
    m_Query = m_Query + "                                                        AND BnrHist.t_ChangeDate <= ?) ";
    m_Query = m_Query + "                                             WHEN RSB_BILL.GetVABnrStatusOnDate (Bnr.t_bcid, ?) = 0 "; //m_BeginDate
    m_Query = m_Query + "                                             THEN  ";
    m_Query = m_Query + "                                                (SELECT LTRIM (TO_CHAR (MIN (BnrHist.t_id), '0000000000')) DocID ";
    m_Query = m_Query + "                                                   FROM dvsbnrbck_dbt BnrHist ";
    m_Query = m_Query + "                                                  WHERE     BnrHist.t_BCID =Bnr.t_bcid ";
    m_Query = m_Query + "                                                        AND BnrHist.t_ABCStatus ='X' ";
    m_Query = m_Query + "                                                        AND BnrHist.t_NewabcStatus = 100 ";
    m_Query = m_Query + "                                                        AND BnrHist.t_OldabcStatus = 0 ";
    m_Query = m_Query + "                                                        AND BnrHist.t_ChangeDate BETWEEN ? "; //m_BeginDate
    m_Query = m_Query + "                                                                                     AND ?) "; //m_EndDate
    m_Query = m_Query + "                                          END from dual) ";
    m_Query = m_Query + "                                          AND odoc.t_DocKind = ? "; //DL_VSBNRBCK
    m_Query = m_Query + "                                          AND opr.t_ID_Operation = ";
    m_Query = m_Query + "                                                 odoc.t_ID_Operation) ";


    if (DepStr != "")
      m_Query = m_Query + "  and Bnr.t_Department in ("+DepStr+") ";
    end;
    if (PFIStr != "")
      m_Query = m_Query + "  and legbnr.t_PFI in ("+PFIStr+") ";
    end;
    m_Query = m_Query + " GROUP BY bnr.t_bcid, lnk.t_ContractID, legbnr.t_PFI ";
    m_Query = m_Query + " ORDER BY legbnr.t_PFI, FirstDate ";
  END;
  
  PRIVATE MACRO SetSqlDataSet()    
    m_CmdQuery = RSDCommand("SELECT COUNT(*) nRecs FROM (" + m_Query + ")");
    m_CmdQuery.addParam( "", RSDBP_IN, m_BeginDate );
    m_CmdQuery.addParam( "", RSDBP_IN, VABANNER_STATUS_ENDED );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, VABANNER_STATUS_ENDED );
    m_CmdQuery.addParam( "", RSDBP_IN, VABANNER_STATUS_ACCOUNT );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, DL_VEKSELACCOUNTED );
    m_CmdQuery.addParam( "", RSDBP_IN, DL_VAENWR );
    m_CmdQuery.addParam( "", RSDBP_IN, m_BeginDate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_BeginDate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_BeginDate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_BeginDate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, DL_VSBNRBCK );
    m_CmdQuery.execute(); 
    
    var  tm_dataSet = TRsbDataSet(m_CmdQuery);
    if ( tm_dataSet.moveNext() )
        m_NRecsBNRS = Int(tm_dataSet.nRecs);
    else
        m_NRecsBNRS = 0;
    end;
  
    m_CmdQuery = RSDCommand(m_Query);
    m_CmdQuery.addParam( "", RSDBP_IN, m_BeginDate );
    m_CmdQuery.addParam( "", RSDBP_IN, VABANNER_STATUS_ENDED );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, VABANNER_STATUS_ENDED );
    m_CmdQuery.addParam( "", RSDBP_IN, VABANNER_STATUS_ACCOUNT );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, DL_VEKSELACCOUNTED );
    m_CmdQuery.addParam( "", RSDBP_IN, DL_VAENWR );
    m_CmdQuery.addParam( "", RSDBP_IN, m_begindate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_begindate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_begindate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_begindate );
    m_CmdQuery.addParam( "", RSDBP_IN, m_EndDate );
    m_CmdQuery.addParam( "", RSDBP_IN, DL_VSBNRBCK );
    m_CmdQuery.execute();    

    m_DataSetBanners = TRsbDataSet( m_CmdQuery );
  END;
  
  PRIVATE macro GetPlanRepayDate(BCID)
    var fd = VSBannerFD(DL_VSBANNER, BCID);
    return DL_GetBnrPlanRepayDate(fd.getbnr(), fd.getleg())
  END;

  PRIVATE MACRO НаполненияПолейВекс()
    //составные части для "ТИП векселя":
    var _FirstSymbols:STRING;
    var _SecondSymbols:STRING;
    var _ThirdSymbols:STRING;
    var date_repay_cond;
    var days_before_repay;
    var limit_repay_date;

    m_DepartmentName = GetDepartmentName(m_RegistryPeriodArray[i].InfoBuy.Department);

    m_Data[m_DataSize - 1].set_A(A01, string(m_DepartmentName));
    m_Data[m_DataSize - 1].set_A(A02, ПолучитьКороткоеИмяСубъекта(m_bnr.rec.Issuer));
    m_Data[m_DataSize - 1].set_A(A03, string(Trim(m_bnr.rec.BCSeries) + " " + Trim(m_bnr.rec.BCNumber)));
    m_Data[m_DataSize - 1].set_A(A05, SQL_ConvTypeDate( m_leg.rec.Start ));
    m_Data[m_DataSize - 1].set_A(A07, m_leg.rec.Principal);

    _FirstSymbols = ""; _SecondSymbols = ""; _ThirdSymbols = "";
    
    if (m_isВексельПроцентный)
      _FirstSymbols = "П";
    else
      _FirstSymbols = "Д";
    end;
    
    
    if ( m_bnr.rec.BCTermFormula == VS_TERMF_FIXEDDAY)               //День. На определенный день      
      _SecondSymbols = "ос";
      date_repay_cond = SQL_ConvTypeDate( m_leg.rec.Maturity );
      days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate);
      limit_repay_date = date_repay_cond;
    end;
    if ( m_bnr.rec.BCTermFormula == VS_TERMF_INATIME)                //Период. Во столько-то времени от составления      
      _SecondSymbols = "свс";
      date_repay_cond = SQL_ConvTypeDate( m_leg.rec.Maturity );
      days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate);
      limit_repay_date = date_repay_cond;
    end;
    if ( m_bnr.rec.BCTermFormula == VS_TERMF_ATSIGHT)                //По предъявлении. По предъявлении

      _SecondSymbols = "пп";
      /*******************************/
      /*небольшой алгоритм для       */
      /*расширения "по предъявлении" */
      /*******************************/
      if( ( SQL_ConvTypeDate( m_leg.rec.Maturity ) < SQL_ConvTypeDate( m_leg.rec.Start ) ) // Просто по предъявлении
      and ( SQL_ConvTypeDate( m_leg.rec.Expiry ) < SQL_ConvTypeDate( m_leg.rec.Start ) ) )
            _ThirdSymbols = "";
            date_repay_cond = m_Data[m_DataSize - 1].get_A(A05);
            days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate) + DaysInYearByBasis( m_leg.rec.Basis, date_repay_cond, true );
            limit_repay_date = date_repay_cond + DaysInYearByBasis( m_leg.rec.Basis, date_repay_cond, true );
      else        
        if( ( SQL_ConvTypeDate( m_leg.rec.Expiry ) < SQL_ConvTypeDate( m_leg.rec.Start ) ) // По предъявлении, но не ранее
        and ( SQL_ConvTypeDate( m_leg.rec.Maturity ) >= SQL_ConvTypeDate( m_leg.rec.Start ) ) )
            _ThirdSymbols = "нн";
            date_repay_cond = SQL_ConvTypeDate( m_leg.rec.Maturity ); // "не ранее даты" 
            if( m_RegistryPeriodArray[i].InfoBuy.FirstDate < date(1,1,2011) )
              days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate);
              limit_repay_date = date_repay_cond;
              if (days_before_repay < 0)
                days_before_repay = 0;
              end;
            else
              days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate) + DaysInYearByBasis( m_leg.rec.Basis, date_repay_cond, true );
              limit_repay_date = date_repay_cond + DaysInYearByBasis( m_leg.rec.Basis, date_repay_cond, true );
            end;
        elif( ( SQL_ConvTypeDate( m_leg.rec.Expiry ) >= SQL_ConvTypeDate( m_leg.rec.Start ) ) // По предъявлении, но не позднее
          and ( SQL_ConvTypeDate( m_leg.rec.Maturity ) < SQL_ConvTypeDate( m_leg.rec.Start ) ) )            
            _ThirdSymbols = "нп";
            date_repay_cond = SQL_ConvTypeDate( m_leg.rec.Expiry );
            days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate);
            limit_repay_date = date_repay_cond;
        else // По предъявлении, но не ранее и не позднее
            _ThirdSymbols = "нннп";
            date_repay_cond = SQL_ConvTypeDate( m_leg.rec.Expiry );
            days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate);
            limit_repay_date = date_repay_cond;
        end;
      end;
    end;
    if ( m_bnr.rec.BCTermFormula == VS_TERMF_DURING)
      //От предъявления. Во столько-то времени от предъявления
      _SecondSymbols = "свп";
      date_repay_cond = m_Data[m_DataSize - 1].get_A(A05);
      days_before_repay = date_repay_cond - Date(m_RegistryPeriodArray[i].InfoBuy.FirstDate) + DaysInYearByBasis( m_leg.rec.Basis, date_repay_cond, true );
      limit_repay_date = date_repay_cond + DaysInYearByBasis( m_leg.rec.Basis, date_repay_cond, true );
    end;
    
    m_Data[m_DataSize - 1].set_A(A04, string(_FirstSymbols + _SecondSymbols + _ThirdSymbols));
    m_Data[m_DataSize - 1].set_A(A06, string(VA_GetFI_ISO_Code(m_leg.rec.PFI)));
    if ( m_leg.rec.PFI != NATCUR )
      if ( m_bnr.rec.PayFIID == ALLFININSTR )
        m_Data[m_DataSize - 1].set_A(A08, "Нет");
      else
        m_Data[m_DataSize - 1].set_A(A08, "Да");
      end;
    end;
    m_Data[m_DataSize - 1].set_A(A09, Date(date_repay_cond));
    m_Data[m_DataSize - 1].set_A(A10, days_before_repay);
    m_Data[m_DataSize - 1].set_A(A11, Date(limit_repay_date));
  END;

  PRIVATE MACRO ПровестиДополнительныеВычисления()
    /***************************************************************************/
    /* заполенине структур, используемых при вызове функций из других макросов */
    /***************************************************************************/
    m_fd = VSBannerFD(DL_VSBANNER, m_DataSetBanners.BCID);
    m_leg = m_fd.getleg();
    m_bnr = m_fd.getbnr();
     
    m_leg_Price = m_leg.rec.Price / pow( 10, m_leg.rec.Point );
    /***************************************************/
    /* заполение флагов процентый / дисконтынй вексель */
    /***************************************************/
    if (ВексельДисконтный (m_leg,m_bnr))
      m_isВексельДисконтный = true;
    else
      m_isВексельДисконтный = false;
    end;


    if (ВексельПроцентный (m_leg.rec.Formula, m_leg_Price))
      m_isВексельПроцентный = true;
    else
      m_isВексельПроцентный = false;
    end;

    DL_GetStartIncomeDateType(@m_IncomeDateType);
  END;

  PRIVATE MACRO GetCBRate(SaleDate:date, Rate:@variant)
    var CbrfRate, Select;
    var stat = 0;

    Select = DL_RsdCommand("select t_Rate from dCBrfrate_dbt where t_FIID ="+NATCUR+" and t_EffectiveDate <= ? order by t_EffectiveDate desc");

    Select.addParam(SaleDate);

    CbrfRate = Select.execute();
    stat = CbrfRate.moveNext();
    if(stat)
      Rate = CbrfRate.Rate;
    end;

    return stat;
  END;

  // Получить дату окончания действия ставки
  PRIVATE MACRO GetPrcHstEndDate(BCID, BeginDate):date
    var sqlQuery = "";
    var rsdCmd = null;
    var dataSet = null;

    sqlQuery =
      " SELECT "
      + " NVL( MIN( vsprchst.t_BegDate ) - 1, TO_DATE( '01.01.0001', 'DD.MM.YYYY' ) ) AS t_EndDate "
      + " FROM "
      + " dvsprchst_dbt vsprchst "
      + " WHERE "
      + " vsprchst.t_BCID = ? "
      + " AND vsprchst.t_BegDate > ? ";

    rsdCmd = RSDCommand(sqlQuery);
    rsdCmd.NullConversion = true;
    rsdCmd.AddParam("", RSDBP_IN, BCID);
    rsdCmd.AddParam("", RSDBP_IN, BeginDate);
    rsdCmd.Execute();

    dataSet = TRsbDataSet(rsdCmd);
    dataSet.MoveNext();

    return dataSet.EndDate;
  END;

  PRIVATE MACRO GetCalcPeriodDates(IncomeDateType, BuyDate, RepaymentDate, BeginCalcDate:@date, EndCalcDate:@date)
    if((IncomeDateType == DL_INCOMEDATETYPE_CBR) and 
       (m_bnr.rec.BCTermFormula == VS_TERMF_FIXEDDAY))
      BeginCalcDate = BuyDate;
      EndCalcDate = RepaymentDate - 1;
    else
      BeginCalcDate = BuyDate + 1;
      EndCalcDate = RepaymentDate;
    end;
  END;

  PRIVATE MACRO Get_d(BuyOrRepDate, Reserv_AVR:@variant, DiscountRate:@variant )
    var RefinancingRate;
    if(not GetCBRate(BuyOrRepDate, @RefinancingRate))
      msgbox( "Не найдена ставка рефинансирования ЦБ РФ на " + date(BuyOrRepDate));
      RefinancingRate = 0.0;
    end;

    if(CalcAndCheckReserveParams(m_bnr.rec, BuyOrRepDate, null, VARES_SUBKIND_AVR, @Reserv_AVR) != 0)
      msgbox("Не найден процент резервирования по ц/б сер. " + m_bnr.rec.BCSeries + " N " + trim(m_bnr.rec.BCNumber) + " на дату " + date(BuyOrRepDate));
      Reserv_AVR = 0.0;
    end;

    DiscountRate = RefinancingRate*(1 + Reserv_AVR/100.0)/100.0;
  END;

  PRIVATE MACRO GetCalcCost(DiscountRate, m_A07, EstimatedPrice:@variant)
    var d = 0.0;
    var Dn = date(0,0,0);
    var Do = date(0,0,0);
    var Пр = 0.0;
    var Dni = date(0,0,0);
    var Doi = date(0,0,0);
    var Прi = 0.0;
    var Ai = 0.0;

    GetCalcPeriodDates(m_IncomeDateType, m_RegistryPeriodArray[i].PeriodDateBegin, m_RegistryPeriodArray[i].PeriodDateEnd, @Dn, @Do);
    Пр = РассчитатьКоэффОбращения(Dn, Do, m_leg.rec.Basis);

    if(m_isВексельДисконтный) // дисконтный
      EstimatedPrice = m_A07*(1.0 - DiscountRate*Пр);
    elif(m_isВексельПроцентный) // процентный
      EstimatedPrice = m_A07/(1.0 + DiscountRate*Пр);
    end;

    if(m_isВексельПроцентный)
      Dni = Dn;
      Doi = GetPrcHstEndDate(m_bnr.rec.BCID, Dni);
      if(Doi == date(0,0,0))
        Doi = Do;
      end;

      while((Dni <= Do) and (Doi <= Do))
        Прi = РассчитатьКоэффОбращения(Dni, Doi, m_leg.rec.Basis);
        Ai = DL_VAGetBnrRateOnDate(m_bnr.rec.BCID, Dni) / pow(10, m_leg.rec.Point);

        EstimatedPrice = EstimatedPrice + m_A07*Ai*Прi/100.0/(1.0 + DiscountRate*Пр);

        Dni = Doi + 1;
        Doi = GetPrcHstEndDate(m_bnr.rec.BCID, Dni);
        if(Doi == date(0,0,0))
          Doi = Do;
        end;
      end;
    end;
  END;

  PRIVATE MACRO ПолучитьКурсНаДату(FIID, OtherFIID, KursDate, Type)
    var retVal = 0;
    if(FIID == OtherFIID)
      return 1;
    end;

    record ratedef ("ratedef");
    if(VALTYPE(Type) == V_UNDEF)
      ПолучитьКурс(ratedef, FIID, OtherFIID);
    else
      ПолучитьКурс(ratedef, FIID, OtherFIID, Type);
    end;
    ПолучитьЗначениеКурса(ratedef, Date(KursDate));

    retVal = ConvertSum($1, ratedef.rate, ratedef.scale, ratedef.point, ratedef.isinverse);
    if(retVal == 0)
      RunError("Не найден курс валюты ", VA_GetFI_ISO_Code(FIID), 
                                         " к ", VA_GetFI_ISO_Code(OtherFIID), " за ", KursDate);
    end;
    return retVal;
  END;

  PRIVATE MACRO ПолучитьКомиссииЗаОперацию(oprID)
    record oprcom ("oprsfcom.dbt");
    var sfcomiss = TRecHandler( "sfcomiss.dbt" );
    var InSum = 0;
    while( SfGetOperCommission(oprID, -1, oprcom) )

        if( not SfGetComiss( oprcom.FeeType, oprcom.CommNumber, sfcomiss ) )
           return 0;
        else
           InSum     = InSum    + oprcom.Sum;
        end;
    end;
    return InSum;
  end;

  PRIVATE MACRO ОсобоеУсловиеПоДатеРасчета()
    if ((m_EndDate < date(01,01,2016)) or (StrLwr(m_Data[m_DataSize - 1].get_A(A58)) == "да"))
      return true;
    end;
    return false;
  end;
  
  PRIVATE MACRO РасчетПолейПокупки()
    var m_A07, m_A10, m_A11, m_A12, m_A13, m_A14, m_A16,
        m_A15, m_A17,
        m_A33, m_A34, m_A35,
        m_A36, m_A38, m_A50, m_A50_1, m_A54, m_A64,
        m_A55, m_A65, m_A66, m_A67, m_A58, attrID, attrVal, refinancingRate;
    var ClientRec = TRecHandler("party.dbt");
    var benClientRec = TRecHandler("party.dbt");
    ПолучитьСубъекта(SQL_ConvTypeInteger(m_RegistryPeriodArray[i].InfoBuy.ClientID), ClientRec);
    ПолучитьСубъекта(m_RegistryPeriodArray[i].InfoBuy.tick_ClientID, benClientRec);
    
    m_A17 = 0;
    m_A35 = 0;
    m_A34 = 0;

    var err = 0;

    if ((m_RegistryPeriodArray[i].PeriodType == PeriodTypeOpen) OR (m_RegistryPeriodArray[i].InfoRep == NULL) OR (m_RegistryPeriodArray[i].InfoRep.FirstDate == NULL) OR (m_RegistryPeriodArray[i].InfoRep.FirstDate < date(01,01,1900)))
      if( GetMainObjAttr(err, OBJTYPE_PARTY, UniID(ClientRec, OBJTYPE_PARTY), PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, m_RegistryPeriodArray[i].InfoBuy.tick_DealDate) )
         DL_GetObjAttrName(OBJTYPE_PARTY, PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, @attrVal);
         if (Int(attrVal) != 4)
           m_A58 = "Да";
           m_A64 = "Да";
         end;
      end;
      if( GetMainObjAttr(err, OBJTYPE_PARTY, UniID(benClientRec, OBJTYPE_PARTY), PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, m_RegistryPeriodArray[i].InfoBuy.tick_DealDate) )
         DL_GetObjAttrName(OBJTYPE_PARTY, PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, attrID, null, null, @attrVal);
         if (int(attrVal) != 4)
           m_A58 = "Да";
           m_A64 = "Да";
         end;
      end;
    end;
    m_Data[m_DataSize - 1].set_A(A58,   IIF(VALTYPE(m_A58)   != V_UNDEF, m_A58,         ""));
    
    m_A07 = m_Data[m_DataSize - 1].get_A(A07);
    m_A10 = m_Data[m_DataSize - 1].get_A(A10);
    m_A11 = m_Data[m_DataSize - 1].get_A(A11);
    m_A12 = m_RegistryPeriodArray[i].InfoBuy.Client_ShortName;
    m_A13 = m_RegistryPeriodArray[i].InfoBuy.tick_DealCode;
    m_A14 = m_RegistryPeriodArray[i].InfoBuy.FirstDate;
    m_A15 = m_RegistryPeriodArray[i].InfoBuy.lnk_BCCost;
    m_A16 = ПолучитьКурсНаДату(NATCUR, m_leg.rec.PFI, m_RegistryPeriodArray[i].InfoBuy.FirstDate, 7);

    m_A33 = m_RegistryPeriodArray[i].PeriodDateEnd - m_RegistryPeriodArray[i].PeriodDateBegin; 
    m_A33 = IIF(m_A33 > m_A10, m_A10, m_A33);
    m_A36 = NameAlg(ALG_PC_BASIS, m_leg.rec.Basis);//DaysInYearByBasis( m_leg.rec.Basis, m_BeginDate );
    m_A38 = ПолучитьКурсНаДату(NATCUR, m_leg.rec.PFI, m_EndDate, 7);
    m_A54 = IIF(m_RegistryPeriodArray[i].InfoBuy.ClientID != -1, m_RegistryPeriodArray[i].InfoBuy.Country_FullName, "" );
    m_A55 = IIF(m_RegistryPeriodArray[i].InfoBuy.ClientID != -1, _getINN( ПолучитьКодСубъекта(m_RegistryPeriodArray[i].InfoBuy.ClientID, PTCK_INN )), "" );

    if(m_isВексельДисконтный)
      m_A34 = m_A07 - m_RegistryPeriodArray[i].InfoBuy.lnk_BCCost;
    end;
    m_A34 = IIF(m_A07 > m_A15, m_A34, 0);

    if ( m_isВексельПроцентный )
      m_A35 = m_leg_Price;
    elif(m_isВексельДисконтный)
    
      m_A35 = ((m_A07 - m_A15) * DaysInYearByBasis( m_leg.rec.Basis, date(m_A14), true) * 100) / (m_A07 * (date(m_A11) - date(m_A14)));
    end;

    if(not GetCBRate(m_RegistryPeriodArray[i].PeriodDateBegin, @refinancingRate))
      refinancingRate = 0.0;
    end;

    m_A50 = IIF(ОсобоеУсловиеПоДатеРасчета(),1,0);

    if (m_isВексельПроцентный)
      m_A50_1 = refinancingRate*(1 + m_A50/100.0)/100.0;
    else
      m_A50_1 = m_A50 * m_A35;
    end;

    m_A17 = ПолучитьКомиссииЗаОперацию(m_RegistryPeriodArray[i].InfoBuy.ID_Operation); 

    if(m_isВексельДисконтный)
      m_A66 = MC_GetExistAccount("Начисл.ПДД, УВ", m_fd.kind, m_fd.id, FIROLE_DISCOUNT, m_fd.ОпределитьВалютуУчета());
      if(m_A66 == "")
        msgbox("Ошибка в получении счета для векселя сер. " + string(m_bnr.rec.BCSeries) + " N " + trim(m_bnr.rec.BCNumber) + " :|категория: Начисл.ПДД, УВ(Д)");
        m_A66 = "";
      end;
    elif(m_isВексельПроцентный)
     m_A66 = MC_GetExistAccount("Начисл.ПДД, УВ", m_fd.kind, m_fd.id, FIROLE_PERCENT, m_fd.ОпределитьВалютуУчета());
      if(m_A66 == "")
        msgbox("Ошибка в получении счета для векселя сер. " + string(m_bnr.rec.BCSeries) + " N " + trim(m_bnr.rec.BCNumber) + " :|категория: Начисл.ПДД, УВ(П)");
        m_A66 = "";
      end;
    end;

    m_A65 = MC_GetExistAccount("Учтенные векселя", m_fd.kind, m_fd.id, FIROLE_UNDEF, m_fd.ОпределитьВалютуУчета());
    if(m_A65 == "")
      msgbox("Ошибка в получении счета для векселя сер. " + string(m_bnr.rec.BCSeries) + " N " + trim(m_bnr.rec.BCNumber) + " :|категория: Учтенные векселя");
      m_A65 = "";
    end;
    
    m_A67 = "";


    m_Data[m_DataSize - 1].set_A(A12,   IIF(VALTYPE(m_A12)   != V_UNDEF, m_A12,         ""));
    m_Data[m_DataSize - 1].set_A(A13,   IIF(VALTYPE(m_A13)   != V_UNDEF, m_A13,         ""));
    m_Data[m_DataSize - 1].set_A(A14,   IIF(VALTYPE(m_A14)   != V_UNDEF, Date(m_A14),   ""));
    m_Data[m_DataSize - 1].set_A(A15,   IIF(VALTYPE(m_A15)   != V_UNDEF, m_A15,         ""));
    m_Data[m_DataSize - 1].set_A(A16,   IIF(VALTYPE(m_A16)   != V_UNDEF, m_A16,         ""));
    m_Data[m_DataSize - 1].set_A(A17,   IIF(VALTYPE(m_A17)   != V_UNDEF, m_A17,         ""));
    m_Data[m_DataSize - 1].set_A(A33,   IIF(VALTYPE(m_A33)   != V_UNDEF, m_A33,         ""));
    m_Data[m_DataSize - 1].set_A(A34,   IIF(VALTYPE(m_A34)   != V_UNDEF, m_A34,         ""));
    m_Data[m_DataSize - 1].set_A(A35,   IIF(VALTYPE(m_A35)   != V_UNDEF, m_A35,         ""));
    m_Data[m_DataSize - 1].set_A(A36,   IIF(VALTYPE(m_A36)   != V_UNDEF, m_A36,         ""));
    m_Data[m_DataSize - 1].set_A(A38,   IIF(VALTYPE(m_A38)   != V_UNDEF, m_A38,         ""));
    m_Data[m_DataSize - 1].set_A(A50,   IIF(VALTYPE(m_A50)   != V_UNDEF, m_A50,         ""));
    m_Data[m_DataSize - 1].set_A(A50_1, IIF(VALTYPE(m_A50_1) != V_UNDEF, m_A50_1,       ""));
    m_Data[m_DataSize - 1].set_A(A54,   IIF(VALTYPE(m_A54)   != V_UNDEF, m_A54,         ""));
    m_Data[m_DataSize - 1].set_A(A55,   IIF(VALTYPE(m_A55)   != V_UNDEF, m_A55,         ""));
    m_Data[m_DataSize - 1].set_A(A64,   IIF(VALTYPE(m_A64)   != V_UNDEF, m_A64,         ""));
    m_Data[m_DataSize - 1].set_A(A65,   IIF(VALTYPE(m_A65)   != V_UNDEF, m_A65,         ""));
    m_Data[m_DataSize - 1].set_A(A66,   IIF(VALTYPE(m_A66)   != V_UNDEF, m_A66,         ""));
    m_Data[m_DataSize - 1].set_A(A67,   IIF(VALTYPE(m_A67)   != V_UNDEF, m_A67,         "")); 
    
    return 0;
    OnError(err)
    msgbox(err.Message);
    return 1;
  END;

  PRIVATE MACRO РасчетПолейВыбытия()
    var Sum = 0.0;
    var SumPrcnt = 0.0;
    var SumDscnt = 0.0;
    var SumLimit = 0.0;
    var stat = 0;
    var msg;
    var tickFD;
    var daysInYear;
    var m_A07, m_A18, m_A19, m_A20, m_A22, m_A15, m_A25, m_A16, m_A11,
        m_A17, m_A21, m_A23, m_A28, m_A27, m_A29, m_A30,
        m_A31, m_A32, m_A35, m_A36, m_A41, m_A42, m_A43, 
        m_A44, m_A45, m_A46,  m_A48, m_A52, m_A52_1, m_A56, m_A50_1,
        m_A57, m_A60, m_A61, m_A62, m_A63, m_A14, m_A33, m_A24, m_A26, m_A49;

    daysInYear = DaysInYearByBasis( m_leg.rec.Basis, date(m_RegistryPeriodArray[i].InfoBuy.FirstDate) );

    tickFD = VATickFD(m_RegistryPeriodArray[i].InfoBuy.tick_DocKind, m_RegistryPeriodArray[i].InfoBuy.tick_DealId);
    m_A07 = m_Data[m_DataSize - 1].get_A(A07);
    m_A16 = m_Data[m_DataSize - 1].get_A(A16);
    m_A11 = m_Data[m_DataSize - 1].get_A(A11);
    m_A17 = m_Data[m_DataSize - 1].get_A(A17);
    m_A14 = m_Data[m_DataSize - 1].get_A(A14);
    m_A15 = m_Data[m_DataSize - 1].get_A(A15);
    m_A31 = m_Data[m_DataSize - 1].get_A(A31);
    m_A35 = m_Data[m_DataSize - 1].get_A(A35);
    m_A33 = m_Data[m_DataSize - 1].get_A(A33);
    m_A36 = m_Data[m_DataSize - 1].get_A(A36);
    m_A41 = m_Data[m_DataSize - 1].get_A(A41);
    m_A50_1 = m_Data[m_DataSize - 1].get_A(A50_1);
    m_A18 = m_RegistryPeriodArray[i].InfoRep.Client_ShortName;
    m_A19 = m_RegistryPeriodArray[i].InfoRep.tick_DealCode;
    m_A20 = Date(m_RegistryPeriodArray[i].InfoRep.FirstDate);
    m_A21 = IIF ( m_RegistryPeriodArray[i].PeriodType == PeriodTypeClose, m_RegistryPeriodArray[i].InfoRep.lnk_BCCost , 0 );
    m_A22 = IIF ( m_A20 != "", ПолучитьКурсНаДату(NATCUR, m_leg.rec.PFI, m_A20, 7), "");
    m_A56 = IIF(m_RegistryPeriodArray[i].InfoRep.ClientID != -1, m_RegistryPeriodArray[i].InfoRep.Country_FullName, "" );
    m_A57 = IIF(m_RegistryPeriodArray[i].InfoRep.ClientID != -1, _getINN(ПолучитьКодСубъекта(Int(m_RegistryPeriodArray[i].InfoRep.ClientID), PTCK_INN )), "" );
    m_A61 = "Ставка рефинансирования ЦБ";
    if(not GetCBRate(m_RegistryPeriodArray[i].PeriodDateEnd, @m_A62))
      m_A62 = 0.0;
    end;
    m_A63 = m_A62 * IIF(  (tickfd.GetDealPayFI() == NATCUR) ,0.75 ,0.4 );

    m_A24 = 0;
    m_A25 = 0;
    m_A26 = 0;
    m_A27 = 0;
    m_A28 = 0;
    m_A29 = 0;
    m_A30 = 0;
    m_A32 = 0;
    m_A23 = 0;
    m_A31 = 0;
    m_A52 = 0;

    m_A52 = IIF(ОсобоеУсловиеПоДатеРасчета(),1,0);

    if (m_isВексельПроцентный)
      m_A52_1 = m_A62*(1 + m_A52/100.0)/100.0;
    else
      m_A52_1 = m_A52 * m_A35;
    end; 

    if (ОсобоеУсловиеПоДатеРасчета())
      if ((m_isВексельДисконтный) and (m_A14 >= m_A11))
        m_A24 = m_A07;
      else
        GetCalcCost(m_A50_1, m_A07, @m_A24);
      end;
    end;

    if (ОсобоеУсловиеПоДатеРасчета())
      m_A25 = m_A24 + m_A24 * 0.2;
      m_A26 = IIF(m_A15 > m_A25, m_A15 - m_A25, 0);
    end;

    if (ОсобоеУсловиеПоДатеРасчета())
      if ((m_isВексельДисконтный) and (m_A20 >= m_A11))
        m_A27 = m_A07;
      else
        GetCalcCost(m_A52_1, m_A07, @m_A27);
      end;
    end;
    
    if (ОсобоеУсловиеПоДатеРасчета())
      m_A28 = m_A27 - m_A27 * 0.2; 
      m_A29 = IIF(m_A21 < m_A28, m_A28 - m_A21, 0);
    end;
    m_A30 = IIF(m_A21 > m_A28, m_A21 * m_A22, m_A28 * m_A22);

    m_A23 = ПолучитьКомиссииЗаОперацию(m_RegistryPeriodArray[i].InfoRep.ID_Operation); 

    if ((m_A25 != 0) and (m_A15 > m_A25))
      m_A31 = m_A25 * m_A16 + m_A17 + m_A23;
    else
      m_A31 = m_A15 * m_A16 + m_A17 + m_A23;
    end;
    
    if (m_A14 < m_BeginDate)
      if(m_isВексельДисконтный and m_isВексельПроцентный )
        m_A32 = ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                              m_BeginDate - 1,
                                              FIROLE_DISCOUNT);
        m_A32 = m_A32 + ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                              m_BeginDate - 1,
                                              FIROLE_PERCENT);
      elif(m_isВексельДисконтный)
        m_A32 = ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                      m_BeginDate - 1,
                                      FIROLE_DISCOUNT);
      elif(m_isВексельПроцентный)
        m_A32 = ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                      m_BeginDate - 1,
                                      FIROLE_PERCENT);                                                          
      end;
      m_A32 = m_A32 * ПолучитьКурсНаДату(NATCUR, m_leg.rec.PFI, m_BeginDate - 1, 7);
    end;

    m_A43 = m_A30 - m_A31;  
    if( (m_A20 != date(0,0,0)) AND (m_A20 != NULL))
      m_A42 = m_A30 - m_A31 - m_A32;
    else 
      m_A42 = m_A41;
    end;

    m_A45 = m_A21 - m_A15;

    if(m_isВексельДисконтный)
      //m_A44 = (m_A07 - m_A21) / m_A21 * m_A36 /m_Data[m_DataSize - 1].get_A(A10) * 100;
      m_A44 = (m_A45 * daysInYear * 100) / (m_A15 * m_A33);
    end;

    m_A46 = m_A22 * (m_A21 - m_A15);

    if ((m_leg.rec.PFI != NATCUR) and (m_bnr.rec.PayFIID != ALLFININSTR))
      if ( (m_A20 != date(0,0,0)) AND (m_A20 != NULL))
        if (m_isВексельДисконтный)
          m_A48 = m_A15 * m_A22 - m_A15 * m_A16;
        else
          m_A48 = m_A07 * m_A22 - m_A07 * m_A16;
        end;
      else
        m_A48 = 0;
      end;
    end;
    
    if (m_isВексельПроцентный)
      SumPrcnt = SumPrcnt + ПолучитьСуммуПДДНаДату( m_bnr.rec.BCID, m_RegistryPeriodArray[i].PeriodDateEnd, FIROLE_PERCENT, m_RegistryPeriodArray[i].PeriodDateBegin, m_RegistryPeriodArray[i].InfoBuy.tick_DealId, m_RegistryPeriodArray[i].InfoBuy.tick_DocKind );      
    end;

    if (m_isВексельДисконтный)
      SumDscnt = SumDscnt + ПолучитьСуммуПДДНаДату( m_bnr.rec.BCID, m_RegistryPeriodArray[i].PeriodDateEnd, FIROLE_DISCOUNT, m_RegistryPeriodArray[i].PeriodDateBegin, m_RegistryPeriodArray[i].InfoBuy.tick_DealId, m_RegistryPeriodArray[i].InfoBuy.tick_DocKind);      
    end;
    Sum = SumPrcnt + SumDscnt;
    if ( m_A35 != 0)
      SumLimit = Sum * m_A63 / m_A35;
    end;
    
    if ( ( Sum != 0 ) and ( SumLimit !=0 ) )    
      m_A60 = (Sum - SumLimit) / Sum * 100;//%
    else
      m_A60 = 0;
    end;

    m_A60 = IIF(m_A35 >= m_A63, 0, m_A60);

    if ((m_leg.rec.PFI != NATCUR) and (m_bnr.rec.PayFIID != ALLFININSTR))
        m_A49 = 0;
    end;

    m_Data[m_DataSize - 1].set_A(A15,   IIF(VALTYPE(m_A15)   != V_UNDEF, m_A15,         ""));
    m_Data[m_DataSize - 1].set_A(A17,   IIF(VALTYPE(m_A17)   != V_UNDEF, m_A17,         ""));
    m_Data[m_DataSize - 1].set_A(A18,   IIF(VALTYPE(m_A18)   != V_UNDEF, m_A18,         ""));
    m_Data[m_DataSize - 1].set_A(A19,   IIF(VALTYPE(m_A19)   != V_UNDEF, m_A19,         ""));
    m_Data[m_DataSize - 1].set_A(A20,   IIF(VALTYPE(m_A20)   != V_UNDEF, m_A20,         ""));
    m_Data[m_DataSize - 1].set_A(A21,   IIF(VALTYPE(m_A21)   != V_UNDEF, m_A21,         ""));
    m_Data[m_DataSize - 1].set_A(A22,   IIF(VALTYPE(m_A22)   != V_UNDEF, m_A22,         ""));
    m_Data[m_DataSize - 1].set_A(A23,   IIF(VALTYPE(m_A23)   != V_UNDEF, m_A23,         ""));
    m_Data[m_DataSize - 1].set_A(A24,   IIF(VALTYPE(m_A24)   != V_UNDEF, m_A24,         ""));
    m_Data[m_DataSize - 1].set_A(A25,   IIF(VALTYPE(m_A25)   != V_UNDEF, m_A25,         ""));
    m_Data[m_DataSize - 1].set_A(A26,   IIF(VALTYPE(m_A26)   != V_UNDEF, m_A26,         ""));
    m_Data[m_DataSize - 1].set_A(A27,   IIF(VALTYPE(m_A27)   != V_UNDEF, m_A27,         ""));
    m_Data[m_DataSize - 1].set_A(A28,   IIF(VALTYPE(m_A28)   != V_UNDEF, m_A28,         ""));
    m_Data[m_DataSize - 1].set_A(A29,   IIF(VALTYPE(m_A29)   != V_UNDEF, m_A29,         ""));
    m_Data[m_DataSize - 1].set_A(A30,   IIF(VALTYPE(m_A30)   != V_UNDEF, m_A30,         ""));
    m_Data[m_DataSize - 1].set_A(A31,   IIF(VALTYPE(m_A31)   != V_UNDEF, m_A31,         ""));
    m_Data[m_DataSize - 1].set_A(A32,   IIF(VALTYPE(m_A32)   != V_UNDEF, m_A32,         ""));
    m_Data[m_DataSize - 1].set_A(A42,   IIF(VALTYPE(m_A42)   != V_UNDEF, m_A42,         ""));
    m_Data[m_DataSize - 1].set_A(A43,   IIF(VALTYPE(m_A43)   != V_UNDEF, m_A43,         ""));
    m_Data[m_DataSize - 1].set_A(A44,   IIF(VALTYPE(m_A44)   != V_UNDEF, m_A44,         ""));
    m_Data[m_DataSize - 1].set_A(A45,   IIF(VALTYPE(m_A45)   != V_UNDEF, m_A45,         ""));
    m_Data[m_DataSize - 1].set_A(A46,   IIF(VALTYPE(m_A46)   != V_UNDEF, m_A46,         ""));
    m_Data[m_DataSize - 1].set_A(A48,   IIF(VALTYPE(m_A48)   != V_UNDEF, m_A48,         ""));
    m_Data[m_DataSize - 1].set_A(A49,   IIF(VALTYPE(m_A49)   != V_UNDEF, m_A49,         ""));
    m_Data[m_DataSize - 1].set_A(A52,   IIF(VALTYPE(m_A52)   != V_UNDEF, m_A52,         ""));
    m_Data[m_DataSize - 1].set_A(A52_1, IIF(VALTYPE(m_A52_1) != V_UNDEF, m_A52_1,       ""));
    m_Data[m_DataSize - 1].set_A(A56,   IIF(VALTYPE(m_A56)   != V_UNDEF, m_A56,         ""));
    m_Data[m_DataSize - 1].set_A(A57,   IIF(VALTYPE(m_A57)   != V_UNDEF, m_A57,         ""));
    m_Data[m_DataSize - 1].set_A(A60,   IIF(VALTYPE(m_A60)   != V_UNDEF, m_A60,         ""));
    m_Data[m_DataSize - 1].set_A(A61,   IIF(VALTYPE(m_A61)   != V_UNDEF, m_A61,         ""));
    m_Data[m_DataSize - 1].set_A(A62,   IIF(VALTYPE(m_A62)   != V_UNDEF, m_A62,         ""));
    m_Data[m_DataSize - 1].set_A(A63,   IIF(VALTYPE(m_A63)   != V_UNDEF, m_A63,         ""));
    
    return 0;
    OnError(err)
    msgbox(err.Message);
    return 1;
  END;

  PRIVATE MACRO РасчетПолейНереализованных()
    var Sum = 0.0;
    var SumPrcnt = 0.0;
    var SumDscnt = 0.0;
    var SumLimit = 0.0;
    var stat = 0;
    var msg;
    var m_A07, m_A15, m_A16, m_A14, m_A20, m_A30, m_A31, m_A32, m_A37, m_A38, m_A39, m_A40, m_A41, m_A42, m_A47, m_A48, m_A49;

    m_A40 = 0;

    m_A07 = m_Data[m_DataSize - 1].get_A(A07);
    m_A15 = m_Data[m_DataSize - 1].get_A(A15);
    m_A16 = m_Data[m_DataSize - 1].get_A(A16);
    m_A14 = m_Data[m_DataSize - 1].get_A(A14);
    m_A20 = m_Data[m_DataSize - 1].get_A(A20);
    m_A30 = m_Data[m_DataSize - 1].get_A(A30);
    m_A31 = m_Data[m_DataSize - 1].get_A(A31);
    m_A32 = m_Data[m_DataSize - 1].get_A(A32);
    m_A38 = m_Data[m_DataSize - 1].get_A(A38);

    m_A37 = ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                          m_RegistryPeriodArray[i].PeriodDateEnd,
                                          FIROLE_DISCOUNT,
                                          m_RegistryPeriodArray[i].PeriodDateBegin,
                                          m_RegistryPeriodArray[i].InfoBuy.tick_DealId,
                                          m_RegistryPeriodArray[i].InfoBuy.tick_DocKind);
    m_A37 = m_A37 + ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                                          m_RegistryPeriodArray[i].PeriodDateEnd,
                                                          FIROLE_PERCENT, 
                                                          m_RegistryPeriodArray[i].PeriodDateBegin,
                                                          m_RegistryPeriodArray[i].InfoBuy.tick_DealId,
                                                          m_RegistryPeriodArray[i].InfoBuy.tick_DocKind);
    if (  m_leg.rec.PFI != NATCUR )
      m_A39 = m_A37 * m_A38;
    else
      m_A39 = m_A37;
    end;

    if (m_A14 < m_BeginDate)
      m_A40 = ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                    m_BeginDate - 1,
                                    FIROLE_DISCOUNT);
      m_A40 = m_A40 + ПолучитьСуммуПДДНаДату(m_bnr.rec.BCID,
                                            m_BeginDate - 1,
                                            FIROLE_PERCENT);
      m_A40 =  m_A40 *  ПолучитьКурсНаДату(NATCUR, m_leg.rec.PFI, m_BeginDate - 1, 7);
    end;

    m_A41 = m_A39 - m_A40;  

    if( (m_A20 != date(0,0,0)) AND (m_A20 != NULL))
      m_A42 = m_A30 - m_A31 - m_A32;
    else 
      m_A42 = m_A41;
    end;

    if ((m_leg.rec.PFI != NATCUR) and (m_bnr.rec.PayFIID != ALLFININSTR))
      if (m_A14 < m_BeginDate)
        var S1 = ПолучитьКурсНаДату(NATCUR, m_leg.rec.PFI, m_BeginDate - 1, 7);
        if (m_isВексельДисконтный)
          m_A47 = m_A15 * S1 - m_A15 * m_A16;
        else
          m_A47 = m_A07 * S1 - m_A07 * m_A16;
        end;
      else
        m_A47 = 0;
      end;
    end;

    if ((m_leg.rec.PFI != NATCUR) and (m_bnr.rec.PayFIID != ALLFININSTR))
      if ( (m_A20 == date(0,0,0)) OR (m_A20 == NULL))
        if (m_isВексельДисконтный)
          m_A49 = m_A15 * m_A38 - m_A15 * m_A16;
        else
          m_A49 = m_A07 * m_A38 - m_A07 * m_A16;
        end;
      else
        m_A49 = 0;
      end;
    end;

    if ((m_leg.rec.PFI != NATCUR) and (m_bnr.rec.PayFIID != ALLFININSTR))
        m_A48 = 0;
    end;

    m_Data[m_DataSize - 1].set_A(A37,   IIF(VALTYPE(m_A37)   != V_UNDEF, m_A37,         ""));
    m_Data[m_DataSize - 1].set_A(A39,   IIF(VALTYPE(m_A39)   != V_UNDEF, m_A39,         ""));
    m_Data[m_DataSize - 1].set_A(A40,   IIF(VALTYPE(m_A40)   != V_UNDEF, m_A40,         ""));
    m_Data[m_DataSize - 1].set_A(A41,   IIF(VALTYPE(m_A41)   != V_UNDEF, m_A41,         ""));
    m_Data[m_DataSize - 1].set_A(A42,   IIF(VALTYPE(m_A42)   != V_UNDEF, m_A42,         ""));
    m_Data[m_DataSize - 1].set_A(A47,   IIF(VALTYPE(m_A47)   != V_UNDEF, m_A47,         ""));
    m_Data[m_DataSize - 1].set_A(A48,   IIF(VALTYPE(m_A48)   != V_UNDEF, m_A48,         ""));
    m_Data[m_DataSize - 1].set_A(A49,   IIF(VALTYPE(m_A49)   != V_UNDEF, m_A49,         ""));
    
    return 0;
    OnError(err)
    msgbox(err.Message);
    return 1;
  END;
  PRIVATE MACRO GetFullDepNameByCurrOper():STRING
    var Query = " Select pt.t_name from dparty_dbt pt                                   "+
                "        join ddp_dep_dbt dep on dep.t_partyId = pt.t_partyId           "+
                "        join dperson_dbt ps  on dep.t_code    = ps.t_codedepart        "+
                "                            and  ps.t_oper    = " + {oper};
    var DepName;
    var cmd = RSDCommand(Query);
        cmd.execute();      
    var cmdData = TRsbDataSet(cmd);
    if( cmdData.MoveNext() )
          DepName   = cmdData.name;
    end;
    return DepName;
                
  END;
  
  /*****************************************/
  /* Блок вычисления значений полей отчёта */
  /*****************************************/
  
  PRIVATE MACRO N1_H0_1()
    return date_as_string( 1, m_BeginDate, false );
  END;

  PRIVATE MACRO N1_H0_2()
    return date_as_string( 1, m_EndDate, false );
  END;

  PRIVATE MACRO N1_H0_A()
    return GetFullDepNameByCurrOper();
  END;

  PRIVATE MACRO N1_H0_В()  //ИНН
    var INN="";
    INN = ПолучитьКодСубъекта({ourbank}, PTCK_INN );
    return _getINN(INN);
  END;

  PRIVATE MACRO N1_H0_C()  //КПП
    var INN="";
    INN = ПолучитьКодСубъекта({ourbank}, PTCK_INN );
    return _getKPP(INN);    
  END;

  PRIVATE MACRO N1_H0_3()    
    if (  (m_CurCurrencyList == NULL) or (m_CurCurrencyList.size == 0) or (m_CurCurrencyList.size > 1) ) 
      return " " ;
    else
      return m_CurCurrencyList[0].CodeList;
    end;
  END;

  PRIVATE MACRO N1_H0_4()
    if (  (m_CurCurrencyList == NULL) or (m_CurCurrencyList.size == 0) or (m_CurCurrencyList.size > 1) ) 
      return " " ;
    else
      return m_CurCurrencyList[0].Name;
    end;
  END;

  PRIVATE MACRO N1_H1()
    if ( ( m_SelectedDepartamentList == NULL ) or ( m_SelectedDepartamentList.Size == 0) or  ( m_SelectedDepartamentList.Size > 1) )
      return " " ;
    else
      return m_SelectedDepartamentList[0].PartyName;
    end;
  END;

  PRIVATE MACRO N1_FilialText()
    if ( ( m_SelectedDepartamentList == NULL )  or ( m_SelectedDepartamentList.Size == 0) or ( m_SelectedDepartamentList.Size > 1) )
      return " " ;
    else
      return "Филиал";
    end;
  END;

  PRIVATE MACRO N1_Text1()
    if (  (m_CurCurrencyList == NULL) or (m_CurCurrencyList.size == 0) or (m_CurCurrencyList.size > 1) ) 
      return " " ;
    else
      return "Валюта номинала векселя:";
    end;  
  END;

  PRIVATE MACRO GetFromForm_YEAR()
    var tmp;
    if( m_IsWebService )
      tmp = WebFormData.Year;
    else
      tmp = VARegister_Form.GetFieldValue(PNFLD_DLREGREP_YEAR);
    end;
    return tmp;
  END;

  PRIVATE MACRO GetFromForm_GROWTH()
    var y, y2;
    if( m_IsWebService )
      return WebFormData.AddItog;
    else
      VARegister_Form.GetFieldValue( PNFLD_DLREGREP_GROWTH, @y, @y2 );
      if(y2 == "X")
          return true;
      end;
    end;

    return false;
  END;

  PRIVATE MACRO GetFromForm_PERIOD()
    var tmp;
    if( m_IsWebService )
      tmp = WebFormData.Period;
    else
      var y, y2;
      VARegister_Form.GetFieldValue( PNFLD_DLREGREP_PERIOD, @y, @y2 );
      tmp = y2;
    end;
    return tmp;
  END;


   macro GetYear():string
     var y, y2;
     y2 = GetFromForm_YEAR();
     return string(y2);

   end;

   macro GetPeriodCode():string
      var code = "";
      var p, p2;
      var gr:bool = false;

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3)))
         code = "21";
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "31";
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "33";
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = "34";
      end;

      return code;
   end;

   macro GetPeriodTxt():string
      const ytxt = " ГОДА";
      const y2txt = " ГОД";
      const mtxt = " МЕСЯЦЕВ ";
      const m2txt = " МЕСЯЦА ";
      const qtxt = " КВАРТАЛ ";

      var code = "";
      var p, p2;
      var gr:bool = false;
      var y = GetYear();

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3))) // 1 кв
         code = "1"+qtxt+y+ytxt;
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "I ПОЛУГОДИЕ " + y + ytxt;
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "9" + mtxt + y + ytxt;
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = y + y2txt;
      elif((p2 == 1))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      elif(gr and (p2 > 1) and (p2 < 5))
         code = string(p2) + m2txt + y + ytxt;
      elif(gr and (p2 > 4) and (p2 < 12))
         code = string(p2) + mtxt + y + ytxt;
      elif((not gr) and (p2 > 13) and (p2 < 17))
         code = string(p2-12) + qtxt + y + ytxt;
      elif((not gr) and (p2 > 0) and (p2 < 13))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      end;

      return code;
   end;





  PRIVATE MACRO ДобавитьДанныеДляОбщейСтроки()
    m_N1_A07_TOTAL = m_N1_A07_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A07) != "", round(m_Data[m_DataSize - 1].get_A(A07), 2), 0);
    m_N1_A15_TOTAL = m_N1_A15_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A15) != "", round(m_Data[m_DataSize - 1].get_A(A15), 2), 0);
    m_N1_A17_TOTAL = m_N1_A17_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A17) != "", round(m_Data[m_DataSize - 1].get_A(A17), 2), 0);
    m_N1_A21_TOTAL = m_N1_A21_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A21) != "", round(m_Data[m_DataSize - 1].get_A(A21), 2), 0);
    m_N1_A23_TOTAL = m_N1_A23_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A23) != "", round(m_Data[m_DataSize - 1].get_A(A23), 2), 0);
    m_N1_A24_TOTAL = m_N1_A24_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A24) != "", round(m_Data[m_DataSize - 1].get_A(A24), 2), 0);
    m_N1_A25_TOTAL = m_N1_A25_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A25) != "", round(m_Data[m_DataSize - 1].get_A(A25), 2), 0);
    m_N1_A26_TOTAL = m_N1_A26_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A26) != "", round(m_Data[m_DataSize - 1].get_A(A26), 2), 0);
    m_N1_A27_TOTAL = m_N1_A27_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A27) != "", round(m_Data[m_DataSize - 1].get_A(A27), 2), 0);
    m_N1_A28_TOTAL = m_N1_A28_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A28) != "", round(m_Data[m_DataSize - 1].get_A(A28), 2), 0);
    m_N1_A29_TOTAL = m_N1_A29_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A29) != "", round(m_Data[m_DataSize - 1].get_A(A29), 2), 0);
    m_N1_A30_TOTAL = m_N1_A30_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A30) != "", round(m_Data[m_DataSize - 1].get_A(A30), 2), 0);
    m_N1_A31_TOTAL = m_N1_A31_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A31) != "", round(m_Data[m_DataSize - 1].get_A(A31), 2), 0);
    m_N1_A32_TOTAL = m_N1_A32_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A32) != "", round(m_Data[m_DataSize - 1].get_A(A32), 2), 0);
    m_N1_A34_TOTAL = m_N1_A34_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A34) != "", round(m_Data[m_DataSize - 1].get_A(A34), 2), 0);
    m_N1_A37_TOTAL = m_N1_A37_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A37) != "", round(m_Data[m_DataSize - 1].get_A(A37), 2), 0);
    m_N1_A39_TOTAL = m_N1_A39_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A39) != "", round(m_Data[m_DataSize - 1].get_A(A39), 2), 0);
    m_N1_A40_TOTAL = m_N1_A40_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A40) != "", round(m_Data[m_DataSize - 1].get_A(A40), 2), 0);
    m_N1_A41_TOTAL = m_N1_A41_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A41) != "", round(m_Data[m_DataSize - 1].get_A(A41), 2), 0);
    m_N1_A42_TOTAL = m_N1_A42_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A42) != "", round(m_Data[m_DataSize - 1].get_A(A42), 2), 0);
    m_N1_A43_TOTAL = m_N1_A43_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A43) != "", round(m_Data[m_DataSize - 1].get_A(A43), 2), 0);
    m_N1_A45_TOTAL = m_N1_A45_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A45) != "", round(m_Data[m_DataSize - 1].get_A(A45), 2), 0);
    m_N1_A46_TOTAL = m_N1_A46_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A46) != "", round(m_Data[m_DataSize - 1].get_A(A46), 2), 0);
    m_N1_A47_TOTAL = m_N1_A47_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A47) != "", round(m_Data[m_DataSize - 1].get_A(A47), 2), 0);
    m_N1_A48_TOTAL = m_N1_A48_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A48) != "", round(m_Data[m_DataSize - 1].get_A(A48), 2), 0);
    m_N1_A49_TOTAL = m_N1_A49_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A49) != "", round(m_Data[m_DataSize - 1].get_A(A49), 2), 0);
    m_N1_A60_TOTAL = m_N1_A60_TOTAL + IIF(m_Data[m_DataSize - 1].get_A(A60) != "", round(m_Data[m_DataSize - 1].get_A(A60), 2), 0);
  END;

  PRIVATE MACRO ОбнулитьДанныеДляОбщейСтроки()
    m_N1_A07_TOTAL = 0;
    m_N1_A15_TOTAL = 0;
    m_N1_A17_TOTAL = 0;
    m_N1_A21_TOTAL = 0;
    m_N1_A23_TOTAL = 0;
    m_N1_A24_TOTAL = 0;
    m_N1_A25_TOTAL = 0;
    m_N1_A26_TOTAL = 0;
    m_N1_A27_TOTAL = 0;
    m_N1_A28_TOTAL = 0;
    m_N1_A29_TOTAL = 0;
    m_N1_A30_TOTAL = 0;
    m_N1_A31_TOTAL = 0;
    m_N1_A32_TOTAL = 0;
    m_N1_A34_TOTAL = 0;
    m_N1_A37_TOTAL = 0;
    m_N1_A39_TOTAL = 0;
    m_N1_A40_TOTAL = 0;
    m_N1_A41_TOTAL = 0;
    m_N1_A42_TOTAL = 0;
    m_N1_A43_TOTAL = 0;
    m_N1_A45_TOTAL = 0;
    m_N1_A46_TOTAL = 0;
    m_N1_A47_TOTAL = 0;
    m_N1_A48_TOTAL = 0;
    m_N1_A49_TOTAL = 0;
    m_N1_A60_TOTAL = 0;
  END;
  
   macro headerEndLine()
      return НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_rshb;
   end;

   macro sumBeginLine()
      return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb;
   end;

   macro FullRange(sheet, col):string
      var s:string = "";
      var e:integer = sumBeginLine() + MAXROWSHEET;
      if((sheet == null) or (sheet = ""))
         s = "";
      else
         s = "'" + sheet + "'!";
      end;
      s = s + "$" + col + "$" + sumBeginLine();
      s = s + ":$" + col + "$" + e;
      return s;
   end;

   macro GetColRange(sheet, col, rangeSize):string
      var s:string = "";
      var e:integer = sumBeginLine() + rangeSize - 1;
      if(rangeSize < 1) 
         return "";
      end;
      if((sheet == null) or (sheet = ""))
         s = "";
      else
         s = "'" + sheet + "'!";
      end;
      s = s + "$" + col + "$" + sumBeginLine();
      s = s + ":$" + col + "$" + e;
      return s;
   end;

   MACRO Set_SUMFormula(FirstColumn, point )
      var Formula = "";
      var SheetName = "";

      if (point == null) point = 2; end;

      if (m_UseTemplate)
         SheetName = m_ObjTemplateXLS.SheetName();

         if (m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS) 
              Formula = "ROUND(SUM(";
          else                  
              Formula = "ОКРУГЛ(СУММ(";
         end;

         return "="+Formula+FirstColumn+");"+point+")";
      end;
   END;

   macro FSum_Col(sheet, col, rangeSize)
      var range;
      if(rangeSize == null)
        range = FullRange(sheet, col);
      else
        range = GetColRange(sheet, col, rangeSize);
      end;

      return this.Set_SUMFormula( range );
   end;

   macro GetItogCell(Col):string
      return "$"+Col+"$"+НОМЕР_СТРОКИ_ИТОГОВЫХ_СУММ_rshb;
   end;

  PRIVATE MACRO PrintReportHead()
    PrintFormatString(  null,         
                        "N1_H0_A", N1_H0_A,
                        "N1_FilialText", N1_FilialText,
                        "N1_H1"  , N1_H1,
                        "N1_H0_В", N1_H0_В,
                        "N1_H0_C", N1_H0_C,
                        "N1_H0_1"  , N1_H0_1,
                        "N1_H0_2"  , N1_H0_2,
                        "N1_Text1" , N1_Text1,
                        "N1_H0_3"  , N1_H0_3,
                        "N1_H0_4"  , N1_H0_4
                     );                                    
  END;

  MACRO PrintHeader_rshb()

     PrintFormatString( null,
                       "N1_Операционист",     Oper_rshb(),//Операционист(),
                       "N1_H0_Year",          GetYear(),
                       "N1_H0_PeriodCode",    GetPeriodCode(),
                       "N1_H0_PeriodTxt",     GetPeriodTxt()
                     );

  END;

  MACRO PrintHeader_rshb_supl(rangeSize)

     PrintFormatString( null,
                       GetItogCell(C_A7),      FSum_Col(null, C_A7, rangeSize),
                       GetItogCell(C_A15),     FSum_Col(null, C_A15, rangeSize),
                       GetItogCell(C_A17),     FSum_Col(null, C_A17, rangeSize),
                       GetItogCell(C_A21),     FSum_Col(null, C_A21, rangeSize),

                       GetItogCell(C_A23),     FSum_Col(null, C_A23, rangeSize),
                       GetItogCell(C_A24),     FSum_Col(null, C_A24, rangeSize),
                       GetItogCell(C_A25),     FSum_Col(null, C_A25, rangeSize),
                       GetItogCell(C_A26),     FSum_Col(null, C_A26, rangeSize),
                       GetItogCell(C_A27),     FSum_Col(null, C_A27, rangeSize),
                       GetItogCell(C_A28),     FSum_Col(null, C_A28, rangeSize),
                       GetItogCell(C_A29),     FSum_Col(null, C_A29, rangeSize),
                       GetItogCell(C_A30),     FSum_Col(null, C_A30, rangeSize),
                       GetItogCell(C_A31),     FSum_Col(null, C_A31, rangeSize),
                       GetItogCell(C_A32),     FSum_Col(null, C_A32, rangeSize),

                       GetItogCell(C_A34),     FSum_Col(null, C_A34, rangeSize),
                       GetItogCell(C_A37),     FSum_Col(null, C_A37, rangeSize),

                       GetItogCell(C_A39),     FSum_Col(null, C_A39, rangeSize),
                       GetItogCell(C_A40),     FSum_Col(null, C_A40, rangeSize),
                       GetItogCell(C_A41),     FSum_Col(null, C_A41, rangeSize),
                       GetItogCell(C_A42),     FSum_Col(null, C_A42, rangeSize),
                       GetItogCell(C_A43),     FSum_Col(null, C_A43, rangeSize),

                       GetItogCell(C_A45),     FSum_Col(null, C_A45, rangeSize),
                       GetItogCell(C_A46),     FSum_Col(null, C_A46, rangeSize),
                       GetItogCell(C_A47),     FSum_Col(null, C_A47, rangeSize),
                       GetItogCell(C_A48),     FSum_Col(null, C_A48, rangeSize),
                       GetItogCell(C_A49),     FSum_Col(null, C_A49, rangeSize),

                       GetItogCell(C_A60),     FSum_Col(null, C_A60, rangeSize)
                     );

  END;



  PRIVATE MACRO RegTable()
       RegisterTable("N1_MainTable", "N1_RepHeader",
                     "N1_Dummy1" ,
                     "N1_A1"     ,
                     "N1_A2"     ,
                     "N1_A3"     ,
                     "N1_A4"     ,
                     "N1_A5"     ,
                     "N1_A6"     ,
                     "N1_A7"     ,
                     "N1_A8"     ,
                     "N1_A9"     ,
                     "N1_A10"    ,
                     "N1_A11"    ,
                     "N1_A12"    ,
                     "N1_A13"    ,
                     "N1_A14"    ,
                     "N1_A15"    ,
                     "N1_A16"    ,
                     "N1_A17"    ,
                     "N1_A18"    ,
                     "N1_A19"    ,
                     "N1_A20"    ,
                     "N1_A21"    ,
                     "N1_A22"    ,                     
                     "N1_A23"    ,
                     "N1_A24"    ,
                     "N1_A25"    ,
                     "N1_A26"    ,
                     "N1_A27"    ,
                     "N1_A28"    ,
                     "N1_A29"    ,
                     "N1_A30"    ,
                     "N1_A31"    ,
                     "N1_A32"    ,                     
                     "N1_A33"    ,
                     "N1_A34"    ,
                     "N1_A35"    ,
                     "N1_A36"    ,
                     "N1_A37"    ,
                     "N1_A38"    ,
                     "N1_A39"    ,
                     "N1_A40"    ,
                     "N1_A41"    ,
                     "N1_A42"    ,                     
                     "N1_A43"    ,
                     "N1_A44"    ,
                     "N1_A45"    ,
                     "N1_A46"    ,
                     "N1_A47"    ,
                     "N1_A48"    ,
                     "N1_A49"    ,
                     "N1_A50"    ,
                     "N1_A50_1"  ,
                     "N1_A51"    ,
                     "N1_A52"  ,
                     "N1_A52_1"  ,
                     "N1_A53"    ,
                     "N1_A54"    ,
                     "N1_A55"    ,
                     "N1_A56"    ,
                     "N1_A57"    ,
                     "N1_A58"    ,
                     "N1_A59"    ,
                     "N1_A60"    ,
                     "N1_A61"    ,
                     "N1_A62"    ,
                     "N1_A63"    ,
                     "N1_A64"    ,
                     "N1_A65"    ,
                     "N1_A66"    ,
                     "N1_A67"    
                   );
  END;  

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )
    InitVariables();    
    SetSqlDataQuery();
    SetSqlDataSet();
  END;

  PRIVATE MACRO ПечататьСтрокуТаблицы( LineType, j )
  
    if ( LineType == LineTypeData )
      PrintTableLine( "N1_A1"     , m_Data[j].get_A(A01)  ,   null,
                      "N1_A2"     , m_Data[j].get_A(A02)  ,   null,
                      "N1_A3"     , m_Data[j].get_A(A03)  ,   null,
                      "N1_A4"     , m_Data[j].get_A(A04)  ,   null,
                      "N1_A5"     , m_Data[j].get_A(A05)  ,   null,
                      "N1_A6"     , m_Data[j].get_A(A06)  ,   null,
                      "N1_A7"     , m_Data[j].get_A(A07)  ,   null,
                      "N1_A8"     , m_Data[j].get_A(A08)  ,   null,
                      "N1_A9"     , m_Data[j].get_A(A09)  ,   null,
                      "N1_A10"    , m_Data[j].get_A(A10)  ,   null,
                      "N1_A11"    , m_Data[j].get_A(A11)  ,   null,
                      "N1_A12"    , m_Data[j].get_A(A12)  ,   null,
                      "N1_A13"    , m_Data[j].get_A(A13)  ,   null,
                      "N1_A14"    , m_Data[j].get_A(A14)  ,   null,
                      "N1_A15"    , m_Data[j].get_A(A15)  ,   null,
                      "N1_A16"    , m_Data[j].get_A(A16)  ,   null,
                      "N1_A17"    , m_Data[j].get_A(A17)  ,   null,
                      "N1_A18"    , m_Data[j].get_A(A18)  ,   null,
                      "N1_A19"    , m_Data[j].get_A(A19)  ,   null,
                      "N1_A20"    , m_Data[j].get_A(A20)  ,   null,
                      "N1_A21"    , m_Data[j].get_A(A21)  ,   null,
                      "N1_A22"    , m_Data[j].get_A(A22)  ,   null,                    
                      "N1_A23"    , m_Data[j].get_A(A23)  ,   null,
                      "N1_A24"    , m_Data[j].get_A(A24)  ,   null,
                      "N1_A25"    , m_Data[j].get_A(A25)  ,   null,
                      "N1_A26"    , m_Data[j].get_A(A26)  ,   null,
                      "N1_A27"    , m_Data[j].get_A(A27)  ,   null,
                      "N1_A28"    , m_Data[j].get_A(A28)  ,   null,
                      "N1_A29"    , m_Data[j].get_A(A29)  ,   null,
                      "N1_A30"    , m_Data[j].get_A(A30)  ,   null,
                      "N1_A31"    , m_Data[j].get_A(A31)  ,   null,
                      "N1_A32"    , m_Data[j].get_A(A32)  ,   null,                    
                      "N1_A33"    , m_Data[j].get_A(A33)  ,   null,
                      "N1_A34"    , m_Data[j].get_A(A34)  ,   null,
                      "N1_A35"    , m_Data[j].get_A(A35)  ,   null,
                      "N1_A36"    , m_Data[j].get_A(A36)  ,   null,
                      "N1_A37"    , m_Data[j].get_A(A37)  ,   null,
                      "N1_A38"    , m_Data[j].get_A(A38)  ,   null,
                      "N1_A39"    , m_Data[j].get_A(A39)  ,   null,
                      "N1_A40"    , m_Data[j].get_A(A40)  ,   null,
                      "N1_A41"    , m_Data[j].get_A(A41)  ,   null,
                      "N1_A42"    , m_Data[j].get_A(A42)  ,   null,                    
                      "N1_A43"    , m_Data[j].get_A(A43)  ,   null,
                      "N1_A44"    , m_Data[j].get_A(A44)  ,   null,
                      "N1_A45"    , m_Data[j].get_A(A45)  ,   null,
                      "N1_A46"    , m_Data[j].get_A(A46)  ,   null,
                      "N1_A47"    , m_Data[j].get_A(A47)  ,   null,
                      "N1_A48"    , m_Data[j].get_A(A48)  ,   null,
                      "N1_A49"    , m_Data[j].get_A(A49)  ,   null,
                      "N1_A50"    , m_Data[j].get_A(A50)  ,   null,
                      "N1_A50_1"  , m_Data[j].get_A(A50_1),  null, 
                      "N1_A51"    , m_Data[j].get_A(A51)  ,   null,
                      "N1_A52"    , m_Data[j].get_A(A52)  ,   null, 
                      "N1_A52_1"  , m_Data[j].get_A(A52_1),  null, 
                      "N1_A53"    , m_Data[j].get_A(A53)  ,   null,
                      "N1_A54"    , m_Data[j].get_A(A54)  ,   null,
                      "N1_A55"    , m_Data[j].get_A(A55)  ,   null,
                      "N1_A56"    , m_Data[j].get_A(A56)  ,   null,
                      "N1_A57"    , m_Data[j].get_A(A57)  ,   null,
                      "N1_A58"    , m_Data[j].get_A(A58)  ,   null,
                      "N1_A59"    , m_Data[j].get_A(A59)  ,   null,
                      "N1_A60"    , m_Data[j].get_A(A60)  ,   null,
                      "N1_A61"    , m_Data[j].get_A(A61)  ,   null,
                      "N1_A62"    , m_Data[j].get_A(A62)  ,   null,
                      "N1_A63"    , m_Data[j].get_A(A63)  ,   null,
                      "N1_A64"    , m_Data[j].get_A(A64)  ,   null,
                      "N1_A65"    , m_Data[j].get_A(A65)  ,   null,
                      "N1_A66"    , m_Data[j].get_A(A66)  ,   null,
                      "N1_A67"    , m_Data[j].get_A(A67)  ,   null
                    );                  
      m_CountDataStr = m_CountDataStr + 1;                               
    end;
       
    if ( LineType == LineTypeTotal )
        PrintTableLine("N1_A1"     , "ВСЕГО",          null,
                       "N1_A2"     , "",               null,
                       "N1_A3"     , "",               null,
                       "N1_A4"     , "",               null,
                       "N1_A5"     , "",               null,
                       "N1_A6"     , "",               null,
                       "N1_A7"     , m_N1_A07_TOTAL,   null,
                       "N1_A8"     , "",               null,
                       "N1_A9"     , "",               null,
                       "N1_A10"    , "",               null,
                       "N1_A11"    , "",               null,
                       "N1_A12"    , "",               null,
                       "N1_A13"    , "",               null,
                       "N1_A14"    , "",               null,
                       "N1_A15"    , m_N1_A15_TOTAL,   null,
                       "N1_A16"    , "",               null,
                       "N1_A17"    , m_N1_A17_TOTAL,   null,
                       "N1_A18"    , "",               null,
                       "N1_A19"    , "",               null,
                       "N1_A20"    , "",               null,
                       "N1_A21"    , m_N1_A21_TOTAL,   null,
                       "N1_A22"    , "",               null, 
                       "N1_A23"    , m_N1_A23_TOTAL,   null,
                       "N1_A24"    , m_N1_A24_TOTAL,   null,
                       "N1_A25"    , m_N1_A25_TOTAL,   null,
                       "N1_A26"    , m_N1_A26_TOTAL,   null,
                       "N1_A27"    , m_N1_A27_TOTAL,   null,
                       "N1_A28"    , m_N1_A28_TOTAL,   null,
                       "N1_A29"    , m_N1_A29_TOTAL,   null,
                       "N1_A30"    , m_N1_A30_TOTAL,   null,
                       "N1_A31"    , m_N1_A31_TOTAL,   null,
                       "N1_A32"    , m_N1_A32_TOTAL,   null, 
                       "N1_A33"    , "",               null,
                       "N1_A34"    , m_N1_A34_TOTAL,   null,
                       "N1_A35"    , "",               null,
                       "N1_A36"    , "",               null,
                       "N1_A37"    , m_N1_A37_TOTAL,   null,
                       "N1_A38"    , "",               null,
                       "N1_A39"    , m_N1_A39_TOTAL,   null,
                       "N1_A40"    , m_N1_A40_TOTAL,   null,
                       "N1_A41"    , m_N1_A41_TOTAL,   null,
                       "N1_A42"    , m_N1_A42_TOTAL,   null, 
                       "N1_A43"    , m_N1_A43_TOTAL,   null,
                       "N1_A44"    , "",               null,
                       "N1_A45"    , m_N1_A45_TOTAL,   null,
                       "N1_A46"    , m_N1_A46_TOTAL,   null,
                       "N1_A47"    , m_N1_A47_TOTAL,   null,
                       "N1_A48"    , m_N1_A48_TOTAL,   null,
                       "N1_A49"    , m_N1_A49_TOTAL,   null,
                       "N1_A50"    , "",               null,
                       "N1_A50_1"  , "",               null, 
                       "N1_A51"    , "",               null,
                       "N1_A52"    , "",               null, 
                       "N1_A52_1"  , "",               null, 
                       "N1_A53"    , "",               null,
                       "N1_A54"    , "",               null,
                       "N1_A55"    , "",               null,
                       "N1_A56"    , "",               null,
                       "N1_A57"    , "",               null,
                       "N1_A58"    , "",               null,
                       "N1_A59"    , "",               null,
                       "N1_A60"    , m_N1_A60_TOTAL,   null,
                       "N1_A61"    , "",               null,
                       "N1_A62"    , "",               null,
                       "N1_A63"    , "",               null,
                       "N1_A64"    , "",               null,
                       "N1_A65"    , "",               null,
                       "N1_A66"    , "",               null,
                       "N1_A67"    , "",               null
                        );
    end;
    
    if ( LineType == LineType3 )
      PrintTableLine( "N1_A1"     , "в том числе:",   null);
    end;
  
    if ( LineType == LineTypeNoData )
      PrintTableLine( "N1_A1"     , NoDataTxt,   null);
    end;

  END;
  
  PRIVATE MACRO ВывестиСтроки()
    if(m_DataSize > 0)
      var j = 0;
      // ПечататьСтрокуТаблицы ( LineTypeTotal) ;
      // ПечататьСтрокуТаблицы( LineType3 );

      while(j < m_DataSize)
        ПечататьСтрокуТаблицы ( LineTypeData, j );
        m_Data[j].ClearData();
        j = j + 1;
      end;
      m_Data.size = 0;
      m_DataSize = 0;
      ОбнулитьДанныеДляОбщейСтроки();
    end;
  END;

  PRIVATE MACRO SetRegistryPeriodsForBanner( srcBnrID, FirstDate, PFI )
    var local_period;
    m_RegistryPeriodArray.size = 0;
    var PeriodDateBegin:date;
    var PeriodDateEnd:date;
    var planRepayDate:date;
    PeriodDateBegin = ZeroDate;    
    PeriodDateEnd = ZeroDate;
    planRepayDate = GetPlanRepayDate(srcBnrID);
    var isValidPeriod:BOOL;
    var isCorrecting:BOOL;
    var InfoBuy:BnrPeriodInfo;
    var InfoRep:BnrPeriodInfo;
    //изначально период неподходящий, очевидно, и исправлять никого не надо.
    isValidPeriod = false;
    isCorrecting  = false;

    /*****************************************************************************/
    /* просмотр истории векселя от "начал времён" до окончания отчётного периода */
    /*****************************************************************************/
    var Query =     " SELECT BnrHist.t_ID, ";
    Query = Query + "        BnrHist.t_ChangeDate, ";
    Query = Query + "        BnrHist.t_NewabcStatus status, ";
    Query = Query + "        BnrHist.t_OldabcStatus prev_status, ";
    Query = Query + "        BnrHist.t_OldBCState prev_state, ";
    Query = Query + "        BnrHist.t_NewBCState state, ";
    Query = Query + "        opr.T_DOCKIND, ";
    Query = Query + "        TO_NUMBER (opr.T_DOCUMENTID) AS T_DOCUMENTID, ";
    Query = Query + "        opr.t_ID_Operation, ";
    Query = Query + "        lnk.t_BCCost lnk_BCCost, ";
    Query = Query + "        lnk.t_BCCFI lnk_BCCFI, ";
    Query = Query + "        PartyClient.t_ShortName Client_ShortName, ";
    Query = Query + "        PartyClient.t_PartyID ClientID, ";
    Query = Query + "        CASE WHEN PartyClient.t_NRCountry = CHR (1) THEN '' ";
    Query = Query + "             ELSE (select t_FullName from dcountry_dbt where t_CodeLAT3 = PartyClient.t_NRCountry) ";
    Query = Query + "        END Country_FullName, ";
    Query = Query + "        tick.t_dealid tick_DealId, ";
    Query = Query + "        tick.t_BofficeKind tick_DocKind, ";
    Query = Query + "        tick.t_dealcode tick_DealCode, ";
    Query = Query + "        tick.T_DEALDATE tick_DealDate, ";
    Query = Query + "        tick.T_CLIENTID tick_ClientId, ";
    Query = Query + "        rsb_bill.GetBNRFirstDate (BnrHist.t_bcid, tick.t_dealid) FirstDate ,";
    Query = Query + "        tick.T_DEPARTMENT ";
    Query = Query + "   FROM dvsbnrbck_dbt BnrHist, ";
    Query = Query + "        doprdocs_dbt odoc, ";
    Query = Query + "        DOPROPER_DBT opr, ";
    Query = Query + "        dvsordlnk_dbt lnk, ";
    Query = Query + "        ddl_tick_dbt tick, ";
    Query = Query + "        dparty_dbt PartyClient ";
    Query = Query + "  WHERE BnrHist.t_bcid = ? ";
    Query = Query + "        AND opr.T_DOCKIND in (?, ?, ?) ";
    Query = Query + "        AND BnrHist.t_ABCStatus = 'X' ";
    Query = Query + "        AND BnrHist.t_ChangeDate <= ? ";
    Query = Query + "        AND BnrHist.t_ChangeDate >= ? ";
    Query = Query + "        AND odoc.t_DocumentID = LTRIM (TO_CHAR (BnrHist.t_id, '0000000000')) ";
    Query = Query + "        AND odoc.t_DocKind = ? ";
    Query = Query + "        AND opr.t_ID_Operation = odoc.t_ID_Operation ";
    Query = Query + "        AND lnk.t_BCID = BnrHist.t_bcid ";
    Query = Query + "        AND lnk.t_ContractID = TO_NUMBER (opr.T_DOCUMENTID) ";
    Query = Query + "        AND tick.t_dealid = TO_NUMBER (opr.T_DOCUMENTID) ";
    Query = Query + "        AND PartyClient.t_PartyID = tick.T_PARTYID ";
    Query = Query + "        order by BnrHist.t_ChangeDate, BnrHist.t_Id ";
  
     

    var cmd = RSDCommand( Query );
    cmd.addParam( "", RSDBP_IN, srcBnrID );
    cmd.addParam( "", RSDBP_IN, DL_VEKSELACCOUNTED );
    cmd.addParam( "", RSDBP_IN, DL_VAENWR );
    cmd.addParam( "", RSDBP_IN, DL_VAREPAY );
    cmd.addParam( "", RSDBP_IN, m_EndDate );
    cmd.addParam( "", RSDBP_IN, FirstDate );
    cmd.addParam( "", RSDBP_IN, DL_VSBNRBCK );
    cmd.execute(); 
    var DS = TRsbDataSet( cmd );

    MACRO СброситьПериоды_и_Флаги()
      isValidPeriod = false;
      PeriodDateBegin = ZeroDate;    
      PeriodDateEnd = ZeroDate;
      isCorrecting = false;
      InfoBuy = NULL;
      InfoRep = NULL;
    END;

    while ( DS.MoveNext )
      if ( ( DS.status == VABANNER_STATUS_ACCOUNT ) and ( DS.prev_status != VABANNER_STATUS_ACCOUNT ) )     //изменился на "УЧТЕН"
          if ( ( PeriodDateBegin == ZeroDate ) and ( PeriodDateEnd == ZeroDate ) )
            PeriodDateBegin = DS.ChangeDate;
            isValidPeriod = true;
            InfoBuy = BnrPeriodInfo(DS);
          end;
      end;
      
      if ( (( DS.prev_status == VABANNER_STATUS_ACCOUNT ) and ( DS.status == VABANNER_STATUS_ENDED))
          or (( DS.prev_status == VABANNER_STATUS_ACCOUNT ) and ( DS.status == VABANNER_STATUS_INPUT)) )//изменился с  "выдан" на "погашен" или "выкуплен"
        if (m_BeginDate > DS.ChangeDate)          
          СброситьПериоды_и_Флаги;
        else
          if   ( isValidPeriod == true )
            /*окончание для нового учётного периода*/
            PeriodDateEnd = DS.ChangeDate;
            InfoRep = BnrPeriodInfo(DS);
          end;
        end;
      end;
      
      if ( ( isValidPeriod == true ) and ( PeriodDateBegin != ZeroDate ) and ( PeriodDateEnd != ZeroDate ) )
        m_RegistryPeriodArray[m_RegistryPeriodArray.size] = RegistryPeriod( srcBnrID, PeriodDateBegin, PeriodDateEnd, PeriodTypeClose, InfoBuy, InfoRep );
        СброситьПериоды_и_Флаги;
      end;
    end;
    /***********************************************************/
    /*ds находится на последней позиции её анализируем отдельно*/
    /***********************************************************/
    if ( ( isValidPeriod == true ) and ( PeriodDateBegin != ZeroDate ) )
        m_RegistryPeriodArray[m_RegistryPeriodArray.size] = RegistryPeriod(srcBnrID, PeriodDateBegin, min(planRepayDate, m_EndDate), PeriodTypeOpen, InfoBuy, NULL);
        СброситьПериоды_и_Флаги;
    end;
    
  END;

  PRIVATE MACRO CReport_NoDataMsg()
    if (not m_IsWebService)
      msgbox("Нет данных для формирования отчета");
    end;
  END;

  macro SetAutoSize() //Автоматическая ширина для столбцов
     m_ObjTemplateXLS.SetAutoFit("C:BR", m_ObjTemplateXLS.SheetName());             
  end;

  MACRO SetOnAutoFilter(range)
    if( ExistsSheet( m_ObjTemplateXLS.SheetName() ) )
       m_ObjTemplateXLS.SetAutoFilter(range, m_ObjTemplateXLS.SheetName());
    end;
  END;

  PRIVATE MACRO Create( NumCopy:INTEGER )
    VAR ProgressIndicator, header;
    VAR ProgressValue = CTxProgressValue();
    VAR progr = 0;

    this.SetActiveSheet( SHEET_VAREGISTER );
    // PrintReportHead();    
    PrintHeader_rshb();
    RegTable();      

    /* для каждого векселя */
    if ( VA_DataExist() )
      ProgressValue.Maximum = m_NRecsBNRS;
      ProgressValue.Current = 0;

      if( m_IsWebService )
        header = "Формирование отчета " + WebMenuItem.szNameItem;
      else
        InitProgress( m_NRecsBNRS, "Идет формирование отчета", "Регистр по учтенным векселям" );
      end;
      ProgressIndicator = CreateProgressIndicator(true);
      ProgressIndicator.Start(ProgressValue.Maximum, header, header);
    end;
    var curBnrIndex = 0;
    var CurCurrency = -1;

    if (VA_DataExist())
      while ( m_DataSetBanners.MoveNext() )
        ПровестиДополнительныеВычисления();
        
        /*************************************************/
        /* задать учётные периоды для очередного векселя */
        /*************************************************/
        i = 0;
        if(CurCurrency == -1)
          CurCurrency = m_DataSetBanners.PFI;
        elif(CurCurrency != m_DataSetBanners.PFI)
          ВывестиСтроки();
          CurCurrency = m_DataSetBanners.PFI;
        end;

        SetRegistryPeriodsForBanner ( m_DataSetBanners.BCID, m_DataSetBanners.FirstDate, m_DataSetBanners.PFI );
        
        while ( (i < m_RegistryPeriodArray.size) and (m_fd.IsBill()) )
          var stat = 0;
          m_Data[m_DataSize] = ReportData();
          m_DataSize = m_DataSize + 1;
          НаполненияПолейВекс();
          
          if(m_RegistryPeriodArray[i].PeriodType == PeriodTypeClose )
            stat = РасчетПолейПокупки();
            if(stat == 0)
              РасчетПолейВыбытия();
            end;
          else
            stat = РасчетПолейПокупки();
            if(stat == 0)
              РасчетПолейНереализованных();
            end;
          end;
          if( stat == 0 )
            ДобавитьДанныеДляОбщейСтроки();
          else
            m_DataSize = m_DataSize - 1;
            m_Data[m_DataSize].ClearData();
          end;

          i = i + 1;
        end;
        ProgressValue.Current = ProgressValue.Current + 1;
        ProgressIndicator.Update(ProgressValue.Current,ProgressValue.Maximum); 

        if (not m_IsWebService)
          progr = progr + 1;
          UseProgress( progr );
        end;
      end;

      ВывестиСтроки();
      ProgressIndicator.Stop();
      if (not m_IsWebService)
        RemProgress();
      end;
      EndTable();
      PrintHeader_rshb_supl(m_CountDataStr);  
      SetAutoSize();
      SetOnAutoFilter("B12:BR12");
      ReplaceFormulaAndCalculate();
    else
      ПечататьСтрокуТаблицы ( LineTypeNoData, 0 );
      EndTable();
      PrintHeader_rshb_supl(1);  
    END;    
  end;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
  var stat = true;
  var FullReportFileNames = TArray();
  var Register_Report;

  if( not IsWebService )
    VARegister_Form = DL_Register_Panel("VAREGREP");
  else
    WebMenuItem = menuItem;
    if( ValType( FormData ) != V_UNDEF )
      WebFormData = FormData;
    else
      stat = false;
    end;
  end;

  while( stat )
    if( not IsWebService )
      stat = VARegister_Form.Run();
    end;

    if( stat )
      Register_Report = VA_Register_Report( null, "report_va_register.xlsx", null, IsWebService, ReportHashCode, TRUE, FALSE );
      Register_Report.Run();

      if( IsWebService )
        Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem);
        FullReportFileNames = Register_Report.GetFullReportFileNames();
        stat = false;
      else
        DL_CallInsertStat(DL_OUTREPORT_EXCEL);
      end;
    end;
  end;

  return FullReportFileNames;
END;