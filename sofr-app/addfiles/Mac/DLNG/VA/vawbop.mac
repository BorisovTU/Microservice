/*
$Name:         vawbop.mac
$Module:       Учтенные векселя, Ценные бумаги
$Description:  Печать отчета "Резервы по операциям с ц/б"
*/

IMPORT PaymInter, VSInter, CTInter, RsbDataSet;
IMPORT vasale, dlmisc, vaservop, dlrepfun, vareport, vamisc, vapaym, vaopr, vsrplib, spreserv, vaacc, vsbnrfd;
import "CbReport_h.mac";

VAR ProcVSCat,/* в данном массиве храним векселя для которых не соответствуют категория качества и процент резервирования */
    ProcSecCat,
    ProcVSCatDeal,
    ProcSecCatDeal,
    ЦбОтсутствуетКК,
    ЦбОтсутствуетПроцентРезерва,
    ResAbs,/* отсутствует процент резервирования */
    apostrophe = false;

    ProcSecCat = TArray();
    ProcVSCat = TArray();
    ProcSecCatDeal = TArray();
    ProcVSCatDeal = TArray();
    ЦбОтсутствуетКК = TArray();
    ЦбОтсутствуетПроцентРезерва = TArray();
    ResAbs = TArray();

private var a_str = "";
private var ExistsData = false;
private var ExistsDataRef4 = false;
private var ExistsDataRef6 = false;

private var strsize = 200; //длина строки

private const header =
   "┌───────┬────────────────────┬────────────┬─────────────────────────────────────────────────┬──────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────┬────────────┐\n" +
   "│       │                    │            │              Категория качества                 │           Просроченная задолженность             │      Резерв на возможные потери                                       │ Корректи-  │\n" +
   "│ Номер │   Состав активов   │   Сумма    ├─────────┬─────────┬─────────┬─────────┬─────────┼────────────┬────────────┬────────────┬───────────┼─────────────┬───────────────┬─────────────────────────────────────────┤ ровка ре-  │\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │               │   фактически                            │ зерва на   │\n" +
   "│ строки│                    │ требования │    I    │    II   │   III   │    IV   │    V    │ до 30 дней │  от 31 до  │  от 91 до  │   свыше   │  расчетный  │  расчетный    │   сформированный                        │ возможные  │\n" +
   "│       │                    │            │         │         │         │         │         │            │  90 дней   │  180 дней  │  180 дней │             │  с учетом     ├─────────┬───────────────────────────────┤ потери до  │\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │ обеспечения   │         │    по категориям качества     │ оценочного │\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │               │  итого  ├───────┬───────┬───────┬───────┤ резерва    │\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │               │         │   II  │  III  │   IV  │   V   │ ожидаемые  │\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │               │         │       │       │       │       │ кредитные  │\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │               │         │       │       │       │       │ убытки     │\n" +
   "├───────┼────────────────────┼────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────────┼────────────┼────────────┼───────────┼─────────────┼───────────────┼─────────┼───────┼───────┼───────┼───────┼────────────┤\n" +
   "│       │                    │            │         │         │         │         │         │            │            │            │           │             │               │         │       │       │       │       │            │\n" +
   "│   1   │         2          │      3     │    4    │    5    │    6    │    7    │    8    │      9     │     10     │     11     │     12    │      13     │      14       │    15   │   16  │   17  │   18  │   19  │     20     │\n" +
   "├───────┼────────────────────┼────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼────────────┼────────────┼────────────┼───────────┼─────────────┼───────────────┼─────────┼───────┼───────┼───────┼───────┼────────────┤";

private const header_4 =
   "┌───────┬──────────────────────────────┬─────────────────────┬────────────────────┬────────────────┬───────────────┬────────────────┬──────────────────────────────────────────────────────────────┐\n" +
   "│ Номер │   Наименование депозитария   │   ИНН депозитария   │   Номер лицензии   │   Количество   │  Балансовая   │  Справедливая  │      Сформированный резерв на возможные потерия, тыс. руб.   │\n" +
   "│ строки│                              │                     │    депозитария     │  ценных бумаг, │   стоимость   │   стоимость    ├────────────────────┬────────────────────┬────────────────────┤\n" +
   "│       │                              │                     │                    │       шт.      │ ценных бумаг, │  ценных бумаг, │ В соответствии с   │ В соответствии с   │       Итого        │\n" +
   "│       │                              │                     │                    │                │   тыс. руб.   │    тыс. руб.   │ Положением № 611-П │ Указанием № 2732-У │   (гр. 8 + гр. 9)  │\n" +
   "├───────┼──────────────────────────────┼─────────────────────┼────────────────────┼────────────────┼───────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┤\n" +
   "│   1   │               2              │           3         │          4         │        5       │       6       │        7       │          8         │          9         │         10         │\n" +
   "├───────┼──────────────────────────────┼─────────────────────┼────────────────────┼────────────────┼───────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┤";

private const header_5 =
   "                                                                                                                                                                  тыс. руб.\n" +
   "┌───────┬────────────────────────────────────────────────────┬────────────────────────┬───────────────────────┬──────────────────────────────────┬────────────────────────┐\n" +
   "│ Номер │                   Состав активов                   │    Сумма требования    │ Сформированный резерв │ Корректировка резерва на возмож- │ Справедливая стоимость │\n" +
   "│ строки│                                                    │                        │  на возможные потери  │ ные потери до оценочного резерва │                        │\n" +
   "│       │                                                    │                        │                       │  под ожидаемые кредитные убытки  │                        │\n" +
   "├───────┼────────────────────────────────────────────────────┼────────────────────────┼───────────────────────┼──────────────────────────────────┼────────────────────────┤\n" +
   "│   1   │                         2                          │            3           │            4          │                 5                │            6           │\n" +
   "├───────┼────────────────────────────────────────────────────┼────────────────────────┼───────────────────────┼──────────────────────────────────┼────────────────────────┤";

private const header_6 =
   "                                                                                                                                                                                   тыс. руб.\n" +
   "┌──────────┬──────────────────────────────┬──────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────┐\n" +
   "│          │                              │                               Сумма требования                               │                                                                 │\n" +
   "│          │                              ├────────────┬─────────────────────────────────────────────────────────────────┤       Фактически сформированный резерв на возможные потери      │\n" +
   "│   Номер  │        Наименование          │            │          Балансовая стоимость без учета корректировок           │                                                                 │\n" +
   "│  строки  │         финансового          │ Балансовая ├──────────┬──────────────────────────────────────────────────────┼──────────┬──────────────────────────────────────────────────────┤\n" +
   "│          │           актива             │  стоимость │          │                по категориям качества                │          │                по категориям качества                │\n" +
   "│          │                              │            │   Итого  ├──────────┬──────────┬──────────┬──────────┬──────────┤   Итого  ├──────────┬──────────┬──────────┬──────────┬──────────┤\n" +
   "│          │                              │            │          │     I    │    II    │    III   │    IV    │     V    │          │     I    │    II    │    III   │    IV    │     V    │\n" +
   "├──────────┼──────────────────────────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤\n" +
   "│      1   │               2              │       3    │      4   │      5   │     6    │     7    │     8    │     9    │    10    │    11    │    12    │    13    │    14    │    15    │\n" +
   "├──────────┼──────────────────────────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤";

private const header_6_4927 =
   "                                                                                                                                                                        тыс. руб.\n" +
   "┌──────────┬──────────────────────────────┬──────────────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────┐\n" +
   "│          │                              │                               Сумма требования                               │                                                      │\n" +
   "│          │                              ├────────────┬─────────────────────────────────────────────────────────────────┤ Фактически сформированный резерв на возможные потери │\n" +
   "│   Номер  │        Наименование          │            │          Балансовая стоимость без учета корректировок           │                                                      │\n" +
   "│  строки  │         финансового          │ Балансовая ├──────────┬──────────────────────────────────────────────────────┼──────────┬───────────────────────────────────────────┤\n" +
   "│          │           актива             │  стоимость │          │                по категориям качества                │          │          по категориям качества           │\n" +
   "│          │                              │            │   Итого  ├──────────┬──────────┬──────────┬──────────┬──────────┤   Итого  ├──────────┬──────────┬──────────┬──────────┤\n" +
   "│          │                              │            │          │     I    │    II    │    III   │    IV    │     V    │          │    II    │    III   │    IV    │    V     │\n" +
   "├──────────┼──────────────────────────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤\n" +
   "│      1   │               2              │       3    │      4   │      5   │     6    │     7    │     8    │     9    │    10    │    11    │    12    │    13    │    14    │\n" +
   "├──────────┼──────────────────────────────┼────────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤";


// нужны изменения по 3129?
private macro Need3129(Dотч:date) : bool
  return (Dотч >= Date(01,06,2014));
end;

// нужны изменения по 4212?
private macro Need4212(Dотч:date) : bool
  return (Dотч >= Date(01,01,2017));
end;

private var rep = CVAMakeReport(header);
private const FontStyleTitel =  "ex_FS(b)";

private macro AddStr()
   rep.AddStr();
end;

private macro AddEmptyStr();
   rep.AddEmptyStr();
end;

private macro PrintCell( Str )
   rep.AddPrintCell( Str, strlen(Str)+2, 0, "l:" + FontStyleTitel, REP_ELEM_STR );
end;

private macro PrintCellTable( Str )
   rep.AddPrintCell( Str, 0, 0, "l:" +a_str+ FontStyleTitel );
end;

private macro PrintCellSize( Str, S_Size )
   rep.AddPrintCell( Str, S_Size, 0, "l:" +a_str+FontStyleTitel, REP_ELEM_STR );
end;

private macro PrintCellSizeC( Str, S_Size )
   rep.AddPrintCell( Str, S_Size, 0, "c:" + FontStyleTitel, REP_ELEM_STR );
end;

private macro PrintCellSizeR( Str, S_Size )
   rep.AddPrintCell( Str, S_Size, 0, "r:" + FontStyleTitel, REP_ELEM_STR );
end;

//номера строк
var Str1      = "1",
    Str1_3    = "1.3",
    Str1_4    = "1.4",
    Str1_5    = "1.5",
    Str1_6    = "1.6",
    Str1_8    = "1.8",
    Str1_8_а  = "1.8а",
    Str1_8_б  = "1.8б",
    Str2      = "2",
    Str2_2    = "2.2",
    Str2_3    = "2.3",
    Str2_4    = "2.4",
    Str2_5    = "2.5",
    Str2_7    = "2.7",
    Str2_7_а  = "2.7а",
    Str2_8    = "2.8",
    Str2_8_1  = "2.8.1",
    Str3      = "3",
    Str3_5    = "3.5",
    Str3_6    = "3.6",
    Str4      = "4",
    Str4_1    = "4.1",
    Str4_2    = "4.2";

var Str6_1    = "1",
    Str6_1_2  = "1.2",
    Str6_1_3  = "1.3",
    Str6_2    = "2",
    Str6_2_2  = "2.2",
    Str6_2_3  = "2.3",
    Str6_2_4  = "2.4";

class ResRepStr(name, num, title)
  var strName = name; //уникальное имя строки
  //выводятся в отчет
  var strNum = num;
  var strTitle = title;
  var S3 = 0.0;  var S4 = 0.0;  var S5 = 0.0;
  var S6 = 0.0;  var S7 = 0.0;  var S8 = 0.0;
  var S9 = 0.0;  var S10 = 0.0; var S11 = 0.0;
  var S12 = 0.0; var S13 = 0.0; var S14 = 0.0;
  var S15 = 0.0; var S16 = 0.0; var S17 = 0.0;
  var S18 = 0.0; var S19 = 0.0; var S20 = 0.0;
end;

macro _round(val)
 if(val != 0.0)
   return Round((val/1000.0), 0);
 end;

 return val;
end;

class RepTable(_repDate, _bySecur, _byVA, _needpart1, _needpart2)
  var needpart1 = _needpart1, needpart2 = _needpart2;
  var RepDate = _repDate;
  var bySecur = _bySecur, byVA = _byVA;
  var A5 = 0.0;
  var A8 = 0.0;

  var ReportArr = TArray();
  ReportArr.size = 0;

  ReportArr[ReportArr.size] = ResRepStr(Str1,     "1",    "Требования к кредитным организациям, всего, в том числе:");
  ReportArr[ReportArr.size] = ResRepStr(Str1_3,   "1.3",  "учтенные векселя");
  ReportArr[ReportArr.size] = ResRepStr(Str1_4,   "1.4",  "вложения в ценные бумаги");
  ReportArr[ReportArr.size] = ResRepStr(Str1_5,   "1.5",  "требования по сделкам, связанным с отчуждением (приобретением) кредитной организацией финансовых активов с одновременным предоставлением контрагенту права отсрочки платежа (поставки финансовых активов)");
  ReportArr[ReportArr.size] = ResRepStr(Str1_6,   "1.6",  "требования по возврату денежных средств, предоставленных по операциям, совершаемым с ценными бумагами на возвратной основе без признания получаемых бумаг");
  ReportArr[ReportArr.size] = ResRepStr(Str1_8,   "1.8",  "требования по получению процентных доходов по требованиям к кредитным организациям");
  ReportArr[ReportArr.size] = ResRepStr(Str1_8_а, "",     "По учтенным векселям");
  ReportArr[ReportArr.size] = ResRepStr(Str1_8_б, "",     "По вложениям в ценные бумаги");
  ReportArr[ReportArr.size] = ResRepStr(Str2,     "2",    "Требования к юридическим лицам (кроме кредитных организаций), всего, в том числе:");
  ReportArr[ReportArr.size] = ResRepStr(Str2_2,   "2.2",  "учтенные векселя");
  ReportArr[ReportArr.size] = ResRepStr(Str2_3,   "2.3",  "требования по сделкам, связанным с отчуждением (приобретением) кредитной организацией финансовых активов с одновременным предоставлением контрагенту права отсрочки платежа (поставки финансовых активов)");
  ReportArr[ReportArr.size] = ResRepStr(Str2_4,   "2.4",  "вложения в ценные бумаги");
  ReportArr[ReportArr.size] = ResRepStr(Str2_5,   "2.5",  "требования по возврату денежных средств, предоставленных по операциям, совершаемым с ценными бумагами на возвратной основе без признания получаемых ценных бумаг");
  ReportArr[ReportArr.size] = ResRepStr(Str2_7,   "2.7",  "требования по получению процентных доходов по требованиям к юридическим лицам (кроме кредитных организаций)");
  ReportArr[ReportArr.size] = ResRepStr(Str2_7_а, "",     "По учтенным векселям");
  ReportArr[ReportArr.size] = ResRepStr(Str2_8,   "2.8",  "Задолженность по ссудам, предоставленным субъектам малого и среднего предпринимательства");
  ReportArr[ReportArr.size] = ResRepStr(Str2_8_1, "2.8.1","в том числе учтенные векселя");
  ReportArr[ReportArr.size] = ResRepStr(Str3,     "3",    "Предоставленные физическим лицам ссуды (займы) и прочие требования к физическим лицам, всего, в том числе:");
  ReportArr[ReportArr.size] = ResRepStr(Str3_5,   "3.5",  "прочие активы");
  ReportArr[ReportArr.size] = ResRepStr(Str3_6,   "3.6",  "пребования по получению процентных доходов по требованиям к физическим лицам");
  ReportArr[ReportArr.size] = ResRepStr(Str4,     "4",    "Активы, оцениваемые в целях создания резервов на возможные потери, итого, (стр.1+стр.2+стр.3) из них:");
  ReportArr[ReportArr.size] = ResRepStr(Str4_1,   "4.1",  "ссуды, ссудная и приравненная к ней задолженность, всего");
  ReportArr[ReportArr.size] = ResRepStr(Str4_2,   "4.2",  "активы, кроме ссуд, ссудной и приравниваемой к ней задолженности в соответствии с приложением 1 к Положению Банка России № 590-П, всего, в том числе");

  macro FindStrByName(name)
    var i = 0;
    while(i < ReportArr.size)
      if(ReportArr[i].strName == name)
        return i;
      end;
      i = i+1;
    end;

    return -1;
  end;

  private macro add_a5(name, K, S)
    if(( (((name == Str1_3) OR
           (name == Str1_4) OR
           (name == Str2_2) OR
           (name == Str2_4)
          ) AND (needpart1)
         ) OR
         (((name == Str1_5) OR
           (name == Str1_6) OR
           (name == Str2_3) OR
           (name == Str2_5) OR
           (name == Str3_5)
          ) AND (needpart2)
         )
       ) AND
       (K > 2)
      )
      A5 = A5 + S;
    end;
  end;

  private macro add_a8(name, K, S)
    if( ( (name == Str1_8_б) OR (name == Str2_7) OR (name == Str3_6) ) AND (K > 2) )
      A8 = A8 + S;
    end;
  end;

  macro add(name, W1, W2, W3, W4, K, C, W5)
    var i = FindStrByName(name);

    if(i < 0 )  return; end;

    ReportArr[i].S3 = ReportArr[i].S3 + W1;
    if(K == 1)
      ReportArr[i].S4 = ReportArr[i].S4 + W1;
    elif(K == 2)
      ReportArr[i].S5 = ReportArr[i].S5 + W1;
    elif(K == 3)
      ReportArr[i].S6 = ReportArr[i].S6 + W1;
    elif(K == 4)
      ReportArr[i].S7 = ReportArr[i].S7 + W1;
    elif(K == 5)
      ReportArr[i].S8 = ReportArr[i].S8 + W1;
    end;

    if(C <= 30)
      ReportArr[i].S9 = ReportArr[i].S9 + W2;
    elif((C > 30) and (C <= 90))
      ReportArr[i].S10 = ReportArr[i].S10 + W2;
    elif((C > 90) and (C <= 180))
      ReportArr[i].S11 = ReportArr[i].S11 + W2;
      add_a8(name, K, W2);
    elif(C > 180)
      ReportArr[i].S12 = ReportArr[i].S12 + W2;
      add_a8(name, K, W2);
    end;

    ReportArr[i].S13 = ReportArr[i].S13 + W3;
    add_a5(name, K, W3);

    if( (ValType(W5) != V_UNDEF) and (W5 != $0) ) // с учетом обеспечения
       ReportArr[i].S14 = ReportArr[i].S14 + W5;
    else // без учета обеспечения
       ReportArr[i].S14 = ReportArr[i].S13;
    end;

    ReportArr[i].S15 = ReportArr[i].S15 + W4;

    if(K == 2)
      ReportArr[i].S16 = ReportArr[i].S16 + W4;
    elif(K == 3)
      ReportArr[i].S17 = ReportArr[i].S17 + W4;
    elif(K == 4)
      ReportArr[i].S18 = ReportArr[i].S18 + W4;
    elif(K == 5)
      ReportArr[i].S19 = ReportArr[i].S19 + W4;
    end;

    ExistsData = true;
  end;

  macro add2(name, W1, W2, W3, W4, W5, K, C)
    var i = FindStrByName(name);
    if(i < 0 )  return; end;
    add(name, W1, W2, W3, W4, K, C);
    ReportArr[i].S20 = ReportArr[i].S20 + W5;
  end;

  macro add_c(name, name_c)
    var i = FindStrByName(name);
    var j = FindStrByName(name_c);

    ReportArr[i].S3  = ReportArr[i].S3  + ReportArr[j].S3 ;
    ReportArr[i].S4  = ReportArr[i].S4  + ReportArr[j].S4 ;
    ReportArr[i].S5  = ReportArr[i].S5  + ReportArr[j].S5 ;
    ReportArr[i].S6  = ReportArr[i].S6  + ReportArr[j].S6 ;
    ReportArr[i].S7  = ReportArr[i].S7  + ReportArr[j].S7 ;
    ReportArr[i].S8  = ReportArr[i].S8  + ReportArr[j].S8 ;
    ReportArr[i].S9  = ReportArr[i].S9  + ReportArr[j].S9 ;
    ReportArr[i].S10 = ReportArr[i].S10 + ReportArr[j].S10;
    ReportArr[i].S11 = ReportArr[i].S11 + ReportArr[j].S11;
    ReportArr[i].S12 = ReportArr[i].S12 + ReportArr[j].S12;
    ReportArr[i].S13 = ReportArr[i].S13 + ReportArr[j].S13;
    ReportArr[i].S14 = ReportArr[i].S14 + ReportArr[j].S14;
    ReportArr[i].S15 = ReportArr[i].S15 + ReportArr[j].S15;
    ReportArr[i].S16 = ReportArr[i].S16 + ReportArr[j].S16;
    ReportArr[i].S17 = ReportArr[i].S17 + ReportArr[j].S17;
    ReportArr[i].S18 = ReportArr[i].S18 + ReportArr[j].S18;
    ReportArr[i].S19 = ReportArr[i].S19 + ReportArr[j].S19;
    ReportArr[i].S20 = ReportArr[i].S20 + ReportArr[j].S20; 

  end;

  macro print()
    var isprinthead = false;
    var i = 0;
    while( i < ReportArr.size )
      // если только для модуля учтенных векселей
      if(not bySecur and byVA)
        // пропустить строки модуля ц/б
        if((ReportArr[i].strName == Str1_6) or
           (ReportArr[i].strName == Str2_4) or
           (ReportArr[i].strName == Str2_5) or
           (ReportArr[i].strName == Str3_6)
          )
          i = i + 1;
          continue;
        end;

        if(not needpart1)
          if((ReportArr[i].strName == Str1_3) or (ReportArr[i].strName == Str1_4) or
             (ReportArr[i].strName == Str1_8) or (ReportArr[i].strName == Str1_8_а) or (ReportArr[i].strName == Str1_8_б) or
             (ReportArr[i].strName == Str2_2) or
             (ReportArr[i].strName == Str2_7) or (ReportArr[i].strName == Str2_7_а) or
             (ReportArr[i].strName == Str2_8_1)
            )
            i = i + 1;
            continue;
          end;
        end;

        if(not needpart2)
          if((ReportArr[i].strName == Str1_5) or
             (ReportArr[i].strName == Str2_3) or
             (ReportArr[i].strName == Str3) or (ReportArr[i].strName == Str3_5)
            )
            i = i + 1;
            continue;
          end;
        end;
      end;

      // если только для модуля ц/б
      if(bySecur and not byVA)
        // пропустить строки модуля учтенных векселей
        if((ReportArr[i].strName == Str1_3) or
           (ReportArr[i].strName == Str2_2) or
           (ReportArr[i].strName == Str2_8) or
           (ReportArr[i].strName == Str2_8_1) or
           (ReportArr[i].strName == Str3_5)
          )
          i = i + 1;
          continue;
        end;

        if(not needpart1)
          if((ReportArr[i].strName == Str1_4) or
             (ReportArr[i].strName == Str2_4)
            )
            i = i + 1;
            continue;
          end;
        end;

        if(not needpart2)
          if((ReportArr[i].strName == Str1_5) or
             (ReportArr[i].strName == Str1_6) or
             (ReportArr[i].strName == Str2_3) or
             (ReportArr[i].strName == Str2_5)
            )
            i = i + 1;
            continue;
          end;
        end;

        if(not needpart1 and not needpart2)
          if((ReportArr[i].strName == Str1_8) or (ReportArr[i].strName == Str1_8_а) or (ReportArr[i].strName == Str1_8_б) or
             (ReportArr[i].strName == Str2_7)
            )
            i = i + 1;
            continue;
          end;
        end;
      end;

      if(not byVA and not needpart1 and not needpart2)
        if(ReportArr[i].strName == Str2_8)
          i = i + 1;
          continue;
        end;
      end;

      if(not Need4212(RepDate))
        if(ReportArr[i].strName == Str4_2)
          i = i + 1;
          continue;
        end;
      end;
      
      if(needpart1 or needpart2)
          if((ReportArr[i].strName == Str1_8_а) or (ReportArr[i].strName == Str1_8_б))
            i = i + 1;
            continue;
          end;
      end;

      if(isprinthead == false)
        AddStr();
        PrintCell( "Раздел 1.  Информация о качестве активов, оцениваемых в целях создания резерва на возможные потери" );
        isprinthead = true;
      end;

      AddStr();

      PrintCellTable( ReportArr[i].strNum );
      PrintCellTable( ReportArr[i].strTitle );
      PrintCellTable( _round(ReportArr[i].S3) );
      PrintCellTable( _round(ReportArr[i].S4) );
      PrintCellTable( _round(ReportArr[i].S5) );
      PrintCellTable( _round(ReportArr[i].S6) );
      PrintCellTable( _round(ReportArr[i].S7) );
      PrintCellTable( _round(ReportArr[i].S8) );
      PrintCellTable( _round(ReportArr[i].S9) );
      PrintCellTable( _round(ReportArr[i].S10) );
      PrintCellTable( _round(ReportArr[i].S11) );
      PrintCellTable( _round(ReportArr[i].S12) );
      PrintCellTable( _round(ReportArr[i].S13) );
      PrintCellTable( _round(ReportArr[i].S14) );
      PrintCellTable( _round(ReportArr[i].S15) );
      PrintCellTable( _round(ReportArr[i].S16) );
      PrintCellTable( _round(ReportArr[i].S17) );
      PrintCellTable( _round(ReportArr[i].S18) );
      PrintCellTable( _round(ReportArr[i].S19) );
      if(i < FindStrByName(Str3))
        PrintCellTable( _round(ReportArr[i].S20) );
      else
        PrintCellTable( "" );
      end;

      i = i + 1;
    end;

    //справочно
    AddStr();
    AddEmptyStr();

    AddStr();
    PrintCellSize( "Раздел \"Справочно\"", strsize );

    AddStr();
    PrintCellSize("3. Резерв на возможные потери (тыс. руб.):", strsize);
    AddStr();
    PrintCellSize("3.1. расчетный резерв по ссудам III-V категории качества", 60);
    PrintCellSize(_round(A5), strsize-60);
  end;

  // пункт 5 раздела <Справочно>
  macro Print_Ref5()
    AddStr();
    AddEmptyStr();
    PrintCellSize("5. Требования по процентным доходам, учтенные на внебалансовых счетах,", 75);
    PrintCellSize(string(_round(A8)) + "  тыс. руб.", strsize-180);
  end;
end;

private class TRef4Table()
   class TRef4Str( _DepID, _A6_2, _A6_3, _A6_4, _A6_5, _A6_6, _A6_7, _A6_8, _A6_9, _A6_10 )
      var DepID = _DepID;
      var A6_2  = _A6_2; //уникальное имя строки
      var A6_3  = _A6_3;
      var A6_4  = _A6_4;
      var A6_5  = _A6_5; // Количество ц/б
      var A6_6  = _A6_6;
      var A6_7  = _A6_7;
      var A6_8  = _A6_8;
      var A6_9  = _A6_9;
      var A6_10 = _A6_10;
   end;

   var ReportArr = TArray();
   ReportArr.size = 0;

   macro FindStrByDepID(id)
      var i = 0;
      while(i < ReportArr.size)
         if(ReportArr[i].DepID == id)
            return i;
         end;
         i = i + 1;
      end;

      return -1;
   end;

   macro Add( DepID, _A6_2, _A6_3, _A6_4, _A6_5, _A6_6, _A6_7, _A6_8, _A6_9, _A6_10 )
      var i = FindStrByDepID(DepID);
      if( i < 0 )
         ReportArr[ReportArr.size] = TRef4Str( DepID, _A6_2, _A6_3, _A6_4, _A6_5, _A6_6, _A6_7, _A6_8, _A6_9, _A6_10 );
      else
         ReportArr[i].A6_5  = ReportArr[i].A6_5 + _A6_5; // Количество ц/б
         ReportArr[i].A6_6  = ReportArr[i].A6_6 + _A6_6;
         ReportArr[i].A6_7  = ReportArr[i].A6_7 + _A6_7;
         ReportArr[i].A6_8  = ReportArr[i].A6_8 + _A6_8;
         ReportArr[i].A6_9  = ReportArr[i].A6_9 + _A6_9;
         ReportArr[i].A6_10 = ReportArr[i].A6_10 + _A6_10;
      end;

      ExistsDataRef4 = true;
   end;

   macro Print()
      AddStr();
      AddEmptyStr();
      PrintCell( "4. Информация о ценных бумагах, учтенных на балансовых счетах, права на которые удостоверяются депозитариями" );
      rep.AutoScan("[\n"+header_4+"]" );
      var Format = a_str+"ex_B(rlb)"+FontStyleTitel;

      var i = 0;
      while( i < ReportArr.Size() )
         rep.AddPrintCell( ( i ),                      8, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( ReportArr[i].A6_2,         31, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( ReportArr[i].A6_3,         22, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( ReportArr[i].A6_4,         21, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( ReportArr[i].A6_5,         17, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( (ReportArr[i].A6_6/1000),  16, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( "",                        17, 0, "c:" + Format, REP_ELEM_STR );

         rep.AddPrintCell( (ReportArr[i].A6_8/1000),  21, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( (ReportArr[i].A6_9/1000),  21, 0, "c:" + Format, REP_ELEM_STR );
         rep.AddPrintCell( (ReportArr[i].A6_10/1000), 21, 0, "c:" + Format, REP_ELEM_STR );

         AddStr();

         i = i + 1;
      end;
      rep.AddPrintCell("└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘", 196, 0, "l:", REP_ELEM_STR);
   end;
end;

/*************************************************************/
/*    Сбор информации о негодных векселях                    */
/*************************************************************/
PRIVATE MACRO AddMas(mas:@variant, prm)
    mas[mas.Size] = prm;
END;
/*************************************************************/
/*    Печать негодных сделок                                 */
/*************************************************************/
PRIVATE MACRO PrintErrDealsMas(mas:@variant, str)
    var i = 0;
    while(i < mas.Size)

        rep.AddString(str + mas[i]);

        i = i + 1;
    end;
END;

/*************************************************************/
/*    Печать негодных векселей                               */
/*************************************************************/
PRIVATE MACRO VA_PrintErrMas(mas:@variant, str)
    var bnr, i = 0;

    bnr = Tbfile("vsbanner", "R", 0);

    while(i < mas.Size)
        bnr.Clear();
        bnr.rec.BCID = mas[i];
        bnr.GetEQ();

        rep.AddString(str + " номер " + trim(bnr.rec.bcnumber) + " серия " + bnr.rec.bcseries);

        i = i + 1;
    end;
END;

/*************************************************************/
/*    Печать негодных ц/б модуля "БОЦБ"                      */
/*************************************************************/
PRIVATE MACRO Secur_PrintErrMas(mas:@variant, str)
   VAR i = 0;
    while(i < mas.Size)
        rep.AddString(str + " код " + mas[i]);
        i = i + 1;
    end;
END;

/*************************************************************/
/*    Вычисление плановой даты до погашения                  */
/*************************************************************/
PRIVATE MACRO ПлановаяДатаПогашения(BCID, ID, dateB, dateP:@variant, AvoirKind)
/* Смотрим на формулировку срока */
    var leg = Tbfile("dl_leg.dbt", "R", 1);
    var bnr = TBfile("vsbanner.dbt");
    bnr.rec.BCID = BCID;
    bnr.GetEQ();
    leg.rec.ID = ID;
    leg.GetEQ();

    if((bnr.rec.BCTermFormula == VS_TERMF_FIXEDDAY) OR (bnr.rec.BCTermFormula == VS_TERMF_INATIME))
    /* На опред. день или во столько-то времени от составления */
        dateP = leg.rec.Maturity;//(leg.rec.Start + int(leg.rec.Duration) - 1);
    elif(bnr.rec.BCTermFormula == VS_TERMF_DURING)/* Во столько-то времени от предъявления */
        if(bnr.rec.BCPresentationDate < dateB)
            if(bnr.rec.BCPresentationDate != ZeroDate)
                dateP = bnr.rec.BCPresentationDate + leg.rec.Diff;
            else
                dateP = leg.rec.Start + DaysInYearByBasis(leg.rec.Basis, leg.rec.Start, true);
            end;
        else
            dateP = leg.rec.Start + DaysInYearByBasis(leg.rec.Basis, leg.rec.Start, true);
        end;
    elif(bnr.rec.BCTermFormula == VS_TERMF_ATSIGHT)/* По предъявлении */
        dateP = leg.rec.Start + DaysInYearByBasis(leg.rec.Basis, leg.rec.Start, true);
        if(FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BILL, AvoirKind ))
          if((leg.rec.Maturity != ZeroDate) and (leg.rec.Maturity < dateP))
             dateP = leg.rec.Maturity;
          elif((leg.rec.Expiry != ZeroDate) and (leg.rec.Expiry < dateP))
             dateP = leg.rec.Expiry;
          end;
        end;
    else
        return FALSE;
    end;

    return TRUE;
END;

/*************************************************************/
/*    Печать заголовка                                       */
/*************************************************************/
PRIVATE MACRO PrintHeader(CDate)
VAR OurBank = TRecHandler("party.dbt");

    ПолучитьСубъекта({OurBank}, OurBank);

    rep.Autoscan("[" +
        " \n" +
        "                                                                           Банковская отчетность\n" +
        "                                      ┌────────────────┬───────────────────────────────────────┐\n" +
        "                                      │ Код территории │  Код кредитной организации (филиала)  │\n" +
        "                                      │    по ОКАТО    ├───────────────┬───────────────────────┤\n" +
        "                                      │                │    по ОКПО    │ регистрационный номер │\n" +
        "                                      │                │               │  (/порядковый номер)  │\n" +
        "                                      │                │               │                       │\n" +
        "                                      │                │               │                       │\n" +
        "                                      ├────────────────┼───────────────┼───────────────────────┤\n" +
        "                                      │################│###############│#######################│\n" +
        "                                      └────────────────┴───────────────┴───────────────────────┘\n" +
        " \n" +
        "                ИНФОРМАЦИЯ О КАЧЕСТВЕ АКТИВОВ КРЕДИТНОЙ ОРГАНИЗАЦИИ (БАНКОВСКОЙ ГРУППЫ)\n" +
        " \n" +
        "################################################################################################\n" +
        "Полное или сокращенное фирменное наименование кредитной организации\n" +
        "(головной кредитной организации банковской группы): #\n" +
        "Адрес (место нахождения) кредитной организации\n" +
        "(головной кредитной организации банковской группы) #\n" +
        "                                                                       Код формы по ОКУД 0409115\n" +
        "                                                            Месячная (Квартальная) (Полугодовая)\n" +
        "                                                                                       тыс. руб.\n" +
    "]()",
    DL_GetOkatoCode(OurBank, CDate), "c",
    OurBank.rec.OKPO, "c",
    ПолучитьКодСубъекта({OurBank}, PTCK_BANKREGNUM), "c",
    "по состоянию на " + DL_DateToStr(CDate, true), "c",
    OurBank.rec.ShortName, "l",
    DL_GetRealAddress({OurBank}), "l");
END;

/*************************************************************/
/*    Печать окончания                                       */
/*************************************************************/
PRIVATE MACRO PrintEnd(mas)
    AddStr();
    AddEmptyStr();
    AddEmptyStr();
    after_44_footer(rep);
END;

// true, если платеж не исполнен
PRIVATE MACRO IsReadyedPaym(PaymStatus)
    return (PaymStatus < PM_READY_TO_SEND) AND (PaymStatus != PM_CLOSED_W_M_MOVEMENT);
END;

// true, если платеж исполнен или просрочен
PRIVATE MACRO IsExecutedPaym(PaymStatus)
    return (PaymStatus >= PM_READY_TO_SEND) OR (PaymStatus == PM_CLOSED_W_M_MOVEMENT) OR (PaymStatus == PM_OVERDUE);
END;

PRIVATE MACRO GetDealSum(tick, LinkKind, Дата)
  var vsordlnk = null;
  var err = 0;
  var Sum = 0.0;
  var Select = RsdCommand(  " select t_BCCFI, t_BCCost "
                          + "   from dvsordlnk_dbt "
                          + "  where t_DocKind = ? "
                          + "    and t_ContractID = ? "
                          + "    and t_LinkKind = ?" );

  Select.addParam("", RSDBP_IN, tick.rec.BofficeKind);
  Select.addParam("", RSDBP_IN, tick.rec.DealID);
  Select.addParam("", RSDBP_IN, LinkKind);
  Select.execute();
  vsordlnk = TRsbDataSet(Select);
  while(vsordlnk.movenext())
    if(vsordlnk.BCCFI != NATCUR)
      Sum = Sum + VA_Convert(vsordlnk.BCCost, Дата, vsordlnk.BCCFI, NATCUR, err);
    else
      Sum = Sum + vsordlnk.BCCost;
    end;
  end;

  return Sum;
END;

PRIVATE MACRO GetBuyBCCost(BCID, Дата)
  var vsordlnk = null;
  var err = 0;
  var Sum = 0.0;

  var Select = RsdCommand(   " select t_BCCFI, t_BCCost "
                           + "   from dvsordlnk_dbt "
                           + "  where t_BCID = ? "
                           + "    and t_DocKind = " + DL_VEKSELACCOUNTED
                           + "    and t_LinkKind = " + VSORDLNK_K_BUY
                           + " order by t_InterestChargeDate desc");

  Select.addParam("", RSDBP_IN, BCID);
  Select.execute();
  vsordlnk = TRsbDataSet(Select);
  if(vsordlnk.moveNext())
    if(vsordlnk.rec.BCCFI != NATCUR)
      Sum = VA_Convert(vsordlnk.rec.BCCost, Дата, vsordlnk.rec.BCCFI, NATCUR, err);
    else
      Sum = vsordlnk.rec.BCCost;
    end;
  end;

  return Sum;
END;

private macro VA_CollectData_Ref4(Dотч, Ref4Table)
    var query, DataSet;
    var i = 0;
    var reslnk = TBfile("dlreslnk.dbt");
    var party = TRecHandler("party.dbt");
    var Format = "";
    var stat = 0;
    var num = 0, CustodyName = "", CustodyINN = "", CustodyKPP = "", CustodyLic = "", CntBnr = 0, BalCost = $0, CurrCost = $0, Res283 = $0, Res2732 = $0, ResTotal = $0;
    var prevReceiverBankID = -1;
    var Сумма = $0;

    query =   " select bnr.t_BCID, pm.t_ReceiverBankID, leg.t_PFI, pt.t_PartyID t_DepID, "
            + "        (case when pt.t_NotResident = 'X' and pt.t_LatName <> CHR(1) then pt.t_LatName "
            + "              when pt.t_Name <> CHR(1) then pt.t_Name "
            + "              else pt.t_ShortName end) as CustodyName "
            + "   from dvsbanner_dbt bnr, ddl_tick_dbt tk, dpmpaym_dbt pm, dparty_dbt pt, ddl_leg_dbt leg "
            + "  where bnr.t_BCFormKind = " + VSBANNER_FORMKIND_CERT
            + "    and rsb_bill.GetVABnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(Dотч)+") = " + VABANNER_STATUS_ACCOUNT
            + "    and bnr.t_InUnsafeCustody = 'X' "
            + "    and leg.t_DealID = bnr.t_BCID "
            + "    and leg.t_LegKind = " + LEG_KIND_VSBANNER
            + "    and leg.t_LegID = 0"
            + "    and tk.t_DealID = rsb_bill.GetVABnrBalanceDealID(bnr.t_BCID, "+GetSQLDate(Dотч)+") "
            + "    and pm.t_DocumentID = tk.t_DealID "
            + "    and pm.t_DocKind = tk.t_BOfficeKind "
            + "    and pm.t_Purpose = " + BAi
            + "    and pt.t_PartyID = pm.t_ReceiverBankID "
            + "  order by pm.t_ReceiverBankID ";

    InitProgress( SQL_GetNRecs( query ), "Идет формирование отчета...", "Идет формирование отчета..." );

    DataSet = TRsbDataSet(query);
    stat = DataSet.moveNext();
    while(stat)
      if((GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_CRTUNSAFE, Dотч, true)) and (reslnk.rec.ReserveAmount != $0))
        prevReceiverBankID = DataSet.ReceiverBankID;

        CntBnr = CntBnr + 1;
        CustodyName = DataSet.CustodyName;

        Сумма = ПолучитьОстаточнуюПокупнуюСтоимостьВН(DataSet.BCID, Dотч) + ПолучитьСуммуПДДНаДату(DataSet.BCID, Dотч, FIROLE_DISCOUNT) + ПолучитьСуммуПДДНаДату(DataSet.BCID, Dотч, FIROLE_PERCENT);
        if(DataSet.PFI != NATCUR)
          Сумма = VA_Convert(Сумма, Dотч, DataSet.PFI, NATCUR);
        end;
        BalCost = BalCost + Сумма;

        Res2732 = Res2732 + reslnk.rec.ReserveAmount;

        if((GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_AVR, Dотч, true)) and (reslnk.rec.ReserveAmount != $0))
          Res283 = Res283 + reslnk.rec.ReserveAmount;
        end;

        if((GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_PRC, Dотч, true)) and (reslnk.rec.ReserveAmount != $0))
          Res283 = Res283 + reslnk.rec.ReserveAmount;
        end;

      end;

      stat = DataSet.moveNext();

      if((not stat) or ((stat) and (prevReceiverBankID != DataSet.ReceiverBankID)))
        if(CntBnr > 0)
          SplitFullINN(ПолучитьКодСубъекта(prevReceiverBankID, PTCK_INN), CustodyINN, CustodyKPP);

          party.Clear();
          party.rec.PartyID = prevReceiverBankID;
          CustodyLic = string(readNoteForObject(OBJTYPE_PARTY, UniID(party, OBJTYPE_PARTY), 9));

          ResTotal = Res283 + Res2732;

          Ref4Table.Add( DataSet.DepID, CustodyName, CustodyINN, CustodyLic, CntBnr, BalCost, "", Res283, Res2732, ResTotal );

          CntBnr = 0;
          BalCost = Res2732 = Res283 = ResTotal = $0;
        end;
      end;

      UseProgress(i = i + 1);
    end;

    RemProgress();
end;

private class TPart5Data(flagPart5_:bool, Dотч_:date)
  class TData
    var sum:numeric        = $0.0, // сумма требования
        reserv:numeric     = $0.0, // резерв на потери
        reservCorr:numeric = $0.0, // корректировка резерва на потери
        fairValue:numeric  = $0.0; // справедливая стоимость

    macro Add(sum_:numeric, reserv_:numeric, reservCorr_:numeric, fairValue_:numeric)
      sum        = sum        + sum_;
      reserv     = reserv     + reserv_;
      reservCorr = reservCorr + reservCorr_;
      fairValue  = fairValue  + fairValue_;
    end;
  end;

  var dataPart5   = TData(), // строка 1
      dataPart5_1 = TData(), // строка 1.1
      dataPart5_2 = TData(); // строка 1.2

  var flagPart5:bool = flagPart5_;
  var Dотч:date = Dотч_;

  macro VA_AddDataDC( BCID:integer, sum:numeric, reserv:numeric, reservCorr:numeric )
    var ObjectID = 0;
    var level = 3; // Уровень исходных данных иерархии СС МСФО 13, по умолчанию = 3
    var fairValue:numeric = 0.0;

    var r_ficert = TRecHandler("ficert.dbt");

    var DataSet = TRsbDataSet(" SELECT ficert.* " +
                              "   FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin " +
                              "  WHERE bnr.t_BCID = " + String(BCID) +
                              "    and fin.t_FIID = bnr.t_FIID" +
                              "    and ficert.t_CertID = bnr.t_BCID" +
                              "    and ficert.t_AvoirKind = fin.t_AvoirKind");

    if( DataSet.moveNext() )
      DataSet.GetRecord().CopyTO(r_ficert.rec);
      ObjectID = UniID(r_ficert, OBJTYPE_FICERT);

      GetMainObjAttr(null, OBJTYPE_FICERT, ObjectID, 4, null, null, level); // "Уровень исходных данных иерархии СС МСФО 13"
      // хитрая бага. Если не задано примечание, то readNote возвращает как бы $0.0, но точно не $0.0 (к Double не приведешь, арифметическое дейсвтие не выполнишь)
      fairValue = Numeric(String(readNoteForObject(OBJTYPE_FICERT, ObjectID, 10))); // Сумма справедливой стоимости для формы 115
    end;

    dataPart5.Add(sum, reserv, reservCorr, fairValue);
    if (level == "1")
      dataPart5_1.Add(sum, reserv, reservCorr, fairValue);
    elif (level == "2")
      dataPart5_2.Add(sum, reserv, reservCorr, fairValue);
    end;
  end;
  
  macro GetLastFrVal(BCID)
    var fairValue = 0;
    var query = " (SELECT t_FairValue as FrVal " +
                "    FROM dbnrfrval_dbt bnrfrval" +
                "   WHERE bnrfrval.t_BCID = " + String(BCID) +
                "   ORDER by bnrfrval.t_BegDate DESC)";
    
    query = "SELECT * from " + query + " WHERE ROWNUM = 1";
    var DataSet = TRsbDataSet(query);

    if( DataSet.moveNext() )
      fairValue = DataSet.FrVal;
    end;

    return fairValue;
  end;

  macro VA_AddDataBill( BCID:integer, sum:numeric, reserv:numeric, reservCorr:numeric )
    var ObjectID = 0;
    var level = 3; // Уровень исходных данных иерархии СС МСФО 13, по умолчанию = 3
    var fairValue:numeric = 0.0;

    var r_ficert = TRecHandler("ficert.dbt");

    var DataSet = TRsbDataSet(" SELECT ficert.* " +
                              "   FROM dficert_dbt ficert, dvsbanner_dbt bnr, dfininstr_dbt fin " +
                              "  WHERE bnr.t_BCID = " + String(BCID) +
                              "    and fin.t_FIID = bnr.t_FIID" +
                              "    and ficert.t_CertID = bnr.t_BCID" +
                              "    and ficert.t_AvoirKind = fin.t_AvoirKind");

    if( DataSet.moveNext() )
      DataSet.GetRecord().CopyTO(r_ficert.rec);
      ObjectID = UniID(r_ficert, OBJTYPE_FICERT);

      GetMainObjAttr(null, OBJTYPE_FICERT, ObjectID, 4, null, null, level); // "Уровень исходных данных иерархии СС МСФО 13"
      fairValue = Numeric(GetLastFrVal(BCID)); // Последняя Сумма справедливой из истории изменения СС

    end;

    dataPart5.Add(sum, reserv, reservCorr, fairValue);
    if (level == "1")
      dataPart5_1.Add(sum, reserv, reservCorr, fairValue);
    elif (level == "2")
      dataPart5_2.Add(sum, reserv, reservCorr, fairValue);
    end;
  end;

  macro Secur_AddData(FIID:integer, sum:numeric, reserv:numeric, reservCorr:numeric)
    var level = 3; // Уровень исходных данных иерархии СС МСФО 13, по умолчанию = 3
    var avoiriss = Trechandler( "avoiriss.dbt" );
    avoiriss.rec.FIID = FIID;
    var ObjectID = UniID( avoiriss, OBJTYPE_AVOIRISS);
    GetMainObjAttr(null, OBJTYPE_AVOIRISS, ObjectID, 55, null, null, level); // "Уровень исходных данных иерархии СС МСФО 13"
    // хитрая бага. Если не задано примечание, то readNote возвращает как бы $0.0, но точно не $0.0 (к Double не приведешь, арифметическое дейсвтие не выполнишь)

    var fairValue:numeric = Numeric(String(readNoteForObject(OBJTYPE_AVOIRISS, ObjectID, 19))); // Сумма справедливой стоимости для формы 115

    dataPart5.Add(sum, reserv, reservCorr, fairValue);
    if (level == "1")
      dataPart5_1.Add(sum, reserv, reservCorr, fairValue);
    elif (level == "2")
      dataPart5_2.Add(sum, reserv, reservCorr, fairValue);
    end;
  end;

  macro FilterPart5()
    return (flagPart5) and
           Need3129(Dотч);
  end;
end;

private macro PrintPart5(dataPart5:TPart5Data)
  var name1   = "Вложения в ценные бумаги, изменение первоначальной стоимости которых отражается в учете путем создания резервов на возможные потери, всего, из них:",
      name1_1 = "для определения справедливой стоимости которых используются исходные данные первого уровня в соответствии с МСФО (IFRS) 13",
      name1_2 = "для определения справедливой стоимости которых используются исходные данные второго уровня в соответствии с МСФО (IFRS) 13";
  var lengthCol1 = 8,
      lengthCol2 = 53,
      lengthCol3 = 25,
      lengthCol4 = 24,
      lengthCol5 = 35,
      lengthCol6 = 25;
  var Format = a_str+"ex_B(rlb)"+FontStyleTitel;

  AddStr();
  AddEmptyStr();
  PrintCell( "5. Информация о справедливой стоимости ценных бумаг, изменение первоначальной стоимости которых отражается в бухгалтерском учете путем создания резервов на возможные потери" );
  rep.AutoScan("[\n"+header_5+"]" );

  AddStr();
  rep.AddPrintCell( " 1",                                   lengthCol1, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( name1,                                  lengthCol2, 0, "l:w"+ Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5.sum),        lengthCol3, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5.reserv),     lengthCol4, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5.reservCorr), lengthCol5, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5.fairValue),  lengthCol6, 0, "c:" + Format, REP_ELEM_STR );

  AddStr();
  rep.AddPrintCell( " 1.1",                                   lengthCol1, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( name1_1,                                  lengthCol2, 0, "l:w"+ Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_1.sum),        lengthCol3, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_1.reserv),     lengthCol4, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_1.reservCorr), lengthCol5, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_1.fairValue),  lengthCol6, 0, "c:" + Format, REP_ELEM_STR );

  AddStr();
  rep.AddPrintCell( " 1.2",                                   lengthCol1, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( name1_2,                                  lengthCol2, 0, "l:w"+ Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_2.sum),        lengthCol3, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_2.reserv),     lengthCol4, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_2.reservCorr), lengthCol5, 0, "c:" + Format, REP_ELEM_STR );
  rep.AddPrintCell( _round(dataPart5.dataPart5_2.fairValue),  lengthCol6, 0, "c:" + Format, REP_ELEM_STR );

  AddStr();
  
  rep.AddPrintCell("└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘", 171, 0, "l:", REP_ELEM_STR);
end;

private class TPart6Data(flagPart6_:bool, Dотч_:date)  
  class TData(name, num, title)
    var strName = name; //уникальное имя строки
    var strNum = num;
    var strTitle = title;
    var C3:numeric  = $0.0,                                                            
        C4:numeric  = $0.0,
        C5:numeric  = $0.0,
        C6:numeric  = $0.0,
        C7:numeric  = $0.0,
        C8:numeric  = $0.0,
        C9:numeric  = $0.0,
        C10:numeric = $0.0,
        C11:numeric = $0.0,
        C12:numeric = $0.0,
        C13:numeric = $0.0,
        C14:numeric = $0.0,
        C15:numeric = $0.0;
  end;
  
  var flagPart6 = flagPart6_;
  var Dотч = Dотч_;  
  var ReportArr = TArray();
  ReportArr.size = 0;
  
  ReportArr[ReportArr.size] = TData(Str6_1,     "1",       "Финансовые активы, оцениваемые по справедливой стоимости через прибыль или убыток, всего, в том числе:");
  ReportArr[ReportArr.size] = TData(Str6_1_2,   "1.2",     "учтенные векселя");
  ReportArr[ReportArr.size] = TData(Str6_1_3,   "1.3",     "прочие финансовые активы");
  ReportArr[ReportArr.size] = TData(Str6_2,     "2",       "Финансовые активы, оцениваемые по справедливой стоимости через прочий совокупный доход, всего, в том числе:");
  ReportArr[ReportArr.size] = TData(Str6_2_2,   "2.2",     "долевые ценные бумаги, ИЗ НИХ:");
  ReportArr[ReportArr.size] = TData(Str6_2_3,   "2.3",     "учтенные векселя");
  ReportArr[ReportArr.size] = TData(Str6_2_4,   "2.4",     "прочие финансовые активы");

  macro FindStrByName(name)
    var i = 0;
    while(i < ReportArr.size)
      if(ReportArr[i].strName == name)
        return i;
      end;
      i = i+1;
    end;

    return -1;
  end;
  
  macro add(name, K, W1, W2)
    var i = FindStrByName(name);

    if(i < 0 )  return; end;

    ReportArr[i].C3 = ReportArr[i].C3 + W1;
    ReportArr[i].C4 = ReportArr[i].C4 + W1;
    if(K == 1)
      ReportArr[i].C5 = ReportArr[i].C5 + W1;
    elif(K == 2)
      ReportArr[i].C6 = ReportArr[i].C6 + W1;
    elif(K == 3)
      ReportArr[i].C7 = ReportArr[i].C7 + W1;
    elif(K == 4)
      ReportArr[i].C8 = ReportArr[i].C8 + W1;
    elif(K == 5)
      ReportArr[i].C9 = ReportArr[i].C9 + W1;
    end;

    if((ValType(W2) != V_UNDEF) AND (W2!= $0))
      ReportArr[i].C10 = ReportArr[i].C10 + W2;
      if(K == 1)
        ReportArr[i].C11 = ReportArr[i].C11 + W2;
      elif(K == 2)
        ReportArr[i].C12 = ReportArr[i].C12 + W2;
      elif(K == 3)
        ReportArr[i].C13 = ReportArr[i].C13 + W2;
      elif(K == 4)
        ReportArr[i].C14 = ReportArr[i].C14 + W2;
      elif(K == 5)
        ReportArr[i].C15 = ReportArr[i].C15 + W2;
      end;
    end;

    ExistsDataRef6 = true;
  end;

  macro add_c(name, name_c)
    var i = FindStrByName(name);
    var j = FindStrByName(name_c);

    ReportArr[i].C3  = ReportArr[i].C3  + ReportArr[j].C3 ;
    ReportArr[i].C4  = ReportArr[i].C4  + ReportArr[j].C4 ;
    ReportArr[i].C5  = ReportArr[i].C5  + ReportArr[j].C5 ;
    ReportArr[i].C6  = ReportArr[i].C6  + ReportArr[j].C6 ;
    ReportArr[i].C7  = ReportArr[i].C7  + ReportArr[j].C7 ;
    ReportArr[i].C8  = ReportArr[i].C8  + ReportArr[j].C8 ;
    ReportArr[i].C9  = ReportArr[i].C9  + ReportArr[j].C9 ;
    ReportArr[i].C10 = ReportArr[i].C10 + ReportArr[j].C10;
    ReportArr[i].C11 = ReportArr[i].C11 + ReportArr[j].C11;
    ReportArr[i].C12 = ReportArr[i].C12 + ReportArr[j].C12;
    ReportArr[i].C13 = ReportArr[i].C13 + ReportArr[j].C13;
    ReportArr[i].C14 = ReportArr[i].C14 + ReportArr[j].C14;
    ReportArr[i].C15 = ReportArr[i].C15 + ReportArr[j].C15;

  end;

  macro FilterPart6()
    return flagPart6;
  end;

  macro VA_AddDataBill(PortfolioId, K, V1, V2, V3, V4, V5)
    if(PortfolioId == KINDPORT_DB_PROFIT_LOSS)
      add(str6_1_2, K, V1, V2);
      add(str6_1_2, K, V2, V5);
      add(str6_1_2, K, V3);
    elif(PortfolioId == KINDPORT_DB_OTHER_CMPR_INCOME)
      add(str6_2_3, K, V1, V2);
      add(str6_2_3, K, V2, V5);
      add(str6_2_3, K, V3);
    end;
  end;

  macro print()
    var lengthCol1 = 11, 
      lengthCol2 = 31, 
      lengthCol3 = 13, 
      lengthCol4 = 11, 
      lengthCol5 = 11, 
      lengthCol6 = 11, 
      lengthCol7 = 11, 
      lengthCol8 = 11, 
      lengthCol9 = 11, 
      lengthCol10 = 11,
      lengthCol11 = 11,
      lengthCol12 = 11,
      lengthCol13 = 11,
      lengthCol14 = 11,
      lengthCol15 = 11;

    AddStr();
    AddEmptyStr();
    PrintCell( "6. Информация о финансовых активах, оцениваемых по справедливой стоимости" );
    rep.AutoScan("[\n"+header_6_4927+"]" );
    var Format = a_str+"ex_B(rlb)"+FontStyleTitel;

    var i = 0;
    while( i < ReportArr.Size() )
      AddStr();
      rep.AddPrintCell( ReportArr[i].strNum,      lengthCol1,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( ReportArr[i].strTitle,    lengthCol2,  0, "l:w"+ Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C3),  lengthCol3,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C4),  lengthCol4,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C5),  lengthCol5,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C6),  lengthCol6,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C7),  lengthCol7,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C8),  lengthCol8,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C9),  lengthCol9,  0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C10),  lengthCol10, 0, "c:" + Format, REP_ELEM_STR);
      // rep.AddPrintCell( _round(ReportArr[i].C11),  lengthCol11, 0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C12),  lengthCol12, 0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C13),  lengthCol13, 0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C14),  lengthCol14, 0, "c:" + Format, REP_ELEM_STR);
      rep.AddPrintCell( _round(ReportArr[i].C15),  lengthCol15, 0, "c:" + Format, REP_ELEM_STR);

      i = i + 1;
    end;

    AddStr();
    // rep.AddPrintCell("└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘", 188, 0, "l:", REP_ELEM_STR);
    rep.AddPrintCell("└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘", 177, 0, "l:", REP_ELEM_STR);
  end;

end;

private macro PrintPart6(dataPart6:TPart6Data)
end;

private macro GetReservPairAcc(BCID, FiRole, rDate, Cat_1, Cat_2)
  var AccPlus = TRecHandler("account.dbt");
  var AccMinus = TRecHandler("account.dbt");
  var fd = VSBannerFD (DL_VSBANNER, BCID, DL_VARESERVE, VARES_SUBKIND_OR);
  var ResSum = 0;
  if (VA_GetAccountManual(Cat_1, fd, null, MC_OPENACC_CHECKEXIST, NATCUR, FiRole, AccPlus, rDate) 
      AND VA_GetAccountManual(Cat_2, fd, null, MC_OPENACC_CHECKEXIST, NATCUR, FiRole, AccMinus, rDate))

    if(AccMinus.rec.account != AccPlus.rec.account)
      ResSum = ResSum + GetRestAccount( AccMinus.rec, rDate );
      ResSum = ResSum + GetRestAccount( AccPlus.rec, rDate );
    else
      ResSum = ResSum + GetRestAccount( AccMinus.rec, rDate );
    end;

  end;

  return ResSum;
end;

PRIVATE MACRO VA_CollectData(Dотч, avoirkind, p1, p2, p3, ArrRepTbl, dataPart5, dataPart6)
  var Dпог_пл, Dпл;
  var DataSet;
  var query;
  var currpart = 0, K = 0, err = 0;
  var C, R = 0, ДНН, Pвн, Pr, B, N;
  var leg = TBFile("dl_leg.dbt", "R", 1);
  var reslnk = TBFile("dlreslnk.dbt");
  var tick = TBFile("dl_tick.dbt");
  var pt = TBFile("party.dbt");
  var bnr = Tbfile("vsbanner", "R", 0);
  var V, V0, V1, V2, V3, V4, V5, V6, V7, V8, V9, V10, V11, V6_3;
  var W1, W2, W3, W4, W5;
  var BalanceCost, SumResOr, Rop, reslnkid, errMsg;
  var ResType = "", stBAi, stCAi;
  var ok = false;
  var Link = VSORDLNK_K_ALL, Purp;
  var counter = 0;
  var NumInList = "", PartyIsIndividual = False;

  //1. По бумагам
  query =   " select bnr.t_Issuer, bnr.t_BCID, "
          + "        leg.t_ID as LID, "
          + "        lnk.t_QualityCategory, lnk.t_ReservePercent, "
          + "        fin.t_AvoirKind, "
          + "        (select ps.t_IsEmployer from dpersn_dbt ps where ps.t_PersonID = bnr.t_Issuer) as IsEmployer"
          + "   from dvsbanner_dbt bnr, ddl_leg_dbt leg, dfininstr_dbt fin, "
          + "        (select t_parentid, t_QualityCategory, t_ReservePercent, rank() over (partition by t_parentid ORDER BY  t_lnkdate desc, t_id desc) rnk "
          + "           from ddlreslnk_dbt "
          + "          where t_Type = " + RSRV_TYPE_VABANNER
          + "            and t_LnkDate <= " + GetSQLDate(Dотч)
          + "            and t_QualityCategory > 0 "
          + "          order by t_parentid ) lnk"
          + "  where leg.t_DealID = bnr.t_BCID "
          + "    and leg.t_LegKind = " + LEG_KIND_VSBANNER
          + "    and leg.t_LegID = 0 "
          + "    and exists ( select 1 "
          + "                   from dvsbnrbck_dbt bck2 "
          + "                  where bck2.t_ID = ( select max(bck.t_id) "
          + "                                        from DVSBNRBCK_DBT bck "
          + "                                       where bck.t_BCID = bnr.t_BCID "
          + "                                         and (bck.t_ABCStatus = 'X' or bck.t_BCStatus = 'X') "
          + "                                         and bck.t_ChangeDate <= " + GetSQLDate(Dотч) + " ) "
          + "                    and bck2.t_NewABCStatus = " + VABANNER_STATUS_ACCOUNT + " ) "
          + "    and lnk.t_ParentID = bnr.t_BCID "
          + "    and lnk.rnk = 1 "
          + "    and fin.t_FIID = bnr.t_FIID ";

  if( avoirkind )
    query = query
          + "    and fin.t_AvoirKind in ( select avr.t_AvoirKind from davrkinds_dbt avr "
          + "                              where avr.t_FI_Kind = 2 "
          + "                              start with avr.t_AvoirKind = " + avoirkind
          + "                              connect by prior avr.t_avoirkind = avr.t_parent ) ";
  end;

  VA_Rep_InitProgress(SQL_GetNRecs(query), "Обработка данных модуля \"Учтенные векселя\". Просмотр бумаг...");

  DataSet = TRsbDataSet(query);
  while(DataSet.moveNext())
     C = 0;
     V1 = 0.0; V2 = 0.0; V3 = 0.0; V4 = 0.0; V5 = 0.0; V6 = 0.0; V7 = 0.0; V8 = 0.0; V9 = 0.0; V10 = 0.0;
     W1 = 0.0; W2 = 0.0; W3 = 0.0; W4 = 0.0;
     Dпог_пл = date(0,0,0);
     NumInList = "";
     PartyIsIndividual = false;

     leg.Clear();
     leg.rec.ID = DataSet.LID;
     leg.GetEQ();

     //часть отчета
     if(ВидСубъекта(Int(DataSet.Issuer), PTK_BANK))
        currpart = 1;
     else
        currpart = 2;

        pt.rec.PartyID = DataSet.Issuer;
        if( (DataSet.IsEmployer == SET_CHAR) OR
            ((GetMainObjAttr( null, OBJTYPE_PARTY, UniID( pt, OBJTYPE_PARTY), 39/*Субъект малого и среднего предпринимательства*/, null, null, NumInList)) AND
             (NumInList = "МСП")
            )
          )
          PartyIsIndividual = true;
        end;
     end;

     //категория качества
     K = DataSet.QualityCategory;
     R = DataSet.ReservePercent;
     if((DataSet.QualityCategory == 1) AND (R == 0))
     elif((DataSet.QualityCategory == 2) AND (R >= 1)  AND (R <= 20))
     elif((DataSet.QualityCategory == 3) AND (R >= 21) AND (R <= 50))
     elif((DataSet.QualityCategory == 4) AND (R >= 51) AND (R <= 100))
     elif((DataSet.QualityCategory == 5) AND (R == 100))
     else
         AddMas(@ProcVSCat, DataSet.BCID);
         continue;
     end;

     //V1
     V1 = GetBuyBCCost(DataSet.BCID, Dотч-1);

     //V2
     V2 = ПолучитьСуммуПДДНаДату(DataSet.BCID, Dотч-1);
     if(leg.rec.PFI != NATCUR)
       V2 = VA_Convert(V2, Dотч-1, leg.rec.PFI, NATCUR, err);
     end;

     V4 = 0;
     ПлановаяДатаПогашения(DataSet.BCID, leg.rec.ID, Dотч, @Dпог_пл, DataSet.AvoirKind);
     if(Dпог_пл < Dотч)
       C = Dотч - Dпог_пл;
       V3 = V1;

       V4 = V2;
     end;
      
     //V5
     V5 = V1*R/100;
     //V6
     V6 = V2*R/100;
     //V7
     V7 = 0;
     if (GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_AVR, Dотч-1, true))
       V7 = reslnk.rec.ReserveAmount;
     end;
     //V8
     V8 = 0;
     if (GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_PRC, Dотч-1, true))
       V8 = reslnk.rec.ReserveAmount;
     end;
     
     bnr.Clear();
     bnr.rec.BCID = DataSet.BCID;
     bnr.GetEQ();
     CalcAndCheckOrReserveParams(bnr.rec, Dотч-1, VARES_SUBKIND_OR, @Rop, @reslnkid, @errMsg);

     //V9 
     V9 = V1*Rop/100;
     //V10  
     V10 = V2*Rop/100;
    
     var isBill = false, isDeposit = false;

     W1 = V1;
     W2 = V3;
     W3 = V5;
     W4 = V7;
     W5 = V9;
     if(FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BILL, DataSet.AvoirKind ))
       isBill = true;
       if(currpart == 1)
         ArrRepTbl.add2(Str1_3, W1, W2, W3, W4, W5, K, C);
       elif(currpart == 2)
         if((PartyIsIndividual) and (p1)) //индивидуальный предприниматель
           ArrRepTbl.add2(Str2_8_1, W1, W2, W3, W4, W5, K, C);
         end;
         ArrRepTbl.add2(Str2_2, W1, W2, W3, W4, W5, K, C);
       end;
       if (dataPart5.FilterPart5())
         SumResOr = 0;
         if (GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_OR, Dотч-1, true))
           SumResOr = reslnk.rec.ReserveAmount;
         end;
         BalanceCost = БалансоваяСтоимостьВекселяВН(DataSet.BCID, Dотч-1);
         if(leg.rec.PFI != NATCUR)
           V2 = VA_Convert(V2, Dотч-1, leg.rec.PFI, NATCUR, err);
         end;
         
         dataPart5.VA_AddDataBill(DataSet.BCID, BalanceCost, V7, SumResOr);
       end;
     elif(FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_DEPOSIT_CERTIFICATE, DataSet.AvoirKind ))
       isDeposit = true;
       if(currpart == 1)
         ArrRepTbl.add2(Str1_4, W1, W2, W3, W4, W5, K, C);
       end;
       // Для депозитного сертификата 6 раздел
       if (dataPart5.FilterPart5())
         dataPart5.VA_AddDataDC(DataSet.BCID, V1, V7, V9);
       end;

     end;

     W1 = V2;
     W2 = V4;
     W3 = V6;
     W4 = V8;
     W5 = V10;
     if(isBill)
       if(currpart == 1)
         ArrRepTbl.add2(Str1_8_а, W1, W2, W3, W4, W5, K, C);
       elif(currpart == 2)
         ArrRepTbl.add2(Str2_7_а, W1, W2, W3, W4, W5, K, C);
       end;

       if((dataPart6.FilterPart6()) AND (FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BILL, DataSet.AvoirKind )))
         bnr.Clear();
         bnr.rec.BCID = DataSet.BCID;
         bnr.GetEQ();
         if((bnr.rec.PortfolioId == KINDPORT_DB_PROFIT_LOSS) OR (bnr.rec.PortfolioId == KINDPORT_DB_OTHER_CMPR_INCOME))
           V6_3 = GetReservPairAcc(DataSet.BCID, FIROLE_PERCENT, Dотч-1, "+Переоценка, вексель", "-Переоценка, вексель");
           dataPart6.VA_AddDataBill(bnr.rec.PortfolioId, K, V1, V2, V6_3, V7, V8);
         end;
       end;
     elif(isDeposit)
       if(currpart == 1)
         ArrRepTbl.add2(Str1_8_б, W1, W2, W3, W4, W5, K, C);
       end;
     end;

     UseProgress(counter = counter + 1);
  end;
  RemProgress();

  //2. Теперь по сделкам
  query =   " select tick.t_DealID, pt.t_LegalForm as ContrLegalForm, "
          + "        (select ps.t_IsEmployer from dpersn_dbt ps where ps.t_PersonID = tick.t_PartyID) as IsEmployer"
          + "   from ddl_tick_dbt tick, dparty_dbt pt "
          + "  where tick.t_DealDate <= " + GetSQLDate(Dотч)
          + "    and tick.t_BofficeKind = " + DL_VEKSELACCOUNTED
          + "    and tick.t_DealStatus > 0 "
          + "    and (tick.t_CloseDate = " + GetSQLDate(date(0,0,0)) + " or tick.t_CloseDate > " + GetSQLDate(Dотч) + " ) "
          + "    and pt.t_PartyID = tick.t_PartyID";

  counter = 0;
  VA_Rep_InitProgress(SQL_GetNRecs(query), "Обработка данных модуля \"Учтенные векселя\". Просмотр сделок...");

  DataSet = TRsbDataSet(query);
  while(DataSet.moveNext())
    ResType = "";
    ok = false;
    V = V0 = V10 = V11 = 0;
    NumInList = "";
    PartyIsIndividual = false;

    tick.Clear();
    tick.rec.DealID =  DataSet.DealID;
    tick.getEQ();

    pt.rec.PartyID = tick.rec.PartyID;
    if( (DataSet.IsEmployer == SET_CHAR) OR
        ((GetMainObjAttr( null, OBJTYPE_PARTY, UniID( pt, OBJTYPE_PARTY), 39/*Субъект малого и среднего предпринимательства*/, null, null, NumInList)) AND
         (NumInList = "МСП")
        )
      )
      PartyIsIndividual = true;
    end;

    //часть отчета
    if(ВидСубъекта(Int(tick.rec.PartyID), PTK_BANK))
       currpart = 1;
    elif((DataSet.ContrLegalForm == PTLEGF_INST) OR (PartyIsIndividual)) //юр. лицо
       currpart = 2;
    else
       currpart = 3;
    end;

    ok = VA_GetPmStatus_Direct(tick.rec.BofficeKind, tick.rec.DealID, BAi, @stBAi);
    if(ok)
      ok = VA_GetPmStatus_Direct(tick.rec.BofficeKind, tick.rec.DealID, CAi, @stCAi);
    end;

    if(VA_IsBuy(tick.rec.DealType))
      if((ok) and (IsReadyedPaym(stBAi)) AND (IsExecutedPaym(stCAi)))
         ResType = "РСОП"; Link = VSORDLNK_K_BUY; Purp = BAi;
      end;
    elif(VA_IsSale(tick.rec.DealType))
      if((ok) and (IsReadyedPaym(stCAi)) AND (IsExecutedPaym(stBAi)))
         ResType = "РСОП"; Link = VSORDLNK_K_SALE; Purp = CAi;
       end;
    end;

    if(ResType == "")
      continue;
    end;

    if (GetResLnk(reslnk, tick.rec.DealID, RSRV_TYPE_VADEAL, -1, Dотч))
      K = reslnk.rec.QualityCategory;
      R = reslnk.rec.ReservePercent;

      if((reslnk.rec.QualityCategory == 1) AND (R == 0))
      elif((reslnk.rec.QualityCategory == 2) AND (R >= 1)  AND (R <= 20))
      elif((reslnk.rec.QualityCategory == 3) AND (R >= 21) AND (R <= 50))
      elif((reslnk.rec.QualityCategory == 4) AND (R >= 51) AND (R <= 100))
      elif((reslnk.rec.QualityCategory == 5) AND (R == 100))
      else
        AddMas(@ProcVSCatDeal, DataSet.DealID);
        continue;
      end;
    end;

    V = GetDealSum(tick, Link, Dотч-1);

    if(VA_GetPmValueDate_Direct(tick.rec.BofficeKind, tick.rec.DealID, Purp, @Dпл))
      if(Dпл < Dотч)
        C = Dотч - Dпл;
        V0 = V;
      end;
    end;

    V10 = V*R/100;

    V11 = 0;
    if (GetResLnk(reslnk, tick.rec.DealID, RSRV_TYPE_VADEAL, -1, Dотч-1, true))
       V11 = reslnk.rec.ReserveAmount;
    end;

    if(currpart == 1)
      ArrRepTbl.add(Str1_5, V, V0, V10, V11, K, C);
    elif(currpart == 2)
      if((PartyIsIndividual) and (p2)) //индивидуальный предприниматель
        ArrRepTbl.add(Str2_8, V, V0, V10, V11, K, C);
      end;

      ArrRepTbl.add(Str2_3, V, V0, V10, V11, K, C);
    elif((currpart == 3) and (p2))
      ArrRepTbl.add(Str3_5, V, V0, V10, V11, K, C);
    end;

    UseProgress(counter = counter + 1);
  end;

  RemProgress();
END;

private macro GetRestAccByFiRole(OperationKind, tick, FIID, CatCode, FIRole, rDate)
   var Reserv = $0,
       ReservAcc = TRecHandler( "account" ),
       FD;

   if(OperationKind == KINDRES_RCB/*Резерв по ЦБ*/)
      FD = SPFirstDocFIReserv( FIID, OperationKind );
   else // KINDRES_REQ - Резерв по требованиям сделок
      FD = SPFirstDocDealReserv( tick, OperationKind );
   end;

   if( FD.IsExistAccount( CatCode, null, true, FIRole, ReservAcc, null, rDate ) == true )
      Reserv = ABS(GetRestAccount( ReservAcc.rec, rDate ));
   end;

   return Reserv;
end;

// пункт 4 раздела <Справочно>
private macro Secur_CollectData_Ref4(RepDate, FIID, _A6_8, Ref4Table)
   var R2732 = 0, DepID, _A6_2 = "", _A6_3 = "", _A6_4 = "", _A6_5 = 0, _A6_6 = 0, _A6_9 = $0, _A6_10 = $0;

   R2732 = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( FIID, 10 ), NOTEKIND_AVOIR_RESERV2732/*15 Сумма резерва по 2732-У*/ );
   // для ц/б должен быть указан процент резерва
   if( R2732 <= 0 )
      return;
   end;

   _A6_9 = GetRestAccByFiRole(KINDRES_RCB, null, FIID, "Резерв ц/б", FIROLE_AVOIR_UC, RepDate);
   _A6_10 = _A6_8 + _A6_9;

   var cmd, rs,
       Query =
   "  SELECT  NVL(PT.T_PARTYID, -1) As PARTYID, "+
   "      NVL ( "+
   "            (SELECT objcode.t_Code "+
   "               FROM dobjcode_dbt objcode "+
   "              WHERE objcode.t_ObjectType = " +  string( OBJTYPE_PARTY)  +
   "                AND objcode.t_CodeKind =   " +  string( PTCK_INN) +
   "                AND objcode.t_ObjectID = pt.t_PartyID "+
   "                AND objcode.t_State = 0), "+
   "            CHR (1)) "+
   "            AS INN, "+
   "         case when pt.t_NotResident = 'X' and pt.t_LatName <> CHR(1) then pt.t_LatName " +
   "              when pt.t_Name <> CHR(1) then pt.t_Name " +
   "              else pt.t_ShortName end as CustodyName, " +
   "       wrtsum.t_BalanceCost, " +
   "       wrtsum.t_Amount " +
   " FROM v_scwrthistex wrtsum, ddlrq_dbt rq, dparty_dbt pt, ddlrqacc_dbt rqacc " +
   " WHERE wrtsum.t_FIID = " + FIID +
   "   and wrtsum.t_Date < " + GetSQLDate(RepDate) +
   "   and wrtsum.t_Amount > 0 " +
   "   and wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
   "   and wrtsum.t_state IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+") " +
   "   and wrtsum.t_Department = " + {OperDprt} +
   "   and wrtsum.t_instance = (SELECT MAX (t_instance) " +
   "                            FROM v_scwrthistex " +
   "                            WHERE t_sumid = wrtsum.t_sumid " +
   "                              AND t_changedate < "+GetSQLDate(RepDate)+" ) " +
   "   and wrtsum.t_Portfolio in ("+KINDPORT_TRADE+","+KINDPORT_SALE+","+KINDPORT_RETIRE+","+KINDPORT_PROMISSORY+","+KINDPORT_CONTR+") " +
   "   and rq.t_ID = wrtsum.t_DocID " +
   "   and rq.t_Type = " + DLRQ_TYPE_DELIVERY +
   "   and rq.t_State = " + DLRQ_STATE_EXEC +
   "   AND rqacc.t_ID(+) = rq.t_RqAccId "+
   "   AND PT.T_PARTYID =  "+
   "           CASE "+
   "              WHEN RQACC.T_BANKID > 0 THEN RQACC.T_BANKID "+
   "              WHEN (RQACC.T_BANKID = -1 AND RQACC.T_BANKCORRID > 0) THEN RQACC.T_BANKCORRID "+
   "              ELSE  "+ string({OurBank}) +
   "           END ";

   cmd = RSDCommand( Query );
   cmd.NullConversion = true;
   rs = TRsbDataSet(cmd);

   while( rs.MoveNext() )
      DepId = rs.PARTYID;
      _A6_2 = string(rs.CustodyName);
      _A6_3 = string(rs.INN);
      _A6_4 = string( readNoteForObject( OBJTYPE_PARTY, L_Z( rs.PARTYID, 10 ), 9, RepDate ) );
      _A6_5 = rs.Amount;
      _A6_6 = rs.BalanceCost;
      Ref4Table.Add( DepId, _A6_2, _A6_3, _A6_4, _A6_5, _A6_6, "", _A6_8, _A6_9, _A6_10 );
   end;
end;

private macro GetAvrReservByLot(RepDate, FIID, Rcb:@variant, Rpdd:@variant )
   Rcb = $0;
   Rpdd = $0;

   var cmd, rs,
       Query =
   " SELECT sum(wrtsum.t_ReservAmount) t_Rcb, " +
   "        sum(wrtsum.t_IncomeReserv) t_Rpdd " +
   " FROM v_scwrthistex wrtsum " +
   " WHERE wrtsum.t_FIID = " + FIID +
   "   and wrtsum.t_Date < " + GetSQLDate(RepDate) +
   "   and wrtsum.t_Amount > 0 " +
   "   and wrtsum.t_state IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+") " +
   "   and wrtsum.t_Department = " + {OperDprt} +
   "   and wrtsum.t_instance = (SELECT MAX (t_instance) " +
   "                            FROM v_scwrthistex " +
   "                            WHERE t_sumid = wrtsum.t_sumid " +
   "                              AND t_changedate < "+GetSQLDate(RepDate)+" ) " +
   "   and wrtsum.t_Portfolio in ("+KINDPORT_TRADE+","+KINDPORT_SALE+","+KINDPORT_RETIRE+","+KINDPORT_PROMISSORY+","+KINDPORT_CONTR+") ";

   cmd = RSDCommand( Query );
   cmd.NullConversion = true;
   rs = TRsbDataSet(cmd);

   if( rs.MoveNext() )
      Rcb = SQL_ConvTypeSum(rs.Rcb);
      Rpdd = SQL_ConvTypeSum(rs.Rpdd);
   end;
end;

private macro GetAvrPrmByLot(RepDate, FIID, FaceValueFI, V1:@variant, V2:@variant, V2a:@variant )
   V1 = $0; // стоимость лотов
   V2 = $0; // сумма начисленного процентного и/или дисконтного дохода
   V2a = $0; // сумма начисленного процентного и/или дисконтного дохода - сумма начисленного, но не отнесенного на доход процентного и/или дисконтного дохода

   var cmd, rs,
       Query =
   " SELECT sum(wrtsum.t_BalanceCost) t_SumBalanceCost, " +
   "        sum(wrtsum.t_InterestIncome) t_SumInterestIncome, " +
   "        sum(wrtsum.t_NotCarryInterest) t_SumNotCarryInterest, " +
   "        sum(wrtsum.t_DiscountIncome) t_SumDiscountIncome, " +
   "        sum(wrtsum.t_NotCarryDiscount) t_SumNotCarryDiscount " +
   " FROM v_scwrthistex wrtsum " +
   " WHERE wrtsum.t_FIID = " + FIID +
   "   and wrtsum.t_Date <= " + GetSQLDate(RepDate) +
   "   and wrtsum.t_Amount > 0 " +
   "   and wrtsum.t_state IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+") " +
   "   and wrtsum.t_Department = " + {OperDprt} +
   "   and wrtsum.t_instance = (SELECT MAX (t_instance) " +
   "                            FROM v_scwrthistex " +
   "                            WHERE t_sumid = wrtsum.t_sumid " +
   "                              AND t_changedate <= "+GetSQLDate(RepDate)+" ) " +
   "   and wrtsum.t_Portfolio in ("+KINDPORT_TRADE+","+KINDPORT_SALE+","+KINDPORT_RETIRE+","+KINDPORT_PROMISSORY+","+KINDPORT_CONTR+") ";

   cmd = RSDCommand( Query );
   cmd.NullConversion = true;
   rs = TRsbDataSet(cmd);

   if( rs.MoveNext() )
      V1 = SQL_ConvTypeSum(rs.SumBalanceCost);
      V2 = SQL_ConvTypeSum(rs.SumInterestIncome) + SQL_ConvTypeSum(rs.SumDiscountIncome);
      V2a = V2 - (SQL_ConvTypeSum(rs.SumNotCarryInterest) + SQL_ConvTypeSum(rs.SumNotCarryDiscount));

      if( FaceValueFI != NATCUR )
         V1 = VA_Convert(V1, RepDate-1, FaceValueFI, NATCUR);
         V2 = VA_Convert(V2, RepDate-1, FaceValueFI, NATCUR);
         V2a = VA_Convert(V2a, RepDate-1, FaceValueFI, NATCUR);
      end;
   end;
end;

private macro GetAvrNoteByLotDeal(RepDate, FIID, Rop:@variant)
   var cmd, rs,
       Query =
   " SELECT t_DealID DealID " +
   " FROM v_scwrthistex wrtsum " +
   " WHERE wrtsum.t_FIID = " + FIID +
   "   and wrtsum.t_Date <= " + GetSQLDate(RepDate) +
   "   and wrtsum.t_Amount > 0 " +
   "   and wrtsum.t_Buy_Sale = " + PM_WRITEOFF_SUM_BUY +
   "   and wrtsum.t_state IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+") " +
   "   and wrtsum.t_Department = " + {OperDprt} +
   "   and wrtsum.t_instance = (SELECT MAX (t_instance) " +
   "                            FROM v_scwrthistex " +
   "                            WHERE t_sumid = wrtsum.t_sumid " +
   "                              AND t_changedate <= "+GetSQLDate(RepDate)+" ) " +
   "   and wrtsum.t_Portfolio in ("+KINDPORT_TRADE+","+KINDPORT_SALE+","+KINDPORT_RETIRE+","+KINDPORT_PROMISSORY+","+KINDPORT_CONTR+") ";

   cmd = RSDCommand( Query );
   cmd.NullConversion = true;
   rs = TRsbDataSet(cmd);
   
   if( rs.MoveNext() )
      Rop = readNoteForObject(OBJTYPE_SECDEAL, L_Z(rs.DealID, 34), 36 /*Процент потерь по ожидаемым кредитным убыткам*/);
      if( Rop <= $0 )
         Rop = readNoteForObject(OBJTYPE_AVOIRISS, L_Z(FIID, 10), 24/*Коэффициент для ОР*/);
      end;
   end;
end;

private macro GetStrSqlLotByPortf(RepDate, Portf)
   return
   "       exists(SELECT wrtsum.t_FIID " +
   "              FROM v_scwrthistex wrtsum " +
   "              WHERE wrtsum.t_FIID = fin.t_FIID " +
   "                and wrtsum.t_Date <= " + GetSQLDate(RepDate) +
   "                and wrtsum.t_Amount > 0 " +
   "                and wrtsum.t_state IN ("+PM_WRTSUM_FORM+","+PM_WRTSUM_SALE_BPP+") " +
   "                and wrtsum.t_Department = " + {OperDprt} +
   "                and wrtsum.t_instance = (SELECT MAX (t_instance) " +
   "                                         FROM v_scwrthistex " +
   "                                         WHERE t_sumid = wrtsum.t_sumid " +
   "                                           AND t_changedate <= "+GetSQLDate(RepDate)+" ) " +
   "                and wrtsum.t_Portfolio in ("+Portf+") ) ";
end;

// Формирование строк 1.4, 1.8 подраздела 1 и 2.4, 2.7 подраздела 2 отчета по ц/б раздела 1 и п. 3, 4, 5 раздела <Справочно>
PRIVATE MACRO Secur_CollectData_ByAvoir(RepDate, avoirkind, p1, p2, p3, p4, ArrRepTbl, dataPart5, Ref4Table, dataPart6)
   var currpart = 0,
       pt = TRecHandler( "party.dbt" ),
       reslnk = TBfile("dlreslnk.dbt"),
       PartyIsIndividual = false,
       NumInList = "",
       V, V0, V1, V2, V2a, V3, V4, V5, V6, V7, V8, V9, V10, V11,
       W1, W2, W3, W4, W5,
       K = 0, C = 0, Rop,
       progr = 0,
       cmd, rs,
       Query =
   " SELECT fin.t_FIID, " +
   "        fin.t_FI_Code, " +
   "        fin.t_Issuer, " +
   "        (select ps.t_IsEmployer from dpersn_dbt ps where ps.t_PersonID = fin.t_Issuer) as IsEmployer, " +
   "        fin.t_DrawingDate, " +
   "        fin.t_FaceValueFI, " +
   "        RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_AvoirKind) t_AvrKindsRoot, " +
   "        RSB_SECUR.GetMainObjAttr("+OBJTYPE_AVOIRISS+", LPAD(fin.t_fiid, 10, '0'), "+13/*Категория качества*/+", "+getSqlDate(RepDate)+") t_QualityCateg, " +
   "        NVL((SELECT 1 FROM DUAL WHERE "+ GetStrSqlLotByPortf(RepDate, KINDPORT_TRADE) +"), 0) PortSSPU, "
   "        NVL((SELECT 1 FROM DUAL WHERE "+ GetStrSqlLotByPortf(RepDate, KINDPORT_SALE) +"), 0) PortSSSD "
   " FROM dfininstr_dbt fin " +
   " WHERE fin.t_fi_kind = " + FIKIND_AVOIRISS +
   "   and ("+GetStrSqlLotByPortf(RepDate, KINDPORT_TRADE)+" or "+
              GetStrSqlLotByPortf(RepDate, KINDPORT_SALE)+" or "+
              GetStrSqlLotByPortf(RepDate, KINDPORT_RETIRE)+" or "+
              GetStrSqlLotByPortf(RepDate, KINDPORT_PROMISSORY)+" or "+
              GetStrSqlLotByPortf(RepDate, KINDPORT_CONTR)+") " +
   "   and RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_AvoirKind) IN ("+AVOIRISSKIND_BOND+", "+AVOIRISSKIND_SHARE+") "
   +   IIF(avoirkind, " and RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_AvoirKind) = "+avoirkind, "");

   VA_Rep_InitProgress(SQL_GetNRecs(Query), "Обработка данных модуля \"Бэк-офис ценных бумаг\". Просмотр бумаг...");

   cmd = RSDCommand( Query );
   cmd.NullConversion = true;
   rs = TRsbDataSet(cmd);

   while( rs.MoveNext() )
      PartyIsIndividual = false;
      NumInList = "";
      W1 = $0; W2 = $0; W3 = $0; W4 = $0; W5 = $0;
      V3 = 0; V4 = 0;
      C = 0;
      Rop = $0;

      GetAvrPrmByLot(RepDate, rs.FIID, rs.FaceValueFI, @V1, @V2, @V2a );
      GetAvrReservByLot(RepDate, rs.FIID, @V7, @V8);

      // пункт 4 раздела <Справочно>
      if((p1) and (avoirkind != AVOIRISSKIND_BILL))
         Secur_CollectData_Ref4(RepDate, rs.FIID, V7 + V8, Ref4Table);
      end;

      // для ц/б должна быть указана категория качества
      if( rs.QualityCateg <= 0 )
         AddMas( ЦбОтсутствуетКК, rs.FI_Code );
         UseProgress(progr = progr + 1);
         continue;
      end;

      var R = readNoteForObject( OBJTYPE_AVOIRISS, L_Z( rs.FIID, 10 ), 3/*Процент резервирования*/ );
      // для ц/б должен быть указан процент резерва
      if( R < 0 )
         AddMas( ЦбОтсутствуетПроцентРезерва, rs.FI_Code );
         UseProgress(progr = progr + 1);
         continue;
      end;
      R = double(R);

      // категория качества
      K = rs.QualityCateg;
      if  ((K == 1) AND (R == 0))
      elif((K == 2) AND (R >= 1)  AND (R <= 20))
      elif((K == 3) AND (R >= 21) AND (R <= 50))
      elif((K == 4) AND (R >= 51) AND (R <= 100))
      elif((K == 5) AND (R == 100))
      else
         AddMas(@ProcSecCat, rs.FI_Code);
         UseProgress(progr = progr + 1);
         continue;
      end;

      // номер подраздела отчета
      if(ВидСубъекта(Int(rs.Issuer), PTK_BANK))
         currpart = 1; // кредитная организация
      else
         currpart = 2; // юридическое лицо

         pt.rec.PartyID = rs.Issuer;
         if( (rs.IsEmployer == SET_CHAR) OR
             ((GetMainObjAttr( null, OBJTYPE_PARTY, UniID( pt, OBJTYPE_PARTY), 39/*Субъект малого и среднего предпринимательства*/, null, null, NumInList)) AND
              (NumInList = "МСП")
             )
           )
           PartyIsIndividual = true;
         end;
      end;
      
      
      GetAvrNoteByLotDeal(RepDate, rs.FIID, @Rop);
      
      //Rop = readNoteForObject(OBJTYPE_AVOIRISS, L_Z(rs.FIID, 10), 24/*Коэффициент для ОР*/);
      //if( Rop == $0 )
      //  Rop = readNoteForObject(OBJTYPE_SECDEAL, ?, 36 /*Процент потерь по ожидаемым кредитным убыткам*/);
      //end;
      V9 = V1 * Rop / 100;
      V10 = V2 * Rop / 100;
      

      // пункт 5 раздела <Справочно>
      if( p3 and ((avoirkind == 0) or (avoirkind == AVOIRISSKIND_BOND) or (avoirkind == AVOIRISSKIND_SHARE)) )
         if (dataPart5.FilterPart5())
            dataPart5.Secur_AddData(rs.FIID, V1, V7, V9 + V10);
         end;
      end;
      
      // пункт 6 раздела <Справочно>
      if  ( rs.PortSSPU == 1 /*Портфель ССПУ_ЦБ*/ )
        V3 = GetRestAccByFiRole(KINDRES_RCB, null, rs.FIID, "+Переоценка, ц/б СССД_ЦБ", FIROLE_BAINPROMISSORY, RepDate)
             +
             GetRestAccByFiRole(KINDRES_RCB, null, rs.FIID, "-Переоценка, ц/б СССД_ЦБ", FIROLE_BAINPROMISSORY, RepDate);
             
        dataPart6.add(Str6_1_3, K, V1, V7);
        dataPart6.add(Str6_1_3, K, V2, V8);
        dataPart6.add(Str6_1_3, K, V3);
      elif( rs.PortSSSD == 1 /*Портфель СССД_ЦБ*/ )
        V3 = GetRestAccByFiRole(KINDRES_RCB, null, rs.FIID, "+Переоценка, ц/б ССПУ_ЦБ", FIROLE_BAINPROMISSORY, RepDate)
             +
             GetRestAccByFiRole(KINDRES_RCB, null, rs.FIID, "-Переоценка, ц/б ССПУ_ЦБ", FIROLE_BAINPROMISSORY, RepDate);
        
        if  ( rs.AvrKindsRoot == AVOIRISSKIND_SHARE /*Вид ц/б - долевые*/ )
          dataPart6.add(Str6_2_2, K, V1, V7);
          dataPart6.add(Str6_2_2, K, V2, V8);
          dataPart6.add(Str6_2_2, K, V3);
        elif( rs.AvrKindsRoot == AVOIRISSKIND_BOND /*Вид ц/б - долговые*/ )
          dataPart6.add(Str6_2_4, K, V1, V7);
          dataPart6.add(Str6_2_4, K, V2, V8);
          dataPart6.add(Str6_2_4, K, V3);
        end;
      end;
      V3 = 0;

      if(rs.DrawingDate < RepDate)
        C = RepDate - SQL_ConvTypeDate(rs.DrawingDate);
        V3 = V1;
        V4 = V2;
      end;

      V5 = V1 * R / 100;
      V6 = V2 * R / 100;

      // стоимость покупки
      W1 = V1-V2;
      if( rs.AvrKindsRoot == AVOIRISSKIND_BOND ) // облигации
         W2 = V3;
         W5 = V9;
      end;
      W3 = V5;
      W4 = V7;
      if( currpart == 1 ) // Подраздел 1
         ArrRepTbl.add(Str1_4, W1, W2, W3, W4, K, C);
      else // Подраздел 2
         ArrRepTbl.add(Str2_4, W1, W2, W3, W4, K, C);
      end;

      // ПДД
      if( rs.AvrKindsRoot == AVOIRISSKIND_BOND ) // облигации
         W1 = V2;
         W2 = V4;
         W3 = V6;
         W4 = V8;
         W5 = V10;
         if( currpart == 1 ) // Подраздел 1
            ArrRepTbl.add(Str1_8_б, W1, W2, W3, W4, K, C);
         else // Подраздел 2
            ArrRepTbl.add(Str2_7, W1, W2, W3, W4, K, C);
         end;
      end;

      UseProgress(progr = progr + 1);
   end;
   RemProgress();
END;

private macro GetReservDeal( RepDate, tick, WithOutGuarant, ROR:@variant, RSOP:@variant, RPOR:@variant )
   record dl_comm("dl_comm.dbt");
   ROR = $0; RSOP = $0; RPOR = $0;
   var Data, FD, ReservObj = tick, stat = false;
   FD = SPFirstDocDealReserv( ReservObj, KINDRES_REQ );
   // параметры
   dl_comm.DocKind = DL_RESERVEDOC;
   dl_comm.OperationKind = KINDRES_REQ;
   dl_comm.Division = {OperDprt};
   dl_comm.Oper = {Oper};
   dl_comm.CommDate = RepDate;
   dl_comm.PartyID    = UnknownParty;
   dl_comm.IssuerID   = UnknownParty;
   dl_comm.Currency   = -1;
   dl_comm.CreateReport = UNSET_CHAR;
   dl_comm.Flag1 = SET_CHAR;
   dl_comm.Flag3 = SET_CHAR;
   dl_comm.Flag4 = SET_CHAR;
   dl_comm.Flag6 = SET_CHAR;
   // SvOpSetDeal
   dl_comm.ContractID   = ReservObj.rec.DealID;
   dl_comm.ContractKind = ReservObj.rec.BofficeKind;
   dl_comm.ClientID     = ReservObj.rec.PartyID;
   // SvOpSetAvoiriss
   var Fininstr = TRecHandler( "fininstr.dbt" );
   stat = ПолучитьФинИн(ReservObj.rec.PFI, Fininstr);
   if (not stat)
      dl_comm.FIID = Fininstr.rec.FIID;
      dl_comm.AvoirKind = Fininstr.rec.AvoirKind;
      dl_comm.IssuerID = Fininstr.rec.Issuer;
      dl_comm.Currency = Fininstr.rec.FaceValueFI;

      Data = CReservData( RepDate, null, -1, -1, dl_comm, DL_SECURITYDOC, OBJTYPE_SECDEAL, FD, ReservObj, false );
      Data.WithOutGuarant = WithOutGuarant;

      stat = SP_РасчитатьРезерв( Data );

      if( stat )
         ROR = Data.РезервПоРепоОбр2ч;
         RSOP = Data.РезервПоТребованиямСОтсрочкойПлатежа;
         RPOR = Data.РезервПоПроцентнымТребованиям;
      end;
   end;

   return stat;
end;

// Алгоритм формирования строк 1.5, 1.6, 1.8 подраздела 1, строк 2.3, 2.5, 2.7 подраздела 2 и строки 3.6 подраздела 3 отчета (по сделкам) и строки 3.1 раздела <Справочно>
PRIVATE MACRO Secur_CollectData_ByDeals(RepDate, avoirkind, p1, p2, p3, ArrRepTbl, dataPart5)
   var progr = 0,
       pt = TRecHandler( "party.dbt" ),
       currpart = 0,
       ResType = "", // вид резерва
       PartyIsIndividual = False,
       K = 0, C = 0,
       V, V0, V10, V11, V12, ROR, RSOP, RPOR, ROR_g, RSOP_g, RPOR_g,
       Vincr, V0incr, Cincr,
       NumInList = "",
       cmd, rs,
       Query =
   " SELECT tick.t_DealID, " +
   "        tick.t_DealCode, "
   "        RSB_SECUR.GetMainObjAttr("+OBJTYPE_SECDEAL+", LPAD(tick.t_DealID, 34, '0'), "+OBJGROUP_TICKQUALITY+", "+getSqlDate(RepDate)+") t_QualityCateg, " +
   "        RSB_SECUR.IsSale(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) t_IsSale, " +
   "        RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) t_IsBuy, " +
   "        RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) t_IsRepo, " +
   "        (case when RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 and tick.t_PartyID = -1 " +
   "              then tick.t_MarketID " +
   "              else tick.t_PartyID " +
   "        end) t_ContractorID, " +
   "        (select ps.t_IsEmployer from dpersn_dbt ps where ps.t_PersonID = " +
   "           (case when RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 and tick.t_PartyID = -1 " +
   "                 then tick.t_MarketID " +
   "                 else tick.t_PartyID " +
   "           end) " +
   "        ) as IsEmployer, " +
   "        (select pt.t_LegalForm from dparty_dbt pt where pt.t_PartyID = " +
   "           (case when RSB_SECUR.IsExchange(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 and tick.t_PartyID = -1 " +
   "                 then tick.t_MarketID " +
   "                 else tick.t_PartyID " +
   "           end) " +
   "        ) t_ContrLegalForm " +
   " FROM ddl_tick_dbt tick " +
   " WHERE tick.t_BofficeKind = " + DL_SECURITYDOC +
   "   and tick.t_DealStatus = " + DL_READIED +
   "   and tick.t_DealDate <= " + GetSQLDate(RepDate) +
   "   and exists(SELECT rq.t_ID " +
   "              FROM ddlrq_dbt rq " +
   "              WHERE rq.t_DocKind = tick.t_BofficeKind " +
   "                and rq.t_DocID = tick.t_DealID " +
   "                and rq.t_Kind = " + DLRQ_KIND_REQUEST  +
   "                and rq.t_Type in("+DLRQ_TYPE_PAYMENT+","+DLRQ_TYPE_DELIVERY+")" +
   "                and rq.t_State != " + DLRQ_STATE_EXEC +
   "       ) " +
   "   and (case when RSB_SECUR.IsRepo(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " +
   "             then case when RSB_SECUR.IsBuy(RSB_SECUR.get_OperationGroup(RSB_SECUR.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 then 1 else 0 end "
   "             else 1 " +
   "       end) = 1 ";

   progr = 0;
   VA_Rep_InitProgress(SQL_GetNRecs(Query), "Обработка данных модуля \"Бэк-офис ценных бумаг\". Просмотр сделок...");

   cmd = RSDCommand( Query );
   cmd.NullConversion = true;
   rs = TRsbDataSet(cmd);

   while( rs.MoveNext() )
      var R = readNoteForObject( OBJTYPE_SECDEAL, L_Z( rs.DealID, 34 ), 8/*Процент резерва по требованиям*/ );
      // для сделки должен быть указан процент резерва
      if( R < 0 )
         UseProgress(progr = progr + 1);
         continue;
      end;

      K = rs.QualityCateg;
      if((K == 1) AND (R == 0))
      elif((K == 2) AND (R >= 1)  AND (R <= 20))
      elif((K == 3) AND (R >= 21) AND (R <= 50))
      elif((K == 4) AND (R >= 51) AND (R <= 100))
      elif((K == 5) AND (R == 100))
      else
         AddMas(@ProcSecCatDeal, rs.DealCode);
         UseProgress(progr = progr + 1);
         continue;
      end;

      var FD = SPFirstDoc( DL_SECURITYDOC, rs.DealID );
      ResType = "";
      PartyIsIndividual = false;
      NumInList = "";
      C = 0;
      V = $0; V0 = $0; V10 = $0; V11 = $0; V12 = $0; Vincr = $0; V0incr = $0; Cincr = $0;
      ROR = $0; RSOP = $0; RPOR = $0; ROR_g = $0; RSOP_g = $0; RPOR_g = $0;

      var rq_p = FD.GetRQ( DLRQ_TYPE_PAYMENT, 1, null, true );
      var rq_d = FD.GetRQ( DLRQ_TYPE_DELIVERY, 1, null, true );

      if( not rs.IsRepo ) // сделки покупки/продажи
         if( rs.IsBuy ) // сделка покупки
            if( (rq_p != null) and (rq_d != null) and
                (rq_d.rec.State != DLRQ_STATE_EXEC ) and ((rq_p.rec.State == DLRQ_STATE_EXEC) or (rq_p.rec.State == DLRQ_STATE_OVERDUE))
              )
               ResType = "РСОП";
            end;
         else // сделка продажи
            if( (rq_p != null) and (rq_d != null) and
                (rq_p.rec.State != DLRQ_STATE_EXEC ) and ((rq_d.rec.State == DLRQ_STATE_EXEC) or (rq_d.rec.State == DLRQ_STATE_OVERDUE))
              )
               ResType = "РСОП";
            end;
         end;

         if( ResType == "" )
            UseProgress(progr = progr + 1);
            continue;
         end;
      else // сделки РЕПО
         // поставка и оплата по 1 части должны быть исполнены
         if((rq_p == null) or (rq_d == null) or
            (rq_p.rec.State != DLRQ_STATE_EXEC) or (rq_d.rec.State != DLRQ_STATE_EXEC)
         )
            UseProgress(progr = progr + 1);
            continue;
         end;
      end;

      pt.rec.PartyID = rs.ContractorID;
      if( (rs.IsEmployer == SET_CHAR) OR
          ((GetMainObjAttr( null, OBJTYPE_PARTY, UniID( pt, OBJTYPE_PARTY), 39/*Субъект малого и среднего предпринимательства*/, null, null, NumInList)) AND
           (NumInList = "МСП")
          )
        )
        PartyIsIndividual = true;
      end;
      // подраздел отчета
      if(ВидСубъекта(Int(rs.ContractorID), PTK_BANK))
         currpart = 1;
      elif((rs.ContrLegalForm == PTLEGF_INST) OR (PartyIsIndividual)) //юр. лицо
         currpart = 2;
      else
         currpart = 3;
      end;

      // V, C
      if(not rs.IsRepo) // сделки покупки/продажи
         if(rs.IsBuy)
            // V = балансовая стоимость
            V = GetRestAccByFiRole(KINDRES_REQ, FD.tick, null, "+Форвард, расчеты", FIROLE_BA, RepDate-1);
            if(FD.dl_leg.rec.CFI != NATCUR)
               V = VA_Convert(V, RepDate, FD.dl_leg.rec.CFI, NATCUR);
            end;

            if(rq_d.rec.PlanDate < RepDate)
               C =  RepDate - rq_d.rec.PlanDate;
               V0 = V;
            end;
         else
            V = rq_p.rec.Amount;
            if( rq_p.rec.Fiid != NATCUR )
               V = VA_Convert(V, RepDate, rq_p.rec.Fiid, NATCUR);
            end;
            if(rq_p.rec.PlanDate < RepDate)
               C =  RepDate - rq_p.rec.PlanDate;
               V0 = V;
            end;
         end;
      else // сделки РЕПО
         // проценты
         var rq_incr = FD.GetRQ( DLRQ_TYPE_INCREPO, 2, null, true );
         if( rq_incr != null )
            Vincr = rq_incr.rec.Amount;
            if( rq_incr.rec.Fiid != NATCUR )
               Vincr = VA_Convert(Vincr, RepDate, rq_incr.rec.Fiid, NATCUR);
            end;
            if( rq_incr.rec.PlanDate < RepDate )
               Cincr =  RepDate - rq_incr.rec.PlanDate;
               V0incr = Vincr;
            end;
         end;

         if( FD.DL_LEG.rec.IncomeRate < $0 )
            V = V - Vincr;
         end;
      
         var rq_a2 = FD.GetRQ( DLRQ_TYPE_AVANCE, 2, null, true );
         var rq_p2 = FD.GetRQ( DLRQ_TYPE_PAYMENT, 2, null, true );
         if( rq_a2 != null )
            V = V + rq_a2.rec.Amount;
            if( rq_a2.rec.Fiid != NATCUR )
               V = VA_Convert(V, RepDate, rq_a2.rec.Fiid, NATCUR);
            end;
            if( rq_a2.rec.PlanDate < RepDate )
               C =  RepDate - rq_a2.rec.PlanDate;
               V0 = V;
            end;
         elif( rq_p2 != null )
            V = V + rq_p2.rec.Amount;
            if( rq_p2.rec.Fiid != NATCUR )
               V = VA_Convert(V, RepDate, rq_p2.rec.Fiid, NATCUR);
            end;
            if( rq_p2.rec.PlanDate < RepDate )
               C =  RepDate - rq_p2.rec.PlanDate;
               V0 = V;
            end;
         end;
      end;

      // определяется сумма расчетного резерва по сделке
      GetReservDeal( RepDate, FD.tick, true, @ROR, @RSOP, @RPOR );

      if( not rs.IsRepo ) // сделки покупки/продажи
         if( ResType == "РСОП" )
            V10 = RSOP;
            V11 = GetRestAccByFiRole(KINDRES_REQ, FD.tick, null, "Резерв, договор", FIROLE_RESERV_RSOP, RepDate-1);

            if( currpart == 1 )
               ArrRepTbl.add(Str1_5, V, V0, V10, V11, K, C);
            elif( currpart == 2 )
               ArrRepTbl.add(Str2_3, V, V0, V10, V11, K, C);
            elif( currpart == 3 )
               ArrRepTbl.add(Str3_5, V, V0, V10, V11, K, C);
            end;
         end;
      else // сделки РЕПО
         var Guarant = readNoteForObject( OBJTYPE_SECDEAL, L_Z( rs.DealID, 34 ), 10/*Сумма обеспечения*/ );
         if( Guarant >= 0 )
            // определяется сумма расчетного резерва по сделке с учетом обеспечения
            GetReservDeal( RepDate, FD.tick, false, @ROR_g, @RSOP_g, @RPOR_g );
         end;

         // По одной сделке могут быть определены 2 вида резерва:
         // "РОР";
         V10 = ROR;
         V11 = GetRestAccByFiRole(KINDRES_REQ, FD.tick, null, "Резерв, договор", FIROLE_RESERV_ROR, RepDate-1);
         V12 = ROR_g;
         if( currpart == 1 )
            ArrRepTbl.add(Str1_6, V, V0, V10, V11, K, C, V12);
         elif( currpart == 2 )
            ArrRepTbl.add(Str2_5, V, V0, V10, V11, K, C, V12);
         end;

         if( FD.DL_LEG.rec.IncomeRate >= $0 )
            // "РПОРЗ";
            V10 = RPOR;
            V11 = GetRestAccByFiRole(KINDRES_REQ, FD.tick, null, "Резерв, договор", FIROLE_RESERV_RPOR, RepDate-1);
            V12 = RPOR_g;
            if( currpart == 1 )
               ArrRepTbl.add(Str1_8, Vincr, V0incr, V10, V11, K, Cincr, V12);
            elif( currpart == 2 )
               ArrRepTbl.add(Str2_7, Vincr, V0incr, V10, V11, K, Cincr, V12);
            elif( currpart == 3 )
               ArrRepTbl.add(Str3_6, Vincr, V0incr, V10, V11, K, Cincr, V12);
            end;
         end;
      end;

      UseProgress(progr = progr + 1);
   end;
   RemProgress();
END;

MACRO PrintWBOp( RepDate, bySecur, byVA, avoirkind, p1, p2, p3, p4, ap, mode )
  macro GetAuditMsg():String
    var msg:string = "";
    var deals1:string = "";
    var deals2:string = "";
    var avr_name:string = "Все";
    var part1:string = "";
    var part2:string = "";
    var part3:string = "";
    var part4:string = "";

    deals1 = IIF(bySecur, "Модуля \"Бэк-офис ценных бумаг\"\n", "");
    deals2 = IIF(byVA, "Модуля \"Учтенные векселя\"\n", "");

    if (avoirkind != 0) avr_name = GetAvoirKindRec(avoirkind).name; end;

    part1 = IIF(p1, "Ц/б\n", "");
    part2 = IIF(p2, "Требования по сделкам\n", "");
    part3 = IIF(p3, "Пункт 5 раздела \"Справочно\"\n", "");
    part4 = IIF(p4, "Пункт 6 раздела \"Справочно\"\n", "");

    msg = 
      "Отчет:              Резервы по операциям с ц/б (ф.115)\n\n" +
      "Отчетная дата:      " + RepDate + "\n" +
      IIF(string(deals1 + deals2) != "",
          "По данным модуля:\n"  +
          deals1 + deals2,
          "") +
      "Вид ценной бумаги:  " + avr_name + "\n" +
      IIF(string(part1 + part2 + part3) != "",
          "Разделы:\n"  +
          part1 + part2 + part3 + part4,
          "") +
      "\n----------------------------------------\n";

    return msg;
  end;

  var ArrRepTbl = RepTable(RepDate, bySecur, byVA, p1, p2),
      Ref4Table = TRef4Table(),
      dataPart5 = TPart5Data(p3, RepDate),
      dataPart6 = TPart6Data(p4, RepDate);
  var AuditMsg = GetAuditMsg();

  AuditLog(REPORT_START, @AuditMsg);

  if(ap)
    a_str = "a:";
  end;
  Dl_CallInsertStat( IIF( mode == 2, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );

  if( bySecur )
     Secur_CollectData_ByAvoir(RepDate, avoirkind, p1, p2, p3, p4, ArrRepTbl, dataPart5, Ref4Table, dataPart6);
     Secur_CollectData_ByDeals(RepDate, avoirkind, p1, p2, p3, ArrRepTbl, dataPart5);
  end;
  if( byVA )
     VA_CollectData(RepDate, avoirkind, p1, p2, p3, ArrRepTbl, dataPart5, dataPart6);
  end;

  if( ExistsData )
     PrintHeader(RepDate);

     // добавить суммы в итоговые столбцы
     ArrRepTbl.add_c(Str1, Str1_3);
     ArrRepTbl.add_c(Str1, Str1_4);
     ArrRepTbl.add_c(Str1, Str1_5);
     ArrRepTbl.add_c(Str1, Str1_6);
     ArrRepTbl.add_c(Str1_8, Str1_8_а);
     ArrRepTbl.add_c(Str1_8, Str1_8_б);
     ArrRepTbl.add_c(Str1, Str1_8);
     ArrRepTbl.add_c(Str2, Str2_2);
     ArrRepTbl.add_c(Str2, Str2_3);
     ArrRepTbl.add_c(Str2, Str2_4);
     ArrRepTbl.add_c(Str2, Str2_5);
     ArrRepTbl.add_c(Str2_7, Str2_7_а);
     ArrRepTbl.add_c(Str2, Str2_7);
     ArrRepTbl.add_c(Str2_8, Str2_8_1);
     ArrRepTbl.add_c(Str2, Str2_8);
     ArrRepTbl.add_c(Str3, Str3_5);
     ArrRepTbl.add_c(Str3, Str3_6);
     ArrRepTbl.add_c(Str4, Str1);
     ArrRepTbl.add_c(Str4, Str2);
     ArrRepTbl.add_c(Str4, Str3);

     ArrRepTbl.add_c(Str4_1, Str1_3);
     ArrRepTbl.add_c(Str4_1, Str1_4);
     ArrRepTbl.add_c(Str4_1, Str1_5);
     ArrRepTbl.add_c(Str4_1, Str1_6);
     ArrRepTbl.add_c(Str4_1, Str2_2);
     ArrRepTbl.add_c(Str4_1, Str2_3);
     ArrRepTbl.add_c(Str4_1, Str2_5);
     ArrRepTbl.add_c(Str4_1, Str2_8);
     ArrRepTbl.add_c(Str4_1, Str3_5);

     if(Need4212(RepDate))
        ArrRepTbl.add_c(Str4_2, Str1_8);
        ArrRepTbl.add_c(Str4_2, Str2_7);
        ArrRepTbl.add_c(Str4_2, Str3_6);
     end;

     ArrRepTbl.print();

     // пункт 4 раздела <Справочно>
     if((p1) and (avoirkind != AVOIRISSKIND_BILL))
        if(byVA)
           VA_CollectData_Ref4(RepDate, Ref4Table);
        end;
        if(ExistsDataRef4)
           Ref4Table.Print();
        end;
     end;

     if(bySecur)
        // пункт 5 раздела <Справочно>
        //ArrRepTbl.Print_Ref5();
     end;

     // пункт 5 раздела <Справочно>
     if( p3 and Need3129(RepDate) )
       PrintPart5(dataPart5);
     end;

     
     if(p4 and ExistsDataRef6)
       dataPart6.add_c(str6_1, Str6_1_2);
       dataPart6.add_c(str6_1, Str6_1_3);
       dataPart6.add_c(str6_2, Str6_2_2);
       dataPart6.add_c(str6_2, Str6_2_3);
       dataPart6.add_c(str6_2, Str6_2_4);
       dataPart6.print();
     end;

     PrintEnd();
     rep.AddString(" ");

     Secur_PrintErrMas(ProcSecCat, "Процент резервирования у ц/б не соответствует категории качества :");
     Secur_PrintErrMas(ЦбОтсутствуетКК, "Отсутствует категория качества у ц/б");
     Secur_PrintErrMas(ЦбОтсутствуетПроцентРезерва, "Отсутствует процент резерва у ц/б");
     VA_PrintErrMas(ProcVSCat, "Процент резервирования у векселя не соответствует категории качества :");
     PrintErrDealsMas(ProcSecCatDeal, "Процент резервирования у сделки модуля \"БОЦБ\" не соответствует категории качества : Код сделки ");
     PrintErrDealsMas(ProcVSCatDeal, "Процент резервирования у сделки модуля \"УВ\" не соответствует категории качества : ID сделки ");
  end;

  rep.Print(mode, ExistsData, null, "Нет данных на отчетную дату для формирования отчета!");

  if (ExistsData)
    if (mode == 1)
      AuditLog(REPORT_FINISH, @AuditMsg, "tmp");
    elif (mode == 2)
      AuditLog(REPORT_FINISH, @AuditMsg, rep.ReportFileName_XLS);
    end;
  else 
    AuditLog(REPORT_NO_DATA, @AuditMsg);
  end;

END;
