/*
$Name:         vaprfrpt.mac
$Module:       ìÁ‚•≠≠Î• ¢•™·•´Ô
$Description:  è•Á†‚Ï Æ‚Á•‚† "ÑÆÂÆ§Î ØÆ Ê/°"
*/

IMPORT RsbDataSet, DealsInter, VAInter, "dlcarry.inc", RSD, ä†´•≠§†‡Ï,
       vareport, dlrepfun, vaacc, vsbnrfd, vaconv, dlmisc, vamisc, trvafd, vareslib, "dlerr_log.mac";

const   zero_date = Date(0,0,0),
        RATE_PREC = 4;

private const RoundN = 2;   /*‚ÆÁ≠Æ·‚Ï Æ™‡„£´•≠®Ô*/

PRIVATE VAR dateB, dateE, // ß†§†¢†•¨Î© Ø•‡®Æ§
            VaProfit_tmp; // ¢‡•¨•≠≠Î© ‰†©´

var vaprofit_count = 0;
private var total_count = 0;

var isBill = true;

private var bnrfd;

private const headBill =
    "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥                  ≥             ≥            ≥                        ≥            ≥            ≥            ≥            ≥          ≥          ≥              ≥                        ≥                        ≥                        ≥                        ≥                        ≥                        ≥\n" +
    "≥       N ·Á•‚†        ≥          Ç•™·•´•§†‚•´Ï         ≥    çÆ¨•‡, ·•‡®Ô     ≥        çÆ¨®≠†´         ≥Ñ†‚† ØÆ™„Ø™®≥      ñ•≠† ØÆ™„Ø™®      ≥  ê†·Á•‚≠†Ô   ≥ èÆ¢ÎË•≠®• 20%-£Æ ≥   ë‚†¢™†    ≥ î†™‚.§†‚†  ≥          ñ•≠†          ≥    Ñ†‚†    ≥   Ñ†‚†     ≥   ë‡Æ™     ≥ è•‡•§†≠ ≠† ≥  Ç‡•¨Ô   ≥  ë‡•§≠.  ≥    ë‚†¢™†    ≥         ë„¨¨†          ≥     ê†·ÁÒ‚≠†Ô Ê•≠†     ≥   è‡•¢ÎË•≠®• 20%-£Æ    ≥                        ≥                        ≥                        ≥\n" +
    "≥                      ≥                                ≥       ¢•™·•´Ô       ≥                        ≥            ≥                        ≥ Ê•≠† ≠† §†‚„ ≥    Æ‚™´Æ≠•≠®Ô    ≥  §®·™Æ≠‚†   ≥  Ø‡Æ§†¶®/  ≥        Ø‡Æ§†¶®/        ≥·Æ·‚†¢´•≠®Ô ≥ ØÆ£†Ë•≠®Ô  ≥  Ø´†‚•¶†   ≥  °†´†≠· Éé ≥≠†ÂÆ¶§•≠®Ô≥ „‡Æ¢•≠Ï  ≥   §®·™Æ≠‚†   ≥        §®·™Æ≠‚†        ≥   ≠† §†‚„ ‡•†´®ß†Ê®®   ≥    Æ‚™´Æ≠•≠®Ô Ê•≠Î     ≥   Ç≠•‡•†´®ß†Ê®Æ≠≠Î•    ≥         ÑÆÂÆ§ Æ‚       ≥   Ç≠•‡•†´®ß†Ê®Æ≠≠Î©    ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥    ØÆ™„Ø™®   ≥ Ê•≠Î ØÆ™„Ø™® Æ‚  ≥(•¶•§≠•¢≠.)/ ≥ ØÆ£†Ë•≠®Ô  ≥       ØÆ£†Ë•≠®Ô        ≥            ≥            ≥            ≥            ≥¢•™·•´Ô ¢ ≥  ·‚†¢™®  ≥  ØÆ ¢•™·•´Ó  ≥        ‡†·Á•‚≠†Ô       ≥                        ≥     ‡•†´®ß†Ê®® Æ‚      ≥         §ÆÂÆ§Î         ≥        ‡•†´®ß†Ê®®      ≥         ‡†·ÂÆ§         ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥  ‡†·Á•‚≠Æ© Ê•≠Î  ≥  Ø‡ÆÊ•≠‚†   ≥            ≥                        ≥            ≥            ≥            ≥            ≥ØÆ‡‚‰•´•, ≥ §®·™Æ≠‚† ≥   ¢ Ê•´ÔÂ    ≥                        ≥                        ≥    ‡†·ÁÒ‚≠Æ© Ê•≠Î      ≥                        ≥                        ≥                        ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥                  ≥ (£Æ§Æ¢†Ô),  ≥            ≥                        ≥            ≥            ≥            ≥            ≥  §≠•©    ≥          ≥    ≠†´Æ£Æ-   ≥                        ≥                        ≥                        ≥                        ≥                        ≥                        ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥                  ≥     %       ≥            ≥                        ≥            ≥            ≥            ≥            ≥          ≥          ≥  Æ°´Æ¶•≠®Ô   ≥                        ≥                        ≥                        ≥                        ≥                        ≥                        ≥\n" +
    "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
    "≥          1           ≥                2               ≥          3          ≥            4           ≥     5      ≥            6           ≥      7       ≥         8        ≥     9       ≥     10     ≥           11           ≥     12     ≥     13     ≥     14     ≥     15     ≥    16    ≥    17    ≥      18      ≥           19           ≥           20           ≥           21           ≥           22           ≥           23           ≥           24           ≥\n" +
    "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥"
;

private const headCert =
    "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥                  ≥              ≥            ≥                        ≥            ≥            ≥            ≥          ≥                        ≥                        ≥                        ≥                        ≥                        ≥\n" +
    "≥       N ·Á•‚†        ≥             ù¨®‚•≠‚            ≥    çÆ¨•‡, ·•‡®Ô     ≥        çÆ¨®≠†´         ≥Ñ†‚† ØÆ™„Ø™®≥      ñ•≠† ØÆ™„Ø™®      ≥  ê†·Á•‚≠†Ô   ≥ èÆ¢ÎË•≠®• 20%-£Æ ≥    ë‚†¢™†    ≥ î†™‚.§†‚†  ≥          ñ•≠†          ≥    Ñ†‚†    ≥   Ñ†‚†     ≥ è•‡•§†≠ ≠† ≥  Ç‡•¨Ô   ≥     ê†·ÁÒ‚≠†Ô Ê•≠†     ≥   è‡•¢ÎË•≠®• 20%-£Æ    ≥                        ≥                        ≥                        ≥\n" +
    "≥                      ≥                                ≥    §•ØÆß®‚≠Æ£Æ      ≥                        ≥            ≥                        ≥ Ê•≠† ≠† §†‚„ ≥    Æ‚™´Æ≠•≠®Ô    ≥   Ø‡ÆÊ•≠‚†   ≥  Ø‡Æ§†¶®/  ≥        Ø‡Æ§†¶®/        ≥·Æ·‚†¢´•≠®Ô ≥ ØÆ£†Ë•≠®Ô  ≥  °†´†≠· Éé ≥≠†ÂÆ¶§•≠®Ô≥   ≠† §†‚„ ‡•†´®ß†Ê®®   ≥    Æ‚™´Æ≠•≠®Ô Ê•≠Î     ≥   Ç≠•‡•†´®ß†Ê®Æ≠≠Î•    ≥         ÑÆÂÆ§ Æ‚       ≥   Ç≠•‡•†´®ß†Ê®Æ≠≠Î©    ≥\n" +
    "≥                      ≥                                ≥    ·•‡‚®‰®™†‚†      ≥                        ≥            ≥                        ≥    ØÆ™„Ø™®   ≥ Ê•≠Î ØÆ™„Ø™® Æ‚  ≥  (£Æ§Æ¢†Ô),  ≥ ØÆ£†Ë•≠®Ô  ≥       ØÆ£†Ë•≠®Ô        ≥            ≥            ≥            ≥    ¢     ≥                        ≥     ‡•†´®ß†Ê®® Æ‚      ≥         §ÆÂÆ§Î         ≥        ‡•†´®ß†Ê®®      ≥         ‡†·ÂÆ§         ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥  ‡†·Á•‚≠Æ© Ê•≠Î  ≥      %       ≥            ≥                        ≥            ≥            ≥            ≥ØÆ‡‚‰•´•, ≥                        ≥    ‡†·ÁÒ‚≠Æ© Ê•≠Î      ≥                        ≥                        ≥                        ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥                  ≥              ≥            ≥                        ≥            ≥            ≥            ≥  §≠•©    ≥                        ≥                        ≥                        ≥                        ≥                        ≥\n" +
    "≥                      ≥                                ≥                     ≥                        ≥            ≥                        ≥              ≥                  ≥              ≥            ≥                        ≥            ≥            ≥            ≥          ≥                        ≥                        ≥                        ≥                        ≥                        ≥\n" +
    "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n" +
    "≥          1           ≥                2               ≥          3          ≥            4           ≥     5      ≥            6           ≥      7       ≥         8        ≥      9       ≥     10     ≥            11          ≥     12     ≥     13     ≥     14     ≥    15    ≥           16           ≥           17           ≥           18           ≥           19           ≥           20           ≥\n" +
    "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥"
;

private const
    col_account             = 0,
    col_issuer              = 1,
    col_bnr_number          = 2,
    col_bnr_series          = 3,
    col_principal           = 4,
    col_buy_date            = 5,
    col_buy_cost            = 6,
    col_calc_buy_cost       = 7,
    col_20_prc_calcbuycost  = 8,
    col_discount            = 9,
    col_fact_sale_date      = 10,
    col_sale_cost           = 11,
    col_sign_date           = 12,
    col_repay_date          = 13,
    col_termdate            = 14,
    col_GO_balance          = 15,
    col_billholding         = 16,
    col_avg_discount        = 17,
    col_tax_discount        = 18,
    col_calc_discount       = 19,
    col_calc_dispose_cost   = 20,
    col_20_prc_excess       = 21,
    col_non_saling_income   = 22,
    col_saleincome          = 23,
    col_non_sale_charge     = 24
;

macro getColNumber(col_num)
  var number = col_num;

  if(isBill == false)
    if(col_num >= 15)
      number = col_num - 1;
    end;
    if(col_num >= 20)
      number = col_num - 3;
    end;
  end;

  return number;
end;

private var rep;
private var repErrLog;
private const FontStyleTitel = "ex_FS(b)";

private macro PrintCellSizeC( Str, S_Size, format )
   if(ValType(format) == V_UNDEF)
     format = "";
   end;
   rep.AddPrintCell( Str, S_Size, 0, "c:" + FontStyleTitel+format, REP_ELEM_STR );
   rep.AddStr();
end;

private macro PrintCell( Str )
   rep.AddPrintCell( Str, strlen(Str)+2, 0, "l:" + FontStyleTitel, REP_ELEM_STR );
   rep.AddStr();
end;

/* èÆ´„Á•≠®• ≠†Á†´Ï≠Æ© ® ™Æ≠•Á≠Æ© §†‚Î Ø•‡®Æ§† */
PRIVATE MACRO GetPeriod(period, year, year_run, dateB:@variant, dateE:@variant)

    if((period >= 1) and (period <= 12)) //ØÆ ¨•·ÔÊ†¨
        dateB = Date(1, period, year);
        dateE = DateAfterCalenMonths(dateB, 1) - 1;
    elif(period == 13)   // I ™¢†‡‚†´
        dateB = date(1, 1, int(year));
        dateE = date(31, 3, int(year));
    elif(period == 14) // II ™¢†‡‚†´
        dateB = date(1, 4, int(year));
        dateE = date(30, 6, int(year));
    elif(period == 15) // III ™¢†‡‚†´
        dateB = date(1, 7, int(year));
        dateE = date(30, 9, int(year));
    elif(period == 16) // IV ™¢†‡‚†´
        dateB = date(1, 10, int(year));
        dateE = date(31, 12, int(year));
    else
        return false;
    end;

    if (year_run)
        // ç†‡†·‚†ÓÈ®¨ ®‚Æ£Æ¨
        dateB = date(1, 1, int(year));
    end;

    return true;
END;

/* è•Á†‚Ï ß†£Æ´Æ¢™† */
PRIVATE MACRO PrintHeader(dateB, dateE, year, range)
VAR mName,
    avoirkind_str = "";
    var Sfcontr, query;

    if(isBill)
      avoirkind_str = "„Á‚•≠≠Î¨ ¢•™·•´Ô¨";
    else
      avoirkind_str = "§•ØÆß®‚≠Î¨ ·•‡‚®‰®™†‚†¨";
    end;

    PrintCellSizeC("ë¢•§•≠®Ô Æ §ÆÂÆ§†Â ØÆ "+avoirkind_str+" Ó‡®§®Á•·™®Â ´®Ê ß† " + year + " £Æ§", rep.GetHeaderWidth(), ":ex_FZ(14)");
    PrintCellSizeC("á† Ø•‡®Æ§: · " + date_as_str(dateB) + " ØÆ " + date_as_str(dateE),rep.GetHeaderWidth(), ":ex_FZ(14)");
    if(isBill)
      if(range == 2)
          PrintCellSizeC("Ç•™·•´Ô, ≠Æ¨®≠®‡Æ¢†≠≠Î• ¢ ¢†´Ó‚• êî", rep.GetHeaderWidth(), ":ex_FZ(14)");
      elif(range == 3)
          PrintCellSizeC("Ç•™·•´Ô, ≠Æ¨®≠®‡Æ¢†≠≠Î• ¢ ®≠.¢†´Ó‚•", rep.GetHeaderWidth(), ":ex_FZ(14)");
      end;
    end;
    PrintCell("‡„°., ™ÆØ.", mod);
    return 0;
END;

/* è•Á†‚Ï ß†£Æ´Æ¢™† ‡†ß§•´† */
PRIVATE MACRO PrintSection(SectionName)
    rep.AddPrintCell(SectionName, rep.GetHeaderWidth());
    rep.AddStr();
END;

PRIVATE MACRO PrintFootCommon(ap, title1, title2, F4, F6, F61, F7, F8, F11, F111, F19, F20, F21, F22, F23, F24)
var
    mod_ap = "",
    mod = "",
    mod_n = "";

    if (ap)
        mod_ap = "a:";
    end;

    mod = mod_ap + "ex_B(TLR):ex_FS(B)";
    mod_n = mod + ":r";
    rep.AddPrintCell(title1,rep.GetWidthBeforeCol(col_principal) - 1,       null, mod + ":l");
    rep.AddPrintCell(F4,    rep.GetColWidthTable(col_principal),            null, mod_n);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_buy_date),             null, mod);
    rep.AddPrintCell(F6,    rep.GetColWidthTable(col_buy_cost),             null, mod_n);
    rep.AddPrintCell(F7,    rep.GetColWidthTable(col_calc_buy_cost),        null, mod_n);
    rep.AddPrintCell(F8,    rep.GetColWidthTable(col_20_prc_calcbuycost),   null, mod_n);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_discount),             null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_fact_sale_date),       null, mod);
    rep.AddPrintCell(F11,   rep.GetColWidthTable(col_sale_cost),            null, mod_n);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_sign_date),            null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_repay_date),           null, mod);
    if(isBill)
      rep.AddPrintCell(" ",   rep.GetColWidthTable(col_termdate),           null, mod);
    end;
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_GO_balance)),           null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_billholding)),          null, mod);
    if(isBill)
      rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_avg_discount)),         null, mod);
      rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_tax_discount)),         null, mod);
      rep.AddPrintCell(F19,   rep.GetColWidthTable(getColNumber(col_calc_discount)),        null, mod_n);
    end;
    rep.AddPrintCell(F20,   rep.GetColWidthTable(getColNumber(col_calc_dispose_cost)),    null, mod_n);
    rep.AddPrintCell(F21,   rep.GetColWidthTable(getColNumber(col_20_prc_excess)),        null, mod_n);
    rep.AddPrintCell(F22,   rep.GetColWidthTable(getColNumber(col_non_saling_income)),    null, mod_n);
    rep.AddPrintCell(F23,   rep.GetColWidthTable(getColNumber(col_saleincome)),           null, mod_n);
    rep.AddPrintCell(F24,   rep.GetColWidthTable(getColNumber(col_non_sale_charge)),      null, mod_n);
    rep.AddStr();

    mod = mod_ap + "ex_B(BLR):ex_FS(B)";
    mod_n = mod + ":r";
    rep.AddPrintCell(title2,rep.GetWidthBeforeCol(col_principal) - 1,       null, mod + ":l");
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_principal),            null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_buy_date),             null, mod);
    rep.AddPrintCell(F61,   rep.GetColWidthTable(col_buy_cost),             null, mod_n);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_calc_buy_cost),        null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_20_prc_calcbuycost),   null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_discount),             null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_fact_sale_date),       null, mod);
    rep.AddPrintCell(F111,   rep.GetColWidthTable(col_sale_cost),           null, mod_n);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_sign_date),            null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(col_repay_date),           null, mod);
    if(isBill)
      rep.AddPrintCell(" ",   rep.GetColWidthTable(col_termdate),           null, mod);
    end;
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_GO_balance)),           null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_billholding)),          null, mod);
    if(isBill)
      rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_avg_discount)),         null, mod);
      rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_tax_discount)),         null, mod);
      rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_calc_discount)),        null, mod);
    end;
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_calc_dispose_cost)),    null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_20_prc_excess)),        null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_non_saling_income)),    null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_saleincome)),           null, mod);
    rep.AddPrintCell(" ",   rep.GetColWidthTable(getColNumber(col_non_sale_charge)),      null, mod);
    rep.AddStr();
END; // PrintFootCommon

/* è•Á†‚Ï ®‚Æ£† ØÆ ‡†ß§•´„ */
PRIVATE MACRO PrintFootSection(ap, SectionName, F4, F6, F61, F7, F8, F11, F111, F19, F20, F21, F22, F23, F24)

    var avoirkindstr = "";
    var title2 = "";

    if(isBill)
      avoirkindstr = "¢•™·•´•©";
    else
      avoirkindstr = "§•ØÆß®‚≠ÎÂ ·•‡‚®‰®™†‚Æ¢";
    end;

    SectionName = "\"" + SectionName + "\"";

    title2 = " (¢ ‚.Á. ™‡Æ¨• "+avoirkindstr+", Ø•‡•§†≠≠ÎÂ ≠† °†´†≠· Éé ® ≠†ÂÆ§ÔÈ®Â·Ô ¢ ØÆ‡‚‰•´• °†≠™†)";
    PrintFootCommon(ap,
        " à‚Æ£Æ ØÆ ‡†ß§•´„ " + SectionName,
        title2,
        F4, F6, F61, F7, F8, F11, F111, F19, F20, F21, F22, F23, F24);
END;

/* è•Á†‚Ï ®‚Æ£† ØÆ ‚†°´®Ê• */
PRIVATE MACRO PrintFootAll(ap, F4, F6, F61, F7, F8, F11, F111, F19, F20, F21, F22, F23, F24)

    var avoirkindstr = "";
    var title2 = "";

    if(isBill)
      avoirkindstr = "¢•™·•´•©";
    else
      avoirkindstr = "§•ØÆß®‚≠ÎÂ ·•‡‚®‰®™†‚Æ¢";
    end;

    title2 = " (¢ ‚.Á. ™‡Æ¨• "+avoirkindstr+", Ø•‡•§†≠≠ÎÂ ≠† °†´†≠· Éé ® ≠†ÂÆ§ÔÈ®Â·Ô ¢ ØÆ‡‚‰•´• °†≠™†)";

    PrintFootCommon(ap,
        " ÇëÖÉé",
        title2,
        F4, F6, F61, F7, F8, F11, F111, F19, F20, F21, F22, F23, F24);
END;

/******************************************************************************/
PRIVATE MACRO isBank(PartyID)
  var partyown, Select;

  Select = DL_RsdCommand("select t_partyid from dpartyown_dbt where t_partykind="+PTK_BANK+" and t_partyid= ?");

  Select.addParam(PartyID);

  partyown = Select.execute();
  return partyown.movenext;
end;

PRIVATE MACRO GetCBRate(SaleDate:date, Rate:@variant)
  var CbrfRate, Select;
  var stat = 0;

  Select = DL_RsdCommand("select t_Rate from dCBrfrate_dbt where t_FIID ="+NATCUR+" and t_EffectiveDate <= ? order by t_EffectiveDate desc");

  Select.addParam(SaleDate);

  CbrfRate = Select.execute();
  stat = CbrfRate.moveNext();
  if(stat)
    Rate = CbrfRate.Rate;
  end;

  return stat;
END;

PRIVATE MACRO Get_d(StartDate)
  var d = 0.0;
  var F; //·‚†¢™† ‡•‰®≠†≠·®‡Æ¢†≠®Ô ñÅ ¢ %, §•©·‚¢„ÓÈ†Ô ≠† §†‚„
  var E; //Ø‡ÆÊ•≠‚ ‡•ß•‡¢†, „™†ß†≠≠Î© ¢ ‰Æ‡¨• "ê•ß•‡¢Î ØÆ Ê•≠≠Æ© °„¨†£•",
  var msg;

  if(not GetCBRate(StartDate, @F))
    msg = "ç• ≠†©§•≠† ·‚†¢™† ‡•‰®≠†≠·®‡Æ¢†≠®Ô ñÅ êî ≠† " + date(StartDate);
    repErrLog.LogError(msg);
    F = 0.0;
  end;

  if(CalcAndCheckReserveParams(bnrfd.GetBnr().rec, StartDate, null, VARES_SUBKIND_AVR, @E) != 0)
    msg = "ç• ≠†©§•≠ Ø‡ÆÊ•≠‚ ‡•ß•‡¢®‡Æ¢†≠®Ô ØÆ Ê/° ·•‡. " + bnrfd.GetBnr().rec.BCSeries + " N " + trim(bnrfd.GetBnr().rec.BCNumber) + " ≠† §†‚„ " + date(StartDate);
    repErrLog.LogError(msg);
    E = 0.0;
  end;

  d = F*(1 + E/100.0)/100.0;

  return d;
END;

// èÆ´„Á®‚Ï §†‚Î Ø•‡®Æ§† ‡†·Á•‚Æ¢
PRIVATE MACRO GetCalcPeriodDates(IncomeDateType, BuyDate, RepaymentDate, BeginCalcDate:@date, EndCalcDate:@date)
  if((IncomeDateType == DL_INCOMEDATETYPE_CBR)
 and (bnrfd.GetBnr().rec.BCTermFormula == VS_TERMF_FIXEDDAY))
    BeginCalcDate = BuyDate;
    EndCalcDate = RepaymentDate - 1;
  else
    BeginCalcDate = BuyDate + 1;
    EndCalcDate = RepaymentDate;
  end;
END;

// èÆ´„Á®‚Ï §†‚„ Æ™Æ≠Á†≠®Ô §•©·‚¢®Ô ·‚†¢™®
PRIVATE MACRO GetPrcHstEndDate(BCID, BeginDate):date
  var sqlQuery = "";
  var rsdCmd = null;
  var dataSet = null;

  sqlQuery =
    " SELECT "
    + " NVL( MIN( vsprchst.t_BegDate ) - 1, TO_DATE( '01.01.0001', 'DD.MM.YYYY' ) ) AS t_EndDate "
  + " FROM "
    + " dvsprchst_dbt vsprchst "
  + " WHERE "
    + " vsprchst.t_BCID = ? "
+ " AND vsprchst.t_BegDate > ? ";

  rsdCmd = RSDCommand(sqlQuery);
  rsdCmd.NullConversion = true;
  rsdCmd.AddParam("", RSDBP_IN, BCID);
  rsdCmd.AddParam("", RSDBP_IN, BeginDate);
  rsdCmd.Execute();

  dataSet = TRsbDataSet(rsdCmd);
  dataSet.MoveNext();

  return dataSet.EndDate;
END;

PRIVATE MACRO GetCalcCost(IncomeDateType, N, Rate, BuyOrSaleDate, RepaymentDate)
  var d = 0.0;
  var Dn = date(0,0,0);
  var Do = date(0,0,0);
  var è‡ = 0.0;
  var Dni = date(0,0,0);
  var Doi = date(0,0,0);
  var è‡i = 0.0;
  var Ai = 0.0;
  var isDisc = false;
  var isPrc = false;
  var CalcCost = $0;

  d = Get_d(BuyOrSaleDate);

  GetCalcPeriodDates(IncomeDateType, BuyOrSaleDate, RepaymentDate, @Dn, @Do);
  è‡ = ê†··Á®‚†‚ÏäÆÌ‰‰é°‡†È•≠®Ô(Dn, Do, bnrfd.GetLeg().rec.Basis);

  isDisc = Ç•™·•´ÏÑ®·™Æ≠‚≠Î©(bnrfd.GetLeg());
  isPrc = Ç•™·•´Ïè‡ÆÊ•≠‚≠Î©(bnrfd.GetLeg());

  if(isDisc and isPrc) // Ø‡ÆÊ•≠‚≠Æ-§®·™Æ≠‚≠Î©
    CalcCost = N*(1.0 - d*è‡) + N/(1.0 + d*è‡);
  elif(isDisc) // §®·™Æ≠‚≠Î©
    CalcCost = N*(1.0 - d*è‡);
  elif(isPrc) // Ø‡ÆÊ•≠‚≠Î© ®´® §•ØÆß®‚≠Î© ·•‡‚®‰®™†‚
    CalcCost = N/(1.0 + d*è‡);
  end;

  if(isPrc)
    Dni = Dn;
    Doi = GetPrcHstEndDate(bnrfd.GetBnr().rec.BCID, Dni);
    if(Doi == date(0,0,0))
      Doi = Do;
    end;

    while((Dni <= Do) and (Doi <= Do))
      è‡i = ê†··Á®‚†‚ÏäÆÌ‰‰é°‡†È•≠®Ô(Dni, Doi, bnrfd.GetLeg().rec.Basis);
      if(not isBill) // §•ØÆß®‚≠Î© ·•‡‚®‰®™†‚
        Ai = Rate;
      else // Ø‡ÆÊ•≠‚≠Æ-§®·™Æ≠‚≠Î© ®´® Ø‡ÆÊ•≠‚≠Î©
        Ai = DL_VAGetBnrRateOnDate(bnrfd.GetBnr().rec.BCID, Dni) / pow(10, bnrfd.GetLeg().rec.Point);
      end;

      CalcCost = CalcCost + N*Ai*è‡i/100.0/(1.0 + d*è‡);

      Dni = Doi + 1;
      Doi = GetPrcHstEndDate(bnrfd.GetBnr().rec.BCID, Dni);
      if(Doi == date(0,0,0))
        Doi = Do;
      end;
    end;
  end;

  return round(double(CalcCost), RATE_PREC);

  OnError(err)
    repErrLog.LogError(err.Message);
    return 0;
END;

PRIVATE MACRO GetCalcBuyCost(IncomeDateType, Rate, BuyDate, RepaymentDate)
  var N = $0;
  var CalcCost = $0;
  var msg = "", stat = 0;

  N = VA_Convert(bnrfd.GetLeg().rec.Principal, BuyDate, bnrfd.GetLeg().rec.PFI, NATCUR, stat, msg, true); //≠Æ¨®≠†´ Ê/° ¢ ‡„°´ÔÂ ØÆ ™„‡·„ ≠† §†‚„ ØÆ™„Ø™®
  
  if(stat != 0)
    repErrLog.LogError(msg);
    N = 0;
  end;

  CalcCost = GetCalcCost(IncomeDateType, N, Rate, BuyDate, RepaymentDate);

  return round(double(CalcCost), RATE_PREC);
END;

PRIVATE MACRO GetCalcSaleCost(IncomeDateType, Principal_natcur, Rate, SaleDate, RepaymentDate)
  var CalcCost = $0;

  CalcCost = GetCalcCost(IncomeDateType, Principal_natcur, Rate, SaleDate, RepaymentDate);

  return round(double(CalcCost), RATE_PREC);
END;

PRIVATE MACRO GetNonOpExpense(IncomeDateType, BuyCost, Principal, RateD, RateP, dateB, BuyDate)
  var Dn = date(0,0,0);
  var Do = date(0,0,0);
  var Dni = date(0,0,0);
  var Doi = date(0,0,0);
  var Ai = 0.0;
  var isDisc = false;
  var isPrc = false;
  var NonOpExpense = $0;

  GetCalcPeriodDates(IncomeDateType, BuyDate, dateB - 1, @Dn, @Do);

  isDisc = Ç•™·•´ÏÑ®·™Æ≠‚≠Î©(bnrfd.GetLeg());
  isPrc = Ç•™·•´Ïè‡ÆÊ•≠‚≠Î©(bnrfd.GetLeg());

  if(isDisc and isPrc) // Ø‡ÆÊ•≠‚≠Æ-§®·™Æ≠‚≠Î©
    NonOpExpense = BuyCost * RateD;
  elif(isDisc) // §®·™Æ≠‚≠Î©
    NonOpExpense = BuyCost * RateD * (Do - Dn + 1) / 100;
  elif(isPrc and not isBill) // §•ØÆß®‚≠Î© ·•‡‚®‰®™†‚
    NonOpExpense = Principal * RateP * (dateB - 1 - BuyDate) / 100 / 365;
  end;

  if(isPrc)
    Dni = Dn;
    Doi = GetPrcHstEndDate(bnrfd.GetBnr().rec.BCID, Dni);
    if((Doi == date(0,0,0)) or (Doi > Do))
      Doi = Do;
    end;

    while((Dni <= Do) and (Doi <= Do))
      Ai = DL_VAGetBnrRateOnDate(bnrfd.GetBnr().rec.BCID, Dni) / pow(10, bnrfd.GetLeg().rec.Point);

      NonOpExpense = NonOpExpense + Principal * Ai * (Doi - Dni + 1) / 100 / 365;

      Dni = Doi + 1;
      Doi = GetPrcHstEndDate(bnrfd.GetBnr().rec.BCID, Dni);
      if((Doi == date(0,0,0)) or (Doi > Do))
        Doi = Do;
      end;
    end;
  end;

  return NonOpExpense;

  OnError(err)
    repErrLog.LogError(err.Message);
    return 0;
END;

/******************************************************************************/

PRIVATE MACRO PrintReportLine(ap, t1, t2, t3, t4, t5,
                           Account, Issuer, BuyDate, _BuyCost, BuyFI, _SaleDate, _SaleCost, SaleFI,
                           BCNumber, BCSeries, bnr_RepaymentDate, bnr_BCPresentationDate,
                           bnr_BCState, bnr_BCTermFormula, bnr_BCTermFormat,
                           leg_Principal, leg_PFI, leg_Start:date, leg_Maturity:date, leg_Expiry, leg_Diff, leg_Price,
                           leg_Basis, leg_Formula, leg_Point, leg_InterestStart, DocKind, BCID, bnr_Issuer, tick_PartyID)
var
    msg, stat = 0,
    IncomeDateType = DL_INCOMEDATETYPE_PLUSONE, Principal = "", Rate = 0.0, RateD = 0.0, RateP = 0.0, CbrfRate = 0.0,
    RepaymentDate = "", BuyCost = "", SaleCost = "", SaleDate, TermDate = "",
    WriteOffDate,
    CalcBuyCost, BuyCostExcess="",
    A16 = "", A19 = "", A20 = "", A21 = "", A22 = "", A23 = "", A24 = "", ABCstatus, äÆ´¢ÆÑ≠•©, X, Y;

const CostExceed = 0.2;

    DL_GetStartIncomeDateType(@IncomeDateType);

    VaProfit_tmp.Clear();

    // A4
    if(leg_PFI != NATCUR)
       if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE))
          Principal = VA_Convert( leg_Principal, _SaleDate, leg_PFI, NATCUR, stat, msg, true);
          
          if(stat != 0)
            repErrLog.LogError(msg);
            Principal = 0;
          end;
       else
          Principal = VA_Convert( leg_Principal, dateE, leg_PFI, NATCUR, stat, msg, true);
          if(stat != 0)
            repErrLog.LogError(msg);
            Principal = 0;
          end;
       end;
    else
       Principal = leg_Principal;
    end;

    // A6
    if(BuyFI != NATCUR)
       if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE))
          BuyCost = VA_Convert( _BuyCost, _SaleDate, BuyFI, NATCUR, stat, msg, true );
          if(stat != 0)
            repErrLog.LogError(msg);
            BuyCost = 0;
          end;
       else
          BuyCost = VA_Convert( _BuyCost, dateE, BuyFI, NATCUR, stat, msg, true );
          if(stat != 0)
            repErrLog.LogError(msg);
            BuyCost = 0;
          end;
       end;
    else
       BuyCost = _BuyCost;
    end;

    // A10, A11, A15
    if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE))
       if(DocKind == DL_VAENWR)
          WriteOffDate = _SaleDate;
       elif(DocKind > 0)
          SaleDate = _SaleDate;
       end;
       SaleCost = VA_Convert( _SaleCost, _SaleDate, SaleFI, NATCUR, stat, msg, true );
       if(stat != 0)
            repErrLog.LogError(msg);
            SaleCost = 0;
       end;
    end;

    // A13 - Ñ†‚† ØÆ£†Ë•≠®Ô
    if((bnr_BCTermFormula == VS_TERMF_FIXEDDAY) OR (bnr_BCTermFormula == VS_TERMF_INATIME) OR // ·‡ÆÁ≠Î•
       ((bnr_BCTermFormula == VS_TERMF_ATSIGHT) and (date(leg_Maturity) >= date(leg_Start)))) // èÆ Ø‡•§ÍÔ¢´•≠®®, ≠Æ ≠• ‡†≠••
       RepaymentDate = leg_Maturity;
    elif((bnr_BCTermFormula == VS_TERMF_DURING) and (date(bnr_BCPresentationDate) > date(0,0,0))) // Æ‚ Ø‡•§ÍÔ¢´•≠®Ô, „¶• Ø‡•§ÍÔ¢´•≠≠Î•
       RepaymentDate = bnr_BCPresentationDate + int(leg_Diff);
    else
       RepaymentDate = leg_Start + DaysInYearByBasis(leg_Basis, leg_Start, true);
    end;

    //A14 - ë‡Æ™ Ø´†‚•¶†
    if((bnr_BCTermFormula == VS_TERMF_ATSIGHT) and (date(leg_Maturity) >= date(leg_Start))) // èÆ Ø‡•§ÍÔ¢´•≠®®, ≠Æ ≠• ‡†≠••
       TermDate = RepaymentDate + DaysInYearByBasis(leg_Basis, leg_Start, true);
    else
       TermDate = RepaymentDate;
    end;

    // A9
    var S = 1;
    if((leg_Formula == VS_IN_DISCONT) or (leg_Formula == VS_IN_DISC_PC))
       if((bnr_BCTermFormula == VS_TERMF_FIXEDDAY) OR (bnr_BCTermFormula == VS_TERMF_INATIME)) // ·‡ÆÁ≠Î•
          S = RepaymentDate - BuyDate;
       elif(bnr_BCTermFormula == VS_TERMF_ATSIGHT) //ØÆ Ø‡•§ÍÔ¢´•≠®®
          if(leg_Expiry >= leg_Start)     // ≠• ØÆß§≠••
             S = leg_Expiry - BuyDate;
          elif(leg_Maturity >= leg_Start) // ≠• ‡†≠••
             S = TermDate - BuyDate;
          else
             S = RepaymentDate - BuyDate;
          end;
       elif(bnr_BCTermFormula == VS_TERMF_DURING) //¢Æ ·‚Æ´Ï™Æ-‚Æ ¢‡•¨•≠® Æ‚ Ø‡•§ÍÔ¢´•≠®Ô
          S = RepaymentDate - BuyDate;
       end;
       if((BuyCost == 0) OR (S == 0))
          RateD = 0;
       else
          RateD = (Principal - BuyCost) * 100 / BuyCost / S;
       end;
       RateD = round(double(RateD), RATE_PREC);
    end;
    if((leg_Formula == VS_IN_S_PC) or (leg_Formula == VS_IN_M_PC) or (leg_Formula == VS_IN_DISC_PC))
       RateP = DL_VAGetBnrRateOnDate(BCID, BuyDate) / pow(10, leg_Point);
       RateP = round(double(RateP), RATE_PREC);
    end;
    if(leg_Formula == VS_IN_DISCONT)
       Rate = RateD;
    else
       Rate = RateP;
    end;

    //Ä7 - ‡†·Á•‚≠†Ô Ê•≠† ≠† §†‚„ ØÆ™„Ø™®
    CalcBuyCost = GetCalcBuyCost(IncomeDateType, Rate, BuyDate, RepaymentDate);

    //A8 - èÆ¢ÎË•≠®• 20%-£Æ Æ‚™´Æ≠•≠®Ô Ê•≠Î ØÆ™„Ø™® Æ‚ ‡†·Á•‚≠Æ© Ê•≠Î
    if(BuyCost > (1.0 + CostExceed)*CalcBuyCost)
      BuyCostExcess = (1.0 + CostExceed)*CalcBuyCost - BuyCost;
    end;

    // A16 ¢‡•¨Ô ≠†ÂÆ¶§•≠®Ô ¢ ØÆ‡‚‰•´•
    if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE) and (BuyDate < dateB))
       A16 = _SaleDate - BuyDate;
    else
       if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE))
          A16 = _SaleDate - Max(dateB, BuyDate);
       else
          A16 = dateE - Max(dateB, BuyDate);
       end;
    end;

    // A19 - ë„¨¨† §®·™Æ≠‚† ‡†·Á•‚≠†Ô
    if(leg_Formula == VS_IN_DISCONT)
       A19 = BuyCost * Rate * A16 / 100;
    elif(leg_Formula == VS_IN_S_PC)
       A19 = Principal * Rate * A16 / 100 / 365;
    end;

    // A20 - ê†·Á•‚≠†Ô Ê•≠† ≠† §†‚„ ‡•†´®ß†Ê®®
    if (SaleDate != null)
      A20 = GetCalcSaleCost(IncomeDateType, Principal, Rate, SaleDate, RepaymentDate);
    end;

    // A21 - è‡•¢ÎË•≠®• 20%-£Æ Æ‚™´Æ≠•≠®Ô Ê•≠Î ‡•†´®ß†Ê®® Æ‚ ‡†·-Á•‚≠Æ© Ê•≠Î
    if ((A20 != "") and (SaleCost != ""))
      if (SaleCost < A20 * (1 - CostExceed))
        A21 = A20 * (1 - CostExceed) - SaleCost;
      end;
    end;

    // A22 - Ç≠•‡•†´®ß†Ê®Æ≠≠Î• §ÆÂÆ§Î
    if( (ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE) AND (DocKind == DL_VAENWR)  )
       A22 = SaleCost - BuyCost;
    elif((ValType(_SaleDate) != V_DATE) OR (_SaleDate > dateE))
       A22 = A19;
    end;

    // A23 - ÑÆÂÆ§ Æ‚ ‡•†´®ß†Ê®®
    if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE) AND ((DocKind == DL_VEKSELACCOUNTED) OR (DocKind == DL_VAREPAY)) )
        if(A21 != "")
          X = (1.0 - CostExceed)*A20;
        else
          X = SaleCost;
        end;

        if(BuyCostExcess != "")
          Y = (1.0 + CostExceed)*CalcBuyCost;
        else
          Y = BuyCost;
        end;

        A23 = X - Y;
    end;

    // A24 - Ç≠•‡•†´®ß†Ê®Æ≠≠Î© ‡†·ÂÆ§
    if((ValType(_SaleDate) == V_DATE) AND (_SaleDate <= dateE) and (BuyDate < dateB) AND
       ((DocKind == DL_VEKSELACCOUNTED) OR (DocKind == DL_VATRUST) OR (DocKind==DL_VAREPAY) OR (DocKind==DL_VAENWR)))
       A24 = GetNonOpExpense(IncomeDateType, BuyCost, Principal, RateD, RateP, dateB, BuyDate);
    end;

    if(t1 AND (bnr_Issuer == tick_PartyID))
       VaProfit_tmp.rec.FromIssuer = "X";
    end;
    if(t2 AND (isBank(bnr_Issuer)))
       VaProfit_tmp.rec.IssuerKind = "X";
    end;
    if(t3)
       if(isBill)
         VaProfit_tmp.rec.PeriodOfRepayment = Int( SubStr (Account, 4, 2 ) );
       else
         //§•Ø.·•‡‚

         äÆ´¢ÆÑ≠•© = leg_Maturity - leg_Start;

         if((äÆ´¢ÆÑ≠•© >= 0) and (äÆ´¢ÆÑ≠•© <= 30))
            VaProfit_tmp.rec.PeriodOfRepayment = 1;
         elif((äÆ´¢ÆÑ≠•© >=31) and (äÆ´¢ÆÑ≠•© <= 90))
            VaProfit_tmp.rec.PeriodOfRepayment = 2;
         elif((äÆ´¢ÆÑ≠•© >= 91) and (äÆ´¢ÆÑ≠•© <= 180))
            VaProfit_tmp.rec.PeriodOfRepayment = 3;
         elif((äÆ´¢ÆÑ≠•© >= 181) and (äÆ´¢ÆÑ≠•© <= 365))
            VaProfit_tmp.rec.PeriodOfRepayment = 4;
         elif((äÆ´¢ÆÑ≠•© > 365))
            VaProfit_tmp.rec.PeriodOfRepayment = 5;
         end;
       end;
    end;
    VaProfit_tmp.rec.IsDiscount = string(leg_Formula);
    if(t5)
       if((bnr_BCTermFormula == VS_TERMF_ATSIGHT) AND (leg_Maturity >= leg_Start))  //ØÆ Ø‡•§ÍÔ¢´•≠®®, ≠Æ ≠• ‡†≠••
          VaProfit_tmp.rec.TermNumber = 2;
       elif(bnr_BCTermFormula == VS_TERMF_ATSIGHT) //ØÆ Ø‡•§ÍÔ¢´•≠®® (Æ·‚†´Ï≠Î•)
          VaProfit_tmp.rec.TermNumber = 1;
       elif((bnr_BCTermFormula == VS_TERMF_FIXEDDAY) OR (bnr_BCTermFormula == VS_TERMF_INATIME)) // ·‡ÆÁ≠Î•
          VaProfit_tmp.rec.TermNumber = 3;
       elif(bnr_BCTermFormula == VS_TERMF_DURING) // ÇÆ ·‚Æ´Ï™Æ-‚Æ ¢‡•¨•≠® Æ‚ Ø‡•§ÍÔ¢´•≠®Ô
          VaProfit_tmp.rec.TermNumber = 4;
       end;
    end;
    VaProfit_tmp.rec.Principal = Principal;
    VaProfit_tmp.rec.BuyCost = BuyCost;
    VA_GetABCStatusOnDate(BCID, dateE, ABCstatus);
    if( (DocKind == DL_VAENWR) )
       VaProfit_tmp.rec.BuyCost_GO = BuyCost;
    end;
    if(SaleCost != "")
       VaProfit_tmp.rec.SaleCost = SaleCost;
       if( (DocKind == DL_VAENWR) )
          VaProfit_tmp.rec.SaleCost_GO = SaleCost;
       end;
    end;

    BCNumber = Trim(BCNumber);

     if(A19 != "")
       if(A19/pow(10, 15) > 1)
          msg = "è•‡•ØÆ´≠•≠®• §•≠•¶≠Æ£Æ ‚®Ø†.|å†™·®¨†´Ï≠†Ô ‡†ß‡Ô§≠Æ·‚Ï - 15 ß≠†™Æ¢.|(èÆ´•: \"ë„¨¨† §®·™Æ≠‚† ‡†·Á•‚≠†Ô\".)";
          msg = msg + "|çÆ¨•‡ Ê/°: " + BCNumber;
          repErrLog.LogError(msg);
       else
          VaProfit_tmp.rec.Discount = A19;
       end;
    end;
    if(A20 != "")
       if(A20/pow(10, 15) > 1)
          msg = "è•‡•ØÆ´≠•≠®• §•≠•¶≠Æ£Æ ‚®Ø†.|å†™·®¨†´Ï≠†Ô ‡†ß‡Ô§≠Æ·‚Ï - 15 ß≠†™Æ¢.|(èÆ´•: \"ê†·ÁÒ‚≠†Ô Ê•≠† ≠† §†‚„ ‡•†´®ß†Ê®®\".)";
          msg = msg + "|çÆ¨•‡ Ê/°: " + BCNumber;
          repErrLog.LogError(msg);
       else
          VaProfit_tmp.rec.CalcSaleCost = A20;
       end;
    end;
    if(A21 != "")
       if(A21/pow(10, 15) > 1)
          msg = "è•‡•ØÆ´≠•≠®• §•≠•¶≠Æ£Æ ‚®Ø†.|å†™·®¨†´Ï≠†Ô ‡†ß‡Ô§≠Æ·‚Ï - 15 ß≠†™Æ¢.|(èÆ´•: \"è‡•¢ÎË•≠®• 20%-£Æ Æ‚™´Æ≠•≠®Ô Ê•≠Î ‡•†´®ß†Ê®® Æ‚ ‡†·ÁÒ‚≠Æ© Ê•≠Î\".)";
          msg = msg + "|çÆ¨•‡ Ê/°: " + BCNumber;
          repErrLog.LogError(msg);
       else
          VaProfit_tmp.rec.SaleCostExcess = A21;
       end;
    end;
    if(A22 != "")
       if(A22/pow(10, 15) > 1)
          msg = "è•‡•ØÆ´≠•≠®• §•≠•¶≠Æ£Æ ‚®Ø†.|å†™·®¨†´Ï≠†Ô ‡†ß‡Ô§≠Æ·‚Ï - 15 ß≠†™Æ¢.|(èÆ´•: \"Ç≠•‡•†´®ß†Ê®Æ≠≠Î• §ÆÂÆ§Î\".)";
          msg = msg + "|çÆ¨•‡ Ê/°: " + BCNumber;
          repErrLog.LogError(msg);
       else
          VaProfit_tmp.rec.NonSaleProfit = A22;
       end;
    end;
    if(A23 != "")
       if(A23/pow(10, 15) > 1)
          msg = "è•‡•ØÆ´≠•≠®• §•≠•¶≠Æ£Æ ‚®Ø†.| å†™·®¨†´Ï≠†Ô ‡†ß‡Ô§≠Æ·‚Ï - 15 ß≠†™Æ¢.|(èÆ´•: \"ÑÆÂÆ§ Æ‚ ‡•†´®ß†Ê®®\".)";
          msg = msg + "|çÆ¨•‡ Ê/°: " + BCNumber;
          repErrLog.LogError(msg);
       else
          VaProfit_tmp.rec.SaleProfit = A23;
       end;
    end;
    if(A24 != "")
       if(A24/pow(10, 15) > 1)
          msg = "è•‡•ØÆ´≠•≠®• §•≠•¶≠Æ£Æ ‚®Ø†.|å†™·®¨†´Ï≠†Ô ‡†ß‡Ô§≠Æ·‚Ï - 15 ß≠†™Æ¢.|(èÆ´•: \"Ç≠•‡•†´®ß†Ê®Æ≠≠Î• ‡†·ÂÆ§Î\".)";
          msg = msg + "|çÆ¨•‡ Ê/°: " + BCNumber;
          repErrLog.LogError(msg);
       else
          VaProfit_tmp.rec.NonSaleCharge = A24;
       end;
    end;

    if (SaleDate == null)       SaleDate = zero_date;       end;
    if (WriteOffDate == null)   WriteOffDate = zero_date;   end;

    VaProfit_tmp.rec.Account        = Account;
    VaProfit_tmp.rec.IssuerName     = Issuer;
    VaProfit_tmp.rec.BCSeries       = BCSeries;
    VaProfit_tmp.rec.BCNumber       = BCNumber;
    VaProfit_tmp.rec.BuyDate        = BuyDate;
    VaProfit_tmp.rec.DiscountRate   = RateD;
    VaProfit_tmp.rec.FactSaleDate   = SaleDate;
    VaProfit_tmp.rec.SignDate       = leg_start;
    VaProfit_tmp.rec.RepayDate      = RepaymentDate;
    VaProfit_tmp.rec.GOBalanceDate  = WriteOffDate;
    VaProfit_tmp.rec.BillHolding    = A16;
    VaProfit_tmp.rec.TaxDiscount    = RateP;
    VaProfit_tmp.rec.CalcBuyCost    = CalcBuyCost;
    VaProfit_tmp.rec.BuyCostExcess  = BuyCostExcess;
    VaProfit_tmp.rec.TermDate       = TermDate;

    VaProfit_tmp.insert;
    vaprofit_count = vaprofit_count + 1;
    total_count = total_count + 1;

END;

MACRO UniRunReport(period, year, year_run, range, l1, t1, t2, t3, t4, t5, t8, mode)
VAR ok = true, eod = true, in_period,
    rs, cmd, ap = t8, mod_ap = "", mod = "",  AccDate, CurFilter = "",
    div = true, // ØÆ „¨Æ´Á†≠®Ó - ÂÆ‚Ô °Î Æ§≠Æ ‡†ß°®•≠®• ≠† ‡†ß§•´Î
    sqlSource,
    count, progr = 0, FindAcc = TRecHandler("account.dbt" );

    if (ap)
        mod_ap = "a:";
    end;

    VaProfit_tmp = Tbfile("vaprofit.tmp", "W");
    if(VaProfit_tmp == null)
       return 1;
    end;

    cmd = RSDCommand("TRUNCATE TABLE dvaprofit_tmp");
    cmd.Execute();

    if((not t1) AND (not t2) AND (not t3) AND (not t4) AND (not t5))
       div = false;
    end;

    if(range == 2)
       CurFilter = String(" AND leg.t_PFI = ", NATCUR);
    elif(range == 3)
       CurFilter = String(" AND leg.t_PFI != ", NATCUR);
    end;

    /*** îÆ‡¨®‡„•¨ ¢‡•¨•≠≠Î© ‰†©´ ***/
    sqlSource = " from dpmpaym_dbt paym, dvsbanner_dbt ban, ddl_leg_dbt leg, ddl_tick_dbt tick, dvsordlnk_dbt lnk, " +
           "doprkoper_dbt oprk, dfininstr_dbt fin, dvsbnrbck_dbt bck ";

    sqlSource = sqlSource +
                "where " +
                " tick.t_BOfficeKind IN("+DL_VEKSELACCOUNTED+","+DL_VAREPAY+", "+DL_VAENWR+") AND "+
                " paym.t_DocKind = tick.t_BOfficeKind AND " +
                " paym.t_DocumentID = tick.t_DealID AND " +
                " paym.t_ValueDate <= "+GetSQLDate(dateE)+" AND ";

    sqlSource = sqlSource +
       "( (oprk.T_SYSTYPES LIKE '%B%' AND lnk.t_LinkKind = 1 AND paym.t_Purpose = 1) OR " +
         "(oprk.T_SYSTYPES LIKE '%B%' AND lnk.t_LinkKind = 0 AND paym.t_Purpose = 3) OR " +
         "(oprk.T_SYSTYPES LIKE '%S%' AND lnk.t_LinkKind = 0 AND paym.t_Purpose = 1) OR " +
         "(oprk.T_SYSTYPES LIKE '%S%' AND lnk.t_LinkKind = 1 AND paym.t_Purpose = 3) OR " +
         "(lnk.t_LinkKind = 0 AND paym.t_Purpose = 10) OR " +
         "(oprk.T_SYSTYPES LIKE '%X%' AND lnk.t_LinkKind = 0 AND paym.t_Purpose = 1) OR " +
         "(oprk.T_SYSTYPES LIKE '%X%' AND lnk.t_LinkKind = 1 AND paym.t_Purpose = 2) " +
         ") AND " +
    "paym.t_PaymStatus >= 3000 AND ";

    sqlSource = sqlSource + " tick.T_CLIENTID <= 0 AND ";

    sqlSource = sqlSource +
    "oprk.t_Kind_Operation = tick.t_DealType AND " +
    "(paym.t_FIID = ban.T_FIID OR paym.t_Purpose = 10) AND " +
    "ban.t_Issuer NOT IN (select t_PartyID from ddp_dep_dbt) AND " +
    "rsb_bill.GetVABnrClientOnDate(ban.t_BCID, "+GetSQLDate(dateE)+") = -1 AND "
    "leg.t_LegKind = 1 and leg.t_DealID = ban.t_BCID AND leg.t_LegID = 0 " + CurFilter + " AND " +
    "lnk.t_ContractID = tick.t_DealID AND lnk.t_DocKind = tick.t_BOfficeKind AND ban.t_BCID = lnk.t_BCID AND " +
    "fin.t_FIID = ban.t_FIID";

    if(isBill)
      sqlSource = sqlSource + " AND ban.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE
                            + " AND fin.t_AvoirKind = " + AVOIRISSKIND_BILL;
    else
      sqlSource = sqlSource + " AND ban.t_BCFormKind = " + VSBANNER_FORMKIND_CERT
                            + " AND fin.t_AvoirKind = " + AVOIRISSKIND_DEPOSIT_CERTIFICATE;
    end;

    sqlSource = sqlSource + " AND bck.t_bcid = ban.t_bcid AND bck.t_changedate = paym.t_valuedate "
                          + " AND ( (lnk.t_linkkind = 1 AND bck.t_oldabcstatus = 0 AND bck.t_newabcstatus > 0) OR (lnk.t_linkkind = 0 AND bck.t_oldabcstatus = 100)) ";

    cmd = RSDCommand("SELECT count(*) " + sqlSource);
    rs = RSDRecordset(cmd);
    cmd.Execute();
    rs.MoveNext();

    count = rs.value(0, NULL, V_INTEGER);

    cmd.CmdText = "select ban.t_IssuerName, "+   //0
                  "tick.t_PartyID, " +           //1
                  "ban.t_Issuer, " +             //2
                  "ban.t_BCNumber, " +           //3
                  "ban.t_BCSeries, " +           //4
                  "ban.t_RepaymentDate, " +      //5
                  "ban.t_BCPresentationDate, " + //6
                  "ban.t_BCState, " +            //7
                  "ban.t_BCTermFormula, " +      //8
                  "ban.t_BCTermFormat, " +       //9
                  "leg.t_Principal, " +          //10
                  "leg.t_PFI, " +                //11
                  "leg.t_Start, " +              //12
                  "leg.t_Maturity, " +           //13
                  "leg.t_Expiry, " +             //14
                  "leg.t_Diff, " +               //15
                  "leg.t_Price, " +              //16
                  "leg.t_Basis, " +              //17
                  "leg.t_Formula, " +            //18
                  "leg.t_Point, " +              //19
                  "leg.t_InterestStart, " +      //20
                  "paym.t_ValueDate, " +         //21
                  "lnk.t_BCCost, " +             //22
                  "lnk.t_BCCFI, " +              //23
                  "ban.t_BCID, " +               //24
                  "lnk.t_LinkKind, " +           //25
                  "paym.t_PaymentID, " +         //26
                  "paym.t_DocKind  " +           //27

    sqlSource +
    "order by ban.t_BCSeries, ban.t_BCNumber, ban.t_BCID, paym.t_ValueDate, bck.t_ID";

    cmd.execute;
    rs = TRsbDataSet(cmd);

    ok = rs.MoveNext();

var i = 0,
    Account, Issuer, BuyDate, BuyCost, BuyFI, SaleDate, SaleCost, SaleFI,
    bnr_BCNumber, bnr_BCSeries, bnr_RepaymentDate, bnr_BCPresentationDate,
    bnr_BCState, bnr_BCTermFormula, bnr_BCTermFormat, bnr_Issuer, tick_PartyID,
    leg_Principal, leg_PFI, leg_Start, leg_Maturity, leg_Expiry, leg_Diff, leg_Price, leg_Basis, leg_Formula, leg_Point,
    leg_InterestStart, BCID, DocKind, lnk_LinkKind1, lnk_LinkKind2;

    VA_Rep_InitProgress(count, "é°‡†°Æ‚™† Ê•≠≠ÎÂ °„¨†£");

    vaprofit_count = 0;

    while(ok)
       i = 0;
       eod = false;
// PARTY
       Issuer       = rs.value(i, null, V_STRING);  i = i + 1;             //0
       tick_PartyID = rs.value(i, null, V_INTEGER); i = i + 1;             //1
// VSBANNER
       bnr_Issuer             = rs.value(i, null, V_INTEGER); i = i + 1;   //2
       bnr_BCNumber           = rs.value(i, null, V_STRING);  i = i + 1;   //3
       bnr_BCSeries           = rs.value(i, null, V_STRING);  i = i + 1;   //4
       bnr_RepaymentDate      = rs.value(i, null, V_DATE);    i = i + 1;   //5
       bnr_BCPresentationDate = rs.value(i, null, V_DATE);    i = i + 1;   //6
       bnr_BCState            = rs.value(i, null, V_STRING);  i = i + 1;   //7
       bnr_BCTermFormula      = rs.value(i, null, V_INTEGER); i = i + 1;   //8
       bnr_BCTermFormat       = rs.value(i, null, V_INTEGER); i = i + 1;   //9
// DL_LEG
       leg_Principal     = rs.value(i, null, V_MONEY);      i = i + 1;     //10
       leg_PFI           = rs.value(i, null, V_DOUBLE);     i = i + 1;     //11
       leg_Start         = date(rs.value(i, null, V_DATE)); i = i + 1;     //12
       leg_Maturity      = rs.value(i, null, V_DATE);       i = i + 1;     //13
       leg_Expiry        = date(rs.value(i, null, V_DATE)); i = i + 1;     //14
       leg_Diff          = rs.value(i, null, V_DOUBLE);     i = i + 1;     //15
       leg_Price         = rs.value(i, null, V_DOUBLE);     i = i + 1;     //16
       leg_Basis         = rs.value(i, null, V_INTEGER);    i = i + 1;     //17
       leg_Formula       = rs.value(i, null, V_INTEGER);    i = i + 1;     //18
       leg_Point         = rs.value(i, null, V_INTEGER);    i = i + 1;     //19
       leg_InterestStart = rs.value(i, null, V_DATE);       i = i + 1;     //20
// PM_PAYM
       BuyDate       = rs.value(i, null, V_DATE);   i = i + 1;             //21
// VSORDLNK
       BuyCost       = rs.value(i, null, V_MONEY);   i = i + 1;            //22
       BuyFI         = rs.value(i, null, V_INTEGER); i = i + 1;            //23
       BCID          = rs.value(i, null, V_INTEGER); i = i + 1;            //24
       lnk_LinkKind1 = rs.value(i, null, V_INTEGER); i = i + 1;            //25

      if(lnk_LinkKind1 == 1) // •·´® ®§•‚ ØÆ™„Ø™† VSORDLNK_K_DRAW
       ok = rs.MoveNext; //† ß† ≠•© ¨Æ¶•‚ ®§‚® Ø‡Æ§†¶† VSORDLNK_K_SALE
       in_period = true;
       if(ok AND (BCID == rs.value(24, null, V_INTEGER)))
          i = 21;
          SaleDate   = rs.value(i, null, V_DATE);    i = i + 1;   //21
          SaleCost   = rs.value(i, null, V_MONEY);   i = i + 1;   //22
          SaleFI     = rs.value(i, null, V_INTEGER); i = i + 1;   //23
          DocKind    = rs.value(i+3, null, V_INTEGER);            //27
          if(SaleDate <= dateB)
             in_period = false;
          end;
       else
          eod = true;
          SaleDate   = "";
          SaleCost   = "";
          SaleFI     = "";
          DocKind    = 0;
       end;
       if(in_period)
          // A1
          if((ValType(SaleDate) == V_DATE) AND (SaleDate <= dateE))
             AccDate = SaleDate;
          else
             AccDate = dateE;
          end;

          bnrfd = VSBannerFD(DL_VSBANNER, BCID);
          VA_GetAccount("ìÁ‚•≠≠Î• ¢•™·•´Ô", bnrfd, Account, MC_OPENACC_ACT, bnrfd.éØ‡•§•´®‚ÏÇ†´Ó‚„ìÁ•‚†(), null, null, AccDate);

          PrintReportLine(ap, t1, t2, t3, t4, t5,
                          Account, Issuer, BuyDate, BuyCost, BuyFI, SaleDate, SaleCost, SaleFI,
                          bnr_BCNumber, bnr_BCSeries, bnr_RepaymentDate, bnr_BCPresentationDate,
                          bnr_BCState, bnr_BCTermFormula, bnr_BCTermFormat,
                          leg_Principal, leg_PFI, date(leg_Start), date(leg_Maturity), leg_Expiry, leg_Diff,
                          leg_Price, leg_Basis, leg_Formula, leg_Point, leg_InterestStart, DocKind,
                          BCID, bnr_Issuer, tick_PartyID);
       end; // if(in_period)
      END; // if(lnk_LinkKind1 == 1)

      UseProgress(progr = progr + 1);

      if(eod == false)
         ok = rs.MoveNext;
      end;

    end;

    RemProgress();

    var s0F4, s0F6, s0F61, s0F7, s0F8, s0F11, s0F111, s0F19, s0F20, s0F21, s0F22, s0F23, s0F24,
        s1F4, s1F6, s1F61, s1F7, s1F8, s1F11, s1F111, s1F19, s1F20, s1F21, s1F22, s1F23, s1F24,
        s2F4, s2F6, s2F61, s2F7, s2F8, s2F11, s2F111, s2F19, s2F20, s2F21, s2F22, s2F23, s2F24,
        s3F4, s3F6, s3F61, s3F7, s3F8, s3F11, s3F111, s3F19, s3F20, s3F21, s3F22, s3F23, s3F24,
        s4F4, s4F6, s4F61, s4F7, s4F8, s4F11, s4F111, s4F19, s4F20, s4F21, s4F22, s4F23, s4F24,
        s5F4, s5F6, s5F61, s5F7, s5F8, s5F11, s5F111, s5F19, s5F20, s5F21, s5F22, s5F23, s5F24,
        level1 = true, level2 = true,  level3 = true,  level4 = true,  level5 = true,
        n_t1 = 0, n_t2 = 0, n_t3 = 0, n_t4 = 0, n_t5 = 0,
        Delim = " ", Filter1 = "", Filter2 = "", Filter3 = "", Filter4 = "", Filter5 = "",
        printed1 = false, printed2 = false, printed3 = false, printed4 = false, printed5 = false,
        SectionNames1 = TArray, SectionNames2 = TArray, SectionNames3 = TArray,
        SectionNames4 = TArray, SectionNames5 = TArray,
        spl_i;

    var tmp_counter = TRsbDataSet("select count(*) cnt from dvaprofit_tmp");
    tmp_counter.MoveNext;
    var VaProfit_tmp_nrecords = int(tmp_counter.cnt);
    var avoirkindstr = "";

    if(isBill)
      avoirkindstr = "Ç•™·•´Ô";
    else
      avoirkindstr = "Ñ•ØÆß®‚≠Î• ·•‡‚®‰®™†‚Î";
    end;
    if (vaprofit_count != 0)

    //****** ç†Á®≠†•¨ ¢Î¢Æ§ Æ‚Á•‚† ***********************************************************************

        PrintHeader(dateB, dateE, year, range);

        SectionNames1[0] = avoirkindstr+", ™„Ø´•≠≠Î• „ Ì¨®‚•≠‚Æ¢";
        SectionNames1[1] = avoirkindstr+", ™„Ø´•≠≠Î• „ ‚‡•‚Ï®Â ´®Ê";
        SectionNames2[0] = avoirkindstr+" ™‡•§®‚≠ÎÂ Æ‡£†≠®ß†Ê®©";
        SectionNames2[1] = avoirkindstr+" ≠•™‡•§®‚≠ÎÂ Æ‡£†≠®ß†Ê®©";
        if(isBill)
          SectionNames3[0] = avoirkindstr+" §Æ ¢Æ·‚‡•°Æ¢†≠®Ô";
          SectionNames3[1] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô §Æ 30 §≠•©";
          SectionNames3[2] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô Æ‚ 31 §≠Ô §Æ 90 §≠•©";
          SectionNames3[3] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô Æ‚ 91 §≠Ô §Æ 180 §≠•©";
          SectionNames3[4] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô Æ‚ 181 §≠Ô §Æ 1 £Æ§†";
          SectionNames3[5] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô ·¢ÎË• 1 £Æ§† §Æ 3 ´•‚";
          SectionNames3[6] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô ·¢ÎË• 3 ´•‚";
        else
          SectionNames3[0] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô §Æ 30 §≠•©";
          SectionNames3[1] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô Æ‚ 31 §≠Ô §Æ 90 §≠•©";
          SectionNames3[2] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô Æ‚ 91 §≠Ô §Æ 180 §≠•©";
          SectionNames3[3] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô Æ‚ 181 §≠Ô §Æ 1 £Æ§†";
          SectionNames3[4] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ ØÆ£†Ë•≠®Ô ·¢ÎË• 1 £Æ§† §Æ 3 ´•‚";
        end;

        SectionNames4[0] = "Ñ®·™Æ≠‚≠Î• ¢•™·•´Ô";
        SectionNames4[1] = "è‡ÆÊ•≠‚≠Î• ¢•™·•´Ô";
        SectionNames4[2] = "è‡ÆÊ•≠‚≠Æ-§®·™Æ≠‚≠Î• ¢•™·•´Ô";
        SectionNames5[0] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ \"èÆ Ø‡•§ÍÔ¢´•≠®®\"";
        SectionNames5[1] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ \"èÆ Ø‡•§ÍÔ¢´•≠®®, ≠Æ ≠• ‡†≠••\"";
        SectionNames5[2] = avoirkindstr+" ·‡ÆÁ≠Î•";
        SectionNames5[3] = avoirkindstr+" ·Æ ·‡Æ™Æ¨ \"ÇÆ ·‚Æ´Ï™Æ\-\‚Æ ¢‡•¨•≠® Æ‚ Ø‡•§ÍÔ¢´•≠®Ô\"";  //·´•Ë® Ø•‡•§ §•‰®·Æ¨ Æ°Ôß†‚•´Ï≠Î - °•ß ≠®Â Æ‚Á•‚ ‡†·ØÆ´ß†•‚·Ô

        progr = 0;
        VA_Rep_InitProgress(VaProfit_tmp_nrecords);

        s0F4 = s0F6 = s0F61 = s0F7 = s0F8 = s0F11 = s0F111 = s0F19 = s0F20 = s0F21 = s0F22 = s0F23 = s0F24 = $0;
        /*** Group I ***/
        while(level1)
          s1F4 = s1F6 = s1F61 = s1F7 = s1F8 = s1F11 = s1F111 = s1F19 = s1F20 = s1F21 = s1F22 = s1F23 = s1F24 = $0;
          printed1 = false;
          if(t1)
             if(n_t1 == 0)
                Filter1 = String("t_FromIssuer='X'");
             elif(n_t1 == 1)
                Filter1 = String("t_FromIssuer!='X'");
             end;
          end;
          /*** Group II ***/
          while(level2)
            s2F4 = s2F6 = s2F61 = s2F7 = s2F8 = s2F11 = s2F111 = s2F19 = s2F20 = s2F21 = s2F22 = s2F23 = s2F24 = $0;
            Filter2 = Filter1; printed2 = false;
            if(t2)
               if(Filter1 != "")
                  Delim = " AND ";
               else
                  Delim = " ";
               end;
               if(n_t2 == 0)
                  Filter2 = Filter1 + Delim + String("t_IssuerKind='X'");
               elif(n_t2 == 1)
                  Filter2 = Filter1 + Delim + String("t_IssuerKind!='X'");
               end;
            end;
            /*** Group III ***/
            while(level3)
              s3F4 = s3F6 = s3F61 = s3F7 = s3F8 = s3F11 = s3F111 = s3F19 = s3F20 = s3F21 = s3F22 = s3F23 = s3F24 = $0;
              Filter3 = Filter2; printed3 = false;
              if(t3)
                 if(Filter2 != "")
                    Delim = " AND ";
                 else
                    Delim = " ";
                 end;
                 Filter3 = Filter2 + Delim + String("t_PeriodOfRepayment=",n_t3+1);
              end;
              /*** Group IV ***/
              while(level4)
                s4F4 = s4F6 = s4F61 = s4F7 = s4F8 = s4F11 = s4F111 = s4F19 = s4F20 = s4F21 = s4F22 = s4F23 = s4F24 = $0;
                Filter4 = Filter3; printed4 = false;
                if(t4)
                   if(Filter3 != "")
                      Delim = " AND ";
                   else
                      Delim = " ";
                   end;
                   if(n_t4 == 0)
                      Filter4 = Filter3 + Delim + String("t_IsDiscount='"+VS_IN_DISCONT+"'");
                   elif(n_t4 == 1)
                      Filter4 = Filter3 + Delim + String("(t_IsDiscount='"+VS_IN_S_PC+"' OR t_IsDiscount='"+VS_IN_M_PC+"')");
                   elif(n_t4 == 2)
                      Filter4 = Filter3 + Delim + String("t_IsDiscount='"+VS_IN_DISC_PC+"'");
                   end;
                end;
                /*** Group V ***/
                while(level5)
                   s5F4 = s5F6 = s5F61 = s5F7 = s5F8 = s5F11 = s5F111 = s5F19 = s5F20 = s5F21 = s5F22 = s5F23 = s5F24 = $0;
                   Filter5 = Filter4; printed5 = false;
                   if(t5)
                      if(Filter4 != "")
                         Delim = " AND ";
                      else
                         Delim = " ";
                      end;
                      Filter5 = Filter4 + Delim + String("t_TermNumber=",n_t5+1);
                   end;
                   /*** ÇÎ¢Æ§ Æ‚Á•‚† ***/
                   VaProfit_tmp.AddFilter(Filter5);
                   VaProfit_tmp.KeyNum = 0;
                   VaProfit_tmp.rewind;

                   if(VaProfit_tmp_nrecords > 0)
                     if(t1 and (not printed1) ) PrintSection( SectionNames1[n_t1] ); printed1 = true; end;
                     if(t2 and (not printed2) ) PrintSection( SectionNames2[n_t2] ); printed2 = true; end;
                     if(t3 and (not printed3) ) PrintSection( SectionNames3[n_t3] ); printed3 = true; end;
                     if(t4 and (not printed4) ) PrintSection( SectionNames4[n_t4] ); printed4 = true; end;
                     if(t5) PrintSection( SectionNames5[n_t5] ); printed5 = true; end;

                     while(VaProfit_tmp.next)
                        s5F4 = s5F4 + round(VaProfit_tmp.rec.Principal,2);
                        s5F6 = s5F6 + round(VaProfit_tmp.rec.BuyCost,2);

                        if(date(VaProfit_tmp.rec.FactSaleDate) > date(0,0,0)) //‚Æ´Ï™Æ •·´® „Á•‚≠Î© Ø•‡®Æ§ §´Ô ¢•™·•´Ô ß†™‡Î‚
                          s5F61 = s5F61 + round(VaProfit_tmp.rec.BuyCost,2) - round(VaProfit_tmp.rec.BuyCost_GO,2);
                        end;

                        s5F7 = s5F7 + round(VaProfit_tmp.rec.CalcBuyCost,2);
                        s5F8 = s5F8 + round(VaProfit_tmp.rec.BuyCostExcess,2);

                        s5F11 = s5F11 + round(VaProfit_tmp.rec.SaleCost,2);

                        s5F111 = s5F111 + round(VaProfit_tmp.rec.SaleCost,2) - round(VaProfit_tmp.rec.SaleCost_GO,2);

                        s5F19 = s5F19 + round(VaProfit_tmp.rec.Discount,2);
                        s5F20 = s5F20 + round(VaProfit_tmp.rec.CalcSaleCost,2);
                        s5F21 = s5F21 + round(VaProfit_tmp.rec.SaleCostExcess,2);
                        s5F22 = s5F22 + round(VaProfit_tmp.rec.NonSaleProfit,2);
                        s5F23 = s5F23 + round(VaProfit_tmp.rec.SaleProfit,2);
                        s5F24 = s5F24 + round(VaProfit_tmp.rec.NonSaleCharge,2);

                        mod = mod_ap + "r";
                        rep.AddPrintCell(VaProfit_tmp.rec.Account);
                        rep.AddPrintCell(VaProfit_tmp.rec.IssuerName);
                        rep.AddPrintCell(VaProfit_tmp.rec.BCNumber,               null, null, "ex_B(BTL)");
                        rep.AddPrintCell(VaProfit_tmp.rec.BCSeries,               null, null, "ex_B(BTR)");
                        rep.AddPrintCell(VaProfit_tmp.rec.Principal,              null, null, mod);
                        rep.AddPrintCell(date_as_str(VaProfit_tmp.rec.BuyDate), null, null, "c");
                        rep.AddPrintCell(VaProfit_tmp.rec.BuyCost,                null, null, mod);
                        rep.AddPrintCell(VaProfit_tmp.rec.CalcBuyCost,            null, null, mod);
                        rep.AddPrintCell(VaProfit_tmp.rec.BuyCostExcess,          null, null, mod);
                        if(VaProfit_tmp.rec.IsDiscount == VS_IN_DISCONT)
                          rep.AddPrintCell(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(double(VaProfit_tmp.rec.DiscountRate), RATE_PREC), null, null, mod);
                        elif((VaProfit_tmp.rec.IsDiscount == VS_IN_S_PC)
                          or (VaProfit_tmp.rec.IsDiscount == VS_IN_M_PC))
                          rep.AddPrintCell(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(double(VaProfit_tmp.rec.TaxDiscount), RATE_PREC), null, null, mod);
                        elif(VaProfit_tmp.rec.IsDiscount == VS_IN_DISC_PC)
                          rep.AddPrintCell(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(double(VaProfit_tmp.rec.DiscountRate), RATE_PREC)
                                 + "/" + ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(double(VaProfit_tmp.rec.TaxDiscount), RATE_PREC), null, null, mod);
                        else
                          rep.AddPrintCell(" ");
                        end;
                        rep.AddPrintCell(date_as_str(VaProfit_tmp.rec.FactSaleDate), null, null, "c");
                        rep.AddPrintCell(VaProfit_tmp.rec.SaleCost,               null, null, mod);
                        rep.AddPrintCell(date_as_str(VaProfit_tmp.rec.SignDate), null, null, "c");
                        rep.AddPrintCell(date_as_str(VaProfit_tmp.rec.RepayDate), null, null, "c");
                        if(isBill)
                          rep.AddPrintCell(date_as_str(VaProfit_tmp.rec.TermDate), null, null, "c");
                        end;
                        rep.AddPrintCell(date_as_str(VaProfit_tmp.rec.GOBalanceDate), null, null, "c");
                        rep.AddPrintCell(VaProfit_tmp.rec.BillHolding,            null, null, mod);
                        if(isBill)
                          rep.AddPrintCell(" ");
                          if(VaProfit_tmp.rec.IsDiscount == VS_IN_DISCONT)
                            rep.AddPrintCell(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(double(VaProfit_tmp.rec.DiscountRate), RATE_PREC), null, null, mod);
                          elif((VaProfit_tmp.rec.IsDiscount == VS_IN_S_PC)
                            or (VaProfit_tmp.rec.IsDiscount == VS_IN_M_PC)
                            or (VaProfit_tmp.rec.IsDiscount == VS_IN_DISC_PC))
                            rep.AddPrintCell(ó®·´ÆCá†§†≠≠Æ©íÆÁ≠Æ·‚ÏÓ(double(VaProfit_tmp.rec.TaxDiscount), RATE_PREC), null, null, mod);
                          else
                            rep.AddPrintCell(" ");
                          end;
                          rep.AddPrintCell(VaProfit_tmp.rec.Discount,               null, null, mod);
                        end;
                        rep.AddPrintCell(VaProfit_tmp.rec.CalcSaleCost,           null, null, mod);
                        rep.AddPrintCell(VaProfit_tmp.rec.SaleCostExcess,         null, null, mod);
                        rep.AddPrintCell(VaProfit_tmp.rec.NonSaleProfit,          null, null, mod);
                        rep.AddPrintCell(VaProfit_tmp.rec.SaleProfit,             null, null, mod);
                        rep.AddPrintCell(VaProfit_tmp.rec.NonSaleCharge,          null, null, mod);
                        rep.AddStr();

                        UseProgress(progr = progr + 1);
                     end;
                   end;
                   VaProfit_tmp.DropFilter();

                   /*****************/
                   /*** Footer V ***/
                   if(t5)
                      if(printed5)
                        PrintFootSection(ap, SectionNames5[n_t5], s5F4, s5F6, s5F61, s5F7, s5F8, s5F11, s5F111, s5F19, s5F20, s5F21, s5F22, s5F23, s5F24);
                      end;
                      n_t5 = n_t5 + 1;
                      level5 = (n_t5 < 4);
                   else
                      level5 = false;
                   end;
                   s4F4 = s4F4 + s5F4;    s4F6 = s4F6 + s5F6;       s4F61 = s4F61 + s5F61;
                   s4F7 = s4F7 + s5F7;    s4F8 = s4F8 + s5F8;
                   s4F11 = s4F11 + s5F11; s4F111 = s4F111 + s5F111; s4F19 = s4F19 + s5F19;
                   s4F20 = s4F20 + s5F20; s4F21 = s4F21 + s5F21;    s4F22 = s4F22 + s5F22;
                   s4F23 = s4F23 + s5F23; s4F24 = s4F24 + s5F24;
               end;
               /*** Footer IV ***/
               level5 = true; n_t5 = 0;
               if(t4)
                  if(printed4)
                     PrintFootSection(ap, SectionNames4[n_t4], s4F4, s4F6, s4F61, s4F7, s4F8, s4F11, s4F111, s4F19, s4F20, s4F21, s4F22, s4F23, s4F24);
                  end;
                  n_t4 = n_t4 + 1;
                  level4 = (n_t4 < 3);
               else
                  level4 = false;
               end;
               s3F4 = s3F4 + s4F4;    s3F6 = s3F6 + s4F6;    s3F61 = s3F61 + s4F61;
               s3F7 = s3F7 + s4F7;    s3F8 = s3F8 + s4F8;
               s3F11 = s3F11 + s4F11;    s3F111 = s3F111 + s4F111; s3F19 = s3F19 + s4F19;
               s3F20 = s3F20 + s4F20; s3F21 = s3F21 + s4F21; s3F22 = s3F22 + s4F22;
               s3F23 = s3F23 + s4F23; s3F24 = s3F24 + s4F24;
             end;
             /*** Footer III ***/
             level4 = true; n_t4 = 0;
             if(t3)
                if(printed3)
                   PrintFootSection(ap, SectionNames3[n_t3], s3F4, s3F6, s3F61, s3F7, s3F8, s3F11, s3F111, s3F19, s3F20, s3F21, s3F22, s3F23, s3F24);
                end;
                n_t3 = n_t3 + 1;
                if(isBill)
                  level3 = (n_t3 < 7);
                else
                  level3 = (n_t3 < 5);
                end;
             else
                level3 = false;
             end;
             s2F4 = s2F4 + s3F4;    s2F6 = s2F6 + s3F6;    s2F61 = s2F61 + s3F61;
             s2F7 = s2F7 + s3F7;    s2F8 = s2F8 + s3F8;
             s2F11 = s2F11 + s3F11;    s2F111 = s2F111 + s3F111; s2F19 = s2F19 + s3F19;
             s2F20 = s2F20 + s3F20; s2F21 = s2F21 + s3F21; s2F22 = s2F22 + s3F22;
             s2F23 = s2F23 + s3F23; s2F24 = s2F24 + s3F24;
           end;
           /*** Footer II ***/
           level3 = true; n_t3 = 0;
           if(t2)
              if(printed2)
                 PrintFootSection(ap, SectionNames2[n_t2], s2F4, s2F6, s2F61, s2F7, s2F8, s2F11, s2F111, s2F19, s2F20, s2F21, s2F22, s2F23, s2F24);
              end;
              n_t2 = n_t2 + 1;
              level2 = (n_t2 < 2);
           else
              level2 = false;
           end;
           s1F4 = s1F4 + s2F4;    s1F6 = s1F6 + s2F6;    s1F61 = s1F61 + s2F61;
           s1F7 = s1F7 + s2F7;    s1F8 = s1F8 + s2F8;
           s1F11 = s1F11 + s2F11;    s1F111 = s1F111 + s2F111; s1F19 = s1F19 + s2F19;
           s1F20 = s1F20 + s2F20; s1F21 = s1F21 + s2F21; s1F22 = s1F22 + s2F22;
           s1F23 = s1F23 + s2F23; s1F24 = s1F24 + s2F24;
         end;
         /*** Footer I ***/
         level2 = true; n_t2 = 0;
         if(t1)
            if(printed1)
               PrintFootSection(ap, SectionNames1[n_t1], s1F4, s1F6, s1F61, s1F7, s1F8, s1F11, s1F111, s1F19, s1F20, s1F21, s1F22, s1F23, s1F24);
            end;
            n_t1 = n_t1 + 1;
            level1 = (n_t1 < 2);
         else
            level1 = false;
         end;
         s0F4 = s0F4 + s1F4;    s0F6 = s0F6 + s1F6;    s0F61 = s0F61 + s1F61;
         s0F7 = s0F7 + s1F7;    s0F8 = s0F8 + s1F8;
         s0F11 = s0F11 + s1F11;    s0F111 = s0F111 + s1F111; s0F19 = s0F19 + s1F19;
         s0F20 = s0F20 + s1F20; s0F21 = s0F21 + s1F21; s0F22 = s0F22 + s1F22;
         s0F23 = s0F23 + s1F23; s0F24 = s0F24 + s1F24;
       end;

       PrintFootAll(ap, s0F4, s0F6, s0F61, s0F7, s0F8, s0F11, s0F111, s0F19, s0F20, s0F21, s0F22, s0F23, s0F24);
       after_44_footer_nobook(rep);

       RemProgress();

   end; //if (vaprofit_count != 0)

   return 0;
END;

MACRO RunReport(period, year, year_run, range, l1, t1, t2, t3, t4, t5, t8, mode)

  var DataSet, query;
  var stat = 0, cnt=0;
  var ReportFileName, TblName = "vaprfrpt", errcode, errtext;
  file ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/

  isBill = (not l1);
  Dl_CallInsertStat( IIF( mode == 2, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
  if(isBill)
    rep = CVAMakeReport(headBill);
  else
    rep = CVAMakeReport(headCert);
  end;

  repErrLog = ErrorLoger();
  repErrLog.InitErrLog(rep, mode == VARM_EXCEL);
  repErrLog.StartErrLog();

  GetPeriod(period, year, year_run, @dateB, @dateE);

  stat = UniRunReport(period, year, year_run, range, l1, t1, t2, t3, t4, t5, t8, mode);

  repErrLog.FinishErrLog();

  if(not stat)
    if(total_count != 0)
      if(mode == VARM_EXCEL)
        repErrLog.ShowErrLog();
        rep.SetZoomType(ZOOM_TYPE_A4L); // †´Ï°Æ¨≠†Ô Æ‡®•≠‚†Ê®Ô
        rep.PrintWinRep();
        rep.ShowWinRep();
      elif(mode == VARM_TEXT)
        ReportFileName = GetTxtFileName(TblName);

        if(Open(ReportOutFile, ReportFileName) == false)
          errcode = status(errtext);
          msgbox("éË®°™† Ø‡® Æ‚™‡Î‚®® ‰†©´† Æ‚Á•‚†|"+ ReportFileName +"|(" + errcode + ") " + errtext);
          break;
        end;

        SetOutput(ReportFileName);
        rep.PrintRep();
        repErrLog.ShowErrLog();
        SetOutput(NULL, true);
        close(ReportOutFile);
      end;
    else
      if(mode == VARM_EXCEL)
        msgbox("ç•‚ ≠® Æ§≠Æ© ß†Ø®·® ß† „™†ß†≠≠Î© Ø•‡®Æ§ §´Ô ‰Æ‡¨®‡Æ¢†≠®Ô Æ‚Á•‚†.");
      elif(mode == VARM_TEXT)
        println("ç•‚ ≠® Æ§≠Æ© ß†Ø®·® ß† „™†ß†≠≠Î© Ø•‡®Æ§ §´Ô ‰Æ‡¨®‡Æ¢†≠®Ô Æ‚Á•‚†.");
      end;
    end;
  elif(stat == 1)
    msgbox("ç•¢Æß¨Æ¶≠Æ Æ‚™‡Î‚Ï ¢‡•¨•≠≠Î© ‰†©´");
  end;

  return 0;
END;
