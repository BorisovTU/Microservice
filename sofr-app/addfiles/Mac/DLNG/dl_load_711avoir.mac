/*
$Name: dl_load_711avoir.mac
$Module: Ценные бумаги
$Description: Загрузка закладных для 711 формы
*/
import "or_exl_h.mac", globals, rsd;


private const COL_KO1               = "A",
              COL_KO2               = "B",
              COL_KO3               = "C",
              COL_KO4               = "D",
              COL_KO5               = "E",
              COL_KO6               = "F",
              COL_KO7               = "G",
              COL_KO8               = "H", 
              COL_KO9               = "I", 
              COL_KO10              = "J", 
              COL_KO11              = "K", 
              COL_KO12              = "L", 
              COL_KO13              = "M", 
              COL_KO14              = "N", 
              COL_KO15              = "O";
 

Private Macro ClearTable(RepDate)
   var query1, cmd1;
        query1 =   " DECLARE "
                + " BEGIN "
                + "   DELETE FROM D711AVOIR_MORTGAGE_DBT WHERE T_LOADINGDATE = ?; "
                + " END; ";

        cmd1 = RSDCommand(query1);
		cmd1.AddParam("p01", RSDBP_IN, RepDate);

        cmd1.execute();
End;

Private macro InsertTableKO (strko, RepDate)
 var sql, cmd;
 sql = "INSERT INTO D711AVOIR_MORTGAGE_DBT ("
         "T_ISSUERNAME,"
         "T_ISSUERINN,"
         "T_ISSUERINN_TIN,"
         "T_ISSUERINN_MARK,"
         "T_ISSUERNOTRESCODE,"
         "T_CFI,"
         "T_ISSUEROGRN,"
         "T_ISSUERCOUNTRYCODE,"
         "T_CODE711,"
         "T_LSIN,"
         "T_FACEVALUEFICODE,"
         "T_FACEVALUE,"
         "T_OURAMOUNT,"
         "T_OURREFAMOUNT,"
         "T_ISSUERAMOUNT,"
		 "T_LOADINGDATE"
        " ) "
        "VALUES(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16)";
 cmd = RSDCommand(sql);
 cmd.AddParam("p01", RSDBP_IN, strko.KO1);
 cmd.AddParam("p02", RSDBP_IN, strko.KO2);
 cmd.AddParam("p03", RSDBP_IN, strko.KO3);
 cmd.AddParam("p04", RSDBP_IN, strko.KO4);
 cmd.AddParam("p05", RSDBP_IN, strko.KO5);
 cmd.AddParam("p06", RSDBP_IN, strko.KO6);
 cmd.AddParam("p07", RSDBP_IN, strko.KO7);
 cmd.AddParam("p08", RSDBP_IN, strko.KO8);
 cmd.AddParam("p09", RSDBP_IN, strko.KO9);
 cmd.AddParam("p10", RSDBP_IN, strko.KO10);
 cmd.AddParam("p11", RSDBP_IN, strko.KO11);
 cmd.AddParam("p12", RSDBP_IN, strko.KO12);
 cmd.AddParam("p13", RSDBP_IN, strko.KO13);
 cmd.AddParam("p14", RSDBP_IN, strko.KO14);
 cmd.AddParam("p15", RSDBP_IN, strko.KO15);
 cmd.AddParam("p16", RSDBP_IN, RepDate);

 cmd.Execute;

 return true;
end;

class AvoirRec()
  var KO1              :string,
      KO2              :string,
      KO3              :string,
      KO4              :string,
      KO5              :string,
      KO6              :string,
      KO7              :string,
      KO8              :string,
      KO9              :string,
      KO10             :string,
      KO11             :string,
      KO12             :numeric,
      KO13             :numeric,
      KO14             :numeric,
      KO15             :numeric;

 end;

private macro SaveFileToAppServ(filepath:string, FileName:string):string
   if(not isStandAlone()) // когда мы на терминале, копируем файл на СП     
      var path_appserv = "..\\workfile\\" + FileName;

      if(not CopyFile("$" + filepath, path_appserv))
         msgbox("Ошибка при передаче на сервер приложений файла $" + filepath);
      end;
      filepath = path_appserv;
   end;
      
   return filepath;
end;

private macro DeleteFileToAppServ(FullNameFile)
   if(not isStandAlone()) // когда мы на терминале, удаляем файл на СП
      if (not RemoveFile (FullNameFile))
         println ("Ошибка удаления с сервера приложений файла " + FullNameFile);
      end;
   end;
end;

//Загрузка данных из Excel

macro OpLoadFile(FileName, TermPath, RepDate)

   var row = 3;
   var AvRec, sheet, sheetcount, book;
   var all = 0, err = 0, onSheetCount = 0;
   var ErrStr = "",ErrStat = false;

   var FullNameFile = TermPath + FileName;
   var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   var rc = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");

   /*Открываем файл*/
   BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");
   println("Загрузка данных из файла");
   debugbreak;
   FullNameFile = SaveFileToAppServ(FullNameFile, FileName);

   book = rc.openWorkbook(FullNameFile);

   if(not book)
      MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
      println("Ошибка открытия файла \"" + FullNameFile + "\"");
      EndAction(1);
      return 0;
   end;

  /**/
   sheetcount = 1;
   WHILE(book.getSheetsCount() >= sheetcount)                                       
      book.setActiveSheet(sheetcount-1);
      row = 3;

      //Бежим по файлу
      InitProgress(-1);
      onSheetCount = 0;

      while (valtype(book.getCellValue(COL_KO4+row)) != V_UNDEF) 
         all = all + 1;
         
         AvRec = AvoirRec(); 
         If(valtype(book.getCellValue(COL_KO1+row)) != V_UNDEF)
            AvRec.KO1       = string(book.getCellValue(COL_KO1+row));
         else
            AvRec.KO1       = "";
         end;
         If(valtype(book.getCellValue(COL_KO2+row)) != V_UNDEF)
            AvRec.KO2       = string(book.getCellValue(COL_KO2+row));
         else
            AvRec.KO2       = "";
         end;
         If(valtype(book.getCellValue(COL_KO3+row)) != V_UNDEF)
            AvRec.KO3       = string(book.getCellValue(COL_KO3+row));
         else
            AvRec.KO3       = "";
         end;
         If(valtype(book.getCellValue(COL_KO4+row)) != V_UNDEF)
            AvRec.KO4       = string(book.getCellValue(COL_KO4+row));
         else
            AvRec.KO4       = "";
         end;
         If(valtype(book.getCellValue(COL_KO5+row)) != V_UNDEF)
            AvRec.KO5       = string(book.getCellValue(COL_KO5+row));
         else
            AvRec.KO5       = "";
         end;
         If(valtype(book.getCellValue(COL_KO6+row)) != V_UNDEF)
            AvRec.KO6       = string(book.getCellValue(COL_KO6+row));
         else
            AvRec.KO6       = "";
         end;
         If(valtype(book.getCellValue(COL_KO7+row)) != V_UNDEF)
            AvRec.KO7       = string(book.getCellValue(COL_KO7+row));
         else
            AvRec.KO7       = "";
         end;
         If(valtype(book.getCellValue(COL_KO8+row)) != V_UNDEF)
            AvRec.KO8       = string(book.getCellValue(COL_KO8+row):0:0);
         else
            AvRec.KO8       = "";
         end;
         If(valtype(book.getCellValue(COL_KO9+row)) != V_UNDEF)
            AvRec.KO9       = string(book.getCellValue(COL_KO9+row));
         else
            AvRec.KO9       = "";
         end;
         If(valtype(book.getCellValue(COL_KO10+row)) != V_UNDEF)
            AvRec.KO10       = string(book.getCellValue(COL_KO10+row));
         else
            AvRec.KO10       = "";
         end;
         If(valtype(book.getCellValue(COL_KO11+row)) != V_UNDEF)
            AvRec.KO11       = string(book.getCellValue(COL_KO11+row));
         else
            AvRec.KO11       = "";
         end;
         If(valtype(book.getCellValue(COL_KO12+row)) != V_UNDEF)
            AvRec.KO12       = book.getCellValue(COL_KO12+row);
         else
            AvRec.KO12       = 0;
         end;
         If(valtype(book.getCellValue(COL_KO13+row)) != V_UNDEF)
            AvRec.KO13       = book.getCellValue(COL_KO13+row);
         else
            AvRec.KO13       = 0;
         end;
         If(valtype(book.getCellValue(COL_KO14+row)) != V_UNDEF)
            AvRec.KO14       = book.getCellValue(COL_KO14+row);
         else
            AvRec.KO14       = 0;
         end;
         If(valtype(book.getCellValue(COL_KO15+row)) != V_UNDEF)
            AvRec.KO15       = book.getCellValue(COL_KO15+row);
         else
            AvRec.KO15       = 0;
         end;

         InsertTableKO(AvRec, RepDate);
         UseProgress(row);

         ErrStr = "";
         ErrStat = false;
         //STrec = null;
         row = row + 1;
         onSheetCount = onSheetCount + 1;
      end; //while
      
      println("На листе " + sheetcount + " загружено " + onSheetCount + " записей" );
      RemProgress();
      sheetcount = sheetcount+1;
   end;//eow sheet
  
   println("Всего записей загружено: " + all);
   book.close();
   book = null;
   rc = null;
   DeleteFileToAppServ(FullNameFile);

onerror(error)
   println("Ошибка при загрузке данных " + error.Message);
   if (valtype(book) != V_UNDEF)
      book.close();
   end;
   book = null;
   rc = null;
   EndAction(1);
end;

macro StrToDate(strDDMMYYYY)
  return date(int(substr(strDDMMYYYY, 1, 2)),
              int(substr(strDDMMYYYY, 3, 2)),
              int(substr(strDDMMYYYY, 5, 4)))
OnError
  return date(0,0,0);
end;

macro OpLoad711Avoir()
   var FullNameFile = "";
   var FileName = "";
   var DirName = "";
   var ExtName = "";
   var LoadingDate;
   /*Выбираем файл для обработки*/

   if(SelectFile(FullNameFile, "*.xlsx", "Выбор файла импорта", null, true))
      //Отделяем путь файла от имени
      splitfile(FullNameFile, FileName, ExtName);
      FileName = FileName + ExtName;
      DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);
      if ((strlen(FileName) < 8) OR (StrToDate(substr(FileName, 1, 8)) == date(0,0,0)))
         println("Некорректный формат имени файла. Имя файла должно иметь префикс DDMMYYYY_");
         return;
      end;
      LoadingDate = StrToDate(substr(FileName, 1, 8));
      
      ClearTable(LoadingDate);
      OpLoadFile(FileName, DirName, LoadingDate);
   else
     println("Операция отменена.");
   end;
End;

println("Выполнение процедуры 'Загрузка закладных для 711 формы'");
OpLoad711Avoir();