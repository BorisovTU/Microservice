/*
$Name:         dl711bill.mac
$Module:       Депозитарий
$Description:  Выборка данных для Ф711 Ч2 Операции с векселями
*/

import BankInter, DealsInter, CTInter, VSInter, VSInter, DPInter, cb_sql;
import "vareslib.mac", "dlvaprds.mac", "dlreport.mac", "vsbnrfd.mac", "vaacc.mac", "dpstdrep.mac";
import RsbDataSet;

const BILLKIND_ALL       = 0;  // все
const BILLKIND_ACCOUNTED = 1;  // учтенные
const BILLKIND_OUR       = 2;  // собственные
const BILLKIND_OTHER     = 3;  // прочие

const BILL711_MODE_2055  = 0;  // Выдача данных по версии Указания ЦБР №2055-У
const BILL711_MODE_2332  = 1;  // Выдача данных по версии Указания ЦБР №2332-У
const BILL711_MODE_2627  = 2;  // Выдача данных по версии Указания ЦБР №2627-У
const BILL711_MODE_2835  = 3;  // Выдача данных по версии Указания ЦБР №2835-У
const BILL711_MODE_3129  = 4;  // Выдача данных по версии Указания ЦБР №3129-У
const BILL711_MODE_3269  = 5;  // Выдача данных по версии Указания ЦБР №3269-У
const BILL711_MODE_4212  = 6;  // Выдача данных по версии Указания ЦБР №4212-У
const BILL711_MODE_4637  = 7;  // Выдача данных по версии Указания ЦБР №4637-У
const BILL711_MODE_4927  = 8;  // Выдача данных по версии Указания ЦБР №4927-У

private const PTK_MATERIALCOMPLEX = 39; //имущественный комплекс
private const PTCK_STATEREGNUM    = 33; //Рег.номер в стране регистрации

private const BO_DEPO = "Z";  //Депозитарий
private const BO_VA   = "N";  //Учтенные векселя
private const BO_VS   = "Y";  //Собственные векселя
private const BO_TRUST= "А";  //Доверительное управление

private const OUR_COUNTRY_CODE = "643";            //Код нашей страны
private const INTERNATIONAL_COUNTRY_CODE = "998";  //Код для международных организаций
private const UNKNOWN_COUNTRY_CODE = "999";        //Код страны неизвестен

private var TmpTable = "d711bill_tmp";

CLASS C_711bill()

PRIVATE CONST VSBANNER_STATUS_CIRCULATION_STR = "В обращении",
              VSBANNER_STATUS_REDEEMED_STR = "Выкуплен для дальнейшей перепродажи",
              VSBANNER_STATUS_RECEIVED_4STORAGE_STR = "Принят на хранение",
              VSBANNER_STATUS_RECEIVED_IN_MORTGAGE_STR = "Принят в залог",
              VSBANNER_STATUS_RECEIVED_4BUYOUT_STR = "Принят для выкупа",
              VSBANNER_STATUS_RECEIVED_4REDEMPTION_STR = "Принят к погашению",
              VSBANNER_STATUS_PRESENTED_4REDEMPTION_STR = "Предъявлен для погашения";

PRIVATE CONST VSBANNER_STATE_WRITTENOFF = "списан",
              VSBANNER_STATE_BLOCKED     = "блокирован",
              VSBANNER_STATE_ARRESTED    =  "арестован",
              VSBANNER_STATE_LOST        = "утерян",
              VSBANNER_STATE_STOLED      =  "похищен",
              VSBANNER_STATE_INCIRCULATE = "в обращении",
              VSBANNER_STATE_OVERDUE     = "просрочен",
              VSBANNER_STATE_REDEEMED    = "выкуплен",
              VSBANNER_STATE_ONREDEEM    = "на выкупе",
              VSBANNER_STATE_WRITTENOFFINCOME = "списан на доходы";

PRIVATE VAR  Departments,       // Список филиалов по которым выбираются векселя
             BeginRepDate:date, // Дата начала отчетного периода
             RepDate:date,      // Дата по состоянию на которую выбираются векселя
             BillKind,          // Вид раздела отчета
             Mode,              // Режим работы (по разным версиям нормативных документов)
             Mode2;             // Режим работы (по разным версиям нормативных документов)

PRIVATE VAR DataRec;

VAR IssuerName:string,               // Наименование векселедателя
    Code711:string,                  // Код типа ц/б для ф711
    IssuerINN:string,                // ИНН векселедателя
    IssuerINN_TIN:string,            // для ИНН векселедателя - TIN
    IssuerNotResCode:string,         // Ф711_ПризнакКодаВекселедатНерез - Признак кода нерезидента векселедателя
    IssuerINN_Mark:string,           // для ИНН векселедателя - признак
    IssuerCountryCode:string,        // Код страны эмитента
    IssuerCountryCode2:string,       // Код ОКСМ страны эмитента
    IssuerOGRN:string,               // ОГРН векселедателя
    Series:string,                   // Серия
    Number:string,                   // Номер
    FormNumber:string,               // Номер бланка
    IssueDate:date,                  // Дата составления
    TermFormula:string,              // Формулировка срока платежа. До 4212-У - строка, после - числовой код
    FaceValue:money,                 // Ф711_Графа_Номинал - Номинал
    FaceValueFICode:string,          // Ф711_Графа_Валюта Код валюты номинала
    DealDate:date,                   // Дата постановки векселя на учет
    DealGround:string,               // Ревизиты документа-основания постановки векселя на учет
    DealAgentName:string,            // Наименование контрагента по сделке
    DealAgentINN:string,             // ИНН контрагента по сделке
    DealAgentINN_TIN:string,         // для ИНН контрагента по сделке - TIN
    DealAgentNotResCode:string,      // Ф711_ПризнакКодаКАНерез - Признак кода нерезидента контрагента по сделке
    DealAgentINN_Mark:string,        // для ИНН контрагента по сделке - признак
    DealAgentCountryCode:string,     // Код страны контрагента
    DealAgentCountryCode2:string,    // Код ОКСМ страны контрагента
    DealAgentOGRN:string,            // ОГРН контрагента
    BalanceCost:money,               // Ф711_Графа_БалансСтоим Балансовая стоимость
    Interest:money,                  // Ф711_Графа_ПДД Накопленный дисконт/процент
    BalanceAccNum:string,            // Номер балансового счета на котором учитывается вексель
    StoragePlaceName:string,         // Наименование места хранения
    StoragePlaceINN:string,          // ИНН места хранения
    StoragePlaceINN_TIN:string,      // для ИНН места хранения - TIN
    StoragePlaceNotResCode:string,   // Ф711_ПризнакКодаВджНерез - Признак кода нерезидента места хранения
    StoragePlaceINN_Mark:string,     // для ИНН места хранения - признак
    StoragePlaceCountryCode:string,  // Код страны места хранения
    StoragePlaceCountryCode2:string, // Код ОКСМ страны места хранения
    StorageGround:string,            // Основание принятия на хранение
    StoragePlaceOGRN:string,         // ОГРН места хранения
    FirstHolderName:string,          // Наименование первого векселедержателя
    FirstHolderINN:string,           // ИНН первого векселедержателя
    FirstHolderINN_TIN:string,       // для ИНН первого векселедержателя - TIN
    FirstHolderNotResCode:string,    // Ф711_ПризнакКодаПервыйВджНерез - Признак кода нерезидента первого векселедержателя
    FirstHolderINN_Mark:string,      // для ИНН первого векселедержателя - признак
    FirstHolderCountryCode:string,   // Код страны первого векселедержателя
    FirstHolderCountryCode2:string,  // Код ОКСМ страны первого векселедержателя
    FirstHolderOGRN:string,          // ОГРН первого векселедержателя
    State:string,                    // Состояние векселя: до вступления Указания ЦБР №2627-У - строковая расшифровка, после - числовой код
    RepaymentDate:date,              // Дата фактического погашения векселя
    HolderName:string,               // Наименование векселедержателя
    HolderINN:string,                // ИНН векселедержателя
    HolderINN_TIN:string,            // для ИНН векселедержателя - TIN
    HolderNotResCode:string,         // Ф711_ПризнакКодаВджтНерез/Ф711_ПризнакКодаВекселедержНерез - Признак кода нерезидента векселедержателя
    HolderINN_Mark:string,           // для ИНН векселедержателя - признак
    HolderCountryCode:string,        // Код страны векселедержателя
    HolderCountryCode2:string,       // Код ОКСМ страны векселедержателя
    HolderOGRN:string,               // ОГРН векселедержателя
    HolderState:string,              // Статус векселедержателя
    Note:string,                     // Примечание
    TermDate1:date,                  // Ф711_Графа_СрокДата1
    TermDate2:date,                  // Ф711_Графа_СрокДата2
    PercentRate:double,              // Ф711_Графа_Процент
    BuyCost:money,                   // Ф711_Графа_БалансСтоимНКД
    QualityCateg:integer,            // Ф711_Графа_Качество
    ReserveSum:money,                // Ф711_Графа_Резерв
    SaleCost:money,                  // Ф711_Графа_ПродажаСумма
    SaleDate:date,                   // Ф711_Графа_ПродажаДата
    SaleGround:string,               // Ф711_Графа_ПродажаОснование
    SaleAgentName:string,            // Ф711_Графа_ПродажаКонтр
    SaleAgentINN:string,             // Ф711_Графа_ПродажаКонтрИНН
    SaleAgentINN_TIN:string,         // Ф711_Графа_ПродажаКонтрИНН_TIN
    SaleAgentNotResCode:string,      // Ф711_ПризнакКодаКАПоСделкеНерез - Признак кода нерезидента контрагента по сделке
    SaleAgentINN_Mark:string,        // Ф711_Графа_ПродажаКонтрИНН_призн_контрагент
    SaleAgentCountryCode:string,     // Ф711_Графа_ПродажаКонтрОКМС
    SaleAgentOGRN:string,            // Ф711_Графа_ПродажаКонтрОГРН
    OvervalueBill:money,             // Ф711_Графа_Переоценка
    AdjustCost:money,                // Ф711_Графа_КоррСтоимость
    AdjustReserv:money,              // Ф711_Графа_КоррРезерв
    IdentifierCode:string,           // Ф711_Графа_ИдентКод
    AvalAcept:string;                // Ф711_Графа_АвалАкцеп

    /* Если добавляется новое указание, то делаем проверку на >= и ставим условие по новому указанию самым первым.
       Причина? Для того, чтобы обрабатывались условия по пред. указаниям. Ведь указание 3129 должно включать в себя указание по 2835! */
    private macro Conforms2055( Mode )
      return ( Mode == BILL711_MODE_2055 );
    end;

    private macro Conforms2332( Mode )
      return ( Mode >= BILL711_MODE_2332 );
    end;

    private macro Conforms2627( Mode )
      return ( Mode >= BILL711_MODE_2627 );
    end;

    private macro Conforms2835( Mode )
      return ( Mode >= BILL711_MODE_2835 );
    end;

    private macro Conforms3129( Mode )
      return ( Mode >= BILL711_MODE_3129 );
    end;

    private macro Conforms3269( Mode )
      return ( Mode >= BILL711_MODE_3269 );
    end;

    private macro Conforms4212( Mode )
      return ( Mode >= BILL711_MODE_4212 );
    end;

    private macro Conforms4637( Mode )
      return ( Mode >= BILL711_MODE_4637 );
    end;

    private macro Conforms4927( Mode )
      return ( Mode >= BILL711_MODE_4927 );
    end;

    private macro CheckPartyType( PartyId, PartyType )
      var partyown = TBFile("partyown");
      var isPartyType = false;

      partyown.KeyNum = 0;
      partyown.rec.PartyID   = PartyId;
      partyown.rec.PartyKind = PartyType;
      if (GetEQ(partyown))
        isPartyType = true;
      end;

      return isPartyType;
    end;

    private macro СостояниеНаДату(BCID, RepDate, Symbol)
       var DataSet, query;
       var Select;

       query = "select instr(rsb_bill.GetVABnrStateOnDate(? /*1*/, ? /*2*/), ? /*3*/) as sympos from dual";

       Select = RSDCommand( query );

       Select.AddParam("BCID",    RSDBP_IN,  BCID );     /*1*/
       Select.AddParam("RepDate", RSDBP_IN,  RepDate );  /*2*/
       Select.AddParam("Symb",    RSDBP_IN,  Symbol );   /*3*/

       Select.Execute();

       DataSet = TRsbDataSet(Select);
       if(DataSet.moveNext())
         return DataSet.sympos;
       end;
       return 0;
    end;

    private macro ПолучитьОперациюИзмененияУчтенногоВекселя(BCID, RepDate:date)
      var DataSet, query;
      var BckID = 0;
      var DealID = 0;
      var Select, Select1;

      query =   " SELECT bck.t_ID FROM dvsbnrbck_dbt bck "
              + "  WHERE bck.t_IsBCState = 'A' "
              + "    AND bck.t_ChangeDate < ? /*1*/ "
              + "    AND bck.t_BCID = ? /*2*/ "
              + "  ORDER BY bck.t_ChangeDate DESC ";

      Select = RSDCommand( query );

      Select.AddParam("ChangeDate", RSDBP_IN, RepDate );  /*1*/
      Select.AddParam("BCID",       RSDBP_IN, BCID );     /*2*/

      Select.Execute();

      DataSet = TRsbDataSet(Select);
      if(DataSet.moveNext())
        BckID = DataSet.ID;

        query =   " select tick.t_DealID "
                + "   from ddl_tick_dbt tick, doprdocs_dbt odoc, doproper_dbt opr "
                + "  where odoc.t_DocKind = " + DL_VSBNRBCK
                + "    and odoc.t_DocumentID = LTRIM(TO_CHAR (? /*1*/, '0000000000')) "
                + "    and opr.t_ID_Operation = odoc.t_ID_Operation "
                + "    and tick.t_BOfficeKind = opr.t_DocKind "
                + "    and tick.t_DealID = TO_NUMBER(opr.t_DocumentID) ";

        Select1 = RSDCommand( query );

        Select1.AddParam("DocumentID", RSDBP_IN, BckID );  /*1*/

        Select1.Execute();

        DataSet = TRsbDataSet(Select1);
        if(DataSet.moveNext())
          DealID = DataSet.DealID;
        end;
      end;

      return DealID;
    end;

    private macro GetGround(DealKind, DealID, Kind)
      var ground, query;
      var groundstr = "";
      var Select, Select1;

       if((DealKind != DL_VATRUST) and (DealKind != TS_DOC_DECLAR))
         query = " select val.t_Name, spgr.t_XLD, spgr.t_RegistrDate from dspground_dbt spgr, dspgrdoc_dbt doc, dllvalues_dbt val "
               + "  where doc.t_SourceDocKind = ? /*1*/ "
               + "    and doc.t_SourceDocID = ? /*2*/ "
               + "    and spgr.t_SPgroundID = doc.t_SPgroundID"
               + "    and spgr.t_Kind = ? /*3*/ "
               + "    and val.t_Element = spgr.t_Kind "
               + "    and val.t_List = " + OBJTYPE_KINDDOC;

         Select = DL_RSDCommand( query );

         Select.AddParam(DealKind );  /*1*/
         Select.AddParam(DealID );    /*2*/
         Select.AddParam(Kind );      /*3*/

         ground = Select.Execute();

         if(ground.moveNext())
           groundstr =  (ground.Name + " №"+ ground.XLD + " от " + String(date(ground.RegistrDate):f));
         end;
       else
         query = " select c.t_Number, c.t_DateBegin, c.t_PartyID from dsfcontr_dbt c, ddl_tick_dbt tick"
               + "  where c.t_ID = tick.t_ClientContrID "
               + "    and tick.t_DealID = ? /*1*/ ";

         Select = DL_RSDCommand( query );

         Select.AddParam(DealID );    /*1*/

         ground = Select.Execute();

         if( ground.moveNext())
           groundstr = "№"+ground.Number+" от "+String(date(ground.DateBegin):f);

           query = "SELECT d2.T_PARTYID FROM DPARTYOWN_DBT d2 WHERE d2.T_PARTYID = ? /*1*/ AND d2.T_PARTYKIND = " + PTK_MATERIALCOMPLEX;

           Select1 = DL_RSDCommand( query );

           Select1.AddParam(ground.PartyID );    /*1*/

           ground = Select1.Execute();

           if(ground.moveNext())
              groundstr = "ОФБУ "+groundstr;
           else
              groundstr = "Договору "+groundstr;
           end;
         end;
       end;

       return groundstr;
    end;

    private macro GetICGround(FiCertID, RepDate)
       var query, DataSet, Select;
       var ICGround = "";

       query =   " select sf.t_Number, sf.t_DateBegin, sk.t_Definition "
               + "   from ddepoacnt_dbt acnt, daccount_dbt accP, dsfcontr_dbt sf, dservksub_dbt sk, dinvcard_dbt ic "
               + "  where ic.t_FiCertID = ? /*1*/ "
               + "    and accP.t_AccountID = rsb_depo.iclastaccountid(ic.t_InvCardID, 0, ? /*3*/) "
               + "    and acnt.t_AutoKey = accP.t_DepoRoot "
               + "    and sf.t_ServKind = " + PTSK_DEPOS
               + "    and sf.t_ObjectType = 2 "
               + "    and sf.t_Object = acnt.t_Code "
               + "    and sk.t_ServiceKind = sf.t_ServKind "
               + "    and sk.t_ServiceKindSub = sf.t_ServKindSub ";

       Select = DL_RSDCommand( query );

       Select.AddParam(FiCertID );   /*1*/
       Select.AddParam(RepDate );    /*2*/
       Select.AddParam(RepDate );    /*3*/

       DataSet = Select.Execute();

       if(DataSet.moveNext())
         ICGround = DataSet.Definition + " №"+DataSet.Number + " от "+date(DataSet.DateBegin);
       end;

       return ICGround;
    end;

    private macro GetDealClientID(DealID)
       var Contr, query;
       var ClientID = -1;
       var Select;

       query = " select sf.t_PartyID from ddl_tick_dbt tick, dsfcontr_dbt sf "
             + "  where tick.t_DealID = ? /*1*/ "
             + "    and sf.t_ID = tick.t_ClientContrID ";

       Select = RSDCommand( query );

       Select.AddParam("DealID", RSDBP_IN, DealID );  /*1*/

       Select.Execute();

       Contr = TRsbDataSet(Select);

       if( Contr.moveNext())
         ClientID = Contr.PartyID;
       end;

       return ClientID;
    end;

    private macro GetAgentIDbyRole( BCID, AgentRole, AgentRole2 )
      var DataSet, query;
      var Select;
      var AgentID = -1;

      query =   " select t_Agent from dvsircag_dbt "
              + "  where t_AvoirKind = " + AVOIRISSKIND_BILL
              + "    and t_BCID = ? /*1*/ ";
      
      if (VALTYPE(AgentRole2) != V_UNDEF)
        query = query + "    and (t_AgentRole = ? /*2*/ OR t_AgentRole = ? /*3*/)";
      else
        query = query + "    and t_AgentRole = ? /*2*/ ";
      end;

      Select = RSDCommand( query );

      Select.AddParam("BCID",      RSDBP_IN, BCID );       /*1*/
      Select.AddParam("AgentRole", RSDBP_IN, AgentRole );  /*2*/
      
      if (VALTYPE(AgentRole2) != V_UNDEF)
        Select.AddParam("AgentRole2", RSDBP_IN, AgentRole2 );  /*3*/
      end;

      Select.Execute();

      DataSet = TRsbDataSet(Select);
      if(DataSet.moveNext())
        AgentID = DataSet.Agent;
      end;

      return AgentID;
    end;

    private macro GetPartyINN(PartyID, CheckJud, IsDepo, tin:@string, notrescode:@string)
      var pt  = TRecHandler("party.dbt");
      var PartyINN = "", KPP = "";
      var PtCatCode = "";

      if(ПолучитьСубъекта(PartyID, pt) == 0)
        if (Conforms3129(Mode) AND (pt.rec.NotResident == "X"))
          tin = GetCodeParty(pt.rec.PartyID, PTCK_FOREIGN_INN);
          notrescode = "TIN";
          if(tin == "")
            if(Conforms4927(Mode)) // Проверка на LEI
              // LEI (Legal Entity Identifier)
              tin = GetCodeParty(PartyID, PTCK_LEI);
              notrescode = "LEI";
            end;
            if(tin == "")
              // Регистрационный номер в стране регистрации
              tin = GetCodeParty(PartyID, PTCK_STATEREGNUM);
              notrescode = "RN";
              if(tin == "")
                // Если не заполнен или запонен нулями
                notrescode = "NN";
              end;
            end;
          end;
          PartyINN = tin;
          if (PartyINN == "")
            if (pt.rec.LegalForm != PTLEGF_PERSN)
              PartyINN = "000";
            else
              PartyINN = "00000";
            end;
          end;
        elif((Conforms2332(Mode)) AND (pt.rec.NotResident == "X"))
          // 2332-У Для юридических  лиц-нерезидентов следует указывать код страны(по ОКСМ), резидентом которой является юридическое лицо.
          // В случае отсутствия данных о стране юридического лица - нерезидента указывать код "999"
          if((Conforms2835(Mode)) AND ((ValType(IsDepo) == V_UNDEF) OR (IsDepo == false)))
            if(CheckPartyType( PartyID, 34 /*Международная организация*/ ))
              PartyINN = INTERNATIONAL_COUNTRY_CODE;
            else
              PartyINN = DP_GetCountryByCodeLat3(pt.rec.NRCountry).CodeNum3;
              if(PartyINN == "")
                PartyINN = UNKNOWN_COUNTRY_CODE;
              end;
            end;
          else
            PartyINN = DP_GetCountryByCodeLat3(pt.rec.NRCountry).CodeNum3;
            //Если данные о стране отсутствуют, то выводится код "999"
            if(PartyINN == "")
              PartyINN = UNKNOWN_COUNTRY_CODE;
            end;
          end;
        else
          PartyINN = GetCodeParty(PartyID, PTCK_INN);
          if(PartyINN == "")
            if(pt.rec.LegalForm != PTLEGF_PERSN)
              PartyINN = "0000000000"; //для юрлиц 10 нулей
            else
              PartyINN = "000000000000"; //для физлиц 12 нулей
            end;
          elif(pt.rec.LegalForm != PTLEGF_PERSN)
            if((ValType(CheckJud) != V_UNDEF) and (CheckJud == true))
              //Для организаций, относящихся к органам судебной власти и внутренних дел, следует указывать десять нулей.
              DL_GetObjAttrName(OBJTYPE_PARTY, 64, DL_GetMainObjAttr( pt, 64 /*Код ОКВЭД_2*/, OBJTYPE_PARTY ), null, null, @PtCatCode );
              if((PtCatCode != "") and ((Index(PtCatCode, "84.23") == 1) or (Index(PtCatCode, "84.24") == 1)))
                PartyINN = "0000000000";
              end;
            end;
          end;
        end;
      end;

      SplitFullINN( PartyINN, PartyINN, KPP );

      return PartyINN;
    end;

    private macro GetCodeOGRN(partyID)
      if (Conforms3129(Mode))
        return GetCodeParty(partyID, PTCK_OGRN);
      end;
      return "";
    end;

    private macro GetPartyCountryCode(PartyID)
      var pt  = TRecHandler("party.dbt");
      var PartyCountryCode = "";

      if(ПолучитьСубъекта(PartyID, pt) == 0)
        if(pt.rec.NotResident == "X")
          PartyCountryCode = DP_GetCountryByCodeLat3(pt.rec.NRCountry).CodeNum3;
        else
          PartyCountryCode = OUR_COUNTRY_CODE;
        end;
        if (PartyCountryCode == "")
          PartyCountryCode = UNKNOWN_COUNTRY_CODE;
        end;
      end;

      return PartyCountryCode;
    end;

    private macro GetParty(partyID):TRecHandler
      var pt = TRecHandler("party.dbt");

      ПолучитьСубъекта(partyID, pt);
      return pt;
    end;

    private macro GetVsPtbyDocKinds(BCID, RepDate, DocKinds, OprSymb, PartyID:@variant, PartyName:@variant, DocKind:@variant, DocID:@variant)
      var query = "", ds;
      var stat = 0;
      var ordquery = "";
      var squery = "";
      var Select;

      query = " select DECODE(ptname.t_name, NULL, pt.t_Name, ptname.t_name) as t_name, pt.t_PartyID, lnk.t_DocKind, lnk.t_ContractID"
               + " from dvsordlnk_dbt lnk, dparty_dbt pt, dpartyname_dbt ptname "
               + " where lnk.t_BCID = ? /*1*/ "
               + "   and lnk.t_InterestChargeDate <= ? /*2*/ "
               + "   and lnk.t_DocKind IN ("+DocKinds+") "
               + "   and ptname.t_PartyID (+)= pt.t_PartyID "
               + "   and ptname.t_nametypeID (+)= " + PTKN_BANKNAME;

      ordquery =  " (lnk.t_ContractID, lnk.t_DocKind, pt.t_PartyID) = "
                + " ( select ord.t_ContractID, ord.t_DocKind, ord.t_Contractor "
                + "     from ddl_order_dbt ord "
                + "    where ord.t_ContractID = lnk.t_ContractID "
                + "      and ord.t_DocKind = lnk.t_DocKind )";

      if(OprSymb != "") //задан символ фильтрации по виду операции (только для мены СУ и УС)
        squery =  " (lnk.t_ContractID, lnk.t_DocKind, pt.t_PartyID) = "
                + " ( select tk.t_DealID, tk.t_BOfficeKind, tk.t_PartyID "
                + "     from ddl_tick_dbt tk, doprkoper_dbt kop "
                + "    where tk.t_DealID = lnk.t_ContractID "
                + "      and tk.t_BOfficeKind = lnk.t_DocKind "
                + "      and kop.t_Kind_Operation = tk.t_DealType "
                + "      and instr(kop.t_SysTypes, ? /*3*/) != 0 "
                + " ) ";

        squery = squery + " or " + ordquery;
      else
        squery = ordquery;
      end;

      query = query + " and ( "+squery+") ";
      query = query + " order by lnk.t_InterestChargeDate DESC ";

      Select = RSDCommand( query );

      Select.AddParam("BCID",    RSDBP_IN, BCID );       /*1*/
      Select.AddParam("RepDate", RSDBP_IN, RepDate );    /*2*/
      if(OprSymb != "")
        Select.AddParam("OprSymb", RSDBP_IN, OprSymb );  /*3*/
      end;

      Select.Execute();

      ds = TRsbDataSet(Select);
      stat = ds.moveNext();
      if(stat)
        PartyID   = ds.PartyID;
        PartyName = ds.Name;
        DocKind   = ds.DocKind;
        DocID     = ds.ContractID;
      else
        PartyID   = -1;
        PartyName = "";
        DocKind   = 0;
        DocID     = 0;
      end;

      return stat;
    end;

    private macro GetLastVsOrdLnk(BCID, IDate, lnk:TRecHandler)
      var query = "", cmd = null, ds = null;

      lnk.Clear();

      query = " SELECT "
				+"lnk.T_BCID"
				+",lnk.T_CONTRACTID"
				+",lnk.T_LINKKIND"
				+",lnk.T_INTERESTCHARGEDATE"
				+",nvl(lnk.T_BCCOST,0) T_BCCOST"
				+",nvl(lnk.T_TAXBASEAMOUNT,0) T_TAXBASEAMOUNT"
				+",nvl(lnk.T_TAXAMOUNT,0) T_TAXAMOUNT"
				+",lnk.T_ISPARTYCULAR"
				+",nvl(lnk.T_YIELD,0) T_YIELD"
				+",nvl(lnk.T_SCALE,0) T_SCALE"
				+",nvl(lnk.T_POINT,0) T_POINT"
				+",lnk.T_DOCKIND"
				+",nvl(lnk.T_ISSUER,0) T_ISSUER"
				+",lnk.T_ISSUEDATE"
				+",nvl(lnk.T_BCCFI,0) T_BCCFI"
				+",nvl(lnk.T_BCCOSTR,0) T_BCCOSTR"
				+",nvl(lnk.T_BCCOSTRPOINT,0) T_BCCOSTRPOINT"
				+",lnk.T_START"
				+",lnk.T_EXPIRY"
				+",lnk.T_EXCLUDE"
				+",nvl(lnk.T_TAXAMOUNT15,0) T_TAXAMOUNT15"
				+",nvl(lnk.T_TAXAMOUNT_NATCUR,0) T_TAXAMOUNT_NATCUR"
				+",nvl(lnk.T_TAXAMOUNT15_NATCUR,0) T_TAXAMOUNT15_NATCUR"
            + " FROM "
                + " dvsordlnk_dbt lnk "
               + " ,doproper_dbt oper "
               + " ,doprdocs_dbt docs "
               + " ,dvsbnrbck_dbt bck "
              " WHERE "
                + " lnk.t_BCID = ? /*1*/ "
            + " AND lnk.t_DocKind = oper.t_DocKind "
            + " AND LPAD(lnk.t_ContractID, 10, '0') = oper.t_DocumentID "
            + " AND oper.t_ID_Operation = docs.t_ID_Operation "
            + " AND docs.t_DocKind = " + DL_VSBNRBCK + " "
            + " AND docs.t_DocumentID = LPAD(bck.t_ID, 10, '0') "
            + " AND bck.t_BCID = ? /*2*/ "
            + " AND bck.t_ChangeDate <= ? /*3*/ "
            + " ORDER BY "
                + " bck.t_ID DESC ";

      cmd = RSDCommand(query);

      cmd.NullConversion = true;
      cmd.AddParam("", RSDBP_IN, BCID);  /*1*/
      cmd.AddParam("", RSDBP_IN, BCID);  /*2*/
      cmd.AddParam("", RSDBP_IN, IDate); /*3*/

      cmd.Execute();

      ds = TRsbDataSet(cmd);
      if(ds.moveNext())
        ds.GetRecord().CopyTo(lnk.rec);
      end;
    end;

    private macro GetSQLStr(str:String)
      var sqlstr = "";

      if((ValType(str) == V_UNDEF) or (str == ""))
        sqlstr = "CHR(1)";
      else
        sqlstr = "'"+StrSubst(str, "'", "''")+"'";
      end;

      return sqlstr;
    end;

    private macro GetPseudonim(partyID:integer, typeID:integer, name:@string):bool
      var cmd, dataSet;
      var isFound = false;

      cmd = DL_RSDCommand("SELECT T_NAME FROM DPARTYNAME_DBT " +
                          " WHERE T_PARTYID = ?" +
                          " AND T_NAMETYPEID = ?");
      cmd.addParam(partyID);
      cmd.addParam(typeID);

      dataSet = cmd.Execute();

      if (dataSet.moveNext())
        name = dataSet.Name;
        isFound = true;
      end;

      return isFound;
    end;

    private macro GetINN_Mark(legalForm:integer, notResident:string):string
      var mark = "";
      if ((legalForm == PTLEGF_INST) and (notResident != "X"))
        mark = "1";
      elif ((legalForm == PTLEGF_INST) and (notResident == "X"))
        mark = "2";
      elif ((legalForm == PTLEGF_PERSN) and (notResident != "X"))
        mark = "3";
      elif ((legalForm == PTLEGF_PERSN) and (notResident == "X"))
        mark = "4";
      end;
      return mark;
    end;
    private macro GetINN_Mark_ID(partyID:integer):string
      var pt = TRecHandler("party.dbt");
      var mark = "";

      if(ПолучитьСубъекта(partyID, pt) == 0)
        mark = GetINN_Mark(pt.rec.LegalForm, pt.rec.NotResident);
      end;
      return mark;
    end;

    private macro СтоимостьВекселя(BCID, OnDate, BuyCost:@variant, BuyCostFI:@variant, BuyPayDate:@variant)
      var BalanceDate, BuyDealID, Cost, CostFI, DealType, DealCode;
      var fd = VSBannerFD(DL_VSBANNER, BCID);
      var lnkLast = TBfile("vsordlnk"), tickLast = TBfile("dl_tick"), PaymC = TBfile("pmpaym.dbt");

      if((VA_GetBalanceDate(BCID, OnDate, @BalanceDate, @BuyDealID, @Cost, @CostFI, @DealType, @DealCode)) and
        (fd.VAGetLastBuy(lnkLast, tickLast)) and
        (VA_Get1stPlanPaym(tickLast.rec.BofficeKind, tickLast.rec.DealID, CAi, PaymC))
        )

        BuyCostFI  = PaymC.rec.PayFIID;
        BuyPayDate = PaymC.rec.ValueDate;
        BuyCost = Cost;
      end;

      return 0;
    END;

    PRIVATE MACRO PrepareData()
      var query = "", cmd;
      var err = 0;
      var ShowBnr = false;
      var subquery = "";
      var accsubquery = "";
      var DataSet;
      var FormNumber = "";
      var TermFormula = "";
      var dealid = 0, sumbuy, buyfi;
      var DealDate = ZeroDate;
      file tick(dl_tick);
      var DealGround = "";
      var DealAgentINN = "";
      var DealAgentINN_Mark = "";
      var DealAgentINN_TIN = "";
      var DealAgentNotResCode = "";
      var DealAgentName = "";
      var Party  = TRecHandler("party.dbt");
      var IssuerINN = "";
      var IssuerINN_Mark = "";
      var IssuerINN_TIN = "";
      var IssuerNotResCode = "";
      var Interest = 0.0, BalanceCost = 0.0;
      var StoragePlaceName = "";
      var Storage = "";
      var StoragePlaceINN = "";
      var StoragePlaceINN_Mark = "";
      var StoragePlaceINN_TIN = "";
      var StoragePlaceNotResCode = "";
      var StorageGround = "";
      var Note = "";
      var isFormNumber = false;
      var vsform = "";
      var FirstHolderINN = "";
      var FirstHolderINN_TIN = "";
      var FirstHolderNotResCode = "";
      var FirstHolderINN_Mark = "";
      var ds = "";
      var CurrStatus = "";
      var State = "";
      var HolderName = "";
      var HolderINN = "";
      var HolderINN_Mark = "";
      var HolderINN_TIN = "";
      var HolderNotResCode = "";
      var HolderID = "";
      var Code711 = "";
      var CurrNum = 0;
      var Avoiriss = TRecHandler( "avoiriss.dbt" );
      var Fininstr = TRecHandler( "fininstr.dbt" );
      var ficert   = TBFile( "ficert.dbt" );
      var fd;
      var acc = TRecHandler( "account.dbt" );
      var Account = "";
      var BalanceAccNum = "";
      var LastDocKind = 0;
      var icDealDateQuery = "";
      var IssuerCountryCode = "", DealAgentCountryCode = "", StoragePlaceCountryCode = "", FirstHolderCountryCode = "", HolderCountryCode = "";
      var SqlCond4EndedBills = "";
      var SqlCond4PawnBills = "";
      var IssuerCountryCode2 = "", DealAgentCountryCode2 = "", StoragePlaceCountryCode2 = "", FirstHolderCountryCode2 = "", HolderCountryCode2 = "";
      var IssuerOGRN = "", DealAgentOGRN = "", StoragePlaceOGRN = "", FirstHolderOGRN = "", HolderOGRN = "";
      var RepaymentDate = ZeroDate;
      var Премия = 0;

      query = "DELETE FROM "+TmpTable+"";
      SQL_Execute( query, "Формирование записей", true );

      //1. Данные по "Учтенные"
      if((BillKind == BILLKIND_ALL) or (BillKind == BILLKIND_ACCOUNTED)) //все или учтенные
        GetRegistryValue( "REPTREG\\REP_GROUPS\\ФОРМА 711\\ДАННЫЕ БЭК-ОФИСОВ\\УЧТЕННЫЕ ВЕКСЕЛЯ", V_BOOL, ShowBnr, err );
        if((not err) and (ShowBnr == true)) //только если задана настройка

          query =   " INSERT INTO "+TmpTable+" ("
                                              + "T_AUTOKEY,"
                                              + "T_BCID,"
                                              + "T_BILLKIND,"
                                              + "T_BO,"
                                              + "T_ISSUER,"
                                              + "T_ISSUERNAME,"
                                              + "T_CODE711,"
                                              + "T_ISSUERINN,"
                                              + "T_ISSUERINN_MARK,"
                                              + "T_ISSUERINN_TIN,"
                                              + "T_ISSUERNOTRESCODE,"
                                              + "T_ISSUERCOUNTRYCODE,"
                                              + "T_SERIES,"
                                              + "T_NUMBER,"
                                              + "T_NUMBERLAST,"
                                              + "T_FORMNUMBER,"
                                              + "T_ISSUEDATE,"
                                              + "T_TERMFORMULA,"
                                              + "T_FACEVALUE,"
                                              + "T_FACEVALUEFICODE,"
                                              + "T_DEALDATE,"
                                              + "T_DEALGROUND,"
                                              + "T_DEALAGENTNAME,"
                                              + "T_DEALAGENTINN,"
                                              + "T_DEALAGENTINN_MARK,"
                                              + "T_DEALAGENTINN_TIN,"
                                              + "T_DEALAGENTNOTRESCODE,"
                                              + "T_DEALAGENTCOUNTRYCODE,"
                                              + "T_BALANCECOST,"
                                              + "T_INTEREST,"
                                              + "T_BALANCEACCNUM,"
                                              + "T_STORAGEPLACEID,"
                                              + "T_STORAGEPLACENAME,"
                                              + "T_STORAGEPLACEINN,"
                                              + "T_STORAGEPLACEINN_MARK,"
                                              + "T_STORAGEPLACEINN_TIN,"
                                              + "T_STORAGEPLACENOTRESCODE,"
                                              + "T_STORAGEPLACECOUNTRYCODE,"
                                              + "T_STORAGEGROUND,"
                                              + "T_FIRSTHOLDERNAME,"
                                              + "T_FIRSTHOLDERINN,"
                                              + "T_FIRSTHOLDERINN_MARK,"
                                              + "T_FIRSTHOLDERINN_TIN,"
                                              + "T_FIRSTHOLDERNOTRESCODE,"
                                              + "T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "T_STATE,"
                                              + "T_HOLDERID,"
                                              + "T_HOLDERNAME,"
                                              + "T_HOLDERINN,"
                                              + "T_HOLDERINN_MARK,"
                                              + "T_HOLDERINN_TIN,"
                                              + "T_HOLDERNOTRESCODE,"
                                              + "T_HOLDERCOUNTRYCODE,"
                                              + "T_NOTE )"
                                      + " SELECT 0, "                                         //"T_AUTOKEY,"
                                              + "bnr.t_BCID, "                                //"T_BCID,"
                                              + BILLKIND_ACCOUNTED + ", "                     //"T_BILLKIND,"
                                              + "'"+BO_VA+"', "                               //"T_BO,"
                                              + "bnr.t_Issuer, "                              //"T_ISSUER,"
                                              + " ( case when issuer.t_NotResident <> CHR(0) "
                                              + "        then ( case when issuer.t_LatName <> CHR(1) "
                                              + "                    then issuer.t_LatName "
                                              + "                    else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "               end ) "
                                              + "        else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "    end ), "                                 //"T_ISSUERNAME,"
                                              + "CHR(1), "                                    //"T_CODE711,"
                                              + "CHR(1), "                                    //"T_ISSUERINN,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_MARK,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_TIN,"
                                              + "CHR(1), "                                    //"T_ISSUERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_ISSUERCOUNTRYCODE,"
                                              + "bnr.t_BCSeries, "                            //"T_SERIES,"
                                              + "trim(bnr.t_BCNumber), "                      //"T_NUMBER,"
                                              + "CHR(1), "                                    //"T_NUMBERLAST,"
                                              + "CHR(1),"                                     //"T_FORMNUMBER,"
                                              + "leg.t_Start, "                               //"T_ISSUEDATE,"
                                              + "CHR(1), "                                    //"T_TERMFORMULA,"
                                              + "leg.t_Principal, "                           //"T_FACEVALUE,"
                                              + "fvfin.t_ISO_NUmber, "                        //"T_FACEVALUEFICODE,"
                                              + GetSQLDate(ZeroDate)+", "                     //"T_DEALDATE,"
                                              + "CHR(1), "                                    //"T_DEALGROUND,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNAME,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_MARK,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_TIN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_DEALAGENTCOUNTRYCODE,"
                                              + "0, "                                         //"T_BALANCECOST,"
                                              + "0, "                                         //"T_INTEREST,"
                                              + "CHR(1), "                                    //"T_BALANCEACCNUM,"
                                              + "-1, "                                        //"T_STORAGEPLACEID,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENAME,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_MARK,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_TIN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENOTRESCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACECOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEGROUND,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNAME,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STATE,"
                                              + "-1, "                                        //"T_HOLDER,
                                              + "CHR(1), "                                    //"T_HOLDERNAME,"
                                              + "CHR(1), "                                    //"T_HOLDERINN,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_HOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_HOLDERCOUNTRYCODE,"
                                              + "CHR(1)  "                                    //"T_NOTE )"
                                      + " FROM dvsbanner_dbt bnr, ddl_leg_dbt leg, dparty_dbt issuer, dfininstr_dbt fvfin, dfininstr_dbt bf, dpartyname_dbt issname "
                                      + " WHERE bnr.t_RegistrationDate <= " + GetSQLDate(date(RepDate))
                                      + "   AND bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE  //анкета векселя
                                      + "   AND bnr.t_Issuer NOT IN (SELECT dep.t_PartyID from ddp_dep_dbt dep) "
                                      + "   AND bnr.t_Department IN ("+Departments+") "
                                      + "   AND (   rsb_bill.GetVABnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VABANNER_STATUS_ACCOUNT //учтен
                                      + "        OR EXISTS(SELECT 1 "
                                      + "                    FROM dvsbnrbck_dbt bck "
                                      + "                   WHERE bck.t_BCID = bnr.t_BCID "
                                      + "                     AND bck.t_ChangeDate >=  " + GetSQLDate(date(BeginRepDate))
                                      + "                     AND bck.t_ChangeDate <=  " + GetSQLDate(date(RepDate))
                                      + "                     AND bck.t_NewABCStatus <> " + VABANNER_STATUS_ACCOUNT
                                      + "                     AND bck.t_OldABCStatus = " + VABANNER_STATUS_ACCOUNT
                                      + "           )"
                                      + "       )"
                                      + "   AND rsb_bill.GetVABnrClientOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = -1 "
                                      + "   AND bf.t_FIID = bnr.t_FIID "
                                      + "   AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", bf.t_AvoirKind) > 0 "
                                      + "   AND leg.t_LegKind = " + LEG_KIND_VSBANNER  // Ценовые условия векселя
                                      + "   AND leg.t_DealID = bnr.t_BCID "
                                      + "   AND leg.t_LegID = 0 "
                                      + "   AND issuer.t_PartyID = bnr.t_Issuer "
                                      + "   AND fvfin.t_FIID = leg.t_PFI "
                                      + "   AND rsb_bill.GetVABnrBOOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = '"+BO_VA+"'" //учтен в подсистеме учтенные векселя
                                      + "   AND issname.t_PARTYID (+)= issuer.t_PartyID "
                                      + "   AND issname.T_NAMETYPEID (+)= " + PTKN_BANKNAME;

          SQL_Execute(query, "Сбор данных о векселях, учтенных кредитной организацией", true );

        end;
      end;

      //2. Данные по "прочие"
      if((BillKind == BILLKIND_ALL) or (BillKind == BILLKIND_OTHER)) //все или прочие
        GetRegistryValue( "REPTREG\\REP_GROUPS\\ФОРМА 711\\ДАННЫЕ БЭК-ОФИСОВ\\УЧТЕННЫЕ ВЕКСЕЛЯ", V_BOOL, ShowBnr, err );
        if((not err) and (ShowBnr == true)) //только если задана настройка
          query =   " INSERT INTO "+TmpTable+" ("
                                              + "T_AUTOKEY,"
                                              + "T_BCID,"
                                              + "T_BILLKIND,"
                                              + "T_BO,"
                                              + "T_ISSUER,"
                                              + "T_ISSUERNAME,"
                                              + "T_CODE711,"
                                              + "T_ISSUERINN,"
                                              + "T_ISSUERINN_MARK,"
                                              + "T_ISSUERINN_TIN,"
                                              + "T_ISSUERNOTRESCODE,"
                                              + "T_ISSUERCOUNTRYCODE,"
                                              + "T_SERIES,"
                                              + "T_NUMBER,"
                                              + "T_NUMBERLAST,"
                                              + "T_FORMNUMBER,"
                                              + "T_ISSUEDATE,"
                                              + "T_TERMFORMULA,"
                                              + "T_FACEVALUE,"
                                              + "T_FACEVALUEFICODE,"
                                              + "T_DEALDATE,"
                                              + "T_DEALGROUND,"
                                              + "T_DEALAGENTNAME,"
                                              + "T_DEALAGENTINN,"
                                              + "T_DEALAGENTINN_MARK,"
                                              + "T_DEALAGENTINN_TIN,"
                                              + "T_DEALAGENTNOTRESCODE,"
                                              + "T_DEALAGENTCOUNTRYCODE,"
                                              + "T_BALANCECOST,"
                                              + "T_INTEREST,"
                                              + "T_BALANCEACCNUM,"
                                              + "T_STORAGEPLACEID,"
                                              + "T_STORAGEPLACENAME,"
                                              + "T_STORAGEPLACEINN,"
                                              + "T_STORAGEPLACEINN_MARK,"
                                              + "T_STORAGEPLACEINN_TIN,"
                                              + "T_STORAGEPLACENOTRESCODE,"
                                              + "T_STORAGEPLACECOUNTRYCODE,"
                                              + "T_STORAGEGROUND,"
                                              + "T_FIRSTHOLDERNAME,"
                                              + "T_FIRSTHOLDERINN,"
                                              + "T_FIRSTHOLDERINN_MARK,"
                                              + "T_FIRSTHOLDERINN_TIN,"
                                              + "T_FIRSTHOLDERNOTRESCODE,"
                                              + "T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "T_STATE,"
                                              + "T_HOLDERID,"
                                              + "T_HOLDERNAME,"
                                              + "T_HOLDERINN,"
                                              + "T_HOLDERINN_MARK,"
                                              + "T_HOLDERINN_TIN,"
                                              + "T_HOLDERNOTRESCODE,"
                                              + "T_HOLDERCOUNTRYCODE,"
                                              + "T_NOTE )"
                                      + " SELECT 0, "                                         //"T_AUTOKEY,"
                                              + "bnr.t_BCID, "                                //"T_BCID,"
                                              + BILLKIND_OTHER + ", "                         //"T_BILLKIND,"
                                              + "'"+BO_VA+"', "                               //"T_BO,"
                                              + "bnr.t_Issuer, "                              //"T_ISSUER,"
                                              + " ( case when issuer.t_NotResident <> CHR(0) "
                                              + "        then ( case when issuer.t_LatName <> CHR(1) "
                                              + "                    then issuer.t_LatName "
                                              + "                    else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "               end ) "
                                              + "        else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "    end ), "                                 //"T_ISSUERNAME,"
                                              + "CHR(1), "                                    //"T_CODE711,"
                                              + "CHR(1), "                                    //"T_ISSUERINN,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_MARK,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_TIN,"
                                              + "CHR(1), "                                    //"T_ISSUERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_ISSUERCOUNTRYCODE,"
                                              + "bnr.t_BCSeries, "                            //"T_SERIES,"
                                              + "trim(bnr.t_BCNumber), "                      //"T_NUMBER,"
                                              + "CHR(1), "                                    //"T_NUMBERLAST,"
                                              + "CHR(1),"                                     //"T_FORMNUMBER,"
                                              //+ "bnr.t_IssueDate, "                         //"T_ISSUEDATE,"
                                              + "leg.t_Start, "                               //"T_ISSUEDATE,"
                                              + "CHR(1), "                                    //"T_TERMFORMULA,"
                                              + "leg.t_Principal, "                           //"T_FACEVALUE,"
                                              + "fvfin.t_ISO_NUmber, "                        //"T_FACEVALUEFICODE,"
                                              + GetSQLDate(ZeroDate)+", "                     //"T_DEALDATE,"
                                              + "CHR(1), "                                    //"T_DEALGROUND,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNAME,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_MARK,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_TIN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_DEALAGENTCOUNTRYCODE,"
                                              + "0, "                                         //"T_BALANCECOST,"
                                              + "0, "                                         //"T_INTEREST,"
                                              + "CHR(1), "                                    //"T_BALANCEACCNUM,"
                                              + "-1, "                                        //"T_STORAGEPLACEID,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENAME,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_MARK,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_TIN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENOTRESCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACECOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEGROUND,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNAME,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STATE,"
                                              + "-1, "                                        //"T_HOLDER,
                                              + "CHR(1), "                                    //"T_HOLDERNAME,"
                                              + "CHR(1), "                                    //"T_HOLDERINN,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_HOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_HOLDERCOUNTRYID,"
                                              + "CHR(1)  "                                    //"T_NOTE )"
                                      + " FROM dvsbanner_dbt bnr, ddl_leg_dbt leg, dparty_dbt issuer, dfininstr_dbt fvfin, dfininstr_dbt bf, dpartyname_dbt issname "
                                      + " WHERE bnr.t_RegistrationDate <= " + GetSQLDate(date(RepDate))
                                      + "   AND bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE  //анкета векселя
                                      + "   AND bnr.t_Issuer NOT IN (SELECT dep.t_PartyID from ddp_dep_dbt dep) "
                                      + "   AND bnr.t_Department IN ("+Departments+") "
                                      + "   AND instr(rsb_bill.GetVABnrStateOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+"), 'З') != 0 "  //принят в залог
                                      + "   AND bf.t_FIID = bnr.t_FIID "
                                      + "   AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", bf.t_AvoirKind) > 0 "
                                      + "   AND leg.t_LegKind = " + LEG_KIND_VSBANNER  // Ценовые условия векселя
                                      + "   AND leg.t_DealID = bnr.t_BCID "
                                      + "   AND leg.t_LegID = 0 "
                                      + "   AND issuer.t_PartyID = bnr.t_Issuer "
                                      + "   AND fvfin.t_FIID = leg.t_PFI "
                                      + "   AND issname.t_PARTYID (+)= issuer.t_PartyID "
                                      + "   AND issname.T_NAMETYPEID (+)= " + PTKN_BANKNAME;

                   SQL_Execute(query, "Сбор данных о прочих учтенных векселях", true )

        end;

        GetRegistryValue( "REPTREG\\REP_GROUPS\\ФОРМА 711\\ДАННЫЕ БЭК-ОФИСОВ\\ДОВЕРИТЕЛЬНОЕ УПРАВЛЕНИЕ", V_BOOL, ShowBnr, err );
        if((not err) and (ShowBnr == true)) //только если задана настройка

          query =   " INSERT INTO "+TmpTable+" ("
                                              + "T_AUTOKEY,"
                                              + "T_BCID,"
                                              + "T_BILLKIND,"
                                              + "T_BO,"
                                              + "T_ISSUER,"
                                              + "T_ISSUERNAME,"
                                              + "T_CODE711,"
                                              + "T_ISSUERINN,"
                                              + "T_ISSUERINN_MARK,"
                                              + "T_ISSUERINN_TIN,"
                                              + "T_ISSUERNOTRESCODE,"
                                              + "T_ISSUERCOUNTRYCODE,"
                                              + "T_SERIES,"
                                              + "T_NUMBER,"
                                              + "T_NUMBERLAST,"
                                              + "T_FORMNUMBER,"
                                              + "T_ISSUEDATE,"
                                              + "T_TERMFORMULA,"
                                              + "T_FACEVALUE,"
                                              + "T_FACEVALUEFICODE,"
                                              + "T_DEALDATE,"
                                              + "T_DEALGROUND,"
                                              + "T_DEALAGENTNAME,"
                                              + "T_DEALAGENTINN,"
                                              + "T_DEALAGENTINN_MARK,"
                                              + "T_DEALAGENTINN_TIN,"
                                              + "T_DEALAGENTNOTRESCODE,"
                                              + "T_DEALAGENTCOUNTRYCODE,"
                                              + "T_BALANCECOST,"
                                              + "T_INTEREST,"
                                              + "T_BALANCEACCNUM,"
                                              + "T_STORAGEPLACEID,"
                                              + "T_STORAGEPLACENAME,"
                                              + "T_STORAGEPLACEINN,"
                                              + "T_STORAGEPLACEINN_MARK,"
                                              + "T_STORAGEPLACEINN_TIN,"
                                              + "T_STORAGEPLACENOTRESCODE,"
                                              + "T_STORAGEPLACECOUNTRYCODE,"
                                              + "T_STORAGEGROUND,"
                                              + "T_FIRSTHOLDERNAME,"
                                              + "T_FIRSTHOLDERINN,"
                                              + "T_FIRSTHOLDERINN_MARK,"
                                              + "T_FIRSTHOLDERINN_TIN,"
                                              + "T_FIRSTHOLDERNOTRESCODE,"
                                              + "T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "T_STATE,"
                                              + "T_HOLDERID,"
                                              + "T_HOLDERNAME,"
                                              + "T_HOLDERINN,"
                                              + "T_HOLDERINN_MARK,"
                                              + "T_HOLDERINN_TIN,"
                                              + "T_HOLDERNOTRESCODE,"
                                              + "T_HOLDERCOUNTRYCODE,"
                                              + "T_NOTE )"
                                      + " SELECT 0, "                                         //"T_AUTOKEY,"
                                              + "bnr.t_BCID, "                                //"T_BCID,"
                                              + BILLKIND_OTHER + ", "                         //"T_BILLKIND,"
                                              + "'"+BO_TRUST+"', "                            //"T_BO,"
                                              + "bnr.t_Issuer, "                              //"T_ISSUER,"
                                              + " ( case when issuer.t_NotResident <> CHR(0) "
                                              + "        then ( case when issuer.t_LatName <> CHR(1) "
                                              + "                    then issuer.t_LatName "
                                              + "                    else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "               end ) "
                                              + "        else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "    end ), "                                 //"T_ISSUERNAME,"
                                              + "CHR(1), "                                    //"T_CODE711,"
                                              + "CHR(1), "                                    //"T_ISSUERINN,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_MARK,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_TIN,"
                                              + "CHR(1), "                                    //"T_ISSUERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_ISSUERCOUNTRYCODE,"
                                              + "bnr.t_BCSeries, "                            //"T_SERIES,"
                                              + "trim(bnr.t_BCNumber), "                      //"T_NUMBER,"
                                              + "CHR(1), "                                    //"T_NUMBERLAST,"
                                              + "CHR(1),"                                     //"T_FORMNUMBER,"
                                              //+ "bnr.t_IssueDate, "                         //"T_ISSUEDATE,"
                                              + "leg.t_Start, "                               //"T_ISSUEDATE,"
                                              + "CHR(1), "                                    //"T_TERMFORMULA,"
                                              + "leg.t_Principal, "                           //"T_FACEVALUE,"
                                              + "fvfin.t_ISO_NUmber, "                        //"T_FACEVALUEFICODE,"
                                              + GetSQLDate(ZeroDate)+", "                     //"T_DEALDATE,"
                                              + "CHR(1), "                                    //"T_DEALGROUND,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNAME,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_MARK,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_TIN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_DEALAGENTCOUNTRYCODE,"
                                              + "0, "                                         //"T_BALANCECOST,"
                                              + "0, "                                         //"T_INTEREST,"
                                              + "CHR(1), "                                    //"T_BALANCEACCNUM,"
                                              + "-1, "                                        //"T_STORAGEPLACEID
                                              + "CHR(1), "                                    //"T_STORAGEPLACENAME,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_MARK,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_TIN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENOTRESCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACECOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEGROUND,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNAME,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STATE,"
                                              + "-1, "                                        //"T_HOLDER,
                                              + "CHR(1), "                                    //"T_HOLDERNAME,"
                                              + "CHR(1), "                                    //"T_HOLDERINN,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_HOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_HOLDERCOUNTRYCODE,"
                                              + "CHR(1)  "                                    //"T_NOTE )"
                                      + " FROM dvsbanner_dbt bnr, ddl_leg_dbt leg, dparty_dbt issuer, dfininstr_dbt fvfin, dfininstr_dbt bf, dpartyname_dbt issname "
                                      + " WHERE bnr.t_RegistrationDate <= " + GetSQLDate(date(RepDate))
                                      + "   AND bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE  //анкета векселя
                                      + "   AND bnr.t_Issuer NOT IN (SELECT dep.t_PartyID from ddp_dep_dbt dep) "
                                      + "   AND bnr.t_Department IN ("+Departments+") "
                                      + "   AND rsb_bill.GetVABnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VABANNER_STATUS_ACCOUNT //учтен
                                      + "   AND bf.t_FIID = bnr.t_FIID "
                                      + "   AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", bf.t_AvoirKind) > 0 "
                                      + "   AND leg.t_LegKind = " + LEG_KIND_VSBANNER  // Ценовые условия векселя
                                      + "   AND leg.t_DealID = bnr.t_BCID "
                                      + "   AND leg.t_LegID = 0 "
                                      + "   AND issuer.t_PartyID = bnr.t_Issuer "
                                      + "   AND fvfin.t_FIID = leg.t_PFI "
                                      + "   AND rsb_bill.GetVABnrBOOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = '"+BO_TRUST+"'" //учтен в подсистеме учтенные векселя
                                      + "   AND issname.t_PARTYID (+)= issuer.t_PartyID "
                                      + "   AND issname.T_NAMETYPEID (+)= " + PTKN_BANKNAME;

        SQL_Execute(query, "Сбор данных о прочих учтенных векселях в доверительном управлении", true );
        end;
      end;

      //3. Данные по "Собственным"
      if((BillKind == BILLKIND_ALL) or (BillKind == BILLKIND_OUR)) //все или собственные
        GetRegistryValue( "REPTREG\\REP_GROUPS\\ФОРМА 711\\ДАННЫЕ БЭК-ОФИСОВ\\ВЕКСЕЛЯ БАНКА", V_BOOL, ShowBnr, err );
        if((not err) and (ShowBnr == true)) //только если задана настройка

          if(Conforms2835(Mode))
            SqlCond4EndedBills = "      OR ( rsb_bill.GetVSBnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VSBANNER_STATUS_ENDED //погашен в отчетном периоде
                               + "         AND bnr.t_RepaymentDate >= "+GetSQLDate(date(BeginRepDate))+")";
          end;

          SqlCond4PawnBills = "      OR rsb_bill.GetVSBnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VSBANNER_STATUS_PAWN;

          query =   " INSERT INTO "+TmpTable+" ("
                                              + "T_AUTOKEY,"
                                              + "T_BCID,"
                                              + "T_BILLKIND,"
                                              + "T_BO,"
                                              + "T_ISSUER,"
                                              + "T_ISSUERNAME,"
                                              + "T_CODE711,"
                                              + "T_ISSUERINN,"
                                              + "T_ISSUERINN_MARK,"
                                              + "T_ISSUERINN_TIN,"
                                              + "T_ISSUERNOTRESCODE,"
                                              + "T_ISSUERCOUNTRYCODE,"
                                              + "T_SERIES,"
                                              + "T_NUMBER,"
                                              + "T_NUMBERLAST,"
                                              + "T_FORMNUMBER,"
                                              + "T_ISSUEDATE,"
                                              + "T_TERMFORMULA,"
                                              + "T_FACEVALUE,"
                                              + "T_FACEVALUEFICODE,"
                                              + "T_DEALDATE,"
                                              + "T_DEALGROUND,"
                                              + "T_DEALAGENTNAME,"
                                              + "T_DEALAGENTINN,"
                                              + "T_DEALAGENTINN_MARK,"
                                              + "T_DEALAGENTINN_TIN,"
                                              + "T_DEALAGENTNOTRESCODE,"
                                              + "T_DEALAGENTCOUNTRYCODE,"
                                              + "T_BALANCECOST,"
                                              + "T_INTEREST,"
                                              + "T_BALANCEACCNUM,"
                                              + "T_STORAGEPLACEID,"
                                              + "T_STORAGEPLACENAME,"
                                              + "T_STORAGEPLACEINN,"
                                              + "T_STORAGEPLACEINN_MARK,"
                                              + "T_STORAGEPLACEINN_TIN,"
                                              + "T_STORAGEPLACENOTRESCODE,"
                                              + "T_STORAGEPLACECOUNTRYCODE,"
                                              + "T_STORAGEGROUND,"
                                              + "T_FIRSTHOLDERNAME,"
                                              + "T_FIRSTHOLDERINN,"
                                              + "T_FIRSTHOLDERINN_MARK,"
                                              + "T_FIRSTHOLDERINN_TIN,"
                                              + "T_FIRSTHOLDERNOTRESCODE,"
                                              + "T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "T_STATE,"
                                              + "T_HOLDERID,"
                                              + "T_HOLDERNAME,"
                                              + "T_HOLDERINN,"
                                              + "T_HOLDERINN_MARK,"
                                              + "T_HOLDERINN_TIN,"
                                              + "T_HOLDERNOTRESCODE,"
                                              + "T_HOLDERCOUNTRYCODE,"
                                              + "T_NOTE )"
                                      + " SELECT 0, "                                         //"T_AUTOKEY,"
                                              + "bnr.t_BCID, "                                //"T_BCID,"
                                              + BILLKIND_OUR + ", "                           //"T_BILLKIND,"
                                              + "'"+BO_VS+"', "                               //"T_BO,"
                                              + "bnr.t_Issuer, "                              //"T_ISSUER,"
                                              + " ( case when issuer.t_NotResident <> CHR(0) "
                                              + "        then ( case when issuer.t_LatName <> CHR(1) "
                                              + "                    then issuer.t_LatName "
                                              + "                    else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "               end ) "
                                              + "        else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                              + "    end ), "                                 //"T_ISSUERNAME,"
                                              + "CHR(1), "                                    //"T_CODE711,"
                                              + "CHR(1), "                                    //"T_ISSUERINN,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_MARK,"
                                              + "CHR(1), "                                    //"T_ISSUERINN_TIN,"
                                              + "CHR(1), "                                    //"T_ISSUERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_ISSUERCOUNTRYCODE,"
                                              + "bnr.t_BCSeries, "                            //"T_SERIES,"
                                              + "trim(bnr.t_BCNumber), "                      //"T_NUMBER,"
                                              + "CHR(1), "                                    //"T_NUMBERLAST,"
                                              + "CHR(1),"                                     //"T_FORMNUMBER,"
                                              //+ "bnr.t_IssueDate, "                         //"T_ISSUEDATE,"
                                              + "leg.t_Start, "                               //"T_ISSUEDATE,"
                                              + "CHR(1), "                                    //"T_TERMFORMULA,"
                                              + "leg.t_Principal, "                           //"T_FACEVALUE,"
                                              + "fvfin.t_ISO_NUmber, "                        //"T_FACEVALUEFICODE,"
                                              + GetSQLDate(ZeroDate)+", "                     //"T_DEALDATE,"
                                              + "CHR(1), "                                    //"T_DEALGROUND,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNAME,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_MARK,"
                                              + "CHR(1), "                                    //"T_DEALAGENTINN_TIN,"
                                              + "CHR(1), "                                    //"T_DEALAGENTNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_DEALAGENTCOUNTRYCODE,"
                                              + "0, "                                         //"T_BALANCECOST,"
                                              + "0, "                                         //"T_INTEREST,"
                                              + "CHR(1), "                                    //"T_BALANCEACCNUM,"
                                              + "-1, "                                        //"T_STORAGEPLACEID,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENAME,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_MARK,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACEINN_TIN,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACENOTRESCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEPLACECOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STORAGEGROUND,"
                                              + "DECODE(hldname.t_name, NULL, bnr.t_HolderName, hldname.t_name), " //"T_FIRSTHOLDERNAME,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_FIRSTHOLDERCOUNTRYCODE,"
                                              + "CHR(1), "                                    //"T_STATE,"
                                              + "-1, "                                        //"T_HOLDER,"
                                              + "CHR(1), "                                    //"T_HOLDERNAME,"
                                              + "CHR(1), "                                    //"T_HOLDERINN,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_MARK,"
                                              + "CHR(1), "                                    //"T_HOLDERINN_TIN,"
                                              + "CHR(1), "                                    //"T_HOLDERNOTRESCODE,"
                                              + "CHR(1), "                                    //"T_HOLDERCOUNTRYCODE,"
                                              + "CHR(1)  "                                    //"T_NOTE )"
                                      + " FROM dvsbanner_dbt bnr, ddl_leg_dbt leg, dparty_dbt issuer, dfininstr_dbt fvfin, dfininstr_dbt bf, dpartyname_dbt issname, dpartyname_dbt hldname "
                                      + " WHERE bnr.t_RegistrationDate <= " + GetSQLDate(date(RepDate))
                                      + "   AND bnr.t_BCFormKind = " + VSBANNER_FORMKIND_SIMPLE  //анкета векселя
                                      + "   AND bnr.t_Issuer IN (SELECT dep.t_PartyID from ddp_dep_dbt dep) "
                                      + "   AND bnr.t_Department IN ("+Departments+") "
                                      + "   AND ( rsb_bill.GetVSBnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VSBANNER_STATUS_FORMED //оформлен
                                      + "      OR rsb_bill.GetVSBnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VSBANNER_STATUS_SENDED //выдан
                                      + "      OR rsb_bill.GetVSBnrStatusOnDate(bnr.t_BCID, "+GetSQLDate(date(RepDate))+") = " + VSBANNER_STATUS_REDEEMED //выкуплен
                                      + SqlCond4EndedBills
                                      + SqlCond4PawnBills
                                      + "       )"
                                      + "   AND bf.t_FIID = bnr.t_FIID "
                                      + "   AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", bf.t_AvoirKind) > 0 "
                                      + "   AND leg.t_LegKind = " + LEG_KIND_VSBANNER  // Ценовые условия векселя
                                      + "   AND leg.t_DealID = bnr.t_BCID "
                                      + "   AND leg.t_LegID = 0 "
                                      + "   AND issuer.t_PartyID = bnr.t_Issuer "
                                      + "   AND fvfin.t_FIID = leg.t_PFI "
                                      + "   AND issname.t_PARTYID (+)= issuer.t_PartyID "
                                      + "   AND issname.T_NAMETYPEID (+)= " + PTKN_BANKNAME
                                      + "   AND hldname.t_PARTYID (+)= bnr.t_Holder "
                                      + "   AND hldname.T_NAMETYPEID (+)= " + PTKN_BANKNAME;

          SQL_Execute(query, "Сбор данных о векселях, выпущенных кредитной организацией", true );

        end;
      end;

      //4. Данные по ИК
      GetRegistryValue( "REPTREG\\REP_GROUPS\\ФОРМА 711\\ДАННЫЕ БЭК-ОФИСОВ\\ДЕПОЗИТАРИЙ", V_BOOL, ShowBnr, err );
      if((not err) and (ShowBnr == true)) //только если задана настройка

        if(BillKind == BILLKIND_OUR) //только собственные
          subquery = " AND bnr.t_Issuer IN (SELECT dep.t_PartyID from ddp_dep_dbt dep)";
        elif((BillKind == BILLKIND_ACCOUNTED) OR (BillKind == BILLKIND_OTHER)) //учтенные или прочие
          subquery = " AND bnr.t_Issuer NOT IN (SELECT dep.t_PartyID from ddp_dep_dbt dep)";
        end;
        if(BillKind == BILLKIND_ACCOUNTED)
          accsubquery = " AND accP.t_Client IN (SELECT dep.t_PartyID from ddp_dep_dbt dep where dep.t_Code = ic.t_Department)";
        elif(BillKind == BILLKIND_OTHER)
          accsubquery = " AND accP.t_Client NOT IN (SELECT dep.t_PartyID from ddp_dep_dbt dep where dep.t_Code = ic.t_Department)";
        end;

        icDealDateQuery =  "select NVL(max(ch.t_StatusDate),"+GetSQLDate(ZeroDate)+") as StatusDate from dinvchng_dbt ch "
                         + "  where ch.t_InvCardID = ic.t_InvCardID "
                         + "    and ch.t_ChangeDate <= " + GetSQLDate(RepDate)
                         + "    and ch.t_Status = " + INVCARD_STATUS_INCUSTODY;

        query =   " INSERT INTO "+TmpTable+" ("
                                    + "T_AUTOKEY,"
                                    + "T_BCID,"
                                    + "T_BILLKIND,"
                                    + "T_BO,"
                                    + "T_ISSUER,"
                                    + "T_ISSUERNAME,"
                                    + "T_CODE711,"
                                    + "T_ISSUERINN,"
                                    + "T_ISSUERINN_MARK,"
                                    + "T_ISSUERINN_TIN,"
                                    + "T_ISSUERNOTRESCODE,"
                                    + "T_ISSUERCOUNTRYCODE,"
                                    + "T_SERIES,"
                                    + "T_NUMBER,"
                                    + "T_NUMBERLAST,"
                                    + "T_FORMNUMBER,"
                                    + "T_ISSUEDATE,"
                                    + "T_TERMFORMULA,"
                                    + "T_FACEVALUE,"
                                    + "T_FACEVALUEFICODE,"
                                    + "T_DEALDATE,"
                                    + "T_DEALGROUND,"
                                    + "T_DEALAGENTNAME,"
                                    + "T_DEALAGENTINN,"
                                    + "T_DEALAGENTINN_MARK,"
                                    + "T_DEALAGENTINN_TIN,"
                                    + "T_DEALAGENTNOTRESCODE,"
                                    + "T_DEALAGENTCOUNTRYCODE,"
                                    + "T_BALANCECOST,"
                                    + "T_INTEREST,"
                                    + "T_BALANCEACCNUM,"
                                    + "T_STORAGEPLACEID,"
                                    + "T_STORAGEPLACENAME,"
                                    + "T_STORAGEPLACEINN,"
                                    + "T_STORAGEPLACEINN_MARK,"
                                    + "T_STORAGEPLACEINN_TIN,"
                                    + "T_STORAGEPLACENOTRESCODE,"
                                    + "T_STORAGEPLACECOUNTRYCODE,"
                                    + "T_STORAGEGROUND,"
                                    + "T_FIRSTHOLDERNAME,"
                                    + "T_FIRSTHOLDERINN,"
                                    + "T_FIRSTHOLDERINN_MARK,"
                                    + "T_FIRSTHOLDERINN_TIN,"
                                    + "T_FIRSTHOLDERNOTRESCODE,"
                                    + "T_FIRSTHOLDERCOUNTRYCODE,"
                                    + "T_STATE,"
                                    + "T_HOLDERID,"
                                    + "T_HOLDERNAME,"
                                    + "T_HOLDERINN,"
                                    + "T_HOLDERINN_MARK,"
                                    + "T_HOLDERINN_TIN,"
                                    + "T_HOLDERNOTRESCODE,"
                                    + "T_HOLDERCOUNTRYCODE,"
                                    + "T_NOTE, "
                                    + "T_SALEDATE )"
                            + " SELECT 0, "                                         //"T_AUTOKEY,"
                                    + "bnr.t_BCID, "                                //"T_BCID,"
                                    + " (CASE WHEN "+BillKind+" > "+BILLKIND_ALL+" THEN " + BillKind
                                    + "      ELSE "
                                    + "        (CASE WHEN ficert.t_Issuer IN (SELECT dep.t_PartyID from ddp_dep_dbt dep) THEN " + BILLKIND_OUR
                                    + "             WHEN acc.t_Client IN (SELECT dep.t_PartyID from ddp_dep_dbt dep where dep.t_Code = ic.t_Department) THEN " + BILLKIND_ACCOUNTED
                                    + "             ELSE " + BILLKIND_OTHER
                                    + "        END)"
                                    + " END),"                                      //T_BILLKIND
                                    + "'"+BO_DEPO+"', "                             //"T_BO,"
                                    + "ficert.t_Issuer, "                           //"T_ISSUER,"
                                    + " ( case when issuer.t_NotResident <> CHR(0) "
                                    + "        then ( case when issuer.t_LatName <> CHR(1) "
                                    + "                    then issuer.t_LatName "
                                    + "                    else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                    + "               end ) "
                                    + "        else DECODE(issname.t_name, NULL, issuer.t_Name, issname.t_name) "
                                    + "    end ), "                                 //"T_ISSUERNAME,"
                                    + "CHR(1), "                                    //"T_CODE711,"
                                    + "CHR(1), "                                    //"T_ISSUERINN,"
                                    + "CHR(1), "                                    //"T_ISSUERINN_MARK,"
                                    + "CHR(1), "                                    //"T_ISSUERINN_TIN,"
                                    + "CHR(1), "                                    //"T_ISSUERNOTRESCODE,"
                                    + "CHR(1), "                                    //"T_ISSUERCOUNTRYCODE,"
                                    + "ficert.t_Series, "                           //"T_SERIES,"
                                    + "trim(ficert.t_Number), "                     //"T_NUMBER,"
                                    + "trim(ficert.t_Number), "                     //"T_NUMBERLAST,"
                                    + "CHR(1),"                                     //"T_FORMNUMBER,"
                                    + "ficert.t_IssueDate, "                        //"T_ISSUEDATE,"
                                    + "CHR(1), "                                    //"T_TERMFORMULA,"
                                    + "ficert.t_FaceValue, "                        //"T_FACEVALUE,"
                                    + "fvfin.t_ISO_NUmber, "                        //"T_FACEVALUEFICODE,"
                                    + "(CASE WHEN ic.t_ChangeDate <= "+GetSQLDate(date(RepDate))+" and ic.t_Status = "+INVCARD_STATUS_INCUSTODY+" THEN ic.t_StatusDate ELSE ("+icDealDateQuery+") END), "                    //"T_DEALDATE,"
                                    + "CHR(1), "                                    //"T_DEALGROUND,"
                                    + "CHR(1), "                                    //"T_DEALAGENTNAME,"
                                    + "CHR(1), "                                    //"T_DEALAGENTINN,"
                                    + "CHR(1), "                                    //"T_DEALAGENTINN_MARK,"
                                    + "CHR(1), "                                    //"T_DEALAGENTINN_TIN,"
                                    + "CHR(1), "                                    //"T_DEALAGENTNOTRESCODE,"
                                    + "CHR(1), "                                    //"T_DEALAGENTCOUNRTYCODE,"
                                    + "0, "                                         //"T_BALANCECOST,"
                                    + "0, "                                         //"T_INTEREST,"
                                    + "CHR(1), "                                    //"T_BALANCEACCNUM,"
                                    + "stor.t_PartyID, "                            //T_STORAGEPLACEID
                                    + "DECODE(storname.t_name, NULL, stor.t_Name, storname.t_name), "//"T_STORAGEPLACENAME,"
                                    + "CHR(1), "                                    //"T_STORAGEPLACEINN,"
                                    + "CHR(1), "                                    //"T_STORAGEPLACEINN_MARK,"
                                    + "CHR(1), "                                    //"T_STORAGEPLACEINN_TIN,"
                                    + "CHR(1), "                                    //"T_STORAGEPLACENOTRESCODE,"
                                    + "CHR(1), "                                    //"T_STORAGEPLACECOUNTRYCODE,"
                                    + "CHR(1), "                                    //"T_STORAGEGROUND,"
                                    + "CHR(1), "                                    //"T_FIRSTHOLDERNAME,"
                                    + "CHR(1), "                                    //"T_FIRSTHOLDERINN,"
                                    + "CHR(1), "                                    //"T_FIRSTHOLDERINN_MARK,"
                                    + "CHR(1), "                                    //"T_FIRSTHOLDERINN_TIN,"
                                    + "CHR(1), "                                    //"T_FIRSTHOLDERNOTRESCODE,"
                                    + "CHR(1), "                                    //"T_FIRSTHOLDERCOUNTRYCODE,"
                                    + "CHR(1), "                                    //"T_STATE,"
                                    + "holder.t_PartyID, "                          //"T_HOLDER,"
                                    + "DECODE(ptname.t_name, NULL, holder.t_Name, ptname.t_name), " //"T_HOLDERNAME,"
                                    + "CHR(1), "                                    //"T_HOLDERINN,"
                                    + "CHR(1), "                                    //"T_HOLDERINN_MARK,"
                                    + "CHR(1), "                                    //"T_HOLDERINN_TIN,"
                                    + "CHR(1), "                                    //"T_HOLDERNOTRESCODE,"
                                    + "CHR(1), "                                    //"T_HOLDERCOUNTRYCODE,"
                                    + "CHR(1),  "                                    //"T_NOTE "
                                    + "(CASE WHEN rsb_depo.icstatus(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") = " + INVCARD_STATUS_WRITEOFF
                                    + "           THEN rsb_depo.icstatusdate(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") "
                                    + "      ELSE "+GetSQLDate(ZeroDate)+" END"
                                    + ")"                                            //"T_SALEDATE "
                            + " FROM dvsbanner_dbt bnr, dparty_dbt issuer, dfininstr_dbt fvfin, dinvcard_dbt ic, dv_ficert_dbt ficert, daccount_dbt acc, dparty_dbt stor, daccount_dbt accP, dparty_dbt holder, dpartyname_dbt ptname, dpartyname_dbt issname, dpartyname_dbt storname "
                            + " WHERE RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", ficert.t_AvoirKind) > 0 "
                            + "   AND ficert.t_CertID NOT IN (select t_BCID from "+TmpTable+") "
                            + "   AND ic.t_FiCertID = ficert.t_FiCertID "
                            + "   AND ic.t_RegistrDate <= " + GetSQLDate(date(RepDate))
                            + "   AND ic.t_Department IN ("+Departments+") "
                            + "   AND bnr.t_BCID = ficert.t_CertID "
                            + "   AND bnr.t_Department = ic.t_Department "
                            + subquery
                            + "   AND (   rsb_depo.icstatus(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") = " + INVCARD_STATUS_INCUSTODY  //на хранении
                            + "        OR (    rsb_depo.icstatus(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") = " + INVCARD_STATUS_WRITEOFF  //списана
                            + "            AND rsb_depo.icstatusdate(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") >= " + GetSQLDate(date(BeginRepDate)) //в отчетном периоде
                            + "           )"
                            + "       )"
                            + "   AND acc.t_AccountID = rsb_depo.iclastaccountid(ic.t_InvCardID, 1, "+GetSQLDate(date(RepDate))+") "
                            + accsubquery
                            + "   AND stor.t_PartyID = acc.t_Client "
                            + "   AND accP.t_AccountID = rsb_depo.iclastaccountid(ic.t_InvCardID, 0, "+GetSQLDate(date(RepDate))+") "
                            + "   AND holder.t_PartyID = accP.t_Client "
                            + "   AND issuer.t_PartyID = ficert.t_Issuer "
                            + "   AND fvfin.t_FIID = ficert.t_FaceValueFI "
                            + "   AND ptname.t_PARTYID (+)= holder.t_PartyID "
                            + "   AND ptname.T_NAMETYPEID (+)= " + PTKN_BANKNAME
                            + "   AND issname.t_PARTYID (+)= issuer.t_PartyID "
                            + "   AND issname.T_NAMETYPEID (+)= " + PTKN_BANKNAME
                            + "   AND storname.t_PARTYID (+)= stor.t_PartyID "
                            + "   AND storname.T_NAMETYPEID (+)= " + PTKN_BANKNAME;

          SQL_Execute(query, "Просмотр инвентарных карточек", true );
      end;

      GetRegistryValue( "ВЕКСЕЛЯ БАНКА\\РЕЖИМ РАБОТЫ\\НОМЕРНОЙ УЧЕТ БЛАНКОВ", V_BOOL, isFormNumber, err );

      //дозаполнение полей
      query =  "select bnr.t_FIID, bnr.t_BCSeries, bnr.t_BCNumber, bnr.t_BCTermFormula, bnr.t_BCTermFormat, "
             + "       bnr.t_Holder, bnr.t_Department, bnr.t_RepaymentDate, ficert.t_FiCertID, "
             + "       leg.t_Start, leg.t_Expiry, leg.t_Maturity, leg.t_Diff, leg.t_Duration, leg.t_PFI, "
             + "       b711.* "
             + "  from "+TmpTable+" b711, dvsbanner_dbt bnr, ddl_leg_dbt leg, dfininstr_dbt fin, dficert_dbt ficert "
             + " where bnr.t_BCID = b711.t_BCID "
             + "   AND leg.t_LegKind = " + LEG_KIND_VSBANNER  // Ценовые условия векселя
             + "   AND leg.t_DealID = bnr.t_BCID "
             + "   AND leg.t_LegID = 0 "
             + "   AND fin.t_FIID = bnr.t_FIID "
             + "   AND ficert.t_AvoirKind = fin.t_AvoirKind "
             + "   AND ficert.t_CertID = bnr.t_BCID "
             + " order by t_AutoKey ASC";

      DataSet = TRsbDataSet(query);
      while(DataSet.moveNext())
        FormNumber = "";
        TermFormula = "";
        dealid = 0; sumbuy=0.0; buyfi=0;
        DealDate = ZeroDate;
        DealGround = "";
        DealAgentINN = "";
        DealAgentINN_Mark = "";
        DealAgentINN_TIN = "";
        DealAgentNotResCode = "";
        DealAgentName = "";
        ClearRecord(Party);
        IssuerINN = "";
        IssuerINN_Mark = "";
        IssuerINN_TIN = "";
        IssuerNotResCode = "";
        Interest = 0.0; BalanceCost = 0.0;
        StoragePlaceName = "";
        Storage = "";
        StoragePlaceINN = "";
        StoragePlaceINN_TIN = "";
        StoragePlaceNotResCode = "";
        StoragePlaceINN_Mark = "";
        StorageGround = "";
        Note = "";
        vsform = "";
        FirstHolderINN = "";
        FirstHolderINN_Mark = "";
        FirstHolderINN_TIN = "";
        FirstHolderNotResCode = "";
        ds = "";
        CurrStatus = "";
        State = "";
        HolderName = "";
        HolderINN = "";
        HolderINN_Mark = "";
        HolderINN_TIN = "";
        HolderNotResCode = "";
        HolderID = -1;
        Code711 = "";
        ClearRecord(Fininstr);
        ClearRecord(Avoiriss);
        Account = "";
        BalanceAccNum = "";
        LastDocKind = 0;
        IssuerCountryCode = "";
        DealAgentCountryCode = "";
        StoragePlaceCountryCode = "";
        FirstHolderCountryCode = "";
        HolderCountryCode = "";
        IssuerCountryCode2 = "";
        DealAgentCountryCode2 = "";
        StoragePlaceCountryCode2 = "";
        FirstHolderCountryCode2 = "";
        HolderCountryCode2 = "";
        IssuerOGRN = "";
        DealAgentOGRN = "";
        StoragePlaceOGRN = "";
        FirstHolderOGRN = "";
        HolderOGRN = "";
        HolderState = "";
        RepaymentDate = ZeroDate;
        TermDate1 = ZeroDate;
        TermDate2 = ZeroDate;
        PercentRate = 0.0;
        BuyCost = 0.0;
        QualityCateg = 0;
        ReserveSum = 0.0;
        SaleCost = 0.0;
        SaleDate = ZeroDate;
        SaleGround = "";
        SaleAgentName = "";
        SaleAgentINN = "";
        SaleAgentINN_TIN = "";
        SaleAgentNotResCode = "";
        SaleAgentINN_Mark = "";
        SaleAgentCountryCode = "";
        SaleAgentOGRN = "";
        OvervalueBill = 0.0;
        AdjustCost = 0.0;
        AdjustReserv = 0.0;
        IdentifierCode = "";
        AvalAcept = "";

        if(ПолучитьФинИн( DataSet.FIID, Fininstr, Avoiriss ) == 0)
          DL_GetObjAttrName(OBJTYPE_AVOIRISS, 1, DL_GetMainObjAttr( Avoiriss, 1, OBJTYPE_AVOIRISS ), null, @Code711, null );
        end;

        ficert.Clear();
        ficert.rec.FiCertID = DataSet.FiCertID;
        if(ficert.GetEQ())
          //IdentifierCode
          if(RepDate >= date(1,1,2021))
            IdentifierCode = readNoteForObject( OBJTYPE_FICERT, UniID(ficert, OBJTYPE_FICERT), 21);
          end;
        end;

        if(ПолучитьСубъекта(GetAgentIDbyRole( DataSet.BCID, IRCAG_ROLE_AVALIST, IRCAG_ROLE_ACCEPTANT), Party) == 0)
            DL_GetObjAttrName(OBJTYPE_PARTY, 96, DL_GetMainObjAttr( Party, 96, OBJTYPE_PARTY ), null, @AvalAcept, null );
        end;

        //issuerinn
        //issuercountrycode
        if(ПолучитьСубъекта(DataSet.Issuer, Party) == 0)
          if(Party.rec.NotResident == "X")
            if (Conforms3129(Mode))
              IssuerINN = GetPartyINN(DataSet.Issuer, false, false, @IssuerINN_TIN, @IssuerNotResCode);
            elif((Conforms2055(Mode)) AND (CheckPartyType( DataSet.Issuer, 34 /*Международная организация*/ )))
              IssuerINN = INTERNATIONAL_COUNTRY_CODE;
            else
              if(Conforms2835(Mode))
                IssuerINN = GetPartyINN(DataSet.Issuer);
              else
                IssuerINN = DP_GetCountryByCodeLat3(Party.rec.NRCountry).CodeNum3;
                if(IssuerINN == "")
                  IssuerINN = UNKNOWN_COUNTRY_CODE;
                end;
              end;
            end;
            //Для векселедателей-нерезидентов выводится значение атрибута IssuerINN == IssuerCountryCode
            IssuerCountryCode = IssuerINN;
          else
            IssuerINN = GetPartyINN(DataSet.Issuer);
            //Для векселедателей-резидентов выводится цифровой код "643"
            IssuerCountryCode = "";
          end;
          IssuerOGRN = GetCodeOGRN(DataSet.Issuer);

          IssuerCountryCode2 = GetPartyCountryCode(DataSet.Issuer);
          IssuerINN_Mark = GetINN_Mark(Party.rec.LegalForm, Party.rec.NotResident);
        end;

        //TermFormula
        if(Conforms4212(Mode))
          if(DataSet.BCTermFormula == VS_TERMF_FIXEDDAY) //на определенный день
            TermFormula = "1";
          elif(DataSet.BCTermFormula == VS_TERMF_ATSIGHT) //по предъявлении
            if((date(DataSet.Maturity) < date(DataSet.Start)) AND (date(DataSet.Expiry) < date(DataSet.Start)))
              TermFormula = "2"; // просто по предъявлении
            else
              if((date(DataSet.Expiry) < date(DataSet.Start)) and (date(DataSet.Maturity) >= date(DataSet.Start)))
                TermFormula = "3"; //по предъявлении, но не ранее определенной даты
              elif((date(DataSet.Expiry) >= date(DataSet.Start)) and (date(DataSet.Maturity) >= date(DataSet.Start)))
                TermFormula = "4"; //по предъявлении, но не ранее определенной даты и не позднее определенной даты
              elif((date(DataSet.Expiry) >= date(DataSet.Start)) and (date(DataSet.Maturity) < date(DataSet.Start)))
                TermFormula = "5"; //по предъявлении, но не позднее определенной даты
              end;
            end;
          else
            TermFormula = "99"; //Иное
          end;
        else
          if(DataSet.BCTermFormula == VS_TERMF_FIXEDDAY) //на определенный день
            TermFormula = string(date(DataSet.Maturity):f);
          elif(DataSet.BCTermFormula == VS_TERMF_INATIME) //во столько-то времени от составления
            TermFormula = "через " + string(DataSet.diff:f) + " дней от составления";
          elif(DataSet.BCTermFormula == VS_TERMF_ATSIGHT) //по предъявлении
            if((date(DataSet.Maturity) < date(DataSet.Start)) AND (date(DataSet.Expiry) < date(DataSet.Start)))
              TermFormula = "по предъявлении"; // просто по предъявлении
            else
              if((date(DataSet.Expiry) < date(DataSet.Start)) and (date(DataSet.Maturity) >= date(DataSet.Start)))
                if(DataSet.BCTermFormat == 17) //не ранее дней
                  TermFormula = "по предъявлении, но не ранее "+string(DataSet.Duration:0:0)+" дней от составления";
                else
                  TermFormula = "по предъявлении, но не ранее "+string(date(DataSet.Maturity):f);
                end;
              elif((date(DataSet.Expiry) >= date(DataSet.Start)) and (date(DataSet.Maturity) < date(DataSet.Start)))
                TermFormula = "по предъявлении, но не позднее "+string(date(DataSet.Expiry):f);
              else
                if(DataSet.BCTermFormat == 17) //не ранее дней
                  TermFormula = "по предъявлении, но не ранее "+string(DataSet.Duration:0:0)+" дней от составления и не позднее "+string(date(DataSet.Expiry):f);
                else
                  TermFormula = "по предъявлении, но не ранее "+string(date(DataSet.Maturity):f)+" и не позднее "+string(date(DataSet.Expiry):f);
                end;
              end;
            end;
          elif(DataSet.BCTermFormula == VS_TERMF_DURING) //во столько-то времени от предъявления
            TermFormula = "через "+string(DataSet.diff:f)+" дней от предъявления";
          end;
        end;

        if(Conforms4212(Mode))

          //TermDate1
          if(TermFormula == "1")
            TermDate1 = date(DataSet.Maturity);
          elif((TermFormula == "3") OR (TermFormula == "4"))
            TermDate1 = date(DataSet.Maturity);
          end;

          //TermDate2
          if(TermFormula == "4")
            TermDate2 = date(DataSet.Expiry);
          end;
          if(Conforms4927(Mode))
            if((TermFormula == "4") or (TermFormula == "5"))
              TermDate2 = date(DataSet.Expiry);
            end;
          end;

          //PercentRate
          PercentRate = DL_VAGetBnrRateOnDate(DataSet.BCID, RepDate) / 10000.0;
        end;

        if(DataSet.BO == BO_VA)//учтенные векселя

          ficert.Clear();
          ficert.rec.FiCertID = DataSet.FiCertID;
          if(ficert.GetEQ())
            DL_GetObjAttrName(OBJTYPE_AVOIRISS, 1, DL_GetMainObjAttr( ficert, 1, OBJTYPE_FICERT ), null, @Code711, null );
            //FormNumber
            FormNumber = readNoteForObject( OBJTYPE_FICERT, UniID(ficert, OBJTYPE_FICERT), 4);
          end;

          if(СостояниеНаДату(DataSet.BCID, RepDate, "З")) //принят в залог
            //найти операцию залога
            DealID = ПолучитьОперациюИзмененияУчтенногоВекселя(DataSet.BCID, RepDate);
            if(DealID)
              tick.DealID = DealID;
              if(GetEQ(tick))
                DealDate = tick.DealDate;
                //dealground
                DealGround = GetGround(tick.BOfficeKind, tick.DealID, 107 /*договор залога*/);

                if(ПолучитьСубъекта(tick.PartyID, Party) == 0)
                  if (not GetPseudonim(Party.rec.PartyID, PTKN_BANKNAME, @HolderName))
                    HolderName = Party.rec.Name;
                  end;
                  HolderINN = GetPartyINN(Party.rec.PartyID, true, false, @HolderINN_TIN, @HolderNotResCode);
                  HolderINN_Mark = GetINN_Mark(Party.rec.LegalForm, Party.rec.NotResident);
                  HolderOGRN = GetCodeOGRN(Party.rec.PartyID);
                  //HolderCountryCode
                  HolderCountryCode = IIF(Party.rec.NotResident=="X", HolderINN, "");
                  HolderCountryCode2 = GetPartyCountryCode(Party.rec.PartyID);
                end;
              end;
            end;
          else
            //нати последнюю сделку
            if( VA_GetBalanceDate(DataSet.BCID, RepDate, @DealDate, @DealID, @sumbuy, @buyfi))
              tick.DealID = DealID;
              if(GetEQ(tick))

                if(DataSet.BillKind == BILLKIND_ACCOUNTED) //только для первого раздела
                  //dealground
                  DealGround = GetGround(tick.BOfficeKind, tick.DealID, 26 /*договор купли-продажи*/);
                elif(DataSet.BillKind == BILLKIND_OTHER)
                  //dealground
                  DealGround = GetGround(tick.BOfficeKind, tick.DealID, 105 /*договор хранения*/);
                end;
                //DEALAGENT
                if(ПолучитьСубъекта(tick.PartyID, Party) == 0)
                  if (not GetPseudonim(Party.rec.PartyID, PTKN_BANKNAME, @DealAgentName))
                    DealAgentName = Party.rec.Name;
                  end;

                  //DEALAGENTINN
                  DealAgentINN = GetPartyINN(Party.rec.PartyID, false, false, @DealAgentINN_TIN, @DealAgentNotResCode);
                  DealAgentINN_Mark = GetINN_Mark(Party.rec.LegalForm, Party.rec.NotResident);
                  //DealAgentCountryCode
                  DealAgentCountryCode = IIF(Party.rec.NotResident=="X", DealAgentINN, "");
                  DealAgentCountryCode2 = GetPartyCountryCode(Party.rec.PartyID);
                  // DealAgentOGRN
                  DealAgentOGRN = GetCodeOGRN(Party.rec.PartyID);
                end;
              end;
            end;
            sumbuy = ПолучитьОстаточнуюПокупнуюСтоимостьВН(DataSet.BCID, RepDate-1); // на утро отчетной даты, поэтому -1
            if(Conforms4927(Mode))
              СтоимостьВекселя(DataSet.BCID, RepDate - 1, @sumbuy, NULL, NULL);
            end;
            if(DataSet.PFI != NATCUR)
              if(ConvSum (sumbuy, sumbuy, RepDate-1, DataSet.PFI, NATCUR, 0) != 0)
                sumbuy = 0.0;
              end;
            end;

          end;

          //Balance
          fd = VSBannerFD(DL_VSBANNER, DataSet.BCID);
          Account = MC_GetExistAccount("Учтенные векселя", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);

          var OldDialogFlag = SetDialogFlag(0); // чтобы не выводил ошибки на экран
          if( (Account != "") AND VA_GetAccount("Учтенные векселя", fd, Account, MC_OPENACC_CHECKEXIST, fd.ОпределитьВалютуУчета(), null, acc, RepDate))
            BalanceAccNum = acc.rec.Balance;
          end;
          SetDialogFlag(OldDialogFlag);

          //Interest
          Interest = ПолучитьСуммуПДДНаДату(DataSet.BCID, RepDate-1, 0);
          if(DataSet.PFI != NATCUR)
            if(ConvSum (Interest, money(Interest), RepDate-1, DataSet.PFI, NATCUR, 0) != 0)
              Interest = 0.0;
            end;
          end;

          //BalanceCost
          if(Conforms2332(Mode)) // По 2332-У балансовая стоимость == сумме покупки, без ПДД
            BalanceCost = sumbuy;
          else
            BalanceCost = sumbuy + Interest;
          end;

          if(Conforms4212(Mode))
            //BuyCost
            BuyCost = БалансоваяСтоимостьВекселяВН(DataSet.BCID, RepDate);
            if(Conforms4927(Mode))
              СтоимостьВекселя(DataSet.BCID, RepDate - 1, @BuyCost, NULL, NULL);
              Премия = НачальнаяПремияПоВекселю(DataSet.BCID, RepDate - 1);
              if(Премия != 0)
                BuyCost = BuyCost - Премия;
              end;
            end;
            if(DataSet.PFI != NATCUR)
              if(ConvSum (BuyCost, money(BuyCost), RepDate, DataSet.PFI, NATCUR, 0) != 0)
                BuyCost = 0.0;
              end;
            end;

            //QualityCateg
            QualityCateg = VA_GetBnrQualityCateg(DataSet.BCID, RepDate);

            //ReserveSum
            var reslnk = TBfile("dlreslnk.dbt");
            if(GetResLnk(reslnk, DataSet.BCID, RSRV_TYPE_VABANNER, VARES_SUBKIND_AVR, RepDate, true))
              ReserveSum = reslnk.rec.ReserveAmount;
            end;

            cmd = DL_RSDCommand("select rsb_bill.GetVABnrStatusOnDate(?, ?) as BnrStatus from dual");
            cmd.AddParam(DataSet.BCID);
            cmd.AddParam(date(RepDate));
            ds = cmd.Execute();
            if(ds.moveNext() and (ds.BnrStatus != VABANNER_STATUS_ACCOUNT))
              //выбыл в отчетном периоде

              cmd = DL_RSDCommand(  " SELECT saletk.t_DealID, saletk.t_DealDate, saletk.t_BOfficeKind, saletk.t_PartyID, lnk.t_BCCost, lnk.t_BCCFI "
                                  + "   FROM ddl_tick_dbt saletk, dvsordlnk_dbt lnk, dvsbnrbck_dbt bck, doprdocs_dbt oprdocs, doproper_dbt opr "
                                  + "  WHERE bck.t_BCID = ? "
                                  + "    AND bck.t_ABCStatus = 'X' "
                                  + "    AND bck.t_ChangeDate <= ? "
                                  + "    AND bck.t_NewABCStatus <> " + VABANNER_STATUS_ACCOUNT
                                  + "    AND bck.t_OldABCStatus = " + VABANNER_STATUS_ACCOUNT
                                  + "    AND oprdocs.t_DocKind = " + DL_VSBNRBCK //изменение учтенного векселя
                                  + "    AND oprdocs.t_DocumentID = LTRIM(TO_CHAR (bck.t_ID, '0000000000')) "
                                  + "    AND opr.t_ID_Operation = oprdocs.t_ID_Operation "
                                  + "    AND LPAD( saletk.t_DealID, 34,'0' ) = opr.t_DocumentID "
                                  + "    AND saletk.t_BOfficeKind = opr.t_DocKind "
                                  + "    AND lnk.t_ContractID = saletk.t_DealID "
                                  + "    AND lnk.t_DocKind in ("+DL_VEKSELACCOUNTED+", "+DL_VAENWR+", "+DL_VAREPAY+")"
                                  + "    AND lnk.t_BCID = ? "
                                  + " ORDER BY bck.t_ChangeDate DESC, bck.t_ID DESC "
                                 );

              cmd.AddParam(DataSet.BCID);
              cmd.AddParam(date(RepDate));
              cmd.AddParam(DataSet.BCID);

              ds = cmd.Execute();
              if(ds.moveNext())
                //SaleCost
                SaleCost = ds.BCCost;
                if(ds.BCCFI != NATCUR)
                  if(ConvSum (SaleCost, money(SaleCost), RepDate, ds.BCCFI, NATCUR, 0) != 0)
                    SaleCost = 0.0;
                  end;
                end;

                //SaleDate
                SaleDate = date(ds.DealDate);

                //SaleGround
                if(ds.BOfficeKind == DL_VEKSELACCOUNTED)
                  SaleGround = GetGround(ds.BOfficeKind, ds.DealID, 26 /*договор купли-продажи*/);
                elif(ds.BOfficeKind == DL_VAREPAY)
                  SaleGround = GetGround(ds.BOfficeKind, ds.DealID, 102 /*заявление на погашение*/);
                end;

                if(SaleGround == "")
                  SaleGround = GetGround(ds.BOfficeKind, ds.DealID, 251 /*поручение клиента на операцию*/);
                end;

                if(ПолучитьСубъекта(ds.PartyID, Party) == 0)
                  if (not GetPseudonim(Party.rec.PartyID, PTKN_BANKNAME, @SaleAgentName))
                    SaleAgentName = Party.rec.Name;
                  end;

                  //SALEAGENTINN
                  SaleAgentINN = GetPartyINN(Party.rec.PartyID, false, false, @SaleAgentINN_TIN, @SaleAgentNotResCode);
                  SaleAgentINN_Mark = GetINN_Mark(Party.rec.LegalForm, Party.rec.NotResident);
                  //SaleAgentCountryCode
                  SaleAgentCountryCode = GetPartyCountryCode(Party.rec.PartyID);
                  // SaleAgentOGRN
                  SaleAgentOGRN = GetCodeOGRN(Party.rec.PartyID);
                end;

              end;
            end;
          end;

          if(DataSet.BillKind == BILLKIND_ACCOUNTED) //только для первого раздела
            //StoragePlaceName
            if(СостояниеНаДату(DataSet.BCID, RepDate, "Н")) //передан в залог
              //получить место хранения залога
              query = " select DECODE(ptname.t_name, NULL, pt.t_Name, ptname.t_name) as t_name, pt.t_PartyID, pt.t_NotResident as PartyNotResident, pt.t_LegalForm as t_LegalForm, tick.t_BOfficeKind, tick.t_DealID, "
                    + "        (select count(1) from ddp_dep_dbt dep where dep.t_PartyID = pt.t_PartyID) IsOur "
                    + " from dvsordlnk_dbt lnk, ddl_tick_dbt tick, dpmpaym_dbt pm, dparty_dbt pt, dpartyname_dbt ptname "
                    + " where lnk.t_BCID = " + DataSet.BCID
                    + "   and lnk.t_DocKind = " + DL_VAPAWN
                    + "   and lnk.t_InterestChargeDate <= " + GetSQLDate(RepDate)
                    + "   and tick.t_DealID = lnk.t_ContractID "
                    + "   and pm.t_DocKind = tick.t_BOfficeKind "
                    + "   and pm.t_DocumentID = tick.t_DealID "
                    + "   and pm.t_IsPlanPaym = 'X' "
                    + "   and pm.t_Purpose = " + BAi
                    + "   and pt.t_PartyID = pm.t_ReceiverBankID "
                    + "   and ptname.t_PartyID (+)= pt.t_PartyID "
                    + "   and ptname.t_nametypeID (+)= " + PTKN_BANKNAME
                    + " order by lnk.t_InterestChargeDate DESC ";

              storage = TRsbDataSet(query);
              if(storage.moveNext())
                StoragePlaceName = storage.Name;
                //StoragePlaceINN
                StoragePlaceINN = GetPartyINN(storage.PartyID, true, false, @StoragePlaceINN_TIN, @StoragePlaceNotResCode);
                StoragePlaceINN_Mark = GetINN_Mark(storage.LegalForm, storage.PartyNotResident);

                //StoragePlaceCountryCode
                StoragePlaceCountryCode = IIF(storage.PartyNotResident=="X", StoragePlaceINN, "");
                StoragePlaceCountryCode2 = GetPartyCountryCode(storage.PartyID);

                StoragePlaceOGRN = GetCodeOGRN(storage.PartyID);

                //StorageGround
                if((NOT storage.IsOur) OR (Conforms2055(Mode)))
                  StorageGround = GetGround(storage.BOfficeKind, storage.DealID, 107 /*договор залога*/);
                else
                  StorageGround = ""; // В случае нахождения векселя в нашем банке - не заполняется
                end;

                //Note
                Note = "Находится в залоге";
              end;
            else
                StoragePlaceName = "Хранилище Банка";
                StoragePlaceINN = GetPartyINN({OurBank}); //, true, false, @StoragePlaceINN_TIN, @StoragePlaceNotResCode); //"000000000000";
                StoragePlaceINN_Mark = "1";
                StoragePlaceOGRN = GetCodeOGRN({OurBank});
                StoragePlaceCountryCode = "";
                StoragePlaceCountryCode2 = GetPartyCountryCode({OurBank});

                if(ПолучитьСубъекта(GetAgentIDbyRole( DataSet.BCID, IRCAG_ROLE_AVALIST ), Party) == 0)
                  if (not GetPseudonim(Party.rec.PartyID, PTKN_BANKNAME, @Note))
                    Note = Party.rec.Name;
                  end;
                end;
            end;

            if(Conforms4927(Mode))
              Account = MC_GetExistAccount("+Переоценка, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);

              if( Account != "" )
                VA_GetAccountRest(OvervalueBill, Account, fd.ОпределитьВалютуУчета(), RepDate);
                OvervalueBill = -OvervalueBill;
              end;
              if(OvervalueBill == 0)
                Account = MC_GetExistAccount("-Переоценка, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);
                if( Account != "" )
                  VA_GetAccountRest(OvervalueBill, Account, fd.ОпределитьВалютуУчета(), RepDate);
                end;
              end;
            end;

            if(Conforms4927(Mode))
              Account = MC_GetExistAccount("КорСт_Уменьшение, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);

              if( Account != "" )
                VA_GetAccountRest(AdjustCost, Account, fd.ОпределитьВалютуУчета(), RepDate);
                AdjustCost = -AdjustCost;
              end;
              if(AdjustCost == 0)
                Account = MC_GetExistAccount("КорСт_Увеличение, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);
                if( Account != "" )
                  VA_GetAccountRest(AdjustCost, Account, fd.ОпределитьВалютуУчета(), RepDate);
                end;
              end;
            end;

            if(Conforms4927(Mode))
              Account = MC_GetExistAccount("+Кор_Резерв, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);

              if( Account != "" )
                VA_GetAccountRest(AdjustReserv, Account, fd.ОпределитьВалютуУчета(), RepDate);
                AdjustReserv = -AdjustReserv;
              end;
              if(AdjustReserv == 0)
                Account = MC_GetExistAccount("-Кор_Резерв, вексель", fd.kind, fd.id, FIROLE_UNDEF, fd.ОпределитьВалютуУчета(), RepDate);
                if( Account != "" )
                  VA_GetAccountRest(AdjustReserv, Account, fd.ОпределитьВалютуУчета(), RepDate);
                end;
              end;
            end;
          end;
        elif(DataSet.BO == BO_VS) //собственные

          ficert.Clear();
          ficert.rec.FiCertID = DataSet.FiCertID;
          if(ficert.GetEQ())
            DL_GetObjAttrName(OBJTYPE_AVOIRISS, 1, DL_GetMainObjAttr( ficert, 1, OBJTYPE_FICERT ), null, @Code711, null );
            FormNumber = readNoteForObject( OBJTYPE_FICERT, UniID(ficert, OBJTYPE_FICERT), 4);
          end;

          //FormNumber
          if(isFormNumber == true) //только если задана настройка "Вести учет бланков"
            vsform = TRsbDataSet("select t_FormNumber from dvsform_dbt "+
                                " where t_Series LIKE '"+ DataSet.BCSeries +"' AND t_Number like '"+ DataSet.BCNumber +"'");
            if((vsform.moveNext()) and (ValType(vsform.FormNumber) != V_UNDEF))
              FormNumber = vsform.FormNumber;
            end;
          end;

          //Balance
          if(Conforms4637(Mode))
            fd = VSBannerFD(DL_VSBANNER, DataSet.BCID);
            if(ПолучитьСчетВекселя("Наш вексель", fd, Account, MC_OPENACC_CHECKEXIST, fd.ОпределитьВалютуУчета(), acc, RepDate,NULL,NULL,true))
              BalanceAccNum = acc.rec.Balance;
            end;
          end;

          //FirstHolderINN
          FirstHolderINN = GetPartyINN(DataSet.Holder, false, false, @FirstHolderINN_TIN, @FirstHolderNotResCode);
          FirstHolderINN_Mark = GetINN_Mark_ID(DataSet.Holder);

          //FirstHolderCountryCode
          FirstHolderCountryCode = IIF(GetParty(DataSet.Holder).rec.NotResident=="X", FirstHolderINN, "");
          FirstHolderCountryCode2 = GetPartyCountryCode(DataSet.Holder);

          FirstHolderOGRN = GetCodeOGRN(DataSet.Holder);

          //State
          ds = TRsbDataSet("select rsb_bill.GetVSBnrStatusOnDate("+DataSet.BCID+", "+GetSQLDate(date(RepDate))+") as status from dual");
          if(ds.moveNext())
            var lnk = TRecHandler("vsordlnk.dbt");

            GetLastVsOrdLnk(DataSet.BCID, RepDate, lnk);

            LastDocKind = lnk.rec.DocKind;
            CurrStatus = ds.Status;

            if(Conforms3269(Mode))
              ds = TRsbDataSet("select rsb_bill.GetVABnrStateOnDate("+DataSet.BCID+", "+GetSQLDate(date(RepDate))+") as symbstr from dual");

              if(ds.moveNext())
                if(Index(ds.symbstr, "Щ")) // в обращении
                  if(CurrStatus == VSBANNER_STATUS_PAWN) //Принят в залог
                    State = "3";
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELPAWNORDER), "", @HolderID, @HolderName);
                    Note = VSBANNER_STATUS_RECEIVED_IN_MORTGAGE_STR;
                  else
                    State = "1";
                    Note = VSBANNER_STATE_INCIRCULATE;
                  end;
                elif(Index(ds.symbstr, "Ч")) // просрочен
                  State = "1";
                  Note = VSBANNER_STATE_OVERDUE;
                elif(CurrStatus == VSBANNER_STATUS_REDEEMED) // выкуплен
                  State = "2";
                  Note = VSBANNER_STATE_REDEEMED;
                elif(Index(ds.symbstr, "В")) // на выкупе
                  State = "2";
                  GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена УC*/), "F", @HolderID, @HolderName);
                elif(CurrStatus == VSBANNER_STATUS_PAWN) // принят в залог
                  State = "3";
                  GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELPAWNORDER), "", @HolderID, @HolderName);
                elif(Index(ds.symbstr, "П")) // предъявлен
                  State = "4";
                  GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELDRAWORDER+","+DL_VSINTERCHANGE+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*Мена УС*/), "F", @HolderID, @HolderName);
                elif(Index(ds.symbstr, "Х")) // на хранении
                  State = "5";
                  GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSSTORAGEORDER+","+DL_VSSALE+","+DL_VSBARTERORDER), "", @HolderID, @HolderName);
                elif(Index(ds.symbstr, "Т")) // арестован
                  State = "6";
                  Note = VSBANNER_STATE_ARRESTED;
                elif(Index(ds.symbstr, "Д")) // списан
                  State = "7";
                  Note = VSBANNER_STATE_WRITTENOFF;
                elif(Index(ds.symbstr, "Б")) // блокирован
                  State = "7";
                  Note = VSBANNER_STATE_BLOCKED;
                elif(Index(ds.symbstr, "У")) // утерян
                  State = "7";
                  Note = VSBANNER_STATE_LOST;
                elif(Index(ds.symbstr, "Ф")) // похищен
                  State = "7";
                  Note = VSBANNER_STATE_STOLED;
                elif(Index(ds.symbstr, "Г")) // списан на доходы
                  State = "8";
                  Note = VSBANNER_STATE_WRITTENOFFINCOME;
                  if(Conforms4927(Mode))
                    //по ТЗ операции списания, все шаги операции выполняются в один день, значит дату можно определлить по состоянию
                    var ds_for_date = TRsbDataSet("select RSB_Bill.GetLastDateStateVS("+DataSet.BCID+", "+"'Г'"+", "+GetSQLDate(date(RepDate))+") as WordDate from dual");
                    if(ds_for_date.MoveNext())
                      RepaymentDate = SQL_ConvTypeDate(ds_for_date.WordDate);
                    end;
                  end;
                elif(CurrStatus == VSBANNER_STATUS_ENDED) // погашен
                  State = "9";
                  GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELDRAWORDER), "", @HolderID, @HolderName);
                  Note = string(SQL_ConvTypeDate(DataSet.RepaymentDate:f));
                  RepaymentDate = SQL_ConvTypeDate(DataSet.RepaymentDate);
                end;
              end;
            elif(Conforms2835(Mode))
              ds = TRsbDataSet("select rsb_bill.GetVABnrStateOnDate("+DataSet.BCID+", "+GetSQLDate(date(RepDate))+") as symbstr from dual");

              if(CurrStatus == VSBANNER_STATUS_ENDED ) //погашен
                if(ds.moveNext())
                  if(Index(ds.symbstr, "Д")) //Списан
                    State = "7";
                    Note = VSBANNER_STATE_WRITTENOFF;
                  else
                    State = "9";
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELDRAWORDER), "", @HolderID, @HolderName);
                    Note = string(SQL_ConvTypeDate(DataSet.RepaymentDate:f));
                    if(Conforms3129(Mode))
                      RepaymentDate = SQL_ConvTypeDate(DataSet.RepaymentDate);
                    end;
                  end;
                end;
              else
                if(ds.moveNext())
                  if(Index(ds.symbstr, "Х")) //На хранении
                    if (CurrStatus == VSBANNER_STATUS_PAWN) //Принят в залог
                      State = "3";
                      GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELPAWNORDER), "", @HolderID, @HolderName);
                      Note = VSBANNER_STATUS_RECEIVED_IN_MORTGAGE_STR;
                    else
                      State = "5";
                      GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSSTORAGEORDER+","+DL_VSSALE+","+DL_VSBARTERORDER), "", @HolderID, @HolderName);
                    end;
                  elif(CurrStatus == VSBANNER_STATUS_PAWN) //Принят в залог
                    State = "3";
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELPAWNORDER), "", @HolderID, @HolderName);
                  elif(Index(ds.symbstr, "В")) //На выкупе
                    State = "2";
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена УC*/), "F", @HolderID, @HolderName);
                  elif(Index(ds.symbstr, "П")) //Предъявлен
                    State = "4";
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELDRAWORDER+","+DL_VSINTERCHANGE+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*Мена УС*/), "F", @HolderID, @HolderName);
                  elif(Index(ds.symbstr, "Б")) //Блокирован
                    State = "99";
                    Note = VSBANNER_STATE_BLOCKED;
                  elif(Index(ds.symbstr, "И")) //Перен.к исполн.
                    State = "1";
                  elif(Index(ds.symbstr, "С")) //Перен.по срочн.
                    State = "1";
                  end;
                end; // if(ds.moveNext())
              end; // if(CurrStatus == VSBANNER_STATUS_ENDED ) //погашен
            else // if(Conforms2835(Mode))
              if(CurrStatus == VSBANNER_STATUS_FORMED ) //оформлен
                State = VSBANNER_STATUS_CIRCULATION_STR; // "В обращении"
                GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VEKSELACCOUNTED/*мена СУ*/), "W", @HolderID, @HolderName);
              elif(CurrStatus == VSBANNER_STATUS_REDEEMED) //выкуплен
                State = VSBANNER_STATUS_REDEEMED_STR; // "Выкуплен для дальнейшей перепродажи"
                GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELDRAWORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена УC*/), "F", NULL, @Note);
              else
                ds = TRsbDataSet("select rsb_bill.GetVABnrStateOnDate("+DataSet.BCID+", "+GetSQLDate(date(RepDate))+") as symbstr from dual");

                if(ds.moveNext())
                  if(Index(ds.symbstr, "Х" )) //На хранении
                    if (CurrStatus == VSBANNER_STATUS_PAWN) //Принят в залог
                      State = VSBANNER_STATUS_RECEIVED_IN_MORTGAGE_STR; 
                      GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELPAWNORDER), "", @HolderID, @HolderName);
                    else
                      State = VSBANNER_STATUS_RECEIVED_4STORAGE_STR; // "Принят на хранение"
                      GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSSTORAGEORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена СУ*/), "W", @HolderID, @HolderName);
                    end;
                  elif(CurrStatus == VSBANNER_STATUS_PAWN) //Принят в залог
                    State = VSBANNER_STATUS_RECEIVED_IN_MORTGAGE_STR; // "Принят в залог"
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELPAWNORDER), "", @HolderID, @HolderName);
                  elif(Index(ds.symbstr, "В")) //На выкупе
                    State = VSBANNER_STATUS_RECEIVED_4BUYOUT_STR; // "Принят для выкупа"
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена УC*/), "F", @HolderID, @HolderName);
                  elif((LastDocKind == DL_VSSALE) or (LastDocKind == DL_VSBARTERORDER)) //Продан
                    State = VSBANNER_STATUS_CIRCULATION_STR;  // "В обращении"
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VSSALE+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена СУ*/), "W", NULL, @Note);
                  elif(Index(ds.symbstr, "И"))
                    State = VSBANNER_STATUS_RECEIVED_4REDEMPTION_STR; // "Принят к погашению"
                    GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELDRAWORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена УC*/), "F", @HolderID, @HolderName);
                  elif(Index(ds.symbstr, "П"))
                    State = VSBANNER_STATUS_PRESENTED_4REDEMPTION_STR; // "Предъявлен для погашения"
                  else
                    if(CurrStatus == VSBANNER_STATUS_SENDED) // выдан
                      State = VSBANNER_STATUS_CIRCULATION_STR;  // "В обращении"
                    end;
                  end;
                end;

                if(CurrStatus == VSBANNER_STATUS_SENDED) // выдан
                  GetVsPtbyDocKinds(DataSet.BCID, RepDate, string(DL_VEKSELORDER+","+DL_VSBARTERORDER+","+DL_VEKSELACCOUNTED/*мена СУ*/), "W", NULL, @Note);
                end;
              end; // if(CurrStatus == VSBANNER_STATUS_FORMED ) //оформлен

              if(Conforms2627(Mode2)) // нужно перекодировать строковые статусы в числовые
                if( State == VSBANNER_STATUS_CIRCULATION_STR ) // "В обращении"
                  State = "1";
                elif((State == VSBANNER_STATUS_RECEIVED_4BUYOUT_STR) or (State == VSBANNER_STATUS_REDEEMED_STR)) // "Принят для выкупа" или "Выкуплен для дальнейшей перепродажи"
                  State = "2";
                elif(State == VSBANNER_STATUS_RECEIVED_IN_MORTGAGE_STR) // "Принят в залог"
                  State = "3";
                elif((State == VSBANNER_STATUS_RECEIVED_4REDEMPTION_STR) or (State == VSBANNER_STATUS_PRESENTED_4REDEMPTION_STR)) // "Принят к погашению" или "Предъявлен к погашению"
                  State = "4";
                elif(State == VSBANNER_STATUS_RECEIVED_4STORAGE_STR) // "Принят на хранение"
                  State = "5";
                else
                  State = "";
                end;
              end;
            end; // if(Conforms2835(Mode))

            if(Conforms4212(Mode))
              if((CurrStatus == VSBANNER_STATUS_ENDED) or (CurrStatus == VSBANNER_STATUS_REDEEMED))

                //SaleCost
                SaleCost = lnk.rec.BCCost;
                if(lnk.rec.BCCFI != NATCUR)
                  if(ConvSum(SaleCost, money(SaleCost), RepDate, lnk.rec.BCCFI, NATCUR, 0) != 0)
                    SaleCost = 0.0;
                  end;
                end;
              end;
            end;
          end;

          //HolderINN
          HolderINN = GetPartyINN(HolderID, false, false, @HolderINN_TIN, @HolderNotResCode);
          HolderINN_Mark = GetINN_Mark_ID(HolderID);
          //HolderCountryCode
          HolderCountryCode = IIF(GetParty(HolderID).rec.NotResident=="X", HolderINN, "");
          HolderCountryCode2 = GetPartyCountryCode(HolderID);

          HolderOGRN = GetCodeOGRN(HolderID);

        elif(DataSet.BO == BO_TRUST) //в ДУ

          ficert.Clear();
          ficert.rec.FiCertID = DataSet.FiCertID;
          if(ficert.GetEQ())
            DL_GetObjAttrName(OBJTYPE_AVOIRISS, 1, DL_GetMainObjAttr( ficert, 1, OBJTYPE_FICERT ), null, @Code711, null );
          end;

          //dealground
          //нати последнюю сделку
          if( VA_GetBalanceDate(DataSet.BCID, RepDate, @DealDate, @DealID, @sumbuy, @buyfi))
            tick.DealID = DealID;
            if(GetEQ(tick))
              //dealground
              DealGround = GetGround(tick.BOfficeKind, tick.DealID, 0);
            end;

            //Interest
            Interest = ПолучитьСуммуПДДНаДату(DataSet.BCID, RepDate, 0);
            //BalanceCost
            if(Conforms2332(Mode)) // По 2332-У балансовая стоимость == сумме покупки, без ПДД
              BalanceCost = sumbuy;
            else
              BalanceCost = sumbuy + Interest;
            end;
            if(buyfi != NATCUR)
              if(ConvSum (BalanceCost, BalanceCost, RepDate, buyfi, NATCUR, 0) != 0)
                BalanceCost = 0.0;
              end;
              if(ConvSum (Interest, money(Interest), RepDate, buyfi, NATCUR, 0) != 0)
                Interest = 0.0;
              end;
            end;
          end;

          if(ПолучитьСубъекта(int(GetDealClientID(DealID)), Party) == 0)
            if (not GetPseudonim(Party.rec.PartyID, PTKN_BANKNAME, @HolderName))
              HolderName = Party.rec.Name;
            end;
            HolderINN = GetPartyINN(Party.rec.PartyID, true, false, @HolderINN_TIN, @HolderNotResCode);
            HolderINN_Mark = GetINN_Mark(Party.rec.LegalForm, Party.rec.NotResident);
            //HolderCountryCode
            HolderCountryCode = IIF(Party.rec.NotResident=="X", HolderINN, "");
            HolderCountryCode2 = GetPartyCountryCode(Party.rec.PartyID);

            HolderOGRN = GetCodeOGRN(Party.rec.PartyID);
          end;

        elif(DataSet.BO == BO_DEPO) //Депозитарий

          ficert.Clear();
          ficert.rec.FiCertID = DataSet.FiCertID;
          if(ficert.GetEQ())
            DL_GetObjAttrName(OBJTYPE_AVOIRISS, 1, DL_GetMainObjAttr( ficert, 1, OBJTYPE_FICERT ), null, @Code711, null );

            StoragePlaceName = DataSet.StoragePlaceName;
            StoragePlaceINN = GetPartyINN(DataSet.StoragePlaceID, true, true, @StoragePlaceINN_TIN, @StoragePlaceNotResCode);
            StoragePlaceINN_Mark = GetINN_Mark_ID(DataSet.StoragePlaceID);

            //StoragePlaceCountryCode
            StoragePlaceCountryCode = IIF(GetParty(DataSet.StoragePlaceID).rec.NotResident=="X", StoragePlaceINN, "");
            StoragePlaceCountryCode2 = GetPartyCountryCode(DataSet.StoragePlaceID);

            StoragePlaceOGRN = GetCodeOGRN(DataSet.StoragePlaceID);

            HolderName = DataSet.HolderName;
            HolderINN = GetPartyINN(DataSet.HolderID, true, true, @HolderINN_TIN, @HolderNotResCode);
            HolderINN_Mark = GetINN_Mark_ID(DataSet.HolderID);
            //HolderCountryCode
            HolderCountryCode = IIF(GetParty(DataSet.HolderID).rec.NotResident=="X", HolderINN, "");
            HolderCountryCode2 = GetPartyCountryCode(DataSet.HolderID);

            HolderOGRN = GetCodeOGRN(DataSet.HolderID);

            if(DataSet.HolderID != {OurBank})
              DealGround = GetICGround(DataSet.FiCertID, RepDate);
            end;

            DealDate = date(DataSet.DealDate);

            if(Conforms4212(Mode))
              //QualityCateg
              QualityCateg = VA_GetBnrQualityCateg(DataSet.BCID, RepDate);

              SaleDate = date(DataSet.SaleDate);
              //SaleGround
              if(SaleDate > ZeroDate)
                SaleGround = GetICGround(DataSet.FiCertID, RepDate);
              end;
            end;
          end;
        end;

        if(QualityCateg < 0)
          QualityCateg = 0;
        end;

        query = "UPDATE "+TmpTable+" SET "
                + " t_Code711 = "+GetSQLStr(Code711)+", "
                + " t_IssuerINN = "+ GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = "+ GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = "+ GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerCountryCode = "+ GetSQLStr(IssuerCountryCode) + ", "
                + " t_IssuerCountryCode2 = "+ GetSQLStr(IssuerCountryCode2) + ", "
                + " t_IssuerOGRN = " + GetSQLStr(IssuerOGRN) + ", "
                + " t_FormNumber = " + GetSQLStr(FormNumber) + ", "
                + " t_TermFormula = " + GetSQLStr(TermFormula) + ", "
                + " t_DealDate = " + GetSQLDate(DealDate) + ", "
                + " t_DealAgentName = " + GetSQLStr(DealAgentName) + ", "
                + " t_DealAgentINN = " + GetSQLStr(DealAgentINN) + ", "
                + " t_DealAgentINN_Mark = " + GetSQLStr(DealAgentINN_Mark) + ", "
                + " t_DealAgentINN_TIN = " + GetSQLStr(DealAgentINN_TIN) + ", "
                + " t_DealAgentNotResCode = " + GetSQLStr(DealAgentNotResCode) + ", "
                + " t_DealAgentCountryCode = " + GetSQLStr(DealAgentCountryCode) + ", "
                + " t_DealAgentCountryCode2 = " + GetSQLStr(DealAgentCountryCode2) + ", "
                + " t_DealAgentOGRN = " + GetSQLStr(DealAgentOGRN) + ", "
                + " t_DealGround = " + GetSQLStr(DealGround) + ", "
                + " t_BalanceCost = " + BalanceCost + ", "
                + " t_Interest = " + Interest + ","
                + " t_StoragePlaceName = "+GetSQLStr(StoragePlaceName)+", "
                + " t_StoragePlaceINN = "+GetSQLStr(StoragePlaceINN)+", "
                + " t_StoragePlaceINN_Mark = "+GetSQLStr(StoragePlaceINN_Mark)+", "
                + " t_StoragePlaceINN_TIN = "+GetSQLStr(StoragePlaceINN_TIN)+", "
                + " t_StoragePlaceNotResCode = " + GetSQLStr(StoragePlaceNotResCode) + ", "
                + " t_StoragePlaceCountryCode = "+GetSQLStr(StoragePlaceCountryCode)+", "
                + " t_StoragePlaceCountryCode2 = "+GetSQLStr(StoragePlaceCountryCode2)+", "
                + " t_StoragePlaceOGRN = " + GetSQLStr(StoragePlaceOGRN) + ", "
                + " t_StorageGround = "+GetSQLStr(StorageGround)+", "
                + " t_Note = "+GetSQLStr(Note)+", "
                + " t_FirstHolderINN = "+GetSQLStr(FirstHolderINN)+", "
                + " t_FirstHolderINN_Mark = "+GetSQLStr(FirstHolderINN_Mark)+", "
                + " t_FirstHolderINN_TIN = "+GetSQLStr(FirstHolderINN_TIN)+", "
                + " t_FirstHolderNotResCode = " + GetSQLStr(FirstHolderNotResCode) + ", "
                + " t_FirstHolderCountryCode = "+GetSQLStr(FirstHolderCountryCode)+", "
                + " t_FirstHolderCountryCode2 = "+GetSQLStr(FirstHolderCountryCode2)+", "
                + " t_FirstHolderOGRN = " + GetSQLStr(FirstHolderOGRN) + ", "
                + " t_State = " +GetSQLStr(State)+", "
                + " t_RepaymentDate = " +GetSQLDate(RepaymentDate)+", "
                + " t_HolderName = "+GetSQLStr(HolderName)+", "
                + " t_HolderINN = "+GetSQLStr(HolderINN)+", "
                + " t_HolderINN_Mark = "+GetSQLStr(HolderINN_Mark)+", "
                + " t_HolderINN_TIN = "+GetSQLStr(HolderINN_TIN)+", "
                + " t_HolderNotResCode = " + GetSQLStr(HolderNotResCode) + ", "
                + " t_HolderCountryCode = "+GetSQLStr(HolderCountryCode)+", "
                + " t_HolderCountryCode2 = "+GetSQLStr(HolderCountryCode2)+", "
                + " t_HolderOGRN = " + GetSQLStr(HolderOGRN) + ", "
                + " t_BalanceAccNum = " +GetSQLStr(BalanceAccNum)+ ", "
                + " t_TermDate1 = " + GetSQLDate(TermDate1) + ", "
                + " t_TermDate2 = " + GetSQLDate(TermDate2) + ", "
                + " t_PercentRate = " + PercentRate + ", "
                + " t_BuyCost = " + BuyCost + ", "
                + " t_QualityCateg = " + QualityCateg + ", "
                + " t_ReserveSum = " + ReserveSum + ", "
                + " t_SaleCost = " + SaleCost + ", "
                + " t_SaleDate = " + GetSQLDate(SaleDate) + ", "
                + " t_SaleGround = " + GetSQLStr(SaleGround) + ", "
                + " t_SaleAgentName = " + GetSQLStr(SaleAgentName) + ", "
                + " t_SaleAgentINN = " + GetSQLStr(SaleAgentINN) + ", "
                + " t_SaleAgentINN_TIN = " + GetSQLStr(SaleAgentINN_TIN) + ", "
                + " t_SaleAgentNotResCode = " + GetSQLStr(SaleAgentNotResCode) + ", "
                + " t_SaleAgentINN_Mark = " + GetSQLStr(SaleAgentINN_Mark) + ", "
                + " t_SaleAgentCountryCode = " + GetSQLStr(SaleAgentCountryCode) + ", "
                + " t_SaleAgentOGRN = " + GetSQLStr(SaleAgentOGRN) + ", "
                + " t_HolderState = " + GetSQLStr(HolderState) + ", "
                + " t_OvervalueBill = " + OvervalueBill + ", "
                + " t_AdjustCost = " + AdjustCost + ", "
                + " t_AdjustReserv = " + AdjustReserv + ", "
                + " t_IdentifierCode = " + GetSQLStr(IdentifierCode) + ", "
                + " t_AvalAcept = " + GetSQLStr(AvalAcept)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

        SQL_Execute(query, "Обновление информации о векселе серия \""+DataSet.Series+"\" №"+DataSet.Number, false );

      end;

      //удалить лишние ИК
      if((DataSet.BillKind == BILLKIND_ACCOUNTED) OR (DataSet.BillKind == BILLKIND_OTHER))
        query = " select * from "+TmpTable+" where t_BO = '"+BO_DEPO+"' order by t_AutoKey asc";
        DataSet = TRsbDataSet(query);
        while(DataSet.moveNext())
          //удалить ИК с неподходящих счетов для конкретных разделов формы
          query =   " select rsb_depo.depokindtype(acc.t_DepoRoot) as DepoAccType from daccount_dbt acc, dvsbanner_dbt bnr, dfininstr_dbt fin, dficert_dbt ficert, dinvcard_dbt ic"
                  + "  where bnr.t_BCID = "+DataSet.BCID
                  + "    and fin.t_FIID = bnr.t_FIID "
                  + "    and ficert.t_AvoirKind = fin.t_AvoirKind "
                  + "    and ficert.t_CertID = bnr.t_BCID "
                  + "    and ic.t_FiCertID = ficert.t_FiCertID "
                  + "    and (   rsb_depo.icstatus(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") = " + INVCARD_STATUS_INCUSTODY  //на хранении
                  + "         OR (    rsb_depo.icstatus(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") = " + INVCARD_STATUS_WRITEOFF  //списана
                  + "             AND rsb_depo.icstatusdate(ic.t_InvCardID, "+GetSQLDate(date(RepDate))+") >= " + GetSQLDate(date(BeginRepDate)) //в отчетном периоде
                  + "            )"
                  + "        )"
                  + "    and acc.t_AccountID = rsb_depo.iclastaccountid(ic.t_InvCardID, 0, "+GetSQLDate(date(RepDate))+") ";
          ds = TRsbDataSet(query);
          if(ds.moveNext())
            if( ((DataSet.BillKind == BILLKIND_ACCOUNTED) AND (ds.DepoAccType != OBJTYPE_DEPOKINDTYPE_DEPONENT)) OR
                ((DataSet.BillKind == BILLKIND_OTHER) AND (ds.DepoAccType == OBJTYPE_DEPOKINDTYPE_DEPONENT))
              )
              //удаляем
              SQL_Execute("DELETE FROM "+TmpTable+" WHERE t_AutoKey = " + DataSet.t_AutoKey, "Удаление информации о лишних инвентарных карточках", false );
            end;
          end;
        end;
      end;

    END;

    PRIVATE MACRO SetValues()
        var StrState;

        IssuerName               = DataRec.IssuerName;
        Code711                  = DataRec.Code711;
        IssuerINN                = DataRec.IssuerINN;
        IssuerINN_TIN            = DataRec.IssuerINN_TIN;
        IssuerNotResCode         = DataRec.IssuerNotResCode;
        IssuerINN_Mark           = DataRec.IssuerINN_Mark;
        IssuerCountryCode        = DataRec.IssuerCountryCode;
        IssuerCountryCode2       = DataRec.IssuerCountryCode2;
        IssuerOGRN               = DataRec.IssuerOGRN;
        Series                   = DataRec.Series;
        Number                   = DataRec.Number;
        FormNumber               = DataRec.FormNumber;
        IssueDate                = DataRec.IssueDate;
        TermFormula              = DataRec.TermFormula;
        FaceValue                = DataRec.FaceValue;
        FaceValueFICode          = DataRec.FaceValueFICode;
        DealDate                 = DataRec.DealDate;
        DealGround               = DataRec.DealGround;
        DealAgentName            = DataRec.DealAgentName;
        DealAgentINN             = DataRec.DealAgentINN;
        DealAgentINN_TIN         = DataRec.DealAgentINN_TIN;
        DealAgentNotResCode      = DataRec.DealAgentNotResCode;
        DealAgentINN_Mark        = DataRec.DealAgentINN_Mark;
        DealAgentCountryCode     = DataRec.DealAgentCountryCode;
        DealAgentCountryCode2    = DataRec.DealAgentCountryCode2;
        DealAgentOGRN            = DataRec.DealAgentOGRN;
        BalanceCost              = DataRec.BalanceCost;
        Interest                 = DataRec.Interest;
        BalanceAccNum            = DataRec.BalanceAccNum;
        StoragePlaceName         = DataRec.StoragePlaceName;
        StoragePlaceINN          = DataRec.StoragePlaceINN;
        StoragePlaceINN_TIN      = DataRec.StoragePlaceINN_TIN;
        StoragePlaceNotResCode   = DataRec.StoragePlaceNotResCode;
        StoragePlaceINN_Mark     = DataRec.StoragePlaceINN_Mark;
        StoragePlaceCountryCode  = DataRec.StoragePlaceCountryCode;
        StoragePlaceCountryCode2 = DataRec.StoragePlaceCountryCode2;
        StoragePlaceOGRN         = DataRec.StoragePlaceOGRN;
        StorageGround            = DataRec.StorageGround;
        FirstHolderName          = DataRec.FirstHolderName;
        FirstHolderINN           = DataRec.FirstHolderINN;
        FirstHolderINN_TIN       = DataRec.FirstHolderINN_TIN;
        FirstHolderNotResCode    = DataRec.FirstHolderNotResCode;
        FirstHolderINN_Mark      = DataRec.FirstHolderINN_Mark;
        FirstHolderCountryCode   = DataRec.FirstHolderCountryCode;
        FirstHolderCountryCode2  = DataRec.FirstHolderCountryCode2;
        FirstHolderOGRN          = DataRec.FirstHolderOGRN;
        State                    = DataRec.State;
        RepaymentDate            = DataRec.RepaymentDate;
        HolderName               = DataRec.HolderName;
        HolderINN                = DataRec.HolderINN;
        HolderINN_TIN            = DataRec.HolderINN_TIN;
        HolderNotResCode         = DataRec.HolderNotResCode;
        HolderINN_Mark           = DataRec.HolderINN_Mark;
        HolderCountryCode        = DataRec.HolderCountryCode;
        HolderCountryCode2       = DataRec.HolderCountryCode2;
        HolderOGRN               = DataRec.HolderOGRN;
        HolderState              = DataRec.HolderState;
        Note                     = DataRec.Note;
        TermDate1                = DataRec.TermDate1;
        TermDate2                = DataRec.TermDate2;
        PercentRate              = DataRec.PercentRate;
        BuyCost                  = DataRec.BuyCost;
        QualityCateg             = DataRec.QualityCateg;
        ReserveSum               = DataRec.ReserveSum;
        SaleCost                 = DataRec.SaleCost;
        SaleDate                 = DataRec.SaleDate;
        SaleGround               = DataRec.SaleGround;
        SaleAgentName            = DataRec.SaleAgentName;
        SaleAgentINN             = DataRec.SaleAgentINN;
        SaleAgentINN_TIN         = DataRec.SaleAgentINN_TIN;
        SaleAgentNotResCode      = DataRec.SaleAgentNotResCode;
        SaleAgentINN_Mark        = DataRec.SaleAgentINN_Mark;
        SaleAgentCountryCode     = DataRec.SaleAgentCountryCode;
        SaleAgentOGRN            = DataRec.SaleAgentOGRN;
        OvervalueBill            = DataRec.OvervalueBill;
        AdjustCost               = DataRec.AdjustCost;
        AdjustReserv             = DataRec.AdjustReserv;
        IdentifierCode           = DataRec.IdentifierCode;
        AvalAcept                = DataRec.AvalAcept;
    END;

    MACRO SetFilter(_Departments:TArray, _BeginRepDate:date, _RepDate:date, _BillKind:integer, _Mode:integer, _Mode2:integer)
      var i = 0;

      if(ValType(_Departments) != V_UNDEF)
        Departments = "";
        while(i<_Departments.size)
          if(i > 0 )
            Departments = Departments + ",";
          end;
          Departments = string(string(Departments) + string(_Departments[i]));

          i = i + 1;
        end;
      end;

      if(ValType(_BeginRepDate) != V_UNDEF)
        BeginRepDate = _BeginRepDate;
      end;

      if(ValType(_RepDate) != V_UNDEF)
        RepDate = _RepDate;
      end;

      if(ValType(_BillKind) != V_UNDEF)
        BillKind = _BillKind;
      end;

      if(ValType(_Mode) != V_UNDEF)
        Mode = _Mode;
      end;

      if(ValType(_Mode2) != V_UNDEF)
        Mode2 = _Mode2;
      end;
    END;

    MACRO GetFirst()
      var stat = false;
      PrepareData();

      DataRec = TRsbDataSet(  " select * from "+TmpTable+""
                            + " order by t_BillKind, t_IssuerName, t_Series, t_Number, t_IssueDate" );
      stat = DataRec.moveNext();
      if(stat)
        SetValues();
      end;

      return stat;
    END;

    MACRO GetNext()
      var stat = false;
      stat = DataRec.moveNext();
      if(stat)
        SetValues();
      end;

      return stat;
    END;

   // По умолчанию выборку будем делать для департамента операциониста, за текущую дату, для всех видов векселей по версии 2055-У
   Departments = string({OperDprt});
   BeginRepDate = ZeroDate;
   RepDate = {curdate};
   BillKind = BILLKIND_ALL;
   Mode = BILL711_MODE_2055;
   Mode2 = BILL711_MODE_2332;
END;

/*
var deps = TArray();
var kinds = TArray(), i = 0;
var obj = null;
var stat = false;
var empty = true;
var fields = null, widths = null, j = 0;
var head = null;
var rep = null;
var old = -1;
var style = "ex_B(rlb)";
deps[deps.Size] = {OperDprt};
//kinds[kinds.Size] = BILLKIND_ALL;
kinds[kinds.Size] = BILLKIND_ACCOUNTED;
kinds[kinds.Size] = BILLKIND_OUR;
kinds[kinds.Size] = BILLKIND_OTHER;
while(i < kinds.Size)
  obj = C_711bill();
  obj.SetFilter(deps, date(00,00,0000), date(31,12,9999), kinds[i], BILL711_MODE_4927, BILL711_MODE_4927);
  stat = obj.GetFirst();
  while(stat)
    if(empty)
      fields = GetObjProps(obj);
      widths = TArray();
      head = CHeader();
      j = 0;
      while(j < fields.Size)
        widths[j] = StrLen(fields[j]);
        head.AddChild(fields[j], widths[j]);
        j = j + 1;
      end;
      rep = CMakeReport("", SEP_DEFAULT, 99999);
      rep.AutoScan("[\n" + head.CreateHeader() + "]");
      empty = false;
    end;
    if(old != kinds[i])
      rep.AddPrintCell(kinds[i] + 1, widths[0], 0, style);
      j = 1;
      while(j < fields.Size)
        rep.AddPrintCell("", widths[j], 0, style);
        j = j + 1;
      end;
      rep.AddStr();
      old = kinds[i];
    end;
    j = 0;
    while(j < fields.Size)
      if(GenPropID(obj, fields[j]) != -1)
        rep.AddPrintCell(String(GenGetProp(obj, fields[j])), widths[j], 0, style);
      else
        rep.AddPrintCell("", widths[j], 0, style);
      end;
      j = j + 1;
    end;
    rep.AddStr();
    stat = obj.GetNext();
  end;
  obj = null;
  i = i + 1;
end;
if(not empty)
  rep.PrintRep();
else
  PrintLn("Нет данных")
end;
*/

