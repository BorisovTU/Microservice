/*
$Name:         dlcalc260.mac
$Module:       БО ЦБ, ФИССиКО
$Description:  Расчетная Операция ВУ (Шаг - Выполнение перевода)
*/
import "dl_class.mac", "dl_car.mac", InsCarryDoc, FiInter, DealsInter, "spserv.mac", "sp_categ";
import rsd;
import "limout.mac";
import oralib, likepy;
import UTL_COMIS_STEP;/*CHVA*/
import "dlcalc260_ccbo5829.mac"; //ccbo5829
//import "approveaccountingentries_req.mac"; //ccbo5829

private macro getFIIDbyCurr( inCurCode )
  var cmd = RsdCommand( "select fininstr.t_FIID as fiid "
                    "from dfininstr_dbt fininstr, dcurrency_dbt currency "
                    "where currency.t_externalcode = :curCode "
                      "and ( upper( fininstr.t_fi_code ) = upper( currency.t_externalCode ) or "
                            "upper( fininstr.t_codeInAccount ) = upper( currency.t_externalCode ) )" );

  cmd.addParam( "curCode", RSDBP_IN, inCurCode );
  var rs = RsdRecordset( cmd );
  cmd.execute( );

  if ( rs.moveNext( ) )
    if ( ValType( rs.value( "fiid" ) ) != V_UNDEF )
      return Int( rs.value( "fiid" ) );
    end;
  end;

  return -1;
end;

private macro lpad( str, len)
  var chr; 
  if ( not GetParm(2, chr))
     chr = " ";
  end;
  str = Trim( string(str) );
  return MkStr(chr, len - StrLen(str)) + str;
end;

private Macro GetSectorNum(Id)
  var cmd= ("select * from dptoffice_dbt where t_partyid = /*887*/4 and t_officeid = :id");
  cmd = rsdcommand (cmd);
  cmd.addParam(":id"  , RSDBP_IN, id);
  
  var rs = rsdrecordset (cmd);
  If (rs.movenext())
     return rs.value("t_officecode");
  end;

End;

macro GetAccounts (id, sector, fiid, kind, way, acc, DogId)
  var ret=0, val="", account="", sectorcode = "";
  sectorcode = GetSectorNum(sector);
  var tp ="";
  if (kind == 2)
    tp =" Внебиржевой ";
    ret =1;
  else
    tp =" Биржевой ";
    if   (sectorcode ==2)
       val="Основной рынок"; 
       ret =1;
    elif (sectorcode ==8)
       val="Срочный рынок";
       ret =15;
    elif (sectorcode ==9)
        val="Валютный рынок";
        ret =21;
    else 
       msgboxex (sectorcode); ret = 0; return false;
    end;
  end;

  

  /*отберем договора в состве ДБО*/
  var cmd= ("select rmp.t_sfcontrid, contr.t_servkind, contr.t_servkindsub "+
            "  from ddlcontrmp_dbt rmp, dsfcontr_dbt contr "+
            " where rmp.t_dlcontrid in (select a.t_dlcontrid FROM ddlcontrmp_dbt a where a.t_sfcontrid = :id) ");
  if (kind==2 /*банк*/)
     cmd= cmd+(" and contr.t_servkindsub = 9"); /*внебиржа*/
  else
     cmd= cmd+(" and contr.t_servkindsub = 8");
  end;
  cmd= cmd+("  and contr.t_servkind = :ret "+ 
            "  and contr.t_id = rmp.t_sfcontrid ");
  cmd = rsdcommand (cmd);
  cmd.addParam(":id"  , RSDBP_IN, id);
  cmd.addParam(":ret" , RSDBP_IN, ret);

  var rs = rsdrecordset (cmd);
  while (rs.movenext)
    /*вытащим счета*/
    cmd= ("select stacc.t_account "+       
          "  from dsfssi_dbt ssin, dsettacc_dbt stacc, dsfcontr_dbt contr "+                                                                                          
          " where contr.t_id = :id "+                                                                                                                         
          "   and ssin.t_fiid = :fiid "+                                                                                                      
          "   and ssin.t_objectid = lpad(contr.t_id, 10,'0') "+                                                                                                      
          "   and stacc.t_settaccid = ssin.t_setaccid ");
    if (kind==2 /*банк*/)
      cmd = cmd+(" and contr.t_servkindsub = 9"); /*внебиржа*/
    else
      cmd = cmd+(" and contr.t_servkindsub = 8");
    end;
    cmd = cmd+("  and contr.t_servkind = :ret");
    cmd = rsdcommand (cmd);
    cmd.addParam(":id"  , RSDBP_IN, rs.value (0));
    cmd.addParam(":fiid"  , RSDBP_IN, fiid);
    cmd.addParam(":ret" , RSDBP_IN, ret);
    var sql = rsdrecordset (cmd);

    if (sql.movenext)
      account = sql.value(0);
//      msgboxex ("для сектора : "+val+" счет "+sql.value(0)+" "+tp+ way);
      setparm (5, sql.value(0));
      setparm (6, rs.value (0));
      return true;
    end;
  end;
  msgboxex ("для сектора : "+val+" /"+ tp + " не найден субдоговор / счет");
  return false;
end;

/* Возвращает БИК нашего банка
*/
private macro НашБик()
  var party = TBfile("party.dbt");
  var partcode = TBfile("partcode.dbt");
  var Ok;

  party.KeyNum = 0;
  party.rec.PartyID = {OurBank};
  Ok = party.GetEQ;
  if(not Ok)
    return "";
  end;
  partcode.KeyNum = 0;
  partcode.rec.PartyID = party.rec.PartyID;
  partcode.rec.CodeKind = PTCK_BIC;
  Ok = partcode.GetEQ;
  return IIF(Ok,partcode.rec.Code,"");
END;

//Simanov
private macro Create_intrans_paym (FD, debet, credit, ground, MakeCarry,CommSum)/*CHVA*/
  var pmobj = RSBPayment();
  var stat = true;

  pmobj.DocKind      = FD.Kind;
  pmobj.DocumentID   = string(FD.ID:o:34);
  pmobj.Purpose      = 2;
  pmobj.BaseAmount   = FD.dl_acc.rec.sum - CommSum;/*CHVA*/
  pmobj.BaseFIID     = FD.dl_acc.rec.FIID;
  pmobj.ReceiverFIID = FD.dl_acc.rec.FIID;
  pmobj.PayerFIID    = FD.dl_acc.rec.FIID;
  pmobj.ValueDate    = FD.dl_acc.rec.ValueDate;   // Дата валютирования
  pmobj.PaymStatus   = PM_READY_TO_SEND;  // Статус платежа - 3000 - Готов к отправке
  pmobj.Ground       = ground;
  pmobj.Number       = FD.ID;
  pmobj.PrimDocKind  = DOC_BO_PAYMENT;
  pmobj.NumberPack   = 11;
  pmobj.Priority     = 5;

  //Проверить опера
  pmobj.Oper = GetMainOperInGroup(pmobj.DocKind);
  if (pmobj.Oper <= 0)
    pmobj.Oper = {oper};
  end;

  Pmobj.SetPayerPI(
              PAYMENTS_GROUP_UNDEF, // Group
              {OurBank},            // BankID  // Банк плательщика
              3,                    // BankCodeKind
              НашБик(),             // BankCode
              "",                   // BankName
              "",                   // CorrAcc
              pmobj.BaseFIID,       // AccountFI
              1,                    // AccountChapter
              debet,                // Account   // Счет плательщика
              {OurBank},            // ClientID  // Плательщик
              "",                   // ClientName,
              {INN_Bank},           // ClientINN,
              3,                    // ClientCodeKind,
              НашБик()              // ClientCode
             );

  Pmobj.SetReceiverPI(
              PAYMENTS_GROUP_UNDEF, // Group
              {OurBank},            // BankID
              3,                    // BankCodeKind
              НашБик(),             // BankCode
              "",                   // BankName
              "",                   // CorrAcc
              pmobj.BaseFIID,       // AccountFI
              1,                    // AccountChapter
              credit,               // Account
              {OurBank},            // ClientID
              "",                   // ClientName,
              {INN_Bank},           // ClientINN,
              3,                    // ClientCodeKind,
              НашБик()              // ClientCode
           );

  Pmobj.IsFactPaym   = "X"; //Этот флаг должен бысть установлен уже после добавления схем расчётов. Иначе по платежу не создаётся операция 4001 (или 14001)

  pmobj.BaseRate.Actuate(pmobj.ValueDate, false);
  pmobj.FactRate.Actuate(pmobj.ValueDate, false);
  pmobj.Actuate();

  //Создание проводки
  if ( MakeCarry)
    var tr = pmobj.MakeTransaction();
    if( tr == NULL )
      msgbox("Ошибка при создании проводки по платежу");
      stat = false;
    else
      tr.Number_Pack = pmobj.NumberPack;
      if( not tr.Carry() )
        msgbox("Ошибка при выполнении проводки");
        stat = false;
      end;
    end;
  end;

  return stat;
End;

private macro make_comis_on_step(r_doc, v_Doc_Kd, v_Oper_id, v_Step_Id,  v_Contr_Id, Sm:@money)/*CHVA 507198 */
var v_Date = r_doc.Valuedate;
var Select, DataSet,rsds,rsdc;     
var i=0, coms :TArray;
 var paysum, taxsum, all_c, r, res ;

Select  = String(     "WITH Prm AS \n"
 "(SELECT :p_Dck Dock, :p_Opr Operid, :p_Stp Stepid, :p_Dat Dat FROM Dual)  \n" 
"SELECT Sfc.t_Id Cntrid   \n"
"      ,Sfcc.t_Feetype Cms_Tp   \n"
"      ,Sfcc.t_Commnumber Cms_Nm   \n"
"      ,Sfco.t_Fiid_Comm Cms_Fi   \n"
"      ,Rsi_Rsb_Kernel.Getnote(Objtype  => 650   \n"
"                            ,Objid    => Lpad(Sfcc.t_Feetype, 5, '0') || Lpad(Sfcc.t_Commnumber, 5, '0')   \n"
"                             ,Notekind => 101   \n"
"                            ,Dat      => Prm.Dat) Cms_Ku   \n"
"     ,(SELECT Mc.t_Code FROM Dmccateg_Dbt Mc WHERE Mc.t_Number = Sfco.t_Ndscateg) Cms_Nds_Ku   \n"
"      ,(SELECT p.t_Code FROM Dsfcomiss_Dbt p WHERE p.t_Comissid = Sfco.t_Parentcomissid) Cms_Gr   \n"
"  FROM Prm   \n"
" INNER JOIN Doprstep_Dbt Ops  ON (Ops.t_Id_Operation = Prm.Operid AND Ops.t_Id_Step = Prm.Stepid)   \n"
" INNER JOIN Doproper_Dbt Opr   ON (Opr.t_Id_Operation = Ops.t_Id_Operation AND Opr.t_Dockind = Prm.Dock)   \n"
" INNER JOIN Ddl_acc_Dbt ddlacc  ON (ddlacc.t_Id = To_Number(Opr.t_Documentid))   \n"
" INNER JOIN Dsfcontr_Dbt Sfc   ON (Sfc.t_Id = :p_Contr)   \n"
" INNER JOIN Dsfconcom_Dbt Sfcc  ON (Sfcc.t_Objecttype = 659 AND Sfcc.t_Objectid = Sfc.t_Id AND Sfcc.t_Feetype = 3 AND Sfcc.t_Status = 0 AND Sfcc.t_Date <= Prm.Dat)   \n"
" INNER JOIN Dsfcomiss_Dbt Sfco  ON (Sfco.t_Feetype = Sfcc.t_Feetype AND Sfco.t_Number = Sfcc.t_Commnumber AND Sfco.t_Fiid_Comm = ddlacc.t_FIID)   \n"
" INNER JOIN Doprksfcm_Dbt Oks   ON (Oks.t_Blockid = Ops.t_Blockid AND Oks.t_Number_Step = Ops.t_Number_Step AND Oks.t_Feetype = Sfcc.t_Feetype AND   \n"
"       Oks.t_Commnumber = Sfcc.t_Commnumber)   \n"
"    where (SELECT p.t_Code FROM Dsfcomiss_Dbt p WHERE p.t_Comissid = Sfco.t_Parentcomissid) like case when /*ddlacc.t_operkind=2030*/ ddlacc.t_oldcentroffice = 9 then '%Вывод%' else '%Зачисление%' end \n"
" ORDER BY Sfcc.t_Commnumber   \n" );

rsdc = rsdCommand(Select);

  rsdc.AddParam("p_Dck",RSDBP_IN,v_Doc_Kd);
  rsdc.AddParam("p_Opr",RSDBP_IN,v_Oper_Id);
  rsdc.AddParam("p_Stp",RSDBP_IN,v_Step_Id);
  rsdc.AddParam("p_Dat",RSDBP_IN,v_Date);
  rsdc.AddParam("p_Contr",RSDBP_IN,v_Contr_Id);
  rsds = rsdrecordset(rsdc, RSDVAL_CLIENT_IF_NEEDED, RSDVAL_FORWARD_ONLY);
      rsds.Open;


  //DataSet = Select.Execute();
  coms = Tarray;

if (rsds.MoveNext())
         i = coms.Size;
         coms[i] = Usr_Comiss_Parm(int(rsds.Value("Cntrid")), int(rsds.Value("Cms_Tp")), int(rsds.Value("Cms_Nm")));
         coms[i].Coms_Dt = v_Date;
         coms[i].Coms_Fi = int(rsds.Value("Cms_Fi"));
         if ((rsds.Value("Cms_Ku") != null) and ( rsds.Value("Cms_Ku") != nullval))
            coms[i].Coms_Ku = rsds.Value("Cms_Ku");
         end;
         if ((rsds.Value("Cms_Nds_Ku") != null) and ( rsds.Value("Cms_Nds_Ku") != nullval))
            coms[i].Nds_Ku = rsds.Value("Cms_Nds_Ku");
         end;
         if ((rsds.Value("Cms_Gr") != null) and ( rsds.Value("Cms_Gr") != nullval))
            coms[i].Coms_Gr = rsds.Value("Cms_Gr");
         end;
      
      rsds = null;
      rsdc = null;

  end;

  for (r, coms)
      res = SfCalcOprSfCom(r.ContrID, r.Coms_Nm, r_doc, v_Doc_Kd, r_doc.Sum, r_doc.FIID, r_doc.ValueDate, r_doc.ValueDate, @paysum, @taxsum);
      if (not res)
         r.Coms_Err = GetErrMsg();
         return r.Coms_Err;
      end;
      r.Coms_Sm = paysum;
      r.Nds_Sm  = taxsum;
   end;   
   // сформировать ненулевые комиссии
    Sm = $0.0;
   for (r, coms)
      if (r.Coms_Sm == 0)
         continue;
      end;
      // найти или открыть счета и записать в коллекцию комиссий cms
      if ((v_Doc_Kd == 159) and (r.Coms_Gr == "МСКБ_ВалБиржа_Вывод_ДС")) 
         ExecMacroFile("CLCCOM_BCOUTDS", "make_comission_doc_inacc", r_doc, r);
      elif ((v_Doc_Kd == 159) and (r.Coms_Gr == "МСКБ_ВалБиржа_Зачисление_ДС"))
         ExecMacroFile("CLCCOM_BCINCDS", "make_comission_doc_inacc", r_doc, r);
      end;
      if (strlen(trim(r.Coms_Err)) != 0)
         msgbox(r.Coms_Err);
         return false;
      end;
      //создать запись о комиссии
      Sm = Sm + r.Coms_Sm;
      if (not SfDef_Rec.Ins_rec(r, v_Oper_id, v_Step_ID, "", ""))
         msgbox(r.Coms_Err);
         return false;
      end;
   end;
 return true;
end;

private macro isEdp(_sfcontrid)
  return ExecSqlSelect("select 1 from dual where rshb_rsi_sclimit.SfcontrIsEDP(p_SfcontrID => :1) = 1", makeArray(SqlParam("1", _sfcontrid))).MoveNext();
end;

macro ExecuteStep( Doc, adr, DocKind, ID_Operation, ID_Step )

  record debacc(account);
  record Kredacc(account);

  record debacc21(account);
  record Kredacc21(account);
  record dl_acc( dl_acc );
  record pm_avoir(pmpaym);

  Var  DebProp  = TRecHandler( "pmprop.dbt" ),
       KredProp = TRecHandler( "pmprop.dbt" );
  var FD, Purpose, In = true;
  var sql, cmd1, DogIdCt, DogIdDeb, AccountVU, Ground;

  SetBuff ( dl_acc, adr );
  FD = DLFirstDocDL_ACC( dl_acc );
  
  if(dl_acc.FIKind == FIKIND_AVOIRISS)
    Purpose = BAi;
  elif(dl_acc.FIKind == FIKIND_CURRENCY)
    Purpose = CAi;
  end;
  /*-- Левченко */
  var cmd, rs;
  if ((dl_acc.opertype == 1) and (dl_acc.fikind == 1))
    if (dl_acc.fikind == 2)
      msgbox ("Запрещен перевод РОВУ по ценным бумагам");
      return 1;
    end;

    var dt="-", kt="-";

    if (not GetAccounts (dl_acc.clientcontr, dl_acc.oldcentroffice, dl_acc.fiid, dl_acc.oldplacekind, " Дебет ", dt, DogIdDeb))
      return 1;
    end;

    if (not GetAccounts (dl_acc.clientcontr, dl_acc.newcentroffice, dl_acc.fiid, dl_acc.newplacekind, " Кредит ",kt, DogIdCt))
      return 1;
    end;


     /*-- Левченко */



    if( dl_acc.OperType < 1000 )/*вид операции НЕ пользовательский (Для пользовательских видов РО проводки не формируются)*/
    /*BPV*/
      sql = "select * from dsfcontr_dbt where t_id in ( select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt  where t_sfcontrid = "+DogIdCt+")) ";
      if (dl_acc.newplacekind == 46 /*РЦ Биржи*/)
        if ( dl_acc.newcentroffice == 8 )/*срочный рынок*/
          sql = sql + " and t_servkind = 15";
        elif ( dl_acc.newcentroffice == 2 )/*основной рынок*/
          sql = sql + " and t_servkind = 1 and t_servkindsub = 8";
        elif ( dl_acc.newcentroffice == 9 )/*валютный рынок*/
          sql = sql + " and t_servkind = 21 and t_servkindsub = 8";
        else
          MsgBox("Сектор рынка может быть указан только Срочный рынок или Основной сектор");
        end;
      elif(dl_acc.newplacekind == 2 /*Банк*/)
        sql = sql + " and t_servkind = 1 and t_servkindsub = 9";
      else
        MsgBox("Вид субъекта может быть Банк или РЦ Биржи");
      end;
      var contr = TrsbDataSet(sql);
      if(contr.movenext())

        var FD_Contr = SPFirstDocContract( DL_STOCKCONTR, contr.ID );
        FD_Contr.SetParametr( MC_TYPE_PARAMETR_FIID, dl_acc.FIID );

        ClearRecord( DebAcc );
        if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, dl_acc.ValueDate, null, dl_acc.FIID ) )
          if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, null, null, DebAcc, dl_acc.ValueDate, dl_acc.FIID ) )
            return false;
          end;
        end;
        ClearRecord( KredAcc );
        if( not FD_Contr.IsExistAccount( "ДС, Расч. с клиентом, ВУ", null, true, null, KredAcc21, dl_acc.ValueDate, null, dl_acc.FIID ) )
          if( not FD_Contr.OpenAccount( "ДС, Расч. с клиентом, ВУ", null, null, null, KredAcc21, dl_acc.ValueDate, dl_acc.FIID ) )
            return false;
          end;
        end;
      end;
   /*BPV*/
      if( not FD.OpenAccount( "ДС Клиента, ВУ", null, null, FIROLE_SRCA, KredAcc, null, dl_acc.FIID ) )
        return false;
      end;

      if( not FD.OpenAccount( "ДС, Расч. с клиентом, ВУ", null, null, FIROLE_SRCA, DebAcc21, null, dl_acc.FIID ) )
        return false;
      end;

      //Ground = FD.ВУ_ОснованиеПроводки(dl_acc.OperType);
      Ground = "Перевод средств по поручению клиента № "+dl_acc.code+" от "+string(dl_acc.ValueDate:f)
               +" по Соглашению об оказании брокерских услуг № "+ StrSubst(StrSubst(StrSubst(FD_contr.Contr.rec.Number,"_в",""),"_ф",""),"_с","") +" от "+string(FD_contr.Contr.rec.DateBegin:f)+". НДС не облагается.";

      /*CHVA 507198 считаем комиссию*/
      var DogIdCurr;

      if(dl_acc.oldcentroffice ==9)
        FD.SFCONTR_FROM.rec.id = DogIdDeb;
        DogIdCurr = DogIdDeb;
      elif(dl_acc.newcentroffice == 9)
        FD.SFCONTR_FROM.rec.id = DogIdCt;
        DogIdCurr = DogIdCt;
      end;
      var Cms_sm = $0.0;
      var comInCM = $0.0;
      var contrNote =   ReadNoteForObject(OBJTYPE_SFCONTR , UniID(FD.SFCONTR_FROM,OBJTYPE_SFCONTR), 102);

      if ( (contrNote != dl_acc.fiid) and ( (dl_acc.oldcentroffice ==9) or (dl_acc.newcentroffice == 9) ) )
            
         if (not make_comis_on_step(dl_acc, DocKind, ID_Operation, ID_Step, DogIdCurr,@Cms_sm))
          return false;
         end;    
        
         if(dl_acc.newcentroffice == 9) 
           comInCM = Cms_sm;
           Cms_sm = 0;
         end;
           dl_acc.Sum  = dl_acc.Sum - Cms_sm;
      end; 
       /*CHVA 507198*/
      //Simanov. Теперь проводка будет создаваться по платежу
      if (dl_acc.OperType == 1) //Перевод ДС клиента
        Create_intrans_paym(FD, dt, kt, Ground, true, Cms_sm); /*CHVA 507198*/
      else       
        var acctrn1:RsbAccTransaction = RsbAccTransaction(); 
        
        acctrn1.Chapter         = 1;
        acctrn1.Date_Carry      = dl_acc.ValueDate;
        acctrn1.ResultCarry     = INPCARRY;
        acctrn1.Kind_Oper       = " 1";
        acctrn1.Ground          = Ground;
        acctrn1.Department      = 1;
        acctrn1.AccountPayer    = dt;
        acctrn1.AccountReceiver = kt;
        acctrn1.FIIDPayer       = dl_acc.FIID;
        acctrn1.FIIDReceiver    = dl_acc.FIID;
        acctrn1.SumPayer        = dl_acc.Sum - Cms_sm;
        acctrn1.SumReceiver     = dl_acc.Sum - Cms_sm;
        acctrn1.UserField2      = "1";//Не выгружать проводку
        acctrn1.Number_Pack     = 11;

        if ((acctrn1.FIIDPayer == 0) and (acctrn1.FIIDReceiver == 0))
          acctrn1.FIID = 0; // нац. валюта
          acctrn1.Sum = acctrn1.SumPayer-Cms_sm;
        end;

        if( not acctrn1.Carry )
          return false;
        end;
      end;

      if( not ЮзерПроводкаПоКатегориямУчета( FD,
                                   DebAcc, 
                                   KredAcc,
                                   dl_acc.ValueDate,
                                   21,
                                   dl_acc.FIID,
                                   dl_acc.Sum - comInCM,/*CHVA 509293*/
                                   "",
                                   Ground,
                                   null, 
                                   null,
                                   dl_acc.FIID,dl_acc.FIID,
                                   true, 
                                   dl_acc.OperType
                                 ))
         return false;
      end;

      if( not ЮзерПроводкаПоКатегориямУчета( FD,
                                   DebAcc21, 
                                   KredAcc21,
                                   dl_acc.ValueDate,
                                   21,
                                   dl_acc.FIID,
                                   dl_acc.Sum - comInCM,/*CHVA 509293*/
                                   "",
                                   Ground,
                                   null, 
                                   null,
                                   dl_acc.FIID,dl_acc.FIID,
                                   true, 
                                   dl_acc.OperType
                                 ))
         return false;
      end;
    end;

     /*BPV>>*/
     var err = "";

     var CLDT = TRsbDataSet( " select * from doproper_dbt where t_dockind = 159 and t_documentid = lpad("+dl_acc.id+",10,'0') " ); 
     if (CLDt.movenext())

        if ((dl_acc.ClientContr > 0) and ( NeedCorrLimit(dl_acc.ClientContr) ))
         if ((dl_acc.oldcentroffice == 9) and (not isEdp(dl_acc.ClientContr)))
           InsertLimitAdjust(dl_acc.ClientContr, "0",   "MONEY", -1*Dl_acc.Sum+comInCM, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(dl_acc.ClientContr, "1",   "MONEY", -1*Dl_acc.Sum+comInCM, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(dl_acc.ClientContr, "0",   "DEPO",   0, GetCurrencyByZeroLimit() /*USDRUB_TOM*/, dl_acc.ValueDate, ClDt.ID_Operation);
         else
           InsertLimitAdjust(dl_acc.ClientContr, "0",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(dl_acc.ClientContr, "1",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(dl_acc.ClientContr, "2",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(dl_acc.ClientContr, "365", "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
         end;
        end;
        if ((FD_Contr.Contr.rec.id > 0) and ( NeedCorrLimit(FD_Contr.Contr.rec.id) ))
         if ((dl_acc.newcentroffice == 9) and (not isEdp(FD_Contr.Contr.rec.id)))
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "0",   "MONEY", Dl_acc.Sum-comInCM, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "1",   "MONEY", Dl_acc.Sum-comInCM, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "0",   "DEPO", 0, GetCurrencyByZeroLimit() /*USDRUB_TOM*/, dl_acc.ValueDate, ClDt.ID_Operation);
         else
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "0",   "MONEY", Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "1",   "MONEY", Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "2",   "MONEY", Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
           InsertLimitAdjust(FD_Contr.Contr.rec.ID, "365", "MONEY", Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt.ID_Operation);
         end;
        end;

     else
        //err
     end;
     /*BPV<<*/


   else
     if( (dl_acc.OperType < 1000) and (dl_acc.OperType != 48 ) )/*вид операции НЕ пользовательский (Для пользовательских видов РО проводки не формируются)*/
        if( not ПроводкаПоКатегориямВнутреннегоУчета( dl_acc.OperType, 
                                                      FD, 
                                                      Doc, 
                                                      dl_acc.ValueDate, 
                                                      dl_acc.FIID,  
                                                      dl_acc.Sum
                                                    ) )
           return 1;
        end;
       if( dl_acc.OperType == 36 ) /*Перевод ДС между субсчетами ДБО (по активным счетам ВУ)*/
         if( not ПроводкаПоКатегориямВнутреннегоУчета( 37, /*Перевод ДС между субсчетами ДБО (по пассивным счетам ВУ)*/
                                                      FD, 
                                                      Doc, 
                                                      dl_acc.ValueDate, 
                                                      dl_acc.FIID,  
                                                      dl_acc.Sum
                                                    ) )
             return 1;
         end;
       end;
     end;

     
     if (dl_acc.OperType == 48)  /*Dylgerov BIQ-10484 CCVO-5829 Оплата прочей депозитарной комиссии*/
       if (not GetAccounts (dl_acc.clientcontr, dl_acc.oldcentroffice, dl_acc.fiid, dl_acc.oldplacekind, " Дебет ", dt, DogIdDeb))
         return 1;
       end;
       sql = "select sf.*, dp.t_shortname from dsfcontr_dbt sf, dparty_dbt dp where dp.t_partyid = sf.t_partyid and " + 
             "  sf.t_id in ( select t_sfcontrid from ddlcontrmp_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt  where t_sfcontrid = "+DogIdDeb+"))";
       if (dl_acc.oldplacekind == 46 /*РЦ Биржи*/)
         if ( dl_acc.oldcentroffice == 8 )/*срочный рынок*/
           sql = sql + " and t_servkind = 15";
         elif ( dl_acc.oldcentroffice == 2 )/*основной рынок*/
           sql = sql + " and t_servkind = 1 and t_servkindsub = 8";
         elif ( dl_acc.oldcentroffice == 9 )/*валютный рынок*/
           sql = sql + " and t_servkind = 21 and t_servkindsub = 8";
         else
           MsgBox("Сектор рынка может быть указан только Срочный рынок или Основной сектор");
         end;
       elif(dl_acc.oldplacekind == 2 /*Банк*/)
         sql = sql + " and t_servkind = 1 and t_servkindsub = 9";
       else
         MsgBox("Вид субъекта может быть Банк или РЦ Биржи");
       end;
       var contr48 = TrsbDataSet(sql);
       var FD_Contr48, FD_SFD;
       var credit_currency, credit_amount;  //зашиты в примечаниях РОВУ, так как  в РОВУ таких полей нет (валюта и сумма кредита) CCBO-6668
       var creditAccFiid;
       if(contr48.movenext())
         FD_Contr48 = SPFirstDocContract( DL_STOCKCONTR, contr48.ID );
         FD_Contr48.SetParametr( MC_TYPE_PARAMETR_FIID, dl_acc.FIID );
         FD_SFD = DL_SubContrFD(contr48.ID);
         ClearRecord( DebAcc );
           //if( not FD_Contr48.IsExistAccount( "ДС клиента, ц/б", null, true, null, DebAcc, dl_acc.ValueDate, null, dl_acc.FIID ) )
           //if( not FD_Contr48.OpenAccount(  "ДС клиента, ц/б", null, null, null, DebAcc, dl_acc.ValueDate, dl_acc.FIID ) )
           //end;
         if (not FD_SFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, DebAcc, dl_acc.ValueDate, dl_acc.FIID ))
           return false;
         end;
         credit_currency = ReadNoteForObject(159, lpad(dl_acc.id,10,"0"), 104); 
         credit_amount   = ReadNoteForObject(159, lpad(dl_acc.id,10,"0"), 105); 
         if ((strlen(credit_currency)>0) and (credit_amount>0)) //мультивалютная проводка по  CCBO-6668
           creditAccFiid = getFIIDbyCurr(credit_currency); //не нашел дистрибутивную функцию
         else
           creditAccFiid = dl_acc.FIID;
           credit_amount  = dl_acc.sum;
         end;
         if( not FD.OpenAccount( "ТехническийСчет", null, null, null, KredAcc, dl_acc.ValueDate, creditAccFiid ) )
           return false;
         end;
       end;
       if (GetAbsAccRest( DebAcc.account, dl_acc.ValueDate, 1, dl_acc.FIID ) < dl_acc.sum )
         MsgBox("На счете " + DebAcc.account + " не хватает остатка ("+ GetAbsAccRest( DebAcc.account, dl_acc.ValueDate, 1, dl_acc.FIID ) 
              + ") при формировании проводки БУ на сумму " + dl_acc.sum );
         return 1;
       end;
       var note48 = ReadNoteForObject(159, lpad(dl_acc.id,10,"0"), 103) ; // Основание проводки депо комиссии из ЦФТ
       var ground48;
       if (strLen(note48)>0)   
          ground48 = note48;
//                       + " Договор № " + StrSubst(StrSubst(StrSubst(FD_contr48.Contr.rec.Number,"_в",""),"_ф",""),"_с","") + " от " + string(FD_contr48.Contr.rec.DateBegin:f) 
//                       + "  (ЕКК " + getEkk(DogIdDeb) + "). Клиент - " + contr48.value("t_shortname"); 
       else
          ground48 = "Списание депозитарной комиссии в соответствии с Регламентом оказания брокерских услуг РСХБ. Договор № "  +  
                       StrSubst(StrSubst(StrSubst(FD_contr48.Contr.rec.Number,"_в",""),"_ф",""),"_с","") + " от " + string(FD_contr48.Contr.rec.DateBegin:f) 
                       + "  (ЕКК " + getEkk(DogIdDeb) + "). Клиент - " + contr48.value("t_shortname"); 
       end;

       var userField4 = ReadNoteForObject(159, lpad(dl_acc.id,10,"0"), 102) + "#1"; // ID проводки депо комиссии в ЦФТ
       if( not ПроводкаПоКатегориямВнутреннегоУчета_CCBO5829( dl_acc.OperType, 
                                                      FD, 
                                                      Doc, 
                                                      dl_acc.ValueDate, 
                                                      dl_acc.FIID,  
                                                      dl_acc.Sum,
                                                      null,
                                                      null,
                                                      null,
                                                      ground48,
                                                      null,
                                                      null,
                                                      null,
                                                      null,
                                                      userField4
                                                    ))
           return 1;
       end;

       //ccbo-6745 
       var entryNumber = ReadNoteForObject(159, lpad(dl_acc.id,10,"0"), 106); // номер мультивалютной проводки депо комиссии в ЦФТ
       if (entryNumber==null)
         entryNumber = "";
       end;

       if( not ЮзерПроводкаПоКатегориямУчета_CCBO5829( FD,
                                   DebAcc, 
                                   KredAcc,
                                   dl_acc.ValueDate,
                                   1,
                                   dl_acc.FIID,
                                   dl_acc.Sum,
                                   entryNumber,
                                   ground48,
                                   null, 
                                   null,
                                   dl_acc.FIID,creditAccFiid,
                                   true, 
                                   dl_acc.OperType,
                                   null, 
                                   null, 
                                   userField4,credit_amount, entryNumber
                                 ))
         return 1;
       end;
       var CLDT48 = TRsbDataSet( " select * from doproper_dbt where t_dockind = 159 and t_documentid = lpad("+dl_acc.id+",10,'0') " ); 

       if (CLDt48.movenext())
         if ((dl_acc.ClientContr > 0) and ( NeedCorrLimit(dl_acc.ClientContr) )) 
           if ((dl_acc.oldcentroffice == 9/*валютный рынок*/) and (not isEdp(dl_acc.ClientContr))) 
             InsertLimitAdjust(dl_acc.ClientContr, "0",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt48.ID_Operation);
             InsertLimitAdjust(dl_acc.ClientContr, "1",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt48.ID_Operation);
             InsertLimitAdjust(dl_acc.ClientContr, "0",   "DEPO", 0, GetCurrencyByZeroLimit() /*USDRUB_TOM*/, dl_acc.ValueDate, ClDt48.ID_Operation);
           elif ((dl_acc.oldcentroffice == 2/*фондовый рынок*/) or ((dl_acc.oldcentroffice == 9) and isEdp(dl_acc.ClientContr)))
             InsertLimitAdjust(dl_acc.ClientContr, "0",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt48.ID_Operation);
             InsertLimitAdjust(dl_acc.ClientContr, "1",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt48.ID_Operation);
             InsertLimitAdjust(dl_acc.ClientContr, "2",   "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt48.ID_Operation);
             InsertLimitAdjust(dl_acc.ClientContr, "365", "MONEY", -1*Dl_acc.Sum, dl_acc.FIID, dl_acc.ValueDate, ClDt48.ID_Operation);
           end;
         end;
       end;
     end; /*Dylgerov CCVO-5829*/
   end;

/* пишем заглушки для ДУ*/
  if( GetIdentProgram() == CodeFor("А") )
     InstLoadModule("tsid260.mac");
     if( ExecMacro2( "ExecuteStepOrder", dl_acc, ID_Operation, ID_Step ) != 0 )
        MsgBox("Пользователь прервал выполнение шага операции");
        return 1;
     end;
  end;

  if( not InsertOprStatus( 1592, 4) )   
     msgbox( "Ошибка при установке статуса операции" );
     return 1;
  end;


  return 0;
end;


MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

  record dl_acc( dl_acc );
  SetBuff ( dl_acc, FDoc );
  var FD = DLFirstDocDL_ACC( dl_acc );

  /*
  record nptxop("nptxop");
  SetBuff( nptxop, FDoc );
  */       
  Var Dt, cmd;
  if (errTrn OR (CommitOrRollback == 2))
    cmd = RsdCommand(" delete from ddl_limitadjust_dbt where t_id_oper = "+id_operation);
    cmd.execute();

    return 0;
  end;
  
  //Simanov. Костыль. создать операцию по платежу в арме.
  if (FD.dl_acc.rec.OperType == 1) 
    var query = "select t_paymentid from dpmpaym_dbt where t_dockind = "+FD.Kind+" and t_purpose = 2 and t_documentid = "+FD.ID+" and t_receiverbankid = "+{OurBank};
    var sql = ExecSqlSelect(query);
    if (sql.MoveNext() )
      var pmObj = RsbPayment(sql.value(0));
      var stat = PM_BOOperation(pmObj);
    end;
  end;
    
  return 0;

END;
