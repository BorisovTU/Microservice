/*
$Name:        brokcurr.mac
$Module:      ФИССиКО
$Description: Отчета брокера по валютным операциям
*/
import "DLReport_h.mac", "dlreport.mac", "dlQuery.mac", "scsrvrepfun.mac", "sc_inacc.mac";
import "dpstdrep.mac", "dl_util_xml_obj.mac", "dl_util_poi_obj.mac";
import "dvRepFun2.mac";

PRIVATE CONST BROKERREP_ERRMAILTEMPL_NOREQ = 1; //Шаблон письма об отсутствующих заявках-поручениях

private macro err_msg(err)
   var count = 0, str = "", i = 0;
   if (err.Err)
      if (IsEqClass ("TRsComErr", err.err))
         count = err.err.Count;
         i = 0;
         while (i < count)
            str = string(str, err.err.Message(i), " (Code = ",err.err.Code(i), ", Level = ",err.err.Level(i), ")", strfor(10));
            i = i + 1
         end;
         str = str + " " + err.Module + " " + err.Line + " " + err.Message;
      elif (valtype(err.err) == v_string)
         str = err.err;
      else
         str = err.Module + " " + err.Line + " " + err.Message;
      end;    
   else
      str = err.Module + " " + err.Line + " " + err.Message;
   end;
   return str;
end;

CLASS CBrokerRepErrMail (_Subject, _Body)
  var Subject = _Subject;
  var Body = _Body;
END;

private macro GetErrMailTempl(TemplID:integer, err:@variant)
   var cmd = RSDCommand("begin RSB_BRKREP.GetErrMailTempl(:TemplID, :Subject, :Body, :err); end;");
   cmd.AddParam("TemplID", RSDBP_IN,  TemplID);
   cmd.AddParam("Subject", RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("Body",    RSDBP_OUT, V_STRING, 32768);
   cmd.AddParam("err",     RSDBP_OUT, V_INTEGER);
   cmd.NullConversion = true;
   cmd.Execute();

   if (cmd.Value("err") == 0)
      return CBrokerRepErrMail( iif(ValType(cmd.Value("Subject")) == V_STRING, cmd.Value("Subject"), ""),
                                iif(ValType(cmd.Value("Body")) == V_STRING, cmd.Value("Body"), ""));
   else
      err = "Не удалось получить шаблон письма для отправки сообщения об ошибке";
      return NULL;
   end;
onerror(er)
   err = err_msg(er);
   return NULL;
end;

CLASS XLS_REPORT2PDF(InCnv)
   var errcode;
   var lcl_str = "";
   var is_2ch = false;
   var ob;
   var img_str = "";
   var ActvPrinter;
   var logo_set = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\LOGO";
   var sign_set = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\SIGN_1";
   var stmp_set = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\ОТЧЕТ БРОКЕРА\\STAMP";
   var dst_name = "";

   macro Destructor()
      if (ob)
         //ob.Quit();
      end;
      ob = null;
   end;  

   macro lcl_path(p)
      if (not is_2ch)
         return string("$", p);
      end;
      return p;
   end;

   macro abs_path(p)
      var i = 0, l = 0, pth = "";
      if (substr(p, 1, 1) != ".")
         return p;
      end;        
      if (is_2ch)
         pth = GetCurDir(false);
         while (true)
            i = index(pth, "\\", l + 1);
            if (i == 0)
               break;
            else
               l = i;
            end;
         end;       
         if (l > 0)          
            pth = substr(pth, 1, l - 1);
         end;              
      else
         pth = GetCurDir(true);
      end;
      p = strsubst(p, "..", "");
      p = strsubst(p, "\\\\", "\\");
      return string(pth, p); 
   end;

   macro add_picture(sht, cell_nm, img, SignerParty)
      var img_note, img_fnm, lcl_fnm, nam, ext, cell, shp, str;

      if (index(img,"SIGN_1") > 0)
         GetRegistryValue(img, V_INTEGER, img_note, errcode);
         img_fnm = ReadNoteForObject(OBJTYPE_PARTY , string(SignerParty:o:10), img_note );
      else
         GetRegistryValue(img, V_STRING, img_fnm, errcode);
      end;

      if (ExistDir(img_fnm) > 0)
         str = string("Ошибка поиска файла изображения ", img_fnm);  
         runerror(str, str);
      end;   
      
      if(is_2ch)
         /** Golovkin для конвейера ..\\Templs\Dlng\Secur\Истомина Н.А..jpg */
         var fileDir = splitfile(img_fnm, nam, ext);
         lcl_fnm = string(abs_path(fileDir), nam, ext);
      else
         splitfile(img_fnm, nam, ext);
         lcl_fnm = abs_path(string(lcl_str, "\\", nam, ext)); 
         if (ExistDir(lcl_path(lcl_fnm)) > 0)
            if (not CopyFile(img_fnm, lcl_path(lcl_fnm)))
                str = string("Ошибка доставки файла изображения ", img_fnm);
                runerror(str, str);
            end;
         end;   
      end;

      cell = sht.Range(cell_nm);
      
      shp = sht.Shapes.AddPicture(toansi(lcl_fnm), 0, -1, cell.Left, cell.Top, -1, -1);
   onerror(er)
      str = err_msg(er, null);
      runerror(str, str);
   end;

   macro GetPrinter(ActvPrinter)
      var wsp = CreateObject("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject("WScript.Network", false);
      var printers = wsp.EnumPrinterConnections;
      var c = 0;
      var port = "", RetVal = "";
      for (var i, printers)
         if (mod(c,2)==0) port = i;end;
         if ((index(i,"Microsoft XPS Document Writer") > 0) and 
             (index(i,"redirected") == 0))
            RetVal = i;
         end;
         c = c + 1;
      end;
      if (port == "")
         return ActvPrinter;
      elif (index(port, "PORTPROM") > 0)
         return RetVal+" (Ne00:)";
      else
         return RetVal+" ("+port+")";
      end;
   end;

   private macro getLastPb(sht)
      return sht.HPageBreaks.Item(sht.HPageBreaks.Count);
   OnError(er)
      return sht.HPageBreaks.Item(sht.HPageBreaks.Count-1);
   end;

   macro ins_pagebreak(sht, cell_nm)
      var last_pb, stmp_row, ap = sht.Application, str = "";

      if (IsShedulerRunning())
      ap.ActivePrinter = GetPrinter(ActvPrinter);
      else
      ap.ActivePrinter = ActvPrinter;
      end;
      //ap.PrintCommunication = false;
      //sht.PageSetup.PaperSize = 9;
      //ap.PrintCommunication = true;   
      ap.ActiveWindow.View = 2;
      // если страниц больше одной
      if (sht.PageSetup.Pages.Count > 1) 
        // страничный режим
        stmp_row = sht.Range(cell_nm).Cells.Row;
        //https://support.microsoft.com/ru-ru/help/210663/you-receive-a-subscript-out-of-range-error-message-when-you-use-hpageb
        //bpv обход косяка Excel из-за котрого иногда неверно определяется количество разрывов
        ob.Application.ActiveCell.specialcells(11/*xlLastCell*/).select;
        ob.Application.ActiveCell = "1";//заполни любую ячейку в конце документа
        
        if (sht.HPageBreaks.Count !=0)/*CHVA*/
          // последний разрыв страницы
          //last_pb = sht.HPageBreaks.Item(sht.HPageBreaks.Count);
          last_pb = getLastPb(sht);/*CHVA*/
          // если разрыв после ячейки со штампом
          if (last_pb.Location.Cells.Row > stmp_row - 16)
            // изменение положения разрыва
            last_pb.Location = sht.Rows(stmp_row - 18);
          end;
          ob.Application.ActiveCell.delete;//удалить костыль 
        end;/*CHVA*/
      end;
      ap.ActiveWindow.View = 1;
   onerror(er)
      ap.ActiveWindow.View = 1;
      str = err_msg(er, null);
      runerror(str, str);
   end;

   macro convert2PDF(f, dst, RepFormat, SignerParty)
      var wb, sht, str, pth, nam, ext;
      if (not ob)
        if (is_2ch)
          ob = ActiveX("Excel.Application", NULL, false);
        else
          ob = CreateObject("rsax", "TRsAxServer", "RsAxServer", false).CreateComObject("Excel.Application", false);
        end;
      end;   
      if (not ActvPrinter)
        ActvPrinter = ob.ActivePrinter;
      end;
      ob.Visible = false;
      ob.DisplayAlerts = 0;
      if ((dst  == null) or (dst == nullval))
        pth = splitfile(f, nam, ext);
        dst = string(pth, nam, ".pdf");
      end;
      dst_name = dst;
      wb = ob.Workbooks.Open(toansi(f));
      sht = wb.Sheets(1); 
      str = add_picture(sht, "LOGO__1", logo_set);
      str = add_picture(sht, "SIGN_1__1", sign_set, SignerParty);
      //str = add_picture(sht, "STAMP", stmp_set);
      //ins_pagebreak(sht, "STAMP");

      wb.ExportAsFixedFormat(0, dst, 0, 0, 0, 1, 99, 0);
      wb.Close(false);
      return 0;
   onerror(er)
      str = err_msg(er, null);
      msgbox(str);
      //println(str, strfor(10), wb, strfor(10), ob);
      if (wb)
         wb.Close(false);
      end;   
      runerror(str, str);
      return 1;
   end;

   macro Init(inCnv)
      GetRegistryValue("BANK_INI\\ОБЩИЕ ПАРАМЕТРЫ\\ДИРЕКТОРИИ\\WORKDIR", V_STRING, lcl_str, errcode);   
      if ((inCnv == null) or (inCnv == nullval))
         inCnv = false;
      end;
      if (inCnv)
         is_2ch = true;
      else
         is_2ch = isStandAlone();
      end;   
   end;
   
   Init(inCnv);
END;

CLASS СBrokCurRepData(_NameFile:string, _Format:integer, _CreateDate:date, _CreateTime:time, _ContractID:integer)
  var NameFile   = _NameFile;      //имя сформированного файла
  var Format     = _Format;        //формат файла
  var CreateDate = _CreateDate;    //дата формирвоания
  var CreateTime = _CreateTime;    //время формирования
  var ContractID = _ContractID;  //
  if (ValType(ContractID) == V_UNDEF)
     ContractID = 0;
  end;
END;

CLASS CBrokCurrRepParams()
  var PeriodKind:integer = SC_REPPERIODKIND_DAY, // Вид периода
      BegDate:date       = {curdate},            // Начальная дата
      EndDate:date       = {curdate},            // Конечная дата
      ClientID:integer   = -1,                   // Клиент
      CntrID:integer     = 0,                    // Договор
      IsFiMovement:bool  = true,                 // по движению ФИ?
      IsNotZeroRest:bool = false,                // по ненулевым остаткам?
      ShowPlanRest       = false,                // показывать плановые исходящие остатки
      ShowEmpty          = false,                // показывать пустые пункты при отсутствии данных
      IsApp:bool         = true,                 // апострофы?
      PdfFormat:bool     = true,                 // печатать в PDF
      ExcelFormat:bool   = false,                // печатать в Excel

      ShowFile:bool      = false,                // показать отчет
      InCnv              = false,                // признак того, что отчет формируется в конвейере
      InServOp           = false,                // признак того, что отчет формируется в сервисной операции
      NoData:bool        = false,                // Нет данных для выпуска отчета
      NoReq:bool         = false,                // Нет заявок-поручений по сделкам клиента

      RepData            = TArray(),             // массив данных о сформированных файлах
      ServDocID          = -1,
      SignerParty        = -1;

  var ErrMails           = TArray();             // массив с сообщениями об ошибке
END;

PRIVATE MACRO GetPlanName(PlanID:integer)
  var PlanName = "";

  var cmd = DL_RSDCommand("select t_Name from dsfplan_dbt where t_SfPlanID = ? ");
  cmd.AddParam(PlanID);

  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
    PlanName = DataSet.Name;
  end;

  return PlanName;
END;

// Получить FIID для валюты по коду
PRIVATE MACRO GetFIID(ccy)
  var q = "select t_fiid fiid from dfininstr_dbt where t_ccy = ?";
  var cmd = DL_RSDCommand();
  cmd.AddParam(ccy);
  var ds = cmd.Execute(q);
  if (ds.moveNext)
    return ds.fiid
  end;
  return -1;
END;

PRIVATE CLASS СBrokCurRep_ClientData(ClientID:integer, SfContrID:integer, EndDate:date)
  class acc
    var CODE_CURRENCY, ACCOUNT, CHAPTER, ACCOUNTID;
  end;

  PRIVATE VAR m_ClientID  = ClientID;
  PRIVATE VAR m_SfContrID = SfContrID;
  PRIVATE VAR m_EndDate   = EndDate;

  PRIVATE VAR m_ShortName   = "";
  PRIVATE VAR m_ClientCode  = "";
  PRIVATE VAR m_ContrDate   = date(0,0,0);
  PRIVATE VAR m_ContrNumber = "";
  PRIVATE VAR m_ContrDBOName = "";
  PRIVATE VAR m_ContrSfPlanName = "";
  PRIVATE VAR m_ContrNumberPstfx = "";
  PRIVATE VAR m_LegalForm:integer = 0; //Форма субъекта

  PRIVATE VAR m_accArr = TArray();
  PRIVATE VAR m_ind = 0;
  
  MACRO Load()
    var cmd, query, DataSet;
    var sfcontr = TRecHandler("sfcontr.dbt");
    var i = 0;

    // KS 09.01.2020 Кабалкина ФИО клиента должно быть написано полностью
    //query =   " select pt.t_ShortName, "
    query =   " select pt.t_Name t_ShortName, pt.t_LegalForm, "
            + " rsb_brkrep.GetSfPlanID(sf.t_id, " +GetSQLDate(m_EndDate)+ ") SfPlanID, "
            // KS 09.01.2020 в отчете должен отражаться не дата субдоговора, а дата брокерского договора
            //+ "        NVL(sf.t_DateConc, "+GetSQLDate(date(0,0,0))+") as ContrDate, "
            + "        NVL((select dbo.t_DateConc "
            + "               from ddlcontrmp_dbt dlcontrmp, dsfcontr_dbt sfcontr, ddlcontr_dbt dlcontr, dsfcontr_dbt dbo "
            + "              where sfcontr.t_id = sf.t_ID  "
            + "                AND sfcontr.t_ID = dlcontrmp.t_SfContrID "
            + "                and dlcontr.t_DlContrID = dlcontrmp.t_DlContrID "
            + "                and dlcontr.t_sfcontrid = dbo.t_id), "
            + "             "+GetSQLDate(date(0,0,0))+") as ContrDate, "
            // KS 27.12.2019 Радионова: в отчете должен отражаться не номер субдоговора, а номер брокерского договора
            //            + "        NVL(sf.t_Number, CHR(1)) as ContrNumber, "
            + "        NVL((select dbo.t_number "
            + "               from ddlcontrmp_dbt dlcontrmp, dsfcontr_dbt sfcontr, ddlcontr_dbt dlcontr, dsfcontr_dbt dbo "
            + "              where sfcontr.t_id = sf.t_ID  "
            + "                AND sfcontr.t_ID = dlcontrmp.t_SfContrID "
            + "                and dlcontr.t_DlContrID = dlcontrmp.t_DlContrID "
            + "                and dlcontr.t_sfcontrid = dbo.t_id), "
            + "             CHR(1)) as ContrNumber, "
            + "        NVL((select dbo.t_Name "
            + "               from ddlcontrmp_dbt dlcontrmp, dsfcontr_dbt sfcontr, ddlcontr_dbt dlcontr, dsfcontr_dbt dbo "
            + "              where sfcontr.t_id = sf.t_ID  "
            + "                AND sfcontr.t_ID = dlcontrmp.t_SfContrID "
            + "                and dlcontr.t_DlContrID = dlcontrmp.t_DlContrID "
            + "                and dlcontr.t_sfcontrid = dbo.t_id), "
            + "             CHR(1)) as ContrDBOName, "

            // KS 27.12.2019 Радионова: В строке "Уникальный код " указан ID клиента, а не единый краткий код клиента
            + "       NVL((select objcode.t_code "
            + "              from ddlcontrmp_dbt dlcontrmp, dsfcontr_dbt sfcontr, ddlobjcode_dbt objcode "
            + "             where sfcontr.t_id = sf.t_ID  "
            + "               AND sfcontr.t_ID = dlcontrmp.t_SfContrID "
            + "               and objcode.t_objectid = dlcontrmp.t_DlContrID "
            + "               and objcode.t_codekind = 1 "
            + "               and objcode.t_objecttype = 207), "
            + "           CHR(1)) as ClientCode, "
            + "       (select t_number from dsfcontr_dbt where t_id = sf.t_id ) t_ContrNumberPstfx "
            + "   from dparty_dbt pt "
            + "      left join dsfcontr_dbt sf on sf.t_PartyID = pt.t_PartyID and sf.t_ID = ?"
            + "  where pt.t_PartyID = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(m_SfContrID);
    cmd.AddParam(m_ClientID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      m_ShortName   = DataSet.ShortName;
      m_ClientCode  = DataSet.ClientCode;
      m_ContrDate   = date(DataSet.ContrDate);
      m_ContrNumber = DataSet.ContrNumber;
      m_ContrNumberPstfx = DataSet.ContrNumberPstfx;
      m_ContrDBOName = DataSet.ContrDBOName;
      m_ContrSfPlanName = GetPlanName(DataSet.SfPlanID);
      m_LegalForm   = DataSet.LegalForm;
    end;

    sfcontr.Clear();
    sfcontr.rec.ID = m_SfContrID;

    query =   " select distinct acc.* "
            + "   from daccount_dbt acc, dsettacc_dbt sa, dsfssi_dbt ssi "
            + "  where ssi.t_ObjectType = " + OBJTYPE_SFCONTR
            + "    and ssi.t_ObjectID = ? "
            + "    and ssi.t_FIKind = " + FIKIND_CURRENCY
            + "    and sa.t_SettAccID = ssi.t_SetAccID "
            + "    and acc.t_Account = sa.t_Account "
            + "    and acc.t_Chapter = sa.t_Chapter "
            + "    and acc.t_Code_Currency = sa.t_FIID "
            + " order by acc.t_Code_Currency, acc.t_Account, acc.t_AccountID";

    cmd = DL_RSDCommand(query);
    
    cmd.AddParam(UniID(sfcontr, OBJTYPE_SFCONTR));

    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      i = m_accArr.size;
      m_accArr[i] = acc;
      m_accArr[i].CODE_CURRENCY = DataSet.CODE_CURRENCY;
      m_accArr[i].ACCOUNT    = DataSet.ACCOUNT;
      m_accArr[i].CHAPTER    = DataSet.CHAPTER;
      m_accArr[i].ACCOUNTID  = DataSet.ACCOUNTID;
    end;

  END;

  MACRO ShortName():STRING
    if(m_LegalForm == PTLEGF_INST) //Организация
      return m_ContrDBOName;
    end;
    return m_ShortName;
  END;

  MACRO SfPlanName():STRING
    return m_ContrSfPlanName;
  END;

  MACRO ClientCode():STRING
    return m_ClientCode;
  END;

  MACRO GetClientID()
    return m_ClientID;
  END;

  MACRO ContrDate():DATE
    return m_ContrDate;
  END;

  MACRO ContrNumber():STRING
    return m_ContrNumber;
  END;

  MACRO ContrNumberPstfx():STRING
    return m_ContrNumberPstfx;
  END;

  MACRO GetAccByInd(ind)
    if(ValType(m_accArr[ind]) != V_UNDEF)
      return m_accArr[ind];
    end;
    return NULL;
  END;

  MACRO GetFirstAcc()
    return GetAccByInd(m_ind = 0);
  END;

  MACRO GetNextAcc()
    return GetAccByInd(m_ind = m_ind + 1);
  END;

  Load();
END;

PRIVATE CLASS СBrokCurRep_PrintRep(RepParams:CBrokCurrRepParams)
  PRIVATE VAR m_rep;
  VAR m_RepParams = RepParams;
  var m_ClientData = NULL;
  VAR m_CurrentRepName = "";
  PRIVATE VAR m_FullPath = "";
  PRIVATE VAR m_CellColor = "CAF9FA";
  PRIVATE VAR m_TableHeadStyle = "BOR;P=C;IC="+m_CellColor+";";
  var i:integer = 0;
  var m_currInfo = TArray();
  
  CLASS CurrInfo
    var currency = -1;
    var account = "";
    var rest = 0.0;
    var in = 0.0;
    var out = 0.0;
    var com = 0.0;
    var swap = 0.0;
    var comPay = 0.0;
    var restOut = 0.0;
    var restPlan = 0.0;
    var res = 0.0; // KS 13.01.2020 Результат по сделкам с расчетами в течении дня
    var outWithOutCommis = 0; //В этих переменных в итоге сумма вывода за вычетом комиссии, т.к. при зачислении зачисляется полная сумма , а потом удерживается комиссия, а при списании списывается за вычетом комиссии
    var sumCom = 0;
    var foundIn = false; 
    var foundOut = false; 
    var inWithoutRovu = 0;
    var outWithoutRovu = 0; 
    var inRovu = 0;
    var outRovu = 0;
  END;

  //Получить массив валют счетов клиента
  PRIVATE MACRO GetCurrArr()
    var acc = m_ClientData.GetFirstAcc();
    
    macro GetCurrInd(FIID)
      var ind = -1;
      var i = 0;
      while(i < m_currInfo.size())
        if(m_currInfo[i].currency == FIID)
          ind = i;
          break;
        end;

        i = i + 1;
      end;
      return ind;
    end;

    while(acc != NULL)
      var i = GetCurrInd(acc.Code_Currency);
      if(i == -1)
        m_currInfo[m_currInfo.size] = currInfo;
        m_currInfo[m_currInfo.size-1].currency = acc.Code_Currency;
        m_currInfo[m_currInfo.size-1].account = acc.Account;
      end;
      acc = m_ClientData.GetNextAcc();
    end;
  END;

  PRIVATE MACRO GetClientRestAC(AccountID:integer, OnDate:date):MONEY
    var query, cmd, DataSet;
    var Rest = $0;
    
    if(AccountID > 0)
      query =   " select rsb_account.restac(t_Account, t_Code_Currency, ?, t_Chapter, null) as t_rest"
              + "   from daccount_dbt "
              + "  where t_AccountID = ? ";

      cmd = DL_RSDCommand(query);         

      cmd.AddParam(OnDate);
      cmd.AddParam(AccountID);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        Rest = DataSet.Rest;
      end; 
    end;

    return Rest;
  END;

  PRIVATE CONST BROKERREP_DL_SETTLOPER = 2030; //Расчетная операция ВУ
  PRIVATE CONST BROKERREP_CALCOP_TRANSFERCLCUR = 1; //Перевод д/с
  PRIVATE CONST BROKERREP_CALCOP_RECEPCLCUR = 6; //Прием от клиента д/с
  PRIVATE CONST BROKERREP_CALCOP_RETURNCLCUR = 7; //Возврат клиенту д/с
  PRIVATE CONST BROKERREP_PART_DEALINPERIOD = 1; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С : ПО :
  PRIVATE CONST BROKERREP_PART_NOTEXECDEAL  = 2; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И НЕ ИСПОЛНЕННЫЕ НА
  PRIVATE CONST BROKERREP_PART_EXECDEAL     = 3; //СДЕЛКИ, ЗАКЛЮЧЕННЫЕ И ИСПОЛНЕННЫЕ НА

  //Поиск сумм списания/зачисления по расчетным операциям ВУ
  PRIVATE MACRO GetClientInAccSum(AccNumber:string,  Currency, isIN:bool)
    var query, cmd, DataSet;
    var queryTR, cmdTR, DataSetTR;
    var Sum = $0;
    if (strlen(AccNumber) == 0)
      return 0;
    end;
    //Golovkin 19.08.2019 IM2971095 счет по дебету в РОВУ - списание, по кредиту - зачисление
    query = " SELECT NVL (SUM (dl_acc.t_sum), 0) AS InOutSum              " +
            "   FROM ddl_acc_dbt dl_acc,                                  " +
            "        doproper_dbt oproper,                                " +
            "        doprdocs_dbt oprdocs,                                " +
            "        dacctrn_dbt acctrn                                   " +
            "  WHERE     dl_acc.t_fikind = :fikind                        " +
            "        AND dl_acc.t_fiid = :currency                        " +
            "        AND dl_acc.t_operkind = :operkind                    " +
            "        AND dl_acc.t_opertype = 1                            " +
            "        AND dl_acc.t_client = :clientid                      " +
            "        AND dl_acc.t_dockind = :calcoper                     " +
            "        AND dl_acc.t_valuedate >= :begdate                   " +
            "        AND dl_acc.t_valuedate <= :enddate                   " +
            "        AND dl_acc.t_dockind = oproper.t_dockind             " +
            "        AND LPAD (DL_ACC.T_ID, 10, 0) = oproper.t_documentid " +
            "        AND oprdocs.t_id_operation = oproper.t_id_operation  " +
            "        AND OPRDOCS.T_ACCTRNID = acctrn.t_acctrnid           " +
            "        AND acctrn.t_chapter = 1 "+
             "      AND ACCTRN.T_GROUND not like 'Ком%'";

    if(isIN)
        query = query + " AND ACCTRN.T_ACCOUNT_RECEIVER in ("+AccNumber+") "; // KS 13.01.2020 Проверю сразу все счета
    else
        query = query + " AND ACCTRN.T_ACCOUNT_PAYER in ("+AccNumber+") ";
    end;

    cmd = DL_RSDCommand(query);
    cmd.AddParam(FIKIND_CURRENCY);
    cmd.AddParam(Currency);
    cmd.AddParam(BROKERREP_DL_SETTLOPER);
    cmd.AddParam(m_RepParams.ClientID);
    cmd.AddParam(DL_CALCOPER);
    cmd.AddParam(m_RepParams.BegDate);
    cmd.AddParam(m_RepParams.EndDate);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())
      Sum = DataSet.InOutSum;
    end;
    /*
    queryTR = "select NVL(sum(in_acc.t_sum), 0) as InOutSum "
             + " from ddl_acc_dbt dl_acc, ddlinacc_dbt in_acc "
             + " where dl_acc.t_dockind = in_acc.t_documentkind "
             + " and dl_acc.t_id = in_acc.t_documentid "
             + " and dl_acc.t_fiid = in_acc.t_fiid "
             + " and dl_acc.t_opertype = in_acc.t_opertype "
             + " and dl_acc.t_fikind = ? "
             + " and dl_acc.t_fiid = ? "
             + " and dl_acc.t_operkind = ? "
             + " and dl_acc.t_opertype = ? "
             + " and dl_acc.t_client = ? "
             + " and dl_acc.t_clientcontr = ? "
             + " and dl_acc.t_dockind = ? "
             + " and in_acc.t_date >= ? "
             + " and in_acc.t_date <= ? ";
    if (isIN)
       queryTR = queryTR + " and in_acc.t_kredacc = ";
    else
       queryTR = queryTR + " and in_acc.t_debacc = ";
    end;

    queryTR = queryTR + " (select ac.t_account acc                                  " +
                        "     from daccount_dbt ac, dsettacc_dbt sa, dSfssi_dbt ss  " +
                        "      where sa.t_settaccid = ss.t_setaccid                 " +
                        "        and ss.t_objecttype = 659                          " +
                        "        and ss.t_objectid = LPAD(?, 10, '0')               " +
                        "        and (ss.t_FIKind = ? or ss.t_FIKind = 0)           " + 
                        "        and ac.t_Balance in ('30601', '30606')             " +
                        "        and ac.t_account = sa.t_account                    " +
                        "        and ac.t_chapter = sa.t_chapter                    " +
                        "        and ac.t_code_currency = sa.t_fiid                 " +
                        "        and ac.t_Client = ?                                " +
                        "        and ac.t_code_currency = ?                        )";

    cmdTR = DL_RSDCommand(queryTR);
    cmdTR.AddParam(FIKIND_CURRENCY);
    cmdTR.AddParam(Currency);
    cmdTR.AddParam(BROKERREP_DL_SETTLOPER);
    cmdTR.AddParam(BROKERREP_CALCOP_TRANSFERCLCUR);
    cmdTR.AddParam(m_RepParams.ClientID);
    cmdTR.AddParam(ContrID);
    cmdTR.AddParam(DL_CALCOPER);
    cmdTR.AddParam(m_RepParams.BegDate);
    cmdTR.AddParam(m_RepParams.EndDate);
    cmdTR.AddParam(ContrID);
    cmdTR.AddParam(FIKIND_CURRENCY);
    cmdTR.AddParam(m_RepParams.ClientID);
    cmdTR.AddParam(Currency);    
    DataSetTR = cmdTR.Execute();

    if(DataSetTR.moveNext())
      Sum = Sum + DataSetTR.InOutSum;
    end;*/
    return Sum;
  end;

  PRIVATE MACRO LOGO_LINE
     m_rep.Put_Str("", "START;");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("", "");
     m_rep.Put_Str("Логотип", "FC=W;CN=LOGO__1;");
     m_rep.Put_Str("", "FC=W;END;");
     //m_rep.Put_Str("email:"+m_ClientData.ClientEmail, "FC=W;END;");
  end;
  
  PRIVATE MACRO PrintHeader(CntrID:integer)
     m_Rep.Set_WrapText(0);
     // KS 20191206 Доработка под формат банка
     // m_rep.Put_Str("Отчет по сделкам и операциям с ценными бумагами, совершенным в течение дня", "START;R=6;FB;HA=C;END;");
     LOGO_LINE(); 
     m_rep.Put_Str("Валютный рынок МБ", "START;R=6;FB;HA=C;END;");
     m_rep.Put_Str("Отчет по сделкам и операциям с валютами, совершенным в течение дня", "START;R=6;FB;HA=C;END;");
     if (m_RepParams.EndDate!=m_RepParams.BegDate)
       m_rep.Put_Str("(ОТЧЕТ БРОКЕРА)   с "+DL_DateToStr(m_RepParams.BegDate)+" по "+DL_DateToStr(m_RepParams.EndDate), "START;HA=C;R=6;END;");
     else
       m_rep.Put_Str("(ОТЧЕТ БРОКЕРА) " + DL_DateToStr(m_RepParams.BegDate), "START;HA=C;R=6;END;");
     end;

     m_rep.Put_Str("По операциям:", "START;R=1;HA=L;");
     m_rep.Put_Str(m_ClientData.ShortName(), "HA=L;END;");
     m_rep.Put_Str("Уникальный код:", "START;R=1;HA=L;");
     m_rep.Put_Str(m_ClientData.ClientCode(), "HA=L;END;");
     m_rep.Blank_Line();
     m_rep.Put_Str("Дата и номер договора на брокерское обслуживание: " + m_ClientData.ContrDate() + " № ", "START;R=5;HA=L;");
     m_rep.Put_Str(m_ClientData.ContrNumber(), "HA=L;END;");
     m_rep.Blank_Line();

     m_rep.Put_Str("Дата начала периода:", "START;R=1;HA=L;");
     m_rep.Put_Str(m_RepParams.BegDate, "HA=L;T=D;END;");
     m_rep.Put_Str("Дата окончания периода:", "START;R=1;HA=L;");
     m_rep.Put_Str(m_RepParams.EndDate, "HA=L;T=D;END;");
     m_rep.Put_Str("Настоящим сообщаем, в вышеуказанный отчетный период по Вашему поручению совершены следующие операции:", "START;R=7;HA=L;END;");
     m_rep.Blank_Line();
     m_rep.Blank_Line();
  END;

  MACRO CreateReport(flagBreak:@integer)/*CHVA 517260*/

    private macro ShowEmptyRep(ContrID)
      var CreateEmpty = 0;

      var dt = TRsbDataSet("select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid = " + Contrid);
      if (dt.movenext())
         getMainObjAttr (null, 207, string(dt.dlcontrid:o:34), 150, null,null, CreateEmpty);//формировать нулевой отчет
      end;

      if (CreateEmpty > 0) 
         return true;
      else 
         return false;
      end;
    end;

    PRIVATE MACRO IsValidClientContr(ContrID:integer)
      var valid = true;
      var q, ds, select;
      var ClientData = NULL;
      var acc = null;

      if((m_RepParams.IsFiMovement == true) or (m_RepParams.IsNotZeroRest == true) )

        valid = false;

        ClientData = СBrokCurRep_ClientData(m_RepParams.ClientID, ContrID, m_RepParams.EndDate);

        select = DL_RSDCommand();

        q =   " select 1 "
            + "   from daccount_dbt acc, dmcaccdoc_dbt mc "
            + "  where acc.t_account = mc.t_account and acc.t_chapter = mc.t_chapter and acc.t_code_currency = mc.t_currency "
            + "  and mc.t_clientcontrid = ?   and acc.t_Client = ?"
            + "  and  (   "
            + "          acc.t_Chapter = 22 or acc.t_Chapter = 21 "
            + "    or mc.t_catnum = 5087 ";

        select.AddParam(ContrID);
        select.AddParam(m_RepParams.ClientID);

        acc = ClientData.GetFirstAcc();
        while(acc != NULL)
          q = q + " or (   acc.t_Account = ? "
                + "    and acc.t_Code_Currency = ? "
                + "    and acc.t_Chapter = ?"
                + "    ) ";
          
          select.AddParam(acc.Account);
          select.AddParam(acc.Code_Currency);
          select.AddParam(acc.Chapter);

          acc = ClientData.GetNextAcc();
        end;
        
        if(m_RepParams.IsFiMovement == true)
          q = q + " or rsb_account.kreditac(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?, ?, null) <> 0 "
                + " or rsb_account.debetac(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?, ?, null) <> 0";

          select.AddParam(m_RepParams.BegDate);
          select.AddParam(m_RepParams.EndDate);
          select.AddParam(m_RepParams.BegDate);
          select.AddParam(m_RepParams.EndDate);
        end;

        q = q + " ) ";

        if(m_RepParams.IsNotZeroRest == true)
          q = q + " and rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null) <> 0 ";
          
          select.AddParam(m_RepParams.EndDate);
        end;

        q = q + " and ROWNUM = 1";

        ds = select.Execute(q);
        if(ds.moveNext())
          valid = true;
        end;
      end;

      return valid;
    END;

    /*Дату в строку*/
    private macro GetDateS(dt:date)
      var i;
      datesplit(dt, i);
      if(i < 10)
        return "0" + substr(string(dt),2);
      else
        return string(dt);
      end;
    end;
    
    private macro GetCDS()
      var cmd, DataSet;
      cmd = DL_RSDCommand("select trunc(sysdate) dt from dual");
      DataSet = cmd.execute();
      DataSet.moveNext();
      return date(DataSet.dt);
    end;

    // Пользовательская подпись this->m_rep
    MACRO AddStandardFooter()
      MACRO Операционист():string
          var cmd = DL_RSDCommand("SELECT person.t_Name " +
                                     "  FROM dperson_dbt person " +
                                     " WHERE person.t_PartyID = ? "
                                    );
             cmd.AddParam(m_repparams.SignerParty);

          var RS = cmd.Execute();
          if( RS.MoveNext() )
            return RS.Name;
          else 
            cmd = null;
            cmd = DL_RSDCommand("SELECT person.t_Name " +
                                    "  FROM dperson_dbt person " +
                                    " WHERE person.t_Oper = ? "
                                   );
            cmd.AddParam({oper});
            if( RS.MoveNext() )
               return RS.Name;
            end;
          end;
         return "";
      END;

      MACRO ДолжностьОперациониста():string
         return "Исполнитель";
      END;

      var PostOper = ДолжностьОперациониста();

      m_rep.Set_WrapText(0);
      m_rep.Blank_Line();

      m_rep.Put_Str("", "START;");
      m_rep.Put_Str("", "");
      m_rep.Put_Str("", "");
      m_rep.Put_Str("", "");
      m_rep.Put_Str("Подпись1", "FC=W;END;CN=SIGN_1__1;");

      m_rep.Blank_Line();
      m_rep.Blank_Line();
      m_rep.Blank_Line();
      m_rep.Blank_Line();

      m_rep.Put_Str("   " + PostOper + ": " + Операционист(),"START;P=L;END;");
      m_rep.Put_Str("   М.П.", "START;P=L;");
      m_rep.Put_Str("", "");
      m_rep.Put_Str("Печать", "FC=W;END;CN=STAMP;");
      m_rep.Blank_Line();
      m_rep.Put_Str("Дата составления: " + GetDateS(GetCDS()), "START;P=L;END;");
    END;

    // Печать заголовка и шапки таблицы 1
    MACRO PrintHeaderAndCapTarif(planName)
      m_Rep.Set_WrapText(0);
      m_rep.Put_Str("СДЕЛКИ, СОВЕРШЕННЫЕ В РАМКАХ ТАРИФНОГО ПЛАНА  \""+planName + "\"", "START;HA=L;R=6;END;");
      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("Дата и время заключения сделки",  m_TableHeadStyle+"START;POIH=48;");
      m_rep.Put_Str("Дата исполнения сделки",          m_TableHeadStyle);
      m_rep.Put_Str("Номер",                           m_TableHeadStyle);
      m_rep.Put_Str("Номер в ТС",                      m_TableHeadStyle);
      m_rep.Put_Str("Торговая площадка:",              m_TableHeadStyle);
      m_rep.Put_Str("Инструмент:",                     m_TableHeadStyle);
      m_rep.Put_Str("Вид сделки",                      m_TableHeadStyle);
      m_rep.Put_Str("Объем сделки",                    m_TableHeadStyle);
      m_rep.Put_Str("Цена заявки",                     m_TableHeadStyle);
      m_rep.Put_Str("Цена сделки",                     m_TableHeadStyle);
      m_rep.Put_Str("Валюта сделки",                   m_TableHeadStyle);
      m_rep.Put_Str("Валюта расчетов",                 m_TableHeadStyle);
      m_rep.Put_Str("Сумма в валюте сделки",           m_TableHeadStyle);
      m_rep.Put_Str("Сумма в валюте расчетов",         m_TableHeadStyle);
      m_rep.Put_Str("Сумма в рублях (по курсу ЦБ на дату заключения)", m_TableHeadStyle);
      m_rep.Put_Str("Комиссия брокера в валюте расчетов",              m_TableHeadStyle);
      m_rep.Put_Str("Комиссия брокера в рублях",                       m_TableHeadStyle);
      m_rep.Put_Str("Комиссия организатора торгов в рублях",           m_TableHeadStyle);
      m_rep.Put_Str("Комиссия за клиринговое обслуживание в рублях",   m_TableHeadStyle);
      m_rep.Put_Str("Комиссия за ИТС в рублях",        m_TableHeadStyle);
      m_rep.Put_Str("Тип сделки",                      m_TableHeadStyle);
      m_rep.Put_Str("Контрагент",                      m_TableHeadStyle);
      m_rep.Put_Str("Код контрагента",                 m_TableHeadStyle);
      m_rep.Put_Str("Обязательства в валюте сделки",   m_TableHeadStyle);
      m_rep.Put_Str("Обязательства в валюте расчетов", m_TableHeadStyle);
      m_rep.Put_Str("","END;");
    END;

    // Печать заголовка таблицы 2
    MACRO PrintHeaderAndCapNptxop()
      m_Rep.Set_WrapText(1);
      m_rep.Put_Str("Дата",   m_TableHeadStyle+"START;");
      m_rep.Put_Str("Валюта", m_TableHeadStyle);
      m_rep.Put_Str("Тип",    m_TableHeadStyle);
      m_rep.Put_Str("Сумма",  m_TableHeadStyle);
      m_rep.Put_Str("","END;");
    END;

    // Печать заголовка таблицы 3
    MACRO PrintHeaderAndCapMove()
      m_Rep.Set_WrapText(1);
      i = 0; 
      while(i < m_currInfo.size())
        m_rep.Put_Str(GetCCY(m_currInfo[i].currency), m_TableHeadStyle + IIF(i == 0,"START;",""));
        i = i + 1;  
      end;
      m_rep.Put_Str("","END;");
      if ((ВидСубъекта(m_ClientData.GetClientID, PTK_CONFID_MANAGER)) or (ВидСубъекта(m_ClientData.GetClientID, PTK_INSURANCE)))
        i = 0; 
        while(i < m_currInfo.size())
          m_rep.Put_Str(m_currInfo[i].account, IIF(i == 0,"START;BOR;POIH=25.5;","BOR;HA=C;"));
          i = i + 1; 
        end;
        m_rep.Put_Str("","END;");
      end;
    END;

    var RUR = NATCUR;
    var USD = GetFIID("USD");
    var EUR = GetFIID("EUR");
    var CHF = GetFIID("CHF");
    var GBP = GetFIID("GBP");
    var CNY = GetFIID("CNY");

    var err = 0;
    var cnt = 0;
    var resultFileName = "";

    // выпускаем отчёт из под apache poi
    m_rep = T_Poi_Rep();

    m_RepParams.RepData.size = 0;
    m_RepParams.NoData = m_RepParams.NoReq = false;

    var CreateDate = date();
    var CreateTime = time();
    var day, mon, year;
    var hour, min, sec;

    DateSplit(CreateDate, day, mon, year);
    TimeSplit(CreateTime, hour, min, sec);
    m_CurrentRepName = ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR)
                       +"_"+string(year)+string(mon:f)+string(day:f)
                       +"_"+string(hour:f)+string(min:f)+string(sec:f);

    InitProgress(-1, "Формирование отчета", "Формирование отчета");
    m_rep.Init("utf8", m_RepParams.IsApp);
    m_rep.Set_Column_Width(/* 1*/  65,
                           /* 2*/  49,
                           /* 3*/  59,
                           /* 4*/  50,
                           /* 5*/  53,
                           /* 6*/  56,
                           /* 7*/  101,
                           /* 8*/  58,
                           /* 9*/  52,
                           /*10*/  52,
                           /*11*/  40,
                           /*12*/  51,
                           /*13*/  51,
                           /*14*/  58,
                           /*15*/  66,
                           /*16*/  66,
                           /*17*/  93,
                           /*18*/  65,
                           /*19*/  56,
                           /*20*/  50,
                           /*21*/  163,
                           /*22*/  59,
                           /*23*/  52,
                           /*24*/  60,
                           /*25*/  77,
                           /*26*/  77);

    m_rep.Set_Landscape();
    m_rep.Set_Indent(0);
    m_rep.Print_Header(m_CurrentRepName, "Calibri", 9);

    var query, cmd, DataSet;
    var sql2, cmd2, ds2, firstLine;
    cmd = DL_RSDCommand();
    query =   " select sf.t_ID "
            + "   from dsfcontr_dbt sf "
            + "  where sf.t_ServKind = " + PTSK_CM;
    if(m_RepParams.CntrID > 0)
      query = query + " and sf.t_ID = ? ";
      cmd.AddParam(m_RepParams.CntrID);
    else
      query = query + " and sf.t_PartyID = ? " 
                    + "    and sf.t_ContractorID > 0  " 
                    + "    and sf.t_DateBegin <= ? "
                    + "    and (sf.t_DateClose = "+GetSQLDate(date(0,0,0))+" or sf.t_DateClose >= ? ) ";
      cmd.AddParam(m_RepParams.ClientID);
      cmd.AddParam(m_RepParams.EndDate);
      cmd.AddParam(m_RepParams.BegDate);
    end;
       
    var DealData, ContrDataCount, ContrID;

    DataSet = cmd.Execute(query);
    var IsDataPrinted = false;
    var IsEmptyPrinted = false;
    var NoReqDealStr = "";
    var PrintFooterFlag = true;
    var PrintHeaderFlag = true;
    var prevPlanID = -1;
    var PartStr = "";

    MACRO CreateByMode ( mode ) // функция формирования 1-й части отчёта
        var isValidDeal = false;
        PartStr = "";
        var sql = "  SELECT dvn.t_id as DealID, " +
                  "         dvn.t_kind as OpKind, " +
                  "         dvn.t_dvkind as DvKind, " +
                  "         dvn.t_dockind as DocKind, " +
                  "         case when dvn.t_dvkind = 7 then 0 else (case when dvnfi.t_type = 0 then 1 else 2 end) end as Part, " +
                  "         case when dvn.t_dvkind = 7 then 0 else 1 end as IsSwap, " +
                  "         rsb_brkrep.GetSfPlanID(?, dvn.t_date) as P01, " +
                  "         dvn.t_date as A05_D, " +
                  "         dvn.t_time as A05_T, " +
                  "         dvnfi.t_execdate as A06, " +
                  "         dvn.t_code as A07, " +
                  "         case when dvn.t_sector = 'X' then dvn.t_extcode else '' end as A08, " +
                  "         case when dvn.t_sector = 'X' then 'ММВБ' else '' end as A09, " +
                  "         case when dvn.t_type = 1 then 'Покупка' " +
                  "           when dvn.t_type = 2 then 'Продажа' " +
                  "           when dvn.t_type = 5 and dvnfi.t_type = 2 then 'Продажа' " +
                  "           when dvn.t_type = 6 and dvnfi.t_type = 0 then 'Продажа' " +
                  "           when dvn.t_type = 5 and dvnfi.t_type = 0 then 'Покупка' " +
                  "           when dvn.t_type = 6 and dvnfi.t_type = 2 then 'Покупка' " +
                  "           else '' " +
                  "           end as A11, " +
                  "         dvnfi.t_amount as A12, " +
                  "         dvnfi.t_price as A13, " +
                  "         dvnfi.t_point as A13_point, " +
                  "         fin.t_ccy as A14, " +
                  "         price.t_ccy as A15, " +
                  "         fin.t_fiid as BaseFiid, " +
                  "         price.t_fiid as ContrFiid, " +
                  "         dvnfi.t_amount as A16, " +
                  "         dvnfi.t_cost as A17, " +
                  "         case when fin.t_fiid = 0 " +
                  "            then dvnfi.t_amount " +
                  "            else RSI_RSB_FIInstr.ConvSum(dvnfi.t_amount, fin.t_fiid, 0, dvn.t_date, 0) " +
                  "            end as A18, " +
                  /*"         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  //"             and upper(sfc.t_code) like '%БРОКЕР%' ), 0) as A19, "
                  "             and upper(sfc.t_code) like 'МСКБ_ВБ_ДН%' ), 0) as A19, "
                  //"         nvl((select sum(dlc.t_sum) " +
                  "         nvl((select RSI_RSB_FIInstr.ConvSum(sum(dlc.t_sum), price.t_fiid, 0, dvn.t_date, 0) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  //"             and upper(sfc.t_code) like '%БРОКЕР%'), 0) as A20, "
                  "             and upper(sfc.t_code) like 'МСКБ_ВБ_ДН%' ), 0) as A20, "*/
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and upper(sfc.t_code) = Upper('МскБиржВ')), 0) as A21, " +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and upper(sfc.t_code) = Upper('МскБиржКлирВ')), 0) as A22, " +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and upper(sfc.t_code) = Upper('МскБиржИТСВ')), 0) as A23, " +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and dvnfi.t_type <>2"+/*CHVA 510019*/
                  "             and sfc.t_fiid_comm = " + RUR + "), 0) as ComissRUR, "  +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and dvnfi.t_type <>2"+/*CHVA 510019*/
                  "             and sfc.t_fiid_comm = " + USD + "), 0) as ComissUSD, "   +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and dvnfi.t_type <>2"+/*CHVA 510019*/
                  "             and sfc.t_fiid_comm = " + EUR + "), 0) as ComissEUR, "   +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and dvnfi.t_type <>2"+/*CHVA 510019*/
                  "             and sfc.t_fiid_comm = " + CHF + "), 0) as ComissCHF, "   +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and dvnfi.t_type <>2"+/*CHVA 510019*/ 
                  "             and sfc.t_fiid_comm = " + GBP + "), 0) as ComissGBP, "   +
                  "         nvl((select sum(dlc.t_sum) " +
                  "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                  "           where dlc.t_docid = dvn.t_id " +
                  "             and dlc.t_dockind = dvn.t_dockind " +
                  "             and dlc.t_feetype = sfc.t_feetype " +
                  "             and dlc.t_comnumber = sfc.t_number " +
                  "             and dvnfi.t_type <>2"+ 
                  "             and sfc.t_fiid_comm = " + CNY + "), 0) as ComissCNY, "   +
                  "         case when dvn.t_sector = 'X' then 'Безадресная' else 'Адресная' end as A24, " +
                  "         case when dvn.t_contractor > 0 then (select t_shortname from dparty_dbt pt where pt.t_partyid = dvn.t_contractor) " +
                  "           else '' " +
                  "           end as A25, " +
                  "         case when dvn.t_contractor > 0 then (select t_code from dpartcode_dbt pc where pc.t_codekind = 8 and pc.t_partyid = dvn.t_contractor) " +
                  "           else '' " +
                  "           end as A26, " +
                  "         'A27' as A27, " +
                  "         'A28' as A28, " +
                  "         nvl((select req.t_price " +
                  "                from dspground_dbt ground, dspgrdoc_dbt dealdoc, dspgrdoc_dbt reqdoc, ddl_req_dbt req " +
                  "               where dealdoc.t_sourcedocid = dvn.t_id " + 
                  "                 and dealdoc.t_sourcedockind = dvn.t_dockind " +                            
                  "                 and ground.t_spgroundid = dealdoc.t_spgroundid " +
                  "                 and ground.t_spgroundid = reqdoc.t_spgroundid " +
                  "                 and dealdoc.t_sourcedocid != reqdoc.t_sourcedocid " +
                  "                 and dealdoc.t_sourcedockind != reqdoc.t_sourcedockind " +
                  "                 and reqdoc.t_sourcedocid = req.t_id " +
                  "                 and req.t_sourcekind = dealdoc.t_sourcedockind " +
                  "                 and req.t_client = dvn.t_client " +
                  "                 and reqdoc.t_sourcedockind = req.t_kind " +   
                  "                 and rownum = 1), null) as A43 " +      
                  "    FROM ddvndeal_dbt dvn, ddvnfi_dbt dvnfi, dfininstr_dbt fin, dfininstr_dbt price" +
                  "   WHERE dvn.t_client      = ? " +
                  "     and dvn.t_clientcontr = ? " +
                  "     and dvn.t_dvkind in (6, 7) " +
                  "     and dvn.t_state in (1, 2) " +
                  "     and dvnfi.t_dealid = dvn.t_id " +
                  "     and dvnfi.t_fiid = fin.t_fiid " +
                  "     and fin.t_fi_kind = 1 " +
                  "     and dvnfi.t_pricefiid = price.t_fiid " +
                  "     and dvn.t_date <= ? " +
                  "     and  not exists (select 1 " +
                  "                                                  from doproper_dbt op, doprstep_dbt st " +
                  "                                                 where op.t_documentid = lpad(dvn.t_id, 34, '0') " +
                  "                                                   and op.t_dockind = dvn.t_dockind " +
                  "                                                   and op.t_id_operation = st.t_id_operation " +
                  "                                                   and st.t_plan_date < ? " +/*and st.t_fact_date < ? " +*//*CHVA 513542  по сделкам вышло, что шаги исполнены фактически в следующем числе*/
                  "                                                   and st.t_isexecute = 'X' " +
                  // KS Учёт пользовательских операций
                  "                                                   and (case when dvn.t_dvkind = 7  then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (273004, 273005) or t_parent in (273004, 273005)) and st.t_symbol in ('Т','Б') then 1 else 0 end) " +
                  "                                                             when dvn.t_dvkind = 6 and dvnfi.t_type = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (271002) or t_parent in (271002)) and st.t_symbol in ('т','о') then 1 else 0 end) " +
                  "                                                             when dvn.t_dvkind = 6 and dvnfi.t_type = 2 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (271003) or t_parent in (271003)) and st.t_symbol in ('Т','О') then 1 else 0 end) " +
                  "                                                             else 0 end) = 1 )";
        if ( mode == BROKERREP_PART_DEALINPERIOD )
          sql = sql + "     and dvn.t_date between ? and ? " //+ "   ORDER BY P01, DealID ";
                                                               + "   ORDER BY P01, A05_D, A05_T, DealID, Part ";/*CHVA 510019*/
        elif ( mode == BROKERREP_PART_NOTEXECDEAL )
          sql = sql + "     and dvn.t_date < ? and not exists (select 1 " +
                  "                                                  from doproper_dbt op, doprstep_dbt st " +
                  "                                                 where op.t_documentid = lpad(dvn.t_id, 34, '0') " +
                  "                                                   and op.t_dockind = dvn.t_dockind " +
                  "                                                   and op.t_id_operation = st.t_id_operation " +
                  "                                                   and st.t_plan_date between ? and ? " +/*and st.t_fact_date between ? and ? " +*//*CHVA 513542  по сделкам вышло, что шаги исполнены фактически в следующем числе*/
                  "                                                   and st.t_isexecute = 'X' " +
                  // KS Учёт пользовательских операций
                  "                                                   and (case when dvn.t_dvkind = 7  then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (273004, 273005) or t_parent in (273004, 273005)) and st.t_symbol in ('Т','Б') then 1 else 0 end) " +
                  "                                     when dvn.t_dvkind = 6 and dvnfi.t_type = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (271002) or t_parent in (271002)) and st.t_symbol in ('т','о') then 1 else 0 end) " +
                  "                                     when dvn.t_dvkind = 6 and dvnfi.t_type = 2 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (271003) or t_parent in (271003)) and st.t_symbol in ('Т','О') then 1 else 0 end) " +
                  "                           else 0 end) = 1 ) "  //+ "   ORDER BY P01, DealID ";
                                                                   + "   ORDER BY P01, A05_D, A05_T, DealID, Part ";/*CHVA 510019*/
        elif ( mode == BROKERREP_PART_EXECDEAL )
          sql = sql + " and dvn.t_date < ?"; // KS 09.06.2020 Условие "заключённые ранее"
          sql = sql + " and exists (select 1 " +
                  "                           from doproper_dbt op, doprstep_dbt st " +
                  "                           where op.t_documentid = lpad(dvn.t_id, 34, '0') " +
                  "                           and op.t_dockind = dvn.t_dockind " +
                  "                           and op.t_id_operation = st.t_id_operation " +
                  "                           and st.t_plan_date between ? and ? " +/*and st.t_fact_date between ? and ? " +*/ /*CHVA 513542  по сделкам вышло, что шаги исполнены фактически в следующем числе*/
                  "                           and st.t_isexecute = 'X' " +
                  // KS Учёт пользовательских операций
                  "                           and (case when dvn.t_dvkind = 7 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (273004, 273005) or t_parent in (273004, 273005)) and st.t_symbol in ('Т','Б') then 1 else 0 end) " +
                  "                                     when dvn.t_dvkind = 6 and dvnfi.t_type = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (271002) or t_parent in (271002)) and st.t_symbol in ('т','о') then 1 else 0 end) " +
                  "                                     when dvn.t_dvkind = 6 and dvnfi.t_type = 2 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where t_blockid in (271003) or t_parent in (271003)) and st.t_symbol in ('Т','О') then 1 else 0 end) " +
                  "                           else 0 end) = 1 ) "  //+ "   ORDER BY P01, DealID ";
                                                                   + "   ORDER BY P01, A05_D, A05_T, DealID, Part ";/*CHVA 510019*/
        else
                  // KS 10.01.2020 Сортировка по времени
          //sql = sql + "     ORDER BY P01, DealID ";
          sql = sql + "   ORDER BY P01, A05_D, A05_T, DealID, Part ";/*CHVA 510019*/
        end;

        var exec = DL_RSDCommand(sql);
        exec.addParam(ContrID);
        exec.addParam(m_RepParams.ClientID);
        exec.addParam(ContrID);
        exec.addParam(m_RepParams.EndDate);
        exec.addParam(m_RepParams.BegDate);
        if (( mode == BROKERREP_PART_NOTEXECDEAL )
           or ( mode == BROKERREP_PART_EXECDEAL ) )
          // KS 09.06.2020 Условие "заключённые ранее"
          exec.addParam(m_RepParams.BegDate);
        end;
        exec.addParam(m_RepParams.BegDate);
        exec.addParam(m_RepParams.EndDate);

        ContrDataCount = exec.GetCount();
        DealData = exec.execute();

        sql2 = "select 1 "
             "  from dnptxop_dbt nptxop "
             " where nptxop.t_client = ? "
             "   and nptxop.t_operdate between ? and ? "
             "   and nptxop.t_contract = ? ";
        cmd2 = DL_RSDCommand(sql2);
        cmd2.addParam(m_RepParams.ClientID);
        cmd2.addParam(m_RepParams.BegDate);
        cmd2.addParam(m_RepParams.EndDate);
        cmd2.addParam(ContrID);

        var prevPlanID = -1;
        var i = 0, PrevDealID = 0;
        var IsPrinted = false;
        var isNeedRec = false;/*CHVA 510019*/
        var DateFirstPart = date(0,0,0);/*CHVA 510019*/
        m_Rep.Set_WrapText(0);
        
        
        while(DealData.moveNext())
          i = i + 1;
          isValidDeal = false;
          var q1to, cmd1to, rs1to;

            if(ValType(DealData.A43) == V_UNDEF)
              m_RepParams.NoReq = true;
              if( Index(NoReqDealStr, DealData.A07) == 0 ) 
                NoReqDealStr = NoReqDealStr + IIF(NoReqDealStr != "", ", ", "") + "\"" + DealData.A07 + "\"";
              end;
            end;        

          if (not IsPrinted)
            if ( mode == BROKERREP_PART_DEALINPERIOD )
              PartStr = "1.  СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С  " + DL_DateToStr(m_RepParams.BegDate) + " ПО " + DL_DateToStr(m_RepParams.EndDate);
              m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            elif ( mode == BROKERREP_PART_NOTEXECDEAL )
              m_rep.Blank_Line();
              PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И НЕ ИСПОЛНЕННЫЕ НА  " + DL_DateToStr(m_RepParams.EndDate);
               m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            elif ( mode == BROKERREP_PART_EXECDEAL )
              m_rep.Blank_Line();
              PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА  " + DL_DateToStr(m_RepParams.EndDate);
              m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            end;
            
            IsPrinted = true;
          end;

          IsDataPrinted = true;
          if(prevPlanID != DealData.P01)
            PrintHeaderAndCapTarif(GetPlanName(DealData.P01));
          end;
          
          var Instrument = "";
          if (DealData.IsSwap == 1)
            if ((DealData.BaseFiid == USD) and (DealData.ContrFiid == RUR))
              Instrument = "USDRUB_Спец. SWAP";
            elif ((DealData.BaseFiid == EUR) and (DealData.ContrFiid == RUR))
              Instrument = "EURRUB_Спец. SWAP";
            elif ((DealData.BaseFiid == EUR) and (DealData.ContrFiid == USD))
              Instrument = "EURUSD_Спец. SWAP";
            elif ((DealData.BaseFiid == CNY) and (DealData.ContrFiid == RUR))
              Instrument = "CNYRUB_Спец. SWAP";
            elif ((DealData.BaseFiid == USD) and (DealData.ContrFiid == CNY))
              Instrument = "USDCNY_Спец. SWAP";
            end;
            
            if ( DealData.Part == 1 )
              Instrument = Instrument + " часть 1";
            else
              Instrument = Instrument + " часть 2";
            end;
            
            if (mode == BROKERREP_PART_DEALINPERIOD )
              i = 0; 
              while(i < m_currInfo.size())
                if(DealData.ContrFiid == m_currInfo[i].currency)
                  m_currInfo[i].swap = m_currInfo[i].swap + iif(DealData.A11 == "Покупка", -DealData.A17, DealData.A17);
                end;
                i = i + 1;
              end;
            end;
            
            /*CHVA 510019*/
            if (DealData.Part == 1)
              DateFirstPart = date(DealData.A05_D);
              if(DateFirstPart == m_RepParams.BegDate )
                isNeedRec = true;
              end;
            end;
            
            if (mode == BROKERREP_PART_DEALINPERIOD )   
              if( isNeedRec == false)
                if (DealData.Part == 2)
                  i = 0; 
                  while(i < m_currInfo.size())
                    m_currInfo[i].swap = 0.0;
                    i = i + 1;
                  end;
                end;
              end;
            end;
            /*CHVA 510019*/
          else
            if ((DealData.BaseFiid == USD) and (DealData.ContrFiid == RUR))
              Instrument = "USDRUB";
            elif ((DealData.BaseFiid == EUR) and (DealData.ContrFiid == RUR))
              Instrument = "EURRUB";
            elif ((DealData.BaseFiid == EUR) and (DealData.ContrFiid == USD))
              Instrument = "EURUSD";
            elif ((DealData.BaseFiid == GBP) and (DealData.ContrFiid == RUR))
              Instrument = "GBPRUB";
            elif ((DealData.BaseFiid == CHF) and (DealData.ContrFiid == RUR))
              Instrument = "CHFRUB";
            elif ((DealData.BaseFiid == CNY) and (DealData.ContrFiid == RUR))
              Instrument = "CNYRUB";
            elif ((DealData.BaseFiid == USD) and (DealData.ContrFiid == CNY))
              Instrument = "USDCNY";
            else // KS 20191216 Если инструмент не подобрали, то генерируем свой код
              Instrument = DealData.A14 + DealData.A15;
            end;
            
            if (date(DealData.A05_D) == date(DealData.A06))
              Instrument = Instrument + "_TOD";
            else
              Instrument = Instrument + "_TOM";
            end;
          end;

          var qto, cmdto, rsto;
          var liabilityBase = 0.0, liabilityContr = 0.0;
          liabilityContr = DealData.A17; // KS 13.01.2020 необходим учет в любом случае
          liabilityBase = DealData.A16; // KS 13.01.2020 необходим учет в любом случае
          var isExecTr = true; // KS 14.01.2020 isExec = false - требование не исполнено
          var isExecOb = true; // KS 14.01.2020 isExec = false - обязательство не исполнено

          qto = "select 1 " +
                "  from doproper_dbt op, doprstep_dbt st " +
                " where op.t_kind_operation = ? " +
                "   and op.t_documentid = ? " +
                "   and op.t_id_operation = st.t_id_operation " +
                // KS 14.01.2020 Учёт не только неисполненных, но и исполненных в другой период
                //"   and st.t_isexecute != 'X' " +
                "   and (st.t_isexecute != 'X' or not (st.t_plan_date between ? and ?))"/*CHVA 513542  по сделкам вышло, что шаги исполнены фактически в следующем числе. Заменил fact на plan*/
                // KS 14.01.2020 Учёт пользовательских операций, скопированных из дистрибутивных
                //"   and (case when ? = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 273004 in (t_blockid, t_parent)) and t_number_step = 60 then 1 else 0 end) " +
                "   and (case when ? = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 273005 in (t_blockid, t_parent)) and st.t_symbol = 'Б' then 1 else 0 end) " +
                "             when ? = 1 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 271002 in (t_blockid, t_parent)) and st.t_symbol = 'о' then 1 else 0 end) " +
                "             when ? = 2 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 271003 in (t_blockid, t_parent)) and st.t_symbol = 'О' then 1 else 0 end) " +
                "             else 0 end) = 1 ";
          cmdto = DL_RSDCommand(qto);
          cmdto.addParam(DealData.OpKind);
          cmdto.addParam(DealData.DealID);
          cmdto.addParam(m_RepParams.BegDate);
          cmdto.addParam(m_RepParams.EndDate);
          cmdto.addParam(DealData.Part);
          cmdto.addParam(DealData.Part);
          cmdto.addParam(DealData.Part);
          rsto = cmdto.execute();
          
          if (rsto.moveNext())
            // Есть неисполненные обязательства
            isExecOb = false; // KS 14.01.2020 isExecOb = false - текущее обязательство не исполнено
            if (DealData.A11 == "Покупка")
              // liabilityContr = DealData.A17; // KS 13.01.2020 необходим учет в любом случае
              i = 0; 
              while(i < m_currInfo.size())
                if(DealData.ContrFiid == m_currInfo[i].currency)
                  m_currInfo[i].restPlan = m_currInfo[i].restPlan - liabilityContr;
                end;
                i = i + 1;
              end;
            else
              // liabilityBase = DealData.A16; // KS 13.01.2020 необходим учет в любом случае
              i = 0; 
              while(i < m_currInfo.size())
                if(DealData.BaseFiid == m_currInfo[i].currency)
                  m_currInfo[i].restPlan = m_currInfo[i].restPlan - liabilityBase;
                end;
                i = i + 1;
              end;
            end;
          end;

          qto = "select 1 " +
                "  from doproper_dbt op, doprstep_dbt st " +
                " where op.t_kind_operation = ? " +
                "   and op.t_documentid = ? " +
                "   and op.t_id_operation = st.t_id_operation " +
                // KS 14.01.2020 Учёт не только неисполненных, но и исполненных в другой период
                //"   and st.t_isexecute != 'X' " +
                "   and (st.t_isexecute != 'X' or not (st.t_plan_date between ? and ?))" /*CHVA 513542  по сделкам вышло, что шаги исполнены фактически в следующем числе. Заменил fact на plan*/
                // KS 14.01.2020 Учёт пользовательских операций, скопированных из дистрибутивных
                //"   and (case when ? = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 273005 in (t_blockid, t_parent)) and t_number_step = 70 then 1 else 0 end) " +
                "   and (case when ? = 0 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 273004 in (t_blockid, t_parent)) and st.t_symbol = 'Т' then 1 else 0 end) " +
                "             when ? = 1 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 271002 in (t_blockid, t_parent)) and st.t_symbol = 'т' then 1 else 0 end) " +
                "             when ? = 2 then (case when st.t_blockid in (select t_blockid from doprblock_dbt where 271003 in (t_blockid, t_parent)) and st.t_symbol = 'Т' then 1 else 0 end) " +
                "             else 0 end) = 1 ";
          cmdto = DL_RSDCommand(qto);
          cmdto.addParam(DealData.OpKind);
          cmdto.addParam(DealData.DealID);
          cmdto.addParam(m_RepParams.BegDate);
          cmdto.addParam(m_RepParams.EndDate);
          cmdto.addParam(DealData.Part);
          cmdto.addParam(DealData.Part);
          cmdto.addParam(DealData.Part);
          rsto = cmdto.execute();
          
          if (rsto.moveNext())
            // Есть неисполненные требования
            isExecTr = false; // KS 14.01.2020 isExecTr = false - текущее требование не исполнено
            if (DealData.A11 == "Покупка")
              i = 0; 
              while(i < m_currInfo.size())
                if(DealData.BaseFiid == m_currInfo[i].currency)
                  m_currInfo[i].restPlan = m_currInfo[i].restPlan + DealData.A16;
                end;
                i = i + 1;
              end;
            else
              i = 0; 
              while(i < m_currInfo.size())
                if(DealData.ContrFiid == m_currInfo[i].currency)
                  m_currInfo[i].restPlan = m_currInfo[i].restPlan + DealData.A17;
                end;
                i = i + 1;
              end;
            end;
          end;

          if (DealData.DealID != PrevDealID)
            if (isExecTr) // KS 14.01.2020 Учитываем комиссию только если текущее требование исполнено
              i = 0; 
              while(i < m_currInfo.size())
                if(m_currInfo[i].currency == RUR) // Пока оставляем здесь проверку валют, чтобы не переделывать всю архитектуру расчета комиссий
                  m_currInfo[i].comPay = m_currInfo[i].comPay + DealData.ComissRUR;
                elif(m_currInfo[i].currency == USD)
                  m_currInfo[i].comPay = m_currInfo[i].comPay + DealData.ComissUSD;
                elif(m_currInfo[i].currency == EUR)
                  m_currInfo[i].comPay = m_currInfo[i].comPay + DealData.ComissEUR;
                elif(m_currInfo[i].currency == CHF)
                  m_currInfo[i].comPay = m_currInfo[i].comPay + DealData.ComissCHF;
                elif(m_currInfo[i].currency == GBP)
                  m_currInfo[i].comPay = m_currInfo[i].comPay + DealData.ComissGBP;
                elif(m_currInfo[i].currency == CNY)
                  m_currInfo[i].comPay = m_currInfo[i].comPay + DealData.ComissCNY;
                end;
                i = i + 1;
              end;
            end;
          end;

          var resDif = iif(DealData.A11 == "Покупка", iif(isExecTr, DealData.A16, 0), iif(isExecOb, -DealData.A16, 0));
          i = 0; 
          while(i < m_currInfo.size())
            if(DealData.BaseFiid == m_currInfo[i].currency)
              m_currInfo[i].restOut = m_currInfo[i].restOut + resDif;
              m_currInfo[i].res = m_currInfo[i].res + resDif; // KS 13.01.2020 Результат по сделкам с расчетами в течении дня
            end;
            i = i + 1;
          end;

          resDif = iif(DealData.A11 == "Покупка", iif(isExecOb, -DealData.A17, 0), iif(isExecTr, DealData.A17, 0));
          i = 0; 
          while(i < m_currInfo.size())
            if(DealData.ContrFiid == m_currInfo[i].currency)
              m_currInfo[i].restOut = m_currInfo[i].restOut + resDif;
              m_currInfo[i].res = m_currInfo[i].res + resDif; // KS 13.01.2020 Результат по сделкам с расчетами в течении дня
            end;
            i = i + 1;
          end;

          if (not isExecTr) // KS 14.01.2020 Учитываем комиссию только в плановом остатке и только если текущее требование не исполнено
            i = 0; 
            while(i < m_currInfo.size())
              if(m_currInfo[i].currency == RUR) // Пока оставляем здесь проверку валют, чтобы не переделывать всю архитектуру расчета комиссий
                m_currInfo[i].restPlan = m_currInfo[i].restPlan - DealData.ComissRUR;
              elif(m_currInfo[i].currency == USD)
                m_currInfo[i].restPlan = m_currInfo[i].restPlan - DealData.ComissUSD;
              elif(m_currInfo[i].currency == EUR)
                m_currInfo[i].restPlan = m_currInfo[i].restPlan - DealData.ComissEUR;
              elif(m_currInfo[i].currency == CHF)
                m_currInfo[i].restPlan = m_currInfo[i].restPlan - DealData.ComissCHF;
              elif(m_currInfo[i].currency == GBP)
                m_currInfo[i].restPlan = m_currInfo[i].restPlan - DealData.ComissGBP;
              elif(m_currInfo[i].currency == CNY)
                m_currInfo[i].restPlan = m_currInfo[i].restPlan - DealData.ComissCNY;
              end;
              i = i + 1;
            end;
          end;

          var qcom, cmdcom, rscom;
          var A19 = 0.0, A20 = 0.0;
          qcom = " select dlc.t_sum, dlc.t_date, sfc.t_fiid_comm as fiid " +
                 "            from ddlcomis_dbt dlc, dsfcomiss_dbt sfc " +
                 "           where dlc.t_docid =     ? " +
                 "             and dlc.t_dockind =   ? " +
                 "             and dlc.t_feetype =   sfc.t_feetype " +
                 "             and dlc.t_comnumber = sfc.t_number " +
                 "             and sfc.t_receiverid = ? " ;
          cmdcom = DL_RSDCommand(qcom);
          cmdcom.addParam(DealData.DealID);
          cmdcom.addParam(DealData.DocKind);
          cmdcom.addParam({ourbank});
          rscom = cmdcom.execute();
          
          while (rscom.moveNext())
             var tmpPrice, tmpNatcur;
             DV_SmartConvertSumDbl(tmpPrice, rscom.Sum, rscom.Date, rscom.FIID, DealData.ContrFiid);
             DV_SmartConvertSumDbl(tmpNatcur, rscom.Sum, rscom.Date, rscom.FIID, NATCUR);
             
             A19 = IIF(DealData.Part !=2, A19 + tmpPrice, 0);/*CHVA 510553*/
             A20 = IIF(DealData.Part !=2, A20 + tmpNatcur,0);/*CHVA 510553*/
          end;

          m_rep.Put_Str(string(date(DealData.A05_D):f) + " " + string(time(DealData.A05_T)), "BOR;P=C;START;POIH=24;");
          m_rep.Put_Val(date(DealData.A06), "BOR;P=C;T=D;");
          // 523469 в новом формате  в номер сделки добавляется дата для того, чтобы разделять встречные сделки по запроосу 289864
          m_rep.Put_Str(IIF(StrLen(DealData.A07)>=16,SubStr(DealData.A07,10),DealData.A07),       "BOR;P=C;");
          m_rep.Put_Str(DealData.A08,       "BOR;P=C;");
          m_rep.Put_Str(DealData.A09,       "BOR;P=C;");
          m_rep.Put_Str(Instrument,         "BOR;P=C;");
          m_rep.Put_Str(DealData.A11,       "BOR;P=C;");
          m_rep.Put_Val(DealData.A12,       "BOR;HA=R;VA=C;T=M2;");

          if (index(Instrument,"SWAP") > 0) /*по свопам дублируем цену*/
             m_rep.Put_Val(DealData.A13,    "BOR;HA=R;VA=C;T=M" + DealData.A13_point + ";");
            elif(ValType(DealData.A43) == V_UNDEF)
              m_rep.Put_Str("",             "BOR;P=C;");
          elif (DealData.A43 == 0.0)  /*если заявка есть, но она нулевая, то "Рыночная"*/
             m_rep.Put_Str("Рыночная",      "BOR;P=C;");
          else
             m_rep.Put_Val(DealData.A43,    "BOR;HA=R;VA=C;T=N4;");
          end;

          //m_rep.Put_Str(GetRateOnDateCrossDbl(date(DealData.A06), DealData.ContrFiid, DealData.BaseFiid, false), "BOR;HA=R;VA=C;T=M4;");
          m_rep.Put_Val(DealData.A13,       "BOR;HA=R;VA=C;T=M" + DealData.A13_point + ";");
          m_rep.Put_Str(DealData.A14,       "BOR;P=C;");
          m_rep.Put_Str(DealData.A15,       "BOR;P=C;");
          //m_rep.Put_Val(iif(DealData.A11 == "Покупка", DealData.A16, -DealData.A16),       "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(DealData.A12,       "BOR;HA=R;VA=C;T=M2;");
          //m_rep.Put_Val(iif(DealData.A11 == "Покупка", -DealData.A17, DealData.A17),       "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(DealData.A17,       "BOR;HA=R;VA=C;T=M2;");
          //m_rep.Put_Val(iif(DealData.A11 == "Покупка", -DealData.A18, DealData.A18),       "BOR;HA=R;VA=C;T=M2;");
          //m_rep.Put_Val(DealData.A12,       "BOR;HA=R;VA=C;T=M2;");
          // Разобраться тут с лишним полем
          m_rep.Put_Val(DealData.A18,       "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(A19,       "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(A20,       "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(IIF(DealData.Part !=2,DealData.A21,0),       "BOR;HA=R;VA=C;T=M2;");/*CHVA 510553*/
          // Разобраться тут с лишним полем End
          m_rep.Put_Val(IIF(DealData.Part !=2, DealData.A22,0),       "BOR;HA=R;VA=C;T=M2;");/*CHVA 510553*/
          m_rep.Put_Val(IIF(DealData.Part !=2, DealData.A23,0),       "BOR;HA=R;VA=C;T=M2;");/*CHVA 510553*/
          m_rep.Put_Str(DealData.A24,       "BOR;P=C;");
          m_rep.Put_Str(DealData.A25,       "BOR;P=C;");
          m_rep.Put_Str(DealData.A26,       "BOR;P=C;");
          m_rep.Put_Val(IIF(isExecOb, 0, liabilityBase),       "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Val(IIF(isExecOb, 0, liabilityContr),      "BOR;HA=R;VA=C;T=M2;");
          m_rep.Put_Str("","END;");
          prevPlanID = DealData.P01;
          PrevDealID = DealData.DealID;
        end;
        
        prevPlanID = -1;
        
        if ( (not IsPrinted) and ((m_RepParams.ShowEmpty == SET_CHAR) or ShowEmptyRep(DataSet.ID)) )
          IsEmptyPrinted = true;
          if ( mode == BROKERREP_PART_DEALINPERIOD )
            PartStr = "1.  СДЕЛКИ, ЗАКЛЮЧЕННЫЕ В ПЕРИОД С  " + DL_DateToStr(m_RepParams.BegDate) + " ПО " + DL_DateToStr(m_RepParams.EndDate);
            m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            PrintHeaderAndCapTarif(m_ClientData.SfPlanName() /*GetPlanName(0)*/);
          elif ( mode == BROKERREP_PART_NOTEXECDEAL )
            m_rep.Blank_Line();
            PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И НЕ ИСПОЛНЕННЫЕ НА  " + DL_DateToStr(m_RepParams.EndDate);
            m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            PrintHeaderAndCapTarif(m_ClientData.SfPlanName() /*GetPlanName(0)*/);
          elif ( mode == BROKERREP_PART_EXECDEAL )
            m_rep.Blank_Line();
            PartStr = "СДЕЛКИ, ЗАКЛЮЧЕННЫЕ РАНЕЕ И ИСПОЛНЕННЫЕ НА  " + DL_DateToStr(m_RepParams.EndDate);
            m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            PrintHeaderAndCapTarif(m_ClientData.SfPlanName()/*GetPlanName(0)*/);
            m_rep.Blank_Line();
          end;
        end;
    END; // CreateByMode

    var progress = 0;
    while( DataSet.moveNext() )
      UseProgress(progress = progress + 1);
      if( IsValidClientContr(DataSet.ID) or (m_RepParams.ShowEmpty == SET_CHAR) or (ShowEmptyRep(DataSet.ID)));
        ContrID = DataSet.ID; PartStr = "";
        InitProgress(6, "Подготовка данных для разделов отчета", "Подготовка данных для разделов отчета");

        m_ClientData = СBrokCurRep_ClientData(m_RepParams.ClientID, ContrID, m_RepParams.EndDate);

        m_CurrInfo = TArray();
        GetCurrArr(); // Заполнение массива m_currInfo всеми доступными по договору валютами

        if (PrintHeaderFlag)
          PrintHeader(ContrID);
          PrintHeaderFlag = false;
        end;
        //1 часть отчёта
        CreateByMode ( BROKERREP_PART_DEALINPERIOD );
        UseProgress(1);
        CreateByMode ( BROKERREP_PART_NOTEXECDEAL );
        UseProgress(2);
        CreateByMode ( BROKERREP_PART_EXECDEAL );
        UseProgress(3);

        if( (IsDataPrinted == true) or (IsEmptyPrinted == true) )
          m_rep.Put_Str("Информация о размере полученной дополнительной выгоды Брокера: 0.00 руб.", "START;FB;HA=L;R=6;END;");
        end;

        //2 часть отчёта
        var accRec = m_ClientData.GetFirstAcc();
        var accounts = "";
        var A32_comm = 0;

        var prevOp = 0, nextOp = 0;
        var sql3, cmd3, ds3;
        var sumWithCommis = 0;
        var op = 0, kindop = 0, kindOfOper = 0, oldcentroffice = 0;
        var commisForOut = 0; // В этой переменной будет накапливаться комиссия  за вывод средств
        
        while (accRec != NULL)
          if (accounts != "")
            accounts = accounts + ", ";   
          end;
          
          accounts = accounts + "'" + accRec.Account + "'";
          accRec = m_ClientData.GetNextAcc();
        end;
        
        accounts = IIF (accounts == "", "NULL", accounts );
        sql2 = "SELECT docs.t_id_operation as oper, opr.t_kind_operation AS kindOfOper, opr.t_docKind as docKind, opr.t_documentid as documentID, " +
                      "trans.t_acctrnid, trans.t_ground as ground, trans.t_date_carry as A29, trans.t_FIID_Payer as A30, " +
                      "case when trans.t_Account_Receiver like '306%' then 'Перевод' else 'Списание' end as A31, trans.t_Sum_Payer as A32, 1 as isOut " +
                 "FROM dacctrn_dbt trans, doprdocs_dbt docs, doproper_dbt opr " +
                "WHERE trans.t_Account_Payer  IN ( " + accounts +" ) " +
                  "AND trans.T_DATE_CARRY >= ? " +
                  "AND trans.T_DATE_CARRY <= ? " +
                  "AND trans.T_TYPEDOCUMENT <>'Ц' " +
                  "AND trans.T_RESULT_CARRY = " + INPCARRY + " " +
                  "AND docs.t_id_operation = opr.t_id_operation " +
                  "AND docs.t_acctrnid  = trans.t_acctrnid " +
               "UNION ALL " +
               "SELECT oprdocs.t_id_operation as oper, oproper.t_kind_operation AS kindOfOper, oproper.t_docKind as docKind, oproper.t_documentid as documentID, " +
                      "transrec.t_acctrnid, transrec.t_ground as ground,transrec.t_date_carry as A29, transrec.t_FIID_Receiver as A30, " +
                      "case when transrec.t_Account_Payer like '306%' then 'Перевод' else 'Зачисление' end as A31, transrec.t_Sum_Receiver as A32, 0 as isOut " +
                 "FROM dacctrn_dbt transrec, doprdocs_dbt oprdocs ,  doproper_dbt oproper " +
                "WHERE transrec.t_Account_Receiver  IN ( " + accounts +" ) " +
                  "AND transrec.t_Account_Payer NOT IN ( " + accounts +" ) " +
                  "AND transrec.T_DATE_CARRY >= ? " +
                  "AND transrec.T_DATE_CARRY <= ? "
                  "AND transrec.T_TYPEDOCUMENT <>'Ц' " +
                  "AND transrec.T_RESULT_CARRY = " + INPCARRY + " " +
                  "AND oprdocs.t_id_operation = oproper.t_id_operation " +
                  "AND oprdocs.t_acctrnid  = transrec.t_acctrnid " +
                "ORDER by oper asc, t_acctrnid asc";
        cmd2 = DL_RSDCommand(sql2);
        cmd2.addParam(m_RepParams.BegDate);
        cmd2.addParam(m_RepParams.EndDate);
        cmd2.addParam(m_RepParams.BegDate);
        cmd2.addParam(m_RepParams.EndDate);
        ds2 = cmd2.execute();
        firstLine = true;

        while (ds2.moveNext())
          A32_comm = 0; // убираем комиссии из списка  в табличке "ОТЧЕТ О ВЫВОДАХ И ЗАЧИСЛЕНИЯХ НА БРОКЕРСКИЕ СЧЕТА"
          prevOp = ds2.oper;
                    
          if(substr(ds2.ground ,1,3) == "Ком")
            A32_comm = ds2.A32;
            ds2.A32 = 0;
            commisForOut = 0;
            if (ds2.kindOfOper != 2030)
              sql3 = "SELECT opr.t_id_operation AS oper, opr.t_kind_operation AS op, nptxop.t_subkind_operation AS kind " +
                       "FROM doprdocs_dbt docs, dacctrn_dbt trn, doproper_dbt opr, dnptxop_dbt nptxop " +
                      "WHERE docs.t_id_operation = opr.t_id_operation " +
                        "AND docs.t_acctrnid = trn.t_acctrnid " +
                        "AND trn.t_acctrnid = ? " +
                        "AND LPAD (nptxop.t_id, 34, '0') = OPR.T_DOCUMENTID " +
                        "AND nptxop.t_contract = " + DATASET.ID;
              cmd3 = DL_RSDCommand(sql3);
              cmd3.addParam(ds2.rec.t_acctrnid);
              ds3 = cmd3.execute();

              if(ds3.moveNext())
                nextOp = ds3.oper;
                op = ds3.op ;
                kindop = ds3.kind ;
                
                if ((op == 2037) and (kindop == 20)) // проверяем, что комиссия по операции списания/зачисления "Списание"
                  sumWithCommis = A32_comm;
                  commisForOut = commisForOut + sumWithCommis;
                end;
              end;
            else
              sql3 =  "SELECT opr.t_id_operation AS oper, opr.t_kind_operation AS op, dlacc.t_oldcentroffice AS centroffice " +
                        "FROM doprdocs_dbt docs, dacctrn_dbt trn, doproper_dbt opr, ddl_acc_dbt dlacc " +
                       "WHERE docs.t_id_operation = opr.t_id_operation " +
                         "AND docs.t_acctrnid = trn.t_acctrnid " +
                         "AND trn.t_acctrnid = ? " +
                         "AND LPAD (dlacc.t_id, 10, '0') = OPR.T_DOCUMENTID " ;
                           //"  AND dlacc.t_clientcontr = " + DATASET.ID;
              cmd3 = DL_RSDCommand(sql3);
              cmd3.addParam(ds2.rec.t_acctrnid);
              ds3 = cmd3.execute();
              
              if(ds3.moveNext())
                nextOp = ds3.oper;
                op = ds3.op ;
                oldcentroffice  =  ds3.centroffice  ;

                if( (op == 2030) and (oldcentroffice == 9) ) // проверяем, что комиссия по операции РОВУ при выводе средств с валютного рынка
                  sumWithCommis = A32_comm;
                end;
              end;
            end;
          end;  

          if ((nextOp == prevOp) and (ds2.A32 != 0) and (sumWithCommis > 0)) // Если id операции комиссии и следующей записи совпадают, значит, суммируем комиссию и сумму вывода
            ds2.A32 = ds2.A32 + sumWithCommis;
            sumWithCommis = 0;
            commisForOut = 0;
          end;
          
          // Убрать переводы м/у площадками в "Зачислено/списано со внешних счетов"
          var internalMovingValue = 0;
          
          if ((ds2.A32 != 0) and (ds2.KindOfOper == 2037) and (ds2.docKind == 4607))
            var cmdSubKind = DL_RSDCommand("SELECT t_subKind_operation as subKind FROM dNptxOp_dbt WHERE t_ID = ?");
            cmdSubKind.AddParam(ds2.documentID);
            var subKindDS = cmdSubKind.Execute();
            
            if (subKindDS.MoveNext() and (subKindDS.subKind == 30)) // Перевод между субсчетами ДБО
              internalMovingValue = ds2.A32;
            end;
          end;
          
          var FI_Code = GetCCY(ds2.A30);
          IsDataPrinted = true;
          if (firstLine == true)
            m_rep.Blank_Line();
            PartStr = "ОТЧЕТ О ВЫВОДАХ И ЗАЧИСЛЕНИЯХ НА БРОКЕРСКИЕ СЧЕТА";
            m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
            PrintHeaderAndCapNptxop();
            firstLine = false;
          end;
          
          if (ds2.A32 != 0)
            m_rep.Put_Val(date(ds2.A29), "BOR;P=C;T=D;START;");
            m_rep.Put_Str(FI_Code,       "BOR;P=C;");
            m_rep.Put_Str(ds2.A31,       "BOR;P=C;");
            m_rep.Put_Val(ds2.A32,       "BOR;HA=R;VA=C;T=M2;");
            m_rep.Put_Str("","END;");
          end;
          
          i = 0;
          while (i < m_currInfo.size())
            if (ds2.A30 == m_currInfo[i].currency)
              if (ds2.isOut == 1)
                m_currInfo[i].out = m_currInfo[i].out + ds2.A32;
                m_currInfo[i].outRovu = m_currInfo[i].outRovu + internalMovingValue;
              else
                m_currInfo[i].in = m_currInfo[i].in + ds2.A32;
                m_currInfo[i].inRovu = m_currInfo[i].inRovu + internalMovingValue;
              end;

              m_currInfo[i].com = m_currInfo[i].com + A32_comm; // Учтём сумму комиссии
              m_currInfo[i].outWithOutCommis = m_currInfo[i].outWithOutCommis + commisForOut;//накапливаем комиссию за вывод
            end;
            
            i = i + 1;
          end;
        end;
        UseProgress(4);
        
        if (firstLine and ((m_RepParams.ShowEmpty == SET_CHAR) or ShowEmptyRep(DataSet.ID)) )
          IsEmptyPrinted = true;
          m_rep.Blank_Line();
          PartStr = "ОТЧЕТ О ВЫВОДАХ И ЗАЧИСЛЕНИЯХ НА БРОКЕРСКИЕ СЧЕТА";
          m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
          m_rep.Blank_Line();
          PrintHeaderAndCapNptxop();
        end;

        i = 0; 
        while(i < m_currInfo.size())
          m_currInfo[i].sumCom = 0;
          i = i + 1;
        end;
        
        var acc = m_ClientData.GetFirstAcc();
        var accArr = ""; // Строка для всех счетов в sql-формате
        
        while(acc != NULL)
          var rest = GetClientRestAC(acc.AccountID, m_RepParams.BegDate-1);
          
          // пока работает, но надо пересмотреть, для отчета за период  берет последнюю операцию из списка
          if( ( (op == 2037) and (kindop == 20) )   or (op == 2030 /* and (oldcentroffice == 9 )*/)  ) // проверяем, что комиссия по операции списания/зачисления "Списание"
            i = 0; 
            while(i < m_currInfo.size())
              m_currInfo[i].sumCom = m_currInfo[i].com;
              i = i + 1;
            end;
          end;

          accArr = accArr + ", '" + acc.Account + "'";
          i = 0; 
          while(i < m_currInfo.size())
            if(acc.Code_Currency == m_currInfo[i].currency) 
              m_currInfo[i].rest = m_currInfo[i].rest + rest;
            end;
            
            i = i + 1;
          end;
          
          acc = m_ClientData.GetNextAcc();
        end;
        UseProgress(5);
        
        // Здесь и далее определяем in/out по номерам счетов
        if (strlen(accArr) > 0)
          accArr = substr(accArr, 3, strlen(accArr) - 2);
        end;
        
        i = 0; 
        while(i < m_currInfo.size())
          //3 часть отчёта 523703
          m_currInfo[i].inRovu = m_currInfo[i].inRovu + GetClientInAccSum(accArr, m_currInfo[i].currency, true);
          m_currInfo[i].inWithoutRovu = m_currInfo[i].in - m_currInfo[i].inRovu;

          m_currInfo[i].outRovu = m_currInfo[i].outRovu + GetClientInAccSum(accArr, m_currInfo[i].currency, false);
          m_currInfo[i].outWithoutRovu = m_currInfo[i].out - m_currInfo[i].outRovu;

          // 507551, 510019 в операции зачисления сумма комиссии в проводке не учитывается, в отличие от операции списание, где проводка выполняется за вычетом суммы комиссии поэтому в отчете брокера необходимо учитывать комиссию при зачислении
          m_currInfo[i].restOut = m_currInfo[i].restOut + m_currInfo[i].rest + m_currInfo[i].in - m_currInfo[i].out - m_currInfo[i].com /*+ m_currInfo[i].swap*/ - m_currInfo[i].comPay;
          i = i + 1;
        end;

        var IsDataExist = false;
        i = 0; 
        while(i < m_currInfo.size())
          if (m_currInfo[i].restOut or m_currInfo[i].rest or m_currInfo[i].in or m_currInfo[i].out or m_currInfo[i].com or m_currInfo[i].swap or m_currInfo[i].comPay or ((m_RepParams.ShowPlanRest == "X") and m_currInfo[i].restPlan))
            IsDataExist = true;
            break;
          end;
          
          i = i + 1;
        end;
   
        if(IsDataExist)
          m_rep.Blank_Line();
          PartStr = "ДВИЖЕНИЕ ПО ДЕНЕЖНЫМ СРЕДСТВАМ";
          m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
          firstLine = false;
          var cntRow = m_currInfo.size()-1;

          PrintHeaderAndCapMove();
          m_rep.Put_Str("Входящий остаток (без спец. SWAP)", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].rest, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;",""));
            i = i + 1;
          end;

          m_rep.Put_Str("Зачислено со внешних счетов", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].inWithoutRovu, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); // 523703
            i = i + 1;
          end;

          m_rep.Put_Str("Выведено на внешние счета", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].outWithoutRovu, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Уплаченные комиссии за перечисление и вывод денежных средств", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";P=C;END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].com, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Результат по сделкам спец. SWAP", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].swap, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Результат по сделкам с расчетами в течении дня", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].res, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Уплаченные комиссии (за исключением комиссий за перечисление", "START;BRL;BRT;BRR;FB;HA=L;R=" + string(cntRow) + ";END;");
          m_rep.Put_Str("и вывод денежных средств)", "START;BRL;BRR;BRB;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].comPay, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Возврат средств", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(0, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Исходящий остаток", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].restOut, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;

          m_rep.Put_Str("Плановый исходящий остаток с учетом обязательств", "START;BOR;FB;HA=L;R=" + string(cntRow) + ";END;");
          i = 0; 
          while(i < m_currInfo.size())
            m_rep.Put_Val(m_currInfo[i].restPlan + m_currInfo[i].restOut, "BOR;HA=R;VA=C;T=M2;" + IIF(i == 0,"START;","") + IIF(i == cntRow,"END;","")); 
            i = i + 1;
          end;
          IsDataPrinted = true;
        elif ( ( m_RepParams.ShowEmpty == SET_CHAR ) or ShowEmptyRep(DataSet.ID))
          m_rep.Blank_Line();
          PartStr = "ДВИЖЕНИЕ ПО ДЕНЕЖНЫМ СРЕДСТВАМ";
          m_rep.Put_Str(PartStr, "START;FB;HA=L;R=6;END;");
          m_rep.Blank_Line();
          PrintHeaderAndCapMove(); 
          IsEmptyPrinted = true; 
        end;  

        m_rep.Blank_Line();

        // Пользовательская подпись
        if (PrintFooterFlag)
          AddStandardFooter();
          PrintFooterFlag = false;
        end;

        RemProgress();
      end;
    end;

    m_rep.Print_Bottom();

    if ( (IsDataPrinted == false) and (IsEmptyPrinted == false) )
      m_RepParams.NoData = true;
      m_rep.Delete();
      RemProgress();
      msgbox("Нет данных для выпуска отчета");
      return;
    end;
    
    if(m_RepParams.NoReq)
      var clientCode = ПолучитьКодСубъекта(m_RepParams.ClientID, PTCK_CONTR);
      var errGetMailTempl = null;

      var errMailTempl = GetErrMailTempl(BROKERREP_ERRMAILTEMPL_NOREQ, @errGetMailTempl);
      if(ValType(errMailTempl) == V_GENOBJ)
        m_RepParams.ErrMails[m_RepParams.ErrMails.Size] = CBrokerRepErrMail(errMailTempl.Subject, 
                                                                            StrSubst(StrSubst(errMailTempl.Body, 
                                                                                              "<код клиента>", clientCode ),
                                                                                              "<Номера сделок>", NoReqDealStr));
        msgbox("Ошибка! По клиенту \""+clientCode+"\" отсутствуют заявки-поручения по сделкам: " + NoReqDealStr);
      else
        msgbox("Ошибка при получении шаблона письма об ошибке с кодом \"" + BROKERREP_ERRMAILTEMPL_NOREQ + "\"");
        return;
      end;
    end;

    resultFileName = GetFileName(m_ClientData.ContrNumberPstfx,"xlsx", m_RepParams.ServDocID);
    var brokFileManager = BrokerRepFileStatusManager(resultFileName, true);
    m_rep.Save(brokFileManager.Get_GENERATED_REPORTS_path());

    if(m_RepParams.ExcelFormat == true)
      m_RepParams.RepData[m_RepParams.RepData.size] = СBrokCurRepData(resultFileName, SC_SRVREPFORMAT_EXCEL_XLSX, CreateDate, CreateTime, ContrID);
      brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
      if((not err) and (m_RepParams.ShowFile == true))
        brokFileManager.ShowFile();
      end;
    end;

    if(m_RepParams.PdfFormat == true)
      resultFileName = GetFileName(m_ClientData.ContrNumberPstfx,"pdf", m_RepParams.ServDocID);
      m_RepParams.RepData[m_RepParams.RepData.size] = СBrokCurRepData(resultFileName, SC_SRVREPFORMAT_PDF, CreateDate, CreateTime, ContrID);

      brokFileManager = BrokerRepFileStatusManager(resultFileName, true);

      err = POIAddPictureAndConvertToPDF(m_rep, brokFileManager.Get_CURRENT_path_no_file_name(), m_RepParams.SignerParty, brokFileManager.Get_CURRENT_filename_with_no_ext());
      brokFileManager.Move_File(BROKER_REPORT_FILE_STATUS_SAVED);
      if((not err) and (m_RepParams.ShowFile == true))
        brokFileManager.ShowFile();
      end;
    end;
    
    m_rep.Delete();
    RemProgress();
  END;
END;


MACRO SC_CreateRepBrokCurr(params, flagBreak:@integer)/*CHVA 517260*/
    
  SQL_Execute("DELETE FROM DBRKREPDEAL_TMP", "", false );
  SQL_Execute("DELETE FROM DBRKREPINACC_TMP", "", false );
  SQL_Execute("DELETE FROM DBRKREPPOOL_TMP", "", false );

  var report = СBrokCurRep_PrintRep(params);
  report.CreateReport(@flagBreak);/*CHVA 517260*/

  if(params.ErrMails.Size > 0)
    var im = 0;
    while(im < params.ErrMails.Size)
      SC_SendBrkRepErrMail(params.ErrMails[im].Subject,
                           params.ErrMails[im].Body);
      im = im + 1;
    end;    
    params.ErrMails.Size = 0;
  end;

  return true;
END;