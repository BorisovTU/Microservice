/* операция "Междепозитарный перевод эмиссионных ценных бумаг" */
/* шаг      "создать сообщение?"                               */
/* Chernov Anton 24-11-2005                                    */

import InsCarryDoc, OprInter, PaymInter, "dlcarry.inc", opr_depo;

/* Буферы ПД, заполняемые из операции */
record Pm_paym( pmpaym );     /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );     /*св-ва платежа*/
record Pm_rmprop( pmrmprop ); /*платеж по ценным бумагам*/

/* Номера шагов для перехода */
const НомерШагаСозданиеСообщения     = 22;
const НомерШагаЖдатьПодтверждение    = 25;
const НомерШагаКвитовкаВстречных     = 28;
const НомерШагаОтраженияПоСчетам     = 30;

/**********************************/
/* Выполнение шага                */
/**********************************/
macro ExecuteCaseStep( Kind_Operation, Number_Step, first, KindDoc )
  record spdraft( spdraft );

  SetBuff( spdraft, first );
  
  if( spdraft.SendInstruction == "" )
    if( spdraft.UseKvit == SET_CHAR )
      return string( НомерШагаКвитовкаВстречных );
    else
      return string( НомерШагаОтраженияПоСчетам );
    end;
  else
    if( not FindDpMessageByDraft(spdraft.AutoKey) )
      return string( НомерШагаСозданиеСообщения );
    else
      return string( НомерШагаЖдатьПодтверждение );
    end;
  end;
end;
