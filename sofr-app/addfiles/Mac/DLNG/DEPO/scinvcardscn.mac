/*
$Name: scinvcardscn.mac
$Module: Депозитарий
$Description: Массовое выполнение действий над ИК
*/
IMPORT FIInter, DPInter, dlquery;   
 
PRIVATE VAR ic = TRecHandler( "invcard.dbt" );
PRIVATE VAR vficert;

PRIVATE CONST ERROR_EXEC = 0,
              PRINT_HEADER = 1,
              PRINT_FOOTER = 2;

PRIVATE MACRO PrintHead( Head:STRING )
[
                   #
┌─────────────────────────────┬──────┬───────────────────────────────────────────────────────────────────────────────────────────────────┐
│         Параметры ИК        │  №   │                      Сообщение                                                                    │
│                             │ошибки│                                                                                                   │
├─────────────────────────────┼──────┼───────────────────────────────────────────────────────────────────────────────────────────────────┤](Head);
END;


PRIVATE MACRO PrintFooter()
[└─────────────────────────────┴──────┴───────────────────────────────────────────────────────────────────────────────────────────────────┘
];

END;

PRIVATE MACRO PrintLine( ErrStatus:INTEGER, ErrMessage:STRING )
var parmfistr = "Инв. № "+ic.rec.Number + "\n Серия "+vficert.rec.Series + " Номер " + trim(vficert.rec.Number);

[│#############################│######│###################################################################################################│]
( parmfistr:w, ErrStatus, ErrMessage:w );
END;


PRIVATE MACRO DeleteINVCARD( NumExec:INTEGER, ErrStatus:INTEGER, ErrMessage:STRING )

  if( NumExec == PRINT_HEADER )
     PrintHead( "Отчет о массовом удалении инвентарных карточек." );
  elif( NumExec == PRINT_FOOTER )            
     PrintFooter();
  elif( NumExec == ERROR_EXEC )
     if( ErrStatus == 0 ) 
       ErrMessage = "Инвентарная карточка удалена успешно.";
     end;
     PrintLine( ErrStatus, ErrMessage);
  end;
END;

MACRO Печать_ОтчетСканирования( NumExec:INTEGER, FDoc:VARIANT, ErrStatus:INTEGER, ErrMessage:STRING, Action:INTEGER )
  var cmd;

  ic.SetRecordAddr( FDoc );

  cmd = DL_RSDCommand("select * from dv_ficert_dbt where t_FiCertID = ?");
  cmd.AddParam(ic.rec.FiCertID);

  vficert = cmd.Execute();
  vficert.moveNext();
  
  if( Action == 1 ) //Удаление
     DeleteINVCARD( NumExec, ErrStatus, ErrMessage );
  end;

END;
