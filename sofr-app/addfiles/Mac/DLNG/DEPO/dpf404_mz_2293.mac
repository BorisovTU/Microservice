/*
$Name:         dpf404_mz_2293.mac
$Module:       Депозитарий
$Description:  Отчет "Сведения об инвестициях уполномоченного банка и его клиентов-резидентов" (Форма 404)
*/

import RsbDataSet;
import FIInter, DPInter, secinter, deposerv, "DLReport_h.mac", "dlreport.mac", spserv, "param.mac", "scsrvrepfun.mac", "spRepFun.mac" ;
import "spRepFun.mac";

PRIVATE FILE Kliko_F404() txt write;
PRIVATE FILE TextProtocol() txt write;
private const CHAPT5 = 5; /*  Глава л/с ДЕПО */
private const DEPOATTR_ATTNUM_PLACE = 3;  //характеристика счета депо - "Депозитарий места хранения"
private const DEPOATTR_ATTNUM_BLOCK = 6;  //характеристика счета депо - "Блокировка"
private const DEPOATTR_ATTNUM_TRUST = 16; //характеристика счета депо - "Документ ДУ"

PRIVATE CONST
   RCB_XML_PK_MONTHLY   = 4,
   RCB_XML_PK_QUARTERLY = 5;

PRIVATE CONST
   XML_ATTR_OPTIONAL = 1,
   XML_ATTR_REQ      = 2,
   XML_ATTR_EMPTY    = 3;

private const OUTASTEXT = "OT";

private var ReportHeader =
"                                                                                                                                                                                                                                          Банковская отчетность\n" +
"\n" +
"                                                                                                                                                                                                     ┌──────────────────┬─────────────────────────────────────┐\n" +
"                                                                                                                                                                                                     │        Код       │ Код кредитной организации (филиала) │\n" +
"                                                                                                                                                                                                     │    территории    ├───────────┬─────────────────────────┤\n" +
"                                                                                                                                                                                                     │     по ОКАТО     │  по ОКПО  │     регистрационный     │\n" +
"                                                                                                                                                                                                     │                  │           │          номер          │\n" +
"                                                                                                                                                                                                     │                  │           │      (порядковый        │\n" +
"                                                                                                                                                                                                     │                  │           │          номер)         │\n" +
"                                                                                                                                                                                                     ├──────────────────┼───────────┼─────────────────────────┤\n" +
"                                                                                                                                                                                                     │ ################ │###########│#########################│\n" +
"                                                                                                                                                                                                     └──────────────────┴───────────┴─────────────────────────┘\n" +
"\n" +
"                                                               СВЕДЕНИЯ ОБ ИНВЕСТИЦИЯХ УПОЛНОМОЧЕННОГО БАНКА И ЕГО КЛИЕНТОВ - РЕЗИДЕНТОВ\n" +
"                                                                (КРОМЕ КРЕДИТНЫХ ОРГАНИЗАЦИЙ) В ЦЕННЫЕ БУМАГИ, ВЫПУЩЕННЫЕ НЕРЕЗИДЕНТАМИ,\n" +
"                                                                                И В УСТАВНОЙ КАПИТАЛ (ДОЛИ) НЕРЕЗИДЕНТОВ\n" +
"                                                                                 ##################################\n" +
"\n" +
"\n" +
"Полное или сокращенное фирменное наименование уполномоченного банка ############################################################\n" +
"Адрес (место нахождения) уполномоченного банка #####################################################################################################################################\n" +
"\n" +
"                                                                                                                                                                                                                                      Код формы по ОКУД 0409404\n" +
"                                                                                                                                                                                                                                                    Месячная  ";

private var TableHeader =
"┌────────┬───────────────────┬──────────┬───────────┬──────────────┬──────────┬──────────┬────────────────┬─────────┬──────────┬────────────┬────────┬───────────────────────────┬──────────────────────────────────────┬─────────────────┬──────────┬─────────┐\n" +
"│ Номер  │ Идентификационный │ Код типа │ Код срока │ Наименование │ Код      │ Код      │ Наличие        │ Код     │ Код      │ Количество │ Код    │ Цена одной ценной бумаги, │ Общая стоимость пакета ценных бумаг, │ Код             │ Код      │ Особые  │\n" +
"│ строки │ код               │ ценной   │ погашения │ эмитента     │ страны   │ сектора  │ отношений      │ клиента │ региона  │ ценных     │ валюты │ в единицах валюты         │ в единицах валюты                    │ использованного │ места    │ пометки │\n" +
"│        │ ценной            │ бумаги   │           │              │ эмитента │ экономики│ прямого        │         │ клиента- │ бумаг,     │ ценной ├─────────────┬─────────────┼───────────────────┬──────────────────┤ метода          │ хранения │         │\n" +
"│        │ бумаги            │          │           │              │          │ эмитента │ инвестирования │         │ физичес- │ штук       │ бумаги │ Номинальная │ Рыночная    │ Номинальная       │ Рыночная         │ оценки          │ ценных   │         │\n" +
"│        │                   │          │           │              │          │          │                │         │ кого     │            │        │             │             │ (гр.13 * гр.11)   │ (гр.14 * гр.11)  │ рыночной        │ бумаг    │         │\n" +
"│        │                   │          │           │              │          │          │                │         │ лица     │            │        │             │             │                   │                  │ стоимости       │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │ ценных          │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │ бумаг           │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"│        │                   │          │           │              │          │          │                │         │          │            │        │             │             │                   │                  │                 │          │         │\n" +
"├────────┼───────────────────┼──────────┼───────────┼──────────────┼──────────┼──────────┼────────────────┼─────────┼──────────┼────────────┼────────┼─────────────┼─────────────┼───────────────────┼──────────────────┼─────────────────┼──────────┼─────────┤\n" +
"│    1   │         2         │     3    │     4     │       5      │     6    │     7    │      8         │   9     │    10    │      11    │   12   │      13     │      14     │        15         │         16       │        17       │    18    │    19   │\n" +
"├────────┼───────────────────┼──────────┼───────────┼──────────────┼──────────┼──────────┼────────────────┼─────────┼──────────┼────────────┼────────┼─────────────┼─────────────┼───────────────────┼──────────────────┼─────────────────┼──────────┼─────────┤";

private var ProtocolText =
"Номер формы 04090404                                                                                Дата расчета: ##########\n"+
"Название:   Форма 404 \"Сведения об инвестициях уполномоченного банка и его клиентов-резидентов (кроме кредитных организаций)\n"+
"            в ценные бумаги, выпущенные нерезидентами, и в уставной капитал (доли) нерезидентов\"\n";

private var ProtocolHeader =
"┌────────────────────┬───────────────┬──────────────────┬────────────────┬─────────────────────────────────────────────────┐\n"+
"│                    │               │                  │                │                                                 │\n"+
"│    № счета депо    │ Ценная бумага │ № лицевого счета │ Количество, шт │                     Ошибка                      │\n"+
"├────────────────────┼───────────────┼──────────────────┼────────────────┼─────────────────────────────────────────────────┤";

private var ReportFooter =
"\n"+
"\n"+
"Отчет направляется в составе: ##### строк раздела 1 и ##### строк раздела 2.\n"+
"                                                                             1\n"+
"####################################   ################################ (ФИО)\n"+
"                                                                             1\n"+
"Исполнитель                            ################################ (ФИО)\n"+
"                   2\n"+
"Телефон исполнителя : ################ \n"+
"Адрес электронной почты: ##############################\n"+
"\n"+
" \'____\' ____________________________ г.\n"+
"\n"+
"_________________________________________\n"+
"1 Расшифровка фамилии и инициалов\n"+
"2 Телефонный номер с кодом города, добавочный номер (при наличии)";

CLASS F404DeltaXML(OKUD:String, ReportKind:String, EndDate:Date, Periodicity:Integer)
   private var m_XmlReport;
   private var m_EndDate = EndDate;
   private var jvm;
   private var m_Protocol;
   private var m_FileName = "";
   private var m_ExecutorName = "";
   private var m_OKUD = OKUD;
   private var m_kindOrganisation = ReportKind;
   private var m_Part1Data    = TArray();
   private var m_Part2Data    = TArray();
   private var m_Part2AddData = TArray();
   
   var RowNum = 0;
   var LicenseNum = 0;
   var SRONum = 0;
   PRIVATE MACRO Delta_Fld( Val:VARIANT ):STRING
      VAR ValStr = "";

      if( Val != NULL ) 
        VAR vt = ValType(Val);
        if( vt == V_DATE )
           if( Val == DATE(0,0,0) )
              ValStr = "0";
           else
              ValStr = string(Val:f);
           end;
        elif( vt == V_STRING )
           ValStr = StrSubst( Val, "\"", "''" );
           if (ValStr == "")
               ValStr = "0";
           end;      
        elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
          if( Val != 0.00)
            ValStr = trim(string(Val:18:6));
          else
            ValStr = "0.000000";    
          end;
        else
           ValStr = string(Val);
        end;
      else
        ValStr="0";
      end;

      return ValStr;
   END;
   
   macro atrAdd(Name: string, Val:VARIANT)
     var atr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", Name, Delta_Fld(Val));
     return atr;
   end;

   macro atrAddToNode(XMLNode, Name: string, Val:VARIANT, AttrType:INTEGER, ParentElemName: string)
       VAR vt = ValType(Val), err = "";
       if (vt == V_STRING)
         Val = StrSubst( Val, "-", "" );
       end;
       if((Val == NULL) OR ((vt == V_DATE) and (Val == DATE(0,0,0))) OR ((vt == V_STRING) and (Val == "")) OR (((vt == V_DOUBLE) OR (vt == V_MONEY)) AND (Val == 0.00)))
         if (AttrType == XML_ATTR_OPTIONAL)
            return;
         else
            if (AttrType == XML_ATTR_REQ)
               err = "Не заполнен обязательный атрибут '" + Name + "'";
               if (ParentElemName != NULL)
                  err = err + " элемента '" + ParentElemName + "'";
               end;
               m_Protocol.Error(err);
            end;
         end;
       end;

      XMLNode.addAttribute(Name, Val);
   end;
   
   macro PrintInfo()
      var registrationNumber = repGetPartyCode({OurBank}, PTCK_BANKREGNUM, m_EndDate);
      var BIC = repGetPartyCode({OurBank}, PTCK_BIC, m_EndDate);
      var party = TRecHandler("party.dbt");
      var OKATO;
      var OKPO;
      var Name;
      var PostalAdress;
      var OGRN = repGetPartyCode({OurBank}, PTCK_OGRN, m_EndDate);
      var adress = TRecHandler("adress.dbt");
      var leaderPost:String, leaderName:String;
      var executorPost;
      var executorName;
      var executorPhone;
      var executorEmail;
      var executorFax;

      ПолучитьСубъекта({OurBank}, party);
      OKPO = IIF(party.rec.OKPO != NULL, party.rec.OKPO, "");
      Name = party.rec.Name;

      GetMainObjAttr(NULL,
                     OBJTYPE_PARTY,
                     UniID(party, OBJTYPE_PARTY),
                     RCB_OBJGROUP_PT_OKATO, // 12
                     NULL,
                     NULL,
                     OKATO,
                     m_EndDate
                    );

      if(OKATO == NULL)
         var OkatoQuery = "select adress.t_OKATO " +
                          "from dadress_dbt adress " +
                          "where adress.t_Type = 1 " +
                          "  and adress.t_PartyID = " + string({OurBank});

         var OkatoSelect = DL_RSDCommand(OkatoQuery);
         var OkatoDS = OkatoSelect.Execute();
         if(OkatoDS.MoveNext())
            OKATO = OkatoDS.OKATO;
         end;
      end;

      OKATO = IIF(OKATO != NULL, OKATO, "");

      if(найтиЮридическийАдресСубъекта({OurBank}, adress) or
         найтиПочтовыйАдресСубъекта({OurBank}, adress) or
         найтиАдресСубъекта({OurBank}, PTADDR_REAL, adress)
        )
         PostalAdress = adress.rec.Adress;
      end;

      var leaderQuery = "select off.t_Post, " +
                        "       party.t_Name " +
                        "from dofficer_dbt off, dparty_dbt party " +
                        "where off.t_IsFirstPerson = 'X' " +
                        "  and off.t_PartyID = " + string({OurBank}) +
                        "  and party.t_PartyID = off.t_PersonID ";

      var leaderSelect = DL_RSDCommand(leaderQuery);
      var leaderDS = leaderSelect.Execute();

      if(leaderDS.MoveNext())
         leaderPost = leaderDS.Post;
         leaderName = leaderDS.Name;
      else
         leaderPost = leaderName = "";
      end;
      
      var executorQuery = 
              "select off.t_Post,                                                              " +
              "       party.t_Name,                                                            " +
              "       off.t_PhoneNumber as t_Phone,                                            " +
              "       nvl(                                                                     " +
              "        (                                                                       " +
              "              select q_Fax.t_Value                                              " +
              "              from (                                                            " +
              "                      select Fax.t_Value                                        " +
              "                      from dcontact_dbt Fax                                     " +
              "                      where Fax.t_PartyID = person.t_PartyID                    " +
              "                        and Fax.t_ContactKind = 3                               " +
              "                      order by Fax.t_IsMain DESC                                " +
              "                   ) q_Fax                                                      " +
              "              where ROWNUM = 1                                                  " +
              "              ), chr(1)                                                         " +
              "           ) as t_Fax,                                                          " +
              "        nvl(                                                                    " +
              "        (                                                                       " +
              "          select q_Email.t_Value                                                " +
              "          from (                                                                " +
              "                select Email.t_Value                                            " +
              "                from dcontact_dbt Email                                         " +
              "                where Email.t_PartyID = person.t_PartyID                        " +
              "                      and Email.t_ContactKind = 5                               " +
              "                      and Email.t_ContactType = 8                               " +
              "                      order by Email.t_IsMain DESC                              " +
              "                ) q_Email                                                       " +
              "          where ROWNUM = 1                                                      " +
              "          ), chr(1)                                                             " +
              "        )                                                                       " +
              "        as t_Email                                                              " +
              "from dofficer_dbt off,                                                          " +
              "     dpersOn_dbt  persOn,                                                       " +
              "     dpersn_dbt   persn,                                                        " +
              "     dparty_dbt   party                                                         " +
              "where persOn.t_Oper = "     + string({oper})                                      +
              "      and off.t_PartyID = " + string({OurBank})                                   +
              "      and off.t_PersonID = persOn.t_PartyID                                     " +
              "      and persn.t_PersonID = persOn.t_PartyID                                   " +
              "      and party.t_PartyID = off.t_PersonID ";
                         
                        
      var executorSelect = DL_RSDCommand(executorQuery);
      var executorDS = executorSelect.Execute();

      if(executorDS.MoveNext())
         executorPost  = executorDS.Post;
         executorName  = m_ExecutorName = executorDS.Name;//{Name_Oper}
         executorPhone = executorDS.Phone;
         executorEmail = executorDS.Email;
         executorFax   = executorDS.Fax;
      else
         executorPost = executorName = executorPhone = executorEmail = executorFax = "";
      end;    
      
      var signers = jvm.createJavaObject("java.util.ArrayList", "<init>");
      
      var leaderNodeName = "Руководитель";
      var leaderNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", leaderNodeName);
      atrAddToNode(leaderNode, "Должность", leaderPost, XML_ATTR_REQ, leaderNodeName);
      atrAddToNode(leaderNode, "ФИО",       leaderName, XML_ATTR_REQ, leaderNodeName);
      signers.add(leaderNode);

      var executorNodeName = "Исполнитель";
      var executorNode = jvm.createJavaObject("XMLReportExporter.XMLNode", "<init>", executorNodeName);
      atrAddToNode(executorNode, "Должность", executorPost,  XML_ATTR_REQ, executorNodeName);
      atrAddToNode(executorNode, "ФИО",       executorName,  XML_ATTR_REQ, executorNodeName);
      atrAddToNode(executorNode, "Телефон",   executorPhone, XML_ATTR_REQ, executorNodeName);
      atrAddToNode(executorNode, "Факс",      executorFax,   XML_ATTR_OPTIONAL);
      atrAddToNode(executorNode, "ЭлПочта",   executorFax,   XML_ATTR_OPTIONAL);
      signers.add(executorNode);
      
       m_xmlReport.addInfoPart(registrationNumber,
                              BIC,
                              OKATO,
                              OKPO,
                              OGRN,
                              Name,
                              PostalAdress,
                              signers
                             );


      m_Protocol = m_XmlReport.getProtocol();
   end;

   macro BeginData404()
      var IdAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Ид", "1");
      var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var NullAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

      Attributes.add(IdAttribute);
      m_XmlReport.beginPart("Данные404", Attributes);

      RowNum = 1;
   end;
   
   macro BeginFormPart(str, Num)
     var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
     Attributes.add(atrAdd ("КолСтрокРаздДанные", Num));
     m_XmlReport.beginPart( str, Attributes);
   end;
   
   macro FinishData()
      m_XmlReport.finishPart();
   end;

   macro SaveLineP( Part, A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18)
     var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
     
     Attributes.add(atrAdd ("Разд"+Part+"НомСтр",Part+"."+(IIF(Part == 1, m_Part1Data.size(), m_Part2Data.size()) + 1)));     
     Attributes.add(atrAdd ("ISIN",              A2));
     Attributes.add(atrAdd ("КодТипЦБум",        A3));
     Attributes.add(atrAdd ("КодСрокаПог",       A4));
     Attributes.add(atrAdd ("НаимЭмит",          A5));
     Attributes.add(atrAdd ("КодСтраны",         A6));
     Attributes.add(atrAdd ("КодСектЭк",         A7));
     Attributes.add(atrAdd ("НалОтнПрИнв",       A8));
     Attributes.add(atrAdd ("КолЦБум",           A9));
     Attributes.add(atrAdd ("КодВалюты",         A10));
     Attributes.add(atrAdd ("ЦенаЦБумНомин",     A11));
     Attributes.add(atrAdd ("ЦенаЦБумРын",       A12));
     Attributes.add(atrAdd ("ОбщСтЦБумНомин",    A13));
     Attributes.add(atrAdd ("ОбщСтЦБумРын",      A14));
     if (Part == 1)
        Attributes.add(atrAdd ("КодМетОцСтоимЦБум", A15));
     end;
     Attributes.add(atrAdd ("ПризнМестаХр",      A16));
     Attributes.add(atrAdd ("КодМестХранЦБум",   A17));
     if(Part == 1)
       Attributes.add(atrAdd ("ОсобПом",         A18));
       m_Part1Data[m_Part1Data.size()]    = Attributes;
     else
       m_Part2Data[m_Part2Data.size()]    = Attributes;
       m_Part2AddData[m_Part2Data.size()] = A18;
     end;
     RowNum = RowNum + 1;
   end;


   macro AddDataPart1()
     BeginFormPart("Раздел1", m_Part1Data.size);
     var i = 0;
     while (i < m_Part1Data.size)
      m_XmlReport.addLine("Раздел1Данные", m_Part1Data[i], "");
      i = i + 1;
     end;
   end;

   macro AddDataPart2()
     FinishData();
     BeginFormPart("Раздел2", m_Part2Data.size);
     var i = 0;
     while (i < m_Part2Data.size)
      m_XmlReport.beginPart("Раздел2Данные", m_Part2Data[i]);
      var Rec = jvm.createJavaObject("java.util.ArrayList", "<init>");
      Rec.add(atrAdd ("ОсобПом", m_Part2AddData[i]));
      m_XmlReport.addLine("Активы", Rec, "");    
      m_XmlReport.finishPart();
      i = i + 1;
     end;
   end;

   macro PrintProtocol()
      m_Protocol = m_XmlReport.getProtocol();

      var Errors = m_Protocol.getErrorsText();
      var attributesErrors = jvm.createJavaObject("java.util.ArrayList", "<init>");
      var attrStatusErrors = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "2");
      attributesErrors.add(attrStatusErrors);

      if(Errors != "")
         var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
         m_XmlReport.beginPart("ПротоколКонтроля", Attributes);
         var errs = SplitString(Errors, "\n"), i = 0;
         while(i < errs.Size)
            m_XmlReport.addLine("Сообщение", attributesErrors, errs[i]);
            i = i + 1;
         end;
         m_XmlReport.finishPart();
      end;
   end;

   MACRO GetXMLVer()
      if ((m_EndDate + 1) >= date(1,2,2025))
         return "5.0.4.5";
      end;
      
      return "4.0.4.5";
   END;

   macro GetFileName()
      return m_FileName;
   end;

   macro CreateXMLFile()
      return m_XmlReport.export(m_FileName);
   end;

   macro CreateTextProtocol()
      var errcode, errtext, Errors = "", ProtocolFileName = GetTxtFileName("expx_404"), Year:integer = 0, BegDate, NumQuartal = 0, Month = 1;
      
      DateSplit(m_EndDate, null, null, Year);

      if( not Open( TextProtocol, ProtocolFileName, "rsoem" ) )
         errcode = status(errtext);
         RunError( "Ошибка при открытии файла протокола экспорта в ПК Дельта|"+ProtocolFileName+"|(" + errcode + ") " + errtext );
         return false;
      end;

      NumQuartal = Date_GetQuarter(m_EndDate);
      Month      = (NumQuartal - 1) * 3 + 1;
      BegDate    = Date(1, Month, Year);

      insert(TextProtocol, "Форма " + m_OKUD + ". Протокол экспорта в ПК ДЕЛЬТА");
      insert(TextProtocol, "");
      insert(TextProtocol, "Период отчета с " + BegDate + " по " + m_EndDate);
      //insert(TextProtocol, "Отчетный период: " + PeriodName_GetMonthsAndQuart(12 + Date_GetQuarter(m_EndDate), year));
      insert(TextProtocol, "Дата и время выполнения процедуры " + date() + " " + strSubst(String(Time()), " ", "0"));
      insert(TextProtocol, "Исполнитель " + {oper} + " " + m_ExecutorName);
      insert(TextProtocol, "");
      insert(TextProtocol, "Режим Банк");
      insert(TextProtocol, "Версия XML-формата: urn:cbr-ru:rep" + m_OKUD + ":" + GetXMLVer());
      insert(TextProtocol, "Файл экспорта: " + m_FileName);

      Errors = m_XmlReport.getProtocol().getErrorsText();
      if (Errors == "")
         insert(TextProtocol, "Экспорт в xml-формате для формы " + m_OKUD + " выполнен успешно");
      else
         insert(TextProtocol, "При выполнении экспорта возникли ошибки:");
         insert(TextProtocol, Errors);
      end;

      close( TextProtocol );

      ViewFile( TextProtocol );

      return true;
   end;

   var DepCode;
   var DepCodeQuery = "select dp_dep.t_Name " +
                      "from ddp_dep_dbt dp_dep " +
                      "where dp_dep.t_Code = " + string({OperDprt});

   var DepCodeSelect = DL_RSDCommand(DepCodeQuery);
   var DepCodeDS = DepCodeSelect.Execute();
   if(DepCodeDS.MoveNext())
      DepCode = DepCodeDS.Name;
   else
      DepCode = "";
   end;

   private var dd;
   private var mm;
   DateSplit(m_EndDate, dd, mm, NULL);

   var len = strlen(DepCode);
   if(len < 4)
      var i = len;
      while(i < 4)
         DepCode = "0" + DepCode;
         i = i + 1;
      end;
   elif(len > 4)
      DepCode = SubStr(DepCode, 1, 4);
   end;

   m_FileName = "..\\TxtFile\\" + m_OKUD + "_" + string(dd:o:2) + string(mm:o:2) + DepCode + ".xml";

   jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   m_XmlReport = jvm.createJavaObject("XMLReportExporter.XMLReport", "<init>", GetXMLVer(), m_OKUD, m_OKUD, ReportKind, String(m_EndDate : f), Periodicity);
   m_Protocol = m_XmlReport.getProtocol();
END;
 
MACRO GetOkud():String
   return "0409404";
END;

MACRO GetReportKind():String
   return "КО";
END;

MACRO GetPeriodicity():Integer
   return RCB_XML_PK_QUARTERLY;
END;

private class (TArray) CRestInfo(_Rest, _Place)
  var Rest = _Rest, Place = _Place;
end;

private class (TArray) CRestByPlace

   /* Очистить массив */
   macro ClearArray
      this.Size = 0;
   end;

   macro Add( _Rest, _Place )
      var Counter = this.Size, i = 0, found = false;

      if( Counter > 0 )
         while( i < Counter )
            if( this[i].Place == _Place )
               this[i].Rest = this[i].Rest + _Rest;

               found = true;

               break;
            end;
            i = i + 1;
         end;
      end;

      if(NOT found)
         this[Counter] = CRestInfo(_Rest, _Place);
      end;
   end;

   macro SetRestByPlace( _Rest, _Place )
      var
         Counter     = this.Size, i = 0;

      if( Counter > 0 )
         while( i < Counter )
            if( this[i].Place == _Place )
               this[i].Rest = _Rest;
               break;
            end;
            i = i + 1;
         end;
      end;
   end;

   macro GetRestByPlace( _Place )
      var
         Counter     = this.Size, i = 0, Rest = $0;

      if( Counter > 0 )
         while( i < Counter )
            if( this[i].Place == _Place )
               Rest = this[i].Rest;
               break;
            end;
            i = i + 1;
         end;
      end;

      return Rest;
   end;

end;

private class CLineInfo(_Код_Ценной_Бумаги,
                        _Код_Типа_Ценной_Бумаги,
                        _LatName,
                        _Наличие_Коротношений,
                        _Код_Клиента,
                        _Код_Страны_Эмитента,
                        _ОстатокЦБ,
                        _SumPrecision,
                        _FaceValueFI,
                        _Номинальная_Цена,
                        _Рыночная_Цена,
                        _Номинальная_Стоимость_Пакета,
                        _Рыночная_Стоимость_Пакета,
                        _Код_Метода_Оценки,
                        _Код_Места_Хранения,
                        _Особые_Пометки,
                        _Код_Срока_Погашения,
                        _Код_Региона_Клиента,
                        _Код_Сектора_Экономики_Эмитента,
                        _StorageType
                       )
var Код_Ценной_Бумаги              = _Код_Ценной_Бумаги,
    Код_Типа_Ценной_Бумаги         = _Код_Типа_Ценной_Бумаги,
    LatName                        = _LatName,
    Наличие_Коротношений           = _Наличие_Коротношений,
    Код_Клиента                    = _Код_Клиента,
    Код_Страны_Эмитента            = _Код_Страны_Эмитента,
    ОстатокЦБ                      = _ОстатокЦБ,
    SumPrecision                   = _SumPrecision,
    FaceValueFI                    = _FaceValueFI,
    Номинальная_Цена               = _Номинальная_Цена,
    Рыночная_Цена                  = _Рыночная_Цена,
    Номинальная_Стоимость_Пакета   = _Номинальная_Стоимость_Пакета,
    Рыночная_Стоимость_Пакета      = _Рыночная_Стоимость_Пакета,
    Код_Метода_Оценки              = _Код_Метода_Оценки,
    Код_Места_Хранения             = _Код_Места_Хранения,
    Особые_Пометки                 = _Особые_Пометки,
    Код_Срока_Погашения            = _Код_Срока_Погашения,
    Код_Региона_Клиента            = _Код_Региона_Клиента,
    Код_Сектора_Экономики_Эмитента = _Код_Сектора_Экономики_Эмитента,
    StorageType                    = _StorageType;
end;

private class (TArray) CLineData()

   /* Очистить массив */
   macro ClearArray
      this.Size = 0;
   end;

   /*добавить, учитывая код места хранения А16 и особые пометки А17*/
   macro AddByPlace( _Код_Ценной_Бумаги,
                     _Код_Типа_Ценной_Бумаги,
                     _LatName,
                     _Наличие_Коротношений,
                     _Код_Клиента,
                     _Код_Страны_Эмитента,
                     _ОстатокЦБ,
                     _SumPrecision,
                     _FaceValueFI,
                     _Номинальная_Цена,
                     _Рыночная_Цена,
                     _Номинальная_Стоимость_Пакета,
                     _Рыночная_Стоимость_Пакета,
                     _Код_Метода_Оценки,
                     _Код_Места_Хранения,
                     _Особые_Пометки,
                     _Код_Срока_Погашения,
                     _Код_Региона_Клиента,
                     _Код_Сектора_Экономики_Эмитента,
                     _StorageType
                   )
      var Counter = this.Size, i = 0, found = false;

      if( Counter > 0 )
         while( i < Counter )
            if( (this[i].Код_Места_Хранения == _Код_Места_Хранения) and
                (this[i].Код_Клиента == _Код_Клиента) and
                (this[i].Код_Региона_Клиента == _Код_Региона_Клиента) and
                (this[i].Особые_Пометки == _Особые_Пометки) and
                (this[i].Код_Метода_Оценки == _Код_Метода_Оценки)
              )
               this[i].ОстатокЦБ                    = this[i].ОстатокЦБ + _ОстатокЦБ;
               this[i].Номинальная_Стоимость_Пакета = this[i].Номинальная_Стоимость_Пакета + _Номинальная_Стоимость_Пакета;

               if (this[i].Код_Метода_Оценки != "ПБ")
                  this[i].Рыночная_Стоимость_Пакета    = _Рыночная_Стоимость_Пакета;
               else
                  this[i].Рыночная_Стоимость_Пакета = this[i].Рыночная_Стоимость_Пакета + (this[i].Рыночная_Цена*round(double(this[i].ОстатокЦБ), 6));
               end;
			   
               if (this[i].Код_Метода_Оценки != "ПБ")
                  if ((this[i].ОстатокЦБ > 0))
                     this[i].Рыночная_Цена = double(round(this[i].Рыночная_Стоимость_Пакета/round(double(this[i].ОстатокЦБ), 6), 6));
                     debugbreak;
                     this[i].Рыночная_Стоимость_Пакета = this[i].Рыночная_Цена * round(double(this[i].ОстатокЦБ), 6);
                  else
                     this[i].Рыночная_Цена = 0.0;
                  end
               end;

               found = true;

               break;
            end;
            i = i + 1;
         end;
      end;

      if( NOT found )
         this[Counter] = CLineInfo(_Код_Ценной_Бумаги,
                                   _Код_Типа_Ценной_Бумаги,
                                   _LatName,
                                   _Наличие_Коротношений,
                                   _Код_Клиента,
                                   _Код_Страны_Эмитента,
                                   _ОстатокЦБ,
                                   _SumPrecision,
                                   _FaceValueFI,
                                   _Номинальная_Цена,
                                   _Рыночная_Цена,
                                   _Номинальная_Стоимость_Пакета,
                                   _Рыночная_Стоимость_Пакета,
                                   _Код_Метода_Оценки,
                                   _Код_Места_Хранения,
                                   _Особые_Пометки,
                                   _Код_Срока_Погашения,
                                   _Код_Региона_Клиента,
                                   _Код_Сектора_Экономики_Эмитента,
                                   _StorageType
                                  );
      end;
   end;

end;

private class (DL_CReportTemplate) DP_RepForm404(_end_date, _rep_date, _iDepart, _formPart1, _formPart2, _ToExcel, _is_ap, _delta)
  private var m_end_date = _end_date, m_rep_date = _rep_date, m_iDepart = _iDepart, m_formPart1 = _formPart1, m_formPart2 = _formPart2, m_ToExcel = _ToExcel, m_is_ap = _is_ap;
  private var m_ourbank  = TRecHandler("party.dbt"),
              m_Avoiriss = TRecHandler("avoiriss.dbt"),
              m_Fininstr = TRecHandler("fininstr.dbt"),
              m_Issuer   = TRecHandler("party.dbt");
  private var m_repdate = date(0,0,0);
  private var m_Part1Counter = 0;
  private var m_Part2Counter = 0;
  private var m_form_str = "";
  private var ОстатокПРепоВНеттинге = CRestByPlace();
  private var ОстатокПРепоБезДепо = CRestByPlace();
  private var ОстатокОРепоБезДепо = CRestByPlace();
  private var m_InKliko = true;
  private var m_InDelta = _delta;
  private var DeltaReport;
  private var StorageType;
  private var m_KlikoPart = 0;
  private var m_ByKDU = false;

  if( ПолучитьСубъекта( {OurBank}, m_ourbank ) ) return 1; end;

  if( _is_ap )
    m_form_str = "a";
  end;

  private macro IIF(condition,value_true,value_false)
    if (condition)
        return value_true;
    else
        return value_false;
    end;
  end;

  private macro PrintMode():INTEGER
    if( m_ToExcel ) return 1; end;
    return 0;
  end;

  private macro GetObjAttrName( ObjId:variant, ObjectType:integer, ObjectAttr:integer, Pos:integer ):string
    var Number = "-";

    if( ValType(Pos) == V_UNDEF )
       Pos = 3;
    end;

    if( Pos == 1 )
       DL_GetObjAttrName(ObjectType, ObjectAttr, DL_GetMainObjAttr(ObjId, ObjectAttr, ObjectType), @Number, null, null);
    elif( Pos == 2 )
       DL_GetObjAttrName(ObjectType, ObjectAttr, DL_GetMainObjAttr(ObjId, ObjectAttr, ObjectType), null, @Number, null);
    else
       DL_GetObjAttrName(ObjectType, ObjectAttr, DL_GetMainObjAttr(ObjId, ObjectAttr, ObjectType), null, null, @Number);
    end;

    return Number;
  end;

  private macro BeginReport()
     var Adress = TRecHandler("adress.dbt");
     m_repdate  = m_rep_date;
     Dl_CallInsertStat(PrintMode());
     НайтиАдресСубъекта(m_ourbank.rec.PartyID, PTADDR_REAL, Adress);
     SetActiveSheet( "f404" );
     PrintFormatString( ReportHeader,
                        "B_1" , DL_GetOkatoCode(m_ourbank, m_repdate),
                        "B_2" , m_ourbank.rec.OKPO,
                        "B_4" , ПолучитьКодСубъекта(m_ourbank.rec.PartyID, PTCK_BANKREGNUM),
                        "B_6" , "по состоянию на "+string(m_repdate:f)+" г.",
                        "B_7" , IIF(m_ourbank.rec.ShortName != "", m_ourbank.rec.ShortName, m_ourbank.rec.Name),
                        "B_8" , IIF(Adress, Adress.rec.adress, "")
                      );
     RegisterTable( "RTable1", TableHeader,
                    "A_1", "A_2", "A_4", "A_18", "A_5", "A_8", "A_19", "A_6", "A_7", "A_20",
                    "A_9", "A_10", "A_11", "A_12", "A_13", "A_14", "A_15", "A_16", "A_17"
                  );
  end;

  private macro EndReport()
     EndTable();

     if(m_ToExcel)
       ReplaceAndCalculate( OUTASTEXT, " " );/*добавляем пробел - тогда сможем вывести номера строк в строковые ячейки как текст с точкой-разделителем.*/
     end;

  end;

  private macro CheckPartyType( PartyId, PartyType )
    var partyown = TBFile("partyown");
    var isPartyType = false;

    partyown.KeyNum = 0;
    partyown.rec.PartyID   = PartyId;
    partyown.rec.PartyKind = PartyType;
    if (GetEQ(partyown))
      isPartyType = true;
    end;

    return isPartyType;
  end;

  private macro GetClientCode( client )
    var ClientCode = "";
    if(client.LegalForm() == PTLEGF_INST) //юридическое лицо
        if( CheckPartyType( client.PartyID, 19 ) )
          ClientCode = substr(readNoteForObject(OBJTYPE_PARTY, makeObjectID(OBJTYPE_PARTY, NULL, client.party), 87), 1, 4);
        else
          ClientCode = ПолучитьКодСубъекта(client.PartyID, PTCK_INN);
       end;
    elif(client.LegalForm() == PTLEGF_PERSN) //физ. лицо
        ClientCode = "ФЛ";     
    end;

    return ClientCode;
  end;

  private macro LTrimNulls(in_str:string)
    var out_str = in_str;

    while((substr(out_str, 1, 1) == "0") and (strlen(out_str) > 2))
      out_str = substr(out_str, 2);
    end;

    if(out_str == "00")
      out_str = "";
    end;

    return out_str;
  end;

  private macro GetClientRegCode(client)
    var ClientRegCode = "";
    var Cmd = null, Set = null;

    if(client.LegalForm() == PTLEGF_INST) //юридическое лицо
      ClientRegCode = ""; 
    elif(client.LegalForm() == PTLEGF_PERSN) //Физ. лица
      Cmd = DL_RSDCommand(" SELECT t_OKATO, t_RegionNum FROM dadress_dbt WHERE t_Type = 2 AND t_PartyID = ? ");
      Cmd.AddParam(client.PartyID());
      Set = Cmd.Execute();
      if(Set.MoveNext())
        if((Set.RegionNum == 83)  // Ненецкий автономный округ
        or (Set.RegionNum == 86)  // Ханты-Мансийский автономный округ
        or (Set.RegionNum == 89)) // Ямало-Ненецкий автономный округ
          Cmd = DL_RSDCommand(" SELECT t_OKATO FROM dptregion_dbt WHERE t_CodeRegion = ? ");
          Cmd.AddParam(Set.RegionNum);
          Set = Cmd.Execute();
          if(Set.MoveNext())
            ClientRegCode = Set.OKATO;
          end;
        else
          ClientRegCode = substr(Set.OKATO, 1, 2);
        end;
      end;

      if(ClientRegCode == "")
        ClientRegCode = substr(LTrimNulls(DL_GetOkatoCode(m_ourbank, m_repdate)), 1, 2);
      end;
    end;

    return ClientRegCode;
  end;

  private macro GetStorageCode( AcntAutoKey, AcntOwner, AcntSettingType )
     var depoatvl = TBFile("depoatvl.dbt");
     var StorageCode = "";
     var owner;

     owner = CDPParty(AcntOwner, m_end_date);

     depoatvl.rec.AttrNum = DEPOATTR_ATTNUM_BLOCK;
     depoatvl.rec.IsType  = UNSET_CHAR;
     depoatvl.rec.ID      = AcntAutoKey;
     //анализируем характеристики счета депо
     if( (depoatvl.GetEQ() and (((depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_STANDART)) and (AcntSettingType == OBJTYPE_DEPOKINDTYPE_PLACESAVE)) or
                                ((depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_STORAGESEPARATLY)) and (AcntSettingType == OBJTYPE_DEPOKINDTYPE_FROMPLACESAVE))
                               )) OR
         ((AcntSettingType == OBJTYPE_DEPOKINDTYPE_TRANSFER) and (CheckPartyType(AcntOwner, PTK_BANK)) and (owner.NotResident() == UNSET_CHAR))
       )
        StorageCode = ПолучитьКодСубъекта(AcntOwner, PTCK_BANKREGNUM);
        StorageType = 1;// - регистрационный номер КО
     elif( (AcntSettingType == OBJTYPE_DEPOKINDTYPE_TRANSFER) and (CheckPartyType(AcntOwner, PTK_VEB)) )
        StorageCode = "964";
        StorageType = 1;//964> для Внешэкономбанка
     elif( (AcntSettingType == OBJTYPE_DEPOKINDTYPE_TRANSFER) and (not CheckPartyType(AcntOwner, PTK_BANK)) and (owner.NotResident() == UNSET_CHAR) )
        StorageCode = ПолучитьКодСубъекта(AcntOwner, PTCK_INN);
        StorageType = 2;//2 - ИНН,
     elif( (AcntSettingType == OBJTYPE_DEPOKINDTYPE_TRANSFER) and (owner.NotResident() == SET_CHAR) )
        StorageCode = "9999";
        StorageType = 3;//3 - иной
     else
        StorageCode = "0";
        StorageType = 3;//3 - иной
     end;

     return StorageCode;
  end;

  private macro GetStorageCodeKDU(AcntOwner)
     var StorageCode = "";
     var owner;

     owner = CDPParty(AcntOwner, m_end_date);

     if((CheckPartyType(AcntOwner, PTK_BANK)) and (owner.NotResident() == UNSET_CHAR))
        StorageCode = ПолучитьКодСубъекта(AcntOwner, PTCK_BANKREGNUM);
        StorageType = 1;// - регистрационный номер КО
     elif(CheckPartyType(AcntOwner, PTK_VEB))
        StorageCode = "964";
        StorageType = 1;//964> для Внешэкономбанка
     elif( (not CheckPartyType(AcntOwner, PTK_BANK)) and (owner.NotResident() == UNSET_CHAR) )
        StorageCode = ПолучитьКодСубъекта(AcntOwner, PTCK_INN);
        StorageType = 2;//2 - ИНН,
     elif( owner.NotResident() == SET_CHAR )
        StorageCode = "9999";
        StorageType = 3;//3 - иной
     else
        StorageCode = "0";
        StorageType = 3;//3 - иной
     end;

     return StorageCode;
  end;

  private macro GetStorageCodeBREPO(PartyID)
    var StorageCode = "";
    var pt;

    pt = CDPParty(PartyID, m_end_date);

    if(CheckPartyType(PartyID, PTK_VEB))
      StorageCode = "964";
      StorageType = 1;//964> для Внешэкономбанка
    elif((CheckPartyType(PartyID, PTK_BANK)) and (pt.NotResident() == UNSET_CHAR))
      StorageCode = ПолучитьКодСубъекта(PartyID, PTCK_BANKREGNUM);
      StorageType = 1;// - регистрационный номер КО
    elif( (not CheckPartyType(PartyID, PTK_BANK)) and (pt.NotResident() == UNSET_CHAR) )
      StorageCode = ПолучитьКодСубъекта(PartyID, PTCK_INN);
      StorageType = 2;//2 - ИНН,
    elif( pt.NotResident() == SET_CHAR )
       StorageCode = "9999";
       StorageType = 3;//3 - иной
    else
       StorageCode = "0";
       StorageType = 3;//3 - иной
    end;

    return StorageCode;
  end;

  private macro GetStorageCodeNettingSREPO()
     return "8888";
  end;

  private macro ПолучитьОсобыеПометкиКДУ(IsPawn, IsCorp, IsOperBan, IsArrest, IsTrust, IsRepo, IsAccOwn)
    var NoteStr = "НД";

    if((IsPawn == SET_CHAR) or (IsRepo == SET_CHAR))
      NoteStr = "ЗБ";
    elif((IsAccOwn != SET_CHAR) and ((IsCorp == SET_CHAR) or (IsOperBan == SET_CHAR) or (IsArrest == SET_CHAR)))
      NoteStr = "ОБ";
    elif(IsTrust == SET_CHAR)
      NoteStr = "ДУ";
    elif(IsAccOwn == SET_CHAR)
      NoteStr = "ПС";
    end;

    return NoteStr;
  end;

  private macro ПолучитьОсобыеПометки( AcntAutoKey, AcntOwner, AcntSettingType, ActiveAcntAutoKey, ActiveAcntOwner, ActiveAcntSettingType, IsAddLine )
    var NoteStr = "";

    if( (AcntOwner != null) and (AcntOwner == {OurBank}) )

       var depoatvl = TBFile("depoatvl.dbt");

       if( (AcntSettingType == OBJTYPE_DEPOKINDTYPE_MONEYKEEPER) or IsAddLine )
         NoteStr = "ЗБ";
       end;

       if( NoteStr == "" )
         if( AcntSettingType == OBJTYPE_DEPOKINDTYPE_ISSUER )
           NoteStr = "ДУ";
         end;
       end;

       if( NoteStr == "" )
         if( ( CheckPartyType( ActiveAcntOwner, PTK_DEPOSITORY )) and (ActiveAcntSettingType == OBJTYPE_DEPOKINDTYPE_TRANSFER))
           NoteStr = "НД";
         end;
       end;

       if( NoteStr == "" )
         if( ActiveAcntSettingType == OBJTYPE_DEPOKINDTYPE_FROMPLACESAVE)
           depoatvl.rec.AttrNum = DEPOATTR_ATTNUM_BLOCK;
           depoatvl.rec.IsType  = UNSET_CHAR;
           depoatvl.rec.ID      = ActiveAcntAutoKey;
           if(depoatvl.GetEQ())
             if( (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INCHECK)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INREBILLING)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_UNDERARREST)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INADMINBLOCK)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_ROUTE)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_TRANSMITTED))
               )
               NoteStr = "ОБ";
             end;
           end;
         elif( (AcntSettingType == OBJTYPE_DEPOKINDTYPE_DEPONENT) OR (AcntSettingType == OBJTYPE_DEPOKINDTYPE_TRANSIT) )
           depoatvl.rec.AttrNum = DEPOATTR_ATTNUM_BLOCK;
           depoatvl.rec.IsType  = UNSET_CHAR;
           depoatvl.rec.ID      = AcntAutoKey;
           if(depoatvl.GetEQ())
             if( (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INDELIVERY)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_ACQUIRED)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INRECEPTION)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INISSUE)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_LINKEDDRAFT)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_ISSUE)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INMARKETS)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_PLEDGE)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_INDEPOSIT)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_PAYPARTLY)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_ARRESTED)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_BLOCKBYADMIN)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_BLOCKFORPAY)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_BLOCKFORINVESTMENT)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_BASETRANSFER)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_PAYTRANSFER)) or
                 (depoatvl.rec.Value == string(OBJTYPE_DEPOACC_BLOCK_PAYFORCREDIT))
               )
               NoteStr = "ОБ";
             end;
           end;
         end;
       end;

       if( NoteStr == "" )
         if( (m_Fininstr.rec.DrawingDate != date(0,0,0)) and (m_Fininstr.rec.DrawingDate < m_repdate) )
           NoteStr = "ПН";
         end;
       end;

       if( NoteStr == "" )
         if( AcntSettingType == OBJTYPE_DEPOKINDTYPE_DEPONENT )
           NoteStr = "ПС";
         end;
       end;
    else
       NoteStr = "ДО";
    end;

    return NoteStr;
  end;

  private macro GetNum3CountryCodeByLat3( issuer )
    var Num3 = "-";

    //если есть принадлежность "Международная организация"
    if( CheckPartyType(issuer.PartyID(), PTK_INTERNATIONAL_ORG) or
        (GetObjAttrName(issuer.party, OBJTYPE_PARTY, 76/*Код сектора экономики эмит.-нерез.*/) == "400")
      )
       Num3 = "998";
    else
       var country, cmd;

       //cmd = DL_RSDCommand("select t_CodeLat2 from dcountry_dbt where t_CodeLat3 = ?");
       cmd = DL_RSDCommand("select t_CodeNum3 from dcountry_dbt where t_CodeLat3 = ?");
       cmd.AddParam(issuer.NRCountry());

       country = cmd.Execute();
       if( country.moveNext() )
          Num3 = country.CodeNum3;//Lat2 = country.CodeLat2;
       end;
    end;

    return Num3;
  end;

  private macro КодСектораЭкономикиЭмитента( issuer )
    var RetVal = GetObjAttrName(issuer.party, OBJTYPE_PARTY, 76/*Код сектора экономики эмит.-нерез.*/);

    if( RetVal == "" )
       if( CheckPartyType(issuer.PartyID(), PTK_BANK) )
          RetVal = "100";
       elif( CheckPartyType(issuer.PartyID(), PTK_CENTRBANK) )
          RetVal = "200";
       elif( CheckPartyType(issuer.PartyID(), PTK_MBR) or
             CheckPartyType(issuer.PartyID(), PTK_INTERNATIONAL_ORG)
           )
          RetVal = "400";
       elif( CheckPartyType(issuer.PartyID(), PTK_PENSFOND) or
             CheckPartyType(issuer.PartyID(), PTK_MEDICAL) or
             CheckPartyType(issuer.PartyID(), PTK_INSURANCE)
           )
          RetVal = "511";
       elif( CheckPartyType(issuer.PartyID(), PTK_UNIT_INVESTMENT_FUND) )
          RetVal = "512";
       elif( CheckPartyType(issuer.PartyID(), PTK_FINORG) )
          RetVal = "513";
       elif( CheckPartyType(issuer.PartyID(), PTK_STATE_BODY) or
             CheckPartyType(issuer.PartyID(), PTK_STATE_BODY_SUBJECT) or
             CheckPartyType(issuer.PartyID(), PTK_LOCAL_BODY) or
             CheckPartyType(issuer.PartyID(), PTK_LOCALGOVERNINGINST) or
             CheckPartyType(issuer.PartyID(), PTK_FUND_SOCIAL_INSURANCE)
           )
          RetVal = "520";
       elif( issuer.LegalForm() == PTLEGF_PERSN )
          RetVal = "540";
       else
          RetVal = "550";
       end;
    end;

    return RetVal;
  end;

  private macro GetPaymStatusOnDate_Str(PaymAlias:string, OnDate:date)
    var str  =   "NVL(( select h1.t_StatusIDTo "
               + "  from dpmhist_dbt h1"
               + " where h1.t_PaymentID = "+PaymAlias+".t_PaymentID "
               + "   and h1.t_Date <= " + GetSQLDate(OnDate)
               + "   and h1.t_AutoKey = (select max(h2.t_AutoKey) "
               + "                         from dpmhist_dbt h2 "
               + "                        where h2.t_PaymentID = h1.t_PaymentID "
               + "                          and h2.t_Date <= " + GetSQLDate(OnDate)
               + "                      )"
               + " ), 0)";

    return str;
  end;

  /* получить кол-во ц/б в сделках РЕПО */
  private macro GetRepoAmount( AmountDRepo:@variant, AmountORepo:@variant,
                               FIID, DepoPartID, DepoActivePartID )
    var IsRepoExist = false,
        sql, cmd, rsd, cmd_bs, rsd_bs;

    AmountDRepo = $0;
    AmountORepo = $0;

    /* отбираем 1-е части незакрытых пр./обр. сделок РЕПО */
    /* платеж по 2-й части сделки РЕПО должен быть не закрыт
       или закрыт, но не выполнено по нему поручение депо */
    sql = " SELECT (CASE WHEN Rsb_Secur.IsSale(Opr.oGrp)=1 THEN 1 "
        +              " ELSE 0 END) IsDRepo, Rsb_Secur.IsBasket(Opr.oGrp) IsBasket, Tick.t_DealID, "
        +        " rq_sp1.t_Amount "
        +        " - (SELECT NVL(SUM(t_Amount * (CASE WHEN CompRQ.t_Kind = rq_sp1.t_Kind THEN -1 ELSE 1 END)), 0) "
        +        "    FROM DDLRQ_DBT CompRQ "
        +        "   WHERE CompRQ.t_Type = " + DLRQ_TYPE_COMPDELIVERY
        +        "     AND CompRQ.t_FIID = rq_sp1.t_FIID "
        +        "     AND CompRQ.t_DocKind = rq_sp1.t_DocKind "
        +        "     AND CompRQ.t_DocID = rq_sp1.t_DocID "
        +        "     AND CompRQ.t_State = " + DLRQ_STATE_EXEC
        +        "     AND CompRQ.t_FactDate <= ? "
        +        " ) as t_Amount "
        +   " FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, "
        +        " (SELECT t_Kind_Operation, rsb_secur.get_OperationGroup(t_SysTypes) oGrp "
        +           " FROM doprkoper_dbt WHERE t_DocKind = "+DL_SECURITYDOC+") Opr, "
        +        " dspdrprop_dbt drprop1, dspdrmove_dbt dmove1, dpmpaym_dbt pm_dp1, ddlgrdeal_dbt grdeal, ddp_dep_dbt dep, dparty_dbt depowner "
        +  " WHERE rq_sp1.t_State = " + DLRQ_STATE_EXEC /*ТО по 1-й части д.б. исполнено*/
        +    " AND rq_sp1.t_Type  = " + DLRQ_TYPE_DELIVERY
        +    " AND rq_sp1.t_DealPart = 1 "
        +    " AND rq_sp1.t_FIID = ? " /*+ string(FIID)*/
        +    " AND Tick.t_DealID = rq_sp1.t_DocID "
        +    " AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "

        +    " AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY/*ТО по 2-й части */
        +    " AND rq_sp2.t_DealPart = 2 "
        +    " AND rq_sp2.t_FIID = ? " /*+ string(FIID)*/
        +    " AND rq_sp2.t_DocID = Tick.t_DealID "
        +    " AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "

        +    " AND Opr.t_Kind_Operation = Tick.t_DealType "
        +    " AND Tick.t_DealStatus > " + DL_PREPARING
        +    " AND Tick.t_ClientID = -1 "
        +    " AND Rsb_Secur.IsRepo(Opr.oGrp)=1 "
        +    " AND ( Rsb_Secur.IsBuy(Opr.oGrp)=1 OR " /*ОР*/
        +           " Rsb_Secur.IsSale(Opr.oGrp)=1 ) "  /*ПР*/

        +    " AND GRDEAL.T_DOCID = Tick.t_DealID "
        +    " AND GRDEAL.T_DOCKIND = TICK.T_BOFFICEKIND "
        +    " AND RSI_DLRQ.RSI_GetRQByDepoGrDeal(GRDEAL.T_ID, rq_sp1.t_FIID) = rq_sp1.t_ID "
        +    " AND drprop1.t_PaymentID = GRDEAL.T_ID "
        +    " AND drprop1.t_DocumentKind = " + DL_DLGRDEAL
        +    " AND drprop1.t_DocumentID = GRDEAL.T_ID "
        +    " AND dmove1.t_DraftID = drprop1.t_DraftID "
        +    " AND pm_dp1.t_PaymentID = dmove1.t_PaymentID "
        +    " AND pm_dp1.t_FIID = rq_sp1.t_FIID "
        +    " AND ((pm_dp1.t_PayerDPNode = ? AND pm_dp1.t_ReceiverDPNode = ? ) " /*+ string(DepoPartID), + string(DepoActivePartID) */
        +    "   OR ( pm_dp1.t_ReceiverDPNode = ? AND pm_dp1.t_PayerDPNode = ? ) ) " /*+ string(DepoPartID), + string(DepoActivePartID) */
        +    " AND pm_dp1.t_ValueDate <= ? "
        +    " AND pm_dp1.t_PaymStatus = " + PM_FINISHED/*депозитарный платеж по 1-й части д.б. закрыт*/

        +    " AND Tick.t_department = dep.t_code and depowner.t_partyid = dep.t_partyid"
        +    " AND depowner.t_NotResident = CHR(0)"
        +    " AND (depowner.t_NRCountry = CHR(1) or depowner.t_NRCountry = 'RUS')"

        +    " AND (rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, ?) <> " + DLRQ_STATE_EXEC/*платеж по 2-й части РЕПО не закрыт*/
        +    "    OR EXISTS(SELECT pm_dp2.t_PaymentID " /* или закрыт, но поручение по нему не исполнено */
        +    "                FROM dspdrprop_dbt drprop2, dspdraft_dbt draft2, dspdrmove_dbt dmove2, dpmpaym_dbt pm_dp2, ddlgrdeal_dbt grdeal2 "
        +    "               WHERE GRDEAL2.T_DOCID           = Tick.t_DealID "
        +    "                 AND GRDEAL2.T_DOCKIND         = TICK.T_BOFFICEKIND "
        +    "                 AND drprop2.t_PaymentID       = GRDEAL2.T_ID "
        +    "                 AND drprop2.t_DocumentKind    = drprop1.t_DocumentKind "
        +    "                 AND drprop2.t_DocumentID      = GRDEAL2.T_ID "
        +    "                 AND draft2.t_AutoKey          = drprop2.t_DraftID "
        +    "                 AND draft2.t_OperState        <> " + DP_INVSTATUSORDER_REJECT
        +    "                 AND dmove2.t_DraftID          = draft2.t_AutoKey "
        +    "                 AND pm_dp2.t_PaymentID        = dmove2.t_PaymentID "
        +    "                 AND pm_dp2.t_FIID             = rq_sp2.t_FIID "
        +    "                 AND (pm_dp2.t_PayerDPNode      = ? " /*+ string(DepoPartID)*/
        +    "                    OR pm_dp2.t_ReceiverDPNode = ? " /*+ string(DepoPartID)*/ + ") "
        +    "                 AND "+GetPaymStatusOnDate_Str("pm_dp2", date(m_end_date))+" < "+PM_FINISHED+") " /*депозитарный платеж по 2-й части _не_ д.б. закрыт*/
        +    "     ) ";

    cmd = RSDCommand(sql);

    cmd.addParam( "", RSDBP_IN, date(m_end_date) );
    cmd.addParam( "", RSDBP_IN, int(FIID) );
    cmd.addParam( "", RSDBP_IN, int(FIID) );
    cmd.addParam( "", RSDBP_IN, int(DepoPartID) );
    cmd.addParam( "", RSDBP_IN, int(DepoActivePartID) );
    cmd.addParam( "", RSDBP_IN, int(DepoPartID) );
    cmd.addParam( "", RSDBP_IN, int(DepoActivePartID) );
    cmd.addParam( "", RSDBP_IN, date(m_end_date) );
    cmd.addParam( "", RSDBP_IN, date(m_end_date) );
    cmd.addParam( "", RSDBP_IN, int(DepoPartID) );
    cmd.addParam( "", RSDBP_IN, int(DepoPartID) );

    cmd.Execute();

    rsd = TRsbDataSet(cmd);
    while( rsd.MoveNext() )
      IsRepoExist = true;

      if( rsd.IsDRepo == 1 )
        AmountDRepo = AmountDRepo + money(rsd.Amount);
      else
        AmountORepo = AmountORepo + money(rsd.Amount);
      end;
    end;

    return IsRepoExist;
  end;

  /* получить кол-во ц/б в сделках РЕПО, по которым не формировались поручения в депозитарий
     (например, когда сводные свернулись в 0)*/
  private macro GetRepoAmountNotDepo( FIID:integer )

    var IsRepoExist = false,
        sql, cmd, rsd, Place = "";

    ОстатокПРепоБезДепо.ClearArray();
    ОстатокОРепоБезДепо.ClearArray();

    //а также сделки РЕПО, по которым не было поручения по 1ч (например, свернулись в 0 при формировании сводного)
    sql = " SELECT rq_sp1.t_PlaceID, Rsb_Secur.IsSale(Opr.oGrp) as IsSale, "
         +        " rq_sp1.t_Amount "
         +        " - (SELECT NVL(SUM(t_Amount * (CASE WHEN CompRQ.t_Kind = rq_sp1.t_Kind THEN -1 ELSE 1 END)), 0) "
         +        "    FROM DDLRQ_DBT CompRQ "
         +        "   WHERE CompRQ.t_Type = " + DLRQ_TYPE_COMPDELIVERY
         +        "     AND CompRQ.t_FIID = rq_sp1.t_FIID "
         +        "     AND CompRQ.t_DocKind = rq_sp1.t_DocKind "
         +        "     AND CompRQ.t_DocID = rq_sp1.t_DocID "
         +        "     AND CompRQ.t_State = " + DLRQ_STATE_EXEC
         +        "     AND CompRQ.t_FactDate <= ? "
         +        " ) as t_Amount "
         + "   FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, ddlgrdeal_dbt grdeal, ddlgracc_dbt gracc, "
         +        " (SELECT t_Kind_Operation, rsb_secur.get_OperationGroup(t_SysTypes) oGrp FROM doprkoper_dbt WHERE t_DocKind = "+DL_SECURITYDOC+") Opr "

         +  " WHERE rq_sp1.t_State = " + DLRQ_STATE_EXEC /*ТО по 1-й части д.б. исполнено*/
         +    " AND rq_sp1.t_Type  = " + DLRQ_TYPE_DELIVERY
         +    " AND rq_sp1.t_DealPart = 1 "
         +    " AND rq_sp1.t_FIID = ? " /*+ string(FIID)*/
         +    " AND rq_sp1.t_FactDate <= ? "
         +    " AND Tick.t_DealID = rq_sp1.t_DocID "
         +    " AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "

         +    " AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY/*ТО по 2-й части */
         +    " AND rq_sp2.t_DealPart = 2 "
         +    " AND rq_sp2.t_FIID = ? " /*+ string(FIID)*/
         +    " AND rq_sp2.t_DocID = Tick.t_DealID "
         +    " AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "

         +    " AND rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, ?) <> " + DLRQ_STATE_EXEC/*ТО по 2-й части РЕПО не исполнено*/

         +    " AND Opr.t_Kind_Operation = Tick.t_DealType "
         +    " AND Tick.t_DealStatus > " + DL_PREPARING
         +    " AND Tick.t_ClientID = -1 "
         +    " AND Rsb_Secur.IsRepo(Opr.oGrp)=1 "
         +    " AND GRDEAL.T_DOCID = Tick.t_DealID "
         +    " AND GRDEAL.T_DOCKIND = TICK.T_BOFFICEKIND "
         +    " AND RSI_DLRQ.RSI_GetRQByDepoGrDeal(GRDEAL.T_ID, rq_sp1.t_FIID) = rq_sp1.t_ID "
         +    " AND gracc.t_GrDealID = grdeal.t_ID "
         +    " AND gracc.t_AccNum = " + DLGR_ACCKIND_CUSTODY
         +    " AND NOT EXISTS (SELECT 1 "
         +    "                   FROM dspdrprop_dbt prop "
         +    "                  WHERE prop.t_DocumentKind = " + DL_DLGRDEAL
         +    "                    AND prop.t_DocumentID = GRDEAL.T_ID "
         +    "                )";

    cmd = DL_RSDCommand(sql);

    cmd.addParam( date(m_end_date) );
    cmd.addParam( int(FIID) );
    cmd.addParam( date(m_end_date) );
    cmd.addParam( int(FIID) );
    cmd.addParam( date(m_end_date) );

    rsd = cmd.Execute();

    while( rsd.MoveNext() )

      if(rsd.IsSale)
        Place = GetStorageCodeNettingSREPO();
        ОстатокПРепоБезДепо.Add(money(rsd.Amount),Place);
      else
        Place = GetStorageCodeBREPO(rsd.PlaceID);
        ОстатокОРепоБезДепо.Add(money(rsd.Amount),Place);
      end;
      IsRepoExist = true;
    end;

    return IsRepoExist;
  end;

  /* получить кол-во ц/б в сделках РЕПО, уч в неттинге*/
  private macro GetSaleRepoAmountNetting( FIID:integer )

    var IsRepoExist = false,
        sql, cmd, rsd;

    ОстатокПРепоВНеттинге.ClearArray();

    /* отбираем 1-е части незакрытых пр. сделок РЕПО */
    /* платеж по 2-й части сделки РЕПО должен быть не закрыт
       либо исполнен датой, большей даты окончания от-чётного периода */

    cmd = DL_RSDCommand();

    sql = " SELECT "
       +   "   SUM(nvl( case when Rsb_Secur.IsBasket(Opr.oGrp) = 1 "
       +   "            then (select sum(case when tick_ens.t_kind = ? then nvl(tick_ens.t_principal,0) else nvl(-tick_ens.t_principal, 0) end) as Amount "
       +   "                    from ddl_tick_ens_dbt tick_ens "
       +   "                   where tick_ens.t_dealID = Tick.t_DealID "
       +   "                     and tick_ens.t_FIID   = rq_sp1.t_FIID "
       +   "                     and tick_ens.t_date  <= ? "
       +   "                 ) "
       +   "            else (SELECT nvl(RQHIST.T_Amount,0) "
       +   "                   FROM v_rqhist rqhist "
       +   "                  WHERE RQHIST.T_RQID = rq_sp1.t_ID "
       +   "                    AND RQHIST.T_INSTANCE = (SELECT max(rqhist_1.T_INSTANCE) "
       +   "                                               FROM v_rqhist rqhist_1 "
       +   "                                              WHERE rqhist_1.T_RQID = RQHIST.T_RQID "
       +   "                                                AND rqhist_1.T_CHANGEDATE <= ? "
       +   "                                            ) "
       +   "                 ) end,0) "
       +   "      ) t_Amount, Tick.t_ClientContrID "
       +     " FROM ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2, ddl_tick_dbt Tick, "
       +          " (SELECT t_Kind_Operation, rsb_secur.get_OperationGroup(t_SysTypes) oGrp "
       +             " FROM doprkoper_dbt WHERE t_DocKind = "+DL_SECURITYDOC+") Opr, ddp_dep_dbt dep, dparty_dbt depowner "
       +    " WHERE rsi_dlrq.RSI_GetRQStateOnDate(rq_sp1.t_ID, ?) = ? " /*ТО по 1-й части д.б. исполнено*/
       +      " AND rq_sp1.t_Type = ? "
       +      " AND rq_sp1.t_DealPart = 1 "
       +      " AND rq_sp1.t_FIID = ? "
       +      " AND Tick.t_DealID = rq_sp1.t_DocID "
       +      " AND Tick.t_BOfficeKind = rq_sp1.t_DocKind "
       +      " AND rq_sp1.t_Netting = 'X' " /*только неттинг*/
       +      " AND rq_sp2.t_Type = ? " /*ТО по 2-й части */
       +      " AND rq_sp2.t_DealPart = 2 "
       +      " AND rq_sp2.t_FIID = ? "
       +      " AND rq_sp2.t_DocID = Tick.t_DealID "
       +      " AND rq_sp2.t_DocKind = Tick.t_BOfficeKind "

       +      " AND Opr.t_Kind_Operation = Tick.t_DealType "
       +      " AND Tick.t_ClientID = -1 "
       +      " AND Tick.t_DealStatus > ? "
       +      " AND Rsb_Secur.IsRepo(Opr.oGrp)=1 AND Rsb_Secur.IsSale(Opr.oGrp)=1 "  /*ПР*/

       +      " AND Tick.t_department = dep.t_code and depowner.t_partyid = dep.t_partyid"
       +      " AND depowner.t_NotResident = CHR(0)"
       +      " AND (depowner.t_NRCountry = CHR(1) or depowner.t_NRCountry = 'RUS')"

       +      " AND rsi_dlrq.RSI_GetRQStateOnDate(rq_sp2.t_ID, ?) <> ? "
       + " GROUP BY Tick.t_ClientContrID ";

    cmd.addParam( TICKENS_KIND_IN );
    cmd.addParam( date(m_end_date) );
    cmd.addParam( date(m_end_date) );
    cmd.addParam( date(m_end_date) );
    cmd.addParam( DLRQ_STATE_EXEC );
    cmd.addParam( DLRQ_TYPE_DELIVERY );
    cmd.addParam( int(FIID) );
    cmd.addParam( DLRQ_TYPE_DELIVERY );
    cmd.addParam( int(FIID) );
    cmd.addParam( DL_PREPARING );
    cmd.addParam( date(m_end_date) );
    cmd.addParam( DLRQ_STATE_EXEC );

    rsd = cmd.Execute(sql);

    while( rsd.MoveNext() )
      ОстатокПРепоВНеттинге.Add(money(rsd.Amount), GetStorageCodeNettingSREPO());
      IsRepoExist = true;
    end;

    return IsRepoExist;
  end;

  private macro ПериодБольшеОдногоГода(BegDate:date, EndDate:date ):bool
    var RetVal:bool = false;
    var sql = RSDCommand( " SELECT (case when ((MONTHS_BETWEEN(?, ?)/12) > 1) then 1 else 0 end) RetVal " +
                          "   FROM dual " );
    sql.addParam("", RSDBP_IN, EndDate);
    sql.addParam("", RSDBP_IN, BegDate);
    sql.execute();
    var Rec = TRsbDataSet(sql);
    if( Rec.MoveNext() and (Rec.RetVal != null) )
       RetVal = (SQL_ConvTypeInteger(Rec.RetVal) > 0);
    end;

    return RetVal;
  end;

  private macro GetPtName( PartyID:integer, NameTypeID:integer ): string

    if( PartyID > 0 )
       var arrNames:TArray = GetPartyNames(PartyID, NameTypeID);

       if( arrNames.size > 0 )
          return arrNames[0];
       end;
    end;

    return "";
  end;

    /*************функции экспорта в клико****************************/

  PRIVATE MACRO DelimBy1000(Sum)
     if( (Sum != "") and (Sum != null) and (Sum != 0.0))
        Sum = Sum/1000.0;
     else
        Sum = "-";
     end;
     return Sum;
  END;

  PRIVATE MACRO Kliko_InsertInTxtFile( Str:STRING ):BOOL
    if( insert( Kliko_F404, Str ) == false )
       MsgBox( "Ошибка при вставке записи в файл Kliko" );
       return false;
    end;
    return true;
  END;

  PRIVATE MACRO Kliko_TxtFileName( RepDate:DATE ):STRING
    var Day, Month, Year;
    datesplit( RepDate, Day, Month, Year );
    Year = SubStr( string(Year), strlen(string(Year))-1 );

    return GetTxtFileName( string(Day:2:o)+string(Month:2:o)+string(Year:2:o)+"_F706" );
  END;

  PRIVATE MACRO Kliko_OpenTxtFile( RepDate:DATE )
    VAR errcode, errtext;
    VAR fName = Kliko_TxtFileName( RepDate );
    if( not Open( Kliko_F404, fName, "rsoem" ) )
      errcode = status(errtext);
      RunError( "Ошибка при открытии файла для экспорта в kliko|"+fName+"|(" + errcode + ") " + errtext );
      return false;
    end;
    return true;
  END;

  PRIVATE MACRO Kliko_CloseTxtFile(fileview:bool)
    close( Kliko_F404 );
    if(fileview)
      ViewFile( Kliko_F404 );
    end;
  END;

  PRIVATE MACRO Kliko_Fld( Val:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL )
      VAR vt = ValType(Val);
      if( vt == V_DATE )
         if( Val == DATE(0,0,0) )
            ValStr = "";
         else
            ValStr = string(Val:f);
         end;
      elif( vt == V_STRING )
         ValStr = StrSubst( Val, "\"", "''" );
         ValStr = StrSubst( ValStr, "-", "0" );
         if (ValStr == "")
             ValStr = "0";
         end;           
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        if( Val != 0.00)
          ValStr = trim(string(Val:23:6));
        /*else
          ValStr = "0";     */
        end;
      else
         ValStr = string(Val);
      end;
    end;
    return "\""+ValStr+"\"";
  END;

  PRIVATE MACRO PrintLineKliko(N1,N2,N3,N4,N5,N6,N7,N8,N9,N10,N11,N12,N13,N14,N15,N16,N17,N18,N19)

    if (m_KlikoPart==1)
        N8="";
    end;

    return Kliko_InsertInTxtFile( Kliko_Fld( N1  ) +","+    //Идентификационный код ценной бумаги (гр.2)
                                  Kliko_Fld( N2  ) +","+    //Код типа ценной бумаги (гр.3)
                                  Kliko_Fld( N3  ) +","+    //Код срока погашения (гр.4)
                                  Kliko_Fld( N4  ) +","+    //Наименование эмитента (гр.5)
                                  Kliko_Fld( N5  ) +","+    //Код страны эмитента (гр.6)
                                  Kliko_Fld( N6  ) +","+    //Код сектора экономики эмитента (гр.7)
                                  IIF( m_KlikoPart == 2 , "\"\"" , Kliko_Fld( N7  ) ) +","+    //Наличие отношений прямого инвестирования (гр.8)
                                  IIF( m_KlikoPart == 1 , "\"\"" , Kliko_Fld( N8  ) ) +","+    //Код клиента (гр.9)
                                  IIF( m_KlikoPart == 1 , "\"\"" , Kliko_Fld( N9  ) ) +","+    //Код региона клиента (гр.10)
                                  Kliko_Fld( N10 ) +","+    //Количество ценных бумаг (штук) (гр.11)
                                  Kliko_Fld( N11 ) +","+    //Код валюты ценной бумаги (гр.12)
                                  Kliko_Fld( N12 ) +","+    //Номинальная цена одной ценной бумаги (в ед. валюты) (гр.13)
                                  Kliko_Fld( N13 ) +","+    //Рыночная цена одной ценной бумаги (в ед. валюты) (гр.14)
                                  Kliko_Fld( N14 ) +","+    //Номинальная общая стоимость пакета ценных бумаг (в ед. валюты) (гр.13*гр.11) (гр.15)
                                  Kliko_Fld( N15 ) +","+    //Рыночная общая стоимость пакета ценных бумаг (в ед. валюты) (гр.14*гр.11) (гр.16)
                                  Kliko_Fld( N16 ) +","+    //Код использованного метода оценки рыночной стоимости ценной бумаги (гр.17)
                                  Kliko_Fld( N17 ) +","+    //Признак места хранения ценных бумаг (гр.18_1)
                                  Kliko_Fld( N18 ) +","+    //Код места хранения ценных бумаг (гр.18)
                                  Kliko_Fld( N19 )          //Особые пометки (гр.19)
                                );
  END;

  macro GetEndDate():date
     return m_end_date;
  end;

  macro ПолучитьПризнакМестаХраненияЦенныхБумаг(_src:STRING)
  /*IF (_src ==
  END;*/
  end;
  /*******************конец функций экспорта в клико*******************/
  
  /** Общая рыночная стоимость пакета ценных бумаг
  определяется по остаткам на глобальных счетах КУ +/- Корректировки, ц/б, Наш портфель, ц/б, Уплаченный НКД, Начисл. ПДД, ц/б, Премия, ц/б, +/- Переоценка, ц/б ССПУ_ЦБ, +/- Переоценка, ц/б СССД_ЦБ*/
  private macro GetPacketMarketPrice(Рыночная_Цена, repDate, FIID)
    var sql, cmd, rs;
    
    sql = "select nvl(abs(sum(RSB_FIInstr.ConvSum(rsi_rsb_account.restac(accdoc.t_account, accdoc.t_currency, ?, accdoc.t_chapter, null ), accdoc.t_currency, fin.t_facevaluefi , ? ))), 0) t_sum  "+
          "  from dmcaccdoc_dbt accdoc "+
          "  join dfininstr_dbt fin on accdoc.t_fiid = fin.t_fiid "+
          " where accdoc.t_iscommon='X' and (((accdoc.t_catid in (688, 689, 31, 440, 386, 433) and accdoc.t_account like '504%' ) " +
          "    or (accdoc.t_catid in (31, 440, 386, 433, 67, 69, 489, 490, 491, 492) and accdoc.t_account not like '504%' ))) " +
          "   and accdoc.t_fiid = ?" +
          "   and accdoc.t_activatedate <= ?";

    cmd = RsdCommand(sql);
    cmd.addParam("repdate1", RSDBP_IN, repDate);
    cmd.addParam("repdate2", RSDBP_IN, repDate);
    cmd.addParam("FIID", RSDBP_IN, FIID);
    cmd.addParam("repdate3", RSDBP_IN, repDate);
    rs = RsdRecordSet(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);
    if(rs and rs.MoveNext())
      SetParm(1, round(double(rs.value("t_sum")), 6));
      return true;
    end;
    
    return false;
  end;
  
  private macro PrintHead1()
     merge("A_1", "A_17");
     PrintTableLine("A_1", string("Раздел 1. Ценные бумаги, выпущенные нерезидентами и принадлежащие уполномоченному банку на праве собственности"), null);
     if( m_InKliko )
        Kliko_InsertInTxtFile("<F404_1>");
        m_KlikoPart = 1;
     end;
  end;

  private macro PrintHead2()
     merge("A_1", "A_17");
     PrintTableLine("A_1", string("Раздел 2. Ценные бумаги, выпущенные нерезидентами и принадлежащие резидентам, являющимся клиентами (депонентами) уполномоченного банка (кроме кредитных организаций) "), null);
     if( m_InKliko )
        Kliko_InsertInTxtFile("<F404_2>");
        m_KlikoPart = 2;
     end;
  end;

  private macro PrintEmptyLine()
     PrintTableLine( "A_1",  "", null,
                     "A_2",  "", null,
                     "A_4",  "", null,
                     "A_18", "", null,
                     "A_5",  "", null,
                     "A_8",  "", null,
                     "A_19", "", null,
                     "A_6",  "", null,
                     "A_7",  "", null,
                     "A_20", "", null,
                     "A_9",  "", null,
                     "A_10", "", null,
                     "A_11", "", null,
                     "A_12", "", null,
                     "A_13", "", null,
                     "A_14", "", null,
                     "A_15", "", null,
                     "A_16", "", null,
                     "A_17", "", null
                   );
  end;

  private macro CreatePart( NumberPart )
     var query, DataSet;
     var i=1;
     var client;
     var issuer;
     var fin;
     var Код_Ценной_Бумаги = "-";
     var Код_Типа_Ценной_Бумаги = "-";
     var Наличие_Коротношений = "-";
     var Код_Клиента = "-";
     var Код_Региона_Клиента = "-";
     var Код_Страны_Эмитента = "-";
     var Код_Сектора_Экономики_Эмитента = "-";
     var Номинальная_Цена = 0;
     var Рыночная_Цена = 0;
     var ОстатокЦБ = 0, ОстатокПРепо = 0, ОстатокОРепо = 0;
     var Номинальная_Стоимость_Пакета = 0;
     var Рыночная_Стоимость_Пакета = 0;
     var Код_Метода_Оценки = "-";
     var Код_Места_Хранения = "-";
     var Особые_Пометки = "-";
     var Код_Срока_Погашения = "-";
     var НаименованиеЭмитента = "-";
     var RateDef = TRecHandler("ratedef.dbt");
     record sf(sfcontr);
     record party("party.dbt");
     record FaceValueFI("fininstr");

     var DataFIID, LineData = CLineData(), PrevClient = -1;
     var error = 0, sql, cmd, query_FIID, NetData, sql_FIID, cnt_FIID = 0, Num = 0, IsErrPrint = false;

     macro ПечататьЗаголовок()
       if( (i == 1) and ((LineData.size > 0) or (ОстатокПРепоВНеттинге.size > 0) or (ОстатокПРепоБезДепо.size > 0)) )
         if( NumberPart == 1 )
            PrintHead1();
         elif( NumberPart == 2 )
            PrintHead2();
         end;
       end;
     end;

     macro ПечататьОсновныеСтроки()
       var j = 0;

       if( LineData.size > 0 )
          j = 0;

          var txt="";
          if( m_ToExcel )
             txt = txt + OUTASTEXT;
          end;

          while( j < LineData.size )

             if(LineData[j].ОстатокЦБ > 0 )
               PrintTableLine( "A_1:c",    txt+String(NumberPart)+"."+String(i),                       			null,
                               "A_2",      LineData[j].Код_Ценной_Бумаги,                              			null,
                               "A_4",      LineData[j].Код_Типа_Ценной_Бумаги,                         			null,
                               "A_18",     LineData[j].Код_Срока_Погашения,                            			null,
                               "A_5",      LineData[j].LatName,                                        			null,
                               "A_8",      LineData[j].Код_Страны_Эмитента,                            			null,
                               "A_19",     LineData[j].Код_Сектора_Экономики_Эмитента,                 			null,
                               "A_6",      IIF(NumberPart == 1, StrUpr(LineData[j].Наличие_Коротношений, "" )),	       null,
                               "A_7",      IIF(NumberPart == 2, LineData[j].Код_Клиента, "" ),         			null,
                               "A_20",     IIF(NumberPart == 2, LineData[j].Код_Региона_Клиента,  "" ),			null,
                               "A_9:r:6",  double(LineData[j].ОстатокЦБ),                              DP_GetPrecision(double(LineData[j].ОстатокЦБ), int(LineData[j].SumPrecision)),
                               "A_10",     LineData[j].FaceValueFI,                                    			null,
                               "A_11:r:6", LineData[j].Номинальная_Цена,                               			null,
                               "A_12:r:6", double(LineData[j].Рыночная_Цена),                          			null,
                               "A_13:r:6", LineData[j].Номинальная_Стоимость_Пакета,                   			null,
                               "A_14:r:6", LineData[j].Рыночная_Стоимость_Пакета,                      			null,
                               "A_15",     LineData[j].Код_Метода_Оценки,                              			null,
                               "A_16",     LineData[j].Код_Места_Хранения,                             			null,
                               "A_17",     LineData[j].Особые_Пометки,                                 			null
                              );
                if( m_InKliko )
                   PrintLineKliko(LineData[j].Код_Ценной_Бумаги,
                                  LineData[j].Код_Типа_Ценной_Бумаги,
                                  LineData[j].Код_Срока_Погашения,
                                  LineData[j].LatName,
                                  LineData[j].Код_Страны_Эмитента,
                                  LineData[j].Код_Сектора_Экономики_Эмитента,
                                  StrUpr(LineData[j].Наличие_Коротношений),
                                  LineData[j].Наличие_Коротношений,
                                  LineData[j].Код_Клиента,
                                  LineData[j].Код_Региона_Клиента,
                                  double(LineData[j].ОстатокЦБ),
                                  LineData[j].FaceValueFI,
                                  LineData[j].Номинальная_Цена,
                                  LineData[j].Рыночная_Цена,
                                  LineData[j].Номинальная_Стоимость_Пакета,
                                  LineData[j].Рыночная_Стоимость_Пакета,
                                  LineData[j].Код_Метода_Оценки,
                                  LineData[j].StorageType,
                                  LineData[j].Код_Места_Хранения,
                                  LineData[j].Особые_Пометки
                                  );
                end;
                if(m_InDelta)
                   DeltaReport.SaveLineP(NumberPart, 
                   String(i),
                   LineData[j].Код_Ценной_Бумаги,
                   LineData[j].Код_Типа_Ценной_Бумаги,
                   LineData[j].Код_Срока_Погашения,
                   LineData[j].LatName,
                   LineData[j].Код_Страны_Эмитента,
                   LineData[j].Код_Сектора_Экономики_Эмитента, 
                   LineData[j].Наличие_Коротношений,
                   double(LineData[j].ОстатокЦБ),
                   LineData[j].FaceValueFI,
                   double(LineData[j].Номинальная_Цена),
                   double(LineData[j].Рыночная_Цена),
                   LineData[j].Номинальная_Стоимость_Пакета,
                   LineData[j].Рыночная_Стоимость_Пакета,
                   LineData[j].Код_Метода_Оценки,
                   LineData[j].StorageType,
                   LineData[j].Код_Места_Хранения,
                   LineData[j].Особые_Пометки);
                end;
             end;

             i=i+1;
             j=j+1;
          end;
       end;
     end;

     macro ПечататьДопНеттингСтроки()
       var j = 0;

       if( (NumberPart == 1) and (ОстатокПРепоВНеттинге.size > 0) )
          j = 0;

          if( IsErrPrint == false )
             if( Код_Ценной_Бумаги == "" )
               DP_ProtocolAddStr(NumberPart, "", m_Fininstr.rec.FI_Code, "", "", "Для ценной бумаги не определен ни ISIN, ни \"Код ЦБ для ф.404\"");
             end;

             if( Код_Типа_Ценной_Бумаги == "" )
               DP_ProtocolAddStr(NumberPart, "", m_Fininstr.rec.FI_Code, "", "", "Не определен код типа ценной бумаги в категории \"Код ЦБ для формы 404\"");
             end;

             if( Код_Метода_Оценки == "" )
               DP_ProtocolAddStr(NumberPart, "", m_Fininstr.rec.FI_Code, "", "", "Не определен код использованного метода оценки рыночной стоимости ценных бумаг");
             end;

             IsErrPrint = true;
          end;

          var txt="";
          if( m_ToExcel )
             txt = txt + OUTASTEXT;
          end;

          while( j < ОстатокПРепоВНеттинге.size )
             if( ОстатокПРепоВНеттинге[j].Rest > 0 )
                if(m_ByKDU == true)
                  Особые_Пометки = "ЗБ";
                else
                  Особые_Пометки = ПолучитьОсобыеПометки(null, null, null, null, null, null, true);
                end;
                ОстатокПРепо = double(ОстатокПРепоВНеттинге[j].Rest);
                Код_Места_Хранения = ОстатокПРепоВНеттинге[j].Place;

                Номинальная_Стоимость_Пакета = double(round(double(Номинальная_Цена), 6)*round(double(ОстатокПРепо), 6));
                
                if (ОстатокПРепо > 0)
                   Рыночная_Цена = double(round(Рыночная_Стоимость_Пакета/round(double(ОстатокПРепо), 6), 6));
                   Рыночная_Стоимость_Пакета = Рыночная_Цена * round(double(ОстатокПРепо), 6);
                else
                   Рыночная_Цена = 0.0;
                end;
                
                ПолучитьФинИн(m_FinInstr.rec.FaceValueFI, FaceValueFI);

                PrintTableLine( "A_1:c",    txt+String(NumberPart)+"."+String(i),                      			null,
                                "A_2",      Код_Ценной_Бумаги,                                         			null,
                                "A_4",      Код_Типа_Ценной_Бумаги,                                    			null,
                                "A_18",     Код_Срока_Погашения,                                       			null,
                                "A_5",      НаименованиеЭмитента,                                      			null,
                                "A_8",      Код_Страны_Эмитента,                                       			null,
                                "A_19",     Код_Сектора_Экономики_Эмитента,                            			null,
                                "A_6",      StrUpr(Наличие_Коротношений),                                      	null,
                                "A_7",      "",                                                        			null,
                                "A_20",     "",                                                        			null,
                                "A_9:r:6",  double(ОстатокПРепо),                                      DP_GetPrecision(double(ОстатокПРепо), int(DataFIID.SumPrecision)),
                                "A_10",     FaceValueFI.ISO_Number,                                    			null,
                                "A_11:r:6", double(Номинальная_Цена),                                  			null,
                                "A_12:r:6", double(Рыночная_Цена),                                     			null,
                                "A_13:r:6", Номинальная_Стоимость_Пакета,                              			null,
                                "A_14:r:6", Рыночная_Стоимость_Пакета,                                 			null,
                                "A_15",     Код_Метода_Оценки,                                         			null,
                                "A_16",     Код_Места_Хранения,                                        			null,
                                "A_17",     Особые_Пометки,                                            			null
                               );
                if( m_InKliko )
                   PrintLineKliko(Код_Ценной_Бумаги,
                                  Код_Типа_Ценной_Бумаги,
                                  Код_Срока_Погашения,
                                  НаименованиеЭмитента,
                                  Код_Страны_Эмитента,
                                  Код_Сектора_Экономики_Эмитента,
                                  StrUpr(Наличие_Коротношений),
                                  "",
                                  "",
                                  double(ОстатокПРепо),
                                  FaceValueFI.ISO_Number,
                                  Номинальная_Цена,
                                  Рыночная_Цена,
                                  Номинальная_Стоимость_Пакета,
                                  Рыночная_Стоимость_Пакета,
                                  Код_Метода_Оценки,
                                  StorageType,//признак места хранения?
                                  Код_Места_Хранения,
                                  Особые_Пометки
                                  );
                end;
                if(m_InDelta)
                   DeltaReport.SaveLineP(NumberPart, 
                   String(i),
                   Код_Ценной_Бумаги,
                   Код_Типа_Ценной_Бумаги,
                   Код_Срока_Погашения,
                   НаименованиеЭмитента,
                   Код_Страны_Эмитента,
                   Код_Сектора_Экономики_Эмитента, 
                   Наличие_Коротношений,
                   double(ОстатокПРепо),
                   FaceValueFI.ISO_Number,
                   double(Номинальная_Цена),
                   double(Рыночная_Цена),
                   Номинальная_Стоимость_Пакета,
                   Рыночная_Стоимость_Пакета,
                   Код_Метода_Оценки,
                   StorageType,
                   Код_Места_Хранения,
                   Особые_Пометки);
                end;
                i=i+1;
             end;
             j=j+1;
          end;
       end;
     end;

     macro ПечататьДопБезДепоСтроки()
       var j = 0;

       if( (NumberPart == 1) and (ОстатокПРепоБезДепо.size > 0) )
          j = 0;

          if( IsErrPrint == false )
             if( Код_Ценной_Бумаги == "" )
               DP_ProtocolAddStr(NumberPart, "", m_Fininstr.rec.FI_Code, "", "", "Для ценной бумаги не определен ни ISIN, ни \"Код ЦБ для ф.404\"");
             end;

             if( Код_Типа_Ценной_Бумаги == "" )
               DP_ProtocolAddStr(NumberPart, "", m_Fininstr.rec.FI_Code, "", "", "Не определен код типа ценной бумаги в категории \"Код ЦБ для формы 404\"");
             end;

             if( Код_Метода_Оценки == "" )
               DP_ProtocolAddStr(NumberPart, "", m_Fininstr.rec.FI_Code, "", "", "Не определен код использованного метода оценки рыночной стоимости ценных бумаг");
             end;

             IsErrPrint = true;
          end;

          while( j < ОстатокПРепоБезДепо.size )
             if( ОстатокПРепоБезДепо[j].Rest > 0 )
                if(m_ByKDU == true)
                  Особые_Пометки = "ЗБ";
                else
                  Особые_Пометки = ПолучитьОсобыеПометки(null, null, null, null, null, null, true);
                end;
                ОстатокПРепо = double(ОстатокПРепоБезДепо[j].Rest);
                Код_Места_Хранения = ОстатокПРепоБезДепо[j].Place;

                Номинальная_Стоимость_Пакета = double(round(double(Номинальная_Цена), 6)*round(double(ОстатокПРепо), 6));
                
                GetPacketMarketPrice(Рыночная_Стоимость_Пакета, date(m_end_date), fin.FIID);
                if (ОстатокПРепо > 0)
                   Рыночная_Цена = double(round(Рыночная_Стоимость_Пакета/round(double(ОстатокПРепо), 6), 6));
                   Рыночная_Стоимость_Пакета = Рыночная_Цена * round(double(ОстатокПРепо), 6); 
                else
                   Рыночная_Цена = 0.0;
                end;
                
                ПолучитьФинИн(m_FinInstr.rec.FaceValueFI, FaceValueFI);

                PrintTableLine( "A_1:c",    String(NumberPart)+"."+String(i),                          			null,
                                "A_2",      Код_Ценной_Бумаги,                                         			null,
                                "A_4",      Код_Типа_Ценной_Бумаги,                                    			null,
                                "A_18",     Код_Срока_Погашения,                                       			null,
                                "A_5",      НаименованиеЭмитента,                                      			null,
                                "A_8",      Код_Страны_Эмитента,                                       			null,
                                "A_19",     Код_Сектора_Экономики_Эмитента,                            			null,
                                "A_6",      StrUpr(Наличие_Коротношений),                                      	null,
                                "A_7",      "",                                                        			null,
                                "A_20",     "",                                                        			null,
                                "A_9:r",    double(ОстатокПРепо),                                      DP_GetPrecision(double(ОстатокПРепо), int(DataFIID.SumPrecision)),
                                "A_10",     FaceValueFI.ISO_Number,                                    			null,
                                "A_11:r:4", double(Номинальная_Цена),                                  			null,
                                "A_12:r:4", double(Рыночная_Цена),                                     			null,
                                "A_13:r",   Номинальная_Стоимость_Пакета,                              			null,
                                "A_14:r",   Рыночная_Стоимость_Пакета,                                 			null,
                                "A_15",     Код_Метода_Оценки,                                         			null,
                                "A_16",     Код_Места_Хранения,                                        			null,
                                "A_17",     Особые_Пометки,                                            			null
                               );
                if( m_InKliko )
                   PrintLineKliko(Код_Ценной_Бумаги,
                                  Код_Типа_Ценной_Бумаги,
                                  Код_Срока_Погашения,
                                  НаименованиеЭмитента,
                                  Код_Страны_Эмитента,
                                  Код_Сектора_Экономики_Эмитента,
                                  StrUpr(Наличие_Коротношений),
                                  "",
                                  "",
                                  double(ОстатокПРепо),
                                  FaceValueFI.ISO_Number,
                                  Номинальная_Цена,
                                  Рыночная_Цена,
                                  Номинальная_Стоимость_Пакета,
                                  Рыночная_Стоимость_Пакета,
                                  Код_Метода_Оценки,
                                  StorageType,
                                  Код_Места_Хранения,
                                  Особые_Пометки
                                  );
                end;
                if(m_InDelta)
                   DeltaReport.SaveLineP(NumberPart, 
                   String(i),
                   Код_Ценной_Бумаги,
                   Код_Типа_Ценной_Бумаги,
                   Код_Срока_Погашения,
                   НаименованиеЭмитента,
                   Код_Страны_Эмитента,
                   Код_Сектора_Экономики_Эмитента, 
                   Наличие_Коротношений,
                   double(ОстатокПРепо),
                   FaceValueFI.ISO_Number,
                   double(Номинальная_Цена),
                   double(Рыночная_Цена),
                   Номинальная_Стоимость_Пакета,
                   Рыночная_Стоимость_Пакета,
                   Код_Метода_Оценки,
                   StorageType,
                   Код_Места_Хранения,
                   Особые_Пометки);
                end;
                i=i+1;
             end;
             j=j+1;
          end;
       end;
     end;

     sql_FIID = "select fin.t_FIID, issuer.t_partyid as Issuer, "
              + " (CASE WHEN fin.t_SumPrecision > 0 THEN 6 ELSE 0 END) as SumPrecision "
              + "  from dfininstr_dbt fin, dparty_dbt issuer "
              + " where FIN.T_FI_KIND = " + FIKIND_AVOIRISS
              /*сделки с варрантами попадать не должны (пропишу явно на всякий случай)*/
              + "   and fin.t_AvoirKind != "+AVOIRISSKIND_WARRANT
              + "   and issuer.t_partyid = "
              + "          (CASE"
              + "             WHEN RSB_FIInstr.FI_AvrKindsEQ(fin.t_FI_Kind, "+AVOIRISSKIND_DEPOSITORY_RECEIPT+", fin.t_AvoirKind) = 1 "
              + "             THEN NVL ((SELECT RSI_RSB_FIInstr.FI_GetIssuerOnDate( parentfin.t_FIID, ? ) "
              + "                          FROM dfininstr_dbt parentfin  "
              + "                         WHERE parentfin.t_FIID = fin.t_ParentFI), -1 ) "
              + "          ELSE  RSI_RSB_FIInstr.FI_GetIssuerOnDate( fin.t_FIID, ? ) "
              + "          END ) "
              + "   and issuer.t_NotResident = 'X' ";

     if(m_ByKDU == true)
       sql_FIID = sql_FIID + " and Exists(select 1 from dscqracc_dbt qr where qr.t_FIID = fin.t_FIID) ";
     end;

     if (NumberPart == 1)
       sql_FIID = sql_FIID + " and Exists(select 1 from dmcaccdoc_dbt mcacc " +
                             "              join daccount_dbt acc on mcacc.t_account=acc.t_account and mcacc.t_chapter=acc.t_chapter and mcacc.t_currency=acc.t_code_currency " +
                             "             where mcacc.t_fiid = fin.t_fiid and (mcacc.t_account like '501%' or mcacc.t_account like '502%' or mcacc.t_account like '504%' or mcacc.t_account like '505%') " +
                             "               and acc.t_open_date <= ? and (acc.t_close_date > ? or acc.t_close_date = to_date('01.01.0001','DD.MM.YYYY')))";
       
     end;

     sql_FIID = sql_FIID +
                " order by Issuer, fin.t_FIID ";

     query_FIID = DL_RSDCommand(sql_FIID);

     query_FIID.AddParam(date(m_end_date));
     query_FIID.AddParam(date(m_end_date));
     if (NumberPart == 1)
       query_FIID.AddParam(date(m_end_date));
       query_FIID.AddParam(date(m_end_date));
     end;

     cnt_FIID = query_FIID.GetCount();

     if( cnt_FIID > 0 )
        InitProgress( cnt_FIID, "Формирование отчета", "Просмотр выпусков для раздела "+string(NumberPart) );

        DataFIID = query_FIID.Execute();
        while( DataFIID.MoveNext() )
          error = 0;

          var ClientStr = "";

          IsErrPrint = false;

          ПолучитьФинИн(DataFIID.FIID, m_Fininstr, m_Avoiriss);

          if( FI_IsInvestmentShare(m_Fininstr) and (not GetLinkedObject(12, OBJTYPE_AVOIRISS, m_Avoiriss, OBJTYPE_PARTY, party, date(m_end_date))) and (party.PartyID > 0) )
            ПолучитьСубъекта(party.PartyID, m_Issuer);
          else
            ПолучитьСубъекта(DataFIID.Issuer, m_Issuer);
          end;

          issuer = CDPParty(m_Issuer.rec.PartyID, m_end_date);
          fin    = CDPFinInstr(DataFIID.FIID, m_end_date);

          LineData.ClearArray();
          ОстатокПРепоВНеттинге.ClearArray();
          if( NumberPart == 1 )
             GetSaleRepoAmountNetting(m_Fininstr.rec.FIID);
          end;

          Код_Ценной_Бумаги = fin.ISIN();
          if( (error) or (Код_Ценной_Бумаги == "") )
            Код_Ценной_Бумаги = ПолучитьКодФинИн(m_Fininstr.rec.FIID, error, /*FICK_F404*/ 16);
          end;

          Код_Типа_Ценной_Бумаги = GetObjAttrName(m_Avoiriss, OBJTYPE_AVOIRISS, 56);

          Код_Срока_Погашения = "-";
          if( m_Avoiriss.rec.Termless == SET_CHAR )
             Код_Срока_Погашения = "LNT";
          elif( m_Fininstr.rec.DrawingDate != date(0,0,0) )
             var ДатаРазмещения = m_Avoiriss.rec.BegPlacementDate;
             if( ДатаРазмещения == date(0,0,0) )
                ДатаРазмещения = m_Fininstr.rec.Issued;
             end;
             if( ДатаРазмещения == date(0,0,0) )
                ДатаРазмещения = m_Avoiriss.rec.InCirculationDate;
             end;

             if( ДатаРазмещения != date(0,0,0) )
                if( ПериодБольшеОдногоГода(ДатаРазмещения, m_Fininstr.rec.DrawingDate) )
                   Код_Срока_Погашения = "LNT";
                else
                   Код_Срока_Погашения = "SHT";
                end;
             end;
          end;

          НаименованиеЭмитента = m_Issuer.rec.LatName;
          if( НаименованиеЭмитента == "" )
             НаименованиеЭмитента = m_Issuer.rec.Name;
          end;
          if( НаименованиеЭмитента == "" )
             НаименованиеЭмитента = m_Issuer.rec.ShortName;
          end;
          if( НаименованиеЭмитента == "" )
             НаименованиеЭмитента = GetPtName(m_Issuer.rec.PartyID, PTKN_LATSHORTNAME);
          end;
          if( НаименованиеЭмитента == "" )
             НаименованиеЭмитента = GetPtName(m_Issuer.rec.PartyID, PTKN_LATFULLNAME);
          end;

          GetPacketMarketPrice(Рыночная_Стоимость_Пакета, date(m_end_date), fin.FIID);

          cmd = DL_RSDCommand();
          query =   "select 1 from dmcaccdoc_dbt mcacc join daccount_dbt acc on mcacc.t_account=acc.t_account and mcacc.t_chapter=acc.t_chapter and mcacc.t_currency=acc.t_code_currency where mcacc.t_fiid = ? and mcacc.t_account like '505%' and acc.t_open_date <= ? and (acc.t_close_date > ? or acc.t_close_date = to_date('01.01.0001','DD.MM.YYYY'))";
          cmd.addParam(m_Fininstr.rec.FIID); /*1*/
          cmd.addParam(date(m_end_date));
          cmd.addParam(date(m_end_date));
          DataSet = cmd.Execute(query);
          if( DataSet.moveNext() )
            Код_Метода_Оценки = "ПБ";
          elif(not ПолучитьКурс( RateDef, fin.FaceValueFI(), fin.FIID(), RATETYPE_MARKET_PRICE_F404 ))
            Код_Метода_Оценки = RateDef.rec.Name;
          else
            Код_Метода_Оценки = "РЦ";
          end;

          if( NumberPart == 1 )
            Наличие_Коротношений = GetObjAttrName(m_Issuer, OBJTYPE_PARTY, 33, 2);
            if( Наличие_Коротношений == "")
              Наличие_Коротношений = "НЕТ";
            end;
          else
            Наличие_Коротношений = "";
          end;

          Код_Страны_Эмитента = GetNum3CountryCodeByLat3(issuer);

          Код_Сектора_Экономики_Эмитента = КодСектораЭкономикиЭмитента(issuer);

          if( (Код_Типа_Ценной_Бумаги == "SHS7") or (Код_Типа_Ценной_Бумаги == "DR2") or (Код_Типа_Ценной_Бумаги == "DOL2") or (Код_Типа_Ценной_Бумаги == "OTHER") )
             Номинальная_Цена = 0.0;
          else
             Номинальная_Цена = double(fin.FaceValue());
          end;

          LineData.ClearArray();

          //1. выборка счетов (без закрытого хранения)
          cmd = DL_RSDCommand();

          query =   "with acc as (select account.* "
                  + "               from daccount_dbt account, dparty_dbt owner, ddp_dep_dbt dep, dparty_dbt depowner "
                  + "              where account.t_Chapter = " + CHAPT5
                  + "                and instr(account.t_Type_Account, 'I') = 0 "
                  + "                and account.t_Kind_Account = 'П' "
                  + "                and account.t_Code_Currency = ? /*1*/"
                  + "                and owner.t_PartyID = account.t_Client "
                  + "                and dep.t_code = account.t_department "
                  + "                and depowner.t_partyid = dep.t_partyid "
                  + "                and depowner.t_NotResident = CHR(0)"
                  + "                and (depowner.t_NRCountry = CHR(1) or depowner.t_NRCountry = 'RUS') "
                  + "                and not exists (select 1 from dpartyown_dbt own where own.t_partyID = account.t_Client AND own.t_PartyKind = " + PTK_CENTRBANK + ") " // клиент не ЦБ
                  + "                and not exists (select 1 from dpartyown_dbt own where own.t_partyID = account.t_Client AND own.t_PartyKind = " + PTK_VEB + ") "; // клиент не Внешэкономбанк

          cmd.addParam(m_Fininstr.rec.FIID); /*1*/

          if( NumberPart == 1 )
            query = query + "        and account.t_Client = " + {OurBank};
          else
            query = query + "        and account.t_Client != " + {OurBank}
                          + "        and owner.t_NotResident = CHR(0) "
                          + "        and not exists (select 1 from dpartyown_dbt own where own.t_partyID = account.t_Client AND own.t_PartyKind = " + PTK_BANK + ") ";
          end;

          query = query
                  + "            ) ";

          if(m_ByKDU == true) //По данным КДУ
            query = query
                  + "select accA.t_Account, accA.t_Code_Currency, accA.t_Client, "
                  + "       QrAcc.t_DepoAccCode as AcntCode, QrAcc.t_StorageID, "
                  + "       ABS(rsi_rsb_account.restac( accA.T_ACCOUNT, accA.T_CODE_CURRENCY, ? /*2*/, accA.t_CHAPTER, null )) as RESTACC, "
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 1, ? /*3*/)), CHR(0)), CHR(0)) as IsPawn, "     //Залог
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 3, ? /*5*/)), CHR(0)), CHR(0)) as IsCorp, "     //Ограничение в связи с КД
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 4, ? /*6*/)), CHR(0)), CHR(0)) as IsOperBan, "  //Запрет на операции
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 5, ? /*7*/)), CHR(0)), CHR(0)) as IsArrest, "   //Арест
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 6, ? /*8*/)), CHR(0)), CHR(0)) as IsTrust, "    //Доверительное управление
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 8, ? /*9*/)), CHR(0)), CHR(0)) as IsRepo, "     //Переданы в РЕПО
                  + "       NVL(RTRIM(rsb_struct.getChar(rsi_rsb_kernel.GetNote("+OBJTYPE_QRACC+", LPAD(QrAcc.t_QRID, 10, '0'), 9, ? /*10*/)), CHR(0)), CHR(0)) as IsAccOwn "   //Счет владельца
                  + "  from dscqracc_dbt QrAcc, daccount_dbt accA, "
                  + "       (select DISTINCT accdoc.t_Place, accdoc.t_Currency "
                  + "          from acc, dmcaccdoc_dbt accdoc"
                  + "         where accdoc.t_Account = acc.t_Account "
                  + "           and accdoc.t_Chapter = acc.t_Chapter "
                  + "           and accdoc.t_Currency = acc.t_Code_Currency "
                  + "       ) pl "
                  + " where QrAcc.t_StorageID = pl.t_Place "
                  + "   and QrAcc.t_FIID = pl.t_Currency "
                  + "   and accA.t_AccountID = QrAcc.t_AccountID ";

            cmd.addParam(date(m_end_date)); /*2*/
            cmd.addParam(date(m_end_date)); /*3*/
            cmd.addParam(date(m_end_date)); /*4*/
            cmd.addParam(date(m_end_date)); /*5*/
            cmd.addParam(date(m_end_date)); /*6*/
            cmd.addParam(date(m_end_date)); /*7*/
            cmd.addParam(date(m_end_date)); /*8*/
            cmd.addParam(date(m_end_date)); /*9*/
            cmd.addParam(date(m_end_date)); /*10*/
                  
          else //По данным Депозитария
            query = query
                  + "select acc.t_Account, acc.t_Code_Currency, acc.t_Client, "
                  + "       acc.t_DepoAcc as PassivAcntAutoKey, acntP.t_Owner as PassivAcntOwner, depoacP.t_Type as PassiveAcntSettingType, "
                  + "       depoac.t_Type as AcntSettingType, acnt.t_Owner as AcntOwner, acntP.t_Code as AcntCode, "
                  + "       accsubrd.t_Rest as RESTACC, accA.t_DepoAcc as ActiveAcntAutoKey "
                  + "  from acc, "
                  + "       daccvanl_dbt accvanl, daccsub_dbt accsub, daccsubrd_dbt accsubrd, "
                  + "       daccount_dbt accA, ddepoacnt_dbt acnt, ddepoacnt_dbt acntP, "
                  + "       ddepoac_dbt depoac, ddepoac_dbt depoacP "
                  + " where acntP.t_AutoKey = acc.t_DepoRoot "
                  + "   and depoacP.t_ID = acntp.t_Type "
                  + "   and accvanl.t_Account = acc.t_Account "
                  + "   and accvanl.t_FIID = acc.t_Code_Currency "
                  + "   and accvanl.t_Chapter = acc.t_Chapter "
                  + "   and accsub.t_AccAnaliticsID = accvanl.t_AccAnaliticsID "
                  + "   and accsub.t_SpecialType = 0 "
                  + "   and accsubrd.t_AccAnaliticsID = accsub.t_AccAnaliticsID "
                  + "   and accsubrd.t_SubAccountID = accsub.t_SubAccountID "
                  + "   and accsubrd.t_Date_Carry IN (select NVL(MAX(ad.t_Date_Carry), ? /*8*/ ) "
                  + "                                   from daccsubrd_dbt ad "
                  + "                                  where ad.t_AccAnaliticsID=accsub.t_AccAnaliticsID "
                  + "                                    and ad.t_SubAccountID=accsub.t_SubAccountID "
                  + "                                    and ad.t_Date_Carry <= ? /*9*/) "
                  + "   and accA.t_Account = accsub.t_SubAccountCode "
                  + "   and accA.t_Code_Currency = acc.t_Code_Currency "
                  + "   and accA.t_Chapter = acc.t_Chapter "
                  + "   and acnt.t_AutoKey = accA.t_DepoRoot "
                  + "   and depoac.t_ID = acnt.t_Type ";

            cmd.addParam(date(m_end_date)); /*8*/
            cmd.addParam(date(m_end_date)); /*9*/

          end;

          query = query
                + " order by accA.t_Client ";

          
          DataSet = cmd.Execute(query);

          PrevClient = -1;
          var КДУОстатокОРЕПО = 0;
          while( DataSet.moveNext() )
            if(ClientStr != "")
              ClientStr = ClientStr + ",";
            end;

            ClientStr = ClientStr + string(DataSet.Client);

            client = CDPParty( DataSet.Client, m_end_date );

            if( DataSet.Client != PrevClient )
              if( NumberPart == 1 )
                GetRepoAmountNotDepo( m_Fininstr.rec.FIID ); //Фактически в КДУ эта ф-ция посчиает нам сумму по РЕПО
              end;
            end;

            if( Код_Ценной_Бумаги == "" )
              DP_ProtocolAddStr(NumberPart, DataSet.AcntCode, m_Fininstr.rec.FI_Code, DataSet.Account, DataSet.RESTACC, "Для ценной бумаги не определен ни ISIN, ни \"Код ЦБ для ф.404\"");
            end;

            if( Код_Типа_Ценной_Бумаги == "" )
              DP_ProtocolAddStr(NumberPart, DataSet.AcntCode, m_Fininstr.rec.FI_Code, DataSet.Account, DataSet.RESTACC, "Не определен код типа ценной бумаги в категории \"Код ЦБ для формы 404\"");
            end;

            if( Код_Метода_Оценки == "" )
              DP_ProtocolAddStr(NumberPart, DataSet.AcntCode, m_Fininstr.rec.FI_Code, DataSet.Account, DataSet.RESTACC, "Не определен код использованного метода оценки рыночной стоимости ценных бумаг");
            end;

            if( NumberPart == 2 )
               Код_Клиента = GetClientCode(client);
               Код_Региона_Клиента = GetClientRegCode(client);
            else
               Код_Клиента = "";
               Код_Региона_Клиента = "";
            end;

            if(m_ByKDU == true)
              Код_Места_Хранения = GetStorageCodeKDU(DataSet.StorageID);
            else
              Код_Места_Хранения = GetStorageCode(DataSet.ActiveAcntAutoKey, DataSet.AcntOwner, DataSet.AcntSettingType);
            end;
            if( Код_Места_Хранения == "" )
               DP_ProtocolAddStr(NumberPart, DataSet.AcntCode, m_Fininstr.rec.FI_Code, DataSet.Account, DataSet.RESTACC, "Нет условия по определению места хранения");
            end;

            if(m_ByKDU == true)
              Особые_Пометки = ПолучитьОсобыеПометкиКДУ(DataSet.IsPawn, DataSet.IsCorp, DataSet.IsOperBan, DataSet.IsArrest, DataSet.IsTrust, DataSet.IsRepo, DataSet.IsAccOwn);
            else
              Особые_Пометки = ПолучитьОсобыеПометки(DataSet.PassivAcntAutoKey, DataSet.PassivAcntOwner, DataSet.PassiveAcntSettingType, DataSet.ActiveAcntAutoKey, DataSet.AcntOwner, DataSet.AcntSettingType, false);
            end;

            if( (m_ByKDU == true)  )
              КДУОстатокОРЕПО = ОстатокОРепоБезДепо.GetRestByPlace(Код_Места_Хранения);
              ОстатокОРепоБезДепо.SetRestByPlace(0,Код_Места_Хранения);
              ОстатокПРепоБезДепо.SetRestByPlace(0,Код_Места_Хранения);
            end;
            if( NumberPart == 1 )
              //В КДУ суммы по РЕПО нам обеспечит ф-ция GetRepoAmountNotDepo, а значения ОстатокПРепо и ОстатокОРепо пусть будут нулевыми
              if( (m_ByKDU == false) and (GetRepoAmount(@ОстатокПРепо, @ОстатокОРепо, DataSet.Code_Currency, DataSet.PassivAcntAutoKey, DataSet.ActiveAcntAutoKey)) )
                ОстатокЦБ = double(DataSet.RESTACC - ОстатокОРепо - ОстатокОРепоБезДепо.GetRestByPlace(Код_Места_Хранения));
                ОстатокОРепоБезДепо.SetRestByPlace(0,Код_Места_Хранения);
              else
                ОстатокЦБ = double(DataSet.RESTACC - КДУОстатокОРЕПО); 
                ОстатокОРепоБезДепо.SetRestByPlace(0,Код_Места_Хранения);
              end;
            else
              ОстатокЦБ = double(DataSet.RESTACC);
            end;

            Номинальная_Стоимость_Пакета = double(round(double(Номинальная_Цена), 6)*round(double(ОстатокЦБ), 6));
            if (Код_Метода_Оценки == "ПБ")
                FI_GetCurrentNominal(m_Fininstr.rec.FIID, m_end_date, Рыночная_Цена);
                Рыночная_Цена = round((Рыночная_Цена + НКД(m_Fininstr.rec.FIID, ОстатокЦБ, m_end_date)), 6);
                Рыночная_Стоимость_Пакета = Рыночная_Цена * round(double(ОстатокЦБ), 6);
            elif (ОстатокЦБ > 0)
                Рыночная_Цена = double(round(Рыночная_Стоимость_Пакета/round(double(ОстатокЦБ), 6), 6));
                Рыночная_Стоимость_Пакета = Рыночная_Цена * round(double(ОстатокЦБ), 6);

            else
                Рыночная_Цена = 0.0;
            end;
            ПолучитьФинИн(m_FinInstr.rec.FaceValueFI, FaceValueFI);

            if( double(ОстатокЦБ) != 0 )
              LineData.AddByPlace(Код_Ценной_Бумаги,
                                  Код_Типа_Ценной_Бумаги,
                                  НаименованиеЭмитента,
                                  StrUpr(Наличие_Коротношений),
                                  Код_Клиента,
                                  Код_Страны_Эмитента,
                                  double(ОстатокЦБ),
                                  DataFIID.SumPrecision,
                                  FaceValueFI.ISO_Number,
                                  Номинальная_Цена,
                                  Рыночная_Цена,
                                  Номинальная_Стоимость_Пакета,
                                  Рыночная_Стоимость_Пакета,
                                  Код_Метода_Оценки,
                                  Код_Места_Хранения,
                                  Особые_Пометки,
                                  Код_Срока_Погашения,
                                  Код_Региона_Клиента,
                                  Код_Сектора_Экономики_Эмитента,
                                  StorageType
                                 );
            end;

            ОстатокПРепо = ОстатокПРепо - ОстатокОРепо;
            /* печатаем дополнительную строку для ц/б в прямом РЕПО */
            if( (NumberPart == 1) and ((ОстатокПРепо > 0) or (ОстатокПРепоВНеттинге.GetRestByPlace(Код_Места_Хранения) > 0) or (ОстатокПРепоБезДепо.GetRestByPlace(Код_Места_Хранения) > 0)) )
              if(m_ByKDU == true)
                Особые_Пометки = "ЗБ";
              else
                Особые_Пометки = ПолучитьОсобыеПометки(DataSet.PassivAcntAutoKey, DataSet.PassivAcntOwner, DataSet.PassiveAcntSettingType, DataSet.ActiveAcntAutoKey, DataSet.AcntOwner, DataSet.AcntSettingType, true);
              end;

              ОстатокПРепо = double(ОстатокПРепо+ОстатокПРепоВНеттинге.GetRestByPlace(Код_Места_Хранения)+ОстатокПРепоБезДепо.GetRestByPlace(Код_Места_Хранения));
       
              ОстатокПРепоВНеттинге.SetRestByPlace(0,Код_Места_Хранения);
              ОстатокПРепоБезДепо.SetRestByPlace(0,Код_Места_Хранения);

              Номинальная_Стоимость_Пакета = double(round(double(Номинальная_Цена), 6)*round(double(ОстатокПРепо), 6));
              if (Код_Метода_Оценки == "ПБ")
                FI_GetCurrentNominal(m_Fininstr.rec.FIID, m_end_date, Рыночная_Цена);
                Рыночная_Цена = round((Рыночная_Цена + НКД(m_Fininstr.rec.FIID, ОстатокПРепо, m_end_date)), 6);
                Рыночная_Стоимость_Пакета = Рыночная_Цена * round(double(ОстатокПРепо), 6);
              elif (ОстатокПРепо > 0)
                Рыночная_Цена = double(round(Рыночная_Стоимость_Пакета/round(double(ОстатокПРепо), 6), 6));
                Рыночная_Стоимость_Пакета = Рыночная_Цена * round(double(ОстатокПРепо), 6);
              else
                Рыночная_Цена = 0.0;
              end;

              if( (Рыночная_Цена == 0) or (Рыночная_Цена == 0.00) )
                 DP_ProtocolAddStr(NumberPart, DataSet.AcntCode, m_Fininstr.rec.FI_Code, DataSet.Account, DataSet.RESTACC, "Не определена рыночная цена ценной бумаги (предупреждение)");
              end;
              
              ПолучитьФинИн(m_FinInstr.rec.FaceValueFI, FaceValueFI);

              LineData.AddByPlace(Код_Ценной_Бумаги,
                                  Код_Типа_Ценной_Бумаги,
                                  НаименованиеЭмитента,
                                  StrUpr(Наличие_Коротношений),
                                  Код_Клиента,
                                  Код_Страны_Эмитента,
                                  double(ОстатокПРепо),
                                  DataFIID.SumPrecision,
                                  FaceValueFI.ISO_Number,
                                  Номинальная_Цена,
                                  Рыночная_Цена,
                                  Номинальная_Стоимость_Пакета,
                                  Рыночная_Стоимость_Пакета,
                                  Код_Метода_Оценки,
                                  Код_Места_Хранения,
                                  Особые_Пометки,
                                  Код_Срока_Погашения,
                                  Код_Региона_Клиента,
                                  Код_Сектора_Экономики_Эмитента,
                                  StorageType
                                 );

              ОстатокПРепо = $0;
            end;

            PrevClient = DataSet.Client;
            IsErrPrint = true;
          end;

          ПечататьЗаголовок();
          ПечататьОсновныеСтроки();
          ПечататьДопБезДепоСтроки();
          ПечататьДопНеттингСтроки();

          LineData.ClearArray();
          ОстатокПРепоВНеттинге.ClearArray();
          ОстатокПРепоБезДепо.ClearArray();
          ОстатокОРепоБезДепо.ClearArray();

          UseProgress( Num = Num + 1 );
        end;

     end;

     RemProgress();

     return i-1;
  end;

  private macro Create()
     var Executer = DepoExecuter({Oper});
     var E_mail = Executer.GetEmail();

     GetRegistryValue("SECUR\\ВЕДЕНИЕ КДУ", V_BOOL, m_ByKDU);

     DP_BeginProtocol();
     if(m_InKliko)
       Dl_CallInsertStat(DL_OUTREPORT_KLIKO);
       if( not Kliko_OpenTxtFile( this.GetEndDate() ) )
         return;
       end;
     end;
    
    if(m_InDelta)
      DeltaReport = F404DeltaXML(GetOKUD(), GetReportKind(), m_end_date, GetPeriodicity());
      DeltaReport.PrintInfo();
      DeltaReport.BeginData404();
    end;
     
     if( m_formPart1 )
        m_Part1Counter = CreatePart(1);
        if(m_InDelta)
          DeltaReport.AddDataPart1();
        end;

        if( m_Part1Counter == 0 )
           PrintHead1();
           PrintEmptyLine();
        end;
     end;

     if( m_formPart2 )
        if(m_ByKDU == true)
          m_Part2Counter = 0;
        else
          m_Part2Counter = CreatePart(2);
        end;
        if(m_InDelta)
          DeltaReport.AddDataPart2();
        end;

        if( m_Part2Counter == 0 )
           PrintHead2();
           PrintEmptyLine();
        end;
     end;

     EndTable();

     if( E_mail == "" )
        FindAdressContactValue({OurBank}, PTADDR_LEGAL, CNTADR_E_MAIL, E_mail);
     end;

     PrintFormatString( ReportFooter,
                        "A_18.1" , m_Part1Counter,
                        "A_18.2",  m_Part2Counter,
                        "B_9.1",   DP_GetFirstPersonPost(),
                        "B_9.2",   DP_GetFirstPersonName(),
                        "B_10",    Executer.Name,
                        "B_11.1" , Executer.PhoneNumber,
                        "B_11.3" , E_mail
                      );

     //печатаем протокол
     SetActiveSheet( "protocol" );
     PrintFormatString( ProtocolText,
                        "H_1.2" , Date() );
     RegisterTable( "TablePRT", ProtocolHeader,
                    "PRT_1", "PRT_2", "PRT_3", "PRT_4", "PRT_5" );

     var ПрЧасть = 0;
     var Часть         = 0;
     var Счет_Депо     = "";
     var Код_ЦБ        = "";
     var Лицевой_Счет  = "";
     var Количество_ЦБ = "";
     var Причина       = "";

     while( DP_ProtocolGetNext() )
       Часть = DP_ProtocolGetNextFld();

       if( (ПрЧасть != Часть) and ( m_formPart1 ) and (Часть == 1) )
         merge("PRT_1", "PRT_5");
         PrintTableLine( "PRT_1", string("Лицевые счета уполномоченного банка с ц/б нерезидентов, имеющие ошибки при формировании отчета"), null );
       end;

       if( (ПрЧасть != Часть) and ( m_formPart2 ) and (Часть == 2) )
         merge("PRT_1", "PRT_5");
         PrintTableLine( "PRT_1", string("Лицевые счета клиентов уполномоченного банка с ц/б нерезидентов, имеющие ошибки при формировании отчета"), null );
       end;

       Счет_Депо     = DP_ProtocolGetNextFld();
       Код_ЦБ        = DP_ProtocolGetNextFld();
       Лицевой_Счет  = DP_ProtocolGetNextFld();
       Количество_ЦБ = DP_ProtocolGetNextFld();
       Причина       = DP_ProtocolGetNextFld();

       PrintTableLine( "PRT_1",   Счет_Депо,     null,
                       "PRT_2",   Код_ЦБ,        null,
                       "PRT_3",   Лицевой_Счет,  null,
                       "PRT_4:r", Количество_ЦБ, null,
                       "PRT_5",   Причина,       null
                      );
       ПрЧасть = Часть;
     end;

     DP_EndProtocol();

     if(m_InKliko)
       Kliko_CloseTxtFile( true );
     end;
     if(m_InDelta)
       DeltaReport.FinishData();
       DeltaReport.FinishData();
       DeltaReport.PrintProtocol();
       DeltaReport.CreateXMLFile();
       /*
       if(DeltaReport.CreateXMLFile())
         msgbox("Создан файл " + DeltaReport.GetFileName());
       else
         msgbox("Ошибка экспорта в Delta");
       end;*/

       var delta_file_name_term = "$" + SC_GetFullPath(true) + DeltaReport.GetFileName();
        if(ExistFile(delta_file_name_term))
          RemoveFile(delta_file_name_term);
        end;
        if (not copyFile(DeltaReport.GetFileName(),delta_file_name_term,true,"Копирование на терминал"))
          msgbox("Ошибка при копировании " + DeltaReport.GetFileName() + " на терминал");
        else
          RemoveFile(DeltaReport.GetFileName());
        end;

        if (not DeltaReport.createTextProtocol())
          msgbox("Ошибка при создании протокола экспорта в ПК Дельта");
        end;
     end;
  end;

  initDL_CReportTemplate( NULL , "f404_mz_2293.xls" );
end;

macro GenRep( _end_date: date,
              _rep_date: date,
              _iDepart:integer,
              _formPart1:bool,
              _formPart2:bool,
              _ToExcel:bool,
              _is_ap:bool,
              _delta:bool
              )

  private macro GetAuditMsg():String
    var msg:string = "";
    var dep:string = "";
    var month:integer = 0;
    var year:integer = 0;
    
    CB_GetDepartmentCodeAndName(_iDepart, NULL, dep);

    DateSplit(_end_date, null, month, year);

    msg           = "Отчет:              Форма №0409404\n" +
                    "\n" +
                    "Отчетный период:    " + PeriodName_GetMonthsAndQuart( month, year) + "\n" +
                    "Филиал:             " + dep + "\n" +
    IIF(_formPart1, "Раздел 1:           ЦБ банка, выпущенные нерезидентами\n", "") +
    IIF(_formPart2, "Раздел 2:           ЦБ клиентов-резидентов, выпущенные нерезидентами\n", "") +
                    "\n----------------------------------------\n";

    return msg;
  end;

  var Rep = DP_RepForm404(_end_date, _rep_date, _iDepart, _formPart1, _formPart2, _ToExcel, _is_ap, _delta);

  Rep.Run(null, GetAuditMsg());

  return 0;
end;
