/*
$Name: Depo2Upgr.mac
$Module: Депозитарий
$Description: Макрос обновления Депозитария на версию Depo 2.0
*/

import DPInter, DealsInter, "dpstdrep.mac", "dlcnst.inc", "dpAdmoCLOB.mac", "SpRepFun.mac", "pt_lib.mac";

private const DEPOACAPROLE_OPERATOR = 1,  //Оператор     
              DEPOACAPROLE_CURATOR  = 2,  //Попечитель   
              DEPOACAPROLE_MANAGER  = 3;  //Распорядитель

private var upgrErr = TArray();

macro upgr_msgbox(msg)
  upgrErr[upgrErr.size] = msg;
end;

private macro error(msg)
  msgbox("ERROR:"+msg);
end;

private macro warning(msg)
  msgbox("WARNING:"+msg);
end;

private macro message(msg)
  msgbox("MESSAGE:"+msg);
end;

private macro L_Z( num, len )
  var str1, len1;
  str1 = trim( string( num ) );
  len1 = strlen( str1 );
  if ( len1 >= len ) return str1;
  else  return  mkstr("0", len-len1 ) + str1;
  end;
end;

private macro L_P( str, len )
  var str1, len1;
  str1 = trim( string( str ) );
  len1 = strlen( str1 );
  if ( len1 >= len ) return str1;
  else  return  mkstr(" ", len-len1 ) + str1;
  end;
end;

//создать временную таблицу соответствия ИК
macro RecreateInvCorrTable()
  var sql;

  sql = "DECLARE \n"
      +  " v_err EXCEPTION; \n"
      +  " PRAGMA EXCEPTION_INIT( v_err, -955 );\n"
      + "BEGIN EXECUTE IMMEDIATE 'CREATE TABLE dinvcorrtable_dbt"
      + " ( t_CertifID  NUMBER(10), " /* идентификатор старой ИК */
      +   " t_InvCardID NUMBER(10) " /* идентификатор новой ИК */
      +   " )';\n"  /* признак детализированности поручения */
      + "EXCEPTION WHEN v_err THEN NULL; \n"
      + "END; \n";
  SQL_Execute(sql,"Создание временной таблицы", false);

  SQL_Execute("DELETE FROM dinvcorrtable_dbt");

  sql =  " DECLARE \n"
        +"   E_NAME_EXISTS EXCEPTION; \n"
        +"   PRAGMA EXCEPTION_INIT(E_NAME_EXISTS, -955); \n"
        +"BEGIN \n"
        +"   BEGIN \n"
        +"      EXECUTE IMMEDIATE 'CREATE INDEX dinvcorrtable_dbt_IDX0 ON dinvcorrtable_dbt (T_CERTIFID ASC, T_INVCARDID ASC)'; \n"
        +"      EXCEPTION WHEN E_NAME_EXISTS THEN NULL; \n"
        +"   END; \n"
        +"END; \n";
  SQL_Execute(sql,"Создание индекса", false);

  sql =  " DECLARE \n"
        +"   E_NAME_EXISTS EXCEPTION; \n"
        +"   PRAGMA EXCEPTION_INIT(E_NAME_EXISTS, -955); \n"
        +"BEGIN \n"
        +"   BEGIN \n"
        +"      EXECUTE IMMEDIATE 'CREATE INDEX DCERTIF_UPGR_DBT_IDX0 ON DCERTIF_UPGR_DBT (T_XID ASC, T_DEPARTMENT ASC)'; \n"
        +"      EXCEPTION WHEN E_NAME_EXISTS THEN NULL; \n"
        +"   END; \n"
        +"END; \n";
  SQL_Execute(sql,"Создание индекса", false);

  sql =  " DECLARE \n"
        +"   E_NAME_EXISTS EXCEPTION; \n"
        +"   PRAGMA EXCEPTION_INIT(E_NAME_EXISTS, -955); \n"
        +"BEGIN \n"
        +"   BEGIN \n"
        +"      EXECUTE IMMEDIATE 'CREATE INDEX DDEPOADMO_UPGR_DBT_IDX0 ON DDEPOADMO_UPGR_DBT (T_ITEM ASC, T_OPERKIND ASC)'; \n"
        +"      EXCEPTION WHEN E_NAME_EXISTS THEN NULL; \n"
        +"   END; \n"
        +"END; \n";
  SQL_Execute(sql,"Создание индекса", false);


  OnError(er)
    error(er.module+ " "+er.line+" "+er.message);

end;

//создать пакет
macro CreatePackage()
  var q = "";


q = " CREATE OR REPLACE PACKAGE rsb_depo2upgr AS                                                                                   "
+"    FUNCTION getMoney (p_Value BLOB, p_RecOffset NUMBER DEFAULT 0) RETURN NUMBER;                                                "
+"    FUNCTION getDouble (p_Value BLOB, p_RecOffset NUMBER DEFAULT 0) RETURN NUMBER;                                               "
+"  END rsb_depo2upgr;                                                                                                             ";

SQL_Execute(q, "Создание пакета", true );
q = "  CREATE OR REPLACE PACKAGE BODY rsb_depo2upgr AS                                                                             "
+"   FUNCTION bitNot (operator IN NUMBER) RETURN NUMBER IS                                                                         "
+"     BEGIN                                                                                                                       "
+"       IF operator >= 0 THEN                                                                                                     "
+"         RETURN(4294967295 - operator);                                                                                          "
+"       ELSE                                                                                                                      "
+"         RETURN(-1 - operator);                                                                                                  "
+"       END IF;                                                                                                                   "
+"   END bitNot;                                                                                                                   "
+"                                                                                                                                 "
+"                                                                                                                                 "
+"   FUNCTION getMoneyPriv (p_Expo NUMBER, p_LeaDi NUMBER, p_TraDi0 NUMBER, p_TraDi1  NUMBER) RETURN NUMBER AS                     "
+"       v_Expo    NUMBER;                                                                                                         "
+"       v_LeaDi   NUMBER;                                                                                                         "
+"       v_TraDi0  NUMBER;                                                                                                         "
+"       v_TraDi1  NUMBER;                                                                                                         "
+"     BEGIN                                                                                                                       "
+"       v_Expo   := p_Expo;                                                                                                       "
+"       v_LeaDi  := p_LeaDi;                                                                                                      "
+"       v_TraDi0 := p_TraDi0;                                                                                                     "
+"       v_TraDi1 := p_TraDi1;                                                                                                     "
+"       IF (v_LeaDi < 0) THEN                                                                                                     "
+"         v_LeaDi  := bitNot(v_LeaDi);                                                                                            "
+"         v_TraDi0 := bitNot(v_TraDi0);                                                                                           "
+"         v_TraDi1 := bitNot(v_TraDi1);                                                                                           "
+"                                                                                                                                 "
+"         IF (v_LeaDi < 0 ) THEN                                                                                                  "
+"           v_LeaDi := power(2,32) + v_LeaDi;                                                                                     "
+"         END IF;                                                                                                                 "
+"         IF (v_TraDi0 < 0 ) THEN                                                                                                 "
+"           v_TraDi0 := power(2,32) + v_TraDi0;                                                                                   "
+"         END IF;                                                                                                                 "
+"         IF (v_TraDi1 < 0 ) THEN                                                                                                 "
+"           v_TraDi1 := power(2,32) + v_TraDi1;                                                                                   "
+"         END IF;                                                                                                                 "
+"                                                                                                                                 "
+"         v_TraDi1 := v_TraDi1 + 1;                                                                                               "
+"         IF (v_TraDi1 = power(2,32)) THEN                                                                                        "
+"           v_TraDi1 := 0;                                                                                                        "
+"           v_TraDi0 := v_TraDi0 + 1;                                                                                             "
+"           IF (v_TraDi0 = power(2,32)) THEN                                                                                      "
+"             v_TraDi0 := 0;                                                                                                      "
+"             v_LeaDi := v_LeaDi + 1;                                                                                             "
+"           END IF;                                                                                                               "
+"         END IF;                                                                                                                 "
+"         RETURN -(v_LeaDi*power(2,64) + v_TraDi0*power(2,32) + v_TraDi1)/power(10,v_Expo);                                       "
+"       END IF;                                                                                                                   "
+"       IF (v_LeaDi < 0 ) THEN                                                                                                    "
+"         v_LeaDi := power(2,32) + v_LeaDi;                                                                                       "
+"       END IF;                                                                                                                   "
+"       IF (v_TraDi0 < 0 ) THEN                                                                                                   "
+"         v_TraDi0 := power(2,32) + v_TraDi0;                                                                                     "
+"       END IF;                                                                                                                   "
+"       IF (v_TraDi1 < 0 ) THEN                                                                                                   "
+"         v_TraDi1 := power(2,32) + v_TraDi1;                                                                                     "
+"       END IF;                                                                                                                   "
+"       RETURN (v_LeaDi*power(2,64) + v_TraDi0*power(2,32) + v_TraDi1)/power(10,v_Expo);                                          "
+"     END getMoneyPriv;                                                                                                           "
+"                                                                                                                                 "
+"                                                                                                                                 "
+"   FUNCTION getMoney (p_Value BLOB, p_RecOffset NUMBER DEFAULT 0) RETURN NUMBER AS                                               "
+"       v_Expo    NUMBER;                                                                                                         "
+"       v_LeaDi   NUMBER;                                                                                                         "
+"       v_TraDi0  NUMBER;                                                                                                         "
+"       v_TraDi1  NUMBER;                                                                                                         "
+"     BEGIN                                                                                                                       "
+"       v_Expo   := utl_raw.cast_to_binary_integer(dbms_lob.substr(p_Value, 2, p_RecOffset + 2), utl_raw.little_endian);          "
+"       v_LeaDi  := utl_raw.cast_to_binary_integer(dbms_lob.substr(p_Value, 4, p_RecOffset + 4), utl_raw.little_endian);          "
+"       v_TraDi0 := utl_raw.cast_to_binary_integer(dbms_lob.substr(p_Value, 4, p_RecOffset + 8), utl_raw.little_endian);          "
+"       v_TraDi1 := utl_raw.cast_to_binary_integer(dbms_lob.substr(p_Value, 4, p_RecOffset + 12), utl_raw.little_endian);         "
+"                                                                                                                                 "
+"       RETURN getMoneyPriv(v_Expo, v_LeaDi, v_TraDi0, v_TraDi1);                                                                 "
+"     END getMoney;                                                                                                               "
+"                                                                                                                                 "
+" FUNCTION getDouble (p_Value BLOB, p_RecOffset NUMBER DEFAULT 0) RETURN NUMBER AS                                                "
+"     v_raw    RAW(8);                                                                                                            "
+"     v_Expo   NUMBER;                                                                                                            "
+"     v_Manti  NUMBER;                                                                                                            "
+"     v_res    NUMBER;                                                                                                            "
+"     v_sign   BOOLEAN := FALSE;                                                                                                  "
+"     v_pwbase INT     := -1075;                                                                                                  "
+"  BEGIN                                                                                                                          "
+"     v_raw := utl_raw.reverse(dbms_lob.substr(p_Value, 8, p_RecOffset));                                                         "
+"     v_Expo := to_number(substr(v_raw,1,3),'FMXXXXXXXXXXXXXXXX');                                                                "
+"     v_Manti := to_number('1'||substr(v_raw,4,13),'FMXXXXXXXXXXXXXXXX');                                                         "
+"                                                                                                                                 "
+"     IF v_expo >= power(2, 11) THEN                                                                                              "
+"       v_sign := TRUE;                                                                                                           "
+"       v_Expo := v_Expo - power(2, 11);                                                                                          "
+"     END IF;                                                                                                                     "
+"     v_Expo := v_Expo + v_pwbase;                                                                                                "
+"     v_res := power(2,v_Expo);                                                                                                   "
+"     v_res := v_Manti * v_res;                                                                                                   "
+"     IF v_sign THEN                                                                                                              "
+"       v_res := -v_res;                                                                                                          "
+"     END IF;                                                                                                                     "
+"     RETURN v_res;                                                                                                               "
+"   END getDouble;                                                                                                                "
+"                                                                                                                                 "
+"  END rsb_depo2upgr;                                                                                                             ";
  

  SQL_Execute(q, "Создание пакета", true );

  OnError(er)
    error(er.module+ " "+er.line+" "+er.message);

end;

private macro DropPackage()
  SQL_Execute(" DROP PACKAGE BODY rsb_depo2upgr; ", "Удаление пакета", true );
  SQL_Execute(" DROP PACKAGE rsb_depo2upgr; ", "Удаление пакета", true );

  OnError(er)
    error(er.module+ " "+er.line+" "+er.message);

end;

////////


private macro QueryGetBlobIntSide(offset:@integer, size:integer, Name:string, isNew:bool)
  var str;
  var addStr = "";
  
  if(isNew == true)
    addStr = "t_BuffSize+";
  end;

  str =   " utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+size+","+addStr+string(offset)+"), 2) as " + Name;

  offset = offset+size;

  return str;
end;

private macro QueryGetBlobInt(offset:@integer, size:integer, Name:string)
  var _offset = offset;
  var str = QueryGetBlobIntSide(@_offset, size, "old"+Name, false) + ", ";
  
  _offset = offset; //необходимо вернуть смещение, чтобы дважды оно не увеличилось
  str = str + QueryGetBlobIntSide(@_offset, size, "new"+Name, true);

  offset = _offset;
  return str;
end;

private macro QueryGetBlobInt1(offset:@integer, Name:string)
  return QueryGetBlobInt(@offset, 1, Name);
end;

private macro QueryGetBlobInt16(offset:@integer, Name:string)
  return QueryGetBlobInt(@offset, 2, Name);
end;

private macro QueryGetBlobInt32(offset:@integer, Name:string)
  return QueryGetBlobInt(@offset, 4, Name);
end;

private macro QueryGetBlobStringSide(offset:@integer, Name:string, isNew:bool, StrSize:integer)
  var str;
  var addStr = "";
  
  if(isNew == true)
    addStr = "t_BuffSize+";
  end;
  
  str =   " utl_raw.cast_to_varchar2(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+StrSize+","+addStr+string(offset)+")) as " + Name;

  offset = offset+StrSize;

  return str;
end;

private macro QueryGetBlobString(offset:@integer, Name:string, StrSize:integer)
  var _offset = offset;
  var str = QueryGetBlobStringSide(@_offset, "old"+Name, false, StrSize) + ", ";;
  
  _offset = offset; //необходимо вернуть смещение, чтобы дважды оно не увеличилось
  str = str + QueryGetBlobStringSide(@_offset, "new"+Name, true, StrSize);

  offset = _offset;
  return str;
end;

private macro QueryGetBlobDateSide(offset:@integer, Name:string, isNew:bool)
  var str;
  var daySize = 1, monthSize = 1, yearSize = 2;
  var addStr = "";
  
  if(isNew == true)
    addStr = "t_BuffSize+";
  end;
  
  str =   " to_date(      (case when utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+daySize+","+addStr+string(offset)+")) = 0 then 1 else utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+daySize+","+addStr+string(offset)+")) end) || " 
        + "        '.' || (case when utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+monthSize+","+addStr+string(offset)+" + 1)) = 0 then 1 else utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+monthSize+","+addStr+string(offset)+" + 1)) end) || " 
        + "        '.' || (case when utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+yearSize+","+addStr+string(offset)+" + 2),2)  = 0 then 1 else utl_raw.cast_to_binary_integer(dbms_lob.substr(T_FMTBLOBDATA_XXXX,"+yearSize+","+addStr+string(offset)+" + 2),2)  end) "
        + "       ,'DD.MM.YYYY') as " + Name;

  offset = offset+daySize+monthSize+yearSize;

  return str;
end;

private macro QueryGetBlobDate(offset:@integer, Name:string)
  var _offset = offset;
  var str = QueryGetBlobDateSide(@_offset, "old"+Name, false) + ", ";
  
  _offset = offset; //необходимо вернуть смещение, чтобы дважды оно не увеличилось 
  str = str + QueryGetBlobDateSide(@_offset, "new"+Name, true);

  offset = _offset;
  return str;
end;

private macro QueryGetBlobMoneySide(offset:@integer, Name:string, isNew:bool)
  var str;
  var addStr = "";
  var size = 16;
  
  if(isNew == true)
    addStr = "t_BuffSize+";
  end;
  
  str = " rsb_depo2upgr.getmoney(T_FMTBLOBDATA_XXXX, "+addStr+string(offset)+") as " + Name;

  offset = offset+size;

  return str;
end;

private macro QueryGetBlobMoney(offset:@integer, Name:string)
  var _offset = offset;
  var str = QueryGetBlobMoneySide(@_offset, "old"+Name, false) + ", ";
  
  _offset = offset; //необходимо вернуть смещение, чтобы дважды оно не увеличилось 
  str = str + QueryGetBlobMoneySide(@_offset, "new"+Name, true);

  offset = _offset;
  return str;
end;

private macro QueryGetBlobDoubleSide(offset:@integer, Name:string, isNew:bool)
  var str;
  var addStr = "";
  
  if(isNew == true)
    addStr = "t_BuffSize+";
  end;
  
  str = " rsb_depo2upgr.getdouble(T_FMTBLOBDATA_XXXX, "+addStr+string(offset)+") as " + Name;

  offset = offset+8;

  return str;
end;

private macro QueryGetBlobDouble(offset:@integer, Name:string)
  var _offset = offset;
  var str = QueryGetBlobDoubleSide(@_offset, "old"+Name, false) + ", ";
  
  _offset = offset; //необходимо вернуть смещение, чтобы дважды оно не увеличилось 
  str = str + QueryGetBlobDoubleSide(@_offset, "new"+Name, true);

  offset = _offset;
  return str;
end;


//обновляем АО по л/с
//переносим данные из BLOB в CLOB
class (TDepoAdmoClobACC) TUpgrDepoAdmoACC

  macro ExecUpgrade()
    var query, cmd, DataSet;
    var offset;
    var cnt = 0, num = 0;
    var err = 0;

    message("Обновление АО по лицевым счетам.");

    query =         " select t_AdmOprID, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "DepoRoot")           + ", "
                  + QueryGetBlobInt32(@offset,  "DepoRootType")       + ", "
                  + QueryGetBlobInt32(@offset,  "DepoAcc")            + ", "
                  + QueryGetBlobString(@offset, "Kind_Account", 3)    + ", "
                  + QueryGetBlobInt32(@offset,  "Client")             + ", "
                  + QueryGetBlobString(@offset, "Account", 26)        + ", "
                  + QueryGetBlobInt1(@offset,   "IsEmissiveCurrency") + ", "
                  + QueryGetBlobInt32(@offset,  "Code_Currency")      + ", "
                  + QueryGetBlobInt32(@offset,  "Block")              + ", "
                  + QueryGetBlobString(@offset, "Balance", 26)        + ", "
                  + QueryGetBlobInt32(@offset,  "IndoorStorage")      + ", "
                  + QueryGetBlobString(@offset, "Open_Close", 1);
                   
    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_Item = " + SPDP_FACE_ACCOUNT
                  + "    and t_OperKind IN ("+SPAO_CON_REGISTERING+", "+SPAO_CON_CLOSING+")";


    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обновлению "+cnt+" АО");
    if(cnt > 0)

      InitProgress( cnt, "Идет обновление", "Обновление АО по л/с" );

      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи ddepoadmo_upgr_dbt.t_AdmOprID = " + DataSet.AdmOprID);

        oldData = TData();
        oldData.DepoRoot           = int(DataSet.oldDepoRoot);       
        oldData.DepoRootType       = int(DataSet.oldDepoRootType);   
        oldData.DepoAcc            = int(DataSet.oldDepoAcc);        
        oldData.Kind_Account       = string(DataSet.oldKind_Account);    
        oldData.Client             = int(DataSet.oldClient);         
        oldData.Account            = string(DataSet.oldAccount);         
        oldData.IsEmissiveCurrency = DataSet.oldIsEmissiveCurrency;
        oldData.Code_Currency      = int(DataSet.oldCode_Currency);  
        oldData.Block              = int(DataSet.oldBlock);          
        oldData.Balance            = string(DataSet.oldBalance);         
        oldData.IndoorStorage      = int(DataSet.oldIndoorStorage);  
        oldData.Open_Close         = string(DataSet.oldOpen_Close);      

        newData = TData();
        newData.DepoRoot           = int(DataSet.newDepoRoot);       
        newData.DepoRootType       = int(DataSet.newDepoRootType);   
        newData.DepoAcc            = int(DataSet.newDepoAcc);        
        newData.Kind_Account       = string(DataSet.newKind_Account);    
        newData.Client             = int(DataSet.newClient);         
        newData.Account            = string(DataSet.newAccount);         
        newData.IsEmissiveCurrency = DataSet.newIsEmissiveCurrency;
        newData.Code_Currency      = int(DataSet.newCode_Currency);  
        newData.Block              = int(DataSet.newBlock);          
        newData.Balance            = string(DataSet.newBalance);         
        newData.IndoorStorage      = int(DataSet.newIndoorStorage);  
        newData.Open_Close         = string(DataSet.newOpen_Close);

        err = SaveClobDataTMP(DataSet.AdmOprID);
        if(err)
          error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
        end;

        UseProgress(num = num + 1);
      end;

      RemProgress();
    end;
    
    if(not err)
      message("Обработка АО по лицевым счетам выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;

  end;
end;


//обновляем АО по субъектам
//переносим данные из BLOB в CLOB
class (TDepoAdmoClobPARTY) TUpgrDepoAdmoPARTY
  macro ExecUpgrade()
    var query, cmd, DataSet;
    var queryPers, cmdPers, DataSetPers;
    var offset, offsetPers;
    var NumPersons = 0, oldNumPersons = 0, newNumPersons = 0;
    var i = 0;
    var Person;
    var cnt = 0, num = 0;
    var err = 0;

    message("Обновление АО по субъектам.");

    query =         " select t_AdmOprID, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "PartyID")           + ", "
                  + QueryGetBlobInt16(@offset,  "LegalForm")         + ", "
                  + QueryGetBlobString(@offset, "ShortName", 61)     + ", "
                  + QueryGetBlobString(@offset, "Name",      321)    + ", "
                  + QueryGetBlobDate(@offset,   "Born" )             + ", "
                  + QueryGetBlobString(@offset, "BirsPlase", 81)     + ", "
                  + QueryGetBlobString(@offset, "IsMale",    1)      + ", "
                  + QueryGetBlobString(@offset, "CodeINN",   36)     + ", "
                  + QueryGetBlobString(@offset, "CodeDepos", 36)     + ", "
                  + QueryGetBlobString(@offset, "CodeBank",  36)     + ", "
                  + QueryGetBlobInt16(@offset,  "PaperKind")         + ", "
                  + QueryGetBlobString(@offset, "PaperSeries", 10)   + ", "
                  + QueryGetBlobString(@offset, "PaperNumber", 26)   + ", "
                  + QueryGetBlobString(@offset, "PaperIssuer", 165)  + ", "
                  + QueryGetBlobInt32(@offset,  "PaperIssuerID")     + ", "
                  + QueryGetBlobDate(@offset,   "PaperIssuedDate" )  + ", "
                  + QueryGetBlobString(@offset, "RegNumber", 36)     + ", "
                  + QueryGetBlobString(@offset, "Index", 16)         + ", "
                  + QueryGetBlobString(@offset, "Country", 4)        + ", "
                  + QueryGetBlobString(@offset, "Region", 50)        + ", "
                  + QueryGetBlobString(@offset, "CodeProvince", 21)  + ", "
                  + QueryGetBlobString(@offset, "Province", 50)      + ", "
                  + QueryGetBlobString(@offset, "CodeDistrict", 21)  + ", "
                  + QueryGetBlobString(@offset, "District", 50)      + ", "
                  + QueryGetBlobString(@offset, "CodePlace", 21)     + ", "
                  + QueryGetBlobString(@offset, "Place", 50)         + ", "
                  + QueryGetBlobString(@offset, "CodeStreet", 21)    + ", "
                  + QueryGetBlobString(@offset, "Street", 50)        + ", "
                  + QueryGetBlobString(@offset, "House", 6)          + ", "
                  + QueryGetBlobString(@offset, "NumCorps", 6)       + ", "
                  + QueryGetBlobString(@offset, "Flat", 6)           + ", "
                  + QueryGetBlobString(@offset, "PostIndex", 16)     + ", "
                  + QueryGetBlobString(@offset, "Address", 512)      + ", "
                  + QueryGetBlobString(@offset, "PhoneNumber", 25)   + ", "
                  + QueryGetBlobString(@offset, "PhoneNumber2", 25)  + ", "
                  + QueryGetBlobString(@offset, "Fax", 25)           + ", "
                  + QueryGetBlobString(@offset, "Telegraph", 8)      + ", "
                  + QueryGetBlobString(@offset, "TelexNumber", 25)   + ", "
                  + QueryGetBlobString(@offset, "E_Mail", 81)        + ", "
                  + QueryGetBlobString(@offset, "NotResident", 1)    + ", "
                  + QueryGetBlobString(@offset, "NRCountry", 4)      + ", "
                  + QueryGetBlobInt32(@offset,  "Status")            + ", "
                  + QueryGetBlobInt16(@offset,  "NumPersons");


    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_Item IN ("+SPDP_CLIENT+", "
                                         +SPDP_OURDEPOSITARY+", "
                                         +SPDP_STORAGEPLACE+", "
                                         +SPDP_GUARDIAN+", "
                                         +SPDP_OPERATOR+", "
                                         +SPDP_MANAGER+", "
                                         +SPDP_DEPOCORR+") ";

    
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обновлению "+cnt+" АО");
    if(cnt > 0)

      InitProgress( cnt, "Идет обновление", "Обновление АО по субъектам" );

      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))
        
        message("Обновление по записи ddepoadmo_upgr_dbt.t_AdmOprID = " + DataSet.AdmOprID);
        
        oldNumPersons = 0;
        newNumPersons = 0;

        oldData = TData();
        oldData.PartyID        = int(DataSet.oldPartyID);       
        oldData.LegalForm      = int(DataSet.oldLegalForm);     
        oldData.ShortName      = string(DataSet.oldShortName);      
        oldData.Name           = string(DataSet.oldName);           
        oldData.Born           = date(DataSet.oldBorn);             
        oldData.BirsPlase      = string(DataSet.oldBirsPlase);      
        oldData.IsMale         = string(DataSet.oldIsMale);         
        oldData.CodeINN        = string(DataSet.oldCodeINN);        
        oldData.CodeDepos      = string(DataSet.oldCodeDepos);      
        oldData.CodeBank       = string(DataSet.oldCodeBank);       
        oldData.PaperKind      = int(DataSet.oldPaperKind);     
        oldData.PaperSeries    = string(DataSet.oldPaperSeries);    
        oldData.PaperNumber    = string(DataSet.oldPaperNumber);    
        oldData.PaperIssuer    = string(DataSet.oldPaperIssuer);    
        oldData.PaperIssuerID  = int(DataSet.oldPaperIssuerID); 
        oldData.PaperIssuedDate= date(DataSet.oldPaperIssuedDate);  
        oldData.RegNumber      = string(DataSet.oldRegNumber);      
        oldData.Index          = string(DataSet.oldIndex);          
        oldData.Country        = string(DataSet.oldCountry);        
        oldData.Region         = string(DataSet.oldRegion);         
        oldData.CodeProvince   = string(DataSet.oldCodeProvince);   
        oldData.Province       = string(DataSet.oldProvince);       
        oldData.CodeDistrict   = string(DataSet.oldCodeDistrict);   
        oldData.District       = string(DataSet.oldDistrict);       
        oldData.CodePlace      = string(DataSet.oldCodePlace);      
        oldData.Place          = string(DataSet.oldPlace);          
        oldData.CodeStreet     = string(DataSet.oldCodeStreet);     
        oldData.Street         = string(DataSet.oldStreet);         
        oldData.House          = string(DataSet.oldHouse);          
        oldData.NumCorps       = string(DataSet.oldNumCorps);       
        oldData.Flat           = string(DataSet.oldFlat);           
        oldData.PostIndex      = string(DataSet.oldPostIndex);      
        oldData.Address        = string(DataSet.oldAddress);        
        oldData.PhoneNumber    = string(DataSet.oldPhoneNumber);    
        oldData.PhoneNumber2   = string(DataSet.oldPhoneNumber2);   
        oldData.Fax            = string(DataSet.oldFax);            
        oldData.Telegraph      = string(DataSet.oldTelegraph);      
        oldData.TelexNumber    = string(DataSet.oldTelexNumber);    
        oldData.E_Mail         = string(DataSet.oldE_Mail);         
        oldData.NotResident    = string(DataSet.oldNotResident);    
        oldData.NRCountry      = string(DataSet.oldNRCountry);      
        oldData.Status         = int(DataSet.oldStatus);

        newData = TData();
        newData.PartyID        = int(DataSet.newPartyID);       
        newData.LegalForm      = int(DataSet.newLegalForm);     
        newData.ShortName      = string(DataSet.newShortName);      
        newData.Name           = string(DataSet.newName);           
        newData.Born           = date(DataSet.newBorn);             
        newData.BirsPlase      = string(DataSet.newBirsPlase);      
        newData.IsMale         = string(DataSet.newIsMale);         
        newData.CodeINN        = string(DataSet.newCodeINN);        
        newData.CodeDepos      = string(DataSet.newCodeDepos);      
        newData.CodeBank       = string(DataSet.newCodeBank);       
        newData.PaperKind      = int(DataSet.newPaperKind);     
        newData.PaperSeries    = string(DataSet.newPaperSeries);    
        newData.PaperNumber    = string(DataSet.newPaperNumber);    
        newData.PaperIssuer    = string(DataSet.newPaperIssuer);    
        newData.PaperIssuerID  = int(DataSet.newPaperIssuerID); 
        newData.PaperIssuedDate= date(DataSet.newPaperIssuedDate);  
        newData.RegNumber      = string(DataSet.newRegNumber);      
        newData.Index          = string(DataSet.newIndex);          
        newData.Country        = string(DataSet.newCountry);        
        newData.Region         = string(DataSet.newRegion);         
        newData.CodeProvince   = string(DataSet.newCodeProvince);   
        newData.Province       = string(DataSet.newProvince);       
        newData.CodeDistrict   = string(DataSet.newCodeDistrict);   
        newData.District       = string(DataSet.newDistrict);       
        newData.CodePlace      = string(DataSet.newCodePlace);      
        newData.Place          = string(DataSet.newPlace);          
        newData.CodeStreet     = string(DataSet.newCodeStreet);     
        newData.Street         = string(DataSet.newStreet);         
        newData.House          = string(DataSet.newHouse);          
        newData.NumCorps       = string(DataSet.newNumCorps);       
        newData.Flat           = string(DataSet.newFlat);           
        newData.PostIndex      = string(DataSet.newPostIndex);      
        newData.Address        = string(DataSet.newAddress);        
        newData.PhoneNumber    = string(DataSet.newPhoneNumber);    
        newData.PhoneNumber2   = string(DataSet.newPhoneNumber2);   
        newData.Fax            = string(DataSet.newFax);            
        newData.Telegraph      = string(DataSet.newTelegraph);      
        newData.TelexNumber    = string(DataSet.newTelexNumber);    
        newData.E_Mail         = string(DataSet.newE_Mail);         
        newData.NotResident    = string(DataSet.newNotResident);    
        newData.NRCountry      = string(DataSet.newNRCountry);      
        newData.Status         = int(DataSet.newStatus); 
                                                     
        oldNumPersons          = int(DataSet.oldNumPersons);
        newNumPersons          = int(DataSet.newNumPersons);


        oldData.Persons.size = 0;
        newData.Persons.size = 0;

        //добавить сотрудников
        if((oldNumPersons > 0) or (newNumPersons > 0))

          NumPersons = oldNumPersons;
          if(NumPersons < newNumPersons)
            NumPersons = newNumPersons;
          end;
          
          i = 0;
          while(i < NumPersons)

            offsetPers = offset + i * 9; //(int32 + int32 + char[1])
            Person = TPerson(-1, -1, UNSET_CHAR);

            if(i < oldNumPersons)
              queryPers =  " select "    
                         + QueryGetBlobIntSide(@offsetPers, 4, "oldOfficerID", false) + ", "
                         + QueryGetBlobIntSide(@offsetPers, 4, "oldPersonID", false)  + ", "
                         + QueryGetBlobStringSide(@offsetPers, "oldIsFirstPerson", false, 1)
                         + "   from ddepoadmo_upgr_dbt "
                         + "  where t_AdmOprID = ? ";
              cmdPers = DL_RSDCommand(queryPers);
              cmdPers.AddParam(DataSet.AdmOprID);

              DataSetPers = cmdPers.Execute();
              if(DataSetPers.moveNext())
                Person = TPerson(int(DataSetPers.oldOfficerID), int(DataSetPers.oldPersonID), string(DataSetPers.oldIsFirstPerson));
              end;
            end;

            oldData.Persons[oldData.Persons.size] = Person;


            offsetPers = offset + i * 9; //(int32 + int32 + char[1])
            Person = TPerson(-1, -1, UNSET_CHAR);
            
            if(i < newNumPersons)
              queryPers =  " select "    
                         + QueryGetBlobIntSide(@offsetPers, 4, "newOfficerID", true) + ", "
                         + QueryGetBlobIntSide(@offsetPers, 4, "newPersonID", true)  + ", "
                         + QueryGetBlobStringSide(@offsetPers, "newIsFirstPerson", true, 1)
                         + "   from ddepoadmo_upgr_dbt "
                         + "  where t_AdmOprID = ? ";
              cmdPers = DL_RSDCommand(queryPers);
              cmdPers.AddParam(DataSet.AdmOprID);

              DataSetPers = cmdPers.Execute();
              if(DataSetPers.moveNext())
                Person = TPerson(int(DataSetPers.newOfficerID), int(DataSetPers.newPersonID), string(DataSetPers.newIsFirstPerson));
              end;
            end;

            newData.Persons[newData.Persons.size] = Person;

            i = i + 1;
          end;
        end;

        UseProgress(num = num + 1);

        err = SaveClobDataTMP(DataSet.AdmOprID);

        if(err)
          error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
        end;
      end; 

      RemProgress();
    end;

    if(not err)
      message("Обработка АО по субъектам выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//обновляем АО по ц/б
//переносим данные из BLOB в CLOB
class (TDepoAdmoClobAVOIR) TUpgrDepoAdmoAVOIR

  macro ExecUpgrade()
    var query, cmd, DataSet;
    var offset;
    var cnt = 0, num = 0;
    var err = 0;

    message("Обновление АО по ц/б.");

    query =         " select t_AdmOprID, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "FIID")           + ", "
                  + QueryGetBlobInt16(@offset,  "AvoirKind")      + ", "
                  + QueryGetBlobString(@offset, "LSIN", 36)       + ", "
                  + QueryGetBlobString(@offset, "Name", 51)       + ", "
                  + QueryGetBlobInt32(@offset,  "Issuer")         + ", "
                  + QueryGetBlobDate(@offset,   "Issued")         + ", "
                  + QueryGetBlobMoney(@offset,  "FaceValue")      + ", "
                  + QueryGetBlobInt32(@offset,  "FaceValueFI")    + ", "
                  + QueryGetBlobMoney(@offset,  "Qty")            + ", "
                  + QueryGetBlobDate(@offset,   "DrawingDate")    + ", "
                  + QueryGetBlobDouble(@offset, "IncomeRate")     + ", "
                  + QueryGetBlobMoney(@offset,  "IncomeVolume")   + ", "
                  + QueryGetBlobInt16(@offset,  "ServiceState");


    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_Item = "+SPDP_AVOIRIS;
    
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обновлению "+cnt+" АО");
    if(cnt > 0)

      InitProgress( cnt, "Идет обновление", "Обновление АО по ц/б" );
      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи ddepoadmo_upgr_dbt.t_AdmOprID = " + DataSet.AdmOprID);

        oldData = TData();
        oldData.FIID         =  int(DataSet.oldFIID);        
        oldData.AvoirKind    =  int(DataSet.oldAvoirKind);   
        oldData.LSIN         =  string(DataSet.oldLSIN);         
        oldData.Name         =  string(DataSet.oldName);         
        oldData.Issuer       =  int(DataSet.oldIssuer);      
        oldData.Issued       =  date(DataSet.oldIssued);         
        oldData.FaceValue    =  money(DataSet.oldFaceValue);   
        oldData.FaceValueFI  =  int(DataSet.oldFaceValueFI); 
        oldData.Qty          =  money(DataSet.oldQty);         
        oldData.DrawingDate  =  date(DataSet.oldDrawingDate);    
        oldData.IncomeRate   =  double(DataSet.oldIncomeRate);   
        oldData.IncomeVolume =  money(DataSet.oldIncomeVolume);
        oldData.ServiceState =  int(DataSet.oldServiceState);

        newData = TData();
        newData.FIID         =  int(DataSet.newFIID);        
        newData.AvoirKind    =  int(DataSet.newAvoirKind);   
        newData.LSIN         =  string(DataSet.newLSIN);         
        newData.Name         =  string(DataSet.newName);         
        newData.Issuer       =  int(DataSet.newIssuer);      
        newData.Issued       =  date(DataSet.newIssued);         
        newData.FaceValue    =  money(DataSet.newFaceValue);   
        newData.FaceValueFI  =  int(DataSet.newFaceValueFI); 
        newData.Qty          =  money(DataSet.newQty);         
        newData.DrawingDate  =  date(DataSet.newDrawingDate);    
        newData.IncomeRate   =  double(DataSet.newIncomeRate);   
        newData.IncomeVolume =  money(DataSet.newIncomeVolume);
        newData.ServiceState =  int(DataSet.newServiceState);
   
        err = SaveClobDataTMP(DataSet.AdmOprID);

        if(err)
          error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
        end;

        UseProgress(num = num + 1);
      end;

      RemProgress();

    end;

    if(not err)
      message("Обработка АО по ц/б выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

end;

PRIVATE CLASS TCurrAcnt()
  var newData;
  var oldData;
END;

//обновляем АО по счетам ДЕПО
//переносим данные из BLOB в CLOB, меняем виды АО по УЛ, меняем состав АО
class (TDepoAdmoClobDACNT) TUpgrDepoAdmoACNT

  macro ExecUpgrade(AdmOprID:integer, CurrAcntOld:@variant)
    var query, cmd, DataSet;
    var offset, offsetSETTACC;
    var cnt = 0, num = 0;
    var err = 0;
    var NumSETTACC = 0, oldNumSETTACC = 0, newNumSETTACC = 0;
    var querySETTACC, cmdSETTACC, DataSetSETTACC;
    var SettAcc;
    var i = 0;

    query =         " select t_AdmOprID, t_OperKind, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "AutoKey")               + ", "
                  + QueryGetBlobString(@offset, "Code", 26)              + ", "
                  + QueryGetBlobString(@offset, "BriefCode", 26)         + ", "
                  + QueryGetBlobInt16(@offset,  "Kind")                  + ", "
                  + QueryGetBlobInt32(@offset,  "Type")                  + ", "
                  + QueryGetBlobString(@offset, "CorAccount", 36)        + ", "
                  + QueryGetBlobString(@offset, "IsBase", 1)             + ", "
                  + QueryGetBlobInt32(@offset,  "Owner")                 + ", "
                  + QueryGetBlobString(@offset, "IncomeDelivery", 12)    + ", "
                  + QueryGetBlobString(@offset, "OrderDelivery", 12)     + ", "
                  + QueryGetBlobString(@offset, "StatementDelivery", 12) + ", "
                  + QueryGetBlobInt32(@offset,  "Operator")              + ", "
                  + QueryGetBlobInt32(@offset,  "Curator")               + ", "
                  + QueryGetBlobInt16(@offset,  "Status")                + ", "
                  + QueryGetBlobInt16(@offset,  "NumRights")             + ", "
                  + QueryGetBlobInt16(@offset,  "NumSETTACC");

    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_AdmOprID = ? ";
    
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AdmOprID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())

      oldData = NULL;
      newData = NULL;

      if(((DataSet.OperKind == SPAO_CON_AUTHORITY_ASSIGN) OR
         (DataSet.OperKind == SPAO_CON_AUTHORITY_CHANGE) OR
         (DataSet.OperKind == SPAO_CON_AUTHORITY_CANCEL))
         AND (CurrAcntOld != NULL)
        )
        //если это операция назначения/отмены/изменения полномочий попечителя
        oldData = TData();
        ConvertFromXmlObjectData(oldData, CurrAcntOld, "newData");
        newData = TData();
        ConvertFromXmlObjectData(newData, CurrAcntOld, "newData");
      end;

      if((oldData == NULL) OR (newData == NULL))

        oldData = TData();
        oldData.AutoKey           = int(DataSet.oldAutoKey);
        oldData.Code              = string(DataSet.oldCode);
        oldData.BriefCode         = string(DataSet.oldBriefCode);
        oldData.Kind              = int(DataSet.oldKind);
        oldData.Type              = int(DataSet.oldType);
        oldData.CorAccount        = string(DataSet.oldCorAccount);
        oldData.IsBase            = string(DataSet.oldIsBase);
        oldData.Owner             = int(DataSet.oldOwner);
        oldData.IncomeDelivery    = string(DataSet.oldIncomeDelivery);
        oldData.OrderDelivery     = string(DataSet.oldOrderDelivery);
        oldData.StatementDelivery = string(DataSet.oldStatementDelivery);
        oldData.Status            = int(DataSet.oldStatus);
      
        newData = TData();
        newData.AutoKey           = int(DataSet.newAutoKey);
        newData.Code              = string(DataSet.newCode);
        newData.BriefCode         = string(DataSet.newBriefCode);
        newData.Kind              = int(DataSet.newKind);
        newData.Type              = int(DataSet.newType);
        newData.CorAccount        = string(DataSet.newCorAccount);
        newData.IsBase            = string(DataSet.newIsBase);
        newData.Owner             = int(DataSet.newOwner);
        newData.IncomeDelivery    = string(DataSet.newIncomeDelivery);
        newData.OrderDelivery     = string(DataSet.newOrderDelivery);
        newData.StatementDelivery = string(DataSet.newStatementDelivery);
        newData.Status            = int(DataSet.newStatus);
      
        if(ValType(CurrAcntOld) != V_UNDEF)
          oldData.acap = CurrAcntOld.newData.acap;
          newData.acap = CurrAcntOld.newData.acap;
        end;
      
        oldNumSETTACC = int(DataSet.oldNumSETTACC);
        newNumSETTACC = int(DataSet.newNumSETTACC);

        oldData.SettAcc.size = 0;
        newData.SettAcc.size = 0;

        //добавить СПИ
        if((oldNumSETTACC > 0) or (newNumSETTACC > 0))

          NumSETTACC = oldNumSETTACC;
          if(NumSETTACC < newNumSETTACC)
            NumSETTACC = newNumSETTACC;
          end;
          
          i = 0;
          while(i < NumSETTACC)

            offsetSETTACC = offset + int(DataSet.oldNumRights) * 4 + i * 1243; 
            SettAcc = TSettAccData();

            if(i < oldNumSETTACC)
              querySETTACC =  " select "    
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "SettAccID", false)         + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "ShortName", false, 36)     + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "BeneficiaryID", false)     + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "RecName", false, 321)      + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "CodeKind", false)          + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "Code", false, 36)          + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "INN", false, 36)           + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "Chapter", false)           + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "Account", false, 36)       + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "FIID", false)              + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "BankID", false)            + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankName", false, 321)     + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "BankCodeKind", false)      + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankCode", false, 36)      + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "CorrAcc", false, 36)       + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "BankCorrID", false)        + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankCorrName", false, 321) + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "BankCorrCodeKind", false)  + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankCorrCode", false, 36)
                              + "   from ddepoadmo_upgr_dbt "
                              + "  where t_AdmOprID = ? ";
              cmdSETTACC = DL_RSDCommand(querySETTACC);
              cmdSETTACC.AddParam(DataSet.AdmOprID);

              DataSetSETTACC = cmdSETTACC.Execute();
              if(DataSetSETTACC.moveNext())
                SettAcc = TSettAccData(DataSetSETTACC);
              end;
            end;

            oldData.SettAcc[oldData.SettAcc.size] = SettAcc;


            offsetSETTACC = offset + int(DataSet.newNumRights) * 4 + i * 1243;
            SettAcc = TSettAccData();
            
            if(i < newNumSETTACC)
              querySETTACC =  " select "    
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "SettAccID", true)         + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "ShortName", true, 36)     + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "BeneficiaryID", true)     + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "RecName", true, 321)      + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "CodeKind", true)          + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "Code", true, 36)          + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "INN", true, 36)           + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "Chapter", true)           + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "Account", true, 36)       + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "FIID", true)              + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "BankID", true)            + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankName", true, 321)     + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "BankCodeKind", true)      + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankCode", true, 36)      + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "CorrAcc", true, 36)       + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 4, "BankCorrID", true)        + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankCorrName", true, 321) + ", "
                              + QueryGetBlobIntSide(@offsetSETTACC, 2, "BankCorrCodeKind", true)  + ", "
                              + QueryGetBlobStringSide(@offsetSETTACC, "BankCorrCode", true, 36)
                              + "   from ddepoadmo_upgr_dbt "
                              + "  where t_AdmOprID = ? ";
              cmdSETTACC = DL_RSDCommand(querySETTACC);
              cmdSETTACC.AddParam(DataSet.AdmOprID);

              DataSetSETTACC = cmdSETTACC.Execute();
              if(DataSetSETTACC.moveNext())
                SettAcc = TSettAccData(DataSetSETTACC);
              end;
            end;

            newData.SettAcc[newData.SettAcc.size] = SettAcc;
            
            i = i + 1;
          end;
        end;
      end;

      if((DataSet.OperKind == SPAO_CON_AUTHORITY_ASSIGN) OR
         (DataSet.OperKind == SPAO_CON_AUTHORITY_CHANGE) OR
         (DataSet.OperKind == SPAO_CON_AUTHORITY_CANCEL)
        )
        //если это операция назначения/отмены/изменения полномочий попечителя

        //теперь корректируем список УЛ
        if(DataSet.oldCurator != DataSet.newCurator)
          //попечитель в этом случае мог либо появиться, либо исчезнуть. В рамках одной операции замены быть не могло
          if((DataSet.oldCurator <= 0) AND (DataSet.newCurator > 0))
            //назначение попечителя
            var acap = TRecHandler("dpacap.dbt");
            
            acap.rec.APID         = -1*DataSet.AdmOprID;

            acap.rec.APartyID     = -1;
            acap.rec.Role         = 0;
            acap.rec.APartyGround = 0;

            oldData.acap[oldData.acap.size] = TAcapData(acap);

            acap.rec.APartyID     = DataSet.newCurator;
            acap.rec.Role         = DEPOACAPROLE_CURATOR;      
            acap.rec.APartyGround = 0;

            newData.acap[newData.acap.size] = TAcapData(acap); 

          elif((DataSet.newCurator <= 0) AND (DataSet.oldCurator > 0))
            //отмена попечителя
            
            //найдем в состоянии ПОСЛЕ этого попечителя и удалим
            i = 0;

            while(i < newData.acap.size)
              if((newData.acap[i].APartyID == DataSet.oldCurator) AND (newData.acap[i].Role == DEPOACAPROLE_CURATOR))
                newData.acap[i].APartyID     = -1;
                newData.acap[i].Role         = 0;
                newData.acap[i].APartyGround = 0;

                break;
              end;

              i = i + 1;
            end;
          else
            //это может быть операция изменения полномочий попечителя
            //в неё просто заносим в состояние ДО и ПОСЛЕ состояние ПОСЛЕ предыдущей операции по счету
            //выполнено выше
          end;
        end;
      end;

      CurrAcntOld = TCurrAcnt();
      CurrAcntOld.oldData = TData();
      CurrAcntOld.newData = TData();
      ConvertFromXmlObjectData(CurrAcntOld.newData, this, "newData");

      err = SaveClobDataTMP(DataSet.AdmOprID);

      if(err)
        error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;


//обновляем АО по распорядителям счетов ДЕПО
//переносим данные из BLOB в CLOB, меняем виды АО по УЛ, меняем состав АО
class (TDepoAdmoClobDACNT) TUpgrDepoAdmoACNTMAN

  macro ExecUpgrade(AdmOprID:integer, 
                    CurrAcntOld:@variant    //состояние ПОСЛЕ из ближайшей предыдущей АО по счету 
                   )
    var query, cmd, DataSet;
    var offset, offsetSETTACC;
    var cnt = 0, num = 0;
    var err = 0;
    var i = 0;

    query =         " select t_AdmOprID, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "DepoAccID")   + ", "
                  + QueryGetBlobInt32(@offset,  "DepoType")    + ", "
                  + QueryGetBlobInt32(@offset,  "Operator")    + ", "
                  + QueryGetBlobInt32(@offset,  "AgentID")     + ", "
                  + QueryGetBlobInt16(@offset,  "NumRights");

    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_AdmOprID = ? ";
    
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AdmOprID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())

      oldData = TData();
      newData = TData();

      if(CurrAcntOld != NULL)
        ConvertFromXmlObjectData(oldData, CurrAcntOld, "newData");
        ConvertFromXmlObjectData(newData, CurrAcntOld, "newData");
      else
        oldData.AutoKey = int(DataSet.oldDepoAccID);
        newData.AutoKey = int(DataSet.newDepoAccID);
      end;
    
      //теперь корректируем список УЛ
      if(DataSet.oldAgentID != DataSet.newAgentID)
        //распорядитель в этом случае мог либо появиться, либо исчезнуть. В рамках одной операции замены быть не могло
        if((DataSet.oldAgentID <= 0) AND (DataSet.newAgentID > 0))
          //назначение распорядителя
          var acap = TRecHandler("dpacap.dbt");
          
          acap.rec.APID         = -1*DataSet.AdmOprID;

          acap.rec.APartyID     = -1;
          acap.rec.Role         = 0;
          acap.rec.APartyGround = 0;
          
          oldData.acap[oldData.acap.size] = TAcapData(acap);

          acap.rec.APartyID     = DataSet.newAgentID;
          acap.rec.Role         = DEPOACAPROLE_MANAGER;      
          acap.rec.APartyGround = 0;

          newData.acap[newData.acap.size] = TAcapData(acap); 

        elif((DataSet.newAgentID <= 0) AND (DataSet.oldAgentID > 0))
          //отмена распорядителя
          
          //найдем в состоянии ПОСЛЕ этого распорядителя и удалим
          i = 0;

          while(i < newData.acap.size)
            if((newData.acap[i].APartyID == DataSet.oldAgentID) AND (newData.acap[i].Role == DEPOACAPROLE_MANAGER))
              newData.acap[i].APartyID     = -1;
              newData.acap[i].Role         = 0;
              newData.acap[i].APartyGround = 0;

              break;
            end;

            i = i + 1;
          end;
        else
          //это может быть операция изменения полномочий распорядителя
          //в неё просто заносим в состояние ДО и ПОСЛЕ состояние ПОСЛЕ предыдущей операции по счету
          //выполнено выше
        end;
      end;

      //т.к. это всё-таки операция по счету, то запоминаем текущее состояние ПОСЛЕ
      CurrAcntOld = TCurrAcnt();
      CurrAcntOld.oldData = TData();
      CurrAcntOld.newData = TData();
      ConvertFromXmlObjectData(CurrAcntOld.newData, this, "newData");

      err = SaveClobDataTMP(DataSet.AdmOprID);

      if(err)
        error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//обновляем АО по разделам счетов ДЕПО
//переносим данные из BLOB в CLOB, меняем виды АО по УЛ, меняем состав АО
class (TDepoAdmoClobDPART) TUpgrDepoAdmoPART

  macro ExecUpgrade(AdmOprID:integer,
                    CurrAcntOld:@variant    //состояние ПОСЛЕ из ближайшей предыдущей АО по счету
                   )
    var query, cmd, DataSet;
    var offset, offsetSETTACC;
    var cnt = 0, num = 0;
    var err = 0;
    var NumSETTACC = 0, oldNumSETTACC = 0, newNumSETTACC = 0;
    var querySETTACC, cmdSETTACC, DataSetSETTACC;
    var SettAcc;
    var i = 0;

    query =         " select t_AdmOprID, t_OperKind, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "AutoKey")               + ", "
                  + QueryGetBlobInt32(@offset,  "Root")                  + ", "
                  + QueryGetBlobInt32(@offset,  "RootType")              + ", "
                  + QueryGetBlobInt16(@offset,  "Kind")                  + ", "
                  + QueryGetBlobInt32(@offset,  "Owner")                 + ", "
                  + QueryGetBlobString(@offset, "BriefCode", 26)         + ", "
                  + QueryGetBlobString(@offset, "IncomeDelivery", 12)    + ", "
                  + QueryGetBlobString(@offset, "OrderDelivery", 12)     + ", "
                  + QueryGetBlobString(@offset, "StatementDelivery", 12) + ", "
                  + QueryGetBlobInt32(@offset,  "Operator")              + ", "
                  + QueryGetBlobInt16(@offset,  "AvoirStatus")           + ", "
                  + QueryGetBlobInt16(@offset,  "Status")                + ", "
                  + QueryGetBlobInt16(@offset,  "NumRights");
    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_AdmOprID = ? ";
    
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AdmOprID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())

      oldData = TData();
      oldData.AutoKey           = int(DataSet.oldAutoKey);
      oldData.Root              = int(DataSet.oldRoot);
      oldData.RootType          = int(DataSet.oldRootType);
      oldData.Kind              = int(DataSet.oldKind);
      oldData.Owner             = int(DataSet.oldOwner);
      oldData.BriefCode         = string(DataSet.oldBriefCode);
      oldData.IncomeDelivery    = string(DataSet.oldIncomeDelivery);   
      oldData.OrderDelivery     = string(DataSet.oldOrderDelivery);    
      oldData.StatementDelivery = string(DataSet.oldStatementDelivery);
      oldData.AvoirStatus       = int(DataSet.oldAvoirStatus);
      oldData.Status            = int(DataSet.oldStatus);

      newData = TData();
      newData.AutoKey           = int(DataSet.newAutoKey);
      newData.Root              = int(DataSet.newRoot);
      newData.RootType          = int(DataSet.newRootType);
      newData.Kind              = int(DataSet.newKind);
      newData.Owner             = int(DataSet.newOwner);
      newData.BriefCode         = string(DataSet.newBriefCode);
      newData.IncomeDelivery    = string(DataSet.newIncomeDelivery);   
      newData.OrderDelivery     = string(DataSet.newOrderDelivery);    
      newData.StatementDelivery = string(DataSet.newStatementDelivery);
      newData.AvoirStatus       = int(DataSet.newAvoirStatus);
      newData.Status            = int(DataSet.newStatus);
 
      err = SaveClobDataTMP(DataSet.AdmOprID);

      if(err)
        error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//обновляем АО по УЛ разделов счетов ДЕПО
//переносим данные из BLOB в CLOB, меняем виды АО по УЛ, меняем состав АО
class (TDepoAdmoClobDACNT) TUpgrDepoAdmoPARTAUTHORITY

  macro ExecUpgrade(AdmOprID:integer,
                    CurrAcntOld:@variant    //состояние ПОСЛЕ из ближайшей предыдущей АО по счету
                   )
    var query, cmd, DataSet;
    var offset, offsetSETTACC;
    var cnt = 0, num = 0;
    var err = 0;
    var i = 0;

    query =         " select t_AdmOprID, t_OperKind, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "AutoKey")               + ", "
                  + QueryGetBlobInt32(@offset,  "Root")                  + ", "
                  + QueryGetBlobInt32(@offset,  "RootType")              + ", "
                  + QueryGetBlobInt16(@offset,  "Kind")                  + ", "
                  + QueryGetBlobInt32(@offset,  "Owner")                 + ", "
                  + QueryGetBlobString(@offset, "BriefCode", 26)         + ", "
                  + QueryGetBlobString(@offset, "IncomeDelivery", 12)    + ", "
                  + QueryGetBlobString(@offset, "OrderDelivery", 12)     + ", "
                  + QueryGetBlobString(@offset, "StatementDelivery", 12) + ", "
                  + QueryGetBlobInt32(@offset,  "Operator")              + ", "
                  + QueryGetBlobInt16(@offset,  "AvoirStatus")           + ", "
                  + QueryGetBlobInt16(@offset,  "Status")                + ", "
                  + QueryGetBlobInt16(@offset,  "NumRights");
    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_AdmOprID = ? ";
    
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AdmOprID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())
      oldData = TData();
      newData = TData();

      //это операция назначения/отмены/изменения полномочий оператора
      //то преобразем её в операцию по счету
      if(CurrAcntOld != NULL)
        ConvertFromXmlObjectData(oldData, CurrAcntOld, "newData");
        ConvertFromXmlObjectData(newData, CurrAcntOld, "newData");
      else
        oldData.AutoKey = int(DataSet.oldRoot);
        newData.AutoKey = int(DataSet.newRoot);
      end;
      //теперь корректируем список УЛ
      if(DataSet.oldOperator != DataSet.newOperator)
        //оператор в этом случае мог либо появиться, либо исчезнуть. В рамках одной операции замены быть не могло
        if((DataSet.oldOperator <= 0) AND (DataSet.newOperator > 0))
          //назначение оператора
          var acap = TRecHandler("dpacap.dbt");
            
          acap.rec.APID         = -1*DataSet.AdmOprID;

          acap.rec.APartyID     = -1;
          acap.rec.Role         = 0;
          acap.rec.APartyGround = 0;
          
          oldData.acap[oldData.acap.size] = TAcapData(acap);

          acap.rec.APartyID     = DataSet.newOperator;
          acap.rec.Role         = DEPOACAPROLE_OPERATOR;      
          acap.rec.APartyGround = 0;

          newData.acap[newData.acap.size] = TAcapData(acap); 

        elif((DataSet.newOperator <= 0) AND (DataSet.oldOperator > 0))
          //отмена оператора
          
          //найдем в состоянии ПОСЛЕ этого оператора и удалим
          i = 0;

          while(i < newData.acap.size)
            if((newData.acap[i].APartyID == DataSet.oldOperator) AND (newData.acap[i].Role == DEPOACAPROLE_OPERATOR))
              newData.acap[i].APartyID     = -1;
              newData.acap[i].Role         = 0;
              newData.acap[i].APartyGround = 0;

              break;
            end;

            i = i + 1;
          end;
        else
          //это может быть операция изменения полномочий оператора
          //в неё просто заносим в состояние ДО и ПОСЛЕ состояние ПОСЛЕ предыдущей операции по счету
          //выполнено выше
        end;

        //т.к. это всё-таки теперь будет операция по счету, то запоминаем текущее состояние ПОСЛЕ
        CurrAcntOld = TCurrAcnt();
        CurrAcntOld.oldData = TData();
        CurrAcntOld.newData = TData();
        ConvertFromXmlObjectData(CurrAcntOld.newData, this, "newData");
      end;
 
      err = SaveClobDataTMP(DataSet.AdmOprID);

      if(err)
        error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;


//обновляем АО по распорядителям счетов ДЕПО
//переносим данные из BLOB в CLOB, меняем виды АО по УЛ, меняем состав АО
class (TDepoAdmoClobDACNT) TUpgrDepoAdmoPARTMAN

  macro ExecUpgrade(AdmOprID:integer, 
                    CurrAcntOld:@variant    //состояние ПОСЛЕ из ближайшей предыдущей АО по счету 
                   )
    var query, cmd, DataSet;
    var offset, offsetSETTACC;
    var cnt = 0, num = 0;
    var err = 0;
    var i = 0;

    query =         " select t_AdmOprID, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "DepoRoot")   + ", "
                  + QueryGetBlobInt32(@offset,  "RootType")    + ", "
                  + QueryGetBlobInt32(@offset,  "DepoAccID")   + ", "
                  + QueryGetBlobInt32(@offset,  "Operator")    + ", "
                  + QueryGetBlobInt32(@offset,  "AgentID")     + ", "
                  + QueryGetBlobInt16(@offset,  "NumRights");

    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_AdmOprID = ? ";
    
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AdmOprID);

    DataSet = cmd.Execute();

    if(DataSet.moveNext())

      oldData = TData();
      newData = TData();

      if(CurrAcntOld != NULL)
        ConvertFromXmlObjectData(oldData, CurrAcntOld, "newData");
        ConvertFromXmlObjectData(newData, CurrAcntOld, "newData");
      else
        oldData.AutoKey = int(DataSet.oldDepoRoot);
        newData.AutoKey = int(DataSet.newDepoRoot);
      end;
      

      //теперь корректируем список УЛ
      if(DataSet.oldAgentID != DataSet.newAgentID)
        //распорядитель в этом случае мог либо появиться, либо исчезнуть. В рамках одной операции замены быть не могло
        if((DataSet.oldAgentID <= 0) AND (DataSet.newAgentID > 0))
          //назначение распорядителя
          var acap = TRecHandler("dpacap.dbt");

          acap.rec.APID         = -1*DataSet.AdmOprID;

          acap.rec.APartyID     = -1;
          acap.rec.Role         = 0;
          acap.rec.APartyGround = 0;

          oldData.acap[oldData.acap.size] = TAcapData(acap);
                
          acap.rec.APartyID     = DataSet.newAgentID;
          acap.rec.Role         = DEPOACAPROLE_MANAGER;      
          acap.rec.APartyGround = 0;

          newData.acap[newData.acap.size] = TAcapData(acap); 

        elif((DataSet.newAgentID <= 0) AND (DataSet.oldAgentID > 0))
          //отмена распорядителя
          
          //найдем в состоянии ПОСЛЕ этого распорядителя и удалим
          i = 0;

          while(i < newData.acap.size)
            if((newData.acap[i].APartyID == DataSet.oldAgentID) AND (newData.acap[i].Role == DEPOACAPROLE_MANAGER))
              newData.acap[i].APartyID     = -1;
              newData.acap[i].Role         = 0;
              newData.acap[i].APartyGround = 0;

              break;
            end;

            i = i + 1;
          end;
        else
          //это может быть операция изменения полномочий распорядителя
          //в неё просто заносим в состояние ДО и ПОСЛЕ состояние ПОСЛЕ предыдущей операции по счету
          //выполнено выше
        end;
      end;

      //т.к. это всё-таки теперь будет операция по счету, то запоминаем текущее состояние ПОСЛЕ
      CurrAcntOld = TCurrAcnt();
      CurrAcntOld.oldData = TData();
      CurrAcntOld.newData = TData();
      ConvertFromXmlObjectData(CurrAcntOld.newData, this, "newData");

      err = SaveClobDataTMP(DataSet.AdmOprID);

      if(err)
        error("Ошибка при обновлении АО с ID = " + DataSet.AdmOprID);
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//обновляем АО по счетам/разделам ДЕПО
//переносим данные из BLOB в CLOB, меняем виды АО по УЛ, меняем состав АО
class TUpgrDepoAdmoDEPOACNT

  macro ExecUpgrade()
    var query, cmd, DataSet;
    var cnt = 0, num = 0;
    var err = 0;
    var PrevDepoAcc = 0;
    var CurrAcntOld = NULL;

    message("Обновление АО счетам/разделам ДЕПО.");

    query =   " select t_AdmOprID, t_DepoAcc, t_DepoPart, t_Item, t_OperKind "
            + "   from ddepoadmo_upgr_dbt "
            + "  where t_DepoAcc > 0 "
            + "    and t_Item IN("+SPDP_DEPO_ACCOUNT+","+SPDP_DEPO_PARTITION+","+SPDP_ACCMANAGER+","+SPDP_PARTMANAGER+")"
            + "   order by t_DepoAcc ASC, t_OperDate ASC, t_AdmOprID ASC";
    
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обновлению "+cnt+" АО");
    if(cnt > 0)
      InitProgress( cnt, "Идет обновление", "Обновление АО по счетам/разделам ДЕПО" );
      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи ddepoadmo_upgr_dbt.t_AdmOprID = " + DataSet.AdmOprID);

        if(PrevDepoAcc != DataSet.DepoAcc)
          CurrAcntOld = NULL;
        end;

        //вычистим пустых УЛ
        if(ValType(CurrAcntOld) != V_UNDEF)
          var arr = TArray();
          var i = 0;
          while(i < CurrAcntOld.newData.acap.size)
            if(CurrAcntOld.newData.acap[i].APartyID > 0)
              arr[arr.size] = CurrAcntOld.newData.acap[i];
            end;
            i = i + 1;
          end;
          CurrAcntOld.newData.acap = arr;
        end;
        
        if(DataSet.Item == SPDP_DEPO_PARTITION)
          if((DataSet.OperKind == SPAO_CON_AUTHORITY_ASSIGN) OR
             (DataSet.OperKind == SPAO_CON_AUTHORITY_CHANGE) OR
             (DataSet.OperKind == SPAO_CON_AUTHORITY_CANCEL)
            )
            clobData = TUpgrDepoAdmoPARTAUTHORITY();
          else
            clobData = TUpgrDepoAdmoPART();
          end;
        elif(DataSet.Item == SPDP_DEPO_ACCOUNT)
          clobData = TUpgrDepoAdmoACNT();
        elif(DataSet.Item == SPDP_ACCMANAGER)
          clobData = TUpgrDepoAdmoACNTMAN();
        elif(DataSet.Item == SPDP_PARTMANAGER)
          clobData = TUpgrDepoAdmoACNTMAN();
        end;
        err = clobData.ExecUpgrade(int(DataSet.AdmOprID), @CurrAcntOld);
        if(err)
          error("При обновлении АО по счетам/разделам ДЕПО возникли ошибки. Обновление прервано.");
        end;

        PrevDepoAcc = DataSet.DepoAcc;

        UseProgress(num = num + 1);
      end;

      RemProgress();
    end;

    if(not err)
      message("Обработка АО счетам/разделам ДЕПО выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

end;

//найти идентификатор новой ИК по идентификатору старой
PRIVATE MACRO FindNewInvCardByOld(XID:string, Department:integer, Number:string, ICID:@integer)
  var err = 0;

  //получить идентификатор новой ИК по идентификатору старой
  MACRO GetNewInvCardByOld(XID:string, Department:integer)
    var query, cmd, DataSet;
    var InvCardID = 0;
    query =   " select ic.t_InvCardID "
            + "   from dcertif_upgr_dbt cert, dinvcorrtable_dbt corric, dinvcard_dbt ic, dv_ficert_dbt vficert "
            + "  where cert.t_XID = ? "
            + "    and cert.t_Department = ? "
            + "    and corric.t_CertifID = cert.t_AutoKey "
            + "    and ic.t_InvCardID = corric.t_InvCardID "
            + "    and vficert.t_FiCertID = ic.t_FiCertID "
            + "    and vficert.t_Number = ? ";

    cmd = DL_RSDCommand(query);
    cmd.AddParam(XID);
    cmd.AddParam(Department);
    cmd.AddParam(Number);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      InvCardID = int(DataSet.InvCardID);
    else
      //сразу не нашли - пытаемся найти по дочерним
      query =   " select ch.t_XID, ch.t_Department "
              + "   from dcertif_upgr_dbt ch "
              + "  where ch.t_ParentXID = ? "
              + "    and ch.t_Department = ? ";
      cmd = DL_RSDCommand(query);
      cmd.AddParam(XID);
      cmd.AddParam(Department);

      DataSet = cmd.Execute();
      while((InvCardID == 0) and (DataSet.moveNext()))
        InvCardID = GetNewInvCardByOld(DataSet.XID, DataSet.Department);
      end;
    end;

    return InvCardID;
  END;

  if(XID != "")
    ICID = GetNewInvCardByOld(XID, Department);
    if(ICID == 0)
      err = 1;
      warning("Не найдена новая ИК для старой ИК " + XID + " с номером сертификата \""+Number+"\"");
    end;
  end;

  return err;

  OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
END;

//получить статус новой ИК по статусу старой
private macro GetInvCardStatusByCertifStatus(CertifStatus)
  var InvCardStatus = INVCARD_STATUS_UNKNOWN;

  if(CertifStatus == -1)
    InvCardStatus = INVCARD_STATUS_PLAN;
  elif(CertifStatus == 0)
    InvCardStatus = INVCARD_STATUS_INCUSTODY;
  elif(CertifStatus == 32000)
    InvCardStatus = INVCARD_STATUS_WRITEOFF;
  end;

  return InvCardStatus;
end;

//обновляем АО по ИК
//переносим данные из BLOB в CLOB
class (TDepoAdmoClobINVCARD) TUpgrDepoAdmoINVCARD

  macro GetAdmo(AdmOprID, admo)
    var query, cmd, DataSet;
    var err = 0;

    admo.Clear();

    query = "select * from ddepoadmo_dbt where t_AdmOprID = ? ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AdmOprID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( admo.rec );
    else
      err = 1;
      error("Не найдена АО с ID = " + AdmOprID);
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  private macro GetInvCardStatusOnDate(InvCardID:integer, OnDate:date)
    var cmd, DataSet;
    var Status = INVCARD_STATUS_UNKNOWN;

    cmd= DL_RSDCommand("select rsb_depo.icstatus(?, ?) as InvCardStatus from dual");
    cmd.AddParam(InvCardID);
    cmd.AddParam(OnDate);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Status = int(DataSet.InvCardStatus);
    end;

    return Status;
  end;

  macro ExecUpgrade()
    var query, cmd, DataSet;
    var offset;
    var cnt = 0, num = 0;
    var err = 0;
    var NullDigits = 0;
    var StartNumber = 0;
    var EndNumber = 0;
    var CurrNumber = 0;
    var AdmOprID = 0, InvCardID = 0;
    var NumberFirst, NumberLast;
    var admo = TRecHandler("depoadmo.dbt");
    

    message("Обновление АО по закрытому хранению.");

    query =         " select t_AdmOprID, t_Department, t_OperKind, t_CertifID, t_OperDate, ";

    offset = 1;
    query = query + QueryGetBlobInt32(@offset,  "AutoKey")         + ", "
                  + QueryGetBlobString(@offset, "Xid", 21)         + ", "
                  + QueryGetBlobInt32(@offset,  "FIID")            + ", "
                  + QueryGetBlobInt32(@offset,  "Issuer")          + ", "
                  + QueryGetBlobDate(@offset,   "IssuerDate")      + ", "
                  + QueryGetBlobMoney(@offset,  "FaceValue")       + ", "
                  + QueryGetBlobInt32(@offset,  "FaceValueFI")     + ", "
                  + QueryGetBlobString(@offset, "Series", 21)      + ", "
                  + QueryGetBlobString(@offset, "NumberFirst", 21) + ", "
                  + QueryGetBlobString(@offset, "NumberLast", 21)  + ", "
                  + QueryGetBlobInt32(@offset,  "Copies")          + ", "
                  + QueryGetBlobInt16(@offset,  "Status");

    query = query + "   from ddepoadmo_upgr_dbt " 
                  + "  where t_Item = "+SPDP_INVCARD;
    
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обновлению "+cnt+" АО");
    if(cnt > 0)

      InitProgress( cnt, "Идет обновление", "Обновление АО по закрытому хранению" );
      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи ddepoadmo_upgr_dbt.t_AdmOprID = " + DataSet.AdmOprID);

        err = GetAdmo(DataSet.AdmOprID, admo);
        if(err)
          break;
        end;

        /*if(DataSet.CertifID > 0)
          var cert = TBfile("certif.dbt");

          cert.Clear();
          cert.rec.AutoKey = DataSet.CertifID;
          cert.GetEQ();
          
          NumberFirst = cert.rec.NumberFirst;
          NumberLast  = cert.rec.NumberLast;
        else */
          if(DataSet.oldXID != "")
            NumberFirst = DataSet.oldNumberFirst;
            NumberLast  = DataSet.oldNumberLast;
          else
            NumberFirst = DataSet.newNumberFirst;
            NumberLast  = DataSet.newNumberLast;
          end;
        //end;

        if((NumberFirst != NumberLast) AND //это может быть только ИК с цифровыми номерами
           ((DataSet.OperKind == SPAO_CON_REGISTERING) OR (DataSet.OperKind == SPAO_CON_CLOSING))) //Прием на обслуживание или снятие с обслуживания диапазонной ИК 
          NullDigits = strlen(trim(NumberFirst));
          StartNumber = int(trim(NumberFirst));
          EndNumber = int(trim(NumberLast));

          CurrNumber = StartNumber;
          var i = 1;
          while((not err) and (CurrNumber <= EndNumber))

            oldData = TData();
            FindNewInvCardByOld(DataSet.oldXid, DataSet.Department, string(L_P(L_Z(CurrNumber,NullDigits), 20)), @oldData.InvCardID);
            oldData.Status = GetInvCardStatusByCertifStatus(DataSet.oldStatus);
            
            newData = TData();
            FindNewInvCardByOld(DataSet.newXid, DataSet.Department, string(L_P(L_Z(CurrNumber,NullDigits), 20)), @newData.InvCardID);
            newData.Status = GetInvCardStatusByCertifStatus(DataSet.newStatus);

            InvCardID = oldData.InvCardID;
            if(InvCardID == 0)
              InvCardID = newData.InvCardID;
            end;

            if(CurrNumber == StartNumber)
              //обновляем текущую АО
              AdmOprID = DataSet.AdmOprID;
            else
              var newadmo = TRecHandler("depoadmo.dbt");
              var ins_admo= RsbSQLInsert("depoadmo.dbt");
              var realAdmOprID = TArray();
              
              //создаем новую АО                     
              copy(newadmo, admo);

              newadmo.rec.AdmoprID = 0;
              newadmo.rec.OprXid = admo.rec.OprXid+"/"+string(i);
              newadmo.rec.CertifID = InvCardID;

              ins_admo.AddRecord(newadmo);
              ins_admo.AddReturning( "t_admoprid", V_INTEGER );

              if(not ins_admo.Insert())
                error("Ошибка при создании записи в ddepoadmo_dbt");
                err = 1;
              else
                ins_admo.GetReturning(realAdmOprID);
                AdmOprID = realAdmOprID[0];
              end;

              if(not err)
                SQL_Execute(  " update dspground_dbt "
                            + "    set t_References = t_References + 1 "
                            + "  where t_SPgroundID = " + newadmo.rec.Ground);
              end;

            end;
            
            if(not err)
              SQL_Execute(  " update ddepoadmo_dbt "
                          + "    set t_CertifID = " + InvCardID
                          + "  where t_AdmOprID = " + AdmOprID);

              err = SaveClobDataTMP(AdmOprID);
            end;

            CurrNumber = CurrNumber + 1;
            i = i + 1;
          end;
        else
          AdmOprID = DataSet.AdmOprID;

          oldData = TData();
          FindNewInvCardByOld(DataSet.oldXid, DataSet.Department, NumberFirst, @oldData.InvCardID);
          oldData.Status = GetInvCardStatusByCertifStatus(DataSet.oldStatus);

          newData = TData();
          FindNewInvCardByOld(DataSet.newXid, DataSet.Department, NumberFirst, @newData.InvCardID);
          newData.Status = GetInvCardStatusByCertifStatus(DataSet.newStatus);

          if((newData.InvCardID > 0) and (newData.Status == 0))
            newData.Status = GetInvCardStatusOnDate(newData.InvCardID, date(DataSet.OperDate));
          end;

          InvCardID = oldData.InvCardID;
          if(InvCardID == 0)
            InvCardID = newData.InvCardID;
          end;

          if(not err)
            SQL_Execute(  " update ddepoadmo_dbt "
                        + "    set t_CertifID = " + InvCardID
                        + "  where t_AdmOprID = " + AdmOprID);

            err = SaveClobDataTMP(AdmOprID);
          end;
        end;

        if(err)
          error("Ошибка при обновлении АО с ID = " + AdmOprID);
        end;

        UseProgress(num = num + 1);
      end;

      RemProgress();

    end;

    if(not err)
      message("Обработка АО по закрытому хранению выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

end;


//Обновление УЛ на счетах
//Перенос старых УЛ в новые таблицы
class TUpgrDepoAcap()
  var acapArr = TArray();

  //Найти доверенность
  private macro GetSignedDate(SPgroundID:integer):date
    var query, cmd, DataSet;
    var SignedDate = date(0,0,0);

    query =   " select t_SignedDate from dspground_dbt "
            + "  where t_SPGroundID = ? ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(SPgroundID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      SignedDate = date(DataSet.SignedDate);
    end;

    return SignedDate;
  end;

  //Найти оператора, если он возникает на текущем узле
  private macro GetOperatorIsOWN(AcntID:integer):integer
    var query, cmd, DataSet;
    var Operator = -1;

    query =   " select TO_NUMBER(t_Value) as Operator "
            + "   from ddepoatvl_dbt "
            + "  where t_IsType = CHR(0) "
            + "    and t_ID = ? "
            + "    and t_IsOwn = 'X' "
            + "    and t_AttrNum = 4 "; //Оператор  
    
    cmd = DL_RSDCommand(query);
    cmd.AddParam(AcntID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      Operator = int(DataSet.Operator);
    end;

    return Operator;
  end;

  //Получить дату прекращения полномочий оператора из последней записи в истории
  private macro GetLastDateHistOperator(AcntID:integer, dat:date):date
    var query, cmd, DataSet;
    var LastDate = date(0,0,0);

    cmd = DL_RSDCommand();

    query =   " select t_LastDate "
           + "   from ddpatvlhs_upgr_dbt "
           + "  where t_ID = ? "
           + "    and t_AttrNum = 4 "; //Оператор

    cmd.AddParam(AcntID);       

    if(dat > date(0,0,0))
      query = query + " and t_LastDate < ?";
      cmd.AddParam(dat);
    end;

    query = query + "  order by t_LastDate DESC";
    
    DataSet = cmd.Execute(query);
    if(DataSet.moveNext())
      LastDate = date(DataSet.LastDate);
    end;

    return LastDate;
  end;


  //добавить право для УЛ на узле
  private macro InsertACAPAU(APID:integer,    
                             AUNodeID:integer,
                             AuthKind:integer
                            )
    var acapau = TRecHandler("dpacapau.dbt");
    var ins_acapau = RsbSQLInsert("dpacapau.dbt");
    var stat = 0;

    acapau.Clear();
    
    acapau.rec.APID     = APID;
    acapau.rec.AUNodeID = AUNodeID;
    acapau.rec.AuthKind = AuthKind;

    ins_acapau.AddRecord(acapau);

    stat = ins_acapau.Insert();

    return stat;
  end;

  //добавить УЛ
  private macro InsertACAP(acap:TRecHandler, AUAcntID:integer)
    var ins_acap = RsbSQLInsert("dpacap.dbt");
    var realAPID = TArray();
    var err = 0;

    acap.rec.APID = 0;
    acap.rec.IsAllFI = SET_CHAR;

    ins_acap.AddRecord(acap);
    ins_acap.AddReturning( "t_apid", V_INTEGER );

    if(ins_acap.Insert())
      ins_acap.GetReturning(realAPID);
      acap.rec.APID = realAPID[0];

      if(InsertACAPAU(acap.rec.APID, AUAcntID, OBJTYPE_DEPOAUTHORITY_WRITEOFF) == 0)
        err = 1;
      end;
      if((not err) and (InsertACAPAU(acap.rec.APID, AUAcntID, OBJTYPE_DEPOAUTHORITY_ENROL) == 0))
        err = 1;
      end;
      if((not err) and (InsertACAPAU(acap.rec.APID, AUAcntID, OBJTYPE_DEPOAUTHORITY_STORAGECHANGE) == 0))
        err = 1;
      end;

    else
      err = 1;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //получить юридическую форму субъекта
  private macro GetPartyLegalForm(PartyID:integer):integer
    var LegalForm = PTLEGF_ALL;
    var pt = TBFile("party.dbt");

    pt.rec.PartyID = PartyID;
    if(pt.GetEQ())
      LegalForm = pt.rec.LegalForm;
    end;

    return LegalForm;
  end;

  //проверить, есть ли уже такое распорядитель на счете
  private macro ExistsManager(AgentID:integer, DepoRoot:integer)
    var cmd;
    var exists = false;

    cmd = DL_RSDCommand("select 1 from ddpacap_dbt where t_APartyID = ? and t_APNodeID = ? and t_Role = ?");
    cmd.AddParam(AgentID);
    cmd.AddParam(DepoRoot);
    cmd.AddParam(DEPOACAPROLE_MANAGER);

    if(cmd.GetCount() > 0)
      exists = true;
    end;

    return exists;
  end;

  private macro GetProcurID(SPGroundID, AgentID)
    var ProcurID = 0;
    var query, cmd, DataSet;

    query = "select t_ProcurID from ddpprocur_dbt where t_SPgroundID = ? and t_AgentID = ?";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(SPGroundID);
    cmd.AddParam(AgentID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      ProcurID = int(DataSet.ProcurID);
    end;

    return ProcurID;
  end;


  macro ExecUpgrade()
    var query, cmd, acnt;
    var cnt = 0, num = 0;
    var acap = TRecHandler("dpacap.dbt");
    var procur = TRecHandler("dpprocur.dbt");
    var err = 0;

    message("Обновление уполномоченных лиц");

    //Почистим на всякий случай - до обновления там ничего быть не должно было
    SQL_Execute( " delete from ddpacap_dbt ", "", true );
    SQL_Execute( " delete from ddpacapau_dbt ", "", true );

    //Для каждого ПАССИВНОГО счета депо 
    query =   " select * "
            + "   from ddepoacnt_upgr_dbt "
            + "  where t_Kind = 2 "
            + "  order by t_Level asc";
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обновлению "+cnt+" счетов и разделов");
    if(cnt > 0)
      InitProgress( cnt, "Идет обновление", "Обновление уполномоченных лиц" );

      acnt = cmd.Execute();
      while((not err) and (acnt.moveNext()))

        message("Обновление по записи ddepoacnt_upgr_dbt.t_AutoKey = " + acnt.AutoKey);

        //Если на счете депо задан Попечитель (и он не равен Депоненту счета)
        if((acnt.Root == acnt.AutoKey) and (acnt.HasCurator == SET_CHAR) and (acnt.Operator != acnt.Owner))

          if(GetPartyLegalForm(acnt.Operator) != PTLEGF_PERSN)
            warning("Попечитель (PartyID = "+acnt.Operator+") счета "+acnt.BriefCode+" не является физическим лицом. УЛ не добавлено.");
          else

            acap.Clear();
            acap.rec.APID      = 0;        
            acap.rec.APNodeID  = acnt.AutoKey;    
            acap.rec.APartyID  = acnt.Operator;    
            acap.rec.Role      = DEPOACAPROLE_CURATOR;        
            acap.rec.Principal = -1;   
            acap.rec.ToDate    = date(0,0,0);      

            if(acnt.OperGround > 0)
              acap.rec.APartyGround = GetProcurID(acnt.OperGround,acap.rec.APartyID);
              acap.rec.FromDate = GetSignedDate(acnt.OperGround);
            end;

            if(acap.rec.FromDate == date(0,0,0))
              acap.rec.FromDate = date(acnt.OpenDate);
            end;
            
            err = InsertACAP(acap, acnt.AutoKey);
          end;
        end;

        //Для каждого раздела счета депо, на котором ВОЗНИКАЕТ характеристика Оператор (и она не равна Депоненту счета), 
        if((not err) and (acnt.Root != acnt.AutoKey))
          var Operator = GetOperatorIsOWN(acnt.AutoKey);
          if((Operator > 0) and (Operator != acnt.Owner))
            acap.Clear();
            acap.rec.APID      = 0;        
            acap.rec.APNodeID  = acnt.Root;    
            acap.rec.APartyID  = Operator;    
            acap.rec.Role      = DEPOACAPROLE_OPERATOR;        
            acap.rec.Principal = -1;   
            acap.rec.ToDate    = date(0,0,0);      

            if(acnt.OperGround > 0)
              acap.rec.APartyGround = GetProcurID(acnt.OperGround,acap.rec.APartyID);
              acap.rec.FromDate = GetSignedDate(acnt.OperGround);
            end;

            acap.rec.FromDate = GetLastDateHistOperator(acnt.AutoKey, date(0,0,0));
            if(acap.rec.FromDate > date(0,0,0))
              acap.rec.FromDate = acap.rec.FromDate + 1;
            else
              acap.rec.FromDate = GetSignedDate(acnt.OperGround);
            end;

            if(acap.rec.FromDate == date(0,0,0))
              acap.rec.FromDate = date(acnt.OpenDate);
            end;
            
            err = InsertACAP(acap, acnt.AutoKey);
          end;

          //Для каждой записи в истории изменений характеристики "Оператор" (которая при этом не равна Депоненту счета)
          if(not err)
            var cmdHist, DataSetHist;
            var PrevLastDate = date(0,0,0);

            cmdHist = DL_RSDCommand("select TO_NUMBER(t_Value) as Operator, t_LastDate from ddpatvlhs_upgr_dbt where t_ID = ?");
            cmdHist.AddParam(acnt.AutoKey);

            DataSetHist = cmdHist.Execute();
            while((not err) and (DataSetHist.moveNext()))
              if(int(DataSetHist.Operator) != acnt.Owner)
                PrevLastDate = GetLastDateHistOperator(acnt.AutoKey, date(DataSetHist.LastDate));

                acap.Clear();
                acap.rec.APID      = 0;        
                acap.rec.APNodeID  = acnt.Root;    
                acap.rec.APartyID  = int(DataSetHist.Operator);    
                acap.rec.Role      = DEPOACAPROLE_OPERATOR;        
                acap.rec.Principal = -1;   
                acap.rec.FromDate  = PrevLastDate + 1;
                acap.rec.ToDate    = date(DataSetHist.LastDate);      
                
                err = InsertACAP(acap, acnt.AutoKey);
              end;
            end;
          end;
        end;

        //Для счета депо и его разделов, где определяется характеристика "Оператор" если на них определены "Распорядители" (при этом не равные Депоненту счета)
        if(not err)
          var queryAG, cmdAG, DataSetAG;

          queryAG = "select * from ddpagacc_upgr_dbt where t_DepoAccID = ? and t_AgentID <> ?";
          cmdAG = DL_RSDCommand(queryAG);
          cmdAG.AddParam(acnt.AutoKey);
          cmdAG.AddParam(acnt.Owner);

          DataSetAG = cmdAG.Execute();
          while((not err) and (DataSetAG.moveNext()))
            acap.Clear();
            acap.rec.APID      = 0;        
            acap.rec.APNodeID  = acnt.Root;    
            acap.rec.APartyID  = int(DataSetAG.AgentID);    
            acap.rec.Role      = DEPOACAPROLE_MANAGER;        
            
            if(acnt.AutoKey == acnt.Root)
              acap.rec.Principal = acnt.Owner;
            else  
              acap.rec.Principal = acnt.Operator;   
            end;
            acap.rec.APartyGround = GetProcurID(int(DataSetAG.Ground),acap.rec.APartyID);

            acap.rec.FromDate = GetSignedDate(int(DataSetAG.Ground));
            if(acap.rec.FromDate == date(0,0,0))
              acap.rec.FromDate = date(acnt.OpenDate);
            end;

            acap.rec.ToDate    = date(0,0,0);

            if(ExistsManager(acap.rec.APartyID, acap.rec.APNodeID))
              //просто пропускаем, т.к. на счете уже есть такой распорядитель
            elif(GetPartyLegalForm(acap.rec.APartyID) != PTLEGF_PERSN)
              warning("Распорядитель (PartyID = "+acap.rec.APartyID+") счета/раздела "+acnt.BriefCode+" не является физическим лицом. УЛ не добавлено.");
            elif(GetPartyLegalForm(acap.rec.Principal) != PTLEGF_INST)
              warning("Субъект (PartyID = "+acnt.Operator+"), назначивший распорядителя счета/раздела "+acnt.BriefCode+", не является юридическим лицом. УЛ не добавлено.");
            else
              err = InsertACAP(acap, acnt.AutoKey);
            end;
          end;

        end;
                                                           
        UseProgress(num = num + 1);
      end;

      RemProgress();

      if(not err)
        message("Обработка уполномоченных лиц выполнена успешно");
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

end;

//создасть запись о сертификате
private macro InsertFICERT(AvoirKind:integer, CertID:integer, FiCertID:@integer)
  var ficert = TRecHandler("ficert.dbt");
  var ins_ficert = RsbSQLInsert("ficert.dbt");
  var realFiCertID = TArray();
  var err = 0;

  ficert.Clear();
  
  ficert.rec.FiCertID  = 0;
  ficert.rec.AvoirKind = AvoirKind;
  ficert.rec.CertID    = CertID;

  ins_ficert.AddRecord(ficert);
  ins_ficert.AddReturning( "t_ficertid", V_INTEGER );

  if(not ins_ficert.Insert())
    err = 1;
  else
    ins_ficert.GetReturning(realFiCertID);
    FiCertID = realFiCertID[0];
    message("Создан новый сертификат dficert_dbt.t_FiCertID = " + FiCertID);
  end;

  return err;

  OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
end;
/* Получить новые значения noteKind*/
private macro GetNewNoteKind(oldObjType, oldNoteKind)
  var newNoteKind = oldNoteKind;
  if (651 == oldObjType) // вексель
    if (1 == oldNoteKind)
      newNoteKind = 4; // Номер бланка
    elif (2 == oldNoteKind)
      newNoteKind = 9; // Справедливая стоимость ПФИ
    end;
  elif (674 == oldObjType) // банковский сертификат
    if (1 == oldNoteKind)
      newNoteKind = 10; // Справедливая стоимость для формы 115
    end;
  end;
  return newNoteKind;
end;

//перенести примечания со старого объекта на новый
private macro RemoveNotetext(OldObjType, OldObjID, NewObjType, NewObjID)
  var nt = TRecHandler("notetext.dbt");
  var newnt = TRecHandler("notetext.dbt");
  var ins_nt= RsbSQLInsert("notetext.dbt");
  var cmdNT, DataSetNT;
  var cnt = 0;
  var err = 0;

  cmdNT = DL_RSDCommand("select * from dnotetext_dbt where t_ObjectType = ? and t_DocumentID = ?");
  cmdNT.AddParam(OldObjType);
  cmdNT.AddParam(string(OldObjID));

  cnt = cmdNT.GetCount();
  if(cnt)
    DataSetNT = cmdNT.Execute();

    while(DataSetNT.moveNext())
      DataSetNT.GetRecord().CopyTo( nt.rec );

      copy(newnt, nt);

      newnt.rec.ID         = 0;
      newnt.rec.ObjectType = NewObjType;
      newnt.rec.NoteKind   = GetNewNoteKind(oldObjType, DataSetNT.NoteKind);
      newnt.rec.DocumentID = string(NewObjID);

      ins_nt.AddRecord(newnt);
    end;

    if(not ins_nt.Insert())
      err = 1;
    end;

    if(not err)
      SQL_Execute("delete from dnotetext_dbt where t_ObjectType = "+OldObjType+" and t_DocumentID = '"+string(OldObjID)+"'", "Удаление примечаний", false );
    end;
  end;

  return err;

  OnError(er)
    error(er.module+ " "+er.line+" "+er.message);
    return 1;
end;

/* Получить новые значения GroupID */
private macro GetNewGroupID(oldObjType, oldGroupID)
  var newGroupID = oldGroupID;
  if (651 == oldObjType) // вексель
    if (2 == oldGroupID)
      newGroupID = 3; // Категория качества
    end;
  elif (674 == oldObjType) // банковский сертификат
    if (1 == oldGroupID)
      newGroupID = 4; // Уровень исходных данных иерархии СС МСФО 13
    end;
  end;
  return newGroupID;
end;

//перенести категории со старого объекта на новый
private macro RemoveObjatcor(OldObjType, OldObjID, NewObjType, NewObjID)
  var cat = TRecHandler("objatcor.dbt");
  var newcat = TRecHandler("objatcor.dbt");
  var ins_cat= RsbSQLInsert("objatcor.dbt");
  var cmdCAT, DataSetCAT;
  var cnt = 0;
  var err = 0;

  cmdCAT = DL_RSDCommand("select * from dobjatcor_dbt where t_ObjectType = ? and t_Object = ?");
  cmdCAT.AddParam(OldObjType);
  cmdCAT.AddParam(string(OldObjID));

  cnt = cmdCAT.GetCount();
  if(cnt)
    DataSetCAT = cmdCAT.Execute();

    while(DataSetCAT.moveNext())
      DataSetCAT.GetRecord().CopyTo( cat.rec );

      copy(newcat, cat);

      newcat.rec.ObjectType = NewObjType;
      newcat.rec.GroupID    = GetNewGroupID(OldObjType, DataSetCAT.GroupID);
      newcat.rec.Object     = string(NewObjID);

      ins_cat.AddRecord(newcat);
    end;

    if(not ins_cat.Insert())
      err = 1;
    end;

    if(not err)
      SQL_Execute("delete from dobjatcor_dbt where t_ObjectType = "+OldObjType+" and t_Object = '"+string(OldObjID)+"'", "Удаление категорий", false );
    end;
  end;
  
  return err;

  OnError(er)
    error(er.module+ " "+er.line+" "+er.message);
    return 1;
end;


//Обновление закрытого хранения
//Перенос данных в новые таблицы
class TUpgrDepoInvcard()
  private var DataSetIC;

  private macro GetAccountID(Account:string, FIID:integer):integer
    var cmd, DataSet;
    var AccountID = 0;

    cmd = DL_RSDCommand("select t_AccountID from daccount_dbt where t_Account = ? and t_Code_Currency = ? and t_Chapter = ?");
    cmd.AddParam(Account);
    cmd.AddParam(FIID);
    cmd.AddParam(5);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      AccountID = int(DataSet.AccountID);
    end;

    return AccountID;
  end;

  //создасть запись соответствия старой ИК и новой
  private macro InsertInvCorr(CertifID:integer, InvCardID:integer)
    var sql;

    sql = " INSERT INTO dinvcorrtable_dbt  "
      + " ( t_CertifID, "
      +   " t_InvCardID ) VALUES ("
      + CertifID + ", "
      + InvCardID + ") ";

    SQL_Execute(sql,"Заполнение временной таблицы соответствия", false);

    return 0;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  private macro CreateNewICNumber(OldNumber:string, ind:integer, NewNumber:@string)
    var OldNumLen = strlen(OldNumber);
    var indLen    = strlen(string(DataSetIC.Copies));
    var correctLen = OldNumLen + indLen + 1 - 20;
    var err = 0;
    
    NewNumber = "";

    if(ind == 0)
      NewNumber = OldNumber;
    else
      if(correctLen > 0)
        //если номер дистрибутивный, то отрежем лидирующие нули, чтобы новый номер влез в поле
        if(substr(OldNumber, 1, 2) == "##")
          if(substr(OldNumber, 3, correctLen) != L_Z(0, correctLen))
            error("Ошибка. Невозможно сформировать новый номер для ИК " + OldNumber);
            err = 1;
          else
            //нулей хватает
            NewNumber = "##"+substr(OldNumber, 3+correctLen)+"/"+L_Z(ind, indLen);
          end;
        else
          error("Ошибка. Невозможно сформировать новый номер для ИК " + OldNumber);
          err = 1;
        end;
      else
        NewNumber = OldNumber+"/"+L_Z(ind, indLen); 
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  private macro ExistsInvChng(InvCardID, ID_Operation, ID_Step)
    var cmd, DataSet;
    var exists = false;

    cmd = DL_RSDCommand("select 1 from dinvchng_dbt where t_InvCardID = ? and t_ID_Operation = ? and t_ID_Step = ?");
    cmd.AddParam(InvCardID);
    cmd.AddParam(ID_Operation);
    cmd.AddParam(ID_Step);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      exists = true;
    end;

    return exists;
  end;

  //перенести историю прежней ИК на новую ИК
  private macro RemoveICHist(OldXID, Department, invcard)
        
    var cmdCH, DataSetCH;
    var invchng = TRecHandler("invchng.dbt");
    var ins_invchng = RsbSQLInsert("invchng.dbt");
    var err = 0;  

    cmdCH = DL_RSDCommand("select * from dcertchng_dbt where t_Xid = ? and t_Department = ?");
    cmdCH.AddParam(OldXID);
    cmdCH.AddParam(Department);

    if(cmdCH.GetCount() > 0)
      DataSetCH = cmdCH.Execute();
      while(DataSetCH.moveNext())

        invchng.Clear();

        invchng.rec.InvChngID     = 0;
        invchng.rec.InvCardID     = invcard.rec.InvCardID;
        invchng.rec.ChangeDate    = date(DataSetCH.OldChangeDate);
        invchng.rec.Number        = invcard.rec.Number;

        if(DataSetCH.OldStatus == -1)
          invchng.rec.Status = INVCARD_STATUS_PLAN;
        elif(DataSetCH.OldStatus == 0)
          invchng.rec.Status = INVCARD_STATUS_INCUSTODY;
        elif(DataSetCH.OldStatus == 32000)
          invchng.rec.Status = INVCARD_STATUS_WRITEOFF;
        end;

        invchng.rec.StatusDate    = date(DataSetCH.OldStatusDate);
        invchng.rec.LAccountID    = GetAccountID(DataSetCH.LAccount, DataSetCH.FIID);
        invchng.rec.HAccountID    = GetAccountID(DataSetCH.HAccount, DataSetCH.FIID);
        invchng.rec.Section       = DataSetCH.OldSection;
        invchng.rec.Cell          = DataSetCH.OldCell;
        invchng.rec.ID_Operation  = DataSetCH.ID_Operation;
        invchng.rec.ID_Step       = DataSetCH.ID_Step;

        if(ExistsInvChng(invchng.rec.InvCardID, invchng.rec.ID_Operation, invchng.rec.ID_Step) == false)
          ins_invchng.AddRecord(invchng);
        end;
      end;

      if(not ins_invchng.Insert())
        err = 1; 
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  private macro CreateINVCARD(FiCertID:integer, ind:integer)
    var invcard = TRecHandler("invcard.dbt");
    var ins_invcard = RsbSQLInsert("invcard.dbt");
    var realInvCardID = TArray();
    var err = 0;

    invcard.Clear();
    
    err = CreateNewICNumber(DataSetIC.XID, ind, @invcard.rec.Number);
    if(not err)

      invcard.rec.InvCardID   = 0;
      invcard.rec.FiCertID    = FiCertID;                 
      invcard.rec.Department  = DataSetIC.Department;      
      invcard.rec.Branch      = DataSetIC.Branch;          
      
      if(DataSetIC.Status == -1)
        invcard.rec.Status = INVCARD_STATUS_PLAN;
      elif(DataSetIC.Status == 0)
        invcard.rec.Status = INVCARD_STATUS_INCUSTODY;
      elif(DataSetIC.Status == 32000)
        invcard.rec.Status = INVCARD_STATUS_WRITEOFF;
      end;

      invcard.rec.StatusDate  = date(DataSetIC.StatusDate);
      invcard.rec.Description = DataSetIC.Description;    
      invcard.rec.LAccountID  = GetAccountID(DataSetIC.LAccount, DataSetIC.FIID);   
      invcard.rec.HAccountID  = GetAccountID(DataSetIC.HAccount, DataSetIC.FIID);
      invcard.rec.Section     = DataSetIC.Section;             
      invcard.rec.Cell        = DataSetIC.Cell;                
      invcard.rec.RegistrDate = date(DataSetIC.RegistrDate);         
      invcard.rec.RegistrTime = time(DataSetIC.RegistrTime);         
      invcard.rec.Oper        = DataSetIC.Oper;                
      invcard.rec.ChangeDate  = DataSetIC.ChangeDate;          

      ins_invcard.AddRecord(invcard);
      ins_invcard.AddReturning( "t_invcardid", V_INTEGER );

      if(not ins_invcard.Insert())
        err = 1;
        error("Ошибка при сохранении ИК");
      else
        ins_invcard.GetReturning(realInvCardID);
        invcard.rec.InvCardID = realInvCardID[0];

        err = InsertInvCorr(DataSetIC.AutoKey, invcard.rec.InvCardID);

        if(not err)
          err = RemoveICHist(DataSetIC.XID, DataSetIC.Department, invcard);
          if(err)
            error("Ошибка при сохранении истории ИК");
          end;
        end;
 
        //добавить также историю от родительских карточек
        if(not err)
          var ParentXID = DataSetIC.ParentXID;
          var cmdP, DataSetP;
          while((not err) and (ParentXID != ""))

            err = RemoveICHist(ParentXID, DataSetIC.Department, invcard);

            if(not err)
              cmdP = DL_RSDCommand("select t_ParentXID from dcertif_upgr_dbt where t_XID = ? and t_Department = ?");
              cmdP.AddParam(ParentXID);
              cmdP.AddParam(DataSetIC.Department);

              DataSetP = cmdP.Execute();
              if(DataSetP.moveNext())
                ParentXID = DataSetP.ParentXID;
              else
                ParentXID = "";
              end;
            end;

            if(err)
              error("Ошибка при сохранении истории родительских ИК");
            end;
          end;
        end;
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //перенести агентов
  private macro RemoveVsircag(OldBCID, NewBCID, AvoirKind)
    var ag = TRecHandler("vsircag.dbt");
    var newag = TRecHandler("vsircag.dbt");
    var ins_ag = RsbSQLInsert("vsircag.dbt");
    var cmdAG, DataSetAG;
    var cnt = 0;
    var err = 0;

    cmdAG = DL_RSDCommand("select * from dvsircag_dbt where t_BCID = ? and t_AvoirKind = ?");
    cmdAG.AddParam(OldBCID);
    cmdAG.AddParam(AvoirKind);

    cnt = cmdAG.GetCount();
    if(cnt)
      DataSetAG = cmdAG.Execute();

      while(DataSetAG.moveNext())
        DataSetAG.GetRecord().CopyTo( ag.rec );

        copy(newag, ag);

        newag.rec.ID = 0;
        newag.rec.BCID = NewBCID;

        ins_ag.AddRecord(newag);
      end;

      if(not ins_ag.Insert())
        err = 1;
      end;

      if(not err)
        SQL_Execute("delete from dvsircag_dbt where t_BCID = "+OldBCID+" and t_AvoirKind = "+AvoirKind, "Удаление агентов", false );
      end;

    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //перенести представителей
  private macro RemoveProxy(OldObjType, OldObjID, NewObjType, NewObjID)
    var proxy = TRecHandler("dl_proxy.dbt");
    var newproxy = TRecHandler("dl_proxy.dbt");
    var ins_proxy = RsbSQLInsert("dl_proxy.dbt");
    var cmdPR, DataSetPR;
    var cnt = 0;
    var err = 0;

    cmdPR = DL_RSDCommand("select * from ddl_proxy_dbt where t_DocKind = ? and t_ContractID = ?");
    cmdPR.AddParam(OldObjType);
    cmdPR.AddParam(OldObjID);

    cnt = cmdPR.GetCount();
    if(cnt)
      DataSetPR = cmdPR.Execute();

      while(DataSetPR.moveNext())
        DataSetPR.GetRecord().CopyTo( proxy.rec );

        copy(newproxy, proxy);

        newproxy.rec.DocKind    = NewObjType;
        newproxy.rec.ContractID = NewObjID;

        ins_proxy.AddRecord(newproxy);
      end;

      if(not ins_proxy.Insert())
        err = 1;
      end;

      if(not err)
        SQL_Execute("delete from ddl_proxy_dbt where t_DocKind = "+OldObjType+" and t_ContractID = "+OldObjID, "Удаление представителей", false );
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //перенести ЧП закладной
  private macro RemoveMortpay(OldMortgageID, NewMortgageID)
    var mortpay = TRecHandler("mortpay.dbt");
    var newmortpay = TRecHandler("mortpay.dbt");
    var ins_mortpay = RsbSQLInsert("mortpay.dbt");
    var cmdMP, DataSetMP;
    var cnt = 0;
    var err = 0;

    cmdMP = DL_RSDCommand("select * from dmortpay_dbt where t_MortgageID = ?");
    cmdMP.AddParam(OldMortgageID);

    cnt = cmdMP.GetCount();
    if(cnt)
      DataSetMP = cmdMP.Execute();

      while(DataSetMP.moveNext())
        DataSetMP.GetRecord().CopyTo( mortpay.rec );

        copy(newmortpay, mortpay);

        newmortpay.rec.MortpayID  = 0;
        newmortpay.rec.MortgageID = NewMortgageID;

        ins_mortpay.AddRecord(newmortpay);
      end;

      if(not ins_mortpay.Insert())
        err = 1;
      end;

      if(not err)
        SQL_Execute("delete from dmortpay_dbt where t_MortgageID = "+OldMortgageID, "Удаление ЧП закладной", false );
      end;

    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //создать сертификат векселя для текущей ИК
  private macro CreateBillIC(CurrICNumber:string, ind:integer)
    var bnrIC, legIC, cmd, query;
    var err = 0;

    var FiCertID = 0;

    cmd = DL_RSDCommand(  " select * " 
                        + "   from dvsbanner_upgr_dbt"
                        + "  where t_InventoryXID = ? "
                        + "    and t_Department = ? "
                        + "    and t_BCFormKind = ? "
                        + "    and t_FIID = ? "
                       );
    cmd.AddParam(DataSetIC.XID);
    cmd.AddParam(DataSetIC.Department);
    cmd.AddParam(20/*VSBANNER_FORMKIND_INVCARD*/);
    cmd.AddParam(DataSetIC.FIID);

    bnrIC = cmd.Execute();

    if(not bnrIC.moveNext())
      error("Не найдены параметры векселя для ИК "+DataSetIC.XID);
      err = 1;
    end;

    if(not err)
      cmd = DL_RSDCommand(  " select * " 
                        + "   from ddl_leg_upgr_dbt "
                        + "  where t_DealID = ? "
                        + "    and t_LegKind = ? "
                        + "    and t_LegID = 0 "
                       );
      cmd.AddParam(bnrIC.BCID);
      cmd.AddParam(LEG_KIND_VSBANNER);
      
      legIC = cmd.Execute();

      if(not legIC.moveNext())
        error("Не найдены ценовые условия векселя для ИК "+DataSetIC.XID);
        err = 1;
      end;
    end;

    //1. Сначала пытаемся найти существующий.
    if(not err)
      var vficert;
      
      cmd = DL_RSDCommand(  " select t_FiCertID "
                          + "   from dv_ficert_dbt "
                          + "  where t_FIID = ? "
                          + "    and t_Issuer = ? "
                          + "    and t_IssueDate = ? "
                          + "    and t_FaceValueFI = ? "
                          + "    and t_FaceValue = ? "
                          + "    and t_Series = ? "
                          + "    and t_Number = ? "
                         );
      cmd.AddParam(DataSetIC.FIID);
      cmd.AddParam(DataSetIC.Issuer);
      cmd.AddParam(date(DataSetIC.IssuerDate));
      cmd.AddParam(legIC.PFI);
      cmd.AddParam(legIC.Principal);
      cmd.AddParam(DataSetIC.Series);
      cmd.AddParam(CurrICNumber);

      vficert = cmd.Execute();
      if(vficert.moveNext())
        FiCertID = int(vficert.FiCertID);
        message("Найден существующий сертификат dficert_dbt.t_FiCertID = " + FiCertID);
      end;
    end;

    //2. Если не нашли, то создаем сертификат на основе ИК
    if((not err) and (FiCertID == 0))
      var bnr = TRecHandler("vsbanner.dbt"); 
      var leg = TRecHandler("dl_leg.dbt");
      var ins_bnr = RsbSQLInsert("vsbanner.dbt");
      var ins_leg = RsbSQLInsert("dl_leg.dbt");
      var realBCID = TArray();
      
      bnrIC.GetRecord().CopyTo( bnr.rec );

      bnr.rec.BCID         = 0;
      bnr.rec.BCFormKind   = 1;/*VSBANNER_FORMKIND_SIMPLE*/
      bnr.rec.BCSeries     = DataSetIC.Series;
      bnr.rec.BCNumber     = CurrICNumber;
      bnr.rec.InventoryXID = "";

      ins_bnr.AddRecord(bnr);
      ins_bnr.AddReturning( "t_bcid", V_INTEGER );

      if(not ins_bnr.Insert())
        error("Ошибка при создании записи в dvsbanner_dbt при обработке ИК "+DataSetIC.XID);
        err = 1;
      else
        ins_bnr.GetReturning(realBCID);
        bnr.rec.BCID = realBCID[0];
      end;

      if(not err)
        if(ValType(legIC.SupplyTime) == V_UNDEF)
          legIC.SupplyTime = time(0);
        end;

        legIC.GetRecord().CopyTo( leg.rec );

        leg.rec.ID     = 0;
        leg.rec.DealID = bnr.rec.BCID;

        ins_leg.AddRecord(leg);

        if(not ins_leg.Insert())
          error("Ошибка при создании записи в ddl_leg_dbt при обработке ИК "+DataSetIC.XID);
          err = 1;
        end;
      end;

      //перенести агентов
      if(not err)
        err = RemoveVsircag(bnrIC.rec.BCID, bnr.rec.BCID, DataSetIC.RootAvoirKind);
        if(err)
          error("Ошибка переноса агентов с ИК "+DataSetIC.XID);
        end;
      end;

      //создать сертификат
      if(not err)
        err = InsertFICERT(DataSetIC.AvoirKind, bnr.rec.BCID, @FiCertID);
        if(err)
          error("Ошибка вставки сертификата при обработке ИК "+DataSetIC.XID);
        end;
      end;
      
      //перенести примечания
      if(not err)
        err = RemoveNotetext(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса примечаний с ИК "+DataSetIC.XID);
        end;
      end;

      //перенести категории
      if(not err)
        err = RemoveObjatcor(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса категорий с ИК "+DataSetIC.XID);
        end;
      end;
    end;

    //3.Создать новую ИК
    if(not err)
      err = CreateINVCARD(FiCertID, ind);
      if(err)
        error("Ошибка обработки ИК "+DataSetIC.XID);
      end;
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //создать сертификат БС для текущей ИК
  private macro CreateCertIC(CurrICNumber:string, ind:integer)
    var savecertIC, legIC, cmd, query;
    var fin = TBFile("fininstr.dbt");
    var err = 0;
    
    var FiCertID = 0;

    fin.rec.FIID = DataSetIC.FIID;
    if(not fin.GetEQ())
      err = 1;
    end;

    if(not err)
      cmd = DL_RSDCommand(  " select * " 
                          + "   from dsavecert_upgr_dbt"
                          + "  where t_CertifID = ? "
                         );
      cmd.AddParam(DataSetIC.AutoKey);

      savecertIC = cmd.Execute();

      if(not savecertIC.moveNext())
        error("Не найдены параметры БС для ИК "+DataSetIC.XID);
        err = 1;
      end;

      if(not err)
        cmd = DL_RSDCommand(  " select * " 
                          + "   from ddl_leg_upgr_dbt "
                          + "  where t_DealID = ? "
                          + "    and t_LegKind = ? "
                          + "    and t_LegID = 0 "
                         );
        cmd.AddParam( savecertIC.SaveCertID);
        cmd.AddParam(LEG_KIND_DL_DEPOCERT);
        
        legIC = cmd.Execute();

        if(not legIC.moveNext())
          error("Не найдены ценовые условия БС для ИК "+DataSetIC.XID);
          err = 1;
        end;
      end;
    end;

    //1. Сначала пытаемся найти существующий.
    if(not err)
      var vficert;
      
      cmd = DL_RSDCommand(  " select t_FiCertID "
                          + "   from dv_ficert_dbt "
                          + "  where t_FIID = ? "
                          + "    and t_Issuer = ? "
                          + "    and t_IssueDate = ? "
                          + "    and t_FaceValueFI = ? "
                          + "    and t_FaceValue = ? "
                          + "    and t_Series = ? "
                          + "    and t_Number = ? "
                         );
      cmd.AddParam(DataSetIC.FIID);
      cmd.AddParam(DataSetIC.Issuer);
      cmd.AddParam(date(DataSetIC.IssuerDate));
      cmd.AddParam(legIC.PFI);
      cmd.AddParam(legIC.Principal);
      cmd.AddParam(DataSetIC.Series);
      cmd.AddParam(CurrICNumber);

      vficert = cmd.Execute();
      if(vficert.moveNext())
        FiCertID = int(vficert.FiCertID);
        message("Найден существующий сертификат dficert_dbt.t_FiCertID = " + FiCertID);
      end;
    end;

    //2. Если не нашли, то создаем сертификат на основе ИК
    if((not err) and (FiCertID == 0))
      var bnr = TRecHandler("vsbanner.dbt"); 
      var leg = TRecHandler("dl_leg.dbt");
      var ins_bnr = RsbSQLInsert("vsbanner.dbt");
      var ins_leg = RsbSQLInsert("dl_leg.dbt");
      var realBCID = TArray();
      
                                                     
      bnr.Clear();

      bnr.rec.BCID               = 0;                                 
      bnr.rec.RegistrationDate   = date(DataSetIC.RegistrDate);       
      bnr.rec.RegistrationTime   = time(DataSetIC.RegistrTime);       
      bnr.rec.IssueKind          = 0;                                 
      bnr.rec.Issuer             = DataSetIC.Issuer;                  
      bnr.rec.IssuerTaxCode      = GetPartyINN(DataSetIC.Issuer);                                
      bnr.rec.IssuerName         = GetPartyName(DataSetIC.Issuer);    
      bnr.rec.IssuerAddress      = GetPartyAddress(DataSetIC.Issuer); 
      bnr.rec.IssueDate          = date(DataSetIC.IssuerDate);        
      bnr.rec.IssuePlace         = "";                                
      bnr.rec.BCSeries           = DataSetIC.Series;                  
      bnr.rec.BCNumber           = CurrICNumber;                      
      bnr.rec.Holder             = savecertIC.OwnerID;                
      bnr.rec.HolderTaxCode      = GetPartyINN(savecertIC.OwnerID);                                
      bnr.rec.HolderName         = GetPartyName(savecertIC.OwnerID);  
      bnr.rec.HolderAddress      = savecertIC.OwnerAddress;           
      bnr.rec.PaymentPlace       = "";                                
      bnr.rec.Flags              = 0;                                 
      bnr.rec.BCStatus           = 0;                                 
      bnr.rec.RepaymentDate      = date(DataSetIC.DrawingDate);       
      bnr.rec.Oper               = DataSetIC.Oper;                   
      bnr.rec.Department         = DataSetIC.Department;             
      bnr.rec.OnCallRate         = legIC.Factor;             
      bnr.rec.OnCallRatePoint    = 0;        
      bnr.rec.OnCallRateScale    = 0;        
      bnr.rec.InventoryXid       = "";       
      bnr.rec.BCFormKind         = 2;/*VSBANNER_FORMKIND_CERT*/; 
      bnr.rec.BCPresentationDate = date(0,0,0);
      bnr.rec.DiscountRemainder  = 0;    
      bnr.rec.BCState            = "";   
      bnr.rec.BCTermFormula      = 20/*VS_TERMF_ATSIGHT*/;       
      bnr.rec.BCTermFormat       = 0;           
      bnr.rec.FIID               = DataSetIC.FIID;               
      bnr.rec.PayFIID            = legIC.CFI;              
      bnr.rec.ABCStatus          = 0;              
      bnr.rec.AccCode            = fin.rec.CodeInAccount;
      bnr.rec.Branch             = DataSetIC.Branch;     
      bnr.rec.SecurCode          = fin.rec.FI_Code;  
      bnr.rec.SecurName          = fin.rec.Name;  
      bnr.rec.BuyFIID            = legIC.CFI;        
      bnr.rec.PortfolioID        = 0;            
      bnr.rec.BackOffice         = "";           
      bnr.rec.OFBU               = "";           
      bnr.rec.ContrID            = 0;            
      bnr.rec.UserLot            = "";           
      bnr.rec.AgentID            = bnr.rec.Issuer;       
      bnr.rec.AgentName          = bnr.rec.IssuerName;   
      bnr.rec.InUnsafeCustody    = "";        
      bnr.rec.Kind               = savecertIC.Kind;      
      bnr.rec.InventoryID        = 0;            
      bnr.rec.Description        = DataSetIC.Description;       

      ins_bnr.AddRecord(bnr);
      ins_bnr.AddReturning( "t_bcid", V_INTEGER );

      if(not ins_bnr.Insert())
        error("Ошибка при создании записи в dvsbanner_dbt при обработке ИК "+DataSetIC.XID);
        err = 1;
      else
        ins_bnr.GetReturning(realBCID);
        bnr.rec.BCID = realBCID[0];
      end;

      if(not err)
        if(ValType(legIC.SupplyTime) == V_UNDEF)
          legIC.SupplyTime = time(0);
        end;
        
        legIC.GetRecord().CopyTo( leg.rec );

        leg.rec.ID       = 0;
        leg.rec.DealID   = bnr.rec.BCID;
        leg.rec.LegKind  = LEG_KIND_VSBANNER;
        leg.rec.Start    = date(DataSetIC.IssuerDate);
        leg.rec.Maturity = date(DataSetIC.DrawingDate);

        ins_leg.AddRecord(leg);

        if(not ins_leg.Insert())
          error("Ошибка при создании записи в ddl_leg_dbt при обработке ИК "+DataSetIC.XID);
          err = 1;
        end;
      end;

      //перенести агентов
      if(not err)
        err = RemoveVsircag(savecertIC.SaveCertID, bnr.rec.BCID, DataSetIC.RootAvoirKind);
        if(err)
          error("Ошибка переноса агентов с ИК "+DataSetIC.XID);
        end;
      end;

      //создать сертификат
      if(not err)
        err = InsertFICERT(DataSetIC.AvoirKind, bnr.rec.BCID, @FiCertID);
        if(err)
          error("Ошибка вставки сертификата при обработке ИК "+DataSetIC.XID);
        end;
      end;
      
      //перенести примечания
      if(not err)
        err = RemoveNotetext(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса примечаний с ИК "+DataSetIC.XID);
        end;
      end;

      //перенести категории
      if(not err)
        err = RemoveObjatcor(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса категорий с ИК "+DataSetIC.XID);
        end;
      end;

      //переносим представителей 
      if(not err)
        err = RemoveProxy(106, savecertIC.SaveCertID, 24, FiCertID);
        if(err)
          error("Ошибка переноса представителей с ИК "+DataSetIC.XID);
        end;
      end;
    end;

    //3.Создать новую ИК
    if(not err)
      err = CreateINVCARD(FiCertID, ind);
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  private macro ExistsAgent(BCID, AvoirKind, AgentID, AgentRole)
    var exists = false;

    var cmd = DL_RSDCommand(  " select 1 from dvsircag_dbt"
                            + "  where t_BCID = ? "
                            + "    and t_AvoirKind = ? "
                            + "    and t_Agent = ? "
                            + "    and t_AgentRole = ?"
                           );
    cmd.AddParam(BCID);
    cmd.AddParam(AvoirKind);
    cmd.AddParam(AgentID);
    cmd.AddParam(AgentRole);

    var DataSet = cmd.Execute();

    if(DataSet.moveNext())
      exists = true;
    end;

    return exists;
  end;

  //создать сертификат закладной для текущей ИК
  private macro CreateMortIC(CurrICNumber:string, ind:integer)
    var mortIC, cmd, query;
    var fin = TBFile("fininstr.dbt");
    record persnidc("persnidc.dbt");
    var err = 0;
    
    var FiCertID = 0;

    fin.rec.FIID = DataSetIC.FIID;
    if(not fin.GetEQ())
      error("Не найден финансовый инструмент с ID = "+DataSetIC.FIID);
      err = 1;
    end;

    if(not err)
      cmd = DL_RSDCommand(  " select * " 
                          + "   from dmortgage_upgr_dbt"
                          + "  where t_CertifID = ? "
                         );
      cmd.AddParam(DataSetIC.AutoKey);

      mortIC = cmd.Execute();

      if(not mortIC.moveNext())
        error("Не найдены параметры закладной для ИК "+DataSetIC.XID);
        err = 1;
      else
        if(ValType(mortIC.Percent) == V_UNDEF) 
          mortIC.Percent = 0.0;                      
        end;
        if(ValType(mortIC.Ground) == V_UNDEF)
          mortIC.Ground = 0;                  
        end;
      end;
    end;

    //1. Сначала пытаемся найти существующий.
    if(not err)
      var vficert;
      
      cmd = DL_RSDCommand();

      query = " select t_FiCertID "
                          + "   from dv_ficert_dbt vficert, dmortgage_dbt mort"
                          + "  where vficert.t_FIID = ? "
                          + "    and mort.t_MortgageID = vficert.t_CertID "
                          + "    and mort.t_Amount = ? "
                          + "    and mort.t_AmountFIID = ? "
                          + "    and mort.t_Percent = ? "
                          + "    and mort.t_GroundKind = ? "
                          + "    and mort.t_GroundAltXld = ? ";
       
      cmd.AddParam(DataSetIC.FIID);
      cmd.AddParam(mortIC.Amount);
      cmd.AddParam(mortIC.AmountFIID);
      cmd.AddParam(mortIC.Percent);
      cmd.AddParam(mortIC.GroundKind);
      cmd.AddParam(mortIC.GroundAltXld);
      
      if(mortIC.PawnerID > 0)
        query = query + "and Exists(select 1 from dvsircag_dbt ag"
                      + "            where ag.t_AvoirKind = " + AVOIRISSKIND_MORTGAGE
                      + "              and ag.t_BCID = mort.t_MortgageID "
                      + "              and ag.t_Agent = ? "
                      + "              and ag.t_AgentRole = ? "
                      + "          )";

        cmd.AddParam(mortIC.PawnerID);
        cmd.AddParam(7/*IRCAG_ROLE_PAWNER*/);
      else
        query = query + "and not Exists(select 1 from dvsircag_dbt ag"
                      + "                where ag.t_AvoirKind = " + AVOIRISSKIND_MORTGAGE
                      + "                  and ag.t_BCID = mort.t_MortgageID "
                      + "                  and ag.t_AgentRole = ? "
                      + "              )";

        cmd.AddParam(7/*IRCAG_ROLE_PAWNER*/);
      end;

      if(mortIC.DebtorID > 0)
        query = query + "and Exists(select 1 from dvsircag_dbt ag"
                      + "            where ag.t_AvoirKind = " + AVOIRISSKIND_MORTGAGE
                      + "              and ag.t_BCID = mort.t_MortgageID "
                      + "              and ag.t_Agent = ? "
                      + "              and ag.t_AgentRole = ? "
                      + "          )";

        cmd.AddParam(mortIC.DebtorID);
        cmd.AddParam(16/*IRCAG_ROLE_DEBTOR*/);
      else
        query = query + "and not Exists(select 1 from dvsircag_dbt ag"
                      + "               where ag.t_AvoirKind = " + AVOIRISSKIND_MORTGAGE
                      + "                 and ag.t_BCID = mort.t_MortgageID "
                      + "                 and ag.t_AgentRole = ? "
                      + "             )";

        cmd.AddParam(16/*IRCAG_ROLE_DEBTOR*/);
      end;

      if(mortIC.LSIN != "")
        query = query + "    and Exists(select 1 from dmortobj_dbt obj "
                      + "                 where obj.t_MortgageID = mort.t_MortgageID "
                      + "                   and obj.t_LSIN = ? "
                      + "              )";

        cmd.AddParam(mortIC.LSIN);
      else
        query = query + "    and not Exists(select 1 from dmortobj_dbt obj "
                      + "                     where obj.t_MortgageID = mort.t_MortgageID "
                      + "                  )";
      end;


      vficert = cmd.Execute(query);
      if(vficert.moveNext())
        FiCertID = int(vficert.FiCertID);
        message("Найден существующий сертификат dficert_dbt.t_FiCertID = " + FiCertID);
      end;
    end;

    //2. Если не нашли, то создаем сертификат на основе ИК
    if((not err) and (FiCertID == 0))
      var mort = TRecHandler("mortgage.dbt"); 
      var ins_mort = RsbSQLInsert("mortgage.dbt");
      var realMortgageID = TArray();             

      mort.Clear();

      mort.rec.MortgageID        = 0;
      mort.rec.CertifID          = 0;                       
      mort.rec.OwnerID           = mortIC.OwnerID;    
      mort.rec.OwnerCodeKind     = mortIC.OwnerCodeKind;                
      mort.rec.OwnerShortName    = mortIC.OwnerShortName;                
      mort.rec.GroundKind        = mortIC.GroundKind;                   
      mort.rec.GroundAltXld      = mortIC.GroundAltXld;        
      mort.rec.GroundSignedDate  = date(mortIC.GroundSignedDate);        
      mort.rec.GroundIssuePlace  = mortIC.GroundIssuePlace;        
      mort.rec.Amount            = mortIC.Amount;                       
      mort.rec.AmountFIID        = mortIC.AmountFIID;                   
      mort.rec.Percent           = mortIC.Percent;                      
      mort.rec.Ground            = mortIC.Ground;                  
      mort.rec.IsTempAccounted   = mortIC.IsTempAccounted;              
      mort.rec.FIID              = DataSetIC.FIID;                         
      mort.rec.IssuedDate        = date(DataSetIC.IssuerDate);                   
      mort.rec.Description       = "";              
      mort.rec.DrawingDate       = date(DataSetIC.DrawingDate);                  
      mort.rec.Department        = DataSetIC.Department;                   
      mort.rec.Branch            = DataSetIC.Branch;                       
      mort.rec.RegistrDate       = date(DataSetIC.RegistrDate);                  
      mort.rec.Oper              = DataSetIC.Oper;                         

      ins_mort.AddRecord(mort);
      ins_mort.AddReturning( "t_mortgageid", V_INTEGER );

      if(not ins_mort.Insert())
        error("Ошибка при создании записи в dmortgage_dbt при обработке ИК "+DataSetIC.XID);
        err = 1;
      else
        ins_mort.GetReturning(realMortgageID);
        mort.rec.MortgageID = realMortgageID[0];
      end;

      //создать объект ипотеки
      if(not err)
        var mortobj = TRecHandler("mortobj.dbt"); 
        var ins_mortobj = RsbSQLInsert("mortobj.dbt");

        mortobj.Clear();
        
        mortobj.rec.AutoKey             = 0;               
        mortobj.rec.MortgageID          = mort.rec.MortgageID;          
        mortobj.rec.Name                = "";              
        mortobj.rec.Address             = mortIC.rec.Address;          
        mortobj.rec.AuthorityName       = "";     
        mortobj.rec.Amount              = mortIC.rec.Amount;            
        mortobj.rec.AmountFIID          = mortIC.rec.AmountFIID;        
        mortobj.rec.Description         = "";      
        mortobj.rec.LSIN                = mortIC.rec.LSIN;              
        mortobj.rec.LSINDate            = mortIC.rec.LSINDate;          
        mortobj.rec.RegisterID          = mortIC.rec.RegisterID;        
        mortobj.rec.RegisterCodeKind    = mortIC.rec.RegisterCodeKind;  
        mortobj.rec.RegisterShortName   = mortIC.rec.RegisterShortName; 

        ins_mortobj.AddRecord(mortobj);

        if(not ins_mortobj.Insert())
          error("Ошибка при создании записи в dmortobj_dbt при обработке ИК "+DataSetIC.XID);
          err = 1;
        end;
      end;

      if(not err)
        err = RemoveMortpay(mortIC.rec.MortgageID, mort.rec.MortgageID);
        if(err)
          error("Ошибка переноса ЧП с ИК "+DataSetIC.XID);
        end;
      end;

      //перенести агентов
      if(not err)
        err = RemoveVsircag(mortIC.rec.MortgageID, mort.rec.MortgageID, DataSetIC.RootAvoirKind);
        if(err)
          error("Ошибка переноса агентов с ИК "+DataSetIC.XID);
        end;
      end;

      //добавить агентов
      if(not err)
        var ag = TRecHandler("vsircag.dbt"); 
        var ins_ag = RsbSQLInsert("vsircag.dbt");

        if((mortIC.DebtorID > 0) and (not ExistsAgent(mort.rec.MortgageID, DataSetIC.RootAvoirKind, mortIC.DebtorID, 16/*IRCAG_ROLE_DEBTOR*/)))
          //такого агента ещё нет
          ag.Clear();

          ag.rec.Id               = 0;
          ag.rec.BCID             = mort.rec.MortgageID;
          ag.rec.AgentRole        = 16;/*IRCAG_ROLE_DEBTOR*/
          ag.rec.Agent            = mortIC.DebtorID;
          ag.rec.AgentTaxCode     = GetPartyINN(ag.rec.Agent);
          ag.rec.AgentName        = GetPartyName(ag.rec.Agent);   
          ag.rec.AgentAddress     = GetPartyAddress(ag.rec.Agent);
          ag.rec.DateOfSigning    = mort.rec.IssuedDate;
          ag.rec.Amount           = mort.rec.Amount;
          ag.rec.EndorsementType  = 0;
          ag.rec.EndorsementKind  = 0;
          ag.rec.AvoirKind        = DataSetIC.AvoirKind;
          ag.rec.FIID             = mort.rec.AmountFIID;
          ag.rec.Rate             = 0;
          ag.rec.Ground           = "";
          ag.rec.Comment          = "";

          if( GetPersonIdc(mortIC.DebtorID, persnidc) )
            ag.rec.PaperKind        = persnidc.PaperKind;
            ag.rec.PaperSeries      = persnidc.PaperSeries;    
            ag.rec.PaperNumber      = persnidc.PaperNumber;    
            ag.rec.PaperIssuedDate  = persnidc.PaperIssuedDate;
            ag.rec.PaperIssuer      = persnidc.PaperIssuer;    
            ag.rec.PaperIssuerCode  = persnidc.PaperIssuerCode;
          end;

          ins_ag.AddRecord(ag);
        end;

        if((mortIC.PawnerID > 0) and (not ExistsAgent(mort.rec.MortgageID, DataSetIC.RootAvoirKind, mortIC.PawnerID, 7/*IRCAG_ROLE_PAWNER*/)))
          //такого агента ещё нет
          ag.Clear();

          ag.rec.Id               = 0;
          ag.rec.BCID             = mort.rec.MortgageID;
          ag.rec.AgentRole        = 7;/*IRCAG_ROLE_PAWNER*/
          ag.rec.Agent            = mortIC.PawnerID;
          ag.rec.AgentTaxCode     = GetPartyINN(ag.rec.Agent);
          ag.rec.AgentName        = GetPartyName(ag.rec.Agent);   
          ag.rec.AgentAddress     = GetPartyAddress(ag.rec.Agent);
          ag.rec.DateOfSigning    = mort.rec.IssuedDate;
          ag.rec.Amount           = mort.rec.Amount;
          ag.rec.EndorsementType  = 0;
          ag.rec.EndorsementKind  = 0;
          ag.rec.AvoirKind        = DataSetIC.AvoirKind;
          ag.rec.FIID             = mort.rec.AmountFIID;
          ag.rec.Rate             = 0;
          ag.rec.Ground           = "";
          ag.rec.Comment          = "";

          if( GetPersonIdc(mortIC.PawnerID, persnidc) )
            ag.rec.PaperKind        = persnidc.PaperKind;
            ag.rec.PaperSeries      = persnidc.PaperSeries;    
            ag.rec.PaperNumber      = persnidc.PaperNumber;    
            ag.rec.PaperIssuedDate  = persnidc.PaperIssuedDate;
            ag.rec.PaperIssuer      = persnidc.PaperIssuer;    
            ag.rec.PaperIssuerCode  = persnidc.PaperIssuerCode;
          end;

          ins_ag.AddRecord(ag);
        end;

        if(not ins_ag.Insert())
          error("Ошибка при создании агентов обращения закладной при обработке ИК "+DataSetIC.XID);
          err = 1;
        end;

      end;

      //создать сертификат
      if(not err)
        err = InsertFICERT(DataSetIC.AvoirKind, mort.rec.MortgageID, @FiCertID);
        if(err)
          error("Ошибка вставки сертификата при обработке ИК "+DataSetIC.XID);
        end;
      end;
      
      //перенести примечания
      if(not err)
        err = RemoveNotetext(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса примечаний с ИК "+DataSetIC.XID);
        end;
      end;

      //перенести категории
      if(not err)
        err = RemoveObjatcor(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса категорий с ИК "+DataSetIC.XID);
        end;
      end;

      //удалить старую запись
      if(not err)
        SQL_Execute("delete from dmortgage_dbt where t_MortgageID = " + mortIC.rec.MortgageID, "Удаление старых данных", true );
      end;
    end;

    //3.Создать новую ИК
    if(not err)
      err = CreateINVCARD(FiCertID, ind);
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //создать сертификат складского свидетельства для текущей ИК
  private macro CreateStorIC(CurrICNumber:string, ind:integer)
    var warrIC, cmd, query;
    var fin = TBFile("fininstr.dbt");
    var err = 0;
    
    var FiCertID = 0;

    fin.rec.FIID = DataSetIC.FIID;
    if(not fin.GetEQ())
      error("Не найден финансовый инструмент с ID = "+DataSetIC.FIID);
      err = 1;
    end;

    if(not err)
      cmd = DL_RSDCommand(  " select * " 
                          + "   from dwarrant_upgr_dbt"
                          + "  where t_CertifID = ? "
                         );
      cmd.AddParam(DataSetIC.AutoKey);

      warrIC = cmd.Execute();

      if(not warrIC.moveNext())
        error("Не найдены параметры складского свидетельства для ИК "+DataSetIC.XID);
        err = 1;
      end;
    end;

    //1. Сначала пытаемся найти существующий.
    if(not err)
      var vficert;
      
      cmd = DL_RSDCommand();

      query = " select t_FiCertID "
                          + "   from dv_ficert_dbt vficert, dwarrant_dbt warr"
                          + "  where vficert.t_FIID = ? "
                          + "    and warr.t_WarrantID = vficert.t_CertID "
                          + "    and vficert.t_Issuer = ? "
                          + "    and vficert.t_IssueDate = ? "
                          + "    and warr.t_Series = ? "
                          + "    and warr.t_Number = ? ";
       
      cmd.AddParam(DataSetIC.FIID);
      cmd.AddParam(DataSetIC.Issuer);
      cmd.AddParam(date(DataSetIC.IssuerDate));
      cmd.AddParam(DataSetIC.Series);
      cmd.AddParam(CurrICNumber);
      
      vficert = cmd.Execute(query);
      if(vficert.moveNext())
        FiCertID = int(vficert.FiCertID);
        message("Найден существующий сертификат dficert_dbt.t_FiCertID = " + FiCertID);
      end;
    end;

    //2. Если не нашли, то создаем сертификат на основе ИК
    if((not err) and (FiCertID == 0))
      var warr = TRecHandler("warrant.dbt"); 
      var ins_warr = RsbSQLInsert("warrant.dbt");
      var realWarrantID = TArray();             

      warr.Clear();   

      warr.rec.WarrantID              = 0;                                              
      warr.rec.CertifID               = 0;                                              
      warr.rec.Kind                   = warrIC.Kind;                                    
      warr.rec.Part                   = warrIC.Part;                                    
      warr.rec.StorageID              = warrIC.StorageID;                               
      warr.rec.StorageCodeKind        = warrIC.StorageCodeKind;                         
      warr.rec.StorageShortName       = warrIC.StorageShortName;                        
      warr.rec.OwnerID                = warrIC.OwnerID;                                 
      warr.rec.OwnerCodeKind          = warrIC.OwnerCodeKind;                           
      warr.rec.OwnerShortName         = warrIC.OwnerShortName;                          
      warr.rec.GoodsName              = warrIC.GoodsName;                               
      warr.rec.GoodsCode              = warrIC.GoodsCode;                               
      warr.rec.Quantity               = warrIC.Quantity;                                
      warr.rec.QuantityUnit           = warrIC.QuantityUnit;                             
      warr.rec.Country                = warrIC.Country;                                 
      warr.rec.ManufacturerID         = warrIC.ManufacturerID;                          
      warr.rec.ManufacturerCodeKind   = warrIC.ManufacturerCodeKind;                    
      warr.rec.ManufacturerShortName  = warrIC.ManufacturerShortName;                   
      warr.rec.Cost                   = warrIC.Cost;                                    
      warr.rec.CostFIID               = warrIC.CostFIID;                                
      warr.rec.Mass                   = warrIC.Mass;                                    
      warr.rec.MassUnit               = warrIC.MassUnit;                                
      warr.rec.Volume                 = warrIC.Volume;                                  
      warr.rec.VolumeUnit             = warrIC.VolumeUnit;                              
      warr.rec.StorageTerm            = warrIC.StorageTerm;                             
      warr.rec.StorageDate            = date(warrIC.StorageDate);                       
      warr.rec.StorageDays            = warrIC.StorageDays;                             
      warr.rec.PaymentTerm            = warrIC.PaymentTerm;                             
      warr.rec.PaymentRate            = warrIC.PaymentRate;                             
      warr.rec.PaymentSum             = warrIC.PaymentSum;                              
      warr.rec.PaymentFIID            = warrIC.PaymentFIID;                             
      warr.rec.FIID                   = DataSetIC.FIID;                                 
      warr.rec.Series                 = DataSetIC.Series;                               
      warr.rec.Number                 = CurrICNumber;                                   
      warr.rec.IssuedDate             = date(DataSetIC.IssuerDate);                      
      warr.rec.Description            = "";                                             
      warr.rec.IssuerID               = DataSetIC.Issuer;                               
      warr.rec.IssuerCodeKind         = 1;                                              
      warr.rec.IssuerShortName        = ПолучитьКороткоеИмяСубъекта(DataSetIC.Issuer);  
      warr.rec.Department             = DataSetIC.Department;                           
      warr.rec.Branch                 = DataSetIC.Branch;                                
      warr.rec.RegistrDate            = date(DataSetIC.RegistrDate);                    
      warr.rec.Oper                   = DataSetIC.Oper;                                 

      ins_warr.AddRecord(warr);
      ins_warr.AddReturning( "t_warrantid", V_INTEGER );

      if(not ins_warr.Insert())
        error("Ошибка при создании записи в dwarrant_dbt при обработке ИК "+DataSetIC.XID);
        err = 1;
      else
        ins_warr.GetReturning(realWarrantID);
        warr.rec.WarrantID = realWarrantID[0];
      end;

      //перенести агентов
      if(not err)
        err = RemoveVsircag(warrIC.rec.WarrantID, warr.rec.WarrantID, DataSetIC.RootAvoirKind);
        if(err)
          error("Ошибка переноса агентов с ИК "+DataSetIC.XID);
        end;
      end;

      //создать сертификат
      if(not err)
        err = InsertFICERT(DataSetIC.AvoirKind, warr.rec.WarrantID, @FiCertID);
        if(err)
          error("Ошибка вставки сертификата при обработке ИК "+DataSetIC.XID);
        end;
      end;
      
      //перенести примечания
      if(not err)
        err = RemoveNotetext(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса примечаний с ИК "+DataSetIC.XID);
        end;
      end;

      //перенести категории
      if(not err)
        err = RemoveObjatcor(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса категорий с ИК "+DataSetIC.XID);
        end;
      end;

      //удалить старую запись
      if(not err)
        SQL_Execute("delete from dwarrant_dbt where t_WarrantID = " + warrIC.rec.WarrantID, "Удаление старых данных", true );
      end;
    end;

    //3.Создать новую ИК
    if(not err)
      err = CreateINVCARD(FiCertID, ind);
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  //создать сертификат эмиссионной документарной ц/б для текущей ИК
  private macro CreateEmisIC(CurrICNumber:string, ind:integer)
    var cmd, query;
    var fin = TBFile("fininstr.dbt");
    var err = 0;
    
    var FiCertID = 0;

    fin.rec.FIID = DataSetIC.FIID;
    if(not fin.GetEQ())
      error("Не найден финансовый инструмент с ID = "+DataSetIC.FIID);
      err = 1;
    end;

    //1. Сначала пытаемся найти существующий.
    if(not err)
      var vficert;
      
      cmd = DL_RSDCommand();

      query = " select t_FiCertID "
                          + "   from dv_ficert_dbt vficert"
                          + "  where vficert.t_FIID = ? "
                          + "    and vficert.t_Series = ? "
                          + "    and vficert.t_Number = ? ";
       
      cmd.AddParam(DataSetIC.FIID);
      cmd.AddParam(DataSetIC.Series);
      cmd.AddParam(CurrICNumber);
      
      vficert = cmd.Execute(query);
      if(vficert.moveNext())
        FiCertID = int(vficert.FiCertID);
        message("Найден существующий сертификат dficert_dbt.t_FiCertID = " + FiCertID);
      end;
    end;

    //2. Если не нашли, то создаем сертификат на основе ИК
    if((not err) and (FiCertID == 0))
      var emis = TRecHandler("certemis.dbt"); 
      var ins_emis = RsbSQLInsert("certemis.dbt");
      var realID = TArray();             

      emis.Clear();   

      emis.rec.ID           = 0;    
      emis.rec.FIID         = DataSetIC.FIID;    
      emis.rec.Series       = DataSetIC.Series;
      emis.rec.Number       = CurrICNumber;
      emis.rec.Copies       = DataSetIC.Fold;    
      emis.rec.Department   = DataSetIC.Department;            
      emis.rec.Branch       = DataSetIC.Branch;                
      emis.rec.RegistrDate  = date(DataSetIC.RegistrDate);     
      emis.rec.Oper         = DataSetIC.Oper;                  

      ins_emis.AddRecord(emis);
      ins_emis.AddReturning( "t_id", V_INTEGER );

      if(not ins_emis.Insert())
        error("Ошибка при создании записи в dcertemis_dbt при обработке ИК "+DataSetIC.XID);
        err = 1;
      else
        ins_emis.GetReturning(realID);
        emis.rec.ID = realID[0];
      end;

      //создать сертификат
      if(not err)
        err = InsertFICERT(DataSetIC.AvoirKind, emis.rec.ID, @FiCertID);
        if(err)
          error("Ошибка вставки сертификата при обработке ИК "+DataSetIC.XID);
        end;
      end;
      
      //перенести примечания
      if(not err)
        err = RemoveNotetext(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса примечаний с ИК "+DataSetIC.XID);
        end;
      end;

      //перенести категории
      if(not err)
        err = RemoveObjatcor(106, DataSetIC.AutoKey, 24, L_Z(FiCertID,10));
        if(err)
          error("Ошибка переноса категорий с ИК "+DataSetIC.XID);
        end;
      end;
    end;

    //3.Создать новую ИК
    if(not err)
      err = CreateINVCARD(FiCertID, ind);
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;


  macro ExecUpgrade()
    var query, cmd;
    var cnt = 0;
    var err = 0;
    var num = 0;

    message("Обновление инвентарных карточек");

    query =   " select certif.*, fin.t_AvoirKind, rsb_fiinstr.FI_AvrKindsGetRoot( fin.t_FI_Kind, fin.t_AvoirKind ) as RootAvoirKind "
            + "   from dcertif_upgr_dbt certif, dfininstr_dbt fin "
            + "  where fin.t_FIID = certif.t_FIID "
            + "    and fin.t_FI_Kind = " + FIKIND_AVOIRISS
            + "    and certif.t_Status <> " + 1000 //Списана при делении
            + "  order by certif.t_RegistrDate ASC, certif.t_RegistrTime ASC, certif.t_AutoKey ASC";
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обработке "+cnt+" ИК");
    if(cnt > 0)
      InitProgress( cnt, "Идет обновление", "Обновление данных по закрытому хранению" );

      DataSetIC = cmd.Execute();

      while((not err) and (DataSetIC.moveNext()))

        message("Обновление по записи dcertif_upgr_dbt.t_AutoKey = " + DataSetIC.AutoKey);

        if(DataSetIC.NumberFirst != DataSetIC.NumberLast) //диапазонная карточка
          //это значит, что номера карточки числовые
          var NullDigits = strlen(trim(DataSetIC.NumberFirst));
          var StartNumber = int(trim(DataSetIC.NumberFirst));
          var EndNumber = int(trim(DataSetIC.NumberLast));
          var CurrNumber = StartNumber;
          var i = 1;

          while((not err) and (CurrNumber <= EndNumber))

            if(DataSetIC.RootAvoirKind == AVOIRISSKIND_BILL) //Вексель
              err = CreateBillIC(string(L_P(L_Z(CurrNumber,NullDigits), 20)), i);
            elif(DataSetIC.RootAvoirKind == AVOIRISSKIND_BANKCERT) //Банковский сертификат
              err = CreateCertIC(string(L_P(L_Z(CurrNumber,NullDigits), 20)), i);
            elif(DataSetIC.RootAvoirKind == AVOIRISSKIND_MORTGAGE) //Закладная
              err = CreateMortIC(string(L_P(L_Z(CurrNumber,NullDigits), 20)), i);
            elif(DataSetIC.RootAvoirKind == AVOIRISSKIND_STORAGE_CERTIFICATE) //Складское свидетельство
              err = CreateStorIC(string(L_P(L_Z(CurrNumber,NullDigits), 20)), i);
            else
              err = CreateEmisIC(string(L_P(L_Z(CurrNumber,NullDigits), 20)), i);
            end;

            CurrNumber = CurrNumber + 1;
            i = i + 1;
          end;
        else
          if(DataSetIC.RootAvoirKind == AVOIRISSKIND_BILL) //Вексель
            err = CreateBillIC(DataSetIC.NumberFirst, 0);
          elif(DataSetIC.RootAvoirKind == AVOIRISSKIND_BANKCERT) //Банковский сертификат
            err = CreateCertIC(DataSetIC.NumberFirst, 0);
          elif(DataSetIC.RootAvoirKind == AVOIRISSKIND_MORTGAGE) //Закладная
            err = CreateMortIC(DataSetIC.NumberFirst, 0);
          elif(DataSetIC.RootAvoirKind == AVOIRISSKIND_STORAGE_CERTIFICATE) //Складское свидетельство
            err = CreateStorIC(DataSetIC.NumberFirst, 0);
          else
            err = CreateEmisIC(DataSetIC.NumberFirst, 0);
          end;
        end;


        UseProgress(num = num + 1);
      end;

      RemProgress();
    end;

    if(err)
      error("При обновлении данных по закрытому хранению возникли ошибки");
    else
      message("Обработка инвентарных карточек выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//Обновление описей сертификатов
//Перенос данных в новые таблицы
class TUpgrDepoInvlist()
  macro ExecUpgrade()
    var query, cmd, DataSet;
    var cnt = 0;
    var err = 0;
    var num = 0;
    var NullDigits = 0;
    var StartNumber = 0;
    var EndNumber = 0;
    var CurrNumber = 0;
    var AdmOprID = 0, InvCardID = 0;
    var NumberFirst, NumberLast;
    var newil = TRecHandler("invlist.dbt");
    var ins_il= RsbSQLInsert("invlist.dbt");

    message("Обновление описей сертификатов");

    query =   " select cm.t_NumberFirst, cm.t_NumberLast, cm.t_XID, draft.t_Department, cm.t_PaymTo, cm.t_NewCell, cm.t_NewSection, cm.t_MoveID "
            + "   from dcertmove_upgr_dbt cm, dcertif_upgr_dbt cert, dspdrmove_dbt pm, dspdraft_dbt draft "
            + "  where cm.t_XID <> CHR(1) "
            + "    and cert.t_XID = cm.t_XID "
            + "    and pm.t_PaymentID = cm.t_PaymTo "
            + "    and draft.t_AutoKey = pm.t_DraftID "
            + "    and cert.t_Department = draft.t_Department "
            + " UNION ALL "
            + " select cm.t_NumberFirst, cm.t_NumberLast, cert.t_XID, draft.t_Department, cm.t_PaymTo, cm.t_NewCell, cm.t_NewSection, cm.t_MoveID " 
            + "    from dcertmove_upgr_dbt cm, dcertif_upgr_dbt cert, dspdrmove_dbt pm, dspdraft_dbt draft " 
            + "   where cm.t_XID = CHR(1) " 
            + "     and cert.t_Department = draft.t_Department "
            + "     and cert.t_FIID = cm.t_FIID " 
            + "     and cert.t_Issuer = cm.t_Issuer "
            + "     and cert.t_IssuerDate = cm.t_IssuerDate "
            + "     and cert.t_Series = cm.t_Series "
            + "     and cert.t_NumberFirst = cm.t_NumberFirst "
            + "     and pm.t_PaymentID = cm.t_PaymTo " 
            + "     and draft.t_AutoKey = pm.t_DraftID ";

    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обработке "+cnt+" записей");
    if(cnt > 0)
      InitProgress( cnt, "Идет обновление", "Обновление данных описей сертификатов" );
      
      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи dcertmove_upgr_dbt.t_MoveID = " + DataSet.MoveID);

        NumberFirst = DataSet.NumberFirst;
        NumberLast  = DataSet.NumberLast;

        if(NumberFirst != NumberLast) //это может быть только ИК с цифровыми номерами
          NullDigits = strlen(trim(NumberFirst));
          StartNumber = int(trim(NumberFirst));
          EndNumber = int(trim(NumberLast));

          CurrNumber = StartNumber;
          var i = 1;
          while((not err) and (CurrNumber <= EndNumber))

            newil.Clear();

            newil.rec.InvListID = 0;     
            newil.rec.PaymentID = DataSet.PaymTo;     
            FindNewInvCardByOld(DataSet.Xid, DataSet.Department, string(L_P(L_Z(CurrNumber,NullDigits), 20)), @newil.rec.InvCardID);
            newil.rec.Section   = DataSet.NewSection;     
            newil.rec.Cell      = DataSet.NewCell;     

            if(newil.rec.InvCardID)
              ins_il.AddRecord(newil);
            end;

            CurrNumber = CurrNumber + 1;
            i = i + 1;
          end;
        else
          newil.Clear();

          newil.rec.InvListID = 0;     
          newil.rec.PaymentID = DataSet.PaymTo;     
          FindNewInvCardByOld(DataSet.Xid, DataSet.Department, DataSet.NumberFirst, @newil.rec.InvCardID);
          newil.rec.Section   = DataSet.NewSection;     
          newil.rec.Cell      = DataSet.NewCell;     

          if(newil.rec.InvCardID)
            ins_il.AddRecord(newil);
          end;
        end;

        UseProgress(num = num + 1);
      end;

      if(not ins_il.Insert())
        error("Ошибка при создании записи в dinvlist_dbt");
        err = 1;
      end;

      RemProgress();
    end;

    if(not err)
      message("Обработка описей сертификатов выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//Обновление информационных операций
//Замена старых ИК на новые
class TUpgrDepoInfo()
  macro ExecUpgrade()
    var query, cmd, DataSet;
    var cnt = 0;
    var err = 0;
    var num = 0;
    var InvCardID = 0;

    message("Обновление информационных операций");

    query =   " select inf.t_CertifXID, inf.t_Department, inf.t_SpInfDocID, cert.t_NumberFirst "
            + "   from dspinfopr_upgr_dbt inf, dcertif_upgr_dbt cert "
            + "  where inf.t_CertifXID <> CHR(1) "
            + "    and cert.t_XID = inf.t_CertifXID "
            + "    and cert.t_Department = inf.t_Department ";

    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обработке "+cnt+" записей");
    if(cnt > 0)
      InitProgress( cnt, "Идет обновление", "Обновление информационных операций" );
      
      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи dspinfopr_upgr_dbt.t_SpInfDocID = " + DataSet.SpInfDocID);

        FindNewInvCardByOld(DataSet.CertifXID, DataSet.Department, DataSet.NumberFirst, @InvCardID);
        if(InvCardID > 0)
          SQL_Execute(  " update dspinfopr_dbt "
                      + "    set t_InvCardID = " + InvCardID
                      + "  where t_SpInfDocID = " + DataSet.SpInfDocID);
        end;
        UseProgress(num = num + 1);
      end;

      RemProgress();
    end;

    if(not err)
      message("Обработка информационных операций выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;
end;

//Обновление данных УВ, СВ, ДУ
class TUpgrBnr()

  macro UpdateIssueDate()
    var err = 0;
    var sql;

    sql = " UPDATE dvsbanner_dbt bnr "
        + " SET bnr.t_IssueDate = "
        + " (SELECT leg.t_Start "
        + "  FROM ddl_leg_dbt leg " 
        + "  WHERE leg.t_DealID = bnr.t_BCID "
        + "    AND leg.t_LegKind = 1 "
        + "    AND leg.t_LegID = 0) ";

    message("Обновление даты эмиссии анкет векселей");

    SQL_Execute(sql, "Обновление даты эмиссии анкет векселей", false);

    message("Обновление даты эмиссии анкет векселей выполнено успешно");

    return err;

    OnError(er)
        error(er.module+ " "+er.line+" "+er.message);
        return 1;
  end;

  macro ExecUpgradeBanner()
    var query, cmd, DataSet;
    var cnt = 0;
    var err = 0;
    var num = 0;
    var vficert, cmdFICERT;
    var FiCertID = 0;
    var objID = 0, objGroup = 0;

    message("Обновление данных УВ, СВ, ДУ");

    query =   " select bnr.*, fin.t_AvoirKind, rsb_fiinstr.FI_AvrKindsGetRoot( fin.t_FI_Kind, fin.t_AvoirKind ) as RootAvoirKind "
            + "   from dvsbanner_upgr_dbt bnr, dfininstr_dbt fin "
            + "  where bnr.t_InventoryXID = CHR(1) "
            + "    and bnr.t_BCFormKind IN (1 /*VSBANNER_FORMKIND_SIMPLE*/, 2 /*VSBANNER_FORMKIND_CERT*/)"
            + "    and fin.t_FIID = bnr.t_FIID ";
    cmd = DL_RSDCommand(query);

    cnt = cmd.GetCount();
    message("К обработке "+cnt+" записей");
    if(cnt > 0)
      InitProgress( cnt, "Идет обновление", "Обновление данных УВ, СВ, ДУ" );

      DataSet = cmd.Execute();

      while((not err) and (DataSet.moveNext()))

        message("Обновление по записи dvsbanner_upgr_dbt.t_BCID = " + DataSet.t_BCID);

        FiCertID = 0;

        //пытаемся найти существующий (хотя его быть не должно ещё)
        cmdFICERT = DL_RSDCommand(  " select t_FiCertID "
                                  + "   from dv_ficert_dbt ficert, dfininstr_dbt fin "
                                  + "  where ficert.t_CertID = ? "
                                  + "    and ficert.t_AvoirKind = fin.t_AvoirKind "
                                  + "    and fin.t_FIID = ? "
                                 );
        cmdFICERT.AddParam(DataSet.BCID);
        cmdFICERT.AddParam(DataSet.FIID);

        vficert = cmdFICERT.Execute();
        if(vficert.moveNext())
          FiCertID = int(vficert.FiCertID);
          message("Найден существующий сертификат dficert_dbt.t_FiCertID = " + FiCertID);
        end;

        //создать сертификат
        if((not err) AND (FiCertID == 0))
          err = InsertFICERT(DataSet.AvoirKind, DataSet.BCID, @FiCertID);
          if(err)
            error("Ошибка вставки сертификата при обработке записи dvsbanner_dbt.t_BCID = "+DataSet.BCID);
          end;
        end;

        if ( DataSet.BCFormKind == 1)
          objGroup = 651;
          objID    = L_Z(DataSet.BCID, 8);
        else
          objGroup = 674;
          objID    = L_Z(DataSet.BCID, 34);
        end;
        //перенести примечания
        if(not err)             
          err = RemoveNotetext(objGroup, objID, 24, L_Z(FiCertID,10));
          if(err)
            error("Ошибка переноса примечаний при обработке записи dvsbanner_dbt.t_BCID = "+DataSet.BCID);
          end;
        end;

        //перенести категории
        if(not err)
          err = RemoveObjatcor(objGroup, objID, 24, L_Z(FiCertID,10));
          if(err)
            error("Ошибка переноса категорий при обработке записи dvsbanner_dbt.t_BCID = "+DataSet.BCID);
          end;
        end;

        UseProgress(num = num + 1);
      end;

      RemProgress();
    end;

    if(err)
      error("При обновлении данных УВ, СВ, ДУ возникли ошибки");
    else
      message("Обработка данных УВ, СВ, ДУ выполнена успешно");
    end;

    return err;

    OnError(er)
      error(er.module+ " "+er.line+" "+er.message);
      return 1;
  end;

  macro ExecUpgrade()
    var err = UpdateIssueDate();
    if(not err)
      err = ExecUpgradeBanner();
    end;
    return err;
  end;
end;




//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//ЗАПУСК ОБНОВЛЕНИЯ
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

PRIVATE MACRO ВыполнитьОбновление()
  var err = 0;

  CreatePackage();
  RecreateInvCorrTable();

  RslDefCon.BeginTrans();


  //Формирование сертификатов по данным УВ, СВ, ДУ
  if(not err)
    err = TUpgrBnr().ExecUpgrade();
    if(err)
      error("При формировании сертификатов по данным УВ, СВ, ДУ возникли ошибки. Обновление прервано.");
    end;
  end;

  //Обновление ИК
  if(not err)
    err = TUpgrDepoInvcard().ExecUpgrade();
    if(err)
      error("При обновлении инвентарных карточек возникли ошибки. Обновление прервано.");
    else
      // Добавим всем новым агентам обращения такую принадлежность в справочнике субъектов (у кого ее еще нет)
      SQL_Execute( " INSERT INTO dpartyown_dbt (t_PartyID, t_PartyKind, t_Superior, t_SubKind, t_Branch, t_Numsession) "
                 + "   SELECT pt.t_PartyID, 57, 0, 0, 0, 0 "
                 + "     FROM dparty_dbt pt "
                 + "    WHERE pt.t_PartyID IN (SELECT DISTINCT t_Agent FROM dvsircag_dbt) "
                 + "      AND NOT EXISTS (SELECT 1 "
                 + "                        FROM dpartyown_dbt pto "
                 + "                       WHERE pto.t_PartyID = pt.t_PartyID "
                 + "                         AND pto.t_PartyKind = 57) ",
                  "Обновление агентов обращения", true );
    end;
  end; 

  //Обновление описей сертификатов
  if(not err)
    err = TUpgrDepoInvlist().ExecUpgrade();
    if(err)
      error("При обновлении описей сертификатов возникли ошибки. Обновление прервано.");
    end;
  end;

  //Обновление ИК в информационных операциях
  if(not err)
    err = TUpgrDepoInfo().ExecUpgrade();
    if(err)
      error("При обновлении информационных операций возникли ошибки. Обновление прервано.");
    end;
  end;

  //Обновление АО по л/с
  if(not err)
    clobData = TUpgrDepoAdmoACC();
    err = clobData.ExecUpgrade();
    if(err)
      error("При обновлении АО по л/с возникли ошибки. Обновление прервано.");
    end;
  end;

  //Обновление АО по субъектам
  if(not err)
    clobData = TUpgrDepoAdmoPARTY();
    err = clobData.ExecUpgrade();
    if(err)
      error("При обновлении АО по субъектам возникли ошибки. Обновление прервано.");
    end;
  end;

  //Обновление АО по ц/б
  if(not err)
    clobData = TUpgrDepoAdmoAVOIR();
    err = clobData.ExecUpgrade();
    if(err)
      error("При обновлении АО по ц/б возникли ошибки. Обновление прервано.");
    end;
  end; 

  //Обновление АО по счетам/разделам депо
  if(not err)
    err = TUpgrDepoAdmoDEPOACNT().ExecUpgrade();
    if(err)
      error("При обновлении АО по счетам/разделам ДЕПО возникли ошибки. Обновление прервано.");
    end;

    if(not err)
      //Старые АО назначение оператора, попечителя или распорядителя счёта/раздела преобразуются в новые АО назначения УЛ
      //Старые АО отмены попечителя, отмены распорядителя, отмены оператора счёта или отмены оператора раздела преобразовываются в АО отмены уполномоченного лица
      SQL_Execute(  " update ddepoadmo_dbt adm "
                  + "    set adm.t_Item = " + SPDP_DEPO_ACCOUNT
                  + "  where adm.t_AdmOprID IN (select t_AdmOprID from ddepoadmoclob_tmp) "
                  + "    and adm.t_Item IN ("+SPDP_DEPO_ACCOUNT+", "+SPDP_DEPO_PARTITION+","+SPDP_ACCMANAGER+","+SPDP_PARTMANAGER+") "
                  + "    and adm.t_OperKind IN ("+SPAO_CON_AUTHORITY_ASSIGN+","+SPAO_CON_AUTHORITY_CANCEL+")", 
                  "Обновление АО", true );
    end;

    if(not err)
      //Операции по изменению полномочий УЛ конвертируются в АО "Редактирование счёта депо" в которой состояния "до" и "после" не различаются и содержат сведения о счёте на дату "старой" АО
      SQL_Execute(  " update ddepoadmo_dbt adm "
                  + "    set adm.t_Item = " + SPDP_DEPO_ACCOUNT + ", "
                  + "        adm.t_OperKind = " + SPAO_CON_MODIFYING + ", "
                  + "        adm.t_DepoPart = 0 "
                  + "  where adm.t_AdmOprID IN (select t_AdmOprID from ddepoadmoclob_tmp) "
                  + "    and adm.t_Item IN ("+SPDP_DEPO_ACCOUNT+", "+SPDP_DEPO_PARTITION+","+SPDP_ACCMANAGER+","+SPDP_PARTMANAGER+") "
                  + "    and adm.t_OperKind = " + SPAO_CON_AUTHORITY_CHANGE, 
                  "Обновление АО", true );
    end;

  end; 

  //Обновление АО по ИК
  if(not err)
    clobData = TUpgrDepoAdmoINVCARD();
    err = clobData.ExecUpgrade();
    if(err)
      error("При обновлении АО по закрытому хранению возникли ошибки. Обновление прервано.");
    end;

    if(not err)
      //АО "Списание ИК при делении" и "Регистрация ИК при делении" преобразуются в АО вида "Редактирование ИК". 
      SQL_Execute(  " update ddepoadmo_dbt adm "
                  + "    set adm.t_OperKind = " + SPAO_CON_MODIFYING
                  + "  where adm.t_AdmOprID IN (select t_AdmOprID from ddepoadmoclob_tmp) "
                  + "    and adm.t_Item = " + SPDP_INVCARD
                  + "    and adm.t_OperKind IN (15, 40)", 
                  "Обновление АО", true );
    end;

  end;

  //Перенести все изменения АО в постоянный файл
  if(not err)
    SQL_Execute(  " update ddepoadmo_dbt adm "
                + "    set adm.T_FMTCLOBDATA_XXXX = (select tmp.T_FMTCLOBDATA_XXXX "
                + "                                    from ddepoadmoclob_tmp tmp"
                + "                                   where tmp.t_AdmOprID = adm.t_AdmOprID)"
                + "  where adm.t_AdmOprID IN (select t_AdmOprID from ddepoadmoclob_tmp)", 
                "Обновление АО", true );

  //else
  //  error("Новые данные по АО не сохранены");
  end; 


  //Обновление УЛ на счетах
  if(not err)
    err = TUpgrDepoAcap().ExecUpgrade();
    if(err)
      error("При обновлении уполномоченных лиц возникли ошибки. Обновление прервано.");
    end;
  end;

  //Чистка старых таблиц
  if(not err)
    SQL_Execute("delete from dvsbanner_dbt where t_InventoryXID <> CHR(1)", "Удаление старых данных", true );
    SQL_Execute("delete from dsavecert_dbt", "Удаление старых данных", true );
    SQL_Execute("delete from dcertif_dbt where t_FIID IN (select fin.t_FIID from dfininstr_dbt fin where fin.t_FI_Kind = 2) ", "Удаление старых данных", true );
    SQL_Execute("delete from dcertmove_dbt where t_FIID IN (select fin.t_FIID from dfininstr_dbt fin where fin.t_FI_Kind = 2) ", "Удаление старых данных", true );
  end;

  if(err)
    RslDefCon.RollbackTrans(); 
    message("Выполнен откат транзакции");
  else
    RslDefCon.CommitTrans(); 
    message("Все данные сохранены в базе");
  end;

  DropPackage();

  OnError(er)
    error(er.module+ " "+er.line+" "+er.message);
    if(RslDefCon.IsInTrans)
      RslDefCon.RollbackTrans();
      message("Выполнен откат транзакции");
    end;
end;


//ЗАПУСК
upgrErr.size = 0;
ReplaceMacro( "msgbox", "upgr_msgbox" );

message("ВНИМАНИЕ!!! Сохраните этот протокол");
var t = time();
message("Начало работы - " + string(t));

ВыполнитьОбновление();

message("Завершение работы - " + string(time()));
message("Время выполнения - " + string(time()-t));
message("ВНИМАНИЕ!!! Сохраните этот протокол");

ReplaceMacro( "msgbox", NULL );

var i = 0;
while(i < upgrErr.size)
  println(upgrErr[i]);
  i = i + 1;
end;
