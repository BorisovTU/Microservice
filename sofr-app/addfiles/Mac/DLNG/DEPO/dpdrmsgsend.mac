/* шаг      "отправка  сообщения"                               */
/* Nikonorov Evgeny 29.05.2007                             */

import InsCarryDoc, OprInter, PaymInter, "dlcarry.inc", opr_depo;

/* Буферы ПД, заполняемые из операции */
record Pm_paym( pmpaym );     /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );     /*св-ва платежа*/
record Pm_rmprop( pmrmprop ); /*платеж по ценным бумагам*/

MACRO ExecuteStep( d, spdraft )

  var StatusKind = 0, OprStatus = 0;
  var err = 0;
  record r_spdraft( spdraft );

  SetBuff( r_spdraft, spdraft );

  err = SendDepoMessage(GetDpMessageByDraft( r_spdraft.AutoKey ));

  if(not err)
    
    if( r_spdraft.Kind == SP_DEPOPER_ENROLMENT )
      StatusKind = DP_OPERSTATUS_ENROL_DO;
    elif( r_spdraft.Kind == SP_DEPOPER_TRANSFERORDER )
      StatusKind = DP_OPERSTATUS_TRANSF_DO;
    end;

    if((r_spdraft.WaitForConf == SET_CHAR) OR (r_spdraft.WaitConfirmation == SET_CHAR))
      OprStatus = DP_OPERSTATUS_SPDRAFT_DO_CONFIRM; //Подтверждение операции
    else
      OprStatus = DP_OPERSTATUS_SPDRAFT_DO_ACCCARRY; //Отражение по счетам
    end;

    if( StatusKind and OprStatus and (not InsertOprStatus( StatusKind, OprStatus)) ) 
       msgbox( "Ошибка при установке статуса <Документооборот> операции" );
       err = 1;
    end;
  end;

  return err;

END;