/************************************************************************/
/*         Автоматизированная банковская система RS-Bank 6.0            */
/*                 Copyright (c) R-Style Software Lab 2005              */
/*                                                                      */
/*  Имя файла        : dpginfex.mac                                    */
/*  Описание         : Глобальные операции депозитария                  */
/*                     шага "выпуска отчета об исполнении               */
/*                             инвентарной операции"                    */
/*  Программист      : Nikonorov Evgeny                                 */
/*  Создан           : 06.07.2005                                       */
/************************************************************************/

import InsCarryDoc, OprInter, "dlcarry.inc", opr_depo, "spinfop.mac","dpsteprep.mac";
import DPInter, CTInter, "cb_sql.mac";
import RsbDataSet, deposerv;

/* Буферы ГЛ, заполняемые из операции */
record corpop( dpcorpop ); /*собственно поручение*/
record regstr( dpregstr ); /*реестр*/

file depoacnt("depoacnt");

const NumReportGlobOper = 45;      /* Отчет об исполнении глобальной операции */
const SC_SPDRAFT_STATUS_PREP = 1; /* отложенная операция */


macro ExecuteStep( d, crp ) 
  record dpcorpop("dpcorpop");
  var dpgrrep = TBFile("dpgrrep.dbt");

  SetBuff(dpcorpop, crp);

  /* перебирая всех получателей формируем отчеты для каждого */

  dpgrrep.AddFilter(" t_SourceDocKind = " + dpcorpop.DocKind +
                    " and t_SourceDocID = " + dpcorpop.DocumentID); 

  while(dpgrrep.next())

    //для каждого получателя отчета формировать исходящий документ
    if(DP_RegExtGroundToGrRep(dpgrrep.rec.ID))
      msgbox("Ошибка вставки исходящего документа для получателя отчета");
      return 1;
    end;

  end;

  return 0;

end;

/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    var dpgrrep = TBFile("dpgrrep.dbt");
    var extspgr = TBFile("spground.dbt");
    record dpcorpop("dpcorpop");
    var RepFileName = "";
    var ScanFileName;
    file ScanFile() txt APPEND;

    SetBuff(dpcorpop, FirstDoc);
    
    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

    if(isOprMultiExec() == true) //в массоввом режиме отчет печатается в dpscan.mac
      ScanFileName = GetTxtFileName("dpscanglobid");
      RepFileName = setoutput(ScanFileName, true);
      println(dpcorpop.DocumentID);
      //восстановим вывод
      setoutput(RepFileName, true);
      return;
    end;

    GlobopRepPrintStep(dpcorpop.DocumentID, dpcorpop.DocKind);

    return 1;

END;
