/*                                              */ 
/* макрос case-шагов всех инвентарных операций  */
/* Исполнить инвентарную операцию?              */
/* Chernov Anton 15-07-03                       */

import InsCarryDoc, OprInter, PaymInter, "dlcarry.inc", opr_depo;

/* Буферы ПД, заполняемые из операции */
record Pm_paym( pmpaym );    /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );    /*св-ва платежа*/
record Pm_rmprop( pmrmprop ); /*платеж по ценным бумагам*/


/* Номера шагов для перехода */
const НомерШагаВыпускОтчетаОбИсполнении = 100;

const НомерШагаОткрытиеРазделов = 20;
const НомерШагаЭкспертиза       = 20;
const НомерШагаПоискРазделов    = 40;
const НомерШагаОткрытиеРазделовПРХ = 40;

/*Номера видов системных дат*/
private const DATE_VALUE = 1;
private const DATE_VALUEREC = 2;

/**********************************/
/* Выполнение шага                */
/**********************************/
macro ExecuteCaseStep( Kind_Operation, Number_Step, first, KindDoc )
  record Spdraft( spdraft );
  var acnt = TBFile("depoacnt");
  var Type = 0;

  SetBuff( Spdraft, first );

  if( (spdraft.Kind != SP_DEPOPER_RECORDER) and (spdraft.Kind != SP_DEPOPER_WITHDRORDER))
     DefineOprDate( DATE_VALUE, Pm_paym.ValueDate );
  else
     DefineOprDate( DATE_VALUEREC, Pm_paym.ValueDate );
  end;
  
  if( Spdraft.OperState == DP_INVSTATUSORDER_REJECT )
    return string( НомерШагаВыпускОтчетаОбИсполнении );
  else
    if(   spdraft.Kind == SP_DEPOPER_BOOKORDER )
      return string( НомерШагаОткрытиеРазделов );
    elif( spdraft.Kind == SP_DEPOPER_TRANSFERORDER )
      if( Spdraft.OperState == DP_INVSTATUSORDER_MAKEKVIT )
        return string( НомерШагаВыпускОтчетаОбИсполнении );
      else
        return string( НомерШагаОткрытиеРазделов );
      end;
    elif( spdraft.Kind == SP_DEPOPER_ENROLMENT )
      if( Spdraft.OperState == DP_INVSTATUSORDER_MAKEKVIT )
        return string( НомерШагаВыпускОтчетаОбИсполнении );
      else
        return string( НомерШагаОткрытиеРазделов );
      end;
    elif( spdraft.Kind == SP_DEPOPER_RECORDER )
      //экспертизу планируем только если активный счет (место хранения) имеет значение "Типа счета по назначению"  равное  "Хранилище" 
      //и депонентом активного счета является Наш банк
      acnt.rec.AutoKey = Pm_paym.PayerDpNode;
      if(acnt.GetEQ()) 
        if(acnt.rec.Owner == {OurBank})
          if(not ПолучитьТипСчетаПоНазначению(acnt.rec.Root, Type))
            if( Type == OBJTYPE_DEPOKINDTYPE_PLACESAVE )
              return string( НомерШагаЭкспертиза );
            end;
          end;
        end;
      end;
      return string( НомерШагаОткрытиеРазделовПРХ );
    elif( spdraft.Kind == SP_DEPOPER_WITHDRORDER )
      return string( НомерШагаПоискРазделов );
    else
      msgbox( "Неизвестный вид поручения ", spdraft.Kind );
      return 1;
    end;
  end;
end;
