/*
$Name:         dpcrpsrv.mac
$Module:       Депозитарий
$Description:  Выполнение операции расчета выплат по ц/б
*/

import DPInter, CTInter, PaymInter, OprInter, dlquery, "oprkind.mac", "dppmaccfd.mac", "dl_car.mac", "dp_voop.mac", "nutxfun.mac", "pm_const.mac", "dllog_xml.mac";

private const TYPEKOPER_ISSUE  = "r"; // Погашение выпуска
private const TYPEKOPER_COUPON = "n"; // Погашение купона
private const TYPEKOPER_PARTLY = "x"; // Частичное погашение

//PRIVATE VAR CurrExecState = 0;
private var RepErrArr = TArray(); //массив ошибок по операции

/*класс с данными для списка ошибок в протоколе*/
class CDP_PmAccRepErr(_PmAccID:integer, _ExecState:integer, _ErrStr:string)
 var PmAccID      = _PmAccID;
 var ExecState    = _ExecState;
 var ErrStr       = _ErrStr;

 macro AddErr(_ErrStr)
   ErrStr = substr((ErrStr + IIF(ErrStr != "", "\n", "") + _ErrStr), 1, 1000);
 end;
end;

PRIVATE VAR CurrPmAccData = CDP_PmAccRepErr(0, 0, ""); //данные текущего обрабатываемого объекта

PRIVATE MACRO SetCurrPmAccData(PmAccID:integer, ExecState:integer)
  CurrPmAccData = CDP_PmAccRepErr(PmAccID,
                                  ExecState,
                                  "");
END;

PRIVATE MACRO ClearCurrPmAccData()
  SetCurrPmAccData(0, 0, "");
END;

macro depopmacc_msgbox()
  var i = 0, StrErr = "", str = "";
  var find = false;

  while(getparm(i,str))
    StrErr = StrErr + string(str);
    str = "";
    i = i + 1;
  end;

  if(CurrPmAccData.PmAccID > 0)
    CurrPmAccData.AddErr(StrErr);
  else
    RepErrArr[RepErrArr.size] = StrErr;
  end;
end;

private macro SetPmAccMessage(PmAccID:integer, Msg:string)
  var cmd;

  cmd = RsdCommand("UPDATE ddppmacc_dbt  " +
                   "   SET t_Message = ? " +
                   " WHERE t_ID = ?  "
                  );

  cmd.NullConversion = true;
  cmd.addParam( "", RSDBP_IN, Msg );
  cmd.addParam( "", RSDBP_IN, PmAccID );

  SQL_Execute( cmd );
end;

/*лог ошибок СО*/
CLASS (DL_LOG_DATA_XML) DP_PMACC_ERROR_LOG_DATA_XML(pDocKind:integer, pDocumentID:integer, pDataParms:TArray, pType:integer, pVersion:integer)

  PRIVATE MACRO СоздатьУзелОшибок(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "ErrStr",      m_DataParms[i]
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;

     return УзелОшибок;
  END;

  initDL_LOG_DATA_XML(pDocKind, pDocumentID, pDataParms, pType, pVersion);

END;

macro SavePmAccErrForReport_XML( RepErrArr, DocumentID:integer, DocKind:integer )

  var RepXML = "";

  if( RepErrArr.Size > 0 )
     RepXML = DP_PMACC_ERROR_LOG_DATA_XML(DocKind,DocumentID,RepErrArr,LOG_TYPE_ERROR).GetDataXML();
  end;

  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();

     DL_InsertHeaderLog(DocumentID, DocKind, {Oper}, Header);
     DL_InsertLogXMLData(DocumentID, DocKind, LOG_TYPE_ERROR, {Oper}, RepXML);
  end;

  RepErrArr.size = 0;

  if((CurrPmAccData.PmAccID > 0) and (CurrPmAccData.ErrStr))
    SetPmAccMessage(CurrPmAccData.PmAccID, CurrPmAccData.ErrStr);
  end;
end;

PRIVATE CLASS TInsertDpPmObj(PmAccID:integer, ExecState:integer)
  private var m_PmAccID   = PmAccID;
  private var m_ExecState = ExecState;
  private var m_dppmobjArr = TArray();
  private var m_dppmobjCache = RsbSQLInsert("dppmobj.dbt");

  macro Add(ObjKind:integer, ObjID:integer)
    var sz = m_dppmobjArr.size;

    m_dppmobjArr[sz] = TRecHandler("dppmobj.dbt");

    m_dppmobjArr[sz].Clear();

    m_dppmobjArr[sz].rec.PmAccID   = m_PmAccID;
    m_dppmobjArr[sz].rec.ExecState = m_ExecState;
    m_dppmobjArr[sz].rec.ObjKind   = ObjKind;
    m_dppmobjArr[sz].rec.ObjID     = ObjID;
  end;

  macro Save()
    var err = 0;

    m_dppmobjCache.AddRecordArray(m_dppmobjArr);
    if(not m_dppmobjCache.Insert())
      err = 1;
    end;

    return err;
  end;
END;

PRIVATE CLASS TInsertDepoTaxObjectNPTX(PmAccID:integer, ExecState:integer)
  private var m_TaxObjectsArr = TArray();
  private var m_PmAccID = PmAccID;
  private var m_ExecState = ExecState;

  macro Clear()
    m_TaxObjectsArr.size = 0;
  end;

  macro Add(Date,
            Client,
            Direction,
            Level,
            User,
            Kind,
            Sum,
            Cur,
            AnaliticKind1,
            Analitic1,
            AnaliticKind2,
            Analitic2,
            AnaliticKind3,
            Analitic3,
            AnaliticKind4,
            Analitic4,
            AnaliticKind5,
            Analitic5,
            AnaliticKind6,
            Analitic6,
            Comment)

    var nptxobj = TRecHandler("nptxobj.dbt");

      nptxobj.Clear();

      nptxobj.rec.OBJID         = 0;
      nptxobj.rec.DATE          = Date;
      nptxobj.rec.CLIENT        = Client;
      nptxobj.rec.DIRECTION     = Direction;
      nptxobj.rec.LEVEL         = Level;
      nptxobj.rec.USER          = User;
      nptxobj.rec.KIND          = Kind;
      nptxobj.rec.SUM           = Sum;
      nptxobj.rec.CUR           = Cur;

     // if(Cur != NATCUR)
     //   SmartConvertSum(nptxobj.rec.SUM0, nptxobj.rec.SUM, Date, Cur, NATCUR, false);
    //  else
    //    nptxobj.rec.SUM0 = nptxobj.rec.SUM;
    // end;

      nptxobj.rec.ANALITICKIND1 = AnaliticKind1;
      nptxobj.rec.ANALITIC1     = Analitic1;
      nptxobj.rec.ANALITICKIND2 = AnaliticKind2;
      nptxobj.rec.ANALITIC2     = Analitic2;
      nptxobj.rec.ANALITICKIND3 = AnaliticKind3;
      nptxobj.rec.ANALITIC3     = Analitic3;
      nptxobj.rec.ANALITICKIND4 = AnaliticKind4;
      nptxobj.rec.ANALITIC4     = Analitic4;
      nptxobj.rec.ANALITICKIND5 = AnaliticKind5;
      nptxobj.rec.ANALITIC5     = Analitic5;
      nptxobj.rec.ANALITICKIND6 = AnaliticKind6;
      nptxobj.rec.ANALITIC6     = Analitic6;
      nptxobj.rec.COMMENT       = Comment;

      m_TaxObjectsArr[m_TaxObjectsArr.size] = nptxobj;
  end;

  macro Save()
    var i = 0;
    var err = 0;
    var DpPmObj = TInsertDpPmObj(m_PmAccID, m_ExecState);
    var ObjID = 0;

    i = 0;
    while((not err) and (i < m_TaxObjectsArr.size))

      ObjID = 0;

      err = DL_NPTX_InsertTaxObjectRetID( m_TaxObjectsArr[i].rec.Date             // Дата НДР
                                         ,m_TaxObjectsArr[i].rec.CLIENT           // Клиент
                                         ,m_TaxObjectsArr[i].rec.DIRECTION        // Направление
                                         ,m_TaxObjectsArr[i].rec.LEVEL            // Уровень
                                         ,m_TaxObjectsArr[i].rec.USER             // Признак "Пользовательский"
                                         ,m_TaxObjectsArr[i].rec.KIND             // Вид НДР
                                         ,m_TaxObjectsArr[i].rec.SUM              // Сумма дохода/расхода
                                         ,m_TaxObjectsArr[i].rec.CUR              // Валюта дохода/расхода
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND1    // Вид аналитики 1
                                         ,m_TaxObjectsArr[i].rec.ANALITIC1        // Аналитика 1
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND2    // Вид аналитики 2
                                         ,m_TaxObjectsArr[i].rec.ANALITIC2        // Аналитика 2
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND3    // Вид аналитики 3
                                         ,m_TaxObjectsArr[i].rec.ANALITIC3        // Аналитика 3
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND4    // Вид аналитики 4
                                         ,m_TaxObjectsArr[i].rec.ANALITIC4        // Аналитика 4
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND5    // Вид аналитики 5
                                         ,m_TaxObjectsArr[i].rec.ANALITIC5        // Аналитика 5
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND6
                                         ,m_TaxObjectsArr[i].rec.ANALITIC6
                                         ,m_TaxObjectsArr[i].rec.COMMENT          // Комментарий
                                         ,0                                       // ID операции
                                         ,0                                       // ID шага операции
                                         ,1                                       // Признак вызова не из операции расчета НОБ
                                         ,ObjID );

      if((not err) and (ObjID <= 0))
        err = 1;
      end;

      if(not err)
        DpPmObj.Add(OBJTYPE_NPTXOBJ, ObjID);
      end;

      i = i + 1;
    end;

    if(not err)
      err = DpPmObj.Save();
    end;

    return err;
  end;

  Clear();

END;

PRIVATE CLASS TInsertDepoTaxObjectNUTX(crp, PmAccID:integer, ExecState:integer)
  private var m_TaxObjectsArr = TArray();
  private var m_PmAccID = PmAccID;
  private var m_ExecState = ExecState;
  private var m_crp = crp;

  macro Clear()
    m_TaxObjectsArr.size = 0;
  end;

  macro Add(Date,
            Client,
            Party,
            Direction,
            Level,
            User,
            Kind,
            Sum,
            Cur,
            AnaliticKind1,
            Analitic1,
            AnaliticKind2,
            Analitic2,
            AnaliticKind3,
            Analitic3,
            AnaliticKind4,
            Analitic4,
            AnaliticKind5,
            Analitic5,
            AnaliticKind6,
            Analitic6,
            Comment)

    var nutxobj = TRecHandler("nutxobj.dbt");

      nutxobj.Clear();

      nutxobj.rec.OBJID         = 0;
      nutxobj.rec.DATE          = Date;
      nutxobj.rec.CLIENT        = Client;
      nutxobj.rec.PARTY         = Party;
      nutxobj.rec.DIRECTION     = Direction;
      nutxobj.rec.LEVEL         = Level;
      nutxobj.rec.USER          = User;
      nutxobj.rec.KIND          = Kind;
      nutxobj.rec.SUM           = Sum;
      nutxobj.rec.CUR           = Cur;
      nutxobj.rec.ANALITICKIND1 = AnaliticKind1;
      nutxobj.rec.ANALITIC1     = Analitic1;
      nutxobj.rec.ANALITICKIND2 = AnaliticKind2;
      nutxobj.rec.ANALITIC2     = Analitic2;
      nutxobj.rec.ANALITICKIND3 = AnaliticKind3;
      nutxobj.rec.ANALITIC3     = Analitic3;
      nutxobj.rec.ANALITICKIND4 = AnaliticKind4;
      nutxobj.rec.ANALITIC4     = Analitic4;
      nutxobj.rec.ANALITICKIND5 = AnaliticKind5;
      nutxobj.rec.ANALITIC5     = Analitic5;
      nutxobj.rec.ANALITICKIND6 = AnaliticKind6;
      nutxobj.rec.ANALITIC6     = Analitic6;
      nutxobj.rec.COMMENT       = Comment;

      m_TaxObjectsArr[m_TaxObjectsArr.size] = nutxobj;

  end;

  macro Save()
    var i = 0;
    var err = 0;
    var DpPmObj = TInsertDpPmObj(m_PmAccID, m_ExecState);
    var ObjID = 0;

    i = 0;
    while((not err) and (i < m_TaxObjectsArr.size))

      ObjID = 0;

      err = DL_NUTX_InsertTaxObjectRetID( m_TaxObjectsArr[i].rec.Date             // Дата НДР
                                         ,m_TaxObjectsArr[i].rec.CLIENT           // Клиент
                                         ,m_TaxObjectsArr[i].rec.PARTY            // Фактический получатель
                                         ,m_TaxObjectsArr[i].rec.DIRECTION        // Направление
                                         ,m_TaxObjectsArr[i].rec.LEVEL            // Уровень
                                         ,m_TaxObjectsArr[i].rec.USER             // Признак "Пользовательский"
                                         ,m_TaxObjectsArr[i].rec.KIND             // Вид НДР
                                         ,m_TaxObjectsArr[i].rec.SUM              // Сумма дохода/расхода
                                         ,m_TaxObjectsArr[i].rec.CUR              // Валюта дохода/расхода
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND1    // Вид аналитики 1
                                         ,m_TaxObjectsArr[i].rec.ANALITIC1        // Аналитика 1
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND2    // Вид аналитики 2
                                         ,m_TaxObjectsArr[i].rec.ANALITIC2        // Аналитика 2
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND3    // Вид аналитики 3
                                         ,m_TaxObjectsArr[i].rec.ANALITIC3        // Аналитика 3
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND4    // Вид аналитики 4
                                         ,m_TaxObjectsArr[i].rec.ANALITIC4        // Аналитика 4
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND5    // Вид аналитики 5
                                         ,m_TaxObjectsArr[i].rec.ANALITIC5        // Аналитика 5
                                         ,m_TaxObjectsArr[i].rec.ANALITICKIND6
                                         ,m_TaxObjectsArr[i].rec.ANALITIC6
                                         ,m_TaxObjectsArr[i].rec.COMMENT          // Комментарий
                                         ,m_crp.rec.Dockind
                                         ,m_crp.rec.DocumentID
                                         ,m_PmAccID
                                         ,ObjID );

      if((not err) and (ObjID <= 0))
        err = 1;
      end;

      if(not err)
        DpPmObj.Add(OBJTYPE_NUTXOBJ, ObjID);
      end;

      i = i + 1;
    end;

    if(not err)
      err = DpPmObj.Save();
    end;

    return err;
  end;

  Clear();

END;

PRIVATE CLASS TPmAccData(_crp, _pmacc, _ExecDate)
  var m_crp      = _crp;
  var m_pmacc    = _pmacc;
  var m_ExecDate = _ExecDate;

  private var m_SecurUsed = SP_CheckLicence();

  private var m_pmaccfi         = NULL;
  private var m_issuer          = NULL;
  private var m_holder          = NULL;

  private var m_PaymentID       = NULL;
  private var m_UsePaymInPMACC  = NULL;
  private var m_IsRetirnIncome  = NULL;
  private var m_IsTradeDepoAcnt = NULL;
  private var m_DepoContrID     = NULL;
  private var m_IsIIS           = NULL;
  private var m_PmAccAccountID  = NULL;
  private var m_ClientAccountID = NULL;
  private var m_IsBrokAcc       = NULL;

  private var m_IsForeignAcc    = NULL;
  private var m_IsNatcurAcc     = NULL;

  macro GetPaymentID()
    var cmd, DataSet;

    if(m_PaymentID == NULL)
      m_PaymentID = 0;

      cmd = DL_RSDCommand(  "select t_PaymentID from dpmpaym_dbt"
                          + " where t_DocKind = " + SP_DEPOPER_DIVIDEND
                          + "   and t_DocumentID = ? "
                          + "   and t_Purpose IN (" + PM_PURP_SECUR_INCOME + ", " + PM_PURP_RETURNINCOME+")"
                          + "   and t_ReceiverDpNode = ? "
                         );
      cmd.AddParam(m_pmacc.rec.DocumentID);
      cmd.AddParam(m_pmacc.rec.HolderAccID);

      DataSet = cmd.Execute();
      if(DataSet.moveNext())
        m_PaymentID = DataSet.PaymentID;
      end;
    end;

    return m_PaymentID;
  end;

  macro UsePaymInPMACC()
    if(m_UsePaymInPMACC == NULL)
      m_UsePaymInPMACC = false;

      if((m_pmacc.rec.PaymentWay == PW_INPAYMENT)
      or (m_pmacc.rec.PaymentWay == PW_OUTPAYMENT)
      or (m_pmacc.rec.PaymentWay == PW_CONSOLIDATED)) /* Если выплата через банк */
        m_UsePaymInPMACC = true;
      end;
    end;
    return m_UsePaymInPMACC;
  end;

  macro IsPaymReturnIncome()
    if(m_IsRetirnIncome == NULL)
      m_IsRetirnIncome = false;

      if(this.UsePaymInPMACC() == true) /* Если выплата через банк */

        var PaymentID = this.GetPaymentID();
        if( PaymentID > 0 )
          var PaymentObj = RSBPayment( PaymentID );

          if(PaymentObj.Purpose == PM_PURP_RETURNINCOME)
            m_IsRetirnIncome = true;
          end
        end;
      end;
    end;

    return m_IsRetirnIncome;
  end;

  //Является ли счет депо торговым
  macro IsTradeDepoAcnt()
    var query, cmd, DataSet;

    if(m_IsTradeDepoAcnt == NULL)
      m_IsTradeDepoAcnt = false;

      query = "select RSB_DEPO.IsTradeDepoAcnt(?) as IsTrade from dual";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_pmacc.rec.HolderAccID);

      DataSet = cmd.Execute();

      if(DataSet.moveNext())
        m_IsTradeDepoAcnt = IIF(DataSet.IsTrade == 0, false, true);
      end;
    end;

    return m_IsTradeDepoAcnt;
  end;

  macro GetPmAccFI()
    var query, cmd, DataSet;

    if(m_pmaccfi == NULL)
      m_pmaccfi = TRecHandler("dppmacfi.dbt");

      m_pmaccfi.Clear();

      query = "select * from ddppmacfi_dbt where t_DocumentID = ? and t_HolderAccID = ?";

      cmd = DL_RsdCommand(query);

      cmd.AddParam(m_pmacc.rec.DocumentID);
      cmd.AddParam(m_pmacc.rec.HolderAccID);

      DataSet = cmd.Execute();

      if(DataSet.moveNext())
        DataSet.GetRecord().CopyTo(m_pmaccfi.rec);
      end;
    end;

    return m_pmaccfi;
  end;

  macro GetHolder()
    if(m_holder == NULL)
      m_holder = TRecHandler("party.dbt");

      ПолучитьСубъекта(m_pmacc.rec.BeneficiarID, m_holder);
    end;

    return m_holder;
  end;

  //Является ли получатель физлицом
  macro HolderIsPersn()

    if(GetHolder().rec.LegalForm == PTLEGF_PERSN)
      return true;
    end;

    return false;
  end;

  macro GetIssuer()
    if(m_issuer == NULL)
      var fin = TRecHandler("fininstr.dbt");

      m_issuer = TRecHandler("party.dbt");

      m_issuer.Clear();

      if(ПолучитьФинИн(GetPmAccFI().rec.FIID, fin) == 0)
        ПолучитьСубъекта(fin.rec.Issuer, m_issuer);
      end;
    end;

    return m_issuer;
  end;

  macro IsUSSRorAttr()
    var fin = TRecHandler("fininstr.dbt");
    if((ПолучитьФинИн(GetPmAccFI().rec.FIID, fin) == 0)/* AND (fin.rec.AvoirKind == 53)*/ )
      var NumInList = 0;
      var avoiriss = Trechandler( "avoiriss.dbt" ); /* бумага*/
      avoiriss.rec.FIID = GetPmAccFI().rec.FIID;

      if( GetMainObjAttr(null, OBJTYPE_AVOIRISS, UniID(avoiriss, OBJTYPE_AVOIRISS), OBJGROUP_AVRNPTXGROUP, null, null, NumInList) )
        if(NumInList)
          return true;
        end;
      elif(fin.rec.AvoirKind == 53)
        return true;
      end;

    end;
    return false;
  end;

  //Является ли эмитент резидентом
  macro IssuerIsResident()

    if(GetIssuer().rec.NotResident == UNSET_CHAR)
      return true;
    end;

    return false;
  end;

  macro GetDepoContrID();
    var query, DataSet, Select;

    if(m_DepoContrID == NULL)
      m_DepoContrID = 0;

      query =  " select sf.t_ID "
             + "   from dsfcontr_dbt sf, DDEPOACNT_DBT DEPOACNT "
             + "  where DEPOACNT.t_AutoKey = ? "
             + "    and sf.t_ObjectType = " + SF_DEPOACC
             + "    and sf.t_ServKind = " + PTSK_DEPOS
             + "    and sf.t_Object = depoacnt.t_Code "
             + "    and sf.t_PartyID = depoacnt.t_Owner";

      Select = DL_RSDCommand( query );
      Select.AddParam(m_pmacc.rec.HolderAccID);

      DataSet = Select.Execute();
      if (DataSet.movenext())
        m_DepoContrID =  SQL_ConvTypeInteger(DataSet.ID);
      end;
    end;

    return m_DepoContrID;
  end;

  macro IsContrIIS()
    var sfcontr = TBFile("sfcontr.dbt");

    if(m_IsIIS == NULL)
      var SfContrID = GetDepoContrID();

      m_IsIIS = false;

      if(SfContrID > 0)
        sfcontr.Clear();
        sfcontr.rec.ID = SfContrID;

        if(sfcontr.GetEQ())
          if(DL_GetMainObjAttr(sfcontr, OBJGROUP_SFCONTR_IIS, OBJTYPE_SFCONTR) == 1)
            m_IsIIS = true;
          end;
        end;
      end;
    end;

    return m_IsIIS;
  end;

  macro GetPmAccAccountID()
    var query, cmd, DataSet;

    if(m_PmAccAccountID == NULL)
      m_PmAccAccountID = 0;

      query =   " select acc.t_AccountID "
              + "   from ddppmrac_dbt rac, daccount_dbt acc "
              + "  where rac.t_DocumentID = ? "
              + "    and rac.t_HolderAccID = ? "
              + "    and rac.t_BankIC = " + {OurBank}
              + "    and acc.t_Account = rac.t_Account "
              + "    and acc.t_Code_Currency = rac.t_Currency "
              + "    and acc.t_Chapter = rac.t_Chapter ";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_pmacc.rec.DocumentID);
      cmd.AddParam(m_pmacc.rec.HolderAccID);

      DataSet = cmd.Execute();

      if(DataSet.MoveNext())
        m_PmAccAccountID = DataSet.AccountID;
      end;
    end;

    return m_PmAccAccountID;
  end;

  macro GetClientAccountID()
    var query, cmd, DataSet;

    if(m_ClientAccountID == NULL)
      var DlContrID = 0;
      var UseSubAcc = UNSET_CHAR;

      m_ClientAccountID = 0;

      if(GetDepoContrID() > 0)

        query =   " select dlcontr.t_DlContrID, dlcontr.t_UseSubAcc "
                + "   from dsfcontr_dbt dpsfcontr, ddlcontr_dbt dlcontr "
                + "  where dpsfcontr.t_ID = ? "
                + "    and dpsfcontr.t_UnionContrID > 0 "
                + "    and dlcontr.t_UniDepoContrID = dpsfcontr.t_UnionContrID "
                + "    and dlcontr.t_UseSubAcc = 'X' ";

        cmd = DL_RSDCommand(query);

        cmd.AddParam( GetDepoContrID() );

        DataSet = cmd.Execute(query);

        if( DataSet.MoveNext() )
          DlContrID = DataSet.DlContrID;
          UseSubAcc = DataSet.UseSubAcc;
        end;

        if(DlContrID > 0)
          if(UseSubAcc == SET_CHAR)

            //Если есть связанный ДБО и в нем установлен флаг "субсчета", то рублевый субсчет,
            //открытый по виду обслуживания "фондовый дилинг" подвид "Биржевое обслуживание"
            query =   " select acc.t_AccountID "
                    + "   from ddlcontr_dbt dlcontr, ddlcontrmp_dbt mp, dsfcontr_dbt sfcontr, dsfssi_dbt ssi, dsettacc_dbt sa, daccount_dbt acc "
                    + "  where mp.t_DlContrID = ? "
                    + "    and sfcontr.t_ID = mp.t_SfContrID "
                    + "    and sfcontr.t_ServKind = " + PTSK_STOCKDL
                    + "    and sfcontr.t_ServKindSub = 8 " //Биржевой рынок
                    + "    and sfcontr.t_PartyID = ? "
                    + "    and sfcontr.t_ContractorID = ? "
                    + "    and sfcontr.t_DateBegin <= ? "
                    + "    and ( sfcontr.t_DateClose > ? "
                    + "       or sfcontr.t_DateCLose = "+GetSQLDate(date(0,0,0))+" ) "
                    + "    and ssi.t_ObjectType = " + OBJTYPE_SFCONTR
                    + "    and ssi.t_ObjectID = LPAD(sfcontr.t_ID, 10, 0) "
                    + "    and sa.t_SettAccID = ssi.t_SetAccID "
                    + "    and sa.t_FIID = " + NATCUR
                    + "    and acc.t_Account = sa.t_Account "
                    + "    and acc.t_Code_Currency = sa.t_FIID "
                    + "    and acc.t_Chapter = sa.t_Chapter "
                    + "    and acc.t_Open_Close = CHR(0) "
                    + "  order by acc.t_Open_Date ASC, acc.t_AccountID asc";

            cmd = DL_RSDCommand(query);

            cmd.AddParam( DlContrID );
            cmd.AddParam( m_pmacc.rec.HolderID );
            cmd.AddParam( {OurBank} );
            cmd.AddParam( m_ExecDate );
            cmd.AddParam( m_ExecDate );

            DataSet = cmd.Execute(query);

            if( DataSet.MoveNext() )
              m_ClientAccountID = DataSet.AccountID;
            end;
          else

            //Если есть связанный ДБО и флаг "Субсчета" сброшен, то рублевый брокерский счет
            query = " select acc.t_AccountID "
                  + "   from ddlcontacc_dbt dlcontracc, daccount_dbt acc "
                  + "  where dlcontracc.t_DlContrID = ? "
                  + "    and dlcontracc.t_MPID = 0 "
                  + "    and dlcontracc.t_AccountID > 0 "
                  + "    and acc.t_AccountID = dlcontracc.t_AccountID "
                  + "    and acc.t_Code_Currency = " + NATCUR
                  + "    and acc.t_Open_Close = CHR(0) "
                  + "  order by acc.t_Open_Date ASC, acc.t_AccountID asc";

            cmd = DL_RSDCommand(query);

            cmd.AddParam( DlContrID );

            DataSet = cmd.Execute(query);

            if( DataSet.MoveNext() )
              m_ClientAccountID = DataSet.AccountID;
            end;
          end;
        else
          //Если связанного ДБО нет, то берем открытый рублевый брокерский счет, открытый по ДО (кроме ИИС).
          if(IsContrIIS() == false)
            query =   " select acc.t_AccountID "
                    + "   from dsfssi_dbt ssi, dsettacc_dbt sa, daccount_dbt acc "
                    + "  where ssi.t_ObjectType = " + OBJTYPE_SFCONTR
                    + "    and ssi.t_ObjectID = LPAD(?, 10, 0) "
                    + "    and sa.t_SettAccID = ssi.t_SetAccID "
                    + "    and sa.t_FIID = " + NATCUR
                    + "    and acc.t_Account = sa.t_Account "
                    + "    and acc.t_Code_Currency = sa.t_FIID "
                    + "    and acc.t_Chapter = sa.t_Chapter "
                    + "    and acc.t_Open_Close = CHR(0) "
                    //+ "    and acc.t_Balance IN ('30601', '30606')"
                    + "  order by acc.t_Open_Date ASC, acc.t_AccountID asc";

            cmd = DL_RSDCommand(query);

            cmd.AddParam( GetDepoContrID() );

            DataSet = cmd.Execute(query);

            if( DataSet.MoveNext() )
              m_ClientAccountID = DataSet.AccountID;
            end;
          end;
        end;
      end;
    end;

    return m_ClientAccountID;
  end;

  macro ВыплатаНаБрокерскийСчет()
    var query, cmd, DataSet;

    if(m_IsBrokAcc == NULL)
      m_IsBrokAcc = false;

      query =   " select 1 "
              + "   from ddppmrac_dbt rac, daccount_dbt acc "
              + "  where rac.t_DocumentID = ? "
              + "    and rac.t_HolderAccID = ? "
              + "    and rac.t_BankIC = " + {OurBank}
              + "    and acc.t_Account = rac.t_Account "
              + "    and acc.t_Code_Currency = rac.t_Currency "
              + "    and acc.t_Chapter = rac.t_Chapter "
              + "    and acc.t_Balance IN ('30601', '30606')";

      cmd = DL_RSDCommand(query);

      cmd.AddParam(m_pmacc.rec.DocumentID);
      cmd.AddParam(m_pmacc.rec.HolderAccID);

      if(cmd.GetCount() > 0)
        m_IsBrokAcc = true;
      end;
    end;

    return m_IsBrokAcc;
  end;

  macro ВыплатаНаТекущийСчет()
    var IsCurr = false;

    if((GetPmAccAccountID() > 0) and (ВыплатаНаБрокерскийСчет() == false))
      IsCurr = true;
    end;

    return IsCurr;
  end;

  macro ВыплатаНаВалютныйСчёт()
    var PmRac = TRecHandler("dppmrac.dbt");

    if(m_IsForeignAcc == NULL)
      m_IsForeignAcc = false;

      if((DP_GetPmRac(m_pmacc.rec.DocumentID, m_pmacc.rec.HolderAccID, PmRac) == 0) and
         (PmRac.rec.Currency != NATCUR) and (PmRac.rec.Currency != -1)
        )
        m_IsForeignAcc = true;
      end;
    end;

    return m_IsForeignAcc;
  end;

  macro ВыплатаНаРублёвыйСчёт()
    var PmRac = TRecHandler("dppmrac.dbt");

    if(m_IsNatcurAcc == NULL)
      m_IsNatcurAcc = false;

      if((DP_GetPmRac(m_pmacc.rec.DocumentID, m_pmacc.rec.HolderAccID, PmRac) == 0) and
         (PmRac.rec.Currency == NATCUR)
        )
        m_IsNatcurAcc = true;
      end;
    end;

    return m_IsNatcurAcc;
  end;

  //Нужно ли создавать операцию погашения
  macro NeedCreateRetire()
    var NeedCreate = false;

    if((IsPaymReturnIncome() == false) and (m_SecurUsed == true) and (DL_WORKWITHDEPOSITARY) and (HolderIsPersn() == true))

      if(IssuerIsResident() == true) //Эмитент-резидент
        if(m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
          NeedCreate = true;
        elif(((m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE)) AND
             (IsTradeDepoAcnt() == true) and
             ((ВыплатаНаБрокерскийСчет() == true) or (ВыплатаНаТекущийСчет(true)))
            )
          NeedCreate = true;
        end;
      else //Эмитент-нерезидент
        if(m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
          if((IsTradeDepoAcnt() == true) and
             (IsContrIIS() == true)
            )
            NeedCreate = true;
          end;
        elif((m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE))
          if((IsTradeDepoAcnt() == true)      and //Если указан признак торгового счета депо
             (ВыплатаНаТекущийСчет() == true) and //И вид счета выплаты текущий
             (IsContrIIS() == false)          and //И договор не ИИС
             (ВыплатаНаВалютныйСчёт() == true)    //И валюта счета не рубли
            )
            NeedCreate = true;
          end;

          if((IsTradeDepoAcnt() == true) and
             (ВыплатаНаБрокерскийСчет() == true) and
             (IsContrIIS() == true)
            )
            NeedCreate = true;
          end;
        end;
      end;
    end;

    return NeedCreate;
  end;

  //Нужно ли создавать операцию расчета НОБ
  macro NeedCreateOpCalcTax()
    var NeedCreate = false;

    if((m_SecurUsed == true) and (IsPaymReturnIncome() == false) and (HolderIsPersn() == true))
      if(IssuerIsResident() == true) //Эмитент-резидент

        if(((m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE)) and
           (IsTradeDepoAcnt() == true) and
           (ВыплатаНаТекущийСчет() == true)
          )
          NeedCreate = true;
        end;
      else //Эмитент-нерезидент
        if((m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE))
          if((IsTradeDepoAcnt() == true)       and //Если указан признак торгового счета депо
             (ВыплатаНаТекущийСчет() == true)  and //И вид счета выплаты текущий
             (IsContrIIS() == false)           and //И договор не ИИС
             (ВыплатаНаВалютныйСчёт() == true)     //И валюта счета не рубли
            )
            NeedCreate = true;
          end;
        end;
      end;
    end;

    return NeedCreate;
  end;

  //Нужно ли создавать операцию удержания НДФЛ
  macro NeedCreateOpHoldTax()
    var NeedCreate = false;

    if((m_SecurUsed == true) and (IsPaymReturnIncome() == false) and (HolderIsPersn() == true))
      if(IssuerIsResident() == true) //Эмитент-резидент
        if((m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE))
          if((IsTradeDepoAcnt() == true) and   //Если указан признак торгового счета депо
             (ВыплатаНаТекущийСчет() == true)  //И вид счета выплаты текущий
            )
            NeedCreate = true;
          end;
        end;
      else //Эмитент-нерезидент
        if(m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
          if((IsTradeDepoAcnt() == true) and                                           //Если указан признак торгового счета депо
             ((ВыплатаНаБрокерскийСчет() == true) or (ВыплатаНаТекущийСчет(true))) and //И вид счета выплаты брокерский или текущий
             (IsContrIIS() == false) and                                               //И договор не ИИС
             (ВыплатаНаВалютныйСчёт() == true)                                         //И валюта счета не рубли
            )
            NeedCreate = true;
          end;
        elif((m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE))
          if((IsTradeDepoAcnt() == true)       and //Если указан признак торгового счета депо
             (ВыплатаНаТекущийСчет() == true)  and //И вид счета выплаты текущий
             (ВыплатаНаВалютныйСчёт() == true)     //И валюта счета не рубли
            )
            NeedCreate = true;
          end;
        end;
      end;
    end;

    return NeedCreate;
  end;

  //Нужно ли формировать объекты НДР НДФЛ
  macro NeedCreateTaxObjTipi()
    var NeedCreate = false;

    if((m_SecurUsed == true) and (IsPaymReturnIncome() == false) and (HolderIsPersn() == true))

      if(IssuerIsResident() == true) //Эмитент-резидент
        if(m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS)
          NeedCreate = true;
        elif(m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
          NeedCreate = true;
        end;
      else //Эмитент-нерезидент
        if(m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
          if((IsTradeDepoAcnt() == true) and                                           //Если указан признак торгового счета депо
             ((ВыплатаНаБрокерскийСчет() == true) or (ВыплатаНаТекущийСчет(true))) and //И вид счета выплаты брокерский или текущий
             (IsContrIIS() == false) and                                               //И договор не ИИС
             (ВыплатаНаВалютныйСчёт() == true)                                         //И валюта счета не рубли
            )
            NeedCreate = true;
          end;

          if((IsTradeDepoAcnt() == true) and
             (IsContrIIS() == true)
            )
            NeedCreate = true;
          end;
          if((IsTradeDepoAcnt() == true) or (IsUSSRorAttr() == true))
            NeedCreate = true;
          end;
        elif( (m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS) and (IsUSSRorAttr() == true) )
          NeedCreate = true;
        end;
      end;
    end;

    return NeedCreate;
  end;

  //Обновить запись о выплате
  macro UpdatePMACC()
    var cmd;

    cmd = RsdCommand("UPDATE ddppmacc_dbt " +
                     "   SET t_PayAmount     = ?, " +
                     "       t_Amount        = ?, " +
                     "       t_CalcTaxAmount = ?, " +
                     "       t_ExecState     = ?  "
                     " WHERE t_ID = ?  "
                    );

    cmd.addParam( "", RSDBP_IN, m_pmacc.rec.PayAmount );
    cmd.addParam( "", RSDBP_IN, m_pmacc.rec.Amount );
    cmd.addParam( "", RSDBP_IN, m_pmacc.rec.CalcTaxAmount );
    cmd.addParam( "", RSDBP_IN, m_pmacc.rec.ExecState );
    cmd.addParam( "", RSDBP_IN, m_pmacc.rec.ID );

    SQL_Execute( cmd );

    return 0;

    OnError(er)
      msgbox(er.module+ " "+er.line+" "+er.message);

      return 1;
  end;

END;

private macro CheckRetireAutoStart():Bool
  var regValue:Bool = false;
  var errCode:Integer = 0;

  GetRegistryValue( "DEPO\\АВТОЗАПУСК ПОГАШЕНИЙ В БОЦБ", V_BOOL, regValue, errCode );

  return ( ( errCode == 0 ) and regValue );
end;

//клиентский ли счет?
private macro IsClientAcc(Account)
  var МаскиСчетовКлиентов = "", err;
  GetRegistryValue("PS\\REQOPENACC\\СЧЕТА КЛИЕНТОВ", V_STRING, МаскиСчетовКлиентов, err);
  if (StrLen (МаскиСчетовКлиентов)==0)
    return false; //масок нет - сравнивать не с чем
  end;
  МаскиСчетовКлиентов = StrSubst ( МаскиСчетовКлиентов, ";", "," );
  if(CompareStrWithMasks (МаскиСчетовКлиентов,Account) == 0)
    return true; //счет подходит под маску - значит клиентский
  end;
  return false;
end;

// Является ли счет счетом заданного типа?
private macro CheckAccount_Type( Account:string, Chapter:integer, FIID:integer, AccType:string ):bool

  var query, cmd;

  query =   " select 1 "
          + "  from daccount_dbt acc "
          + " where acc.t_Account       = ? "
          + "   and acc.t_Chapter       = ? "
          + "   and acc.t_Code_Currency = ?    "
          + "   and instr(acc.t_Type_Account, '" + AccType + "') > 0 ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(Account);
  cmd.AddParam(Chapter);
  cmd.AddParam(FIID);

  if(cmd.GetCount() > 0)
    return true;
  end;

  return false;
end;

private macro GetIsIntegrated()
  var ErrCode, Path = "COMMON\\WORK_MODE\\INTEGRATED", Integr = false;

  GetRegistryValue(Path, V_BOOL, Integr, ErrCode);
  if( ErrCode != 0 )
     MsgBox("Ошибка при получении значения настройки \"" + Path + "\"");
     Integr = false;
  end;

  return Integr;
end;

private macro GetIsExtCarry():bool
  var ErrCode, Path = "COMMON\\WORK_MODE\\ПРОВОДКА ПО ИСХОДЯЩИМ ПЛАТЕЖАМ", ExtCarry = false;

  GetRegistryValue(Path, V_BOOL, ExtCarry, ErrCode);
  if( ErrCode != 0 )
     MsgBox("Ошибка при получении значения настройки \"" + Path + "\"");
     ExtCarry = false;
  end;

  return ExtCarry;
end;

PRIVATE MACRO GetPartyCode(PartyID, CodeKind):STRING
  return ПолучитьКодСубъекта(PartyID, CodeKind);
END;

MACRO CorSchem(PmRac):INTEGER
  var Schem = 0;
  if((PmRac.rec.BankCorrID > 0) and (PmRac.rec.BankCorrID != {OurBank}))
    Schem = ПолучитьКорсхемуПоУмолчанию(PmRac.rec.BankCorrID, PmRac.rec.Currency, 1);
  elif((PmRac.rec.BankIC > 0) and (PmRac.rec.BankIC != {OurBank}))
    Schem = ПолучитьКорсхемуПоУмолчанию(PmRac.rec.BankIC, PmRac.rec.Currency, 1);
  end;

  return Schem;
END;

private macro GetNextExecState(ExecState:integer)
  var query, cmd, DataSet;
  var NextExecState = -1;

  query =   " select t_Element "
          + "   from dllvalues_dbt "
          + "  where t_List = " + OBJTYPE_DPPMACC_EXECSTATE
          + "    and t_Element > ? "
          + " order by t_Element asc";

  cmd = DL_RSDCommand(query);
  cmd.AddParam(ExecState);

  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    NextExecState = DataSet.Element;
  end;

  return NextExecState;
end;

private macro GetActuatePmacc(PmAccID:integer, pmacc:TRecHandler)
  var cmd, DataSet;
  var err = 0;

  pmacc.Clear();

  cmd = DL_RSDCommand("select * from ddppmacc_dbt where t_ID = ?");
  cmd.AddParam(PmAccID);

  DataSet = cmd.Execute();

  if(DataSet.moveNext())
    DataSet.GetRecord().CopyTo(pmacc.rec);
  else
    err = 1;
    msgbox("Не найдена запись о получателе дохода");
  end;

  return err;
end;

private macro ВыполнитьНачисление(pmaccObj)
  var err = 0;
  var FD = null, tr = null, TrnBatch = null;
  var DtAcc = TRecHandler("account.dbt");
  var CtAcc = TRecHandler("account.dbt");

  if(CheckDepoChargeIncome() == true)

    if((pmaccObj.m_ExecDate < pmaccObj.m_crp.rec.ValueDate) OR (pmaccObj.m_ExecDate > pmaccObj.m_crp.rec.EndValueDate))
      msgbox("Начисление дохода может быть выполнено только в период выплат");
      err = 1;
    end;

    if((not err) AND (pmaccObj.m_crp.rec.DontCarryCharge == UNSET_CHAR))
      FD = DP_PmaccFD(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID);

      if(false == FD.OpenAccount( "-Расчеты, Выплаты по ц/б", NULL, NULL, CtAcc, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency ))
        msgbox("Ошибка при открытии счета");
        err = 1;
      end;

      if(not err)

        /*проводку формируем без платежа*/
        tr = RsbAccTransaction();

        if(tr == null)
          msgbox("Ошибка при формировании проводки");
          err = 1;
        end;

        if(not err)
          if(DP_FindAccount(pmaccObj.m_crp.rec.Account, pmaccObj.m_crp.rec.Currency, 1, DtAcc) != 0)
            msgbox("Не найден счет");
            err = 1;
          end;

          if(not err)
            tr.Date_Carry = pmaccObj.m_crp.rec.ValueDate;

            tr.Chapter         = 1;
            tr.Department      = pmaccObj.m_crp.rec.Department;

            tr.Number_Pack     = 0;
            tr.Numb_Document   = "";
            tr.Ground          = "Начисление дохода";
            tr.FIIDPayer       = pmaccObj.m_crp.rec.Currency;
            tr.FIIDReceiver    = pmaccObj.m_crp.rec.Currency;
            tr.SumPayer        = pmaccObj.m_pmacc.rec.BruttoAmount;
            tr.SumReceiver     = pmaccObj.m_pmacc.rec.BruttoAmount;
            tr.AccountPayer    = pmaccObj.m_crp.rec.Account;
            tr.AccountReceiver = CtAcc.rec.Account;

            tr.Shifr_Oper = DL_GetShifrOper(1, DtAcc.rec, CtAcc.rec);

            TrnBatch = RsbBatchAccTrn;
            TrnBatch.AddAccTransaction( tr, NULL, 0, 0 );
          end;
        end;
      end;
    end;

    if(not err)
      var DpPmObj = TInsertDpPmObj(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);
      var i = 0;
      var arrErrCode = TArray(), arrErrMessage = TArray();
      var ClosedAcc = "";

      RslDefCon.BeginTrans();

      if(TrnBatch != null)

        TrnBatch.Execute();
        //Переносим ID проводок
        var nCarry = TrnBatch.GetResult( arrErrCode, arrErrMessage );
        while(i < nCarry)
          var accTrn = TrnBatch.GetAccTransaction(i);

          if( arrErrCode[i] == 0 )
            DpPmObj.Add(DLDOC_CARRY, accTrn.AccTrnID);
          else
            if (arrErrCode[i] != ACCTRN_PACKAGE_ERROR_NUMBER)
              if(arrErrCode[i] == ERR_CLOSED_PAYERACC)
                ClosedAcc = accTrn.AccountPayer;
              elif(arrErrCode[i] == ERR_CLOSED_RECEIVERACC)
                ClosedAcc = accTrn.AccountReceiver;
              end;
              msgbox("Ошибка при выполнении проводки \""+accTrn.Ground+"\". " + arrErrMessage[i] + " " + ClosedAcc);
              ClosedAcc = "";
              err = 1;
            end;
          end;

          i = i + 1;
        end;
      end;

      if(not err)
        err = DpPmObj.Save();
        if(err)
          msgbox("Ошибка при сохранении объектов операции");
        end;
      end;

      if(not err)
        if(not DP_ChangePMACCState(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID, DPPMAC_STATE_CRED, pmaccObj.m_crp.rec.ValueDate, true))
          msgbox("Ошибка при изменении статуса выплаты");
          err = 1;
        end;
      end;

      if(not err)
        pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_CALC;

        err = pmaccObj.UpdatePMACC();
      end;

      if(err)
        RslDefCon.RollbackTrans();
      else
        RslDefCon.CommitTrans();
      end;
    end;
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

private macro ОформитьВыплату(pmaccObj)
  var err = 0;
  var pmObj = NULL;
  var PmRac = TRecHandler("dppmrac.dbt");
  var PayerAcc = TRecHandler("account.dbt");

  if(pmaccObj.UsePaymInPMACC() == true)

    pmObj = RsbPayment(0);

    pmObj.DocKind    = SP_DEPOPER_DIVIDEND;
    pmObj.DocumentID = pmaccObj.m_crp.rec.DocumentID;

    pmObj.ReceiverDpNode = pmaccObj.m_pmacc.rec.HolderAccID;

    pmObj.OrderFIID   = pmaccObj.m_crp.rec.Currency;
    pmObj.OrderAmount = pmaccObj.m_pmacc.rec.Amount;

    pmObj.BaseFIID   = pmaccObj.m_crp.rec.Currency;
    pmObj.BaseAmount = pmaccObj.m_pmacc.rec.Amount;

    pmObj.Number     = string(pmObj.ReceiverDpNode);

    if(not CheckDepoChargeIncome())

      pmObj.ValueDate = pmaccObj.m_crp.rec.ValueDate;

      err = DP_GetPmRac(pmaccObj.m_crp.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID, PmRac);
      if(err)
        msgbox("Не найдена ПИ получателя средств");
      end;

      if(DP_FindAccount(pmaccObj.m_crp.rec.Account, pmaccObj.m_crp.rec.Currency, 1, PayerAcc) != 0)
        msgbox("Не найден счет плательщика");
        err = 1;
      end;

      pmObj.Purpose = PM_PURP_SECUR_INCOME;
      pmObj.Ground  = PmRac.rec.Description;
    else
      var FD = DP_PmaccFD(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID);

      pmObj.ValueDate = pmaccObj.m_ExecDate;

      if(false == FD.OpenAccount( "-Расчеты, Выплаты по ц/б", NULL, NULL, PayerAcc, pmObj.ValueDate, pmaccObj.m_crp.rec.Currency ))
        msgbox("Ошибка при открытии счета");
        err = 1;
      end;

      if(not err)
        var HolderAccID = pmaccObj.m_pmacc.rec.HolderAccID;

        if(pmaccObj.m_ExecDate > pmaccObj.m_crp.rec.EndValueDate)
          HolderAccID = 0; //Для поиска ПИ эмитента
        end;

        err = DP_GetPmRac(pmaccObj.m_crp.rec.DocumentID, HolderAccID, PmRac);
        if(err)
          if(HolderAccID == 0)
            msgbox("Не найдена ПИ эмитента для возврата дохода");
          else
            msgbox("Не найдена ПИ получателя средств");
          end;
        end;
      end;

      if(not err)
        pmObj.Purpose = PM_PURP_SECUR_INCOME;
        pmObj.Ground  = PmRac.rec.Description;
        if(HolderAccID == 0)
          pmObj.Purpose = PM_PURP_RETURNINCOME;
          pmObj.Ground  = "Возврат средств";
        end;
      end;
    end;

    if(not err)
      var Payer       = PayerAcc.rec.Client;
      var PayerBankID = {OurBank};

      pmObj.SetPayerPI (PAYMENTS_GROUP_INTERNAL,
                        PayerBankID,
                        PTCK_CONTR,
                        GetPartyCode(PayerBankID, PTCK_CONTR),
                        GetPartyName(PayerBankID),
                        "",
                        PayerAcc.rec.Code_Currency,
                        1,
                        PayerAcc.rec.Account,
                        Payer,
                        GetPartyName(Payer),
                        GetPartyINN(Payer),
                        PTCK_CONTR,
                        GetPartyCode(Payer, PTCK_CONTR),
                        0,
                        0);

      pmObj.SetReceiverPI (PAYMENTS_GROUP_UNDEF,
                           PmRac.rec.BankIC,
                           PmRac.rec.BankCodeKind,
                           PmRac.rec.BankCode,
                           PmRac.rec.BankName,
                           PmRac.rec.CorrAcc,
                           PmRac.rec.Currency,
                           1,
                           PmRac.rec.Account,
                           PmRac.rec.Receiver,
                           PmRac.rec.RecName,
                           PmRac.rec.INN,
                           PTCK_CONTR,
                           GetPartyCode(PmRac.rec.Receiver, PTCK_CONTR),
                           CorSchem(PmRac),
                           0);

      pmObj.Department  = pmaccObj.m_crp.rec.Department;
      pmObj.PaymStatus  = PM_PREPARING;
      pmObj.Oper        = {oper};
      pmObj.Netting     = UNSET_CHAR;

      if( not DP_SetPaymentGround( pmObj.GetPM_PAYM(), pmaccObj.m_crp, pmaccObj.m_pmacc ) )
        err = 1;
      end;
    end;

    if(not err)
      RslDefCon.BeginTrans();

      err = pmObj.Update();
      if(not err)
        var DpPmObj = TInsertDpPmObj(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);

        DpPmObj.Add(DLDOC_PAYMENT, pmObj.PaymentID);

        err = DpPmObj.Save();
        if(err)
          msgbox("Ошибка при сохранении объектов операции");
        end;
      end;

      if(not err)
        pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_ACCRUED;

        err = pmaccObj.UpdatePMACC();
      end;

      if(err)
        RslDefCon.RollbackTrans();
      else
        RslDefCon.CommitTrans();
      end;
    end;
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

PRIVATE MACRO Rs(PtIsRes)
   if (PtIsRes == NPTXPARTY_RESIDENT)
      return 9.0;
   else
      return 15.0;
   end;
END;

PRIVATE MACRO Rg(PtIsRes)
   if (PtIsRes == NPTXPARTY_RESIDENT)
      return 13.0;
   else
      return 30.0;
   end;
END;

private macro InsertTaxObject(pmaccObj, TaxObj:@variant):Integer
  var err:Integer = 0;
  var query:String = "";
  var rsdCmd = null;
  var dataSet = null;
  var direction:Integer = 0;
  var level:Integer = 0;
  var vKind:Integer = 0;
  var sum:Money = $0;
  var cur:Integer = 0;
  var analiticKind1:Integer = 0;
  var analitic3:Integer = -1;
  var analitic4:Integer = -1;
  var analitic5:Integer = -1;
  var comment:String = "";
  var pContract = pmaccObj.GetDepoContrID();
  var PtIsRes = DL_GetPartyResident(pmaccObj.m_pmacc.rec.BeneficiarID);
  var IsIIS = pmaccObj.IsContrIIS();
  var Quantity = $0, Year, pBegDate, pEndDate, R, Div_Sec0 = $0, DivPay_Sec0 = $0, MinusSum = $0, PlusSum = $0, ProcSec_TS0 = $0;

  DateSplit( pmaccObj.m_crp.rec.ValueDate, null, null, Year );
  pBegDate = Date(1,1,Year);
  pEndDate = pmaccObj.m_crp.rec.ValueDate;

  query =   " SELECT dppmfi.t_FIID, dppmacfi.t_Quantity, "
          + "        NPTO.Market1date( dppmfi.t_FIID, ? ) t_Circulate, "
          + "        NPTO.GetPaperTaxGroupNPTX( dppmfi.t_FIID ) t_TaxGroupNPTX "
          + "   FROM ddpregstr_dbt regstr, ddppmfi_dbt dppmfi, ddppmacfi_dbt dppmacfi "
          + "  WHERE regstr.t_DocumentID = ? "
          + "    AND dppmfi.t_RegisterID = regstr.t_RegisterID "
          + "    AND dppmacfi.t_DocumentID = regstr.t_DocumentID "
          + "    AND dppmacfi.t_HolderAccID = ? "
          + "    AND dppmacfi.t_FIID = dppmfi.t_FIID ";

  rsdCmd = DL_RsdCommand( query );
  rsdCmd.AddParam(pmaccObj.m_crp.rec.ValueDate );
  rsdCmd.AddParam(pmaccObj.m_crp.rec.DocumentID );
  rsdCmd.AddParam(pmaccObj.m_pmacc.rec.HolderAccID );
  dataSet = rsdCmd.Execute();

  if( dataSet.MoveNext() )
    analitic3 = dataSet.FIID;
    analitic4 = Int( dataSet.Circulate );
    analitic5 = Int( dataSet.TaxGroupNPTX );
    Quantity = SQL_ConvTypeSum(dataSet.Quantity);
  end;

  TaxObj = TInsertDepoTaxObjectNPTX(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);

  if(pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS)

     direction = TXOBJ_DIR_IN;
     level = 4;
     vKind = TXOBJ_DIV_SEC;
     comment = "Выплата суммы дивидендов в Депозитарии";
     analiticKind1 = TXOBJ_KIND1098;
     sum = pmaccObj.m_pmacc.rec.BruttoAmount;
     cur = pmaccObj.m_crp.rec.Currency;

     if(pmaccObj.m_crp.rec.Currency != NATCUR)
        ConvSum(Div_Sec0, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
     else
        Div_Sec0 = sum;
     end;

     if( sum != $0 )
        TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                   ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                   ,direction                         // Направление
                   ,level                             // Уровень
                   ,""                                // Признак "Пользовательский"
                   ,vKind                             // Вид НДР
                   ,sum                               // Сумма дохода/расхода
                   ,cur                               // Валюта дохода/расхода
                   ,analiticKind1                     // Вид аналитики 1
                   ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                   ,0                                 // Вид аналитики 2
                   ,-1                                // Аналитика 2
                   ,TXOBJ_KIND3010                    // Вид аналитики 3
                   ,analitic3                         // Аналитика 3
                   ,TXOBJ_KIND4010                    // Вид аналитики 4
                   ,analitic4                         // Аналитика 4
                   ,TXOBJ_KIND5010                    // Вид аналитики 5
                   ,analitic5                         // Аналитика 5
                   ,TXOBJ_KIND6020                    // Вид аналитики 6
                   ,pContract                         // Аналитика 6
                   ,comment                           // Комментарий
                   );
     end;

     if( (err == 0) and (pmaccObj.m_crp.rec.HoldTax == "X") )
        direction = TXOBJ_DIR_OUT;
        level = 4;
        vKind = TXOBJ_DIVPAY_SEC;
        comment = "Налог с выплаты суммы дивидендов в Депозитарии";
        analiticKind1 = TXOBJ_KIND1098;
        sum = pmaccObj.m_pmacc.rec.CalcTaxAmount;
        if(pmaccObj.m_crp.rec.Currency != NATCUR)
          ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
        end;

        DivPay_Sec0 = sum;

        if( sum != $0 )
           TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                      ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                      ,direction                         // Направление
                      ,level                             // Уровень
                      ,""                                // Признак "Пользовательский"
                      ,vKind                             // Вид НДР
                      ,sum                               // Сумма дохода/расхода
                      ,NATCUR                            // Валюта дохода/расхода
                      ,analiticKind1                     // Вид аналитики 1
                      ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                      ,0                                 // Вид аналитики 2
                      ,-1                                // Аналитика 2
                      ,TXOBJ_KIND3010                    // Вид аналитики 3
                      ,analitic3                         // Аналитика 3
                      ,TXOBJ_KIND4010                    // Вид аналитики 4
                      ,analitic4                         // Аналитика 4
                      ,TXOBJ_KIND5010                    // Вид аналитики 5
                      ,analitic5                         // Аналитика 5
                      ,TXOBJ_KIND6020                    // Вид аналитики 6
                      ,pContract                         // Аналитика 6
                      ,comment                           // Комментарий
                      );
        end;
     end;

     if(err == 0)

        if(PtIsRes == NPTXPARTY_RESIDENT)
           vKind = TXOBJ_PLUSG_1010;
           comment = "ФЛ = резидент";
        else
           vKind = TXOBJ_PLUS15_1010;
           comment = "ФЛ = нерезидент";
        end;

        PlusSum = Div_Sec0;

        if(PlusSum != 0)
          TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                     ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                     ,TXOBJ_DIR_IN                      // Направление
                     ,5                                 // Уровень
                     ,""                                // Признак "Пользовательский"
                     ,vKind                             // Вид НДР
                     ,PlusSum                           // Сумма дохода/расхода
                     ,NATCUR                            // Валюта дохода/расхода
                     ,analiticKind1                     // Вид аналитики 1
                     ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                     ,0                                 // Вид аналитики 2
                     ,-1                                // Аналитика 2
                     ,0                                 // Вид аналитики 3
                     ,-1                                // Аналитика 3
                     ,0                                 // Вид аналитики 4
                     ,-1                                // Аналитика 4
                     ,0                                 // Вид аналитики 5
                     ,-1                                // Аналитика 5
                     ,TXOBJ_KIND6020                    // Вид аналитики 6
                     ,pContract                         // Аналитика 6
                     ,comment                           // Комментарий
                     );
        end;

     end;

     if(err == 0)

        if( PtIsRes == NPTXPARTY_RESIDENT )
          R = Rg(PtIsRes);
        else
          R = Rs(PtIsRes);
        end;

        var fiwarnts = TBFile("fiwarnts.dbt");
        var ObjectID = "";
        var D1 = 0;
        var D2 = 0;

        fiwarnts.Clear();
        fiwarnts.rec.FIID = DataSet.FIID;
        fiwarnts.rec.Number = pmaccObj.m_crp.rec.WarrantNum;
        if(fiwarnts.GetEQ())
          ObjectID = UniID( fiwarnts, OBJTYPE_DIVIDENDS );
          D1 = money( readNoteForObject( OBJTYPE_DIVIDENDS, ObjectID, 1, pmaccObj.m_ExecDate ) );
          D2 = money( readNoteForObject( OBJTYPE_DIVIDENDS, ObjectID, 2, pmaccObj.m_ExecDate ) );
        end;

        MinusSum = 0;
        if((D1 != 0) and (D2 != 0))
          MinusSum = Div_Sec0 * D2 / D1;
        end;

        vKind = 0;
        if(PtIsRes == NPTXPARTY_RESIDENT)
           vKind = TXOBJ_MINUSG_601;
           comment = "ФЛ = резидент";
        end;

        if( (MinusSum != 0) and (vKind != 0))
          TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                     ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                     ,TXOBJ_DIR_OUT                     // Направление
                     ,5                                 // Уровень
                     ,""                                // Признак "Пользовательский"
                     ,vKind                             // Вид НДР
                     ,MinusSum                          // Сумма дохода/расхода
                     ,NATCUR                            // Валюта дохода/расхода
                     ,analiticKind1                     // Вид аналитики 1
                     ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                     ,0                                 // Вид аналитики 2
                     ,-1                                // Аналитика 2
                     ,0                                 // Вид аналитики 3
                     ,-1                                // Аналитика 3
                     ,0                                 // Вид аналитики 4
                     ,-1                                // Аналитика 4
                     ,0                                 // Вид аналитики 5
                     ,-1                                // Аналитика 5
                     ,TXOBJ_KIND6020                    // Вид аналитики 6
                     ,pContract                         // Аналитика 6
                     ,comment                           // Комментарий
                     );

        end;

     end;

     if(err == 0)

       if(PtIsRes == NPTXPARTY_RESIDENT)
          comment = "ФЛ = резидент";
       else
          comment = "ФЛ = нерезидент";
       end;

       sum = Max(0,PlusSum - MinusSum);

       if(sum != 0)
          TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                     ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                     ,TXOBJ_DIR_IN                      // Направление
                     ,7                                 // Уровень
                     ,""                                // Признак "Пользовательский"
                     ,TXOBJ_BASESPECIAL_DIV             // Вид НДР
                     ,sum                               // Сумма дохода/расхода
                     ,NATCUR                            // Валюта дохода/расхода
                     ,analiticKind1                     // Вид аналитики 1
                     ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                     ,0                                 // Вид аналитики 2
                     ,-1                                // Аналитика 2
                     ,0                                 // Вид аналитики 3
                     ,-1                                // Аналитика 3
                     ,0                                 // Вид аналитики 4
                     ,-1                                // Аналитика 4
                     ,0                                 // Вид аналитики 5
                     ,-1                                // Аналитика 5
                     ,TXOBJ_KIND6020                    // Вид аналитики 6
                     ,pContract                         // Аналитика 6
                     ,comment                           // Комментарий
                     );
       end;

     end;

  elif(pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)  //Если эмитент нерезидент и не указан признак "Торговый", то НДР не формируются

     if( DL_NPTX_IsCorpBondAfter2018(analitic3, pmaccObj.m_crp.rec.WarrantNum) and (pmaccObj.m_crp.rec.ValueDate < Date(1, 1, 2021)) )
        comment = "Купонный доход для выплат от эмитента по корпоративным облигациям";
        analiticKind1 = TXOBJ_KIND1095;
        ProcSec_TS0 = DL_NPTX_GetTaxBaseCorpBondAfter2018(analitic3, pmaccObj.m_crp.rec.WarrantNum, Quantity);/*Сумма рассчитанной НОБ*/

        if( ProcSec_TS0 != $0 )
           TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                      ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                      ,TXOBJ_DIR_IN                      // Направление
                      ,2                                 // Уровень
                      ,""                                // Признак "Пользовательский"
                      ,TXOBJ_PROCSEC_TS_35               // Вид НДР
                      ,ProcSec_TS0                       // Сумма дохода/расхода
                      ,NATCUR                            // Валюта дохода/расхода
                      ,analiticKind1                     // Вид аналитики 1
                      ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                      ,0                                 // Вид аналитики 2
                      ,-1                                // Аналитика 2
                      ,TXOBJ_KIND3010                    // Вид аналитики 3
                      ,analitic3                         // Аналитика 3
                      ,TXOBJ_KIND4010                    // Вид аналитики 4
                      ,analitic4                         // Аналитика 4
                      ,TXOBJ_KIND5010                    // Вид аналитики 5
                      ,analitic5                         // Аналитика 5
                      ,TXOBJ_KIND6020                    // Вид аналитики 6
                      ,pContract                         // Аналитика 6
                      ,comment                           // Комментарий
                      );
        end;

        if( err == 0 )
           if(PtIsRes == NPTXPARTY_RESIDENT)
              comment = "Клиент = резидент";
              if( ProcSec_TS0 != $0 )
                 TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                            ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                            ,TXOBJ_DIR_IN                      // Направление
                            ,7                                 // Уровень
                            ,""                                // Признак "Пользовательский"
                            ,TXOBJ_BASE_35                     // Вид НДР
                            ,ProcSec_TS0                       // Сумма дохода/расхода
                            ,NATCUR                            // Валюта дохода/расхода
                            ,analiticKind1                     // Вид аналитики 1
                            ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                            ,0                                 // Вид аналитики 2
                            ,-1                                // Аналитика 2
                            ,0                                 // Вид аналитики 3
                            ,-1                                // Аналитика 3
                            ,0                                 // Вид аналитики 4
                            ,-1                                // Аналитика 4
                            ,0                                 // Вид аналитики 5
                            ,-1                                // Аналитика 5
                            ,TXOBJ_KIND6020                    // Вид аналитики 6
                            ,pContract                         // Аналитика 6
                            ,comment                           // Комментарий
                            );
              end;
           end;
        end;

        if( err == 0 )

           sum = pmaccObj.m_pmacc.rec.BruttoAmount;
           cur = pmaccObj.m_crp.rec.Currency;

           if(pmaccObj.m_crp.rec.Currency != NATCUR)
              ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
           end;

           sum = sum - ProcSec_TS0;
           comment = "Процентные доходы по льготным бумагам";

           if( sum != $0 )
              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_IN                      // Направление
                         ,4                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,TXOBJ_COUP0_GROUP                 // Вид НДР
                         ,sum                               // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,TXOBJ_KIND3010                    // Вид аналитики 3
                         ,analitic3                         // Аналитика 3
                         ,TXOBJ_KIND4010                    // Вид аналитики 4
                         ,analitic4                         // Аналитика 4
                         ,TXOBJ_KIND5010                    // Вид аналитики 5
                         ,analitic5                         // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;
        end;

        if( (err==0) and (pmaccObj.m_crp.rec.HoldTax == "X") )

           sum = pmaccObj.m_pmacc.rec.CalcTaxAmount;
           if(pmaccObj.m_crp.rec.Currency != NATCUR)
             ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
           end;

           if(PtIsRes == NPTXPARTY_RESIDENT)
              vKind = TXOBJ_PAID_35;
              comment = "Клиент = резидент";
           else
              vKind = TXOBJ_PAIDGENERAL;
              comment = "Клиент = нерезидент";
           end;

           if( sum != $0 )
              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_OUT                     // Направление
                         ,8                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,vKind                             // Вид НДР
                         ,sum                               // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;

        end;

        if( (err==0) and (PtIsRes != NPTXPARTY_RESIDENT) )
           comment = "Клиент = нерезидент";
           if( ProcSec_TS0 != $0 )
              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_IN                      // Направление
                         ,7                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,TXOBJ_BASEGENERAL                 // Вид НДР
                         ,ProcSec_TS0                       // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;
        end;

        if( err==0 )
           comment = "Купонный доход по корпоративным облигациям";
           if( ProcSec_TS0 != $0 )
              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_IN                      // Направление
                         ,5                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,TXOBJ_PLUS35_3023                 // Вид НДР
                         ,ProcSec_TS0                       // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;
        end;

     elif((not DL_NPTX_IsCorpBondAfter2018(analitic3, pmaccObj.m_crp.rec.WarrantNum)) and (pmaccObj.m_crp.rec.ValueDate >= Date(1, 1, 2021)))/*кроме Корп. облиг. с 2018 до 31.12.2020*/
        comment = "Выплата суммы купона в Депозитарии";
        analiticKind1 = TXOBJ_KIND1095;
        sum = pmaccObj.m_pmacc.rec.BruttoAmount;
        cur = pmaccObj.m_crp.rec.Currency;

        if(pmaccObj.m_crp.rec.Currency != NATCUR)
           ConvSum(ProcSec_TS0, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
        else
           ProcSec_TS0 = sum;
        end;

        if( sum != $0 )
           TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                      ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                      ,TXOBJ_DIR_IN                      // Направление
                      ,2                                 // Уровень
                      ,""                                // Признак "Пользовательский"
                      ,TXOBJ_PROCSEC_TS                  // Вид НДР
                      ,sum                               // Сумма дохода/расхода
                      ,cur                               // Валюта дохода/расхода
                      ,analiticKind1                     // Вид аналитики 1
                      ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                      ,0                                 // Вид аналитики 2
                      ,-1                                // Аналитика 2
                      ,TXOBJ_KIND3010                    // Вид аналитики 3
                      ,analitic3                         // Аналитика 3
                      ,TXOBJ_KIND4010                    // Вид аналитики 4
                      ,analitic4                         // Аналитика 4
                      ,TXOBJ_KIND5010                    // Вид аналитики 5
                      ,analitic5                         // Аналитика 5
                      ,TXOBJ_KIND6020                    // Вид аналитики 6
                      ,pContract                         // Аналитика 6
                      ,comment                           // Комментарий
                      );
        end;

        if( (err == 0) and (analitic5==30) )

           if(PtIsRes == NPTXPARTY_RESIDENT)
              if(IsIIS == true)
                vKind = TXOBJ_PLUS9_1110_IIS;
              else
                vKind = TXOBJ_PLUS9_1110;
              end;

              comment = "НГ=30 и клиент = резидент";
           else
              vKind = TXOBJ_PLUSG_1110;
              comment = "НГ=30 и клиент = нерезидент";
           end;

           if( ProcSec_TS0 != $0 )
              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_IN                      // Направление
                         ,5                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,vKind                             // Вид НДР
                         ,ProcSec_TS0                       // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;

           if( (err == 0) and (PtIsRes == NPTXPARTY_RESIDENT) )

              if( ProcSec_TS0 != $0 )
                 if(IsIIS == true)
                   vKind = TXOBJ_BASESPECIAL_IIS;
                 else
                   vKind = TXOBJ_BASESPECIAL;
                 end;

                 TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                            ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                            ,TXOBJ_DIR_IN                      // Направление
                            ,7                                 // Уровень
                            ,""                                // Признак "Пользовательский"
                            ,vKind                             // Вид НДР
                            ,ProcSec_TS0                       // Сумма дохода/расхода
                            ,NATCUR                            // Валюта дохода/расхода
                            ,analiticKind1                     // Вид аналитики 1
                            ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                            ,0                                 // Вид аналитики 2
                            ,-1                                // Аналитика 2
                            ,0                                 // Вид аналитики 3
                            ,-1                                // Аналитика 3
                            ,0                                 // Вид аналитики 4
                            ,-1                                // Аналитика 4
                            ,0                                 // Вид аналитики 5
                            ,-1                                // Аналитика 5
                            ,TXOBJ_KIND6020                    // Вид аналитики 6
                            ,pContract                         // Аналитика 6
                            ,comment                           // Комментарий
                            );
              end;

           end;

        end;

        if( (err == 0) and ((analitic5==20)or(analitic5==50)) )

           if(analitic5==20)
              if(IsIIS == true)
                vKind = TXOBJ_PLUSG_1011_IIS;
              else
                vKind = TXOBJ_PLUSG_1011;
              end;
              comment = "НГ = 20";
           else
              vKind = TXOBJ_COUP0_GROUP;
              comment = "НГ = 50";
           end;

           if( ProcSec_TS0 != $0 )
              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_IN                      // Направление
                         ,5                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,vKind                             // Вид НДР
                         ,ProcSec_TS0                       // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;

        end;

        if( (err == 0) and (not ((PtIsRes == NPTXPARTY_RESIDENT) and (analitic5 == 30))) )

           comment = "Кроме случаев, когда НГ=30 и клиент = резидент";

           if( ProcSec_TS0 != $0 )
              if(IsIIS == true)
                vKind = TXOBJ_BASEGENERAL_IIS;
              else
                vKind = TXOBJ_BASEGENERAL;
              end;

              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_IN                      // Направление
                         ,7                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,vKind                             // Вид НДР
                         ,ProcSec_TS0                       // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;

           if( (err==0) and (pmaccObj.m_crp.rec.HoldTax == "X") )

              sum = pmaccObj.m_pmacc.rec.CalcTaxAmount;
              if(pmaccObj.m_crp.rec.Currency != NATCUR)
                ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
              end;

              if( sum != $0 )
                 if(IsIIS == true)
                   vKind = TXOBJ_PAIDGENERAL_IIS;
                 else
                   vKind = TXOBJ_PAIDGENERAL;
                 end;

                 TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                            ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                            ,TXOBJ_DIR_OUT                     // Направление
                            ,8                                 // Уровень
                            ,""                                // Признак "Пользовательский"
                            ,vKind                             // Вид НДР
                            ,sum                               // Сумма дохода/расхода
                            ,NATCUR                            // Валюта дохода/расхода
                            ,analiticKind1                     // Вид аналитики 1
                            ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                            ,0                                 // Вид аналитики 2
                            ,-1                                // Аналитика 2
                            ,0                                 // Вид аналитики 3
                            ,-1                                // Аналитика 3
                            ,0                                 // Вид аналитики 4
                            ,-1                                // Аналитика 4
                            ,0                                 // Вид аналитики 5
                            ,-1                                // Аналитика 5
                            ,TXOBJ_KIND6020                    // Вид аналитики 6
                            ,pContract                         // Аналитика 6
                            ,comment                           // Комментарий
                            );
              end;

           end;

        end;

        if( (err == 0) and (pmaccObj.m_crp.rec.HoldTax == "X") and ((PtIsRes == NPTXPARTY_RESIDENT) and (analitic5 == 30)) )

           analiticKind1 = TXOBJ_KIND1095;
           sum = pmaccObj.m_pmacc.rec.CalcTaxAmount;
           if(pmaccObj.m_crp.rec.Currency != NATCUR)
             ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
           end;

           if( sum != $0 )
              if(IsIIS == true)
                vKind = TXOBJ_PAIDSPECIAL_IIS;
              else
                vKind = TXOBJ_PAIDSPECIAL;
              end;

              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Клиент
                         ,TXOBJ_DIR_OUT                     // Направление
                         ,8                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,vKind                             // Вид НДР
                         ,sum                               // Сумма дохода/расхода
                         ,NATCUR                            // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,0                                 // Вид аналитики 3
                         ,-1                                // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,0                                 // Вид аналитики 5
                         ,-1                                // Аналитика 5
                         ,TXOBJ_KIND6020                    // Вид аналитики 6
                         ,pContract                         // Аналитика 6
                         ,comment                           // Комментарий
                         );
           end;

        end;

     end;

  end;

  return err;
end;

private macro InsertNUTaxObjects(pmaccObj, TaxObj:@variant)
  var query, cmd, DataSet;
  var pContract = pmaccObj.GetDepoContrID();
  var err = 0;
  var analiticKind1 = 0;
  var sum = $0, cur = -1, Comment = "";

  TaxObj = TInsertDepoTaxObjectNUTX(pmaccObj.m_crp, pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);

  query =   " SELECT dppmfi.t_FIID, dppmacfi.t_Quantity, fin.t_AvoirKind, "
          + "        RSI_NUTX.GetNUTaxGroup(dppmfi.t_FIID, ?) TaxGroupNUTX "
          + "   FROM ddpregstr_dbt regstr, ddppmfi_dbt dppmfi, ddppmacfi_dbt dppmacfi, dfininstr_dbt fin "
          + "  WHERE regstr.t_DocumentID = ? "
          + "    AND dppmfi.t_RegisterID = regstr.t_RegisterID "
          + "    AND dppmacfi.t_DocumentID = regstr.t_DocumentID "
          + "    AND dppmacfi.t_HolderAccID = ? "
          + "    AND dppmacfi.t_FIID = dppmfi.t_FIID "
          + "    AND fin.t_FIID = dppmacfi.t_FIID";

  cmd = DL_RsdCommand( query );
  cmd.AddParam(pmaccObj.m_crp.rec.ValueDate);
  cmd.AddParam(pmaccObj.m_crp.rec.DocumentID);
  cmd.AddParam(pmaccObj.m_pmacc.rec.HolderAccID);
  dataSet = cmd.Execute();

  if( dataSet.MoveNext() )

    if(pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS)
      analiticKind1 = TXOBJ_KIND1098;

      sum = pmaccObj.m_pmacc.rec.BruttoAmount;
      cur = pmaccObj.m_crp.rec.Currency;

      if(pmaccObj.m_crp.rec.Currency != NATCUR)
        ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
      end;

      TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                 ,pmaccObj.m_pmacc.rec.HolderID     // Клиент
                 ,pmaccObj.m_pmacc.rec.BeneficiarID // Фактический получатель дохода
                 ,NUTXOBJ_DIR_IN                    // Направление
                 ,4                                 // Уровень
                 ,""                                // Признак "Пользовательский"
                 ,NUTXOBJ_PLUS_01                   // Вид НДР
                 ,sum                               // Сумма дохода/расхода
                 ,cur                               // Валюта дохода/расхода
                 ,analiticKind1                     // Вид аналитики 1
                 ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                 ,0                                 // Вид аналитики 2
                 ,-1                                // Аналитика 2
                 ,TXOBJ_KIND3010                    // Вид аналитики 3
                 ,DataSet.FIID                      // Аналитика 3
                 ,0                                 // Вид аналитики 4
                 ,-1                                // Аналитика 4
                 ,TXOBJ_KIND5010                    // Вид аналитики 5
                 ,DataSet.TaxGroupNUTX              // Аналитика 5
                 ,TXOBJ_KIND6020                    // Вид аналитики 6
                 ,pContract                         // Аналитика 6
                 ,"Дивиденды в Депозитарии" )       // Комментарий

    elif(pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
      var NuTxKind = 0;

      if(  FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BOND_STATE, DataSet.AvoirKind ) //Государственная
        or FI_AvrKindsEQ( FIKIND_AVOIRISS, AVOIRISSKIND_BOND_MUNICIPAL, DataSet.AvoirKind ) //Муниципальная
        )
        NuTxKind = NUTXOBJ_PLUS_10;
        Comment  = "Купон по государственным/муниципальным облигациям в Депозитарии";
      else
        NuTxKind = NUTXOBJ_PLUS_11;
        Comment  = "Купону по прочим облигациям в Депозитарии";
      end;

      analiticKind1 = TXOBJ_KIND1095;

      sum = pmaccObj.m_pmacc.rec.BruttoAmount;
      cur = pmaccObj.m_crp.rec.Currency;

      if(pmaccObj.m_crp.rec.Currency != NATCUR)
        ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
      end;

      TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                 ,pmaccObj.m_pmacc.rec.HolderID     // Клиент
                 ,pmaccObj.m_pmacc.rec.BeneficiarID // Фактический получатель дохода
                 ,NUTXOBJ_DIR_IN                    // Направление
                 ,4                                 // Уровень
                 ,""                                // Признак "Пользовательский"
                 ,NuTxKind                          // Вид НДР
                 ,sum                               // Сумма дохода/расхода
                 ,cur                               // Валюта дохода/расхода
                 ,analiticKind1                     // Вид аналитики 1
                 ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                 ,0                                 // Вид аналитики 2
                 ,-1                                // Аналитика 2
                 ,TXOBJ_KIND3010                    // Вид аналитики 3
                 ,DataSet.FIID                      // Аналитика 3
                 ,0                                 // Вид аналитики 4
                 ,-1                                // Аналитика 4
                 ,TXOBJ_KIND5010                    // Вид аналитики 5
                 ,DataSet.TaxGroupNUTX              // Аналитика 5
                 ,TXOBJ_KIND6020                    // Вид аналитики 6
                 ,pContract                         // Аналитика 6
                 ,Comment )                         // Комментарий
    end;

    if((not err) and (IsInstNeresForNUTX(pmaccObj.m_pmacc.rec.BeneficiarID, pmaccObj.m_crp.rec.ValueDate) == true)) //Фактический получатель - юрлицо-нерезидент

      sum = pmaccObj.m_pmacc.rec.CalcTaxAmount;
      if(pmaccObj.m_crp.rec.Currency != NATCUR)
        ConvSum(sum, sum, pmaccObj.m_crp.rec.ValueDate, pmaccObj.m_crp.rec.Currency, NATCUR);
      end;

      if(sum > 0)
        TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                   ,pmaccObj.m_pmacc.rec.HolderID     // Клиент
                   ,pmaccObj.m_pmacc.rec.BeneficiarID // Фактический получатель дохода
                   ,NUTXOBJ_DIR_OUT                   // Направление
                   ,5                                 // Уровень
                   ,""                                // Признак "Пользовательский"
                   ,NUTXOBJ_DUETAX                    // Вид НДР
                   ,sum                               // Сумма дохода/расхода
                   ,cur                               // Валюта дохода/расхода
                   ,analiticKind1                     // Вид аналитики 1
                   ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                   ,0                                 // Вид аналитики 2
                   ,-1                                // Аналитика 2
                   ,TXOBJ_KIND3010                    // Вид аналитики 3
                   ,DataSet.FIID                      // Аналитика 3
                   ,0                                 // Вид аналитики 4
                   ,-1                                // Аналитика 4
                   ,TXOBJ_KIND5010                    // Вид аналитики 5
                   ,DataSet.TaxGroupNUTX              // Аналитика 5
                   ,TXOBJ_KIND6020                    // Вид аналитики 6
                   ,pContract                         // Аналитика 6
                   ,"Налог, подлежащей уплате в Депозитарии" ) // Комментарий
      end;
    end;
  end;

  return err;
end;

private macro СоздатьОбъектыНДР(pmaccObj)
  var NeedTaxObj = true;
  var err = 0;
  var TaxObj = NULL;

  if(pmaccObj.IsPaymReturnIncome() == true)
    NeedTaxObj = false;
  end;

  if((not err) and (NeedTaxObj == true))
    if( ( ( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS )
       or ( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON ) ) )
        if(pmaccObj.HolderIsPersn() == true)
          if(pmaccObj.NeedCreateTaxObjTipi() == true)
            if( InsertTaxObject(pmaccObj, @TaxObj) != 0 )
              MsgBox( "Ошибка формирования объектов НДР" );
              err = 1;
            end;
          end;
        elif((DL_UseNUTX() == true) and
             (IsNeresidentForNUTX(pmaccObj.m_pmacc.rec.HolderID, pmaccObj.m_crp.rec.ValueDate) == true) and
             (pmaccObj.IssuerIsResident() == true) and (IsControlOrg(pmaccObj.m_pmacc.rec.HolderID))
            )
          if( InsertNUTaxObjects(pmaccObj, @TaxObj) != 0 )
            MsgBox( "Ошибка формирования объектов НДР" );
            err = 1;
          end;
        end;
    end;

    if(not err)
      RslDefCon.BeginTrans();

      if(TaxObj != NULL)
        err = TaxObj.Save();
      end;

      if(not err)
        pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_TAXOBJ;

        err = pmaccObj.UpdatePMACC();
      end;

      if(err)
        RslDefCon.RollbackTrans();
      else
        RslDefCon.CommitTrans();
      end;
    end;
  end;

  // Отсутствует лицензия на использование операции| "%s".
  if( err == 31899 )
    err = 0;
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

private macro GetSfContrIDByDepoContr(DepoContrID:integer, servKind:Integer, subKind:integer, receiverID:Integer, payerID:Integer, contrDate:Date):Integer
  var sfContrID:Integer = 0;
  var query:String = "";
  var rsdCmd = null;
  var dataSet = null;

  if(DepoContrID > 0)
    rsdCmd = DL_RsdCommand();

    query =   " select sfcontr.t_ID "
            + "   from dsfcontr_dbt dpsfcontr, ddlcontr_dbt dlcontr, ddlcontrmp_dbt mp, dsfcontr_dbt sfcontr "
            + "  where dpsfcontr.t_ID = ? "
            + "    and dpsfcontr.t_UnionContrID > 0 "
            + "    and dlcontr.t_UniDepoContrID = dpsfcontr.t_UnionContrID "
            + "    and mp.t_DlContrID = dlcontr.t_DlContrID "
            + "    and sfcontr.t_ID = mp.t_SfContrID "
            + "    and sfcontr.t_ServKind = ? "
            + "    and sfcontr.t_PartyID = ? "
            + "    and sfcontr.t_ContractorID = ? "
            + "    and sfcontr.t_DateBegin <= ? "
            + "    and ( sfcontr.t_DateClose > ? "
            + "       or sfcontr.t_DateCLose = "+GetSQLDate(date(0,0,0))+" ) ";

    rsdCmd.AddParam( DepoContrID );
    rsdCmd.AddParam( servKind );
    rsdCmd.AddParam( payerID );
    rsdCmd.AddParam( receiverID );
    rsdCmd.AddParam( contrDate );
    rsdCmd.AddParam( contrDate );

    if(subKind > 0)
      query = query + " and sfcontr.t_ServKindSub = ? ";
      rsdCmd.AddParam(subKind);
    end;

    dataSet = rsdCmd.Execute(query);

    if( dataSet.MoveNext() )
      sfContrID = dataSet.ID;
    end;

  end;

  return sfContrID;
end;

private macro GetSfContrID(DepoContrID:integer, servKind:Integer, receiverID:Integer, payerID:Integer, contrDate:Date):Integer
  var sfContrID:Integer = 0;
  var query:String = "";
  var rsdCmd = null;
  var dataSet = null;

  sfContrID = GetSfContrIDByDepoContr(DepoContrID, servKind, 8/*Биржевой рынок*/, receiverID, payerID, contrDate);
  if(sfContrID == 0)
    sfContrID = GetSfContrIDByDepoContr(DepoContrID, servKind, 0/*Любой подвид*/, receiverID, payerID, contrDate);
  end;

  if(sfContrID == 0)
    query =
      " SELECT sfcontr.t_ID "
    + "   FROM dsfcontr_dbt sfcontr "
    + "  WHERE sfcontr.t_ServKind = ? "
    + "    AND sfcontr.t_PartyID = ? "
    + "    AND sfcontr.t_ContractorID = ? "
    + "    AND sfcontr.t_DateBegin <= ? "
    + "    AND ( sfcontr.t_DateClose > ? "
    + "       OR sfcontr.t_DateCLose = "+GetSQLDate(date(0,0,0))+" ) "
    + " ORDER BY t_DateBegin ASC ";

    rsdCmd = DL_RsdCommand( query );
    rsdCmd.AddParam( servKind );
    rsdCmd.AddParam( payerID );
    rsdCmd.AddParam( receiverID );
    rsdCmd.AddParam( contrDate );
    rsdCmd.AddParam( contrDate );

    dataSet = rsdCmd.Execute();

    if( dataSet.MoveNext() )
      sfContrID = dataSet.ID;
    end;
  end;

  return sfContrID;
end;

private macro InsertRetire(pmaccObj, DealID:@integer)
  var err:Integer = 0;
  var query:String = "";
  var rsdCmd = null;
  var dataSet = null;
  var tick = TRecHandler( "dl_tick" );
  var leg = TRecHandler( "dl_leg" );

  DealID = 0;

  tick.Clear();

  tick.rec.PartyID = -1;
  tick.rec.TraderID = -1;
  tick.rec.DepositID = -1;
  tick.rec.MarketID = -1;
  tick.rec.BrokerID = -1;
  tick.rec.ClientID = -1;

  leg.Clear();

  rsdCmd = DL_RsdCommand( query );

  query = " SELECT regstr.t_Date, regstr.t_StoragePlace, spgr.t_Xld, dppmfi.t_FIID, fin.t_FaceValueFI ";

  if( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON )
    query = query + " ,RSI_RSB_FIInstr.FI_GetCouponDrawingDate( dppmfi.t_FIID, ? ) AS t_DrawingDate ";
    rsdCmd.AddParam( pmaccObj.m_crp.rec.WarrantNum );
  elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL )
    query = query + " ,RSI_RSB_FIInstr.FI_GetPartialDrawingDate( dppmfi.t_FIID, ? ) AS t_DrawingDate ";
    rsdCmd.AddParam( pmaccObj.m_crp.rec.WarrantNum );
  elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE )
    query = query + " ,RSI_RSB_FIInstr.FI_GetNominalDrawingDate( dppmfi.t_FIID, (select t_Termless from davoiriss_dbt where t_FIID = dppmfi.t_FIID) ) AS t_DrawingDate ";
  end;

  query = query + ", (SELECT SUM( NVL( reglinag.t_HRest, " + String( $0 ) + " ) ) "
                + "     FROM ddpreglin_dbt reglinag "
                + "     START WITH reglinag.t_ReglineID = reglin.t_ReglineID "
                + "     CONNECT BY PRIOR reglinag.t_ReglineID = reglinag.t_Parent ) AS t_HRest "
                + "  FROM dspground_dbt spgr, ddpregstr_dbt regstr, ddppmfi_dbt dppmfi, ddpreglin_dbt reglin, dfininstr_dbt fin "
                + " WHERE spgr.t_SPgroundID = ? "
                + "   AND spgr.t_Direction = " + String( ENTERING ) + " "
                + "   AND spgr.t_Division = " + String( DP_SelfDivision ) + " "
                + "   AND regstr.t_DocumentID = ? "
                + "   AND dppmfi.t_RegisterID = regstr.t_RegisterID "
                + "   AND reglin.t_RegisterID = regstr.t_RegisterID "
                + "   AND reglin.t_Type = " + String( DP_REGLINETYPE_DEPOACC ) + " "
                + "   AND reglin.t_HolderAccID = ? "
                + "   AND fin.t_FIID = dppmfi.t_FIID";

  rsdCmd.AddParam( pmaccObj.m_crp.rec.SPgroundID );
  rsdCmd.AddParam( pmaccObj.m_crp.rec.DocumentID );
  rsdCmd.AddParam( pmaccObj.m_pmacc.rec.HolderAccID );

  dataSet = rsdCmd.Execute(query);

  if( dataSet.MoveNext() )
    // <A0> Вид погашения
    if( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON )
      tick.rec.DealType = CB_GetFirstValidOpenOpKind( DL_RETIREMENT, OPPF_FITALL, TYPEKOPER_COUPON );
    elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL )
      tick.rec.DealType = CB_GetFirstValidOpenOpKind( DL_RETIREMENT, OPPF_FITALL, TYPEKOPER_PARTLY );
    elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE )
      tick.rec.DealType = CB_GetFirstValidOpenOpKind( DL_RETIREMENT, OPPF_FITALL, TYPEKOPER_ISSUE );
    end;
    tick.rec.DealCode       = GetDealCodeNew();         // <A1>     Код операции
    tick.rec.DealCodeTS     = dataSet.Xld;              // <A2>     Код операции внешний
    tick.rec.DealDate       = dataSet.DrawingDate;      // <A3>     Дата
    tick.rec.BOfficeKind    = DL_RETIREMENT;            // <A4>     ДУ
    tick.rec.Flag1          = "";                       // <A5>     Биржа
    tick.rec.Flag4          = "";                       // <A6>     Брокер
    leg.rec.Start           = dataSet.Date;             // <A7>     Дата составления перечня
    leg.rec.Maturity        = pmaccObj.m_crp.rec.ValueDate;        // <A8>     Дата получения средств
    leg.rec.Expiry          = pmaccObj.m_crp.rec.ValueDate;        // <A8>     Дата получения средств
    tick.rec.CarryWrt       = "";                       // <A42>    Проводка зачисления средств
    tick.rec.OFBU           = "";                       // <A9>     ОФБУ
    tick.rec.ClientID       = pmaccObj.m_pmacc.rec.HolderID;       // <A10.0>  Клиент
    // <A10.2> № договора
    tick.rec.ClientContrID  = GetSfContrID( pmaccObj.GetDepoContrID(), PTSK_STOCKDL, {OurBank}, pmaccObj.m_pmacc.rec.HolderID, tick.rec.DealDate );
    tick.rec.BrokerID       = dataSet.StoragePlace;     // <A11>    Платежный агент
    tick.rec.PartyID        = dataSet.StoragePlace;     // <A11>    Платежный агент
    leg.rec.DepositID       = dataSet.StoragePlace;     // <A16>    Депозитарий
    leg.rec.PFI             = dataSet.FIID;             // <A18.1>  Ценная бумага
                                                        // <A19.1>  Эмитент
                                                        // <A20.1>  Номинал
    leg.rec.CFI = leg.rec.PayFIID = dataSet.FaceValueFI;      // <A23>    Валюта платежа
    if( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON )
      tick.rec.Number_Coupon  = pmaccObj.m_crp.rec.WarrantNum;  // <A24>    Купон №
    elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL )
      tick.rec.Number_Partly  = pmaccObj.m_crp.rec.WarrantNum;  // <A25>    Частичное погашение №
    elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE )
      SP_GetLastCouponORPartialNumber( dataSet.FIID, tick.rec.Number_Partly, false ); // <A25>    Частичное погашение №
    end;

    leg.rec.Principal       = dataSet.HRest;            // <A30>    Количество ц/б
    if( ( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL )
     or ( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE ) )
      leg.rec.Cost          = pmaccObj.m_pmacc.rec.Amount;        // <A31.1>  Погашение номинала на сумму
    elif( pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON )
      leg.rec.NKD           = pmaccObj.m_pmacc.rec.Amount;        // <A32.1>  Процентный/купонный доход
    end;
    leg.rec.TotalCost       = pmaccObj.m_pmacc.rec.Amount;        // <A33.1>  Сумма погашения
    tick.rec.CouponNDFL     = UNSET_CHAR;              // <A34.1>  Купон в НДФЛ

    tick.rec.Department     = {OperDprt};              // <A40>    Филиал
    tick.rec.Oper           = {Oper};                  // <A41.1>  Исполнитель
  end;

  SP_BeginCreateDeal(DL_RETIREMENT);

  if( ( tick.rec.ClientContrID > 0 )
  and ( SP_CreateDeal( tick, leg, null, $0, $0, $0, $0, false, 0, false ) != 0) )
    msgbox(GetErrMsg());
    err = 1;
  end;

  SP_EndCreateDeal();

  if(not err)
    DealID = tick.rec.DealID;
  end;

  return err;
end;

private macro СоздатьОперациюПогашения(pmaccObj)
  var DealID = 0;
  var DpPmObj = TInsertDpPmObj(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);
  var NeedCreate = pmaccObj.NeedCreateRetire();
  var err = 0;

  if(NeedCreate == true)
    //Транзакция сохранения
    RslDefCon.BeginTrans();

    if( InsertRetire(pmaccObj, @DealID) != 0 )
      MsgBox( "Ошибка при вставке погашения: " + GetErrMsg() );
      err = 1;
    end;
    if((not err) and (DealID > 0))
      DpPmObj.Add(OBJTYPE_RETIRE, DealID);
    end;

    if(not err)
      err = DpPmObj.Save();
      if(err)
        msgbox("Ошибка при сохранении объектов операции");
      end;
    end;

    if(not err)
      pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_RETIRE;

      err = pmaccObj.UpdatePMACC();
    end;

    if(err)
      RslDefCon.RollbackTrans();
    else
      RslDefCon.CommitTrans();
    end;

    //После транзакции запускаем операцию погашения на выполнение. Результат не важен.
    if((not err) and (DealID > 0) and (CheckRetireAutoStart() == true))
      SP_ExecDeal( DealID, false );
    end;

  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

private macro СоздатьОперациюРасчетаНОБ(pmaccObj)
  var prm = TRecHandler("nptxcalctaxprm.rec");
  var NeedCreate = pmaccObj.NeedCreateOpCalcTax();
  var err = 0;
  var ErrStr = "";
  var IsIIS = pmaccObj.IsContrIIS();
  var DpPmObj = TInsertDpPmObj(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);

  if(NeedCreate == true)
    RslDefCon.BeginTrans();

    prm.Clear();

    prm.rec.SubKind_Operation = DL_TXBASECALC_OPTYPE_NORMAL;  // Подвид операции
    prm.rec.OperDate          = pmaccObj.m_ExecDate;                     // Дата операции
    prm.rec.Client            = pmaccObj.m_pmacc.rec.HolderID;           // Клиент
    prm.rec.IIS               = IIF(IsIIS == true, SET_CHAR, UNSET_CHAR);  // Признак Индвидуального инвестиционного счета (ИИС)
    prm.rec.BigProtocol       = SET_CHAR;                     // Признак расширенного протокола
    prm.rec.Oper              = pmaccObj.m_crp.rec.Oper;                 // Операционист
    prm.rec.Department        = pmaccObj.m_crp.rec.Department;           // Филиал

    err = DL_CreateOpNptxCalcTax(prm, ErrStr);
    if(err)
      msgbox("Ошибка при создании операции расчета НОБ. " + ErrStr);
    end;

    if((not err) and (prm.rec.ID > 0))
      DpPmObj.Add(DL_CALCNDFL, prm.rec.ID);
    end;

    if(not err)
      err = DpPmObj.Save();
      if(err)
        msgbox("Ошибка при сохранении объектов операции");
      end;
    end;

    if(not err)
      pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_TAXCALC;

      err = pmaccObj.UpdatePMACC();
    end;

    if(err)
      RslDefCon.RollbackTrans();
    else
      RslDefCon.CommitTrans();
    end;

    if((not err) and (prm.rec.ID > 0))
      var OldDialogFlag = SetDialogFlag(0);

      DL_ExecuteNptxOp(prm.rec.ID, true, ErrStr);

      SetDialogFlag(OldDialogFlag);
    end;
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

private macro СоздатьОперациюУдержанияНДФЛ(pmaccObj)
  var prm = TRecHandler("nptxholdtaxprm.rec");
  var query, cmd, DataSet;
  var ErrStr = "";
  var IsIIS = pmaccObj.IsContrIIS();
  var DpPmObj = TInsertDpPmObj(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);
  var NeedCreate = pmaccObj.NeedCreateOpHoldTax();
  var err = 0;
  var Sum1 = 0.0, Sum2 = 0.0, Sum3 = 0.0, Sum4 = 0.0, Sum5 = 0.0;
  var EndDate = pmaccObj.m_ExecDate;
  var Year;
  DateSplit(EndDate, NULL, NULL, Year);
  var BegDate = date(1, 1, Year);

  if(NeedCreate == true)

    //проверить, исполнена ли операция расчета НОБ, если она есть
    query =   " select op.t_Code "
            + "   from ddppmobj_dbt pmobj, dnptxop_dbt op "
            + "  where pmobj.t_PmAccID = ? "
            + "    and pmobj.t_ObjKind = " + DL_CALCNDFL
            + "    and op.t_ID = pmobj.t_ObjID "
            + "    and op.t_Status <> " + DL_TXOP_Close;

    cmd = DL_RSDCommand(query);

    cmd.AddParam(pmaccObj.m_pmacc.rec.ID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      msgbox("Не выполнена операция расчета НОБ с кодом " + DataSet.Code);
      err = 1;
    end;

    if(not err)
      RslDefCon.BeginTrans();

      prm.Clear();

      prm.rec.SubKind_Operation = DL_TXHOLD_OPTYPE_OUTMONEY;                // Тип удержания
      prm.rec.OperDate          = pmaccObj.m_ExecDate;                      // Дата операции
      prm.rec.Client            = pmaccObj.m_pmacc.rec.HolderID;            // Клиент
      prm.rec.IIS               = IIF(IsIIS == true, SET_CHAR, UNSET_CHAR); // Признак Индвидуального инвестиционного счета (ИИС)

      //если по купону операция удержания формируется без операции расчета НОБ, то признак ИИС всегда в ней сброшен
      if((pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON) and (pmaccObj.NeedCreateOpCalcTax() == false))
        prm.rec.IIS             = UNSET_CHAR;
      end;

      prm.rec.Oper              = pmaccObj.m_crp.rec.Oper;                  // Операционист
      prm.rec.Department        = pmaccObj.m_crp.rec.Department;            // Филиал
      prm.rec.Method            = DL_TYPEGETNALOG_BROKER_ACC;               // Способ удержания
      prm.rec.Tax               = $0;                                       // Сумма налога (если 0, то рассчитывается в операции удержания)

      if(pmaccObj.IssuerIsResident() == true) //Эмитент-резидент
        prm.rec.TOut            = pmaccObj.m_pmacc.rec.Amount;              // Сумма вывода ДС
        prm.rec.AccountID       = pmaccObj.GetPmAccAccountID();             // Счет удержания НДФЛ
      else //Эмитент-нерезидент
        ConvSum(prm.rec.TOut, pmaccObj.m_pmacc.rec.Amount, pmaccObj.m_ExecDate, pmaccObj.m_crp.rec.Currency, NATCUR);

        prm.rec.AccountID       = pmaccObj.GetClientAccountID();

        if(pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)
          Sum1 = prm.rec.TOut;

          var SumQuery = "select " +
                         "   (" +
                         "      select nvl(sum(nptxobjSum2.t_Sum0), 0) as t_Sum2" +
                         "      from dnptxobj_dbt nptxobjSum2" +
                         "      where nptxobjSum2.t_Kind in (" + string(TXOBJ_PROCSEC_TS) + ", " + string(TXOBJ_PROCSEC_TS_35) + ")" +
                         "        and nptxobjSum2.t_Client = party.t_PartyID" +
                         "        and nptxobjSum2.t_Date between ? and ?" +
                         "        and nptxobjSum2.t_AnaliticKind1 = " + string(TXOBJ_KIND1095) + //созданные в операциях выплаты купона в Депозитарии,
                         "        and nptxobjSum2.t_Analitic1 <> ?" + //но не в текущей операции
                         "   ) as t_Sum2," +
                         "   (" +
                         "      select nvl(sum(nptxobjSum3.t_Sum0), 0) as t_Sum3" +
                         "      from dnptxobj_dbt nptxobjSum3" +
                         "      where nptxobjSum3.t_Kind in (" + string(TXOBJ_PAIDGENERAL) +
                                                          ", " + string(TXOBJ_PAIDSPECIAL) +
                                                          ", " + string(TXOBJ_PAIDGENERAL_IIS) +
                                                          ", " + string(TXOBJ_PAIDSPECIAL_IIS) +
                         "                                  )" +
                         "        and nptxobjSum3.t_Client = party.t_PartyID" +
                         "        and nptxobjSum3.t_Date between ? and ?" +
                         "        and nptxobjSum3.t_AnaliticKind1 = " + string(TXOBJ_KIND1095) + //созданные в операциях выплаты купона в Депозитарии
                         "        and nptxobjSum3.t_Analitic1 <> ?" +
                         "   ) as t_Sum3 " +
                         "from dparty_dbt party " +
                         "where party.t_PartyID = ?";

          var SumSelect = DL_RSDCommand(SumQuery);
          SumSelect.AddParam(BegDate);
          SumSelect.AddParam(EndDate);
          SumSelect.AddParam(pmaccObj.m_crp.rec.DocumentID);
          SumSelect.AddParam(BegDate);
          SumSelect.AddParam(EndDate);
          SumSelect.AddParam(pmaccObj.m_crp.rec.DocumentID);
          SumSelect.AddParam(pmaccObj.m_pmacc.rec.HolderID);

          var SumDS = SumSelect.Execute();
          if(SumDS.MoveNext())
             Sum2 = SumDS.Sum2;
             Sum3 = SumDS.Sum3;
          end;

          Sum4 = Sum1 + Sum2;
          Sum5 = Sum4 * 0.13;
          prm.rec.Tax = Sum5 - Sum3;
        elif(  (((pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_NOMINAL) OR (pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_ISSUE)) and
             (pmaccObj.IsTradeDepoAcnt() == true)       and //Если указан признак торгового счета депо
             (pmaccObj.ВыплатаНаТекущийСчет() == true)  and //И вид счета выплаты текущий
             (pmaccObj.IsContrIIS() == true)
            )
          )
          prm.rec.Tax = prm.rec.TOut * 0.13;
        end;
      end;

      err = DL_CreateOpNptxHoldTax(prm, ErrStr);
      if(err)
        msgbox("Ошибка при создании операции удрежания НДФЛ. " + ErrStr);
      end;

      if((not err) and (prm.rec.ID > 0))
        DpPmObj.Add(DL_HOLDNDFL, prm.rec.ID);
      end;

      if(not err)
        err = DpPmObj.Save();
        if(err)
          msgbox("Ошибка при сохранении объектов операции");
        end;
      end;

      if(not err)
        pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_TAXHOLD;

        err = pmaccObj.UpdatePMACC();
      end;

      if(err)
        RslDefCon.RollbackTrans();
      else
        RslDefCon.CommitTrans();
      end;

      if((not err) and (prm.rec.ID > 0))
        var OldDialogFlag = SetDialogFlag(0);

        DL_ExecuteNptxOp(prm.rec.ID, true, ErrStr);

        SetDialogFlag(OldDialogFlag);
      end;
    end;

  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

private macro ЗанестиВВыплатуНалогНДФЛ(pmaccObj)
  var query, cmd, DataSet;
  var err = 0;
  var HoldTax = 0;
  var HoldTaxCurr = -1;
  var PaymentObj = NULL;

  if(pmaccObj.IssuerIsResident() == true)

    //проверить, исполнена ли операция удержания НДФЛ, если она есть
    query =   " select op.t_Code, op.t_Tax, op.t_Status, op.t_CurrencySum "
            + "   from ddppmobj_dbt pmobj, dnptxop_dbt op "
            + "  where pmobj.t_PmAccID = ? "
            + "    and pmobj.t_ObjKind = " + DL_HOLDNDFL
            + "    and op.t_ID = pmobj.t_ObjID ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(pmaccObj.m_pmacc.rec.ID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      if(DataSet.Status != DL_TXOP_Close)
        msgbox("Не выполнена операция удержания НДФЛ с кодом " + DataSet.Code);
        err = 1;
      else
        HoldTax     = DataSet.Tax;
        HoldTaxCurr = DataSet.CurrencySum;
      end;
    end;

    if((not err) and (HoldTax > 0) and (HoldTaxCurr != -1))
      RslDefCon.BeginTrans();

      if(pmaccObj.m_crp.rec.Currency != HoldTaxCurr)
        err = ConvSum(HoldTax, HoldTax, pmaccObj.m_ExecDate, HoldTaxCurr, pmaccObj.m_crp.rec.Currency);
      end;

      pmaccObj.m_pmacc.rec.Amount        = pmaccObj.m_pmacc.rec.Amount - HoldTax;
      pmaccObj.m_pmacc.rec.CalcTaxAmount = HoldTax;

      pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_TAXSET;

      if(not err)
        err = pmaccObj.UpdatePMACC();
      end;

      if((not err) and (pmaccObj.UsePaymInPMACC() == true)) /* Если выплата через банк */

        var PaymentID = pmaccObj.GetPaymentID();
        if( PaymentID > 0 )
          PaymentObj = RSBPayment( PaymentID );
        else
          msgbox("Не найден платеж");
          err = 1;
        end;

        if(not err)
          PaymentObj.OrderAmount = pmaccObj.m_pmacc.rec.Amount;
          PaymentObj.BaseAmount  = pmaccObj.m_pmacc.rec.Amount;

          if(not DP_GetPmRAccDescription(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID, pmaccObj.m_pmacc.rec.State, pmaccObj.m_ExecDate, PaymentObj.Ground))
            msgbox("Ошибка заполнения поля \"Основание\"");
            err = 1;
          end;

          if(not err)
            err = PaymentObj.Update();
            if(err)
              msgbox("Ошибка при обновлении платежа");
            end;
          end;
        end;
      end;

      if(err)
        RslDefCon.RollbackTrans();
      else
        RslDefCon.CommitTrans();
      end;
    end;
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

class (RsbBatchPaymTrn) DP_RsbBatchPaymTrn
  InitRsbBatchPaymTrn();

  macro AppRunFunction()
    return 0;
  end;

  macro CommitFunction(iPackStartRec : integer, iCarry : integer, ID_Operation : integer, ID_Step : integer)
    return 0;
  end;

  macro RollbackFunction(iPackStartRec : integer, iCarry : integer, ID_Operation : integer, ID_Step : integer)
    return 0;
  end;
end;

private macro GetAccTrnIDByPaym(PaymentID:integer)
  var query, cmd, DataSet;
  var AccTrnID = 0;

  if(PaymentID > 0)
    query = "select t_AccTrnID from dpmdocs_dbt where t_PaymentID = ?";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(PaymentID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      AccTrnID = DataSet.AccTrnID;
    end;
  end;

  return AccTrnID;
end;

private macro ИсполнитьВыплату(pmaccObj)
  var tr = null, PaymentObj = null;
  var trTax = null;
  var party = TRecHandler( "party" );
  var State, IsReturnIncome = false;
  var IsIntegrated, IsExtCarry;
  var DpPmObj = TInsertDpPmObj(pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);
  var err = 0;
  var TaxObj = NULL;
  var rsdCmd, query, dataSet;
  var mcaccdoc = TBFile( "mcaccdoc" ); mcaccdoc.Clear();
  var accountReceiver:String = "", accountPayer:String = "";
  var ground:String = "";
  var category:String = "";
  var PayerAcc = TRecHandler("account.dbt");
  var SumPayer = $0, SumReceiver = $0;
  var TrnBatch = null, PaymTrnBatch = null;
  var i = 0;
  var arrErrCode = TArray(), arrErrMessage = TArray(), arrErrPaymentID = TArray();
  var accTrn;
  var nCarry;
  var PaymentID = 0;
  var q, select, ds;
  var NeedTaxTr = false;
  var analiticKind1 = 0;

  if(pmaccObj.UsePaymInPMACC() == true) /* Если выплата через банк */

    PaymentID = pmaccObj.GetPaymentID();
    if( PaymentID > 0 )
      PaymentObj = RSBPayment( PaymentID );
    else
      msgbox("Не найден платеж");
      return 1;
    end;

    IsIntegrated = GetIsIntegrated();
    IsExtCarry = GetIsExtCarry();

    // Если (НЕинтегрированный режим и платеж внутренний) либо (ИНТЕГРИРОВАННЫЙ режим и ПРОВОДКА_ПО_ИСХ_ПЛАТЕЖАМ)
    // то проводку по платежу формируем и оплачиваем
    if(((NOT IsIntegrated) AND (PaymentObj.ReceiverBankID == {OurBank})) OR
      (IsIntegrated AND ((IsExtCarry) OR (PaymentObj.ReceiverBankID == {OurBank}))) )

      tr = PaymentObj.MakeTransaction();

      if(tr == null)
        msgbox("Ошибка при создании проводки");
        return 1;
      end;

      tr.Date_Carry = PaymentObj.ValueDate;

      tr.Chapter         = 1;
      tr.Department      = {OperDprt};

      tr.Number_Pack     = PaymentObj.NumberPack;
      tr.Numb_Document   = PaymentObj.Number;
      tr.Ground          = PaymentObj.Ground;
      tr.FIIDPayer       = PaymentObj.FuturePayerFIID;
      tr.FIIDReceiver    = PaymentObj.FutureReceiverFIID;
      tr.SumPayer        = PaymentObj.FuturePayerAmount;
      tr.SumReceiver     = PaymentObj.FutureReceiverAmount;
      tr.AccountPayer    = PaymentObj.FuturePayerAccount;
      tr.AccountReceiver = PaymentObj.FutureReceiverAccount;

      //определить шифр проводки
      //Условия, при которых устанавливается значение Шифра равное 17:
      //   - кредитуемый  счет  является "клиентским счетом"
      // И
      //   - дебетуемый счет  -  не является "клиентским счетом" и не является корсчетом

      if( (IsClientAcc(tr.AccountReceiver)) AND (NOT IsClientAcc(tr.AccountPayer)) AND (NOT CheckAccount_Type( tr.AccountPayer, tr.Chapter, tr.FIIDPayer, "К" )) )
        tr.Shifr_Oper = 17;
      end;

    end;

    if((NOT IsIntegrated) OR ((not IsExtCarry) AND (PaymentObj.ReceiverBankID == {OurBank}))) // Если НЕинтегрированный или внутренний платеж - платеж закрываем
      PaymentObj.PaymStatus = PM_FINISHED;
    else // Если ИНТЕГРИРОВАННЫЙ - отправим его в модуль межбанковских расчетов
      PaymentObj.PaymStatus = PM_READY_TO_SEND;
      PaymentObj.IsFactPaym = SET_CHAR;
    end;

    if(PaymentObj.Purpose == PM_PURP_RETURNINCOME)
      IsReturnIncome = true;
    end;
  else
    /* Выдача наличными - в текущей версии не поддерживается */
  end;

  State = DPPMAC_STATE_PAID;
  if(IsReturnIncome)
    State = DPPMAC_STATE_RET;
  end;

  //проводка по удержанию налога
  if(IsReturnIncome == false)
     if((pmaccObj.m_crp.rec.HoldTax == "X") and (pmaccObj.m_crp.rec.TransferTax == "X") and (pmaccObj.m_pmacc.rec.CalcTaxAmount != 0))
       NeedTaxTr = true;
     end;

     //Если есть операция удержания НДФЛ, то проводку не формируем, т.к. удержали налог уже там.
     if((NeedTaxTr == true) and (pmaccObj.HolderIsPersn() == true))
       q =   " select op.t_Code, op.t_Status "
           + "   from ddppmobj_dbt pmobj, dnptxop_dbt op "
           + "  where pmobj.t_PmAccID = ? "
           + "    and pmobj.t_ObjKind = " + DL_HOLDNDFL
           + "    and op.t_ID = pmobj.t_ObjID ";

       select = DL_RSDCommand(q);

       select.AddParam(pmaccObj.m_pmacc.rec.ID);

       ds = select.Execute();
       //Если есть операция удержания и в ней сумма налога в рублях, то возьмём оттуда, чтобы не конвертировать
       if(ds.moveNext())
         if(ds.Status != DL_TXOP_Close)
           msgbox("Не выполнена операция удержания НДФЛ с кодом " + ds.Code);
           err = 1;
         else
           NeedTaxTr = false;
         end;
       end;
    end;

    if( NeedTaxTr == true )
      query = " SELECT spgr.t_Xld, spgr.t_RegistrDate "
            + "   FROM dspground_dbt spgr "
            + " WHERE spgr.t_SourceDocID = ? "
            + "   AND spgr.t_SourceDocKind = ? "
            + "   AND spgr.t_Direction = " + String( ENTERING ) + " "
            + "   AND spgr.t_Division = " + String( DP_SelfDivision ) + " ";

      rsdCmd = DL_RsdCommand( query );
      rsdCmd.AddParam(pmaccObj.m_crp.rec.DocumentID );
      rsdCmd.AddParam(pmaccObj.m_crp.rec.DocKind );

      dataSet = rsdCmd.Execute();
      if( dataSet.MoveNext() )

        if( pmaccObj.HolderIsPersn() == true)
          if( DL_GetPartyResident(pmaccObj.m_pmacc.rec.BeneficiarID) == NPTXPARTY_NOTRESIDENT )
            category = "НДФЛ к перечислению.нерез";
          else
            category = "НДФЛ к перечислению";
          end;
        else
          category = "-Бюджет, ф.налоги";
        end;

        ground = "Удержание налога по уведомлению №" + String( dataSet.Xld ) + " от " + String( Date( dataSet.RegistrDate ) ) + ". "
               + "Клиент " + ПолучитьКодСубъекта( pmaccObj.m_pmacc.rec.HolderID, PTCK_CLIENT ) + " " + party.rec.ShortName;

        accountReceiver = MC_FindAndOpenCommonAcc( category
                                                  ,Date( dataSet.RegistrDate )
                                                  ,MC_OPENACC_CREATE
                                                  ,1
                                                  ,mcaccdoc
                                                  ,0
                                                  ,NATCUR );

        if(CheckDepoChargeIncome() == false)
          accountPayer = pmaccObj.m_crp.rec.Account;
        else
          var FD = DP_PmaccFD(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID);

          if(false == FD.OpenAccount( "-Расчеты, Выплаты по ц/б", NULL, NULL, PayerAcc, dataSet.RegistrDate, pmaccObj.m_crp.rec.Currency ))
            msgbox("Ошибка при открытии счета");
            err = 1;
          else
            accountPayer = PayerAcc.rec.Account;
          end;
        end;

        SumPayer = pmaccObj.m_pmacc.rec.CalcTaxAmount;
        if(pmaccObj.m_crp.rec.Currency != NATCUR)
          err = ConvSum (SumReceiver, SumPayer, pmaccObj.m_ExecDate, pmaccObj.m_crp.rec.Currency, NATCUR);
        else
          SumReceiver = SumPayer;
        end;

        if( (not err) and (accountPayer != "") and (accountReceiver != "") )

          trTax = RsbAccTransaction();

          trTax.Chapter         = 1;
          trTax.Date_Carry      = dataSet.RegistrDate;
          trTax.ResultCarry     = 1;
          trTax.Ground          = ground;
          trTax.Department      = {OperDprt};
          trTax.FIIDPayer       = pmaccObj.m_crp.rec.Currency;
          trTax.FIIDReceiver    = NATCUR;
          trTax.SumPayer        = MoneyL(round(SumPayer,2));
          trTax.SumReceiver     = MoneyL(round(SumReceiver,2));
          trTax.AccountPayer    = accountPayer;
          trTax.AccountReceiver = accountReceiver;

          if(((pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS) or
              (pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_COUPON)) and
             (trTax.SumReceiver > 0) and
             (pmaccObj.HolderIsPersn() == false) and
             (DL_UseNUTX() == true) and
             (IsNeresidentForNUTX(pmaccObj.m_pmacc.rec.HolderID, pmaccObj.m_crp.rec.ValueDate) == true)
            )
            if(pmaccObj.m_crp.rec.PaymentType == DP_CRPPAYMENTTYPE_DIVIDENDS)
              analiticKind1 = TXOBJ_KIND1098;
            else
              analiticKind1 = TXOBJ_KIND1095;
            end;

            q =   " SELECT dppmacfi.t_FIID, RSI_NUTX.GetNUTaxGroup(dppmacfi.t_FIID, ?) TaxGroupNUTX "
                + "   FROM ddppmacfi_dbt dppmacfi "
                + "  WHERE dppmacfi.t_DocumentID = ? "
                + "    AND dppmacfi.t_HolderAccID = ? ";

            select = DL_RsdCommand(q);
            select.AddParam(pmaccObj.m_crp.rec.ValueDate);
            select.AddParam(pmaccObj.m_pmacc.rec.DocumentID);
            select.AddParam(pmaccObj.m_pmacc.rec.HolderAccID);
            ds = select.Execute();

            if(ds.moveNext())
              var pContract = pmaccObj.GetDepoContrID();

              TaxObj = TInsertDepoTaxObjectNUTX(pmaccObj.m_crp, pmaccObj.m_pmacc.rec.ID, CurrPmAccData.ExecState);

              TaxObj.Add( pmaccObj.m_crp.rec.ValueDate      // Дата НДР
                         ,pmaccObj.m_pmacc.rec.HolderID     // Клиент
                         ,pmaccObj.m_pmacc.rec.BeneficiarID // Фактический получатель дохода
                         ,NUTXOBJ_DIR_OUT                   // Направление
                         ,6                                 // Уровень
                         ,""                                // Признак "Пользовательский"
                         ,NUTXOBJ_PAIDTAX                   // Вид НДР
                         ,trTax.SumReceiver                 // Сумма дохода/расхода
                         ,trTax.FIIDReceiver                // Валюта дохода/расхода
                         ,analiticKind1                     // Вид аналитики 1
                         ,pmaccObj.m_crp.rec.DocumentID     // Аналитика 1
                         ,0                                 // Вид аналитики 2
                         ,-1                                // Аналитика 2
                         ,TXOBJ_KIND3010                    // Вид аналитики 3
                         ,ds.FIID                           // Аналитика 3
                         ,0                                 // Вид аналитики 4
                         ,-1                                // Аналитика 4
                         ,TXOBJ_KIND5010                    // Вид аналитики 5
                         ,ds.TaxGroupNUTX                   // Аналитика 5
                         ,TXOBJ_KIND6020
                         ,pContract
                         ,"Удержанный налог в Депозитарии" ) // Комментарий
            end;
          end;
        else
          err = 1;
        end;
      else
        err = 1;
      end;
    end;
  end;

  if(not err)
    //Транзакция сохранения
    RslDefCon.BeginTrans();

    if(IsReturnIncome == false)
      pmaccObj.m_pmacc.rec.PayAmount = pmaccObj.m_pmacc.rec.Amount;
      pmaccObj.m_pmacc.rec.ExecState = IIF(IsReturnIncome == true, DP_PMACC_EXECSTATE_RETURNINC, DP_PMACC_EXECSTATE_PAYINC);

      err = pmaccObj.UpdatePMACC();
    end;

    if(not err)
      if(not DP_ChangePMACCState(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID, State, pmaccObj.m_ExecDate, true))
        msgbox("Ошибка при изменении статуса выплаты");
        err = 1;
      end;
    end;

    if((not err) and (PaymentObj != NULL))
      if(not DP_GetPmRAccDescription(pmaccObj.m_pmacc.rec.DocumentID, pmaccObj.m_pmacc.rec.HolderAccID, State, pmaccObj.m_ExecDate, PaymentObj.Ground))
        msgbox("Ошибка заполнения поля \"Основание\"");
        return 1;
      end;
    end;

    if((not err) and (PaymentObj != NULL))
      err = PaymentObj.Update();
      if(err)
        msgbox("Ошибка при обновлении платежа");
      end;
    end;

    if((not err) and (tr != NULL))

      tr.Ground = PaymentObj.Ground;

      PaymTrnBatch = DP_RsbBatchPaymTrn;
      PaymTrnBatch.AddTransaction( PaymentObj.PaymentID, tr, ACCTRN_STATUS_DOCUMENT, PM_CARRY_REASON_EXECUTION, 0, 0, 0 );

      if( not PaymTrnBatch.Execute() )
        msgbox( "Ошибка при исполнении проводок" );
        err = 1;
      end;

      if((not err) and (not PaymTrnBatch.GetErrors(arrErrPaymentID, arrErrCode, arrErrMessage)))
        err =  1;
      end;

      if(not err)
        i = 0;
        if(arrErrPaymentID.size() > 0)
          while( i < arrErrPaymentID.size() )

            if((arrErrCode[i] > 0) or (arrErrMessage[i] != ""))
              msgbox("Ошибка при выполнении проводки. " + arrErrMessage[i]);
            end;
            i = i + 1;
          end;

          err = 1;
        end;
      end;

      if((not err) and (PaymentID > 0))
        var accTrnID = GetAccTrnIDByPaym(PaymentID);
        if(accTrnID > 0)
          DpPmObj.Add(DLDOC_CARRY, accTrnID);
        end;
      end;
    end;

    if((not err) and (trTax != NULL))

      TrnBatch = RsbBatchAccTrn;
      TrnBatch.AddAccTransaction(trTax, NULL, 0, 0 );

      TrnBatch.Execute();
      //Переносим ID проводок
      i = 0;
      nCarry = TrnBatch.GetResult( arrErrCode, arrErrMessage );
      while(i < nCarry)
        accTrn = TrnBatch.GetAccTransaction(i);

        if( arrErrCode[i] == 0 )
          DpPmObj.Add(DLDOC_CARRY, accTrn.AccTrnID);
        else
          msgbox("Ошибка при выполнении проводки. " + arrErrMessage[i]);
          err = 1;
        end;

        i = i + 1;
      end;
    end;

    if(not err)
      err = DpPmObj.Save();
      if(err)
        msgbox("Ошибка при сохранении объектов операции");
      end;
    end;

    if((not err) and (TaxObj != NULL))
      err = TaxObj.Save();
    end;

    if(err)
      RslDefCon.RollbackTrans();
    else
      RslDefCon.CommitTrans();
    end;
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

private macro ЗавершитьОбработку(pmaccObj)
  var err = 0;

  RslDefCon.BeginTrans();

  pmaccObj.m_pmacc.rec.ExecState = DP_PMACC_EXECSTATE_ENDEXEC;

  err = pmaccObj.UpdatePMACC();

  if(err)
    RslDefCon.RollbackTrans();
  else
    RslDefCon.CommitTrans();
  end;

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
  end;

  return 1;
end;

//Выполнить выплату по одному счету
macro ExecOnePMACC(DocumentID:integer, PmAccID:integer, ExecDate:date)
  var crp   = TBFile("dpcorpop.dbt");
  var pmacc = TRecHandler("dppmacc.dbt");
  var pmaccObj = NULL;
  var CurrExecState = 0;
  var err = 0;

  DP_OpenFilesCORPOP();

  RepErrArr.size = 0;
  ReplaceMacro( "msgbox", "depopmacc_msgbox" );

  crp.Clear();
  crp.rec.DocumentID = DocumentID;
  if(not crp.GetEQ)
    msgbox("Ошибка при поиске операции расчетов с ID = " + DocumentID);
    err = 1;
  end;

  if(not err)
    err = GetActuatePmacc(PmAccID, pmacc);
  end;

  if(not err)
    SetPmAccMessage(PmAccID, "");

    pmaccObj = TPmAccData(crp, pmacc, ExecDate);

    CurrExecState = GetNextExecState(pmacc.rec.ExecState);
    while((not err) and (CurrExecState > 0))
      SetCurrPmAccData(PmAccID, CurrExecState);

      if(CurrExecState == DP_PMACC_EXECSTATE_CALC)
        err = ВыполнитьНачисление(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_ACCRUED)
        err = ОформитьВыплату(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_RETIRE)
        err = СоздатьОперациюПогашения(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_TAXOBJ)
        err = СоздатьОбъектыНДР(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_TAXCALC)
        err = СоздатьОперациюРасчетаНОБ(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_TAXHOLD)
        err = СоздатьОперациюУдержанияНДФЛ(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_TAXSET)
        err = ЗанестиВВыплатуНалогНДФЛ(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_PAYINC)
        err = ИсполнитьВыплату(pmaccObj);
      elif(CurrExecState == DP_PMACC_EXECSTATE_ENDEXEC)
        err = ЗавершитьОбработку(pmaccObj);
      end;

      if(not err)
        err = GetActuatePmacc(PmAccID, pmaccObj.m_pmacc);
      end;

      SavePmAccErrForReport_XML(RepErrArr, DocumentID, SP_DEPOPER_DIVIDEND);

      if(not err)
        CurrExecState = GetNextExecState(CurrExecState);
      end;
    end;
  end;

  SavePmAccErrForReport_XML(RepErrArr, DocumentID, SP_DEPOPER_DIVIDEND);
  ClearCurrPmAccData();

  DP_CloseFilesCORPOP();

  ReplaceMacro( "msgbox", NULL );

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  return 1;
end;

PRIVATE CLASS DepoPmAccParams()
  var DocumentID:integer  = 0;
  var ExecDate:date       = date(0,0,0);
END;

PRIVATE MACRO GetDepoPmAccObjectQuery(DocumentID:integer)
  var query = "";

  query =   " select 0 as t_ObjectType, t_ID as t_ObjectID, ROWNUM as t_GroupNumber, t_ID as t_PmAccID"
          + "   from ddppmacc_dbt "
          + "  where t_DocumentID = " + DocumentID
          + "    and t_ExecState <> " + DP_PMACC_EXECSTATE_ENDEXEC;

  return query;
END;

MACRO ОтобратьОбъектыДляРасчета(_taskID, _execID, _conveyerID, _packetSize, _Params)
  var cnt = 0;
  var query, DataSet;

  query = " INSERT INTO DCNVDOC_DBT(T_TASKID,T_EXECID,T_CONVTYPEID,T_PACKID,T_OBJECTTYPE,T_OBJECTID) "
        + " SELECT "+_taskID+","+_execID+","+_conveyerID+",q.t_GroupNumber, q.t_ObjectType, q.t_ObjectID "
        + "   FROM (" + GetDepoPmAccObjectQuery(_Params.DocumentID) + ") q ";
  query = query + " ORDER BY q.t_ObjectID ";

  SQL_Execute(query, "Отбор объектов", false );

  if(_packetSize == 0)
    cnt = 1;
  else
    query =   " select NVL(max(t_PackID), 0) as cnt "
            + "   from dcnvdoc_dbt "
            + "  where t_ExecID = " + _execID;

    DataSet = TRsbDataSet(query);
    if(DataSet.moveNext())
      cnt = int(round(int(DataSet.cnt), 0));
    end;
  end;

  return cnt;
END;

MACRO ExecuteDepoPmAcc(_taskID, _execID, _conveyerID, _operationID, _packetID, _Params)
  var query, cmd, DataSet;
  var cnt = 0;
  var err = 0;

  RepErrArr.size = 0;
  ReplaceMacro( "msgbox", "depopmacc_msgbox" );

  ClearCurrPmAccData();

  if((_conveyerID) and (_packetID))

    query =  "select t_ObjectID as t_PmAccID from dcnvdoc_dbt where t_ExecID = ? and t_ConvTypeID = ? and t_PackID = ?";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(_execID);
    cmd.AddParam(_conveyerID);
    cmd.AddParam(_packetID);

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      ExecOnePMACC(_Params.DocumentID, DataSet.PmAccID, date(_Params.ExecDate));
    end;

  else
    query = "select q.t_PmAccID from ("+GetDepoPmAccObjectQuery(_Params.DocumentID)+") q ";
    cmd = DL_RSDCommand(query);
    cnt = cmd.GetCount();

    if(cnt > 0)
      InitProgress( cnt, "Идет выполнение ...", "Расчет выплат по ц/б" );

      DataSet = cmd.Execute();
      var i = 0;
      while(DataSet.moveNext())

        ExecOnePMACC(_Params.DocumentID, DataSet.PmAccID, date(_Params.ExecDate));

        UseProgress(i = i + 1);
      end;

      RemProgress();
    end;
  end;

  if((_conveyerID) and (_packetID))
    /*не зависимо от того, делали что-то или нет - ставим исходящий статус обрабатываемой пачке*/
    var exec = RSDCommand(  " UPDATE dcnvpack_dbt "
                          + " SET t_State = t_State + 1 "
                          + " WHERE t_ExecID = ? "
                          + "   AND t_ConvTypeID = ? "
                          + "   AND t_PackID = ? ");

    exec.addParam( "", RSDBP_IN, _execID );
    exec.addParam( "", RSDBP_IN, _conveyerID );
    exec.addParam( "", RSDBP_IN, _packetID );
    exec.execute();
  end;

  ReplaceMacro( "msgbox", NULL );

  SavePmAccErrForReport_XML(RepErrArr, _Params.DocumentID, SP_DEPOPER_DIVIDEND);

  return err;

OnError(er)
  msgbox(er.module+ " "+er.line+" "+er.message);
  return 1;
END;

//Выполнить выплаты по всем счетам
macro ExecAllPMACC(DocumentID:integer)
  var cmd, query, DataSet;
  var OperID = 22; //Операция для конвейера - Пакетная операция расчета выплат дохода по ц/б в Депозитарии
  var ConvID = 27; //Вид конвейера - Расчет выплат по ц/б в Депозитарии
  var UseConveyer = SecurUseConveyer(ConvID, OperID);
  var params = DepoPmAccParams();
  var err = 0;

  RepErrArr.size = 0;
  ReplaceMacro( "msgbox", "depopmacc_msgbox" );

  params.DocumentID = DocumentID;
  params.ExecDate   = {curdate};

  if(UseConveyer)
    var cnv = RsbConveyerExec(ConvID);

    cnv.AddParamsForConveyer(ConvID, params, 0);
    cnv.AddParamsForOperation(ConvID, OperID, params, "", 0);
    cnv.showPanelMonitoring(1);
    cnv.Run();
  else
    err = ExecuteDepoPmAcc(0, 0, 0, 0, 0, params);
  end;

  ReplaceMacro( "msgbox", NULL );
  SavePmAccErrForReport_XML(RepErrArr, DocumentID, SP_DEPOPER_DIVIDEND);

  return err;
end;
