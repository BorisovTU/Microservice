/* шаг      "отправить  сообщение?"                               */
/* Nikonorov Evgeny 29.05.2007                             */

import InsCarryDoc, OprInter, PaymInter, "dlcarry.inc", opr_depo;

/* Буферы ПД, заполняемые из операции */
record Pm_paym( pmpaym );     /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );     /*св-ва платежа*/
record Pm_rmprop( pmrmprop ); /*платеж по ценным бумагам*/

/* Номера шагов для перехода */
const НомерШагаОтправитьИнструкцию  = 45;
var НомерШагаНужноЛиЖдатьПодтверждение = 0;

/**********************************/
/* Выполнение шага                */
/**********************************/
macro ExecuteCaseStep( Kind_Operation, Number_Step, first, KindDoc )
  
  var AutoSendMessEnabled = false;
  record spdraft( spdraft );

  SetBuff( spdraft, first );

  if( spdraft.Kind == SP_DEPOPER_ENROLMENT )
    НомерШагаНужноЛиЖдатьПодтверждение = 23;
  elif( spdraft.Kind == SP_DEPOPER_TRANSFERORDER )
    НомерШагаНужноЛиЖдатьПодтверждение = 25;
  end;

  GetAutoSendMessState( AutoSendMessEnabled );
  if( (AutoSendMessEnabled == true)  )
    //сообщение уже должно быть, но всё же проверим
    if( FindDpMessageByDraft(spdraft.AutoKey) )
      return string( НомерШагаОтправитьИнструкцию );
    else
      return string( НомерШагаНужноЛиЖдатьПодтверждение );
    end;
  else
    return string( НомерШагаНужноЛиЖдатьПодтверждение );
  end;
 
  return "";
end;
