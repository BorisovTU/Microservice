/************************************************************************/
/*         Автоматизированная банковская система RS-Bank 6.0            */
/*                 Copyright (c) R-Style Software Lab 2005              */
/*                                                                      */
/*  Имя файла        : dpgl_20.mac                                      */
/*  Описание         : Глобальные операции депозитария                  */
/*                     открытие разделов                                */
/*  Программист      : Nikonorov Evgeny                                 */
/*  Создан           : 05.07.2005                                       */
/************************************************************************/

//Import DPInter, makenum, dpainpdf, dp_util, "dlcarry.inc", opr_depo;

/* Выбор терминального раздела по счету/разделу счета ДЕПО.
   В случае отсутствия - открывает новый раздел (для зачисления).
*/

//var DPGLError = CDPError; /* Глобальный обработчик ошибок */

/*
Получение значения настройки "Учет актива в пассиве"
*/
/*
macro DP_GL_InputDepoPartByDepoAcc( IsPayer, corpop, err )
  var DPAcntID, BriefCode = "", err_text = "";
  var XID;

  file DepoAcnt( depoacnt ) key 0;
  file spground( spground ) key 6;

  if( IsPayer == DP_OPRACC_PAYER )
     DepoAcnt.AutoKey = corpop.PayOFFAccID;   //счет депо эмитента для учета погашаемых ц/б
  else
     DepoAcnt.AutoKey = corpop.EmissiveAccID; //эмиссионный счет депо эмитента для учета размещаемых ц/б
  end;

  if( GetEQ( DepoAcnt ) == true )
     BriefCode = DepoAcnt.BriefCode;
  end; 

   
  spground.SourceDocKind = corpop.DocKind;
  spground.SourceDocID   = corpop.DocumentID;
  spground.Direction     = 1;
  spground.Division      = SelfDivision;

  if(GetEQ(spground))
    XID = string(spground.XLD);
  else
    XID = "";
  end;


  DPAcntID = GL_GetDepoPartition( IsPayer, corpop, err );
  if( DPAcntID == 0 )
    if(err == DP_GETDPAC_BTRERR)
      err_text = "Ошибка менеджера записей!";
    elif(err == DP_GETDPAC_WRONG_PARAMS )
      err_text = "Функции поиска переданы неверные параметры";
    elif(err == DP_GETDPAC_NODPAC )
      err_text = "Счет/раздел " + BriefCode + " счета депо не найден";
    elif(err == DP_GETDPAC_KINDACCOP_DIFFERS )
      err_text = "Переданный вид операции, отличается от определенного функцией";
    elif(err == DP_GETDPAC_WRONG_SA_ATTR )
      err_text = "В поручении указан раздел " + BriefCode + " с недопустимыми характеристиками";
    elif(err == DP_GETDPAC_WRONG_DPAC_STATUS )
      err_text = "Недопустимый статус раздела счета депо " + BriefCode;
    elif(err == DP_GETDPAC_NOT_ENOUGH_DT_SEL )
      err_text = "В поручении №"+XID+" недостаточно данных для выбора раздела";
    elif(err == DP_GETDPAC_NODPAC_FORWRTOFF)
      err_text = "Не найден раздел " + BriefCode + " счета депо списания";
    elif(err == DP_GETDPAC_NODPAC_OPERATOR)
      err_text = "Не найден раздел оператора счета";
    elif(err == DP_GETACC_DPACNEWER)
      err_text = "Раздел " + BriefCode + " не был открыт на дату проводки";
    elif(err == DP_GETDPAC_NOT_ENOUGH_DT_CR)
      err_text = "В поручении недостаточно данных для создания раздела";
    elif(err == DP_GETDPAC_DEPONOOPEN)
      err_text = "Счет не открыт";
    elif(err == DP_GETDPAC_NOKORRECTDATE)
      err_text = "Дата создания счета больше даты операции";
    elif(err == DP_GETDPAC_NOKORRECTSTATUS)
      err_text = "Недопустимый статус счета депо";
    else
      err_text = "Ошибка поиска раздела счета для счета депо";
    end;

    DPGLError.SetErr(err_text);
    SetParm(3, err);
  else
    SetParm(3, 0);
  end;

  return DPAcntID;
end;
     */
/* Выбор лицевого счета по счету ДЕПО.
   В случае отсутствия л/с открывает новый счет (для зачисления).
   В случае привязки к одному разделу счета ДЕПО более одного л/с при списании
   предлагает скроллинг (если не испольщуется режим пакетной обработки).
*/
/*
macro GL_InputAccountByDepoAcc( AutoKey, IsPayer, corpop, err, Xid )
  var Acc, BriefCode = "", err_text = "";
  file DepoAcnt( depoacnt ) key 0;

  DepoAcnt.AutoKey = AutoKey;
  if( GetEQ( DepoAcnt ) == true )
     BriefCode = DepoAcnt.BriefCode;
  end;

 // if( ( ValType(Xid) == V_STRING ) AND ( Xid != "" ) )
//    Acc = GL_GetAccountByDepoAcc(AutoKey, IsPayer, corpop, err, Xid );
//  else
    Acc = GL_GetAccountByDepoAcc(AutoKey, IsPayer, corpop, err );
//  end;
  if( NOT strlen(Acc) or (err))
    if(err == DP_GETACC_BTRERR)
      err_text = "Ошибка менеджера записей!";
    elif(err == DP_GETACC_WRONG_PARAMS )
      err_text = "Функции поиска переданы неверные параметры";
    elif(err == DP_GETACC_NODPAC )
      err_text = "Счет/раздел " + BriefCode + " счета депо не найден";
    elif(err == DP_GETACC_DIFFACCONCARDS )
      err_text = "Счета на карточках сертификатов не совпадают";
    elif(err == DP_GETACC_ACCNOTEXIST )
      err_text = "Не найден лицевой счет, указанный в инвентарной карточке";
    elif(err == DP_GETACC_WRONGACC )
      err_text = "Найденный л/с не подходит для данных валюты, |главы, признака закрытого хранения";
    elif(err == DP_GETACC_NOPARTY )
      err_text = "Не найден владелец счета";
    elif(err == DP_GETACC_MANYACC)
      err_text = "Массовое действие|Невозможно вывести список счетов";
    elif(err == DP_GETACC_ESC)
/*       err_text = "Прерывание пользователя";*/
       ;
    elif(err == DP_GETACC_DPACNOTTERM)
      err_text = "Счет/раздел " + BriefCode + " не является терминальным";
    elif(err == DP_GETACC_STOREMODE_DIFFERS)
      err_text = "Режим хранения на разделе счета ДЕПО " + BriefCode + " не совпадает с указанным в поручении";
    elif(err == DP_GETACC_BLOCK_DIFFERS)
      err_text = "Блокировка на разделе счета ДЕПО " + BriefCode + " не совпадает с указанной в поручении";
    elif(err == DP_GETACC_WRONGBLOCK)
      err_text = "В поручении указана некорректная блокировка по счету отправителя/получателя";
    elif(err == DP_GETACC_WRTOFF_ACCNOTEXIST)
      err_text = "На разделе счета ДЕПО " + BriefCode + " не найден лицевой счет списания";
    elif(err == DP_GETACC_ACC_CLOSED)
       err_text = "Лицевой счет закрыт";
    elif(err == DP_GETACC_WRONG_PARTIT)
       err_text = "Лицевой счет принадлежит другому разделу";
    elif(err == DP_GETACC_ACCNEWER)
       err_text = "Лицевой счет не открыт на дату проводки";
    elif(err == DP_GETACC_WRONGACCCERT)
       err_text = "В инвентарной карточке указан некорректный лицевой счет";
    elif(err == DP_GETACC_WRONG_PARTITCERT)
       err_text = "Инвентарная карточка зачислена на лицевой счет другого раздела";
    elif(err == DP_GETACC_WRONGBLOCKCERT)
       err_text = "Блокировка на лицевом счете, указанном в инвентарной карточке, не совпадает с указанной в поручении";
    elif(err == DP_GETACC_DEPOACCNEWER)
       err_text = "Раздел счета депо " + BriefCode + " не открыт на дату проводки";
    elif(err == DP_GETACC_DEPOACC_CLOSED)
       err_text = "Раздел счета депо " + BriefCode + " закрыт";
    elif(err == DP_GETACC_ACCAMBIGUITY)
       err_text = "На разделе " + BriefCode + " более одного лицевого счета|неоднозначность выбора";
    elif(err == DP_GETACC_REC_ACCNOTEXIST)
       err_text = "Не найден лицевой счет зачисления";
    elif(err == DP_GETACC_NOXID)
       err_text = "Функции поиска не передан номер инвентарной карточки";
    elif(err == DP_GETACC_WRONGISSUERCERT)
       err_text = "Эмитент на лицевом счете не совпадает с |эмитентом ценных бумаг на инвентарной карточке";
    elif(err == DP_GETACC_WRONGISSUER)
       err_text = "Эмитент по поручению не определен";
    elif(err == DP_GETACC_NOACCISSUER)
       err_text = "Эмитент на лицевом счете не найден";
    else
       err_text = "Ошибка поиска лицевого счета для счета депо " + BriefCode;
    end;

    if(err != DP_GETACC_ESC )
      DPGLError.SetErr(err_text);
    end;
    SetParm(3, err);
  else
    SetParm(3, 0);
  end;

  return Acc;
end;

/* Обработка ошибочной ситуации на шаге инв. операции.
   Выводится сообщение об ошибке и вопрос помещать ли поручение в отказанные.
   В случае положительного ответа - вызывается C_RSL для ввода основания отказа и 
   возвращается, что все ОК - операция продолжится.
   В случае отрицательного - просто возвращается ошибочный статус - операция прерывается.
*/
macro RejectGlobopYesNo( corpop, err_mes )
  var stat = 0, user_message, rej_prm;

  if( ( ValType(err_mes) == V_STRING ) AND ( err_mes != "" ) )
    user_message = "Ошибка: " + err_mes;
  else
    user_message = DPGLError.GetErr();
    if( user_message == "" )
      user_message = "Ошибка при обработке поручения депо";
    end;
  end;

  if(GetTrue(TRUE,user_message + "|Поместить поручение в отказанные?"))
    stat = GetRejectGlobop(corpop, user_message, rej_prm);
    if(stat == DP_REJECTDRAFT_OK)
      /* заменяем последующие шаги шагами из цепочки "перемещение в отказ" */ 
      if( SetGlobalParameter(DPRejectParm, rej_prm) )
        if( not Opr_InsertBranch("R", OPRBR_REMOVE) ) /*вставляемая цепочка заменяет неисполненные шаги*/
          msgbox("Ошибка при вставке цепочки");
          stat = 1;
        end;
      else
        msgbox("Ошибка записи дополнительных параметров");
        stat = 1;
      end;
    elif(stat == DP_REJECTDRAFT_BTRERR)
      msgbox("Ошибка менеджера записей!");
    elif(stat == DP_REJECTDRAFT_WRONG_PARAMS)
      msgbox( "Функции формирования отказа обработки поручения переданы неверные параметры" );
    elif(stat == DP_REJECTDRAFT_ESC)
/*       msgbox("Прерывание пользователя");*/
       ;
    end;
  else
    stat = 1; /* Остановить выполнение операции, т.к. все равно ошибка */
  end;

  return stat;
end;
  */
