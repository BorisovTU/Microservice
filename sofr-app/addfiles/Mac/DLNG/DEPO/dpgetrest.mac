/****************************************************/
/*  Функции получения остатков по счетам ДЕПО       */
/*  Programmed by:  Chernov Anton 17-04-2007        */
/****************************************************/

import CTInter, globals, "cb_sql.mac";

private const 
  DEPOATTR_ATTNUM_OPERATOR = 4,
  DEPOATTR_ATTNUM_BLOCK = 6;

macro DP_GetRestAC( v_FIID:integer, 
                    v_Owner:integer,
                    v_Date:date,
                    v_TypeAcArr:TArray,
                    v_TypePuprpAcArr:TArray )
  var v_Sum = $0, iCount;
  var sql, rsd;

  sql = " SELECT NVL(SUM(acc.t_RestAc), 0) t_RestAC"
      +   " FROM (SELECT t_Account, t_DepoRoot, t_DepoAcc,"
      +                " rsb_account.restac( t_Account, t_Code_Currency, " + GetSQLDate(v_Date) + " , t_Chapter, null ) as t_RestAc "
      +           " FROM daccount_dbt "
      +          " WHERE t_Chapter = 5 "
      +            " AND t_Code_Currency = " + v_FIID
      +            " AND t_Client = " + v_Owner
      +            " AND t_Open_Date <= " + GetSQLDate(v_Date)
      +            " AND instr(t_Kind_Account, 'П') <> 0 ) acc, "
      +        " ddepoacnt_dbt dpac, "
      +        " ddepoacnt_dbt dppt, "
      +        " ddepoac_dbt dpact, "
      +        " dllvalues_dbt llv, "
      +        " ddepoatvl_dbt atvlOper, "
      +        " ddepoatvl_dbt atvlBlock, "
      +        " dllvalues_dbt llvBlock "
      +  " WHERE acc.t_RestAc <> 0 "
      +    " AND dpac.t_AutoKey = acc.t_DepoRoot "
      +    " AND dpact.t_ID = dpac.t_Type ";

  if( (v_TypeAcArr != null) and (v_TypeAcArr.size > 0 ) )
    iCount  = 0;
    sql = sql + " AND dpact.t_shortname IN ('";
    while( iCount < v_TypeAcArr.size )
      if( iCount > 0 )
        sql = sql + ", '";
      end;
      sql = sql + v_TypeAcArr[iCount] + "'";
      iCount = iCount + 1;
    end;
    sql = sql + ")";
  end;

  sql = sql 
      +    " AND llv.t_list = " + OBJTYPE_DEPOKINDTYPE
      +    " AND llv.t_Element = dpact.t_Type ";

  if( (v_TypePuprpAcArr != null) and (v_TypePuprpAcArr.size > 0 ) )
    iCount  = 0;
    sql = sql + " AND llv.t_code IN ('";
    while( iCount < v_TypePuprpAcArr.size )
      if( iCount > 0 )
        sql = sql + ", '";
      end;
      sql = sql + v_TypePuprpAcArr[iCount] + "'";
      iCount = iCount + 1;
    end;
    sql = sql + ")";
  end;

  sql = sql 
      +    " AND dppt.t_AutoKey = acc.t_DepoAcc "
      +    " AND atvlOper.t_IsType = CHR(0) "
      +    " AND atvlOper.t_AttrNum = " + DEPOATTR_ATTNUM_OPERATOR
      +    " AND atvlOper.t_ID = acc.t_DepoAcc "
      +    " AND TO_NUMBER(atvlOper.t_Value) = " + {OurBank}
      +    " AND atvlBlock.t_IsType = CHR(0) "
      +    " AND atvlBlock.t_AttrNum = " + DEPOATTR_ATTNUM_BLOCK
      +    " AND atvlBlock.t_ID = acc.t_DepoAcc "
      +    " AND llvBlock.t_list = " + OBJTYPE_KIND_BLOCK_CB
      +    " AND llvBlock.t_Element = to_number(atvlBlock.t_Value) "
      +    " AND llvBlock.t_code <> ('W22') ";

  rsd = TRsbDataSet(sql);
  if( rsd.MoveNext() )
    v_Sum = money(rsd.t_RestAc);
  end;

  return v_Sum;
end;
