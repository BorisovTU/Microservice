/*
$Name:         dpimp.mac
$Module:       Депозитарий
$Description:  Работа со функциями импорта в Депозитарий
*/

/* т.к. этот макрос используется в разных БО, то импорт без необходимости не использовать*/
Import FIInter, BankInter, DPInter, RsbDataSet, "dlcnst.inc";

// статусы поиска сертификата
private const IS_CS_ALLSTATUS = -2; // не определен

/* обработка статусов возврата функций импорта */
macro DP_ProcImpError(err:integer, errstr:string, actstr:string, objstr:string)
  var bftext;
  if( (err == DP_IMPERR_OK) and (errstr != "") )
    msgbox( actstr + "|", " Предупреждение: ", errstr );
  elif( err == DP_IMPERR_DIDNTFIND )
    msgbox( actstr + "|", objstr + " отсутствует|", errstr );
  elif( err == DP_IMPERR_PARAM_ABSENT )
    msgbox( actstr + "|", "Не задан обязательный параметр|", errstr );
  elif( err == DP_IMPERR_PARAM_NOTINBASE )
    msgbox( actstr + "|", "Заданный параметр отсутствует в справочнике|", errstr );
  elif( err == DP_IMPERR_PARAM_INVALID )
    msgbox( actstr + "|", "Заданный параметр некорректен|", errstr );
  elif( err == DP_IMPERR_DIFFDEPART )
    msgbox( actstr + "|", "Объект находится в другом филиале|", errstr );
  elif( err == DP_IMPERR_ALREADYEXISTS )
    msgbox( actstr + "|", "Уже есть " + objstr + " с такими параметрами:|", errstr );
  elif( err == DP_IMPERR_ACC_WRONGAMOUNT )
    msgbox( actstr + "|", "Сумма остатков по субсчетам превышает начальный остаток на л/с|", errstr );
  elif( err == DP_IMPERR_ACC_MULTISELECT )
    msgbox( actstr + "|", "Найдено несколько л/с, удовлетворяюших условиям|", errstr );
  elif( err == DP_IMPERR_SPGR_UNABLESGRFIND )
    msgbox( actstr + "|", "Поиск незарегистрированного документа невозможен|", errstr );
  elif( err == DP_IMPERR_DPACC_DEBETMULTISEL )
    msgbox( actstr + "|", "Неоднозначность выбора счета дебета|", errstr );
  elif( err == DP_IMPERR_DPACC_DEBACCABSENT )
    msgbox( actstr + "|", "Поставщику не открыт счет в депозитарии|", errstr );
  elif( err == DP_IMPERR_DPACC_KREDMULTISEL )
    msgbox( actstr + "|", "Неоднозначность выбора счета кредита|", errstr );
  elif( err == DP_IMPERR_DPACC_KREDACCABSENT )
    msgbox( actstr + "|", "Получателю не открыт счет в депозитарии|", errstr );
  elif( (err == DP_IMPERR_ERROR) or (err == 4) or (err == 9) )
    Status(bftext);
    msgbox( actstr + "|", "Ошибка: " + bftext + "|", errstr );
  else
    InitError();
    MemoryError(err);
    DisplayError();
  end;

  return err;
end;

/* инициализация параметров вставки/поиска ИК */
macro DP_InitParmInvCrd(parm:variant)
  ClearRecord(parm);
end;

/* инициализация параметров вставки/поиска агентов обращения */
macro DP_InitParmAgent(parm:variant)
  ClearRecord(parm);

  parm.Agent = UnknownParty;
  parm.FIID  = ALLFININSTR;
end;

/* инициализация параметров вставки/поиска счетов/разделов депо */
macro DP_InitParmDPACC(parm:variant)
  ClearRecord(parm);

  parm.Owner    = UnknownParty;
end;

/* инициализация параметров вставки/поиска л/с депо */
macro DP_InitParmACC(parm:variant)
  ClearRecord(parm);

  parm.FIID   = ALLFININSTR;
  parm.Owner  = UnknownParty;
  parm.Issuer = UnknownParty;
end;

/* инициализация параметров вставки/поиска хранилища ц/б */
macro DP_InitParmStPl(parm:variant)
  ClearRecord(parm);

  parm.BankID   = UnknownParty;
  parm.OfficeID = UnknownParty;
end;

/* инициализация параметров вставки поручения депо */
macro DP_InitParmDraft(draftparm:variant, paymparm:variant)
  ClearRecord(draftparm);
  ClearRecord(paymparm);

  draftparm.DwPartyID        = UnknownParty;
  draftparm.DwCustodyID      = UnknownParty;
  draftparm.DwCustodyAgentID = UnknownParty;
  draftparm.DwOurCustAgentID = UnknownParty;
  draftparm.BnPartyID        = UnknownParty;
  draftparm.BnCustodyID      = UnknownParty;
  draftparm.BnCustodyAgentID = UnknownParty;
  draftparm.FIID             = ALLFININSTR;
  draftparm.GeneralizedFIID  = ALLFININSTR;
  draftparm.Initiator        = UnknownParty;
  draftparm.DealParty        = UnknownParty;

  paymparm.FIID               = ALLFININSTR;
  paymparm.PayFIID            = ALLFININSTR;
  paymparm.Payer              = UnknownParty;
  paymparm.PayerBankID        = UnknownParty;
  paymparm.PayerMesBankID     = UnknownParty;
  paymparm.Receiver           = UnknownParty;
  paymparm.ReceiverBankID     = UnknownParty;
  paymparm.ReceiverMesBankID  = UnknownParty;
  paymparm.BaseFIID           = ALLFININSTR;
  paymparm.ComissFIID         = ALLFININSTR;
end;

/* инициализация параметров вставки строки описи сертификатов */
macro DP_InitParmCmMove(parm:variant)
  ClearRecord(parm);
end;

/* инициализация параметров поиска/вставки документа-основания */
macro DP_InitParmSPgr(parm:variant)
  ClearRecord(parm);

  parm.PartyID     = UnknownParty;
  parm.Proxy       = UnknownParty;
  parm.Deponent    = UnknownParty;
end;

/* Поиск ИК */
macro DP_FindInventoryCard(InvCardID:integer, Department:integer, FiCertID:integer, FindState:integer, StatusDate:date, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = FindInventoryCard(v_ErrStr, InvCardID, Department, FiCertID, FindState, StatusDate);

  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Поиск ИК", "ИК");
  end;

  SetParm(0, InvCardID);
  SetParm(6, v_ErrStr);

  return v_stat;
end;

/* Вставка ИК */
macro DP_InsertInventoryCard(InvCardID:integer, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertInventoryCard(v_ErrStr, InvCardID, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка ИК", "ИК");
  end;

  SetParm(0, InvCardID);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Поиск агентов обращения */
macro DP_FindBillAgent(Id:integer, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = FindBillAgent(v_ErrStr, Id, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Поиск агента обращения", "агент обращения");
  end;

  SetParm(0, Id);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка агента обращения */
macro DP_InsertBillAgent(parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertBillAgent(v_ErrStr, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка агента обращения", "агент обращения");
  end;

  SetParm(2, v_ErrStr);

  return v_stat;
end;

/* Поиск счета депо */
macro DP_FindDepoAcc(Id:integer, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = FindDepoAcc(v_ErrStr, Id, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Поиск счета депо", "счет депо");
  end;

  SetParm(0, Id);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка счета депо */
macro DP_InsertDepoAcc(Id:integer, dpacparm:variant, dpavparm:TArray, DontShowError:bool, ErrStr:string, CreateAdmOp:bool)
  var v_DontShowError:bool,
      v_CreateAdmOp:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  if( (ValType(CreateAdmOp) == V_UNDEF) or (CreateAdmOp == null) )
    v_CreateAdmOp = true;
  else
    v_CreateAdmOp = CreateAdmOp;
  end;

  v_stat = InsertDepoAcc(v_ErrStr, Id, dpacparm, dpavparm, CreateAdmOp);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка счета депо", "счет депо");
  end;

  SetParm(0, Id);
  SetParm(4, v_ErrStr);

  return v_stat;
end;

/* Вставка раздела счета депо */
macro DP_InsertDepoPartition(Id:integer, dpacparm:variant, dpavparm:TArray, DontShowError:bool, ErrStr:string, CreateAdmOp:bool)
  var v_DontShowError:bool,
      v_CreateAdmOp:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  if( (ValType(CreateAdmOp) == V_UNDEF) or (CreateAdmOp == null) )
    v_CreateAdmOp = true;
  else
    v_CreateAdmOp = CreateAdmOp;
  end;

  v_stat = InsertDepoPartition(v_ErrStr, Id, dpacparm, dpavparm, CreateAdmOp);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка раздела счета депо", "раздел счета депо");
  end;

  SetParm(0, Id);
  SetParm(4, v_ErrStr);

  return v_stat;
end;

/* Поиск л/с депо */
macro DP_FindDepoFaceAcc(acc:string, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = FindDepoFaceAcc(v_ErrStr, acc, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Поиск лицевого счета депо", "лицевой счет депо");
  end;

  SetParm(0, acc);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка л/с депо */
macro DP_InsertDepoFaceAcc(accparm:variant, atvlparm:TArray, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertDepoFaceAcc(v_ErrStr, accparm, atvlparm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка лицевого счета депо", "лицевой счет депо");
  end;

  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Поиск хранилища */
macro DP_FindDepoKeepingPlace(Id:integer, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = FindDepoKeepingPlace(v_ErrStr, Id, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Поиск хранилища ц/б", "хранилище ц/б");
  end;

  SetParm(0, Id);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка хранилища */
macro DP_InsertDepoKeepingPlace(Id:integer, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertDepoKeepingPlace(v_ErrStr, Id, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка хранилища ц/б", "хранилище ц/б");
  end;

  SetParm(0, Id);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка поручения депо */
macro DP_InsertDeferDraft(draftparm:variant, paymparm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertDeferDraft(v_ErrStr, draftparm, paymparm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка поручения депо", "поручение депо");
  end;

  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка поручения депо по ТО*/
macro DP_InsertDeferDraftRQ(draftparm:variant, rqparm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertDeferDraftByRQ(v_ErrStr, draftparm, rqparm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка поручения депо", "поручение депо");
  end;

  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка исходящего документа в с межфилиальном поручении депо */
macro DP_InsertExtGroundToSpdraft(DraftID:integer, SPgroundID:@variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertExtGroundToSpdraft(v_ErrStr, DraftID, SPgroundID);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка исходящего документа", "поручение депо");
  end;

  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка строки описи сертификатов */
macro DP_InsertInvList(InvCardID:integer, Section:integer, Cell:integer, DraftID:integer, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = InsertInvList(v_ErrStr, InvCardID, Section, Cell, DraftID);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка строки описи", "строка описи");
  end;

  SetParm(5, v_ErrStr);

  return v_stat;
end;

/* Поиск документа-основания */
macro DP_FindSPGroundDocument(Id:integer, parm:variant, DontShowError:bool, ErrStr:string)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat;

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  v_stat = FindSPGroundDocument(v_ErrStr, Id, parm);
  if( not v_DontShowError )
    v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Поиск документа-основания", "документ-основание");
  end;

  SetParm(0, Id);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Вставка документа-основания */
macro DP_InsertGroundDocument(Id:integer, parm:variant, DontShowError:bool, ErrStr:string, UseDocFltr:bool)
  var v_DontShowError:bool,
      v_ErrStr:string,
      v_stat = 0;
  var NeedInsert = true;
  var llclsv = TBFile("llclsval.dbt");

  if( (ValType(DontShowError) == V_UNDEF) or (DontShowError == null) )
    v_DontShowError = false;
  else
    v_DontShowError = DontShowError;
  end;

  //фильтр по виду документа
  //если не подошел, то просто не делаем вставку и говорим, что всё хорошо
  if((ValType(UseDocFltr) != V_UNDEF) and (UseDocFltr==true))
    //1. Документ должен быть в классификаторе 300
    llclsv.AddFilter(" t_Classificator = 300 and t_Element = " + parm.rec.Kind);
    if( not llclsv.next() )
      NeedInsert = false;
    end;

    //2. Пропустить вид документа 299 "Поручение депо"
    if( (NeedInsert) and (parm.rec.Kind == 299))
      NeedInsert = false;
    end;

    //3. Пропустить вид документа 300 "Отчет об исполнении поручения"
    if( (NeedInsert) and (parm.rec.Kind == 300))
      NeedInsert = false;
    end;
    if( (NeedInsert) and (parm.rec.Kind == 366))
      NeedInsert = false;
    end;

    //4. Пропустить вид документа 301 "Уведомление об отказе в исполнении"
    if( (NeedInsert) and (parm.rec.Kind == 301))
      NeedInsert = false;
    end;
  end;

  if( NeedInsert )
    v_stat = InsertGroundDocument(v_ErrStr, Id, parm);
    if( not v_DontShowError )
      v_stat = DP_ProcImpError(v_stat, v_ErrStr, "Вставка документа-основания", "документ-основание");
    end;
  end;

  SetParm(0, Id);
  SetParm(3, v_ErrStr);

  return v_stat;
end;

/* Проверить наличие сформированного поручения */
/* возврашает true - если поручение есть */
macro DP_GetDraftDate( PaymentID:integer, /*Вх. парам.  - ИД платежа по БА*/
                       RegistrDate:date,  /*Вовз. парам - дата регистрации поручения*/
                       DocumentKind,
                       DocumentID
                     )

  var IsExists, sql, rsd;

  if(ValType(DocumentKind) == V_UNDEF)
     DocumentKind = 0;
     DocumentID   = 0;
  elif(ValType(DocumentID) == V_UNDEF)
     DocumentID = 0;
  end;

  sql = " SELECT spgr.t_RegistrDate "
      +   " FROM dspdrprop_dbt prop, "
      +        " dspdraft_dbt draft, "
      +        " dspground_dbt spgr "
      + " WHERE prop.t_PaymentID = " + PaymentID
      +   " AND prop.t_DocumentKind = " + DocumentKind
      +   " AND prop.t_DocumentID = " + DocumentID
      +   " AND prop.t_IsMain = 'X' "
      +   " AND draft.t_AutoKey = prop.t_DraftID "
      +   " AND spgr.t_SPGroundID = draft.t_SPgroundID "
      +   " AND ROWNUM = 1 ";

  rsd = TRsbDataSet(sql);
  if( rsd.MoveNext() )
    RegistrDate = date(rsd.RegistrDate);
    IsExists = true;
  else
    IsExists = false;
  end;

  SetParm(1, RegistrDate);

  return IsExists;
end;

/* Получить кол-во ц/б в исполненных поручениях */
macro DP_GetDraftAmount( PaymentID:integer, DocumentKind, DocumentID) /*Вх. парам.  - ИД платежа по БА*/

  var Amount = $0, sql, rsd;

  if(ValType(DocumentKind) == V_UNDEF)
     DocumentKind = 0;
     DocumentID   = 0;
  elif(ValType(DocumentID) == V_UNDEF)
     DocumentID = 0;
  end;

  sql = " SELECT NVL(SUM(paym.t_Amount), 0) t_Amount "
      +   " FROM dspdrprop_dbt prop, "
      +        " dspdrmove_dbt move, "
      +        " dspdraft_dbt  draft, "
      +        " dpmpaym_dbt paym "
      + " WHERE prop.t_PaymentID = " + PaymentID
      +   " AND prop.t_DocumentKind = " + DocumentKind
      +   " AND prop.t_DocumentID = " + DocumentID
      +   " AND move.t_DraftID = prop.t_DraftID "
      +   " AND prop.t_DraftID = draft.t_AutoKey "
      +   " AND draft.t_Status = 3 " /*Только для исполненных поручений депо*/
      +   " AND paym.t_PaymentID = move.t_PaymentID ";

  rsd = TRsbDataSet(sql);
  if( rsd.MoveNext() )
    Amount = money(rsd.Amount);
  end;

  return Amount;
end;

macro DP_InitParmInfOpr( _DepoInfo )
  ClearRecord( _DepoInfo );

  _DepoInfo.InfoprParty = UnknownParty;
  _DepoInfo.InfoprFIID = ALLFININSTR;
  _DepoInfo.InfoprIssuer = UnknownParty;
  _DepoInfo.InfoprStoragePlaceID = UnknownParty;
  _DepoInfo.InfoprIssuerTo = UnknownParty;
  _DepoInfo.InfoprFIIDto = ALLFININSTR;
  _DepoInfo.GrDraftProxy = UnknownParty;
  _DepoInfo.GrReportPartyID = UnknownParty;
  _DepoInfo.DeponentDoc = UnknownParty;
end;

macro DP_CreateInfOperation( _DepoInfo, _CreateReport, _PrintMode, Copies )
  return CreateInfOperation( _DepoInfo, _CreateReport, _PrintMode, Copies );
end;
