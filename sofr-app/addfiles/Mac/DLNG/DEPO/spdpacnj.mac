/*
$Name:         spdpacnj.mac
$Module:       Ñ•ØÆß®‚†‡®©
$Description:  é‚Á•‚ éØ•‡†Ê®Æ≠≠Î© ¶„‡≠†´ ·Á•‚† §•ØÆ
*/
import spacform, DPInter, "adress.mac", "pt_lib.mac", SECinter, cb_sql;
import RsbDataSet;

const SC_SPDRAFT_STATUS_CLOSE = 3;
const ALG_ITEM_KIND = 3104;   /* Æ°Í•™‚, ØÆ ™Æ‚Æ‡Æ¨„ Æ·„È. ÆØ•‡†Ê®Ô*/
const DEPO_CHAPTER = 5;
const UNDEF_ID = -1;
private const ALG_DEPO_PAYMENTTYPE = 3258;

const OBJTYPE_ADMOPRTYPE = 1207; /* ‚®ØÎ †§¨®≠®·‚‡†‚®¢≠ÎÂ ÆØ•‡†Ê®© §•ØÆß®‚†‡®Ô */

var AdmTable = "⁄ƒƒƒ¬ƒƒƒƒƒ¬ƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
               "≥ ¸ ≥  ¸  ≥ äéè ≥èÆ‡„Á•≠®•       ≥éØ•‡†Ê®Ô        ≥í®Ø         ≥à§•≠‚®‰®™†‚Æ‡           ≥äÆ§ ØÆ´Ô        ≥çÆ¢Æ• ß≠†Á•≠®•     ≥ë‚†‡Æ• ß≠†Á•≠®•     ≥Æ‚Á•‚ Æ° ®·ØÆ´≠•≠®®                   ≥\n"+
               "≥Ø/Ø≥ÆØ•‡.≥     ≥§†‚† Ø‡®•¨†/¢Â.¸≥§†‚† ®·Ø./¢‡•¨Ô ≥§Æ™„¨•≠‚†   ≥                        ≥                ≥                   ≥                    ≥                                      ≥\n"+
               "√ƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n"+
               "≥ 1 ≥  2  ≥  3  ≥       4        ≥        5       ≥     6      ≥           7            ≥        8       ≥         9         ≥         10         ≥                     11               ≥\n"+
               "√ƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

var InfTable = "⁄ƒƒƒ¬ƒƒƒƒƒ¬ƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"+
               "≥ ¸ ≥  ¸  ≥ äéè ≥èÆ‡„Á•≠®•       ≥éØ•‡†Ê®Ô        ≥í®Ø Æ‚Á•‚† ØÆ ™´†··®‰®™†Ê®®        ≥é‚Á•‚≠Î© Ø•‡®Æ§      ≥à§•≠‚®‰®™†‚Æ‡Î ¨†‚•‡®†´Æ¢, ØÆ ™Æ‚Æ-≥Æ‚Á•‚ Æ° ®·ØÆ´≠•≠®® ®≠‰Æ‡¨†Ê®Æ≠≠Æ©   ≥\n"+
               "≥Ø/Ø≥ÆØ•‡.≥     ≥§†‚† Ø‡®•¨†/¢Â.¸≥§†‚† ®·Ø./¢‡•¨Ô ≥§•ØÆß®‚†‡®Ô                        ≥                     ≥‡Î¨ ¢Î§†•‚·Ô Æ‚Á•‚                 ≥ÆØ•‡†Ê®®                             ≥\n"+
               "√ƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥\n"+
               "≥ 1 ≥  2  ≥  3  ≥       4        ≥        5       ≥                 6                 ≥          7          ≥                 8                 ≥                  9                  ≥\n"+
               "√ƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

var Rep = CMakeReport();
const RepFontStyleTitel =  "ex_FS(b)";
const WIDTHTable_ = Index(AdmTable, "\n");

var printDeponentName;
var printDeponentIURISD;
var printOperatorName;
var printOperatorIURISD;
var OjdBegin, OjdEnd;/*, OperDateBegin, OperDateEnd; */

var llvl    = TBFile("llvalues");
var personF = TBFile("person");

var icount = 0, count = 0, ReleasedCount = 0;
var _LogOprID = 0,
    _BeginDate,
    _EndDate,
    _pIs_app;

var ÑëÁ•‚_arr = TARRAY;

/*§´Ô class AdmOperations*/
record depoacnt(depoacnt);

macro OperName(OperVal)
   personF.rec.oper=OperVal;
   if (personF.GetEQ)
      return personF.rec.Name;
   end;
   return UnSetName;
end;

/* äÆ§ †§¨.§•©·‚¢®Ô */
macro AdmCode(Element)
  record llvalues( "llvalues.dbt" );
  if( LL_FindLLVALUES( OBJTYPE_ADMOPRTYPE, Element, llvalues ))
    return llvalues.Code;
  end;
  return "";
end;

macro cmpAdmOpID( key, elem )
   if(key.carryDate > elem.carryDate)
     return -1;
   elif(key.carryDate < elem.carryDate)
     return 1;
   else
     if( (mkstr(" ", 20-strlen(key.AdmOpXid))+key.AdmOpXid) > (mkstr(" ", 20-strlen(elem.AdmOpXid))+elem.AdmOpXid))
       return -1;
     elif( (mkstr(" ", 20-strlen(key.AdmOpXid))+key.AdmOpXid) < (mkstr(" ", 20-strlen(elem.AdmOpXid))+elem.AdmOpXid))
       return 1;
     else
       return 0;
     end;
   end;
end;

CLASS AdmDat(_AdmOpID, _AdmOpXid, _carryDate)
  var AdmOpID = _AdmOpID, AdmOpXid = _AdmOpXid, carryDate = _carryDate;
END;

CLASS AdmOperations(__FromDate, __UptoDate, __DepoAccAK, __iDeponent, __AdmopRegDATEbegin, __AdmopRegDATEend, __DepoOpenDate, __AdmopXldMask)
   var FromDate = __FromDate,
       UptoDate = __UptoDate,
       DepoAccAK= __DepoAccAK,
       iDeponent= __iDeponent,
       AdmopRegDATEbegin = __AdmopRegDATEbegin,
       AdmopRegDATEend   = __AdmopRegDATEend,
       DepoOpenDate      = __DepoOpenDate,
       AdmopXldMask      = __AdmopXldMask,
       owner             = -1,
       DocType           = "",
       ID                = "",
       TotalRec          = -1;

   var AdmOpIDs = TArray;

   var sNAMEs = TArray;
   var sFROM  = TArray;
   var sTO    = TArray;
   var iContString = 0;

   var depoadmo   = TBFile("depoadmo", "R", 5);  /* ØÆ ·Á•‚†¨ §•ØÆ */
   var GGround    = TBFile("spground");
   var depoacnt   = TBFile("depoacnt");
   var Admop      = TBFILE("dpadmopr");
   var partcode   = TBFILE("partcode");
   var dacc       = TBFILE("depoacnt");
   var fininstr   = TBFILE("fininstr");

   macro FindGround()
      GGround.rec.SPgroundID = depoadmo.rec.Ground;
      if(GGround.GetEQ)
        return GGround.rec.Xld;
      end;
      return "";
   end;

   macro FindOpCode()
     admop.rec.Item = depoadmo.rec.Item;
     admop.rec.OperKind = depoadmo.rec.OperKind;
     if (admop.GetEQ())
       return admop.rec.Code;
     else
       return "";
     end;
   end;

   macro CheckAdmop(___depoadmorec)
      FindGround(___depoadmorec.rec.Ground);
      if((AdmopXldMask != "") and CompareStrWithMasks(AdmopXldMask, GGround.rec.Xld))
         return false;
      end;

      if( GGround.rec.RegistrDate < FromDate )
         return false;
      end;
      if( GGround.rec.RegistrDate > UptoDate )
         return false;
      end;

      if ((OjdBegin != "") AND (OjdEnd != ""))
         if ((___depoadmorec.rec.OprXid < OjdBegin) OR
             (___depoadmorec.rec.OprXid > OjdEnd))
            return false;
         end;
      end;

      if ((___depoadmorec.rec.OperDate < AdmopRegDATEbegin) OR
          (___depoadmorec.rec.OperDate > AdmopRegDATEend))
         return false;
      end;
      return true;
   end;

   macro GetDocumentType()

      if ((depoadmo.rec.Item == SPDP_CLIENT) OR
          (depoadmo.rec.Item == SPDP_GUARDIAN) OR
          (depoadmo.rec.Item == SPDP_OPERATOR) OR
          (depoadmo.rec.Item == SPDP_MANAGER) OR
          (depoadmo.rec.Item == SPDP_OURDEPOSITARY) OR
          (depoadmo.rec.Item == SPDP_STORAGEPLACE))

        DocType = "·„°Í•™‚";
        partcode.rec.PartyID = depoadmo.rec.partyID;
        partcode.rec.CodeKind = 1;
        if (NOT partcode.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ™Æ§ ·„°Í•™‚† · ID = " + depoadmo.rec.partyID, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        else
          ID = partcode.rec.Code;
        end;

      elif (depoadmo.rec.Item == SPDP_AVOIRIS)
        DocType = "Ê•≠≠†Ô °„¨†£†";
        fininstr.rec.FIID = depoadmo.rec.FIID;
        if (NOT fininstr.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠† Ê/° · ID = " + depoadmo.rec.FIID, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        else
          ID = fininstr.rec.FI_Code;
        end;

      elif ((depoadmo.rec.Item == SPDP_DEPO_ACCOUNT) OR
            (depoadmo.rec.Item == SPDP_ACCMANAGER))
        DocType = "·Á•‚ §•ØÆ";
        /* ß†Ø®·®· Ø‡Æ Ø‡†¢† ÆØ•‡†‚Æ‡†/‡†·ØÆ‡Ô§®‚•´Ô */
        /*if (depoadmo.rec.Item == SPDP_DEPO_ACCOUNT)
          TotalRec = DP_ADMDACNT_Total;
        else
          TotalRec = DP_DACMNGR_Total;
        end;*/
        dacc.rec.AutoKey = depoadmo.rec.DepoAcc;
        if (NOT dacc.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ·Á•‚ §•ØÆ · ID = " + depoadmo.rec.DepoAcc, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        else
          ID = dacc.rec.BriefCode;
        end;

      elif ((depoadmo.rec.Item == SPDP_PARTMANAGER) OR
            (depoadmo.rec.Item == SPDP_DEPO_PARTITION))
        DocType = "‡†ß§•´ ·Á•‚†";
        /* ß†Ø®·®· Ø‡Æ Ø‡†¢† ÆØ•‡†‚Æ‡†/‡†·ØÆ‡Ô§®‚•´Ô */
        /*if (depoadmo.rec.Item == SPDP_DEPO_PARTITION)
          TotalRec = DP_ADMDPART_Total;
        else
          TotalRec = DP_DPTMNGR_Total;
        end;*/
        dacc.rec.AutoKey = depoadmo.rec.DepoPart;
        if (NOT dacc.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ·Á•‚ §•ØÆ · ID = " + depoadmo.rec.DepoPart, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        else
          ID = dacc.rec.BriefCode;
        end;

      elif (depoadmo.rec.Item == SPDP_FACE_ACCOUNT)
        DocType = "´®Ê•¢Æ© ·Á•‚";
        ID = depoadmo.rec.account;
      end;

   end;

   /*ë°Æ‡ ØÆ§ÂÆ§ÔÈ®Â †§¨®≠®·‚‡†‚®¢≠ÎÂ ÆØ•‡†Ê®©*/
   macro ColectAdmOperations()
      var continue_cicle, Item;
      AdmOpIDs.size = 0;

      depoadmo.rec.DepoAcc = DepoAccAK;
      continue_cicle = depoadmo.GetEQ();
      while (continue_cicle)
         if(CheckAdmop(depoadmo))
            AdmOpIDs[AdmOpIDs.size] = AdmDat(depoadmo.rec.AdmoprID, depoadmo.rec.OprXid, depoadmo.rec.operDate);
         end;
         continue_cicle = depoadmo.Next();
         if (continue_cicle AND (depoadmo.rec.DepoAcc != DepoAccAK))
            continue_cicle = false;
         end;
      end;

      if(AdmOpIDs.size)
         qsort( AdmOpIDs, "cmpAdmOpID", 0,  AdmOpIDs.Size-1);
      end;

      return AdmOpIDs.size;
   end;

   macro First()
     if(not ColectAdmOperations())
        return false;
     end;
     depoadmo.KeyNum = 0; /*§†´•• ØÆ´Ïß„•¨·Ô AdmoprID*/

     depoadmo.rec.AdmoprID = AdmOpIDs[AdmOpIDs.Size-1].AdmOpID;
     if(GetEQ(depoadmo))
        FindGround();
        FindOpCode();
        GetDocumentType();
        AdmOpIDs.Size = AdmOpIDs.Size-1;
        return true;
     end;
     return false;
   end;

   macro Next()
     if(AdmOpIDs.Size)
        depoadmo.rec.AdmoprID = AdmOpIDs[AdmOpIDs.Size-1].AdmOpID;
        if(AdmOpIDs.Size and GetEQ(depoadmo))
           FindGround();
           FindOpCode();
           GetDocumentType();
           AdmOpIDs.Size = AdmOpIDs.Size-1;
           return true;
        end;
     end;
     return false;
   end;

   macro AdmRec()
      return depoadmo.rec;
   end;

   macro FirstContentString()
      iContString = 0;
      GetDEPOADMO_Contents(depoadmo, sNAMEs, sFROM, sTO);
      while((iContString < sNAMEs.size) and
            not (sNAMEs[iContString] and ((sFROM[iContString] != sTO[iContString]) //OR
                                          /*( iContString == TotalRec)*/)
                )
           )
         iContString = iContString + 1;
      end;
      return iContString < sNAMEs.size;
   end;

   macro NextContentString()
      iContString = iContString + 1;
      while((iContString < sNAMEs.size) and
             not (sNAMEs[iContString] and ((sFROM[iContString] != sTO[iContString]) //OR
                                          /*( iContString == TotalRec)*/)
                )
           )
         iContString = iContString + 1;
      end;
      return iContString < sNAMEs.size;
   end;

   macro CSName()
      return sNAMEs[iContString];
   end;
   macro CSFrom()
      return sFROM[iContString];
   end;
   macro CSTo()
      return sTO[iContString];
   end;

   macro ActionCaption()
      return DL_GetNameAlg(3105, depoadmo.rec.OperKind);
   end;

   macro ActionDone()
      return depoadmo.rec.OperDate;
   end;

   macro ActionExecuter()
      return OperName(depoadmo.rec.Oper);
   end;

   macro Item()
      return DL_GetNameAlg(3104, depoadmo.rec.Item); /*"·ÁÒ‚ §•ØÆ"*/
   end;

END;

CLASS InfoOperations(__FromDate, __UptoDate, _RD_begin, _RD_end, __DepoAccAK)
   var FromDate = __FromDate,
       UptoDate = __UptoDate,
       DepoAccAK= __DepoAccAK,
       RD_begin = _RD_begin,
       RD_end   = _RD_end,
       ID       = "";

   var continue_cicle;
   var splogopr;
   var spinfopr = TBFile("spinfopr");
   var spground = TBFile("spground");
   var spoper   = TBFILE("spoper");

   macro GetObject()

      var item = spoper.rec.Item;
      var obj = "", own = "";
      var depoacnt  = TBFILE("depoacnt");
      var partition = TBFILE("depoacnt");
      var account   = TBFILE("account");
      var fininstr  = TBFILE("fininstr");
      VAR RepNum    = TBFILE("spground", "r", 6);
      var query;
      var cOwner;

      RepNum.rec.SourceDocKind = SP_DEPOPER_INFOPER;
      RepNum.rec.SourceDocID   = splogopr.rec.AutoKey;
      RepNum.rec.Direction     = EXITING;
      RepNum.rec.Division      = SelfDivision;
      RepNum.GetEQ();
      ID = "≠Æ¨•‡ Æ‚Á•‚†: " + RepNum.rec.Xld + "\n";

      if (spinfopr.rec.DepoAcc > 0) /* ·Á•‚ */
        depoacnt.rec.AutoKey = spinfopr.rec.DepoAcc;
        if (NOT depoacnt.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ·Á•‚ §•ØÆ · ID = " + spinfopr.rec.DepoAcc, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        end;
      end;

      if (spinfopr.rec.DepoPart > 0) /* ‡†ß§•´ */
        partition.rec.AutoKey = spinfopr.rec.DepoPart;
        if (NOT partition.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ·Á•‚ §•ØÆ · ID = " + spinfopr.rec.DepoPart, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        end;
      end;

      if (spinfopr.rec.FIID != -1) /* îà */
        fininstr.rec.FIID = spinfopr.rec.FIID;
        if (NOT fininstr.GetEQ())
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠† Ê/° · ID = " + spinfopr.rec.FIID, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        end;
      end;

      if (spinfopr.rec.Account != "") /* ´/· */
        query =   "     t_Account = '" + spinfopr.rec.Account + "' "
               + " and t_Chapter = " + DEPO_CHAPTER;
        if (spinfopr.rec.FIID != -1)
          query = query + " and t_Code_Currency = " + spinfopr.rec.FIID;
        end;

        account.AddFilter(query);
        if(account.nrecords() <= 0 )
          DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ´/· ¸ " + spinfopr.rec.Account, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
          Rep.AddStr();
        end;
      end;

      if(item == DPINF_DACCOUNT)
        if (spinfopr.rec.DepoAcc <= 0)
          obj = "¢·•";
        else
          obj = depoacnt.rec.BriefCode;
          cOwner = CDPParty(depoacnt.rec.Owner, splogopr.rec.CarryDate);
          own = "¢´†§•´•Ê " + cOwner.ShortName() + "\n";
        end;
        ID = ID + "Æ°Ï•™‚: ·Á•‚ §•ØÆ - " + obj + "\n";
        ID = ID + "§ÆØÆ´≠®‚•´Ï≠Æ: \n";
        ID = ID + own;

      elif(item == DPINF_DPARTITION)
        if (spinfopr.rec.DepoPart <= 0)
          obj = "¢·•";
        else
          obj = partition.rec.BriefCode;
          cOwner = CDPParty(partition.rec.Owner, splogopr.rec.CarryDate);
          own = "¢´†§•´•Ê " + cOwner.ShortName() + "\n";
        end;
        ID = ID + "Æ°Ï•™‚: ‡†ß§•´ - " + obj + "\n";
        ID = ID + "§ÆØÆ´≠®‚•´Ï≠Æ: \n";
        ID = ID + own;

      elif(item == DPINF_FACCOUNT)
        if (spinfopr.rec.DepoPart == "")
          obj = "¢·•";
        else
          obj = spinfopr.rec.Account;
          cOwner = CDPParty(account.rec.Client, splogopr.rec.CarryDate);
          own = "¢´†§•´•Ê " + cOwner.ShortName() + "\n";
        end;
        ID = ID + "Æ°Í•™‚: ´/· - " + obj + "\n";
        ID = ID + "§ÆØÆ´≠®‚•´Ï≠Æ: \n";
        ID = ID + own;
      end;

      /* ·•™Ê®Ô §ÆØÆ´≠®‚•´Ï≠Æ */
      ID = ID + "·Á•‚ §•ØÆ: ";
      if (spinfopr.rec.DepoAcc > 0)
        ID = ID + depoacnt.rec.BriefCode + "\n";
      else
        ID = ID + "¢·•" + "\n";
      end;

      ID = ID + "‡†ß§•´: ";
      if (spinfopr.rec.DepoPart > 0)
        ID = ID + partition.rec.BriefCode + "\n";
      else
        ID = ID + "¢·•" + "\n";
      end;

      ID = ID + "Ê/°: ";
      if (spinfopr.rec.FIID != -1)
        ID = ID + fininstr.rec.Name + "\n";
      else
        ID = ID + "¢·•" + "\n";
      end;

      ID = ID + "™Æ§ ´/·: ";
      if (spinfopr.rec.Account != "")
        ID = ID + spinfopr.rec.Account + "\n";
      else
        ID = ID + "¢·•" + "\n";
      end;

   end;

   macro CheckItem()
      if ((spoper.rec.Item == DPINF_DACCOUNT) OR
          (spoper.rec.Item == DPINF_DPARTITION) OR
          (spoper.rec.Item == DPINF_FACCOUNT))
        return true;
      end;

      return false;
   end;

   macro isChild(_depopart, _depoacc)
     var acc = TBFILE("depoacnt");

     if (_depoacc == _depopart or ( _depopart == 0 ))
       return true;
     end;

     acc.rec.Autokey = _depopart;
     if ( acc.GetEQ() and (acc.rec.Root == _depoacc) )
       return true;
     end;

     return false;
   end;

   macro CheckInfOperation()
     var account = TBFILE("account");
     var query;

     /* Ø‡Æ¢•‡™† ‡†ß§•´† */
     if (not isChild(spinfopr.rec.DepoPart, spinfopr.rec.DepoAcc))
        return false;
     else
       return true;
     end;

     if( spinfopr.rec.Account != "" )
       query =   "     t_Account = '" + spinfopr.rec.Account + "' "
               + " and t_Chapter = " + DEPO_CHAPTER
               + " and t_DepoRoot = " + DepoAccAK;
       if (spinfopr.rec.FIID != -1)
         query = query + " and t_Code_Currency = " + spinfopr.rec.FIID;
       end;

       account.AddFilter(query);
       if(account.nrecords() > 0 )
         return true;
       end;
     else
       return true;
     end;

     return false;
   end;

   macro First()

     var query;
     ID = "";
     query =   " select * from dsplogopr_dbt "
             + " where t_CarryDate >= " + GetSQlDate(RD_begin)
             + " and t_CarryDate <= " + GetSQlDate(RD_end)
             + " and t_State = " + SC_SPDRAFT_STATUS_CLOSE
             + " and t_Draft in ( select t_SpgroundID from dspground_dbt "
             + "                  where t_RegistrDate >= " + GetSQLDate(FromDate)
             + "                    and t_RegistrDate <= " + GetSQLDate(UptoDate)
             + "                ) "
             + " and t_recId in ( select t_SpinfDocID from dspinfopr_dbt where t_docType in "
             + "                  ( select t_OperationCode from dspoper_dbt where "
             + "                       t_Item = " + DPINF_DACCOUNT
             + "                    or t_Item = " + DPINF_DPARTITION
             + "                    or t_Item = " + DPINF_FACCOUNT
             + "                  ) "
             + "                  and t_DepoAcc = " + DepoAccAK
             + "                ) ";

     /* Ø‡Æ¢•‡™† ¸ éÜÑ */
     if ((OjdBegin != "") AND (OjdEnd != ""))
        query = query +
               " and t_OprXid > '" + OjdBegin + "' ";
     end;

     query = query +
               " order by t_CarryDate, LPAD(t_OprXid, 20, ' ') ";

     splogopr = TRsbDataSet(query);//.AddFilter(query);
     while(splogopr.MoveNext() )
         spground.rec.SPgroundID = splogopr.rec.Draft;
         spground.GetEQ();
         spinfopr.rec.spinfdocID = splogopr.rec.recId;
         if( (spinfopr.GetEQ()) and ( CheckInfOperation() ) )
           /* ¢®§ ÆØ•‡†Ê®® */
           spoper.rec.operationCode  = spinfopr.rec.docType;
           spoper.GetEQ();
           if ( CheckItem() )
            GetObject();
            return true;
           end;
         end;
       end;
     return false;

   end;

   macro Next()

     ID = "";
     while(splogopr.MoveNext() )
         spground.rec.SPgroundID = splogopr.rec.Draft;
         spground.GetEQ();
         spinfopr.rec.spinfdocID = splogopr.rec.recId;
         if( spinfopr.GetEQ() and (spinfopr.rec.DepoAcc == DepoAccAK))
           /* ¢®§ ÆØ•‡†Ê®® */
           spoper.rec.operationCode  = spinfopr.rec.docType;
           spoper.GetEQ();
           if ( CheckItem() )
            GetObject();
            return true;
           end;
         end;
     end;
     return false;

   end;

  macro Oper()
     return splogopr.rec.oper;
  end;

  macro Rec()
    return spground.rec;
  end;

  macro LogoprRec()
    return splogopr.rec;
  end;

  macro InfoprRec()
    return spinfopr.rec;
  end;

  macro SpoperRec()
    return spoper.rec;
  end;

END;

CLASS ExecuterInfo(OperVal)
   var Name, Post;
   var person = TBFile("person");
   var TypeAc = TBFile("typeac");
  /*à·ØÆ´≠®‚•´Ï (ÆØ•‡)*/
   /*à¨Ô*/
   person.rec.oper=OperVal;
   if (person.GetEQ)
      Name = person.rec.Name;
   else
      Name = UnSetName;
   end;
   /*ÑÆ´¶≠Æ·‚Ï*/
   TypeAc.rec.iNumType = 13;
   TypeAc.rec.Type_Account = person.rec.cTypePerson;
   if(TypeAc.GetEQ)
     Post = TypeAc.rec.Name_Type;
   else
     Post = "Æ‚¢. ‡†°Æ‚≠®™ §•ØÆß®‚†‡®Ô";
   end;
END;

macro GetSettaccOwnerStr(DeponentID)
   var Settacc;// = TBFile("settacc");
   var query;
   var ëÁ•‚ = "";

   var FIID;
   var NominalFICode;
   var NominalFIIDName;
   var BankCorrID;
   var BankCorrBIG = "";
   var CorrAcc; //äÆ‡·Á•‚
   var BankID;//≠†®¨•≠Æ¢†≠®• °†≠™†
   var BankBIG = "";
   var Account;//·Á•‚

   macro AddressParty(ID)
     record RecordAdress ( adress );
     var PARTY;
     var address = "-";

     query = "select t_PartyID from dparty_dbt";
     PARTY = TRsbDataSet(query);
     if( PARTY.MoveNext() )
       if(ç†©‚®û‡®§®Á•·™®©Ä§‡•·ë„°Í•™‚†(party.PartyID,RecordAdress))
         address = RecordAdress.Adress;
       end;
     else
       MsgBox("ç• ≠†©§•≠ §•ØÆß®‚†‡®©");
     end;

     return address;
   end;
   ÑëÁ•‚_arr.Size = 0;
    //≠†©§•¨ ëèà, Ø‡®¢Ôß†≠≠Î• ™ §•ØÆ≠•≠‚„
   query =   " select sett.t_FIID, sett.t_BankCorrID, sett.t_CorrAcc, sett.t_BankID, sett.t_Account "
           + " from dsettacc_dbt sett, dpmautoac_dbt pm"
           + " where sett.t_FIKind = " + FIKIND_CURRENCY
           + "   and sett.t_PartyID = " + DeponentID
           + "   and sett.t_FIID > -1"
           + "   and sett.t_SettAccID = pm.t_SettAccID";
   Settacc = TRsbDataSet(query);
   while( Settacc.MoveNext() )
     FIID = Settacc.FIID;
     BankCorrID = Settacc.BankCorrID;
     CorrAcc = Settacc.CorrAcc;
     if( CodeFor(CorrAcc) == 1)
       CorrAcc = "-";
     end;
     BankID  = Settacc.BankID;
     Account = Settacc.Account;
     NominalFICode   = èÆ´„Á®‚ÏäÆ§î®≠à≠(FIID);
     NominalFIIDName = FinInName(FIID);

     BankCorrBIG = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(BankCorrID, PTCK_BIC);
     BankBIG     = èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(BankID, PTCK_BIC);
     ëÁ•‚ = "";
     ëÁ•‚ = NominalFICode+" ("+NominalFIIDName+") ";
     ëÁ•‚ = " ‡/· " + Account + "  "+ëÁ•‚ + ", ¢ °†≠™• " + NameParty(BankID)  + ", " +
            AddressParty(BankID) + ", Åàä " + BankBIG + " ™/· " + CorrAcc + " ¢ " +
            NameParty(BankCorrID) + ", Åàä " + BankCorrBIG;
     ÑëÁ•‚_arr[ÑëÁ•‚_arr.size] = ëÁ•‚;
   end;
   if( not ÑëÁ•‚_arr.size )
     ÑëÁ•‚_arr[ÑëÁ•‚_arr.size] = "-";
   end;

end;

private macro GetReportStr(SourceDocKind, SourceDocID)
   file typeac("typeac");
   var Report = "";
   var DataSet;
   var select = RSDCommand("select rep.t_RecipientName, rep.t_DeliveryKind, spgr.t_Xld, spgr.t_SignedDate, spgr.t_RegistrDate, spgr.t_Sent " +
                            " from ddpgrrep_dbt rep, ddprepdoc_dbt repdoc, dspground_dbt spgr " +
                            "where rep.t_SourceDocKind = ? " +
                            "  and rep.t_SourceDocID = ? " +
                            "  and repdoc.t_GrRepID = rep.t_ID " +
                            "  and spgr.t_SPgroundID = repdoc.t_RepSPgroundID "
                          );

   select.addParam( "", RSDBP_IN, SourceDocKind );
   select.addParam( "", RSDBP_IN, SourceDocID );
   select.execute();

   DataSet = TRsbDataSet(select);
   while(DataSet.moveNext())
     if(Report)
       Report = Report + "\n";
     end;

     Report = Report + "¸ " + DataSet.Xld + ", ·Æ·‚†¢´•≠ " + DateToStr(date(DataSet.SignedDate), true);
     if( DataSet.Sent == "X" )
       Report = Report + ", Æ‚Æ·´†≠ " + DataSet.RecipientName + ", " + DateToStr(date(DataSet.RegistrDate), true);
       typeac.iNumType = TA_STAT_DEL;
       typeac.Type_Account = StrFor(DataSet.DeliveryKind);
       if( getEQ(typeac) )
         Report = Report +  ", " + typeac.Name_Type;
       end;
     end;
   end;

   return Report;

end;

private macro GetSecurList(RegisterID)
  var query;
  var Select;
  var DataSet;
  var sec_list = "";

  query = " select fi.t_Name t_FIName, Decode(avr.t_LSIN, chr(1), avr.t_ISIN, avr.t_LSIN) t_LSIN " +
          " from ddppmfi_dbt pmfi, dfininstr_dbt fi, davoiriss_dbt avr " +
          " where pmfi.t_RegisterID = ? /*1*/ " +
          " AND fi.t_FIID = pmfi.t_FIID " +
          " AND avr.t_FIID = fi.t_FIID ";

  Select = RSDCommand( query );

  Select.AddParam("RegisterID", RSDBP_IN, RegisterID );  /*1*/

  Select.Execute();

  DataSet = TRsbDataSet(Select);

  while(DataSet.moveNext())
    sec_list = sec_list + "\nÊ/°: " + string(DataSet.FIName) + ", " + string(DataSet.LSIN);
  end;

  return sec_list;
end;

/*****************************************************************************/
macro ÇÎØ®·™†éØ•‡Ü„‡≠†´†ëÁ•‚†Ñ•ØÆ(iCount, iDepoAcc, AdmopXldMask, FromDate, UptoDate, DepoAccAK,
                                  iDeponent, AdmopRegDATEbegin, AdmopRegDATEend)
   var i = 1, j, continue_cicle, n=0, t = 0;
   var date_beg, date_end;
   var reporter, Receptionist;
   var CorespAcc;
   var DepoAcc;
   var AdmOprtn;
   var InfoOprtn;
   var acc = TBFILE("depoacnt");
   var ground = TBFILE("spground");
   var stat = 0, é·≠Æ¢†≠®• = "-";
   var isADM = false, isINF = false;
   var ADM_OP, INF_OP, query;
   var Format;
   var Select;
   var DataSet;
   var Securities, OperInfo;
   var cDeponent, cOperator, cIssuer, cCurator;
   var WarrantNum = "", WarrantDate = "", WarrantStr = "", SingleFIID = -1;

   if( (_BeginDate != date(0,0,0)) AND (_EndDate != date(0,0,0)) )
      date_beg = _BeginDate;
      date_end = _EndDate;
   else
      date_beg = AdmopRegDATEbegin;
      date_end = AdmopRegDATEend;
   end;

   DepoAcc = DepoInfo(DepoAccAK, date_end);

   //Ø‡Æ¢•‡®¨, •·‚Ï ´® ÂÆ‚Ï Æ§≠† Äé
   query =   " select count( t_AdmoprID ) as count from ddepoadmo_dbt "
           + " where t_OperDate >= " + GetSQLDate(AdmopRegDATEbegin)
           + "   and t_OperDate <= " + GetSQLDate(AdmopRegDATEend)
           + "   and ( t_DepoAcc = "+DepoAcc.AutoKey+" )";

   ADM_OP = TRsbDataSet(query);
   if( (ADM_OP.MoveNext()) and (ADM_OP.count > 0) )
      isADM = true;
      AdmOprtn = AdmOperations(FromDate, UptoDate, DepoAccAK, iDeponent, AdmopRegDATEbegin, AdmopRegDATEend, DepoAcc.OpenDate, AdmopXldMask);
   end;
   CLOSE(ADM_OP);

   //Ø‡Æ¢•‡®¨, •·‚Ï ´® ÂÆ‚Ï Æ§≠† ®≠‰. ÆØ. ¢ ß†™‡Î‚ÎÂ
   query =     " select count( t_AutoKey ) as count from dsplogopr_dbt "
             + " where t_CarryDate >= " + GetSQlDate(AdmopRegDATEbegin)
             + " and t_CarryDate <= " + GetSQlDate(AdmopRegDATEend)
             + " and t_State = " + SC_SPDRAFT_STATUS_CLOSE
             + " and t_Draft in ( select t_SpgroundID from dspground_dbt "
             + "                  where t_RegistrDate >= " + GetSQLDate(FromDate)
             + "                    and t_RegistrDate <= " + GetSQLDate(UptoDate)
             + "                ) "
             + " and t_recId in ( select t_SpinfDocID from dspinfopr_dbt where t_docType in "
             + "                  ( select t_OperationCode from dspoper_dbt where "
             + "                       t_Item = " + DPINF_DACCOUNT
             + "                    or t_Item = " + DPINF_DPARTITION
             + "                    or t_Item = " + DPINF_FACCOUNT
             + "                  ) "
             + "                  and  t_DepoAcc = " + DepoAcc.AutoKey
             + "                ) ";
   INF_OP = TRsbDataSet(query);
   if( (INF_OP.MoveNext()) and (INF_OP.count > 0) )
      isINF = true;
      InfoOprtn = InfoOperations(FromDate, UptoDate, AdmopRegDATEbegin, AdmopRegDATEend, DepoAccAK);
   end;
   CLOSE(INF_OP);

   /* •·‚Ï ´® ÂÆ‚Ï 1 Äé */
   if ( isADM )
      isADM = AdmOprtn.First()
   end;
   /* •·‚Ï ´® ÂÆ‚Ï 1 àé */
   if ( isINF )
      isINF = InfoOprtn.First()
   end;

   if( iCount > 1 )
     DP_AddPrintCell( Rep, "-------------------------------------------------------------------------------", 100, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
     Rep.AddStr();
     Rep.AddEmptyStr();
   end;

   if( iDepoAcc <= 0 )
     DP_StdHeaderLO_Ex( Rep, RepFontStyleTitel, "éØ•‡†Ê®Æ≠≠Î© ¶„‡≠†´ ·Á•‚† ÑÖèé", _LogOprID, iCount, true, date_beg, date_end, WIDTHTable_ );
   else
     DP_StdHeaderLO_Ex( Rep, RepFontStyleTitel, "éØ•‡†Ê®Æ≠≠Î© ¶„‡≠†´ ·Á•‚† ÑÖèé", _LogOprID, iCount, false, date_beg, date_end, WIDTHTable_ );
   end;

   DP_AddPrintCell( Rep, "     ·Á•‚ §•ØÆ", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, DepoAcc.Code, WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   DP_AddPrintCell( Rep, "     ≠†®¨•≠Æ¢†≠®• ·ÁÒ‚†", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, DepoAcc.Name, WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   DP_AddPrintCell( Rep, "     ¢®§ ·Á•‚†", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, DepoAcc.DepoKind, 17, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, " ‚®Ø ·Á•‚†:  ", 13, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, DepoAcc.DepoTypeName, 50, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   DP_AddPrintCell( Rep, "     §†‚† Æ‚™‡Î‚®Ô", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, DepoAcc.OpenDate,WIDTHTable_-28, 0, "l:f:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   DP_AddPrintCell( Rep, "     ·‚†‚„·", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   DP_AddPrintCell( Rep, DepoAcc.StatusName,WIDTHTable_-28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   DP_AddPrintCell( Rep, "-------------------------------------------------------------------------------", WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   Rep.AddEmptyStr();
   if(printDeponentName)
      DP_AddPrintCell( Rep, " Ç´†§•´•Ê ·Á•‚† §•ØÆ:", 50, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      Rep.AddStr();
      DP_AddPrintCell( Rep, "     ç†®¨•≠Æ¢†≠®•", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      DP_AddPrintCell( Rep, DepoAcc.DeponentName, WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      Rep.AddStr();
      DP_AddPrintCell( Rep, "     àçç", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      DP_AddPrintCell( Rep, DepoAcc.DeponentINN, WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      Rep.AddStr();

      cDeponent = CDPParty( DepoAcc.DeponentID, date_end );
      if(printDeponentIURISD)
         if(cDeponent.PaperKind() >= 0 )
           Rep.AddPrintCell( "     §Æ™„¨•≠‚:", 28, 0, "l:" + RepFontStyleTitel, REP_ELEM_STR );
           Rep.AddPrintCell( cDeponent.PaperKindName() + " ·•‡®Ô: " + cDeponent.PaperSeries() + " ¸: " +
                             cDeponent.PaperNumber() + " ¢Î§†≠: " +
                             date_as_string(1, date(cDeponent.PaperIssuedDate())) + " " + cDeponent.PaperIssuerName(),
                             WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, REP_ELEM_STR );
           Rep.AddStr();
         end;

         DP_AddPrintCell( Rep, "     û‡®·§®™Ê®Ô", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
         DP_AddPrintCell( Rep, DepoAcc.Nationality, WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
         Rep.AddStr();
      end;
   end;

   acc.rec.AutoKey = DepoAccAK;
   if ( not acc.GetEQ() )
     DP_AddPrintCell( Rep, "ç• ≠†©§•≠ ·Á•‚ §•ØÆ · ID = " + DepoAccAK, WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
     Rep.AddStr();
   else
     /*ground.rec.SPgroundID = acc.rec.OperGround;
     if (ground.GetEQ())
       é·≠Æ¢†≠®• = "§Æ¢•‡•≠≠Æ·‚Ï ¸" + ground.rec.Xld + " Æ‚ " + string(ground.rec.RegistrDate:f);
     end;*/
   end;

   if(printOperatorName)
     var cmd, q, DataCurator;
     var country = TBFile("country",NULL,2,NULL,"rsrfdb.def");
     var Nation = "";

     q =   " select ag.t_APartyID, NVL((select pr.t_SPgroundID from ddpprocur_dbt pr where pr.t_ProcurID = ag.t_APartyGround), 0) as SPgroundID"
         + "   from ddpacap_dbt ag "
         + "  where ag.t_ApNodeID = ? "
         + "    and ag.t_Role = " + DEPOACAPROLE_CURATOR
         + "    and ag.t_FromDate <= ? "
         + "    and (ag.t_ToDate = "+GetSQLDate(date(0,0,0))+" or ag.t_ToDate > ? )";
     cmd = DL_RSDCommand(q);
     cmd.AddParam(acc.rec.Root);
     cmd.AddParam(date_end);
     cmd.AddParam(date_end);

     DataCurator = cmd.Execute();
     while(DataCurator.moveNext())
       cCurator = CDPParty( DataCurator.APartyID, date_end );

       Rep.AddEmptyStr();
       DP_AddPrintCell( Rep, " èÆØ•Á®‚•´Ï ·Á•‚† §•ØÆ:", WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
       Rep.AddStr();
       DP_AddPrintCell( Rep, "     ç†®¨•≠Æ¢†≠®•", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
       DP_AddPrintCell( Rep, cCurator.Name(), WIDTHTable_-28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
       Rep.AddStr();
       DP_AddPrintCell( Rep, "     àçç", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
       DP_AddPrintCell( Rep, cCurator.CodeINN(), WIDTHTable_-28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
       Rep.AddStr();

       if(printOperatorIURISD)
         if(cCurator.PaperKind() >= 0 )
            DP_AddPrintCell( Rep, "     §Æ™„¨•≠‚:", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
            DP_AddPrintCell( Rep, cCurator.PaperKindName() + " ·•‡®Ô: " + cCurator.PaperSeries() + " ¸: " +
                              cCurator.PaperNumber() + " ¢Î§†≠: " +
                              date_as_string(1, date(cCurator.PaperIssuedDate())) +
                              " " + cCurator.PaperIssuerName(),
                              WIDTHTable_-28, 0, "l:w:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
            Rep.AddStr();
         end;

         Nation = "";
         if(cCurator.NotResident() == SET_CHAR)
           country.rec.CodeLat3 = cCurator.NRCountry();
           if(country.GetEQ)
             Nation = country.rec.Name;
           end;
         else
           Nation = "êÆ··®©·™†Ô î•§•‡†Ê®Ô";
         end;

         DP_AddPrintCell( Rep, "     û‡®·§®™Ê®Ô", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
         DP_AddPrintCell( Rep, Nation, WIDTHTable_-28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
         Rep.AddStr();

         é·≠Æ¢†≠®• =  "";
         if(DataCurator.SPgroundID)
           ground.rec.SPgroundID = DataCurator.SPgroundID;
           if (ground.GetEQ())
             é·≠Æ¢†≠®• = "§Æ¢•‡•≠≠Æ·‚Ï ¸" + ground.rec.Xld + " Æ‚ " + string(ground.rec.RegistrDate:f);
           end;
         end;

         DP_AddPrintCell( Rep, "     ÑÆ™„¨•≠‚ - Æ·≠Æ¢†≠®•", 28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
         DP_AddPrintCell( Rep, é·≠Æ¢†≠®•, WIDTHTable_-28, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
         Rep.AddStr();
       end;
     end;

   end;

   DP_AddPrintCell( Rep, "-------------------------------------------------------------------------------", WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddStr();
   Rep.AddEmptyStr();

   if(isADM)
      DP_AddPrintCell( Rep, "     ÄÑåàçàëíêÄíàÇçõÖ éèÖêÄñàà", WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      Rep.AddStr();
      Rep.AutoScan( "[\n" + AdmTable + "]" );
      continue_cicle = true;
   end;

   while(continue_cicle)
      stat = AdmOprtn.FirstContentString();
      if((i-1) == 0)
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;

      if (stat)
         DP_AddPrintCell( Rep, i, 3, 0, "c:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.AdmRec.OprXid, 5, 0, "c:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmCode(AdmOprtn.Admop.rec.OperType), 5, 0, "c:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, string(AdmOprtn.GGround.rec.RegistrDate:f) + " " + string(AdmOprtn.GGround.rec.Xld), 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, string(AdmOprtn.AdmRec.OperDate:f) + " " + string(SPTimeSplit(AdmOprtn.AdmRec.OperTime)), 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.DocType, 12, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.ID, 24, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.CSName, 16, 0, "l:w:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.CSTo, 19, 0, "l:w:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.CSFrom, 20, 0, "l:w:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, GetReportStr(825, AdmOprtn.depoadmo.rec.AdmoprID), 38, 0, "l:w:" + Format + RepFontStyleTitel );
         Rep.AddStr();
         Format ="";
      else
         DP_AddPrintCell( Rep, i, 3, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.AdmRec.OprXid, 5, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmCode(AdmOprtn.Admop.rec.OperType), 5, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, string(AdmOprtn.GGround.rec.RegistrDate:f) + " " + string(AdmOprtn.GGround.rec.Xld), 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, string(AdmOprtn.AdmRec.OperDate:f) + " " + string(SPTimeSplit(AdmOprtn.AdmRec.OperTime)), 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.DocType, 12, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.ID, 24, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 19, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 20, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, GetReportStr(825, AdmOprtn.depoadmo.rec.AdmoprID), 38, 0, "l:w:" + Format + RepFontStyleTitel );
         Rep.AddStr();
         Format ="";
      end;

      while (stat)
         stat = AdmOprtn.NextContentString();
         if (stat)
         DP_AddPrintCell( Rep, "", 3, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 5, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 5, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 16, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 12, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 24, 0, "l:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.CSName, 16, 0, "l:w:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.CSTo, 19, 0, "l:w:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, AdmOprtn.CSFrom, 20, 0, "l:w:" + Format + RepFontStyleTitel );
         DP_AddPrintCell( Rep, "", 38, 0, "l:" + Format + RepFontStyleTitel );
         Rep.AddStr();
         Format ="";
         end; /* if */
      end; /* while (stat)*/
      continue_cicle = AdmOprtn.Next();
      i = i + 1;
   end; /* while (continue_cicle) */

   if(isINF)
     continue_cicle = true;
      Rep.AddEmptyStr();
      DP_AddPrintCell( Rep, "     àçîéêåÄñàéççõÖ éèÖêÄñàà", WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
      Rep.AddStr();
      Rep.AutoScan( "[\n" + InfTable + "]" );
   else
     continue_cicle = false;
   end;
   j = 0;
   while (continue_cicle)
      if(j == 0)
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;

      DP_AddPrintCell( Rep, i, 3, 0, "l:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, InfoOprtn.LogoprRec.OprXid, 5, 0, "l:" + Format + RepFontStyleTitel );
      DP_AddPrintCell( Rep, "9999", 5, 0, "l:" + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DateToStr(date(InfoOprtn.Rec.RegistrDate:l)) + " " + InfoOprtn.Rec.Xld, 16, 0, "l:" + Format + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DateToStr(date(InfoOprtn.LogoprRec.CarryDate:l)) + " " + SPTimeSplit(time(InfoOprtn.LogoprRec.CarryTime)), 16, 0, "l:" + Format + RepFontStyleTitel );
      DP_AddPrintCell( Rep, InfoOprtn.SpoperRec.OperationName, 35, 0, "l:w:" + Format + RepFontStyleTitel );
      DP_AddPrintCell( Rep, DateToStr(InfoOprtn.InfoprRec.FromDate, true) + "-" + DateToStr(InfoOprtn.InfoprRec.ToDate, true), 21, 0, "l:" + Format + RepFontStyleTitel );
      DP_AddPrintCell( Rep, InfoOprtn.ID, 35, 0, "l:w:" + Format + RepFontStyleTitel );
      DP_AddPrintCell( Rep, GetReportStr(830, InfoOprtn.splogopr.rec.AutoKey), 37, 0, "l:w:" + Format + RepFontStyleTitel );
      Rep.AddStr();
      Format ="";
      i = i + 1;
      j = j + 1;
      continue_cicle = InfoOprtn.Next();
   end;

   // ëê
   query = " SELECT reg.t_RegisterID t_RegisterID, " +
           "        reg.t_CreationDate t_CreationDate, " +
           "        reg.t_CreationTime t_CreationTime, " +
           "        reg.t_Date t_Date, " +
           "        Decode(crp.t_DocKind, 852, 'äÆ≠¢•‡‚†Ê®Ô', " +
           "                              854, 'èÆ£†Ë•≠®•', " +
           "                              856, 'ÅÆ≠„·≠†Ô Ì¨®··®Ô', " +
           "                              870, 'ç†Á®·´•≠®• §ÆÂÆ§Æ¢', chr(1) ) t_TypeOperation, " +
           "        NVL(na.t_sznameAlg, CHR(1)) t_PaymentTypeName, " +
           "        crp.t_DocumentID, crp.t_WarrantNum, crp.t_PaymentType, " +
           "        reg.t_Issuer t_Issuer " +
           " FROM ddpreglin_dbt lin, ddpregstr_dbt reg, ddpcorpop_dbt crp, dnamealg_dbt na " +
           " WHERE lin.t_Type = " + DP_REGLINETYPE_DEPOACC +
           "   AND lin.t_HolderAccID = ? /*1*/ " +
           "   AND reg.t_RegisterID = lin.t_registerID " +
           "   AND reg.t_CreationDate >= " + GetSQlDate(AdmopRegDATEbegin) +
           "   AND reg.t_CreationDate <= " + GetSQlDate(AdmopRegDATEend) +
           "   AND ( TO_DATE('01.01.0001', 'DD.MM.YYYY') >= " + GetSQLDate(FromDate) +
           "         OR TO_DATE('01.01.0001', 'DD.MM.YYYY') <= " + GetSQLDate(UptoDate) + " ) " +
           "   AND ( CHR(1) = " + GetSQLString(OjdBegin) +
           "         OR CHR(1) = " + GetSQLString(OjdEnd) + " ) " +
           "   AND crp.t_DocumentID(+) = reg.t_DocumentID " +
           "   AND na.t_iTypeAlg(+) = " + ALG_DEPO_PAYMENTTYPE +
           "   AND na.t_iNumberAlg(+) = crp.t_PaymentType " +
           " ORDER BY reg.t_CreationDate, LPAD(reg.t_Number, 20, ' ') ";

   Select = RSDCommand( query );

   Select.AddParam("DepoAccID", RSDBP_IN, DepoAcc.AutoKey );  /*1*/

   Select.Execute();

   DataSet = TRsbDataSet(Select);

   stat = DataSet.moveNext();
   if(stat AND NOT isINF)
     Rep.AddEmptyStr();
     DP_AddPrintCell( Rep, "     àçîéêåÄñàéççõÖ éèÖêÄñàà", WIDTHTable_, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
     Rep.AddStr();
     Rep.AutoScan( "[\n" + InfTable + "]" );
   end;
   while(stat)
     DP_AddPrintCell( Rep, i, 3, 0, "l:" + RepFontStyleTitel );
     DP_AddPrintCell( Rep, "", 5, 0, "l:" + RepFontStyleTitel );
     DP_AddPrintCell( Rep, "", 5, 0, "l:" + RepFontStyleTitel );
     DP_AddPrintCell( Rep, "", 16, 0, "l:" + Format + RepFontStyleTitel );
     DP_AddPrintCell( Rep, DateToStr(date(DataSet.CreationDate:l)) + " " + SPTimeSplit(time(DataSet.CreationTime)), 16, 0, "l:" + Format + RepFontStyleTitel );
     DP_AddPrintCell( Rep, "ê••·‚‡ ¢´†§•´ÏÊ•¢", 35, 0, "l:w:" + RepFontStyleTitel );
     DP_AddPrintCell( Rep, DateToStr(date(DataSet.Date), true), 21, 0, "l:" + Format + RepFontStyleTitel );

     Securities = GetSecurList(DataSet.RegisterID);
     cIssuer = CDPParty(DataSet.Issuer, date(DataSet.Date));
     DP_AddPrintCell( Rep, "Ì¨®‚•≠‚: " + cIssuer.ShortName() + Securities, 35, 0, "l:w:" + Format + RepFontStyleTitel );

     if(string(DataSet.TypeOperation) != "")
       OperInfo = "‚®Ø ÆØ•‡†Ê®®: " + string(DataSet.TypeOperation);
       if(string(DataSet.TypeOperation) == "ç†Á®·´•≠®• §ÆÂÆ§Æ¢")

         SingleFIID = DP_GetSingleCorpFIID(DataSet.DocumentID);

         WarrantNum  = DataSet.WarrantNum;
         WarrantDate = DP_GetFIWarntDate(SingleFIID, WarrantNum, DataSet.PaymentType);
         WarrantStr  = WarrantNum;

         if(WarrantDate == date(0,0,0))
           WarrantDate = "";
         else
           WarrantDate = string(WarrantDate:f);
           if(WarrantStr == "")
             WarrantStr  = WarrantDate;
           else
             WarrantStr  = WarrantDate + "/" + WarrantStr;
           end;
         end;

         OperInfo = OperInfo + "\n‚®Ø ¢ÎØ´†‚: " + string(DataSet.PaymentTypeName) + " " + WarrantStr;
       end;
     else
       OperInfo = "";
     end;

     DP_AddPrintCell( Rep, OperInfo, 37, 0, "l:w:" + Format + RepFontStyleTitel );
     Rep.AddStr();
     i = i + 1;
     stat = DataSet.moveNext();
   end;

   Rep.AddEmptyStr();
   DP_StdFooter_Ex(Rep, RepFontStyleTitel, NULL, NULL, WIDTHTable_);
   Rep.AddEmptyStr();
   return 0;
end;

private macro CreateEmptyRep()
   DP_StdHeaderLO_Ex( Rep, RepFontStyleTitel, "éØ•‡†Ê®Æ≠≠Î© ¶„‡≠†´ ·Á•‚† ÑÖèé", _LogOprID, 0, false, _BeginDate, _EndDate, WIDTHTable_ );
   Rep.AddEmptyStr();
   DP_AddPrintCell( Rep, "ç•‚ §†≠≠ÎÂ, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†.", 100, 0, "l:" + RepFontStyleTitel, _pIs_app, REP_ELEM_STR );
   Rep.AddEmptyStr();
   DP_StdFooter_Ex(Rep, RepFontStyleTitel, NULL, NULL, WIDTHTable_);
end;

macro AcnDepoJournal (
                     LogOprID        : integer,
                     iDepartment     : integer,
                     iDepoAcc        : integer,
                     iDeponent       : integer,
                     BeginDate       : date,
                     EndDate         : date,
                     OpStatusBegin   : date,
                     OpStatusEnd     : date,
                     OjdNumBegin     : string,
                     OjdNumEnd       : string,
                     pInDate         : bool,
                     pExDate         : bool,
                     pOjd            : bool,
                     pDeponent       : bool,
                     pDepoAcc        : bool,
                     pDeponentName   : bool,
                     pDeponentIURISD : bool,
                     pOperatorName   : bool,
                     pOperatorIURISD : bool,
                     ToExcel         : bool,
                     pIs_app         : bool
                     )

   var AdmopXldMask  = "";
   var dacnt;
   var sQuery = "";
   var nrec = 0;
   var stat = 0;
   var Progress = CProgressBar;

   _LogOprID = LogOprID;
   _BeginDate          = OpStatusBegin; // £´Æ°†´Ï≠Î• §´Ô ¢ÎØ„·™† Ø„·‚Æ£Æ Æ‚Á•‚†
   _EndDate            = OpStatusEnd;

   printDeponentName   = pDeponentName;
   printDeponentIURISD = pDeponentIURISD;
   printOperatorName   = pOperatorName;
   printOperatorIURISD = pOperatorIURISD;
   OjdBegin            = OjdNumBegin;
   OjdEnd              = OjdNumEnd;
   _pIs_app            = pIs_app;

   DP_BeginProtocol();  //≠†Á†‚Ï Ø‡Æ‚Æ™Æ´®‡Æ¢†≠®• - ØÆ§¨•≠† MsgBox

   if(EndDate == date(0,0,0))
     EndDate = date(31,12,9999);
   end;

   sQuery =   " select distinct acnt.t_Owner, acnt.t_AutoKey from ddepoacnt_dbt acnt"
            + " where acnt.t_Superior = 0 "
            + "   and acnt.t_Department = " + iDepartment;
   /*ØÆ ¢·•¨ ·Á•‚†¨ ® ¢·•¨ §•ØÆ≠•≠‚†¨*/
   if(iDeponent != UNDEF_ID )
     sQuery = sQuery + " and acnt.t_Owner = " + iDeponent;
   end;
   if( iDepoAcc > 0 )
     sQuery = sQuery + " and acnt.t_AutoKey = " + iDepoAcc;
   end;

   dacnt = TRsbDataSet( sQuery, RSDVAL_CLIENT, RSDVAL_STATIC);
   dacnt.MoveLast();
   nrec = dacnt.GetRecCount();
   CLOSE( dacnt );
   dacnt = TRsbDataSet( sQuery );
   Progress.Init( nrec, "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚†", "éØ•‡†Ê®Æ≠≠Î© ¶„‡≠†´ ·Á•‚† ÑÖèé" );
   while( dacnt.MoveNext() )

     if( NOT ÇÎØ®·™†éØ•‡Ü„‡≠†´†ëÁ•‚†Ñ•ØÆ(ReleasedCount + 1, iDepoAcc, AdmopXldMask, BeginDate, EndDate, dacnt.rec.AutoKey,
                                          dacnt.rec.Owner, OpStatusBegin, OpStatusEnd)
        )
        ReleasedCount = ReleasedCount + 1;
     end;
     icount = Progress.Use();
   end;

   Progress.Remove();

   DP_AddProtocol(Rep, "protocol");  //§Æ°†¢®¨ Ø‡Æ‚Æ™Æ´ ™ „¶• ·‰Æ‡¨®‡Æ¢†≠≠Æ¨„ Æ‚Á•‚„
   DP_EndProtocol();                         //ß†™Æ≠Á®‚Ï Ø‡Æ‚Æ™Æ´®‡Æ¢†≠®•
   return DP_StdReportControl( _LogOprID, ReleasedCount, @CreateEmptyRep, 0, ToExcel, Rep, ZOOM_TYPE_A4L, NULL, NULL, "spdpacnj" );
end;
