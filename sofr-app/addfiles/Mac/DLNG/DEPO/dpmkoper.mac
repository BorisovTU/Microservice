/*
$Name:         dpmkoper.mac
$Module:       „¥¯®§¨â à¨©
$Description:  Žâç¥â ® á®¢¥àè¥­­ëå ®¯¥à æ¨ïå §  ¯¥à¨®¤
*/
import FIInter, RsbDataSet, "dprepsec.mac", "dlcnst.inc";

private const SIDEBALANCE_ACTIVE = 1;

private var NameJrn = "Žâç¥â \"Žâç¥â ® á®¢¥àè¥­­ëå ®¯¥à æ¨ïå\".";

private var HeaderStr = "Ž ’ — … ’   Ž   ‘ Ž ‚ …  ˜ …   › •   Ž  …  € – ˆ Ÿ •";

private var _BeginDate,
            _EndDate,  
            _Deponent,
            _iDepoAcc,
            _iDepoPart,
            _Issuer,   
            _AvrKind,  
            _iFI,       
            _DispPart,
            _OnlyWTrans,
            _Is_Ap,     
            _LOAutoKey,
            _ToExcel,
            _NumDprt;
            
            
PRIVATE VAR EmptyDataStr  = "###################################################################\n\n";
PRIVATE VAR NotOperStr    = "###################################################################\n\n";

private var FITableHead=  "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
                          "³                      ³                                 ³ Žáâ â®ª – ¯® à §¤¥«ã      ³  Žáâ â®ª – ¯® áçñâã ¤¥¯®   ³\n" +
                          "³                      ³                                 ³                            ³                             ³\n" +
                          "³   ƒ®áã¤ àáâ¢¥­­ë©    ³        ¨¬¥­®¢ ­¨¥ ¢ë¯ãáª       ³                            ³                             ³\n" +
                          "³   à¥£¨áâà æ¨®­­ë©    ³           æ¥­­ëå ¡ã¬ £          ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n" +
                          "³    ­®¬¥à ¢ë¯ãáª      ³                                 ³  ­  ­ ç «®  ³  ­  ª®­¥æ    ³ ­  ­ ç «®    ³   ­  ª®­¥æ   ³\n" +
                          "³                      ³                                 ³   ¯¥à¨®¤    ³   ¯¥à¨®¤     ³  ¯¥à¨®¤      ³    ¯¥à¨®¤    ³\n" +
                          "³                      ³                                 ³             ³              ³              ³              ³\n" +
                          "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´"; 
                                                                                                                          
private var OprTableHead= "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
                          "³       Ž¯¥à æ¨¨       ³          „ â  ®¯¥à æ¨¨          ³Š®«¨ç¥áâ¢® æ¡³ ’¨¯ ®¯¥à æ¨¨ ³  Žá­®¢ ­¨¥(¤ â /ü¯®àãç¥­¨ï) ³\n" +
                          "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´"; 

private var tablewidth = Index(FITableHead, "\n");


PRIVATE VAR RepParmStr = "\n"+
"‘®áâ ¢¨â¥«ì ®âç¥â         ##################################################\n"+
"®«ãç â¥«ì ®âç¥â          ##################################################\n"+
"Žá­®¢ ­¨¥ ¢ë¤ ç¨ ®âç¥â    ##################################################\n"+
"                          ¤ â  ¯à¨ñ¬  ##########\n"+
"\n"+
"‘ç¥â ¤¥¯®\n"+
"     ª®¤ (­®¬¥à)          ##################################################\n"+
"     ­ ¨¬¥­®¢ ­¨¥         ##################################################\n"+
"     ¤¥¯®­¥­â             ##################################################\n"+
"\n";

PRIVATE VAR PartStr = "\n"+
"      §¤¥« áç¥â  ¤¥¯®\n"+
"     ª®¤ (­®¬¥à)          ##################################################\n"+
"\n"; 


private var party  = TBFile("party");
private var fin    = TBFile("fininstr");
private var avr    = TBFile("avoiriss");

private macro GetReceiverName(DepoAcc)
  var query, DataSet;
  var Select;
  var ReceiverID;
  var ReceiverName = "";

  Select = DL_RSDCommand();

  if(_LOAutoKey) /*ˆ§ ˆŽ*/
    query = " select sp.t_PartyName ReceiverName " +
            " from dspground_dbt sp " +
            " where t_SourceDocKind = 830 " +
            "   and t_SourceDocID = ? /*1*/ " +
            "   and t_Direction = 2 ";

    Select.AddParam(_LOAutoKey );  /*1*/
  else
    if(_iDepoAcc) /*®âç¥â ¯® ®¤­®¬ã áç¥âã*/
      ReceiverID = _Deponent;
      query = " select pt.t_Name ReceiverName " +
              " from dparty_dbt pt " +
              " where pt.t_PartyId = ? /*1*/ ";

      Select.AddParam(ReceiverID );  /*1*/
    else
      query = " select pt.t_Name ReceiverName " +
              " from dparty_dbt pt, ddepoacnt_dbt ac " +
              " where pt.t_PartyID = ac.t_Owner " +
              "   AND ac.t_AutoKey = ? ";

      Select.AddParam(DepoAcc );  /*1*/
    end;
  end;

  DataSet = Select.Execute(query);

  if(DataSet.moveNext())
    ReceiverName = DataSet.ReceiverName;
  end;

  return ReceiverName;
end;


private macro GetGround(RegistrDate:@variant)
  var query, DataSet, Select;
  var GroundDoc = "";

  query = " select llv.t_Name DocName, spgr.t_Xld Xld, spgr.t_RegistrDate RegistrDate" +
          " from dllvalues_dbt llv, dspground_dbt spgr, dsplogopr_dbt logopr " +
          " where logopr.t_AutoKey = ? /*1*/ " +
          " AND spgr.t_SpgroundID = logopr.t_Draft " +
          " AND llv.t_List = 1050 " +
          " AND llv.t_Element = spgr.t_Kind";  

  Select = DL_RSDCommand( query );

  Select.AddParam(_LOAutoKey );  /*1*/

  DataSet = Select.Execute();

  if(DataSet.moveNext())
    GroundDoc = string(DataSet.DocName) + " ¢å.ü ";
    if(string(DataSet.Xld) == "");
      GroundDoc = GroundDoc + "¡/­";
    else
      GroundDoc = GroundDoc + string(DataSet.Xld);
    end;

    RegistrDate = string(date(DataSet.RegistrDate));
  else
    GroundDoc = "- ¢å.ü -";
    RegistrDate = "-";
  end;

  return GroundDoc;
end;


private macro GetDepoAccount(DepoAcc, AccName:@variant, OwnerName:@variant)
  var query, DataSet, Select;
  var AccCode = "";

  query = " select da.t_Code Code, da.t_BriefCode BriefCode, da.t_Name AccName, pt.t_Name OwnerName" +
          " from ddepoacnt_dbt da, dparty_dbt pt " +
          " where da.t_AutoKey = ? /*1*/ " +
          " AND pt.t_PartyID = da.t_Owner ";   

  Select = DL_RSDCommand( query );

  Select.AddParam(DepoAcc );  /*1*/

  DataSet = Select.Execute();

  if(DataSet.moveNext())
    AccCode = string(DataSet.Code) + " (ª®à®âª¨© " + string(DataSet.BriefCode) + ")";
    AccName = string(DataSet.AccName);
    OwnerName = string(DataSet.OwnerName);
  else
    AccName = "";
    OwnerName = "";
  end;

  return AccCode;
end;

PRIVATE CLASS (DL_CReportTemplate) DP_dpmkoper
  var NeedBreak = false;
  private var isPrint = false;

  PRIVATE MACRO PrintMode():INTEGER
     if(_ToExcel)
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
    Dl_CallInsertStat(PrintMode());
    CreateTotalBook();     
    SetActiveSheet( "Žâç¥â" );
  END;

  PRIVATE MACRO EndReport()
     if(not NeedBreak)
       SaveTotalBook();
     else
       m_ObjTemplateXLS.SheetDelete(1);
     end;
  END;

  MACRO CReport_DataExist()
    return not NeedBreak;
  END;

  PRIVATE MACRO PrintHeader(DepoAcc, iCount)
    var RepGroundDate;
    var RepGround = GetGround(@RepGroundDate);
    var AcntName, AcntOwnerName;
    var AcntCode = GetDepoAccount(DepoAcc, @AcntName, @AcntOwnerName);

    DP_StdHeaderLO_Ex( null, null, HeaderStr, _LOAutoKey, iCount, false, _BeginDate, _EndDate, tablewidth, null, null, this, "N1_" );

    PrintFormatString( RepParmStr,
                       "N1_RepFormer", GetPartyName( {OurBank}, true ),
                       "N1_RepReceiver",  GetReceiverName(DepoAcc),
                       "N1_RepGround", RepGround,
                       "N1_RepGroundDate", RepGroundDate,
                       "N1_AcntCode", AcntCode,
                       "N1_AcntName", AcntName,
                       "N1_AcntOwner", AcntOwnerName
                     );

    CopyAllSheetInTotalBook( NULL, false, "N1_Head", 1 );
  END;

  PRIVATE MACRO PrintPart(DepoPart)
    var query, DataSet, Select;
    var PartCode = "";

    query = " select da.t_Code Code, da.t_BriefCode BriefCode " +
            " from ddepoacnt_dbt da, dparty_dbt pt " +
            " where da.t_AutoKey = ? /*1*/ ";

    Select = DL_RSDCommand( query );

    Select.AddParam(DepoPart);  /*1*/
    DataSet = Select.Execute();

    if(DataSet.moveNext())
      PartCode = string(DataSet.Code) + " (ª®à®âª¨© " + string(DataSet.BriefCode) + ")";
    end;

    PrintFormatString( PartStr,
                       "N1_PartCode", PartCode
                     );

    CopyAllSheetInTotalBook( NULL, false, "N1_PartHead", 1 );
  END;

  PRIVATE MACRO GetCorrectSignRest(DepoAccKind, Rest)
    if(DepoAccKind == SIDEBALANCE_ACTIVE)
      if(Rest != 0.0)
        Rest = Rest * (-1);
        SetParm(2, Rest);
      end;
    end;

    return Rest;
  END;

  PRIVATE MACRO PrintFI(DepoAcc, DepoAccKind, _DispPart, DepoPart, FIID)
    var query, DataSet, Select;
    var query2, DataSet2, Select2;
    var PartRestBegin = 0.0, PartRestEnd = 0.0, DepoAcRestBegin = 0.0, DepoAcRestEnd = 0.0;
    var LSIN = "", FIName = "", SumPrecision = AVOIRISS_SUM_PRECISION;

    /* ®«ãç¨âì ®áâ âª¨ ­  â¥à¬¨­ «ì­®¬ à §¤¥«¥ ­  ­ ç «® ¨ ª®­¥æ ¯¥à¨®¤  */
    if(_DispPart)
      query = " select sum(rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, 5, null )) PartRestBegin, " +
              "        sum(rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, 5, null )) PartRestEnd " +
              " from daccount_dbt acc " +
              " where acc.t_DepoAcc = ? " +
              "   AND acc.t_Code_Currency = ? ";

      Select = DL_RSDCommand(query);

      Select.AddParam(_BeginDate-1 );
      Select.AddParam(_EndDate );
      Select.AddParam(DepoPart );
      Select.AddParam(FIID );

      DataSet = Select.Execute();

      if(DataSet.moveNext())
        PartRestBegin = DataSet.PartRestBegin;
        PartRestEnd = DataSet.PartRestEnd;
      end;
    end;

    /*®«ãç¨âì ®áâ âª¨ ª®­ªà¥â­®© æ/¡ ­  áç¥â¥ ¤¥¯® ­  ­ ç «® ¨ ®ª®­ç ­¨¥ ¯¥à¨®¤ */
    query2 = " select sum(rsb_account.restac(acc1.t_Account, acc1.t_Code_Currency, ?, 5, null )) DepoAcRestBegin, " +
             "        sum(rsb_account.restac(acc1.t_Account, acc1.t_Code_Currency, ?, 5, null )) DepoAcRestEnd " +
             " from daccount_dbt acc1 " +
             " where acc1.t_DepoRoot = ? " +
             "   AND acc1.t_Code_Currency = ? ";

    Select2 = DL_RSDCommand( query2 );

    Select2.AddParam(_BeginDate-1 );
    Select2.AddParam(_EndDate );
    Select2.AddParam(DepoAcc );
    Select2.AddParam(FIID );

    DataSet2 = Select2.Execute();

    if(DataSet2.moveNext())
      DepoAcRestBegin = DataSet2.DepoAcRestBegin;
      DepoAcRestEnd = DataSet2.DepoAcRestEnd;
    end;

    if(®«ãç¨âì”¨­ˆ­( FIID, fin, avr ) == 0) //­ è«¨
      LSIN = avr.rec.LSIN;
      FIName = fin.rec.Name;
      SumPrecision = fin.rec.SumPrecision;
    end;

    CopyAllSheetInTotalBook( NULL, false, "N1_FITableHeader", 1 );

    RegisterTable( "N1_FITable", FITableHead,
                   "N1_A1",          
                   "N1_A2",               
                   "N1_A3",                
                   "N1_A4",        
                   "N1_A5",
                   "N1_A6"        
                 );

    PrintTableLine( "N1_A1", LSIN,                                             null,
                    "N1_A2", FIName,                                           null,
                    "N1_A3", GetCorrectSignRest(DepoAccKind, PartRestBegin),   null,
                    "N1_A4", GetCorrectSignRest(DepoAccKind, PartRestEnd),     null,
                    "N1_A5", GetCorrectSignRest(DepoAccKind, DepoAcRestBegin), null,
                    "N1_A6", GetCorrectSignRest(DepoAccKind, DepoAcRestEnd),   null
                  );

    EndTable();
    CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
  END;

  PRIVATE MACRO GetAccNodes(Account, FIID, DepoRoot:@variant)
    var query, DataSet, Select;
    var DepoAcc = 0;

    query = " select acc.t_DepoRoot DepoRoot, acc.t_DepoAcc DepoAcc" +
            " from daccount_dbt acc " +
            " where acc.t_Account = ? " +
            " AND acc.t_Code_Currency = ? " +
            " AND t_Chapter = 5"; 

    Select = DL_RSDCommand( query );

    Select.AddParam(Account);
    Select.AddParam(FIID);

    DataSet = Select.Execute();

    if(DataSet.MoveNext)
      DepoAcc = DataSet.DepoAcc;
      DepoRoot = DataSet.DepoRoot;
    else
      DepoRoot = 0;
    end;

    return DepoAcc;

  END;


  PRIVATE MACRO GetRegParm(DocKind, DocID, Xld:@variant)
    var query, DataSet, Select;
    var RegDate = date(0,0,0);

    Xld = "";

    Select = DL_RSDCommand();

    if((DocKind == SP_DEPOPER_BOOKORDER) OR
       (DocKind == SP_DEPOPER_TRANSFERORDER) OR
       (DocKind == SP_DEPOPER_ENROLMENT) OR
       (DocKind == SP_DEPOPER_RECORDER) OR
       (DocKind == SP_DEPOPER_WITHDRORDER) ) /* ˆ­¢¥­â à­ë¥ ®¯¥à æ¨¨ */
      query = " select gr.t_RegistrDate RegDate, gr.t_Xld Xld " +
              " from  dspdraft_dbt dr, dspground_dbt gr " +
              " where dr.t_AutoKey = ? " +
              "   AND gr.t_SPgroundID = dr.t_SPgroundID ";

      Select.AddParam(DocID );

    elif( ( DocKind == DP_DEPOPER_CONVERT ) OR
          ( DocKind ==  DP_DEPOPER_REPAY ) OR
          ( DocKind == DP_DEPOPER_BONEMISS ) ) /* ƒ«®¡ «ì­ë¥ ®¯¥à æ¨¨ */
      query = " select gr.t_RegistrDate RegDate, gr.t_Xld Xld " +
              " from  ddpcorpop_dbt cr, dspground_dbt gr " +
              " where cr.t_DocumentID = ? " +
              "   AND gr.t_SPgroundID = cr.t_SPgroundID ";

      Select.AddParam(DocID );
    else
      return RegDate;
    end;

    DataSet = Select.Execute(query);

    if(DataSet.MoveNext)
      RegDate = date(DataSet.RegDate);
      Xld = DataSet.Xld;
    end;

    return RegDate;
  END;


  PRIVATE MACRO PutOneOper(FIID, DepoAcc, DepoPart, DocKind, DocID, Date_Carry, OperSum, Account_Payer, Account_Receiver)
    var PayerDepoAcc, PayerDepoRoot;
    var ReceiverDepoAcc, ReceiverDepoRoot;
    var opr_kind, RegDate, Xld;
    var fi = TRecHandler("fininstr");
    var SumPrecision = AVOIRISS_SUM_PRECISION;

    if(®«ãç¨âì”¨­ˆ­( FIID, fi ) == 0) //­ è«¨
      SumPrecision = fi.rec.SumPrecision;
    end;

    PayerDepoAcc = GetAccNodes(Account_Payer, FIID, @PayerDepoRoot);
    ReceiverDepoAcc = GetAccNodes(Account_Receiver, FIID, @ReceiverDepoRoot );
    if(_DispPart)
      if(PayerDepoAcc == DepoPart)
        opr_kind = "¯®áâ ¢ª \n(á¯¨á ­¨¥)";
      else
        opr_kind = "¯à¨¥¬\n(§ ç¨á«¥­¨¥)";
      end;
    else
      if(PayerDepoRoot == DepoAcc)
        opr_kind = "¯®áâ ¢ª \n(á¯¨á ­¨¥)";
      else
        opr_kind = "¯à¨¥¬\n(§ ç¨á«¥­¨¥)";
      end;

      if((PayerDepoRoot == DepoAcc) AND (ReceiverDepoRoot == DepoAcc))
        opr_kind = "¯¥à¥¢®¤ ¬¥¦¤ã à §¤¥« ¬¨"
      end;
    end;

    RegDate = GetRegParm(DocKind, DocID, @Xld);

    PrintTableLine( "N1_B0:ex_B(rl)", "", null,
                    "N1_B1:c", date(Date_Carry),      null,
                    "N1_B2:r", OperSum,               null,
                    "N1_B3:c", opr_kind,              null,
                    "N1_B4:c", RegDate + " / " + Xld, null
                  );
    
  END;


  PRIVATE MACRO IsExistsOperations(DepoAcc, DepoPart, FIID)
    var Query = "", DataSet, Select;
    var IsExists = false;

    Select = DL_RSDCommand();

    Query =
              " SELECT 1 " +
                " FROM dacctrn_dbt ad, doprdocs_dbt od, doproper_dbt op " +
               " WHERE ad.t_date_carry >= ? " +
                 " AND ad.t_date_carry <= ? " +
                 " AND ad.t_fiid_payer = ? " +
                 " AND ad.t_chapter = 5 " +
                 " AND od.t_dockind = 1 " +
                 " AND od.t_acctrnid = ad.t_acctrnid " +
                 " AND op.t_id_operation = od.t_id_operation ";

    Select.AddParam(_BeginDate );
    Select.AddParam(_EndDate );
    Select.AddParam(FIID );

    if(_DispPart)
      Query = Query +
                 " AND (   ad.t_account_payer IN (SELECT accp.t_account " +
                                                  " FROM daccount_dbt accp " +
                                                 " WHERE accp.t_depoacc = ?) " +
                      " OR ad.t_account_receiver IN (SELECT accr.t_account " +
                                                     " FROM daccount_dbt accr " +
                                                    " WHERE accr.t_depoacc = ?) " +
                     " ) ";

      Select.AddParam(DepoPart );
      Select.AddParam(DepoPart );
    else
      Query = Query +
                 " AND (   ad.t_account_payer IN (SELECT accp.t_account " +
                                                  " FROM daccount_dbt accp " +
                                                 " WHERE accp.t_deporoot = ?) " +
                      " OR ad.t_account_receiver IN (SELECT accr.t_account " +
                                                     " FROM daccount_dbt accr " +
                                                    " WHERE accr.t_deporoot = ?) " +
                     " ) ";

      Select.AddParam(DepoAcc );
      Select.AddParam(DepoAcc );
    end;

    DataSet = Select.Execute(query);

    if(DataSet.MoveNext)
      IsExists = true;
    end;

    return IsExists;
  END;

  PRIVATE MACRO PrintOperations(DepoAcc, DepoPart, FIID)
    var query, DataSet, Select;
    var PrevDocKind, PrevDocID, PrevDate_Carry, PrevOperSum, PrevAccount_Payer, PrevAccount_Receiver;

    Select = DL_RSDCommand();

    query = " select op.t_DocKind DocKind, op.t_DocumentID DocID, ad.t_Date_Carry Date_Carry, ad.t_Sum_Payer OperSum, ad.t_Account_Payer Account_Payer, ad.t_Account_Receiver Account_Receiver" +
            " from dacctrn_dbt ad, doprdocs_dbt od, doproper_dbt op " +
            " where ad.t_Date_Carry >= ? " +
            "   AND ad.t_Date_Carry <= ? " +
            "   AND ad.t_FIID_Payer = ? " +
            "   AND ad.t_Chapter = 5 " +
            "   AND od.t_DocKind = 1 " +
            "   AND od.t_AccTrnID = ad.t_AccTrnID " +
            "   AND op.t_ID_Operation = od.t_ID_Operation ";

    Select.AddParam(_BeginDate );
    Select.AddParam(_EndDate );
    Select.AddParam(FIID );

    if(_DispPart)
      query = query + "  AND ( ad.t_Account_Payer in (select accp.t_Account from daccount_dbt accp where accp.t_DepoAcc = ?) " +
                      "     OR ad.t_Account_Receiver in (select accr.t_Account from daccount_dbt accr where accr.t_DepoAcc = ?) ) ";

      Select.AddParam(DepoPart );
      Select.AddParam(DepoPart );
    else
      query = query + "  AND ( ad.t_Account_Payer in (select accp.t_Account from daccount_dbt accp where accp.t_DepoRoot = ?) " +
                      "     OR ad.t_Account_Receiver in (select accr.t_Account from daccount_dbt accr where accr.t_DepoRoot = ?) ) ";

      Select.AddParam(DepoAcc );
      Select.AddParam(DepoAcc );
    end;

    query = query + " ORDER BY ad.t_Date_Carry, op.t_DocKind, op.t_DocumentID, ad.t_AccTrnID ";


    DataSet = Select.Execute(query);

    if(DataSet.MoveNext)

      CopyAllSheetInTotalBook( NULL, false, "N1_OprTableHeader", 0 );

      RegisterTable( "N1_OprTable", OprTableHead,
                     "N1_B0",
                     "N1_B1",          
                     "N1_B2",               
                     "N1_B3",                
                     "N1_B4"        
                   );

      /* „«ï á¡®à  ¯à®¢®¤®ª ¯® ®¤­®© ®¯¥à æ¨¨ */
      /* § ¯®¬­¨¬ ¤ ­­ë¥ ¯® ¯à®¢®¤ª¥ */
      PrevDocKind = DataSet.DocKind;
      PrevDocID = DataSet.DocID;
      PrevDate_Carry = DataSet.Date_Carry;
      PrevOperSum = DataSet.OperSum;
      PrevAccount_Payer = DataSet.Account_Payer;
      PrevAccount_Receiver = DataSet.Account_Receiver;

      while(DataSet.MoveNext)
        if( (PrevDocKind != DataSet.DocKind) OR (PrevDocID != DataSet.DocID ) ) /*®è«¨ ¯à®¢®¤ª¨ ¯® ¤àã£®© ®¯¥à æ¨¨ - ­ã¦­® ®â¯¥ç â âì âã, çâ® ­ ª®¯¨« áì*/
          PutOneOper(FIID, DepoAcc, DepoPart, PrevDocKind, PrevDocID, PrevDate_Carry, PrevOperSum, PrevAccount_Payer, PrevAccount_Receiver);

          PrevDocKind = DataSet.DocKind; /* § ¯®¬­¨¬ ¤ ­­ë¥ ­®¢®© ®¯¥à æ¨¨ */
          PrevDocID = DataSet.DocID;
          PrevDate_Carry = DataSet.Date_Carry;
          PrevOperSum = DataSet.OperSum;
          PrevAccount_Payer = DataSet.Account_Payer;
          PrevAccount_Receiver = DataSet.Account_Receiver;
        else
          PrevOperSum = PrevOperSum + DataSet.OperSum; /* á®¡¥à¥¬ áã¬¬ã */
        end;
      end;

      PutOneOper(FIID, DepoAcc, DepoPart, PrevDocKind, PrevDocID, PrevDate_Carry, PrevOperSum, PrevAccount_Payer, PrevAccount_Receiver);

      EndTable();
      CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0 );
    end;

  END;

  PRIVATE MACRO CreateReport(DepoAcc, iCount)
    var query, DataSet, Select;
    var i;
    var PrevDepoPart = 0;
    var PrevFIID = 0;
    var IsData = false;
    var IsHeaderPrint = false;
    var WithTrans;

    Select = DL_RSDCommand();

    query =
    " select distinct ";

    if(_DispPart)
      query = query +
    " acc.t_DepoAcc DepoPart, ";
    end;

    query = query +
    " da.t_Kind DepoAccKind, " +
    " acc.t_Code_Currency FIID " +
    " from daccount_dbt acc, ddepoacnt_dbt da, dfininstr_dbt fi " +
    " where acc.t_DepoRoot = ? " +
    " AND da.t_AutoKey = acc.t_DepoAcc " +
    " AND fi.t_FIID = acc.t_Code_Currency ";

    Select.AddParam(DepoAcc);

    if(_iDepoPart)
      query = query + " AND acc.t_DepoAcc = ? ";
      Select.AddParam(_iDepoPart);
    end;

    if(_iFI != ALLFININSTR)
      query = query + " AND acc.t_Code_Currency = ? ";
      Select.AddParam(_iFI);
    else
      if(_Issuer != UnknownParty) 
        query = query + " AND RSI_RSB_FIInstr.FI_GetIssuerOnDate( fi.t_FIID, ? ) = ? ";
        Select.AddParam(_EndDate);
        Select.AddParam(_Issuer);
      end;
      if(_AvrKind)
        query = query + " AND 1 = RSB_FIInstr.FI_AvrKindsEQ(fi.t_FI_Kind, ?, fi.t_AvoirKind) ";
        Select.AddParam(_AvrKind);
      end;
    end;

    query = query + " AND (   rsb_account.debetac(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?, ?) != 0.0 " +
                    "      OR rsb_account.kreditac(acc.t_Account, acc.t_Chapter, acc.t_Code_Currency, ?, ?) != 0.0 " +
                    "      OR rsb_account.restac(acc.t_Account, acc.t_Code_Currency, ?, acc.t_Chapter, null) != 0.0 ) ";

    if(_DispPart)
      query = query + " ORDER BY acc.t_DepoAcc, acc.t_Code_Currency ";
    else
      query = query + " ORDER BY acc.t_Code_Currency ";
    end;

    Select.AddParam(_BeginDate);
    Select.AddParam(_EndDate);
    Select.AddParam(_BeginDate);
    Select.AddParam(_EndDate);
    Select.AddParam(_BeginDate);

    DataSet = Select.Execute(query);

    while(DataSet.moveNext())
      IsData = true;
      if(_DispPart)
        WithTrans = IsExistsOperations(DepoAcc, DataSet.DepoPart, DataSet.FIID);
        if((WithTrans) or (not (_OnlyWTrans)))
          // ˜ ¯ª 
          if(not (IsHeaderPrint))
            PrintHeader(DepoAcc, iCount);
            IsHeaderPrint = true;
          end;
          // ®¢ë© à §¤¥«
          if(PrevDepoPart != DataSet.DepoPart)
            PrintPart(DataSet.DepoPart);
            PrevDepoPart = DataSet.DepoPart;
            PrevFIID = 0;
          end;
          // ®¢ë© ”ˆ
          if(PrevFIID != DataSet.FIID)
            PrintFI(DepoAcc, DataSet.DepoAccKind, _DispPart, DataSet.DepoPart, DataSet.FIID);
            if(WithTrans)
              PrintOperations(DepoAcc, DataSet.DepoPart, DataSet.FIID);
            else
              PrintFormatString( NotOperStr, "N1_NotOperStr", "Ž¯¥à æ¨¨ ­¥ ¯à®¢®¤¨«¨áì"); 
              CopyAllSheetInTotalBook( NULL, false, "N1_NotOperStr", 0 );
            end;
            PrevFIID = DataSet.FIID;
          end;
        end;
      else // if(_DispPart)
        WithTrans = IsExistsOperations(DepoAcc, 0, DataSet.FIID);
        if((WithTrans) or (not (_OnlyWTrans)))
          // ˜ ¯ª 
          if(not (IsHeaderPrint))
            PrintHeader(DepoAcc, iCount);
            IsHeaderPrint = true;
          end;
          // ®¢ë© ”ˆ
          if(PrevFIID != DataSet.FIID)
            PrintFI(DepoAcc, DataSet.DepoAccKind, _DispPart, 0, DataSet.FIID);
            if(WithTrans)
              PrintOperations(DepoAcc, 0, DataSet.FIID);
            else
              PrintFormatString( NotOperStr, "N1_NotOperStr", "Ž¯¥à æ¨¨ ­¥ ¯à®¢®¤¨«¨áì"); 
              CopyAllSheetInTotalBook( NULL, false, "N1_NotOperStr", 0 );
            end;
            PrevFIID = DataSet.FIID;
          end;
        end;
      end; // if(_DispPart)
    end; // while(DataSet.moveNext())

    if(IsData)
      if(IsHeaderPrint)
        // ®¤«®¦ª 
        DP_StdAuthPerson_Ex(null, null, this, "N1_");
        DP_StdDeposInfo_Ex(null, null, 0, this, "N1_");
        DP_StdExecReport_Ex(null, null, NULL, NULL, 0, this, "N1_");
        isPrint = true;
      end;
    else
      if(not (_OnlyWTrans))
        PrintHeader(DepoAcc, iCount);

        PrintFormatString( EmptyDataStr, "N1_EmptyDataStr", "¥â ¤ ­­ëå, ã¤®¢«¥â¢®àïîé¨å ¯ à ¬¥âà ¬ ®âç¥â "); 
        CopyAllSheetInTotalBook( NULL, false, "N1_EmptyDataStr", 0 );

        DP_StdAuthPerson_Ex(null, null, this, "N1_");
        DP_StdDeposInfo_Ex(null, null, 0, this, "N1_");
        DP_StdExecReport_Ex(null, null, NULL, NULL, 0, this, "N1_");
        isPrint = true;
      end;
    end;

  end;


  MACRO CreateRep()
    var query, DataSet, cmd;
    var Progress = CProgressBar;
    var iCount = 1;

    if(NOT _iDepoAcc)
      cmd = DL_RSDCommand();

      query = " SELECT da.t_autokey DepoAcc " +
              "   FROM ddepoacnt_dbt da " +
              "  WHERE da.t_Root = da.t_Autokey " +
              "    AND da.t_Department = ? ";

      cmd.AddParam(_NumDprt);

      if(_Deponent != UnknownParty)
        query = query + " AND da.t_owner = ? ";
        cmd.AddParam(_Deponent);
      end;

      var cnt = cmd.GetCount(query);
      if(cnt)
        DataSet = cmd.Execute(query);
        Progress.Init( cnt, NameJrn + " ‚ë¯®«­¥­¨¥ ®âç¥â  ...", "Žâ¡®à áç¥â®¢" );

        while( DataSet.MoveNext() )
          CreateReport(DataSet.DepoAcc, iCount);
          iCount = Progress.Use();
        end;

        Progress.Remove();

      end;
    else
      CreateReport(_iDepoAcc, 0);
    end;
    
    return IIF(isPrint, 1, 0);
  END;

  PRIVATE MACRO Create()
    return DP_StdReportControl(_LOAutoKey, this.CreateRep(), null, 0, _ToExcel, null, null, this, "N1_" );
  END;

  MACRO CreateEmptyRep()
     DP_StdHeaderLO_Ex( null, null, HeaderStr, _LOAutoKey, 0, false, _BeginDate, _EndDate, tablewidth, null, null, this, "N1_" );

     PrintFormatString( EmptyDataStr, "N1_EmptyDataStr", "¥â ¤ ­­ëå, ã¤®¢«¥â¢®àïîé¨å ¯ à ¬¥âà ¬ ®âç¥â "); 
     CopyAllSheetInTotalBook( NULL, false, "N1_EmptyDataStr", 0 );

     DP_StdAuthPerson_Ex(null, null, this, "N1_");
     DP_StdDeposInfo_Ex(null, null, tablewidth, this, "N1_");
     DP_StdExecReport_Ex(null, null, NULL, NULL, tablewidth, this, "N1_");
  END;

  initDL_CReportTemplate( NULL, "dpmkoper.xls" );
END;


/* ‚ë¯ãáâ¨âì ®âç¥â 
 à ¬¥âàë, ¯®«ãç ¥¬ë¥ ¨§ ¯ ­¥«¨ § ¯ãáª :
NumDprt - ä¨«¨ «
BeginDate - „ â  ­ ç «  ¯¥à¨®¤ 
EndDate  - „ â  ®ª®­ç ­¨ï ¯¥à¨®¤ 
Deponent - ˆ„ ¤¥¯®­¥­â 
DepoAcc - ˆ„ áç¥â  ¤¥¯®
DepoPart - ˆ„ à §¤¥« 
Issuer - ˆ„ í¬¨â¥­â  æ/¡
AvrKind - ¢¨¤ æ/¡
FIID - ˆ„ æ/¡
DispPart -  áªàë¢ âì ®âç¥â ¯® à §¤¥« ¬
OnlyWTrans - ’®«ìª® á ®¡®à®â ¬¨
ToExcel - ‚ë¢®¤¨âì ®âç¥â ¢ Excel
Is_Ap - ‚ë¢®¤¨âì ¢ áã¬¬ å  ¯®áâà®äë
LOAutoKey - ˆ„ ¨­ä®à¬ æ¨®­­®© ®¯¥à æ¨¨ (¯à¨ ¯®¤ª«îç¥­¨¨ ®âç¥â  ª ­¥©)
*/
MACRO GenRep(
             NumDprt:integer,
             BeginDate:date,
             EndDate:date,
             Deponent:integer,
             DepoAcc:integer,
             DepoPart:integer,
             Issuer:integer,
             AvrKind:integer,
             FIID:integer,
             DispPart:bool,
             OnlyWTrans:bool,
             ToExcel:bool,
             Is_Ap:bool,
             LOAutoKey:integer
            )

  _BeginDate  = BeginDate;
  _EndDate    = EndDate;
  _Deponent   = Deponent;
  _iDepoAcc   = DepoAcc;
  _iDepoPart  = DepoPart;
  _Issuer     = Issuer;
  _AvrKind    = AvrKind;
  _iFI        = FIID;
  _DispPart   = DispPart;
  _OnlyWTrans = OnlyWTrans;
  _Is_Ap      = Is_Ap;
  _LOAutoKey  = LOAutoKey;
  _ToExcel    = ToExcel;
  _NumDprt    = NumDprt;

  var stat = 0;
  var RepObj = DP_dpmkoper();
  
  RepObj.Run();
  stat = RepObj.NeedBreak;
  if(stat == 1)
    return stat;
  else
    return 0;
  end;
END;
