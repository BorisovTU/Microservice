/*
$Name: sptr_10.mac
$Module: Депозитарий
$Description: Междепозитарный перевод эмиссионных ценных бумаг - шаг Настроек операции
*/
import InsCarryDoc, PaymInter, OprInter, dpmassexec;

/* Буферы ПД, заполняемые из операции */
record Pm_paym( pmpaym );    /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );    /*св-ва платежа*/
record Pm_rmprop( pmrmprop ); /*платеж по ценным бумагам*/

macro executeParamStep( KindOper, KindDoc, FDoc )
  
  DefineOprDate( DATE_FIRST, {curdate} );

  if( {curdate} < Pm_paym.ValueDate )
     DefineOprDate( DATE_VALUE, Pm_paym.ValueDate );
    else 
     DefineOprDate( DATE_VALUE, {curdate} );
  end;

  return 0;
end;

// Массовое исполнение 
MACRO MassExecuteStep()
  VAR OperDate = DP_MassOperDate();
  var err = 0;

  OperDate.InsertDate( DATE_FIRST, {curdate} );
  OperDate.InsertDateValue( DATE_VALUE, {curdate} );

  err = OperDate.Execute( "Шаг настройки операции. Установка планируемых дат операций." );

  if(err)
    DP_SetErrorOprTemp(0, err, "Ошибка при пакетном выполнении шага");
  end;

  return err;

OnError(er)
  DP_SetErrorOprTemp(0, 1, er.module+ " "+er.line+" "+er.message);
  return 1;
END;
