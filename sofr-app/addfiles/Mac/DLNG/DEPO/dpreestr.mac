/*
$Name:         dpreestr.mac
$Module:       Депозитарий
$Description:  Отчет по спискам-реестрам
*/
import deposerv, cb_sql, RsbDataSet;

var HeadTable_ac = "┌──────────────────┬───────────────────────┬─────────────────────┬─────────────────────┐\n"+
                   "│   Код субъекта   │      Наименование     │      Счет депо      │  Раздел счета депо  │\n"+
                   "├──────────────────┼───────────────────────┼─────────────────────┼─────────────────────┤";

var HeadTable_fi = "┌──────────────────┬───────────────────────┬─────────────────────┬─────────────────────┐\n"+
                   "│     Код ц/б      │    № гос. регистр.    │        ISIN         │    Наименование     │\n"+
                   "├──────────────────┼───────────────────────┼─────────────────────┼─────────────────────┤";

var HeadTable_re = "┌──────────────────┬───────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┬───────────────────┬─────┬─────────────────────┬─────────────────────┬─────────────────────┬──────────────────┬───────────────────────┬──────────────────────┐\n"+
                   "│   Код владельца  │        Владелец       │      Счет депо      │  Раздел счета депо  │       Л/с  депо     │  Базовый остаток  │ Тип │ Л/с депо места хран.│ Разд. сч. места хр. │ Счет депо места хр. │  Код депозитария │      Депозитарий      │      Примечание      │\n"+
                   "├──────────────────┼───────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼───────────────────┼─────┼─────────────────────┼─────────────────────┼─────────────────────┼──────────────────┼───────────────────────┼──────────────────────┤\n"+
                   "│         1        │           2           │          3          │          4          │          5          │         6         │  7  │          8          │          9          │         10          │        11        │          12           │          13          │\n"+
                   "├──────────────────┼───────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼───────────────────┼─────┼─────────────────────┼─────────────────────┼─────────────────────┼──────────────────┼───────────────────────┼──────────────────────┤";

var HeadTable_vt = "┌──────────────────┬───────────────────────┬─────────────────────┬─────────────┬──────────────┬──────────────┬────────────────────────┬────────────┬────────────┬────────────┬─────────────┬─────────────┬──────────────────────┐\n"+
                   "│   Код владельца  │        Владелец       │      Счет депо      │   Код ц/б   │ Наименование │  Количество  │   Решение/Кандидатура  │     За     │   Против   │Воздержался │ Голосование │ Ограничения │      Примечание      │\n"+
                   "│                  │                       │                     │             │     ц/б      │              │                        │            │            │            │     по      │             │                      │\n"+
                   "│                  │                       │                     │             │              │              │                        │            │            │            │доверенности │             │                      │\n"+
                   "├──────────────────┼───────────────────────┼─────────────────────┼─────────────┼──────────────┼──────────────┼────────────────────────┼────────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────────────┤\n"+
                   "│         1        │           2           │          3          │      4      │       5      │       6      │            7           │      8     │      9     │      10    │      11     │     12      │          13          │\n"+
                   "├──────────────────┼───────────────────────┼─────────────────────┼─────────────┼──────────────┼──────────────┼────────────────────────┼────────────┼────────────┼────────────┼─────────────┼─────────────┼──────────────────────┤";


private
  var DpAcList = TArray,
      AvoirList  = TArray;

private var Rep;
private const FontStyleTitel =  "ex_FS(b)";
private var TableWidth = Index(HeadTable_re, "\n");

private macro SmartSetBuff(dest, src)
  if(ValType(src) == V_MEMADDR)
    SetBuff(dest, src);
  else
    Copy(dest, src);
  end;
end;

private macro AddStr()
  Rep.AddStr();
end;

private macro EmptyStr()
  Rep.AddEmptyStr();
end;

private macro PrintCell( Str )
  Rep.AddPrintCell( Str, strlen(Str)+2, 0, "l:" + FontStyleTitel, REP_ELEM_STR );
end;

private macro PrintCellTable( Str )
  Rep.AddPrintCell( Str, 0, 0, "l:"/* + FontStyleTitel*/ );
end;

private macro PrintCellSize( Str, S_Size, v_Point, Format )
  if( (ValType(v_Point) == V_UNDEF) or (v_Point == null) )
    v_Point = 0;
  end;
  if(ValType(Format) == V_UNDEF)
    Format = "";
  end;
  Rep.AddPrintCell( Str, S_Size, v_Point, "l:" + Format/* + FontStyleTitel*/ );
end;

/* Аналог оператора ?: в си. */
private macro IIF( condition, value_true, value_false )
   if( condition )
      return value_true;
   else 
      return value_false;
   end;
end;

macro RunReport( v_reestr,    
                 IsTemp   : bool,
                 is_ap    : bool,
                 IsExcel  : bool )

  var sql, rsd, iCount;
  var cmd_solve, DataSet_solve, cmd_cml, DataSet_cml;
  var party  = TRecHandler("party.dbt"), Format;

  record reestr("dpregstr.dbt");
  record dppmfi("dppmfi.dbt");
  record dpacccrp("DPACCCRP.dbt");

  SmartSetBuff( reestr, v_reestr );

  Rep = CMakeReport();

  DP_StdHeaderLO_Ex( Rep, FontStyleTitel, "Список-реестр", 0, 0, false, null, null, TableWidth );

  /*шапка реестра*/
  PrintCell( "№ " + reestr.Number + 
             " создан " + date(reestr.CreationDate) + ", " + time(reestr.CreationTime) );
  AddStr();
  PrintCell( "Дата сбора остатков " + date(reestr.Date) );
  AddStr();
  if(reestr.ByRegistrar == SET_CHAR)
    PrintCell( "Построение списка реестра по дате включения в реестр" );
  else
    PrintCell( "Построение списка реестра по остаткам на счетах" );
  end; 
  AddStr();
  if( reestr.Comment != "" )
    PrintCell( "Комментарий: " + reestr.Comment );
  end;
  EmptyStr();


  /*Место хранения*/
  PrintCell( "Места хранения или учета" );
  if( (reestr.StoragePlace != -1) and
      (ПолучитьСубъекта(reestr.StoragePlace, party) == 0) )
    PrintCell( "в депозитарии " + ПолучитьКодСубъекта(reestr.StoragePlace, PTCK_CONTR) + ", " + party.rec.ShortName );
  end;

  Rep.AutoScan( "[\n" + HeadTable_ac + "]" );
  Format = "ex_B(rlb)";
  iCount = 0;
  while( iCount < DpAcList.Size )
    SmartSetBuff( dpacccrp, DpAcList[iCount] );

    sql = " select dpac.t_BriefCode AccCode, "
        +        " dppart.t_BriefCode PartCode, "
        +        " dpac.t_Owner "
        +   " from ddepoacnt_dbt dpac, "
        +        " ddepoacnt_dbt dppart "
        +  " where dppart.t_AutoKey = " + string(dpacccrp.DepoAccID)
        +    " and dpac.t_AutoKey = dppart.t_Root ";
    rsd = TRsbDataSet(sql);
    if( rsd.MoveNext() )
      if( ПолучитьСубъекта(rsd.Owner, party) == 0 )
        PrintCellSize( ПолучитьКодСубъекта(rsd.Owner, PTCK_CONTR), 18, 0, Format );
        PrintCellSize( party.rec.ShortName, 23, 0, Format );
        PrintCellSize( rsd.AccCode, 21, 0, Format );
        PrintCellSize( rsd.PartCode, 21, 0, Format );
        AddStr();
        Format = "";
      end;
    end;

    iCount = iCount + 1;
  end;
  EmptyStr();


  /*ц/б*/
  PrintCell( "Ценные бумаги для сбора остатков" );
  if( (reestr.Issuer != -1) and
      (ПолучитьСубъекта(reestr.Issuer, party) == 0) )
    PrintCell( "эмитента " + ПолучитьКодСубъекта(reestr.Issuer, PTCK_CONTR) + ", " + party.rec.ShortName );
  end;
  Rep.AutoScan( "[\n" + HeadTable_fi + "]" );
  Format = "ex_B(rlb)";
  iCount = 0;
  while( iCount < AvoirList.Size )
    SmartSetBuff( dppmfi, AvoirList[iCount] );

    sql = " select fi.t_FI_Code, "
        +        " fi.t_Name, "
        +        " avr.t_LSIN, "
        +        " avr.t_ISIN "
        +   " from dfininstr_dbt fi, "
        +        " davoiriss_dbt avr "
        +  " where fi.t_FIID = " + string(dppmfi.FIID)
        +    " and avr.t_FIID = fi.t_FIID ";
    rsd = TRsbDataSet(sql);
    while( rsd.MoveNext() )
      PrintCellSize( rsd.FI_Code, 18, 0, Format );
      PrintCellSize( rsd.LSIN, 23, 0, Format );
      PrintCellSize( rsd.ISIN, 21, 0, Format );
      PrintCellSize( rsd.Name, 21, 0, Format );
      AddStr();
      Format = "";
    end;

    iCount = iCount + 1;
  end;
  EmptyStr();


  /*реестр*/
  PrintCell( "Реестр: " );
  Rep.AutoScan( "[\n" + HeadTable_re + "]" );
  Format = "ex_B(rlb)";

  sql = " select reg.t_HAccount, reg.t_HRest, reg.t_LAccount, reg.t_HolderID, fin.t_SumPrecision, "
      +        " dpacntD.t_BriefCode dacntDBriefCode, rootD.t_BriefCode rootDBriefCode, rootD.t_Owner rootDOwner, "
      +        " dpacnt.t_BriefCode dacntBriefCode, root.t_BriefCode rootBriefCode, root.t_Owner rootOwner, "
      +        " rsb_depo.GetReestrRestStatus( reg.t_HAccount, reg.t_LAccount, reg.t_HRest, " + GetSQLDate(reestr.Date) + ", reg.t_FIIDfrom ) RestState "
      +   " from " + IIF(IsTemp, "ddpreglin_tmp", "ddpreglin_dbt") + " reg, "
      +        " daccount_dbt accD, "
      +        " daccount_dbt acc, "
      +        " ddepoacnt_dbt dpacntD, "
      +        " ddepoacnt_dbt rootD, "
      +        " ddepoacnt_dbt dpacnt, "
      +        " ddepoacnt_dbt root, "
      +        " dfininstr_dbt fin "
      +  " where reg.t_RegisterID = " + string(reestr.RegisterID)
      +  "   and reg.t_Type = " + DP_REGLINETYPE_LACCOUNT
      +          IIF(IsTemp, "and reg.t_Action <> " + string(3 /*REGLIN_DELETE*/), "")
      +    " and accD.t_Chapter = " + string(5/*CHAPT5*/)
      +    " and accD.t_Account = reg.t_HAccount "
      +    " and accD.t_Code_Currency = DECODE(reg.t_FIIDDR, -1, reg.t_FIIDfrom, reg.t_FIIDDR ) "
      +    " and dpacntD.t_AutoKey = accD.t_DepoAcc "
      +    " and rootD.t_AutoKey = dpacntD.t_Root "
      +    " and acc.t_Chapter = " + string(5/*CHAPT5*/)
      +    " and acc.t_Account = reg.t_LAccount "
      +    " and acc.t_Code_Currency = DECODE(reg.t_FIIDDR, -1, reg.t_FIIDfrom, reg.t_FIIDDR ) "
      +    " and dpacnt.t_AutoKey = acc.t_DepoAcc "
      +    " and root.t_AutoKey = dpacnt.t_Root "
      +    " and fin.t_FIID = acc.t_Code_Currency ";

  rsd = TRsbDataSet(sql);
  while( rsd.MoveNext() )
    if( ПолучитьСубъекта(rsd.HolderID, party) == 0 )
      PrintCellSize( ПолучитьКодСубъекта(rsd.HolderID, PTCK_CONTR), 18 , 0, Format);
      PrintCellSize( party.rec.ShortName, 23, 0, Format );
    else
      PrintCellSize( "", 18, 0, Format );
      PrintCellSize( "", 23, 0, Format );
    end;

    PrintCellSize( rsd.rootDBriefCode, 21, 0, Format );
    PrintCellSize( rsd.dacntDBriefCode, 21, 0, Format );
    PrintCellSize( rsd.HAccount, 21, 0, Format );
    PrintCellSize( ЧислоCЗаданнойТочностью(double(rsd.HRest), DP_GetPrecision(rsd.HRest, rsd.SumPrecision), ""), 19, 0, Format );
    PrintCellSize( rsd.RestState, 5, 0, Format );
    PrintCellSize( rsd.LAccount, 21, 0, Format );
    PrintCellSize( rsd.dacntBriefCode, 21, 0, Format );
    PrintCellSize( rsd.rootBriefCode, 21, 0, Format );

    if( ПолучитьСубъекта(rsd.rootOwner, party) == 0 )
      PrintCellSize( ПолучитьКодСубъекта(rsd.rootOwner, PTCK_CONTR), 18, 0, Format );
      PrintCellSize( party.rec.ShortName, 23, 0, Format );
    else
      PrintCellSize( "", 18, 0, Format );
      PrintCellSize( "", 23, 0, Format );
    end;

    if(rsd.HolderID != rsd.rootDOwner)
      PrintCellSize( "Залогодержатель", 22, 0, Format );
    else
      PrintCellSize( "", 22, 0, Format );
    end;

    AddStr();
    Format = "";
  end;

  //Голосование
  if(reestr.Voting == SET_CHAR)
    sql =   " select solve.*, vt.*, rootD.t_BriefCode, rootD.t_Owner, quest.t_Number QuestNumber, "
          + "        fin.t_SumPrecision, fin.t_FI_Code, fin.t_Name as FI_Name "
          + "   from "+IIF(IsTemp, "ddpregvote_tmp", "ddpregvote_dbt")+" vt, "
          +            IIF(IsTemp, "ddpregagenda_tmp", "ddpregagenda_dbt")+" solve, "
          +            IIF(IsTemp, "ddpregagenda_tmp", "ddpregagenda_dbt")+" quest, "
          + "        ddepoacnt_dbt rootD, dfininstr_dbt fin "
          + "  where vt.t_RegisterID = ?" 
          + "    and solve.t_AgendaID = vt.t_SolveID "
          + "    and quest.t_AgendaID = solve.t_ParentID "
          + "    and rootD.t_AutoKey = vt.t_HolderAccID "
          + "    and fin.t_FIID = vt.t_FIID "
          +          IIF(IsTemp, "and vt.t_Action <> " + string(3 /*REGLIN_DELETE*/), "")
          + "  order by vt.t_HolderID, vt.t_HolderAccID, vt.t_FIID, quest.t_Number, solve.t_Number";

    cmd_solve = DL_RSDCommand(sql);

    cmd_solve.AddParam(reestr.RegisterID);

    if(cmd_solve.GetCount() > 0)
      DataSet_solve = cmd_solve.Execute();
      

      var NumVotes_Yes = 0.0, NumVotes_No = 0.0, NumVotes_Abstention = 0.0, NumVotes = 0.0;
      var HolderName = "", HolderCode = "";
      var Note = "", Number = "";

      var VT_SIZE_FIELD_HOLDERCODE  = 18,
          VT_SIZE_FIELD_HOLDERNAME  = 23,
          VT_SIZE_FIELD_BRIEFCODE   = 21,
          VT_SIZE_FIELD_FICODE      = 13,
          VT_SIZE_FIELD_FINAME      = 14,
          VT_SIZE_FIELD_NUMVOTING   = 14,
          VT_SIZE_FIELD_SOLVECAND   = 24,
          VT_SIZE_FIELD_YES         = 12,
          VT_SIZE_FIELD_NO          = 12,
          VT_SIZE_FIELD_ABSTENTION  = 12,
          VT_SIZE_FIELD_BYPROXY     = 13,
          VT_SIZE_FIELD_RESTRICTION = 13,
          VT_SIZE_FIELD_NOTE        = 22;

      EmptyStr();

      PrintCell( "Голосование: " );
      Rep.AutoScan( "[\n" + HeadTable_vt + "]" );
      Format = "ex_B(rlb)";
      while(DataSet_solve.moveNext())

        NumVotes_Yes        = 0.0;
        NumVotes_No         = 0.0;
        NumVotes_Abstention = 0.0;
        NumVotes            = 0.0;

        HolderName = "";
        HolderCode = "";

        Number = "";

        Note = "";

        if( ПолучитьСубъекта(DataSet_solve.HolderID, party) == 0 )
          HolderCode = ПолучитьКодСубъекта(DataSet_solve.HolderID, PTCK_CONTR);
          HolderName = party.rec.ShortName;
        end;

        Number = DataSet_solve.QuestNumber+"."+DataSet_solve.Number+". "+DataSet_solve.Name;

        Note = IIF(DataSet_solve.HolderID != DataSet_solve.Owner, "Залогодержатель", "");

        if(DataSet_solve.Type == DP_REGAGENDA_TYPE_CUMULATIVE) //Кумулятивное
          NumVotes = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes*DataSet_solve.Rate), DP_GetPrecision(DataSet_solve.NumVotes*DataSet_solve.Rate, DataSet_solve.SumPrecision), "");
          
          if(DataSet_solve.VotingByProxy == SET_CHAR)
            NumVotes_Yes        = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes_Yes), DP_GetPrecision(DataSet_solve.NumVotes_Yes, DataSet_solve.SumPrecision), "");
            NumVotes_No         = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes_No), DP_GetPrecision(DataSet_solve.NumVotes_No, DataSet_solve.SumPrecision), "");
            NumVotes_Abstention = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes_Abstention), DP_GetPrecision(DataSet_solve.NumVotes_Abstention, DataSet_solve.SumPrecision), "");
          end;

          PrintCellSize( HolderCode,                  VT_SIZE_FIELD_HOLDERCODE, 0, Format );
          PrintCellSize( HolderName,                  VT_SIZE_FIELD_HOLDERNAME, 0, Format );
          PrintCellSize( DataSet_solve.BriefCode,     VT_SIZE_FIELD_BRIEFCODE,  0, Format );
          PrintCellSize( DataSet_solve.FI_Code,       VT_SIZE_FIELD_FICODE,     0, Format );
          PrintCellSize( DataSet_solve.FI_Name,       VT_SIZE_FIELD_FINAME,     0, Format );
          PrintCellSize( NumVotes,                    VT_SIZE_FIELD_NUMVOTING,  0, Format );
          PrintCellSize( Number,                      VT_SIZE_FIELD_SOLVECAND,  0, Format );
          PrintCellSize( NumVotes_Yes,                VT_SIZE_FIELD_YES,        0, Format );
          PrintCellSize( NumVotes_No,                 VT_SIZE_FIELD_NO,         0, Format );
          PrintCellSize( NumVotes_Abstention,         VT_SIZE_FIELD_ABSTENTION, 0, Format );
          PrintCellSize( DataSet_solve.VotingByProxy, VT_SIZE_FIELD_BYPROXY,    0, Format );
          PrintCellSize( DataSet_solve.Restriction,   VT_SIZE_FIELD_RESTRICTION,0, Format );
          PrintCellSize( Note,                        VT_SIZE_FIELD_NOTE,       0, Format );
          
          sql =   " select cand.*, cml.* "
                + "   from "+IIF(IsTemp, "ddpregagenda_tmp", "ddpregagenda_dbt")+" cand, "
                +            IIF(IsTemp, "ddpregcml_tmp", "ddpregcml_dbt")+" cml "
                + "  where cml.t_VoteID = ? "
                + "    and cand.t_AgendaID = cml.t_CandidadID "
                +          IIF(IsTemp, "and cml.t_Action <> " + string(3 /*REGLIN_DELETE*/), "")
                + "  order by cand.t_AgendaID";

          cmd_cml = DL_RSDCommand(sql);
          cmd_cml.AddParam(DataSet_solve.VoteID);

          DataSet_cml = cmd_cml.Execute();
          while(DataSet_cml.moveNext())
            AddStr();

            NumVotes_Yes        = ЧислоCЗаданнойТочностью(double(DataSet_cml.NumVotes_Yes), DP_GetPrecision(DataSet_cml.NumVotes_Yes, DataSet_solve.SumPrecision), "");
            NumVotes_No         = 0.0;
            NumVotes_Abstention = 0.0;
            
            PrintCellSize( HolderCode,                  VT_SIZE_FIELD_HOLDERCODE,  0, Format );
            PrintCellSize( HolderName,                  VT_SIZE_FIELD_HOLDERNAME,  0, Format );
            PrintCellSize( DataSet_solve.BriefCode,     VT_SIZE_FIELD_BRIEFCODE,   0, Format );
            PrintCellSize( DataSet_solve.FI_Code,       VT_SIZE_FIELD_FICODE,      0, Format );
            PrintCellSize( DataSet_solve.FI_Name,       VT_SIZE_FIELD_FINAME,      0, Format );
            PrintCellSize( NumVotes,                    VT_SIZE_FIELD_NUMVOTING,   0, Format );
            PrintCellSize( DataSet_cml.Name,            VT_SIZE_FIELD_SOLVECAND,   0, Format );
            PrintCellSize( NumVotes_Yes,                VT_SIZE_FIELD_YES,         0, Format );
            PrintCellSize( NumVotes_No,                 VT_SIZE_FIELD_NO,          0, Format );
            PrintCellSize( NumVotes_Abstention,         VT_SIZE_FIELD_ABSTENTION,  0, Format );
            PrintCellSize( DataSet_solve.VotingByProxy, VT_SIZE_FIELD_BYPROXY,     0, Format );
            PrintCellSize( DataSet_solve.Restriction,   VT_SIZE_FIELD_RESTRICTION, 0, Format );
            PrintCellSize( Note,                        VT_SIZE_FIELD_NOTE,        0, Format );

          end;
        else //Простое
          NumVotes = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes), DP_GetPrecision(DataSet_solve.NumVotes, DataSet_solve.SumPrecision), "");

          if(DataSet_solve.VotingByProxy == SET_CHAR)
            NumVotes_Yes        = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes_Yes), DP_GetPrecision(DataSet_solve.NumVotes_Yes, DataSet_solve.SumPrecision), "");
            NumVotes_No         = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes_No), DP_GetPrecision(DataSet_solve.NumVotes_No, DataSet_solve.SumPrecision), "");
            NumVotes_Abstention = ЧислоCЗаданнойТочностью(double(DataSet_solve.NumVotes_Abstention), DP_GetPrecision(DataSet_solve.NumVotes_Abstention, DataSet_solve.SumPrecision), "");
          else
            if(DataSet_solve.VoteResult == DP_REGVOTE_RESULT_YES)
              NumVotes_Yes = DataSet_solve.NumVotes;
            elif(DataSet_solve.VoteResult == DP_REGVOTE_RESULT_NO)
              NumVotes_No = DataSet_solve.NumVotes;
            elif(DataSet_solve.VoteResult == DP_REGVOTE_RESULT_ABSTENTION)
              NumVotes_Abstention = DataSet_solve.NumVotes;
            end;
          end;

          PrintCellSize( HolderCode,                  VT_SIZE_FIELD_HOLDERCODE,  0, Format );
          PrintCellSize( HolderName,                  VT_SIZE_FIELD_HOLDERNAME,  0, Format );
          PrintCellSize( DataSet_solve.BriefCode,     VT_SIZE_FIELD_BRIEFCODE,   0, Format );
          PrintCellSize( DataSet_solve.FI_Code,       VT_SIZE_FIELD_FICODE,      0, Format );
          PrintCellSize( DataSet_solve.FI_Name,       VT_SIZE_FIELD_FINAME,      0, Format );
          PrintCellSize( NumVotes,                    VT_SIZE_FIELD_NUMVOTING,   0, Format );
          PrintCellSize( Number,                      VT_SIZE_FIELD_SOLVECAND,   0, Format );
          PrintCellSize( NumVotes_Yes,                VT_SIZE_FIELD_YES,         0, Format );
          PrintCellSize( NumVotes_No,                 VT_SIZE_FIELD_NO,          0, Format );
          PrintCellSize( NumVotes_Abstention,         VT_SIZE_FIELD_ABSTENTION,  0, Format );
          PrintCellSize( DataSet_solve.VotingByProxy, VT_SIZE_FIELD_BYPROXY,     0, Format );
          PrintCellSize( DataSet_solve.Restriction,   VT_SIZE_FIELD_RESTRICTION, 0, Format );
          PrintCellSize( Note,                        VT_SIZE_FIELD_NOTE,        0, Format );
        end;

        AddStr();
        Format = "";

      end;
    end;

  end;

  /*подвал отчета*/
  DP_StdFooter_Ex(Rep, FontStyleTitel, null, null, TableWidth);

  Rep.PrintRep();
  if( IsExcel )
    Rep.PrintWinRep();
    Rep.ShowWinRep();
  end;

  return 0;
end;
