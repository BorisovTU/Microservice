/*
$Name:        dpmassexec.mac
$Module:      Депозитарий
$Description: Массовые действия на шагах
*/

import "opr_depo.mac";

private const OBJTYPE_DEPODRAFT = 104;

macro DP_SetErrorOprTemp( PaymentID, ErrorNumber, ErrorMessage )
  /* и исключаем документ из дальнейшей обработки */
  var cmd, query;

  query = "UPDATE doprtemp_tmp SET t_errorstatus = ?, t_errormessage = ? where t_errorstatus = 0 and t_SkipDocument = 0";

  if(PaymentID)
    query = query + " and t_OrderID IN (select mv.t_DraftID from dspdrmove_dbt mv where mv.t_PaymentID = ?)";
  end;

  cmd = RSDCommand(query);
  cmd.addParam( "", RSDBP_IN, ErrorNumber ); 
  cmd.addParam( "", RSDBP_IN, ErrorMessage ); 
  if(PaymentID)
    cmd.addParam( "", RSDBP_IN, PaymentID );
  end;

  cmd.NullConversion = true;
  cmd.execute();
end;

macro DP_SqlSavePoint()
  var PointName = "";

  OraTrnSavePoint(PointName);

  return PointName; 
end;


private class DP_SaveErrsData(_PaymentID, _ErrorNumber, _ErrorMessage)
  var PaymentID    = _PaymentID;
  var ErrorNumber  = _ErrorNumber;     
  var ErrorMessage = _ErrorMessage;   
end;

macro DP_SqlRollBackPoint(pointName)
  var errors = TArray();
  var query, cmd, DataSet;
  
  query =   " select mv.t_PaymentID, ot.t_errorstatus, ot.t_errormessage "
          + "   from doprtemp_tmp ot, dspdrmove_dbt mv "
          + "  where ot.t_SkipDocument = 0 "
          + "    and ot.t_errorstatus <> 0 "
          + "    and mv.t_DraftID = ot.t_OrderID ";
  cmd = DL_RSDCommand(query);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    errors[errors.size] = DP_SaveErrsData(DataSet.PaymentID, DataSet.ErrorStatus, DataSet.ErrorMessage);
  end;
  
  OraTrnRollbackToSavePoint(pointName);

  if(errors.size > 0)
    var i = 0;
    while(i < errors.size)
      DP_SetErrorOprTemp(errors[i].PaymentID, errors[i].ErrorNumber, errors[i].ErrorMessage);
      i = i + 1;
    end;
  end;
end;

// Установить даты операции в массовом режиме 
// Аналог DefineOprDate для единичного режима исполнения
CLASS DP_MassOperDate()
  PRIVATE VAR m_init = false;

  PRIVATE MACRO Init():INTEGER
    SQL_Execute("DELETE FROM doprsetdates_tmp");
    m_init = true;

    return 0;
  ONERROR
    return 1;
  END;

  MACRO Execute( Msg:STRING ):INTEGER
     if( m_init )     
        m_init = false;

        SQL_Execute( "DECLARE "+
                     " v_Error INTEGER; "+
                     "BEGIN "+
                     " v_Error := RSI_RsbOperation.procMassSetOprDates( true ); "+
                     " IF( v_Error != 0 ) THEN "+
                     "   RAISE_APPLICATION_ERROR( -20101, 'Error procMassSetOprDates' ); "+
                     " END IF; "+
                     "END; ", Msg, true );
     end;

     return 0;
  ONERROR
     return 1;
  END;

  MACRO InsertDate( NumberDate:INTEGER, NewDate:DATE ):INTEGER
     
     var cmd = RsdCommand( " INSERT INTO doprsetdates_tmp( t_ID_Operation, t_ID_Step, t_DateKindID, t_DateNew ) " +
                           " SELECT ot.t_ID_Operation, ot.t_ID_Step, okd.t_DateKindID, ? " +
                           "   FROM DOPRTEMP_VIEW ot, doprkdate_dbt okd " +
                           "  WHERE okd.t_DocKind = ot.t_DocKind AND okd.t_NumberDate = ? " );

     cmd.addParam( "", RSDBP_IN, NewDate );
     cmd.addParam( "", RSDBP_IN, NumberDate );

     if( not m_init )
        Init();
     end;

     SQL_Execute( cmd );
     return 0;

  ONERROR
     return 1;
  END;

  MACRO InsertDateValue( NumberDate:INTEGER, NewDate:DATE ):INTEGER
     
     var cmd = RsdCommand( " INSERT INTO doprsetdates_tmp( t_ID_Operation, t_ID_Step, t_DateKindID, t_DateNew ) " +
                           " SELECT ot.t_ID_Operation, ot.t_ID_Step, okd.t_DateKindID, case when ? < pm.t_ValueDate then pm.t_ValueDate else ? end " +
                           "   FROM DOPRTEMP_VIEW ot, doprkdate_dbt okd, dspdrmove_dbt mv, dpmpaym_dbt pm " +
                           "  WHERE okd.t_DocKind = ot.t_DocKind AND okd.t_NumberDate = ? " +
                           "    AND mv.t_DraftID = TO_NUMBER(ot.t_DocumentID) AND pm.t_PaymentID = mv.t_PaymentID " );

     cmd.addParam( "", RSDBP_IN, NewDate );
     cmd.addParam( "", RSDBP_IN, NewDate );
     cmd.addParam( "", RSDBP_IN, NumberDate );

     if( not m_init )
        Init();
     end;

     SQL_Execute( cmd );
     return 0;

  ONERROR
     return 1;
  END;

END;

// Установить статус операции в массовом режиме 
// Аналог InsertOprStatus для единичного режима исполнения
CLASS DP_MassOperStatus()
  PRIVATE VAR m_init = false;

  PRIVATE MACRO Init():INTEGER
    SQL_Execute("DELETE FROM doprstval_tmp");
    m_init = true;

    return 0;
  ONERROR
    return 1;
  END;

  MACRO Execute( Msg:STRING ):INTEGER
     if( m_init )
        m_init = false;

        SQL_Execute( "{ CALL RSI_RsbOperation.procSetOprStatusValue() }", Msg, true );
     end;

     return 0;
  ONERROR
     return 1;
  END;

  MACRO Insert( StatusKindID:INTEGER, NumValue:INTEGER, where:STRING /*, ... параметры WHERE */ ):INTEGER
     
     var cmd = RsdCommand( " INSERT INTO doprstval_tmp (t_ID_Operation, t_StatusKindID, t_DocKind, t_ID_Step, t_NumValue) " +
                           " SELECT opr.t_ID_Operation, ?, opr.t_DocKind, opr.t_ID_Step, ?" +                       
                           "   FROM doprtemp_view opr, dspdraft_dbt dr " +
                           " WHERE  TO_NUMBER(opr.t_DocumentID) = dr.t_AutoKey " +
                           IIF( where != NULL, " AND " + where, "" )
                         );

     cmd.addParam( "", RSDBP_IN, StatusKindID  );
     cmd.addParam( "", RSDBP_IN, NumValue ); 

     VAR i = 4, Val;
     while( getparm( i, Val ) )
       cmd.addParam( "", RSDBP_IN, Val ); 
       i = i + 1;
     end;

     if( not m_init )
        Init();
     end;

     SQL_Execute( cmd );
     return 0;

  ONERROR
     return 1;
  END;

END;

macro DP_MassChangePaymStatus()
  var sql, cmd;
  var ErrPaymentID = 0;
  
  sql =  "DECLARE "
       + "  v_stat NUMBER;"
       + "BEGIN "
       + "  FOR one_pm IN (SELECT mv.t_PaymentID, oprtemp.t_ID_Operation, oprtemp.t_ID_Step, oprtemp.t_OrderID "
       + "                   FROM DOPRTEMP_VIEW oprtemp, dspdrmove_dbt mv "
       + "                  WHERE mv.t_DraftID = oprtemp.t_OrderID "
       + "                ) LOOP "
       + "     v_stat := PM_COMMON.ChangePaymStatus(one_pm.t_PaymentID, RSB_PAYMENT.PM_FINISHED, one_pm.t_ID_Operation, one_pm.t_ID_Step, ?); "
       + "     IF v_stat <> 0 THEN "
       + "       UPDATE doprtemp_tmp SET t_errorstatus = 1, t_errormessage = 'Ошибка при установке статуса платежа' where t_OrderID = one_pm.t_OrderID; "
       + "     END IF; "
       + "  END LOOP; "
       + "END; ";
   
  cmd = RSDCommand(sql);
  cmd.addParam( "", RSDBP_IN, {oper} );

  cmd.execute();

  return 0;
end;

private class SubCarryData(_DraftID, _paym, _OprAccType, _Corschem, _PayerFaceAccount, _ReceiverFaceAccount, _carryDate, _DraftAllParms)
  var DraftID = _DraftID;
  var paym = TRecHandler("pmpaym.dbt");
  var OprAccType          = _OprAccType;
  var Corschem            = _Corschem;
  var PayerFaceAccount    = _PayerFaceAccount;
  var ReceiverFaceAccount = _ReceiverFaceAccount;
  var carryDate           = _carryDate;
  var DraftAllParms       = _DraftAllParms; 
  
  copy(paym,    _paym);
end;


class (RsbBatchPaymTrn) DP_RsbBatchPaymTrnForCarryStep
  InitRsbBatchPaymTrn();

  macro AppRunFunction()
    return 0;
  end;
  
  macro CommitFunction(iPackStartRec : integer, iCarry : integer, ID_Operation : integer, ID_Step : integer)
    return 0;
  end;
  
  macro RollbackFunction(iPackStartRec : integer, iCarry : integer, ID_Operation : integer, ID_Step : integer)
    return 0;
  end;
end;

class DP_BatchPaymTrn
  private var m_batchTrn = DP_RsbBatchPaymTrnForCarryStep();
  private var m_DraftParms;

  private var m_AinPEnabled;

  GetAinPAccState( m_AinPEnabled );

  macro SetContextParams(_spdraft, _spgr, _paym, _debet, _credit, _rmprop, _ID_Operation, _ID_Step)
    m_DraftParms = DP_DraftAllParms(_spdraft, _spgr, _paym, _rmprop, _debet, _credit, _ID_Operation, _ID_Step)
  end;

  macro GetID_Operation()
    return m_DraftParms.ID_Operation();
  end;

  macro GetID_Step()
    return m_DraftParms.ID_Step();
  end;

  macro DraftAllParms()
    return m_DraftParms;
  end;

  macro AddOneAccTrnByPaym(carryDate:date, PayerFaceAccount:string, ReceiverFaceAccount:string, ground:string)
    var accTrn = RsbAccTransactionData();
    var err = 0, stat = 0;          

    accTrn.Chapter         = 5;
    accTrn.Date_Carry      = carryDate;
    accTrn.Number_Pack     = m_DraftParms.paym.rec.NumberPack;
    accTrn.Numb_Document   = m_DraftParms.rmprop.rec.Number;
    accTrn.ResultCarry     = 0;
    accTrn.Shifr_Oper      = 18;

    accTrn.Department      = m_DraftParms.spdraft.rec.Department;
    accTrn.FIIDPayer       = m_DraftParms.paym.rec.FIID;
    accTrn.AccountPayer    = PayerFaceAccount;
    accTrn.SumPayer        = m_DraftParms.paym.rec.Amount;
    accTrn.SumReceiver     = m_DraftParms.paym.rec.Amount;
    accTrn.FIIDReceiver    = m_DraftParms.paym.rec.FIID;
    accTrn.AccountReceiver = ReceiverFaceAccount;

    accTrn.Ground          = ground;

    //Подготовить данные для субпроводок
    if((m_DraftParms.paym.rec.IndoorStorage == 0) and (m_AinPEnabled))
      var OprAccType  = NULL;
      var Corschem = NULL;
      var SubAccData = NULL;
      
      if(m_DraftParms.spdraft.rec.Kind == SP_DEPOPER_TRANSFERORDER)
        OprAccType = DP_OPRACC_RECEIVER;
        Corschem   = m_DraftParms.credit.rec.Corschem;
      elif(m_DraftParms.spdraft.rec.Kind == SP_DEPOPER_ENROLMENT)
        OprAccType = DP_OPRACC_PAYER;
        Corschem   = m_DraftParms.debet.rec.Corschem;
      end;

      SubAccData = DPSubAccData(m_DraftParms.paym.rec, NULL, OprAccType, Corschem, m_DraftParms);
      
      if( ExecuteSubAccCarry( true,
                              0, 
                              m_DraftParms.paym.rec.PayerDpNode, 
                              m_DraftParms.paym.rec.ReceiverDpNode, 
                              PayerFaceAccount, 
                              ReceiverFaceAccount, 
                              m_DraftParms.paym.rec.FIID, 
                              m_DraftParms.paym.rec.Amount, 
                              carryDate, 
                              m_DraftParms.paym.rec.PaymentID, 
                              SubAccData ) )
        //если не удалось сформировать субпроводку, то пропускаем только её
        err = 1;
        DP_SetErrorOprTemp( m_DraftParms.paym.rec.PaymentID, err, DPError.GetErr() );
      end;
      
      if((not err) and (SubAccData.arrSubAccDoc.size > 0))
        var DocumentsList = RsbAccSubDocuments();
        var i = 0;
        while(i < SubAccData.arrSubAccDoc.size)

          if(SubAccData.arrSubAccDoc[i].subdoc.rec.SubCarryID > 0)
            DocumentsList.AddPlanSubDoc(SubAccData.arrSubAccDoc[i].subdoc);  
          else
            DocumentsList.AddSubDocData(SubAccData.arrSubAccDoc[i].subdoc, SubAccData.arrSubAccDoc[i].AnaliticsID, SubAccData.arrSubAccDoc[i].Account, SubAccData.arrSubAccDoc[i].SubAccountCode);
          end;

          i = i + 1;
        end;

        accTrn.AddSubDocument(DocumentsList);
      end;
    end;

    if(not err)
      if( m_batchTrn.AddTransaction( m_DraftParms.paym.rec.PaymentID, accTrn, ACCTRN_STATUS_DOCUMENT, PM_CARRY_REASON_EXECUTION, 0, m_DraftParms.ID_Operation(), m_DraftParms.ID_Step() ) < 0)
        stat = 1;
      end;
    end;

    return stat;
  end;

  macro Execute()
    var errPaymentID:TArray;
    var errCode:TArray;
    var errMess:TArray;
    var err = 0;

    if( not m_batchTrn.Execute() )
      DPError.SetErr( "Ошибка при исполнении проводок" );
      err = 1;
    end;
    
    if((not err) and (not m_batchTrn.GetErrors(errPaymentID, errCode, errMess)))
      err =  1;
    end;
    
    if(not err)
      var i = 0;
      if(errPaymentID.size() > 0)
        while( i < errPaymentID.size() )

          if((errCode[i] > 0) or (errMess[i] != ""))
            DP_SetErrorOprTemp( errPaymentID[i], errCode[i], errMess[i] );
          end;
          i = i + 1;
        end;
      end;
    end;

    return err;
  end;

end;

//Массовая генерация номера в ОЖД для поручений депо
macro DP_MassGenerateDraftOprXid()
  var err = 0;
  var RefID = 0;
  var cmd;

  if( GetReferenceIDByType( OBJTYPE_OPRMAGDEPO, /*Операционный журнал депозитария*/
                            1, /*REFOBJ_OPRMAGDEPO*/   /*Номер записи в операционном журнале депо*/
                            RefID ) != 0 )
    DPError.SetErr( "Ошибка при определении референса" );
    err = 1;
  end;

  if(not err)
    cmd = RsdCommand("DELETE FROM drefgenprm_tmp");
    SQL_Execute( cmd );

    cmd = RsdCommand( " INSERT INTO drefgenprm_tmp(t_ID, t_ObjKind, t_ObjectID, t_Date, t_Time, t_MeterDate, t_MeterTime, t_RefNum, t_SeqNum, t_Error, t_ErrMsg) " +
                      " SELECT t_RowNum, "+OBJTYPE_OPRMAGDEPO+", t_ObjectID * t_k, " +
                      "        TO_DATE('01.01.0001', 'dd.mm.yyyy'), TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), TO_DATE('01.01.0001', 'dd.mm.yyyy'), TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), " +
                      "        CHR(1), 0, 0, CHR(1) " +
                      "   FROM (  SELECT t_ObjectID, t_k, ROWNUM AS t_RowNum " +
                      "             FROM (SELECT dr.t_AutoKey AS t_ObjectID, 1 AS t_k " +
                      "   FROM DOPRTEMP_VIEW ot, dspdraft_dbt dr " +
                      "  WHERE dr.t_AutoKey = ot.t_OrderID " +
                      "                          AND dr.t_OperState != 2 " + /*DP_INVSTATUSORDER_REJECT*/
                      "                          AND dr.t_OperState != 3 " + /*DP_INVSTATUSORDER_KVIT*/
                      "                   UNION ALL " +
                      "                   SELECT dr.t_AutoKey AS t_ObjectID, -1 AS t_k " +
                      "                     FROM DOPRTEMP_VIEW ot, " +
                      "                          dspdraft_dbt dr, " +
                      "                          doprkoper_dbt kopr " +
                      "                    WHERE     dr.t_AutoKey = ot.t_OrderID " +
                      "                          AND dr.t_OperState != 2 " + /*DP_INVSTATUSORDER_REJECT*/
                      "                          AND dr.t_OperState != 3 " + /*DP_INVSTATUSORDER_KVIT*/
                      "                          AND dr.t_Kind = 800 " + /*SP_DEPOPER_BOOKORDER*/
                      "                          AND kopr.t_Kind_Operation = dr.t_Kind_Operation " +
                      "                          AND (INSTR (kopr.t_SysTypes, 'П') != 0 or INSTR (kopr.t_SysTypes, 'Р') != 0) " +
                      "                   ORDER BY t_ObjectID, t_k desc) " +
                      "        ) "
                    );

    SQL_Execute( cmd );

    err = GenerateReferenceMass( RefID, false );

    if(not err)

      cmd = RsdCommand("UPDATE dspdraft_dbt dr " +
                       "   SET dr.t_OprXid = (SELECT prm.t_RefNum FROM drefgenprm_tmp prm WHERE prm.t_ObjKind = "+OBJTYPE_OPRMAGDEPO+" AND prm.t_ObjectID = dr.t_AutoKey), " +
                       "       dr.t_OprXid2= (SELECT prm.t_RefNum FROM drefgenprm_tmp prm WHERE prm.t_ObjKind = "+OBJTYPE_OPRMAGDEPO+" AND prm.t_ObjectID = -dr.t_AutoKey), " +
                       "       dr.t_FactOprDate = ?, " +
                       "       dr.t_FactOprTime = ?,  " +
                       "       dr.t_Oper = ? " +
                       " WHERE dr.t_AutoKey IN (SELECT ot.t_OrderID " +
                       "                          FROM DOPRTEMP_VIEW ot, drefgenprm_tmp prm " +
                       "                         WHERE prm.t_ObjKind = "+OBJTYPE_OPRMAGDEPO+" AND prm.t_ObjectID = ot.t_OrderID " +
                       "                           AND prm.t_Error = 0 " +
                       "                           AND prm.t_ObjectID > 0 " +
                       "                       ) "
                      );

      cmd.addParam( "", RSDBP_IN, date() );
      cmd.addParam( "", RSDBP_IN, time() );
      cmd.addParam( "", RSDBP_IN, {oper} );

      SQL_Execute( cmd );


      cmd = RsdCommand( "UPDATE doprtemp_tmp oprtemp "
                        "SET (t_errorstatus, t_errormessage) = (SELECT prm.t_Error, prm.t_ErrMsg FROM drefgenprm_tmp prm where prm.t_ObjKind = "+OBJTYPE_OPRMAGDEPO+" AND prm.t_ObjectID = oprtemp.t_OrderID) "
                        "WHERE oprtemp.t_OrderID IN (SELECT prm.t_ObjectID FROM drefgenprm_tmp prm WHERE prm.t_ObjKind = "+OBJTYPE_OPRMAGDEPO+" AND prm.t_Error <> 0)");
      SQL_Execute( cmd );
    end;

  end;

  return err;
end;

//Массовое формирование отчетов об исполнении для получателей
macro DP_MassRegExtGroundToGrRep()
  var err = 0;
  var RefID = 0;
  var cmd, query, DataSet;
  var spgrArr = TArray();
  var grrepArr = TArray();
  var realSpgrIDArr = TArray();
  var spgr = TRecHandler("spground.dbt");
  var grrep = TRecHandler("dpgrrep.dbt");
  var i = 0;
   
//1. Создадим исходящие документы во временной таблице, чобы потом выделить им номера по референсу
  cmd = RsdCommand("DELETE FROM dspground_tmp");
  SQL_Execute( cmd );
  
  query = "INSERT INTO dspground_tmp (T_SPGROUNDID  ,"  +
                                    " T_DOCLOG      ,"  +
                                    " T_KIND        ,"  +
                                    " T_DIRECTION   ,"  +
                                    " T_XLD         ,"  +
                                    " T_REGISTRDATE ,"  +
                                    " T_REGISTRTIME ,"  +
                                    " T_PARTY       ,"  +
                                    " T_ALTXLD      ,"  +
                                    " T_SIGNEDDATE  ,"  +
                                    " T_SIGNEDTIME  ,"  +
                                    " T_PROXY       ,"  +
                                    " T_DIVISION    ,"  +
                                    " T_REFERENCES  ,"  +
                                    " T_RECEPTIONIST,"  +
                                    " T_COPIES      ,"  +
                                    " T_SENT        ,"  +
                                    " T_DELIVERYKIND,"  +
                                    " T_BACKOFFICE  ,"  +
                                    " T_COMMENT     ,"  +
                                    " T_SOURCEDOCID ,"  +
                                    " T_SOURCEDOCKIND," + 
                                    " T_DOCTEMPLATE ,"  + 
                                    " T_TERMINATEDATE," +
                                    " T_PARTYNAME   ,"  + 
                                    " T_PARTYCODE   ,"  + 
                                    " T_BEGINNINGDATE," +
                                    " T_SENTDATE    ,"  +
                                    " T_SENTTIME    ,"  +
                                    " T_DEPARTMENT  ,"  +
                                    " T_BRANCH      ,"  +
                                    " T_PARENT      ,"  +
                                    " T_USERLOG     ,"  +
                                    " T_VERSION     ,"  +
                                    " T_ISMAKEAUTO  ,"  +
                                    " T_TECHAUTODOC ,"  +
                                    " T_DEPONENT    ,"  +
                                    " T_HAVESUBJLIST,"  +
                                    " T_SUBJECTID   ,"  +
                                    " T_REGISTERID  ,"  +
                                    " T_DEPOACNTID  ,"  +
                                    " T_MSGNUMBER   ,"  +
                                    " T_MSGDATE     ,"  +
                                    " T_MSGTIME     ,"  +
                                    " T_METHODAPPLIC "
                                    " ) " +
          "SELECT gr.t_ID, "                               //T_SPGROUNDID
               + string(LLCLASS_KINDDOC_DOCDEPO) + ", "    //T_DOCLOG
               + "(CASE WHEN dr.t_OperState = "+DP_INVSTATUSORDER_REJECT+" THEN "+301/*DP_INFREPORT_REJECT*/+" ELSE "+366/*DOCKIND_REPDEPODRAFT*/+" END), " //T_KIND
               + string(EXITING) + ", "                    //T_DIRECTION
               + "CHR(1), "                                //T_XLD
               + GetSQLDate(date())+" , "                  //T_REGISTRDATE
               + "TO_DATE('01.01.0001 " + string(time()) + "', 'dd.mm.yyyy HH24:MI:SS') , "  //T_REGISTRTIME
               + "gr.t_Recipient, "                        //T_PARTY
               + "CHR(1), "                                //T_ALTXLD
               + "TO_DATE('01.01.0001', 'dd.mm.yyyy') , "  //T_SIGNEDDATE
               + "TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS') , " //T_SIGNEDTIME
               + "-1, "                                    //T_PROXY
               + string(DP_SelfDivision) + ", "            //T_DIVISION
               + "1, "                                     //T_REFERENCES
               + string({oper})+", "                       //T_RECEPTIONIST
               + "1, "                                     //T_COPIES
               + "gr.t_AutoSend, "                         //T_SENT
               + "gr.t_DeliveryKind, "                     //T_DELIVERYKIND
               + "'Z', "                                   //T_BACKOFFICE
               + "NVL(RTRIM(rsb_struct.getString(rsi_rsb_kernel.GetNote("+OBJTYPE_DEPODRAFT+", TO_CHAR(dr.t_AutoKey), "+3/*DP_NOTEKIND_REJECT*/+", "+GetSQLDate(date())+")), CHR(0)), CHR(1)), " //T_COMMENT
               + "0, "                                     //T_SOURCEDOCID
               + "0, "                                     //T_SOURCEDOCKIND
               + "0, "                                     //T_DOCTEMPLATE
               + "TO_DATE('01.01.0001', 'dd.mm.yyyy'), "   //T_TERMINATEDATE
               + "gr.t_RecipientName, "                    //T_PARTYNAME
               + "gr.t_RecipientCode, "                    //T_PARTYCODE
               + "TO_DATE('01.01.0001', 'dd.mm.yyyy'), "   //T_BEGINNINGDATE
               + "(CASE WHEN gr.t_AutoSend = 'X' THEN "+GetSQLDate(date())+" ELSE TO_DATE('01.01.0001', 'dd.mm.yyyy') END), " //T_SENTDATE
               + "(CASE WHEN gr.t_AutoSend = 'X' THEN TO_DATE('01.01.0001 " + string(time()) + "', 'dd.mm.yyyy HH24:MI:SS') ELSE TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS') END), " //T_SENTTIME
               + string({OperDprt}) + ", "                 //T_DEPARTMENT
               + string({OperDprtNode}) + ", "             //T_BRANCH
               + "0, "                                     //T_PARENT
               + "0, "                                     //T_USERLOG
               + "0, "                                     //T_VERSION
               + "CHR(0), "                                //T_ISMAKEAUTO
               + "0, "                                     //T_TECHAUTODOC
               + "(CASE WHEN gr.t_Desc > 0 THEN (SELECT spgr.t_Deponent FROM dspground_dbt spgr WHERE spgr.t_SPgroundID = gr.t_Desc) ELSE -1 END)," //T_DEPONENT
               + "CHR(0), "                                //T_HAVESUBJLIST
               + "-1, "                                    //T_SUBJECTID
               + "0, "                                     //T_REGISTERID
               + "0, "                                      //T_DEPOACNTID
               + "CHR(1), "                                //T_MSGNUMBER
               + "TO_DATE('01.01.0001', 'dd.mm.yyyy') , "  //T_MSGDATE
               + "TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'),  " //T_MSGTIME
               + "0 "                                      //T_METHODAPPLIC
         + "  FROM ddpgrrep_dbt gr, DOPRTEMP_VIEW ot, dspdraft_dbt dr " 
         + " WHERE dr.t_AutoKey = ot.t_OrderID " 
         + "   AND gr.t_SourceDocKind = dr.t_Kind "  
         + "   AND gr.t_SourceDocID = dr.t_AutoKey "
         + " ORDER BY gr.t_ID "; //!!!Сортировка обеспечивает порядок соответствия для spground и dpgprep

  cmd = RSDCommand(query);

  SQL_Execute( cmd );


//2. Выделяем номера по референсу
  if( GetReferenceIDByType( OBJTYPE_DEPOINFOPR, /*Депозитарный отчет*/
                            1, /*REFOBJ_INFOPR*/   /*номер депозитарного отчета*/
                            RefID ) != 0 )
    DPError.SetErr( "Ошибка при определении референса" );
    return 1;
  end;

  var cnt = 1;
  while((cnt > 0) and (not err))

    cmd = RsdCommand("DELETE FROM drefgenprm_tmp");
    SQL_Execute( cmd );

    cmd = RsdCommand( " INSERT INTO drefgenprm_tmp(t_ID, t_ObjKind, t_ObjectID, t_Date, t_Time, t_MeterDate, t_MeterTime, t_RefNum, t_SeqNum, t_Error, t_ErrMsg) " +
                      " SELECT spgr.t_SPgroundID, "+OBJTYPE_DEPOINFOPR+", spgr.t_SPgroundID, " +
                      "        TO_DATE('01.01.0001', 'dd.mm.yyyy'), TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), TO_DATE('01.01.0001', 'dd.mm.yyyy'), TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), " +
                      "        CHR(1), 0, 0, CHR(1) " +
                      "   FROM dspground_tmp spgr " +
                      "  WHERE spgr.t_Xld = CHR(1) "
                    );

       

    SQL_Execute( cmd );

    err = GenerateReferenceMass( RefID, false );

    if(not err)
      cmd = RsdCommand("UPDATE dspground_tmp spgr " +
                       "   SET spgr.t_Xld = (SELECT prm.t_RefNum FROM drefgenprm_tmp prm WHERE prm.t_ObjKind = "+OBJTYPE_DEPOINFOPR+" AND prm.t_ObjectID = spgr.t_SPgroundID) " +
                       " WHERE spgr.t_SPgroundID IN (SELECT prm.t_ObjectID " +
                       "                               FROM drefgenprm_tmp prm " +
                       "                              WHERE prm.t_ObjKind = "+OBJTYPE_DEPOINFOPR+
                       "                                AND prm.t_Error = 0 " +
                       "                                AND prm.t_RefNum <> CHR(1) "
                       "                                AND Not Exists(SELECT 1 " +
                       "                                                 FROM dspground_dbt sp " +
                       "                                                WHERE sp.t_Kind = spgr.t_Kind " +
                       "                                                  AND sp.t_Xld = prm.t_RefNum " +
                       "                                                  AND sp.t_Direction = spgr.t_Direction " +
                       "                                                  AND sp.t_Department = spgr.t_Department " +
                       "                                                  AND sp.t_Division = spgr.t_Division " +
                       "                                                  AND sp.t_RegistrDate = spgr.t_RegistrDate " +
                       "                                               )"
                       "                            ) "
                      );

      SQL_Execute( cmd );

      cmd = DL_RSDCommand("select 1 from dspground_tmp where t_Xld = CHR(1)");
      cnt = cmd.GetCount();
    end;
  end;

//3. Сохраняем документы в постоянной таблице. Формируем привязки к поручению. Формируем привязки к получателям отчетов
  if(not err)
    cmd = DL_RSDCommand("select * from dspground_tmp order by t_SPgroundID");
    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      i = spgrArr.size;
      spgrArr(i) = TRecHandler("spground.dbt");

      DataSet.GetRecord().CopyTo( spgrArr(i).rec );

      spgrArr(i).rec.SPgroundID = 0;
    end;

    cmd = DL_RSDCommand(   " SELECT gr.* "
                         + "   FROM ddpgrrep_dbt gr, DOPRTEMP_VIEW ot, dspdraft_dbt dr " 
                         + " WHERE dr.t_AutoKey = ot.t_OrderID " 
                         + "   AND gr.t_SourceDocKind = dr.t_Kind "  
                         + "   AND gr.t_SourceDocID = dr.t_AutoKey "
                         + " ORDER BY gr.t_ID " //!!!Сортировка обеспечивает порядок соответствия для spground и dpgprep
                      );
    DataSet = cmd.Execute();
    while(DataSet.moveNext())
      i = grrepArr.size;
      grrepArr(i) = TRecHandler("dpgrrep.dbt");

      DataSet.GetRecord().CopyTo( grrepArr(i).rec );
    end;

    if(spgrArr.size != grrepArr.size)
      err = 1;
      DPError.SetErr( "Ошибка при формировании исходящих документов для получаетелей отчета" );
    end;

    if(not err)
      var spgrCache = RsbSQLInsert("spground.dbt");

      spgrCache.AddRecordArray(spgrArr);
      spgrCache.AddReturning( "t_spgroundid", V_INTEGER );

      if(not spgrCache.insert())
        err = 1;
        DPError.SetErr( "Ошибка при сохранении исходящих документов для получаетелей отчета" );
      else
        spgrCache.GetReturning(realSpgrIDArr);
      end;

      if(not err)
        var grdocCache = RsbSQLInsert("spgrdoc.dbt");
        var repdocCache = RsbSQLInsert("dprepdoc.dbt");

        i = 0;
        while(i < grrepArr.size)

          var grdoc = TRecHandler("spgrdoc.dbt");
          var repdoc = TRecHandler("dprepdoc.dbt");

          grdoc.Clear();

          grdoc.rec.SourceDocID   = grrepArr[i].rec.SourceDocID;
          grdoc.rec.SourceDocKind = grrepArr[i].rec.SourceDocKind;
          grdoc.rec.SPGroundID    = realSpgrIDArr[i];
          
          grdocCache.AddRecord(grdoc);


          repdoc.Clear();

          repdoc.rec.GrRepID       = grrepArr[i].rec.ID;
          repdoc.rec.RepSPgroundID = realSpgrIDArr[i];

          repdocCache.AddRecord(repdoc);

          i = i + 1;
        end;

        if(not grdocCache.insert())
          err = 1;
          DPError.SetErr( "Ошибка при сохранении документов-приложений" );
        end;

        if((not err) and (not repdocCache.insert()))
          err = 1;
          DPError.SetErr( "Ошибка при сохранении записей о сформированных отчетах" );
        end;

      end;
    end;

//4. По всем поручениям, полученным из БОЦБ, формируем входящие документы под сделку
    if(not err)
      var SecDivision;

      GetRegistryValue( "SECUR\\OURSECUROFFICE", V_INTEGER, SecDivision, err );
      if( err )
        DPError.SetErr("Ошибка поиска настройки \"SECUR\\OURSECUROFFICE\"");
      end;
//4.1. Создаем входящие документы на основе исходящих во временной таблице      
      if(not err)

        var pt = TRecHandler("party.dbt");
        var OurBankName = "", OurBankCode = ПолучитьКодСубъекта({OurBank}, PTCK_CONTR);
        if( ПолучитьСубъекта({OurBank}, pt) == 0 )
          OurBankName = pt.rec.Name;
        end;
      
        cmd = RsdCommand("DELETE FROM dspground_tmp");
        SQL_Execute( cmd );        

        query = "INSERT INTO dspground_tmp (T_SPGROUNDID  ,"  +
                                      " T_DOCLOG      ,"  +
                                      " T_KIND        ,"  +
                                      " T_DIRECTION   ,"  +
                                      " T_XLD         ,"  +
                                      " T_REGISTRDATE ,"  +
                                      " T_REGISTRTIME ,"  +
                                      " T_PARTY       ,"  +
                                      " T_ALTXLD      ,"  +
                                      " T_SIGNEDDATE  ,"  +
                                      " T_SIGNEDTIME  ,"  +
                                      " T_PROXY       ,"  +
                                      " T_DIVISION    ,"  +
                                      " T_REFERENCES  ,"  +
                                      " T_RECEPTIONIST,"  +
                                      " T_COPIES      ,"  +
                                      " T_SENT        ,"  +
                                      " T_DELIVERYKIND,"  +
                                      " T_BACKOFFICE  ,"  +
                                      " T_COMMENT     ,"  +
                                      " T_SOURCEDOCID ,"  +
                                      " T_SOURCEDOCKIND," + 
                                      " T_DOCTEMPLATE ,"  + 
                                      " T_TERMINATEDATE," +
                                      " T_PARTYNAME   ,"  + 
                                      " T_PARTYCODE   ,"  + 
                                      " T_BEGINNINGDATE," +
                                      " T_SENTDATE    ,"  +
                                      " T_SENTTIME    ,"  +
                                      " T_DEPARTMENT  ,"  +
                                      " T_BRANCH      ,"  +
                                      " T_PARENT      ,"  +
                                      " T_USERLOG     ,"  +
                                      " T_VERSION     ,"  +
                                      " T_ISMAKEAUTO  ,"  +
                                      " T_TECHAUTODOC ,"  +
                                      " T_DEPONENT    ,"  +
                                      " T_HAVESUBJLIST,"  +
                                      " T_SUBJECTID   ,"  +
                                      " T_REGISTERID  ,"  +
                                      " T_DEPOACNTID  ,"  +
                                      " T_MSGNUMBER   ,"  +
                                      " T_MSGDATE     ,"  +
                                      " T_MSGTIME     ,"  +
                                      " T_METHODAPPLIC "
                                      " ) " +
            "SELECT rdoc.t_ID, "                             //T_SPGROUNDID
                 + string(LLCLASS_KINDDOC_SECUR) + ", "      //T_DOCLOG
                 + "ext_spgr.t_Kind, "                       //T_KIND
                 + string(ENTERING) + ", "                   //T_DIRECTION
                 + "CHR(1), "                                //T_XLD
                 + "ext_spgr.t_RegistrDate, "                //T_REGISTRDATE
                 + "TO_DATE('01.01.0001 " + string(time()) + "', 'dd.mm.yyyy HH24:MI:SS') , " //T_REGISTRTIME
                 + string({OurBank})+", "                    //T_PARTY
                 + "ext_spgr.t_Xld, "                        //T_ALTXLD
                 + "ext_spgr.t_RegistrDate, "                //T_SIGNEDDATE
                 + "ext_spgr.t_RegistrTime, "                //T_SIGNEDTIME
                 + "-1, "                                    //T_PROXY
                 + string(SecDivision) + ", "                //T_DIVISION
                 + "1, "                                     //T_REFERENCES
                 + string({oper})+", "                       //T_RECEPTIONIST
                 + "1, "                                     //T_COPIES
                 + "CHR(0), "                                //T_SENT
                 + "ext_spgr.t_DeliveryKind, "               //T_DELIVERYKIND
                 + "ext_spgr.t_BackOffice, "                 //T_BACKOFFICE
                 + "CHR(1), "                                //T_COMMENT
                 + "0, "                                     //T_SOURCEDOCID
                 + "0, "                                     //T_SOURCEDOCKIND
                 + "0, "                                     //T_DOCTEMPLATE
                 + "TO_DATE('01.01.0001', 'dd.mm.yyyy'), "   //T_TERMINATEDATE
                 + "'"+OurBankName+"', "                     //T_PARTYNAME
                 + "'"+OurBankCode+"', "                     //T_PARTYCODE
                 + "TO_DATE('01.01.0001', 'dd.mm.yyyy'), "   //T_BEGINNINGDATE
                 + "TO_DATE('01.01.0001', 'dd.mm.yyyy'), "   //T_SENTDATE
                 + "TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), " //T_SENTTIME
                 + string({OperDprt}) + ", "                 //T_DEPARTMENT
                 + string({OperDprtNode}) + ", "             //T_BRANCH
                 + "ext_spgr.t_SPgroundID, "                 //T_PARENT
                 + string(SPGRUSERLOG_OURENTER)+", "         //T_USERLOG
                 + "0, "                                     //T_VERSION
                 + "CHR(0), "                                //T_ISMAKEAUTO
                 + "0, "                                     //T_TECHAUTODOC
                 + "-1,"                                     //T_DEPONENT
                 + "CHR(0), "                                //T_HAVESUBJLIST
                 + "-1, "                                    //T_SUBJECTID
                 + "0, "                                     //T_REGISTERID
                 + "0, "                                     //T_DEPOACNTID
                 + "CHR(1), "                                //T_MSGNUMBER
                 + "TO_DATE('01.01.0001', 'dd.mm.yyyy') , "  //T_MSGDATE
                 + "TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'),  " //T_MSGTIME
                 + "0 "                                      //T_METHODAPPLIC
        + "   FROM ddpgrrep_dbt gr, ddprepdoc_dbt rdoc, dspground_dbt ext_spgr, DOPRTEMP_VIEW ot, dspdraft_dbt dr " 
        + "  WHERE dr.t_AutoKey = ot.t_OrderID " 
        + "    AND gr.t_SourceDocKind = dr.t_Kind "  
        + "    AND gr.t_SourceDocID = dr.t_AutoKey "
        + "    AND rdoc.t_GrRepID = gr.t_ID "
        + "    AND ext_spgr.t_SPgroundID = rdoc.t_RepSPgroundID "
        + "    AND Exists (select 1 from dspdrprop_dbt prop where prop.t_DraftID = dr.t_AutoKey and prop.t_DocumentKind = "+DL_DLGRDEAL+")";

        cmd = RSDCommand(query);

        SQL_Execute( cmd );

//4.2. Выделяем номера по референсу
        if( GetReferenceIDByType( OBJTYPE_KINDDOC, /*вид документа*/
                                  2, /*REFOBJ_ORD_ENTERING_OP*/   /*Номер входящего документа для операций с ц/б*/
                                  RefID ) != 0 )
          DPError.SetErr( "Ошибка при определении референса" );
          return 1;
        end;

        cnt = 1;
        while((cnt > 0) and (not err))

          cmd = RsdCommand("DELETE FROM drefgenprm_tmp");
          SQL_Execute( cmd );

          cmd = RsdCommand( " INSERT INTO drefgenprm_tmp(t_ID, t_ObjKind, t_ObjectID, t_Date, t_Time, t_MeterDate, t_MeterTime, t_RefNum, t_SeqNum, t_Error, t_ErrMsg) " +
                            " SELECT spgr.t_SPgroundID, "+OBJTYPE_KINDDOC+", spgr.t_SPgroundID, " +
                            "        TO_DATE('01.01.0001', 'dd.mm.yyyy'), TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), TO_DATE('01.01.0001', 'dd.mm.yyyy'), TO_DATE('01.01.0001 00:00:00', 'dd.mm.yyyy HH24:MI:SS'), " +
                            "        CHR(1), 0, 0, CHR(1) " +
                            "   FROM dspground_tmp spgr " +
                            "  WHERE spgr.t_Xld = CHR(1) "
                          );

          SQL_Execute( cmd );

          err = GenerateReferenceMass( RefID, false );

          if(not err)
            cmd = RsdCommand("UPDATE dspground_tmp spgr " +
                             "   SET spgr.t_Xld = (SELECT prm.t_RefNum FROM drefgenprm_tmp prm WHERE prm.t_ObjKind = "+OBJTYPE_KINDDOC+" AND prm.t_ObjectID = spgr.t_SPgroundID) " +
                             " WHERE spgr.t_SPgroundID IN (SELECT prm.t_ObjectID " +
                             "                               FROM drefgenprm_tmp prm " +
                             "                              WHERE prm.t_ObjKind = "+OBJTYPE_KINDDOC+
                             "                                AND prm.t_Error = 0 " +
                             "                                AND prm.t_RefNum <> CHR(1) "
                             "                                AND Not Exists(SELECT 1 " +
                             "                                                 FROM dspground_dbt sp " +
                             "                                                WHERE sp.t_Kind = spgr.t_Kind " +
                             "                                                  AND sp.t_Xld = prm.t_RefNum " +
                             "                                                  AND sp.t_Direction = spgr.t_Direction " +
                             "                                                  AND sp.t_Department = spgr.t_Department " +
                             "                                                  AND sp.t_Division = spgr.t_Division " +
                             "                                                  AND sp.t_RegistrDate = spgr.t_RegistrDate " +
                             "                                               )"
                             "                            ) "
                            );

            SQL_Execute( cmd );

            cmd = DL_RSDCommand("select 1 from dspground_tmp where t_Xld = CHR(1)");
            cnt = cmd.GetCount();
          end;
        end;

//4.3. Переносим в постоянную таблицу
        if(not err)
          
          query = "INSERT INTO dspground_dbt (T_SPGROUNDID  ,"  +
                                            " T_DOCLOG      ,"  +
                                            " T_KIND        ,"  +
                                            " T_DIRECTION   ,"  +
                                            " T_XLD         ,"  +
                                            " T_REGISTRDATE ,"  +
                                            " T_REGISTRTIME ,"  +
                                            " T_PARTY       ,"  +
                                            " T_ALTXLD      ,"  +
                                            " T_SIGNEDDATE  ,"  +
                                            " T_SIGNEDTIME  ,"  +
                                            " T_PROXY       ,"  +
                                            " T_DIVISION    ,"  +
                                            " T_REFERENCES  ,"  +
                                            " T_RECEPTIONIST,"  +
                                            " T_COPIES      ,"  +
                                            " T_SENT        ,"  +
                                            " T_DELIVERYKIND,"  +
                                            " T_BACKOFFICE  ,"  +
                                            " T_COMMENT     ,"  +
                                            " T_SOURCEDOCID ,"  +
                                            " T_SOURCEDOCKIND," + 
                                            " T_DOCTEMPLATE ,"  + 
                                            " T_TERMINATEDATE," +
                                            " T_PARTYNAME   ,"  + 
                                            " T_PARTYCODE   ,"  + 
                                            " T_BEGINNINGDATE," +
                                            " T_SENTDATE    ,"  +
                                            " T_SENTTIME    ,"  +
                                            " T_DEPARTMENT  ,"  +
                                            " T_BRANCH      ,"  +
                                            " T_PARENT      ,"  +
                                            " T_USERLOG     ,"  +
                                            " T_VERSION     ,"  +
                                            " T_ISMAKEAUTO  ,"  +
                                            " T_TECHAUTODOC ,"  +
                                            " T_DEPONENT    ,"  +
                                            " T_HAVESUBJLIST,"  +
                                            " T_SUBJECTID   ,"  +
                                            " T_REGISTERID  ,"  +
                                            " T_DEPOACNTID  ,"  +
                                            " T_MSGNUMBER   ,"  +
                                            " T_MSGDATE     ,"  +
                                            " T_MSGTIME     ,"  +
                                            " T_METHODAPPLIC "
                                            " ) " +
                               "SELECT 0, " +
                                     " T_DOCLOG      ,"  +
                                     " T_KIND        ,"  +
                                     " T_DIRECTION   ,"  +
                                     " T_XLD         ,"  +
                                     " T_REGISTRDATE ,"  +
                                     " T_REGISTRTIME ,"  +
                                     " T_PARTY       ,"  +
                                     " T_ALTXLD      ,"  +
                                     " T_SIGNEDDATE  ,"  +
                                     " T_SIGNEDTIME  ,"  +
                                     " T_PROXY       ,"  +
                                     " T_DIVISION    ,"  +
                                     " T_REFERENCES  ,"  +
                                     " T_RECEPTIONIST,"  +
                                     " T_COPIES      ,"  +
                                     " T_SENT        ,"  +
                                     " T_DELIVERYKIND,"  +
                                     " T_BACKOFFICE  ,"  +
                                     " T_COMMENT     ,"  +
                                     " T_SOURCEDOCID ,"  +
                                     " T_SOURCEDOCKIND," + 
                                     " T_DOCTEMPLATE ,"  + 
                                     " T_TERMINATEDATE," +
                                     " T_PARTYNAME   ,"  + 
                                     " T_PARTYCODE   ,"  + 
                                     " T_BEGINNINGDATE," +
                                     " T_SENTDATE    ,"  +
                                     " T_SENTTIME    ,"  +
                                     " T_DEPARTMENT  ,"  +
                                     " T_BRANCH      ,"  +
                                     " T_PARENT      ,"  +
                                     " T_USERLOG     ,"  +
                                     " T_VERSION     ,"  +
                                     " T_ISMAKEAUTO  ,"  +
                                     " T_TECHAUTODOC ,"  +
                                     " T_DEPONENT    ,"  +
                                     " T_HAVESUBJLIST,"  +
                                     " T_SUBJECTID   ,"  +
                                     " T_REGISTERID  ,"  +
                                     " T_DEPOACNTID  ,"  +
                                     " T_MSGNUMBER   ,"  +
                                     " T_MSGDATE     ,"  +
                                     " T_MSGTIME     ,"  +
                                     " T_METHODAPPLIC "
                               "FROM dspground_tmp";

          cmd = RsdCommand(query);
          SQL_Execute( cmd );
        end;
         
//4.4. Привязываем документы к сделкам
        if(not err)
          query =   "DECLARE "
                  + "  v_err NUMBER; "
                  + "  v_AddCount NUMBER;"
                  + "BEGIN "
                  + "  FOR one_rec IN (SELECT spgr.t_SPgroundID, ot.t_OrderID "
                  + "                    FROM DOPRTEMP_VIEW ot, dspground_dbt spgr, ddpgrrep_dbt gr, ddprepdoc_dbt rdoc "
                  + "                   WHERE gr.t_SourceDocKind = ot.t_DocKind "
                  + "                     AND gr.t_SourceDocID = ot.t_OrderID "
                  + "                     AND rdoc.t_GrRepID = gr.t_ID "
                  + "                     AND spgr.t_Parent = rdoc.t_RepSPgroundID "
                  + "                 ) "
                  + "  LOOP "
                  + "    v_err := rsb_depo.AddEntSpgrToSecDeals(one_rec.t_SPgroundID, one_rec.t_OrderID, v_AddCount); "
                  + "    IF v_err = 0 THEN "
                  + "      UPDATE dspground_dbt SET t_References = t_References + v_AddCount WHERE t_SPgroundID = one_rec.t_SPgroundID; "
                  + "    END IF; "
                  + "  END LOOP;"
                  + "END; ";
          cmd = RsdCommand(query);
          SQL_Execute( cmd );
          
//4.5. Обновляем информацию в родительских исходящих документах          
          if(not err)
            query = " UPDATE "
                      + " dspground_dbt ext_spgr "
                  + " SET "
                      + " (ext_spgr.t_AltXld "
                      + " ,ext_spgr.t_SignedDate "
                      + " ,ext_spgr.t_SignedTime "
                      + " ,ext_spgr.t_Proxy "
                      + " ,ext_spgr.t_Sent "
                      + " ,ext_spgr.t_SentDate "
                      + " ,ext_spgr.t_SentTime) = "
                          + " (SELECT "
                               + " ent_spgr.t_Xld "
                              + " ,ent_spgr.t_RegistrDate "
                              + " ,ent_spgr.t_RegistrTime "
                              + " ,(SELECT "
                                    + " op.t_PartyID "
                                + " FROM "
                                    + " dperson_dbt op "
                                + " WHERE "
                                    + " op.t_Oper = ent_spgr.t_Receptionist) "
                              + " ,'X' "
                              + " ,ent_spgr.t_RegistrDate "
                              + " ,ent_spgr.t_RegistrTime "
                           + " FROM "
                               + " dspground_dbt ent_spgr "
                           + " WHERE "
                               + " ent_spgr.t_Parent = ext_spgr.t_SPgroundID) "
                  + " WHERE "
                      + " ext_spgr.t_SPgroundID IN (SELECT "
                                                    + " rdoc.t_RepSPgroundID "
                                                + " FROM "
                                                    + " doprtemp_view ot "
                                                   + " ,ddpgrrep_dbt gr "
                                                   + " ,ddprepdoc_dbt rdoc "
                                                + " WHERE "
                                                    + " gr.t_SourceDocKind = ot.t_DocKind "
                                                + " AND gr.t_SourceDocID = ot.t_OrderID "
                                                + " AND rdoc.t_GrRepID = gr.t_ID) "
                  + " AND EXISTS (SELECT "
                                  + " 1 "
                              + " FROM "
                                  + " dspground_dbt ent_spgr "
                              + " WHERE "
                                  + " ent_spgr.t_Parent = ext_spgr.t_SPgroundID) ";
            cmd = RsdCommand(query);
            SQL_Execute( cmd );
          end;

        end;

      end;
    end;

//5. Вставляем данные для отката
    if(not err)
      query = " INSERT INTO "
                + " doprdocs_dbt(t_DocKind "
                            + " ,t_DocumentID "
                            + " ,t_ID_Operation "
                            + " ,t_ID_Step "
                            + " ,t_Part "
                            + " ,t_Status "
                            + " ,t_Origin "
                            + " ,t_ServDocKind "
                            + " ,t_ServDocID "
                            + " ,t_AutoKey "
                            + " ,t_LaunchOper "
                            + " ,t_FMTBLOBData_XXXX) "
                + " SELECT "
                    + " " + DLDOC_DPALLEXTSPGR + " "
                   + " ,LPAD(oprtemp.t_OrderID, 10, '0') "
                   + " ,oprtemp.t_ID_Operation "
                   + " ,oprtemp.t_ID_Step "
                   + " ,1 "
                   + " ,0 "
                   + " ,0 "
                   + " ,0 "
                   + " ,0 "
                   + " ,0 "
                   + " ,CHR(0) "
                   + " ,NULL "
                + " FROM "
                    + " doprtemp_view oprtemp ";

      cmd = RsdCommand(query);
      SQL_Execute(cmd);
    end;
  end;

  return err;
end;

//Массовая проверка корректности выполнения операции с выпусками ц\б, предназначенными только для КИ
MACRO DP_MassCheckKI(IsPayer, add_query)
  var query, cmd;
  
  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = NVL((SELECT pt.t_Name||' не признан квалифицированным инвестором.' "
          + "                                   FROM dparty_dbt pt, dspdrmove_dbt mv, dpmpaym_dbt pm "
          + "                                  WHERE mv.t_DraftID = ot.t_OrderID "
          + "                                    AND pm.t_PaymentID = mv.t_PaymentID "
          + "                                    AND pt.t_PartyID = "+IIF(IsPayer, "pm.t_Payer", "pm.t_Receiver")
          + "                                ), CHR(1)) "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists (SELECT 1 "
          + "                  FROM dspdraft_dbt dr, dspground_dbt spgr, dspdrmove_dbt mv, dpmpaym_dbt pm, dfininstr_dbt fin "
          + "                 WHERE dr.t_AutoKey = ot.t_OrderID "
          + "                   AND NOT Exists(SELECT 1 FROM dspdrprop_dbt prop WHERE prop.t_DraftID = dr.t_AutoKey) " //кроме импортируемых
          + "                   AND spgr.t_SPgroundID = dr.t_SPgroundID "
          + "                   AND mv.t_DraftID = dr.t_AutoKey "
          + "                   AND pm.t_PaymentID = mv.t_PaymentID "
          + "                   AND "+IIF(((ValType(add_query) == V_STRING) and (add_query != "")), add_query, "1=1")
          + "                   AND 0 < "+ IIF(IsPayer, "pm.t_Payer", "pm.t_Receiver")
          + "                   AND rsb_depo.depokindtype("+IIF(IsPayer, "pm.t_PayerDpNode", "pm.t_receiverDpNode")+") NOT IN ("+OBJTYPE_DEPOKINDTYPE_ISSUER+", "+OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER+", "+OBJTYPE_DEPOKINDTYPE_MONEYKEEPER+")"
          + "                   AND fin.t_FIID = pm.t_FIID "
          + "                   AND rsb_secur.GetMainObjAttr("+OBJTYPE_AVOIRISS+", lpad(fin.t_FIID, 10, '0'), "+OBJGROUP_ACCESSORYQI+", spgr.t_RegistrDate) = " + OBJATTR_ACCESSORYQI_ONLY /*Только для КИ*/
          + "                   AND NOT Exists(SELECT 1 "
          + "                                    FROM DV_SCQINVHIST hist "
          + "                                   WHERE hist.t_PartyID = "+IIF(IsPayer, "pm.t_Payer", "pm.t_Receiver")
          + "                                     AND hist.t_Kind = " + DSCQINV_Kind_STATEMENT
          + "                                     AND hist.t_State = " + DSCQINV_State_INCLUDED
          + "                                     AND hist.t_BegDate <= spgr.t_RegistrDate "
          + "                                     AND ( hist.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY') OR hist.t_EndDate > spgr.t_RegistrDate ) "
          + "                                 )"
          + "               )";

  cmd = RsdCommand(query);
  SQL_Execute( cmd );


  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = NVL((SELECT pt.t_Name||' не признан квалифицированным инвестором в отношении вида ц\б '||avrk.t_Name||'.' "
          + "                                   FROM dparty_dbt pt, dspdrmove_dbt mv, dpmpaym_dbt pm, dfininstr_dbt fin, davrkinds_dbt avrk "
          + "                                  WHERE mv.t_DraftID = ot.t_OrderID "
          + "                                    AND pm.t_PaymentID = mv.t_PaymentID "
          + "                                    AND pt.t_PartyID = "+IIF(IsPayer, "pm.t_Payer", "pm.t_Receiver")
          + "                                    AND fin.t_FIID = pm.t_FIID "
          + "                                    AND avrk.t_FI_Kind = fin.t_FI_Kind "
          + "                                    AND avrk.t_AvoirKind = fin.t_AvoirKind "
          + "                                ), CHR(1)) "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists (SELECT 1 "
          + "                  FROM dspdraft_dbt dr, dspground_dbt spgr, dspdrmove_dbt mv, dpmpaym_dbt pm, dfininstr_dbt fin "
          + "                 WHERE dr.t_AutoKey = ot.t_OrderID "
          + "                   AND NOT Exists(SELECT 1 FROM dspdrprop_dbt prop WHERE prop.t_DraftID = dr.t_AutoKey) " //кроме импортируемых
          + "                   AND spgr.t_SPgroundID = dr.t_SPgroundID "
          + "                   AND mv.t_DraftID = dr.t_AutoKey "
          + "                   AND pm.t_PaymentID = mv.t_PaymentID "
          + "                   AND "+IIF(((ValType(add_query) == V_STRING) and (add_query != "")), add_query, "1=1")
          + "                   AND 0 < "+ IIF(IsPayer, "pm.t_Payer", "pm.t_Receiver")
          + "                   AND rsb_depo.depokindtype("+IIF(IsPayer, "pm.t_PayerDpNode", "pm.t_receiverDpNode")+") NOT IN ("+OBJTYPE_DEPOKINDTYPE_ISSUER+", "+OBJTYPE_DEPOKINDTYPE_NOMINALKEEPER+", "+OBJTYPE_DEPOKINDTYPE_MONEYKEEPER+")"
          + "                   AND fin.t_FIID = pm.t_FIID "
          + "                   AND rsb_secur.GetMainObjAttr("+OBJTYPE_AVOIRISS+", lpad(fin.t_FIID, 10, '0'), "+OBJGROUP_ACCESSORYQI+", spgr.t_RegistrDate) = " + OBJATTR_ACCESSORYQI_ONLY /*Только для КИ*/
          + "                   AND NOT Exists(SELECT 1 "
          + "                                    FROM DV_SCQINVFIHIST dscqinvfi "
          + "                                   WHERE dscqinvfi.t_PartyID = "+IIF(IsPayer, "pm.t_Payer", "pm.t_Receiver")
          + "                                     AND dscqinvfi.t_AvoirKind = fin.t_AvoirKind " 
          + "                                     AND dscqinvfi.t_State = " + DSCQINVFI_State_ACCESS
          + "                                     AND dscqinvfi.t_BegDate <= spgr.t_RegistrDate "
          + "                                     AND ( dscqinvfi.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY') OR dscqinvfi.t_EndDate > spgr.t_RegistrDate ) "
          + "                                 )"
          + "               )"; 

  cmd = RsdCommand(query);
  SQL_Execute( cmd );

  return 0;
END;

private macro InsertToGrRep()
  var query = "", cmd = null;

  query = " INSERT INTO "
            + " ddpgrrep_dbt(t_ID "
                        + " ,t_Desc "
                        + " ,t_Recipient "
                        + " ,t_RecipientCode "
                        + " ,t_RecipientName "
                        + " ,t_DeliveryKind "
                        + " ,t_SourceDocKind "
                        + " ,t_SourceDocID "
                        + " ,t_AutoSend "
                        + " ,t_Version "
                        + " ,t_DepoAcntID) "
            + " SELECT "
                + " 0 "
               + " ,t_Desc "
               + " ,t_Recipient "
               + " ,t_RecipientCode "
               + " ,t_RecipientName "
               + " ,t_Deliverykind "
               + " ,t_SourceDocKind "
               + " ,t_SourceDocID "
               + " ,t_AutoSend "
               + " ,t_Version "
               + " ,t_DepoAcntID "
            + " FROM "
                + " ddpgrrep_tmp ";
  cmd = RsdCommand(query);
  SQL_Execute(cmd);

  return 0;
end;

private macro InsertToOprDocs()
  var query = "", cmd = null;

  query = " INSERT INTO "
            + " doprdocs_dbt(t_DocKind "
                        + " ,t_DocumentID "
                        + " ,t_ID_Operation "
                        + " ,t_ID_Step "
                        + " ,t_Part "
                        + " ,t_Status "
                        + " ,t_Origin "
                        + " ,t_ServDocKind "
                        + " ,t_ServDocID "
                        + " ,t_AutoKey "
                        + " ,t_LaunchOper "
                        + " ,t_FMTBLOBData_XXXX) "
            + " SELECT "
                + " " + DLDOC_CONNECTDPGRREP + " "
               + " ,LPAD(dpgrrep.t_ID, 10, '0') "
               + " ,oprtemp.t_ID_Operation "
               + " ,oprtemp.t_ID_Step "
               + " ,1 "
               + " ,0 "
               + " ,0 "
               + " ,0 "
               + " ,0 "
               + " ,0 "
               + " ,CHR(0) "
               + " ,NULL "
            + " FROM "
                + " doprtemp_view oprtemp "
               + " ,ddpgrrep_tmp dpgrrep_tmp "
               + " ,ddpgrrep_dbt dpgrrep "
            + " WHERE "
                + " dpgrrep_tmp.t_SourceDocKind = oprtemp.t_DocKind "
            + " AND dpgrrep_tmp.t_SourceDocID = oprtemp.t_OrderID "
            + " AND dpgrrep.t_SourceDocKind = dpgrrep_tmp.t_SourceDocKind "
            + " AND dpgrrep.t_SourceDocID = dpgrrep_tmp.t_SourceDocID "
            + " AND dpgrrep.t_Recipient = dpgrrep_tmp.t_Recipient ";
  cmd = RsdCommand(query);
  SQL_Execute(cmd);

  return 0;
end;

//добавить всех залогодержателей в качестве получателей отчета от исполнении
macro DP_MassAddAllMortgageeToGrRep()
  var query = "", cmd = null;

  SQL_Execute("DELETE FROM ddpgrrep_tmp");
  

  query = " INSERT INTO "
            + " ddpgrrep_tmp(t_ID "
                        + " ,t_Desc "
                        + " ,t_Recipient "
                        + " ,t_RecipientCode "
                        + " ,t_RecipientName "
                        + " ,t_DeliveryKind "
                        + " ,t_SourceDocKind "
                        + " ,t_SourceDocID "
                        + " ,t_AutoSend "
                        + " ,t_Version "
                        + " ,t_DepoAcntID) "
            + " SELECT DISTINCT "
                + " 0 "
               + " ,spgr.t_SPgroundID "
               + " ,acap.t_APartyID "
               + " ,RSI_RSBPARTY.GetPartyCode(acap.t_APartyID, " + PTCK_CONTR + ") "
               + " ,NVL((SELECT "
                     + " pt.t_Name "
                     + " FROM "
                     + " dparty_dbt pt "
                     + " WHERE "
                     + " pt.t_PartyID = acap.t_APartyID), CHR(1)) "
               + " ," + CodeFor("E") + " "
               + " ,dr.t_Kind "
               + " ,dr.t_AutoKey "
               + " ,CHR(0) "
               + " ,0 "
               + " ,0 "
            + " FROM "
                + " doprtemp_view ot "
               + " ,dspdraft_dbt dr "
               + " ,dspdrmove_dbt mv "
               + " ,dspground_dbt spgr "
               + " ,dpmpaym_dbt pm "
               + " ,ddepoacnt_dbt part "
               + " ,ddpacap_dbt acap "
               + " ,ddpacapau_dbt acapau "
            + " WHERE "
                + " dr.t_AutoKey = ot.t_OrderID "
            + " AND spgr.t_SPgroundID = dr.t_SPgroundID "
            + " AND mv.t_DraftID = dr.t_AutoKey "
            + " AND pm.t_PaymentID = mv.t_PaymentID "
            + " AND (part.t_AutoKey = pm.t_PayerDpNode "
              + " OR part.t_AutoKey = pm.t_ReceiverDpNode) "
            + " AND acap.t_ApNodeID = part.t_Root "
            + " AND acap.t_APartyID <> dr.t_Initiator "
            + " AND acap.t_APartyID NOT IN (SELECT "
                                            + " grrep.t_Recipient "
                                        + " FROM "
                                            + " ddpgrrep_dbt grrep "
                                        + " WHERE "
                                            + " grrep.t_SourceDocKind = dr.t_Kind "
                                        + " AND grrep.t_SourceDocID = dr.t_AutoKey)"
            + " AND acap.t_Role = " + DEPOACAPROLE_MORTGAGEE + " "
            + " AND acap.t_FromDate <= spgr.t_RegistrDate "
            + " AND (acap.t_ToDate >= spgr.t_RegistrDate "
              + " OR acap.t_ToDate = " + GetSQLDate(ZeroDate) + ") "
            + " AND acapau.t_APID = acap.t_APID "
            + " AND acapau.t_AuNodeID = part.t_AutoKey "
            + " AND acapau.t_AuthKind = " + OBJTYPE_DEPOAUTHORITY_GETINFO + " ";
  
  cmd = RsdCommand(query);
  SQL_Execute(cmd);

  InsertToGrRep();

  InsertToOprDocs();

  return 0;
end;

// Занести в список получателей отчета владельцев ц/б, перевод или перемещение которых выполняется.
macro DP_MassAddAllOwnerToGrRep()
  var query = "", cmd = null;

  SQL_Execute("DELETE FROM ddpgrrep_tmp");

  // !!! необходимо вызвать ХП-ку 1 раз отдельно от вставки
  // чтобы произошло начальное и единственное обращение к таблице ddpgrrep_tmp
  // без этого вызова будет ошибка - таблица мутирует
  query = " SELECT RSB_DEPO.GetNextTempGrRepID() FROM DUAL ";
  cmd = RsdCommand(query);
  SQL_Execute(cmd);

  query = " INSERT INTO "
            + " ddpgrrep_tmp(t_ID "
                        + " ,t_Desc "
                        + " ,t_Recipient "
                        + " ,t_RecipientCode "
                        + " ,t_RecipientName "
                        + " ,t_DeliveryKind "
                        + " ,t_SourceDocKind "
                        + " ,t_SourceDocID "
                        + " ,t_AutoSend "
                        + " ,t_Version "
                        + " ,t_DepoAcntID) "
            + " SELECT "
                + " RSB_DEPO.GetNextTempGrRepID() "
               + " ,q.* "
            + " FROM "
                + " (SELECT DISTINCT "
                     + " spground.t_SPgroundID AS t_Desc "
                    + " ,account.t_Client AS t_Recipient "
                    + " ,RSI_RSBPARTY.GetPartyCode(account.t_Client, " + PTCK_CONTR + ") AS t_RecipientCode "
                    + " ,NVL((SELECT "
                              + " party.t_Name "
                          + " FROM "
                              + " dparty_dbt party "
                          + " WHERE "
                              + " party.t_PartyID = account.t_Client), CHR(1)) AS t_RecipientName "
                    + " ," + CodeFor("E") + " AS t_DeliveryKind "
                    + " ,spdraft.t_Kind AS t_SourceDocKind "
                    + " ,spdraft.t_AutoKey AS t_SourceDocID "
                    + " ,CHR(0) AS t_AutoSend "
                    + " ,0 AS t_Version "
                    + " ,0 AS t_DepoAcntID "
                 + " FROM "
                     + " daccount_dbt account "
                    + " ,daccvanl_dbt accvanl "
                    + " ,daccsubdc_dbt accsubdc "
                    + " ,dpmpaym_dbt pmpaym "
                    + " ,dspdrmove_dbt spdrmove "
                    + " ,dspground_dbt spground "
                    + " ,dspdraft_dbt spdraft "
                    + " ,doprtemp_view oprtemp "
                 + " WHERE "
                     + " account.t_Chapter = accvanl.t_Chapter "
                 + " AND account.t_Account = accvanl.t_Account "
                 + " AND account.t_Code_Currency = accvanl.t_FIID "
                 + " AND NOT EXISTS (SELECT "
                                     + " 1 "
                                 + " FROM "
                                     + " ddpgrrep_dbt dpgrrep "
                                 + " WHERE "
                                     + " dpgrrep.t_SourceDocKind = spdraft.t_Kind "
                                 + " AND dpgrrep.t_SourceDocID = spdraft.t_AutoKey "
                                 + " AND dpgrrep.t_Recipient = account.t_Client) "
                 + " AND accvanl.t_AccAnaliticsID = accsubdc.t_AccAnaliticsID "
                 + " AND accvanl.t_AnaliticsID = " + SYS_ANL_AINPACCOUNTING + " "
                 + " AND accvanl.t_Chapter = " + CHAPT5 + " "
                 + " AND accsubdc.t_PaymentID = pmpaym.t_PaymentID "
                 + " AND pmpaym.t_PaymentID = spdrmove.t_PaymentID "
                 + " AND RSB_DEPO.DefineKindOperation(pmpaym.t_PayerDpNode, pmpaym.t_ReceiverDpNode) IN (" + KINDOPER_TRANSFER + ", " + KINDOPER_MOVEMENT + ") "
                 + " AND spdrmove.t_DraftID = spdraft.t_AutoKey "
                 + " AND spground.t_SPGroundID = spdraft.t_SPGroundID "
                 + " AND spdraft.t_AutoKey = oprtemp.t_OrderID) q ";
  cmd = RsdCommand(query);
  SQL_Execute(cmd);

  InsertToGrRep();

  InsertToOprDocs();

  return 0;
end;

/* Массовая проверка наличия транзитного счета */
macro DP_MassCheckTransitAccount()
  var query, cmd;
  FILE DepoAcc( depoacnt );

  if(GetTransitAccount( DepoAcc ) != 0)
    query =   " UPDATE doprtemp_tmp ot "
            + "    SET ot.t_errorstatus = 1, "
            + "        ot.t_errormessage = ? "
            + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
            + "    AND Exists(select 1 "
            + "                 from dspdraft_dbt dr "
            + "                where dr.t_AutoKey = ot.t_OrderID "
            + "                  and dr.t_FromTransitAccount = 'X'"
            + "              ) ";
  
    cmd = RsdCommand(query);
    cmd.addParam( "", RSDBP_IN, DPError.GetErr() );


    SQL_Execute( cmd );
  end;

  return 0;
end;

//Массовая проверка заданности схемы расчетов
macro DP_MassCheckCorschem(IsPayer)
  var query, cmd;
  
  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = ? "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists(select 1 "
          + "                 from dspdraft_dbt dr, dspdrmove_dbt mv, dpmpaym_dbt pm, dpmprop_dbt prop "
          + "                where dr.t_AutoKey = ot.t_OrderID "
          + "                  and dr.t_FromTransitAccount <> 'X'"
          + "                  and mv.t_DraftID = dr.t_AutoKey "
          + "                  and pm.t_PaymentID = mv.t_PaymentID "
          + "                  and "+IIF(IsPayer, "pm.t_PayerBankID", "pm.t_ReceiverBankID")+" <> ? "
          + "                  and prop.t_PaymentID = pm.t_PaymentID "
          + "                  and prop.t_DebetCredit = "+IIF(IsPayer, 0, 1)
          + "                  and prop.t_Corschem = -1" 
          + "              ) ";

  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, "Не задана схема расчетов!" );
  cmd.addParam( "", RSDBP_IN, {OurBank} );

  SQL_Execute( cmd );

  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = ? "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists(select 1 "
          + "                 from dspdraft_dbt dr, dspdrmove_dbt mv, dpmpaym_dbt pm, dpmprop_dbt prop "
          + "                where dr.t_AutoKey = ot.t_OrderID "
          + "                  and dr.t_FromTransitAccount <> 'X'"
          + "                  and mv.t_DraftID = dr.t_AutoKey "
          + "                  and pm.t_PaymentID = mv.t_PaymentID "
          + "                  and "+IIF(IsPayer, "pm.t_PayerBankID", "pm.t_ReceiverBankID")+" <> ? "
          + "                  and prop.t_PaymentID = pm.t_PaymentID "
          + "                  and prop.t_DebetCredit = "+IIF(IsPayer, 0, 1)
          + "                  and prop.t_Corschem <> -1 " 
          + "                  and 0 = rsb_depo.GetAcntNodeFromCorschem(prop.t_Corschem, pm.t_FIID) "
          + "              ) ";

  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, "Не найден корреспондентский счет депо" );
  cmd.addParam( "", RSDBP_IN, {OurBank} );

  SQL_Execute( cmd );

  return 0;
end;


macro DP_MassCheckRejectedDepoDraft()
  var query, cmd;
  
  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = ? "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists(select 1 "
          + "                 from dspdraft_dbt dr, dspdrmove_dbt mv, dpmpaym_dbt pm "
          + "                where dr.t_AutoKey = ot.t_OrderID "
          + "                  and mv.t_DraftID = dr.t_AutoKey "
          + "                  and pm.t_PaymentID = mv.t_PaymentID "
          + "                  and pm.t_FIID <= 0 "
          + "              ) ";

  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, "В поручении не задана ценная бумага." );

  SQL_Execute( cmd );

  
  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = ? "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists(select 1 "
          + "                 from dspdraft_dbt dr, dspdrmove_dbt mv, dpmpaym_dbt pm "
          + "                where dr.t_AutoKey = ot.t_OrderID "
          + "                  and mv.t_DraftID = dr.t_AutoKey "
          + "                  and pm.t_PaymentID = mv.t_PaymentID "
          + "                  and dr.t_LateDeliveryDate <> " + GetSQLDate(date(0,0,0))
          + "                  and dr.t_SettlementDate <> " + GetSQLDate(date(0,0,0))
          + "                  and dr.t_LateDeliveryDate < pm.t_ValueDate "
          + "              ) ";

  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, "Период расчётов уже завершен." );

  SQL_Execute( cmd );
  
  
  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = ? "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists(select 1 "
          + "                 from dspdraft_dbt dr, dspdrmove_dbt mv, dpmpaym_dbt pm "
          + "                where dr.t_AutoKey = ot.t_OrderID "
          + "                  and mv.t_DraftID = dr.t_AutoKey "
          + "                  and pm.t_PaymentID = mv.t_PaymentID "
          + "                  and dr.t_LateDeliveryDate <> " + GetSQLDate(date(0,0,0))
          + "                  and dr.t_SettlementDate <> " + GetSQLDate(date(0,0,0))
          + "                  and dr.t_SettlementDate > pm.t_ValueDate "
          + "              ) ";

  cmd = RsdCommand(query);
  cmd.addParam( "", RSDBP_IN, "Период расчётов еще не наступил." );

  SQL_Execute( cmd );
  
  return 0;
end;

macro DP_MassCheckValueDate()
  var query, cmd;
  
  query =   " UPDATE doprtemp_tmp ot "
          + "    SET ot.t_errorstatus = 1, "
          + "        ot.t_errormessage = ? "
          + "  WHERE ot.t_errorstatus = 0 AND ot.t_SkipDocument = 0 "
          + "    AND Exists(select 1 "
          + "                 from dspdraft_dbt dr, dspdrmove_dbt mv, dpmpaym_dbt pm "
          + "                where dr.t_AutoKey = ot.t_OrderID "
          + "                  and mv.t_DraftID = dr.t_AutoKey "
          + "                  and pm.t_PaymentID = mv.t_PaymentID "
          + "                  and pm.t_ValueDate > ? "
          + "              ) ";

  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, "Дата проводки больше текущей. Выполнение операции приостановлено до наступления запланированной даты." );
  cmd.addParam( "", RSDBP_IN, {curdate} );

  SQL_Execute( cmd );
  
  return 0;
end;

macro DP_MassCheckDepoMessage()
  var r_spdraft= TRecHandler("spdraft.dbt");
  var query, cmd, DataSet;

  query =   " select dr.*, mv.t_PaymentID"
          + "   from DOPRTEMP_VIEW ot, dspdraft_dbt dr, dspdrmove_dbt mv "
          + "  where dr.t_AutoKey = ot.t_OrderID "
          + "    and dr.t_SendInstruction <> CHR(0) "
          + "    and dr.t_FromTransitAccount <> 'X' "
          + "    and mv.t_DraftID = dr.t_AutoKey ";

  cmd = DL_RSdCommand(query);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    DataSet.GetRecord().CopyTo( r_spdraft.rec );

    if( not DP_SpdraftIsBothDepart(r_spdraft) )
      if( not FindDpMessageByDraft(r_spdraft.rec.AutoKey) )
        DP_SetErrorOprTemp( DataSet.PaymentID, 1, "На шаге \"Создание сообщения\" сообщение не было сформировано или было удалено. Продолжение невозможно" );
      end;
    end;
  end;

  return 0;
end;

macro DP_MassExpToSecur()
  var h_spdraft= TRecHandler("spdraft.dbt");
  record r_spdraft("spdraft.dbt");
  record r_Pm_paym("pmpaym.dbt") BTR;
  var query, cmd, DataSet;
  var stat = 0;

  query =   " select dr.*, mv.t_PaymentID "
        + "   from DOPRTEMP_VIEW oprtemp, dspdraft_dbt dr, dspdrmove_dbt mv "
        + "  where dr.t_AutoKey = oprtemp.t_OrderID "
        + "    and dr.t_ToBO = 'X'"
        + "    and mv.t_DraftID = dr.t_AutoKey ";

  cmd = DL_RSDCommand(query);
   
  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    DataSet.GetRecord().CopyTo( h_spdraft.rec );
    ClearRecord(r_spdraft);
    Copy(r_spdraft, h_spdraft);

    ClearRecord(r_Pm_paym);
    r_Pm_paym.PaymentID = DataSet.PaymentID;
    GetEQ(r_Pm_paym);

    stat = ExecMacroFile("dpexpsecur.mac", "ExpToSecur", r_spdraft, r_Pm_paym);
    if(stat)
      DP_SetErrorOprTemp( DataSet.PaymentID, stat, DPError.GetErr() );
    end;
  end;

  return 0;
end;

macro DP_SetDpNodeToPaym(PaymentID, PayerDpNode, ReceiverDpNode)
  var cmd, query;

  query =   " UPDATE dpmpaym_dbt "
          + "    SET t_PayerDpNode = ?, "
          + "        t_ReceiverDpNode = ? "
          + "  WHERE t_PaymentID = ? ";
  
  cmd = RsdCommand(query);

  cmd.addParam( "", RSDBP_IN, PayerDpNode );
  cmd.addParam( "", RSDBP_IN, ReceiverDpNode );
  cmd.addParam( "", RSDBP_IN, PaymentID );

  SQL_Execute( cmd );

  return 0;
end;

macro DP_SetSkipOtherDocs(SkipDocument, OldSkipDocument, DocKind, DocumentID, ID_Operation, ID_Step)
  var query, cmd;
  
  query =   " UPDATE doprtemp_tmp "
          + "    SET t_SkipDocument = ? "
          + "  WHERE t_ErrorStatus = 0 "
          + "    AND t_SkipDocument = ? "
          + "    AND (   t_DocKind <> ? "
          + "        OR t_OrderID <> ? "
          + "        OR t_ID_Operation <> ? "
          + "        OR t_ID_Step <> ? "
          + "        ) ";
  cmd = RSDCommand(query);
  cmd.addParam( "", RSDBP_IN, SkipDocument );
  cmd.addParam( "", RSDBP_IN, OldSkipDocument );
  cmd.addParam( "", RSDBP_IN, DocKind );
  cmd.addParam( "", RSDBP_IN, DocumentID );
  cmd.addParam( "", RSDBP_IN, ID_Operation );
  cmd.addParam( "", RSDBP_IN, ID_Step );

  SQL_Execute( cmd );
end;

