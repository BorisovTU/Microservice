/*                           
$Name:             spacform.mac
$Module:           Депозитарий
$Description:      

 Отчеты
 Анкета счета депо.
 Анкета раздела счета депо.
 06 June 2000,
 VSH
 оптимизация под ORACLE Nikonorov Evgeny 21.01.2005
*/
import deposerv, DPInter, "adress.mac";
import RsbDataSet;

const MAXINT = 2147483647,
      SP_DEPOPER_INFOPER = 830;

const ALG_STATUS_KIND = 3103;//Виды статусов счёта депо

VAR sNAMEs  = TArray;
VAR sFROM   = TArray;
VAR sTO     = TArray;

private var _LogoprID, _RepDate, _SelfID = {OurBank}, _use_ap;

/* Глава синтетического учета */
const synt_chapter = 5;
/* Вид Альтернативного идентификатора */
const AltCodeKind = PTCK_BIC;

const OBJTYPE_DIVISION = 50;
const OBJTYPE_PLACES = 40;
const OBJTYPE_AVOIRKINDS = 7;
const OBJTYPE_DEPODOC = 115;
const ELEMENT_UNDEFINE = -1;
const SERVKIND = 7;
const DEPOATTR_OPERATOR = 4;

const TA_STAT_DEL = 152;

const TA_INC_DEL = 151;

const физическое_лицо = 2;
const юридическое_лицо= 1;
const UnSetName ="не определен";
const DLink = "*";
const IsLink = "X";
/*Счет Депо*/
const активный = 1;
const пассивный= 2;

const SPSK_OPEN   = 0;
const SPSK_CLOSE  = 1;
const SPSK_LOCKED = 2;

/*Алгоритмы NameAlg*/
const NLAvoirStatusName = 3107, /*Тип алгоритма блокировки в NameAlg*/
      NLStatusName = 3103,   /*Тип алгоритма Статус счета Депо в NameAlg*/
      NLOpenGroun = 3210;

var errstr1;
const errACCdepo  = "Не могу получить счет депо указанный в параметрах отчета";
const errPARTdepo = "Не могу получить раздел счета депо указанный в параметрах отчета";
const оперсчета     = "Оператор счета";
const оперраздела   = "Оператор раздела";
const распорсчета   = "Распорядитель счета";  
const распорраздела = "Распорядитель раздела";

const OpenOperKind  = "открытие";
const CloseOperKind = "закрытие";
const ModifOperKind = "изменение";


var Table1 = "┌──────────────────┬────────────────────┬──────────────┬───────────┬────────────────────────┐\n"+
             "│        Код       │    Наименование    │     Тип      │  Статус   │   Характеристика       │\n"+
             "├──────────────────┼────────────────────┼──────────────┼───────────┼────────────────────────┤";

var Table2 = "┌──────────────────┬─────────────────┬──────────────┬───────────────────────────┐\n"+
             "│        №         │       Тип       │      Код     │    Полное наименование,   │\n"+
             "│       п/п        │ уполномоченного │    анкеты    │         полномочия        │\n"+
             "│                  │       лица      │              │                           │\n"+
             "├──────────────────┼─────────────────┼──────────────┼───────────────────────────┤";

var Table3 = "┌───────────┬───────────────────┬──────────┬─────────────────────────────────────┐\n"+
             "│    Тип    │       Дата,       │    №     │                Документ             │\n"+
             "│           │       время       │ операции │                                     │\n"+
             "├───────────┼───────────────────┼──────────┼─────────────────────────────────────┤";

var Table4 = "┌────────────┬─────────────────┬───────────────────────────────────────────────┐\n"+
             "│   № п/п    │   Код анкеты    │         Полное наименование, полномочия       │\n"+
             "├────────────┼─────────────────┼───────────────────────────────────────────────┤";


const width = Index(Table1,"\n");
var DispPartRep = CMakeReport();
const FontStyleTitel = ""; // "ex_FS(b)";
//const TableWidth = 255;

macro AdmoKindName(kind)
  var llvl = TBFile("llvalues");
  llvl.rec.List    = 1050;
  llvl.rec.Element = kind;
  if (GetEQ(llvl))
    return llvl.rec.Name;
  end;
  return "";
end;

    
macro GetUndefDEPOATVL( List )
  var UndefVal;

  if( List == OBJTYPE_PARTY )
    UndefVal = UnknownParty;
  elif( List == OBJTYPE_DIVISION )
    UndefVal = 0;
  elif( List == OBJTYPE_PLACES )
    UndefVal = 0;
  elif( List == OBJTYPE_AVOIRKINDS )
    UndefVal = 0;
  else
    UndefVal = ELEMENT_UNDEFINE;
  end;

  return UndefVal;
end;


// Определяет значение характеристики с учетом возможной ее историчности (считается, что характеристика главная)
MACRO GetValueDEPOATVL( Depoatvl, RepDate )
  var Value = Depoatvl.Value;

  if( Value == "" )
     Value = GetUndefDEPOATVL( Depoatvl.List );
  end;

  return Value;
end;

macro NameParty(ID, RepDate)
  var Name = UnSetName;
  var cPat;

  cPat = CDPParty( ID, RepDate );

  return cPat.Name();
end;


class АдмОпер(_depoadmo)
  var depoadmo = _depoadmo;
  var ModData = "-", ModGroun = "-", ModDocNum = "-", RegistrDateMod = "-";
  var ModOprXid = depoadmo.OprXid;
  var ModOpNum = _depoadmo.AdmoprID;
  var OperKind = "";

  var spGround=TBFile("spground");

  if( depoadmo.OperDate!=date(0,0,0) )
    ModData = depoadmo.OperDate;
  else ModData = "-";
  end;
  if( depoadmo.OperTime!=Time(0) )
    ModData = ModData + " " + depoadmo.OperTime;
  else ModData = ModData + " -";
  end;

  if( depoadmo.OperKind == SPAO_CON_REGISTERING )
    OperKind = OpenOperKind;
  elif( depoadmo.OperKind == SPAO_CON_CLOSING )
    OperKind = CloseOperKind;
  else
    OperKind = ModifOperKind;
  end;

  spGround.rec.SPgroundID = depoadmo.Ground;
  if(spGround.GetEQ)
    ModGroun  = AdmoKindName(spGround.rec.Kind);
    ModDocNum = spGround.rec.Xld;
    RegistrDateMod = spGround.rec.RegistrDate;
  end;
end;
var АдмОпер_Arr = TArray;


private macro GetDepoAcntStatusQuery(statOpen_PAR:bool, statClose_PAR:bool, statLocked_PAR:bool, aliasAcnt:string):string
  var query = "";
  var flag = false;

  if (statOpen_PAR or statClose_PAR or statLocked_PAR)
    query = query + " and ( ";
    if (statOpen_PAR)
      query = query + " "+aliasAcnt+".t_Status = " + SPSK_OPEN; 
      flag = true;
    end;
    if (statClose_PAR)
      if (flag)
        query = query + " or ";
      end;
      query = query + " "+aliasAcnt+".t_Status = " + SPSK_CLOSE;
      flag = true;
    end;
    if (statLocked_PAR)
      if (flag)
        query = query + " or ";
      end;
      query = query + " "+aliasAcnt+".t_Status = " + SPSK_LOCKED;
    end;
    query = query + " ) ";
  end;
  return query;
end;

class Полномочия(_Group, _Name)
  var Group = _Group;
  var Name  = _Name;
end;

class УполнЛица(_НаимТипЛица, PartyID, RepDate)
  var НаимТипаЛица = _НаимТипЛица;
  var Код          = "";//код анкеты
  var Наименование = "";

  Код = ПолучитьКодСубъекта(PartyID, PTCK_CONTR);
  Наименование = NameParty(PartyID, RepDate);
  
  macro ПолучитьПолномочия(apID:integer, statOpen_PAR:bool, statClose_PAR:bool, statLocked_PAR:bool)
    var query = "select acapau.t_AuthKind, acnt.t_BriefCode, llv.t_name as t_AuthName"
              + "  from ddepoacnt_dbt acnt, ddpacapau_dbt acapau, dllvalues_dbt llv"
              + " where acapau.t_APID = " + String(apID)
              + "   and acnt.t_AutoKey = acapau.t_AUNodeID" + GetDepoAcntStatusQuery(statOpen_PAR, statClose_PAR, statLocked_PAR, "acnt")
              + "   and llv.t_List = 1211" /*OBJTYPE_DEPOAUTHORITY*/
              + "   and llv.t_element = acapau.t_AuthKind"
              + " order by acnt.t_BriefCode, acapau.t_AuthKind";    
    var dataSet = TRsbDataSet(query);
    var lastBriefCode = "";

    while (dataSet.MoveNext())
      if (lastBriefCode != dataSet.BriefCode)
        Наименование = Наименование + "\n" + "Раздел " + dataSet.BriefCode + ":";
        lastBriefCode = dataSet.BriefCode;
      end;
      Наименование = Наименование + "\n\t" + dataSet.AuthName; // При выводе в отчет стирает впереди идущие пробелы, поэтому поставим \t
    end;
  end;
end;

private macro NeedOperatorLevel(depoacnt, checkopt, RepDate)
  file Depoatvl(depoatvl) key 1;
  var Need = true;
  var err = 0, RegValue;
  
  Depoatvl.IsMain      = SET_CHAR;
  Depoatvl.IsCurrent   = SET_CHAR;
  Depoatvl.IsType      = UNSET_CHAR;
  Depoatvl.ID          = depoacnt.AutoKey;

  if( GetEQ(Depoatvl) )
    if((Depoatvl.AttrNum == DEPOATTR_OPERATOR) and (string(depoacnt.Owner) == GetValueDEPOATVL(Depoatvl, RepDate)))
      if(checkopt == true)
        GetRegistryValue( "DEPO\\ADMOPOPENDEPOPART", V_BOOL, RegValue, err );
        if((not err) and (RegValue == false))
          Need = false;
        end;
      else
        Need = false;
      end;
    end;
  end;

  return Need;
end;

macro Characteristic_Name(AutoKey, RepDate)
  file Depoatvl(depoatvl) key 1;
  file Ptoffice(ptoffice);
  file Avrkinds(avrkinds);
  file Spplaces(spplaces);
  file Llvalues(llvalues);
  file spgr_attr(spground);

  var Characteristic_Name, ValueID, cPat;

  Depoatvl.IsMain      = SET_CHAR;
  Depoatvl.IsCurrent   = SET_CHAR;
  Depoatvl.IsType      = UNSET_CHAR;
  Depoatvl.ID          = AutoKey;

  if( GetEQ(Depoatvl) )
    if(Depoatvl.List == 0)
      Characteristic_Name = Depoatvl.Value;
    else
      ValueID = GetValueDEPOATVL( Depoatvl, RepDate );
      if( Depoatvl.List==OBJTYPE_PARTY )
        cPat = CDPParty( ValueID, RepDate );
  
        Characteristic_Name = cPat.Name();
      elif( Depoatvl.List==OBJTYPE_DIVISION )
        Ptoffice.PartyID = _SelfID;
        Ptoffice.OfficeID = ValueID;

        if( GetEQ(Ptoffice) )
          Characteristic_Name = Ptoffice.OfficeName;
        end;
      elif( Depoatvl.List==OBJTYPE_AVOIRKINDS )
        Avrkinds.FI_Kind   = FIKIND_AVOIRISS;
        Avrkinds.AvoirKind = ValueID;

        if( GetEQ(Avrkinds) )
          Characteristic_Name = Avrkinds.Name;
        end;
      elif( Depoatvl.List==OBJTYPE_PLACES )
        Spplaces.Num = ValueID;
        if( GetEQ(Spplaces) )
          Characteristic_Name = Spplaces.Name;
        end;
      elif( Depoatvl.List==OBJTYPE_DEPODOC )
        spgr_attr.SPgroundID = ValueID;
        if( GetEQ(spgr_attr) )
          ClearRecord(Llvalues);
          Llvalues.List    = OBJTYPE_KINDDOC;
          Llvalues.Element = spgr_attr.Kind;
          if( GetEQ(Llvalues) )
            Characteristic_Name = Llvalues.Code;
          else
            Characteristic_Name = "";
          end;
          if( spgr_attr.AltXld != "" )
            Characteristic_Name = Characteristic_Name + " №" + spgr_attr.AltXld;
          end;
        end;
      else
        if( Depoatvl.List != 0 )
          Llvalues.List    = Depoatvl.List;
          Llvalues.Element = ValueID;

          if( GetEQ(Llvalues) )
            Characteristic_Name = Llvalues.Name;
          end;
        end;
      end;
    end;
  else
    Characteristic_Name = "";
  end;

  return Characteristic_Name; 
end;

/* УЛ. Раздел счета ДЕПО */
private class CDepoPartAcntAcap
  var PartyCode:string = "",
      FullName_AuthName:string = "";
  
  // Фильтр 
  private var role           = 0,           // роль УЛ
              acntID         = -1,          // узел раздела
              dateRep        = Date(0,0,0), // Дата От
              statOpen_PAR   = false,
              statClose_PAR  = false,
              statLocked_PAR = false;

  private var dataSet = null;

  /* Установить фильтр */
  macro SetFilter(acntID_:integer, role_:integer, dateRep_:Date, statOpen_PAR_:bool, statClose_PAR_:bool, statLocked_PAR_:bool)
    role           = role_;
    acntID         = acntID_;
    dateRep        = dateRep_;
    statOpen_PAR   = statOpen_PAR_;
    statClose_PAR  = statClose_PAR_;
    statLocked_PAR = statLocked_PAR_;

    dataSet = null;
  end;

  private macro SetValues()
    var dpParty = CDPParty(dataSet.APartyID, dateRep);
    PartyCode = ПолучитьКодСубъекта(dataSet.APartyID, PTCK_CONTR);
    FullName_AuthName = dpParty.Name() + "\nполномочия:\n\t"+dataSet.AuthName;
  end;

  /* Получить первое значение*/
  macro GetFirst():bool
    var stat = false;
    var query = "select acap.t_apartyid, LISTAGG(llv.t_name, '\n\t') WITHIN GROUP (order by  acap.t_apartyid, acap.t_role) as t_AuthName"
              + "  from ddepoacnt_dbt acnt, ddpacap_dbt acap, ddpacapau_dbt acapau, dllvalues_dbt llv"
              + " where acap.t_APNodeID = acnt.t_root"
              + "   and (acap.t_FromDate<=" + GetSQLDate(dateRep) + " and (acap.t_ToDate>=" + GetSQLDate(dateRep) + " OR acap.t_ToDate=TO_DATE('01.01.0001','DD.MM.YYYY')))"
              + "   and acap.t_APID = acapau.t_APID"
              + "   and acap.t_Role = " + String(role)
              + "   and acapau.t_AUNodeID = acnt.t_AutoKey" + GetDepoAcntStatusQuery(statOpen_PAR, statClose_PAR, statLocked_PAR, "acnt")
              + "   and llv.t_List = 1211" /*OBJTYPE_DEPOAUTHORITY*/
              + "   and llv.t_element = acapau.t_AuthKind"
              + "   and acnt.t_AutoKey IN (select acnt2.t_AutoKey "
              + "                            from ddepoacnt_dbt acnt2 "
              + "                           where acnt2.t_root = acnt.t_root"
              + "                           start with acnt2.t_AutoKey = " + String(acntID)
              + "                         connect by prior acnt2.t_Superior = acnt2.t_AutoKey)"
              + "   and llv.t_List = 1211" /*OBJTYPE_DEPOAUTHORITY*/
              + "   and llv.t_element = acapau.t_AuthKind"
              + " group by  acap.t_apartyid, acap.t_role";

    dataSet = TRsbDataSet(query);

    stat = dataSet.moveNext();
    if (stat)
      SetValues();
    end;
    return stat;
  end;  
  /* Следующее значение */
  macro GetNext():bool
    var stat = dataSet.moveNext();

    if (stat)
      SetValues();
    end;
    return stat;
  end;
end;

macro УЛицаСчетаДепо( УЛ_Arr, _depoacnt, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR )
  var stat;
  var lastPartyID = -1, lastRole = 0;

  var query =  "select acap.t_apartyid, acap.t_role, acap.t_APID, na.t_sznamealg as RoleName"
             + "  from ddpacap_dbt acap, dnamealg_dbt na"
             + " where acap.t_APNodeID = " + _depoacnt.AutoKey // Счет ДЕПО!
             + "   and (acap.t_FromDate<=" + GetSQLDate(RepDate) + " and (acap.t_ToDate>=" + GetSQLDate(RepDate) + " OR acap.t_ToDate=TO_DATE('01.01.0001','DD.MM.YYYY')))"
             + "   and na.t_itypealg = 3266"/*ALG_DEPOACAPROLE*/
             + "   and na.t_inumberalg = acap.t_role"
             + " order by acap.t_role";

  var dataSet = TRsbDataSet(query);

  while (dataSet.MoveNext())

    if ((lastPartyID != dataSet.APartyID) or (lastRole != dataSet.Role))
      // Новая запись в массив
      УЛ_Arr[УЛ_Arr.size] = УполнЛица(dataSet.RoleName, dataSet.APartyID, RepDate);

      lastPartyID = dataSet.APartyID;
      lastRole    = dataSet.Role;
    end;
    УЛ_Arr[УЛ_Arr.size - 1].ПолучитьПолномочия(dataSet.APID, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR);
  end;
end;

macro StatusAtoi( Status )
  var namealg, query;
  var stat;

  query =   " select t_inumberalg from dnamealg_dbt " 
          + " where t_itypealg = " + ALG_STATUS_KIND
          + "   and t_sznamealg = '" + Status + "' ";
  namealg = TRsbDataSet(query);
  if( namealg.MoveNext() )
     return namealg.inumberalg;
  end;
  return -1;
end;

/*Собственно данные об аналитическом счете Депо*/
class DepoInfo(depo_acc:integer,
               c_rep_date:date)
   /*Имя банка денежного счета*/
   var vBankName= UnSetName;
   var vAgentKind = "", /* Депонент || Домицилиат */
       vDeponentID,
       vDeponentName= "",
       vDeponentКод = "",
       vDeponentINN = UnSetName;
   /*Связи*/
   var vStatementString= UnSetName, vOrderString= UnSetName, /*виды доставки*/
       vStatementDC, vOrderDC; /*вид доставки по умолчанию*/
   var vSynthetics;  /*Синтетический счет, назначенный счёту депо по умолчанию*/
   var vAvoirStatusName = ""; /*Блокировка*/
   /*Статус счета Депо*/
   var vStatus,
       vStatusName= UnSetName, /*название cтатуса*/
       vStatusMomentSet, /*дата установки статуса*/
       vIncomeDelivery = "",
       vOrderDelivery = "",
       vStatementDelivery = ""; 
   /*Административные операции*/
   var vOpenOpNum = 0,
       vModOpNum = 0,
       vOpenDate = date(0,0,0),
       vOpenTime = time(0),
       vModDate = date(0,0,0),
       vModTime = time(0),
       vOpenOprXid = "-",
       vModOprXid = "-",
       vRegistrDateOpen = "-",
       vRegistrDateMod  = "-",
       vOpenOper="", 
       vModOper="",
       vOpenGroun="",
       vModGroun="",
       vOpenDocNum="",
       vModDocNum="",
       ExpiryDate = "______"; /*неизвестно, как искать*/

   var cDeponent; //это будет объект класса CDPParty
   //var cOperator;
   var cBank;

   private const P_DEPONENT = 1;
   private const P_BANK     = 2;
   //private const P_OPERATOR = 3;

   var arh_date;

   var DepoAcount = TBFile("depoacnt");
   var depoac = TBFile("depoac");
   var OwnPArty=TBFile("party");
   var BParty = TBFile("party");
   var OParty = TBFile("party"); 
   var TypeAc = TBFile("typeac"); 
   var NameAlg= TBFile("namealg");
 //  var DEPOADMO=TBFile("depoadmo");
   var DEPOADMO, query;
   var spGround=TBFile("spground");
   var settacc=TRecHandler("settacc");
   var llv_rec =TRecHandler("llvalues");
   
   //КОНСТРУКТОР
   /*-----------------------------------------------------------------------*/
   /*Собственно поиск счета*/
   //это будет единственное действие в конструкторе класса
   DepoAcount.rec.AutoKey = depo_acc;
   ClearRecord(settacc.rec);
   if(DepoAcount.GetEQ)
     if ( not FindSETTACC( DepoAcount.rec.Owner, FIKIND_CURRENCY, NATCUR, settacc ) )
       settacc.rec.BankID = -1;
     end;
   else
     return NULL;
   end;

   //так как некоторые значения (например, наименования субъектов)
   //могут подкачиваться за определенную дату (обычно дата выпуска отчета)
   //если дата не указана для объекта класса, то делаем её текущей по умолчанию
   if (valType(c_rep_date) == V_UNDEF)
     arh_date = {curdate};
   else
     arh_date = c_rep_date;
   end;

  ////////////////////////////////////////////////////////////////////////
  //функции члены класса

   /*Внутренний интерфейс в Namealg.dbt*/
   private macro __NameAlg(Type, Number)
     NameAlg.rec.iTypeAlg = Type;
     NameAlg.rec.iNumberAlg = Number;
     if(NameAlg.GetEQ)
       return NameAlg.rec.szNameAlg;
     end;
     return UnSetName;
   end;
   
   macro DepoTypeName()
     depoac.rec.ID = DepoAcount.rec.Type;
     if(not depoac.GetEQ)
       MsgBox("Не определен тип счета Депо");
       return "";
     end;
     return depoac.rec.ShortName;
   end;
 
   macro DepoRec()
      return DepoAcount.rec;
   end;

   macro Owner()
     return DepoAcount.rec.Owner;
   end;
 
   macro AutoKey()
     return DepoAcount.rec.AutoKey;
   end;

   macro Type()
     return DepoAcount.rec.Type;
   end;
 
   macro Code()
     return DepoAcount.rec.Code;
   end;
 
   macro Name()
     return DepoAcount.rec.Name;
   end;

   /*Ссылка на корень (счет Депо) AutoKey*/
   macro Root()
     return DepoAcount.rec.Root;
   end;

   macro DepoKind()
     if(DepoAcount.rec.Kind == активный)
       return "активный";
     elif(DepoAcount.rec.Kind == пассивный)
       return "пассивный";
     else 
       return UnSetName;
     end;
   end;

   macro DepoKindChar()
      return DepoAcount.rec.Kind;
   end;

  /* Депонент || Домицилиат */
   /*Страна*/
   macro Nationality()
     var Nation="";
     var country = TBFile("country",NULL,2,NULL,"rsrfdb.def");
     OwnPArty.rec.PartyID = vDeponentID;
     if(OwnPArty.GetEQ())
       if(OwnPArty.rec.NotResident == SET_CHAR)
         country.rec.CodeLat3 = OwnPArty.rec.NRCountry;
         if(country.GetEQ)
           Nation = country.rec.Name;
         else
           MsgBox("Не найдена страна нерезидента ", OwnPArty.rec.ShortName);
         end;
       else
         Nation = "Российская Федерация";
       end;
     end;
     return Nation;
   end;

   /* юрисдикция оператора/попечителя */
   macro OpNationality()
     var Nation="";
//     var country = TBFile("country",NULL,2,NULL,"rsrfdb.def");
//     OParty.rec.PartyID = vOperatorID;
//     if( OParty.GetEQ() )
//       if(OParty.rec.NotResident == SET_CHAR)
//         country.rec.CodeLat3 = OwnPArty.rec.NRCountry;
//         if(country.GetEQ)
//           Nation = country.rec.Name;
//         else
//           MsgBox("Не найдена страна нерезидента ", OParty.rec.ShortName);
//         end;
//       else
//         Nation = "Российская Федерация";
//       end;
//     end;
     return Nation;
   end;

   macro Superior()
     var ppath;
     var CurentNode = DepoAcount.rec.AutoKey;
     DepoAcount.rec.AutoKey = DepoAcount.rec.Superior;
 
     if(DepoAcount.GetEQ)
       if(DepoAcount.rec.Superior == 0)
         ppath = "";
       else
         ppath = DepoAcount.rec.BriefCode;
       end;
     end;
     DepoAcount.rec.AutoKey = CurentNode;
     if(not DepoAcount.GetEQ)
       runerror("Не найден счет депо");
     end;
     return ppath;
   end;

  /* Денежный счет */
   /*Номер счета*/
   macro MoneyAcc()
     return settacc.rec.Account;
   end;
   /*Вид альтернативного кода*/
   macro KindOfAltCode()
     var codekind = TBFile("codekind");
     codekind.rec.CodeKind = AltCodeKind;
     if(codekind.GetEQ)
       return codekind.rec.Name;
     else 
       MsgBox("Неизвестный вид альтернативного идентификатора");
       return "";
     end;
   end;
   macro AltCode() /*Альтернативный код*/
     return ПолучитьКодСубъекта (settacc.rec.BankID, AltCodeKind);
   end;
   macro BankCode() /*Код банка*/
     return ПолучитьКодСубъекта (settacc.rec.BankID, party_code_kind_contr_code);
   end;
   macro BankINN() /*INN Bank*/
     return ПолучитьКодСубъекта (settacc.rec.BankID, PTCK_INN);
   end;


   /*Путь от корня к узлу из BriefCode*/
   macro PartitionPath()
     var Select;
     var ppath = "", pstat = true;
     var DataSet, query;
     if( DepoAcount.rec.Superior != 0)
       query =   " select t_BriefCode from ddepoacnt_dbt "
               + " where t_AutoKey != ? " /*1*/ 
               + " START WITH t_AutoKey = ? " /*2*/ 
               + " CONNECT BY  t_Autokey  = PRIOR t_Superior "; 

       Select = RSDCommand( query  );

       Select.AddParam("AutoKey1", RSDBP_IN, DepoAcount.rec.AutoKey );  /*1*/
       Select.AddParam("AutoKey2", RSDBP_IN, DepoAcount.rec.AutoKey );  /*2*/

       Select.Execute();

       DataSet = TRSBDataSet(Select);
       while( DataSet.MoveNext() )
         ppath = DataSet.BriefCode +" / "+ppath;
       end;
     end; 
     return ppath;
   end;

   macro ДоговорДепо(RepDate)
     var Договор = "-";
     file Sfcontr ("sfcontr") key 1;

     Sfcontr.ServKind    = SERVKIND;
     Sfcontr.ServKindSub = 0;
     Sfcontr.ObjectType  = 2;
     Sfcontr.FIID        = 0;
     Sfcontr.Object      = Code;
     
     if( GetEQ(Sfcontr) AND (Sfcontr.DateBegin<=RepDate) )
       if(Sfcontr.Name!="")
         Договор = Sfcontr.Name + ", ";
       else Договор = "-" + ", ";
       end;

       Договор = Договор + "№ " + Sfcontr.Number + " от " + Sfcontr.DateBegin;
     end;
     return Договор;
   end;

   //группа ф-ций, оперделяющих св-ва депонента
   macro DeponentID()
     vDeponentID = DepoAcount.rec.Owner;
     return vDeponentID;
   end;

   macro OperatorID()
//     if(valType(vOperatorID) != V_UNDEF)
//       return vOperatorID;
//     end;

     return -1;
   end;

   //создает объект класса CDPParty 
   private macro GetPartyObject( P_TYPE )
    
     if( P_TYPE == P_DEPONENT )
       if( valType(cDeponent) == V_UNDEF)
         cDeponent = CDPParty(DeponentID(), arh_date);
       end;
       return cDeponent;
     elif( P_TYPE == P_BANK )
       if( valType(cBank) == V_UNDEF)
         cBank = CDPParty(settacc.rec.BankID, arh_date);
       end;
       return cBank; 
//     elif( P_TYPE == P_OPERATOR )
//       if( valType(cOperator) == V_UNDEF)
//         cOperator = CDPParty(OperatorID(), arh_date);
//       end;
//       return cOperator;
     end;

   end;

   macro DeponentName()
     if( vDeponentName != "" )
       return vDeponentName;
     end;

     //подкачиваем наименование депонента за дату создания счета
     cDeponent = GetPartyObject(P_DEPONENT);
     vDeponentName = cDeponent.Name();
     return vDeponentName;
   end;

   macro DeponentКод()
     if( vDeponentКод != "" )
       return vDeponentКод;
     end;
     
     //подкачаем код депонента
     vDeponentКод = ПолучитьКодСубъекта(DeponentID(), PTCK_CONTR);
     return vDeponentКод;
   end;

   macro DeponentINN()
     if( vDeponentINN != UnSetName )
       return vDeponentINN;
     end;

     //подкачаем ИНН депонента
     cDeponent = GetPartyObject(P_DEPONENT);
     vDeponentINN = cDeponent.CodeINN();
     return vDeponentINN;
   end;

   //группа ф-ций для агента
   macro AgentKind()
     if( vAgentKind != "" )
       return vAgentKind;
     end;

     if(DepoAcount.rec.Kind == активный)
       vAgentKind = "Домицилиат";
     elif(DepoAcount.rec.Kind == пассивный)
       vAgentKind = "Депонент";
     end;

     return vAgentKind;
   end;

   ////
   macro IncomeDelivery()
     if( vIncomeDelivery != "" )
       return vIncomeDelivery;
     end;

     if(DepoAcount.rec.IncomeDelivery == "")
       vIncomeDelivery = "-";
     else
       vIncomeDelivery = DepoAcount.rec.IncomeDelivery;
     end;

     return vIncomeDelivery;
   end;

   macro OrderDelivery()
     if( vOrderDelivery != "" )
       return vOrderDelivery;
     end;

     if(DepoAcount.rec.OrderDelivery == "")
       vOrderDelivery = "-";
     else
       vOrderDelivery = DepoAcount.rec.OrderDelivery;
     end;
     
     return vOrderDelivery;
   end;

   macro StatementDelivery()
     if( vStatementDelivery != "" )
       return vStatementDelivery;
     end;

     if(DepoAcount.rec.StatementDelivery=="")
       vStatementDelivery = "-";
     else
       vStatementDelivery = DepoAcount.rec.StatementDelivery;
     end;
     
     return vStatementDelivery;
   end;

   /*Имя банка*/
   macro BankName()
     if( vBankName != UnSetName )
       return vBankName;
     end;

     BParty.rec.PartyID = settacc.rec.BankID;

     cBank = GetPartyObject(P_BANK);
     vBankName = cBank.Name();

     return vBankName;
   end;

   
   //группа ф-ций для оператора
   macro Operator()
//     if( vOperator != UnSetName )
//       return vOperator;
//     end;
//     
//     cOperator = GetPartyObject(P_OPERATOR);
//     vOperator = cOperator.Name();
//     return vOperator;
     return -1;
   end;
 
   /*Связи*/
   macro OrderDC()
     vOrderDC = DepoAcount.rec.DODelivery;
     return vOrderDC;
   end;

   macro StatementDC()
     vStatementDC = DepoAcount.rec.DSDelivery;
     return  vStatementDC;
   end;

   macro OrderString()
     vOrderString = DepoAcount.rec.OrderDelivery;
     return vOrderString;
   end;

   macro StatementString()
     vStatementString = DepoAcount.rec.StatementDelivery;
     return vStatementString;
   end;

   /*Синтетический счет, назначенный счёту депо по умолчанию*/
   macro Synthetics()
     vSynthetics = DepoAcount.rec.Synt;
     return vSynthetics;
   end;
  
   /*Блокировка*/
   macro AvoirStatusName()
     if( vAvoirStatusName != "" )
       return vAvoirStatusName;
     end;
        
     if( LL_FindLLVALUES( OBJTYPE_KIND_BLOCK_CB, DepoAcount.rec.AvoirStatus, llv_rec ) )
       vAvoirStatusName = llv_rec.rec.Name;
     else
       vAvoirStatusName = "-";
     end;
     return vAvoirStatusName;
   end;

   macro AvoirStatus()
     return DepoAcount.rec.AvoirStatus;
   end;



   /*Статус счета Депо*/
   macro Status()
     //ищем через адм. операции и их объекты
     var query, AdmData;
     file dpadm("depoadmo");
     var locNAMEs  = TArray;
     var locFROM   = TArray;
     var locTO     = TArray;
     var Select;

     // Если статус счета установили до даты запроса, то он таким и будет до бесконечности
     if(DepoAcount.rec.StateDate <= arh_date)
       vStatus = DepoAcount.rec.Status;
     end;

     if( (ValType(vStatus) != V_UNDEF) and (vStatus >= 0))
       return vStatus;
     end;
  
     // Для случая когда дата запроса указывает на момент до последнего изменения статуса его можно попытаться определить ТОЛЬКО по АО

     query =   " select t_AdmoprID from ddepoadmo_dbt "
             + "  where t_AdmoprID = rsb_depo.GetObjPrevAdmoprOnDate(?, -1, CHR(0), ?)";
     
     Select = RSDCommand( query  );

     Select.AddParam("AutoKey", RSDBP_IN, DepoAcount.rec.AutoKey );  /*1*/
     Select.AddParam("arh_date", RSDBP_IN, arh_date );  /*2*/

     Select.Execute();

     AdmData = TRsbDataSet(Select);
     if(AdmData.moveNext()) 
       //есть операция в эту дату или до
       
       dpadm.AdmoprID = AdmData.AdmoprID;
       if(GetEQ(dpadm))
         //GetDEPOADMO_Contents(dpadm, locNAMEs, locFROM, locTO);
         vStatus = GetParmValue("Status", dpadm.AdmoprID, true);//StatusAtoi( locTO(DP_ADMDACNT_Status) );
       end;
     else
       //ищем операцию после
       query =   " select t_AdmoprID from ddepoadmo_dbt "
               + "  where t_AdmoprID = rsb_depo.GetObjNextAdmoprOnDate(?, -1, CHR(0), ?)";
       Select = RSDCommand( query  );

       Select.AddParam("AutoKey", RSDBP_IN, DepoAcount.rec.AutoKey );  /*1*/
       Select.AddParam("arh_date", RSDBP_IN, arh_date );  /*2*/

       Select.Execute();

       AdmData = TRsbDataSet(Select);
       if(AdmData.moveNext())
         //нашли
         dpadm.AdmoprID = AdmData.AdmoprID;
         if(GetEQ(dpadm))
           //GetDEPOADMO_Contents(dpadm, locNAMEs, locFROM, locTO);
           vStatus = GetParmValue("Status", dpadm.AdmoprID, false);//StatusAtoi( locFROM(DP_ADMDACNT_Status) );

           // Дата выполнения АО позже последнего изменения статуса счета и ее содержимое далеко от состояния arh_date
           if(dpadm.OperDate > DepoAcount.rec.StateDate)
             //операций нет - возвращаем текущий статус
             vStatus = DepoAcount.rec.Status;
           end;
         end;
       else
         //операций нет - возвращаем текущий статус
         vStatus = DepoAcount.rec.Status;   
       end;
     end;

     //vStatus = DepoAcount.rec.Status;
     return vStatus;
   end;

   macro StatusName()
     if( vStatusName != UnsetName )
       return vStatusName;
     end;

     vStatusName = __NameAlg(NLStatusName, Status);
     return vStatusName;
   end;

   macro StatusMomentSet()
     if(DepoAcount.rec.CloseDate != date(0,0,0))
       vStatusMomentSet = DepoAcount.rec.CloseDate;
     else
       vStatusMomentSet = DepoAcount.rec.OpenDate;
     end;

     return vStatusMomentSet;
   end;

   /*Административные операции*/
   macro OpenOpNum()
     if(DepoAcount.rec.OpNum)
       vOpenOpNum = DepoAcount.rec.OpNum;
     end;

     return vOpenOpNum;
   end;

   macro OpenDate()
     vOpenDate = DepoAcount.rec.OpenDate;

     return vOpenDate;
   end;

   macro OpenTime()
     vOpenTime = DepoAcount.rec.OpenTime;
     return vOpenTime();
   end;

   macro ModDate()
     vModDate = DepoAcount.rec.CloseDate;
     return vModDate;
   end;

   macro  ModTime()
     vModTime = DepoAcount.rec.CloseTime;
     return vModTime;
   end;


    /*Связи*/
   macro LinkKind(OrderChar, StatementChar)
     var DeliveryChar = false,
         stat = false;
     var tOrderChar = " ",
         tStatementChar = " ";
     var numb = 0; 

     if(OrderDC() != "")
       stat = true;
       DeliveryChar = vOrderDC;
       vOrderDC = "";
       tOrderChar = DLink;
     end;
     if((not stat) and (StatementDC() != ""))
       stat = true;
       DeliveryChar = vStatementDC;
       vStatementDC = "";
       tStatementChar = DLink;
     end;
     if(stat and (StatementDC() == DeliveryChar()))
       vStatementDC = "";
       tStatementChar = DLink;
     end;
     if((not stat) and (OrderString != ""))
       DeliveryChar = substr(OrderString, 1, 1);
       tOrderChar = IsLink;
       stat = true;
     end;
     if((stat) and (OrderString != ""))
       if((numb = Index(OrderString, DeliveryChar)) != 0)
         OrderString = substr(OrderString, 1, numb-1)
                     + substr(OrderString, numb+1, strlen(OrderString));
         if(tOrderChar == " ")
           tOrderChar = IsLink;
         end;
       end;
     end;

     if((not stat) and (StatementString != ""))
       DeliveryChar = substr(StatementString, 1, 1);
       tStatementChar = IsLink;
       stat = true;
     end;
     if((stat) and (StatementString != ""))
       if((numb = Index(StatementString, DeliveryChar)) != 0)
         StatementString = substr(StatementString, 1, numb-1) 
                  + substr(StatementString, numb+1, strlen(StatementString));
         if(tStatementChar == " ")
            tStatementChar = IsLink;
         end;
       end;
     end;

     if(stat)
       SetParm(1, tOrderChar);
       SetParm(2, tStatementChar);

       TypeAc.rec.iNumType = 152;
       TypeAc.rec.Type_Account = DeliveryChar;
       if(TypeAc.GetEQ)
         return TypeAc.rec.Name_Type;
       else
         return DeliveryChar;
       end;
     end;

     return false;
   end;
 
    /*Административные операции*/

   macro AdmoID()
      var Select;
      query =   " select t_OprXid, t_Ground, t_Oper from ddepoadmo_dbt "
              + " where t_AdmoprID = ? " /*1*/;

      Select = RSDCommand( query  );

      Select.AddParam("AdmoprID", RSDBP_IN, DepoAcount.rec.OpNum );  /*1*/

      Select.Execute();

      DEPOADMO = TRsbDataSet(Select);
      if(DEPOADMO.MoveNext())
        if(DEPOADMO.rec.OprXid)
          vOpenOprXid = DEPOADMO.rec.OprXid;
        end;
        vOpenOper = DEPOADMO.rec.Oper;    
        spGround.rec.SPgroundID = DEPOADMO.rec.Ground;
        if(spGround.GetEQ)
          vOpenGroun = AdmoKindName(spGround.rec.Kind);
          vOpenDocNum = spGround.rec.Xld;
          if( spGround.rec.RegistrDate != date(0,0,0) )
            vRegistrDateOpen = spGround.rec.RegistrDate;
          end;
        end;
      end;
      CLOSE(DEPOADMO);
   end;

   macro OpenOprXid()
     if( vOpenOprXid != "" )
       return vOpenOprXid;
     end;

     AdmoID();
     return vOpenOprXid;
   end;

   macro OpenOper()
     if( vOpenOper != "" )
       return vOpenOper;
     end;

     AdmoID();
     return vOpenOper;
   end;

   macro OpenGroun()
     if( vOpenGroun != "" )
       return vOpenGroun;
     end;

     AdmoID();
     return vOpenGroun;
   end;

   macro OpenDocNum()
     if( vOpenDocNum != "" )
       return vOpenDocNum;
     end;

     AdmoID();
     return vOpenDocNum;
   end;

   macro RegistrDateOpen()
     if( vRegistrDateOpen != date(0,0,0) )
       return vRegistrDateOpen;
     end;

     AdmoID();
     return vRegistrDateOpen;
   end;

   macro AdmoParty()
     var Select;

     query =   " select t_OprXid, t_Ground, t_Oper, t_AdmoprID from ddepoadmo_dbt "
             + " where t_PartyID = ? "/*1*/
             + "   and t_FIID = " + ALLFININSTR
             + "   and t_Account = CHR(1) "
             + "   and t_Item = ? " /*2*/
             + "   and t_DepoAcc = ? " /*3*/
             + "   and t_DepoPart = ? " /*4*/;  

     Select = RSDCommand( query  );


     Select.AddParam("PartyID", RSDBP_IN, DepoAcount.rec.Owner );     /*1*/

     if( DepoAcount.rec.SKind == DEPO_ACCOUNT )
       Select.AddParam("Item", RSDBP_IN, SPDP_DEPO_ACCOUNT );         /*2*/
       Select.AddParam("DepoAcc", RSDBP_IN, DepoAcount.rec.AutoKey ); /*3*/
       Select.AddParam("DepoPart", RSDBP_IN, 0 );                     /*4*/
     else
       Select.AddParam("Item", RSDBP_IN, SPDP_DEPO_PARTITION );       /*2*/
       Select.AddParam("DepoAcc", RSDBP_IN, DepoAcount.rec.Root );    /*3*/
       Select.AddParam("DepoPart", RSDBP_IN, DepoAcount.rec.AutoKey );/*4*/
     end;

     Select.Execute();

     DEPOADMO = TRSBDataSet(Select);
     if( DEPOADMO.MoveNext() )
         vModOpNum = DEPOADMO.rec.AdmoprID; 
         if(DEPOADMO.rec.OprXid)     
           vModOprXid = DEPOADMO.rec.OprXid;
         end;
         vModOper = DEPOADMO.rec.Oper;    
         spGround.rec.SPgroundID = DEPOADMO.rec.Ground;
         if(spGround.GetEQ)
           vModGroun  = AdmoKindName(spGround.rec.Kind); 
           vModDocNum = spGround.rec.Xld;
           if( spGround.rec.RegistrDate != date(0,0,0) )
             vRegistrDateMod = spGround.rec.RegistrDate;
           end;
         end;
     end;
     CLOSE(DEPOADMO);
   end;

   macro ModOpNum()
     if( vModOpNum > 0 )
       return vModOpNum;
     end;

     AdmoParty();
     return vModOpNum;
   end;

   macro ModOprXid()
     if( vModOprXid != "" )
       return vModOprXid;
     end;

     AdmoParty();
     return vModOprXid;
   end;

   macro ModOper()
     if(vModOper > 0)
       return vModOper;
     end;

     AdmoParty();
     return vModOper; 
   end;

   macro ModGroun()
     if(vModGroun > "")
       return vModGroun;
     end;

     AdmoParty();
     return vModGroun; 
   end;

   macro ModDocNum()
     if(vModDocNum > "")
       return vModDocNum;
     end;

     AdmoParty();
     return vModDocNum; 
   end;

   macro RegistrDateMod()
     if(vRegistrDateMod != date(0,0,0) )
       return vRegistrDateMod;
     end;

     AdmoParty();
     return vRegistrDateMod; 
   end;


   Macro StatusNameF()
     return __NameAlg(NLStatusName, Status);
   end;

   Macro IncomeDeliveryF()
     file Typeac("typeac");
                
     Typeac.iNumType = TA_INC_DEL;
     Typeac.Type_Account = IncomeDelivery;
 
     if( GetEQ(Typeac) )
      return Typeac.Name_Type;
     end;

     return "-";
   end;

   Macro OrderDeliveryF()
     file Typeac("typeac");
                
     Typeac.iNumType = TA_STAT_DEL;
     Typeac.Type_Account = OrderDelivery();
 
     if( GetEQ(Typeac) )
      return Typeac.Name_Type;
     end;

     return "-";
   end;

   Macro StatementDeliveryF()
     file Typeac("typeac");
                
     Typeac.iNumType = TA_STAT_DEL;
     Typeac.Type_Account = StatementDelivery();
 
     if( GetEQ(Typeac) )
      return Typeac.Name_Type;
     end;

     return "-";
   end;

end;              
/*---------------------------------------------------------------------------*/


macro MDepoPart( _depoacnt, _Tab, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, rep )
  macro NameAlg(Type, Number)
    file NameAlg(namealg);

    NameAlg.iTypeAlg = Type;
    NameAlg.iNumberAlg = Number;
    if( GetEQ(NameAlg) )
      return NameAlg.szNameAlg;
    end;
    return UnSetName;
  end;

  macro DepoTypeName(Type)
    file Depoac(depoac);

    depoac.ID = Type;
    if(not GetEQ(Depoac))
      return "";
    end;
    return depoac.ShortName;
  end;

  var stat, Status, query;
  file Depoacnt_key5(depoacnt) key 5;
  var admo = TBFile("depoadmo");
  var depopart;

  Depoacnt_key5.Superior = _depoacnt.AutoKey;
  stat = GetEQ(Depoacnt_key5);
  while( stat AND (Depoacnt_key5.Superior == _depoacnt.AutoKey) AND 
              (Depoacnt_key5.OpenDate<=RepDate) )
    
    
/*  [------------------+--------------+-----------+------------------------];*/
    depopart = DepoInfo(Depoacnt_key5.AutoKey, RepDate);
    /*Status = Depoacnt_key5.Status;
    if(RepDate!={curdate}) 
      query =   "     t_PartyID = " + Depoacnt_key5.Owner
              + " and t_Item = " + SPDP_DEPO_PARTITION
              + " and t_DepoAcc = " + Depoacnt_key5.Root
              + " and t_DepoPart = " + Depoacnt_key5.AutoKey
              + " and t_FIID = " + ALLFININSTR
              + " and t_Account = CHR(1) ";
      admo.AddFilter(query);

     if( admo.next() )
        GetDEPOADMO_Contents(admo, sNAMEs, sFROM, sTO);      
        Status = sTO(DP_ADMDACNT_Status);
        Status = StatusAtoi( Status );
      end;
    end; */
    
    if((((depopart.Status==SPSK_OPEN)  AND StatusOpen_PAR)  OR
        ((depopart.Status==SPSK_CLOSE)  AND StatusClose_PAR) OR
        ((depopart.Status==SPSK_LOCKED) AND StatusLocked_PAR)))
      if( rep == true )
         if(NeedOperatorLevel(Depoacnt_key5, true, RepDate))
           DP_AddPrintCell( DispPartRep, _Tab + Depoacnt_key5.BriefCode, 18, 0, "l:" + FontStyleTitel );
           DP_AddPrintCell( DispPartRep, Depoacnt_key5.Name, 20, 0, "l:" + FontStyleTitel );
           DP_AddPrintCell( DispPartRep, DepoTypeName(Depoacnt_key5.Type), 14, 0, "l:" + FontStyleTitel );
           DP_AddPrintCell( DispPartRep, depopart.StatusName, 11, 0, "l:" + FontStyleTitel );
           DP_AddPrintCell( DispPartRep, Characteristic_Name(Depoacnt_key5.AutoKey, RepDate), 24, 0, "l:" + FontStyleTitel );
           DispPartRep.AddStr();
         end;
         MDepoPart(Depoacnt_key5, _Tab + "   ", RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, true );
      else return 0;
      end;
    end;
    stat = Next(Depoacnt_key5);
  end;

  return 1;
end;


macro FinInName(FIID)
   file fininstr(fininstr);
   fininstr.FIID = FIID;
   if(not GetEQ(fininstr))
     MsgBox("Не найден финансовый инструмент");
     return "";
   end;
   return fininstr.Name;
end;


class ДенежныйСчет(_Settacc, _RepDate)
  var FIID = _Settacc.FIID;
  var NominalFICode;
  var NominalFIIDName;
  var BankCorrID = _Settacc.BankCorrID;
  var BankCorrBIG = "";
  var CorrAcc = _Settacc.CorrAcc; //Корсчет
  var BankID = _Settacc.BankID;//наименование банка
  var BankBIG = "";
  var Account = _Settacc.Account;//счет
  var RepDate = _RepDate;

  NominalFICode   = ПолучитьКодФинИн(FIID);
  NominalFIIDName = FinInName(FIID);

  BankCorrBIG = ПолучитьКодСубъекта(BankCorrID, PTCK_BIC);
  BankBIG     = ПолучитьКодСубъекта(BankID, PTCK_BIC);

  macro AddressParty(ID)
    record party(party);
    record RecordAdress ( adress );
    var address = "";

    if( ПолучитьСубъекта( ID, party ) )
      MsgBox("Не найден депозитарий");
    else
      if(НайтиЮридическийАдресСубъекта(party.PartyID,RecordAdress))
        address = RecordAdress.Adress;
      end;
    end;

    return address;
  end;

  macro ДСчет( PrintFI )
    var Счет = "-";
    if( PrintFI )
      Счет = Счет + NominalFICode+" ("+NominalFIIDName+") ";
    end;
    Счет = Счет + " р/с " + Account + ", в банке " + NameParty(BankID, RepDate)  + ", " + 
           AddressParty(BankID) + ", БИК " + BankBIG + " к/с " + CorrAcc + " в " + 
           NameParty(BankCorrID, RepDate) + ", БИК " + BankCorrBIG;
    
    return Счет;
  end;

end;
var ДенежныйСчет_Arr = TArray;


/*Имя депозитария*/
macro OurDepozitariumName()       /*Our Name*/
  file party (party);
  party.PartyID = _SelfID;
  if(not GetEQ(party))
    MsgBox("Не найден депозитарий");
    return "";
  end;
  return party.Name;
end;

macro АнкетаСчетаДепо(depo_acc, 
                      iDeponent, 
                      RepDate, 
                      StatusOpen_ACC, 
                      StatusLocked_ACC, 
                      StatusClose_ACC, 
                      disp_part, 
                      StatusOpen_PAR, 
                      StatusLocked_PAR, 
                      StatusClose_PAR, 
                      count, 
                      AutoKey_logopr,
                      _depo_acc)

  var tt;
  var DepoInf = DepoInfo(depo_acc, RepDate);
  var LinkKind, OrderChar, StatementChar;
  var stat, ДСчет;
  var i_лица, i = 0;
  var PrintFI = false;
//  var ТипЛица, Полномочия;
//  var Оператор_Arr      = TArray;
//  var Распорядитель_Arr = TArray;
  var AcAP_arr = TArray;
  var OpenData, CloseData, Документ;
  var query;
  var ObjectID;
  var DataSettAcc;
  var Format="";

  var settacc = TBFile("settacc");
  var sfcontr = TBFile("sfcontr");
  record Depoadm ("depoadmo");
  var admo = TBFile("depoadmo");

  if(RepDate!={curdate})

    /*query =   "     t_PartyID = " + DepoInf.DepoRec.Owner
            + " and t_Item = " + SPDP_DEPO_ACCOUNT
            + " and t_DepoAcc = " + DepoInf.DepoRec.AutoKey
            + " and t_DepoPart = 0 "
            + " and t_FIID = " + ALLFININSTR
            + " and t_Account = CHR(0) "
            + " and t_OperDate <= " + GetSQLDate(RepDate);
    admo.AddFilter(query);
    if( admo.next() )
      SetBuff(Depoadm, admo.rec);
      GetDEPOADMO_Contents(Depoadm, sNAMEs, sFROM, sTO);      
      DepoInf.vStatus            = sTO(DP_ADMDACNT_Status);
      DepoInf.vIncomeDelivery    = sTO(DP_ADMDACNT_IncomeDelivery);
      DepoInf.vOrderDelivery     = sTO(DP_ADMDACNT_OrderDelivery);
      DepoInf.vStatementDelivery = sTO(DP_ADMDACNT_StatementDelivery);
      DepoInf.vStatus = StatusAtoi( DepoInf.Status );
    end;*/
  end;

  if( (  DepoInf.DepoRec.OpenDate<=RepDate) AND 
      ( (DepoInf.DepoRec.Owner==iDeponent) OR (-1==iDeponent)) AND
      (((DepoInf.Status==SPSK_OPEN)  AND StatusOpen_ACC)  OR
      (( DepoInf.Status==SPSK_CLOSE)  AND StatusClose_ACC) OR
      (( DepoInf.Status==SPSK_LOCKED) AND StatusLocked_ACC))
    )
    if( count > 0 )
      DP_AddPrintCell( DispPartRep, "------------------------------------------------------", width, 0, "c:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
      DispPartRep.AddStr();
      DispPartRep.AddEmptyStr();
    end;

    if( _depo_acc <= 0 )
      DP_StdHeaderLO_Ex(DispPartRep, FontStyleTitel, "АНКЕТА СЧЕТА ДЕПО", AutoKey_logopr, count+1, true, RepDate, NULL, width );
    else
      DP_StdHeaderLO_Ex(DispPartRep, FontStyleTitel, "АНКЕТА СЧЕТА ДЕПО", AutoKey_logopr, count, false, RepDate, NULL, width );
    end;

    if(DepoInf == NULL)
      return 1;
    end;

    ДенежныйСчет_Arr.Size = 0;

    //СПИ нужны только привязанные к договору счета, но не к депоненту
    
    //сначала ищем договор по счету
    query = " t_Object = '" + DepoInf.DepoRec.Code + "' ";
    sfcontr.AddFilter(query);
    if( sfcontr.next() )  //есть контракт
       //преобразуем ид объекта
       ObjectID = UniID( sfcontr, OBJTYPE_SFCONTR );
       //найдем наконец СПИ, привязанные к контракту
       query =   " select distinct * from dsettacc_dbt  "  
               + " where t_FIKind = " + FIKIND_CURRENCY
               + " and t_SettaccID in ( select t_SetaccID from dsfssi_dbt "
               + "                      where t_ObjectType = "+OBJTYPE_SFCONTR
               + "                        and t_ObjectID = '"+ObjectID+"' "
               + "                    ) ";
       DataSettAcc = TRsbDataSet(query);
       while( DataSettAcc.moveNext() )
         ДенежныйСчет_Arr[ДенежныйСчет_Arr.Size] = ДенежныйСчет( DataSettAcc, RepDate );
       end;
    end;
    
    if( ДенежныйСчет_Arr.Size )
      while( i < ДенежныйСчет_Arr.Size ) 
        if( ДенежныйСчет_Arr[i].FIID != NATCUR ) 
          PrintFI = true;
        end;
        i = i + 1;
      end;
    end;
   DP_AddPrintCell( DispPartRep, "------------------------------------------------------", width, 0, "c:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "Cчёт депо", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "     код", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.Code + " ( короткий " + DepoInf.DepoRec.BriefCode + " )", width-30, 0, "l:w:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "     наименование", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.Name, width-30, 0, "l:w:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "     вид", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.DepoKind, width-30, 0, "l:w:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "     тип", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.Type + " " + DepoInf.DepoTypeName, width-30, 0, "l:w:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "Владелец", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.AgentKind + " " + DepoInf.DeponentName, width-30, 0, "l:w:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "     ИНН", 30, 0, "l:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.DeponentINN, width-30, 0, "l:w:" + FontStyleTitel,_use_ap, REP_ELEM_STR );
   DispPartRep.AddStr();
   DP_AddPrintCell( DispPartRep, "     код анкеты", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
   DP_AddPrintCell( DispPartRep, DepoInf.DeponentКод, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
   DispPartRep.AddStr();
    if(DepoInf.ДоговорДепо(RepDate)!="-")
      i = 1;
      if(ДенежныйСчет_Arr.Size)
        ДСчет = ДенежныйСчет_Arr[0].ДСчет( PrintFI );
      else
        ДСчет = "-";
      end;
      DP_AddPrintCell( DispPartRep, "Денежный счет ", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DP_AddPrintCell( DispPartRep, ДСчет, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DispPartRep.AddStr();
      while( i < ДенежныйСчет_Arr.Size ) 
        DP_AddPrintCell( DispPartRep, "", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
        DP_AddPrintCell( DispPartRep, ДенежныйСчет_Arr[i].ДСчет( PrintFI ), width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
        DispPartRep.AddStr();
        i = i + 1;
      end;
    else
      DP_AddPrintCell( DispPartRep, "Денежный счет ", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DP_AddPrintCell( DispPartRep, "-", width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DispPartRep.AddStr();
    end;
 
    DP_AddPrintCell( DispPartRep, "Статус счета депо", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.StatusNameF, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "Депозитарный договор", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.ДоговорДепо(RepDate), width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "Способ получения доходов:", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.IncomeDeliveryF, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "Способ приема поручений от владельца счета:", 44, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.OrderDeliveryF, width-44, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "Способ передачи информации владельцу счета:", 44, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.StatementDeliveryF, width-44, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DispPartRep.AddEmptyStr();
    if( (disp_part==true) AND
        (MDepoPart( DepoInf.DepoRec, "   ", RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, false ) == 0)
      )
      DP_AddPrintCell( DispPartRep, "Структура счета депо по состоянию на дату составления отчета", width, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DispPartRep.AddStr();

      DispPartRep.AutoScan( "[\n" + Table1 + "]" );
      Format ="ex_B(rlb)";
      DP_AddPrintCell( DispPartRep, DepoInf.DepoRec.BriefCode, width-3, 0, "l:w:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      MDepoPart( DepoInf.DepoRec, "   ", RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, true );
      DispPartRep.AddEmptyStr();
    end;

    AcAP_arr.size = 0;
    УЛицаСчетаДепо(AcAP_arr, DepoInf.DepoRec, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR);
    if (AcAP_arr.size > 0)
      DP_AddPrintCell( DispPartRep, "Уполномоченные лица счета депо", width, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DispPartRep.AddStr();

      i = 0;

      DispPartRep.AutoScan( "[\n" + Table2 + "]" );
      while( i < AcAP_arr.Size )
        if(i==0)
          Format ="ex_B(rlb)";
        else
          Format ="";
        end;

        DP_AddPrintCell( DispPartRep, i+1,                      18, 0, "c:"   + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, AcAP_arr[i].НаимТипаЛица, 17, 0, "l:w:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, AcAP_arr[i].Код,          14, 0, "c:w:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, AcAP_arr[i].Наименование, 27, 0, "l:w:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
        Format ="";
        i = i + 1;
      end;
    end;
    if( DepoInf.OpenDate!=date(0,0,0) )
      OpenData = DepoInf.OpenDate;
    else OpenData = "-";
    end;
    if( DepoInf.OpenTime!=Time(0) )
      OpenData = OpenData + " " + DepoInf.OpenTime;
    else OpenData = OpenData + " -";
    end;
    if( (DepoInf.OpenGroun=="") AND (DepoInf.OpenDocNum=="") AND 
        (DepoInf.RegistrDateOpen=="-") AND (DepoInf.OpenOpNum=="-") )
      Документ = "-";
    else
      Документ = DepoInf.OpenGroun + " № " + DepoInf.OpenDocNum + " от " + DateToStr(DepoInf.RegistrDateOpen, true) + " Вх. № " + DepoInf.OpenOpNum;
    end;
    DP_AddPrintCell( DispPartRep, "Административные операции", width, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DispPartRep.AutoScan( "[\n" + Table3 + "]" );

    АдмОпер_Arr.Size = 0;

    query =   " ( t_Item = " + SPDP_DEPO_ACCOUNT
            + " or t_Item = " + SPDP_ACCMANAGER + " ) "
            + " and t_DepoAcc = " + DepoInf.DepoRec.AutoKey
            + " and t_DepoPart = 0 "
            + " and t_OperDate <= " + GetSQLDate(RepDate);

    admo.AddFilter(query);
    while( admo.next() )
      АдмОпер_Arr[АдмОпер_Arr.Size] = АдмОпер(admo.rec);
    end;
  
    i = 0;
    while( i < АдмОпер_Arr.Size )
      Format ="";
      if(i==0)
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;

      if( (i == 0) and (АдмОпер_Arr[i].OperKind != OpenOperKind) )
        DP_AddPrintCell( DispPartRep, "открытие", 11, 0, "l:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
        Format ="";
      end;

      if( (i == 1) and (АдмОпер_Arr[i].OperKind != ModifOperKind) )
        DP_AddPrintCell( DispPartRep, "изменение", 11, 0, "l:" + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
        Format ="";
      end;

      DP_AddPrintCell( DispPartRep, АдмОпер_Arr[i].OperKind, 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, АдмОпер_Arr[i].ModData, 19, 0, "l:w:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, АдмОпер_Arr[i].ModOprXid, 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, (АдмОпер_Arr[i].ModGroun + " № " + АдмОпер_Arr[i].ModDocNum + " от " + АдмОпер_Arr[i].RegistrDateMod + " Вх. № " + АдмОпер_Arr[i].ModOpNum), 37, 0, "l:w:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";

      i = i + 1;
    end;
    
    if( АдмОпер_Arr.Size == 0 )
      DP_AddPrintCell( DispPartRep, "открытие", 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";
      DP_AddPrintCell( DispPartRep, "изменение", 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      DP_AddPrintCell( DispPartRep, "закрытие", 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
    elif( (i == АдмОпер_Arr.Size) and (АдмОпер_Arr[i-1].OperKind != CloseOperKind) )
      if( (i == 1) and (АдмОпер_Arr[i-1].OperKind != ModifOperKind) )
         DP_AddPrintCell( DispPartRep, "изменение", 11, 0, "l:" + Format + FontStyleTitel );
         DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
         DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
         DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
         DispPartRep.AddStr();
         Format ="";
      end;
         DP_AddPrintCell( DispPartRep, "закрытие", 11, 0, "l:" + Format + FontStyleTitel );
         DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
         DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
         DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
         DispPartRep.AddStr();
         Format ="";
    end;

    DispPartRep.AddEmptyStr();
    DP_StdFooter_Ex(DispPartRep, FontStyleTitel, NULL, NULL, width);
    DispPartRep.AddEmptyStr();
    return 1;
  else
    return 0;
  end;
end;


macro АнкетаРазделаСчетаДепо(depo_part, 
                             iDeponent, 
                             RepDate,
                             StatusOpen_PAR, 
                             StatusLocked_PAR, 
                             StatusClose_PAR, 
                             count,
                             AutoKey_logopr,
                             _depo_part)

  var DepoInf = DepoInfo(depo_part, RepDate);
  var RootAcc = DepoInfo(DepoInf.Root, RepDate);
  var LinkKind, OrderChar, StatementChar;
  var stat, ДСчет;
  var i_лица, i = 0;
  var PrintFI = false;
  var ТипЛица, Полномочия;
  var Оператор_Arr      = TArray;
  var Распорядитель_Arr = TArray;
  var OpenData, CloseData, Документ, query;
  var Format = "";
  
  file settacc ("settacc") key 4;
  var admo = TBFile("depoadmo");
  /*if(RepDate!={curdate})
    query =   "     t_PartyID = " + DepoInf.DepoRec.Owner
            + " and t_Item = " + SPDP_DEPO_PARTITION
            + " and t_DepoAcc = " + DepoInf.DepoRec.Root
            + " and t_DepoPart = " + DepoInf.DepoRec.AutoKey
            + " and t_FIID = " + ALLFININSTR
            + " and t_Account = CHR(1) "
            + " and t_OperDate <= " + GetSQLDate(RepDate); 

    admo.AddFilter(query);
    if( admo.next() )
      GetDEPOADMO_Contents(admo, sNAMEs, sFROM, sTO);      
      DepoInf.vStatus = sTO(DP_ADMDPART_Status);
      DepoInf.vStatus = StatusAtoi( DepoInf.Status );
    end;
    CLOSE(admo);
  end;*/

  if( (  DepoInf.DepoRec.OpenDate<=RepDate) AND 
      ( (DepoInf.DepoRec.Owner==iDeponent) OR (-1==iDeponent)) AND
      (((DepoInf.Status==SPSK_OPEN)  AND StatusOpen_PAR)  OR
      (( DepoInf.Status==SPSK_CLOSE)  AND StatusClose_PAR) OR
      (( DepoInf.Status==SPSK_LOCKED) AND StatusLocked_PAR))
    )

    if( count > 0 )
      DP_AddPrintCell( DispPartRep, "------------------------------------------------------", width, 0, "c:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
      DispPartRep.AddStr();
      DispPartRep.AddEmptyStr();
    end;

    if( _depo_part <= 0 )
      DP_StdHeaderLO_Ex(DispPartRep, FontStyleTitel, "РЕГИСТРАЦИОННАЯ КАРТОЧКА РАЗДЕЛА СЧЕТА ДЕПО", AutoKey_logopr, count+1, true, RepDate, NULL, width);
    else
      DP_StdHeaderLO_Ex(DispPartRep, FontStyleTitel, "РЕГИСТРАЦИОННАЯ КАРТОЧКА РАЗДЕЛА СЧЕТА ДЕПО", AutoKey_logopr, count, false, RepDate, NULL, width);
    end;

    if(DepoInf == NULL)
      return 1;
    end;
    DP_AddPrintCell( DispPartRep, "------------------------------------------------------", width, 0, "c:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();

    if( (RootAcc.OpenGroun=="") AND (RootAcc.OpenDocNum=="") AND 
        (RootAcc.RegistrDateOpen=="-") AND (RootAcc.OpenOpNum=="-") )
      Документ = "-";
    else
      Документ = RootAcc.OpenGroun + " № " + RootAcc.OpenDocNum + " от " + RootAcc.RegistrDateOpen + " Вх. № " + RootAcc.OpenOpNum;
    end;

    DP_AddPrintCell( DispPartRep, "Раздел", width, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    код", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.Code + " ( короткий " + DepoInf.DepoRec.BriefCode + " )", width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    наименование", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.Name, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    код счета депо", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, RootAcc.DepoRec.BriefCode, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    владелец", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.AgentKind() + " " + DepoInf.DeponentName(), width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "        ИНН", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.DeponentINN(), width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "        код анкеты", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.DeponentКод(), width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    базовый документ", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, RootAcc.ДоговорДепо(RepDate), width-30, 0, "l:w" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    вид раздела", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.DepoKind, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    тип раздела", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.Type + " " + DepoInf.DepoTypeName, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    код объемлющего раздела", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.Superior(), width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DP_AddPrintCell( DispPartRep, "    статус раздела", 30, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DP_AddPrintCell( DispPartRep, DepoInf.StatusNameF, width-30, 0, "l:w:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DispPartRep.AddEmptyStr();

    
    // Уполномоченные лица
    var acap = CDepoPartAcntAcap();
    // Операторы
    acap.SetFilter(DepoInf.DepoRec.AutoKey, DEPOACAPROLE_OPERATOR, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR);

    stat = acap.GetFirst();
    i = 0;
    while (stat)
      if (i == 0)
        DP_AddPrintCell( DispPartRep, "Оператор раздела", 100, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
        DispPartRep.AddStr();
        DispPartRep.AutoScan( "[\n" + Table4 + "]" );
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;
      DP_AddPrintCell( DispPartRep, i+1, 12, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, acap.PartyCode, 17, 0, "c:w:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, acap.FullName_AuthName, 47, 0, "l:w:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";
      i = i + 1;
      stat = acap.GetNext();
    end;
    if (i > 0)
      DispPartRep.AddEmptyStr();
    end;
    
    // Распорядители
    acap.SetFilter(DepoInf.DepoRec.AutoKey, DEPOACAPROLE_MANAGER, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR);

    stat = acap.GetFirst();
    i = 0;
    while (stat)
      if (i == 0)
        DP_AddPrintCell( DispPartRep, "Распорядители раздела", 100, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
        DispPartRep.AddStr();
        DispPartRep.AutoScan( "[\n" + Table4 + "]" );
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;
      DP_AddPrintCell( DispPartRep, i+1, 12, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, acap.PartyCode, 17, 0, "c:w:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, acap.FullName_AuthName, 47, 0, "l:w:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";
      i = i + 1;
      stat = acap.GetNext();
    end;
    if (i > 0)
      DispPartRep.AddEmptyStr();
    end;

    // Залогодержатели
    acap.SetFilter(DepoInf.DepoRec.AutoKey, DEPOACAPROLE_MORTGAGEE, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR);

    stat = acap.GetFirst();
    i = 0;
    while (stat)
      if (i == 0)
        DP_AddPrintCell( DispPartRep, "Залогодержатели раздела", 100, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
        DispPartRep.AddStr();
        DispPartRep.AutoScan( "[\n" + Table4 + "]" );
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;
      DP_AddPrintCell( DispPartRep, i+1, 12, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, acap.PartyCode, 17, 0, "c:w:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, acap.FullName_AuthName, 47, 0, "l:w:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";
      i = i + 1;
      stat = acap.GetNext();
    end;
    if (i > 0)
      DispPartRep.AddEmptyStr();
    end;

    if( DepoInf.OpenDate!=date(0,0,0) )
      OpenData = DepoInf.OpenDate;
    else OpenData = "-";
    end;
    if( DepoInf.OpenTime!=Time(0) )
      OpenData = OpenData + " " + DepoInf.OpenTime;
    else OpenData = OpenData + " -";
    end;
    if( (DepoInf.OpenGroun=="") AND (DepoInf.OpenDocNum=="") AND 
        (DepoInf.RegistrDateOpen=="-") AND (DepoInf.OpenOpNum=="-") )
      Документ = "-";
    else
      Документ = DepoInf.OpenGroun + " № " + DepoInf.OpenDocNum + " от " + DepoInf.RegistrDateOpen + " Вх. № " + DepoInf.OpenOpNum;
    end;
    DP_AddPrintCell( DispPartRep, "Административные операции", 100, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
    DispPartRep.AddStr();
    DispPartRep.AutoScan( "[\n" + Table3 + "]" );
    i = 0;
    АдмОпер_Arr.Size = 0;
  
    query =   "     t_OperDate <= " + GetSQLDate(RepDate)    
            + " and ((( t_Item = " + SPDP_DEPO_PARTITION
            + "     or t_Item = " + SPDP_PARTMANAGER + " ) "
            + "  and t_DepoAcc = " + DepoInf.DepoRec.Root
            + "  and t_DepoPart = " + DepoInf.DepoRec.AutoKey + " ) "
            + " OR (t_AdmoprID IN (select obj.t_AdmoprID from ddpadmobj_dbt obj where obj.t_DepoPart = "+DepoInf.DepoRec.AutoKey+")))"; 

    admo.AddFilter(query);
    while( admo.next() )
      АдмОпер_Arr[АдмОпер_Arr.Size] = АдмОпер(admo.rec);
    end;
    CLOSE(admo);
  
    i = 0;
    while( i < АдмОпер_Arr.Size )
    Format ="";
      if(i==0)
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;
      if( (i == 0) and (АдмОпер_Arr[i].OperKind != OpenOperKind) )
        DP_AddPrintCell( DispPartRep, "открытие", 11, 0, "l:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
        Format ="";
      end;

      if( (i == 1) and (АдмОпер_Arr[i].OperKind != ModifOperKind) )
        DP_AddPrintCell( DispPartRep, "изменение", 11, 0, "l:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
        Format ="";
      end;

      DP_AddPrintCell( DispPartRep, АдмОпер_Arr[i].OperKind, 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, АдмОпер_Arr[i].ModData, 19, 0, "l:w:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, АдмОпер_Arr[i].ModOprXid, 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, (АдмОпер_Arr[i].ModGroun + " № " + АдмОпер_Arr[i].ModDocNum + " от " + АдмОпер_Arr[i].RegistrDateMod + " Вх. № " + АдмОпер_Arr[i].ModOpNum), 37, 0, "l:w:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";
      i = i + 1;
    end;

    if( АдмОпер_Arr.Size == 0 )
      Format ="";
      DP_AddPrintCell( DispPartRep, "открытие", 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      Format ="";
      DP_AddPrintCell( DispPartRep, "изменение", 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
      DP_AddPrintCell( DispPartRep, "закрытие", 11, 0, "l:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
      DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
      DispPartRep.AddStr();
    elif( (i == АдмОпер_Arr.Size) and (АдмОпер_Arr[i-1].OperKind != CloseOperKind) )
      if( (i == 1) and (АдмОпер_Arr[i-1].OperKind != ModifOperKind) )
        DP_AddPrintCell( DispPartRep, "изменение", 11, 0, "l:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
        Format ="";
      end;
      if((DepoInf.DepoRec.Status == SPSK_CLOSE) and (DepoInf.DepoRec.StateDate <= RepDate))
        DP_AddPrintCell( DispPartRep, "закрытие", 11, 0, "l:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, DepoInf.DepoRec.StateDate + " " + DepoInf.DepoRec.StateTime, 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
      else
        DP_AddPrintCell( DispPartRep, "закрытие", 11, 0, "l:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 19, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 10, 0, "c:" + Format + FontStyleTitel );
        DP_AddPrintCell( DispPartRep, "-", 37, 0, "c:" + Format + FontStyleTitel );
        DispPartRep.AddStr();
      end;
      Format ="";
    end;

    DispPartRep.AddEmptyStr();
    DP_StdFooter_Ex(DispPartRep, FontStyleTitel, NULL, NULL, width);
    DispPartRep.AddEmptyStr();
    return 1;
  else
    return 0;
  end;
end;

file __Depoacnt_key5(depoacnt) key 5;

macro DepoPart( depoacnt_AutoKey, iDeponent, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, count, AutoKey_logopr, _depo_part)
  var stat;

  __Depoacnt_key5.Superior = depoacnt_AutoKey;
  stat = GetEQ(__Depoacnt_key5);
  while( stat AND (__Depoacnt_key5.Superior == depoacnt_AutoKey) )
    count = count + АнкетаРазделаСчетаДепо(__Depoacnt_key5.AutoKey, iDeponent, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, count, AutoKey_logopr, _depo_part);

    DepoPart(__Depoacnt_key5.AutoKey, iDeponent, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, count, AutoKey_logopr, _depo_part);
    stat = Next(__Depoacnt_key5);
  end;

  return count;
end;

private macro CreateEmptyRep(Rep, KindRep)

 if( KindRep == DPINF_DACCOUNT )
   DP_StdHeaderLO_Ex(DispPartRep, FontStyleTitel, "АНКЕТА СЧЕТА ДЕПО", _LogoprID, 0, false, _RepDate, NULL, width );
 elif( KindRep == DPINF_DPARTITION )
   DP_StdHeaderLO_Ex(DispPartRep, FontStyleTitel, "РЕГИСТРАЦИОННАЯ КАРТОЧКА РАЗДЕЛА СЧЕТА ДЕПО", _LogoprID, 0, false, _RepDate, NULL, width);
 end;
 DispPartRep.AddEmptyStr();
 DP_AddPrintCell( DispPartRep, "Нет данных, удовлетворяющих параметрам отчета.", width, 0, "l:" + FontStyleTitel, _use_ap,REP_ELEM_STR );
 DispPartRep.AddEmptyStr();
 DP_StdFooter_Ex(DispPartRep, FontStyleTitel, NULL, NULL, width);

end;


macro depo_acc_form( NumDprt:integer,
                     RepDate:date,
                     iDeponent:integer,
                     depo_acc:integer,    /*номер[autokey] счета депо;*/                                     
                     depo_part:integer,   /*номер раздела счета депо;*/                                      
                     KindReport:integer,  /*вид отчета [раздел-счет], 0-сам счет ДЕПО, 1-раздел счета ДЕПО;*/
                     StatusOpen_ACC:bool,
                     StatusLocked_ACC:bool,
                     StatusClose_ACC:bool,
                     disp_part:bool,
                     StatusOpen_PAR:bool,
                     StatusLocked_PAR:bool,
                     StatusClose_PAR:bool,
                     AutoKey_logopr:integer,
                     ToExcel:bool,
                     use_ap:bool)

  var stat = true;
  var sQuery = "";
  var count = 0, НомерВыписки = "", iCount = 0;;
  var nrec = 0;
  var Depoacnt;

  DP_BeginProtocol();  //начать протоколирование - подмена MsgBox
  Dl_CallInsertStat( IIF( ToExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
  var Progress = CProgressBar;

  _SelfID = DP_GetSelfId(NumDprt);

  _LogoprID = AutoKey_logopr;
  _RepDate  = RepDate;
  _use_ap = use_ap;

  file Splogopr("splogopr");
  file Spground("Spground") key 6;

  sQuery =   " select t_AutoKey from ddepoacnt_dbt where t_AutoKey > 0 "
           + " and t_OpenDate <= " +GetSQLDate(RepDate)
           + " and t_Department = " + NumDprt;

  if( iDeponent != -1 )
    sQuery = sQuery + " and t_Owner = " + iDeponent;
  end;
    
    if(KindReport == DPINF_DACCOUNT)
      sQuery = sQuery + " and t_Superior = 0 ";
                         
      if( depo_acc != 0 )
        sQuery = sQuery + " and t_AutoKey = " + depo_acc;
            end;
      if( StatusOpen_ACC == false )
        sQuery = sQuery + " and t_Status != " + SPSK_OPEN;
          end;

      if( StatusClose_ACC == false )
        sQuery = sQuery + " and t_Status != " + SPSK_CLOSE;
      end;

      if(  StatusLocked_ACC == false )
        sQuery = sQuery + " and t_Status != " + SPSK_LOCKED;
      end;

      Depoacnt = TRsbDataSet(sQuery, RSDVAL_CLIENT, RSDVAL_STATIC);
      Depoacnt.MoveLast();
      nrec = Depoacnt.GetRecCount();
      stat = Depoacnt.MoveFirst();
      
      Progress.Init( nrec, "Формирование отчета...", "Анкета счета депо" );
      while(stat)
         count = count + АнкетаСчетаДепо(Depoacnt.rec.AutoKey, iDeponent, RepDate, StatusOpen_ACC, StatusLocked_ACC, StatusClose_ACC, disp_part, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, count, AutoKey_logopr, depo_acc);
         iCount = Progress.Use();
         stat = Depoacnt.MoveNext();
      end;

      Progress.Remove();
    elif(KindReport == DPINF_DPARTITION)
      if( depo_acc > 0)
         sQuery = sQuery + " and t_Root = " + depo_acc;
         sQuery = sQuery + " and t_AutoKey != " + depo_acc;
            end;
      if(depo_part > 0)
         sQuery = sQuery + " and t_Autokey = " + depo_part;
          end;
      if( (depo_acc <= 0) and (depo_part <= 0) )
        sQuery = sQuery + " and t_AutoKey != t_Root and t_Superior != 0 ";
      end;
      if( StatusOpen_PAR == false )
        sQuery = sQuery + " and t_Status != " + SPSK_OPEN;
      end;
      if( StatusClose_PAR == false )
        sQuery = sQuery + " and t_Status != " + SPSK_CLOSE;
      end;
      if(  StatusLocked_PAR == false )
        sQuery = sQuery + " and t_Status != " + SPSK_LOCKED;
      end;
   
      Depoacnt = TRsbDataSet(sQuery, RSDVAL_CLIENT, RSDVAL_STATIC);
      Depoacnt.MoveLast();
      nrec = Depoacnt.GetRecCount();
      stat = Depoacnt.MoveFirst();
      Progress.Init( nrec, "Формирование отчета...", "Анкета раздела счета депо" );
      while(stat)
        count = count + АнкетаРазделаСчетаДепо(Depoacnt.rec.AutoKey, iDeponent, RepDate, StatusOpen_PAR, StatusLocked_PAR, StatusClose_PAR, count, AutoKey_logopr, depo_part);
        iCount = Progress.Use();
        stat = Depoacnt.MoveNext();
      end;
      Progress.Remove();
    end;

    CLOSE(depoacnt);
   
    DP_AddProtocol(DispPartRep, "protocol");  //добавим протокол к уже сформированному отчету
    DP_EndProtocol();                 //закончить протоколирование

  return DP_StdReportControl( AutoKey_logopr, count, @CreateEmptyRep, KindReport, ToExcel, DispPartRep);
end;
