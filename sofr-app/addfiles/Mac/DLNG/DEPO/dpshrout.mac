/* -@H------------------------------------------------------------------
*            Автоматизированная банковская система RS-Bank
*                 Библиотека интерпретируемых модулей
*                  Copyright (c) JV R-Style 1993-96
*
*   Description      :     Снятие с хранения документарных ц\б
*----------------------------------------------------------------------*/

import oprinter, SPInter, PaymInter, "dps_com.inc", "dp_util.mac";

file pmpaym("pmpaym") key 10;

macro InInterDepo(DACNTCode, ДатаНачала, ДатаКонца)
   var stat=0, NumCert=0, DwAccount = "";
   record  rBaseSum( "sfbassum.str" );

   /*Снятие с хранения документарных ц\б*/
   pmpaym.DocKind     = SP_DEPOPER_WITHDRORDER;   /*списание*/
   pmpaym.ValueDate   = ДатаНачала;
   pmpaym.Purpose     = PurpBase;
   pmpaym.SubPurpose  = 0;
   stat = GetGE(pmpaym);
   while(  stat and
          (pmpaym.DocKind   == SP_DEPOPER_WITHDRORDER) and
          (pmpaym.ValueDate <= ДатаКонца)
        )
      DwAccount = GetHeadAccForAcc(pmpaym.PayerDpNode);
      if( (pmpaym.Purpose == PurpBase) and 
          (DwAccount == DACNTCode ) /*счет клиента c которого списаны бумаги*/
        )
         NumCert = NumCert + 1; /*считаем поручения*/

        rBaseSum.baseType    = SF_BASETYPE_QUONT;
        rBaseSum.baseType2   = SF_BASETYPE_QUONT;
        rBaseSum.baseQuont   = 1;
        rBaseSum.baseQuont2  = 1;

        rBaseSum.BaseObjectType = OBJTYPE_OPERATIONDEPO;
        rBaseSum.BaseObjectID   = GetSpdraftByPayment(pmpaym.PaymentID);

        if( InsertSumList(rBaseSum) )
           MacroError = 1;
           MsgBox("Ошибка при вставке базовой суммы");
        end;

      end;
      stat = Next(pmpaym);
   end;
   return NumCert;
end;

macro CalcServiceSum( sfcontr_addr, BeginDate, EndDate )
   record  rContr( sfcontr );
   file depoacnt(depoacnt) key 1;
   SetBuff( rContr, sfcontr_addr );
   InInterDepo(rContr.Object, BeginDate, EndDate);
   return;
end;
