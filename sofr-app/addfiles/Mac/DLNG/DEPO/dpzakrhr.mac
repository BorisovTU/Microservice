/*====================*\
   ¯¨áì á¥àâ¨ä¨ª â®¢
\*====================*/ 
import DPInter, FIInter, dp_util;

var HeadTable = "ÚÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
                "³ü ³¬¨â¥­â                ³ˆ         ³‘¥à¨ï   ³á ü     ³¯® ü    ³Š-¢® æ/¡³‚ë¤ ­     ³®£ è.    ³®¬¨­ « æ/¡            ³\n"+
                "ÃÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";
                
//var Rep = CMakeReport(HeadTable);
const RepFontStyleTitel =  "ex_FS(b)";


private class FiNominal
  var Nominal = $0;
  var NominalStr = "";
end;


CLASS IK_class(PmPaymRec)
   var cmd;
   var IK;
   private var FaceFIID = TBFile("fininstr");
   var PmPaym = TRecHandler("pmpaym");
   PmPaym = PmPaymRec;

   macro FIID()
     return IK.FIID;
   end;

   macro Issuer()
     return IK.Issuer;
   end;

   macro Number()
     return IK.Number;
   end;

   macro Series()
     return IK.Series;
   end;

   macro IssueDate()
     return date(IK.IssueDate);
   end;

   macro DrawingDate()
     return date(IK.DrawingDate);
   end;

   macro FiName()
     FaceFIID.rec.FIID = IK.FIID;
     if(FaceFIID.GetEQ)
       return FaceFIID.rec.Name;
     else
       MsgBox("¥ ­ ©¤¥­ ä¨­¨­áâàã¬¥­â ¯« â¥¦ ");
       return "";
     end; 
   end;

   macro FaceValueFiCcy()
     var ccy = "";
     
     FaceFIID.rec.FIID = IK.FaceValueFI;
     if(FaceFIID.GetEQ)
       ccy = string(FaceFIID.rec.Ccy);
     end;

     return ccy;
   end;

   macro Nominal()
      var Nominal= FiNominal, FaceValue = 0, FaceValueFI = 0;
      
      if( IK.FaceValueFI != -1 ) /* ®¬¨­ « § ¤ ­ */
         Nominal.Nominal = IK.FaceValue;
         FaceFIID.rec.FIID = IK.FaceValueFI;
         if(FaceFIID.GetEQ)
           if(ˆ­¤¨¢¨¤ã «ì­ë©”¨­ˆ­(IK.FIID))
             Nominal.NominalStr = string(FaceFIID.rec.Ccy)+" (" + FaceFIID.rec.Name + ")";
           else
             Nominal.NominalStr = string(FaceFIID.rec.Ccy);
           end;
         else
           MsgBox("¥ ­ ©¤¥­  ¢ «îâ  ­®¬¨­ « ");
           Nominal.NominalStr = "";
         end;
      end;
      
      return Nominal;
   end;

   macro IssuerINN()
      return ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ (IK.Issuer, PTCK_INN);
   end;

   macro IssuerName()
      return IK.IssuerName;
   end;

   macro IK_Amount()
      return IK.Copies;
   end;

   macro First_IK()
      
      cmd = DL_RSDCommand(  " select vficert.t_FIID, vficert.t_FaceValue, vficert.t_FaceValueFI, vficert.t_Issuer, vficert.t_IssuerName, "
                          + "        vficert.t_Series, vficert.t_Number, vficert.t_IssueDate, vficert.t_Copies, "
                          + "        rsb_deals.GetFicertPlanDrawingDate(vficert.t_FiCertID) as DrawingDate "
                          + "   from dinvlist_dbt il, dinvcard_dbt ic, dv_ficert_dbt vficert"
                          + "  where il.t_PaymentID = ? "
                          + "    and ic.t_InvCardID = il.t_InvCardID "
                          + "    and vficert.t_FiCertID = ic.t_FiCertID "
                         );
      cmd.AddParam(PmPaym.PaymentID);
      
      IK = cmd.Execute();
      if( IK.moveNext() )
         return true;
      end;
      return false;
   end;

   macro Next_IK()
      if(IK.moveNext())
         return true;
      end;
      return false;
   end;
END;

/*
ÚÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
³ü ³¬¨â¥­â                ³ˆ        ³‘¥à¨ï   ³á ü     ³¯® ü    ³Š-¢® æ/¡³‚ë¤ ­     ³®£ è.    ³®¬¨­ « æ/¡            ³
ÃÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
³1 ³€ ®à¨«ìáª¨© ¨ª¥«ì  ³7712345678 ³€€€-••• ³123456  ³123457  ³20      ³01.01.2001³01.01.2002³1000 000 000 000.00 RUR³
ÀÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
*/
macro ¥ç âì¯¨á¨‘¥àâ¨ä¨ª â®¢(PmPaymRec, is_ap)
  var IK = IK_class(PmPaymRec);
  var stat, n = 0;
  if(stat = IK.First_IK())
  println();
[   ¯¨áì á¥àâ¨ä¨ª â®¢ #](IK.FiName);
[ÚÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿];
[³ü ³¬¨â¥­â                ³ˆ         ³‘¥à¨ï   ³á ü     ³¯® ü    ³Š-¢® æ/¡³‚ë¤ ­     ³®£ è.    ³®¬¨­ « æ/¡            ³];
[ÃÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´];
    while(stat)
      n = n + 1;
[³##³#######################³############³########³########³########³########³##########³##########³#######################³]
(n, IK.IssuerName, IK.IssuerINN, IK.Series, trim(IK.Number), trim(IK.Number), 
    setApp(IK.IK_Amount,is_ap), IK.IssueDate:f, IK.DrawingDate:f, setApp(IK.Nominal.Nominal,is_ap)+" "+IK.FaceValueFiCcy());
      stat = IK.Next_IK();
    end;
[ÀÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ];
/*else
[  ¢ ª®«¨ç¥áâ¢¥  #](PmPaymRec.Amount+" èâãª");*/
  end;
end;

macro ¥ç âì¯¨á¨‘¥àâ¨ä¨ª â®¢_Ex(PmPaymRec, is_ap, CertRep)
  var IK = IK_class(PmPaymRec);
  var stat, n = 0;
  var Format;
  if(stat = IK.First_IK())
    CertRep.AddEmptyStr();
    CertRep.AddPrintCell( "   ¯¨áì á¥àâ¨ä¨ª â®¢ " + IK.FiName, 100, 0, "l:" + RepFontStyleTitel, REP_ELEM_STR );
    CertRep.AddStr();
    CertRep.AutoScan( "[\n" + HeadTable + "]" );
    CertRep.AddStr();
    while(stat)
      if(n == 0)
        Format ="ex_B(rlb)";
      else
        Format ="";
      end;
      n = n + 1;
      CertRep.AddPrintCell( n, 2, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( IK.IssuerName, 23, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( IK.IssuerINN, 12, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( IK.Series, 8, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( trim(IK.Number), 8, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( trim(IK.Number), 8, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( setApp(IK.IK_Amount,is_ap), 8, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( IK.IssueDate, 10, 0, "l:f:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( IK.DrawingDate, 10, 0, "l:f:" + Format + RepFontStyleTitel );
      CertRep.AddPrintCell( setApp(IK.Nominal.Nominal,is_ap)+" "+IK.FaceValueFiCcy(), 23, 0, "l:" + Format + RepFontStyleTitel );
      CertRep.AddStr();
      stat = IK.Next_IK();
    end;
  end;
end;

macro strtab( tabs )
  var i=0;
  var str = "";
  while(i<tabs)
    str = str + " ";
    i=i+1;
  end;
  return str;
end;
