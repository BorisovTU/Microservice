/*
$Name:        dpclntreg.mac
$Module:      Ñ•ØÆß®‚†‡®©
$Description: é‚Á•‚ "ê•£®·‚‡ §•ØÆ≠•≠‚Æ¢"
*/

import "dpstdrep.mac", "dpclntreg_form.mac", SfInter;

private const SIDEBALANCE_PASSIVE = 2; /* è†··®¢≠Î• ·Á•‚† Ñ•ØÆ */

private const SPSK_NOTDEFINED = -1;
private const SPSK_OPEN       = 0;
private const SPSK_CLOSE      = 1;
private const SPSK_LOCKED     = 2;
private const SPSK_PLANE      = 3;
private const SPSK_NEW        = 4;

private var ReportHeader = "\n"
                         + "                                                                                       ê•£®·‚‡ §•ØÆ≠•≠‚Æ¢\n"
                         + "####################################################################################################################################################################################################\n"
                         + "                                                                                    Ñ†‚† ·Æß§†≠®Ô #";

private var TableHeaderA = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"
                         + "≥  äÆ§        ≥ ç†®¨•≠Æ¢†≠®• ≥ èÆ´≠Æ• Æ‰®Ê®†´Ï≠Æ•   ≥        çÆ¨•‡        ≥ ë¢•§•≠®Ô Æ §Æ™„¨•≠‚†Â                ≥ éÉêç         ≥ àçç/äèè      ≥     ê„™Æ¢Æ§®‚•´Ï       ≥ å•·‚Æ ¶®‚•´Ï·‚¢†/      ≥    èÆÁ‚Æ¢Î© †§‡•·      ≥ Å†≠™Æ¢·™®•                      ≥\n"
                         + "≥             ≥              ≥ ≠†®¨•≠Æ¢†≠®•         ≥        ·Á•‚†        ≥                                      ≥              ≥              ≥    „ØÆ´≠Æ¨ÆÁ•≠≠Æ£Æ     ≥å•·‚Æ ‡•£®·‚‡†Ê®®       ≥                        ≥ ‡•™¢®ß®‚Î                       ≥\n"
                         + "≥             ≥              ≥                      ≥                     ≥                                      ≥              ≥              ≥       Æ‡£†≠†           ≥                        ≥                        ≥                                 ≥\n"
                         + "√ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var TableHeaderB = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n"
                         + "≥  äÆ§        ≥ ç†®¨•≠Æ¢†≠®• ≥ èÆ´≠Æ• Æ‰®Ê®†´Ï≠Æ•   ≥ çÆ¨•‡  ≥ ê†ß§•´Î    ≥ ë¢•§•≠®Ô Æ §Æ™„¨•≠‚†Â                ≥ éÉêç         ≥ àçç/äèè      ≥     ê„™Æ¢Æ§®‚•´Ï       ≥ å•·‚Æ ¶®‚•´Ï·‚¢†/      ≥    èÆÁ‚Æ¢Î© †§‡•·      ≥ Å†≠™Æ¢·™®•                      ≥\n"
                         + "≥             ≥              ≥ ≠†®¨•≠Æ¢†≠®•         ≥ ·Á•‚†  ≥ ·Á•‚† §•ØÆ ≥                                      ≥              ≥              ≥    „ØÆ´≠Æ¨ÆÁ•≠≠Æ£Æ     ≥å•·‚Æ ‡•£®·‚‡†Ê®®       ≥                        ≥ ‡•™¢®ß®‚Î                       ≥\n"
                         + "≥             ≥              ≥                      ≥        ≥            ≥                                      ≥              ≥              ≥       Æ‡£†≠†           ≥                        ≥                        ≥                                 ≥\n"
                         + "√ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private macro èÆ´„Á®‚Ïà¨Ôë„°Í•™‚†( PartyID )
   var _rParty     = TRecHandler( "party.dbt" );
   var party_name = "";
   if( PartyID >= 0 )
     if( not èÆ´„Á®‚Ïë„°Í•™‚†( PartyID, _rParty ) )
        party_name = _rParty.rec.Name;
     end;
   end;
   return party_name;
END;

private macro CreateBankAccountsStr(Owner:integer, AcntID:integer, RepDate:date)
  var query, cmd, DataSet;
  var AAA = "", BBB = "", CCC = "", EEE = "", TTT = "", III = "";
  var str = "", currstr = "";

  //1. ëèà ≠† §Æ£Æ¢Æ‡•, ™‡Æ¨• ëèà ØÆ ¢ÎØ´†‚†¨
  query =   " select sa.t_Account, sa.t_BankName, sa.t_BankCode, sa.t_FIID as Currency, sa.t_CorrAcc, sa.t_BankCorrName "
          + "   from dsfcontr_dbt contr, dsfssi_dbt ssi, ddepoacnt_dbt acnt, dsettacc_dbt sa "
          + "  where acnt.t_AutoKey = ? "
          + "    and contr.t_ObjectType = " + SF_DEPOACC
          + "    and contr.t_ServKind = " + PTSK_DEPOS
          + "    and contr.t_Object = acnt.t_Code "
          + "    and ssi.t_ObjectType = " + OBJTYPE_SFCONTR
          + "    and ssi.t_ObjectID = LPAD(contr.t_ID, 10, 0) "
          + "    and sa.t_SettAccID = ssi.t_SetAccID ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(AcntID);

  DataSet = cmd.Execute();

  while(DataSet.moveNext())
    //‰Æ‡¨†‚: "ëëë: ëÁÒ‚ " AAA "¢ " BBB

    AAA = DataSet.Account;
    BBB = DataSet.BankName;
    CCC = GetFICode(DataSet.Currency, null, FICK_ISONUMBER);

    str = str + CCC+": ëÁÒ‚ "+AAA+" ¢ "+BBB+IIF(DataSet.t_BankCode != "", " Åàä: "+DataSet.t_BankCode, "")+"\n";

    if(DataSet.CorrAcc != "")
      str = str + "äÆ‡·Á•‚: " + DataSet.CorrAcc + " ¢ " + DataSet.BankCorrName + "\n";
    end;
  end;

  //2. ëèà ØÆ ¢ÎØ´†‚†¨ ≠† §Æ£Æ¢Æ‡•
  query =   " select sa.t_Account, sa.t_BankName, sa.t_BankCode, sa.t_FIID as Currency, sa.t_CorrAcc, sa.t_BankCorrName, "
          + "        ssi.t_Issuer, ssi.t_AvoirKind, ssi.t_FIID as AvrFIID, "
          + "        NVL((select avrk.t_Name from davrkinds_dbt avrk where avrk.t_FI_Kind = "+FIKIND_AVOIRISS+" and avrk.t_AvoirKind = ssi.t_AvoirKind), CHR(1)) as AvrKindName "
          + "   from dsfcontr_dbt contr, ddlssi_dbt ssi, ddepoacnt_dbt acnt, dsettacc_dbt sa "
          + "  where acnt.t_AutoKey = ? "
          + "    and contr.t_ObjectType = " + SF_DEPOACC
          + "    and contr.t_ServKind = " + PTSK_DEPOS
          + "    and contr.t_Object = acnt.t_Code "
          + "    and ssi.t_ConID = contr.t_ID "
          + "    and sa.t_SettAccID = ssi.t_SettAccID ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(AcntID);

  DataSet = cmd.Execute();

  while(DataSet.moveNext())
    //‰Æ‡¨†‚: "CCC: ëÁÒ‚ " AAA "¢ " BBB "(" "ù¨®‚•≠‚: " EEE ®´® "Ç®§ Ê/°: " TTT ®´® "ÇÎØ„·™: " III ")"
    currstr = "";

    AAA = DataSet.Account;
    BBB = DataSet.BankName;
    CCC = GetFICode(DataSet.Currency, null, FICK_ISONUMBER);

    if(DataSet.AvrFIID > 0)
      var cFin = CDPFinInstr(DataSet.AvrFIID, RepDate);

      III = cFin.Name();
      if(cFin.ISIN() != "")
        III = III + " ("+cFin.ISIN()+")";
      elif(cFin.LSIN() != "")
        III = III + " ("+cFin.LSIN()+")";
      end;

      currstr = CCC+": ëÁÒ‚ "+AAA+" ¢ "+BBB+" (ÇÎØ„·™: "+III+")"+IIF(DataSet.t_BankCode != "", " Åàä: "+DataSet.t_BankCode, "")+"\n";
    elif(DataSet.AvoirKind > 0)
      TTT = DataSet.AvrKindName;

      currstr = CCC+": ëÁÒ‚ "+AAA+" ¢ "+BBB+" (Ç®§ Ê/°: "+TTT+")"+IIF(DataSet.t_BankCode != "", " Åàä: "+DataSet.t_BankCode, "")+"\n";
    elif(DataSet.Issuer > 0)
      var cPt = CDPParty(DataSet.Issuer, RepDate);

      EEE = cPt.ShortName();

      currstr = CCC+": ëÁÒ‚ "+AAA+" ¢ "+BBB+" (ù¨®‚•≠‚: "+EEE+")"+IIF(DataSet.t_BankCode != "", " Åàä: "+DataSet.t_BankCode, "")+"\n";
    end;

    if((currstr != "") and (DataSet.CorrAcc != ""))
      currstr = currstr + "äÆ‡·Á•‚: " + DataSet.CorrAcc + " ¢ " + DataSet.BankCorrName + "\n";
    end;

    str = str + currstr;

  end;

  //3. Ö·´® ≠®Á•£Æ ≠• ≠†Ë´®, ‚Æ °•‡•¨ §•≠•¶≠Î• ëèà ≠† ·„°Í•™‚•
  if(str == "")
    query =   " select sa.t_Account, sa.t_BankName, sa.t_BankCode, sa.t_FIID as Currency, sa.t_CorrAcc, sa.t_BankCorrName "
            + "   from dpmautoac_dbt pm, dsettacc_dbt sa "
            + "  where pm.t_PartyID = ? "
            + "    and pm.t_ServiceKind = " + PTSK_DEPOS
            + "    and pm.t_FIKIND = " + FIKIND_CURRENCY
            + "    and sa.t_SettAccID = pm.t_SettAccID ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(Owner);

    DataSet = cmd.Execute();

    while(DataSet.moveNext())
      //‰Æ‡¨†‚: "ëëë: ëÁÒ‚ " AAA "¢ " BBB

      AAA = DataSet.Account;
      BBB = DataSet.BankName;
      CCC = GetFICode(DataSet.Currency, null, FICK_ISONUMBER);

      str = str + CCC+": ëÁÒ‚ "+AAA+" ¢ "+BBB+IIF(DataSet.t_BankCode != "", " Åàä: "+DataSet.t_BankCode, "")+"\n";

      if(DataSet.CorrAcc != "")
        str = str + "äÆ‡·Á•‚: " + DataSet.CorrAcc + " ¢ " + DataSet.BankCorrName + "\n";
      end;
    end;
  end;

  return str;
end;

class (DL_CReportTemplate) DP_CLNTREG_Report()
  private var
    m_ReportDate = ZeroDate,
    m_ClientStatus = 0,
    m_WithPartition = false,
    m_Query = "",
    m_NRecs = 0;

  macro PrintMode():Integer
    return IIF(m_Form.GetFieldValue(PNFLD_DPCLNTREG_TOEXCEL) == SET_CHAR, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD);
  end;

  macro CReport_DataExist()
    return m_NRecs > 0;
  end;

  macro CReport_NoDataMsg()
    MsgBox("ç•‚ §†≠≠ÎÂ §´Ô ‰Æ‡¨®‡Æ¢†≠®Ô Æ‚Á•‚†");
  end;

  private macro BeginReport(NumCopy:Integer)
    var StatusEnum = "", OurBank = TRecHandler("party.dbt");

    m_ReportDate = m_Form.GetFieldValue(PNFLD_DPCLNTREG_REPORTDATE);
    m_ClientStatus = m_Form.GetFieldValue(PNFLD_DPCLNTREG_CLIENTSTATUS);
    m_WithPartition = (m_Form.GetFieldValue(PNFLD_DPCLNTREG_WITHPARTITION) == SET_CHAR);

    Dl_CallInsertStat(PrintMode());

    if(m_ClientStatus == DPCLNTREG_CLIENTSTATUS_SERVED)
      StatusEnum = " " + SPSK_OPEN + ", " + SPSK_LOCKED + ", " + SPSK_NEW + " ";
    elif(m_ClientStatus == DPCLNTREG_CLIENTSTATUS_NOTSERVED)
      StatusEnum = " " + SPSK_CLOSE + " ";
    else
      StatusEnum = " " + SPSK_OPEN + ", " + SPSK_CLOSE + ", " + SPSK_LOCKED + ", " + SPSK_NEW + " ";
    end;

    m_Query = " SELECT "
                + " q.t_AutoKey "
               + " ,q.t_BriefCode ";

    if(m_WithPartition)
      m_Query = m_Query +
                 " ,DECODE(q.t_Status, " + SPSK_CLOSE + ", CHR(0) "
                                  + " ,(SELECT "
                                        + " NVL(LISTAGG(acnt2.t_BriefCode, ', ') WITHIN GROUP (ORDER BY acnt2.t_BriefCode), CHR(0)) "
                                    + " FROM "
                                        + " ddepoacnt_dbt acnt2 "
                                    + " WHERE "
                                        + " acnt2.t_AutoKey IN (SELECT "
                                                                + " acnt3.t_AutoKey "
                                                            + " FROM "
                                                                + " ddepoacnt_dbt acnt3 "
                                                            + " START WITH "
                                                                + " acnt3.t_AutoKey = q.t_AutoKey "
                                                            + " CONNECT BY "
                                                                + " acnt3.t_Root = PRIOR acnt3.t_AutoKey "
                                                            + " AND acnt3.t_Level <> PRIOR acnt3.t_Level) "
                                    + " AND RSB_DEPO.IsTerminalAcntNode(acnt2.t_AutoKey) = 1 "
                                    + " AND acnt2.t_OpenDate <= " + GetSQLDate(m_ReportDate) + " "
                                    + " AND RSB_DEPO.DepoStatus(acnt2.t_AutoKey, " + GetSQLDate(m_ReportDate) + ") = " + SPSK_OPEN + ")) AS t_PartBriefCodeList ";
    end;

    m_Query = m_Query +
                 " ,q.t_Owner "
               + " ,DECODE(q.t_Status, " + SPSK_CLOSE + ", 1, 0) AS t_Closed "
            + " FROM "
                + " (SELECT "
                     + " acnt.t_AutoKey "
                    + " ,acnt.t_BriefCode "
                    + " ,acnt.t_Owner "
                    + " ,RSB_DEPO.DepoStatus(acnt.t_AutoKey, " + GetSQLDate(m_ReportDate) + ") AS t_Status "
                 + " FROM "
                     + " ddepoacnt_dbt acnt "
                 + " WHERE "
                     + " acnt.t_Kind = " + SIDEBALANCE_PASSIVE + " "
                 + " AND acnt.t_AutoKey = acnt.t_Root "
                 + " AND acnt.t_OpenDate <= " + GetSQLDate(m_ReportDate) + " "
                 + " AND acnt.t_Owner NOT IN (SELECT "
                                              + " d.t_PartyID "
                                          + " FROM "
                                              + " ddp_dep_dbt d) "
                 + " AND acnt.t_Department = " + {OperDprt} + ") q "
            + " WHERE "
                + " q.t_Status IN (" + StatusEnum + ") "
            + " AND (q.t_Status <> " + SPSK_CLOSE + " "
              + " OR NOT EXISTS (SELECT "
                                 + " 1 "
                             + " FROM "
                                 + " ddepoacnt_dbt acnt4 "
                             + " WHERE "
                                 + " acnt4.t_Owner = q.t_Owner "
                             + " AND acnt4.t_OpenDate <= " + GetSQLDate(m_ReportDate) + " "
                             + " AND RSB_DEPO.DepoStatus(acnt4.t_AutoKey, " + GetSQLDate(m_ReportDate) + ") <> " + SPSK_CLOSE + ")) "
            + " ORDER BY "
                + " DECODE(q.t_Status, " + SPSK_CLOSE + ", 1, 0) ASC "
               + " ,q.t_Owner ASC "
               + " ,q.t_BriefCode ASC "
               + " ,q.t_AutoKey ASC ";

    m_NRecs = SQL_GetNRecs(m_Query);

    if(CReport_DataExist())
      SetActiveSheet("é‚Á•‚");
      CreateTotalBook();
      UseNewSheetInTotalBook();

      if(èÆ´„Á®‚Ïë„°Í•™‚†({OurBank}, OurBank) != 0)
        MsgBox("ç• „·‚†≠Æ¢´•≠ ≠†Ë °†≠™");
        OurBank.Clear();
      end;

      PrintFormatString(ReportHeader,
                        "N1_H1:c", OurBank.rec.Name,
                        "N1_H2:l", String(m_ReportDate:f));
      CopyAllSheetInTotalBook(null, false, "N1_ReportHeader", 1);
    end;
  end;

  private macro Create(NumCopy:Integer)
    var
      RecCount = 0,
      DataSet = null,
      PrevClosed = -1,
      Owner = null,
      OwnerCode = "",
      OwnerShortName = "",
      OwnerName = "",
      BriefCode = "",
      PartBriefCodeList = "",
      Documents = "",
      OGRN = "",
      INN = "",
      KPP = "",
      Manager = "",
      Adress = "",
      PostAdress = "",
      BankAccounts = "";

    if(CReport_DataExist())
      InitProgress(m_NRecs, "îÆ‡¨®‡Æ¢†≠®• Æ‚Á•‚† \"ê•£®·‚‡ §•ØÆ≠•≠‚Æ¢\"", "ê•£®·‚‡ §•ØÆ≠•≠‚Æ¢");

      DataSet = TRsbDataSet(m_Query);

      while(DataSet.MoveNext())
        if(PrevClosed != DataSet.Closed)
          if(PrevClosed != -1)
            EndTable();
            CopyAllSheetInTotalBook(null, false, GetTableRange(), 1);
          end;

          if(DataSet.Closed == 0)
            PrintFormatString("\n#", "N1_H3", "Ñ•ØÆ≠•≠‚Î ≠† Æ°·´„¶®¢†≠®®");
          else
            PrintFormatString("\n#", "N1_H3", "Ñ•ØÆ≠•≠‚Î, ·≠Ô‚Î• · Æ°·´„¶®¢†≠®Ô");
          end;
          CopyAllSheetInTotalBook(null, false, "N1_H3", 1);

          if((DataSet.Closed == 1) or not m_WithPartition)
            CopyAllSheetInTotalBook(null, false, "N1_TableHeaderA", 1);

            RegisterTable("N1_TableRecordA", TableHeaderA,
                          "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A6", "N1_A7", "N1_A8", "N1_A9", "N1_A10");
          else
            CopyAllSheetInTotalBook(null, false, "N1_TableHeaderB", 1);

            RegisterTable("N1_TableRecordB", TableHeaderB,
                          "N1_B1", "N1_B2", "N1_B3", "N1_B4", "N1_B5", "N1_B6", "N1_B7", "N1_B8", "N1_B9", "N1_B10");
          end;

          PrevClosed = DataSet.Closed;
        end;

        Owner = CDPParty(DataSet.Owner, m_ReportDate);

        OwnerCode = DP_GetArchPartyCode(DataSet.Owner, PTCK_CONTR, m_ReportDate);

        OwnerShortName = Owner.ShortName();

        OwnerName = Owner.Name();

        BriefCode = DataSet.BriefCode;

        PartBriefCodeList = "";
        if((DataSet.Closed == 0) and m_WithPartition)
          PartBriefCodeList = StrSubst(DataSet.PartBriefCodeList, ",", ", ");
        end;

        Documents = "";
        OGRN = "";
        INN = Owner.CodeINN();
        KPP = "";
        if(Owner.LegalForm() == PTLEGF_PERSN)
          Documents = "Ñ†‚† ‡Æ¶§•≠®Ô: " + string(Owner.Born():f);
          if((Owner.PaperKind() >= 0) and (Owner.PaperSeries() != ""))
            Documents = Documents + "\n" + Owner.PaperKindName() + ": " + Owner.PaperSeries() + ", " + Owner.PaperNumber() + ", " + Owner.PaperIssuerName() + ", " + String(Owner.PaperIssuedDate():f);
          end;

          SplitFullINN(INN, INN, KPP);
        else
          if((Owner.PaperKind() >= 0) and (Owner.PaperSeries() != ""))
            Documents = Owner.PaperKindName() + ": " + Owner.PaperSeries() + ", " + Owner.PaperNumber() + ", " + String(Owner.PaperIssuedDate():f);

            var PaperIssuerID = Owner.PaperIssuer();
            if(PaperIssuerID > 0)
              Documents = Documents + ", " + èÆ´„Á®‚ÏäÆ§ë„°Í•™‚†(PaperIssuerID, PTCK_OGRN) + " " + èÆ´„Á®‚Ïà¨Ôë„°Í•™‚†(PaperIssuerID);
            end;
          end;

          OGRN = DP_GetArchPartyCode(DataSet.Owner, PTCK_OGRN, m_ReportDate);
        end;

        Manager = "";
        var FirstPersonID = Owner.GetFirstPersonID();
        if(FirstPersonID > 0)
          var man = CDPParty(FirstPersonID, m_ReportDate);

          Manager = man.Name();
          if((man.PaperKind() >= 0) and (man.PaperSeries() != ""))
            Manager = Manager + "\n" + man.PaperKindName() + ": " + man.PaperSeries() + ", " + man.PaperNumber() + ", " + man.PaperIssuerName() + ", " + String(man.PaperIssuedDate():f);
          end;
        end;

        Adress = DL_GetLegalAddress(DataSet.Owner);
        if(Adress == "")
          Adress = DL_GetRealAddress(DataSet.Owner);
        end;

        PostAdress = Owner.Adress();

        BankAccounts = CreateBankAccountsStr(DataSet.Owner, DataSet.AutoKey, m_ReportDate);

        if((DataSet.Closed == 1) or not m_WithPartition)
          if(PrintMode() == DL_OUTREPORT_EXCEL)
            PrintTableLine("N1_A1",  OwnerCode,      null,
                           "N1_A2",  OwnerShortName, null,
                           "N1_A3",  OwnerName,      null,
                           "N1_A4",  BriefCode,      null,
                           "",       "",             null,
                           "N1_A6",  Documents,      null,
                           "N1_A7",  OGRN,           null,
                           "N1_A8",  INN,            null,
                           "N1_A9",  Manager,        null,
                           "N1_A10", Adress,         null,
                           "N1_A11", PostAdress,     null,
                           "N1_A12", BankAccounts,   null);
          else
            PrintTableLine("N1_A1",  OwnerCode,      null,
                           "N1_A2",  OwnerShortName, null,
                           "N1_A3",  OwnerName,      null,
                           "N1_A4",  BriefCode,      null,
                           "N1_A6",  Documents,      null,
                           "N1_A7",  OGRN,           null,
                           "N1_A8",  INN,            null,
                           "N1_A9",  Manager,        null,
                           "N1_A10", Adress,         null,
                           "N1_A11", PostAdress,     null,
                           "N1_A12", BankAccounts,   null);
          end;
        else
          PrintTableLine("N1_B1",  OwnerCode,         null,
                         "N1_B2",  OwnerShortName,    null,
                         "N1_B3",  OwnerName,         null,
                         "N1_B4",  BriefCode,         null,
                         "N1_B5",  PartBriefCodeList, null,
                         "N1_B6",  Documents,         null,
                         "N1_B7",  OGRN,              null,
                         "N1_B8",  INN,               null,
                         "N1_B9",  Manager,           null,
                         "N1_B10", Adress,            null,
                         "N1_B11", PostAdress,        null,
                         "N1_B12", BankAccounts,      null);
        end;

        UseProgress(RecCount = RecCount + 1);
      end;

      EndTable();
      CopyAllSheetInTotalBook(null, false, GetTableRange(), 0);

      RemProgress();
    end;
  end;

  private macro EndReport(NumCopy:Integer)
    if(CReport_DataExist())
      AddStandardFooter("N1_");
      CopyAllSheetInTotalBook(null, false, "N1_ReportFooter", 1);

      SaveTotalBook();
    end;
  end;

  initDL_CReportTemplate(DP_CLNTREG_Panel(), "dpclntreg.xls", false);
end;

DP_CLNTREG_Report().Run();
Exit(1);
