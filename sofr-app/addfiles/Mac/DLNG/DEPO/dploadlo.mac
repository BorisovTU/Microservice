//Макрос загрузки данных о владельцах ЛОРО счетов для строк реестра СР

import DPInter;

macro GetNextParm(currstr:@variant, delimiter)
  var retstr = "";
  var pos = index(currstr, delimiter);
 
  if(pos)
    retstr = substr(currstr, 1, pos);
    currstr = substr(currstr, pos+1);
  else
    retstr = currstr;
    currstr = "";
  end;

  return retstr;
end;


macro LoadLoroOwn( ReglineID:integer,  //Идентификатор строки реестра
                   IsTemp:bool         //Работа ведется с временным или постоянным файлом
                 )
  
  FILE DataFile() txt;
  record lo("dploroown");
  var datafilename = "";
  var delimiter = "|";
  var currstr = "";
  
  //1. Запросить имя текстового файла с разделителями
  if(SelectFile ( datafilename, ".txt" ))
    //2. Запросить тип разделителя
    if(GetString(delimiter, "Введите используемый разделитель",3))
      if( Open( DataFile, datafilename ) )

        //3.Считываем данные построчно
        while(Next(DataFile))
          
          ClearRecord(lo);
          
          currstr = DataFile(0);

          lo.PartyID            = GetNextParm(@currstr, delimiter);    // ID субъекта (если есть в базе) или -1                                           
          lo.FullName           = GetNextParm(@currstr, delimiter);    // Фамилия владельца цб (для физического лица) / Полное наименование субъекта - владельца цб (для юридиче-ского лица)
          lo.ShortName          = GetNextParm(@currstr, delimiter);    // Имя владельца цб (для физического лица) / Краткое наименование субъекта - владельца цб (для юридиче-ского лица)
          lo.SecondName         = GetNextParm(@currstr, delimiter);    // Отчество владельца цб (для физического лица) / ФИО первого лица (для юридического лица)                                     
          lo.LegalForm          = GetNextParm(@currstr, delimiter);    // Тип владельца (см. namealg №3253)                                         
          lo.Code               = GetNextParm(@currstr, delimiter);    // Код анкеты субъекта                                           
          lo.AccType            = GetNextParm(@currstr, delimiter);    // Тип счета (см. namealg №3254)                                              
          lo.Nationality        = GetNextParm(@currstr, delimiter);    // Гражданство/юрисдикция владельца (двухбуквенный код страны)                                            
          lo.INN                = GetNextParm(@currstr, delimiter);    // ИНН                                                    
          lo.TaxType            = GetNextParm(@currstr, delimiter);    // Налоговая категория                                    
                                                                         
          lo.Amount             = GetNextParm(@currstr, delimiter);    // Количество ценных бумаг у владельца                    
          lo.Charge             = GetNextParm(@currstr, delimiter);    // Текстовое указание на обремененность ценных бумаг обязательствами                          
                                                                          
          lo.PaperKind          = GetNextParm(@currstr, delimiter);    // Вид регистрационного документа (в paprkind.dbt)        
          lo.PaperSeries        = GetNextParm(@currstr, delimiter);    // Серия регистрационного документа                       
          lo.PaperNumber        = GetNextParm(@currstr, delimiter);    // Номер регистрационного документа                       
          lo.PaperIssuedDate    = date(GetNextParm(@currstr, delimiter));    // Дата выдачи регистрационного документа                 
          lo.PaperIssuer        = GetNextParm(@currstr, delimiter);    // Кем выдан регистрационный документ                     
          lo.PaperIssuedPlace   = GetNextParm(@currstr, delimiter);    // Место выдачи регистрационного документа                
          lo.Birthday           = date(GetNextParm(@currstr, delimiter));    // Дата рождения                                          
                                                                                 
          lo.LegalIndex         = GetNextParm(@currstr, delimiter);    // Индекс (Юридический адрес)                             
          lo.LegalAdress        = GetNextParm(@currstr, delimiter);    // Адрес (Юридический адрес)                              
          lo.Country            = GetNextParm(@currstr, delimiter);    // Двухбуквенный код страны на основе латинского алфавита 
          lo.PostIndex          = GetNextParm(@currstr, delimiter);    // Индекс (Почтовый адрес)                                
          lo.PostAdress         = GetNextParm(@currstr, delimiter);    // Адрес (Почтовый адрес)                                 
          lo.Receiver           = GetNextParm(@currstr, delimiter);    // Получат. корр.                                         
          lo.ReceiverCountry    = GetNextParm(@currstr, delimiter);    // Двухбуквенный код страны на основе латинского алфавита 
          lo.PhoneNumber        = GetNextParm(@currstr, delimiter);    // Телефонный номер                                       
          lo.Fax                = GetNextParm(@currstr, delimiter);    // Факс                                                   
          lo.EMail              = GetNextParm(@currstr, delimiter);    // Электронный адрес                                      
                                                                                 
          lo.BankBIC            = GetNextParm(@currstr, delimiter);    // БИК банка                                              
          lo.BankName           = GetNextParm(@currstr, delimiter);    // Наименование банка                                     
          lo.Account            = GetNextParm(@currstr, delimiter);    // Расчетный счет                                         
          lo.ReceiverAccount    = GetNextParm(@currstr, delimiter);    // Лицевой счет получателя                                
          lo.BankPartName       = GetNextParm(@currstr, delimiter);    // Отделение банка                                        
          lo.BankTown           = GetNextParm(@currstr, delimiter);    // Город банка                                            
          lo.CorrAccount        = GetNextParm(@currstr, delimiter);    // Корреспондентский счет  банка                          
          lo.BankAccount        = GetNextParm(@currstr, delimiter);    // Счет банка                                             
          lo.CorrBankName       = GetNextParm(@currstr, delimiter);    // Название банка - корреспондента                        
          lo.KPP                = GetNextParm(@currstr, delimiter);    // КПП банка                                              
                                                                                 
          lo.PaymReceiver       = GetNextParm(@currstr, delimiter);    // ФИО для физического лица, краткое наименование для юридического лица                                 
          lo.INNPaymReceiver    = GetNextParm(@currstr, delimiter);    // Индивидуальный налоговый номер (ИНН) из анкеты субъекта  получатель платежа                                          

          
          DP_AddLoroOwnToRegline(IsTemp, ReglineID, lo);

        end;

      end;
    end;
  end;

  return 0;

end;