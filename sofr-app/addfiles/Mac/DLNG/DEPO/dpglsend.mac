/*
$Name:         dpglsend.mac
$Module:       „¥¯®§¨â à¨©
$Description:  Žâç¥â "“¢¥¤®¬«¥­¨¥ ® ¢ë¯®«­¥­¨¨ £«®¡ «ì­®© ®¯¥à æ¨¨"
*/

import "dpglrep.mac";

private var HeaderStr = " “ ‚ … „ Ž Œ ‹ …  ˆ …   Ž   ‚ ›  Ž ‹  …  ˆ ˆ   ƒ ‹ Ž  € ‹ œ  Ž ‰   Ž  …  € – ˆ ˆ ";
private var HeadreStrReject = "“ ‚ … „ Ž Œ ‹ …  ˆ …   Ž    Ž ’ Š € ‡ …   ‚   ˆ ‘  Ž ‹  …  ˆ ˆ    Ž  “ — …  ˆ Ÿ";

private var DEPOATTR_ATTNUM_BLOCK = 6; // ââà¨¡ãâ áç¥â  ¤¥¯® - ¡«®ª¨à®¢ª 

//§ £®«®¢ª¨ â ¡«¨æ
private var HeadTable =
  "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
  "³  §¤¥« áç¥â  ¤¥¯®                                 ³ Š®«¨ç¥áâ¢® æ¥­­ëå ¡ã¬ £               ³\n" +
  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

private var HeadTableMini =
  "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
  "³  §¤¥« áç¥â  ¤¥¯®                                 ³ Š®«¨ç¥áâ¢® æ¥­­ëå ¡ã¬ £ ³\n" +
  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                         ³\n" +
  "³ Š®¤           ³  ¨¬¥­®¢ ­¨¥  ³ ’¨¯               ³                         ³\n" +
  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

private var HeadTableSum =
  "ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n" +
  "³  §¤¥« áç¥â  ¤¥¯®                                 ³ Ž¯¨á ­¨¥ ¢ë¯ãáª        ³ Š®«¨ç¥áâ¢® æ¥­­ëå ¡ã¬ £ ³\n" +
  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´                        ³                         ³\n" +
  "³ Š®¤           ³  ¨¬¥­®¢ ­¨¥  ³ ’¨¯               ³                        ³                         ³\n" +
  "ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

private var tablewidth = Index(HeadTableSum, "\n");

macro PrintOneDepoAcc( depoacnt, TableHeader )
  var width = 35;
  var DepoPart, query, cmdPart, cmdBlock;
  file acnt("depoacnt");
  var BlockData;
  var PointFIIDfrom = 0, PointFIIDto = 0;
  file fin("fininstr");
  var AllSumHRest = $0, AllSumAmount = $0;
  var Col1 = 0, Col2 = 0, Col3 = 0, Col4 = 0, Col5 = 0, Format;
  var cOwner;

  fin.FIID = GlRepDataSet.FIID;
  if( GetEQ(fin) )
    PointFIIDfrom = fin.SumPrecision;
  end;
  ClearRecord(fin);
  fin.FIID = GlRepDataSet.Currency;
  if( GetEQ(fin) )
    PointFIIDto = fin.SumPrecision;
  end;

  //à §¬¥àë ª®«®­®ª
  if( TableHeader == HeadTable )
    Col1 = 15;
    Col2 = 15;
    Col3 = 19;
    Col4 = 19;
    Col5 = 19;
  elif( TableHeader == HeadTableMini )
    Col1 = 15;
    Col2 = 15;
    Col3 = 19;
    Col4 = 25;
    Col5 = 0;
  elif( TableHeader == HeadTableSum )
    Col1 = 15;
    Col2 = 15;
    Col3 = 19;
    Col4 = 24;
    Col5 = 25;
  end;

  AddStr();
  AddEmptyStr();
  PrintCellSize("‘ç¥â ¤¥¯®", width);
  PrintCellSize(depoacnt.Code + " (ª®à®âª¨© "+ depoacnt.BriefCode+") ", tablewidth - width);

  AddStr();
  PrintCellSize("    ­ ¨¬¥­®¢ ­¨¥", width);
  PrintCellSize(IIF(depoacnt.Name != "", depoacnt.Name, "-" ), tablewidth - width);

  AddStr();
  PrintCellSize("    ¢« ¤¥«¥æ", width);
  PrintCellSize(GetPartyFullName(depoacnt.Owner, date(GlRepDataSet.OprDate)), tablewidth - width);

  AddStr();
  PrintCellSize("        ˆ", width);
  cOwner = CDPParty(depoacnt.Owner, date(GlRepDataSet.OprDate));
  PrintCellSize( cOwner.CodeINN(), tablewidth - width);

  AddStr();
  PrintCellSize("        ª®¤  ­ª¥âë", width);
  PrintCellSize( ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ (depoacnt.Owner, PTCK_CONTR) , tablewidth - width);

  if( GlRepDataSet.ConvForm == CONVFORM_SUMM )
    AddStr();
    AddEmptyStr();
    PrintCellSize("–¥­­ë¥ ¡ã¬ £¨, à ­¥¥ à §¬¥é¥­­ëå ¢ë¯ãáª®¢", tablewidth - width);
  end;

  AddStr();
  GlRep.AutoScan("[\n"+ TableHeader+"]" );
  Format = "ex_B(rlb)";
  if( TableHeader == HeadTable )
    PrintCellTableSize(" Š®¤", Col1, Format);
    PrintCellTableSize("  ¨¬¥­®¢ ­¨¥", Col2, Format);
    PrintCellTableSize(" ’¨¯", Col3, Format);
    PrintCellTableSize(GetFiName( GlRepDataSet.FIID ), Col4, Format);
    PrintCellTableSize(GetFiName( GlRepDataSet.Currency ), Col5, Format);
    Format = "";
  end;

  //¢ë£à¥¡ ¥¬ ¢á¥ à §¤¥«ë «/á, ª®â®àë¥ ¥áâì ¢ à¥¥áâà¥ ¤«ï ãª § ­­®£® áç¥â 
  cmdPart = DL_RSDCommand();

  query =   " select lin.t_HolderPartID, sum(lin.t_HRest) as SumRest, sum(lin.t_BruttoAmount) as SumAmount"
          + " from ddpreglin_dbt lin, daccount_dbt accA "
          + " where lin.t_RegisterID = ? " 
          + "   and lin.t_Type = " + DP_REGLINETYPE_LACCOUNT
          + "   and lin.t_HolderAccID = ? " 
          + "   and accA.t_Account = lin.t_LAccount "
          + "   and accA.t_Chapter = " + 5 // CHAPT5
          + "   and accA.t_Code_Currency = lin.t_FIIDfrom "
          + "   and (accA.t_DepoRoot = ? or accA.t_DepoAcc = ?)";

  cmdPart.AddParam(GlRepDataSet.RegisterID);
  cmdPart.AddParam(depoacnt.AutoKey);
  cmdPart.AddParam(GlRepDataSet.LAccID);
  cmdPart.AddParam(GlRepDataSet.LAccID);

  if(_GlRepRecipientID > 0)

    query = query + " and (   lin.t_HolderID = ? "
                  + "      or Exists(select 1 "
                  + "                  from ddpacap_dbt acap, ddpacapau_dbt acapau "
                  + "                 where acap.t_ApNodeID = lin.t_HolderAccID "
                  + "                   and acap.t_APartyID = ? "
                  + "                   and acap.t_Role = " + DEPOACAPROLE_MORTGAGEE
                  + "                   and acapau.t_APID = acap.t_APID "
                  + "                   and acapau.t_AuNodeID = lin.t_HolderPartID "
                  + "                   and acapau.t_AuthKind = " + OBJTYPE_DEPOAUTHORITY_GETINFO
                  + "               ) "
                  + "     ) ";

    cmdPart.AddParam(_GlRepRecipientID);
    cmdPart.AddParam(_GlRepRecipientID);

  end;

  query = query + " group by lin.t_HolderPartID ";

  DepoPart = cmdPart.Execute(query);
  while( DepoPart.moveNext() )
    ClearRecord(acnt);
    acnt.AutoKey = DepoPart.HolderPartID;
    if(GetEQ(acnt))
      AddStr();
      PrintCellTableSize(acnt.Code, Col1, Format);
      PrintCellTableSize(acnt.Name, Col2, Format);
      //­ ©¤¥¬ ¡«®ª¨à®¢ªã à §¤¥« 
      query =   " select llv.t_Name, llv.t_Element "
              + " from dllvalues_dbt llv, ddepoatvl_dbt atvl "
              + " where atvl.t_ID = ? " 
              + "   and atvl.t_IsType = CHR(0) "
              + "   and atvl.t_AttrNum = " + DEPOATTR_ATTNUM_BLOCK
              + "   and llv.t_List = " + OBJTYPE_KIND_BLOCK_CB
              + "   and llv.t_Element = TO_NUMBER(atvl.t_Value) ";
      
      cmdBlock = DL_RSDCommand(query);
      cmdBlock.AddParam(acnt.AutoKey);

      BlockData = cmdBlock.Execute();
      if(BlockData.moveNext() and (BlockData.Element >= 0) )
        PrintCellTableSize(BlockData.Name, Col3, Format);
      else
        PrintCellTableSize("", Col3, Format);
      end;
      AllSumHRest = AllSumHRest + SQL_ConvTypeSum(DepoPart.SumRest);
      AllSumAmount = AllSumAmount + SQL_ConvTypeSum(DepoPart.SumAmount);
      if( TableHeader != HeadTableSum )
        DP_AddPrintCell( GlRep, SQL_ConvTypeSum(DepoPart.SumRest), Col4, DP_GetPrecision(SQL_ConvTypeSum(DepoPart.SumRest), PointFIIDfrom), "r:" + Format + FontStyleTitel,_is_ap );
      else
        //¤«ï ®¡ê¥¤¨­¥­¨ï ¯¥ç â ¥¬ ®¯¨á ­¨¥ ¢ë¯ãáª 
        PrintCellTableSize(string(  GlRepDataSet.FI_Code + " (" + GlRepDataSet.FIName + "), "
                        + GlRepDataSet.LSIN + IIF( GlRepDataSet.ISIN != "", " ("+GlRepDataSet.ISIN+"), ", "")
                        + GlRepDataSet.AvrName + ", " + GlRepDataSet.Issue ), Col4 , Format);
      end;

      if(Col5 != 0)
        DP_AddPrintCell( GlRep, SQL_ConvTypeSum(DepoPart.SumAmount), Col5, DP_GetPrecision(SQL_ConvTypeSum(DepoPart.SumAmount), PointFIIDto), "r:" + Format + FontStyleTitel,_is_ap );
      end;
      Format = "";
    end;
  end;

  if((AllSumHRest != $0) and (AllSumAmount != $0))
    AddStr();
    if( TableHeader != HeadTableSum )
      PrintCellTableSize("ˆ’ŽƒŽ", Col1 + Col2 + Col3 + 2);
      DP_AddPrintCell(GlRep, AllSumHRest, Col4, DP_GetPrecision(AllSumHRest, PointFIIDfrom), "r:" + Format + FontStyleTitel, _is_ap);
    else
      PrintCellTableSize("ˆ’ŽƒŽ", Col1 + Col2 + Col3 + Col4 + 3);
    end;
    if(Col5 != 0)
      DP_AddPrintCell(GlRep, AllSumAmount, Col5, DP_GetPrecision(AllSumAmount, PointFIIDto), "r:" + Format + FontStyleTitel, _is_ap);
    end;
    Format = "";
  end;
end;

private macro PrintReport( depoacnt )
  var TableHeader = HeadTable;

  PrintSeparateLine(tablewidth);
  PrintRstDate(tablewidth);
  PrintStoragePlace(tablewidth);

  AddStr();
  AddEmptyStr();

  if( GlRepDataSet.Kind_Operation == DP_GLOBOPOPERATION_CONVERT )   //ª®­¢¥àâ æ¨ï

    if( (GlRepDataSet.ConvForm == CONVFORM_CONVERT) or
        (GlRepDataSet.ConvForm == CONVFORM_CUTTING) or
        (GlRepDataSet.ConvForm == CONVFORM_CONSOL) )
      PrintCellSize("–¥­­ë¥ ¡ã¬ £¨, ª®­¢¥àâ¨àã¥¬®£® ¢ë¯ãáª ", tablewidth );
      PrintBaseAvoir(depoacnt.AutoKey, tablewidth);
      AddStr();
      AddEmptyStr();
      PrintCellSize("‚ë¯ãáª, ¢ ª®â®àë© ª®­¢¥àâ¨àãîâáï æ¥­­ë¥ ¡ã¬ £¨", tablewidth);
      PrintCalcAvoir(depoacnt.AutoKey, tablewidth);
    elif( GlRepDataSet.ConvForm == CONVFORM_ANUL )
      PrintCellSize("–¥­­ë¥ ¡ã¬ £¨, à §¬¥é ¥¬®£® ¢ë¯ãáª  ", tablewidth);
      PrintBaseAvoir(depoacnt.AutoKey, tablewidth);
      AddStr();
      AddEmptyStr();
      PrintCellSize("–¥­­ë¥ ¡ã¬ £¨ ¢ë¯ãáª , ¯® ®â­®è¥­¨î ª ª®â®à®¬ã à §¬¥é ¥¬ë© ï¢«ï¥âáï ¤®¯®«­¨â¥«ì­ë¬", tablewidth);
      PrintCalcAvoir(depoacnt.AutoKey, tablewidth);
    elif( GlRepDataSet.ConvForm == CONVFORM_SUMM )
      PrintCellSize("–¥­­ë¥ ¡ã¬ £¨, ®á­®¢­®£® ¢ë¯ãáª ", tablewidth);
      PrintCalcAvoir(depoacnt.AutoKey, tablewidth);
      AddStr();
      AddEmptyStr();
//      PrintCell("–¥­­ë¥ ¡ã¬ £¨, à ­¥¥ à §¬¥é¥­­ëå ¢ë¯ãáª®¢", tablewidth);
      TableHeader = HeadTableSum;
    end;

  elif( GlRepDataSet.Kind_Operation == DP_GLOBOPOPERATION_REPAY )     //¯®£ è¥­¨¥
    PrintCellSize("®£ è ¥¬ë¥ æ¥­­ë¥ ¡ã¬ £¨", tablewidth);
    PrintBaseAvoir(depoacnt.AutoKey, tablewidth);
    TableHeader = HeadTableMini;
  elif( GlRepDataSet.Kind_Operation == DP_GLOBOPOPERATION_BONEMISS )  //¡®­ãá­ ï í¬¨áá¨ï
    PrintCellSize("–¥­­ë¥ ¡ã¬ £¨, ¯® ª®â®àë¬ ­ ç¨á«ïîâáï ¤®å®¤ë", tablewidth);
    PrintBaseAvoir(depoacnt.AutoKey, tablewidth);
    AddStr();
    AddEmptyStr();
    PrintCellSize("–¥­­ë¥ ¡ã¬ £¨ ¢ë¯ãáª , ­ ç¨á«¥­­ë¥ ¢ ª ç¥áâ¢¥ ¤®å®¤ ", tablewidth);
    PrintCalcAvoir(depoacnt.AutoKey, tablewidth);
  end;

  PrintOneDepoAcc( depoacnt, TableHeader );

  PrintSeparateLine(tablewidth);

end;

private macro CreateEmptyRep(GlRep)
  DP_StdHeaderLO_Ex( GlRep, FontStyleTitel, HeaderStr, _LOAuotoKey, 0, false, null, null, tablewidth );
  AddEmptyStr();
  PrintCell( "¥â ¤ ­­ëå, ã¤®¢«¥â¢®àïîé¨å ¯ à ¬¥âà ¬ ®âç¥â ." );
  AddEmptyStr();
  DP_StdFooter_Ex(GlRep, FontStyleTitel, null, null, tablewidth);
  return 1;
end;

private macro GetRepNumDateReglin(RegisterID, HolderAccID, Recipient, RepNum:@variant, RepDate:@variant)
  var query, Select, Data;
  var state = DPREGLINSTATE_CLOSE;

  RepNum = "";
  RepDate = date(0,0,0);

  query = " select nvl(spgr.t_Xld, 0) Xld, nvl(spgr.t_RegistrDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')) RegistrDate " +
          " from ddpreglin_dbt rl, ddpreglinrep_dbt rep, dspground_dbt spgr " +
          " where rl.t_RegisterID = :RegisterID " +
          "   and rl.t_HolderAccID = :HolderAccID " +
          "   and rl.t_Type = " + DP_REGLINETYPE_DEPOACC +
          "   and rep.t_ReglineID(+) = rl.t_ReglineID " +
          "   and rep.t_Recipient(+) = :Recipient "+
          "   and spgr.t_SPgroundID(+) = rep.t_RepSPGroundID ";

  Select = RSDCommand( query );

  Select.AddParam("RegisterID", RSDBP_IN, RegisterID );
  Select.AddParam("HolderAccID", RSDBP_IN, HolderAccID );
  Select.AddParam("Recipient", RSDBP_IN, Recipient );

  Select.NullConversion = true;
  Select.Execute();

  Data = TRsbDataSet(Select);

  if( Data.moveNext() )
    RepNum = string(Data.Xld);
    RepDate = date(Data.RegistrDate);
  end;
end;

private macro CreateRepExt()
  var sQuery = "";
  var count = 0;
  var stat = 0;
  var i = 0;
  var CountRep = 0;
  var PrintSubNum = false;
  var depoacnt, query, acntcount, noterr, j=0;
  var Progress = CProgressBar,
      Progress2 = CProgressBar;
  var RepNum = "", RepDate = date(0,0,0);
  var cmd;

  DP_BeginProtocol();  //­ ç âì ¯à®â®ª®«¨à®¢ ­¨¥ - ¯®¤¬¥­  MsgBox

  if( (_XldBegin != _XldEnd) or (_XldBegin == "") or (_XldEnd == "") )
    PrintSubNum = true;
  end;

  sQuery = CreateRepSQLQuery(true);
  
  GlRepDataSet = TRsbDataSet( sQuery, RSDVAL_CLIENT, RSDVAL_STATIC);
  GlRepDataSet.MoveLast();  //­ã¦­®, çâ®¡ë ®¯à¥¤¥«¨âì à §¬¥à ª¥è 
  count = GlRepDataSet.GetRecCount();//à ¡®â ¥â â®«ìª® á RSDVAL_STATIC!!!
  stat = GlRepDataSet.MoveFirst();
  if( (count > 0) and (stat) )
    Progress.Init( count, "ˆ¤ñâ ä®à¬¨à®¢ ­¨¥ ®âçñâ ...", "“¢¥¤®¬«¥­¨¥ ® ¢ë¯®«­¥­¨¨ £«®¡ «ì­®© ®¯¥à æ¨¨" );

    while( stat )
      i = Progress.Use();

      //¯®§¨æ¨®­¨àã¥¬áï ­  ¨­ä. ¯®àãç¥­¨¨ (¥á«¨ ­ ¤®)
      if( _LOAuotoKey )
        SpLogopr.rec.AutoKey = _LOAuotoKey;
        stat = SpLogopr.GetEQ();
        if( stat )
          GroundAdd.rec.SourceDocKind = 830;
          GroundAdd.rec.SourceDocID = _LOAuotoKey;
          GroundAdd.rec.Direction   = EXITING;
          GroundAdd.rec.Department  = {OperDprt};
          GroundAdd.rec.Division = SelfDivision;
          GroundAdd.GetEQ();
        end;
      end;

      if( stat )
        cmd = DL_RSDCommand();

        query =   " select q.* "
                + "   from (select root.*, lin.t_HolderID as t_Recipient "
                + "           from ddpreglin_dbt lin, ddepoacnt_dbt root "
                + "          where lin.t_RegisterID = ? "
                + "            and lin.t_State != " + DPREGLINSTATE_OPEN
                + "            and lin.t_Type = " + DP_REGLINETYPE_DEPOACC
                + "            and root.t_AutoKey = lin.t_HolderAccID "
                + "            and root.t_AutoKey = lin.t_HolderAccID "
                + "         UNION "
                + "         select root.*, acap.t_APartyID as t_Recipient "
                + "           from ddpreglin_dbt lin, ddpacap_dbt acap, ddepoacnt_dbt root "
                + "          where lin.t_RegisterID = ? "
                + "            and lin.t_State != " + DPREGLINSTATE_OPEN
                + "            and lin.t_Type = " + DP_REGLINETYPE_DEPOACC
                + "            and acap.t_ApNodeID = lin.t_HolderAccID "
                + "            and acap.t_Role = " + DEPOACAPROLE_MORTGAGEE
                + "            and acap.t_FromDate <= ? "
                + "            and (acap.t_ToDate >= ? or acap.t_ToDate = " + GetSQLDate(date(0,0,0)) + ") "
                + "            and Exists(select 1 "
                + "                         from ddpacapau_dbt acapau "
                + "                        where acapau.t_APID = acap.t_APID "
                + "                          and acapau.t_AuthKind = " + OBJTYPE_DEPOAUTHORITY_GETINFO
                + "                      )"
                + "            and root.t_AutoKey = lin.t_HolderAccID "
                + "         ) q"
                + "  where Exists(select 1 "
                + "                 from daccount_dbt accA, ddpreglin_dbt linL "
                + "                where linL.t_RegisterID = ? "
                + "                  and linL.t_HolderAccID = q.t_AutoKey "
                + "                  and linL.t_State != " + DPREGLINSTATE_OPEN
                + "                  and linL.t_Type = " + DP_REGLINETYPE_LACCOUNT
                + "                  and accA.t_Account = linL.t_LAccount "
                + "                  and accA.t_Chapter = " + 5 // CHAPT5
                + "                  and accA.t_Code_Currency = linL.t_FIIDfrom "
                + "                  and (accA.t_DepoRoot = ? or accA.t_DepoAcc = ?) "
                + "               ) ";


        cmd.addParam(GlRepDataSet.RegisterID);

        cmd.addParam(GlRepDataSet.RegisterID);
        cmd.addParam(date(GlRepDataSet.RegistrDate));
        cmd.addParam(date(GlRepDataSet.RegistrDate));

        cmd.addParam(GlRepDataSet.RegisterID);
        cmd.addParam(GlRepDataSet.LAccID);
        cmd.addParam(GlRepDataSet.LAccID);

        if( _iParty > -1 )
          query = query + " and q.t_Recipient = ? ";
          cmd.addParam(_iParty);
        end;

        if( _iDepoAcc )
          query = query + " and q.t_AutoKey = ? ";
          cmd.addParam(_iDepoAcc);
        end;
        
        acntcount = cmd.GetCount(query);
        if(acntcount > 0)
          depoacnt = cmd.Execute(query);

          Progress2.Init( acntcount, "ˆ¤ñâ ä®à¬¨à®¢ ­¨¥ ®âçñâ ...", "“¢¥¤®¬«¥­¨¥ ® ¢ë¯®«­¥­¨¨ £«®¡ «ì­®© ®¯¥à æ¨¨" );

          while( depoacnt.moveNext() )
            j = Progress2.Use();

            AddEmptyStr();

            if(NOT _LOAuotoKey)
              _GlRepRecipientID = depoacnt.Recipient;
              GetRepNumDateReglin(GlRepDataSet.RegisterID, depoacnt.AutoKey, depoacnt.Recipient, @RepNum, @RepDate);
            end;

            DP_StdHeaderLO_Ex( GlRep, FontStyleTitel, IIF( ((GlRepDataSet.OperState) or (GetStateReglinAcc(GlRepDataSet.RegisterID, depoacnt.AutoKey) == DPREGLINSTATE_REJECT) ), HeadreStrReject, HeaderStr), _LOAuotoKey, CountRep = CountRep + 1, PrintSubNum, null, null, tablewidth, RepNum, RepDate );

            PrintRepHeader(tablewidth);
            PrintReport(depoacnt);
            PrintRepFooter(depoacnt.AutoKey, tablewidth);

            DP_StdFooter_Ex(GlRep, FontStyleTitel, NULL, NULL, tablewidth);
            AddEmptyStr();
          end;
          Progress2.Remove();
        end;

        stat = GlRepDataSet.moveNext();
      end;
    end;

    Progress.Remove();
  end;

  if( count==0 or ( CountRep == 0) )
    count = 0;
  end;

  DP_AddProtocol(GlRep, "protocol");  //¤®¡ ¢¨¬ ¯à®â®ª®« ª ã¦¥ áä®à¬¨à®¢ ­­®¬ã ®âç¥âã
  DP_EndProtocol();                    //§ ª®­ç¨âì ¯à®â®ª®«¨à®¢ ­¨¥

  return count;
end;

macro CreateReport(  NumDprt         :integer,  GrDoc           :integer,
                     BeginDate       :date,     EndDate         :date,
                     XldBegin        :string,   XldEnd          :string,
                     OpKind          :integer,  iGlOpForm       :integer,
                     OpStatus        :integer,  OpStatusBegin   :date,
                     OpStatusEnd     :date,     OjdNumBegin     :string,
                     OjdNumEnd       :string,   iStoragePlace   :integer,
                     iStorAcc        :integer,  iIssuer         :integer,
                     iFI             :integer,  iIssuerTo       :integer,
                     iFIIDto         :integer,  iParty          :integer,
                     iDepoAcc        :integer,  LOAuotoKey      :integer,
                     ToExcel         :bool,     is_ap           :bool
)
  var count = 0;

  _NumDprt        =   NumDprt;     _GrDoc          =   GrDoc;
  _BeginDate      =   BeginDate;   _EndDate        =   EndDate;
  _XldBegin       =   XldBegin;    _XldEnd         =   XldEnd;
  _OpKind         =   OpKind;      _iGlOpForm      =   iGlOpForm;
  _OpStatus       =   OpStatus;    _OpStatusBegin  =   OpStatusBegin;
  _OpStatusEnd    =   OpStatusEnd; _OjdNumBegin    =   OjdNumBegin;
  _OjdNumEnd      =   OjdNumEnd;   _iStoragePlace  =   iStoragePlace;
  _iStorAcc       =   iStorAcc;    _iIssuer        =   iIssuer;
  _iFI            =   iFI;         _iIssuerTo      =   iIssuerTo;
  _iFIIDto        =   iFIIDto;     _iParty         =   iParty;
  _iDepoAcc       =   iDepoAcc;    _LOAuotoKey     =   LOAuotoKey;
  _ToExcel        =   ToExcel;     _is_ap          =   is_ap;

  Dl_CallInsertStat( IIF( ToExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );

  GlRep = CMakeReport();

  count = CreateRepExt();

  return DP_StdReportControl( _LOAuotoKey, count, @CreateEmptyRep, 0, ToExcel, GlRep );
end;

macro DP_GlsendByDoc( DocumentID, iDepoAcc/*, _Rep:@variant*/ )
  var ToExcel, err;

/*  if((ValType(_Rep) != V_UNDEF) and (_Rep != null))
     GlRep = _Rep;
  else*/
     GlRep = CMakeReport();
/*  end;*/

  _NumDprt        =   {operdprt};  _GrDoc          =   0;
  _BeginDate      =   date(0,0,0); _EndDate        =   date(0,0,0);
  _XldBegin       =   "";          _XldEnd         =   "";
  _OpKind         =   0;           _iGlOpForm      =   0;
  _OpStatus       =   -1;          _OpStatusBegin  =   date(0,0,0);
  _OpStatusEnd    =   date(0,0,0); _OjdNumBegin    =   "";
  _OjdNumEnd      =   "";          _iStoragePlace  =   -1;
  _iStorAcc       =   0;           _iIssuer        =   -1;
  _iFI            =   -1;          _iIssuerTo      =   -1;
  _iFIIDto        =   -1;          _LOAuotoKey     =   0;
  _ToExcel        =   false;       _is_ap          =   true;

  _iParty  = -1;
  _iDepoAcc = iDepoAcc;
  _DocumentID = DocumentID;
  _GlRepRecipientID = -1;

   var count = CreateRepExt();

/*  _Rep = GlRep;*/
  if(count > 0)
    GetRegistryValue("DEPO\\DEPOREPTOEXCEL", V_BOOL, ToExcel, err);
    if( err != 0 )
      ToExcel = false;
    end;
    if( ToExcel )
      GlRep.PrintWinRep();
      GlRep.ShowWinRep();
    else
      GlRep.PrintRep();
    end;
  end;

end;
