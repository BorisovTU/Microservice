/*
$Name: dpinfexec.mac
$Module: Депозитарий
$Description: макрос шага выпуска отчета об исполнении инвентарной операции
*/

import InsCarryDoc, OprInter, opr_depo, "spinfop.mac", "dpsteprep.mac", "spdobook.mac";
import DPInter, CTInter, /*"swgendoc.mac",*/ "cb_sql.mac";

record Pm_paym( pmpaym );     /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );     /*св-ва платежа*/
record Pm_rmprop( pmprop );   /*св-ва платежа*/

const NumReportInvOper = 28;      /* Отчет об исполнении инвентарной операции */
const SC_SPDRAFT_STATUS_PREP = 1; /* отложенная операция */
const SP_INV_OPERATION = 1;       /* вид отчета - об исполнении инвентарной операции */

const DP_INFREPORT_PREPARE = 300; //отчет об исполнении инв. операции
const DP_INFREPORT_REJECT  = 301; //уведомление об отказе в исполнении

const REFOBJ_ORD_ENTERING_OP = 2; // Номер входящего документа для операций с ц/б
const REFOBJ_INFOPR          = 1; // ObjectType = 105; номер депозитарного отчета (ценные бумаги)


PRIVATE MACRO Generate_RepXid()
  var RefID = 0, RepXid = "";

  if( GetReferenceIDByType( OBJTYPE_DEPOINFOPR, REFOBJ_INFOPR, RefID) )
     MsgBox( "Не найден описатель референса" );
     return "";
  elif( GenerateReference( RefID, RepXid ) )
     MsgBox( "Ошибка при генерации референса по описателю " + string(RefID) );
     return "";
  end;

  return RepXid;
END;


macro ExecuteStep( d, spdr ) 

  return RegAllExtGroundToGrRep(spdr);
end;

/* Макрос печати
*/
MACRO PrintStepDocs(
                        Id_Oper,    /* внутренний идентификатор операции */
                        ID_Step,    /* внутренний идентификатор шага операции */
                        KindDoc,    /* номер вида первичного документа */
                        KindStep)   /* вид шага операции */

    var oproper = TBFile("oproper");
    var spdraft = TBFile("spdraft");

    oproper.rec.ID_Operation = ID_Oper;
    if( not GetEQ(oproper) )
      MsgBox("Не найден экземпляр операции");
      return 0;
    end;

    spdraft.rec.AutoKey = int(oproper.rec.DocumentID);
    if( not GetEQ(spdraft) )
      MsgBox("Не первичный документ <SPDRAFT.DBT>");
      return 0;
    end;

    DraftRepPrintStep(spdraft.rec.AutoKey, spdraft.rec.Kind, NULL, true, false);

    return 1;
END;

/* Макрос постобработки 
*/
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */

    record spdraft("spdraft");
    var RepFileName = "";
    var ScanFileName;
    file ScanFile() txt APPEND;  

    setbuff (spdraft, FirstDoc);
    if (errTrn OR (CommitOrRollback==2)) 
        /* Произошла ошибка или происходит откат */
        return;
    end;

  /*  if(isOprMultiExec() == true) //в массоввом режиме отчет печатается в dpscan.mac
      ScanFileName = GetTxtFileName(DP_SCAN_FILE_NAME);
      RepFileName = setoutput(ScanFileName, true);
      println(spdraft.AutoKey);
      //восстановим вывод
      setoutput(RepFileName, true);
      return;
    end;

    DraftRepPrintStep(spdraft.AutoKey, spdraft.Kind); */

    return 1;

END;

