/*
$Name:         dpcnldrf_io.mac
$Module:       Депозитарий
$Description:  Панель информационной операции "Отмена ранее зарегистрированного поручения"
*/

import "spinfrep.mac", "opr_depo.mac", "dpstdrep.mac", "dpcnldrf.mac";

private var Pan = null;

private class (RsdRecordset) CCnclDrftSet(SPGroundID)
    private var m_Query = "", m_Cmd = null;

    m_Query = " SELECT "
                + " q3.* "
               + " ,DECODE(q3.t_Count, 1, NVL(depoacnt2.t_BriefCode, CHR(1)), CHR(1)) AS t_BriefCode "
               + " ,DECODE(q3.t_Count, 1, NVL(depoacnt2.t_Name, CHR(1)), CHR(1)) AS t_Name "
               + " ,DECODE(q3.t_Count, 1, NVL(depoacnt2.t_OpenDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')), TO_DATE('01.01.0001', 'DD.MM.YYYY')) AS t_OpenDate "
               + " ,DECODE(q3.t_Count, 1, NVL(depoacnt2.t_Owner, " + UnknownParty + "), " + UnknownParty + ") AS t_Owner "
               + " ,DECODE(q3.t_Count, 1, NVL((SELECT "
                                               + " party.t_ShortName "
                                           + " FROM "
                                               + " dparty_dbt party "
                                           + " WHERE "
                                               + " party.t_PartyID = depoacnt2.t_Owner), CHR(1)) "
                                     + " ,CHR(1)) AS t_ShortName "
               + " ,DECODE(q3.t_Count, 1, RSI_RSBPARTY.PT_GetPartyCode(depoacnt2.t_Owner, " + PTCK_CONTR + "), CHR(1)) AS t_OwnerCode "
            + " FROM "
                + " (SELECT "
                     + " q2.* "
                    + " ,DECODE(q2.t_Count, 1, CASE "
                                               + " WHEN q2.t_KindOperation IN (" + KINDOPER_ENROLMENT + ", " + KINDOPER_WRITINGOFF + ", " + KINDOPER_TRANSFER + ") "
                                               + " THEN NVL((SELECT "
                                                             + " depoacnt.t_Root "
                                                         + " FROM "
                                                             + " ddepoacnt_dbt depoacnt "
                                                         + " WHERE "
                                                             + " depoacnt.t_Department(+) = q2.t_Department "
                                                         + " AND depoacnt.t_BriefCode(+) = DECODE(q2.t_KindOperation, " + KINDOPER_ENROLMENT + ", q2.t_ReceiverAccount, q2.t_PayerAccount)), 0) "
                                               + " WHEN q2.t_KindOperation = " + KINDOPER_MOVEMENT + " "
                                               + " THEN DECODE((SELECT "
                                                                + " COUNT(1) "
                                                            + " FROM "
                                                                + " daccsubdc_dbt accsubdc "
                                                            + " WHERE "
                                                                + " (accsubdc.t_DebetCredit(+) = -1 "
                                                              + " OR accsubdc.t_DebetCredit(+) = 0) "
                                                            + " AND accsubdc.t_PaymentID(+) = q2.t_PaymentID), 1, NVL((SELECT "
                                                                                                                       + " account.t_DepoRoot "
                                                                                                                   + " FROM "
                                                                                                                       + " daccount_dbt account "
                                                                                                                      + " ,daccvanl_dbt accvanl "
                                                                                                                      + " ,daccsubdc_dbt accsubdc2 "
                                                                                                                   + " WHERE "
                                                                                                                       + " account.t_Account(+) = accvanl.t_Account "
                                                                                                                   + " AND account.t_Chapter(+) = accvanl.t_Chapter "
                                                                                                                   + " AND account.t_Code_Currency(+) = accvanl.t_FIID "
                                                                                                                   + " AND accvanl.t_AnaliticsId(+) = 2 "
                                                                                                                   + " AND accvanl.t_AccAnaliticsID(+) = accsubdc2.t_AccAnaliticsID "
                                                                                                                   + " AND (accsubdc2.t_DebetCredit(+) = -1 "
                                                                                                                     + " OR accsubdc2.t_DebetCredit(+) = 0) "
                                                                                                                   + " AND accsubdc2.t_PaymentID(+) = q2.t_PaymentID), 0) "
                                                                                                             + " ,0) "
                                               + " ELSE 0 "
                                           + " END "
                                          + " ,0) AS t_AutoKey "
                    + " ,DECODE(q2.t_Count, 1, NVL(q2.t_FIID, " + ALLFININSTR + "), " + ALLFININSTR + ") AS t_FIID2 "
                    + " ,DECODE(q2.t_Count, 1, NVL(fininstr.t_Issuer, " + UnknownParty + "), " + UnknownParty + ") AS t_Issuer "
                    + " ,DECODE(q2.t_Count, 1, RSI_RSBPARTY.PT_GetPartyCode(fininstr.t_Issuer, " + PTCK_CONTR + "), CHR(1)) AS t_IssuerCode "
                    + " ,DECODE(q2.t_Count, 1, NVL(avoiriss.t_LSIN, CHR(1)), CHR(1)) AS t_LSIN "
                    + " ,DECODE(q2.t_Count, 1, NVL(avoiriss.t_ISIN, CHR(1)), CHR(1)) AS t_ISIN "
                    + " ,DECODE(q2.t_Count, 1, NVL(q2.t_Amount, 0), 0) AS t_Amount2 "
                 + " FROM "
                     + " davoiriss_dbt avoiriss "
                    + " ,dfininstr_dbt fininstr "
                    + " ,(SELECT "
                          + " NVL(spground.t_AltXld, CHR(1)) AS t_AltXld "
                         + " ,NVL(spground.t_SignedDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')) AS t_SignedDate "
                         + " ,NVL(spground.t_Xld, CHR(1)) AS t_Xld "
                         + " ,NVL(spground.t_RegistrDate, TO_DATE('01.01.0001', 'DD.MM.YYYY')) AS t_RegistrDate "
                         + " ,spdraft.t_Department "
                         + " ,pmpaym.t_PaymentID "
                         + " ,pmpaym.t_PayerAccount "
                         + " ,pmpaym.t_ReceiverAccount "
                         + " ,pmpaym.t_FIID "
                         + " ,pmpaym.t_Amount "
                         + " ,RSB_DEPO.DefineKindOperation(NVL(pmpaym.t_PayerDpNode, 0), NVL(pmpaym.t_ReceiverDpNode, 0)) AS t_KindOperation "
                         + " ,COUNT(1) OVER () AS t_Count "
                         + " ,ROWNUM AS t_Number "
                      + " FROM "
                          + " dpmpaym_dbt pmpaym "
                         + " ,dspdrmove_dbt spdrmove "
                         + " ,dspdraft_dbt spdraft "
                         + " ,dspground_dbt spground "
                         + " ,(SELECT "
                               + " ? AS t_SPGroundID "
                           + " FROM "
                               + " DUAL) q "
                      + " WHERE "
                          + " pmpaym.t_PaymentID(+) = spdrmove.t_PaymentID "
                      + " AND spdrmove.t_DraftID(+) = spdraft.t_AutoKey "
                      + " AND spdraft.t_SPGroundID(+) = spground.t_SPGroundID "
                      + " AND spground.t_SPGroundID(+) = q.t_SPGroundID) q2 "
                 + " WHERE "
                     + " avoiriss.t_FIID(+) = fininstr.t_FIID "
                 + " AND fininstr.t_FIID(+) = q2.t_FIID) q3 "
               + " ,ddepoacnt_dbt depoacnt2 "
            + " WHERE "
                + " depoacnt2.t_AutoKey(+) = q3.t_AutoKey ";

    m_Cmd = RSDCommand(m_Query);
    m_Cmd.AddParam("", RSDBP_IN, SPGroundID);
    m_Cmd.NullConversion = true;
    m_Cmd.Execute();

    initRsdRecordset(m_Cmd);
end;

macro DP_CreateCnclDrftSet(SPGroundID)
    return CCnclDrftSet(SPGroundID);
end;

private class (DP_UserRep) CCnclDrftPan(_PanelDic, _PanelName)
    private var m_CnclDrftSet = null;

    macro GetPanelFldsArr()
        var panFields = TArray();

        panFields[0] = SP_CODEDEPONENT;
        panFields[1] = SP_DEPO_PART;
        panFields[2] = SP_CODEISSUER;
        panFields[3] = SP_CODESECUR;
        panFields[4] = SP_XLDBEGIN;
        panFields[5] = SP_ISINSECUR;
        panFields[6] = SP_BEGINDATE;
        panFields[7] = SP_AMOUNTSECUR;
        panFields[8] = SP_XLDEND;
        panFields[9] = SP_ENDDATE;
        panFields[10] = SP_IS_APP;

        return panFields;
    end;

    macro ProcessNumFields(PanField, key)
        var field = PanFieldNums[PanField];
        var query = "", rs = null;

        if(field == SP_XLDEND)
            if(key == KEY_F3)
                query = " SELECT "
                          + " spground.t_SPGroundID "
                         + " ,(SELECT "
                               + " llvalues.t_Name "
                           + " FROM "
                               + " dllvalues_dbt llvalues "
                           + " WHERE "
                               + " llvalues.t_list = " + OBJTYPE_KINDDOC + " "
                           + " AND llvalues.t_element = spground.t_Kind) AS t_KindName "
                          + " ,spground.t_AltXld "
                          + " ,spground.t_SignedDate "
                          + " ,spground.t_Xld "
                          + " ,spground.t_RegistrDate "
                       + " FROM "
                           + " dspdraft_dbt spdraft "
                          + " ,dspground_dbt spground "
                       + " WHERE "
                           + " spdraft.t_SPGroundID = spground.t_SPGroundID "
                       + " ORDER BY "
                           + " spground.t_Department "
                          + " ,spground.t_DocLog "
                          + " ,spground.t_Direction "
                          + " ,spground.t_RegistrDate "
                          + " ,spground.t_SpgroundID ";

                rs = DL_Scroll(query, "Список документов", 1, 4, "t_KindName", "Вид",
                                                                 "t_AltXld", "Номер",
                                                                 "t_SignedDate", "Дата составления",
                                                                 "t_Xld", "Входящий номер",
                                                                 "t_RegistrDate", "Дата приема",
                                                                 "t_SpgroundID", "ID");

                if(rs != null)
                    IOInfopr.Desc = rs.Value("t_SPGroundID");

                    m_CnclDrftSet = CCnclDrftSet(IOInfopr.Desc);
                    m_CnclDrftSet.MoveNext();

                    SetFldParm(SP_CODEDEPONENT, m_CnclDrftSet.Value("t_Owner"));
                    SetFldData(SP_CODEDEPONENT, m_CnclDrftSet.Value("t_OwnerCode"));
                    SetFldParm(SP_DEPO_PART, m_CnclDrftSet.Value("t_AutoKey"));
                    SetFldData(SP_DEPO_PART, m_CnclDrftSet.Value("t_BriefCode"));
                    SetFldParm(SP_CODEISSUER, m_CnclDrftSet.Value("t_Issuer"));
                    SetFldData(SP_CODEISSUER, m_CnclDrftSet.Value("t_IssuerCode"));
                    SetFldParm(SP_CODESECUR, m_CnclDrftSet.Value("t_FIID2"));
                    SetFldData(SP_CODESECUR, m_CnclDrftSet.Value("t_LSIN"));
                    SetFldParm(SP_XLDBEGIN, m_CnclDrftSet.Value("t_AltXld"));
                    SetFldParm(SP_ISINSECUR, m_CnclDrftSet.Value("t_FIID2"));
                    SetFldData(SP_ISINSECUR, m_CnclDrftSet.Value("t_ISIN"));
                    SetFldParm(SP_BEGINDATE, m_CnclDrftSet.Value("t_SignedDate"));
                    SetFldParm(SP_AMOUNTSECUR, m_CnclDrftSet.Value("t_Amount2"));
                    SetFldParm(SP_XLDEND, m_CnclDrftSet.Value("t_Xld"));
                    SetFldParm(SP_ENDDATE, m_CnclDrftSet.Value("t_RegistrDate"));
                end;

                key = 0;
            elif(key == KEY_SPACE)
                key = 0;
            end;
        end;

        if(key != 0)
            key = ProcessNumFields(PanField, key);
        end;

        return key;
    end;

    macro ExecRep()
        var err = 0;
        var rep = null;

        err = ClntDrftExecRep(IOLogopr.AutoKey,
                              m_CnclDrftSet.Value("t_BriefCode"),
                              m_CnclDrftSet.Value("t_Name"),
                              Date(m_CnclDrftSet.Value("t_OpenDate")),
                              m_CnclDrftSet.Value("t_ShortName"),
                              m_CnclDrftSet.Value("t_OwnerCode"),
                              GetFldParm(SP_IS_APP) == SET_CHAR);

        if(err == 0)
            rep = CMakeReport();

            if(DP_PrintAllLogoprExtRep(@rep, IOLogopr.AutoKey, false) != 0)
                rep.PrintWinRep();
                rep.ShowWinRep();
            end;
        end;

        return err;
    end;

    macro PushDataToPanel(key, PanField, fromIO)
        var field = PanFieldNums[PanField];

        if(field == SP_CODEDEPONENT)
            SetFldParm(SP_CODEDEPONENT, m_CnclDrftSet.Value("t_Owner"));
            SetFldData(SP_CODEDEPONENT, m_CnclDrftSet.Value("t_OwnerCode"));

            key = 0;
        elif(field == SP_DEPO_PART)
            SetFldParm(SP_DEPO_PART, m_CnclDrftSet.Value("t_AutoKey"));
            SetFldData(SP_DEPO_PART, m_CnclDrftSet.Value("t_BriefCode"));

            key = 0;
        elif(field == SP_CODEISSUER)
            SetFldParm(SP_CODEISSUER, m_CnclDrftSet.Value("t_Issuer"));
            SetFldData(SP_CODEISSUER, m_CnclDrftSet.Value("t_IssuerCode"));

            key = 0;
        elif(field == SP_CODESECUR)
            SetFldParm(SP_CODESECUR, m_CnclDrftSet.Value("t_FIID2"));
            SetFldData(SP_CODESECUR, m_CnclDrftSet.Value("t_LSIN"));

            key = 0;
        elif(field == SP_XLDBEGIN)
            SetFldParm(SP_XLDBEGIN, m_CnclDrftSet.Value("t_AltXld"));

            key = 0;
        elif(field == SP_ISINSECUR)
            SetFldParm(SP_ISINSECUR, m_CnclDrftSet.Value("t_FIID2"));
            SetFldData(SP_ISINSECUR, m_CnclDrftSet.Value("t_ISIN"));

            key = 0;
        elif(field == SP_BEGINDATE)
            SetFldParm(SP_BEGINDATE, m_CnclDrftSet.Value("t_SignedDate"));

            key = 0;
        elif(field == SP_AMOUNTSECUR)
            SetFldParm(SP_AMOUNTSECUR, m_CnclDrftSet.Value("t_Amount2"));

            key = 0;
        elif(field == SP_XLDEND)
            SetFldParm(SP_XLDEND, m_CnclDrftSet.Value("t_Xld"));

            key = 0;
        elif(field == SP_ENDDATE)
            SetFldParm(SP_ENDDATE, m_CnclDrftSet.Value("t_RegistrDate"));

            key = 0;
        end;

        return key;
    end;

    macro PopDataFromPanel(key, PanField, fromIO)
        var field = PanFieldNums[PanField];

        if(field == SP_CODEDEPONENT)
            IOInfopr.PartyID = m_CnclDrftSet.Value("t_Owner");

            key = 0;
        elif(field == SP_DEPO_PART)
            IOInfopr.DepoPart = m_CnclDrftSet.Value("t_AutoKey");

            key = 0;
        elif(field == SP_CODEISSUER)
            IOInfopr.Issuer = m_CnclDrftSet.Value("t_Issuer");

            key = 0;
        elif(field == SP_CODESECUR)
            IOInfopr.FIID = m_CnclDrftSet.Value("t_FIID2");

            key = 0;
        elif(field == SP_XLDBEGIN)
            IOInfopr.fromXid = m_CnclDrftSet.Value("t_AltXld");

            key = 0;
        elif(field == SP_ISINSECUR)
            IOInfopr.FIID = m_CnclDrftSet.Value("t_FIID2");

            key = 0;
        elif(field == SP_BEGINDATE)
            IOInfopr.fromDate = m_CnclDrftSet.Value("t_SignedDate");

            key = 0;
        elif(field == SP_XLDEND)
            IOInfopr.toXid = m_CnclDrftSet.Value("t_Xld");

            key = 0;
        elif(field == SP_ENDDATE)
            IOInfopr.toDate = m_CnclDrftSet.Value("t_RegistrDate");

            key = 0;
        end;

        DisableField(SP_CODEDEPONENT);

        return key;
    end;

    macro Check()
        var err = 0;

        if(IOInfopr.Desc == 0)
            err = 1;
            MsgBox("Не задано значение поля \"Вход.рег.№\"");
        end;

        return err;
    end;

    initDP_UserRep(_PanelDic, _PanelName);
    m_CnclDrftSet = CCnclDrftSet(IOInfopr.Desc);
    m_CnclDrftSet.MoveNext();
end;

macro ExecRepPan(mode, field, key, fromIO)
    var err = 0;

    if(Pan == null)
        Pan = CCnclDrftPan("dp_res.lbr", "DPCNLDRF");
    end;

    err = Pan.Run(mode, field, key, fromIO);

    return err;
end;
