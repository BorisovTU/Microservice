/*
$Name: dpmemord.mac
$Module: Депозитарий
$Description: Мемориальный ордер по л/с депо
*/
import "dpsteprep.mac";

record Pm_paym( pmpaym );    /*основной платеж*/
record Pm_prop_deb( pmprop ); /*св-ва платежа банка-плательщика*/
record Pm_prop( pmprop );    /*св-ва платежа*/
record Pm_rmprop( pmprop );   /*св-ва платежа*/

macro PrintStepDocs( ID_Oper,    /* внутренний идентификатор операции        */
                     ID_Step,    /* внутренний идентификатор шага операции   */
                     KindDoc,    /* номер вида первичного документа          */
                     KindStep )  /* вид шага операции                        */

   var oproper = TBFile("oproper");
   var spdraft = TBFile("spdraft");

   oproper.rec.ID_Operation = ID_Oper;
   if( not GetEQ(oproper) )
      MsgBox("Не найден экземпляр операции");
      return 0;
   end;

   spdraft.rec.AutoKey = int(oproper.rec.DocumentID);
   if( not GetEQ(spdraft) )
      MsgBox("Не первичный документ <SPDRAFT.DBT>");
      return 0;
   end;

   var ThisRep = NULL;
   var isPrint = false;
   var ToExcel = false;
   var err = 0;

   DepoMemOrder(spdraft.rec, @ThisRep, false);
   DraftRepPrintStep(spdraft.rec.AutoKey, spdraft.rec.Kind, @ThisRep, false);
   
   GetRegistryValue("DEPO\\DEPOREPTOEXCEL", V_BOOL, ToExcel, err);
   
   if( ToExcel )
     ThisRep.PrintWinRep();
     ThisRep.ShowWinRep();
   else
     var RepFileName = GetTxtFileName("dpinfexec");
     ThisRep.SetFileNameTxt(RepFileName);
     ThisRep.PrintRep();
     ViewFile(RepFileName);
   end;


   return 1;
end;

macro PostStep( message,     /* данный параметр может принимать следующие       */
                             /* значения: 1 - выполнение шага; 2 - откат шага;  */
                errTrn,      /* статус выполнения шага. Если параметр не равен 0*/
                             /* произошла ошибка                                */
                FirstDoc,    /* указатель на первичный документ                 */
                ID_Oper,     /* внутренний идентификатор операции               */
                ID_Step,     /* внутренний идентификатор шага операции          */
                KindOper,    /* номер вида операции                             */
                KindDoc,     /* номер вида первичного документа                 */
                KindStep )   /* вид шага операции                               */

   record spdraft("spdraft");
   setbuff (spdraft, FirstDoc);

   if (errTrn OR (message==2)) 
       /* Произошла ошибка или происходит откат */
       return;
   end;

   if(isOprMultiExec() == true) //в массоввом режиме отчет печатается в dpscan.mac
     return;
   end;

   //DepoMemOrder(spdraft);
   
   return 1;
end;



