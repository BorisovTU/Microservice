/*
$Name: dpacapmas.mac
$Module: Депозитарий
$Description: Массовое назначение уполномоченных лиц
*/

Import rsd;
import DPInter, "secinter.mac", "dpstdrep.mac", "fi.mac", "ws_validation.mac", "spserv.mac";
import RsbDataSet;
import FIInter, CurrInter, CTInter, secinter, deposerv;


var HeadTable = "┌─────────────────────────┬─────────────────┬─────────────────┬─────────────────┬───────────────┬─────────────────────────┬────────────────────────┐\n"+
                "│     Номер счёта депо    │  Наименование   │  Наименование   │   Код анкеты    │ Дата открытия │       Номер раздела     │ Дата открытия раздела  │\n"+
                "│                         │  счета депо     │   Депонента     │    депонента    │     счета     │        счета депо       │     счета депо         │\n"+
                "├─────────────────────────┼─────────────────┼─────────────────┼─────────────────┼───────────────┼─────────────────────────┼────────────────────────┤";

var tablewidth = Index(HeadTable, "\n");
var Rep = CMakeReport(HeadTable);
var RepHead = CMakeReport("заголовок                                                    ");
var   HeaderStr = "Протокол процедуры закрытия счетов депо в административном порядке";
const RepFontStyleTitel =  "ex_FS(b)";
var  _is_ap;
var HeadDate = "за <"+{Curdate}+">";
DP_StdHeaderLO_Ex( RepHead, RepFontStyleTitel, HeaderStr, 0, 0, false, null, null, tablewidth );
DP_AddPrintCell( RepHead, headDate, 140, 0, "r:" + RepFontStyleTitel,_is_ap, REP_ELEM_STR );
   RepHead.AddStr();

var HeadTable1 = "┌─────────────────────────┬─────────────────┬─────────────────┬─────────────────┬───────────────────────┬──────────────────────────────────────────┐\n"+
                 "│     Номер счёта депо    │  Наименование   │  Наименование   │   Код анкеты    │      Номер раздела    │                Причина                   │\n"+
                 "│                         │  счета депо     │   Депонента     │    депонента    │       счета депо      │                                          │\n"+
                 "├─────────────────────────┼─────────────────┼─────────────────┼─────────────────┼───────────────────────┼──────────────────────────────────────────┤";

var tablewidth1 = Index(HeadTable1, "\n");
var Rep1 = CMakeReport(HeadTable1);
const RepFontStyleTitel1 =  "ex_FS(b)";

VAR CountErr = 0, CountMes = 0;

macro PrintStr(CodeDA, NameDA, NameDep, CodeDep,
               OpenDateDA, CodeDP, OpenDateDP)

   DP_AddPrintCell( Rep, CodeDA, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, NameDA, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, NameDep, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, CodeDep, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, OpenDateDA, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, CodeDP, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, OpenDateDP, 0, 0, "r:w" + RepFontStyleTitel );
   Rep.AddStr();
end;
	
macro PrintStr1(CodeDA1, NameDA1, NameDep1, CodeDep1,
               CodeDP1, Mes)

   DP_AddPrintCell( Rep1, CodeDA1, 0, 0, "l:w" + RepFontStyleTitel1 );
   DP_AddPrintCell( Rep1, NameDA1, 0, 0, "l:w" + RepFontStyleTitel1 );
   DP_AddPrintCell( Rep1, NameDep1, 0, 0, "l:w" + RepFontStyleTitel1 );
   DP_AddPrintCell( Rep1, CodeDep1, 0, 0, "l:w" + RepFontStyleTitel1 );
   DP_AddPrintCell( Rep1, CodeDP1, 0, 0, "l:w" + RepFontStyleTitel1 );
   DP_AddPrintCell( Rep1, Mes, 0, 0, "l:w" + RepFontStyleTitel1 );
   Rep1.AddStr();
end;

//  private var m_query = "";
//  private var m_DataSet = null;
  private const IMPLODE_SYMBOL = "|";
  private var m_currstr = "";

private  macro GetNextFld(m_currstr:@string)
    var Ind = "";
    var pos = Index ( m_currstr, IMPLODE_SYMBOL );

    if( pos )
      Ind = substr(m_currstr, 1, pos-1 );
      m_currstr = substr(m_currstr, pos+1);
    else
      Ind = m_currstr;
    end;
    return Ind;
end;

	
MACRO  PrintRepAcap()

  var count;
  var query, Select, DataSet;
  var mess = "";
  var stat = 0;
  var OpClose = TArray;   //массив открытых/закрытых разделов счета депо
  var Ind, ID, IDD;
  var dpacc = TRecHandler("depoacnt");
  
  query = " SELECT * "
        + " FROM DDEPOREPLOG_TMP "
        + " ORDER BY T_FORMATSTRING DESC, T_AUTOKEY ASC "             
        ;
  
  count = SQL_GetNRecs(query);
  
  Dl_CallInsertStat( DL_OUTREPORT_STD  );
  
  if( count > 0 )
    DataSet = TRsbDataSet(query);
    while( DataSet.moveNext() )
      m_currstr = DataSet.FormatString;
      Ind = GetNextFld(@m_currstr);
      ID = int(GetNextFld(@m_currstr));
      if(Ind == "E")
        IDD = int(GetNextFld(@m_currstr));
      end;
      var m_query, m_Select, m_DataSet;
      if((Ind == "S") or ((Ind == "E") and (IDD == 0)))	
        m_query = " SELECT ACNT.*, ac.t_code as cod ,ac.t_OpenDate as dat "
                + " FROM DDEPOACNT_DBT ACNT , ddepoacnt_dbt ac "
                + " where ac.t_autokey = acnt.t_root "
                + " and ACNT.T_STATUS != 1 "
                + " START WITH ACNT.T_AUTOKEY IN "
                + " (SELECT DISTINCT TMP.T_DEPOACNTID "
                + " FROM DDEPOACNT_TMP TMP, DDPACAPAU_TMP AU "
                + " WHERE TMP.T_ROOT = " + ID
                + " AND TMP.T_DEPOACNTID = AU.T_AUNODEID) "
                + " CONNECT BY PRIOR ACNT.T_AUTOKEY = ACNT.T_SUPERIOR " ;
      else
        m_query = " SELECT ACNT.*, ac.t_code as cod ,ac.t_OpenDate as dat "
                + " FROM DDEPOACNT_DBT ACNT , ddepoacnt_dbt ac "
                + " where ac.t_autokey = acnt.t_root "
                + " START WITH ACNT.T_AUTOKEY =  " + IDD
                + " CONNECT BY PRIOR ACNT.T_AUTOKEY = ACNT.T_SUPERIOR " ;

      end;

      m_DataSet = TRsbDataSet(m_query);
      while(m_DataSet.moveNext())
        var  CodeDA = "", NameDA = "", NameDep = "", CodeDep = "" , OpenDateDA = "" , CodeDP = "", OpenDateDP = ""  , Mes = "";
        CodeDA = m_DataSet.Cod;
        NameDA = m_DataSet.Name;
        CodeDep = ПолучитьКодСубъекта(m_DataSet.Owner,1);
        NameDep = ПолучитьКороткоеИмяСубъекта( m_DataSet.Owner);
        OpenDateDA = date(m_DataSet.dat);

        if(not(m_DataSet.Autokey==m_DataSet.Root))
          CodeDP = m_DataSet.Code;
          OpenDateDP = date(m_DataSet.OpenDate);	
        end;
        if(Ind == "E")
          mess = m_currstr;
          PrintStr1(CodeDA, NameDA, NameDep, CodeDep, CodeDP, mess);
          CountErr = CountErr +1;
        else
          PrintStr(CodeDA, NameDA, NameDep, CodeDep, OpenDateDA, CodeDP, OpenDateDP);
          CountMes = CountMes +1;
        end;
      end;
    end;
  end;

    //печать протокола
    if((CountMes+CountErr))
        RepHead.PrintRep();

      if(CountMes)
         [Перечень счетов и разделов счета депо, по которым назначен оператор-брокер:];
        if( CountErr == 0)
          DP_StdFooter_Ex(Rep, RepFontStyleTitel, NULL, NULL, tablewidth);               // стандартный подвал отчета, добавляем если нет таблицы с ошибками
        end;
        Rep.PrintRep();
      else
       [По счетам депо/разделам счета депо оператор-брокер не назначен];
      end;
  
      if(CountErr)
        [Перечень счетов/разделов счета депо, по которым оператор-брокер не назначен:];
        DP_StdFooter_Ex(Rep1, RepFontStyleTitel1, NULL, NULL, tablewidth1);              // добавляем стандартный подвал отчета
        Rep1.PrintRep();
      end;

    else    //если нет никаких таблиц

      DP_AddPrintCell( RepHead, "По счетам депо/разделам счета депо оператор-брокер не назначен", 100, 0, "r:" /*+ RepFontStyleTitel*/,_is_ap, REP_ELEM_STR );
      RepHead.AddStr();
      DP_StdFooter_Ex(RepHead, RepFontStyleTitel, NULL, NULL, tablewidth);               
      RepHead.PrintRep();

    end;
  

 
END;

