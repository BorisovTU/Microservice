/*
$Name: dpunconclmas.mac
$Module: Депозитарий
$Description: Закрытие счетов депо с уведомлением
*/

Import rsd;
import DPInter, "secinter.mac", "dpstdrep.mac", "fi.mac", "ws_validation.mac", "spserv.mac";
import RsbDataSet;

private const CHAPT5 = 5; //глава л/с депо
var HeadTable = "┌────────────────────┬─────────────────┬─────────────────┬────────────────────────┬─────────────────┬─────────────────┬─────────────────┬───────────────┬─────────────────────────┬────────────────────────┐\n"+
                "│       Номер        │  Наименование   │ Дата заключения │    Номер счёта депо    │  Наименование   │  Наименование   │   Код анкеты    │ Дата открытия │       Номер раздела     │ Дата открытия раздела  │\n"+
                "│  Дерозитарного     │  Депозитарного  │  Депозитарного  │                        │  счета депо     │   Депонента     │    депонента    │     счета     │        счета депо       │     счета депо         │\n"+
                "│     договора       │    договора     │    договора     │                        │                 │                 │                 │               │                         │                        │\n"+
                "├────────────────────┼─────────────────┼─────────────────┼────────────────────────┼─────────────────┼─────────────────┼─────────────────┼───────────────┼─────────────────────────┼────────────────────────┤";

var tablewidth = Index(HeadTable, "\n");
var Rep = CMakeReport(HeadTable);
var RepHead = CMakeReport("                                                      ");
var N = 0, err;
GetRegistryValue("DEPO\\DAYS_FROM_NOTICE", V_INTEGER, N, err);
  if( err != 0 )
    msgbox("Ошибка поиска значения настройки \"Уведомление Депонентов о закрытии счетов депо с остатками\"");
    return;
  end;
var   HeaderStr = "Перечень пассивных счетов депо, подлежащих закрытию через " + N +" дней в связи с направлением Депонентам уведомления о расторжении Депозитарного договора в одностороннем порядке";
const RepFontStyleTitel =  "ex_FS(b)";
var  _is_ap;
var HeadDate = "за <"+ date_as_string(1,{Curdate},false) +">";
DP_StdHeaderLO_Ex( RepHead, RepFontStyleTitel, HeaderStr, 70, 0, false, null, null, tablewidth );
DP_AddPrintCell( RepHead, headDate, 200, 0, "r:" + RepFontStyleTitel,_is_ap, REP_ELEM_STR );
   RepHead.AddStr();

VAR CountMes = 0;

var  ContrNum = "",
     ContrName = "",
     ContrDate,
     CodeDA = "",
     NameDA = "",
     NameDep = "",
     CodeDep = "" ,
     OpenDateDA ,
     CodeDP = "",
     OpenDateDP,
     Mes = "";

macro PrintStr(CodeDA, NameDA, NameDep, CodeDep,
               OpenDateDA, CodeDP, OpenDateDP)

   DP_AddPrintCell( Rep, ContrNum, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, ContrName, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, ContrDate, 0, 0, "l:w" + RepFontStyleTitel );

   DP_AddPrintCell( Rep, CodeDA, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, NameDA, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, NameDep, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, CodeDep, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, OpenDateDA, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, CodeDP, 0, 0, "l:w" + RepFontStyleTitel );
   DP_AddPrintCell( Rep, OpenDateDP, 0, 0, "r:w" + RepFontStyleTitel );
   Rep.AddStr();
end;
	
// вывод в протокол инф. о закрытых счета/ разделах депо
PRIVATE MACRO PrintRepRoot(autokey,OpClose)
  var query, Select, DataSet;
  var i = 0;
  query = " SELECT acnt.* "
        + " FROM ddepoacnt_dbt acnt"
        + " START WITH t_autokey = ? " 
        + " CONNECT BY PRIOR t_autokey = t_superior " 
        + " ORDER BY acnt.t_autokey ";

  Select = RSDCommand( query );

  Select.AddParam("Autokey",  RSDBP_IN, autokey  );  /*0*/
  Select.Execute();

  DataSet = TRsbDataSet(Select);
  while(DataSet.moveNext())
    if(not(DataSet.Autokey==DataSet.Root))
      CodeDP = DataSet.Code;
      OpenDateDP = date_as_string(1,DataSet.OpenDate,false);	
    else
      CodeDP = "";
      OpenDateDP = "";	
    end;
    if( not (OpClose[i]==1))                 // не равен закрытому
      PrintStr(CodeDA, NameDA, NameDep, CodeDep, OpenDateDA, CodeDP, OpenDateDP);
    end;
    i = i+1;
  end;
END;


// заполнение массива 
PRIVATE MACRO FillOpClose( autokey,OpClose:@TArray)
  var query, Select, DataSet;
  var i = 0;
  query = " SELECT acnt.* "
        + " FROM ddepoacnt_dbt acnt"
        + " START WITH t_autokey = ? " 
        + " CONNECT BY PRIOR t_autokey = t_superior " 
        + " ORDER BY acnt.t_autokey ";
  Select = RSDCommand( query );

  Select.AddParam("Autokey",  RSDBP_IN, autokey  );  /*0*/
  Select.Execute();

  DataSet = TRsbDataSet(Select);
  while(DataSet.moveNext())
    OpClose[i] = DataSet.Status;
    i = i+1;
  end;
END;

MACRO PrintRep()
  var query1, query2, query3, DataSet, DataSet1;
  var CntPrep = 0, CntOpen = 0;
  var mesState = "", mesOpKind = "", mess = "";
  var OpClose = TArray;   //массив открытых/закрытых разделов счета депо
  var Type = 0;

  query1 = " select * from ddepoacnt_dbt dbt"
         + " where dbt.t_Autokey in (Select tmp.t_root from ddepoacnt_tmp tmp )"
         + " and dbt.t_noticedate <> TO_DATE('01.01.0001', 'DD.MM.YYYY') "
         + " AND ROWNUM = 1 ";

  query2 = " Select unc.t_number as ContrNum, unc.t_name as ContrName ,unc.t_dateconc as ContrDate, acnt.* "
         + " from ddepoacnt_dbt acnt, dsfunioncontr_dbt unc , dsfcontr_dbt ctr  "
         + " where ACNT.T_AUTOKEY IN (SELECT TMP.T_DEPOACNTID FROM DDEPOACNT_TMP TMP)"
         + " and unc.t_UnionContrID = ctr.t_UnionContrID "
         + " and ACNT.t_code = ctr.t_object ";
         
  DataSet1 = TRsbDataSet(query1);
  if( DataSet1.MoveNext() )

    var flag = MsgBoxEx("Найдены счета депо, отобранные к закрытию ранее. Обновить дату закрытия выбранных счетов депо?",MB_YES+MB_NO+MB_CANCEL, IND_NO);

    if(flag == IND_YES)
       DataSet = TRsbDataSet(query2);
       SQL_Execute( " UPDATE DDEPOACNT_DBT ACNT "
                  + " SET ACNT.T_NOTICEDATE = " + GetSQLDate({curdate}) 
                  + " WHERE ACNT.T_AUTOKEY IN (SELECT TMP.T_DEPOACNTID FROM DDEPOACNT_TMP TMP)");

    elif (flag == IND_NO)
       query2 = query2
              + " AND ACNT.T_NOTICEDATE = TO_DATE('01.01.0001', 'DD.MM.YYYY') ";
       DataSet = TRsbDataSet(query2);

       SQL_Execute( " UPDATE DDEPOACNT_DBT ACNT "
                  + " SET ACNT.T_NOTICEDATE = " + GetSQLDate({curdate}) 
                  + " WHERE ACNT.T_AUTOKEY IN (SELECT TMP.T_DEPOACNTID FROM DDEPOACNT_TMP TMP)"
                  + " AND ACNT.T_NOTICEDATE = TO_DATE('01.01.0001', 'DD.MM.YYYY') " );
    elif (flag == IND_CANCEL)
       return;
    end;
  else
       DataSet = TRsbDataSet(query2);
       SQL_Execute( " UPDATE DDEPOACNT_DBT ACNT "
                  + " SET ACNT.T_NOTICEDATE = " + GetSQLDate({curdate}) 
                  + " WHERE ACNT.T_AUTOKEY IN (SELECT TMP.T_DEPOACNTID FROM DDEPOACNT_TMP TMP)");
  end;

  while( DataSet.MoveNext() )
    OpClose.size = 0;
    CodeDA = DataSet.Code;
    NameDA = DataSet.Name;
    CodeDep = ПолучитьКодСубъекта(DataSet.Owner,1);
    NameDep = GetPartyName(DataSet.Owner, PTKN_FULLNAME);                  
    OpenDateDA = date_as_string(1,DataSet.OpenDate,false);
    ContrNum =  DataSet.ContrNum;
    ContrName = DataSet.ContrName;
    ContrDate = date_as_string(1,DataSet.ContrDate,false);           
    FillOpClose(DataSet.AutoKey,@OpClose);             // заполнение массива
    PrintRepRoot(DataSet.AutoKey,OpClose);
    CountMes = CountMes +1;
    OpClose.size = 0;
  end;
      //печать протокола
    if(CountMes)
        RepHead.PrintRep();
        DP_StdFooter_Ex(Rep, RepFontStyleTitel, NULL, NULL, tablewidth);               // стандартный подвал отчета, добавляем если нет таблицы с ошибками
        Rep.PrintRep();
  
    else    //если нет никаких таблиц

      DP_AddPrintCell( RepHead, "Счетов для закрытия нет", 0, 0, "r:" + RepFontStyleTitel,_is_ap, REP_ELEM_STR );
      RepHead.AddStr();
      DP_StdFooter_Ex(RepHead, RepFontStyleTitel, NULL, NULL, tablewidth);               
      RepHead.PrintRep();

    end;

    SQL_Execute("DELETE FROM ddepoacnt_tmp");  


end;
