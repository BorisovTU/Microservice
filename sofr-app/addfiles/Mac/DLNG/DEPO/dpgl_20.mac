/************************************************************************/
/*         Автоматизированная банковская система RS-Bank 6.0            */
/*                 Copyright (c) R-Style Software Lab 2005              */
/*                                                                      */
/*  Имя файла        : dpgl_20.mac                                      */
/*  Описание         : Глобальные операции депозитария                  */
/*                     шаг      "Открытие счетов                        */
/*  Программист      : Nikonorov Evgeny                                 */
/*  Создан           : 05.07.2005                                       */
/************************************************************************/
import OprInter, InsCarryDoc, DPInter, opr_depo;

/* Буферы ГЛ, заполняемые из операции */
record corpop( dpcorpop );    /*поручение*/
record regstr( dpregstr ); /*реестр*/


macro ExecuteStep( d, crp )

  var DpNode, err = 0;
  if( corpop.ValueDate > {curdate} )
    MsgBox("Дата проводки больше текущей.\n Выполнение операции приостановлено\n до наступления запланированной даты.");
    return 1;
  end;

  if( corpop.TransitAcc == "X")
    if( corpop.PayOffAccID > 0 )
      //открыть недостающие разделы на счете эмитента
      DpNode = InputDepoPartByDepoAcc( DP_OPRACC_ISSUE, corpop.PayOFFAccID, crp, err, 0, corpop.DocKind, 0, DP_GLOBOP_OPERATION );
      if( DpNode == 0 ) /* Была ошибка */
        err = 1;
      end;
    end;
 
    if( corpop.EmissiveAccID > 0 )
      //проверить разделы на эмиссионном счете
      DpNode = InputDepoPartByDepoAcc( DP_OPRACC_EMISS, corpop.EmissiveAccID, crp, err, 0, corpop.DocKind, 0, DP_GLOBOP_OPERATION );
      if( DpNode == 0 ) /* Была ошибка */
        err = 1;
      end;

    end;
  end;

  if( err )
    err = RejectDepoDraftYesNo( crp, DP_GLOBOP_OPERATION );
  end;

  return err;
end;
