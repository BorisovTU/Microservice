/*
$Name:         dl711Part3.mac
$Module:       Депозитарий
$Description:  Выборка данных для Ф711 Ч3
*/

import "dl711avoir.mac";

// Модули отчета
const SECUR_MODULE  = "S"; // БОЦБ
const DEPO_MODULE   = "D"; // депозитарий
const VEKSEL_MODULE = "V"; // УВ

private const EMISS_SORT    = 1; // Эмиссионные
private const NOTEMISS_SORT = 2; // Неэмиссионные
private const YURMORT_SORT  = 3; // закладная юрика
private const PHYSMORT_SORT = 4; // закладная физика

private const BLOCKAMOUNT_DATE = date(1,7,2017);
private const BLOCKARREST_DATE = date(30,6,2017);

/* ********************** */
/*         Фильтр         */
/* ********************** */
private class TFilter
  var Departments:string = string({OperDprt}), // Список филиалов по которым выбираются ц/б
      BegDate:date       = {curdate},          // Дата начала отчетного периода
      RepDate:date       = {curdate},          // Дата окончания отчетного периода
      RepModule:string   = "",                 // Модули отчета
      OnlyLoaded:bool    = false;              // Только загруженные данные
end;

/* Подзапрос на полуение кода 711 */
private macro GetSelectSubQueryCode711(RepDateSQL:string, objectType:string, condWhere:string):string
  return  " NVL( (SELECT att.t_name"
        + "    FROM dobjattr_dbt att,"
        + "         (SELECT DECODE (t_attrObjectType, 0, atc.t_objectType, t_attrObjectType) AS t_ObjectType,"
        + "                 DECODE (t_attrgroupId, 0, atc.t_groupId, t_attrgroupId) AS t_groupId,"
        + "                 atc.t_objectType AS t_realObjectType,"
        + "                 atc.t_groupId AS t_realGroupId,"
        + "                 atc.t_attrId t_attrId,"
        + "                 atc.t_object t_object,"
        + "                 atc.t_validToDate t_validToDate,"
        + "                 atc.t_validFromDate t_validFromDate"
        + "            FROM dobjatcor_dbt atc, dobjgroup_dbt grp"
        + "           WHERE atc.t_groupId = grp.t_groupId"
        + "             AND atc.t_objectType = grp.t_objectType"
        + "             AND atc.t_general = 'X') atc"
        + "   WHERE atc.t_attrId = att.t_attrId"
        + "     AND att.t_objectType = 12" /* OBJTYPE_AVOIRISS */
        + "     AND atc.t_groupId = att.t_groupId"
        + "     AND "+RepDateSQL+" BETWEEN atc.t_validFromDate AND atc. t_validToDate"
        + "     AND atc.t_realObjectType = " + objectType
        + "     AND atc.t_realGroupId = 1 "
        + "     AND atc.t_object = " + condWhere
        + "    ), CHR(1)) as T_CODE711,";
end;

/* ********************************************** */
/* Класс сбора ранее загруженных через xls данных о залогах */
/* ********************************************** */
private class CLoadedData(_fltr)
  private var fltr = _fltr;
  private var tools = C_711Tools;

  macro PrepareData()
    var query, cmd;
    var LoadingDateSQL = GetSQLDate(fltr.RepDate+1);

    query = "INSERT INTO d711Part3_tmp (T_ISSUERNAME"
                    + ", T_ISSUERINN "
                    + ", T_ISSUERINN_TIN "
                    + ", T_ISSUERINN_MARK "
                    + ", T_ISSUERNOTRESCODE "
                    + ", T_CFI "
                    + ", T_ISSUEROGRN "
                    + ", T_ISSUERCOUNTRYCODE "
                    + ", T_CODE711 "
                    + ", T_LSIN "
                    + ", T_ISIN "
                    + ", T_FACEVALUEFICODE "
                    + ", T_FACEVALUE "
                    + ", T_SALEREPOAMOUNT "
                    + ", T_TRANSLOANAMOUNT "
                    + ", T_BUYREPOAMOUNT "
                    + ", T_ACCEPTLOANAMOUNT "
                    + ", T_TRANSDUAMOUNT "
                    + ", T_TRANSRIGHTSDUAMOUNT "
                    + ", T_TRANSPLEDGEBOAMOUNT "
                    + ", T_TRANSPLEDGEAMOUNT "
                    + ", T_ACCEPTPLEDGEAMOUNT "
                    + ", T_TRADEAMOUNT "
                    + ", T_CORPRESTRAMOUNT "
                    + ", T_OPERBANAMOUNT "
                    + ", T_ARRESTAMOUNT "
                    + ", T_SORT)"
          + "(SELECT T_ISSUERNAME"
                    + ", T_ISSUERINN "
                    + ", T_ISSUERINN_TIN "
                    + ", T_ISSUERINN_MARK "
                    + ", T_ISSUERNOTRESCODE "
                    + ", T_CFI "
                    + ", T_ISSUEROGRN "
                    + ", T_ISSUERCOUNTRYCODE "
                    + ", T_CODE711 "
                    + ", T_LSIN "
                    + ", T_ISIN "
                    + ", T_FACEVALUEFICODE "
                    + ", T_FACEVALUE "
                    + ", T_SALEREPOAMOUNT "
                    + ", T_TRANSLOANAMOUNT "
                    + ", T_BUYREPOAMOUNT "
                    + ", T_ACCEPTLOANAMOUNT "
                    + ", T_TRANSDUAMOUNT "
                    + ", T_TRANSRIGHTSDUAMOUNT "
                    + ", T_TRANSPLEDGEBOAMOUNT "
                    + ", T_TRANSPLEDGEAMOUNT "
                    + ", T_ACCEPTPLEDGEAMOUNT "
                    + ", T_TRADEAMOUNT "
                    + ", T_CORPRESTRAMOUNT "
                    + ", T_OPERBANAMOUNT "
                    + ", T_ARRESTAMOUNT "
					+ ", 1"
          + " FROM D711PART3_PAWN_DBT WHERE T_LOADINGDATE = " + LoadingDateSQL + ")";

    SQL_Execute(query, "Сбор данных по залогам, ранее загруженным в систему", true );
  end;
end;

/* ********************************************** */
/* Класс сбора данных на по модулю БОЦБ           */
/* ********************************************** */
private class CSecurData(_fltr)
  private var fltr = _fltr;
  private var tools = C_711Tools;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "", queryIns = "";
    var pt:TRecHandler;
    var count = 0;
    var IssuerName = "", IssuerINN = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "", IssuerKPP = "", IssuerCountryCode = "", LSIN = "", ISIN = "",
        Code711 = "", FaceValueFiCode = "", FaceValue = $0.0, FaceValuePoint = 0, IsEmissive = false, CFI = "";

    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_IssuerName, t_Issuer, t_IssuerCountryCode, t_FIID, t_code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint "
                        +"  FROM d711Part3_tmp WHERE t_Module = 'S'");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      IssuerName              = dataSet.IssuerName;
      IssuerINN               = dataSet.IssuerINN;
      IssuerINN_Mark          = "";
      IssuerINN_TIN           = "";
      IssuerNotResCode        = "";
      IssuerKPP               = "";
      IssuerCountryCode       = dataSet.IssuerCountryCode;
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;

      count = count + 1;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotresCode);
        IssuerCountryCode = tools.GetCountryCode(pt);
        IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);
      end;

      // Выпуск
      var Avoiriss = TRecHandler( "avoiriss.dbt" );
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if ((dataSet.FIID != -1) and (ПолучитьФинИн(dataSet.FIID, Fininstr, Avoiriss) == 0))
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
          ISIN = "";
        elif (not IsEmissive)
          LSIN = "";
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

      if((IssuerCountryCode != "") AND (IssuerCountryCode != "643"))
        LSIN = "";
      end;

      if(Code711 == "DR") // депозитарная расписка
        LSIN = tools.GetLSINDEPO(dataSet.FIID);
      end;

      queryUpd = "UPDATE d711Part3_tmp SET "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + IIF(FaceValue==$0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint)+ ","
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных БО ЦБ, " + String(count), false );
    end;

    var LoadingDateSQL = GetSQLDate(fltr.RepDate+1);
    queryIns = "INSERT INTO d711Part3_tmp (T_ISSUERNAME"
                + ", T_ISSUERINN "
                + ", T_ISSUERINN_TIN "
                + ", T_ISSUERINN_MARK "
                + ", T_ISSUERNOTRESCODE "
                + ", T_CFI "
                + ", T_ISSUEROGRN "
                + ", T_ISSUERCOUNTRYCODE "
                + ", T_CODE711 "
                + ", T_LSIN "
                + ", T_ISIN "
                + ", T_FACEVALUEFICODE "
                + ", T_FACEVALUE "
                + ", T_SALEREPOAMOUNT "
                + ", T_TRANSLOANAMOUNT "
                + ", T_BUYREPOAMOUNT "
                + ", T_ACCEPTLOANAMOUNT "
                + ", T_TRANSDUAMOUNT "
                + ", T_TRANSRIGHTSDUAMOUNT "
                + ", T_TRANSPLEDGEBOAMOUNT "
                + ", T_TRANSPLEDGEAMOUNT "
                + ", T_ACCEPTPLEDGEAMOUNT "
                + ", T_TRADEAMOUNT "
                + ", T_CORPRESTRAMOUNT "
                + ", T_OPERBANAMOUNT "
                + ", T_ARRESTAMOUNT "
                + ", T_SORT)"
      + "(SELECT T_ISSUERNAME"
                + ", T_ISSUERINN "
                + ", T_ISSUERINN_TIN "
                + ", T_ISSUERINN_MARK "
                + ", T_ISSUERNOTRESCODE "
                + ", T_CFI "
                + ", T_ISSUEROGRN "
                + ", T_ISSUERCOUNTRYCODE "
                + ", T_CODE711 "
                + ", T_LSIN "
                + ", T_ISIN "
                + ", T_FACEVALUEFICODE "
                + ", T_FACEVALUE "
                + ", T_SALEREPOAMOUNT "
                + ", T_TRANSLOANAMOUNT "
                + ", T_BUYREPOAMOUNT "
                + ", T_ACCEPTLOANAMOUNT "
                + ", T_TRANSDUAMOUNT "
                + ", T_TRANSRIGHTSDUAMOUNT "
                + ", T_TRANSPLEDGEBOAMOUNT "
                + ", T_TRANSPLEDGEAMOUNT "
                + ", T_ACCEPTPLEDGEAMOUNT "
                + ", T_TRADEAMOUNT "
                + ", T_CORPRESTRAMOUNT "
                + ", T_OPERBANAMOUNT "
                + ", T_ARRESTAMOUNT "
      + ", 1"
      + " FROM D711PART3_PAWN_DBT WHERE T_LOADINGDATE = " + LoadingDateSQL + ")";

      SQL_Execute(queryIns, "Сбор данных по залогам, ранее загруженным в систему", true );
  end;

  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);
    var MethodTradeAcc = 0;

    GetRegistryValue("REPTREG\\REP_GROUPS\\ФОРМА 711\\СВЕД. ПО ТОРГ. СЧ. В 3-Й РАЗДЕЛ", V_INTEGER, MethodTradeAcc);

    //Кроме граф 211-214
    query = "INSERT INTO d711Part3_tmp (T_ACCOUNTID, "
                                     + "T_ISSUER,"
                                     + "T_ISSUERNAME,"
                                     + "T_ISSUERINN,"
                                     + "T_ISSUERKPP,"
                                     + "T_ISSUEROGRN,"
                                     + "T_ISSUERCOUNTRYCODE,"
                                     + "T_ISSUERINN_MARK,"
                                     + "T_ISSUERINN_TIN,"
                                     + "T_ISSUERNOTRESCODE,"
                                     + "T_FIID,"
                                     + "T_CODE711,"
                                     + "T_LSIN,"
                                     + "T_ISIN,"
                                     + "T_FACEVALUEFICODE,"
                                     + "T_FACEVALUE,"
                                     + "T_FACEVALUEPOINT,"
                                     + "T_SALEREPOAMOUNT,"
                                     + "T_TRANSLOANAMOUNT,"
                                     + "T_BUYREPOAMOUNT,"
                                     + "T_ISCOMPDELIVERY,"
                                     + "T_ACCEPTLOANAMOUNT,"
                                     + "T_TRANSDUAMOUNT,"
                                     + "T_TRANSRIGHTSDUAMOUNT, "
                                     + "T_TRANSPLEDGEBOAMOUNT,"
                                     + "T_TRANSPLEDGEAMOUNT,"
                                     + "T_ACCEPTPLEDGEAMOUNT,"
                                     + "T_MODULE,"
                                     + "T_NUMBER,"
                                     + "T_TYPEAVR,"
                                     + "T_PARENTKINDAVR,"
                                     + "T_NAMEAVR,"
                                     + "T_SORT, "
                                     + "T_TRADEAMOUNT,"
                                     + "T_CORPRESTRAMOUNT,"
                                     + "T_OPERBANAMOUNT,"
                                     + "T_ARRESTAMOUNT,"
                                     + "T_TRANSLOANCONTR, "
                                     + "T_ACCEPTLOANCONTR) "
          + "(SELECT q.T_ACCOUNTID, "
          + "        q.T_ISSUER,"
          + "        q.T_ISSUERNAME,"
          + "        q.T_ISSUERINN,"
          + "        q.T_ISSUERKPP,"
          + "        q.T_ISSUEROGRN,"
          + "        q.T_ISSUERCOUNTRYCODE,"
          + "        q.T_ISSUERINN_MARK,"
          + "        q.T_ISSUERINN_TIN,"
          + "        q.T_ISSUERNOTRESCODE,"
          + "        q.T_FIID,"
          + "        q.T_CODE711,"
          + "        q.T_LSIN,"
          + "        q.T_ISIN,"
          + "        q.T_FACEVALUEFICODE,"
          + "        q.T_FACEVALUE,"
          + "        q.T_FACEVALUEPOINT,"
          + "        q.T_SALEREPOAMOUNT,"
          + "        q.T_TRANSLOANAMOUNT,"
          + "        q.T_BUYREPOAMOUNT,"
          + "        q.T_ISCOMPDELIVERY,"
          + "        q.T_ACCEPTLOANAMOUNT,"
          + "        q.T_TRANSDUAMOUNT,"
          + "        q.T_TRANSRIGHTSDUAMOUNT, "
          + "        q.T_TRANSPLEDGEBOAMOUNT,"
          + "        q.T_TRANSPLEDGEAMOUNT,"
          + "        q.T_ACCEPTPLEDGEAMOUNT,"
          + "        q.T_MODULE,"
          + "        q.T_NUMBER,"
          + "        q.T_TYPEAVR,"
          + "        q.T_PARENTKINDAVR,"
          + "        q.T_NAMEAVR,"
          + "        q.T_SORT, "
          + "        0," //  T_TRADEAMOUNT
          + "        0," //  T_CORPRESTRAMOUNT
          + "        0," //  T_OPERBANAMOUNT
          + "        0, " //  T_ARRESTAMOUNT
          + "        q.T_TRANSLOANCONTR, " 
          + "        q.T_ACCEPTLOANCONTR "
          + " FROM "
          + "(SELECT 0 AS T_ACCOUNTID,"                                                                             // T_ACCOUNTID
          + "        issuer.t_Issuer as T_ISSUER,"                                                                  // T_ISSUER
          + "        CHR(1) as T_ISSUERNAME,"                                                                       // T_ISSUERNAME
          + "        rsi_rsbparty.GetPartyCode(issuer.t_Issuer, "+PTCK_INN+") as T_ISSUERINN,"                      // T_ISSUERINN
          + "        CHR(1) as T_ISSUERKPP,"                                                                        // T_ISSUERKPP
          + "        rsi_rsbparty.GetPartyCode(issuer.t_Issuer, "+PTCK_OGRN+") as T_ISSUEROGRN,"                    // T_ISSUEROGRN
          + "        CHR(1) as T_ISSUERCOUNTRYCODE,"                                                                // T_ISSUERCOUNTRYCODE
          + "        CHR(1) as T_ISSUERINN_MARK,"                                                                   // T_ISSUERINN_MARK
          + "        CHR(1) as T_ISSUERINN_TIN,"                                                                    // T_ISSUERINN_TIN
          + "        CHR(1) as T_ISSUERNOTRESCODE,"                                                                 // T_ISSUERNOTRESCODE
          + "        avr.t_FIID as T_FIID,"                                                                         // T_FIID
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_AVOIRISS, "lpad(to_char(avr.t_FIID), 10, '0')")   // T_CODE711
          + "        avr.T_LSIN as T_LSIN,"                                                                         // T_LSIN
          + "        avr.T_ISIN as T_ISIN,"                                                                         // T_ISIN
          + "        NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR(1)) as T_FACEVALUEFICODE,"  // T_FACEVALUEFICODE
          + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+"), 0.0) as T_FACEVALUE,"         // T_FACEVALUE
          + "        fin.T_POINT+2 as T_FACEVALUEPOINT,"                                                            // T_FACEVALUEPOINT
          + "        (CASE WHEN Rsb_Secur.IsSale (Opr.oGrp) = 1 THEN rq_sp1.t_Amount - (SELECT NVL(SUM(CompRQ.t_Amount * (CASE WHEN CompRQ.t_Kind = rq_sp1.t_Kind THEN -1 ELSE 1 END)), 0) "
          +        "    FROM DDLRQ_DBT CompRQ "
          +        "   WHERE CompRQ.t_Type = " + DLRQ_TYPE_COMPDELIVERY
          +        "     AND CompRQ.t_FIID = rq_sp1.t_FIID "
          +        "     AND CompRQ.t_DocKind = rq_sp1.t_DocKind "
          +        "     AND CompRQ.t_DocID = rq_sp1.t_DocID "
          +        "     AND rsi_dlrq.RSI_GetRQStateOnDate (CompRQ.t_ID,"+RepDateSQL+") = " + DLRQ_STATE_EXEC
          +        " ) ELSE 0 END) as T_SALEREPOAMOUNT,"                                                              // T_SALEREPOAMOUNT
          + "        0 as T_TRANSLOANAMOUNT, "  // T_TRANSLOANAMOUNT
          + "        (CASE WHEN Rsb_Secur.IsBuy (Opr.oGrp) = 1 THEN rq_sp1.t_Amount - (SELECT NVL(SUM(CompRQ.t_Amount * (CASE WHEN CompRQ.t_Kind = rq_sp1.t_Kind THEN -1 ELSE 1 END)), 0) "
          +        "    FROM DDLRQ_DBT CompRQ "
          +        "   WHERE CompRQ.t_Type = " + DLRQ_TYPE_COMPDELIVERY
          +        "     AND CompRQ.t_FIID = rq_sp1.t_FIID "
          +        "     AND CompRQ.t_DocKind = rq_sp1.t_DocKind "
          +        "     AND CompRQ.t_DocID = rq_sp1.t_DocID "
          +        "     AND rsi_dlrq.RSI_GetRQStateOnDate (CompRQ.t_ID,"+RepDateSQL+") = " + DLRQ_STATE_EXEC
          +        " ) ELSE  0 END) as T_BUYREPOAMOUNT,"                                                                                // T_BUYREPOAMOUNT
          + "        (CASE WHEN (SELECT NVL(SUM(CompRQ.t_Amount * (CASE WHEN CompRQ.t_Kind = rq_sp1.t_Kind THEN -1 ELSE 1 END)), 0) "
          +        "    FROM DDLRQ_DBT CompRQ "
          +        "   WHERE CompRQ.t_Type = " + DLRQ_TYPE_COMPDELIVERY
          +        "     AND CompRQ.t_FIID = rq_sp1.t_FIID "
          +        "     AND CompRQ.t_DocKind = rq_sp1.t_DocKind "
          +        "     AND CompRQ.t_DocID = rq_sp1.t_DocID "
          +        "     AND rsi_dlrq.RSI_GetRQStateOnDate (CompRQ.t_ID,"+RepDateSQL+") = " + DLRQ_STATE_EXEC
          +        " ) <> 0 THEN 1 ELSE 0 END) as T_ISCOMPDELIVERY, "                                                                    // T_ISCOMPDELIVERY
          + "      0 as T_ACCEPTLOANAMOUNT, "                                                            //T_ACCEPTLOANAMOUNT,"
          + "      0 as T_TRANSDUAMOUNT, "                                                               //T_TRANSDUAMOUNT,"
          + "      0 as T_TRANSRIGHTSDUAMOUNT, "                                                         //T_TRANSRIGHTSDUAMOUNT, "
          + "      0 as T_TRANSPLEDGEBOAMOUNT, "                                                         //T_TRANSPLEDGEBOAMOUNT,"
          + "      0 as T_TRANSPLEDGEAMOUNT, "                                                           //T_TRANSPLEDGEAMOUNT,"
          + "      0 as T_ACCEPTPLEDGEAMOUNT, "                                                          //T_ACCEPTPLEDGEAMOUNT,"
          + "      'S' as T_MODULE,"                                                                     // T_MODULE
          + "      tick.t_DealCode as T_NUMBER,"                                                         // T_NUMBER
          + "      avrKinds.t_Name as T_TYPEAVR,"                                                        // T_TYPEAVR
          + "      RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND) as T_PARENTKINDAVR,"     // T_PARENTKINDAVR
          + "      fin.t_Name as T_NAMEAVR,"                                                             // T_NAMEAVR
          +        EMISS_SORT+" as T_SORT,"                                                              // T_SORT
          + "      rq_sp1.t_ID as T_RQID, "
          + "      CHR(1) as T_TRANSLOANCONTR, "                                                         //T_TRANSLOANCONTR
          + "      CHR(1) as T_ACCEPTLOANCONTR "                                                       //T_ACCEPTLOANCONTR
          + "   FROM davoiriss_dbt avr, dfininstr_dbt fin, ddlrq_dbt rq_sp1, ddlrq_dbt rq_sp2,ddl_tick_dbt Tick, davrkinds_dbt avrKinds,"
          + "        (SELECT t_Kind_Operation, rsb_secur.get_OperationGroup (t_SysTypes) oGrp FROM doprkoper_dbt) Opr,"
          // если депозитарная расписка, то эмитент из базового выпуска
          + "        (SELECT CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
          + "                      THEN (SELECT finParent.t_Issuer"
          + "                              FROM dfininstr_dbt finParent"
          + "                             WHERE finParent.t_FIID = fin2.t_ParentFI)"
          + "                      ELSE fin2.t_Issuer"
          + "                END AS t_Issuer,"
          + "                fin2.t_FIID"
          + "           FROM dfininstr_dbt fin2) issuer "
          + "  WHERE rq_sp1.t_Type = " + DLRQ_TYPE_DELIVERY
          + "    AND rq_sp1.t_DealPart = 1"
          + "    AND rq_sp1.t_FIID = avr.t_FIID"
          + "    AND Tick.t_ClientID = -1"
          + "    AND Tick.t_DealID = rq_sp1.t_DocID"
          + "    AND Tick.t_BOfficeKind = rq_sp1.t_DocKind"
          + "    AND Tick.t_DealStatus > 0"
          + "    AND Tick.t_department IN ("+fltr.Departments+")"
          + "    AND rq_sp2.t_Type = " + DLRQ_TYPE_DELIVERY
          + "    AND rq_sp2.t_DealPart = 2"
          + "    AND rq_sp2.t_FIID = rq_sp1.t_FIID"
          + "    AND rq_sp2.t_DocID = Tick.t_DealID"
          + "    AND rq_sp2.t_DocKind = Tick.t_BOfficeKind"
          + "    AND Opr.t_Kind_Operation = Tick.t_DealType"
          + "    AND Rsb_Secur.IsRepo (Opr.oGrp) = 1"
          + "    AND rsi_dlrq.RSI_GetRQStateOnDate (rq_sp1.t_ID,"+RepDateSQL+") = " + DLRQ_STATE_EXEC
          + "    AND rsi_dlrq.RSI_GetRQStateOnDate (rq_sp2.t_ID,"+RepDateSQL+") NOT IN("+DLRQ_STATE_EXEC+", "+DLRQ_STATE_REJECT+")"
          + "    AND fin.t_FIID = avr.t_FIID"
          + "    AND issuer.t_FIID = avr.t_fiid"
          + "    AND avrKinds.t_FI_Kind = " + FIKIND_AVOIRISS
          + "    AND avrKinds.t_AvoirKind = fin.t_AvoirKind) q )";

    //println("БО ЦБ: " + query);
    SQL_Execute(query, "Сбор данных модуля БО ЦБ", true );

    //Графы 211-214 по лотам ПВО
    query = "INSERT INTO d711Part3_tmp (T_ACCOUNTID, "
                                     + "T_ISSUER,"
                                     + "T_ISSUERNAME,"
                                     + "T_ISSUERINN,"
                                     + "T_ISSUERKPP,"
                                     + "T_ISSUEROGRN,"
                                     + "T_ISSUERCOUNTRYCODE,"
                                     + "T_ISSUERINN_MARK,"
                                     + "T_ISSUERINN_TIN,"
                                     + "T_ISSUERNOTRESCODE,"
                                     + "T_FIID,"
                                     + "T_CODE711,"
                                     + "T_LSIN,"
                                     + "T_ISIN,"
                                     + "T_FACEVALUEFICODE,"
                                     + "T_FACEVALUE,"
                                     + "T_FACEVALUEPOINT,"
                                     + "T_SALEREPOAMOUNT,"
                                     + "T_TRANSLOANAMOUNT,"
                                     + "T_BUYREPOAMOUNT,"
                                     + "T_ISCOMPDELIVERY,"
                                     + "T_ACCEPTLOANAMOUNT,"
                                     + "T_TRANSDUAMOUNT,"
                                     + "T_TRANSRIGHTSDUAMOUNT, "
                                     + "T_TRANSPLEDGEBOAMOUNT,"
                                     + "T_TRANSPLEDGEAMOUNT,"
                                     + "T_ACCEPTPLEDGEAMOUNT,"
                                     + "T_MODULE,"
                                     + "T_NUMBER,"
                                     + "T_TYPEAVR,"
                                     + "T_PARENTKINDAVR,"
                                     + "T_NAMEAVR,"
                                     + "T_SORT, "
                                     + "T_TRADEAMOUNT,"
                                     + "T_CORPRESTRAMOUNT,"
                                     + "T_OPERBANAMOUNT,"
                                     + "T_ARRESTAMOUNT,"
                                     + "T_TRANSLOANCONTR,"
                                     + "T_ACCEPTLOANCONTR)"
          + "(SELECT q.T_ACCOUNTID, "
          + "        q.T_ISSUER,"
          + "        q.T_ISSUERNAME,"
          + "        q.T_ISSUERINN,"
          + "        q.T_ISSUERKPP,"
          + "        q.T_ISSUEROGRN,"
          + "        q.T_ISSUERCOUNTRYCODE,"
          + "        q.T_ISSUERINN_MARK,"
          + "        q.T_ISSUERINN_TIN,"
          + "        q.T_ISSUERNOTRESCODE,"
          + "        q.T_FIID,"
          + "        q.T_CODE711,"
          + "        q.T_LSIN,"
          + "        q.T_ISIN,"
          + "        q.T_FACEVALUEFICODE,"
          + "        q.T_FACEVALUE,"
          + "        q.T_FACEVALUEPOINT,"
          + "        q.T_SALEREPOAMOUNT,"
          + "        q.T_TRANSLOANAMOUNT,"
          + "        q.T_BUYREPOAMOUNT,"
          + "        q.T_ISCOMPDELIVERY,"
          + "        q.T_ACCEPTLOANAMOUNT,"
          + "        q.T_TRANSDUAMOUNT,"
          + "        q.T_TRANSRIGHTSDUAMOUNT, "
          + "        q.T_TRANSPLEDGEBOAMOUNT,"
          + "        q.T_TRANSPLEDGEAMOUNT,"
          + "        q.T_ACCEPTPLEDGEAMOUNT,"
          + "        q.T_MODULE,"
          + "        q.T_NUMBER,"
          + "        q.T_TYPEAVR,"
          + "        q.T_PARENTKINDAVR,"
          + "        q.T_NAMEAVR,"
          + "        q.T_SORT, "
          + IIF(MethodTradeAcc == 0,
            "        (CASE WHEN "+GetSQLDate(fltr.BegDate)+" >= "+GetSQLDate(BLOCKAMOUNT_DATE)+" AND rsb_depo.IsDepoDraftByTradeAcc(q.t_RQID, "+RepDateSQL+") = 1 THEN q.T_AMOUNT ELSE 0 END)",
            "        (CASE WHEN "+GetSQLDate(fltr.BegDate)+" >= "+GetSQLDate(BLOCKAMOUNT_DATE)+" AND rsb_secur.IsBuy(q.oGrp) = 1 AND rsb_secur.IsRepo(q.oGrp) = 1 THEN q.T_AMOUNT ELSE 0 END)"
               ) + ", " //  T_TRADEAMOUNT
          + "        (CASE WHEN "+GetSQLDate(fltr.BegDate)+" >= "+GetSQLDate(BLOCKAMOUNT_DATE)+" AND rsb_depo.IsDepoDraftByBlockAcc(q.t_RQID, "+RepDateSQL+", "+LLCLASS_KIND_BLOCK_CB_CORPRESTRICT+", 1) = 1 THEN q.T_AMOUNT ELSE 0 END)," //  T_CORPRESTRAMOUNT
          + "        (CASE WHEN "+GetSQLDate(fltr.BegDate)+" >= "+GetSQLDate(BLOCKAMOUNT_DATE)+" AND rsb_depo.IsDepoDraftByBlockAcc(q.t_RQID, "+RepDateSQL+", "+LLCLASS_KIND_BLOCK_CB_OPERBAN+", 0) = 1 THEN q.T_AMOUNT ELSE 0 END)," //  T_OPERBANAMOUNT
          + "        (CASE WHEN "+GetSQLDate(fltr.BegDate)+" >= "+GetSQLDate(BLOCKARREST_DATE)+" AND rsb_depo.IsDepoDraftByBlockAcc(q.t_RQID, "+RepDateSQL+", "+LLCLASS_KIND_BLOCK_CB_ARREST+", 0) = 1 THEN q.T_AMOUNT ELSE 0 END), " //  T_ARRESTAMOUNT
          + "        q.T_TRANSLOANCONTR,"
          + "        q.T_ACCEPTLOANCONTR"
          + " FROM "
          + "(SELECT 0 AS T_ACCOUNTID,"                                                                             // T_ACCOUNTID
          + "        issuer.t_Issuer as T_ISSUER,"                                                                  // T_ISSUER
          + "        CHR(1) as T_ISSUERNAME,"                                                                       // T_ISSUERNAME
          + "        rsi_rsbparty.GetPartyCode(issuer.t_Issuer, "+PTCK_INN+")  as T_ISSUERINN,"                     // T_ISSUERINN
          + "        CHR(1) as T_ISSUERKPP,"                                                                        // T_ISSUERKPP
          + "        rsi_rsbparty.GetPartyCode(issuer.t_Issuer, "+PTCK_OGRN+") as T_ISSUEROGRN,"                    // T_ISSUEROGRN
          + "        CHR(1) as T_ISSUERCOUNTRYCODE,"                                                                // T_ISSUERCOUNTRYCODE
          + "        CHR(1) as T_ISSUERINN_MARK,"                                                                   // T_ISSUERINN_MARK
          + "        CHR(1) as T_ISSUERINN_TIN,"                                                                    // T_ISSUERINN_TIN
          + "        CHR(1) as T_ISSUERNOTRESCODE,"                                                                 // T_ISSUERNOTRESCODE
          + "        avr.t_FIID as T_FIID,"                                                                         // T_FIID
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_AVOIRISS, "lpad(to_char(avr.t_FIID), 10, '0')")   // T_CODE711
          + "        avr.T_LSIN as T_LSIN,"                                                                         // T_LSIN
          + "        avr.T_ISIN as T_ISIN,"                                                                         // T_ISIN
          + "        NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR(1)) as T_FACEVALUEFICODE,"  // T_FACEVALUEFICODE
          + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+"), 0.0) as T_FACEVALUE,"         // T_FACEVALUE
          + "        fin.T_POINT+2 as T_FACEVALUEPOINT,"                                                            // T_FACEVALUEPOINT
          + "        0 as T_SALEREPOAMOUNT,"                                                                        // T_SALEREPOAMOUNT
          + "        0 as T_TRANSLOANAMOUNT, "                                                                      // T_TRANSLOANAMOUNT
          + "        0 as T_BUYREPOAMOUNT,"                                                                         // T_BUYREPOAMOUNT
          + "        0 as T_ISCOMPDELIVERY, "                                                                       // T_ISCOMPDELIVERY
          + "        0 as T_ACCEPTLOANAMOUNT, "                                                                     // T_ACCEPTLOANAMOUNT,"
          + "        0 as T_TRANSDUAMOUNT, "                                                                        // T_TRANSDUAMOUNT,"
          + "        0 as T_TRANSRIGHTSDUAMOUNT, "                                                                  // T_TRANSRIGHTSDUAMOUNT, "
          + "        0 as T_TRANSPLEDGEBOAMOUNT, "                                                                  // T_TRANSPLEDGEBOAMOUNT,"
          + "        0 as T_TRANSPLEDGEAMOUNT, "                                                                    // T_TRANSPLEDGEAMOUNT,"
          + "        0 as T_ACCEPTPLEDGEAMOUNT, "                                                                   // T_ACCEPTPLEDGEAMOUNT,"
          + "        'S' as T_MODULE,"                                                                              // T_MODULE
          + "        tick.t_DealCode as T_NUMBER,"                                                                  // T_NUMBER
          + "        avrKinds.t_Name as T_TYPEAVR,"                                                                 // T_TYPEAVR
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND) as T_PARENTKINDAVR,"              // T_PARENTKINDAVR
          + "        fin.t_Name as T_NAMEAVR,"                                                                      // T_NAMEAVR
          +          EMISS_SORT+" as T_SORT,"                                                                       // T_SORT
          + "        rq.t_ID as T_RQID, "
          + "        v.t_Amount, "
          + "        Opr.oGrp, "
          + "        CHR(1) as T_TRANSLOANCONTR, "                                                         //T_TRANSLOANCONTR
          + "        CHR(1) as T_ACCEPTLOANCONTR "                                                       //T_ACCEPTLOANCONTR
          + "   FROM davoiriss_dbt avr, dfininstr_dbt fin, v_scwrthistex v, ddlrq_dbt rq, ddl_tick_dbt Tick, davrkinds_dbt avrKinds,"
          + "        (SELECT t_Kind_Operation, rsb_secur.get_OperationGroup (t_SysTypes) oGrp FROM doprkoper_dbt) Opr,"
          // если депозитарная расписка, то эмитент из базового выпуска
          + "        (SELECT CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
          + "                      THEN (SELECT finParent.t_Issuer"
          + "                              FROM dfininstr_dbt finParent"
          + "                             WHERE finParent.t_FIID = fin2.t_ParentFI)"
          + "                      ELSE fin2.t_Issuer"
          + "                END AS t_Issuer,"
          + "                fin2.t_FIID"
          + "           FROM dfininstr_dbt fin2) issuer "
          + "  WHERE v.t_Buy_Sale <> " + PM_WRITEOFF_SUM_SALE
          + "    AND v.t_State = " + PM_WRTSUM_FORM
          + "    AND v.t_Portfolio in (" + KINDPORT_BACK +","+ KINDPORT_BACK_KSU +")"
          + "    AND v.t_FIID = rq.t_FIID "
          + "    AND v.t_ChangeDate <= " +RepDateSQL
          + "    AND v.t_Amount <> 0 "
          + "    AND v.t_Instance = (SELECT MAX(v2.t_Instance)"
          + "                          FROM v_scwrthistex v2"
          + "                         WHERE v2.t_SumID = v.t_SumID "
          + "                           AND v2.t_ChangeDate <= " +RepDateSQL
          + "                                               )"
          + "    AND avr.t_FIID = v.t_FIID "
          + "    AND rq.t_ID = v.t_DocID "
          + "    AND Tick.t_ClientID = -1"
          + "    AND Tick.t_DealID = v.t_DealID"
          + "    AND Tick.t_DealStatus > 0"
          + "    AND Tick.t_department IN ("+fltr.Departments+")"
          + "    AND Opr.t_Kind_Operation = Tick.t_DealType"
          + "    AND Rsb_Secur.IsRepo (Opr.oGrp) = 1"
          + "    AND fin.t_FIID = avr.t_FIID"
          + "    AND issuer.t_FIID = avr.t_fiid"
          + "    AND avrKinds.t_FI_Kind = " + FIKIND_AVOIRISS
          + "    AND avrKinds.t_AvoirKind = fin.t_AvoirKind) q )";

    //println("БО ЦБ: " + query);
    SQL_Execute(query, "Сбор данных модуля БО ЦБ", true );


    // Golovkin 26.02.2019 Графа 229 Переданные в ДУ
    query = "INSERT INTO d711Part3_tmp (T_ACCOUNTID, "
                                     + "T_ISSUER,"
                                     + "T_ISSUERNAME,"
                                     + "T_ISSUERINN,"
                                     + "T_ISSUERKPP,"
                                     + "T_ISSUEROGRN,"
                                     + "T_ISSUERCOUNTRYCODE,"
                                     + "T_ISSUERINN_MARK,"
                                     + "T_ISSUERINN_TIN,"
                                     + "T_ISSUERNOTRESCODE,"
                                     + "T_FIID,"
                                     + "T_CODE711,"
                                     + "T_LSIN,"
                                     + "T_ISIN,"
                                     + "T_FACEVALUEFICODE,"
                                     + "T_FACEVALUE,"
                                     + "T_FACEVALUEPOINT,"
                                     + "T_SALEREPOAMOUNT,"
                                     + "T_TRANSLOANAMOUNT,"
                                     + "T_BUYREPOAMOUNT,"
                                     + "T_ISCOMPDELIVERY,"
                                     + "T_ACCEPTLOANAMOUNT,"
                                     + "T_TRANSDUAMOUNT,"
                                     + "T_TRANSRIGHTSDUAMOUNT, "
                                     + "T_TRANSPLEDGEBOAMOUNT,"
                                     + "T_TRANSPLEDGEAMOUNT,"
                                     + "T_ACCEPTPLEDGEAMOUNT,"
                                     + "T_MODULE,"
                                     + "T_NUMBER,"
                                     + "T_TYPEAVR,"
                                     + "T_PARENTKINDAVR,"
                                     + "T_NAMEAVR,"
                                     + "T_SORT, "
                                     + "T_TRADEAMOUNT,"
                                     + "T_CORPRESTRAMOUNT,"
                                     + "T_OPERBANAMOUNT,"
                                     + "T_ARRESTAMOUNT,"
                                     + "T_TRANSLOANCONTR,"
                                     + "T_ACCEPTLOANCONTR)"
          + "(SELECT q.T_ACCOUNTID, "
          + "        q.T_ISSUER,"
          + "        q.T_ISSUERNAME,"
          + "        q.T_ISSUERINN,"
          + "        q.T_ISSUERKPP,"
          + "        q.T_ISSUEROGRN,"
          + "        q.T_ISSUERCOUNTRYCODE,"
          + "        q.T_ISSUERINN_MARK,"
          + "        q.T_ISSUERINN_TIN,"
          + "        q.T_ISSUERNOTRESCODE,"
          + "        q.T_FIID,"
          + "        q.T_CODE711,"
          + "        q.T_LSIN,"
          + "        q.T_ISIN,"
          + "        q.T_FACEVALUEFICODE,"
          + "        q.T_FACEVALUE,"
          + "        q.T_FACEVALUEPOINT,"
          + "        q.T_SALEREPOAMOUNT,"
          + "        q.T_TRANSLOANAMOUNT,"
          + "        q.T_BUYREPOAMOUNT,"
          + "        q.T_ISCOMPDELIVERY,"
          + "        q.T_ACCEPTLOANAMOUNT,"
          + "        q.T_TRANSDUAMOUNT,"
          + "        q.T_TRANSRIGHTSDUAMOUNT, "
          + "        q.T_TRANSPLEDGEBOAMOUNT,"
          + "        q.T_TRANSPLEDGEAMOUNT,"
          + "        q.T_ACCEPTPLEDGEAMOUNT,"
          + "        q.T_MODULE,"
          + "        q.T_NUMBER,"
          + "        q.T_TYPEAVR,"
          + "        q.T_PARENTKINDAVR,"
          + "        q.T_NAMEAVR,"
          + "        q.T_SORT, "
          + "        0, " //  T_TRADEAMOUNT
          + "        0, " //  T_CORPRESTRAMOUNT
          + "        0, " //  T_OPERBANAMOUNT
          + "        0,  " //  T_ARRESTAMOUNT
          + "        q.T_TRANSLOANCONTR,"
          + "        q.T_ACCEPTLOANCONTR"
          + " FROM "
          + "(SELECT 0 AS T_ACCOUNTID,"                                                                             // T_ACCOUNTID
          + "        issuer.t_Issuer as T_ISSUER,"                                                                  // T_ISSUER
          + "        CHR(1) as T_ISSUERNAME,"                                                                       // T_ISSUERNAME
          + "        rsi_rsbparty.GetPartyCode(issuer.t_Issuer, "+PTCK_INN+")  as T_ISSUERINN,"                     // T_ISSUERINN
          + "        CHR(1) as T_ISSUERKPP,"                                                                        // T_ISSUERKPP
          + "        rsi_rsbparty.GetPartyCode(issuer.t_Issuer, "+PTCK_OGRN+") as T_ISSUEROGRN,"                    // T_ISSUEROGRN
          + "        CHR(1) as T_ISSUERCOUNTRYCODE,"                                                                // T_ISSUERCOUNTRYCODE
          + "        CHR(1) as T_ISSUERINN_MARK,"                                                                   // T_ISSUERINN_MARK
          + "        CHR(1) as T_ISSUERINN_TIN,"                                                                    // T_ISSUERINN_TIN
          + "        CHR(1) as T_ISSUERNOTRESCODE,"                                                                 // T_ISSUERNOTRESCODE
          + "        avr.t_FIID as T_FIID,"                                                                         // T_FIID
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_AVOIRISS, "lpad(to_char(avr.t_FIID), 10, '0')")   // T_CODE711
          + "        avr.T_LSIN as T_LSIN,"                                                                         // T_LSIN
          + "        avr.T_ISIN as T_ISIN,"                                                                         // T_ISIN
          + "        NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR(1)) as T_FACEVALUEFICODE,"  // T_FACEVALUEFICODE
          + "        NVL(rsb_fiinstr.FI_GetNominalOnDate(avr.t_FIID, "+RepDateSQL+"), 0.0) as T_FACEVALUE,"         // T_FACEVALUE
          + "        fin.T_POINT+2 as T_FACEVALUEPOINT,"                                                            // T_FACEVALUEPOINT
          + "        0 as T_SALEREPOAMOUNT,"                                                                        // T_SALEREPOAMOUNT
          + "        0 as T_TRANSLOANAMOUNT, "                                                                      // T_TRANSLOANAMOUNT
          + "        0 as T_BUYREPOAMOUNT,"                                                                         // T_BUYREPOAMOUNT
          + "        0 as T_ISCOMPDELIVERY, "                                                                       // T_ISCOMPDELIVERY
          + "        0 as T_ACCEPTLOANAMOUNT, "                                                                     // T_ACCEPTLOANAMOUNT,"
          + "        sum(v.t_Amount) as T_TRANSDUAMOUNT, "                                                          // T_TRANSDUAMOUNT,"
          + "        0 as T_TRANSRIGHTSDUAMOUNT, "                                                                  // T_TRANSRIGHTSDUAMOUNT, "
          + "        0 as T_TRANSPLEDGEBOAMOUNT, "                                                                  // T_TRANSPLEDGEBOAMOUNT,"
          + "        0 as T_TRANSPLEDGEAMOUNT, "                                                                    // T_TRANSPLEDGEAMOUNT,"
          + "        0 as T_ACCEPTPLEDGEAMOUNT, "                                                                   // T_ACCEPTPLEDGEAMOUNT,"
          + "        'S' as T_MODULE,"                                                                              // T_MODULE
          + "        ''  as T_NUMBER,"                                                                              // T_NUMBER
          + "        avrKinds.t_Name as T_TYPEAVR,"                                                                 // T_TYPEAVR
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND) as T_PARENTKINDAVR,"              // T_PARENTKINDAVR
          + "        fin.t_Name as T_NAMEAVR,"                                                                      // T_NAMEAVR
          +          EMISS_SORT+" as T_SORT,"                                                                       // T_SORT
          + "        sum(v.t_Amount), "
          + "        CHR(1) as T_TRANSLOANCONTR, "                                                         //T_TRANSLOANCONTR
          + "        CHR(1) as T_ACCEPTLOANCONTR "                                                       //T_ACCEPTLOANCONTR
          + "   FROM davoiriss_dbt avr, dfininstr_dbt fin, DAVR_IN_TRUST_DBT v, davrkinds_dbt avrKinds, "
          // если депозитарная расписка, то эмитент из базового выпуска
          + "        (SELECT CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = " + AVOIRISSKIND_DEPOSITORY_RECEIPT
          + "                      THEN (SELECT finParent.t_Issuer"
          + "                              FROM dfininstr_dbt finParent"
          + "                             WHERE finParent.t_FIID = fin2.t_ParentFI)"
          + "                      ELSE fin2.t_Issuer"
          + "                END AS t_Issuer,"
          + "                fin2.t_FIID"
          + "           FROM dfininstr_dbt fin2) issuer "
          + "  WHERE v.T_REPDATE = " +RepDateSQL
          + "    AND avr.t_FIID = v.t_FIID "
          + "    AND fin.t_FIID = avr.t_FIID"
          + "    AND issuer.t_FIID = avr.t_fiid " // Debug
          + "    AND avrKinds.t_FI_Kind = " + FIKIND_AVOIRISS
          + "    AND avrKinds.t_AvoirKind = fin.t_AvoirKind "
          + " GROUP BY issuer.t_Issuer, avr.t_FIID, avrKinds.T_AVOIRKIND, avr.T_LSIN, avr.T_ISIN, fin.T_POINT, avrKinds.t_Name, fin.t_Name, fin.T_FACEVALUEFI) q ) ";

    //println("БО ЦБ: " + query);
    SQL_Execute(query, "Сбор данных модуля БО ЦБ: Переданные в ДУ", true );


    PostProcess();
  end;
end;

/* ********************************************** */
/* Класс сбора данных по модулю Депозитарий       */
/* ********************************************** */
private class CDepoData(_fltr)
  var fltr = _fltr;
  private var tools = C_711Tools;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "";
    var pt:TRecHandler;
    var count = 0;

    var Issuer = 0, IssuerName = "", IssuerINN = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "", IssuerKPP = "", IssuerCountryCode = "", LSIN = "", ISIN = "",
        Code711 = "", FaceValueFiCode = "", FaceValue = $0.0, FaceValuePoint = 0, SortKind = 0, IsEmissive = false, CFI = "";

    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_IssuerName, t_Issuer, t_IssuerCountryCode, t_FIID, t_code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, "
                        +" t_FaceValueFiCode, t_FaceValuePoint, t_Sort, T_PARENTKINDAVR "
                        +"  FROM d711Part3_tmp WHERE t_Module = 'D'");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      Issuer            = dataSet.Issuer;
      IssuerName        = dataSet.IssuerName;
      IssuerINN         = dataSet.IssuerINN;
      IssuerINN_Mark    = "";
      IssuerINN_TIN     = "";
      IssuerNotResCode  = "";
      IssuerKPP         = "";
      IssuerCountryCode = dataSet.IssuerCountryCode;
      Code711           = dataSet.Code711;
      LSIN              = dataSet.LSIN;
      ISIN              = dataSet.ISIN;
      FaceValueFiCode   = dataSet.FaceValueFiCode;
      FaceValue         = dataSet.FaceValue;
      FaceValuePoint    = dataSet.FaceValuePoint;
      SortKind          = dataSet.Sort;

      count = count + 1;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)

        if (pt.rec.LegalForm == PTLEGF_PERSN)
          if (DataSet.ParentKindAvr == AVOIRISSKIND_MORTGAGE)
            SortKind = PHYSMORT_SORT; // закладная юрика
          end;
          //IssuerName = "Физические лица";
          IssuerCountryCode = tools.GetCountryCode(pt);
          if (IssuerCountryCode == {ResidentCountryCodeNum})
            IssuerINN = tools.UNKNOW_INN_RES_PHYS;
            IssuerINN_Mark = 3;
          else
            IssuerINN = tools.UNKNOW_INN_NOTRES_PHYS;
            IssuerINN_Mark = 4;
          end;
        else
          if (DataSet.ParentKindAvr == AVOIRISSKIND_MORTGAGE)
            SortKind = YURMORT_SORT; // закладная юрика
          end;
          IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
          tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotResCode);
          IssuerCountryCode = tools.GetCountryCode(pt);
          IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);
        end;
      end;

      // Выпуск
      var Avoiriss = TRecHandler( "avoiriss.dbt" );
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if ((dataSet.FIID != -1) and (ПолучитьФинИн(dataSet.FIID, Fininstr, Avoiriss) == 0))
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
          ISIN = "";
        elif (not IsEmissive)
          LSIN = "";
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

      if((IssuerCountryCode != "") AND (IssuerCountryCode != "643"))
        LSIN = "";
      end;

      if(Code711 == "DR") // депозитарная расписка
        LSIN = tools.GetLSINDEPO(dataSet.FIID);
      end;

      queryUpd = "UPDATE d711Part3_tmp SET "
                + " t_Issuer = " + String(Issuer)  + ", "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + IIF(FaceValue==$0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint) + ","
                + " t_Sort =" + String(SortKind) + ","
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных Депозитария, " + String(count), false );
    end;
  end;

  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);
    var UsedSecurModule = SP_CheckLicence();
    var depoMode = 0;

    var workWithDepo; //Работаем с депозитарием
    var isQDA; //Ведём квазидепозитарный учет
    GetRegistryValue("COMMON\\WORK_MODE\\WORK_WITH_DEPOSITARY", V_BOOL, workWithDepo);
    GetRegistryValue("SECUR\\ВЕДЕНИЕ КДУ", V_BOOL, isQDA);

    if ( (workWithDepo == true) and (isQDA == false))
      depoMode = 1;
    elif ( (workWithDepo == false) and (isQDA == true) )
      depoMode = 2;
    else
      depoMode = 0;
    end;

    if(depoMode != 1)
      return;
    end;

    query = "INSERT INTO d711Part3_tmp (T_ACCOUNTID,"
                                     + "T_ISSUER,"
                                     + "T_ISSUERNAME,"
                                     + "T_ISSUERINN,"
                                     + "T_ISSUERKPP,"
                                     + "T_ISSUEROGRN,"
                                     + "T_ISSUERCOUNTRYCODE,"
                                     + "T_ISSUERINN_MARK,"
                                     + "T_ISSUERINN_TIN,"
                                     + "T_ISSUERNOTRESCODE,"
                                     + "T_FIID,"
                                     + "T_CODE711,"
                                     + "T_LSIN,"
                                     + "T_ISIN,"
                                     + "T_FACEVALUEFICODE,"
                                     + "T_FACEVALUE,"
                                     + "T_FACEVALUEPOINT,"
                                     + "T_SALEREPOAMOUNT,"      //202
                                     + "T_TRANSLOANAMOUNT,"     //203
                                     + "T_BUYREPOAMOUNT,"       //204
                                     + "T_ISCOMPDELIVERY,"
                                     + "T_ACCEPTLOANAMOUNT,"    //205
                                     + "T_TRANSDUAMOUNT,"       //206
                                     + "T_TRANSRIGHTSDUAMOUNT, "//207 226 230
                                     + "T_TRANSPLEDGEBOAMOUNT," //208 227 231
                                     + "T_TRANSPLEDGEAMOUNT,"   //209 228 232
                                     + "T_ACCEPTPLEDGEAMOUNT,"  //210     233
                                     + "T_MODULE,"
                                     + "T_NUMBER,"
                                     + "T_TYPEAVR, "
                                     + "T_PARENTKINDAVR,"
                                     + "T_NAMEAVR,"
                                     + "T_SORT,"
                                     + "T_CORPRESTRAMOUNT,"  //212
                                     + "T_OPERBANAMOUNT,"    //213
                                     + "T_ARRESTAMOUNT,"     //214
                                     + "T_TRADEAMOUNT,"   //211
                                     + "T_TRANSLOANCONTR,"
                                     + "T_ACCEPTLOANCONTR)"
          // Эмиссионные ЦБ
          + "(SELECT acc.t_AccountID, "
          + "        issuer.t_Issuer,"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (issuer.t_Issuer, 16),"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (issuer.t_Issuer, 27),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        avr.t_FIID,"
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_AVOIRISS, "lpad(to_char(avr.t_FIID), 10, '0')")
          + "        avr.T_LSIN,"
          + "        avr.T_ISIN,"
          + "        NVL ( (SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR (1)),"
          + "        NVL(rsb_fiinstr.FI_GetNominalOnDate (avr.t_FIID,"+RepDateSQL+"),0.0),"
          + "        fin.T_POINT + 2,"
          + "        0,"
          + "        0,"
          + IIF(UsedSecurModule == false,
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (204,227) THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END",
            "        0 "
               ) + ", " //  T_BUYREPOAMOUNT
          + "        0, "
          + IIF(UsedSecurModule == false,
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (205,228) THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END",
            "        0 "
               ) + ", " //  T_ACCEPTLOANAMOUNT
          + "        0,"

          + IIF( (depoMode == 1),
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (207,230) THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END,","  0, ") //230
          + IIF( (depoMode == 1),
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (208,231) THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END,","  0, ") //231
          + IIF( (depoMode == 1),
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (209,232) THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END,","  0, ") //232

          + "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (210,233) THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END," //233
          + "        'D',"
          + "        dacntPart.t_BriefCode,"
          + "        avrKinds.t_Name,"
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND),"
          + "        fin.t_Name,"
          +          EMISS_SORT+", "
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        CHR(1)," //T_TRANSLOANCONTR
          + "        rsb_secur.GetObjAttrNumber("+OBJTYPE_PARTY+", 61, rsb_secur.GetMainObjAttr("+OBJTYPE_PARTY+", LPAD(acc.t_client, 10, '0'), 61, "+RepDateSQL+")) "  //T_ACCEPTLOANCONTR
          + "   FROM davoiriss_dbt avr, dfininstr_dbt fin, ddepoacnt_dbt dacntPart, ddepoacnt_dbt dacntRoot, ddepoac_dbt dpac, dnotetext_dbt note, daccount_dbt acc, davrkinds_dbt avrKinds,"
          + "        (SELECT CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = 10"
          + "                     THEN (SELECT finParent.t_Issuer FROM dfininstr_dbt finParent WHERE finParent.t_FIID = fin2.t_ParentFI)"
          + "                     ELSE fin2.t_Issuer"
          + "                END AS t_Issuer,"
          + "                fin2.t_FIID"
          + "           FROM dfininstr_dbt fin2) issuer "
          + "  WHERE dacntPart.t_Kind = 2 " //Пассивный
          + "    AND dacntPart.t_autoKey != dacntPart.t_root"
          + "    AND dacntPart.t_department IN ("+fltr.Departments+")"
          + "    AND note.t_objecttype = 122"  // OBJTYPE_DEPOPART
          + "    AND note.t_notekind = 1" // Графа 711-й формы
          + "    AND note.t_documentid = dacntPart.t_AutoKey"
          + "    AND note.t_Date <= "+RepDateSQL
          + "    AND note.t_ValidToDate >= "+RepDateSQL
          + "    AND dacntRoot.t_AutoKey = dacntPart.t_root "
          + "    AND dpac.t_ID = dacntRoot.t_Type "
          + "    AND acc.t_DepoAcc = dacntPart.t_AutoKey"
          + "    AND rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL) != 0"
          + "    AND INSTR (acc.t_Type_Account, 'I') = 0"
          + "    AND fin.t_FIID = avr.t_FIID"
          + "    AND issuer.t_FIID = avr.t_fiid"
          + "    AND avr.t_FIID = acc.t_Code_Currency"
          + "    AND avrKinds.t_FI_Kind = 2"
          + "    AND avrKinds.t_AvoirKind = fin.t_AvoirKind)"
          + " UNION ALL "
          // Эмиссионные залоговые ЦБ на счете с незаполненным примечанием для граф 208 (231) и 210 (233)
          + "(SELECT DISTINCT acc.t_AccountID, "
          + "        issuer.t_Issuer,"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (issuer.t_Issuer, 16),"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (issuer.t_Issuer, 27),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        avr.t_FIID,"
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_AVOIRISS, "lpad(to_char(avr.t_FIID), 10, '0')")
          + "        avr.T_LSIN,"
          + "        avr.T_ISIN,"
          + "        NVL ( (SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = fin.T_FACEVALUEFI), CHR (1)),"
          + "        NVL(rsb_fiinstr.FI_GetNominalOnDate (avr.t_FIID,"+RepDateSQL+"),0.0),"
          + "        fin.T_POINT + 2,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0," //230
          + IIF( (depoMode == 1),
            "        CASE WHEN dacntPart.t_Owner = "+{OurBank}+" AND acap.t_APartyID <> "+{OurBank}+" THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END,", " 0, ") //231
          + "        0," //232
          + "        CASE WHEN dacntPart.t_Owner <> "+{OurBank}+" AND acap.t_APartyID = "+{OurBank}+" THEN ABS(rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL)) ELSE 0 END," //233
          + "        'D',"
          + "        dacntPart.t_BriefCode,"
          + "        avrKinds.t_Name,"
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND),"
          + "        fin.t_Name,"
          +          EMISS_SORT+", "
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        CHR(1),"                                                         //T_TRANSLOANCONTR
          + "        CHR(1) "                                                         //T_ACCEPTLOANCONTR
          + "   FROM davoiriss_dbt avr, dfininstr_dbt fin, ddepoacnt_dbt dacntRoot, ddepoacnt_dbt dacntPart, ddepoac_dbt dpac, daccount_dbt acc, davrkinds_dbt avrKinds, ddpacap_dbt acap, ddepoatvl_dbt atvl, "
          + "        (SELECT CASE WHEN RSI_RSB_FIInstr.fi_avrkindsgetroot (2, fin2.t_AvoirKind) = 10"
          + "                     THEN (SELECT finParent.t_Issuer FROM dfininstr_dbt finParent WHERE finParent.t_FIID = fin2.t_ParentFI)"
          + "                     ELSE fin2.t_Issuer"
          + "                END AS t_Issuer,"
          + "                fin2.t_FIID"
          + "           FROM dfininstr_dbt fin2) issuer "
          + "  WHERE dacntPart.t_Kind = 2 " //Пассивный
          + "    AND dacntPart.t_autoKey != dacntPart.t_root"
          + "    AND dacntPart.t_department IN ("+fltr.Departments+")"
          + "    AND dacntRoot.t_AutoKey = dacntPart.t_root "
          + "    AND dpac.t_ID = dacntRoot.t_Type "
          + "    AND acc.t_DepoAcc = dacntPart.t_AutoKey"
          + "    AND acap.t_ApNodeID = dacntPart.t_root "
          + "    AND acap.t_Role = " + DEPOACAPROLE_MORTGAGEE
          + "    AND acap.t_FromDate <= " + RepDateSQL
          + "    AND (acap.t_ToDate >= " + RepDateSQL + " or acap.t_ToDate = " + GetSQLDate(date(0,0,0)) + ") "
          + "    AND ((acap.t_APartyID = "+{OurBank}+" and dacntPart.t_Owner <> "+{OurBank}+") or (acap.t_APartyID <> "+{OurBank}+" and dacntPart.t_Owner = "+{OurBank}+"))"
          + "    AND atvl.t_ID = dacntPart.t_AutoKey "
          + "    AND atvl.t_IsType = CHR(0) "
          + "    AND atvl.t_AttrNum = 15 " //документ залога
          + "    AND TO_CHAR(acap.t_APartyGround) = atvl.t_Value "
          + "    AND Not Exists(SELECT 1 "
          + "                     FROM dnotetext_dbt note "
          + "                    WHERE note.t_objecttype = 122"  // OBJTYPE_DEPOPART
          + "                      AND note.t_notekind = 1" // Графа 711-й формы
          + "                      AND note.t_documentid = dacntPart.t_AutoKey"
          + "                      AND note.t_Date <= "+RepDateSQL
          + "                      AND note.t_ValidToDate >= "+RepDateSQL
          + "                      AND rsb_struct.getInt(TO_BLOB (note.t_text)) > 0"
          + "                  )"
          + "    AND rsi_rsb_account.restac(acc.t_Account,acc.T_CODE_CURRENCY,"+RepDateSQL+",acc.t_Chapter,NULL) != 0"
          + "    AND INSTR (acc.t_Type_Account, 'I') = 0"
          + "    AND fin.t_FIID = avr.t_FIID"
          + "    AND issuer.t_FIID = avr.t_fiid"
          + "    AND avr.t_FIID = acc.t_Code_Currency"
          + "    AND avrKinds.t_FI_Kind = 2"
          + "    AND avrKinds.t_AvoirKind = fin.t_AvoirKind)"
          + " UNION ALL "
          // Неэмиссионные ЦБ
          + "(SELECT acc.t_AccountID, "
          + "        rsb_deals.GetFicertIssuer (ficert.t_FiCertID),"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (rsb_deals.GetFicertIssuer (ficert.t_FiCertID), 16),"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (rsb_deals.GetFicertIssuer (ficert.t_FiCertID), 27),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        -1,"
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_FICERT, "lpad(to_char(ficert.t_FiCertID), 10, '0')")
          + "        CHR (1),"
          + "        CHR (1),"
          + "        NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = ficert.t_FaceValueFI), CHR (1)),"
          + "        ficert.t_FaceValue,"
          + "        2,"
          + "        0,"
          + "        0,"
          + IIF(UsedSecurModule == false,
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (204,227) THEN ficert.t_Copies ELSE 0 END",
            "        0 "
               ) + ", " //  T_BUYREPOAMOUNT
          + "        0, "
          + IIF(UsedSecurModule == false,
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (205,228) THEN ficert.t_Copies ELSE 0 END",
            "        0 "
               ) + ", " //  T_ACCEPTLOANAMOUNT
          + "        0,"
          + IIF( (depoMode ==1),
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (207,230) THEN ficert.t_Copies ELSE 0 END,", " 0, ") //230
          + IIF( (depoMode ==1),
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (208,231) THEN ficert.t_Copies ELSE 0 END,", " 0, ") //231
          + IIF( (depoMode ==1),
            "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (209,232) THEN ficert.t_Copies ELSE 0 END,", " 0, ") //232
          + "        CASE WHEN rsb_struct.getInt(TO_BLOB(note.t_text)) IN (210,233) THEN ficert.t_Copies ELSE 0 END," //233
          + "        'D',"
          + "        dacntPart.t_BriefCode,"
          + "        avrKinds.t_Name,"
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND),"
          + "        fin.t_Name,"
          +          NOTEMISS_SORT+", "
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        CHR(1),"                                                         //T_TRANSLOANCONTR
          + "        rsb_secur.GetObjAttrNumber("+OBJTYPE_PARTY+", 61, rsb_secur.GetMainObjAttr("+OBJTYPE_PARTY+", LPAD(acc.t_client, 10, '0'), 61, "+RepDateSQL+")) " //T_ACCEPTLOANCONTR
          + "   FROM ddepoacnt_dbt dacntPart, ddepoacnt_dbt dacntRoot, ddepoac_dbt dpac, dnotetext_dbt note, daccount_dbt acc, dinvcard_dbt invc, dv_ficert_dbt ficert, davrkinds_dbt avrKinds, dfininstr_dbt fin"
          + "  WHERE dacntPart.t_Kind = 2 " //Пассивный
          + "    AND dacntPart.t_autoKey != dacntPart.t_root"
          + "    AND dacntPart.t_department IN ("+fltr.Departments+")"
          + "    AND note.t_objecttype = 122"  // OBJTYPE_DEPOPART
          + "    AND note.t_notekind = 1" // Графа 711-й формы
          + "    AND note.t_documentid = dacntPart.t_AutoKey"
          + "    AND note.t_Date <= "+RepDateSQL
          + "    AND note.t_ValidToDate >= "+RepDateSQL
          + "    AND dacntRoot.t_AutoKey = dacntPart.t_root "
          + "    AND acc.t_DepoAcc = dacntPart.t_AutoKey"
          + "    AND dpac.t_ID = dacntRoot.t_Type "
          + "    AND INSTR (acc.t_Type_Account, 'I') != 0"
          + "    AND ficert.t_FIID = acc.t_Code_Currency"
          + "    AND invc.t_FICertID = ficert.t_FICertID"
          + "    AND rsb_depo. icstatus (invc.t_InvCardID, "+RepDateSQL+") = 2"
          + "    AND acc.t_AccountID = rsb_depo.icaccountid( invc.t_InvCardID, DECODE(acc.T_KIND_ACCOUNT,'А', 1, 0), "+RepDateSQL+")"
          + "    AND fin.t_FIID = ficert.t_FIID"
          + "    AND avrKinds.t_FI_Kind = fin.t_FI_Kind"
          + "    AND avrKinds.t_AvoirKind = ficert.t_AvoirKind "
          + "    AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", ficert.t_AvoirKind) = 0)"
          + " UNION ALL "
          // Неэмиссионные залоговые ЦБ на счете с незаполненным примечанием для граф 208 (231) и 210 (233)
          + "(SELECT acc.t_AccountID, "
          + "        rsb_deals.GetFicertIssuer (ficert.t_FiCertID),"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (rsb_deals.GetFicertIssuer (ficert.t_FiCertID), 16),"
          + "        CHR (1),"
          + "        rsi_rsbparty.GetPartyCode (rsb_deals.GetFicertIssuer (ficert.t_FiCertID), 27),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        CHR (1),"
          + "        -1,"
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_FICERT, "lpad(to_char(ficert.t_FiCertID), 10, '0')")
          + "        CHR (1),"
          + "        CHR (1),"
          + "        NVL((SELECT T_ISO_Number FROM dfininstr_dbt WHERE T_FIID = ficert.t_FaceValueFI), CHR (1)),"
          + "        ficert.t_FaceValue,"
          + "        2,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0," //230
          + IIF( ( depoMode == 1),
            "        CASE WHEN dacntPart.t_Owner = "+{OurBank}+" AND acap.t_APartyID <> "+{OurBank}+" THEN ficert.t_Copies ELSE 0 END,", " 0, ")//231
          + "        0," //232
          + "        CASE WHEN dacntPart.t_Owner <> "+{OurBank}+" AND acap.t_APartyID = "+{OurBank}+" THEN ficert.t_Copies ELSE 0 END," //233
          + "        'D',"
          + "        dacntPart.t_BriefCode,"
          + "        avrKinds.t_Name,"
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot(2, avrKinds.T_AVOIRKIND),"
          + "        fin.t_Name,"
          +          NOTEMISS_SORT+", "
          + "        0,"
          + "        0,"
          + "        0,"
          + "        0,"
          + "        CHR(1),"                                                         //T_TRANSLOANCONTR
          + "        CHR(1) "                                                         //T_ACCEPTLOANCONTR
          + "   FROM ddepoacnt_dbt dacntPart, ddepoacnt_dbt dacntRoot, ddepoac_dbt dpac, daccount_dbt acc, dinvcard_dbt invc, dv_ficert_dbt ficert, davrkinds_dbt avrKinds, dfininstr_dbt fin, ddpacap_dbt acap, ddepoatvl_dbt atvl"
          + "  WHERE dacntPart.t_Kind = 2 " //Пассивный
          + "    AND dacntPart.t_autoKey != dacntPart.t_root"
          + "    AND dacntPart.t_department IN ("+fltr.Departments+")"
          + "    AND dacntRoot.t_AutoKey = dacntPart.t_root "
          + "    AND dpac.t_ID = dacntRoot.t_Type "
          + "    AND acc.t_DepoAcc = dacntPart.t_AutoKey"
          + "    AND acap.t_ApNodeID = dacntPart.t_root "
          + "    AND acap.t_Role = " + DEPOACAPROLE_MORTGAGEE
          + "    AND acap.t_FromDate <= " + RepDateSQL
          + "    AND (acap.t_ToDate >= " + RepDateSQL + " or acap.t_ToDate = " + GetSQLDate(date(0,0,0)) + ") "
          + "    AND ((acap.t_APartyID = "+{OurBank}+" and dacntPart.t_Owner <> "+{OurBank}+") or (acap.t_APartyID <> "+{OurBank}+" and dacntPart.t_Owner = "+{OurBank}+"))"
          + "    AND atvl.t_ID = dacntPart.t_AutoKey "
          + "    AND atvl.t_IsType = CHR(0) "
          + "    AND atvl.t_AttrNum = 15 " //документ залога
          + "    AND TO_CHAR(acap.t_APartyGround) = atvl.t_Value "
          + "    AND Not Exists(SELECT 1 "
          + "                     FROM dnotetext_dbt note "
          + "                    WHERE note.t_objecttype = 122"  // OBJTYPE_DEPOPART
          + "                      AND note.t_notekind = 1" // Графа 711-й формы
          + "                      AND note.t_documentid = dacntPart.t_AutoKey"
          + "                      AND note.t_Date <= "+RepDateSQL
          + "                      AND note.t_ValidToDate >= "+RepDateSQL
          + "                      AND rsb_struct.getInt(TO_BLOB (note.t_text)) > 0"
          + "                  )"
          + "    AND INSTR (acc.t_Type_Account, 'I') != 0"
          + "    AND ficert.t_FIID = acc.t_Code_Currency"
          + "    AND invc.t_FICertID = ficert.t_FICertID"
          + "    AND rsb_depo. icstatus (invc.t_InvCardID, "+RepDateSQL+") = 2"
          + "    AND acc.t_AccountID = rsb_depo.icaccountid( invc.t_InvCardID, DECODE(acc.T_KIND_ACCOUNT,'А', 1, 0), "+RepDateSQL+")"
          + "    AND fin.t_FIID = ficert.t_FIID"
          + "    AND avrKinds.t_FI_Kind = fin.t_FI_Kind"
          + "    AND avrKinds.t_AvoirKind = ficert.t_AvoirKind "
          + "    AND RSB_FIInstr.FI_AvrKindsEQ(" + FIKIND_AVOIRISS + ", " + AVOIRISSKIND_BILL + ", ficert.t_AvoirKind) = 0)";

    //println("Депозитарий: " + query);
    SQL_Execute(query, "Сбор данных модуля Депозитарий", true );

    PostProcess();
  end;
end;

/* ********************************************** */
/* Класс сбора данных на по модулю УВ             */
/* ********************************************** */
private class CVekselData(_fltr)
  private var fltr = _fltr;
  private var tools = C_711Tools;

  /*Постобработка (дозаполнение полей)*/
  private macro PostProcess()
    var cmd, dataSet, queryUpd = "";
    var pt:TRecHandler;
    var count = 0;
    var IssuerName = "", IssuerINN = "", IssuerINN_Mark = "", IssuerINN_TIN = "", IssuerNotResCode = "", IssuerKPP = "", IssuerCountryCode = "", LSIN = "", ISIN = "",
        Code711 = "", FaceValueFiCode = "", FaceValue = $0.0, FaceValuePoint = 0, IsEmissive = false, CFI = "";

    cmd = DL_RSDCommand( "SELECT t_AutoKey, t_IssuerName, t_Issuer, t_IssuerCountryCode, t_FIID, t_code711, t_IssuerINN, t_LSIN, t_ISIN, t_FaceValue, t_FaceValueFiCode, t_FaceValuePoint "
                        +"  FROM d711Part3_tmp WHERE t_Module = 'V'");

    dataSet = cmd.Execute();
    while (dataSet.moveNext())
      IssuerName              = dataSet.IssuerName;
      IssuerINN               = dataSet.IssuerINN;
      IssuerINN_Mark          = "";
      IssuerINN_TIN           = "";
      IssuerNotResCode        = "";
      IssuerKPP               = "";
      IssuerCountryCode       = dataSet.IssuerCountryCode;
      Code711                 = dataSet.Code711;
      LSIN                    = dataSet.LSIN;
      ISIN                    = dataSet.ISIN;
      FaceValueFiCode         = dataSet.FaceValueFiCode;
      FaceValue               = dataSet.FaceValue;
      FaceValuePoint          = dataSet.FaceValuePoint;

      count = count + 1;

      pt = TRecHandler("party.dbt");
      // Эмитент
      if (ПолучитьСубъекта(dataSet.Issuer, pt) == 0)
        IssuerName = tools.GetIssuerName(pt, dataSet.FIID);
        tools.SplitINN_KPP(pt, IssuerINN, @IssuerINN, @IssuerKPP, @IssuerINN_TIN, @IssuerNotResCode);
        IssuerCountryCode = tools.GetCountryCode(pt);
        IssuerINN_Mark = tools.GetIssuerINN_Mark(pt);
      end;

      // Выпуск
      var Avoiriss = TRecHandler( "avoiriss.dbt" );
      var Fininstr = TRecHandler( "fininstr.dbt" );
      if ((dataSet.FIID != -1) and (ПолучитьФинИн(dataSet.FIID, Fininstr, Avoiriss) == 0))
        IsEmissive = tools.IsEmissive(Fininstr.rec.AvoirKind);
        if ((Code711 == "SHS7") or (Code711 == "SHS71") or (Code711 == "SHS8"))
          LSIN = tools.CorrectLSINInvst(dataSet.FIID, LSIN);
          ISIN = "";
        elif (not tools.IsEmissive(Fininstr.rec.AvoirKind))
          LSIN = "";
          ISIN = "";
        end;

        if (IsEmissive) //для эмиссионной заполняем код ЦФИ (18) (в том числе деп. расписки, т.к. они эмиссионные)
          CFI = tools.GetCFI(dataSet.FIID);
        end;
        tools.CorrectFaceValue(Code711, @FaceValue, @FaceValueFiCode, @FaceValuePoint);
      end;

      queryUpd = "UPDATE d711Part3_tmp SET "
                + " t_IssuerName = " + tools.GetSQLStr(IssuerName) + ", "
                + " t_IssuerINN = " + tools.GetSQLStr(IssuerINN) + ", "
                + " t_IssuerINN_Mark = " + tools.GetSQLStr(IssuerINN_Mark) + ", "
                + " t_IssuerINN_TIN = " + tools.GetSQLStr(IssuerINN_TIN) + ", "
                + " t_IssuerNotResCode = " + tools.GetSQLStr(IssuerNotResCode) + ", "
                + " t_IssuerKPP = " + tools.GetSQLStr(IssuerKPP) + ", "
                + " t_IssuerCountryCode = " + tools.GetSQLStr(IssuerCountryCode) + ", "
                + " t_LSIN = " + tools.GetSQLStr(LSIN) + ", "
                + " t_ISIN = " + tools.GetSQLStr(ISIN) + ", "
                + " t_FaceValueFiCode = " + tools.GetSQLStr(FaceValueFiCode) + ", "
                + IIF(FaceValue==$0.0, " t_FaceValue =" + FaceValue + ", ", "" )  // обновляем только если были изменения (обнулили)
                + " t_FaceValuePoint =" + String(FaceValuePoint)+ ","
                + " t_CFI =" + tools.GetSQLStr(CFI)
                + " WHERE t_AutoKey = " + DataSet.t_AutoKey;

      SQL_Execute(queryUpd, "Обновление информации о данных УВ, " + String(count), false );
    end;
  end;

  macro PrepareData()
    var query, cmd;
    var RepDateSQL = GetSQLDate(fltr.RepDate);

    query = "INSERT INTO d711Part3_tmp (T_ISSUER,"
                                     + "T_ISSUERNAME,"
                                     + "T_ISSUERINN,"
                                     + "T_ISSUERKPP,"
                                     + "T_ISSUEROGRN,"
                                     + "T_ISSUERCOUNTRYCODE,"
                                     + "T_ISSUERINN_MARK,"
                                     + "T_ISSUERINN_TIN,"
                                     + "T_ISSUERNOTRESCODE,"
                                     + "T_FIID,"
                                     + "T_CODE711,"
                                     + "T_LSIN,"
                                     + "T_ISIN,"
                                     + "T_FACEVALUEFICODE,"
                                     + "T_FACEVALUE,"
                                     + "T_FACEVALUEPOINT,"
                                     + "T_SALEREPOAMOUNT,"
                                     + "T_TRANSLOANAMOUNT,"
                                     + "T_BUYREPOAMOUNT,"
                                     + "T_ISCOMPDELIVERY,"
                                     + "T_ACCEPTLOANAMOUNT,"
                                     + "T_TRANSDUAMOUNT,"
                                     + "T_TRANSRIGHTSDUAMOUNT, "
                                     + "T_TRANSPLEDGEBOAMOUNT,"
                                     + "T_TRANSPLEDGEAMOUNT,"
                                     + "T_ACCEPTPLEDGEAMOUNT,"
                                     + "T_MODULE,"
                                     + "T_NUMBER,"
                                     + "T_TYPEAVR,"
                                     + "T_PARENTKINDAVR,"
                                     + "T_NAMEAVR,"
                                     + "T_SORT, "
                                     + "T_TRADEAMOUNT, "
                                     + "T_CORPRESTRAMOUNT, "
                                     + "T_OPERBANAMOUNT, "
                                     + "T_ARRESTAMOUNT,"
                                     + "T_TRANSLOANCONTR,"
                                     + "T_ACCEPTLOANCONTR)"
          + "(SELECT bnr.t_Issuer,"                                                 // T_ISSUER
          + "        CHR(1),"                                                       // T_ISSUERNAME
          + "        rsi_rsbparty.GetPartyCode(bnr.t_Issuer, 16),"                  // T_ISSUERINN
          + "        CHR(1),"                                                       // T_ISSUERKPP
          + "        rsi_rsbparty.GetPartyCode(bnr.t_Issuer, 27),"                  // T_ISSUEROGRN
          + "        CHR(1),"                                                       // T_ISSUERCOUNTRYCODE
          + "        CHR(1),"                                                       // T_ISSUERINN_MARK
          + "        CHR(1),"                                                       // T_ISSUERINN_TIN
          + "        CHR(1),"                                                       // T_ISSUERNOTRESCODE
          + "        -1,"                                                           // T_FIID
          +          GetSelectSubQueryCode711(RepDateSQL, OBJTYPE_FICERT, "lpad(to_char(ficert.t_FiCertID), 10, '0')") // T_CODE711
          + "        CHR(1),"                                                       // T_LSIN
          + "        CHR(1),"                                                       // T_ISIN
          + "        fvfin.t_ISO_NUmber,"                                           // T_FACEVALUEFICODE
          + "        legCert.t_Principal,"                                          // T_FACEVALUE
          + "        2,"                                                            // T_FACEVALUEPOINT
          + "        0,"                                                            // T_SALEREPOAMOUNT
          + "        0,"                                                            // T_TRANSLOANAMOUNT
          + "        0,"                                                            // T_BUYREPOAMOUNT
          + "        0,"                                                            // T_ISCOMPDELIVERY
          + "        0,"                                                            // T_ACCEPTLOANAMOUNT
          + "        0,"                                                            // T_TRANSDUAMOUNT
          + "        0,"                                                            // T_TRANSRIGHTSDUAMOUNT
          + "        DECODE(oprkop.t_SysTypes, 'S', leg.t_Principal, 0),"           // T_TRANSPLEDGEBOAMOUNT
          + "        0,"                                                            // T_TRANSPLEDGEAMOUNT
          + "        DECODE(oprkop.t_SysTypes, 'B', leg.t_Principal, 0),"           // T_ACCEPTPLEDGEAMOUNT
          + "        'V',"                                                          // T_MODULE
          + "        tick.t_DealCode,"                                              // T_NUMBER
          + "        avrKinds.t_Name,"                                              // T_TYPEAVR
          + "        RSI_RSB_FIInstr.fi_avrkindsgetroot (2, avrKinds.T_AVOIRKIND)," // T_PARENTKINDAVR
          + "        fin.t_Name,"                                                   // T_NAMEAVR
          +          NOTEMISS_SORT+","                                              // T_SORT
          + "        0, "                                                           // T_TRADEAMOUNT
          + "        0, "                                                           // T_CORPRESTRAMOUNT
          + "        0, "                                                           // T_OPERBANAMOUNT
          + "        0,  "                                                          // T_ARRESTAMOUNT
          + "        CHR(1), "                                                      //T_TRANSLOANCONTR
          + "        CHR(1) "                                                       //T_ACCEPTLOANCONTR
          + "  FROM dvsbanner_dbt bnr, dvsordlnk_dbt lnk, ddl_tick_dbt tick, doprkoper_dbt oprkop,  ddl_leg_dbt leg, ddl_leg_dbt legCert,"
          + "       davrkinds_dbt avrKinds, dfininstr_dbt fin, dficert_dbt ficert, dfininstr_dbt fvfin"
          + " WHERE bnr.t_RegistrationDate <= "+RepDateSQL
          + "   AND bnr.t_BCFormKind = 2" // VSBANNER_FORMKIND_CERT сертификат
          + "   AND bnr.t_Department IN ("+fltr.Departments+")"
          + "   AND (instr(rsb_bill.GetVABnrStateOnDate(bnr.t_BCID,"+RepDateSQL+"), 'Н') != 0" // передан в залог
            + "   OR instr(rsb_bill.GetVABnrStateOnDate(bnr.t_BCID,"+RepDateSQL+"), 'З') != 0)" // принят в залог
          + "   AND lnk.t_BCID = bnr.t_BCID"
          + "   AND lnk.t_DocKind = 143 " // DL_VAPAWN
          + "   AND lnk.t_InterestChargeDate <= "+RepDateSQL
          + "   AND legCert.t_LegKind = 1 " // LEG_KIND_VSBANNER - Ценовые условия векселя
          + "   AND legCert.t_DealID = bnr.t_BCID "
          + "   AND legCert.t_LegID = 0"
          + "   AND fvfin.t_FIID = legCert.t_PFI"
          + "   AND leg.t_LegKind = 0"
          + "   AND leg.t_DealID = tick.t_DealID "
          + "   AND leg.t_LegID = 0"
          + "   AND tick.t_DealID = lnk.t_ContractID"
          + "   AND oprkop.t_Kind_Operation = tick.t_DealType"
          // статус <Передан в залог> (для всех контрагентов) или <Принят в залог> (только если контрагент по договору залога является клиентом нашего банка).
          + "   AND (oprkop.t_SysTypes = 'S' OR " // передан в залог
          + "        (oprkop.t_SysTypes = 'B'and EXISTS (SELECT 1 FROM dpartyown_dbt WHERE t_PartyID = tick.t_PartyID AND T_PartyKind = 1)) )" // принят в залог и контрагент наш клиент
          + "   AND fin.t_FIID = bnr.t_FIID "
          + "   AND ficert.t_AvoirKind = fin.t_AvoirKind "
          + "   AND ficert.t_CertID = bnr.t_BCID "
          + "   AND avrKinds.t_FI_Kind = fin.t_FI_Kind"
          + "   AND avrKinds.t_AvoirKind = ficert.t_AvoirKind"
          // отбираются только такие договора, по которым было сформировано поручение вида <Снятие с хранения>, либо поручение депо не было сформировано вообще
          + IIF(index(fltr.RepModule, DEPO_MODULE)==0, "",
                   "    AND NOT EXISTS (SELECT 1 "
                 + "                      FROM dpmpaym_dbt pm, dspdrprop_dbt sprop, dspdraft_dbt draft"
                 + "                     WHERE pm.t_DocKind = tick.t_BOfficeKind "
                 + "                       AND pm.t_DocumentID = tick.t_DealID "
                 + "                       AND sprop.t_PaymentID = pm.t_PaymentID "
                 + "                       AND draft.t_AutoKey  = sprop.t_DraftID"
                 + "                       AND draft.t_Kind != 845)" // SP_DEPOPER_WITHDRORDER
                     ) //
          + " )";

    //println("Учтенные векселя: " + query);
    SQL_Execute(query, "Сбор данных модуля Учтенные векселя", true );

    PostProcess();
  end;
end;
/* ********************************************** */
/* Клас данных 711 формы для отчета               */
/* ********************************************** */
class CDataReport(_RepDate)
  private var DataRec = null;
  private var RepDate = _RepDate;

  var ЭмитентНаименование:string   = "",   // Наименование эмитента
      ЭмитентИНН:string            = "",   // ИНН эмитента
      ЭмитентКПП:string            = "",   // КПП эмитента
      ЭмитентОГРН:string           = "",   // ОГРН эмитента
      ЭмитентОКСМ:string           = "",   // ОКСМ эмитента
      ЭмитентИНН_TIN:string        = "",   // для ИНН TIN - эмитента
      ПризнакКодаЭмНерез:string    = "",   // Признак кода нерезидента эмитента
      ЭмитентИНН_Признак:string    = "",   // для ИНН признак эмитента
      ЦБКодТипа:string             = "",   // Код ц/б для Ф711
      ЦБНомерГосРег:string         = "",   // Номер гос. рег. ц/б
      ЦБISIN:string                = "",   // ISIN ц/б
      ЦБВалюта:string              = "",   // Код валюты номинала ц/б
      ЦБНоминал:numeric            = $0.0, // Номинал ц/б
      ЦБНоминалТочность:integer    = 0,    // Точность номинала ц/б
      ЦБ_Переданы_ПРЕПО:numeric    = $0.0, // Ц/б, переданные по сделкам прямого репо
      ЦБ_Переданы_Займ:numeric     = $0.0, // Ц/б, переданные по сделкам займа
      ЦБ_Получены_ОРЕПО:numeric    = $0.0, // Ц/б, полученные по сделкам обратного репо
      ЦБ_Получены_Займ:numeric     = $0.0, // Ц/б, полученные по сделкам займа
      ЦБ_Переданы_ДУ:numeric       = $0.0, // Ц/б, переданные в доверительное управление
      ЦБ_ПраваПереданы_ДУ:numeric  = $0.0, // Ц/б, права из которых переданы в доверительное управление
      ЦБ_Переданы_Залог_КО:numeric = $0.0, // Ц/б, переданные в залог по обязательствам кредитной организации
      ЦБ_Переданы_Залог:numeric    = $0.0, // Ц/б, переданные в залог по обязательствам третьих лиц
      ЦБ_Приняты_Залог:numeric     = $0.0, // Ц/б, принятые в залог
      ЦБ_Раздел3_Примечание:string = "",   // Примечание
      ТогрСчета:numeric            = $0.0, // Ц/б на торговых счетах
      ОгранКД:numeric              = $0.0, // Ц/б на счетах с блокировкой классификатора "Блокировки цб, ограниченных по кор. действ."
      ЗапретОпер:numeric           = $0.0, // Ц/б на счетах с блокировкой классификатора "Блокировка цб запрета на операции"
      Арест:numeric                = $0.0, // Ц/б на счетах с блокировкой классификатора "Блокировки арестованных ц/б"
      КодCFI:string                = "",   // Код CFI
      Ф711_Контрагент_СекторЭкономики_Переданы_Займ:string = "",
      Ф711_Контрагент_СекторЭкономики_Получены_Займ:string = "";

  private macro SetValues()
    ЭмитентНаименование  = DataRec.IssuerName;          // Наименование эмитента
    ЭмитентИНН           = DataRec.IssuerINN;           // ИНН эмитента
    ЭмитентКПП           = DataRec.IssuerKPP;           // КПП эмитента
    ЭмитентОГРН          = DataRec.IssuerOGRN;          // ОГРН эмитента
    ЭмитентОКСМ          = DataRec.IssuerCountryCode;   // ОКСМ эмитента
    ЭмитентИНН_TIN       = DataRec.IssuerINN_TIN;       // для ИНН TIN - эмитента
    ПризнакКодаЭмНерез   = DataRec.IssuerNotResCode;    // Признак кода нерезидента эмитента
    ЭмитентИНН_Признак   = DataRec.IssuerINN_Mark;      // для ИНН признак эмитента
    ЦБКодТипа            = DataRec.Code711;             // Код ц/б для Ф711
    ЦБНомерГосРег        = DataRec.LSIN;                // Номер гос. рег. ц/б
    ЦБISIN               = DataRec.ISIN;                // ISIN ц/б
    ЦБВалюта             = DataRec.FaceValueFICode;     // Код валюты номинала ц/б
    ЦБНоминал            = DataRec.FaceValue;           // Номинал ц/б
    ЦБНоминалТочность    = DataRec.FaceValuePoint;      // Точность номинала ц/б
    ЦБ_Переданы_ПРЕПО    = DataRec.SaleREPOAmount;      // Ц/б, переданные по сделкам прямого репо
    ЦБ_Переданы_Займ     = DataRec.TransLoanAmount;     // Ц/б, переданные по сделкам займа
    ЦБ_Получены_ОРЕПО    = DataRec.BuyREPOAmount;       // Ц/б, полученные по сделкам обратного репо
    ЦБ_Получены_Займ     = DataRec.AcceptLoanAmount;    // Ц/б, полученные по сделкам займа
    ЦБ_Переданы_ДУ       = DataRec.TransDUAmount;       // Ц/б, переданные в доверительное управление
    ЦБ_ПраваПереданы_ДУ  = DataRec.TransRightsDUAmount; // Ц/б, права из которых переданы в доверительное управление
    ЦБ_Переданы_Залог_КО = DataRec.TransPledgeBOAmount; // Ц/б, переданные в залог по обязательствам кредитной организации
    ЦБ_Переданы_Залог    = DataRec.TransPledgeAmount;   // Ц/б, переданные в залог по обязательствам третьих лиц
    ЦБ_Приняты_Залог     = DataRec.AcceptPledgeAmount;  // Ц/б, принятые в залог
    ТогрСчета            = IIF(DataRec.TradeAmount < 0, 0, DataRec.TradeAmount);         // Ц/б на торговых счетах
    ОгранКД              = IIF(DataRec.CorpRestrAmount < 0, 0, DataRec.CorpRestrAmount); // Ц/б на счетах с блокировкой классификатора "Блокировки цб, ограниченных по кор. действ."
    ЗапретОпер           = IIF(DataRec.OperBanAmount < 0, 0, DataRec.OperBanAmount);     // Ц/б на счетах с блокировкой классификатора "Блокировка цб запрета на операции"
    Арест                = IIF(DataRec.ArrestAmount < 0, 0, DataRec.ArrestAmount);       // Ц/б на счетах с блокировкой классификатора "Блокировки арестованных ц/б"
    КодCFI               = DataRec.CFI;                 // Код CFI
    Ф711_Контрагент_СекторЭкономики_Переданы_Займ = DataRec.TRANSLOANCONTR;
    Ф711_Контрагент_СекторЭкономики_Получены_Займ = DataRec.ACCEPTLOANCONTR;

    if(DataRec.IsCompDelivery)
      ЦБ_Раздел3_Примечание = "Компенсационный взнос по сделке РЕПО";
    elif((RepDate < RCB_I6406_DATE) and ((ОгранКД == 0) or (ЗапретОпер == 0) or (Арест == 0))) // Golovkin 15.08.2019 ID : 492444
      ЦБ_Раздел3_Примечание = "Графы 22-24 не заполнены по причине отсутствия у кредитной организации информации об обременениях и (или) ограничениях распоряжения в отношении отдельных ценных бумаг";
    else
      ЦБ_Раздел3_Примечание = "";     // Примечание
    end;
  end;

  // Формирование выборки и получение первой записи
  macro GetFirst():bool
    var stat = 0;
    var query = "(SELECT t_Sort, T_ISSUER, T_ISSUERNAME, T_ISSUERINN, T_ISSUERKPP, T_ISSUERINN_MARK, T_ISSUERINN_TIN, T_ISSUERNOTRESCODE, T_ISSUEROGRN, T_ISSUERCOUNTRYCODE,"
              + "        T_FIID, T_CODE711, T_LSIN, T_ISIN, T_FACEVALUEFICODE, T_FACEVALUE, T_FACEVALUEPOINT, "
              + "        SUM(T_SALEREPOAMOUNT) as T_SALEREPOAMOUNT, SUM(T_TRANSLOANAMOUNT) as T_TRANSLOANAMOUNT, SUM(T_BUYREPOAMOUNT) as T_BUYREPOAMOUNT, "
              + "        SUM(T_ACCEPTLOANAMOUNT) as T_ACCEPTLOANAMOUNT, SUM(T_TRANSDUAMOUNT) as T_TRANSDUAMOUNT, SUM(T_TRANSRIGHTSDUAMOUNT) as T_TRANSRIGHTSDUAMOUNT,"
              + "        SUM(T_TRANSPLEDGEBOAMOUNT) as T_TRANSPLEDGEBOAMOUNT, SUM(T_TRANSPLEDGEAMOUNT) as T_TRANSPLEDGEAMOUNT, "
              + "        SUM(T_ACCEPTPLEDGEAMOUNT) as T_ACCEPTPLEDGEAMOUNT, "
              + "        SUM(T_ISCOMPDELIVERY) as T_ISCOMPDELIVERY, "
              + "        SUM(T_TRADEAMOUNT) as T_TRADEAMOUNT, "
              + "        SUM(T_CORPRESTRAMOUNT) AS T_CORPRESTRAMOUNT, "
              + "        SUM(T_OPERBANAMOUNT) AS T_OPERBANAMOUNT, "
              + "        SUM(T_ARRESTAMOUNT) AS T_ARRESTAMOUNT, "
              + "        T_CFI, "
              + "        T_TRANSLOANCONTR, "
              + "        T_ACCEPTLOANCONTR "
              + "  FROM d711PArt3_tmp WHERE t_Sort = 1 or t_Sort = 2" // эмисс и неэмисс
              + " GROUP BY t_Sort,T_ISSUER, T_ISSUERNAME,T_ISSUERINN,T_ISSUERKPP,T_ISSUERINN_MARK,T_ISSUERINN_TIN,T_ISSUERNOTRESCODE,T_ISSUEROGRN,T_ISSUERCOUNTRYCODE,"
              + "          T_FIID,T_CODE711,T_LSIN,T_ISIN,T_FACEVALUEFICODE,T_FACEVALUE,T_FACEVALUEPOINT, T_CFI, T_TRANSLOANCONTR, T_ACCEPTLOANCONTR)"
              // закладные ЮЛ
              + " UNION ALL "
              + "(SELECT t_Sort, T_ISSUER,T_ISSUERNAME,T_ISSUERINN,T_ISSUERKPP,T_ISSUERINN_MARK,T_ISSUERINN_TIN,T_ISSUERNOTRESCODE,T_ISSUEROGRN,T_ISSUERCOUNTRYCODE,"
              + "        -1,T_CODE711,CHR(1),CHR(1),T_FACEVALUEFICODE,Sum(T_FACEVALUE) as T_FACEVALUE,2,"
              + "        SUM(T_SALEREPOAMOUNT) as T_SALEREPOAMOUNT, SUM(T_TRANSLOANAMOUNT) as T_TRANSLOANAMOUNT, SUM(T_BUYREPOAMOUNT) as T_BUYREPOAMOUNT, "
              + "        SUM(T_ACCEPTLOANAMOUNT) as T_ACCEPTLOANAMOUNT, SUM(T_TRANSDUAMOUNT) as T_TRANSDUAMOUNT, SUM(T_TRANSRIGHTSDUAMOUNT) as T_TRANSRIGHTSDUAMOUNT,"
              + "        SUM(T_TRANSPLEDGEBOAMOUNT) as T_TRANSPLEDGEBOAMOUNT, SUM(T_TRANSPLEDGEAMOUNT) as T_TRANSPLEDGEAMOUNT, "
              + "        SUM(T_ACCEPTPLEDGEAMOUNT) as T_ACCEPTPLEDGEAMOUNT, "
              + "        SUM(T_ISCOMPDELIVERY) as T_ISCOMPDELIVERY, "
              + "        SUM(T_TRADEAMOUNT) as T_TRADEAMOUNT, "
              + "        SUM(T_CORPRESTRAMOUNT) AS T_CORPRESTRAMOUNT, "
              + "        SUM(T_OPERBANAMOUNT) AS T_OPERBANAMOUNT, "
              + "        SUM(T_ARRESTAMOUNT) AS T_ARRESTAMOUNT, "
              + "        T_CFI, "
              + "        T_TRANSLOANCONTR, "
              + "        T_ACCEPTLOANCONTR "
              + "   FROM d711PArt3_tmp WHERE t_Sort = 3 "
              + " GROUP BY t_Sort,T_ISSUER,T_ISSUERNAME,T_ISSUERINN,T_ISSUERKPP,T_ISSUERINN_MARK,T_ISSUERINN_TIN,T_ISSUERNOTRESCODE,T_ISSUEROGRN,T_ISSUERCOUNTRYCODE,"
              + "          T_CODE711,T_FACEVALUEFICODE, T_CFI, T_TRANSLOANCONTR, T_ACCEPTLOANCONTR)"
              // закладные ФЛ
              + " UNION ALL "
              + "(SELECT t_Sort, -1,'Физические лица',T_ISSUERINN,CHR(1),T_ISSUERINN_MARK,T_ISSUERINN_TIN,T_ISSUERNOTRESCODE,CHR(1),T_ISSUERCOUNTRYCODE,"
              + "        -1,'ENC',CHR(1),CHR(1),T_FACEVALUEFICODE,SUM(T_FACEVALUE) as T_FACEVALUE,2,"
              + "        SUM(T_SALEREPOAMOUNT) as T_SALEREPOAMOUNT, SUM(T_TRANSLOANAMOUNT) as T_TRANSLOANAMOUNT, SUM(T_BUYREPOAMOUNT) as T_BUYREPOAMOUNT, "
              + "        SUM(T_ACCEPTLOANAMOUNT) as T_ACCEPTLOANAMOUNT, SUM(T_TRANSDUAMOUNT) as T_TRANSDUAMOUNT, SUM(T_TRANSRIGHTSDUAMOUNT) as T_TRANSRIGHTSDUAMOUNT,"
              + "        SUM(T_TRANSPLEDGEBOAMOUNT) as T_TRANSPLEDGEBOAMOUNT, SUM(T_TRANSPLEDGEAMOUNT) as T_TRANSPLEDGEAMOUNT, "
              + "        SUM(T_ACCEPTPLEDGEAMOUNT) as T_ACCEPTPLEDGEAMOUNT, "
              + "        SUM(T_ISCOMPDELIVERY) as T_ISCOMPDELIVERY, "
              + "        SUM(T_TRADEAMOUNT) as T_TRADEAMOUNT, "
              + "        SUM(T_CORPRESTRAMOUNT) AS T_CORPRESTRAMOUNT, "
              + "        SUM(T_OPERBANAMOUNT) AS T_OPERBANAMOUNT, "
              + "        SUM(T_ARRESTAMOUNT) AS T_ARRESTAMOUNT, "
              + "        T_CFI, "
              + "        T_TRANSLOANCONTR, "
              + "        T_ACCEPTLOANCONTR "
              + "   FROM d711PArt3_tmp  WHERE t_Sort = 4"
              + " GROUP BY t_Sort,T_ISSUERINN,T_ISSUERINN_MARK,T_ISSUERINN_TIN,T_ISSUERNOTRESCODE,T_ISSUERCOUNTRYCODE,T_FACEVALUEFICODE, T_CFI, T_TRANSLOANCONTR, T_ACCEPTLOANCONTR)"
              + " ORDER BY t_Sort, T_ISSUERNAME,T_CODE711,T_FACEVALUEFICODE,T_FACEVALUE";

              /*"SELECT DECODE(t_FIID, -1, 2, 1) AS Num, "
              + "        T_ISSUER, T_ISSUERNAME, T_ISSUERINN, T_ISSUERKPP, T_ISSUERINN_MARK, T_ISSUERINN_TIN, T_ISSUERNOTRESCODE, T_ISSUEROGRN, T_ISSUERCOUNTRYCODE,"
              + "        T_FIID, T_CODE711, T_LSIN, T_ISIN, T_FACEVALUEFICODE, T_FACEVALUE, T_FACEVALUEPOINT, "
              + "        SUM(T_SALEREPOAMOUNT) as T_SALEREPOAMOUNT, SUM(T_TRANSLOANAMOUNT) as T_TRANSLOANAMOUNT, SUM(T_BUYREPOAMOUNT) as T_BUYREPOAMOUNT, "
              + "        SUM(T_ACCEPTLOANAMOUNT) as T_ACCEPTLOANAMOUNT, SUM(T_TRANSDUAMOUNT) as T_TRANSDUAMOUNT, SUM(T_TRANSRIGHTSDUAMOUNT) as T_TRANSRIGHTSDUAMOUNT,"
              + "        SUM(T_TRANSPLEDGEBOAMOUNT) as T_TRANSPLEDGEBOAMOUNT, SUM(T_TRANSPLEDGEAMOUNT) as T_TRANSPLEDGEAMOUNT, "
              + "        SUM(T_ACCEPTPLEDGEAMOUNT) as T_ACCEPTPLEDGEAMOUNT, "
              + "        SUM(T_ISCOMPDELIVERY) as T_ISCOMPDELIVERY "
              + "  FROM d711Part3_tmp"
              + " GROUP BY T_ISSUER, T_ISSUERNAME, T_ISSUERINN, T_ISSUERKPP, T_ISSUERINN_MARK, T_ISSUERINN_TIN, T_ISSUERNOTRESCODE, T_ISSUEROGRN, T_ISSUERCOUNTRYCODE,"
              + "          T_FIID, T_CODE711, T_LSIN, T_ISIN, T_FACEVALUEFICODE, T_FACEVALUE, T_FACEVALUEPOINT"
              + " ORDER BY Num, T_ISSUERNAME, T_CODE711, T_FACEVALUEFICODE, T_FACEVALUE";
              */
    DataRec = TRsbDataSet(query);

    stat = DataRec.moveNext();
    if(stat)
      SetValues();
    end;

    return stat;
  end;
  // Получение следующей записи
  macro GetNext():bool
    var stat = 0;
    stat = DataRec.moveNext();
    if(stat)
      SetValues();
    end;
    return stat;
  end;
end;
/* ********************************************** */
/* Клас данных 711 формы для протокола            */
/* ********************************************** */
class CDataProtocol
  private var DataRec = null;

  var ЭмитентНаименование:string = "",   // Наименование эмитента
      ЦБТип:string               = "",   // Тип ЦБ
      ЦБВалюта:string            = "",   // Валюта номинала
      ЦБНоминал:numeric          = $0.0, // Номинал
      ЦБНоминалТочность:integer  = 0,    // Точность номинала ц/б
      Выпуск:string              = "",   // Наименование выпуска
      Количество:numeric         = $0.0, // Количество ЦБ
      ИсточникДанных:string      = "",   // Источник данных
      ВидОбъекта:string          = "",   // Вид объекта
      НомерОбъекта:string        = "",   // Номер объекта
      Графа:integer              = 0;    // Графа

  private macro GetSumAvr() : numeric
    return (DataRec.SaleREPOAmount+DataRec.TransLoanAmount+DataRec.BuyREPOAmount+DataRec.AcceptLoanAmount+DataRec.TransDUAmount+
            DataRec.TransRightsDUAmount+DataRec.TransPledgeBOAmount+DataRec.TransPledgeAmount+DataRec.AcceptPledgeAmount)
  end;

  private macro GetKindData() : string
    if (SECUR_MODULE == DataRec.Module)
      return "БО ЦБ";
    elif (DEPO_MODULE == DataRec.Module)
      return "Депозитарий ";
    elif (VEKSEL_MODULE == DataRec.Module)
      return "Учтенные векселя";
    end;
  end;

  private macro GetKindObject() : string
    if (SECUR_MODULE == DataRec.Module)
      if (DataRec.SaleREPOAmount != $0.0)
        return "Обратное РЕПО";
      elif (DataRec.BuyREPOAmount != $0.0)
        return "Прямое РЕПО";
      end;
    elif (DEPO_MODULE == DataRec.Module)
      return "Раздел счёта депо";
    elif (VEKSEL_MODULE == DataRec.Module)
      return "Договор залога";
    end;
    return "";
  end;

  private macro GetColumn() : integer
    // T_TRANSRIGHTSDUAMOUNT //207 226
    // T_TRANSPLEDGEBOAMOUNT 208 227
    // T_TRANSPLEDGEAMOUNT 209 228

    if(DataRec.SaleREPOAmount != $0.0)
      return 202;
    elif(DataRec.TransLoanAmount != $0.0)
      return 203;
    elif(DataRec.BuyREPOAmount != $0.0)
      return 204;
    elif(DataRec.AcceptLoanAmount != $0.0)
      return 205;
    elif(DataRec.TransDUAmount != $0.0)
      return 206;
    elif(DataRec.TransRightsDUAmount != $0.0)
      return 207;
    elif(DataRec.TransPledgeBOAmount != $0.0)
      return 208;
    elif(DataRec.TransPledgeAmount != $0.0)
      return 209;
    elif(DataRec.AcceptPledgeAmount != $0.0)
      return 210;
    end;
    return 0;
  end;

  private macro SetValues()
    ЭмитентНаименование = DataRec.IssuerName;       // Наименование эмитента
    ЦБТип               = DataRec.TypeAvr;          // Тип ЦБ
    ЦБВалюта            = DataRec.FaceValueFICode;  // Валюта номинала
    ЦБНоминал           = DataRec.FaceValue;        // Номинал
    ЦБНоминалТочность   = DataRec.FaceValuePoint;   // Точность номинала ц/б
    Выпуск              = DataRec.NameAvr;          // Наименование выпуска
    Количество          = GetSumAvr();              // Количество ЦБ
    ИсточникДанных      = GetKindData();            // Источник данных
    ВидОбъекта          = GetKindObject();          // Вид объекта
    НомерОбъекта        = DataRec.Number;           // Номер объекта
    Графа               = GetColumn();              // Графа
  end;

  // Формирование выборки и получение первой записи
  macro GetFirst():bool
    var stat = 0;

    DataRec = TRsbDataSet("SELECT * FROM d711Part3_tmp");

    stat = DataRec.moveNext();
    if(stat)
      SetValues();
    end;

    return stat;
  end;
  // Получение следующей записи
  macro GetNext():bool
    var stat = 0;
    stat = DataRec.moveNext();
    if(stat)
      SetValues();
    end;
    return stat;
  end;
end;
/* ********************************************** */
/* Клас данных по 711 форме (3 раздел)            */
/* ********************************************** */
class C_711Part3
  private var flt = TFilter;
  private var objData = null;
  private var dataReport = null;
  private var dataProtocol = null;

  // Подготовить данные
  macro PrepareData()
    SQL_Truncate("d711Part3_tmp");

    if (flt.OnlyLoaded)
      CLoadedData(flt).PrepareData();
      return;
    end;
    if (index(flt.RepModule, SECUR_MODULE) != 0)
      CSecurData(flt).PrepareData();
    end;
    if (index(flt.RepModule, DEPO_MODULE) != 0)
      CDepoData(flt).PrepareData();
    end;
    if (index(flt.RepModule, VEKSEL_MODULE) != 0)
      CVekselData(flt).PrepareData();
    end;

    SQL_Execute(" DELETE FROM "
                  + " d711Part3_tmp "
              + " WHERE "
                  + " T_SALEREPOAMOUNT = 0 "
              + " AND T_TRANSLOANAMOUNT = 0 "
              + " AND T_BUYREPOAMOUNT = 0 "
              + " AND T_ACCEPTLOANAMOUNT = 0 "
              + " AND T_TRANSDUAMOUNT = 0 "
              + " AND T_TRANSRIGHTSDUAMOUNT = 0 "
              + " AND T_TRANSPLEDGEBOAMOUNT = 0 "
              + " AND T_TRANSPLEDGEAMOUNT = 0 "
              + " AND T_ACCEPTPLEDGEAMOUNT = 0 "
              + " AND T_TRADEAMOUNT = 0 "
              + " AND T_CORPRESTRAMOUNT = 0 "
              + " AND T_OPERBANAMOUNT = 0 "
              + " AND T_ARRESTAMOUNT = 0 ");
  end;

  // Установить фильтр
  macro SetFilter(_Departments:TArray, _BegDate:date, _RepDate:date, _RepModule:string, _OnlyLoaded:bool)
    if (ValType(_Departments) != V_UNDEF)
      flt.Departments = "";
      for(var dep, _Departments)
        if (flt.Departments != "")
          flt.Departments = flt.Departments + ",";
        end;
        flt.Departments = string(flt.Departments) + string(dep);
      end;
    end;
    if (ValType(_BegDate) != V_UNDEF)
      flt.BegDate = _BegDate;
    end;
    if (ValType(_RepDate) != V_UNDEF)
      flt.RepDate = _RepDate;
    end;
    if (ValType(_RepModule) != V_UNDEF)
      flt.RepModule = _RepModule;
    end;
    if (ValType(_OnlyLoaded) != V_UNDEF)
      flt.OnlyLoaded = _OnlyLoaded;
    end;
  end;

  // Получить объект отчета
  macro GetReport():CDataReport
    if (dataReport == null)
      dataReport = CDataReport(flt.RepDate);
    end;
    return dataReport;
  end;
  // Получить объект протокола
  macro GetProtocol():CDataProtocol
    if (dataProtocol == null)
      dataProtocol = CDataProtocol();
    end;
    return dataProtocol;
  end;
end;

/*
var deps = Tarray();
var obj = C_711Part3();
var stat = false;
var empty = true;
var fields = null, widths = null, j = 0;
var head = null;
var rep = null;
var style = "ex_B(rlb)";
deps[deps.size] = {OperDprt};
obj.SetFilter(deps, Date(00,00,0000), Date(31,12,9999), SECUR_MODULE + DEPO_MODULE + VEKSEL_MODULE);
obj.PrepareData();
stat = obj.GetReport().GetFirst();
while(stat)
  if(empty)
    fields = GetObjProps(obj.GetReport());
    widths = TArray();
    head = CHeader();
    j = 0;
    while(j < fields.Size)
      widths[j] = StrLen(fields[j]);
      head.AddChild(fields[j], widths[j]);
      j = j + 1;
    end;
    rep = CMakeReport("", SEP_DEFAULT, 99999);
    rep.AddPrintCell("Отчет", head.CalcWidthHeader(), 0, "ex_B()");
    rep.AutoScan("[\n" + head.CreateHeader() + "]");
    empty = false;
  end;
  j = 0;
  while(j < fields.Size)
    if(GenPropID(obj.GetReport(), fields[j]) != -1)
      rep.AddPrintCell(String(GenGetProp(obj.GetReport(), fields[j])), widths[j], 0, style);
    else
      rep.AddPrintCell("", widths[j], 0, style);
    end;
    j = j + 1;
  end;
  rep.AddStr();
  stat = obj.GetReport().GetNext();
end;
if(not empty)
  rep.PrintRep();
end;
empty = true;
stat = obj.GetProtocol().GetFirst();
while(stat)
  if(empty)
    fields = GetObjProps(obj.GetProtocol());
    widths = TArray();
    head = CHeader();
    j = 0;
    while(j < fields.Size)
      widths[j] = StrLen(fields[j]);
      head.AddChild(fields[j], widths[j]);
      j = j + 1;
    end;
    rep = CMakeReport("", SEP_DEFAULT, 99999);
    rep.AddPrintCell("Протокол", head.CalcWidthHeader(), 0, "ex_B()");
    rep.AutoScan("[\n" + head.CreateHeader() + "]");
    empty = false;
  end;
  j = 0;
  while(j < fields.Size)
    if(GenPropID(obj.GetProtocol(), fields[j]) != -1)
      rep.AddPrintCell(String(GenGetProp(obj.GetProtocol(), fields[j])), widths[j], 0, style);
    else
      rep.AddPrintCell("", widths[j], 0, style);
    end;
    j = j + 1;
  end;
  rep.AddStr();
  stat = obj.GetProtocol().GetNext();
end;
if(not empty)
  rep.PrintRep();
else
  PrintLn("Нет данных")
end;
*/

