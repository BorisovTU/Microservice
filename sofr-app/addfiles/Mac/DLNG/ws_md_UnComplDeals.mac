/*
$Name:         ws_md_UnComplDeals.mac
$Module:       Монитор дилера
$Description:  Запуск планировщика для получения незаверешнных сделок
*/

import "ws_md.mac";
import "ws_common.mac";
import "fx_api.mac";

private macro ПолучитьНезавершенныеСделки()
  var count = 0;
/* вызов api для получения количества незавершенных сделок */
/* вызвать функцию GetForexDealsCount2 или определеить свою*/
  //count = ExecMacroFile("fx_api.mac", "GetForexDealsCount2", {curdate});
  count = GetUncomplitedDealsCount({curdate});
  return count;
end;

private macro ОбработатьУведомлениеНезавершенныеСделки(CountUncomplDeals, noticeval)
  if( ( (noticeval == 0 ) and (CountUncomplDeals > 0) ) or
      ( (noticeval != 0 ) and (CountUncomplDeals == 0) ) )
    var sql = RSDCommand("UPDATE DRKNOTICE_DBT SET T_NOTICEVAL = ?, T_INPUTDATE = ?, T_INPUTTIME = ? WHERE T_NOTICEKIND = ? ");
    sql.addParam( "", RSDBP_IN, CountUncomplDeals );
    sql.addParam( "", RSDBP_IN, {curdate});
    sql.addParam( "", RSDBP_IN, time() );
    sql.addParam( "", RSDBP_IN, UNCOMPLETED_DEALS );
    sql.execute();   
  end;
end;

macro ПослатьУведомление(notice_kind:integer, notice_val:integer, always_update:bool)
  var sql;
  var query = "SELECT t_noticeval FROM DRKNOTICE_DBT WHERE T_NOTICEKIND = " + string (notice_kind); 

  var ds = TRsbDataSet(query);   

  if( ds.MoveNext() )
    if(always_update)
      sql = RSDCommand("UPDATE DRKNOTICE_DBT SET T_NOTICEVAL = ?, T_INPUTDATE = ?, T_INPUTTIME = ? WHERE T_NOTICEKIND = ? ");
      sql.addParam( "", RSDBP_IN, notice_val );
      sql.addParam( "", RSDBP_IN, {curdate});
      sql.addParam( "", RSDBP_IN, time() );
      sql.addParam( "", RSDBP_IN, notice_kind );
      sql.execute();    
    else
      if(notice_kind == UNCOMPLETED_DEALS) 
         ОбработатьУведомлениеНезавершенныеСделки(notice_val, ds.noticeval);
      /*elif(notice_kind == вид_уведомления)*/
      end;
    end;
  else
    sql = RSDCommand("INSERT INTO DRKNOTICE_DBT (T_NOTICEVAL , T_NOTICEKIND, T_INPUTDATE, T_INPUTTIME ) VALUES (?, ?, ?, ? ) ");
    sql.addParam( "", RSDBP_IN, notice_val );
    sql.addParam( "", RSDBP_IN, notice_kind );
    sql.addParam( "", RSDBP_IN, {curdate});
    sql.addParam( "", RSDBP_IN, time() );
    sql.execute();   
  end;     
end;

/*Интерфейс для посыла уведомления*/
macro ПослатьУведомлениеНезавершенныеСделки(count)
  ПослатьУведомление(UNCOMPLETED_DEALS, count, false);
end;

macro GetUnComplitedDeals()
  var count = ПолучитьНезавершенныеСделки();
  ПослатьУведомлениеНезавершенныеСделки(count);
end;

GetUnComplitedDeals();
