/**
 @file      dlactmoney.mac
 @brief     Отчет " Акты сверки наличия денежных средств " (общая для БОЦБ, УВ и ПИ)

 #menu 
  - БО ЦБ\Внутренний учет\Отчеты\Акты сверки\Акты сверки наличия денежных средств

 # tag
 - code_type:GUI

 # changelog
 |date       |autor          |tasks                                           |note
 |-----------|---------------|------------------------------------------------|-------------------------------------------------------------
 |31.01.2025 |Велигжанин А.В.|BOSS-5882_BOSS-7711                             |Реализация по BOSS-5882

*/
IMPORT "DLReport_h.mac", "spserv.mac", "sprepfun.mac";
IMPORT "dlactmoney_Form.mac","dlactmoney_user.mac";
IMPORT "dlactmoney5882.mac";

//константы - подсистемы по счетам которых выпускать отчет
PRIVATE CONST REPKIND_SEC = 1, //Ценные Бумаги
              REPKIND_DV  = 2, //Производные инструменты
              REPKIND_VA  = 3; //Учтенные векселя

/*Подвид отчета*/
PRIVATE CONST INACC_ACTMONEY_1   =  1,
              INACC_ACTMONEY_2   =  2, 
              INACC_ACTMONEY_3   =  3;
private var  IsUseDVDer = 0, 
             IsUseDVCur = 0;
private var SpActMoney;
private var RepBO;
private var glob_IsExistsData = false;
PRIVATE VAR ReportHeader =
"\nДата формирования отчета: ########## ########\n"+
"Дата расчета остатков: ##########\n" +
"                                                       АКТ О ПРОВЕДЕНИИ СВЕРКИ НАЛИЧИЯ ДЕНЕЖНЫХ СРЕДСТВ\n";


PRIVATE VAR Footer = "\n\nСотрудник, ответственный за"+            
                     "\nведение внутреннего учета:                      #" +          
                     "\n__________________                     ___________________"+
                     "\n(должность)       (подпись)   (фамилия)\n"+
                     "\nСотрудник Службы внутреннего контроля:\n"          
                     "\n________________________                     ___________________  /__________________/"+
                     "\n(должность)        (подпись)  (фамилия)";

PRIVATE VAR TableHeader_1 =
"┌───────────────────┬──────────────┬──────────┬────────────────────┬─────────────────┬───────────────────┬──────────────────┬─────────────────┬─────────────────┐\n"+
"│    Клиент         │   Договор    │   Дата   │ Лицевой счет       │Остаток денежных │ Лицевой счет      │ Остаток денежных │ Расхождение     │ Причина         │\n"+
"│                   │              │ договора │ внутреннего учета  │средств по данным│ бухгалтерского    │ средств по данным│                 │ расхождения     │\n"+                       
"│                   │              │          │                    │внутреннего учета│ учета             │ бухгалтерского   │                 │                 │\n"+
"│                   │              │          │                    │                 │                   │ учета            │                 │                 │\n"+
"│                   │              │          │                    │                 │                   │                  │                 │                 │\n"+
"├───────────────────┼──────────────┼──────────┼────────────────────┼─────────────────┼───────────────────┼──────────────────┼─────────────────┼─────────────────┤";
 
PRIVATE VAR TableHeader_2 =
"┌───────────────────┬────────────────────┬────────────────────┬─────────────────┬────────────────┬───────────┬───────────────────┬──────────────────┬─────────────────┬─────────────────┐\n"+
"│    Брокер         │ Лицевой счет       │ Владелец счета     │Остаток денежных │ № договора     │   Дата    │ Лицевой счет      │ Остаток денежных │ Расхождение     │ Причина         │\n"+
"│                   │ внутреннего учета  │                    │средств по данным│ с брокером     │ договора  │ бухгалтерского    │ средств по данным│                 │ расхождения     │\n"+                       
"│                   │                    │                    │внутреннего учета│                │ с брокером│ учета             │ бухгалтерского   │                 │                 │\n"+
"│                   │                    │                    │                 │                │           │                   │ учета            │                 │                 │\n"+
"│                   │                    │                    │                 │                │           │                   │                  │                 │                 │\n"+
"├───────────────────┼────────────────────┼────────────────────┼─────────────────┼────────────────┼───────────┼───────────────────┼──────────────────┼─────────────────┼─────────────────┤";

PRIVATE VAR TableHeader_3 =
"┌───────────────────┬────────────────────┬────────────────────┬─────────────────┬────────────────┬───────────────────┬──────────────────┬─────────────────┬─────────────────┐\n"+
"│    Расчетный      │ Лицевой счет       │ Владелец счета     │Остаток денежных │    Сектор      │ Лицевой счет      │ Остаток денежных │ Расхождение     │ Причина         │\n"+
"│    центр          │ внутреннего учета  │                    │средств по данным│                │ бухгалтерского    │ средств по данным│                 │ расхождения     │\n"+                       
"│                   │                    │                    │внутреннего учета│                │ учета             │ бухгалтерского   │                 │                 │\n"+
"│                   │                    │                    │                 │                │                   │ учета            │                 │                 │\n"+
"│                   │                    │                    │                 │                │                   │                  │                 │                 │\n"+
"├───────────────────┼────────────────────┼────────────────────┼─────────────────┼────────────────┼───────────────────┼──────────────────┼─────────────────┼─────────────────┤";


MACRO ConvertToISO():string
    var code;
    getparm(0,code)  ;
    if((valtype(code)==v_integer)and (code==0))
        return 640;
    elif ((valtype(code)==V_STRING)and (code=="RUR"))
        var sql = RSDCommand( " select t_isocode " +
                              "   from disocur_dbt " +
                              "  where t_numbercode    = 643"  );
        sql.execute();
        var DataSet = TRsbDataSet(sql);
        if( DataSet.MoveNext() )
            return  DataSet.isocode;
        end;
    else
        return code;
    end;
end;

PRIVATE class (TArray) TDataCurrency

      class CurrData( _Currency:Integer )
          var Curr  = _Currency;
      end;
      /* Очистить массив. */
      macro ClearArray
         this.Size = 0;
      end;

      /* Добавить строчку в массив. */
      macro AddLine(Currency)

         var
            Counter = 0;

         while( ( Counter < this.Size ) and 
                (this.(Counter).Curr != Currency )
              )
            Counter = Counter + 1;
         end;

         if( this.Size > Counter )
            if( ( this.(Counter).Curr != Currency ) )
               this.(Counter) = CurrData( Currency );
            end;
         else
             this.(Counter) = CurrData( Currency );
         end;

      end; /*AddLine*/
end;

PRIVATE CLASS CMoneyAct_1( Report:OBJECT )
  VAR m_Report = Report;
  
  MACRO BeginRepTab()
    // m_Report.PrintFormatString( MkStr(" ",33)+"#\n","N1_H0_3" , "Данные о денежных средствах клиентов, переданных Банку по договорам на обслуживание");
     m_Report.CopyAllSheetInTotalBook( null, false, "N1_RepHeader", 1 );
     m_Report.RegisterTable( "N1_MainTable", TableHeader_1,
                             "N1_A1",       
                             "N1_A2",       
                             "N1_A3",         
                             "N1_A4",           
                             "N1_A5",           
                             "N1_A6",          
                             "N1_A7",          
                             "N1_A8",         
                             "N1_A9");      
  END;

  MACRO ПечататьКодВалюты()
        m_Report.Merge( "N1_A1", "N1_A9", null);
        m_Report.PrintTableLine( "N1_A1:l",  "Счета в " + ConvertToISO(m_Report.AccValue()), null);
  END;
         
  MACRO ПечататьСтрокуТаблицы()

        m_Report.PrintTableLine( "N1_A1",  m_Report.Client(),   null,   
                                 "N1_A2",  m_Report.NumContr(), null,   
                                 "N1_A3",  m_Report.DateContr(),null,  
                                 "N1_A4",  m_Report.InnerAcc(), null,   
                                 "N1_A5",  m_Report.GBAcc(),    null, 
                                 "N1_A6",  m_Report.InnerRest(),null,     
                                 "N1_A7",  m_Report.GBRest(),   null,  
                                 "N1_A8",  m_Report.Delta(),    null   
                               );
  END;        

 MACRO ПечататьИтоговуюСтрокуТаблицы()

        //m_Report.PrintTableLine( "I1_A5",  "итого .",   null);
  END;        

  MACRO EndReportTab();
      m_Report.EndTable();
      m_Report.CopyAllSheetInTotalBook( null, false, m_Report.GetTableRange(), 0 );      
  END;
END;

PRIVATE CLASS CMoneyAct_2( Report:OBJECT )
  VAR m_Report = Report;
  
  MACRO BeginRepTab()
     m_Report.PrintFormatString( MkStr(" ", 44)+"#\n","N2_H0_3" , "Данные о суммарных остатках денежных средств, переданных другим проф. участникам");
     m_Report.CopyAllSheetInTotalBook( null, false, "N2_RepHeader", 1 );
     m_Report.RegisterTable( "N2_MainTable", TableHeader_2,
                             "N2_A1",       
                             "N2_A2",       
                             "N2_A3",         
                             "N2_A4",           
                             "N2_A5",           
                             "N2_A6",          
                             "N2_A7",          
                             "N2_A8",         
                             "N2_A9",
                             "N2_A10");      

  END; 

  MACRO ПечататьКодВалюты()
        m_Report.Merge( "N2_A1", "N2_A10", null);
        m_Report.PrintTableLine( "N2_A1:l", "Счета в " + ConvertToISO(m_Report.AccValue()), null);
  END;

  MACRO ПечататьИтогВУ()
        m_Report.Merge( "N2_A2", "N2_A3", null);
        m_Report.Merge( "N2_A5", "N2_A8", null);
        m_Report.PrintTableLine( "N2_A2:l", "Всего: средства у брокера по данным внутреннего учета", null,
                                 "N2_A4:l", m_Report.InnerItog(), null );                 
  END;

  MACRO ПечататьИтогГБ()
        m_Report.Merge( "N2_A2", "N2_A6", null);
        m_Report.PrintTableLine( "N2_A7:l", "Всего: средства у брокера по данным бухучета", null,
                        "N2_A8:l", m_Report.GBItog(), null );                 
  END;

  MACRO ПечататьИтогДляСверки()
        m_Report.Merge( "N2_A1", "N2_A3", null);
        m_Report.Merge( "N2_A5", "N2_A7", null);
        m_Report.PrintTableLine( "N2_A1:l", "Данные для сверки по средствам у брокера " + m_Report.Client(), null,
                                "N2_A4", m_Report.InnerItog(), null,
                                "N2_A8", m_Report.GBItog(), null,
                                "N2_A9", m_Report.BrokerDelta(), null);                 
  END;

  MACRO EndReportTab();
      m_Report.EndTable();
      m_Report.CopyAllSheetInTotalBook( null, false, m_Report.GetTableRange(), 0 );      
  END;         

END;

PRIVATE CLASS CMoneyAct_3( Report:OBJECT )
  VAR m_Report = Report;

  MACRO BeginRepTab()
     m_Report.PrintFormatString( MkStr(" ",23)+"#\n","N3_H0_3" , "Данные о суммарных остатках денежных средств, предназначенных для совершения сделок и операций с ценными бумагами на ОРЦБ");
     m_Report.CopyAllSheetInTotalBook( null, false, "N3_RepHeader", 1 );
     m_Report.RegisterTable( "N3_MainTable", TableHeader_3,
                             "N3_A1",
                             "N3_A2",
                             "N3_A3",
                             "N3_A4",
                             "N3_A5",
                             "N3_A6",
                             "N3_A7",
                             "N3_A8",
                             "N3_A9");
  END;

  MACRO ПечататьКодВалюты()
     m_Report.Merge( "N3_A1", "N3_A9", null);
     m_Report.PrintTableLine( "N3_A1:l", "Счета в " + ConvertToISO(m_Report.AccValue()), null);
  END;

  MACRO ПечататьИтогВУ()
     m_Report.Merge( "N3_A2", "N3_A3", null);
     m_Report.Merge( "N3_A5", "N3_A7", null);
     m_Report.PrintTableLine( "N3_A2:l", "Всего: средства в РЦ по данным внутреннего учета", null,
                              "N3_A4:l", m_Report.InnerItog(), null );
  END;

  MACRO ПечататьИтогГБ()
     m_Report.Merge( "N3_A2", "N3_A4", null);
     m_Report.Merge( "N3_A5", "N3_A6", null);
     m_Report.PrintTableLine( "N3_A5:l", "Всего: средства в РЦ по данным бухучета", null,
                              "N3_A7:l", m_Report.GBItog(), null );
  END;

  MACRO ПечататьИтогДляСверки( SourceMoney )
     m_Report.Merge( "N3_A1", "N3_A3", null);
     m_Report.PrintTableLine( "N3_A1:l", "Данные для сверки по средствам в РЦ " + m_Report.Client() + IIF(SourceMoney == ALG_SP_MONEY_SOURCE_OWN, " (собственные)", " (клиентские)"), null,
                              "N3_A4", m_Report.InnerItog(), null,
                              "N3_A7", m_Report.GBItog(), null,
                              "N3_A8", m_Report.BrokerDelta(), null);
  END;

  MACRO EndReportTab();
      m_Report.EndTable();
      m_Report.CopyAllSheetInTotalBook( null, false, m_Report.GetTableRange(), 0 );
  END;

END;

PRIVATE CLASS (DL_CReportTemplate) SP_MoneyAct_Report
  PRIVATE VAR m_ReportKind, m_SheetCount = 0, m_AccData, m_Department, IsExistsDepData = false,
              ReportDateBeg = ZeroDate, ReportDateEnd = ZeroDate, IsPeriod = true, IsFirstUse = true;

  PRIVATE MACRO PrintMode():INTEGER
     if((SpActMoney.IsExportToExel == "X") and (SpActMoney.IsUseApp == "X"))
        return DL_OUTREPORT_EXCEL;
     elif((SpActMoney.IsExportToExel == "X") and (SpActMoney.IsUseApp != "X"))
        return DL_OUTREPORT_EXCEL_NO_FORMAT;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
     CreateTotalBook();
     SetActiveSheet( "Акты сверки ДС" );
     SetUseApp(SpActMoney.IsUseApp == "X");
  END;

  PRIVATE MACRO PrintRepHeader()
     var PastePos, RepTime;
     if( IsFirstUse )
       PastePos = 0;/*отступ сверху не нужен*/
       IsFirstUse = false;
     else
       PastePos = 4;
     end;
     if (SpActMoney.IsExportToExel != "X")
       PrintFormatString( ReportHeader,
                       "Date" , this.CheckDate(),
                       "Time" , this.CheckTime(),
                    //   "N1_H0_1" , this.Dep(), 
                       "N1_H0_2" , this.RepDate());
       CopyAllSheetInTotalBook( null, false, "N1_NameRep", PastePos );
     else
    //   PrintFormatString( "#","Date" , this.CheckDate());
    //   PrintFormatString( "#","Time" , this.CheckTime());
       RepTime = string(this.CheckDate()) + " " + string(this.CheckTime());

       PrintFormatString( "#","Date" , RepTime );    
       CopyAllSheetInTotalBook( null, false, "A1:B1", PastePos );
     //  PrintFormatString( "#","N1_H0_1" , "Филиал:"+this.Dep());
     //  CopyAllSheetInTotalBook( null, false, "N1_H0_1", 0 );
     //  CopyAllSheetInTotalBook( null, false, "A3:L3", 0 );
       PrintFormatString( "#","N1_H0_2" , this.RepDate());
       CopyAllSheetInTotalBook( null, false, "A2:B2", 0 );
     end;
  END;

  PRIVATE MACRO PrintRepFooter()
     PrintFormatString( Footer, "N1_F1",{Name_Oper});
     CopyAllSheetInTotalBook( null, false, "N1_Footer", 1 );
  END;

  PRIVATE MACRO EndReport();
     SaveTotalBook();
  END;         

  PRIVATE VAR m_Currency, m_Client, m_NumContr, m_DateContr, m_InnerAcc, m_InnerRest, m_GBAcc, m_GBRest, m_Delta, m_WhyDelta;
  PRIVATE VAR m_Owner, m_Sector;

  PRIVATE VAR m_InnerItog = $0, m_GBItog = $0;
 
  MACRO ClearCacheOneRecord()
     m_Client  = null;
     m_NumContr    = null;
     m_DateContr = null;
     m_Owner     = null;
     m_Sector    = null;
     m_InnerAcc = null;
     m_InnerRest = null;
     m_GBAcc  = null;
     m_GBRest  = null;
     m_Delta = null;
  END;

  MACRO ClearAccountOneRecord()
     m_InnerAcc = null;
     m_InnerRest = null;
     m_GBAcc  = null;
     m_GBRest  = null;
     m_Delta = null;
  END;

  MACRO ClearItog()
     m_InnerItog = $0;
     m_GBItog = $0;
  END;

  MACRO ExecuteReportClient( ObjReport:OBJECT )
    var Act = DLACTMONEY_CL(ObjReport, RepBO);
    Act.run();
    //EndAction();
  END;

  PRIVATE MACRO ExecuteReportClient_old( ObjReport:OBJECT )
     VAR QueryInner, sqlQuery, QueryClient, ClientData, NRecSelect, QueryCurr, CurrData, i = 0, CurrIn = "", IsFirstCurr = true,
         NRecData, Num = 0, Rep_Name, count = 0,
         AccValue = SpActMoney.AccValue,
         ClientID = SpActMoney.ClientCode,
         ContrID =  SpActMoney.ClientContr;
     var ServKind = 0;
     var DocKinds = "";

     var m_PrevCurrency = "";
     var sfcontr  = TBfile("sfcontr.dbt"); 
     var Currency = TDataCurrency();
     var IsExistsData = false;

     if(RepBO == REPKIND_SEC)
       DocKinds = "101,107,122,176,159,127,117,138,155";
     elif(RepBO == REPKIND_VA)
       DocKinds = "141,142,143,144";
     elif(RepBO == REPKIND_DV)
       DocKinds = "193,194";
     end;

     if(RepBO == REPKIND_SEC)
       ServKind = PTSK_STOCKDL;
     elif(RepBO == REPKIND_VA)
       ServKind = PTSK_VEKSACC;
     elif(RepBO == REPKIND_DV)
       ServKind = PTSK_DV;
     end;

     sqlQuery = "select sf.t_PartyID Owner, sf.t_ID ContrID " +
                              " from dsfcontr_dbt sf " +
                              " where sf.t_Department = ? " +
                              "   and sf.t_ID = (case when(? = -1) then sf.t_ID else ? end) " +
                              "   and sf.t_PartyID = (case when(? = -1) then sf.t_PartyID else ? end)  " + 
                              iif (RepBO == REPKIND_DV, "   and sf.t_ServKind in (?, ?) "," and sf.t_ServKind = ? ")  +
                              "   and sf.t_ContractorID = ? " +
                              "   and (sf.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY') or sf.t_DateClose >= ?) " +
                              "   and (sf.t_DateBegin <= ?) " +
                              " group by sf.t_PartyID, sf.t_ID " +
                              " order by sf.t_PartyID, sf.t_ID ";

     QueryClient = RSDCommand(sqlQuery);

     QueryClient.addParam("", RSDBP_IN, m_Department);
     QueryClient.addParam("", RSDBP_IN, ContrID);
     QueryClient.addParam("", RSDBP_IN, ContrID);
     QueryClient.addParam("", RSDBP_IN, ClientID);
     QueryClient.addParam("", RSDBP_IN, ClientID);
     if (RepBO == REPKIND_DV)
        if(IsUseDVCur == 1)
        QueryClient.addParam("", RSDBP_IN, PTSK_CM);
        end;
        if(IsUseDVDer == 1)
        QueryClient.addParam("", RSDBP_IN, PTSK_DV);
        end;
     else
     QueryClient.addParam("", RSDBP_IN, ServKind);
     end;
     QueryClient.addParam("", RSDBP_IN, {OurBank});
     QueryClient.addParam("", RSDBP_IN, ReportDateBeg);
     QueryClient.addParam("", RSDBP_IN, ReportDateEnd);                                                   
     QueryClient.execute();

     NRecSelect = RSDCommand("select count(1) nRecs from(" + sqlQuery + ")");;

     NRecSelect.addParam("", RSDBP_IN, m_Department);
     NRecSelect.addParam("", RSDBP_IN, ContrID);
     NRecSelect.addParam("", RSDBP_IN, ContrID);
     NRecSelect.addParam("", RSDBP_IN, ClientID);
     NRecSelect.addParam("", RSDBP_IN, ClientID);
     if (RepBO == REPKIND_DV)
        if(IsUseDVCur == 1)
          NRecSelect.addParam("", RSDBP_IN, PTSK_CM);
        end;
        if(IsUseDVDer == 1)
          NRecSelect.addParam("", RSDBP_IN, PTSK_DV);
        end;
     else
        NRecSelect.addParam("", RSDBP_IN, ServKind);
     end;
     NRecSelect.addParam("", RSDBP_IN, {OurBank});
     NRecSelect.addParam("", RSDBP_IN, ReportDateBeg);                                                   
     NRecSelect.addParam("", RSDBP_IN, ReportDateEnd);                                                   
     NRecSelect.execute();

     NRecData = TRsbDataSet(NRecSelect);
     
     if( NRecData.MoveNext() )
        count = int(NRecData.nRecs);
     end;

     InitProgress( count, Rep_Name, "Просмотр данных по договорам клиента " 
                                    + IIF(IsPeriod,"за период","на дату "+GetDateAfterWorkDays(ReportDateBeg,1)) );
     ClientData = TRsbDataSet(QueryClient);    

     while( ClientData.MoveNext() )

        this.ClearCacheOneRecord();

        QueryInner = RSDCommand(" select mc.t_Account, mc.t_Currency, mc.t_Place " +
                                "   from dmcaccdoc_dbt mc " +
                                "  where mc.t_Chapter = 21 " +
                                "    and mc.t_CatNum = 533 " +  /*"ДС, Расч. с клиентом, ВУ" */
                                "    and mc.t_Owner = ? " +
                                "    and mc.t_ClientContrID = ? " +
                                "    and mc.t_Currency = (case when(? = -1) then mc.t_Currency else ? end) " +
                                "    and mc.t_DocKind in ("+DocKinds+") " +
                                "    and mc.t_DepartmentID = ? " +
                                "    and exists(select acc.* from daccount_dbt acc where acc.t_Chapter = 21 and acc.t_Account = mc.t_Account and " +
                                "                    acc.t_Code_Currency = mc.t_Currency and " +
                                "                    (acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') or acc.t_Close_Date >= ?) and " +
                                "                     acc.t_Open_Date <= ?) " +
                                " group by mc.t_Currency, mc.t_Account, mc.t_Place " +
                                " order by mc.t_Currency, mc.t_Account, mc.t_Place");

        QueryInner.addParam("", RSDBP_IN, ClientData.Owner);
        QueryInner.addParam("", RSDBP_IN, ClientData.ContrID);

        QueryInner.addParam("", RSDBP_IN, AccValue);
        QueryInner.addParam("", RSDBP_IN, AccValue);

        QueryInner.addParam("", RSDBP_IN, m_Department);
        QueryInner.addParam("", RSDBP_IN, ReportDateBeg);
        QueryInner.addParam("", RSDBP_IN, ReportDateEnd);                                                   
        QueryInner.execute();
       
        m_AccData = TRsbDataSet(QueryInner);    
        m_Client = ClientData.Owner;

        sfcontr.rec.ID = ClientData.ContrID;
        if( sfcontr.GetEQ() )
           m_NumContr = sfcontr.rec.Number;
           m_DateContr = sfcontr.rec.DateConc;      
        end;
        Currency.ClearArray();
          /*печатаем строки по счетам ВУ и цепляем соответствующие счета бухучета(если есть) */
        while( m_AccData.MoveNext() )
             if( not IsExistsDepData)
                PrintRepHeader();
             end;

             if( not IsExistsData)
                ObjReport.BeginRepTab();
             end;

             this.ClearAccountOneRecord();
             Currency.AddLine(m_AccData.Currency);

             if( m_PrevCurrency != m_AccData.Currency )
                m_Currency = m_AccData.Currency;
               // ObjReport.ПечататьКодВалюты();
                m_PrevCurrency = m_AccData.Currency;
             end;

             m_InnerAcc = m_AccData.Account; 
             m_InnerRest = ABS(this.ПолучитьОстатокНаСчете(m_AccData.Account,m_AccData.Currency,21));
             if( not this.НайтиСчетБухУчета(sfcontr,m_AccData.Currency) )
                m_GBAcc = "-";
                m_GBRest = "-";
                m_Delta = m_InnerRest;
             else
                m_Delta = m_InnerRest - m_GBRest;
             end;

             ObjReport.ПечататьСтрокуТаблицы();
             IsExistsData = true;
             IsExistsDepData = true;
        end;
        /*выведем стоки по бухучету, счета по кот. не попали вместе со счетами по ВУ*/
        if( not ((Currency.Size > 0) and (AccValue != -1)) )
           if( (Currency.Size > 0) ) 
             /*ищем счета бухучета по тем валютам, по кот не вошли выше*/
             CurrIn = "";
             while( i < Currency.Size)
                if(not IsFirstCurr)
                   CurrIn = CurrIn + ",";
                else
                   IsFirstCurr = false;
                end;
                CurrIn = CurrIn + string(Currency[i].Curr);
                i = i + 1;
             end;

             QueryCurr = RSDCommand("select t_FIID Currency " +
                                    "  from dfininstr_dbt " +
                                    " where t_FI_KIND = 1 " +
                                    "   and t_FIID not in(" + CurrIn + ")");
             QueryCurr.execute();
             CurrData = TRsbDataSet(QueryCurr);    
          else 
             QueryCurr = RSDCommand("select t_FIID Currency " +
                                    "  from dfininstr_dbt " +
                                    " where t_FI_KIND = 1" +
                                    IIF(AccValue != -1," and t_fiid = " + AccValue,""));
             QueryCurr.execute();
             CurrData = TRsbDataSet(QueryCurr);    
          end;

          while( CurrData.MoveNext() )
             this.ClearAccountOneRecord();
             if( this.НайтиСчетБухУчета(sfcontr,CurrData.Currency) )
                if( not IsExistsDepData)
                    PrintRepHeader();
                end;

                if( not IsExistsData)
                   ObjReport.BeginRepTab();
                end;
         
                if( m_PrevCurrency != CurrData.Currency )
                   m_Currency = CurrData.Currency;
                   //ObjReport.ПечататьКодВалюты();
                   m_PrevCurrency = CurrData.Currency;
                end;
           
                m_InnerAcc = "-"; 
                m_InnerRest = "-";

                m_Delta = m_GBRest;
                ObjReport.ПечататьСтрокуТаблицы();

                IsExistsData = true;
                IsExistsDepData = true;
             end;
          end;
       end;
       Currency.ClearArray();
       IsFirstCurr = true;
       i = 0;

       this.ClearCacheOneRecord();
       UseProgress( Num = Num + 1 );
    end;
    ObjReport.ПечататьИтоговуюСтрокуТаблицы(); 
    RemProgress();

    if( IsExistsData)
        ObjReport.EndReportTab();
        glob_IsExistsData=true;
    end;

  END;

  PRIVATE MACRO ExecuteReportBroker( ObjReport:OBJECT )

     VAR sqlInner = "", sqlGB = "", sqlUnion = "", sqlQuery, NRecSelect, NRecData, Num = 0, Rep_Name, count = 0,
         AccValue = SpActMoney.AccValue,
         BrokerID = SpActMoney.Broker;
     var DocKinds = "";

     var m_PrevCurrency = "", m_PrevBroker = "", m_PrevChapter = "", IsFirstUse = true;
     var sfcontr  = TBfile("sfcontr.dbt"); 
     var IsExistsData = false;

     if(RepBO == REPKIND_SEC)
       DocKinds = "101,107,122,176,159,127,117,138,155";
     elif(RepBO == REPKIND_DV)
       DocKinds = "193,194";
     end;

     this.ClearCacheOneRecord();
     this.ClearItog();

     sqlInner = " select DECODE(mc.t_Owner,-1,?,mc.t_Owner) Owner, " +
             "        mc.t_Account, mc.t_Currency, mc.t_Place Broker, mc.t_BankContrID BrokerContr, mc.t_Chapter" +
             "   from dmcaccdoc_dbt mc " +
             "  where mc.t_Chapter = 21 " +
             " and mc.t_CatNum in(535,531) " + /*"ДС у брокера, ВУ","ДС клиента"*/
             " and mc.t_Place = (case when(? = -1) then mc.t_Place else ? end) " +
             " and 22 = (case when(mc.t_CatNum = 531) then NVL((select pwn.t_PartyKind " +
             "                                                from dpartyown_dbt pwn " +
             "                                               where pwn.t_PartyID = mc.t_Place and pwn.t_PartyKind = 22),0) " +
             "          else 22 end) " +
             " and mc.t_Currency = (case when(? = -1) then mc.t_Currency else ? end) " +
             " and mc.t_DocKind in("+DocKinds+") " +
             " and mc.t_DepartmentID = ? " +
             " and exists(select acc.* from daccount_dbt acc where acc.t_Chapter = 21 and acc.t_Account = mc.t_Account and " +
             "                    acc.t_Code_Currency = mc.t_Currency and " +
             "                    (acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') or acc.t_Close_Date >= ?) and " +
             "                     acc.t_Open_Date <= ?)  " +
             " group by mc.t_Place, mc.t_Currency, mc.t_BankContrID, mc.t_Account, mc.t_Owner, mc.t_Chapter " +
             " order by mc.t_Place, mc.t_Currency, mc.t_BankContrID, mc.t_Account, mc.t_Owner";

     sqlGB = " select DECODE(mc.t_Owner,-1,?,mc.t_Owner) Owner, " +
                    "        mc.t_Account, mc.t_Currency, mc.t_Contractor Broker, mc.t_BankContrID BrokerContr, mc.t_Chapter " +
                    "   from dmcaccdoc_dbt mc " +
                    "  where mc.t_Chapter = 1 " +
                    "    and mc.t_CatNum = 213 " +/*"Брокер"*/
                    "    and mc.t_Contractor = (case when(? = -1) then mc.t_Contractor else ? end) " +
                    "    and mc.t_Currency = (case when(? = -1) then mc.t_Currency else ? end) " +
                    "    and mc.t_DepartmentID = ? " +
                    "    and exists(select acc.* from daccount_dbt acc where acc.t_Chapter = 1 and acc.t_Account = mc.t_Account and " +
                    "                    acc.t_Code_Currency = mc.t_Currency and " +
                    "                    (acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') or acc.t_Close_Date >= ?) and " +
                    "                    acc.t_Open_Date <= ? ) " +
                    "    and mc.t_DocKind in("+DocKinds+") " +
                    " group by mc.t_Contractor, mc.t_Currency, mc.t_BankContrID, mc.t_Account, mc.t_Owner, mc.t_Chapter " +
                    " order by mc.t_Contractor, mc.t_Currency, mc.t_BankContrID, mc.t_Account";

     sqlUnion = "select * from (select mc1.* from (" + sqlInner + ") mc1 " +
                "union " +
                "select mc2.* from (" + sqlGB + ") mc2) mc_union " +
                "order by mc_union.t_Currency, mc_union.Broker, mc_union.t_Chapter desc";

     sqlQuery = RSDCommand(sqlUnion); 
                                                            
     sqlQuery.addParam("", RSDBP_IN, {OurBank});
     sqlQuery.addParam("", RSDBP_IN, BrokerID);
     sqlQuery.addParam("", RSDBP_IN, BrokerID); 
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, m_Department);
     sqlQuery.addParam("", RSDBP_IN, ReportDateBeg);
     sqlQuery.addParam("", RSDBP_IN, ReportDateEnd);                                                   

     sqlQuery.addParam("", RSDBP_IN, {OurBank});
     sqlQuery.addParam("", RSDBP_IN, BrokerID);
     sqlQuery.addParam("", RSDBP_IN, BrokerID);
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, m_Department);
     sqlQuery.addParam("", RSDBP_IN, ReportDateBeg);
     sqlQuery.addParam("", RSDBP_IN, ReportDateEnd);                                                   

     sqlQuery.execute();

     NRecSelect = RSDCommand("select count(1) nRecs from(" + sqlUnion + ")");;

     NRecSelect.addParam("", RSDBP_IN, {OurBank});
     NRecSelect.addParam("", RSDBP_IN, BrokerID);
     NRecSelect.addParam("", RSDBP_IN, BrokerID); 
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, m_Department);
     NRecSelect.addParam("", RSDBP_IN, ReportDateBeg);
     NRecSelect.addParam("", RSDBP_IN, ReportDateEnd);                                                   

     NRecSelect.addParam("", RSDBP_IN, {OurBank});
     NRecSelect.addParam("", RSDBP_IN, BrokerID);
     NRecSelect.addParam("", RSDBP_IN, BrokerID);
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, m_Department);
     NRecSelect.addParam("", RSDBP_IN, ReportDateBeg);
     NRecSelect.addParam("", RSDBP_IN, ReportDateEnd);                                                   

     NRecSelect.execute();

     NRecData = TRsbDataSet(NRecSelect);
     
     if( NRecData.MoveNext() )
        count = int(NRecData.nRecs);
     end;

     m_AccData = TRsbDataSet(sqlQuery);
     
     InitProgress( count, Rep_Name, "Формирование данных по счетам брокера " 
                                   + IIF(IsPeriod,"за период","на дату "+GetDateAfterWorkDays(ReportDateBeg,1)) ); 
     while( m_AccData.MoveNext() )

          if( not IsExistsDepData)
             PrintRepHeader();
          end;

          if( not IsExistsData)
             ObjReport.BeginRepTab();
          end;

          if( ((m_PrevBroker != m_AccData.Broker) or (m_PrevChapter != m_AccData.Chapter) or 
                (m_PrevCurrency != m_AccData.Currency)) and (not IsFirstUse) )
             /*напечатать итог*/
             if( m_PrevChapter == 21)
                ObjReport.ПечататьИтогВУ();
             else
                ObjReport.ПечататьИтогГБ();
             end;
          end;

          if( ((m_PrevBroker != m_AccData.Broker) or (m_PrevCurrency != m_AccData.Currency)) and (not IsFirstUse) )
             ObjReport.ПечататьИтогДляСверки();
          end;

          if( m_PrevCurrency != m_AccData.Currency )
             this.ClearItog();
             m_Currency = m_AccData.Currency;
             //ObjReport.ПечататьКодВалюты();
             m_PrevCurrency = m_AccData.Currency;
             m_PrevBroker = "";
          end;

          if(m_PrevChapter != m_AccData.Chapter)
             if( m_PrevBroker == m_AccData.Broker )
                Merge( "N2_A2", "N2_A6", null);
                Merge( "N2_A7", "N2_A8", null);
                PrintTableLine( "N2_A7:l", "Данные бухучета", null );
             end;
             m_PrevChapter = m_AccData.Chapter;
          end;

          if( m_PrevBroker != m_AccData.Broker )
             this.ClearCacheOneRecord()();
             this.ClearItog();

             m_Client = m_AccData.Broker;
             m_PrevBroker = m_AccData.Broker;

             Merge( "N2_A2", "N2_A6", null);
             Merge( "N2_A7", "N2_A8", null);

             if( m_AccData.Chapter == 21)
                PrintTableLine( "N2_A1", ПолучитьКороткоеИмяСубъекта(m_Client), null,
                                "N2_A2:l", "Данные внутреннего учета", null );
             else
                PrintTableLine( "N2_A1", ПолучитьКороткоеИмяСубъекта(m_Client), null,
                                "N2_A7:l", "Данные бухучета", null );
             end;
          end;

          sfcontr.rec.ID = m_AccData.BrokerContr;
          if( sfcontr.GetEQ() )
             m_NumContr = sfcontr.rec.Number;
             m_DateContr = sfcontr.rec.DateConc;      
          end;

          m_Owner = m_AccData.Owner;

          if( m_AccData.Chapter == 21)
             m_InnerAcc = m_AccData.Account; 
             m_InnerRest = ABS(this.ПолучитьОстатокНаСчете(m_InnerAcc,m_AccData.Currency,21));
             m_InnerItog = m_InnerItog + m_InnerRest;

             Merge( "N2_A7", "N2_A8", null);
             PrintTableLine( "N2_A2", m_InnerAcc, null,
                             "N2_A3", ПолучитьКороткоеИмяСубъекта(m_Owner), null,
                             "N2_A4", m_InnerRest, null,
                             "N2_A5", m_NumContr, null,
                             "N2_A6", m_DateContr, null );                 
          else
             m_GBAcc = m_AccData.Account;
             m_GBRest = ABS(this.ПолучитьОстатокНаСчете(m_GBAcc,m_AccData.Currency,1));
             m_GBItog = m_GBItog + m_GBRest;

             Merge( "N2_A2", "N2_A4", null);
             PrintTableLine( "N2_A5", m_NumContr, null,
                             "N2_A6", m_DateContr, null,
                             "N2_A7", m_GBAcc, null,
                             "N2_A8", m_GBRest, null );                 
          end;

          IsFirstUse = false;
          IsExistsData = true;
          IsExistsDepData = true;
          UseProgress( Num = Num + 1 );
     end;

     RemProgress();

     /*напечатать итог по последнему брокеру*/
     if( IsExistsData )
        if( not IsFirstUse )
           if( m_PrevChapter == 21)
              ObjReport.ПечататьИтогВУ();
           else
              ObjReport.ПечататьИтогГБ();
           end;
        end;

        ObjReport.ПечататьИтогДляСверки();
        ObjReport.EndReportTab();
        glob_IsExistsData=true;
     end;
  END;

  PRIVATE MACRO ExecuteReportMarket( ObjReport:OBJECT )

     VAR sqlInner = "", sqlGB = "", sqlUnion = "", sqlQuery, NRecSelect, NRecData, Num = 0, Rep_Name, count = 0,
         AccValue = SpActMoney.AccValue,
         MarketID = SpActMoney.Market;
     var DocKinds = "";

     var m_PrevCurrency = "", m_PrevMarket = "", m_PrevChapter = "", m_PrevSourceMoney, IsFirstUse = true;
     var IsExistsData = false;

     if(RepBO == REPKIND_SEC)
       DocKinds = "101,107,122,176,159,127,117,138,155";
     elif(RepBO == REPKIND_DV)
       DocKinds = "193,194";
     end;

     this.ClearCacheOneRecord();
     this.ClearItog();

     sqlInner = " select DECODE(mc.t_Owner, -1, ?, mc.t_Owner) Owner, mc.t_Account, mc.t_Currency, mc.t_Place Market, mc.t_Chapter, (-1) Sector, DECODE(mc.t_CatNum, 536, ?, ?) SourceMoney " +
                "   from dmcaccdoc_dbt mc " +
                "  where mc.t_Chapter = 21 " +
                "    and mc.t_CatNum in(536,531) " + /*"ДС в РЦ ОРЦБ, ВУ","ДС клиента"*/
                "    and mc.t_Place = (case when(? = -1) then mc.t_Place else ? end) " +
                "    and exists(select pwn.t_PartyKind " +
                "                 from dpartyown_dbt pwn " +
                "                where pwn.t_PartyID = mc.t_Place " +
                "                  and pwn.t_PartyKind = (case when mc.t_CatNum = 531 then 46 else pwn.t_PartyKind end) ) " +/*РЦ ОРЦБ*/
                "    and mc.t_Currency = (case when(? = -1) then mc.t_Currency else ? end) " +
                "    and mc.t_DocKind in(" + DocKinds + ") " +
                "    and mc.t_DepartmentID = ? " +
                "    and exists(select acc.* " +
                "                 from daccount_dbt acc " +
                "                where acc.t_Chapter = 21 " +
                "                  and acc.t_Account = mc.t_Account " +
                "                  and acc.t_Code_Currency = mc.t_Currency " +
                "                  and (acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') or acc.t_Close_Date >= ?) " +
                "                  and acc.t_Open_Date <= ?) ";

     sqlGB = " select DECODE(mc.t_Owner, -1, ?, mc.t_Owner) Owner, mc.t_Account, mc.t_Currency, mc.t_MarketPlaceID Market, mc.t_MarketPlaceOfficeID Sector, mc.t_Chapter, templ.t_Value1 SourceMoney " +
             "   from dmcaccdoc_dbt mc, dmctempl_dbt templ " +
             "  where mc.t_Chapter = 1 " +
             "    and mc.t_CatNum in(219,217) " +/*"Клиринговый счёт","Торговый счет"*/
             "    and mc.t_MarketPlaceID = (case when(? = -1) then mc.t_MarketPlaceID else ? end) " +
             "    and mc.t_Currency = (case when(? = -1) then mc.t_Currency else ? end) " +
             "    and mc.t_DepartmentID = ? " +
             "    and exists(select acc.* " +
             "                 from daccount_dbt acc " +
             "                where acc.t_Chapter = 1 " +
             "                  and acc.t_Account = mc.t_Account " +
             "                  and acc.t_Code_Currency = mc.t_Currency " +
             "                  and (acc.t_Close_Date = TO_DATE('01.01.0001','DD.MM.YYYY') or acc.t_Close_Date >= ?) " +
             "                  and acc.t_Open_Date <= ?) " +
             "    and mc.t_DocKind in(" + DocKinds + ") " + 
             "    and templ.t_Number  = mc.t_TemplNum " +
             "    and templ.t_CatID   = mc.t_CatID " +
             "    and templ.t_Value1  != ? ";

     sqlUnion = "select * from (select mc1.* from (" + sqlInner + ") mc1 " +
                "union " +
                "select mc2.* from (" + sqlGB + ") mc2) mc_union " +
                "order by mc_union.t_Currency, mc_union.Market, mc_union.SourceMoney, mc_union.t_Chapter";

     sqlQuery = RSDCommand(sqlUnion); 

     sqlQuery.addParam("", RSDBP_IN, {OurBank});
     sqlQuery.addParam("", RSDBP_IN, ALG_SP_MONEY_SOURCE_OWN);
     sqlQuery.addParam("", RSDBP_IN, ALG_SP_MONEY_SOURCE_CLIENT);
     sqlQuery.addParam("", RSDBP_IN, MarketID);
     sqlQuery.addParam("", RSDBP_IN, MarketID); 
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, m_Department);
     sqlQuery.addParam("", RSDBP_IN, ReportDateBeg);
     sqlQuery.addParam("", RSDBP_IN, ReportDateEnd);                                                   

     sqlQuery.addParam("", RSDBP_IN, {OurBank});
     sqlQuery.addParam("", RSDBP_IN, MarketID);
     sqlQuery.addParam("", RSDBP_IN, MarketID);
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, AccValue);
     sqlQuery.addParam("", RSDBP_IN, m_Department);
     sqlQuery.addParam("", RSDBP_IN, ReportDateBeg);
     sqlQuery.addParam("", RSDBP_IN, ReportDateEnd);
     sqlQuery.addParam("", RSDBP_IN, ALG_SP_MONEY_SOURCE_TRUST);

     sqlQuery.execute();

     NRecSelect = RSDCommand("select count(1) nRecs from(" + sqlUnion + ")");

     NRecSelect.addParam("", RSDBP_IN, {OurBank});
     NRecSelect.addParam("", RSDBP_IN, ALG_SP_MONEY_SOURCE_OWN);
     NRecSelect.addParam("", RSDBP_IN, ALG_SP_MONEY_SOURCE_CLIENT);
     NRecSelect.addParam("", RSDBP_IN, MarketID);
     NRecSelect.addParam("", RSDBP_IN, MarketID); 
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, m_Department);
     NRecSelect.addParam("", RSDBP_IN, ReportDateBeg);
     NRecSelect.addParam("", RSDBP_IN, ReportDateEnd);                                                   

     NRecSelect.addParam("", RSDBP_IN, {OurBank});
     NRecSelect.addParam("", RSDBP_IN, MarketID);
     NRecSelect.addParam("", RSDBP_IN, MarketID);
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, AccValue);
     NRecSelect.addParam("", RSDBP_IN, m_Department);
     NRecSelect.addParam("", RSDBP_IN, ReportDateBeg);
     NRecSelect.addParam("", RSDBP_IN, ReportDateEnd);
     NRecSelect.addParam("", RSDBP_IN, ALG_SP_MONEY_SOURCE_TRUST);

     NRecSelect.execute();

     NRecData = TRsbDataSet(NRecSelect);
     
     if( NRecData.MoveNext() )
        count = int(NRecData.nRecs);
     end;

     m_AccData = TRsbDataSet(sqlQuery);
     
     InitProgress( count, Rep_Name, "Формирование данных по счетам участников ОРЦБ " 
                                    + IIF(IsPeriod,"за период","на дату "+GetDateAfterWorkDays(ReportDateBeg,1)) ); 

     while( m_AccData.MoveNext() )

          if( not IsExistsDepData )
             PrintRepHeader();
          end;

          if( not IsExistsData )
             ObjReport.BeginRepTab();
          end;

          if( ((m_PrevMarket != m_AccData.Market) or (m_PrevSourceMoney != m_AccData.SourceMoney) or (m_PrevChapter != m_AccData.Chapter) or 
                (m_PrevCurrency != m_AccData.Currency)) and (not IsFirstUse) )
             /*напечатать итог*/
             if( m_PrevChapter == 21)
                ObjReport.ПечататьИтогВУ();
             else
                ObjReport.ПечататьИтогГБ();
             end;
          end;

          if( ((m_PrevMarket != m_AccData.Market) or (m_PrevSourceMoney != m_AccData.SourceMoney) or (m_PrevCurrency != m_AccData.Currency)) and (not IsFirstUse) )
             ObjReport.ПечататьИтогДляСверки(m_PrevSourceMoney);
          end;

          if( m_PrevCurrency != m_AccData.Currency )
             this.ClearItog();
             m_Currency = m_AccData.Currency;
            // ObjReport.ПечататьКодВалюты();
             m_PrevCurrency = m_AccData.Currency;
             m_PrevMarket = "";
          end;

          if(m_PrevChapter != m_AccData.Chapter)
             if( m_PrevMarket == m_AccData.Market )
                Merge( "N3_A2", "N3_A4", null);
                Merge( "N3_A5", "N3_A7", null);
                PrintTableLine("N3_A2:l", "Данные внутреннего учета", null );
             end;
             m_PrevChapter = m_AccData.Chapter;
          end;

          if( (m_PrevMarket != m_AccData.Market) or (m_PrevSourceMoney != m_AccData.SourceMoney) )
             this.ClearCacheOneRecord();
             this.ClearItog();

             m_Client = m_AccData.Market;
             m_PrevMarket = m_AccData.Market;
             m_PrevSourceMoney = m_AccData.SourceMoney;

             Merge( "N3_A2", "N3_A4", null);
             Merge( "N3_A5", "N3_A7", null);

             if( m_AccData.Chapter == 21)
                PrintTableLine( "N3_A1", ПолучитьКороткоеИмяСубъекта(m_Client) + IIF(m_PrevSourceMoney == ALG_SP_MONEY_SOURCE_OWN, " (собственные)", " (клиентские)"), null,
                                "N3_A2:l", "Данные внутреннего учета", null  );
             else
                PrintTableLine( "N3_A1", ПолучитьКороткоеИмяСубъекта(m_Client) + IIF(m_PrevSourceMoney == ALG_SP_MONEY_SOURCE_OWN, " (собственные)", " (клиентские)"), null,
                                "N3_A5:l", "Данные бухучета", null );
             end;
          end;

          m_PrevChapter = m_AccData.Chapter;

          m_Owner = m_AccData.Owner;
          m_Sector = m_AccData.Sector;

          if( m_AccData.Chapter == 21)
             m_InnerAcc = m_AccData.Account; 
             m_InnerRest = ABS(this.ПолучитьОстатокНаСчете(m_InnerAcc,m_AccData.Currency,21));
             m_InnerItog = m_InnerItog + m_InnerRest;

             Merge( "N3_A5", "N3_A7", null);
             PrintTableLine( "N3_A2", m_InnerAcc, null,
                             "N3_A3", ПолучитьКороткоеИмяСубъекта(m_Owner), null,
                             "N3_A4", m_InnerRest, null);                 
          else
             m_GBAcc = m_AccData.Account;
             m_GBRest = ABS(this.ПолучитьОстатокНаСчете(m_GBAcc,m_AccData.Currency,1));
             m_GBItog = m_GBItog + m_GBRest;

             Merge( "N3_A2", "N3_A4", null);
             PrintTableLine( "N3_A5", ПолучитьНаименованиеСектора( m_Client, m_Sector ), null,
                             "N3_A6", m_GBAcc, null,
                             "N3_A7", m_GBRest, null );                 
          end;

          IsFirstUse = false;
          IsExistsData = true;
          IsExistsDepData = true;
          UseProgress( Num = Num + 1 );

     end;

     RemProgress();

     /*напечатать итог по последнему РЦ и подвал отчета*/
     if( IsExistsData )
        if( not IsFirstUse )
           if( m_PrevChapter == 21)
              ObjReport.ПечататьИтогВУ();
           else
              ObjReport.ПечататьИтогГБ();
           end;
        end;

        ObjReport.ПечататьИтогДляСверки();
        ObjReport.EndReportTab();
        glob_IsExistsData=true;
     end;
  END;

  PRIVATE MACRO CreateReportByKind( Kind:INTEGER )
     m_ReportKind = Kind;

     if( Kind == INACC_ACTMONEY_1 )
        ExecuteReportClient( CMoneyAct_1(this) );
     elif( Kind == INACC_ACTMONEY_2 )
        ExecuteReportBroker( CMoneyAct_2(this) );
     elif( Kind == INACC_ACTMONEY_3 )
        ExecuteReportMarket( CMoneyAct_3(this) );
     end;
  END;


  
  PRIVATE MACRO PrintDep(Dep:integer)
     m_Department = Dep;
     IsExistsDepData = false;

     if( SpActMoney.PassivAcc == "X" )
        CreateReportByKind( INACC_ACTMONEY_1 );
     end;

     if((RepBO == REPKIND_SEC) or (RepBO == REPKIND_DV))
       if( SpActMoney.ActivAcc == "X" )
          if( SpActMoney.BrokerMoney == "X" )
             CreateReportByKind( INACC_ACTMONEY_2 );
          end;
          if( SpActMoney.MarketMoney == "X" )
             CreateReportByKind( INACC_ACTMONEY_3 );
          end;
       end;
     end;

     if(not IsExistsDepData)
        PrintFormatString( null,"N1_ReportRunFalse","Нет данных по филиалу "+DL_GetDepartmentNameByCode(m_Department)+", удовлетворяющих параметрам отчета");
        CopyAllSheetInTotalBook( null, false, "N1_ReportRunFalse", 1 );
     end;

     if(IsExistsDepData)
        PrintRepFooter();
     end;
     
     

     
  END;

  PRIVATE MACRO ListerDate(Department:integer)
     /*перебор дат*/
     ReportDateBeg = SpActMoney.BegDate;
     ReportDateEnd = SpActMoney.EndDate;

     if( SpActMoney.ForEveryDate != "X" )
        /*выпускаем на период*/
        IsPeriod = true;
        /*по состоянию на начало даты, следующей после последней даты отчетного периода.*/
        ReportDateEnd = GetDateAfterWorkDays(ReportDateEnd,1);
        PrintDep(Department);
     else
      /*выпускаем на начало каждой отчетной даты периода*/
        IsPeriod = false;
        while( ReportDateBeg <= SpActMoney.EndDate )
           ReportDateEnd = GetDateAfterWorkDays(ReportDateBeg,1);
           PrintDep(Department);
           ReportDateBeg = GetDateAfterWorkDays(ReportDateBeg,1);
        end;
     end;
  END;

  PRIVATE MACRO Create() 
     var Dep = SpActMoney.DepartmentID;
     var Department, query, NumDep = 0;

     if( Dep != -1 )
        ListerDate(Dep);
     else
        query = " SELECT t_Code"
               + " FROM  ddp_dep_dbt";

        Department = TRsbDataSet( query );
        InitProgress( SQL_GetNRecs(query), "Отчет: Акт о проведении сверки наличия денежных средств", "Просмотр филиалов..." );
        while( Department.MoveNext() )
           Dep = Department.Code;  
           ListerDate(Dep);
           UseProgress( NumDep = NumDep + 1 );
        end;
        RemProgress(); 
     end;
  END;

  MACRO ПолучитьОстатокНаСчете(Account,Currency:integer,Chapter:integer)     /*!!!*/
     record AccBuf(account);
     ClearRecord( AccBuf );
     if( GetAccount( Chapter, Currency, Account, AccBuf, true ) )
        return GetRestAccount( AccBuf, GetDateAfterWorkDays(ReportDateEnd,-1) );
     end;
     return $0;
  END;

  MACRO НайтиСчетБухУчета(sfcontr,Currency:integer)
     var settacc  = TRecHandler("settacc.dbt");
     var foundSetAcc = false;
     record AccBuf(account);
     var BalanceAcc = "";

     settacc.Clear();

     SfSelectSETTACC( Currency, OBJTYPE_SFCONTR, sfcontr, settacc, foundSetAcc );
     if (not foundSetAcc)
        return false;
     end;
     BalanceAcc = SubStr( string(settacc.rec.Account), 1, 5 );
     if( (settacc.rec.FIID == Currency) and ((BalanceAcc == "30601") or (BalanceAcc == "30606")) )
        ClearRecord( AccBuf );
        if( GetAccount( 1, Currency, settacc.rec.Account, AccBuf, true ) )
           if( (AccBuf.Open_Date <= ReportDateEnd) and          /*!!!*/
               ((AccBuf.Close_Date == "") or (AccBuf.Close_Date == ZeroDate) or (AccBuf.Close_Date >= ReportDateBeg )) )
              m_GBAcc = settacc.rec.Account;
              m_GBRest = ABS(ПолучитьОстатокНаСчете(settacc.rec.Account,Currency,1));
              return true;
           end;
        end;
     end;

     return false;
  END;

  MACRO CheckDate():DATE
     return DATE();
  END;

  MACRO CheckTime():Time
     return Time();
  END;

  MACRO Dep():STRING
     return DL_GetDepartmentNameByCode(m_Department);
  END;

  MACRO RepDate():DATE
     return ReportDateEnd;
  END;

  MACRO AccValue():STRING
     private var T_ISO:T_ISO_Collector;
     T_ISO.ClearArray();

     return T_ISO.Get_ISO(m_Currency);
  END;

  MACRO Client():STRING
     if( (m_Client != "") and (m_Client != null) )
        return ПолучитьКороткоеИмяСубъекта(m_Client);
     else
        return "";
     end;
  END;
  
  MACRO NumContr():STRING
     return m_NumContr;
  END;

  MACRO DateContr():DATE
     return m_DateContr;
  END;      

  MACRO InnerAcc():STRING
     return m_InnerAcc; 
  END;

  MACRO InnerRest():MONEY
     return m_InnerRest;
  END;
 
  MACRO GBAcc():STRING
     return m_GBAcc;
  END;

  MACRO GBRest():MONEY 
     return m_GBRest;
  END;

  MACRO Delta():MONEY
     return m_Delta;
  END;

  MACRO InnerItog():MONEY
     return m_InnerItog;
  END;
 
  MACRO GBItog():MONEY
     return m_GBItog;
  END;

  MACRO BrokerDelta():MONEY
     return m_GBItog - m_InnerItog;
  END;

  initDL_CReportTemplate( null, "Report_DLActMoney.xls", null, null, null, true );
END;

private macro ReportRun(DlActMoneyData, RepKind)
   SpActMoney = DlActMoneyData;
   RepBO = RepKind;
   //SP_MoneyAct_Report().Run();
   SP_MoneyAct_Report().ExecuteReportClient(DlActMoneyRepFormData);
end;

PRIVATE MACRO PrintJournal()//печать в журнал актов сверки
     var REPKIND_MONEY = 2;
     var query = " insert into DDL_JOURNAL_DBT " +
                 "   (T_DATE, T_TIME, T_REPDATE, T_OPER, T_REPKIND, T_RESULT ) " +
                 " VALUES " +
                 "   ( ?,?,?,?,?,? ) ";
     var sqlQuery = RSDCommand(query); 
     sqlQuery.addParam("", RSDBP_IN, DATE());//программная дата проведения сверки 
     sqlQuery.addParam("", RSDBP_IN, Time());//программное время проведения сверки
     sqlQuery.addParam("", RSDBP_IN, SpActMoney.EndDate);//конец отчетного периода
     sqlQuery.addParam("", RSDBP_IN, {oper});//операционист
     sqlQuery.addParam("", RSDBP_IN, REPKIND_MONEY);
     sqlQuery.addParam("", RSDBP_IN, IIF(glob_IsExistsData, 1 , 0) );
     sqlQuery.execute();
END;

//запуск отчета

PRIVATE VAR  m_Form = DL_ActMoney_Panel();

PRIVATE MACRO GetDataFromFormFields()
    DlActMoneyRepFormData.IsUseBO                   = m_Form.GetFieldValue( PNFLD_INACC_ACT_MODULE_BO );
    DlActMoneyRepFormData.IsUseVA                   = m_Form.GetFieldValue( PNFLD_INACC_ACT_MODULE_VA );
    DlActMoneyRepFormData.IsUseDV                   = m_Form.GetFieldValue( PNFLD_INACC_ACT_MODULE_DV );
    DlActMoneyRepFormData.IsUseDVDer                = m_Form.GetFieldValue( PNFLD_INACC_ACT_MODULE_DV_DER );
    DlActMoneyRepFormData.IsUseDVCur                = m_Form.GetFieldValue( PNFLD_INACC_ACT_MODULE_DV_CUR );

    DlActMoneyRepFormData.BegDate                   = m_Form.GetFieldValue( PNFLD_INACC_ACT_BEGINDATE );
    DlActMoneyRepFormData.EndDate                   = m_Form.GetFieldValue( PNFLD_INACC_ACT_FINISHDATE );
    DlActMoneyRepFormData.ForEveryDate              = m_Form.GetFieldValue( PNFLD_INACC_ACT_FOR_EVERY_DATE );
    DlActMoneyRepFormData.AccValue                  = m_Form.GetFieldValue( PNFLD_INACC_ACT_ACCVALUE );

    DlActMoneyRepFormData.PassivAcc                 = m_Form.GetFieldValue( PNFLD_INACC_ACT_PASSIVACC );
    DlActMoneyRepFormData.ClientCode                = m_Form.GetFieldValue( PNFLD_INACC_ACT_CLIENT_CODE );
    DlActMoneyRepFormData.ClientContr               = m_Form.GetFieldValue( PNFLD_INACC_ACT_CLIENT_CONTR );

    DlActMoneyRepFormData.ActivAcc                  = m_Form.GetFieldValue( PNFLD_INACC_ACT_ACTIVACC );
    DlActMoneyRepFormData.BrokerMoney               = m_Form.GetFieldValue( PNFLD_INACC_ACT_BROKERMONEY );
    DlActMoneyRepFormData.Broker                    = m_Form.GetFieldValue( PNFLD_INACC_ACT_BROKER );
    DlActMoneyRepFormData.MarketMoney               = m_Form.GetFieldValue( PNFLD_INACC_ACT_MARKETMONEY );
    DlActMoneyRepFormData.Market                    = m_Form.GetFieldValue( PNFLD_INACC_ACT_MARKET );
    DlActMoneyRepFormData.IsUseApp                  = m_Form.GetFieldValue( PNFLD_INACC_ACT_WITH_APP );
    DlActMoneyRepFormData.IsExportToExel            = m_Form.GetFieldValue( PNFLD_INACC_ACT_TO_EXEL );
    DlActMoneyRepFormData.DepartmentID              = m_Form.GetFieldValue( PNFLD_INACC_ACT_DEPARTMENT );
END;
  
PRIVATE MACRO GetAuditMsg(panel:DL_ActMoney_Panel):String
	GetDataFromFormFields();
	var msg:string = "";
	var beginDate:date = DlActMoneyRepFormData.BegDate;
	var endDate:date = DlActMoneyRepFormData.EndDate;
    var deals1:string = "";
    var deals2:string = "";
	var deals3:string = "";

    deals1 = IIF(DlActMoneyRepFormData.IsUseBO == "X",
                 "Модуля \"Бэк-офис ценных бумаг\"\n",
                 "");

    deals2 = IIF(DlActMoneyRepFormData.IsUseVA == "X",
                 "Модуля \"Учтенные векселя\"\n",
                 "");
				 
	deals3 = IIF(DlActMoneyRepFormData.IsUseDV == "X",
                 "Модуля \"ФИССиКО\"\n",
                 "");

    msg = 
    "Отчет:              Акт сверки наличия денежных средств\n\n" +
    "Отчетный период:          с " + beginDate + " по " + endDate + "\n" +
    "По сделкам:\n"  +
    deals1 + deals2 + deals3 +
    "\n----------------------------------------\n";

    return msg;
END;

//запуск отчета

  
macro MakeReports()

  var stat = 0;
  
  stat = m_Form.Run();
  
  // Проверяем можем ли мы делать отчет по предоставленным данным
  if (not stat)
     return;
  end;
  GetDataFromFormFields();

  if((DlActMoneyRepFormData.IsExportToExel == "X") and (DlActMoneyRepFormData.IsUseApp == "X"))
    Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  elif((DlActMoneyRepFormData.IsExportToExel == "X") and (DlActMoneyRepFormData.IsUseApp != "X"))
    Dl_CallInsertStat( DL_OUTREPORT_EXCEL_NO_FORMAT );
  else
    Dl_CallInsertStat( DL_OUTREPORT_STD );
  end;
  
  AuditLog(REPORT_START, GetAuditMsg(m_Form));
  
  if (DlActMoneyRepFormData.IsUseVA == "X" )
    ReportRun(DlActMoneyRepFormData, REPKIND_VA);
  end;

  if (DlActMoneyRepFormData.IsUseDV == "X" )
    IsUseDVDer = 0;
    IsUseDVCur = 0;
    if (DlActMoneyRepFormData.IsUseDVDer == "X" )
      IsUseDVDer = 1;
    end;
    if (DlActMoneyRepFormData.IsUseDVCur == "X" )
      IsUseDVCur = 1;
    end;
    ReportRun(DlActMoneyRepFormData, REPKIND_DV);
  end;

  if (DlActMoneyRepFormData.IsUseBO == "X" )
    ReportRun(DlActMoneyRepFormData, REPKIND_SEC);
    //ExecuteReportClient(DlActMoneyRepFormData);
  end;
  
  PrintJournal();
  
  AuditLog(REPORT_FINISH, GetAuditMsg(m_Form));
  
 // MakeReports();
  
end;

/**
  @brief    Функция проверки рубильника
  @param[in]   p_RelayName - наименование настройки
*/
PRIVATE MACRO  GetRelay ( p_RelayName: STRING )
  var ErrCode, FlagValue:bool;

  GetRegistryValue( p_RelayName, V_BOOL, FlagValue, ErrCode );
  if ( ErrCode != 0 )
     FlagValue = false;
  end;

  return FlagValue;
onError(erru)  
  return false;
END;

/**
  @brief    проверка рубильника
*/
PRIVATE MACRO CheckRelay
  var x_RelayName: STRING = "РСХБ\\БРОКЕРСКОЕ ОБСЛУЖИВАНИЕ\\РУБИЛЬНИК.BOSS-5882";
  var x_RelayFlag: BOOL = GetRelay( x_RelayName );
  if(x_RelayFlag)
    // рубильник установлен, работаем по BOSS-5882
    MakeReports5882();
  else
    // рубильник не установлен, работаем, как раньше
    MakeReports();
  end;
end;


/**
  @brief    Начинаем с проверки рубильника
*/
CheckRelay();
exit(1);
