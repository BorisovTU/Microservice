/*
 $Name: nptxgetsnobproc.mac 
 $Module: НДФЛ
 $Description: Макрос выполнения процедуры запроса к источнику 
*/

IMPORT DealsInter, SPInter, PTInter, globals;
IMPORT RsbDataSet, "dlquery.mac";
import bnk_common;
import "nptxstbfun.mac";
import GetReportClientOperationReq;

private var ProtocolStrNum = 0;

PRIVATE MACRO AddErrToAllCurrClnt(ErrStr:string)
  var query, cmd;
  
  query =   " UPDATE DDLSELECTPT_TMP SPT "
          + "    SET SPT.T_MESSAGE = ? "
          + "  WHERE SPT.T_MESSAGE = CHR(1) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(ErrStr);

  cmd.ExecuteCMD();
END;

private macro GetSystDateTime(SystDate:@date, SystTime:@time)
  var cmd = DL_RSDCommand("select sysdate dt from dual");
  var DataSet = cmd.execute();

  DataSet.moveNext();

  DtTmSplit(DataSet.dt, SystDate, SystTime);
end;


PRIVATE MACRO InitReq(Req:@variant, TaxPeriod)
  Req = c_GetReportClientOperationRequest;
  
  Req.GetReportClientOperationReq.TaxYear        = TaxPeriod;  // Налоговый период, к которому относится событие (налоговый год)
  Req.GetReportClientOperationReq.ClientInfoList = TArray;     // Список информации по клиентам

  DL_RSDCommand("TRUNCATE TABLE DDLSELECTPT_TMP").ExecuteCMD();
END;

PRIVATE MACRO AddClientToReq(Req:@variant, ClientID)
  var sz = Req.GetReportClientOperationReq.ClientInfoList.size;
  var query, exec;
  
  Req.GetReportClientOperationReq.ClientInfoList[sz]                   = c_ClientInfo_GetReportClientOperation;
  Req.GetReportClientOperationReq.ClientInfoList[sz].ClientId          = c_IntegrationSymbolicIdentifierXType();
  Req.GetReportClientOperationReq.ClientInfoList[sz].ClientId.ObjectId = ClientID; // ID клиента в системе-источнике


  //Добавить клиента во временную таблицу
  query =   " INSERT INTO DDLSELECTPT_TMP (T_CLIENTID, T_CLIENTCODE, T_CLIENTNAME, T_SELECTFLAG, T_MESSAGE) "
          + " VALUES (?, CHR(1), CHR(1), CHR(88), CHR(1)) ";

  exec = DL_RSDCommand(query);
  
  exec.AddParam(ClientID);

  exec.ExecuteCMD();

END;

PRIVATE MACRO GetDefault(Val, DefaultVal)

  if(Val == NULL)
    return DefaultVal;
  end;

  return Val;
END;

PRIVATE MACRO GetTaxBaseKind(TaxBaseTypeNum)
    var query, cmd, DataSet;
    var TaxBaseKind = 0;

    query =   " select t_Element "
            + "   from dllvalues_dbt "
            + "  where t_List = " + OBJTYPE_STB_TAXBASEKIND
            + "    and t_Flag = ? ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(int(TaxBaseTypeNum));

    DataSet = cmd.Execute();
    if(DataSet.moveNext())
      TaxBaseKind = DataSet.Element;
    end;

    return TaxBaseKind;
  END;

PRIVATE MACRO _ExecReq(nptxop, Req:@variant, isFirstLoad)
  var Resp = NULL;
  var ins_nptxtbext_tmp = RsbSQLInsert("nptxtbext.tmp");
  var nptxtbext_tmp_new = TRecHandler( "nptxtbext.tmp" );
  var query, cmd;
  var i = 0, j = 0;
  var TaxPeriod = Req.GetReportClientOperationReq.TaxYear;
  var LoadDate = date(0,0,0), LoadTime = time(0);

  DL_RSDCommand("TRUNCATE TABLE DNPTXTBEXT_TMP").ExecuteCMD();
  DL_RSDCommand("TRUNCATE TABLE DNPTXMES_TMP").ExecuteCMD();

  if(Req.GetReportClientOperationReq.ClientInfoList.size == 0)
    return;
  end;

  InitProgress(-1, "Отправка запроса в Хранилище", "Отправка запроса в Хранилище");
  Resp = GetReportClientOperationReq(Req);
  RemProgress();
  
  if(ValType(Resp) != V_GENOBJ)
    AddErrToAllCurrClnt("Ошибка получения ответа от Хранилища");
    return;                                                                                                                                              
  end;

  if((Resp.ErrorList != NULL) and (Resp.ErrorList[0].ErrorCode != "0") and (Resp.ErrorList[0].ErrorCode != "000"))
    AddErrToAllCurrClnt(Resp.ErrorList[0].ErrorCode + " " + Resp.ErrorList[0].ErrorDesc);

    //если получили ошибку и пустой список записей, то выйти из обработки текущей группы клиентов 
    if(Resp.ReportRecordClientList == NULL)
      return;
    end;
  end;
   
  if(Resp.ReportRecordClientList != NULL)
    InitProgress(Resp.ReportRecordClientList.size, "Обработка полученной информации по клиентам", "Обработка полученной информации по клиентам");

    GetSystDateTime(@LoadDate, @LoadTime);

    while(i < Resp.ReportRecordClientList.size)

      if((Resp.ReportRecordClientList[i].ReportRecordList != NULL) and (Resp.ReportRecordClientList[i].ReportRecordList.size > 0))

        InitProgress(Resp.ReportRecordClientList[i].ReportRecordList.size, "Обработка полученной информации по клиенту", "Обработка полученной информации по клиенту");
        j = 0;
        while(j < Resp.ReportRecordClientList[i].ReportRecordList.size)
          var ReportRecord = Resp.ReportRecordClientList[i].ReportRecordList[j];

          nptxtbext_tmp_new.Clear();

          if(Resp.ReportRecordClientList[i].ClientId)
            nptxtbext_tmp_new.rec.ClientID            = GetDefault(Resp.ReportRecordClientList[i].ClientId.ObjectID, -1);
          end;
          nptxtbext_tmp_new.rec.TaxPeriod           = TaxPeriod;
          nptxtbext_tmp_new.rec.IncDate             = date(ReportRecord.IncomeDateTime);
          nptxtbext_tmp_new.rec.IncTime             = time(ReportRecord.IncomeDateTime);
          nptxtbext_tmp_new.rec.KbkCalc             = GetDefault(ReportRecord.KBKCalculate, "");
          nptxtbext_tmp_new.rec.KbkKeep             = GetDefault(ReportRecord.KBKKeep, "");
          if(ReportRecord.TaxBaseType)
            nptxtbext_tmp_new.rec.TaxBaseKind         = GetTaxBaseKind(GetDefault(ReportRecord.TaxBaseType.RecordCode, 0));
          end;
          nptxtbext_tmp_new.rec.NobAmount           = GetDefault(ReportRecord.NOBAmount, 0);           
          nptxtbext_tmp_new.rec.NdflCalcAmount      = GetDefault(ReportRecord.NDFLCalculateAmount, 0);      
          nptxtbext_tmp_new.rec.NDFLCalcRate        = GetDefault(ReportRecord.NDFLTaxRate, 0);        
          nptxtbext_tmp_new.rec.NdflKeepAmount      = GetDefault(ReportRecord.NDFLKeepAmount, 0);      
          nptxtbext_tmp_new.rec.NDFLKeepRate        = GetDefault(ReportRecord.NDFLKeepRate, 0);
          if(ReportRecord.TaxPayerStatus)  
            nptxtbext_tmp_new.rec.TaxPayerStatus      = GetDefault(ReportRecord.TaxPayerStatus.RecordCode, 0);     
          end;
          if(ReportRecord.SystemCode)
            nptxtbext_tmp_new.rec.SystemCode          = GetDefault(ReportRecord.SystemCode.RecordCode, "");         
          end;
          nptxtbext_tmp_new.rec.LoadDate            = LoadDate;
          nptxtbext_tmp_new.rec.LoadTime            = LoadTime;
          if(ReportRecord.RecordId)
            nptxtbext_tmp_new.rec.RecordID            = GetDefault(ReportRecord.RecordId.ObjectID, "");
          end;

          if(StrUpr(nptxtbext_tmp_new.rec.SystemCode) == "DIASOFT")
            ins_nptxtbext_tmp.AddRecord(nptxtbext_tmp_new);
          end;

          UseProgress(j = j + 1);
        end;

        RemProgress();
      end;

      UseProgress(i = i + 1);
    end;

    ins_nptxtbext_tmp.Insert();

    RemProgress();
  end;

  InitProgress(-1, "Сохранение полученных данных", "Сохранение полученных данных");
  
  //1.Если по клиенту нет записей в ответе Хранилища, то в Протокол выводим сообщение: "По клиенту отсутствуют выплаты в Депозитарии". 
  query =   " UPDATE DDLSELECTPT_TMP SPT "
          + "    SET SPT.T_MESSAGE = 'По клиенту отсутствуют выплаты в Депозитарии' "
          + "  WHERE NOT EXISTS(SELECT 1 FROM DNPTXTBEXT_TMP TMP WHERE TMP.T_CLIENTID = SPT.T_CLIENTID) "
          + "    AND SPT.T_MESSAGE = CHR(1)";

  cmd = DL_RSDCommand(query);

  cmd.ExecuteCMD();


  //2.Проверка совпадения резидентности в СОФР и в полученных записях
  //Если налоговый статус субъекта в записи в ответе из Хранилища СНОБ определен и не равен налоговому статусу по анкете клиента в СОФР, то в Протокол выводим сообщение: "Несовпадение налогового статуса клиента".
  //Данные по такому клиенту тоже заносятся в таблицу и выводятся в скроллинг 
  query =   " UPDATE DDLSELECTPT_TMP SPT "
          + "    SET SPT.T_MESSAGE = 'Несовпадение налогового статуса клиента' "
          + "  WHERE SPT.T_CLIENTID IN (SELECT Q.T_CLIENTID "
          + "                             FROM (SELECT DISTINCT TMP.T_CLIENTID, (CASE WHEN TMP.T_TAXPAYERSTATUS = 1 THEN CHR(0) ELSE 'X' END) AS NOTRESIDENT "
          + "                                     FROM DNPTXTBEXT_TMP TMP "
          + "                                    WHERE TMP.T_TAXPAYERSTATUS > 0 "
          + "                                  ) Q, DPARTY_DBT PT "
          + "                            WHERE PT.T_PARTYID = Q.T_CLIENTID "
          + "                              AND PT.T_NOTRESIDENT <> Q.NOTRESIDENT "
          + "                          ) "
          + "    AND SPT.T_MESSAGE = CHR(1)";

  cmd = DL_RSDCommand(query);

  cmd.ExecuteCMD();

  //3.Проверка совпадения резидентности в СОФР и в полученных записях
  //Если налоговый статус в записи в ответе из Хранилища СНОБ не определен, то в Протокол выводим сообщение: "Не определен налоговый статус клиента в записи Хранилища СНОБ". 
  //Данные по такому клиенту тоже заносятся в таблицу и выводятся в скроллинг 
  query =   " UPDATE DDLSELECTPT_TMP SPT "
          + "    SET SPT.T_MESSAGE = 'Не определен налоговый статус клиента в записи Хранилища СНОБ' "
          + "  WHERE SPT.T_CLIENTID IN (SELECT DISTINCT TMP.T_CLIENTID "
          + "                             FROM DNPTXTBEXT_TMP TMP "
          + "                            WHERE TMP.T_TAXPAYERSTATUS = 0 "
          + "                          ) "
          + "    AND SPT.T_MESSAGE = CHR(1)";

  cmd = DL_RSDCommand(query);

  cmd.ExecuteCMD();

  //Транзакция обработки полученных данных
  RslDefCon.BeginTrans();

  //4.Добавляем новые записи
  query =   " INSERT INTO DNPTXTBEXT_DBT (  T_ID              "
          + "                             , T_CLIENTID        "
          + "                             , T_TAXPERIOD       "
          + "                             , T_INCDATE         "
          + "                             , T_INCTIME         "
          + "                             , T_KBKCALC         "
          + "                             , T_KBKKEEP         "
          + "                             , T_TAXBASEKIND     "
          + "                             , T_NOBAMOUNT       "
          + "                             , T_NDFLCALCAMOUNT  "
          + "                             , T_NDFLCALCRATE    "
          + "                             , T_NDFLKEEPAMOUNT  "
          + "                             , T_NDFLKEEPRATE    "
          + "                             , T_TAXPAYERSTATUS  "
          + "                             , T_SYSTEMCODE      "
          + "                             , T_DOCKIND         "
          + "                             , T_DOCID           "
          + "                             , T_ISCHANGED       "
          + "                             , T_LOADDATE        "
          + "                             , T_LOADTIME        "
          + "                             , T_RECORDID        "
          + "                            ) "
          + "             SELECT  0                     "
          + "                   , TMP.T_CLIENTID        "
          + "                   , TMP.T_TAXPERIOD       "
          + "                   , TMP.T_INCDATE         "
          + "                   , TMP.T_INCTIME         "
          + "                   , TMP.T_KBKCALC         "
          + "                   , TMP.T_KBKKEEP         "
          + "                   , TMP.T_TAXBASEKIND     "
          + "                   , TMP.T_NOBAMOUNT       "
          + "                   , TMP.T_NDFLCALCAMOUNT  "
          + "                   , TMP.T_NDFLCALCRATE    "
          + "                   , TMP.T_NDFLKEEPAMOUNT  "
          + "                   , TMP.T_NDFLKEEPRATE    "
          + "                   , TMP.T_TAXPAYERSTATUS  "
          + "                   , TMP.T_SYSTEMCODE      "
          + "                   , ? "
          + "                   , ? "
          + "                   , " + IIF(isFirstLoad, "CHR(0)", "CHR(88)")
          + "                   , TMP.T_LOADDATE        "
          + "                   , TMP.T_LOADTIME        "
          + "                   , TMP.T_RECORDID        "
          + "              FROM DNPTXTBEXT_TMP TMP "
          + "             WHERE NOT EXISTS(SELECT 1 "
          + "                                FROM DNPTXTBEXT_DBT TBEXT "
          + "                               WHERE TBEXT.T_RECORDID = TMP.T_RECORDID "
          + "                             )";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(nptxop.rec.DocKind);
  cmd.AddParam(nptxop.rec.ID);

  cmd.ExecuteCMD();

  //5.Обнуляем по клиентам прежние записи, которых нет в ответе
  query =   " UPDATE DNPTXTBEXT_DBT TBEXT "
          + "    SET TBEXT.T_NOBAMOUNT = 0, "
          + "        TBEXT.T_NDFLCALCAMOUNT = 0, "
          + "        TBEXT.T_NDFLKEEPAMOUNT = 0, "
          + "        TBEXT.T_ISCHANGED = 'X', "
          + "        TBEXT.T_DOCKIND = ?, "
          + "        TBEXT.T_DOCID = ?, "
          + "        TBEXT.T_LOADDATE = ?, "
          + "        TBEXT.T_LOADTIME = ? "
          + " WHERE (TBEXT.T_CLIENTID, TBEXT.T_TAXPERIOD) IN (SELECT SPT.T_CLIENTID, ? FROM DDLSELECTPT_TMP SPT WHERE SPT.T_SELECTFLAG = CHR(88)) " 
          + "   AND NOT EXISTS(SELECT 1 FROM DNPTXTBEXT_TMP TMP WHERE TMP.T_RECORDID = TBEXT.T_RECORDID) ";

  cmd = DL_RSDCommand(query);

  cmd.AddParam(nptxop.rec.DocKind);
  cmd.AddParam(nptxop.rec.ID);
  cmd.AddParam(LoadDate);
  cmd.AddParam(LoadTime);
  cmd.AddParam(TaxPeriod);

  cmd.ExecuteCMD();

  RslDefCon.CommitTrans();

  RemProgress();

OnError(er)
  if(RslDefCon.IsInTrans)
    RslDefCon.RollbackTrans();
    RemProgress();
  end;
    
  AddErrToAllCurrClnt(er.Message);
END;

PRIVATE MACRO ExecReq(nptxop, Req:@variant, isFirstLoad)
  var query, cmd, DataSet;

  _ExecReq(nptxop, @Req, isFirstLoad);

  //Печатать сообщения в файл протокола
  query =   " select spt.t_ClientID, spt.t_Message, pt.t_ShortName, NVL(RSB_SECUR.SC_GetObjCodeOnDate("+OBJTYPE_PARTY+", 101 /*Код ЦФТ*/, spt.t_ClientID), CHR(1)) as ID_CFT"
          + "   from ddlselectpt_tmp spt "
          + "        inner join dparty_dbt pt on pt.t_PartyID = spt.t_ClientID "
          + " order by spt.t_ClientID ASC ";

  cmd = DL_RSDCommand(query);

  DataSet = cmd.Execute();
  while(DataSet.moveNext())
    if(ProtocolStrNum == 0)
      println(toAnsi("Номер п/п;ID СОФР;ФИО;ID ЦФТ;Результат выполнения процедуры", true));
    end;
    
    ProtocolStrNum = ProtocolStrNum + 1;

    println(toAnsi(string(ProtocolStrNum)+";"+
                   string(DataSet.ClientID)+";"+
                   string(DataSet.ShortName)+";"+
                   string(DataSet.ID_CFT)+";"+
                   string(IIF(DataSet.Message != "", DataSet.Message, "Процедура отработала успешно"))
                  , true)
           );
  end;    
END;

private macro _ExecGetSNOBProc(nptxop, isFirstLoad)
  var cmd, query, DataSet, cnt;
  var Req = c_GetReportClientOperationRequest;
  var i = 0;
  var TaxPeriod;

  datesplit(nptxop.rec.PrevDate, NULL, NULL, TaxPeriod);

  var BegDate = date(1,1,TaxPeriod);
  var EndDate = date(31,12,TaxPeriod);

  cmd = DL_RSDCommand();

  if(nptxop.rec.Client == -1)
    query =    " select DISTINCT p.t_PersonID as t_ClientID "
             + "   from dpersn_dbt p "
             + "  where Exists (select 1 "
             + "                  from dnptxobj_dbt obj "
             + "                 where obj.t_Client = p.t_PersonID "
             + "                   and obj.t_Kind IN (select ok.t_Element from dnptxkind_dbt ok where ok.t_Level = 5 and ok.t_Code LIKE 'PlusG%') "
             + "                   and obj.t_Date between ? and ? "
             + "               ) "
             + "     or Exists (select 1 "
             + "                  from dsfcontr_dbt sf, ddlcontr_dbt dlc "
             + "                 where sf.t_PartyID = p.t_PersonID "
             + "                   and sf.t_DateBegin <= ? "
             + "                   and (sf.t_DateClose = " + GetSQLDate(date(0,0,0)) + " or sf.t_DateClose >= ?) "
             + "                   and dlc.t_SfContrID = sf.t_ID "
             + "               ) "
             + "  order by p.t_PersonID ASC "; 

    cmd.AddParam(BegDate);
    cmd.AddParam(EndDate);
    cmd.AddParam(nptxop.rec.OperDate);
    cmd.AddParam(nptxop.rec.OperDate);
  else
    query =    " select pt.t_PartyID as ClientID  "
             + "   from dparty_dbt pt "
             + "  where pt.t_PartyID = ? ";

    cmd.AddParam(nptxop.rec.Client);
  end;

  cnt = cmd.GetCount(query);
  if(cnt > 0)
    InitProgress(cnt, "Получение информации по клиентам", "Получение информации по клиентам");

    DataSet = cmd.Execute(query);

    i = 0;
    InitReq(@Req, TaxPeriod);
    while(DataSet.moveNext())
      
      AddClientToReq(@Req, DataSet.ClientID);

      if(Req.GetReportClientOperationReq.ClientInfoList.size == 100)
        ExecReq(nptxop, @Req, isFirstLoad);
        InitReq(@Req, TaxPeriod);
      end;

      UseProgress(i = i + 1);
    end;

    if(Req.GetReportClientOperationReq.ClientInfoList.size > 0)
      ExecReq(nptxop, @Req, isFirstLoad);
    end;

    RemProgress();
  end;
end;


PRIVATE MACRO GetCSVPath()
  var RegistryPath = "РСХБ\\ДИРЕКТОРИИ\\OUT\\ПРОТОКОЛ_ЗАПРОСА_К_ХРАНИЛИЩУ";
  var Path = "";
  var stat = 0;
 
  GetRegistryValue(RegistryPath, V_STRING, Path, stat);
  if((stat) or (Path == "")) 
    msgbox("Не задана настройка в реестре банка:|", RegistryPath);      
  else
    if(substr(Path, strlen(Path)-1, 1) != "\\")
      Path = Path + "\\";
    end;
  end;

  return Path;
END;

//Точка входа
private macro ExecGetSNOBProc(ID)
  FILE output_file() txt write;
  var nptxop = TBFile("nptxop.dbt");
  var query, cmd, DataSet;
  var isFirstLoad = true;
  var day, mon, year;
  var hour, min, sec;
  
  nptxop.Clear();

  nptxop.rec.ID = ID;
  if(not nptxop.GetEQ)
    msgbox("Не найдена процедура с ID = " + ID);
    return 1;
  end;

  datesplit(nptxop.rec.OperDate, day, mon, year);
  timesplit(time(), hour, min, sec);

  var StartSTBDate = GetStartSTBDate();
  if((РАБОТА_С_ВНЕШНИМ_ХРАНИЛИЩЕМ_СНОБ()) and (StartSTBDate > date(0,0,0)) and (nptxop.rec.OperDate >= StartSTBDate))
    query =   "select 1 "
            + "  from dnptxop_dbt "
            + " where t_DocKind = ? "
            + "   and t_ID <> ? "
            + "   and t_PrevDate = ? "
            + "   and t_OperDate <> ? "
            + "   and ROWNUM = 1 ";

    cmd = DL_RSDCommand(query);

    cmd.AddParam(nptxop.rec.DocKind);
    cmd.AddParam(nptxop.rec.ID);  
    cmd.AddParam(nptxop.rec.PrevDate);
    cmd.AddParam(nptxop.rec.OperDate);
    
    if(cmd.GetCount() > 0)
      isFirstLoad = false;
    end;
          
    var  filename = GetCSVPath()+"Протокол_процедуры_запроса_к_Хранилищу_"+string(year)+string(mon:o:2)+string(day:o:2)+"_"+string(hour:f:2)+string(min:f:2)+".csv";
    if (not Open(output_file, filename, "rsansi"))
      msgbox("Ошибка при открытии файла отчета|" + filename);
      return 0;
    end;

    SetOutput(filename);

    ProtocolStrNum = 0;

    _ExecGetSNOBProc(nptxop, isFirstLoad);

    SetOutput(null, true);

    Close(output_file);
  end;

  return 0;
OnError(er)
  Close(output_file);
end;

