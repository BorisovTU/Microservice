/*
$Name:         dllog_xml.mac
$Module:       Ядро Securities
$Description:  работа в формате xml с протоколом сервисной операции
*/
/*
 PROGRAMMED BY:   Nikolskaya V.
 CREATION DATE:   june 2013
*/
import "globals.mac", "dl_xml.mac", OprInter, "dlmisc.mac", "dlquery.mac";
import RsbDataSet, DealsInter;

PRIVATE CONST CHILD_NODE  = 1,
              ATTR_NODE   = 2;

CONST LOG_TYPE_HEADER  = 0,
      LOG_TYPE_DATA    = 1,
      LOG_TYPE_WARN    = 2,
      LOG_TYPE_ERROR   = 3,
      LOG_TYPE_DATA_PROC = 4;

const REPORT_LIST_END = "</ReportList>";

/* Данные об ошибке*/
class DLOpError( _NUMERROR, _ERROR )
  var NUMERROR = _NUMERROR, 
      ERROR    = _ERROR; 
end;

/*данные протокола СО в XML*/
CLASS (DL_XML) DL_LOG_DATA_XML(pDocKind:integer, pDocumentID:integer, pDataParms:TArray, pType:integer, pVersion:integer)
  private var m_DataParms;
  private var m_RepXml = null;
  private var m_DocKind;
  private var m_DocumentID;
  private var m_Type;
  private var m_Version;

  PRIVATE MACRO GetFileName()
    var RefID, Num;

    if(m_FileName == NULL)

      if( GetReferenceIDByType( 134, 1, RefID) )
      elif( GenerateReference( RefID, Num ) )
      end;

      m_FileName = "SP_LOG_"+string(m_DocKind)+"_"+string(m_DocumentID)+"_"+string(m_Type);

    end;
    
    return m_FileName;
  END;

  PRIVATE MACRO CreateXML()

    var stat = CreateXML();
    
    return stat;

  END;

  PRIVATE MACRO СоздатьУзелСекции(ReportNumber:integer)
    return CreateNode("ReportNumber",
                      "Number", string(ReportNumber)
                     );
  END;

  PRIVATE MACRO СоздатьУзелПроводок(i)
     var УзелПроводок = null;

     if( m_DocKind == SP_AJUSTVALOEB )/*переоценка по рын цене*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Code",             m_DataParms[i].Code,
                                        "AmountSum",        m_DataParms[i].AmountSum,
                                        "CurrCorrValueSum", m_DataParms[i].CurrCorrValueSum,
                                        "PrevCorrValueSum", m_DataParms[i].PrevCorrValueSum,
                                        "Sum",              m_DataParms[i].Sum,
                                        "DtAcc",            m_DataParms[i].DtAcc,
                                        "KtAcc",            m_DataParms[i].KtAcc,
                                        "Ground",           m_DataParms[i].Ground
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == SP_ACCEXPREVOEB )/*Начисление расходов и доходов ОЭБ*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Code",    m_DataParms[i].Code,
                                        "Amount",  m_DataParms[i].Amount,
                                        "PrevSum", m_DataParms[i].PrevSum,
                                        "CurrSum", m_DataParms[i].CurrSum,
                                        "Sum",     m_DataParms[i].Sum,
                                        "SumCCY",  m_DataParms[i].SumCCY,
                                        "DtAcc",   m_DataParms[i].DtAcc,
                                        "KtAcc",   m_DataParms[i].KtAcc,
                                        "Ground",  m_DataParms[i].Ground
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == SP_TRANSFERPA )
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Code",    m_DataParms[i].Code,
                                        "Amount",  m_DataParms[i].Amount,
                                        "Type",    m_DataParms[i].Type,
                                        "Sum",     m_DataParms[i].Sum,
                                        "DtAcc",   m_DataParms[i].DtAcc,
                                        "KtAcc",   m_DataParms[i].KtAcc,
                                        "Ground",  m_DataParms[i].Ground
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == SP_COMISSION_PA )
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "PaymSum", m_DataParms[i].PaymSum,
                                        "Comiss",  m_DataParms[i].Comiss,
                                        "NDS",     m_DataParms[i].NDS,
                                        "DtAcc",   m_DataParms[i].DtAcc,
                                        "KtAcc",   m_DataParms[i].KtAcc,
                                        "Ground",  m_DataParms[i].Ground
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_OVERVALUE )/*переоценка по рын цене*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Code",       m_DataParms[i].Code       ,
                                        "Num",        m_DataParms[i].Num        ,
                                        "Price",      m_DataParms[i].Price      ,
                                        "PriceCcy",   m_DataParms[i].PriceCcy   ,
                                        "BalCost",    m_DataParms[i].BalCost    ,
                                        "NewBalCost", m_DataParms[i].NewBalCost ,
                                        "DtAcc",      m_DataParms[i].DtAcc      ,
                                        "KtAcc",      m_DataParms[i].KtAcc      ,
                                        "Sum",        m_DataParms[i].Sum        ,
                                        "SumCcy",     m_DataParms[i].SumCcy     ,
                                        "Ground",     m_DataParms[i].Ground
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_OVERVALUE_RD )/*переоценка внебаланса*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Deal",        m_DataParms[i].Deal       ,
                                        "FIID",        m_DataParms[i].FIID       ,
                                        "Kind",        m_DataParms[i].Kind       ,
                                        "Summ_RD",     m_DataParms[i].Summ_RD    ,
                                        "Summ_RD_NEW", m_DataParms[i].Summ_RD_NEW,
                                        "Curr",        m_DataParms[i].Curr       ,
                                        "Num",         m_DataParms[i].Num        ,
                                        "Price",       m_DataParms[i].Price      ,
                                        "DtAcc",       m_DataParms[i].DtAcc      ,
                                        "KtAcc",       m_DataParms[i].KtAcc      ,
                                        "Summa",       m_DataParms[i].Summa      ,
                                        "NKD",         m_DataParms[i].NKD      
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_OVERVALUE_NVPI )/*переоценка нвпи*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Deal",   m_DataParms[i].Deal,
                                        "FiCode", m_DataParms[i].FiCode,
                                        "Kind",   m_DataParms[i].Kind,
                                        "SumTO",  m_DataParms[i].SumTO,
                                        "CurTO",  m_DataParms[i].CurTO,
                                        "DtAcc",  m_DataParms[i].DtAcc,
                                        "KtAcc",  m_DataParms[i].KtAcc,
                                        "Summa",  m_DataParms[i].Summa
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_GET_INCOME )/*ПДД*/
        if( m_Version == 1 )
           if( m_DataParms[i].Kind == 6 )
              УзелПроводок = CreateElement("Property",
                                           "Fi_Code",    m_DataParms[i].FI_Code,
                                           "Fi_Name",    m_DataParms[i].FI_Name,
                                           "IsNullCoup", m_DataParms[i].IsNullCoup,
                                           "IsNullPart", m_DataParms[i].IsNullPart
                                          );
           elif( m_DataParms[i].Kind == 1000 )
              УзелПроводок = CreateElement("Property",
                                           "Fi_Code",    m_DataParms[i].FI_Code,
                                           "Fi_Name",    m_DataParms[i].FI_Name,
                                           "Drawing_Date", m_DataParms[i].DrawingDate
                                          );
           else
             УзелПроводок = CreateElement("Property",
                                          "Kind",       m_DataParms[i].Kind,       
                                          "ID",         m_DataParms[i].ID,         
                                          "Code",       m_DataParms[i].Code,       
                                          "Amount",     m_DataParms[i].Amount,     
                                          "Point",      m_DataParms[i].Point,      
                                          "OldIncome",  m_DataParms[i].OldIncome,  
                                          "NewIncome",  m_DataParms[i].NewIncome,  
                                          "Sum",        m_DataParms[i].Sum,        
                                          "SumCCY",     m_DataParms[i].SumCCY,     
                                          "DtAcc",      m_DataParms[i].DtAcc,      
                                          "KtAcc",      m_DataParms[i].KtAcc,      
                                          "Ground",     m_DataParms[i].Ground    
                                         );
           end;
        else
           УзелПроводок = CreateElement("Property");
        end;

     elif( m_DocKind == DL_OFFBALTRANSFSRVOP )/*Перенос по внебалансу*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "DealCode",        m_DataParms[i].DealCode,       
                                        "DealKindName",    m_DataParms[i].DealKindName,         
                                        "PartyCode",       m_DataParms[i].PartyCode,       
                                        "PayerAccount",    m_DataParms[i].PayerAccount,     
                                        "ReceiverAccount", m_DataParms[i].ReceiverAccount,      
                                        "Amount",          m_DataParms[i].Amount,  
                                        "FICode",          m_DataParms[i].FICode    
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_INACCSRVOP )/*Внутренний учет*/
        if( m_Version == 1 )
           //сохраняется лог по проблемным счетам (при закрытии счетов)
           if((GenPropID(m_DataParms[i], "Kind") != -1) AND (m_DataParms[i].Kind == 2))
              УзелПроводок = CreateElement("Property",
                                           "Code",    m_DataParms[i].Code,
                                           "Account", m_DataParms[i].Account,
                                           "Note",    m_DataParms[i].Note
                                          );

           else
              УзелПроводок = CreateElement("Property",
                                           "DealKindName",    m_DataParms[i].DealKindName, 
                                           "DealCode",        m_DataParms[i].DealCode,       
                                           "InAccKindName",   m_DataParms[i].InAccKindName,         
                                           "PayerAccount",    m_DataParms[i].PayerAccount,     
                                           "ReceiverAccount", m_DataParms[i].ReceiverAccount,      
                                           "Amount",          m_DataParms[i].Amount,  
                                           "FICode",          m_DataParms[i].FICode    
                                          );
           end;
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif(m_DocKind == DL_SСACCOUNTING)
        if( m_Version == 1 )
           //сохраняется секци по периодическим комиссиям
           if( m_DataParms[i].Kind == 0 )
              УзелПроводок = CreateElement("Property",
                                           "SfContrID",   m_DataParms[i].SfContrID,  
                                           "ComisCode",   m_DataParms[i].ComisCode,  
                                           "DebAccount",  m_DataParms[i].DebAccount,        
                                           "CredAccount", m_DataParms[i].CredAccount,  
                                           "Amount",      m_DataParms[i].Amount,           
                                           "Currency",    m_DataParms[i].Currency   
                                          );
           //сохраняется лог по проблемным счетам (при закрытии счетов)
           elif( (m_DataParms[i].Kind == 1) or (m_DataParms[i].Kind == 2) )
              УзелПроводок = CreateElement("Property",
                                           "Code",    m_DataParms[i].Code,
                                           "Account", m_DataParms[i].Account,
                                           "Note",    m_DataParms[i].Note
                                          );
           //сохраняется лог по нулевым купонам/ЧП
           elif( m_DataParms[i].Kind == 3 )
              УзелПроводок = CreateElement("Property",
                                           "Fi_Code",    m_DataParms[i].FI_Code,
                                           "Fi_Name",    m_DataParms[i].FI_Name,
                                           "IsNullCoup", m_DataParms[i].IsNullCoup,
                                           "IsNullPart", m_DataParms[i].IsNullPart
                                          );
           //сохраняется лог выпусков по репо с непогашенными купонами/ЧП
           elif( m_DataParms[i].Kind == 4 )
              УзелПроводок = CreateElement("Property",
                                           "Fi_Code",    m_DataParms[i].FI_Code,
                                           "Fi_Name",    m_DataParms[i].FI_Name,
                                           "REPOCODE", m_DataParms[i].REPOCODE,
                                           "COUP_NUMBER", m_DataParms[i].COUP_NUMBER,
                                           "COUP_DRAWINGDATE", m_DataParms[i].COUP_DRAWINGDATE
                                          );
           end;
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( (m_DocKind == DL_DVOPER_OVERVALUE) or (m_DocKind == DL_DVOPER_FIXING) )/*Переоценка ПИ и фиксинг*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "DealCode",     m_DataParms[i].DealCode,
                                        "ReqOrCom",     m_DataParms[i].ReqOrCom,
                                        "SumReqOrCom",  m_DataParms[i].SumReqOrCom,
                                        "SumCcy",       m_DataParms[i].SumCcy,
                                        "DebetAcc",     m_DataParms[i].DebetAcc,
                                        "CreditAcc",    m_DataParms[i].CreditAcc,
                                        "SumOverValue", m_DataParms[i].SumOverValue,
                                        "OffRate",      m_DataParms[i].OffRate,     
                                        "ExchDiff",     m_DataParms[i].ExchDiff,  
                                        "BAOverReg",    m_DataParms[i].BAOverReg,       
                                        "BAEquivalent", m_DataParms[i].BAEquivalent,     
                                        "KAOverReg",    m_DataParms[i].KAOverReg,    
                                        "KAEquivalent", m_DataParms[i].KAEquivalent 
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == SP_CALCRESERV )/*Расчет суммы обеспечения по резервам*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "DealID",   m_DataParms[i].DealID,
                                        "Mes",      m_DataParms[i].Mes
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_RESERVEDOC)
        if(m_Version == 1)
          УзелПроводок = CreateElement("Property",
                                       "ObjID",      m_DataParms[i].ObjID,
                                       "ResPc",      m_DataParms[i].ResPc,
                                       "RiskGrp",    m_DataParms[i].RiskGrp,
                                       "BaseSum",    m_DataParms[i].BaseSum,
                                       "OldReserv",  m_DataParms[i].OldReserv,
                                       "BaseAcc",    m_DataParms[i].BaseAcc,
                                       "ReservAcc",  m_DataParms[i].ReservAcc,
                                       "AccDbt",     m_DataParms[i].AccDbt,
                                       "AccCred",    m_DataParms[i].AccCred,
                                       "IsDealNtg",  m_DataParms[i].IsDealNtg,
                                       "CostRUR",    m_DataParms[i].CostRUR,
                                       "MarketSum",  m_DataParms[i].MarketSum,
                                       "IsBiVal",    m_DataParms[i].IsBiVal,
                                       "GuarantSum", m_DataParms[i].GuarantSum,
                                       "ResKind",    m_DataParms[i].ResKind,
                                       "CorrectSum", m_DataParms[i].CorrectSum,
                                       "IsSetting",  m_DataParms[i].IsSetting,
                                       "ReqAcc",     m_DataParms[i].ReqAcc,
                                       "ResPcSec",   m_DataParms[i].ResPcSec,
                                       "RiskGrpSec", m_DataParms[i].RiskGrpSec,
                                       "AccRest_BPP",m_DataParms[i].AccRest_BPP,
                                       "AccRest_OD", m_DataParms[i].AccRest_OD,
                                       "KindPortf",  m_DataParms[i].KindPortf,
                                       "FIRole",     m_DataParms[i].FIRole,
                                       "DATERESERV", m_DataParms[i].DateReserv
                                       );
        else
           УзелПроводок = CreateElement("Property");

        end;
     elif( m_DocKind == DL_CALCTSS )
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "FIID",    m_DataParms[i].FIID,
                                        "Rate",    m_DataParms[i].Rate,
                                        "RateFIID",m_DataParms[i].RateFIID,
                                        "Msg",     m_DataParms[i].Msg
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DL_RENUMBERINGDEALS )/*Перенумерация сделок/операций*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "NewCode",   m_DataParms[i].NewCode,       
                                        "OldCode",   m_DataParms[i].OldCode,         
                                        "ExtCode",   m_DataParms[i].ExtCode,       
                                        "Date",      m_DataParms[i].DDate,     
                                        "Time",      m_DataParms[i].DTime,      
                                        "ID",        m_DataParms[i].ID,  
                                        "Module",    m_DataParms[i].Module,
                                        "KindOper",  m_DataParms[i].KindOper
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == REPOS_SERVICEOPERATION )/*Репозитарный учет*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Action",    m_DataParms[i].Action,
                                        "DealCode",  m_DataParms[i].DealCode,
                                        "MsgCode",   m_DataParms[i].MsgCode,
                                        "Status",    m_DataParms[i].Status,
                                        "DealID",    m_DataParms[i].DealID,
                                        "DealKind",  m_DataParms[i].DealKind
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == REPOS_MESSAGEGENERATION )/*Генерация сообщений*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "DealCode",  m_DataParms[i].DealCode,
                                        "MsgCode",   m_DataParms[i].MsgCode,
                                        "Status",    m_DataParms[i].Status
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == DV_CSAPSO )/*СО начисления процентов по CSA*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Message", m_DataParms[i].Message
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == SP_IMPOWNLIST)
       if( m_Version == 1 )
           if((GenPropID(m_DataParms[i], "Kind") != -1) AND (m_DataParms[i].Kind == 0))
             УзелПроводок = CreateElement("Property",
                                          "CntTotal",          m_DataParms[i].CntTotal,
                                          "CntIndvRes",        m_DataParms[i].CntIndvRes,       
                                          "CntIndvResFact",    m_DataParms[i].CntIndvResFact,   
                                          "CntIndvNotRes",     m_DataParms[i].CntIndvNotRes,    
                                          "CntIndvNotResFact", m_DataParms[i].CntIndvNotResFact,
                                          "CntLeglRes",        m_DataParms[i].CntLeglRes,       
                                          "CntLeglResFact",    m_DataParms[i].CntLeglResFact,   
                                          "CntLeglNotRes",     m_DataParms[i].CntLeglNotRes,    
                                          "CntLeglNotResFact", m_DataParms[i].CntLeglNotResFact,
                                          "CntTaxExpampt",     m_DataParms[i].CntTaxExpampt,    
                                          "CntNotUpdate",      m_DataParms[i].CntNotUpdate     
                                         );

           elif((GenPropID(m_DataParms[i], "Kind") != -1) AND (m_DataParms[i].Kind == 1))
             УзелПроводок = CreateElement("Property",
                                          "ListOwnerFullName",  m_DataParms[i].ListOwnerFullName, 
                                          "OwnerCode",          m_DataParms[i].OwnerCode,         
                                          "ListOwnerCode",      m_DataParms[i].ListOwnerCode,     
                                          "FindParamName",      m_DataParms[i].FindParamName,     
                                          "OthernessParamName", m_DataParms[i].OthernessParamName,
                                          "LisTParamValue",     m_DataParms[i].LisTParamValue,    
                                          "ParamValue",         m_DataParms[i].ParamValue,        
                                          "Result",             m_DataParms[i].Result            
                                         );

           elif((GenPropID(m_DataParms[i], "Kind") != -1) AND (m_DataParms[i].Kind == 2))
             УзелПроводок = CreateElement("Property",
                                          "ListOwnerFullName",  m_DataParms[i].ListOwnerFullName,
                                          "OwnerCode",          m_DataParms[i].OwnerCode,        
                                          "ListOwnerCode",      m_DataParms[i].ListOwnerCode,    
                                          "FindParamName",      m_DataParms[i].FindParamName,    
                                          "MissingParamName",   m_DataParms[i].MissingParamName, 
                                          "LisTParamValue",     m_DataParms[i].LisTParamValue,   
                                          "Result",             m_DataParms[i].Result           
                                         );

           elif((GenPropID(m_DataParms[i], "Kind") != -1) AND (m_DataParms[i].Kind == 3))
             УзелПроводок = CreateElement("Property",
                                          "ListOwnerFullName",  m_DataParms[i].ListOwnerFullName,
                                          "ListOwnerCode",      m_DataParms[i].ListOwnerCode,    
                                          "Result",             m_DataParms[i].Result,           
                                          "Note",               m_DataParms[i].Note             
                                         );
           elif((GenPropID(m_DataParms[i], "Kind") != -1) AND (m_DataParms[i].Kind == 4))
             УзелПроводок = CreateElement("Property",
                                          "PartyName",          m_DataParms[i].PartyName,
                                          "Pseudonym",          m_DataParms[i].Pseudonym,    
                                          "Note",               m_DataParms[i].Note             
                                         );
           end;
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == LIMITQ_PROTOCOL)
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "MarketKind",       m_DataParms[i].MarketKind,
                                        "CalcTotal",        m_DataParms[i].CalcTotal,
                                        "CalcCash",         m_DataParms[i].CalcCash,
                                        "CalcSecurities",   m_DataParms[i].CalcSecurities,
                                        "Error",            m_DataParms[i].Error,
                                        "HandErrResult",    m_DataParms[i].HandErrResult
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif( m_DocKind == SP_AMORTHEDGCORR )/*Амортизация корректировок хеджирования*/
        if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "Code",    m_DataParms[i].Code,
                                        "Sum",     m_DataParms[i].Sum,
                                        "SumCCY",  m_DataParms[i].SumCCY,
                                        "DtAcc",   m_DataParms[i].DtAcc,
                                        "KtAcc",   m_DataParms[i].KtAcc,
                                        "Ground",  m_DataParms[i].Ground
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     elif (m_DocKind == DV_SRVOP_AMORT_RHDP)
      if( m_Version == 1 )
           УзелПроводок = CreateElement("Property",
                                        "IDObj",         m_DataParms[i].IDObj,
                                        "TypeObj",       m_DataParms[i].TypeObj,
                                        "DateFirst",     m_DataParms[i].DateFirst,
                                        "IDInstr",       m_DataParms[i].IDInstr,
                                        "DataInstr",     m_DataParms[i].DataInstr,
                                        "IDRel",         m_DataParms[i].IDRel,
                                        "CodePortf",     m_DataParms[i].CodePortf,
                                        "CodeSubPortf",  m_DataParms[i].CodeSubPortf,
                                        "DateEndPlan",   m_DataParms[i].DateEndPlan,
                                        "DateEndFact",   m_DataParms[i].DateEndFact,
                                        "SumRHDPEndR",   m_DataParms[i].SumRHDPEndR,
                                        "SumRHDPOp",     m_DataParms[i].SumRHDPOp,
                                        "SumSa",         m_DataParms[i].SumSa,
                                        "TxtLine",       m_DataParms[i].TxtLine,
                                        "ErrorLine",     m_DataParms[i].ErrorLine
                                       );
        else
           УзелПроводок = CreateElement("Property");
        end;
     else
        УзелПроводок = CreateElement("Property");
     end;
     
     return УзелПроводок;
  END;

  PRIVATE MACRO СоздатьУзелОшибок(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "NumError",  m_DataParms[i].NumError, 
                                   "Error", m_DataParms[i].Error
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;
     
     return УзелОшибок;
  END;

  PRIVATE MACRO СоздатьУзелПредупреждений(i)
     var УзелОшибок = null;

     if( m_Version == 1 )
        УзелОшибок = CreateElement("Property",
                                   "Warning",  m_DataParms[i].Warning
                                  );
     else
        УзелОшибок = CreateElement("Property");
     end;
     
     return УзелОшибок;
  END;

  PRIVATE MACRO ConvertRepDataToXML()
    var i = 0;
    var УзелСекции = null, УзелДанныхСекции = null;
    var PrevReportNumber = -1, ReportNumber = -1;

    /*формируем по нашей бумаге строку XML*/
    m_RepXml = "";
    while( i < m_DataParms.Size )

       if( m_Type == LOG_TYPE_DATA )

          if( (m_DocKind == DL_OVERVALUE) or (m_DocKind == DL_GET_INCOME) or (m_DocKind == DL_SСACCOUNTING) or (m_DocKind == SP_IMPOWNLIST) or
              ((m_DocKind == DL_INACCSRVOP) and (GenPropID(m_DataParms[i], "Kind") != -1)))
             ReportNumber = m_DataParms[i].Kind;
          else
             ReportNumber = 0;/*для переоценки Т\О и НВПИ пока только единственная форма*/
          end;

          if( PrevReportNumber != ReportNumber )
             if( УзелСекции != null )
                m_RepXml = m_RepXml + УзелСекции.xml;
             end;
             УзелСекции   = СоздатьУзелСекции(ReportNumber);
          end;
          УзелДанныхСекции = СоздатьУзелПроводок(i);
          УзелСекции.appendChild(УзелДанныхСекции);
         
          PrevReportNumber = ReportNumber;
       elif( m_Type == LOG_TYPE_WARN )

          if( PrevReportNumber != 0 )
             if( УзелСекции != null )
                m_RepXml = m_RepXml + УзелСекции.xml;
             end;
             УзелСекции   = СоздатьУзелСекции(0);
          end;

          УзелДанныхСекции = СоздатьУзелПредупреждений(i);
          УзелСекции.appendChild(УзелДанныхСекции);
         
          PrevReportNumber = 0;
       elif( m_Type == LOG_TYPE_ERROR )

          if( m_DocKind == DL_INACCSRVOP )
             ReportNumber = m_DataParms[i].RepNumber;
          else
             ReportNumber = 0;
          end;

          if( PrevReportNumber != ReportNumber )
             if( УзелСекции != null )
                m_RepXml = m_RepXml + УзелСекции.xml;
             end;
             УзелСекции   = СоздатьУзелСекции(ReportNumber);
          end;

          УзелДанныхСекции = СоздатьУзелОшибок(i);
          УзелСекции.appendChild(УзелДанныхСекции);
         
          PrevReportNumber = ReportNumber;
       end;

       i = i + 1;

    end;

    if( УзелСекции != null )
       m_RepXml = m_RepXml + УзелСекции.xml;
    end;

  END;

  MACRO GetDataXML()
     if( m_RepXml == null )
        ConvertRepDataToXML();
        return m_RepXml;
     end;
     return "";
  end;

  /*специально сохранять в файл не требовалось, но если надо, то к m_RepXml надо лепить заголовок (но схвостом) из DL_LOG_HEADER_XML*/
  PRIVATE MACRO SaveXML()
     return 0;
  END;

  macro Construct( pDocKind, pDocumentID, pDataParms, pType, pVersion );
     m_DataParms = pDataParms;
     m_RepXml = null;
     m_DocKind = pDocKind;
     m_DocumentID = pDocumentID;
     m_Type = pType;
     m_Version = IIF(pVersion == null, 1, pVersion);

     CreateXML();
  end;

  initDL_XML();
  this.Construct( pDocKind, pDocumentID, pDataParms, pType, pVersion );

END;

/*заголовок протокола в XML*/
CLASS (DL_XML) DL_LOG_HEADER_XML(pDocKind:integer)
  private var m_HeaderXml;
  private var m_DocKind = pDocKind;

  PRIVATE MACRO СоздатьУзелЛиста()
    return CreateNode("ReportList");
  END;

  PRIVATE MACRO СоздатьУзелВерсииОтчета()
    return CreateNode("ReportVersion");
  END;

  PRIVATE MACRO СоздатьВерсиюОтчета()
     return CreateElement("Property",
                          "Version", "1"
                         );
  END;

  MACRO GetHeaderXML()
     var УзелЛист, УзелВерсииОтчета, ВерсияОтчета;

     if( m_HeaderXml == null )   

        УзелЛист = СоздатьУзелЛиста();
        УзелВерсииОтчета = СоздатьУзелВерсииОтчета();
        ВерсияОтчета = СоздатьВерсиюОтчета();

        УзелВерсииОтчета.appendChild(ВерсияОтчета);
        УзелЛист.appendChild(УзелВерсииОтчета);

        AddMainNode(УзелЛист);

        m_HeaderXml = m_xml.xml;

        /*откусим хвост*/            
        m_HeaderXml = SubStr(m_HeaderXml, 1, (Index(m_HeaderXml, REPORT_LIST_END)) - 1 );

        return m_HeaderXml;

     end;

     return "";
  end;

  CreateXML();
END;

macro DL_InsertLogXMLData( DocumentID, DocKind, Type, Oper, RepXML, ID_Operation:integer, ID_Step:integer )
  var query, cmd, cmd1, DataSet;

  cmd1 = DL_RSDCommand("SELECT NVL(MAX(T_ID), 0) LogID FROM DDL_LOG_DBT WHERE T_DOCKIND = ? AND T_DOCID = ? AND T_OPER = ?");
  cmd1.AddParam(DocKind);
  cmd1.AddParam(DocumentID);
  cmd1.AddParam(Oper);
  DataSet = cmd1.Execute();
  if((DataSet.moveNext()) and (DataSet.LogID > 0))

    var ID_Operation_:integer = 0, ID_Step_:integer = 0;

    if( ID_Operation != null )
       ID_Operation_ = ID_Operation;
    end;

    if( ID_Step != null )
       ID_Step_ = ID_Step;
    end;

    query = "INSERT INTO DDL_LOGDATA_DBT (T_ID, T_LOGID, T_ID_OPERATION, T_ID_STEP, T_TYPE, T_LOGDATA ) "
            + "                  VALUES  (?, ?, ?, ?, ?, ?)";

    cmd = RSDCommand( query );

    cmd.NullConversion = true;
    cmd.addParam( "", RSDBP_IN, 0 );
    cmd.addParam( "", RSDBP_IN, int(DataSet.LogID) );   
    cmd.addParam( "", RSDBP_IN, ID_Operation_ );
    cmd.addParam( "", RSDBP_IN, ID_Step_ );
    cmd.addParam( "", RSDBP_IN, Type );    
    cmd.addParam( "", RSDBP_IN, RepXML );     
    cmd.execute();
  end; 
end;

macro DL_SaveDataForReport_XML( DocumentID:integer, DocKind:integer, DataParms:TArray, Type:integer, ID_Operation:integer, ID_Step:integer, Oper )

  var RepXML = "";

  if (not Oper)
    Oper = {Oper};
  end;

  if( DataParms.Size > 0 )
     RepXML = DL_LOG_DATA_XML(DocKind,DocumentID,DataParms,Type).GetDataXML();
  end;

  if( RepXML != "" )
     var Header = DL_LOG_HEADER_XML(DocKind).GetHeaderXML();

     DL_InsertHeaderLog(DocumentID, DocKind, Oper, Header);
     DL_InsertLogXMLData(DocumentID, DocKind, Type, Oper, RepXML, ID_Operation, ID_Step);
  end;

end;

macro DL_DeleteDataByStep_XML( ID_Operation:integer, ID_Step:integer )
  var cmd = RSDCommand(" delete from ddl_logdata_dbt where t_ID_Operation = ? and t_ID_Step = ? ");
  cmd.addParam("", RSDBP_IN, ID_Operation);
  cmd.addParam("", RSDBP_IN, ID_Step);
  cmd.Execute();
end;

/* оставить 2 знака */
private macro MakeMoney( Summa:STRING )
   return Round(money(double(Summa)), 2);
end;

/* в xml файле дата приходит в формате "MM/DD/YYYY"
*  АСТРА: msxml под вайном записывает дату в формате "DD.MM.YYYY", поэтому добавил альтернативный вариант парсинга
*/
private macro ПолучитьДату(str:string):date
   var YYYY:integer, MM:integer, DD:integer, pos:integer;
   
   if( ( pos = Index(str, "/") ) > 0 )
      MM = int(SubStr(str, 1, pos));
      str = SubStr(str, pos + 1);

      pos = Index(str, "/");
      DD = int(SubStr(str, 1, pos));
      str = SubStr(str, pos + 1);

   elif( ( pos = Index(str, ".") ) > 0 )
      DD = int(SubStr(str, 1, pos));
      str = SubStr(str, pos + 1);

      pos = Index(str, ".");
      MM = int(SubStr(str, 1, pos));
      str = SubStr(str, pos + 1);
   end;

   YYYY = int(str);

   return date(DD, MM, YYYY);
end;

private macro LZ( num, len )
  var str1, len1;

  str1 = trim(string(num));
  len1 = strlen(str1);

  if( len1 >= len )
     return str1;
  else
     return mkstr("0", len-len1) + str1;
  end;
end;

/* в xml файле дата приходит в формате "hh:mm:ss AM", "hh:mm:ss PM"*/
private macro ПолучитьВремя(str:string):time

   var hh:integer, mm:integer, ss:integer, AMPM:string = "";
   var RetVal = time(0,0,0);

   if( str == "12:00:00 AM" )
      RetVal = time(0,0,0);
   elif( str == "12:00:00 PM" )
      RetVal = time(12,0,0);
   else
      str = LZ(str, 11);

      hh   = int(substr(str, 1, 2));
      mm   = int(substr(str, 4, 2));
      ss   = int(substr(str, 7, 2));
      AMPM = substr(str, 10, 2);

      RetVal = time(IIF(AMPM == "PM", IIF(hh==12, 0, hh)+12, hh), mm, ss);
   end;

   return RetVal;
end;

/* Получить значение атрибута тэга */
macro DL_ReadTagAttribut(node:object, name:string, DataType:integer, retval)

   var ret;
   var i:integer;
   var child:object;
   i=0;
   while( i < node.attributes.length )
     child = node.attributes.item(i);
     if( child and (child.nodeType == ATTR_NODE) )
        if ( StrUpr(child.NodeName) == name )
           if(DataType == V_DATE)
              ret = ПолучитьДату(child.nodeValue);
           elif(DataType == V_INTEGER)
              ret = int(child.nodeValue);
           elif(DataType == V_MONEY)
              ret = MakeMoney(child.nodeValue);
           elif(DataType == V_DOUBLE)
              ret = double(child.nodeValue);
           elif(DataType == V_STRING)
              ret = child.nodeValue;
           elif(DataType == V_TIME)
              ret = ПолучитьВремя(child.nodeValue);
           elif(DataType == V_BOOL)
              ret = IIF(child.nodeValue>0, true, false);           
           end;
           setparm(3, ret);
           return true;
        end;
     end;
     i= i + 1;
   end;

   return false;
end;

/*протокол из XML*/
CLASS (DL_XML) DL_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)
  private var m_DocKind;
  private var m_DocumentID;
  private var m_Type;

  private var m_OnlyLastReport;

  private var m_CurrentReportLineData = null;

  private var m_child_ReportList = null,
              m_child_ReportVersion = null,
              m_child_ReportNumber = null;

  private var m_ReportNumber = -1,  m_ReportVersion = -1;
  private var m_i = 0, m_k = 0;
  private var node = null;

  PRIVATE MACRO GetFileName()
    var RefID, Num;

    if(m_FileName == NULL)

      if( GetReferenceIDByType( 134, 1, RefID) )
      elif( GenerateReference( RefID, Num ) )
      end;

      m_FileName = "SP_LOG_"+string(m_DocKind)+"_"+string(m_DocumentID)+"_"+string(m_Type);

    end;
    
    return m_FileName;
  END;

  PRIVATE MACRO SaveXML()
    RemoveEmpty();
    SaveXML();
  END;

  PRIVATE MACRO CreateXML()

    var stat = CreateXML();
    
    return stat;

  END;

  MACRO PutToFile(pxml_str)
    if( pxml_str != null )
       m_xml.loadXML(pxml_str);
       SaveXML();
       return GetFileName();
    end;
    return null;
  END;

  macro GetDataFromXMLByDocKind()/*переопределить для своего протокола*/
     return null;
  end;

  macro Rewind()

     node = m_xml.documentElement;

     m_child_ReportList = m_child_ReportVersion = m_child_ReportNumber = null;
     m_ReportVersion = -1;
     m_i = m_k = 0;
     m_CurrentReportLineData = null;

  end;

  private macro NextReportNumber()

     m_CurrentReportLineData = null;

     if( (m_child_ReportList != null) and (m_k < m_child_ReportList.childNodes.length) ) 
        m_child_ReportNumber = m_child_ReportList.childNodes.item(m_k);

        if(m_child_ReportNumber and (m_child_ReportNumber.nodeType==CHILD_NODE))
          
           /*разобрать строку*/
           if(m_child_ReportNumber.tagname == "Property")
              m_CurrentReportLineData = GetDataFromXMLByDocKind();
           end;

        end;

        m_k= m_k + 1;

     end;
     
     return (m_CurrentReportLineData!=null);
  end;

  private macro NextReportList()
     var ReportNumber = -1;

     m_CurrentReportLineData = null;

     if( node and (m_i < node.childNodes.length) ) 
        m_child_ReportList = node.childNodes.item(m_i);

        if( m_child_ReportList.tagname == "ReportNumber" )

           if(DL_ReadTagAttribut(m_child_ReportList, "NUMBER", V_INTEGER, ReportNumber) == false)
           end;

           if( ReportNumber == m_ReportNumber )
              m_k=0;
              NextReportNumber();
           end;

        elif( m_child_ReportList.tagname == "ReportVersion" )
           m_child_ReportVersion = m_child_ReportList.childNodes.item(0);
           /*разобрать строку*/
           if(m_child_ReportVersion and (m_child_ReportVersion.nodeType==CHILD_NODE))
              if(m_child_ReportVersion.tagname == "Property")
                 if(DL_ReadTagAttribut(m_child_ReportVersion, "VERSION", V_INTEGER, m_ReportVersion) == false)
                 end;
              end;
           end;

        end;

        m_i= m_i + 1;
     else
        return true;
     end;
     
     return (m_CurrentReportLineData != null);
  end;

  /*перейти к следующей печатаемой строке*/
  macro Next()
     if( not NextReportNumber() )
        while( not NextReportList() )
        end;
     else
        return true;
     end;
     
     return (m_CurrentReportLineData!=null);
  end;

  /*получить печатаемую строку*/
  macro GetReportLineData()
     return m_CurrentReportLineData;
  end;

  /*определить номер печатаемой формы протокола*/
  macro SetReportNumber(_ReportNumber:integer)
     m_ReportNumber = _ReportNumber;
     Rewind();
  end;

  private macro SelectPartXMLStr(LogDataID, substrsize, offset)
    var PartXmlStr = "";
    var cmd, DataSet;

    cmd = RSDCommand(  " select NVL(DBMS_LOB.SUBSTR(t_logdata, ?, ?), CHR(1)) PartXmlStr "
                     + "   from ddl_logdata_dbt "
                     + "  where t_ID = ?"
                    );

    cmd.AddParam("", RSDBP_IN, substrsize );
    cmd.AddParam("", RSDBP_IN, offset );
    cmd.AddParam("", RSDBP_IN, LogDataID );

    cmd.Execute();

    DataSet = TRsbDataSet(cmd);
    if(DataSet.moveNext())
      PartXmlStr = DataSet.PartXmlStr;
    end;

    return PartXmlStr;
  end;

  private macro SelectXMLStr(LogDataID)
    var substrsize = 4000; //!!!Больше нельзя
    var cmd;
    var XmlStr = "", PartXmlStr = "";
    var i = 0;

    PartXmlStr = SelectPartXMLStr(LogDataID, substrsize, i*substrsize+1);
    while(PartXmlStr != "")
      XmlStr = XmlStr + PartXmlStr;
      i = i + 1;
      
      PartXmlStr = SelectPartXMLStr(LogDataID, substrsize, i*substrsize+1);
    end;

    return XmlStr;
  end;

  private macro GetXmlStr()                                                                    
                                                                                       
    var RepXml = "", Query = "";                                                       
                                                                                       
    /*заголовок по операции должен быть один*/                                         
    var cmd_header = RSDCommand("select DBMS_LOB.SUBSTR(d.t_logdata) logdata "+        
                                "  from ddl_logdata_dbt d, DDL_LOG_DBT log "+          
                                " where d.T_LOGID = log.t_ID "+                        
                                "   and log.T_DOCKIND = "+m_DocKind+                   
                                "   AND log.T_DOCID = "+m_DocumentID+                  
                                "   AND d.T_TYPE = "+LOG_TYPE_HEADER+                  
                                " order by log.t_ID desc"                              
                               );                                                      
                                                                                       
    cmd_header.execute();                                                              
                                                                                       
    var DataHeader = TRsbDataSet(cmd_header);                                          
                                                                                       
    if( DataHeader.MoveNext() )                                                        
       RepXml = RepXml + DataHeader.logdata;                                           
                                                                                       
       if( m_OnlyLastReport )                                                            
          Query = Query + "select d.t_ID LogDataID "+              
                          "  from ddl_logdata_dbt d "+                                 
                          " where d.T_LOGID = (select max(log.t_ID)  "+                
                          "                      from DDL_LOG_DBT log "+               
                          "                       where log.T_DOCKIND = "+m_DocKind+   
                          "                       AND log.T_DOCID = "+m_DocumentID+")"+
                          "   AND d.T_TYPE != "+LOG_TYPE_HEADER+                       
                          "   AND d.T_TYPE = "+m_Type+                                   
                          " order by d.T_TYPE, d.T_ID";                                
       else                                                                            
          Query = Query + "select d.t_ID LogDataID "+              
                          "  from ddl_logdata_dbt d, DDL_LOG_DBT log "+                
                          " where d.T_LOGID = log.t_ID "+                              
                          "   and log.T_DOCKIND = "+m_DocKind+                         
                          "   AND log.T_DOCID = "+m_DocumentID+                        
                          "   AND d.T_TYPE != "+LOG_TYPE_HEADER+                       
                          "   AND d.T_TYPE = "+m_Type+                                 
                          " order by d.T_TYPE, d.T_ID";                                
       end;                                                                            
                                                                                       
       var cmd = RSDCommand( Query );                                                  
       var Datacmd;                                                                    
                                                                                       
       cmd.execute();                                                                  
                                                                                       
       Datacmd = TRsbDataSet(cmd);                                                     
                                                                                       
       while( Datacmd.MoveNext() )                                                     
          //для каждой отобранной записи будем вынимать xml-строку частями
          RepXml = RepXml + SelectXMLStr(Datacmd.LogDataID);                                           
       end;                                                                            
       RepXml = RepXml + REPORT_LIST_END;                                              
                                                                                       
    end;                                                                               
                                                                                       
    return RepXml;                                                                     
  end;                                                                                 

  macro Construct( pDocKind, pDocumentID, pType, pOnlyLastReport );

     m_DocKind = pDocKind;
     m_DocumentID = pDocumentID;
     m_Type = pType;
   
     m_OnlyLastReport = pOnlyLastReport;
   
     m_CurrentReportLineData = null;
   
     m_child_ReportList = null;
     m_child_ReportVersion = null;
     m_child_ReportNumber = null;
   
     m_ReportNumber = -1;  m_ReportVersion = -1;
     m_i = 0; m_k = 0;
     node = null;

     if( CreateXML() )
        m_xml.loadXML(GetXmlStr());
     end;
  end;

  initDL_XML();
  this.Construct( pDocKind, pDocumentID, pType, pOnlyLastReport );

END;

/*лог ошибок*/
CLASS (DL_LOG_FROM_XML) DL_ERROR_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var NUMERROR = 0, ERROR = "";

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "NUMERROR", V_INTEGER, NUMERROR) == false)
        end;
        if(DL_ReadTagAttribut(m_child_ReportNumber, "ERROR", V_STRING, ERROR) == false)
        end;
       
        return DLOpError(NUMERROR,       
                         ERROR
                        );
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

/*лог предупреждений*/
CLASS (DL_LOG_FROM_XML) DL_WARNING_LOG_FROM_XML(pDocKind:integer, pDocumentID:integer, pType:integer, pOnlyLastReport:bool)

  macro GetDataFromXMLByDocKind()
     var WARNING = "";

     if( m_ReportVersion == 1 )
     
        if(DL_ReadTagAttribut(m_child_ReportNumber, "WARNING", V_STRING, WARNING) == false)
        end;
       
        return WARNING;
     end;

     return null;
  end;

  initDL_LOG_FROM_XML(pDocKind, pDocumentID, pType, pOnlyLastReport);

END;

/*проверяет, есть ли протокол по операции*/
macro DL_IsExistsLogByOper(DocKind:integer, DocumentID:integer, OnlyLastReport:bool)

  var Query = "";

  if( (OnlyLastReport != null) and (OnlyLastReport == true) )
     Query = "select count(1) NRec "+
             "  from DDL_LOG_DBT log "+
             " where log.T_DOCKIND = "+DocKind+
             "   AND log.T_DOCID = "+DocumentID+
             "   AND log.T_OPER = "+{oper};
  else
     Query = "select count(1) NRec "+
             "  from DDL_LOG_DBT log "+
             " where log.T_DOCKIND = "+DocKind+
             "   AND log.T_DOCID = "+DocumentID;
  end;

  /*заголовок по операции должен быть один*/
  var cmd = RSDCommand(Query);

  cmd.execute();
  
  var  Datacmd = TRsbDataSet(cmd);
    
  if( Datacmd.MoveNext() and (SQL_ConvTypeInteger(Datacmd.NRec) > 0) )
     return true;
  end; 
  
  return false;
end;                                                       

