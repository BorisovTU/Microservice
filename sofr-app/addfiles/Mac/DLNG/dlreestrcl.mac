/*
$Name:        dlreestrcl.mac
$Module:      Ÿ¤à® Securities
$Description: âç¥â "¥¥áâà ª«¨¥­â®¢ “–"
*/
import "dlreestrcl_form.mac", "dlmisc.mac", "dlquery.mac";

PRIVATE VAR TableHeader =
"ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\n"+
"³     Š®¤     ³     ®¬¥à      ³  ‚¨¤ ®¡á«ã¦¨¢ ­¨ï  ³      ®¤¢¨¤        ³ Š®¤, ¯à¨á¢®¥­­ë© ³   „ â    ³   „ â    ³                                   à¨¤¨ç¥áª¨¥ «¨æ                                       ³                                       ”¨§¨ç¥áª¨¥ «¨æ                                                                   ³   Š®¤ Š‘Œ   ³ ü à¥£¨áâà æ¨¨ ¢ à¥¥áâà¥ ³\n"+
"³   ª«¨¥­â    ³    ¤®£®¢®à     ³                    ³    ®¡á«ã¦¨¢ ­¨ï    ³  ®à£ ­¨§ â®à®¬   ³ § ª«îç¥­ ³ § ªàëâ¨ï ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´              ³    ª¢ «¨ä¨æ¨à®¢ ­­ëå    ³\n"+
"³             ³                ³                    ³                    ³     â®à£®¢«¨     ³    ¨ï    ³          ³    ¨¬¥­®¢ ­¨¥   ³      ƒ       ³ Œ¥¦¤ã­ à®  ³   „ â     ³   €¤à¥á ¬¥áâ®­ å®¦¤¥­¨ï   ³       ”ˆ        ³   ®¬¥à ¨ á¥à¨ï   ³   „ â    ³ Ÿ¢«ï¥âáï ˆ ³    ˆ     ³      „ â      ³          €¤à¥á            ³              ³        ¨­¢¥áâ®à®¢       ³\n"+
"³             ³                ³                    ³                    ³                  ³          ³          ³    ®à£ ­¨§ æ¨¨   ³                 ³ ¤­ë© ª®¤   ³ á®§¤ ­¨ï  ³     (á®£« á­® ãáâ ¢ã)     ³                  ³     ¤®ªã¬¥­â ,    ³ à®¦¤¥­¨ï ³             ³            ³  à¥£¨áâà æ¨¨  ³                           ³              ³                         ³\n"+
"³             ³                ³                    ³                    ³                  ³          ³          ³                  ³                 ³ ¨¤¥­â¨ä¨ª  ³ ®à£ ­¨§ æ ³                           ³                  ³  ã¤®áâ®¢¥àïîé¥£®  ³          ³             ³            ³ ¢ ª ç¥áâ¢¥ ˆ ³                           ³              ³                         ³\n"+
"³             ³                ³                    ³                    ³                  ³          ³          ³                  ³                 ³    æ¨¨     ³    ¨¨     ³                           ³                  ³     «¨ç­®áâì      ³          ³             ³            ³               ³                           ³              ³                         ³\n"+
"³             ³                ³                    ³                    ³                  ³          ³          ³                  ³                 ³            ³           ³                           ³                  ³                   ³          ³             ³            ³               ³                           ³              ³                         ³\n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´\n"+
"³      1      ³        2       ³          3         ³         4          ³          5       ³     6    ³     7    ³        8         ³        9        ³     10     ³     11    ³            12             ³        13        ³         14        ³    15    ³      16     ³     17     ³      18       ³            19             ³      20      ³            21           ³\n"+
"ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´";

PRIVATE VAR ReportHeader =
"                           ¥¥áâà ª«¨¥­â®¢ ¯à®ä¥áá¨®­ «ì­®£® ãç áâ­¨ª  àë­ª  æ¥­­ëå ¡ã¬ £\n" +
"                                      §  ¯¥à¨®¤ á ########## ¯® ##########\n";

private const sheet_name = "¥¥áâà ª«¨¥­â®¢ “–";

PRIVATE CLASS (DL_CReportTemplate) DL_ReestrCl_Report

  PRIVATE MACRO GetDataFromFormFields()
     DlReestrClRepFormData.ServKind_SD = m_Form.GetFieldValue(PNFLD_REESTRCL_SERVICE_KIND_SD);
     DlReestrClRepFormData.ServKind_DV = m_Form.GetFieldValue(PNFLD_REESTRCL_SERVICE_KIND_DV);
     DlReestrClRepFormData.ServKind_CUR = m_Form.GetFieldValue(PNFLD_REESTRCL_SERVICE_KIND_CUR);
     DlReestrClRepFormData.ClientCode  = m_Form.GetFieldValue(PNFLD_REESTRCL_CLIENT_CODE);
     DlReestrClRepFormData.ClientName  = m_Form.GetFieldValue(PNFLD_REESTRCL_CLIENT_NAME);
     DlReestrClRepFormData.IsForm      = m_Form.GetFieldValue(PNFLD_REESTRCL_ISFORM);
     DlReestrClRepFormData.FormSub     = m_Form.GetFieldValue(PNFLD_REESTRCL_FORMSUB);
     DlReestrClRepFormData.IsVid       = m_Form.GetFieldValue(PNFLD_REESTRCL_ISVID);
     DlReestrClRepFormData.VidSub      = m_Form.GetFieldValue(PNFLD_REESTRCL_VIDSUB);
     DlReestrClRepFormData.QiInvestor  = m_Form.GetFieldValue(PNFLD_REESTRCL_QIINVESTOR);
     DlReestrClRepFormData.Noresident  = m_Form.GetFieldValue(PNFLD_REESTRCL_NORESIDENT);
     DlReestrClRepFormData.CloseOrder  = m_Form.GetFieldValue(PNFLD_REESTRCL_CLOSEORDER);
     DlReestrClRepFormData.BegDate     = m_Form.GetFieldValue(PNFLD_REESTRCL_BEGINDATE);
     DlReestrClRepFormData.EndDate     = m_Form.GetFieldValue(PNFLD_REESTRCL_ENDDATE);
     DlReestrClRepFormData.ToExcel     = m_Form.GetFieldValue(PNFLD_REESTRCL_TO_EXEL);
  END;

  PRIVATE MACRO PrintMode():INTEGER
     if( m_Form.GetFieldValue(PNFLD_REESTRCL_TO_EXEL) == SET_CHAR )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  PRIVATE MACRO BeginReport()
     SetActiveSheet(sheet_name); 
     GetDataFromFormFields();
     Dl_CallInsertStat(PrintMode());
     PrintFormatString(ReportHeader, "N1_D1", DlReestrClRepFormData.BegDate,
                                     "N1_D2", DlReestrClRepFormData.EndDate
                      );
     RegisterTable( "N1_MainTable", IIF(PrintMode == DL_OUTREPORT_STD, TableHeader, "N1_TableHeader"), 
                    "N1_A1",
                    "N1_A2",
                    "N1_A3",
                    "N1_A4",
                    "N1_A5",
                    "N1_A6",
                    "N1_A7",
                    "N1_A8",
                    "N1_A9",
                    "N1_A10",
                    "N1_A11",
                    "N1_A12",
                    "N1_A13",
                    "N1_A14",
                    "N1_A15",
                    "N1_A16",
                    "N1_A17",
                    "N1_A18",
                    "N1_A19",
                    "N1_A20",
                    "N1_A21" );
  END;

  PRIVATE MACRO EndReport()
     EndTable();
     AddStandardFooter("N1_");
     var count = 0;
     if (PrintMode() == DL_OUTREPORT_EXCEL)
       if( ExistsSheet(sheet_name) )
          count = 1;
          while( ExistsSheet( count + "ı" + sheet_name ) )
             count = count + 1;
          end;
       end;
     end; 
     //MoveStandartFooter("N1_Footer", count); //for not poi
  END;

  MACRO ¥ç â âì‘âà®ªã’ ¡«¨æë( A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21 )
     PrintTableLine( "N1_A1",  A1,  null,
                     "N1_A2",  A2,  null,
                     "N1_A3",  A3,  null,
                     "N1_A4",  A4,  null,
                     "N1_A5",  A5,  null,
                     "N1_A6",  A6,  null,
                     "N1_A7",  A7,  null,
                     "N1_A8",  A8,  null,
                     "N1_A9",  A9,  null,
                     "N1_A10", A10, null,
                     "N1_A11", A11, null,
                     "N1_A12", A12, null,
                     "N1_A13", A13, null,
                     "N1_A14", A14, null,
                     "N1_A15", A15, null,
                     "N1_A16", A16, null,
                     "N1_A17", A17, null,
                     "N1_A18", A18, null,
                     "N1_A19", A19, null,
                     "N1_A20", A20, null,
                     "N1_A21", A21, null
                   );
  END;        

  PRIVATE MACRO QICode( PartyID:integer, RepDate:date ):string
     var RetVal;
     var Query, SqlQuery, DataSet;

     Query = "select NVL(t.t_Code,'')as Code" +
             "  from dv_scqinvhist t " +
             " where t.t_State = 1 " +
             "   and t.t_BegDate = (select max(VHist.t_BegDate) from dv_scqinvhist VHist " +
             "                       where VHist.t_PartyID = t.t_PartyID " +
             "                         and VHist.t_BegDate < ? " +
             "                         and (VHist.t_EndDate >= ? or VHist.t_EndDate = '01.01.0001') " +
             "                         and VHist.t_State = t.t_State) " + 
             "   and t.t_PartyID = ? " +
             " order by t.t_BegDate"; 

     SqlQuery = RSDCommand(Query);
     SqlQuery.addParam("", RSDBP_IN, RepDate);
     SqlQuery.addParam("", RSDBP_IN, RepDate);
     SqlQuery.addParam("", RSDBP_IN, PartyID);
     SqlQuery.execute();

     DataSet = TRsbDataSet(SqlQuery);

     if( DataSet.MoveNext() )
        RetVal = SQL_ConvTypeStr(DataSet.Code);
     end;

     return RetVal;
  END;

  PRIVATE MACRO GetRegDate( PartyID:integer ):date
     var RetVal:date = date(0,0,0);
     var Set, Sql;
     Sql = RSDCommand("select objrgdoc.t_StartDate, objrgdoc.t_DocDate " +
                      "  from dobjrgdoc_dbt objrgdoc, dobjcode_dbt objcode  "+        
                      " where objrgdoc.t_ObjectType = ? "+               
                      "   and objrgdoc.t_ObjectID = ? " +
                      "   and objrgdoc.t_RegDocKind = 4 ");

     Sql.addParam("", RSDBP_IN, OBJTYPE_PARTY);
     Sql.addParam("", RSDBP_IN, PartyID);
     Sql.execute();

     Set = TRsbDataSet(Sql);
     if( Set.MoveNext() )
        RetVal = SQL_ConvTypeDate(Set.StartDate);
        if( RetVal == date(0,0,0) )
           RetVal = SQL_ConvTypeDate(Set.DocDate);
        end;
     end;

     return RetVal;
  END;

  PRIVATE MACRO GetPaperNumber( PartyID:integer ):string
     var RetVal:string = "";
     var Sql, SqlSet;
     Sql = RSDCommand( "select persnidc.t_paperseries, persnidc.t_papernumber " +
                       "  from dpersnidc_dbt persnidc" +
                       " where persnidc.t_personid  = ? " +
                       "   and persnidc.t_ismain    = 'X' " );
     Sql.addParam("", RSDBP_IN, PartyID);
     Sql.execute();
     SqlSet = TRsbDataSet(Sql);
     if( SqlSet.movenext() )
        RetVal = SqlSet.PaperSeries + " " +SqlSet.PaperNumber;
     end;

     return RetVal;
  END;

  PRIVATE MACRO GetPersnData( PartyID:integer, Born:@date, IsEmployer:@string )
     var Sql, SqlSet;

     Born       = date(0,0,0);
     IsEmployer = "";

     Sql = RSDCommand("select persn.t_Born, persn.t_IsEmployer " +
                      "  from dpersn_dbt persn " +
                      " where persn.t_PersonId = ? ");

     Sql.addParam("", RSDBP_IN, PartyID);
     Sql.execute();
     SqlSet = TRsbDataSet(Sql);
     if( SqlSet.movenext() )
        Born       = SQL_ConvTypeDate(SqlSet.Born);
        IsEmployer = SQL_ConvTypeStr(SqlSet.IsEmployer);
     end;
  END;

  PRIVATE MACRO Create()
     var Query, SqlQuery, DataSet, Num = 0, NRec = 0;
     var QiCode1 ;
     var ServKind:string = "";
     var QInv=DlReestrClRepFormData.QiInvestor;

     if( DlReestrClRepFormData.ServKind_SD == SET_CHAR )
        ServKind = ServKind + IIF(ServKind == "", "", ",") + string(PTSK_STOCKDL);
     end;

     if( DlReestrClRepFormData.ServKind_DV == SET_CHAR )
        ServKind = ServKind + IIF(ServKind == "", "", ",") + string(PTSK_DV) ;
     end;

     if( DlReestrClRepFormData.ServKind_CUR == SET_CHAR )
        ServKind = ServKind + IIF(ServKind == "", "", ",")  + string(PTSK_CM);
     end;

     SqlQuery = DL_RSDCommand();

     Query = " SELECT party.t_PartyID, sfcontr.t_Number, servkind.t_Name as ServKindName, " +
             "        rsi_npto.CheckContrIIS(sfcontr.t_ID) as IsIIS, sfcontr.t_DateBegin, sfcontr.t_DateClose, " +
             "        NVL((select cn.t_CodeNum3 " +
             "               from dadress_dbt adr, dcountry_dbt cn " +
             "              where adr.t_PartyID = party.t_PartyID " +
             "                and adr.t_Type = " + PTADDR_REAL +
             "                and adr.t_Country <> CHR(1) " +
             "                and cn.t_CodeLat3 = adr.t_Country), CHR(1)) as Country, " +
             "        party.t_LegalForm, party.t_NotResident, party.t_Name, " +
             "        (SELECT o1.t_Code " +
             "           FROM dobjcode_dbt o1 " +
             "          WHERE o1.t_CodeKind = "+PTCK_CONTR+" AND o1.t_ObjectID = party.t_PartyID " +
             "            AND o1.t_BankDate = " +
             "                   (SELECT MAX (o2.t_BankDate) " +
             "                      FROM dobjcode_dbt o2 " +
             "                     WHERE o2.t_CodeKind = " + PTCK_CONTR +
             "                           AND o2.t_ObjectID = party.t_PartyID " +
             "                           AND o2.t_BankDate <= ?)) " +
             "           AS PartyCode, " +
             "        NVL(mainsfcontr.t_Number, CHR(1)) as DlContrNumber, "
             "        NVL(dlcontrmp.t_MPCode, CHR(1)) as MPCode, " +
             "        NVL(sks.t_Name, CHR(1)) as SubKindName, " +
             "        NVL(dlcontr.t_DlContrID, 0) as DlContrID "
             "   FROM dparty_dbt party, dpartyown_dbt partyown, dservkind_dbt servkind, " +
             "        dsfcontr_dbt sfcontr LEFT JOIN ddlcontrmp_dbt dlcontrmp ON dlcontrmp.t_SfContrID = sfcontr.t_ID " +
             "                             LEFT JOIN ddlcontr_dbt dlcontr ON dlcontr.t_DlContrID = dlcontrmp.t_DlContrID " +
             "                             LEFT JOIN dsfcontr_dbt mainsfcontr ON mainsfcontr.t_ID = dlcontr.t_SfContrID " +
             "                             LEFT JOIN dservksub_dbt sks ON sks.t_ServiceKind = sfcontr.t_ServKind AND sks.t_ServiceKindSub = sfcontr.t_ServKindSub " +
             "  WHERE partyown.t_PartyID   = party.t_PartyID " +
             "    AND partyown.t_PartyKind = " + PTK_CLIENT +
             "    AND partyown.t_SubKind   = 0 " +
             "    AND Exists(SELECT 1 " +
             "                 FROM dclient_dbt cl " +
             "                WHERE cl.t_PartyID     = party.t_PartyID " +
             "                  AND cl.t_ServiceKind in( " + ServKind + " )" +
             "                  AND cl.t_Department  = ? " +
             "                  AND cl.t_Branch      = 0 " +
             "              ) " +
             "    AND sfcontr.t_PartyID    = party.t_PartyID " +
             "    AND sfcontr.t_ServKind   in( " + ServKind + " )" +
             "    AND sfcontr.t_Department = ? " +
             "    AND sfcontr.t_DateBegin  <= ? " +
             "    AND (sfcontr.t_DateClose >= ? OR sfcontr.t_DateClose = "+GetSQLDate(date(0,0,0))+") " +
             "    AND servkind.t_ServiseKind = sfcontr.t_ServKind ";

     SqlQuery.addParam(DlReestrClRepFormData.EndDate);
     SqlQuery.addParam({OperDprt});
     SqlQuery.addParam({OperDprt});
     SqlQuery.addParam(DlReestrClRepFormData.EndDate);
     if( DlReestrClRepFormData.CloseOrder == SET_CHAR )
        SqlQuery.addParam(DlReestrClRepFormData.BegDate);
     else
        SqlQuery.addParam(DlReestrClRepFormData.EndDate);
     end;

     if( DlReestrClRepFormData.ClientCode != -1 )
        Query = Query + " AND party.t_PartyID = ? ";
        SqlQuery.addParam(DlReestrClRepFormData.ClientCode);
     end;

     if( (DlReestrClRepFormData.IsForm > 0) and (DlReestrClRepFormData.FormSub != 0) )
        if( DlReestrClRepFormData.IsForm == 1 )
           Query = Query + " AND party.t_LegalForm = ? ";
           SqlQuery.addParam(DlReestrClRepFormData.FormSub);
        end;
        if( DlReestrClRepFormData.IsForm == 2 )
           Query = Query + " AND party.t_LegalForm != ? ";
           SqlQuery.addParam(DlReestrClRepFormData.FormSub);
        end;
     end;
   
     if( (DlReestrClRepFormData.IsVid > 0) and (DlReestrClRepFormData.VidSub != 0) )
        if( DlReestrClRepFormData.IsVid == 1 )
           Query = Query + " AND EXISTS (select 1 from dpartyown_dbt Pto where Pto.t_PartyKind = ? and Pto.t_PartyID = party.t_PartyID) ";
           SqlQuery.addParam(DlReestrClRepFormData.VidSub);
        end;
        if( DlReestrClRepFormData.IsVid == 2 )          
           Query = Query + " AND NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.t_PartyKind = ? and Pto.t_PartyID = party.t_PartyID) ";
           SqlQuery.addParam(DlReestrClRepFormData.VidSub);
        end;
     end;
   
     if( DlReestrClRepFormData.NoResident )
        Query = Query + " AND party.t_NotResident = 'X' ";
     end;

     Query = Query + " Order By PartyCode, sfcontr.t_DateBegin ";

     NRec = SqlQuery.GetCount(Query);

     if( NRec > 0 )
        DataSet = SqlQuery.Execute(Query);

        InitProgress(NRec, "âç¥â: ¥¥áâà ª«¨¥­â®¢ “–", "¥à¥¡®à ¤®£®¢®à®¢ ª«¨¥­â®¢");
        while( DataSet.MoveNext() )

           var PartyID:integer = SQL_ConvTypeInteger(DataSet.PartyID);
           var LegalForm:integer = SQL_ConvTypeInteger(DataSet.LegalForm);
           var NotResident:string = SQL_ConvTypeStr(DataSet.NotResident);
           var OGRN:string = "", StateRegNum:string = "", RegDate = "", Adress:string = "";
           var PaperNumber:string = "", BornDate:date = date(0,0,0), IsEmployer:string = "", INN:string = "", A5_Code:string = "";

           if( LegalForm == 1 )
              if( NotResident != SET_CHAR )
                 OGRN = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ (PartyID, PTCK_OGRN);
                 RegDate = GetRegDate(PartyID);
              else
                 StateRegNum = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ (PartyID, PTCK_STATEREGNUM);
              end;

              var AdressUL = TRecHandler("adress.dbt");
              if(  ©â¨à¨¤¨ç¥áª¨©€¤à¥á‘ã¡ê¥ªâ (PartyID, AdressUL) )
                 Adress = AdressUL.rec.Adress;
              end;
           else
              PaperNumber = GetPaperNumber(PartyID);
              GetPersnData(PartyID, @BornDate, @IsEmployer);
              if( IsEmployer == SET_CHAR )
                 INN = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ (PartyID, PTCK_INN);
                 RegDate = GetRegDate(PartyID);
              end;

              var AdressFL = TRecHandler("adress.dbt");
              if(  ©â¨€¤à¥á‘ã¡ê¥ªâ (PartyID, PTADDR_REAL, AdressFL) )
                 Adress = AdressFL.rec.Adress;
              end;
           end;
           QiCode1 = QICode(PartyID, DlReestrClRepFormData.EndDate);
           //DlReestrClRepFormData.QiInvestor
           if(((QInv==SET_CHAR) and (QiCode1 or (QiCode1==""))) or (QInv==UNSET_CHAR))

              if( DataSet.DlContrID > 0 )
                 A5_Code = SQL_ConvTypeStr(DataSet.MPCode);
                 if(A5_Code == "")
                    A5_Code = DL_GetDlObjCodeOnDate(OBJTYPE_BROKERCONTR_DL, DLCCK_USC, int(DataSet.DlContrID));
                 end;
              else
                 A5_Code = ®«ãç¨âìŠ®¤‘ã¡ê¥ªâ (PartyID, PTCK_MICEX);
              end;

           ¥ç â âì‘âà®ªã’ ¡«¨æë(SQL_ConvTypeStr(DataSet.PartyCode),
                                 IIF(DataSet.DlContrID > 0, SQL_ConvTypeStr(DataSet.DlContrNumber), SQL_ConvTypeStr(DataSet.Number)) + IIF(DataSet.IsIIS, ", „®£®¢®à ˆˆ‘", ""),
                                 SQL_ConvTypeStr(DataSet.ServKindName),
                                 SQL_ConvTypeStr(DataSet.SubKindName),
                                 A5_Code,
                                 SQL_ConvTypeDate(DataSet.DateBegin),
                                 IIF(SQL_ConvTypeDate(DataSet.DateClose) == date(0,0,0), "", SQL_ConvTypeDate(DataSet.DateClose)),
                                 IIF(LegalForm == 1, SQL_ConvTypeStr(DataSet.Name), ""),
                                 OGRN,
                                 StateRegNum,
                                 RegDate,
                                 IIF(LegalForm == 1, Adress, ""),
                                 IIF(LegalForm == 2, SQL_ConvTypeStr(DataSet.Name), ""),
                                 PaperNumber,
                                 BornDate,
                                 IIF(IsEmployer == SET_CHAR, "¤ ", ""),
                                 INN,
                                 RegDate,
                                 IIF(LegalForm == 2, Adress, ""),
                                 SQL_ConvTypeStr(DataSet.Country),
                                 QICode(PartyID, DlReestrClRepFormData.EndDate));
           end;

           UseProgress(Num = Num + 1);
        end;

        RemProgress();
     end;
  END;

  initDL_CReportTemplate(DL_ReestrCl_Panel(), "Report_ReestrCl.xlsx", true, null, null, true, true);
END;

DL_ReestrCl_Report().Run();
exit(1);
