/*
$Name:             ws_md.mac
$Module:           Монитор дилера 
$Description:      WEB. Макрос констант модуля монитора дилера
*/

import "secinter.mac", "dlquery.mac";

/////////////// Константы, которые можно изменять: //////////////

// Промежуток времени, через который должен обновляться скроллинг курсов (по умолчанию 10 сек):
// Пример:
// Time(0, 0, 30) - обновление каждые 30 секунд
// Time(0, 0, 05) - обновление каждые 5 секунд
const TimeUpdateScroll  = Time(0, 0, 10); // HH24:MI:SS (часы:минуты:секунды)

//Настройка использовать таймер для обновлния кнопки страт/стоп торги
const UPDATE_TRADESTATE_ON_TIMER = false;
// Интревал обновления
const TimeUpdateTradeState  = Time(0, 0, 05); // HH24:MI:SS (часы:минуты:секунды)


//Котировки от Рейтрерс
const  REUTERS_TERM_ID = 1;

//Имя макроса и метода для получения котировок с ММВБ
const MICEX_TERM_ID = 2;
const MICEX_MACRONAME = "ws_md_GetRatesDFS.mac";
const MICEX_MACROFUNC = "GetRatesDFS";

// Значения диапазонов по умолчанию:
// должно выполняться условие возрастания значений: Диапазон 1. Мин < Диапазон 1. Макс = Диапазон 2. Мин < Диапазон 2. Макс = Диапазон 3. Мин < Диапазон 3. Макс
const RANGE11 =  100000;
const RANGE12 =  500000;
const RANGE21 =  RANGE12;
const RANGE22 = 2000000;
const RANGE31 = RANGE22;
const RANGE32 = 5000000;

//////////////////////////////////////////////////////////////////
// Настройка планировщика
const STOPTRADE_SHEDULE_EXEC_KEY = "-exec:10040";
const STOPTRADE_SHEDULE_TASK_NAME = "Остановка торгов";

// Тип оповещения незавершенные сделки
const UNCOMPLETED_DEALS = 1; 

/////////////////////////////////////////////////////////////////

// Константы диапазонов
const COMMON_RANGE      = 0; // Общие
const GROUP_RANGE       = 1; // Групповые
const INDIVIDUAL_RANGE  = 2; // Индивидуальные

// Диапазоны времени, используемые для формирования графика курсов
const CURRENT_RATES     = 0; // Текущие курсы
const PERIOD            = 1; // За период
const DAY               = 2; // День

// Виды графиков
const FXRATEBUY         = 1; // Курс Forex покупки
const FXRATESALE        = 2; // Курс Forex продажи
const BANKRATEBUY       = 5; // Банковский курс покупки
const BANKRATESALE      = 6; // Банковский курс продажи
const BANKRATECOVERBUY  = 9; // Курс покрытия покупки
const BANKRATECOVERSALE = 10; // Курс покрытия продажи
const BANKRATETOMBUY    = 11; // Курс покрытия покупки TOM
const BANKRATETOMSALE   = 12; // Курс покрытия продажи TOM
const BANKRATESPOTBUY   = 13; // Курс покрытия покупки SPOT
const BANKRATESPOTSALE  = 14; // Курс покрытия продажи SPOT


// Статусы торгов
const STARTING          = 0; // Попытка запустить торги
const START             = 1; // Торги идут
const SHOUTDOWN         = 2; // Торги завершены
const CANCEL            = 3; // Отмена пуска торгов (идет редактирование)

// OBJCODE_INTERNAL
const CODE_Ccy          = 3;

const BEdupkey          = 5; //Дублирование ключа

const группа_ЮЛ         = 71; // Категория группы юридические лица
const группа_ФЛ         = 72; // Категория группы физические лица

// Виды сделки
const Deal_Buy  = 1; // Покупка
const Deal_Sale = 2; // Продажа

// Типы сделки
const Deal_TOD  = 1;
const Deal_TOM  = 2;
const Deal_SPOT = 3;
const Deal_FW   = 4;

// Действия для неподтвержденных сделок
const CONFIRM_DEAL = 1;  // Подтвердить сделку
const REJECT_DEAL = 2;   // Отклонить сделку


//////////////////////////////// Функции для общего использования ///////////////////////
// Получить часовой пояс (по времени сервера БД)
MACRO GetTimeZone()
  var TZ = "+00:00";
  var query_zone = "select to_char(DBTIMEZONE) from dual";
  var rs_zone = Dl_RSDCommand(query_zone);
  var DataSet = rs_zone.Execute();
  if (DataSet.moveNext() )
    TZ = trim( string( DataSet.value(0) ) );
  end;              
  return TZ;
END;

// Сконвертировать дату на смещение часового пояса TZ
macro GetCorrectDateTZ(inDate, sign, inTime, tz)
  var hh_in, hh_out, mm_in, mm_out, ss_in, ss_out;
  
  TimeSplit(inTime, hh_in, mm_in, ss_in); 
  TimeSplit(tz, hh_out, mm_out, ss_out); 

  var add_day = 0;

  if((sign > 0) and (mm_in + mm_out >= 60) )
    hh_out = hh_out + 1;
  elif((sign < 0) and (mm_in - mm_out < 0) )
    hh_out = hh_out - 1;
  end;

  if( (sign > 0) and (hh_in + hh_out >= 24) )
    add_day = 1;
  elif( (sign < 0) and (hh_in - hh_out < 0) )
    add_day = -1;
  end;

  return inDate + add_day;
end;

const IS_STOP_TRADE_ERR_MSG = "Идут торги. Сохранение изменений невозможно.";
//////////////////////////////////////////////
// Проверка остановлены ли торги. Если да - можно сохранять
macro IsStopTrade()
  var isStopTr = true;
  var query = "select * from V_RKSETTINGS";

  var ds = TRsbDataSet(query);

  if( ds.MoveNext() )
    isStopTr = IIF(SQL_ConvTypeStr(ds.IsStopTrade) == "X", true, false);
  end;

  return isStopTr;
end;