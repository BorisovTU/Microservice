/*
$Name: dl_load_711part3_pawn.mac
$Module: Ценные бумаги
$Description: Загрузка залогов для 711 формы
*/
import "or_exl_h.mac", globals, rsd, "dlquery.mac", CTInter;

private const COL_KO1               = "A",
              COL_KO2               = "B",
              COL_KO3               = "C",
              COL_KO4               = "D",
              COL_KO5               = "E",
              COL_KO6               = "F",
              COL_KO7               = "G",
              COL_KO8               = "H", 
              COL_KO9               = "I", 
              COL_KO10              = "J", 
              COL_KO11              = "K", 
              COL_KO12              = "L", 
              COL_KO13              = "M", 
              COL_KO14              = "N", 
              COL_KO15              = "O", 
              COL_KO16              = "P", 
              COL_KO17              = "Q", 
              COL_KO18              = "R", 
              COL_KO19              = "S", 
              COL_KO20              = "T", 
              COL_KO21              = "U", 
              COL_KO22              = "V", 
              COL_KO23              = "W", 
              COL_KO24              = "X", 
              COL_KO25              = "Y", 
              COL_KO26              = "Z", 
              COL_KO27              = "AA"; 

Private Macro ClearTable(RepDate)
   var query1, cmd1;
        query1 =   " DECLARE "
                + " BEGIN "
                + "   DELETE FROM D711PART3_PAWN_DBT WHERE T_LOADINGDATE = ?; "
                + " END; ";

        cmd1 = RSDCommand(query1);
		cmd1.AddParam("p01", RSDBP_IN, RepDate);

        cmd1.execute();
End;

Private macro InsertTableKO (strko, RepDate)
 var sql, cmd;
 sql = "INSERT INTO D711PART3_PAWN_DBT ("
   "T_ISSUERNAME,"
	"T_ISSUERINN,"
	"T_ISSUERINN_TIN,"
	"T_ISSUERINN_MARK,"
	"T_ISSUERNOTRESCODE,"
	"T_CFI,"
	"T_ISSUEROGRN,"
	"T_ISSUERCOUNTRYCODE,"
	"T_CODE711,"
	"T_LSIN,"
	"T_ISIN,"
	"T_FACEVALUEFICODE,"
	"T_FACEVALUE,"
	"T_SALEREPOAMOUNT,"
	"T_TRANSLOANAMOUNT,"
	"T_BUYREPOAMOUNT,"
	"T_ACCEPTLOANAMOUNT,"
	"T_TRANSDUAMOUNT,"
	"T_TRANSRIGHTSDUAMOUNT,"
	"T_TRANSPLEDGEBOAMOUNT,"
	"T_TRANSPLEDGEAMOUNT,"
	"T_ACCEPTPLEDGEAMOUNT,"
	"T_TRADEAMOUNT,"
	"T_CORPRESTRAMOUNT,"
	"T_OPERBANAMOUNT,"
	"T_ARRESTAMOUNT,"
	"T_NOTE,"
	"T_LOADINGDATE"
 ")"
 " VALUES(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18, :19, :20, :21, :22, :23, :24, :25, :26, :27, :28)";
 cmd = RSDCommand(sql);
 cmd.AddParam("p01", RSDBP_IN, strko.KO1);
 cmd.AddParam("p02", RSDBP_IN, strko.KO2);
 cmd.AddParam("p03", RSDBP_IN, strko.KO3);
 cmd.AddParam("p04", RSDBP_IN, strko.KO4);
 cmd.AddParam("p05", RSDBP_IN, strko.KO5);
 cmd.AddParam("p06", RSDBP_IN, strko.KO6);
 cmd.AddParam("p07", RSDBP_IN, strko.KO7);
 cmd.AddParam("p08", RSDBP_IN, strko.KO8);
 cmd.AddParam("p09", RSDBP_IN, strko.KO9);
 cmd.AddParam("p10", RSDBP_IN, strko.KO10);
 cmd.AddParam("p11", RSDBP_IN, strko.KO11);
 cmd.AddParam("p12", RSDBP_IN, strko.KO12);
 cmd.AddParam("p13", RSDBP_IN, strko.KO13);
 cmd.AddParam("p14", RSDBP_IN, strko.KO14);
 cmd.AddParam("p15", RSDBP_IN, strko.KO15);
 cmd.AddParam("p16", RSDBP_IN, strko.KO16);
 cmd.AddParam("p17", RSDBP_IN, strko.KO17);
 cmd.AddParam("p18", RSDBP_IN, strko.KO18);
 cmd.AddParam("p19", RSDBP_IN, strko.KO19);
 cmd.AddParam("p20", RSDBP_IN, strko.KO20);
 cmd.AddParam("p21", RSDBP_IN, strko.KO21);
 cmd.AddParam("p22", RSDBP_IN, strko.KO22);
 cmd.AddParam("p23", RSDBP_IN, strko.KO23);
 cmd.AddParam("p24", RSDBP_IN, strko.KO24);
 cmd.AddParam("p25", RSDBP_IN, strko.KO25);
 cmd.AddParam("p26", RSDBP_IN, strko.KO26);
 cmd.AddParam("p27", RSDBP_IN, strko.KO27);
 cmd.AddParam("p28", RSDBP_IN, RepDate);

 cmd.Execute;

 return true;
end;

class AvoirRec()
  var KO1              :string,
      KO2              :string,
      KO3              :string,
      KO4              :string,
      KO5              :string,
      KO6              :string,
      KO7              :string,
      KO8              :string,
      KO9              :string,
      KO10             :string,
      KO11             :string,
      KO12             :string,
      KO13             :numeric,
      KO14             :numeric,
      KO15             :numeric,
      KO16             :numeric,
      KO17             :numeric,
      KO18             :numeric,
      KO19             :numeric,
      KO20             :numeric,
      KO21             :numeric,
      KO22             :numeric,
      KO23             :numeric,
      KO24             :numeric,
      KO25             :numeric,
      KO26             :numeric,
      KO27             :string,

 end;

private macro SaveFileToAppServ(filepath:string, FileName:string):string
   if(not isStandAlone()) // когда мы на терминале, копируем файл на СП     
      var path_appserv = "..\\workfile\\" + FileName;
         
      if(not CopyFile("$" + filepath, path_appserv))
         msgbox("Ошибка при передаче на сервер приложений файла $" + filepath);
      end;
      filepath = path_appserv;
   end;
      
   return filepath;
end;

private macro DeleteFileToAppServ(FullNameFile)
   if(not isStandAlone()) // когда мы на терминале, удаляем файл на СП
      if (not RemoveFile (FullNameFile))
         println ("Ошибка удаления с сервера приложений файла " + FullNameFile);
      end;
   end;
end;

//Загрузка данных из Excel

macro OpLoadFile(FileName, TermPath, RepDate)

   var row = 3;
   var AvRec, StRecDR, StRecDRV, sheet, sheetcount, book;
   var all = 0,suc = 0, err = 0, onSheetCount = 0;
   var ErrStr = "",ErrStat = false,IsOption = false;

   var FullNameFile = TermPath + FileName;
   var jvm = CreateObject("rsjvm", "TJavaHost", "GlobalJavaHost");
   var rc = jvm.callStaticMethod("ru.softlab.rsbank.poireports.ReportCreator", "getInstance");

   /*Открываем файл*/
   BegAction(1, "Обработка файла \"" + TermPath + "\\" + FileName + "\". Ждите...");
   println("Загрузка данных из файла");
   debugbreak;
   FullNameFile = SaveFileToAppServ(FullNameFile, FileName);

   book = rc.openWorkbook(FullNameFile);

   if(not book)
      MsgBox("Ошибка открытия файла \"" + FullNameFile + "\"");
      println("Ошибка открытия файла \"" + FullNameFile + "\"");
      EndAction(1);
      return 0;
   end;

   /**/
   sheetcount = 1;
   WHILE(book.getSheetsCount() >= sheetcount)                                       
      book.setActiveSheet(sheetcount-1);
      row = 3;

      //Бежим по файлу
      InitProgress(-1);
      onSheetCount = 0;
      while (valtype(book.getCellValue(COL_KO4+row)) != V_UNDEF) 
         all = all + 1;
         
         AvRec = AvoirRec(); 
         If(valtype(book.getCellValue(COL_KO1+row)) != V_UNDEF)
            AvRec.KO1       = string(book.getCellValue(COL_KO1+row));
         else
            AvRec.KO1       = "";
         end;
         If(valtype(book.getCellValue(COL_KO2+row)) != V_UNDEF)
            AvRec.KO2       = string(book.getCellValue(COL_KO2+row):0:0);
         else
            AvRec.KO2       = "";
         end;
         If(valtype(book.getCellValue(COL_KO3+row)) != V_UNDEF)
            AvRec.KO3       = string(book.getCellValue(COL_KO3+row):0:0);
         else
            AvRec.KO3       = "";
         end;
         If(valtype(book.getCellValue(COL_KO4+row)) != V_UNDEF)
            AvRec.KO4       = string(book.getCellValue(COL_KO4+row):0:0);
         else
            AvRec.KO4       = "";
         end;
         If(valtype(book.getCellValue(COL_KO5+row)) != V_UNDEF)
            AvRec.KO5       = string(book.getCellValue(COL_KO5+row));
         else
            AvRec.KO5       = "";
         end;
         If(valtype(book.getCellValue(COL_KO6+row)) != V_UNDEF)
            AvRec.KO6       = string(book.getCellValue(COL_KO6+row):0:0);
         else
            AvRec.KO6       = "";
         end;
         If(valtype(book.getCellValue(COL_KO7+row)) != V_UNDEF)
            AvRec.KO7       = string(book.getCellValue(COL_KO7+row):0:0);
         else
            AvRec.KO7       = "";
         end;
         If(valtype(book.getCellValue(COL_KO8+row)) != V_UNDEF)
            AvRec.KO8       = string(book.getCellValue(COL_KO8+row):0:0);
         else
            AvRec.KO8       = "";
         end;
         If(valtype(book.getCellValue(COL_KO9+row)) != V_UNDEF)
            AvRec.KO9       = string(book.getCellValue(COL_KO9+row));
         else
            AvRec.KO9       = "";
         end;
         If(valtype(book.getCellValue(COL_KO10+row)) != V_UNDEF)
            AvRec.KO10       = string(book.getCellValue(COL_KO10+row));
         else
            AvRec.KO10       = "";
         end;
         If(valtype(book.getCellValue(COL_KO11+row)) != V_UNDEF)
            AvRec.KO11       = string(book.getCellValue(COL_KO11+row));
         else
            AvRec.KO11       = "";
         end;
         If(valtype(book.getCellValue(COL_KO12+row)) != V_UNDEF)
            AvRec.KO12       = string(book.getCellValue(COL_KO12+row):0:0);
         else
            AvRec.KO12       = "";
         end;
         If(valtype(book.getCellValue(COL_KO13+row)) != V_UNDEF)
            AvRec.KO13       = book.getCellValue(COL_KO13+row);
         else
            AvRec.KO13       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO14+row)) != V_UNDEF)
            AvRec.KO14       = book.getCellValue(COL_KO14+row);
         else
            AvRec.KO14       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO15+row)) != V_UNDEF)
            AvRec.KO15       = book.getCellValue(COL_KO15+row);
         else
            AvRec.KO15       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO16+row)) != V_UNDEF)
            AvRec.KO16       = book.getCellValue(COL_KO16+row);
         else
            AvRec.KO16       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO17+row)) != V_UNDEF)
            AvRec.KO17       = book.getCellValue(COL_KO17+row);
         else
            AvRec.KO17       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO18+row)) != V_UNDEF)
            AvRec.KO18       = book.getCellValue(COL_KO18+row);
         else
            AvRec.KO18       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO19+row)) != V_UNDEF)
            AvRec.KO19       = book.getCellValue(COL_KO19+row);
         else
            AvRec.KO19       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO20+row)) != V_UNDEF)
            AvRec.KO20       = book.getCellValue(COL_KO20+row);
         else
            AvRec.KO20       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO21+row)) != V_UNDEF)
            AvRec.KO21       = book.getCellValue(COL_KO21+row);
         else
            AvRec.KO21       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO22+row)) != V_UNDEF)
            AvRec.KO22       = book.getCellValue(COL_KO22+row);
         else
            AvRec.KO22       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO23+row)) != V_UNDEF)
            AvRec.KO23       = book.getCellValue(COL_KO23+row);
         else
            AvRec.KO23       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO24+row)) != V_UNDEF)
            AvRec.KO24       = book.getCellValue(COL_KO24+row);
         else
            AvRec.KO24       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO25+row)) != V_UNDEF)
            AvRec.KO25       = book.getCellValue(COL_KO25+row);
         else
            AvRec.KO25       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO26+row)) != V_UNDEF)
            AvRec.KO26       = book.getCellValue(COL_KO26+row);
         else
            AvRec.KO26       = 0.0;
         end;
         If(valtype(book.getCellValue(COL_KO27+row)) != V_UNDEF)
            AvRec.KO27       = string(book.getCellValue(COL_KO27+row));
         else
            AvRec.KO27       = "";
         end;

         InsertTableKO(AvRec, RepDate);
         UseProgress(row);

         ErrStr = "";
         ErrStat = false;
         row = row + 1;
         onSheetCount = onSheetCount + 1;
      end; //while
        
      RemProgress();
      println("На листе " + sheetcount + " загружено " + onSheetCount + " записей" );

      sheetcount = sheetcount + 1;
   end;//eow sheet
   
   println("Всего записей загружено: " + all);
   book.close();
   book = null;
   rc = null;
   DeleteFileToAppServ(FullNameFile);

onerror(error)
   println("Ошибка при загрузке данных " + error.Message);
   if (valtype(book) != V_UNDEF)
      book.close();
   end;
   book = null;
   rc = null;
   EndAction(1);
end;

macro StrToDate(strDDMMYYYY)
  return date(int(substr(strDDMMYYYY, 1, 2)),
              int(substr(strDDMMYYYY, 3, 2)),
              int(substr(strDDMMYYYY, 5, 4)))
OnError
  return date(0,0,0);
end;

macro OpLoad711Part3Pawn()
   var FullNameFile = "";
   var FileName = "";
   var DirName = "";
   var ExtName = "";
   var LoadingDate;
   /*Выбираем файл для обработки*/

   if(SelectFile(FullNameFile, "*.xlsx", "Выбор файла импорта", null, true))
      //Отделяем путь файла от имени
      splitfile(FullNameFile, FileName, ExtName);
      FileName = FileName + ExtName;
      DirName = substr(FullNameFile, 1, index(FullNameFile, FileName) - 1);
	  if ((strlen(FileName) < 8) OR (StrToDate(substr(FileName, 1, 8)) == date(0,0,0)))
		println("Некорректный формат имени файла. Имя файла должно иметь префикс DDMMYYYY_");
		return;
	  end;
	  LoadingDate = StrToDate(substr(FileName, 1, 8));
      
      ClearTable(LoadingDate);
      OpLoadFile(FileName, DirName, LoadingDate);
   else
     println("Операция отменена.");
   end;
End;

println("Выполнение процедуры 'Загрузка залогов для 711 формы'");
OpLoad711Part3Pawn();