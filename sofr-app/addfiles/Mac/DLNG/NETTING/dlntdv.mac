/*
$Name:        dlntdv.mac
$Module:      Неттинг
$Description: Часть неттинга, работающая только в ПИ
*/
import "dlntfd.mac";
/*PNV*/
PRIVATE MACRO ВалютаМеталл(iFIID)
  private var select,rs,rez=0;

  select="select count(*) from dfininstr_dbt where t_fiid="+iFIID+" and t_fi_kind=6 ";
  rs = TRsbDataSet(select);
  if(rs != null)
     if (rs.moveNext) 
        rez=int(rs.value(0));
        if (rez!=0)
          return true;
        else
          return false;
        end;
     end;
  end;
  return false;
END;
/*PNV*/

MACRO ИницПарамИсполн(Параметры, ВыполняемОбязательства, ntg)
  VAR stat = 0, retVal = false;
  Параметры.НеттингЧерезТранзитныеСчета = (ntg.OverTransitAccount == "X");
  GetRegistryValue("ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\РЕЖИМ КВИТОВКИ ПЛАТЕЖЕЙ", V_BOOL, retVal, stat);

  if (stat)
     msgbox ("Ошибка при получении значений реестра");
     return false;
  end;
  Параметры.ПроводимКвитовку = (retVal and NGT_ИнтегрРежимРаботы());
  return true;
END;

MACRO КорректироватьПлатеж( pmobj, ntg )
  var acc= "", ntg_fd = NULL;

  ntg_fd = DL_NettingDoc(ntg);

  ntg_fd.SetBaseFIID(pmobj.BaseFIID);

  if( ВидСубъекта(ntg.Contractor, PTK_MARKETPLASE) )
     if( PaymIsDemand(pmobj, ntg) )
        ntg_fd.GetAccount("+Биржа", acc, MC_OPENACC_CREATE, pmobj.PayerFIID, pmobj.ValueDate);
        pmobj.FuturePayerAccount = acc;
     else
        ntg_fd.GetAccount("-Биржа", acc, MC_OPENACC_CREATE, pmobj.ReceiverFIID, pmobj.ValueDate);
        pmobj.FutureReceiverAccount = acc;
     end;
  end;

  return pmobj;
END;
