/*                           
$Name:        dlstartcrnt.mac
$Module:      ФИССиКО, БОЦБ
$Description: процедура формирования операций неттинга
*/

import "dldlngfun.mac";
import DVinter;

macro GetQuery(comm_nett)
  var query;
  if ( comm_nett.DocKind == DL_NTGDOC)

    query = " SELECT * "
          + "  FROM (SELECT distinct q1.t_Contractor, "
          + "               q1.t_GenAgrID, "
          + "               q1.t_fi_kind, "
          + "               q1.t_paymentid, "
          + "               DENSE_RANK () "
          + "                 OVER (ORDER BY q1.t_Contractor, q1.t_GenAgrID, q1.t_fi_kind) "
          + "                 AS t_GroupNumber "
          + "          FROM (SELECT deals.*, (case when  fideal.T_FI_KIND = 6 THEN 6 else 1 end) t_fi_kind, pm.t_paymentID "
          + "                  FROM dpmpaym_dbt pm, ddvndeal_dbt deals, dfininstr_dbt fi, dfininstr_dbt fideal, ddvnfi_dbt nfi "
          + "                 WHERE     pm.t_netting = 'X' "
          + "                       AND pm.t_docKind IN (199, 4813, 4815) "
          + "                       AND deals.t_id = pm.t_documentID  "
          + "                       AND deals.t_dockind = pm.t_dockind  "
          + "                       AND deals.t_client = -1 "
          + "                       AND pm.t_valuedate = " + GetSQLDate(date(comm_nett.valuedate))
          + "                       AND PM.T_PAYMSTATUS = 1000 "
          + "                       AND fi.t_fiid = pm.t_fiid  " ;
  
     if(comm_nett.BaseFIID > -1 )
        query = query +     "       AND pm.t_fiid = " +  comm_nett.BaseFIID;  
     end;
        query = query  + "          AND fideal.t_fiid = nfi.t_fiid "
          + "                       AND nfi.t_dealid = deals.t_id  "
          + "                       AND FI.T_FI_KIND IN (1, 6)  "
          + "                       ) q1) q "
          + " WHERE q.t_GroupNumber > 0 ";
  else
    query = " SELECT * "
          + "  FROM (SELECT distinct q1.T_PARTYID t_Contractor, "                                                                                                                                                                                 
          + "               q1.t_GenAgrID, "                                                                                                                                                                                          
          + "               q1.t_fi_kind, "                                                                                                                                                                                           
          + "               q1.t_paymentid, "                                                                                                                                                                                         
          + "               DENSE_RANK () "                                                                                                                                                                                           
          + "                 OVER (ORDER BY q1.t_PARTYID, q1.t_GenAgrID, q1.t_fi_kind) "                                                                                                                                          
          + "                 AS t_GroupNumber "                                                                                                                                                                                      
          + "          FROM (SELECT tick.*, FI.T_FI_KIND, rq.t_ID t_paymentID "                                                                                                                                                             
          + "                  FROM ddlrq_dbt rq, ddl_tick_dbt tick, dfininstr_dbt fi "                                                                                                                                               
          + "                 WHERE      rq.t_usenetting = 'X' "                                                                                                                                                                           
          + "                       AND rq.t_type IN (0, 2, 3, 7, 8) "                                                                                                                                                           
          + "                       AND rq.t_Docid = tick.t_dealid "                                                                                                                                                               
          + "                       AND rq.t_dockind = tick.t_bofficekind "                                                                                                                                                             
          + "                       AND tick.t_clientID = -1 "                                                                                                                                                                         
          + "                       AND rsb_secur.IsOUTEXCHANGE(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind))) = 1 " //внебиржевые
          + "                       AND rq.t_plandate = " + GetSQLDate(date(comm_nett.valuedate))                            
          + "                       AND rq.t_state <> 2 "                                                                    
          + "                       AND fi.t_fiid = rq.t_fiid  " ;                                                           
                                                                                                                             
     if(comm_nett.BaseFIID > -1 )                                                                                            
        query = query +     "       AND rq.t_fiid = " +  comm_nett.BaseFIID;                                                 
     end;                                                                                                                    
        query = query  + "          AND FI.T_FI_KIND IN (1, 2)  "
          + "                       ) q1) q "
          + " WHERE q.t_GroupNumber > 0 ";


   end;


   if(comm_nett.Contractor > 0 )
      if(comm_nett.CheckContr == SET_CHAR)
        query = query + "AND q.t_Contractor = " +  comm_nett.Contractor;  
        if(comm_nett.GenAgrID > 0 )
           query = query + "AND q.t_GenAgrID = " +  comm_nett.GenAgrID;  
        end;
      else
        if(comm_nett.GenAgrID > 0 )
           query = query + "AND NOT (q.t_GenAgrID = " +  comm_nett.GenAgrID + "AND q.t_Contractor = " +  comm_nett.Contractor + ")";  
        else
           query = query + "AND q.t_Contractor <> " +  comm_nett.Contractor;  
        end;
      end;
   end;
   if(comm_nett.FI_Kind > 0 )
      query = query + "AND q.t_fi_kind = " +  comm_nett.FI_Kind;  
   end;
   return query;
end;

macro _StartCreateNett (comm_nett)
  var stat = 0, i ;
  var queryCount, cmdCount, DataSetCount;
  var query, cmd, DataSet;
  var transactionStarted:bool = false;

  cmdCount = DL_RSDCommand();
  queryCount = "WITH cnvdoc AS ( " + GetQuery(comm_nett) + ")  select NVL( max(cnvdoc.t_GroupNumber), 0) count from cnvdoc";
  DataSetCount = cmdCount.Execute(queryCount);
    RslDefCon.BeginTrans();
    transactionStarted = true;
  if(DataSetCount.moveNext() AND ( stat == 0 ))
    i = 1;
    While( i <= DataSetCount.count )

      query = GetQuery(comm_nett) + " AND q.t_GroupNumber  = " + i;
      cmd = DL_RSDCommand();
      DataSet = cmd.Execute(query);
     SQL_Execute("DELETE FROM DDL_DIFFERENTID_TMP", "", false ); 

      if(DataSet.moveNext())

      var cmdIns = RSDCommand( " INSERT INTO DDL_DIFFERENTID_TMP ( t_ID ) VALUES (?);") ;
      cmdIns.addParam( "", RSDBP_IN, DataSet.t_paymentid );
      SQL_Execute( cmdIns, "", false );                              



      While(DataSet.moveNext())
        cmdIns = RSDCommand( " INSERT INTO DDL_DIFFERENTID_TMP ( t_ID ) VALUES (?);" );
        cmdIns.addParam( "", RSDBP_IN, DataSet.t_paymentid );
        SQL_Execute( cmdIns, "", false );                              
      end;




      stat = NTG_DV_CreateNettOp(comm_nett.signingdate,
                                 comm_nett.valuedate, 
                                 DataSet.Contractor,
                                 DataSet.GenAgrID,
                                 int(DataSet.FI_Kind),
                                 comm_nett.BaseFIID,
                                 comm_nett.Xld,
                                 comm_nett.RegistrDate,
                                 comm_nett.DocTemplate,
                                 comm_nett.ConfirmTransport,
                                 comm_nett.ConfirmDate,
                                 comm_nett.ID,
                                 comm_nett.DocKind
                                 );
      end;
      i = i + 1;
    end;

  end;

    RslDefCon.CommitTrans(); /*Завершить транзакцию*/
    transactionStarted = false;

  return stat;

OnError(er)
  if( transactionStarted )
     RslDefCon.RollbackTrans();
  end;

end;

macro StartCreateNett( ID )
  var stat = 0;
  var comm_nett = TBFile("dl_comm_nett.dbt");
  comm_nett.rec.ID = ID;
  if( not comm_nett.GetEQ() )
    msgbox("Ошибка поиска операции");
    return 1;
  end;   
    
    stat = _StartCreateNett(comm_nett.rec);
    return stat;
end;

