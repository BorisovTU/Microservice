/*
$Name:        scnt_doc.mac
$Module:      Неттинг
$Description:
*/
import OprInter, CTInter, globals, DealsInter, "sp_class.mac", "sp_grfun.mac";

MACRO InitOperation( KindOpr, KindDoc, FDoc )

    RECORD ntg(dl_nett);
    var cmd, DataSet;
    SetBuff( ntg, FDoc );
    cmd = DL_RSDCommand(  " SELECT 1 "
                        + "       FROM DPMPAYM_DBT pm, dfininstr_dbt f "
                        + "     WHERE     pm.T_DOCUMENTID = " + ntg.NETTINGID 
                        + "           AND pm.t_dockind = 140 " /*netting*/
                        + "           AND pm.t_fiid = f.t_fiid "
                        + "           AND f.t_fi_kind = 6 " /*metal*/
                     );

  DataSet = cmd.Execute();

  var PrevNettingID:integer = -1;
  if(DataSet.moveNext())
     if (ntg.OVERTRANSITACCOUNT != "X" )
     if( ( not GetDialogFlag()))
      var OldDialogFlag = SetDialogFlag(1);
        msgbox("Неттинг по драг.металлам должен быть выполнен с признаком \"Неттинг через транзитные счета\"");
      SetDialogFlag(OldDialogFlag);
      end;
        return 1;
     end;
  end;
  return 0;
END;

MACRO PrepMassInitOperation()
    return 0;
END;

MACRO ExecMassInitOperation()

  var sql, cmd, DataSet;
  
  cmd = DL_RSDCommand(  " select ntg.t_DocKind, ntg.t_NettingID, ntg.t_SigningDate, ntg.t_ValueDate, ntg.t_FI_Kind, ntg.t_BaseFIID "
                      + "   from doprtemp_tmp oprtemp, "
                      + "        ddl_nett_dbt ntg "
                      + "  where oprtemp.t_SkipDocument = 0 "
                      + "    and lpad(ntg.t_NettingID, 34, '0') = oprtemp.t_DocumentID "
                      + "    and ntg.t_DocKind = oprtemp.t_DocKind "
                     );

  DataSet = cmd.Execute();

  var PrevNettingID:integer = -1;
  while(DataSet.moveNext())

    if( DataSet.t_DocKind == DL_NTGDOC )
       continue;
    end;

    if( PrevNettingID == DataSet.NettingID )
       continue;
    end;
    
    //сначала определить все даты по сделке
    GrDateArray.size = 0;
                                                     
    //Дата заключения
    GrDateArray[DLGR_DATEKIND_DELADATE]  = date(DataSet.SigningDate);
    //Дата поставки
    GrDateArray[DLGR_DATEKIND_DELIVERY]  = date(DataSet.ValueDate);
    //Дата оплаты
    GrDateArray[DLGR_DATEKIND_PAYMENT]   = date(DataSet.ValueDate);
    //Дата формирования поручения депо
    GrDateArray[DLGR_DATEKIND_DEPO]      = date(DataSet.ValueDate);


    if(DataSet.FI_Kind == FIKIND_CURRENCY)
      SetGrDeal(DataSet.DocKind, DataSet.NettingID, DataSet.BaseFIID, DLGR_TEMPL_PAYMENT);
    elif(DataSet.FI_Kind == FIKIND_AVOIRISS)
      SetGrDeal(DataSet.DocKind, DataSet.NettingID, DataSet.BaseFIID, DLGR_TEMPL_DELIVERYNTG);
      SetGrDeal(DataSet.DocKind, DataSet.NettingID, DataSet.BaseFIID, DLGR_TEMPL_DEPODRAFT);
    end;

    PrevNettingID = DataSet.NettingID;
  end;

  InsertAllGrDeal();

  return 0;

END;