/*
$Name:        dlnt30.mac
$Module:      Неттинг
$Description: макрос шага "Исполнение требований по сделке"
*/
IMPORT PaymInter, dlnteffpm, dlnteffrq;
IMPORT "dvserv.mac"; /*PNV*/
import "dl_check_mt300.mac"; //Simanov

PRIVATE CONST
    NTG_ERR_SYSERROR = 0,
    NTG_ERR_FULLKVIT = 1,
    NTG_ERR_CHGKURS  = 2,
    NTG_ERR_BADMODE  = 3,
    NTG_ERR_BADCARRY = 4,
    NTG_ERR_BADCONV  = 5;

PRIVATE VAR Параметры = NULL,
            Err       = NULL;
/*PNV*/
PRIVATE MACRO ВалютаМеталл(iFIID)
  private var select,rs,rez=0;

  select="select count(*) from dfininstr_dbt where t_fiid="+iFIID+" and t_fi_kind=6 ";
  rs = RsdRecordset(select);
  if (rs and rs.moveNext) 
        rez=int(rs.value(0));
        if (rez!=0)
          return true;
        else
          return false;
        end;
     end;
  return false;
END;
/*PNV*/

/*PNV*/
PRIVATE MACRO ПолучитьКоррсчетИзКоррсхемы(FIID, corrid):string
  var RetAcc:string = "";
  var rs, cmd, str;

  str = " SELECT t_account                   " +
        "   FROM DCORSCHEM_DBT               " +
        "  WHERE t_fiid = ?      " ;

  if (corrid != null)
      str = str + " and t_number = " + corrid;
  end;

  str = str +  "  order by t_number asc ";

  cmd = RsdCommand(str);
  cmd.addParam("fiid",   RSDBP_IN, FIID);

  rs = RsdRecordset(cmd);
  if (rs and rs.MoveNext())
    return string(rs.value("t_account"));
  end;

  return RetAcc;
END;
/*PNV*/

PRIVATE CLASS (NTG_ERROR)STEP_ERROR
    PRIVATE MACRO ПолучитьСтрокуСОшибкой(errnum, parm)
        VAR
            idx = 2,
            cnt = parm.Size,
            str = "";

        if (errnum == NTG_ERR_SYSERROR)
            str = parm[2];
        elif (errnum == NTG_ERR_FULLKVIT)
            str = "Плановый платеж не сквитован полностью";
        elif (errnum == NTG_ERR_CHGKURS)
            str = "Ошибка при учете доходов/расходов от изменения курсов";
        elif (errnum == NTG_ERR_BADMODE)
            str = "Используйте квитовку платежей";
        elif (errnum == NTG_ERR_BADCARRY)
            str = "Ошибка при исполнении проводок";
        elif (errnum == NTG_ERR_BADCONV)
            str = "Ошибка при конвертации";
        else
            str = "Неизвестная ошибка";
        end;

        while(idx < cnt)
            if(not((idx == 2) and (errnum == NTG_ERR_SYSERROR)))
                if((ValType(parm[idx]) != V_UNDEF) and (parm[idx] != null))
                    str = str + "|" + parm[idx];
                end;
            end;
            idx = idx + 1;
        end;

        return str;
    END;

    InitNTG_ERROR();
END;

PRIVATE MACRO ИсполнениеТребованийДляВалют(pmobj, ntg, ntg_fd)
    var stat = 0;
    var mes = "";
    /*PNV*/
    var Acc_str = "";
    file AccBuff( "account.dbt" );
    var v_fininstr = Trechandler( "fininstr.dbt" ); /* фин. инструмент*/

    pmobj.NUMBERPACK = 30;
    pmobj.number = pmobj.paymentid;
    Acc_str = ПолучитьКоррсчетИзКоррсхемы(pmobj.basefiid, pmobj.incorschem);
    
    if( DV_GetAccount( 1, pmobj.basefiid, Acc_str, AccBuff, true ) == true )  
       if( ПолучитьФинИн( pmobj.basefiid, v_fininstr ) == 0 ) 
           if(ВалютаМеталл(pmobj.BaseFIID))  
               pmobj.Ground = "Зачисление стоимости ДМ (" + v_fininstr.rec.name + ") с обезличенного металлического счета " + AccBuff.nameaccount + ". К/агент: " + GetPartyNames( pmobj.payer,2)[0];
           else
               pmobj.Ground = "Расчеты по неттингу от " + ntg.valuedate + " с " + StrSubst(GetPartyNames( pmobj.payer,2)[0], "'", "");
           end; 
       end; 
    end;
    /*PNV*/

     if( Параметры.ПроводимКвитовку and (pmobj.ReceiverBankID == {OurBank}) and (pmobj.PayerBankID != {OurBank}) )
       if ((pmobj.PaymStatus != PM_FINISHED) and (pmobj.FuturePayerAmount > 0))
           //Simanov - false, чтобы автоматически не выполнялся шаг в массовом режиме
           if( not GetTrue(false, "Плановый платеж "+pmobj.PaymentID+" не сквитован полностью. Исполнить требование?") )/*просили не запрещать*/
             return false;
           end;
       end;
    end;

      if( (pmobj.PaymStatus != PM_FINISHED) and (pmobj.PaymStatus != PM_CLOSED_W_M_MOVEMENT) )
       if( not ((pmobj.PayerBankID == {OurBank})and(pmobj.ReceiverBankID == {OurBank})) )
          if( (Параметры.БэкОфис == "V") or (Параметры.СквознойНеттинг) )
             pmobj = ExecMacroFile("dlntfx.mac", "КорректироватьПлатеж", pmobj, ntg);
          elif( Параметры.БэкОфис == "Ю" )
             pmobj = ExecMacroFile("dlntdv.mac", "КорректироватьПлатеж", pmobj, ntg);
          end;
       end;
     
       if ((pmobj.PIList(PRT_Credit).Size > 0) or (pmobj.PIList(PRT_Debet).Size > 0))
           stat = pmobj.MakeMultyTransaction();
           if (stat)
               mes = GetErrMsg();
               if (strlen(mes) == 0)
                   InitError();
                   MemoryError(stat);
                   mes = GetErrMsg();
               end;
               Err.Добавить(NTG_ERR_BADCARRY,mes);
               return false;
           end;
       else
           if (not pmobj.MakeTransaction().Carry())
               mes = GetErrMsg();
               Err.Добавить(NTG_ERR_BADCARRY,mes);
               return false;
           end;
       end;

       pmobj.PaymStatus = PM_FINISHED; 
    end;

    if( Параметры.БэкОфис == "S" )
       return ExecMacroFile("dlntsp.mac", "СписатьРезерв", ntg_fd);
    elif( Параметры.БэкОфис == "N" )
       return ExecMacroFile("dlntva.mac", "СписатьРезерв", ntg_fd);
    end;

    return true;
END;

PRIVATE MACRO ИсполнениеТОДляВалют(rq, ntg, ntg_fd, ID_Operation, ID_Step)
    var stat = 0;
    var mes = "";
    var DebAccountBuff = TRecHandler("account");
    var CredAccountBuff = TRecHandler("account");
    var Cat = "";
    var Amount_From = $0, Amount_To = $0;
    
    if (Параметры.ПроводимКвитовку)
        /*if (pmobj.FuturePayerAmount > 0)
            Err.Добавить(NTG_ERR_FULLKVIT);
            return false;
        end;*/
    else
        if(ExecMacroFile("spserv.mac", "ПолучитьДенежныйСчетСубъектаПоСделке", rq.rec.DocKind, rq.rec.DocID, rq.rec.Party, rq.rec.FIID, DebAccountBuff) != 0)
          return false;
        end;

        if(ntg.OverTransitAccount == "X")
          Cat = "+Расчеты";
        else
          Cat = "+Форвард, расчеты";
        end;

        if(not ntg_fd.GetAccount(Cat, CredAccountBuff.rec.Account, MC_OPENACC_CREATE, ntg.PayFIID, rq.rec.PlanDate))
          return false;
        end;

        if( rq.rec.FIID != DebAccountBuff.rec.Code_Currency )
           if( ConvSum( Amount_From, rq.rec.Amount, rq.rec.PlanDate, rq.rec.FIID, DebAccountBuff.rec.Code_Currency) )
              Err.Добавить(NTG_ERR_BADCONV);
              return false;
           end;
        else
           Amount_From = rq.rec.Amount;
        end;

        if( rq.rec.FIID != ntg.PayFIID )
           if( ConvSum( Amount_To, rq.rec.Amount, rq.rec.PlanDate, rq.rec.FIID, ntg.PayFIID) )
              Err.Добавить(NTG_ERR_BADCONV);
              return false;
           end;
        else
           Amount_To = rq.rec.Amount;
        end;

        if(DL_MultyCarry (DebAccountBuff.rec.Code_Currency, DebAccountBuff.rec.Account, Amount_From, 
                          ntg.PayFIID, CredAccountBuff.rec.Account, Amount_To, 1,
                          NULL, NULL, rq.rec.PlanDate, rq.rec.PlanDate,
                          "Исполнение требований по операции № "+ntg.DealNumber+" заключена "+ntg.SigningDate, 0) ) 
            mes = GetErrMsg();
            Err.Добавить(NTG_ERR_BADCARRY,mes);
            return false;
        end;

        rq.rec.State = DLRQ_STATE_EXEC;
        if( DL_ChangeDLRQ(rq, rq.rec.PlanDate, DLRQ_ACTION_UPDATE) )
          return false; 
        end;
    end;

    if (Параметры.БэкОфис == "S")
        return ExecMacroFile("dlntsp.mac", "СписатьРезерв", ntg_fd);
    end;

    return true;
END;

MACRO ExecuteStep(Buffer, Document, DocKind, ID_Operation, ID_Step)
    RECORD ntg_buff("dl_nett");
    Err = STEP_ERROR;
    VAR retVal = true;

    SetBuff( ntg_buff, Document );
    DL_PrepareCarryBuffer(Buffer);

    //Simanov. 13.01.20 - Проверка сквитованных МТ300 для сделок, заключенных по телефону
    if (not DL_nett_check_kvit_mt(ntg_buff) )
      return 1;
    end;

    Параметры = ПараметрыИсполнения(false, ntg_buff);

    if (Параметры.БэкОфис == "S")
     retVal =  ИсполнитьТО(Параметры, DLRQ_KIND_REQUEST, ntg_buff, @ИсполнениеТОДляВалют, Err, ID_Operation, ID_Step);
    else
              retVal = ИсполнитьПлатежи(Параметры, true, ntg_buff, @ИсполнениеТребованийДляВалют, Err);
          end;     

    if (Err.Вывести() or (retVal==false))
        return 1;
    end;

    return 0;
END;
