/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  Печать отчета "Лист неттинга"
  RSForms вариант.

  Ограничения: - отсутствует фильтрация по параметрам, в т.ч. по дате (#74490)
               - не проверяется наличие данных для запроса (PrintBody)
└───────────────────────────────────────────────────────────────────────────*/

import rcw, RSForms, RsbDataSet;

/*{{DESIGNER_HEADERS()*/
/*DESIGNER_HEADERS()}}*/


/*{{DESIGNER_CLASS_RSL_THEADER()*/
class (TForm)THeader(owner:object, name:string)
/*DESIGNER_CLASS_RSL()}}*/

/*{{DESIGNER_CONSTRBASE_RSL_THEADER()*/
   InitTForm(owner,name);
/*DESIGNER_CONSTRBASE_RSL()}}*/
/*{{DESIGNER_VAL_RSL_THEADER(PaymStatus,Market,ValueDate)*/
   var PaymStatus = TControl(this, "PaymStatus");
   var Market = TControl(this, "Market");
   var ValueDate = TControl(this, "ValueDate");
/*DESIGNER_VAL_RSL()}}*/

end;


/*{{DESIGNER_CLASS_RSL_TNTGRPLST()*/
class (TReport)TNTGRPLST(group:TReportsGroup, ValDate, Market, PaymStatus)
/*DESIGNER_CLASS_RSL()}}*/
   var m_ValueDate = ValDate,
       m_Market = Market,
       m_PaymStatus = PaymStatus,
       m_querystr = "select t_ShortName Contractor, sum(ReQ1) Req, sum(Liab1) Liab, "
     "case when sum(ReQ1) > sum(Liab1) then sum(ReQ1) - sum(Liab1) else 0 end as TotalReQ, "
     "case when sum(ReQ1) > sum(Liab1) then 0 else sum(Liab1) - sum(ReQ1) end as TotalLiab, "
     "case when t_FI_Kind = 2 then t_FI_Code else t_CCY end as FinInstr "
"from ("
   "select case when t_receiver in (select t_partyid from ddp_dep_dbt) then t_payer else t_receiver end as cid, "
       "case when t_receiver in (select t_partyid from ddp_dep_dbt) then sum(t_amount) else 0 end as ReQ1, "
       "case when t_receiver in (select t_partyid from ddp_dep_dbt) then 0 else sum(t_amount) end as Liab1, "
       "t_fiid fi "
   "from dpmpaym_dbt "
   "where (t_receiver in (select t_partyid from ddp_dep_dbt) or t_payer in (select t_partyid from ddp_dep_dbt)) and "
//      "t_ValueDate=TO_DATE('17 08 2005','DD MM YYYY') AND "
	  "(t_DocKind=100 OR t_DocKind=101 OR t_DocKind=102) "
   "group by t_payer, t_receiver, t_fiid "
"), dparty_dbt p, dfininstr_dbt f"
" where "
   " p.t_PartyID=cid and f.t_FIID = fi "
"group by cid, t_ShortName, t_fiid, t_CCY, t_FI_Code, t_FI_Kind "
"order by cid, t_FI_Code ",
       m_querystr_totals = "select "
"case when rownum < 2 then 'Всего:' else chr(1) end as Contractor, sl.*"
"from (select sum(ReQ1) Req, sum(Liab1) Liab, "
     "case when sum(ReQ1) > sum(Liab1) then sum(ReQ1) - sum(Liab1) else 0 end as TotalReQ, "
     "case when sum(ReQ1) > sum(Liab1) then 0 else sum(Liab1) - sum(ReQ1) end as TotalLiab, "
     "case when t_FI_Kind = 2 then t_FI_Code else t_CCY end as FinInstr "
"from ("
   "select "
       "case when t_receiver in (select t_partyid from ddp_dep_dbt) then sum(t_amount) else 0 end as ReQ1, "
       "case when t_receiver in (select t_partyid from ddp_dep_dbt) then 0 else sum(t_amount) end as Liab1, "
       "t_fiid fi "
   "from dpmpaym_dbt "
   "where (t_receiver in (select t_partyid from ddp_dep_dbt) or t_payer in (select t_partyid from ddp_dep_dbt)) and "
	  "(t_DocKind=100 OR t_DocKind=101 OR t_DocKind=102) "
   "group by t_payer, t_receiver, t_fiid "
"), dfininstr_dbt f"
" where "
   " f.t_FIID = fi "
"group by t_fiid, t_CCY, t_FI_Code, t_FI_Kind "
"order by t_FI_Code) sl",
       m_querystr_netto = "select "
"case when rownum < 2 then 'Баланс нетто:' else chr(1) end as Contractor, sl.* "
"from (select sum(ReQ1) Req, sum(Liab1) Liab, "
     "case when sum(ReQ1) > sum(Liab1) then sum(ReQ1) - sum(Liab1) else 0 end as TotalReQ, "
     "case when sum(ReQ1) > sum(Liab1) then 0 else sum(Liab1) - sum(ReQ1) end as TotalLiab, "
     "case when t_FI_Kind = 2 then t_FI_Code else t_CCY end as FinInstr "
"from ("
   "select "
       "case when t_receiver in (select t_partyid from ddp_dep_dbt) then sum(t_amount) else 0 end as ReQ1, "
       "case when t_receiver in (select t_partyid from ddp_dep_dbt) then 0 else sum(t_amount) end as Liab1, "
       "t_fiid fi "
   "from dpmpaym_dbt "
   "where (t_receiver in (select t_partyid from ddp_dep_dbt) or t_payer in (select t_partyid from ddp_dep_dbt)) and "
	  "(t_DocKind=100 OR t_DocKind=101 OR t_DocKind=102) "
   "group by t_payer, t_receiver, t_fiid "
"), dfininstr_dbt f"
" where "
   " f.t_FIID = fi "
"group by t_fiid, t_CCY, t_FI_Code, t_FI_Kind "
"order by t_FI_Code) sl",
       m_ds = CreateObject( "RSDS", "TDataSet", NULL, TRUE ),
       m_totals = CreateObject( "RSDS", "TDataSet", NULL, TRUE ),
       m_netto = CreateObject( "RSDS", "TDataSet", NULL, TRUE );
//       m_ds1 = TRsbDataSet("select t_Payer Contractor from dpmpaym_dbt", RSDVAL_CLIENT, RSDVAL_STATIC);

/*{{DESIGNER_CONSTRBASE_RSL_TNTGRPLST()*/
   InitTReport();
/*DESIGNER_CONSTRBASE_RSL()}}*/
   setTemplate("deals2.lbr", "NTGRPLST");

/*{{DESIGNER_VAL_RSL_TNTGRPLST(Header,ReportTable)*/
   var Header = THeader(this, "Header");
   var ReportTable = TControl(this, "ReportTable");
   var Netto = TControl(this, "Netto");
   var Totals = TControl(this, "Totals");
/*DESIGNER_VAL_RSL()}}*/

/*{{DESIGNER_CMD_SET_RSL_TNTGRPLST()*/
/*DESIGNER_CMD_SET_RSL()}}*/

/*{{DESIGNER_HANDLERS_ADD_RSL_TNTGRPLST(OnLoad,OnGetContents)*/
   addHandler(-2147385343, R2M(this, "OnLoad"));
   addHandler(4, R2M(this, "OnGetContents"));
/*DESIGNER_HANDLERS_ADD_RSL()}}*/

   Create(group);

   macro FillTable()
      var //l_row, 
          l_tbl = TReportTable();

      PutElement(ReportTable, l_tbl);

//      l_row = l_tbl.AddLine( "Row" );
//      m_ds1.MoveFirst();
//      m_ds = m_ds1.StdDataSet;
      l_tbl.Line("Row").BindItem.DataSource = m_ds;
      expandrowset(l_tbl.Line("Row"));

   end;

   macro FillFooter()
      var l_tbl_totals = TReportTable(),
          l_tbl_netto = TReportTable();

      PutElement(Totals, l_tbl_totals);
      PutElement(Netto, l_tbl_netto);

      l_tbl_totals.Line("Row").BindItem.DataSource = m_totals;
      l_tbl_netto.Line("Row").BindItem.DataSource = m_netto;
      expandrowset(l_tbl_totals.Line("Row"));
      expandrowset(l_tbl_netto.Line("Row"));

   end;

   macro PutAllElements()
/*{{DESIGNER_PUT_ELEMENT_RSL_TNTGRPLST(Header,ReportTable)*/
      PutElement(Header);
//      PutElement(ReportTable);
/*DESIGNER_PUT_ELEMENT_RSL()}}*/
      FillTable();
      FillFooter();
   end;

/*{{DESIGNER_HANDLERS_RSL_TNTGRPLST(OnLoad,OnGetContents)*/
   macro OnLoad (Sender: Object, pbCancel: @Bool)
      ReportTable.DoInit();
      Totals.DoInit();
      Netto.DoInit();
      // Инициализируем рекордсет
      m_ds.Init( 1, GetIniFileValue ("rsreq.ini", "CONNSTRING"), m_querystr);
      m_totals.Init( 1, GetIniFileValue ("rsreq.ini", "CONNSTRING"), m_querystr_totals);
      m_netto.Init( 1, GetIniFileValue ("rsreq.ini", "CONNSTRING"), m_querystr_netto);
   end;

   macro OnGetContents (Sender: Object)
      Header.ValueDate.Text   = m_ValueDate;
      Header.Market.Text      = m_Market;
      Header.PaymStatus.Text  = m_PaymStatus;

      PutAllElements();
   end;

/*DESIGNER_HANDLERS_RSL()}}*/

end;


MACRO PrintBody(grp, ValDate, Market, PaymStatus)
/*var MMRPRORL,
    DataSet, ok = false,
    sqltext  = "select distinct t_ValueDate ",
    sqlfrom  = " from dpmpaym_dbt paym ",
    sqlwhere = " where paym.t_DocKind = 102 ";

    // дата сделки
    if(p_valuedate > date(0,0,0))
       sqlwhere = sqlwhere + " AND paym.t_ValueDate = " + to_date(p_valuedate);
    end;
    // ФИ
    if(p_fiid > -1)
       sqlwhere = sqlwhere + " AND paym.t_fiid = " + p_fiid;
    end;
    // портфель
    AddPortfel(@sqlfrom, @sqlwhere);
    // категория контрагента
    AddContrCateg(@sqlfrom, @sqlwhere);

    DataSet = TRsbDataSet(sqltext + sqlfrom + sqlwhere);
    if(DataSet.MoveNext)
       MMRPRORL = TMMRPRORL(grp);
       ok = true;
    end;
    
    return ok;*/
    TNTGRPLST(grp, ValDate, Market, PaymStatus);
    return true;
END;


/* Печать отчета */
MACRO printReportRSF( ValDate, Market, PaymStatus )
var grp = TReportsGroup();

   /* Считать переданные параметры в глобальные переменные.
      Если какие-либо параметры не были заданы, они должны быть == 0 */

   if(PrintBody(grp, ValDate, Market, PaymStatus) == true)
      grp.Print( TRUE );
   else
      msgbox( "Нет данных, удовлетворяющих заданной фильтрации." );
   end;

END;
