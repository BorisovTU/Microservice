/*
$Name:        dlntfx.mac
$Module:      Неттинг
$Description: Часть неттинга, работающая только в FOREX
*/
IMPORT BankInter, fxlb, fxcarry,fxcateg, RsbDataSet;

MACRO ИницПарамИсполн(Параметры, ВыполняемОбязательства, ntg)
    VAR stat = 0, KvitMode;

    GetRegistryValue("КОНВЕРСИОННЫЕ ОПЕРАЦИИ\\РЕЖИМ КВИТОВКИ", V_INTEGER, KvitMode, stat);

    if (stat)
        msgbox ("Ошибка при получении значений реестра");
        return false;
    end;

    Параметры.НеттингЧерезТранзитныеСчета = (ntg.OverTransitAccount == "X");

    if ((not ВыполняемОбязательства)and(KvitMode == FX_KVIT_REQ))
        Параметры.ПроводимКвитовку = true;
    else
        Параметры.ПроводимКвитовку = false;
    end;

    return true; 
END;

MACRO КорректироватьПлатеж(pmobj, ntg)
    VAR acc= "", ntg_fd = NULL;

    ntg_fd = DL_NettingDoc(ntg);

    ntg_fd.SetBaseFIID(pmobj.BaseFIID);

    if (ВидСубъекта(ntg.Contractor, PTK_MARKETPLASE))
        if (PaymIsDemand(pmobj, ntg))
            ntg_fd.GetAccount("+Биржа", acc, MC_OPENACC_CREATE, pmobj.PayerFIID, pmobj.ValueDate);
            pmobj.FuturePayerAccount = acc;
        else
            ntg_fd.GetAccount("-Биржа", acc, MC_OPENACC_CREATE, pmobj.ReceiverFIID, pmobj.ValueDate);
            pmobj.FutureReceiverAccount = acc;
        end;
    end;

    return pmobj;
END;
