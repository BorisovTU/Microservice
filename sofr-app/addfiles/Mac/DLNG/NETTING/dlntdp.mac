/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 5.1                                          R-Style Software Lab

  Programmer  : Азарцов В.В.
  Description : Импорт поручений депо в депозитарий по платежам в ценных бумагах
└───────────────────────────────────────────────────────────────────────────*/
import DealsInter, "insdpdr.mac", "dlntlib.mac";

MACRO ИмпортироватьПоручениеДепо(dl_nett, rq, OperDate)
 
   var cmd  = "", q;

   /*депозитарный учет ведется в депозитарии*/
   if( DL_WORKWITHDEPOSITARY == "X" )

      if( InsertDepoDraft( dl_nett, rq, OperDate ) == false )
         return false;
      end;            

      cmd = RSDCommand("SELECT count(1) as num " +
                       "  FROM dspdrprop_dbt prop " +
                       " WHERE prop.t_paymentid in " +
                       "              (SELECT pmlnk.t_initialpayment " +
                       "                 FROM dpmlink_dbt pmlnk " +
                       "                WHERE pmlnk.t_purposepayment = ?  " +
                       "                  AND pmlnk.t_dockind = ? ) " +
                       "   AND prop.t_DocumentKind = ? " +
                       "   AND prop.t_DocumentID = ? " 
                      );

      cmd.addParam( "", RSDBP_IN, rq.rec.ID );
      cmd.addParam( "", RSDBP_IN, DL_NTGDOC );
      cmd.addParam( "", RSDBP_IN, rq.rec.DocKind );
      cmd.addParam( "", RSDBP_IN, rq.rec.DocID );
      cmd.execute();

      q = TRsbDataSet(cmd);
      if( q.movenext() )
          if( q.num > 0 )
             MsgBox("Необходимо отменить поручение депо № " + rq.rec.ID + ", сформированное по ТО, включенному в неттинг");
          end;
      else
         msgbox("Не найдено ТО");
         return false;
      end;

   end;

   return true;
END;   
