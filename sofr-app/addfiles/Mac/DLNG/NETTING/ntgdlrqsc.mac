/*
$Name:        ntgdlrqsc.mac
$Module:      Неттинг
$Description: Макрос применяется для инициализации и проверки параметров сделки в скроллинге сделок неттинга по ТО
*/
import BankInter, TSInter, "dlntlib.mac"/*, "dvswiftMT399.mac"*/;

const NTG_DEFER = 0;

//только для БОЦБ
PRIVATE VAR Документ       = TRecHandler("dl_nett");
PRIVATE VAR СтарыйДокумент = TRecHandler("dl_nett"); /* заполняется при редактировании */

var HasPayms; /* существуют ли платежи */

PRIVATE MACRO CmpDeal( Режим )

  if( (Режим == OBJ_UPDATE) OR (Режим == OBJ_INSERT) OR (Режим == OBJ_STARTOPR) )
     if( Документ.rec.IdentProgram <= 0 )
        MsgBox( "В сделке не задан модуль, к которому она относится. Необходимо заполнить поле ddl_nett_dbt.t_IdentProgram." );
        return 1;
     end;
  end;

  if( (Режим == OBJ_UPDATE) AND (Документ.rec.Status != NTG_DEFER) AND
      ((Документ.rec.Contractor != СтарыйДокумент.rec.Contractor) OR
       (Документ.rec.ValueDate != СтарыйДокумент.rec.ValueDate)) )
      MsgBox("Произведенные изменения возможны только в отложенных сделках.| Для этого переведите сделку в отложенные...");
      return OBJ_IMPORTANT;     /*  важные изменения */
  end;

  return 0;  
END;


MACRO Функция_Пользователя( Режим )
   private Var items = Tarray (), ch;
   private Var items1 = Tarray (), ch1;
   items [0] = "Платежи                    ";
   items [1] = "Подтверждения              ";

   if ( (ch = menu (items, NULL, "Выберите действие")) < 0 )
       return 0;
   end;
   if( ch == 0 )  
   execmacrofile("dl_mt", "Kontr_plat",Документ.rec.nettingid) ;
   execmacrofile("dl_mt", "Kontr_netting",Документ.rec.nettingid) ;
   elif( ch == 1 )      
      items1 [items1.size] = "Формирование MT399";
      if( (ch1 = menu (items1, NULL, "Выберите действие")) < 0 )
        return 0;
      end;
      if( items1[ch1] == "Формирование MT399" )
//         DV_DealsGenMesMT399Paym( Документ.rec.nettingid, "X" );
           ExecMacroFile("dvswiftMT399", "DV_DealsGenMesMT399Paym", Документ.rec.nettingid, "X");
      end;
   end;
  return 0;
END;

///////////////////////////////////
//Только для БОЦБ

/* Макрофункция инициализации новой операции 
   необходимо заполнить структуру "Документ"
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Новый_Документ()

  return 0;
END;


/* Макрофункция проверки операции при вводе, редактировании, удалении 
   возвращаемое значение
   0 - ошибок не было
   1 - была ошибка
*/
PRIVATE MACRO Проверить_Документ( Режим:INTEGER )

  if( Режим == TS_INSERT ) /* ввод новй операции*/
     return CmpDeal( Режим );
  elif( Режим == TS_EDIT ) /* редактирование операции*/
     return CmpDeal( Режим );
  elif( Режим == TS_DELETE ) /* удаление операции*/

  elif( Режим == TS_EXECUTE) /* старт операции*/

  end;

  return 0;
END;

