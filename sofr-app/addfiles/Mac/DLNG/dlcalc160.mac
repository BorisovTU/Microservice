/*   Расчетная Операция ВУ          
   Шаг - формирование поручения Депо
*/
import PaymInter, "insdpdr.mac","sp_categ.mac", "sp_car.mac", InsCarryDoc, FiInter, DealsInter;

macro ExecuteStep( Doc, adr )

  record dl_acc( dl_acc );
  record pm_avoir(pmpaym);
  var Purpose;
  SetBuff ( dl_acc, Adr );

  If(dl_acc.FIKind == FIKIND_AVOIRISS)
     Purpose = BAi;
  elIf(dl_acc.FIKind == FIKIND_CURRENCY)
     Purpose = CAi;
  end;

  if( dl_acc.OperType < 1000 )/*вид операции пользовательский (пользователю требуется самостоятельно доработать макрос шага)*/
     if( FindPayment( null, Purpose, 0, dl_acc.DocKind, dl_acc.ID, true, pm_avoir ) != 0 )
        MsgBox( "Отсутствуют платеж на поставку основного актива|(Код операции=", dl_acc.Code, ")" );
        return 1;
     end;
     
     if( not InsertDepoDraft( dl_acc, pm_avoir, dl_acc.Date ) ) /* вставляем отложенное поручение депо */
        return 1;
     end;
  end;

  if( not InsertOprStatus( 1592, 3) )   
     msgbox( "Ошибка при установке статуса операции" );
     return 1;
  end;

  return 0;

end;
