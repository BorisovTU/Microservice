/*
$Name:             dl_car.mac
$Module:           Ядро Securities
$Description:      Выполннение проводок
*/

IMPORT "MC_lib.mac", oprinter, InsCarryDoc, "dl_class.mac", "dlquery.mac", "dlmisc.mac";
IMPORT "role_model.mac";//ролевая модель

/* Проводка по категориям учета (в том числе и мультивалютная)
   СчетДебет,СчетКредит - если тип V_STRING то категории, иначе record ACCOUNT*/
PRIVATE RECORD AccountPayer(account);
PRIVATE RECORD AccountReceiver(account);
PRIVATE MACRO SayCarryError( error )
  MsgBox( error );
  return false;
END;

private macro it_log(text)
  var sql = "begin it_log.log(:1); end;";
  var cmd = RSDCommand(sql);
  cmd.AddParam("",RSDBP_IN,text);
  cmd.execute;
end;

private macro ВнутреннийУчетОткрыт(): BOOL
   var query =  " SELECT t_IsClosed FROM dDLGRACCKIND_dbt  WHERE t_Num = 3";  /*системный номер внутреннего учета*/
   var Select = Dl_RSDCommand(query);
   var DataSet = Select.Execute();
   var InnerAccIsOpen = true;

   if(DataSet.moveNext())
    if(DataSet.IsClosed == SET_CHAR)
      InnerAccIsOpen = false;
    end;
   end;

   return InnerAccIsOpen;
end;

PRIVATE VAR DL_UseInnerCalc = NULL;
PRIVATE MACRO ВестиВнутреннийУчет():BOOL
  VAR ErrCode = 0;

  if( DL_UseInnerCalc == NULL )
    if( GetIdentProgram() == CodeFor("S") ) /*операция выполняется из БОЦБ*/
      //проверим настройку из графика
     DL_UseInnerCalc = ВнутреннийУчетОткрыт();
    elif( GetIdentProgram() == CodeFor("N") ) /*операция выполняется из УВ*/
     DL_UseInnerCalc = VA_NeedInnerAcc();
    else
     GetRegistryValue( "COMMON\\ВНУТРЕННИЙ УЧЕТ\\ФОРМИРОВАНИЕ ПРОВОДОК", V_BOOL, DL_UseInnerCalc, ErrCode );
     if( ErrCode != 0 )
       DL_UseInnerCalc = false;
     end;
    end;
  end;

  return DL_UseInnerCalc;
END;

PRIVATE MACRO ПолучитьМаскиСчКлиентов(Masks:@string):BOOL
  VAR ErrCode = 0;

  GetRegistryValue( "SECUR\\СЧЕТА КЛИЕНТОВ БО ЦБ", V_STRING, Masks, ErrCode );
  if( ErrCode != 0 )
     Masks = "";
     return false;
  end;

  return true;
END;

MACRO DL_IsClientAcc(Account:string)
   var Masks = "";

   if( ПолучитьМаскиСчКлиентов(@Masks) )
      if( not CompareStrWithMasks(Masks,Account) )
         return true;
      end;
   end;

   return false;
END;

MACRO DL_GetAccount( Chapter:INTEGER, FIID:INTEGER, Account:STRING, AccBuf:VARIANT):BOOL
   VAR AccRec;
   var RetVal = false;
   record AccountBuf(account);

   AccRec = TBFile( "account.dbt", "R", 0 );

   AccRec.rec.Chapter       = Chapter;
   AccRec.rec.Code_Currency = FIID;
   AccRec.rec.Account       = Account;
   if( AccRec.GetEQ() )
      Copy( AccBuf, AccRec );
      RetVal = true;
   end;

   /* если надо поищем счёт во временной базе */
   if(not RetVal)
      ClearRecord( AccountBuf );
      if(DL_FindAccount( Chapter, FIID, Account, AccountBuf ) == 0)
         Copy( AccBuf, AccountBuf );
         RetVal = true;
      end;
   end;

   return RetVal;
END;

MACRO DL_GetShifrOper( Chapter, AccountPayer, AccountReceiver )

  var RetVal = "";

  if( Chapter == 1 )

     RetVal = "09";

     if( DL_IsClientAcc(AccountPayer.Account) AND (not DL_IsClientAcc(AccountReceiver.Account)) )
        if(Index(AccountReceiver.Type_Account, "К") == 0 )
           RetVal = "17";
        end;
     elif( DL_IsClientAcc(AccountReceiver.Account) AND (not DL_IsClientAcc(AccountPayer.Account)) )
        if(Index(AccountPayer.Type_Account, "К") == 0 )
           RetVal = "17";
        end;
     end;
  elif( Chapter == 3 )
     RetVal = "09";
     // "18" в векселях проставляется
  elif( Chapter == 4 )
     RetVal = "09";
  end;

  return RetVal;
END;

PRIVATE VAR isPlanMode = false;
PRIVATE VAR CheckCatArr = TArray();
PRIVATE VAR PlanInAccData = TArray();

MACRO DL_SetPlanMode(_isPlanMode:bool, _CheckCatArr)
  isPlanMode  = _isPlanMode;

  CheckCatArr.size = 0;
  if(ValType(_CheckCatArr) != V_UNDEF)
    CheckCatArr = TArray(_CheckCatArr); 
  end;

  PlanInAccData.size = 0;
END;

CLASS CDLPlanInAccData(_inacc)
  var inacc = TRecHandler("dlinacc.dbt");

  copy(inacc, _inacc);
END;

MACRO DL_GetPlanInAccData()
  return PlanInAccData;
END;

private var GlDealCode, DopFD, FlagSetDealCode = false;
private macro РасчетнаяОперацияВУ( accTrn : RsbAccTransaction, FD, ВидРО ) : bool
  var DlInAcc = TBfile("dlinacc.dbt");
  record  InnAcc(DlInAcc);
  var Tick = TBfile("dl_tick.dbt");
  var stat = true;

  var DealSum = $0, spground, dealcode = "", DealCost = $0;

  if( GetIdentProgram() == CodeFor("S") )
     InnAcc.Boffice   = OBJTYPE_BACKOFFICE_SP;
  elif( GetIdentProgram() == CodeFor("Ю") )
     InnAcc.Boffice   = OBJTYPE_BACKOFFICE_DV;
  elif( GetIdentProgram() == CodeFor("J") )
     InnAcc.Boffice   = OBJTYPE_BACKOFFICE_MM;
  elif( GetIdentProgram() == CodeFor("V") )
     InnAcc.Boffice   = OBJTYPE_BACKOFFICE_FOREX;
  elif( GetIdentProgram() == CodeFor("А") )
     InnAcc.Boffice   = OBJTYPE_BACKOFFICE_TRUST;
  elif( GetIdentProgram() == CodeFor("N") )
     InnAcc.Boffice   = OBJTYPE_BACKOFFICE_VA;
  end;

  InnAcc.OperType     = ВидРО;
  InnAcc.DocumentID   = FD.ID;

  InnAcc.AccTrnID   = accTrn.AccTrnID;
  InnAcc.Date       = accTrn.Date_Carry;
  InnAcc.Chapter    = accTrn.Chapter;
  InnAcc.DebAcc     = accTrn.AccountPayer;
  InnAcc.KredAcc    = accTrn.AccountReceiver;

  if (accTrn.Chapter == 22)
   InnAcc.FIKind    = FIKIND_AVOIRISS;
  else
   InnAcc.FIKind    = FIKIND_CURRENCY;
  end;

  InnAcc.FIID       = accTrn.FIIDPayer;
  InnAcc.Sum        = accTrn.SumPayer;
  InnAcc.Department = accTrn.Department;
  InnAcc.Oper       = accTrn.Oper;

  if( FD.Kind == 159 )
  /*если РОВУ привязана к сделке, вносим dealkind\dealcode из операции dl_acc_dbt*/
     if( (FD.dl_acc.rec.DealID > 0) and (FD.dl_acc.rec.Boffice == OBJTYPE_BACKOFFICE_SP) )
        Tick.Clear();
        Tick.rec.DealID = FD.dl_acc.rec.DealID;
        if( Tick.GetEQ() )
           InnAcc.DealKind = Tick.rec.BofficeKind;
           dealcode = Tick.rec.DealCode;
        else
           InnAcc.DealKind   = FD.Kind;
        end;
     else
        InnAcc.DealKind   = FD.Kind;
     end;
  else
     if( StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD") )
        InnAcc.DealKind   = FD.Request.Kind;
     elif( StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD") )
        InnAcc.DealKind   = FD.CalcORCB().rec.DocKind;
     else
        InnAcc.DealKind   = FD.Kind;
     end;
  end;

  InnAcc.DocumentKind = FD.Kind;

  if( not ((GlDealCode == "") and (ВидРО == 94) and (StrUpr(GenClassName(FD)) == StrUpr("TS_OrderFD"))) )
     if(FlagSetDealCode == true)
        dealcode = GlDealCode;
     end;
  end;

  FD.ВУ_СкорректироватьРесчетнуюОперацию( ВидРО, InnAcc );
  if(FlagSetDealCode == true)
     if(DopFD != NULL)
        DopFD.ВУ_СкорректироватьРесчетнуюОперацию( ВидРО, InnAcc );
     end;
  end;
  FlagSetDealCode = false;

  if(isPlanMode == true)
    if((InnAcc.DebAcc != "") or (InnAcc.KredAcc != ""))
      PlanInAccData[PlanInAccData.size] = CDLPlanInAccData(InnAcc);
    end;
  else
    stat = DL_InsertDLINACC(InnAcc, dealcode);
  end;

  return stat; 
end;

PRIVATE MACRO CheckCat(CatCode)
  var check = true;
  if((ValType(CheckCatArr) != V_UNDEF) and (CheckCatArr.size > 0))
    check = false;

    var i = 0;
    while(i < CheckCatArr.size)
      if(CatCode == CheckCatArr[i])
        check = true;
        break;
      end;
      i = i + 1;
    end;
  end;

  return check;
END;

PRIVATE MACRO GetAccount(FD, CatCode, FIRole, recAccount:@variant, ActionDate, FIID)
  var stat = true;
  var findAccount = "";

  if(isPlanMode)
    ClearRecord(recAccount);
    if(CheckCat(CatCode, CheckCatArr) == true)
      stat = FD.FindNumberAccount( CatCode,
                                   findAccount,
                                   false,
                                   FIRole,
                                   FIID
                                 );

      recAccount.Account       = findAccount;
      recAccount.Code_Currency = FIID;
    end;
  else
    stat = FD.OpenAccount( CatCode,
                           null,
                           false,
                           FIRole,
                           recAccount,
                           ActionDate,
                           FIID);
  end;

  return stat;
END;
MACRO ЮзерПроводкаПоКатегориямУчета(
  FD:VARIANT, 
  СчетДебет:VARIANT, СчетКредит:VARIANT, 
  ДатаВалютирования:DATE,
  Chapter:INTEGER, 
  FIID:INTEGER,
  СуммаОперации:MONEY,
  Numb_Document:STRING,
  Ground:STRING,
  FIRolePayer:INTEGER, FIRoleReceiver:INTEGER,
  СчетДебетFIID:INTEGER, СчетКредитFIID:INTEGER,
  IsInnerCarry,
  ВидРО:INTEGER,
  FDDebetParm:VARIANT, FDCreditParm:VARIANT
)
  var CуммаДебет:money = $0, СуммаКредит:money  = $0, tr = NULL, PaymentObj = NULL, 
      СчетОВПДебет = "", СчетОВПКредит = "", СчетДоходов = "", СчетРасходов = "";

  if( СуммаОперации == null )  
     return SayCarryError( "В проводке не задана ни одна из сумм." );
  end;

  /*оставить только копейки для первой суммы, если она задана*/
  if( СуммаОперации != null )
     if( (Chapter == 5) or (Chapter == 22) )
        /*количество ц/б может быть дробным*/
     else
        СуммаОперации = money( round( СуммаОперации, 2 ) );    
     end;
     if( СуммаОперации < $0 )  
        return SayCarryError( "Сумма проводки < 0." );
     end;
  else  
    СуммаОперации = $0;
  end;

  if( СуммаОперации == $0 )  
     return true;
  end;

  if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
     If(СчетДебет == "ДС Общий")
          FIRolePayer = FIROLE_SETTL_AGENT;
     end;
     If(СчетДебет == "ДС Клиринговый, ВУ")
          FIRolePayer = FIROLE_SETTL_AGENT;
     end;

      
/* 
    If(СчетДебет == "ДС Банка, ВУ")
         FIRolePayer = FIROLE_BANKROLL_BANK;
     end;
*/
     if( (StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD")) OR 
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD_DV"))
       )
        if( not FD.OpenAccount( FDDebetParm, СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID) )          
            return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
        end;
     else
        if( not FD.OpenAccount( СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID) )          
            return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
        end;
     end;
  else
     copy( AccountPayer, СчетДебет );
  end;

  if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
  
  If(СчетКредит == "ДС Общий")
      FIRoleReceiver = FIROLE_SETTL_AGENT;
  end;

  If(СчетДебет == "ДС Клиринговый, ВУ")
       FIRolePayer = FIROLE_SETTL_AGENT;
  end;

/*
  If(СчетКредит == "ДС Банка, ВУ")
     FIRoleReceiver = FIROLE_BANKROLL_BANK;
  end;
*/

     if( (StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD_DV"))
       )
        if( not FD.OpenAccount( FDCreditParm, СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID) )
           return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
        end;
     else
        if( not FD.OpenAccount( СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID) )
           return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
        end;
     end;
  else
     copy( AccountReceiver, СчетКредит );
  end;

  if( FIID == null )
     return SayCarryError("Не задана ни одна из валют проводки.");
  end;

  if( (FIID != AccountPayer.Code_Currency) AND
      (FIID != AccountReceiver.Code_Currency) )
     return SayCarryError( "В проводке не совпадают валюты счетов: " 
                            + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                           "| и валюта документа: " + string(FIID) );
  end;

  if( СуммаОперации != $0 )
     CуммаДебет = СуммаКредит = СуммаОперации;
  end;
/*KD PROV*/
//If(Chapter != 22)
  tr = RsbAccTransaction();

/*DAN.Ролевая модель Определяем конечного операциониста для проводки.  */
      var retvalGetMO = GetMainOperInGroup(FD.kind);
      if (retvalGetMO > 0)
	 Tr.Oper = retvalGetMO;
      else
         Tr.Oper = {Oper};
      end;
/*DAN*/

  if( tr == NULL )
     return SayCarryError("Ошибка при формировании документа проводки.");
  end;
  tr.Chapter         = Chapter;
  tr.Date_Carry      = ДатаВалютирования;
  tr.Numb_Document   = Numb_Document;
  tr.ResultCarry     = INPCARRY;
  tr.Kind_Oper       = "";
  tr.Ground          = Ground;
  tr.Department      = {OperDprt};
  tr.FIIDPayer       = AccountPayer.Code_Currency;
  tr.FIIDReceiver    = AccountReceiver.Code_Currency;
  tr.SumPayer        = CуммаДебет;
  tr.SumReceiver     = СуммаКредит;
  tr.AccountPayer    = AccountPayer.Account;
  tr.AccountReceiver = AccountReceiver.Account;
  if( PaymentObj != null )
     tr.Number_Pack  = PaymentObj.NumberPack;
  end;

     if( not tr.Carry() )
        return SayCarryError("Ошибка при выполнении проводки");
     end;
  
  if( IsInnerCarry )
     if( not РасчетнаяОперацияВУ( tr, FD, ВидРО ) )
        return SayCarryError("Ошибка при вставке расчетной операции внутреннего учета");
     end;
  end;
//end;
  return true;
END;

PRIVATE MACRO ПроводкаПоКатегориямУчета(
  FD:VARIANT,
  СчетДебет:VARIANT, СчетКредит:VARIANT,
  ДатаВалютирования:DATE,
  Chapter:INTEGER,
  FIID:INTEGER,
  СуммаОперации:MONEY,
  Numb_Document:STRING,
  Ground:STRING,
  FIRolePayer:INTEGER, FIRoleReceiver:INTEGER,
  СчетДебетFIID:INTEGER, СчетКредитFIID:INTEGER,
  IsInnerCarry,
  ВидРО:INTEGER,
  FDDebetParm:VARIANT, FDCreditParm:VARIANT
)
  var CуммаДебет:money = $0, СуммаКредит:money  = $0, tr = NULL, PaymentObj = NULL,
      СчетОВПДебет = "", СчетОВПКредит = "", СчетДоходов = "", СчетРасходов = "";

  if( СуммаОперации == null )
     return SayCarryError( "В проводке не задана ни одна из сумм." );
  end;

  /*оставить только копейки для первой суммы, если она задана*/
  if( СуммаОперации != null )
     if( (Chapter == 5) or (Chapter == 22) )
        /*количество ц/б может быть дробным*/
     else
        СуммаОперации = money( round( СуммаОперации, 2 ) );
     end;
     if( СуммаОперации < $0 )
        return SayCarryError( "Сумма проводки < 0." );
     end;
  else
    СуммаОперации = $0;
  end;

  if( СуммаОперации == $0 )
     return true;
  end;

  if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
     if( (StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD_DV"))
       )
        if( not FD.OpenAccount( FDDebetParm, СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID) )
            return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
        end;
     else
        if(not GetAccount(FD, СчетДебет, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID))
          return SayCarryError( "Ошибка при определении счета по категории "+СчетДебет+" в проводке.");
        end;
     end;
  else
     copy( AccountPayer, СчетДебет );
  end;

  if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
     if( (StrUpr( GenClassName(FD) ) == StrUpr("TS_CALCORCB_FD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_ReqAssetFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD")) OR
         (StrUpr( GenClassName(FD) ) == StrUpr("TS_OrderFD_DV"))
       )
        if( not FD.OpenAccount( FDCreditParm, СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID) )
           return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке." );
        end;
     else
        if(not GetAccount(FD, СчетКредит, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID))
          return SayCarryError( "Ошибка при определении счета по категории "+СчетКредит+" в проводке.");
        end;
     end;
  else
     copy( AccountReceiver, СчетКредит );
  end;

  if( FIID == null )
     return SayCarryError("Не задана ни одна из валют проводки.");
  end;

  if( (FIID != AccountPayer.Code_Currency) AND
      (FIID != AccountReceiver.Code_Currency) )
     return SayCarryError( "В проводке не совпадают валюты счетов: "
                            + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                           "| и валюта документа: " + string(FIID) );
  end;

  if( СуммаОперации != $0 )
     CуммаДебет = СуммаКредит = СуммаОперации;
  end;

  tr = RsbAccTransaction();

/*DAN.Ролевая модель Определяем конечного операциониста для проводки */
      var retvalGetMO = GetMainOperInGroup(FD.kind);
      if (retvalGetMO > 0)
	 Tr.Oper = retvalGetMO;
      else
         Tr.Oper = {Oper};
      end;
/*DAN*/

  if( tr == NULL )
     return SayCarryError("Ошибка при формировании документа проводки.");
  end;
  tr.Chapter         = Chapter;
  tr.Date_Carry      = ДатаВалютирования;
  tr.Numb_Document   = Numb_Document;
  tr.ResultCarry     = INPCARRY;
  tr.Kind_Oper       = "";
  tr.Ground          = Ground;
  tr.Department      = {OperDprt};
  tr.FIIDPayer       = AccountPayer.Code_Currency;
  tr.FIIDReceiver    = AccountReceiver.Code_Currency;
  tr.SumPayer        = CуммаДебет;
  tr.SumReceiver     = СуммаКредит;
  tr.AccountPayer    = AccountPayer.Account;
  tr.AccountReceiver = AccountReceiver.Account;
  if( PaymentObj != null )
     tr.Number_Pack  = PaymentObj.NumberPack;
  end;

  if(isPlanMode == false)
    if( not tr.Carry() )
       return SayCarryError("Ошибка при выполнении проводки");
    end;
  end;

  if( IsInnerCarry )
     if( not РасчетнаяОперацияВУ( tr, FD, ВидРО ) )
        return SayCarryError("Ошибка при вставке расчетной операции внутреннего учета");
     end;
  end;

  return true;
END;

macro ПроводкаПоКатегориямВнутреннегоУчета( ВидРО, FD, Doc, CarryDate, FIID, CarrySumm:money, FDDebetParm:VARIANT, FDCreditParm:VARIANT, DealCode, GroundStr, AccDeb:VARIANT, AccKred:VARIANT, _FIRolePayer:integer, _FIRoleReceiver:integer )
  var ClassName:string = "";
  var Ground:string = "";
  var AccountDeb, AccountKred;
  var FIRolePayer:integer = -1, FIRoleReceiver:integer = -1;

  if( not ВестиВнутреннийУчет() )
     return 1;
  end;

  FlagSetDealCode = false;
  if(ValType(DealCode) != V_UNDEF)
     GlDealCode = DealCode;
     DopFD      = FDDebetParm;
     FlagSetDealCode = true;
  else
     if( FD != NULL )
        ClassName = StrUpr( GenClassName( FD ));
        if( (ClassName == StrUpr("SPFirstDoc") ) OR
            (ClassName == StrUpr("SPFirstDocTrust")) OR
            (ClassName == StrUpr("TS_VaTickFD"))
          )
           if( FD.tick != NULL ) //Сделка
              GlDealCode = FD.tick.rec.DealCode;
              FlagSetDealCode = true;
           end;
        elif( ClassName == StrUpr("TS_ReqAssetFD" ) )   //операция ВВК ДУ
           if( FD.Request != NULL )
              GlDealCode = FD.Request.Number;
              FlagSetDealCode = true;
           end;
        elif( ClassName == StrUpr("DLFirstDocDL_Acc" ) )//расчетная операция
           if( FD.dl_acc != NULL )
              GlDealCode = FD.dl_acc.rec.Code;
              FlagSetDealCode = true;
           end;
        elif( ClassName == StrUpr("TS_CALCORCB_FD" ) )  //расчеты на ОРЦБ
           if( FD.CalcORCB() != NULL )
              GlDealCode = FD.CalcORCB().rec.CommCode;
              FlagSetDealCode = true;
           end;
        elif( (ClassName == StrUpr("SPFirstDocDLCOMM" )) or (ClassName == StrUpr("DVFirstDocDLCOMM" )) )
           if( FD.comm != NULL )
              GlDealCode = FD.comm.rec.CommCode;
              FlagSetDealCode = true;
           end;
        end;
     end;
  end;

  if(ValType(GroundStr) == V_STRING)
     Ground = GroundStr;
  else
     Ground = FD.ВУ_ОснованиеПроводки( ВидРО );
  end;

  if( (StrUpr(GenClassName(FD)) == StrUpr("SPFirstDocDLCOMM")) AND ((FD.Kind == DL_ISSUE_UNION) OR (FD.Kind == DL_CHGAVRNOM) OR ((FD.Kind == DL_SETTLEMENT) AND (AccDeb != NULL) AND (AccKred != NULL))) )
     AccountDeb  = AccDeb;
     AccountKred = AccKred;
  elif((StrUpr(GenClassName(FD)) == StrUpr("DLFirstDocNPTXOP")) AND (FD.Kind == DL_HOLDNDFL) AND (AccDeb != NULL) AND (AccKred != NULL))
     AccountDeb  = AccDeb;
     AccountKred = AccKred;
  else
     AccountDeb  = FD.ВУ_ПолучитьКатегориюДебет( ВидРО, null, CarryDate, FIID );
     AccountKred = FD.ВУ_ПолучитьКатегориюКредит( ВидРО, null, CarryDate, FIID );
  end;

  if( _FIRolePayer != NULL )
     FIRolePayer = _FIRolePayer;
  else
     FIRolePayer = FD.ВУ_ПолучитьРольФИ(ВидРО, true);
  end;

  if( _FIRoleReceiver != NULL )
     FIRoleReceiver = _FIRoleReceiver;
  else
     FIRoleReceiver = FD.ВУ_ПолучитьРольФИ(ВидРО, false);
  end;

  return ПроводкаПоКатегориямУчета( FD,
                                    AccountDeb,
                                    AccountKred,
                                    CarryDate,
                                    FD.ВУ_ОпределениеГлавы(FIID),
                                    FIID,
                                    CarrySumm,
                                    "",
                                    Ground,
                                    FIRolePayer,
                                    FIRoleReceiver,
                                    FIID, FIID,
                                    true,
                                    FD.ВУ_ПолучитьРО(ВидРО),
                                    FDDebetParm, FDCreditParm
                                  );
end;

/**
 @brief Получение реального вида ФИ
        Т.к. драгметаллы для клиентов заведены как базовый актив Валюта, то вид базового инструмента необходимо определять по буквенному ISO-коду валюты 
        Если ISO-код начинается с латинской буквы "A", то ФИ - драгметалл
 @param[in]  FIID  идентификатор ФИ 
 @return вид ФИ
*/
macro GetRealFIKind(FIID:integer):integer
  var cmd, DataSet;
  var RetVal:integer = 0;

  cmd = DL_RSDCommand( " SELECT RSI_RSB_FIInstr.FI_GetRealFIKind(?) FI_Kind " +
                       "   FROM dual " );
  cmd.AddParam(FIID);
  DataSet = cmd.Execute();
  if(DataSet.moveNext())
    RetVal = SQL_ConvTypeInteger(DataSet.FI_Kind);
  end;

  return RetVal;
end;