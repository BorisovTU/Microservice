/* ╔══════════════════════════════════════════════════════════════════╗ */
/*         Автоматизированная банковская система RS-Bank v5.10          */
/*                 Copyright (c) R-Style SoftLab 2002                   */
/*                                                                      */
/*  Имя файла        : dlsole.mac                                       */
/*                                                                      */
/*  Описание         : Стандартная подошва отчета                       */
/*  Программист      : Голдобин А.А.                                    */
/*                                                                      */
/*  Создан           : 31.01.2002                                       */
/*                                                                      */
/* ╚══════════════════════════════════════════════════════════════════╝ */
IMPORT Globals, RsbDataSet;


/*
MACRO НайтиНачальникаБО( ПодразделениеБО )  
    должностьНач = "Начальник отдела";
    фиоНач = "";
    Сотрудники = TBfile("officer");
    Сотрудники.KeyNum = 5;
    Сотрудники.rec.PartyID = {OurBank};
    Сотрудники.rec.OfficeID = ПодразделениеБО;
    Сотрудники.rec.IsFirstOfficePerson = "X";  
    if( GetEq(Сотрудники) )            
        if( Сотрудники.rec.Post != "" )
            должностьНач = Сотрудники.rec.Post;
        end;
        Субъекты = TBfile("party");
        Субъекты.KeyNum = 0;
        Субъекты.rec.PartyID = Сотрудники.rec.PersonID;
        if( GetEq(Субъекты) )
            фиоНач = Субъекты.rec.ShortName;
        end
    end
END;

MACRO НайтиИсполнителя
VAR length;              
      должностьИсп = "Ответственный сотрудник";
      фиоИсп = "";  
      Пользователи = TBfile("person");
      Пользователи.KeyNum = 0;  
      Пользователи.rec.Oper = {oper};
      if( GetEq(Пользователи) )
          if( {oper} == 9999 )
              length = strbrk(Пользователи.rec.Name, " ");          
              if( length == 0 )
                  length = strlen( Пользователи.rec.Name );
              end;
              фиоИсп = substr( Пользователи.rec.Name, 1, length );
          else 
              Сотрудники = TBfile("officer");
              Сотрудники.KeyNum = 0;
              Сотрудники.rec.PartyID = {OurBank};
              Сотрудники.rec.PersonID = Пользователи.rec.PartyID;
              if( GetEq(Сотрудники) )
                  if( Сотрудники.rec.Post != "" )
                      должностьИсп = Сотрудники.rec.Post;
                  end;
              end;
              Субъекты = TBfile("party");
              Субъекты.KeyNum = 0;
              Субъекты.rec.PartyID = Пользователи.rec.PartyID;
              if( GetEq(Субъекты) )
                  фиоИсп = Субъекты.rec.ShortName;
              end
          end// if else 
      end// if 
END;*/

MACRO НайтиНачальникаБО( ПодразделениеБО, должностьНач:@string, фиоНач:@string )  
    var person, officers = TRsbDataSet("select t_PersonID, t_Post from dofficer_dbt where t_PartyID = "+
                             {OurBank}+" and t_OfficeID = "+ПодразделениеБО+" and t_IsFirstOfficePerson = 'X'");
    должностьНач = "Начальник отдела";
    фиоНач = "";
    if(officers.movenext)
       if( officers.Post != "" )
           должностьНач = officers.Post;
       end;
       person = TRsbDataSet("select t_ShortName from dparty_dbt where t_PartyID = "+officers.PersonID);
       if(person.movenext)
          фиоНач = person.ShortName;
       end;
    end;
END;

MACRO НайтиИсполнителя( должностьИсп:@string, фиоИсп:@string )
VAR length, officers, person,
    users = TRsbDataSet("select t_PartyID, t_Name from dperson_dbt where t_Oper = "+{oper});

    должностьИсп = "Ответственный сотрудник";
    фиоИсп = "";
    if(users.movenext)
       if( {oper} == 9999 )
           length = strbrk(users.Name, " ");          
           if( length == 0 )
               length = strlen( users.Name );
           end;
           фиоИсп = substr( users.Name, 1, length );
       else
           officers = TRsbDataSet("select t_Post from dofficer_dbt where t_PartyID = "+{OurBank}+
                             " and t_PersonID = "+users.PartyID);
           if(officers.movenext)
              if( officers.Post != "" )
                 должностьИсп = officers.Post;
              end;
           end;
           person = TRsbDataSet("select t_ShortName from dparty_dbt where t_PartyID = "+users.PartyID);
           if(person.movenext)
              фиоИсп = person.ShortName;
           end;
       end;
    end;
END;

MACRO printTXT( должность, фио )
[                                                                                   ];
    if( фио != "" )
[ ######################################  __________  ##############################](должность, фио:c);
[                                          (подись)                                 ];
    else
[ ######################################  __________  ______________________________](должность);
[                                          (подись)                                 ];
    end
END;

MACRO ПодошваОтчета( Директор, ГлавБух, НачБО, Исполнитель, ПодразделениеБО )   
VAR  должностьНач = "", фиоНач = "", 
     должностьИсп = "", фиоИсп = "";
 
     if( Директор )
         if( {Name_Boss} == "" )
            {Name_Boss} = "Директор банка";
         end;
         printTXT({Name_Boss},{FIO_Boss});
     end;   
     if( ГлавБух )
         if( {Name_Book} == "" )
             {Name_Book} = "Главный бухгалтер банка";
         end;
         printTXT({Name_Book},{FIO_Book});
     end;
     if( НачБО )
         НайтиНачальникаБО( ПодразделениеБО, @должностьНач, @фиоНач );
         printTXT( должностьНач, фиоНач );
     end;
     if( Исполнитель )
         НайтиИсполнителя( @должностьИсп, @фиоИсп );
         printTXT( должностьИсп, фиоИсп );
     end;
[                                                                             ];
END;    

