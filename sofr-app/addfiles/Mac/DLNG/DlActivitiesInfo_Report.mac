/*
$Name:             DlActivitiesInfo_Report.mac
$Module:           Ценные бумаги
$Description:      Отчет "Сведения об осуществлении брокерской, депозитарной деятельности, деятельности по управлению ценными бумагами и инвестиционному консультированию"
*/
/*Отчет был отключен в рамках DEF-78341*/
import "DLReport_h.mac", "DlActivitiesInfo_Form.mac", "ws_txreportform.mac", "cb_sql.mac", "dv_const.mac", "dvrepfun.mac", "dvserv.mac", "dv_ground.mac", "bnk_dttmfrmt.mac", "dlquery.mac", "scsrvrepfun.mac";

PRIVATE FILE Kliko_F707() txt write;

PRIVATE VAR Form707;
PRIVATE VAR Report707;
PRIVATE VAR WebMenuItem; // Информация о запуске отчета из веб

PRIVATE CONST DEBUG_OUTPUT       = FALSE;
PRIVATE CONST DEBUG_NO_CALC      = FALSE;
PRIVATE CONST DEBUG_TMP_TABLE    = FALSE;
//PRIVATE CONST RATETYPE_BLOOMBERG_PRICE = 23;

PRIVATE CONST PARALLEL_LEVEL = 8;
PRIVATE CONST PARTITION_COUNT = 10;

PRIVATE CONST
   RCB_XML_PK_MONTHLY   = 4,
   RCB_XML_PK_QUARTERLY = 5;

PRIVATE CONST POI_MODE = TRUE;

PRIVATE CONST GREYCOLOR    = RGB(192,192,192);     //SVE DEF-20802

PRIVATE CONST MAXSTRLEN    = 4000;
//Перечисление подразделов раздела 3 для выгрузки в Delta
PRIVATE CONST SUBSECTION_PART3_DELTA_RES                = 1, //Клиентов-резидентов
              SUBSECTION_PART3_DELTA_RES_SUB            = 2, //в том числе по субъектам
              SUBSECTION_PART3_DELTA_ACTIVE_RES         = 3, //Активных клиентов-резидентов
              SUBSECTION_PART3_DELTA_ACTIVE_RES_SUB     = 4, //в том числе по субъектам
              SUBSECTION_PART3_DELTA_NOT_RES            = 5, //Клиентов-нерезидентов
              SUBSECTION_PART3_DELTA_NOT_RES_CON        = 6, //в том числе по странам
              SUBSECTION_PART3_DELTA_ACTIVE_NOT_RES     = 7, //Активных клиентов-нерезидентов
              SUBSECTION_PART3_DELTA_ACTIVE_NOT_RES_CON = 8; //в том числе по странам

var dbg_time = null;
var dbg_num = 0;

private macro dbg(msg)
  if (msg == null)
    dbg_num = dbg_num + 1;
    msg = string(dbg_num);
  end;
  if (DEBUG_OUTPUT)
    if (dbg_time != null)
      msg = string(time() - dbg_time) + " " + string(msg);
    end;
    println(msg);
    dbg_time = time();
  end;
end;

PRIVATE CONST PTSK_STOCKDL = 1,
              PTSK_DV = 15,
              PTSK_VEKSACC = 14,
              PTSK_DEPOS = 7,
              PTSK_CM = 21;

PRIVATE CONST PTK_CLIENT = 1;

PRIVATE CONST SC_SPDRAFT_STATUS_PREP   = 1;  /* отложенное поручение депо */
PRIVATE CONST OBJTYPE_TRN_CONT_BUYSELL = 1;  /* Содержание транзакции: Купля-продажа*/

PRIVATE CONST ЮРИДИЧЕСКОЕ_ЛИЦО = 1,
              ФИЗИЧЕСКОЕ_ЛИЦО = 2;

PRIVATE CONST CALCTYPE_COUNTRY = 1,
              CALCTYPE_NOCOUNTRY = 2,
              CALCTYPE_INTERNATIONAL = 3,
              CALCTYPE_SIMPLE = 4;

/* Golovkin 19.10.2020 Для категории 103 на дбо(207) другие значения */
PRIVATE CONST RISKLEVEL_NOTINSTALL = 0,
              RISKLEVEL_USUAL = 1,
              RISKLEVEL_ELEVATED = 2,
              RISKLEVEL_SPECIAL = 3;

PRIVATE CONST REPORT_FORM_CHAPTER_F707N_1 = 0; // Разделы Формы отчета <F707N_1>

PRIVATE MACRO GetSessionID():Integer
  var id:Integer = -1;
  var sql = "SELECT SYS_CONTEXT('USERENV','SESSIONID') SessionID FROM DUAL";
  var cmd = DL_RSDCommand(sql);
  var ds = cmd.execute();
  if( ds.MoveNext() )
    id = int(ds.SessionID);
  end;
  return id;
END;

PRIVATE MACRO _GetRate(d, from_fi, to_fi, MarketId:integer)
   var err, sincedate;
   var rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, 1, err, sincedate, MarketId);
   if ((rate == NULL) or (rate == 0.0) or (iif(IsWorkDay(d), d, GetDateAfterWorkDays(d, -1)) > sincedate))
     rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, 23, err, sincedate);
     if ((rate == NULL) or (rate == 0.0))
       rate = GetRateOnDateCrossDbl(d, from_fi, to_fi, false, 1001, err, sincedate);
       if ((rate == NULL) or (rate == 0.0))
         return NULL;
       end;
     end;
   end;
   return rate;
END;

PRIVATE macro GetOkatoCode(pt:variant,OnDate:Date)
   var party = TRecHandler ("party.dbt");
   var okatoCode, lenght_okato_code = 5;

   if( ValType(pt)==V_INTEGER )
      ПолучитьСубъекта(pt, party);
   elif( ValType(pt)==V_GENOBJ )
      party = pt;
   end;

   getMainObjAttr (null,
                   OBJTYPE_PARTY,
                   uniID(party, OBJTYPE_PARTY),
                   12,
                   null,
                   null,
                   okatoCode,
                   OnDate);

   if (okatoCode==null)
      getMainObjAttr (null,
                   OBJTYPE_PARTY,
                   uniID(party, OBJTYPE_PARTY),
                   12,
                   null,
                   null,
                   okatoCode);
   end;
   return DL_IIF(okatoCode==null,"",okatoCode);
end;

PRIVATE MACRO ПолучитьПоследнийКурсНаДатуТипа( p_RateDate:DATE, p_fiid:INTEGER, p_Type:INTEGER, p_OtherFi:@INTEGER, p_MarketId:INTEGER ):bool
  VAR v_Data, v_Query, IsExistCurse = false;

  v_Query = RSDCommand(
             "SELECT t_rateid, t_fiid "+
             "  FROM (SELECT t_rateid, t_fiid "+
             "            FROM (SELECT rate.t_rateid, rate.t_sincedate, rate.t_type, rate.t_fiid, rate.T_ISRELATIVE, rate.t_otherfi "+
             "                    FROM dratedef_dbt rate "+
             "                   WHERE rate.t_otherfi = ? "+ /*string(Fiid_from) */
IIF( p_MarketId and ( p_MarketId > 0 ), " AND rate.t_Market_Place = " + string(p_MarketId), "")+
             "                     AND t_sincedate    = (SELECT MAX (t_sincedate) "+
             "                                             FROM dratedef_dbt "+
             "                                            WHERE     t_otherfi = rate.t_otherfi "+
             "                                                  AND t_type    = rate.t_type  "+
                      IIF( p_MarketId and ( p_MarketId > 0 ), " AND t_Market_Place = " + string(p_MarketId), "")+
             "                                                  AND t_sincedate <= ? "+ /*RateDate*/
             "                                          ) "+
             "                  UNION "+
             "                    SELECT r.t_rateid, h.t_sincedate, r.t_type, r.t_fiid, r.T_ISRELATIVE, r.t_otherfi "+
             "                      FROM dratehist_dbt h, dratedef_dbt r "+
             "                     WHERE     r.t_rateid    = h.t_rateid "+
             "                           AND r.t_otherfi   = ? "+  /*string(Fiid_from) */
IIF( p_MarketId and ( p_MarketId > 0 ), " AND r.t_Market_Place = " + string(p_MarketId), "")+
             "                           AND h.t_sincedate = ( SELECT MAX (h2.t_sincedate) "+
             "                                                   FROM dratehist_dbt h2, dratedef_dbt r2 "+
             "                                                  WHERE r2.t_rateid  = h2.t_rateid "+
             "                                                    AND r2.t_otherfi = r.t_otherfi "+
             "                                                    AND r2.t_type    = r.t_type  "+
                        IIF( p_MarketId and ( p_MarketId > 0 ), " AND r2.t_Market_Place = " + string(p_MarketId), "")+
             "                                                    AND h2.t_sincedate <= ?  "+ /*RateDate*/
             "                                               ) "+
             "                 ) WHERE t_type IN (?)"+
             // Golovkin 17.05.2019 для относительных курсов берём в первую очередь валюту номинала
             "         ORDER BY t_sincedate DESC,                                            " +
             "                  (CASE                                                        " +
             "                      WHEN T_ISRELATIVE != CHR (88) THEN 1                     " +
             "                      WHEN T_ISRELATIVE = CHR (88)                             " +
             "                           AND t_fiid = (SELECT fin.t_facevaluefi              " +
             "                                           FROM dfininstr_dbt fin              " +
             "                                          WHERE fin.t_fiid = t_otherfi) THEN 1 " +
             "                      ELSE 0                                                   " +
             "                   END) DESC,                                                  " +
             "                  t_type ASC                                                   " +
             //"        ORDER BY t_sincedate DESC, t_type ASC "+
             "       ) "+
             " WHERE ROWNUM = 1 "
                     );

  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_fiid );
  v_Query.addParam( "", RSDBP_IN, p_RateDate );
  v_Query.addParam( "", RSDBP_IN, p_Type );
  v_Query.execute();

  v_Data = TRsbDataSet( v_Query );
  if( v_Data.MoveNext() )
    p_OtherFi = v_Data.fiid;
    IsExistCurse = true;
  elif( p_MarketId and ( p_MarketId > 0 ) )
    IsExistCurse = ПолучитьПоследнийКурсНаДатуТипа( p_RateDate, p_fiid, p_Type, @p_OtherFi );
  end;

  return IsExistCurse;
END;

PRIVATE MACRO GetRiskName(RiskLevel):String
   var RiskName = "";

   if( RiskLevel == RISKLEVEL_NOTINSTALL )
      RiskName = "Без уровня";
   elif( RiskLevel == RISKLEVEL_USUAL )
      RiskName = "Стандартный";
   elif( RiskLevel == RISKLEVEL_ELEVATED )
      RiskName = "Повышенный";
   elif( RiskLevel == RISKLEVEL_SPECIAL )
      RiskName = "Особый";
   end;

   return RiskName;
END;

PRIVATE MACRO hasOGRN(PartyID):Bool
  var Query = "begin ? := RSI_RSBPARTY.GetPartyCode(?, 27); end;";
  var cmd = RSDCommand(Query);
  cmd.addParam("pReturn",  RSDBP_OUT, V_STRING,    10000);
  cmd.addParam("PPARTYID", RSDBP_IN, PartyID);
  cmd.execute();

  return iif((cmd.value(0) == ""), false, true);
END;


CLASS F707DeltaXML(OKUD:String, ReportKind:String, EndDate:Date, Periodicity:Integer)
  var jvm;
  var m_XmlReport;
  var m_OKUD = OKUD;
  var m_EndDate = EndDate;
  var m_FileName = "";
  var m_Protocol;
  var m_DepCode;

  private macro CreateSignersNode(NodeName:String, Post:String, FIO:String, Phone:String, Fax:String, Email:String)
    var attributes = jvm.createJavaObject("java.util.ArrayList");

    var PostAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Должность", Post);
    attributes.add(PostAttr);
    var FIOAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ФИО", FIO);
    attributes.add(FIOAttr);

    if(NodeName == "Исполнитель")
      var PhoneAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Телефон", Phone);
      attributes.add(PhoneAttr);
      var FaxAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Факс", Fax);
      attributes.add(FaxAttr);
      var EmailAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ЭлПочта", Email);
      attributes.add(EmailAttr);
    end;

    m_XmlReport.addLine(NodeName, attributes, "");
  end;

  macro PrintInfo()
    var registrationNumber = ПолучитьКодСубъекта({OurBank}, PTCK_BANKREGNUM);
    var BIC = ПолучитьКодСубъекта({OurBank}, PTCK_BIC);
    var party = TRecHandler("party.dbt");
    var OKATO = "";
    var OKPO = "";
    var OGRN = ПолучитьКодСубъекта({OurBank}, PTCK_OGRN);
    var Name = "";
    var PostalAdress = "";
    var adress = TRecHandler("adress.dbt");
    var leaderPost:String = "", leaderName:String = "";
    var executorPost:String = "", executorName:String = "", executorPhone:String = "", executorFax:String = "", executorEmail:String = "";
    var glavBuhPost:String, glavBuhName:String;
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    ПолучитьСубъекта({OurBank}, party);
    OKPO = IIF(party.rec.OKPO != NULL, party.rec.OKPO, "");
    Name = party.rec.ShortName;

    GetMainObjAttr(NULL,
                   OBJTYPE_PARTY,
                   UniID(party, OBJTYPE_PARTY),
                   RCB_OBJGROUP_PT_OKATO, // 12
                   NULL,
                   NULL,
                   OKATO,
                   m_EndDate
                  );

    if(OKATO == NULL)
       var OkatoQuery = "select adress.t_OKATO " +
                        "from dadress_dbt adress " +
                        "where adress.t_Type = 1 " +
                        "  and adress.t_PartyID = " + string({OurBank});
 
       var OkatoSelect = DL_RSDCommand(OkatoQuery);
       var OkatoDS = OkatoSelect.Execute();
       if(OkatoDS.MoveNext())
          OKATO = OkatoDS.OKATO;
       end;
    end;

    OKATO = IIF(OKATO != NULL, OKATO, "");

    if(найтиЮридическийАдресСубъекта({OurBank}, adress) or
       найтиПочтовыйАдресСубъекта({OurBank}, adress) or
       найтиАдресСубъекта({OurBank}, PTADDR_REAL, adress)
      )
       PostalAdress = adress.rec.Adress;
    end;

    var leaderQuery = "select off.t_Post, " +
                      "       party.t_Name " +
                      "from dofficer_dbt off, dparty_dbt party " +
                      "where off.t_IsFirstPerson = 'X' " +
                      "  and off.t_PartyID = " + string({OurBank}) +
                      "  and party.t_PartyID = off.t_PersonID ";

    var leaderSelect = DL_RSDCommand(leaderQuery);
    var leaderDS = leaderSelect.Execute();

    if(leaderDS.MoveNext())
       leaderPost = leaderDS.Post;
       leaderName = leaderDS.Name;
    else
       leaderPost = leaderName = "";
    end;

    var executorQuery = "select off.t_Post, " +
                        "       persn.t_Name1 || ' ' || persn.t_Name2 || ' ' || persn.t_Name3 as t_Name, " +
                        "       off.t_PhoneNumber as t_Phone,                                            " +
                        "       nvl( " +
                        "             ( " +
                        "                select q_Fax.t_Value " +
                        "                from ( " +
                        "                        select Fax.t_Value " +
                        "                        from dcontact_dbt Fax " +
                        "                        where Fax.t_PartyID = person.t_PartyID " +
                        "                          and Fax.t_ContactKind = 3 " +
                        "                        order by Fax.t_IsMain DESC " +
                        "                     ) q_Fax " +
                        "                where ROWNUM = 1 " +
                        "             ), chr(1) " +
                        "          ) as t_Fax, " +
                        "       nvl( " +
                        "             ( " +
                        "                select q_Email.t_Value " +
                        "                from ( " +
                        "                        select Email.t_Value " +
                        "                        from dcontact_dbt Email " +
                        "                        where Email.t_PartyID = person.t_PartyID " +
                        "                          and Email.t_ContactKind = 5 " +
                        "                          and Email.t_ContactType = 8 " +
                        "                        order by Email.t_IsMain DESC " +
                        "                     ) q_Email " +
                        "                where ROWNUM = 1 " +
                        "             ), chr(1) " +
                        "          ) as t_Email " +
                        "from dofficer_dbt off, dpersOn_dbt persOn, dpersn_dbt persn " +
                        "where persOn.t_Oper = " + string({Oper}) +
                        "  and off.t_PartyID = " + string({OurBank}) +
                        "  and off.t_PersonID = persOn.t_PartyID " +
                        "  and persn.t_PersonID = persOn.t_PartyID ";

    var executorCmd = DL_RSDCommand(executorQuery);
    var executorDS = executorCmd.Execute();
    if(executorDS.MoveNext())
      executorPost = executorDS.Post;
      executorName = executorDS.Name;
      executorPhone = executorDS.Phone;
      executorFax = executorDS.Fax;
      executorEmail = executorDS.Email;
    end;

    var KindOrgAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ВидОрг", "КО");
    attributes.add(KindOrgAttr);
    var RegNumAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодОрг", registrationNumber);
    attributes.add(RegNumAttr);
    //var DepCodeAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодТУ", "");
    //attributes.add(DepCodeAttr);
    if (BIC != "")
      var BICAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "БИК", BIC);
      attributes.add(BICAttr);
    end;
    //var OKATOAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКАТО", "");
    //attributes.add(OKATOAttr);
    if (OKPO != "")
      var OKPOAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКПО", OKPO);
      attributes.add(OKPOAttr);
    end;
    if (OGRN != "")
      var OGRNAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОГРН", OGRN);
      attributes.add(OGRNAttr);
    end;
    if (Name != "")
      var ShNameAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "СокрНаимен", Name);
      attributes.add(ShNameAttr);
    end;
    if (PostalAdress != "")
      var AdressAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Адрес", PostalAdress);
      attributes.add(AdressAttr);
    end;
    var SignDateAttr = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ДатаПодписания", YYYY_MM_DD({CurDate}));
    attributes.add(SignDateAttr);

    m_XmlReport.beginPart("Составитель", attributes);
      CreateSignersNode("Руководитель", leaderPost, leaderName, "", "", "");
      CreateSignersNode("Контролер", executorPost, executorName, "", "", "");
      CreateSignersNode("Исполнитель", executorPost, executorName, executorPhone, executorFax, executorEmail);
    m_XmlReport.finishPart();

    m_Protocol = m_XmlReport.getProtocol();
  end;

  macro BeginData707(HasData:BOOL)
    var IdAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Ид", "1");
    var HasDataAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПризнакПредст", IIF(HasData, "1", "0"));
    var Attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var NomLic = ПолучитьКодСубъекта({OurBank}, PTCK_ORCBLICENSE);
    var NomLicAttribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "НомЛиц", NomLic);
    var AttributesNomLic = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var AttributesLic = jvm.createJavaObject("java.util.ArrayList", "<init>");

    Attributes.add(IdAttribute);
    Attributes.add(HasDataAttribute);
    m_XmlReport.beginPart("Данные707", Attributes); //<Данные707 Ид = "" ПризнакПредст = "">
       m_XmlReport.beginPart("Лицензия", AttributesLic); // <Лицензия>
          AttributesNomLic.add(NomLicAttribute);
          m_XmlReport.addLine("НомЛиц", AttributesNomLic, "");
       m_XmlReport.finishPart(); // </Лицензия>
  end;

  private macro Delta_Fld( Val:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL ) 
      VAR vt = ValType(Val);
      if( vt == V_DATE )
        if( Val == DATE(0,0,0) )
          ValStr = "0";
        else
          ValStr = YYYY_MM_DD(Val);
        end;
      elif( vt == V_STRING )
        ValStr = StrSubst( Val, "\"", "''" );
        ValStr = StrSubst( ValStr, "-", "0" );
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        if( Val != 0.00)
          ValStr = trim(string(Val:18:2));
        else
          ValStr = "0.00";
        end;
      else
        ValStr = string(Val);
      end;
    else
      ValStr="0";
    end;

    return ValStr;
  end;

  macro BeginPart1()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел1", attributes); //<Раздел1>
  end;

  macro PrintLinePart1(CodeStr:Integer, CountryCode:String, ClientCount:Integer, InAccPlus, SecurPlus, RestMoneyPlus, RestSecurPlus,
                           RestOtherPlus, InAccMinus, SecurMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus)

    var Part1LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var A1Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодСтр", Delta_Fld(CodeStr));
    Part1LineAttributes.add(A1Attribute);
    if (CountryCode != "")
      var A2Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКАТО", Delta_Fld(CountryCode));
      Part1LineAttributes.add(A2Attribute);
    end;
    var A3Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиент", Delta_Fld(ClientCount));
    Part1LineAttributes.add(A3Attribute);
    var A4Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоложДенежСредстКл", Delta_Fld(InAccPlus));
    Part1LineAttributes.add(A4Attribute);
    var A5Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоложЦБКлиентов", Delta_Fld(SecurPlus));
    Part1LineAttributes.add(A5Attribute);
    var A6Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоложТребПоДенСр", Delta_Fld(RestMoneyPlus));
    Part1LineAttributes.add(A6Attribute);
    var A7Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоложТребПоЦБ", Delta_Fld(RestSecurPlus));
    Part1LineAttributes.add(A7Attribute);
    var A8Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ПоложТребПоИнАктивам", Delta_Fld(RestOtherPlus));
    Part1LineAttributes.add(A8Attribute);
    var A9Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОтрицДенежСредстКл", Delta_Fld(InAccMinus));
    Part1LineAttributes.add(A9Attribute);
    var A10Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОтрицЦБКлиентов", Delta_Fld(SecurMinus));
    Part1LineAttributes.add(A10Attribute);
    var A11Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОтрицТребПоДенСр", Delta_Fld(RestMoneyMinus));
    Part1LineAttributes.add(A11Attribute);
    var A12Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОтрицТребПоЦБ", Delta_Fld(RestSecurMinus));
    Part1LineAttributes.add(A12Attribute);
    var A13Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОтрицТребПоИнАктивам", Delta_Fld(RestOtherMinus));
    Part1LineAttributes.add(A13Attribute);

    m_XmlReport.addLine("КодСтр", Part1LineAttributes, "");
  end;

  macro EndPart1()
    m_XmlReport.finishPart(); //</Раздел1>
  end;

  macro BeginPart3()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    m_XmlReport.beginPart("Раздел3", attributes); //<Раздел3>
  end;

  macro PrintLinePart3(CodeStr:Integer, CountryCode:String, AllCount:Integer, PersnCount:Integer, OrgCount:Integer)
    var Part3LineAttributes = jvm.createJavaObject("java.util.ArrayList", "<init>");

    var D00Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодСтрР3", Delta_Fld(CodeStr));
    Part3LineAttributes.add(D00Attribute);
    if (CountryCode != "")
      var D01Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "ОКАТО", Delta_Fld(CountryCode));
      Part3LineAttributes.add(D01Attribute);
    end;
    var D02Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиентДогДепОбслВсего", Delta_Fld(AllCount));
    Part3LineAttributes.add(D02Attribute);
    var D03Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиентДогДепОбслФЛ", Delta_Fld(PersnCount));
    Part3LineAttributes.add(D03Attribute);
    var D04Attribute = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КолКлиентДогДепОбслЮЛ", Delta_Fld(OrgCount));
    Part3LineAttributes.add(D04Attribute);
  
    m_XmlReport.addLine("КодСтрР3", Part3LineAttributes, "");
  end;

  macro EndPart3()
    m_XmlReport.finishPart();
  end;

  macro EndData707()
    m_XmlReport.finishPart(); //</Данные707>
  end;

  macro NoData()
    var attributes = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrCode = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "КодНепредоставления", "1");

    attributes.add(attrCode);
    m_XmlReport.addLine("НетДанных", attributes, "");
  end;

  macro PrintProtocol()
    m_Protocol = m_XmlReport.getProtocol();
    var attributesNotes = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrStatusNotes = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "0");
    attributesNotes.add(attrStatusNotes);
    var attributesErrors = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrStatusErrors = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "1");
    attributesErrors.add(attrStatusErrors);
    var attributesFails = jvm.createJavaObject("java.util.ArrayList", "<init>");
    var attrStatusFails = jvm.createJavaObject("XMLReportExporter.XMLAttribute", "<init>", "Статус", "2");
    attributesFails.add(attrStatusFails);

    var Notes = m_Protocol.getNotesText();
    var Errors = m_Protocol.getErrorsText();
    var Fails = m_Protocol.getFailsText();

    if((Notes != "") or (Errors != "") or (Fails != ""))
      m_XmlReport.beginPart("ПротоколКонтроля");
      if(Notes != "")
        m_XmlReport.addLine("Сообщение", attributesNotes, Notes);
      end;
      if(Errors != "")
        m_XmlReport.addLine("Сообщение", attributesErrors, Errors);
      end;
      if(Fails != "")
        m_XmlReport.addLine("Сообщение", attributesFails, Fails);
      end;
      m_XmlReport.finishPart();
    end;
  end;

  macro GetFileName():String
    return m_FileName;
  end;

  macro CreateXMLFile()
    return m_xmlReport.export(m_FileName);
  end;

  var DepCodeQuery = "select dp_dep.t_Name " +
                     "from ddp_dep_dbt dp_dep " +
                     "where dp_dep.t_Code = " + string({OperDprt});

  var DepCodeSelect = DL_RSDCommand(DepCodeQuery);
  var DepCodeDS = DepCodeSelect.Execute();
  if(DepCodeDS.MoveNext())
     m_DepCode = DepCodeDS.Name;
  else
     m_DepCode = "";
  end;

  private var dd;
  private var mm;
  DateSplit(m_EndDate, dd, mm, NULL);

  var len = strlen(m_DepCode);

  var DepCode = m_DepCode;
  if(len < 4)
     var i = len;
     while(i < 4)
        DepCode = "0" + DepCode;
        i = i + 1;
     end;
  elif(len > 4)
     DepCode = SubStr(DepCode, 1, 4);
  end;

  m_FileName = "..\\TxtFile\\" + m_OKUD + "_" + string(dd:o:2) + string(mm:o:2) + DepCode + ".xml";

  jvm = createObject("rsjvm", "TJavaHost", "GlobalJavaHost");
  m_XmlReport = jvm.createJavaObject("XMLReportExporter.XMLReport", "<init>", "4.0.4.5", m_OKUD, m_OKUD, ReportKind, String(m_EndDate : f), Periodicity);
  m_Protocol = m_XmlReport.getProtocol();
END;

PRIVATE CLASS (DL_CReportTemplate) DlActivitiesInfo_Report707( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
  var m_BegDate, m_EndDate, m_IsSecur:bool, m_IsDV:bool, m_IsVA:bool, m_IsDepo:bool, m_DepNum = 0;

  private var SessionID = GetSessionID();

  private var m_IsApp;
  private var m_ClientData;


  private var ALL_CLIENTS_SUBREPORT = 0;
  private var ACTIVE_CLIENTS_SUBREPORT = 1;

  private var ALL_COUNT_CLIENTS_HEADER = "Всего клиентов: ";
  private var ACTIVE_CLIENTS_HEADER = "В том числе, активных: ";

  PRIVATE VAR m_IsDataExist = false; /*для Web, если нет данных, то ничего не показываем*/
  PRIVATE VAR m_InKliko = false;
  PRIVATE VAR m_InDelta = false;
  PRIVATE VAR m_DeltaReport;

  PRIVATE VAR kliko_file_name;

  PRIVATE VAR m_ProtocolTxt;

/****************************************** Функции экспорта в kliko ********************************************************/
  PRIVATE MACRO Kliko_InsertInTxtFile( Str:STRING ):BOOL

    if( insert( Kliko_F707, Str ) == false )
       MsgBox( "Ошибка при вставке записи в файл Kliko" );
       return false;
    end;
    return true;
  END;

  /* ДДММГГ_F116, где ДДММГГ - дата, по состоянию на которую выпускается отчет. Расширение файла - номер операциониста в сети.*/
  PRIVATE MACRO Kliko_TxtFileName( RepDate:DATE ):STRING
    var Day, Month, Year;
    datesplit( RepDate, Day, Month, Year );
    Year = SubStr( string(Year), strlen(string(Year))-1 );

    kliko_file_name = string(Day:2:o)+string(Month:2:o)+string(Year:2:o)+"_F707";
    return GetTxtFileName( kliko_file_name );
  END;

  PRIVATE MACRO Kliko_CloseTxtFile(fileview:bool)
    var Day, Month, Year, stat = -1;
    datesplit( m_EndDate+1, Day, Month, Year );
    var kliko_dir_dt_name = string(Day:2:o)+string(Month:2:o)+string(Year:4:o);
    kliko_dir_dt_name = "\\\\go.rshbank.ru\\dfsroot\\OTHER\\SOFR_for_ETL\\inbox\\export\\KLIKO\\0409707\\"+kliko_dir_dt_name;
    var kliko_file_name_term = kliko_dir_dt_name+"\\"+kliko_file_name+".dat";
    
    close( Kliko_F707 );
 
    stat = ExistDir(kliko_dir_dt_name);
     
    if(stat == 2)//нет директории
      if(not MakeDir(kliko_dir_dt_name))
        msgbox("Не могу создать директорию "+kliko_dir_dt_name);
      end;
    elif (stat == 1) //нет прав доступа
      msgbox("Нет прав на запись в директорию "+kliko_dir_dt_name);
    elif (stat == 0) //директория есть и права на запись есть
      
    end;

    if(ExistFile(kliko_file_name_term))
      RemoveFile(kliko_file_name_term);
    end;

    copyFile(FileName(Kliko_F707),kliko_file_name_term,true,"Копирование на терминал"); // Golovkin 28.06.2019
    
    if(fileview)
      ViewFile( Kliko_F707 );
    end;
  END;

  PRIVATE MACRO Kliko_TxtFileExt(filename:string)
    return SubStr(filename,1,Index(filename,"7.") + 1) + "dat";
  END;

  PRIVATE MACRO Kliko_OpenTxtFile( RepDate:DATE )
    VAR errcode, errtext;

    VAR fName = Kliko_TxtFileExt(Kliko_TxtFileName( RepDate ));

    if( not Open( Kliko_F707, fName, "rsoem" ) )
      errcode = status(errtext);
      msgbox( "Ошибка при открытии файла для экспорта в kliko|"+fName+"|(" + errcode + ") " + errtext );
      return false;
    end;

    return true;
  END;

  private macro ЧислоСЗаданнойТочностью( _var, _point:integer, _parm:string ) 
      var TmpStr:string;
      if( (valtype (_var) == V_DOUBLE) OR (valtype (_var) == V_MONEY) )
        if((valtype (_parm) == V_UNDEF) OR (_parm == ""))
          TmpStr = "String(_var:0" + ":" + string(_point) + ")";
        else
          TmpStr = "String(_var:0" + ":" + string(_point) + ":" + _parm + ")";
        end;
        return ExecExp(TmpStr);
      else
        return String(_var);
      end;
  end;

  PRIVATE MACRO Kliko_Fld( Val:VARIANT, _point:VARIANT ):STRING
    VAR ValStr = "";

    if( Val != NULL )
      VAR vt = ValType(Val);
      if( vt == V_DATE )
         if( Val == DATE(0,0,0) )
            ValStr = "";
         else
            ValStr = string(Val:f);
         end;
      elif( vt == V_STRING )
        if( Val != "0")
          ValStr = string(Val);
        else
          ValStr = "";
        end;
      elif( (vt == V_DOUBLE) OR (vt == V_MONEY) )
        if( Val != 0.00)
          //ValStr = trim(string(Val:18:5));
          if(_point != null)
             ValStr = ЧислоСЗаданнойТочностью(Val, _point); // Golovkin 10.05.2021 SD6630971
          else
             ValStr = ЧислоСЗаданнойТочностью(Val, 2);
          end;
        end;
      elif( vt == V_INTEGER )
        if( Val != 0)
          ValStr = string(Val);
        else
          ValStr = "0";
        end;
      else
         ValStr = string(Val);
      end;
    end;
    return "\""+ValStr+"\"";
  END;

/****************************************************************************************************************************/

  /* не показывать пустые отчет в Web*/
  MACRO CReport_DataExist()
    if(m_IsWebService == true )
      return (m_IsDataExist or ReportHasError() );
    else
      return true; /*в EW показываем листы всегда*/
    end;
  END;

  macro GetBegEndDateByPeriod():Date
     var NumQuartal, Month,
         Year = Form707.GetFieldValue(PNFLD_FORM707_YEAR),
         Period = Form707.GetFieldValue(PNFLD_FORM707_PERIOD);

     if(Period < 13)   /*Задан месяц*/
       m_BegDate = Date(1, Period, Year);
       m_EndDate = DateAfterCalenMonths(m_BegDate, 1) - 1;
     else                   /*Задан квартал*/
       NumQuartal = Period - 12;
       Month = (NumQuartal - 1) * 3 + 1;
       m_BegDate = Date(1, Month, Year);
       m_EndDate = DateAfterCalenMonths(m_BegDate, 3) - 1;
     end;
  end;

  PRIVATE MACRO PrintMode():INTEGER
    if(Form707.GetFieldValue( PNFLD_FORM707_EXCEL) == SET_CHAR )
      return DL_OUTREPORT_EXCEL;
    /*Текстовый вид пока не раелизуем
    elif (Form707.GetFieldValue( PNFLD_FORM707_STD) == SET_CHAR)
      return DL_OUTREPORT_STD;*/
    end;
  END;

  PRIVATE MACRO BeginReport( NumCopy:INTEGER )

    CreateTotalBook();
    GetBegEndDateByPeriod();
    m_IsSecur     = iif(Form707.GetFieldValue(PNFLD_FORM707_ISSECUR) == SET_CHAR,true,false);
    m_IsDV        = iif(Form707.GetFieldValue(PNFLD_FORM707_ISDV) == SET_CHAR,true,false);
    m_IsVA        = iif(Form707.GetFieldValue(PNFLD_FORM707_ISVA) == SET_CHAR,true,false);
    m_IsDepo      = iif(Form707.GetFieldValue(PNFLD_FORM707_ISDEPO) == SET_CHAR,true,false);
    m_IsApp       = iif(Form707.GetFieldValue(PNFLD_FORM707_APP) == SET_CHAR,true,false);
    m_InKliko     = iif(Form707.GetFieldValue(PNFLD_FORM707_KLIKO) == SET_CHAR,true,false);
    m_ProtocolTxt = iif(Form707.GetFieldValue(PNFLD_FORM707_PROTOCOL_TXT) == SET_CHAR,true,false);
    m_InDelta = iif(Form707.GetFieldValue(PNFLD_FORM707_DELTA) == SET_CHAR,true,false);

    //SetActiveSheet( "Отчет" );
    if(m_InDelta)
      m_DeltaReport = F707DeltaXML("0409707", "КО", m_EndDate, RCB_XML_PK_MONTHLY);
    end;

    SetActiveSheet( "Отчет" );
  END;

  MACRO PrintKlikoHead(header:STRING)
     if (m_InKliko)
       Kliko_InsertInTxtFile(String(header));
     end;
  END;

  MACRO PrintKlikoTitle(ReportChapter:Integer, StrName, X, _StCount:@INTEGER)
     
        private macro __insertLine(_StrName, _EmptyCount, _X, _Y)
          var i = 0;
     
          var s:string = Kliko_Fld( _StrName ) +",";
          while( i < _EmptyCount )
            s = s + Kliko_Fld( "" ) +",";
            i = i + 1;
          end;
          s = s + Kliko_Fld( _X ) +","+
                  Kliko_Fld( _Y ) +","+
                  Kliko_Fld( "" );
          return Kliko_InsertInTxtFile(s);
        end;

     if (m_InKliko)
       var StrCount = "";
       if (_StCount != null)
         StrCount = _StCount + 1;
         _StCount = StrCount;
       end;

       var EmptyCount;
       if ( (ReportChapter != null) and (ReportChapter == REPORT_FORM_CHAPTER_F707N_1) )
         EmptyCount = 14;
       else
         EmptyCount = 6;
       end;

       return __insertLine(StrName, EmptyCount, X, StrCount);
     end;
  END;

  MACRO PrintReportHead()
     var recOurBank = TRecHandler("party.dbt");
     ПолучитьСубъекта({OurBank}, recOurBank);

     PrintFormatString( "#",
                        "H1_ОКАТО",      GetOkatoCode(recOurBank, this.H1_ReportDate()),
                        "H1_ОКПО",       recOurBank.rec.OKPO,
                        "H1_РегНом",     ПолучитьКодСубъекта({OurBank}, PTCK_BANKREGNUM),
                        "H1_ЛицЦБ",      ПолучитьКодСубъекта({OurBank}, PTCK_ORCBLICENSE),
                        "H1_ДатаСРО",    DL_ДатаВключенияВСРО(),
                        "H1_НаимСРО",    DL_НаименованиеСРО(),
                        "H1_ReportDate", date_as_string(1, this.H1_ReportDate() + 1),
                        "H1_ShortName",  string(GetPartyShortNameByID({OurBank})),
                        "H1_Adress",     string(GetPartyAddress({OurBank}, false, false, PTADDR_REAL))
                      );
     if( m_InKliko )
//        Kliko_InsertInTxtFile(String("<F707_1>"));
     end;
  END;

  MACRO H1_ReportDate():date
     return m_EndDate;
  end;

  MACRO H1_EndWorkDate():date
     return iif(IsWorkDay(m_EndDate), m_EndDate, GetDateAfterWorkDays(m_EndDate, -1));
  end;

  MACRO PrintDepoOneTableHeader(Text)
    PrintFormatString( NULL, "N1_D_Subtitle", Text);
    CopyAllSheetInTotalBook("Отчет", false, "N1_D_Subtitle_1", 0, false);
  END;

  MACRO PrintOneTableHeader(Text)
    PrintFormatString( NULL, "N1_A_Subtitle", Text);
    CopyAllSheetInTotalBook("Отчет", false, "N1_A_Subtitle_1", 0, false);
  END;

  MACRO PrintDepoRepTableLine(CountryCode, PersnCount, OrgCount):BOOL
    if((PersnCount > 0) or (OrgCount > 0))
        PrintFormatString( NULL, "N1_D01", CountryCode,
                                 "N1_D02", PersnCount + OrgCount,
                                 "N1_D03", PersnCount,
                                 "N1_D04", OrgCount
                         );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable3", 0, "Отчет");
        return true;
    elif(CountryCode == "")
        PrintFormatString( NULL, "N1_D01", "",
                                 "N1_D02", "",
                                 "N1_D03", "",
                                 "N1_D04", ""
                         );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable3", 0, "Отчет");
        return true;
    else
        return false;
    end;
  END;

  MACRO PrintRepTableLine(CountryCode, ClientsCount, 
                          InAccPlus, SecurPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,
                          InAccMinus, SecurMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus):BOOL
    if(ClientsCount > 0)
        PrintFormatString(null,"N1_A01", CountryCode, 
                               "N1_A02", ClientsCount,
                               "N1_A03", InAccPlus,
                               "N1_A04", SecurPlus,
                               "N1_A05", RestMoneyPlus,
                               "N1_A06", RestSecurPlus,
                               "N1_A07", RestOtherPlus,
                               "N1_A08", InAccMinus,
                               "N1_A09", SecurMinus,
                               "N1_A10", RestMoneyMinus,
                               "N1_A11", RestSecurMinus,
                               "N1_A12", RestOtherMinus
                               );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable1", 0, "Отчет");
        return true;
    elif(CountryCode == "")
        PrintFormatString(null,"N1_A01", "", 
                               "N1_A02", "",
                               "N1_A03", "",
                               "N1_A04", "",
                               "N1_A05", "",
                               "N1_A06", "",
                               "N1_A07", "",
                               "N1_A08", "",
                               "N1_A09", "",
                               "N1_A10", "",
                               "N1_A11", "",
                               "N1_A12", ""
                               );
        CopyAllSheetInTotalBook("Отчет", false, "N1_MainTable1", 0, "Отчет");
        return true;
    else
        return false;
    end;
  END;

  PRIVATE MACRO GetDepoClients()
     return " Exists(select 1 "
            "          from ddepoacnt_dbt root, ddepoacnt_dbt part "+
            "         where root.t_Code = sfcontr.t_Object "+
            "           and part.t_Root = root.t_AutoKey "+
            "           and (Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_PayerAccount = part.t_BriefCode "+
            "                          and pmpaym.t_PayerBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN ? AND ? "+
            "                      ) "+
            "             or Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_ReceiverAccount = part.t_BriefCode "+
            "                          and pmpaym.t_ReceiverBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN ? AND ? "+
            "                      ) "+
            "               ) "+
            "       ) ";
  END;

  PRIVATE MACRO GetVAClientsFilled(DealDate1,DealDate2)
     return " exists(SELECT 1 " +
            "    FROM ddl_tick_dbt tick " +
            "   WHERE TICK.T_BOFFICEKIND = " + string(DL_VEKSELACCOUNTED) +
            "     AND tick.t_DealStatus > 0 " +
            "     AND tick.t_ClientContrID = sfcontr.t_ID" +
            "     AND tick.t_DealDate BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "     AND Tick.t_ClientID = t.t_partyID ) ";
  END;

  PRIVATE MACRO GetSecurClientsFilled(DealDate1,DealDate2)
     return " exists (SELECT 1 " +
            "         FROM ddl_tick_dbt tick " +
            "         WHERE TICK.T_BOFFICEKIND = " + string(DL_SECURITYDOC) +
            "         AND tick.t_DealStatus > 0 " +
            "         AND (Tick.t_ClientContrID = sfcontr.t_ID OR (Tick.t_PartyContrID = sfcontr.t_ID AND Tick.t_IsPartyClient = 'X')) " +
            "         AND tick.t_DealDate BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "         AND (Tick.t_ClientID = t.t_partyID OR (Tick.t_PartyID = t.t_partyID AND Tick.t_IsPartyClient = 'X'))) ";
  END;

  PRIVATE MACRO GetDVClientsFilled(DealDate1,DealDate2)
     return " (exists(SELECT 1 " +
            "         FROM DDVNDEAL_DBT dvndeal " +
            "         WHERE DVNDEAL.T_CLIENT = T.T_PARTYID " +
            "           AND DVNDEAL.T_DATE BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "           AND DVNDEAL.T_STATE > 0) " +
            "      OR " +
            " exists (SELECT 1 " +
            "         FROM DDVDEAL_DBT dvdeal" +
            "         WHERE DVDEAL.T_CLIENT = T.T_PARTYID " +
            "         AND DVDEAL.T_DATE BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" " +
            "         AND DVDEAL.T_STATE > 0)) ";
  END;

  PRIVATE MACRO GetDepoClientsFilled(DealDate1,DealDate2)
     return " Exists(select 1 "
            "          from ddepoacnt_dbt root, ddepoacnt_dbt part "+
            "         where root.t_Code = sfcontr.t_Object "+
            "           and part.t_Root = root.t_AutoKey "+
            "           and (Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_PayerAccount = part.t_BriefCode "+
            "                          and pmpaym.t_PayerBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" "+
            "                      ) "+
            "             or Exists(select 1 "+
            "                         from dpmpaym_dbt pmpaym, dspdrmove_dbt spdrmove, dspdraft_dbt spdraft "+
            "                        where pmpaym.t_ReceiverAccount = part.t_BriefCode "+
            "                          and pmpaym.t_ReceiverBankID = " + {OurBank} +
            "                          and spdrmove.t_PaymentID = pmpaym.t_PaymentID "+
            "                          and spdraft.t_AutoKey = spdrmove.t_DraftID "+
            "                          and spdraft.t_Date BETWEEN "+GetSQLDate(DealDate1)+" AND "+GetSQLDate(DealDate2)+" "+
            "                      ) "+
            "               ) "+
            "       ) ";
  END;

  PRIVATE MACRO GetCountResident(IsNotResident, LegalForm)
    var Query = "select COUNT(0) as t_Count from (select distinct t.t_PartyID  " +
                "  from dparty_dbt t, dclient_dbt cl " +
                " where t_LegalForm = " + string(LegalForm) + " and t_NotResident " + IIF(IsNotResident, "=", "<>") + " 'X'" +
                "   and t.t_PartyID <> " + string({OurBank}) +
                "   and cl.t_PartyID = t.t_PartyID " +
  IIF(m_IsDepo, "   and cl.t_ServiceKind = " + string(PTSK_DEPOS), "") +
                "   and exists(select 1" +
                "               from dsfcontr_dbt sfcontr" +
                "               where sfcontr.t_PartyID = t.t_PartyID" +
                "                 and (" +
                "                           (sfcontr.t_DateClose > ?" +
                "                               or" +
                "                           sfcontr.t_DateClose = ?)" +
                "                           and" +
                "                           sfcontr.t_DateBegin <= ?" +
                "                       )" +
  IIF(m_IsDepo, "                 and sfcontr.t_ServKind = " + string(PTSK_DEPOS), "") +
                "                 and sfcontr.t_Department = cl.t_Department)" +
                "   and cl.t_StartDate <= ?" +
                "   and (cl.t_FinishDate > ? or cl.t_FinishDate = ?))";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    var DS = Select.execute();
    DS.MoveNext();
    return DS.Count;
  END;

  PRIVATE MACRO GetRestInAccResidentVA(SubQueryForContrId)
    var totalCount = 0;
    var Query = "select RSI_RSB_FIInstr.ConvSum(rsi_rsb_account.RestAC(acdoc.t_account, acdoc.t_currency, ?, acdoc.t_chapter, 0)"+
                ", acdoc.t_currency, ?, ?, 0 ) as t_rest " +
                "  from ddl_tick_dbt t, dmcaccdoc_dbt acdoc " +
                " where acdoc.t_catnum = (select T_NUMBER from DMCCATEG_DBT where T_CODE = ?) "+
                "  and t.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")" +
                "   and acdoc.t_docid = t.t_dealid "+
                "   and acdoc.t_iscommon = CHR(0) "+
                "   and t.t_clientcontrid in " + SubQueryForContrId;
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(NATCUR);
    Select.AddParam(H1_ReportDate()-1);
    Select.AddParam("ДС Клиента, ВУ");
    var DS = Select.execute();
    while (DS.MoveNext())
      totalCount = (totalCount + ABS(DS.Rest / 1000));
    end;
    return Int(totalCount);
  END;

  PRIVATE MACRO GetSecurInAccResidentVA(SubQueryForContrId)
    var totalCount = 0,buf=0,pfi=0;
    var Query = "select t.t_Name as t_FiidName, t.T_FIID as t_fiid, t.t_facevaluefi as t_pfi, rsi_rsb_account.RestAC(acdoc.t_account, acdoc.t_currency, ?, acdoc.t_chapter, 0) as t_rest " +
                "  from dfininstr_dbt t, dmcaccdoc_dbt acdoc, dvsbanner_dbt bnr, ddl_leg_dbt leg " +
                " where bnr.t_contrid in " + SubQueryForContrId +
                "   and t.t_FIID = bnr.t_FIID and bnr.t_BCID = leg.t_DealId and leg.t_LegId = 0 and leg.t_LegKind = 1 " +
                "   and acdoc.t_catnum IN (select T_NUMBER from DMCCATEG_DBT where T_CODE IN (?,?,?)) "+
                "   and acdoc.t_dockind = " + string(DL_VSBANNER) +
                "   and acdoc.t_docid = bnr.T_BCID " +
                "   and acdoc.t_iscommon = CHR(0) ";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam("ЦБ Клиента, ВУ");
    Select.AddParam("НЦБ Клиента, ВУ");
    Select.AddParam("ФО Клиента, ВУ");
    var DS = Select.execute();
    while (DS.MoveNext())
      pfi = IIF(DS.PFI==-1,NATCUR,DS.PFI);
      if (ПолучитьКурсЗаданногоTипа( @buf, DS.Fiid, pfi, 1, H1_ReportDate(), false))
        buf = buf * ABS(DS.Rest);
        if (ConvSum (buf, money(buf), H1_ReportDate()-1, pfi, NATCUR, 0) != 0)
          buf = 0.0;
        end;
        totalCount = totalCount + (buf / 1000);
      else
        msgbox("Не определена рыночная стоимость ц/б "+DS.FiidName);
      end;
    end;
    return Int(totalCount);
  END;

  PRIVATE MACRO GetRestMoneyResidentVA(SubQueryForContrId)
    var totalCount = $0;
    var Query = "select (RSI_RSB_FIInstr.ConvSum(pm.t_baseamount, pm.t_basefiid, ?, ?, 0 ) * (CASE WHEN pm.t_receiver = t.t_ClientId THEN 1 ELSE -1 END)) as t_rest " +
                "  from ddl_tick_dbt t, dpmpaym_dbt pm " +
                " where t.t_clientcontrid in " +SubQueryForContrId+
                "   and t.t_dealstatus = " + string(DL_READIED) +
                "   and pm.t_dockind = t.t_bofficekind " +
                "   and pm.t_documentid = t.t_dealid " +
                "   and pm.t_paymstatus = " + string(PM_READIED) +
                "   and pm.T_PURPOSE in ("+string(CAi)+","+string(PM_PURP_VSBARTERDIFF)+","+string(PM_PURP_PRINC_RET)+","+string(PM_PURP_PERCENT)+") "+
                "   and t.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(NATCUR);
    Select.AddParam(H1_ReportDate()-1);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    var DS = Select.execute();
    while (DS.MoveNext())
      totalCount = totalCount + (DS.Rest / 1000);
    end;
    return Int(totalCount);
  END;

  PRIVATE MACRO GetRestSecurResidentVA(SubQueryForContrId)
    var totalCount = $0,buf=0,pfi=0;
    var Query = "select t.t_Name as t_FiidName, t.t_facevaluefi as t_pfi, pm.t_baseamount as t_baseamount, pm.t_basefiid as t_fiid, CASE WHEN pm.t_receiver = tick.t_ClientId THEN 1 ELSE -1 END as t_coef " +
                "  from dfininstr_dbt t, ddl_tick_dbt tick, dpmpaym_dbt pm " +
                " where tick.t_clientcontrid IN "+SubQueryForContrId+
                "   and pm.t_basefiid = t.t_FIID "+
                "   and tick.t_dealstatus = " + string(DL_READIED) +
                "   and pm.t_dockind = tick.t_bofficekind " +
                "   and pm.t_documentid = tick.t_dealid " +
                "   and pm.t_paymstatus = " + string(PM_READIED) +
                "   and pm.T_PURPOSE in ("+string(BAi)+") "+
                "   and tick.t_bofficekind in ("+string(DL_VEKSELACCOUNTED)+","+string(DL_VAREPAY)+","+string(DL_VAPAWN)+","+string(DL_VAENWR)+")";
    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    var DS = Select.execute();
    while (DS.MoveNext())
      pfi = IIF(DS.PFI==-1,NATCUR,DS.PFI);
      if (ПолучитьКурсЗаданногоTипа( @buf, DS.Fiid, pfi, 1, H1_ReportDate(), false))
        buf = buf * DS.BaseAmount * DS.Coef;
        if (ConvSum (buf, money(buf), H1_ReportDate()-1, pfi, NATCUR, 0) != 0)
          buf = 0.0;
        end;
        totalCount = totalCount + (buf / 1000);
      else
        msgbox("Не определена рыночная стоимость ц/б "+DS.FiidName);
      end;
    end;
    return Int(totalCount);
  END;

  MACRO PrintLineDecription(ClientCode, Client, ClientFull, A01, ResidenceStatus, RegisterType, Activity, QualifedInvestor, ContractNumber, ContractOpenDate, ContractCloseDate, Industry, Account, CrNom, A05, NumDEPO, SecQnty, MarketSecCost, A06, A07, A08, A09, Itog, RiskName)
/*    if (ContractCloseDate == null)
      ContractCloseDate = date(01,01,2000);
    end;*/

    PrintTableLine("N2_ClientCode", ClientCode, null, 
                   "N2_Client", Client, null, 
                   "N2_ClientFull", ClientFull, null, 
                   "N2_A01", string(A01), null, 
                   "N2_ResidenceStatus", IIF(ResidenceStatus == "X", "нерезидент", iif(ResidenceStatus != "", "резидент","")), null, 
                   "N2_RegisterType", IIF(RegisterType == "X", "физ.лицо", iif(RegisterType == "0", "юр.лицо","")), null, 
                   "N2_Activity", iif(Activity == "X", "Да", iif(Activity != "", "Нет","")), null, 
                   "N2_QualifiedInvestor", iif(QualifedInvestor == "X", "Да", iif(QualifedInvestor != "", "Нет","")), null, 
                   "N2_ContractNumber", ContractNumber, null, 
                   "N2_ContractOpenDate", ContractOpenDate, null, 
                   "N2_ContractCloseDate", iif(ContractCloseDate > date(01,01,2000), ContractCloseDate, ""), null, 
                   "N2_Industry", Industry, null, 
                   "N2_Account", Account, null, 
                   "N2_CrNom", iif(CrNom == 0, "", CrNom), null, 
                   //"N2_A05", iif(A05 == null, 0.0, money(A05)), 2,
                   "N2_A05", iif(A05 == null, 0.0, A05), 5, // Golovkin 2 -> 5
                   "N2_NumDEPO", "", null, 
                   "N2_SecQnty", "", null,
                   "N2_MarketSecCost", A06, null, 
                   "N2_A06", A06, null, 
                   "N2_A07", iif((Itog >= 0), A07, ""), null, 
                   "N2_A08", iif((Itog >= 0), A08, ""), null, 
                   "N2_A09", iif((Itog >= 0), A09, ""), null,
                   "N2_A10", iif((Itog >= 0), Itog, ""), null,
                   "N2_A11", RiskName, null,
                   "N2_A12", iif((Itog < 0), A07, ""), null,
                   "N2_A13", iif((Itog < 0), A08, ""), null,
                   "N2_A14", iif((Itog < 0), A09, ""), null,
                   "N2_A15", iif((Itog < 0), Itog, ""), null,
                   "N2_S0.", Itog, null);
  end;

  MACRO PrintLineAvoiriss(ClientCode, Client, A01, ContractNumber, AvrKind, AvrType, FI_Name, ISIN, SecQnty, Nominal, Fiid, MarketPrice, Rate, TotalCost)
    PrintTableLine("N3_ClientCode", ClientCode, null,
                   "N3_Client", Client, null,
                   "N3_A01", string(A01), null,
                   "N3_ContractNumber", ContractNumber, null,
                   "N3_KindAvr", AvrKind, null,
                   "N3_TypeAvr", AvrType, null,
                   "N3_FIName", FI_Name, null,
                   "N3_ISIN", ISIN, null,
                   "N3_SecQnty", SecQnty, null,
                   "N3_Nominal", Nominal, null,
                   "N3_FiID", ПолучитьКодФинИн(int(Fiid)), null,
                   "N3_MarketPrice", MarketPrice, null,
                   "N3_Rate", Rate, null,
                   "N3_TotalCost", TotalCost, null);
  END;

  private class DecrAcc(_ContractNumber, _ContractOpenDate, _ContractCloseDate, _Industry, _Account, _CrNom, _A05, _NumDEPO, _SecQnty, _MarketSecCost, _A06, _A07, _A08, _A09)
    var ContractNumber = _ContractNumber;
    var ContractOpenDate = _ContractOpenDate;
    var ContractCloseDate = _ContractCloseDate;
    var Industry = _Industry;
    var Account = _Account;
    var CrNom = _CrNom;
    var A05 = _A05;
    var NumDEPO = _NumDEPO;
    var SecQnty = _SecQnty;
    var MarketSecCost = _MarketSecCost;
    var A06 = _A06;
    var A07 = _A07;
    var A08 = _A08;
    var A09 = _A09;
  end;
/*
  MACRO PrintDecryptionTable()
    var q_main, cmd_main, rs_main, q_cl, cmd_cl, rs_cl, q, cmd, rs;
    var DS_ProgressIndicator = TProgressBar();
    var ServKind:string = "";
    var ok, cr = $0, i;
    var tmp_sum = 0; 

    q_main = "select T_CLIENTCODE, " +
             "       sum(Round(T_A5/1000,2)) total_a5, " +
             "       sum(Round(T_A6/1000,2)) total_a6, " +
             "       sum(Round(T_A7/1000,2)) total_a7, " +
             "       sum(Round(T_A8/1000,2)) total_a8, " +
             "       sum(Round(T_A9/1000,2)) total_a9, " +
             "       sum(Round(T_ITOG/1000,2)) total_itog " + 
             " from " + tmp_table + 
             " group by T_CLIENTCODE " +
             " order by T_CLIENTCODE ";  
    cmd_main = DL_RSDCommand(q_main);  

    var DS_Nrec = cmd_main.GetCount();
    DS_ProgressIndicator.init(DS_Nrec, "Печать листа расшифровок", "Печать листа расшифровок" );

    rs_main = cmd_main.execute();

    while( rs_main.MoveNext() )
       var IsTotalPlus = iif(rs_main.total_itog >= 0, true, false);

       q_cl = "select * from " + tmp_table + " where T_CLIENTCODE = ? ";
       cmd_cl = DL_RSDCommand(q_cl);
       cmd_cl.AddParam(rs_main.ClientCode);

       rs_cl = cmd_cl.execute();
  
       while( rs_cl.MoveNext() )
          dbg("Client " + rs_cl.T_CLIENT);
          // перебор счетов по договору 
          q = "SELECT * FROM D707ACC_DBT WHERE t_SessionID = ? AND t_ContrId = ? ";

          cmd = DL_RSDCommand(q);
          cmd.AddParam(SessionID);
          cmd.AddParam(int(rs_cl.ContrID));
          rs = cmd.execute();
          ok = rs.MoveNext;
          if (ok == false)
            msgbox("Счетов для ДО " + string(rs_cl.Number) + " не найдено");
          if(rs_cl.INDUSTRY == PTSK_STOCKDL)
             ServKind = iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок");
          elif(rs_cl.INDUSTRY == PTSK_VEKSACC)
               ServKind = "Учтенные векселя";  
            else
               ServKind = iif(rs_cl.INDUSTRY == PTSK_DV, "Срочный рынок", "Валютный рынок");
            end;
            //выведем строку без счетов
            PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, SQL_ConvTypeDate(rs_cl.DATEBEGIN), SQL_ConvTypeDate(rs_cl.DATECLOSE), ServKind, "", "", "", "", "", Round(rs_cl.A6/ 1000, 2), Round(rs_cl.A6/ 1000, 2), Round(rs_cl.A7/ 1000, 2), Round(rs_cl.A8/ 1000, 2), Round(rs_cl.A9/ 1000, 2), Round(rs_cl.Itog/ 1000, 2), GetRiskName(rs_cl.RiskLevel), IsTotalPlus);
          else
            i = 1;
            while(ok)
             /*tmp_sum = 0;
              if (Int(rs.cur) != NATCUR)
                cr = GetRateOnDateCrossDbl(H1_ReportDate(), int(rs.cur), NATCUR, true);
                tmp_sum = cr * rs.sum;
              else
                tmp_sum = rs.sum;
                cr = $1;
              end;
              tmp_sum = Round(tmp_sum/ 1000, 2);*/
              if(i == 1)
                if(rs_cl.INDUSTRY == PTSK_STOCKDL)
                   ServKind = iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок");
                elif(rs_cl.INDUSTRY == PTSK_VEKSACC)
                   ServKind = "Учтенные векселя";  
                else
                   ServKind = iif(rs_cl.INDUSTRY == PTSK_DV, "Срочный рынок", "Валютный рынок");
                end;
                PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, SQL_ConvTypeDate(rs_cl.DATEBEGIN), SQL_ConvTypeDate(rs_cl.DATECLOSE), ServKind, rs.account, double(rs.cr), round(rs.rest/1000, 5), "", "", Round(rs_cl.A6/ 1000, 2), Round(rs_cl.A6/ 1000, 2), Round(rs_cl.A7/ 1000, 2), Round(rs_cl.A8/ 1000, 2), Round(rs_cl.A9/ 1000, 2), Round(rs_cl.Itog/ 1000, 2), GetRiskName(rs_cl.RiskLevel), IsTotalPlus);
              else
                PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, SQL_ConvTypeDate(rs_cl.DATEBEGIN), SQL_ConvTypeDate(rs_cl.DATECLOSE), "", rs.account, double(rs.cr), round(rs.rest/1000, 5), "", "", "", "", "", "", "", "", GetRiskName(rs_cl.RiskLevel), IsTotalPlus);
              end;
              ok = rs.MoveNext;
              i = i + 1;                        
            end;
          end;
        end;

        SetCurrentLineFont( 10, true, false, null, null, GREYCOLOR );
        PrintLineDecription( "", "", "", "", "", "", "", "", "", "", "", "", "", "", rs_main.total_a5, "", "", "", rs_main.total_a6, rs_main.total_a7, rs_main.total_a8, rs_main.total_a9, rs_main.total_itog, "", IsTotalPlus );
        SetCurrentLineFont( 10, false, false, null, null, DefaultBkGrColor );

        DS_ProgressIndicator.Use;
     end;
     DS_ProgressIndicator.Remove;
  END;
*/

  macro CheckPartyType( PartyId, PartyType )
    var partyown = TBFile("partyown");
    var isPartyType = false;

    partyown.KeyNum = 0;
    partyown.rec.PartyID   = PartyId;
    partyown.rec.PartyKind = PartyType;
    if (GetEQ(partyown))
      isPartyType = true;
    end;

    return isPartyType;
  end;

  macro GetCountryCode(PartyCode):string
    var q = "select t_codenum3 code from dcountry_dbt where t_CodeLat3 = ? ";
    var cmd = DL_RSDCommand(q);
    cmd.AddParam(PartyCode);
    var rs = cmd.execute();

    if (rs.MoveNext())
      return string(rs.code);
    end;

    return "999";
  end;

  PRIVATE CLASS Cals_Sums(H1_ReportDate, p_IsSecur, p_IsDV, p_IsVA, p_IsDepo, num, LegalForm, CodeCountry, IsQualified, IsActive, State, BegDate, EndDate, DealDate1, DealDate2, H1_EndWorkDate, ProtocolTxt, p_InDelta:BOOL, p_DeltaReport)
    var SessionID = GetSessionID();

    VAR m_IsSecur = p_IsSecur;
    VAR m_IsDV = p_IsDV;
    VAR m_IsVA = p_IsVA;
    VAR m_IsDepo = p_IsDepo;
    VAR m_InDelta = p_InDelta;
    VAR m_DeltaReport = p_DeltaReport;
    VAR m_IsDataExist = false;

    VAR m_ProtocolTxt = ProtocolTxt;

    //Перечисление подразделов таблицы 1, используется для удобства и оптимизации кода
    PRIVATE CONST SUBSECTION_ALL    = 1,  
                  SUBSECTION_FL     = 2,
                  SUBSECTION_UL     = 3,
                  SUBSECTION_KI     = 4,
                  SUBSECTION_ACTIVE = 5,
                  SUBSECTION_RISK   = 6;

    //Перечисление подразделов раздела 1 для выгрузки в Delta
    PRIVATE CONST SUBSECTION_DELTA_ALL            = 1, //Всего
                  SUBSECTION_DELTA_FL_RES         = 2, //Физические лица-резиденты
                  SUBSECTION_DELTA_FL_RES_SUB     = 3, //В том числе по субъектам
                  SUBSECTION_DELTA_FL_NOT_RES     = 4, //Физические лица-нерезиденты
                  SUBSECTION_DELTA_FL_NOT_RES_CON = 5, //В том числе по странам
                  SUBSECTION_DELTA_UL_RES         = 6, //Юридические лица-резиденты
                  SUBSECTION_DELTA_UL_RES_SUB     = 7, //В том числе по субъектам
                  SUBSECTION_DELTA_UL_NOT_RES     = 8, //Юридические лица-нерезиденты
                  SUBSECTION_DELTA_UL_NOT_RES_CON = 9, //В том числе по странам
                  SUBSECTION_DELTA_KI             = 10, //Клиенты, являющиеся квалифицированными инвесторами
                  SUBSECTION_DELTA_ACTIVE         = 11, //Активные клиенты
                  SUBSECTION_DELTA_USUAL_RISK     = 12, //Клиенты со стандартным уровнем риска
                  SUBSECTION_DELTA_ELEVATED_RISK  = 13, //Клиенты с повышенным уровнем риска
                  SUBSECTION_DELTA_SPECIAL_RISK   = 14, //Клиенты с особым уровнем риска
                  SUBSECTION_DELTA_NOTINSTALL_RISK= 15; //Клиенты без установленного уровня риска

    private macro PrintSubsectionTable_1( SubTitle, SubSection, IsNotResident, RiskLevel, StCount:@integer, PrCount:@integer )
      var q, cmd, rs, q1, cmd1, rs1, _q;
      var q0, cmd0, rs0, nr, c29, c45, c61, c89, c92, cc;
      const ReportChapter = REPORT_FORM_CHAPTER_F707N_1;
      var IsNotEmpty = false;
      var SubSectionDelta;

      dbg(SubTitle);
      Report707.PrintOneTableHeader(SubTitle + ":");
      Report707.PrintKlikoTitle(ReportChapter, SubTitle + ":", "1", @StCount);

      if( this.m_IsSecur or this.m_IsDV or this.m_IsVA )
        if( (SubSection == SUBSECTION_FL) or (SubSection == SUBSECTION_UL) )
          q = "select nvl(sum(sub_cnt), 0) cnt, " + 
              "       sum(round(a5_pl/1000,0)) a5_plus, " + 
              "       sum(round(a6_pl/1000,2)) a6_plus, " + 
              "       sum(round(a7_pl/1000,2)) a7_plus, " + 
              "       sum(round(a8_pl/1000,2)) a8_plus, " + 
              "       sum(round(a9_pl/1000,2)) a9_plus, " + 
              "       sum(round(a5_min/1000,0)) a5_minus, " + 
              "       sum(round(a6_min/1000,2)) a6_minus, " + 
              "       sum(round(a7_min/1000,2)) a7_minus, " + 
              "       sum(round(a8_min/1000,2)) a8_minus, " + 
              "       sum(round(a9_min/1000,2)) a9_minus " + 
              "  from ( select T_COUNTRY, count(T_CLIENTCODE) sub_cnt, " + 
              "                sum(case when itog >= 0 then a5 else 0 end) a5_pl, " + 
              "                sum(case when itog >= 0 then a6 else 0 end) a6_pl, " +
              "                sum(case when itog >= 0 then a7 else 0 end) a7_pl, " +   
              "                sum(case when itog >= 0 then a8 else 0 end) a8_pl, " +   
              "                sum(case when itog >= 0 then a9 else 0 end) a9_pl, " +
              "                sum(case when itog < 0 then a5 else 0 end) a5_min, " + 
              "                sum(case when itog < 0 then a6 else 0 end) a6_min, " +
              "                sum(case when itog < 0 then a7 else 0 end) a7_min, " +   
              "                sum(case when itog < 0 then a8 else 0 end) a8_min, " +   
              "                sum(case when itog < 0 then a9 else 0 end) a9_min " + 
              "           from ( select d.T_COUNTRY, ds.T_CLIENTCODE, " +
              "                         NVL(sum(d.T_A5), 0) a5, " +
              "                         NVL(sum(d.T_A6), 0) a6, " +
              "                         NVL(sum(d.T_A7), 0) a7, " +
              "                         NVL(sum(d.T_A8), 0) a8, " +
              "                         NVL(sum(d.T_A9), 0) a9, " + 
              "                         NVL(sum(d.T_ITOG), 0) itog " +
              "                    from daidecr_dbt d, d707ds_dbt ds "
              "                   where d.T_SESSIONID = " + string(SessionID) +
              "                     and ds.T_SESSIONID = d.T_SESSIONID " +
              "                     and ds.T_ID = d.T_CONTRID "
              "                     and ds.T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + 
              "                     and ds.T_FL " + IIF(SubSection == SUBSECTION_FL, " = 'X' ", " != 'X' ") + 
              "                   group by ds.T_CLIENTCODE, d.T_COUNTRY ) " +
              "     group by T_COUNTRY )";     
        else
          q = "select count(T_CLIENTCODE) cnt, " + 
              "       round(sum(case when itog >= 0 then a5 else 0 end)/1000, 0) a5_plus, " + 
              "       round(sum(case when itog >= 0 then a6 else 0 end)/1000, 2) a6_plus, " +
              "       round(sum(case when itog >= 0 then a7 else 0 end)/1000, 2) a7_plus, " +   
              "       round(sum(case when itog >= 0 then a8 else 0 end)/1000, 2) a8_plus, " +   
              "       round(sum(case when itog >= 0 then a9 else 0 end)/1000, 2) a9_plus, " +
              "       round(sum(case when itog < 0 then a5 else 0 end)/1000, 0) a5_minus, " + 
              "       round(sum(case when itog < 0 then a6 else 0 end)/1000, 2) a6_minus, " +
              "       round(sum(case when itog < 0 then a7 else 0 end)/1000, 2) a7_minus, " +   
              "       round(sum(case when itog < 0 then a8 else 0 end)/1000, 2) a8_minus, " +   
              "       round(sum(case when itog < 0 then a9 else 0 end)/1000, 2) a9_minus " + 
              "  from ( select ds.T_CLIENTCODE, " +
              "                NVL(sum(d.T_A5), 0) a5, " +
              "                NVL(sum(d.T_A6), 0) a6, " +
              "                NVL(sum(d.T_A7), 0) a7, " +
              "                NVL(sum(d.T_A8), 0) a8, " +
              "                NVL(sum(d.T_A9), 0) a9, " + 
              "                NVL(sum(d.T_ITOG), 0) itog " +
              "           from daidecr_dbt d, d707ds_dbt ds " +
              "          where d.T_SESSIONID = " + string(SessionID) +
              "            and ds.T_SESSIONID = d.t_SESSIONID " +
              "            and ds.T_ID = d.t_CONTRID ";

          if( SubSection == SUBSECTION_KI )
            q = q + " and ds.T_KI = 'X' ";
          elif( SubSection == SUBSECTION_ACTIVE )
            q = q + " and ds.T_ACTIVE = 'X' ";
          elif( SubSection == SUBSECTION_RISK )
            q = q + " and ds.T_RISKLEVEL = " + RiskLevel;
          end;
          q = q + " group by ds.T_CLIENTCODE ) " ; //Обязательная группировка вконце
        end;
     

        cmd = DL_RSDCommand(q);
        rs = cmd.execute();
        dbg(q);

        // Golovkin 17.09.2020 Адаптация 4927у
        nr = 0; c29 = 0; c45 = 0; c61 = 0; c89 = 0; c92 = 0; cc = 0;
        if( not (SubSection == SUBSECTION_UL))
           _q = " select count(1) cnt " +
                "   from (select ds.T_PARTY " +
                "           from daidecr_dbt t, d707ds_dbt ds " +
                "          where t.t_SessionID = " + string(SessionID) + 
                "            and ds.t_SessionID = t.t_SessionID " +
                "            and ds.t_id = t.t_ContrID " +
                "            and ds.T_NOTRESIDENT " + iif(IsNotResident, " = 'X' ", " != 'X' ") + 
                "            and ds.T_FL = 'X' "+
                iif(SubSection == SUBSECTION_ACTIVE,"and ds.T_ACTIVE = 'X'","")+" "+
                iif(SubSection == SUBSECTION_KI,"and ds.T_KI = 'X'","")+" "+
                iif(SubSection == SUBSECTION_RISK,"and ds.T_RISKLEVEL = " + RiskLevel,"")+
                "           group by ds.T_PARTY) ";

           q0 = _q + " where t_party in (115148, 127823)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c45 = c45 + 1; end;
           q0 = _q + " where t_party in (115856, 127824)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c92 = c92 + 1;  end;
           q0 = _q + " where t_party in (116478, 127825)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c92 = c92 + 1; end;
           q0 = _q + " where t_party in (119746, 127826)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c89 = c89 + 1; end;
           q0 = _q + " where t_party in (118520, 127827)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c89 = c89 + 1; end;
           q0 = _q + " where t_party in (118993, 127837)";
           cmd0 = DL_RSDCommand(q0); rs0 = cmd0.execute(); rs0.MoveNext(); if (rs0.cnt == 2) nr = nr + 1; c29 = c29 + 1; end;
        end;

        if( rs.MoveNext() and (rs.cnt > 0) )           
          cc = rs.cnt - nr; // Golovkin 17.09.2020 Адаптация 4927у
          Report707.PrintRepTableLine("", cc, //rs.cnt, // Golovkin 17.09.2020 Адаптация 4927у
                                      rs.a5_plus, rs.a6_plus, rs.a7_plus, rs.a8_plus, rs.a9_plus, 
                                      rs.a5_minus, rs.a6_minus, rs.a7_minus, rs.a8_minus, rs.a9_minus);

          Report707.PrintKlikoValLine("", "", cc/*rs.cnt*/,
                                      rs.a5_plus, rs.a6_plus, rs.a7_plus, rs.a8_plus, rs.a9_plus, 
                                      rs.a5_minus, rs.a6_minus, rs.a7_minus, rs.a8_minus, rs.a9_minus,
                                      "1", @StCount, @PrCount, false);

          if(m_InDelta)
            if(SubSection == SUBSECTION_ALL)
              m_DeltaReport.BeginData707(true);
              m_DeltaReport.BeginPart1();
              SubSectionDelta = SUBSECTION_DELTA_ALL;
            elif(SubSection == SUBSECTION_FL)
              SubSectionDelta = IIF(IsNotResident, SUBSECTION_DELTA_FL_NOT_RES, SUBSECTION_DELTA_FL_RES);
            elif(SubSection == SUBSECTION_UL)
              SubSectionDelta = IIF(IsNotResident, SUBSECTION_DELTA_UL_NOT_RES, SUBSECTION_DELTA_UL_RES);
            elif(SubSection == SUBSECTION_KI)
              SubSectionDelta = SUBSECTION_DELTA_KI;
            elif(SubSection == SUBSECTION_ACTIVE)
              SubSectionDelta = SUBSECTION_DELTA_ACTIVE;
            elif(SubSection == SUBSECTION_RISK)
              if(RiskLevel == RISKLEVEL_USUAL)
                SubSectionDelta = SUBSECTION_DELTA_USUAL_RISK;
              elif(RiskLevel == RISKLEVEL_ELEVATED)
                SubSectionDelta = SUBSECTION_DELTA_ELEVATED_RISK;
              elif(RiskLevel == RISKLEVEL_SPECIAL)
                SubSectionDelta = SUBSECTION_DELTA_SPECIAL_RISK;
              elif(RiskLevel == RISKLEVEL_NOTINSTALL)
                SubSectionDelta = SUBSECTION_DELTA_NOTINSTALL_RISK;
              end;
            end;

            m_DeltaReport.PrintLinePart1(SubSectionDelta, "", rs.cnt, rs.a5_plus, rs.a6_plus, rs.a7_plus, rs.a8_plus,
                                         rs.a9_plus, rs.a5_minus, rs.a6_minus, rs.a7_minus, rs.a8_minus, rs.a9_minus);

          end;
          IsNotEmpty = true;
          m_IsDataExist = true;
        else
          if(m_InDelta)
            if(SubSection == SUBSECTION_ALL)
              m_DeltaReport.BeginData707(false);
            end;
          end;
        end;
      end;
      if( IsNotEmpty == false )
          Report707.PrintRepTableLine("", 0);
          Report707.PrintKlikoValLine("", "", "", // EMPTY LINE
                                      "", "", "", "", "", 
                                      "", "", "", "", "", 
                                      "1", @StCount, @PrCount, false);
      end;

      if( (SubSection == SUBSECTION_FL) or (SubSection == SUBSECTION_UL) )
        dbg(IIF(IsNotResident, "В том числе по странам", "В том числе по субъектам"));
        Report707.PrintOneTableHeader(IIF(IsNotResident, "В том числе по странам:", "В том числе по субъектам:"));
         Report707.PrintKlikoTitle(ReportChapter,IIF(IsNotResident, "в том числе по странам:", "в том числе по субъектам:"), "1", @StCount);
  
         if( IsNotEmpty )  
            q1 = "select T_COUNTRY, count(T_CLIENTCODE) cnt, " + 
                 "       round(sum(case when itog >= 0 then a5 else 0 end)/1000, 0) a5_plus, " + 
                 "       round(sum(case when itog >= 0 then a6 else 0 end)/1000, 2) a6_plus, " +
                 "       round(sum(case when itog >= 0 then a7 else 0 end)/1000, 2) a7_plus, " +   
                 "       round(sum(case when itog >= 0 then a8 else 0 end)/1000, 2) a8_plus, " +   
                 "       round(sum(case when itog >= 0 then a9 else 0 end)/1000, 2) a9_plus, " +
                 "       round(sum(case when itog < 0 then a5 else 0 end)/1000, 0) a5_minus, " + 
                 "       round(sum(case when itog < 0 then a6 else 0 end)/1000, 2) a6_minus, " +
                 "       round(sum(case when itog < 0 then a7 else 0 end)/1000, 2) a7_minus, " +   
                 "       round(sum(case when itog < 0 then a8 else 0 end)/1000, 2) a8_minus, " +   
                 "       round(sum(case when itog < 0 then a9 else 0 end)/1000, 2) a9_minus " + 
                 "  from ( select d.T_COUNTRY, ds.T_CLIENTCODE, " +
                 "                NVL(sum(d.T_A5), 0) a5, " +
                 "                NVL(sum(d.T_A6), 0) a6, " +
                 "                NVL(sum(d.T_A7), 0) a7, " +
                 "                NVL(sum(d.T_A8), 0) a8, " +
                 "                NVL(sum(d.T_A9), 0) a9, " + 
                 "                NVL(sum(d.T_ITOG), 0) itog " +
                 "           from daidecr_dbt d, d707ds_dbt ds "
                 "          where d.T_SESSIONID = " + string(SessionID) +
                 "            and ds.t_SessionID = d.t_SessionID " +
                 "            and ds.t_id = d.t_ContrID " +
                 "            and ds.T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + 
                 "            and ds.T_FL " + IIF(SubSection == SUBSECTION_FL, " = 'X' ", " != 'X' ") + 
                 "          group by ds.T_CLIENTCODE, d.T_COUNTRY ) " +
                 " group by T_COUNTRY order by T_COUNTRY asc";     

            cmd1 = DL_RSDCommand(q1);
            rs1 = cmd1.execute();
            dbg(q1);

            var CountCountry = 0;
            while( rs1.MoveNext() )
              dbg("Country: " + string(rs1.t_country));
              
              // Golovkin 17.09.2020 Адаптация 4927у
              if (rs1.t_country == "29") cc = rs1.cnt - c29;
              elif (rs1.t_country == "45") cc = rs1.cnt - c45;
              elif (rs1.t_country == "61") cc = rs1.cnt - c61;
              elif (rs1.t_country == "89") cc = rs1.cnt - c89;
              elif (rs1.t_country == "92") cc = rs1.cnt - c92;
              else  cc = rs1.cnt; end;

              Report707.PrintRepTableLine(rs1.t_country, cc, //rs1.cnt, // Golovkin 17.09.2020 Адаптация 4927у
                                          rs1.a5_plus, rs1.a6_plus, rs1.a7_plus, rs1.a8_plus, rs1.a9_plus, 
                                          rs1.a5_minus, rs1.a6_minus, rs1.a7_minus, rs1.a8_minus, rs1.a9_minus);

              Report707.PrintKlikoValLine(IIF(IsNotResident,"",rs1.t_country), IIF(IsNotResident,rs1.t_country,""), cc/*rs.cnt*/,   
                                          rs1.a5_plus, rs1.a6_plus, rs1.a7_plus, rs1.a8_plus, rs1.a9_plus, 
                                          rs1.a5_minus, rs1.a6_minus, rs1.a7_minus, rs1.a8_minus, rs1.a9_minus,
                                          "1", @StCount, @PrCount, (CountCountry > 0));

              if(m_InDelta)
                if(SubSection == SUBSECTION_FL)
                  SubSectionDelta = IIF(IsNotResident, SUBSECTION_DELTA_FL_NOT_RES_CON, SUBSECTION_DELTA_FL_RES_SUB);
                elif(SubSection == SUBSECTION_UL)
                  SubSectionDelta = IIF(IsNotResident, SUBSECTION_DELTA_UL_NOT_RES_CON, SUBSECTION_DELTA_UL_RES_SUB);
                end;

                m_DeltaReport.PrintLinePart1(SubSectionDelta, rs1.t_country, rs1.cnt, rs1.a5_plus, rs1.a6_plus, rs1.a7_plus, rs1.a8_plus,
                                             rs1.a9_plus, rs1.a5_minus, rs1.a6_minus, rs1.a7_minus, rs1.a8_minus, rs1.a9_minus);
              end;

              CountCountry = CountCountry + 1;
            end;
         else
            Report707.PrintRepTableLine("", 0);
            Report707.PrintKlikoValLine("", "", "", // EMPTY LINE
                                        "", "", "", "", "", 
                                        "", "", "", "", "", 
                                        "1", @StCount, @PrCount, false);
        end;
      end;

      return PrCount;
    end;

    private macro PrintTable_1()
      var StCount = 0; //сквозная нумерация строк данных для kliko
      var PrCount = 0; //сквозная нумерация пунктов для kliko
      var DS_ProgressIndicator = TProgressBar();
      var DS_Nrec = 11;
      DS_ProgressIndicator.init(DS_Nrec, "Печать сведений о брокерской деятельности", "Печать сведений о брокерской деятельности" );

      PrintSubsectionTable_1("Всего", SUBSECTION_ALL, NULL, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Физические лица - резиденты", SUBSECTION_FL, false, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Физические лица - нерезиденты", SUBSECTION_FL, true, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Юридические лица - резиденты", SUBSECTION_UL, false, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Юридические лица - нерезиденты", SUBSECTION_UL, true, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты, являющиеся квалифицированными инвесторами", SUBSECTION_KI, NULL, NULL, @StCount, @PrCount); 
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Активные клиенты", SUBSECTION_ACTIVE, NULL, NULL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты со стандартным уровнем риска", SUBSECTION_RISK, NULL, RISKLEVEL_USUAL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты с повышенным уровнем риска", SUBSECTION_RISK, NULL, RISKLEVEL_ELEVATED, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты с особым уровнем риска", SUBSECTION_RISK, NULL, RISKLEVEL_SPECIAL, @StCount, @PrCount);
      DS_ProgressIndicator.Use;
      PrintSubsectionTable_1("Клиенты без установленного уровня риска", SUBSECTION_RISK, NULL, RISKLEVEL_NOTINSTALL, @StCount, @PrCount);
      DS_ProgressIndicator.Remove; 

      if(m_InDelta and m_IsDataExist)
        m_DeltaReport.EndPart1();
      end;
    end;

    private macro SaveDecriptionInCSV()
      macro CreateDirName()
        var cd = GetCurDir(false), txtdir = GetSysDir(0), i = StrLen(cd);

        if(index(txtdir,"..\\") == 1)
          while((i > 0) and (substr(cd,i,1) != "\\"))
            i = i - 1;
          end;
          cd = substr(cd,1,i-1);
          txtdir = substr(txtdir, 4);
        end;

        return cd + "\\" + txtdir + "\\Report_ActivitiesInfo" + date()+ "_" + StrSubst(string(time()), ":", ".") + "_Расшифровка";
      end;

      file f() txt write;

      var cmd, rs;
      var ProgressIndicator = TProgressBar();
      var DecrDir = CreateDirName();
      var FilesCount = -1, fname;
      
      ProgressIndicator.Init(1, "Формирование файлов для листа \"Расшифровка\"", "Формирование файлов для листа \"Расшифровка\"");

      cmd = RsdCommand("BEGIN ? := RSB_DLAIREP.CreateDecrTableDataCSV(?); END;");
      cmd.AddParam("p_out", RSDBP_OUT, V_INTEGER);
      cmd.AddParam("", RSDBP_IN, SessionID);
      cmd.Execute();

      ProgressIndicator.Use;
      ProgressIndicator.Remove;

      FilesCount = cmd.value("p_out");

      if (FilesCount > 0)
        MakeDir(DecrDir);

        ProgressIndicator.Init(FilesCount, "Сохранение файлов", "Сохранение файлов");

        for(var fnum, 1, FilesCount)

          fname = MergeFile(DecrDir, string(fnum), "csv");
          open(f, fname);

          cmd = RsdCommand("SELECT DBMS_LOB.SUBSTR (t_data, LEAST (" + MAXSTRLEN + ", LENGTH (t_data) - (LEVEL - 1) * " + MAXSTRLEN + "), (LEVEL - 1) * " + MAXSTRLEN + " + 1) t_data "
                           "  FROM (SELECT RSB_DLAIREP.GetDecrTableDataCSV(?) t_data FROM DUAL) "
                           "CONNECT BY (LEVEL - 1) * " + MAXSTRLEN + " < LENGTH (t_data) "
                           "  ORDER BY LEVEL ");
          cmd.AddParam("", RSDBP_IN, fnum);
          cmd.Execute();

          rs = RsdRecordSet(cmd);

          while (rs.MoveNext())
            insert(f, ToANSI(rs.value("t_data"), true), strlen(rs.value("t_data")));
          end;

          close(f);
          msgbox("Сформирован файл расшифровок "+ fname);
          ProgressIndicator.Use;
          fnum = fnum + 1;
        end;
        ProgressIndicator.Remove;
      end;

      execSQL("BEGIN RSB_DLAIREP.ClearDecrTableDataCSV(); END;");
    end;

    private macro PrintMessages()
      var query, cmd, ds, protocol_fname, prev_output;

      if (m_ProtocolTxt)
        protocol_fname = GetSysDir(0) + "\\protocol_" + GetExlusiveFileName("out");
        msgbox("Протокол сохранен в файл " + protocol_fname);
        prev_output = SetOutput(protocol_fname);
        ReplaceMacro("msgbox", "println");
      end;

      query = " SELECT DISTINCT t_Message "
              "   FROM darnureperr_dbt    "
              "  WHERE t_SessionID = ?    ";
     
      cmd = DL_RSDCommand(query);
      cmd.AddParam(SessionID);

      ds = cmd.execute();

      WHILE (ds.MoveNext())
        msgbox(ds.Message);
      END;

      execSQL("DELETE FROM darnureperr_dbt WHERE t_SessionID = " + SessionID);
      execSQL("COMMIT");

      if (m_ProtocolTxt)
        ReplaceMacro(msgbox, NULL);
        SetOutput(prev_output);
      end;
    END;


    VAR Query;
    var ClientCode, Client, ClientFull, A01, ResidenceStatus, RegisterType, Activity, QualifedInvestor, ContractNumber, ContractOpenDate, ContractCloseDate, Industry, Account, CrNom, A05, NumDEPO, SecQnty, MarketSecCost, A06, A07, A08, A09;
    var money_sum = 0;
    var avr_sum = 0;
    var tmp_sum = 0;
    var nkd_sum = 0;
    var f7_secur_sum = 0;
    var f7_dv_sum = 0;
    var f8 = 0;
    var f8_secur_sum = 0;
    var f8_dv_sum = 0;
    var f9 = 0;
    var f9_secur_sum = 0;
    var f9_dv_sum = 0;
    var Select;
    var SQL_DML;
    var find, CourceSinceDate, rate, market_price, pfi;
    var vn, q_amount, cmd_amount, rs_amount, pos_amount = $0.0, NRec = 0;
    var cf_price, mf_price, fw_price, fw_ba_price, op_price, op_ba_price, other_price, q_other, cmd_other, rs_other;
    var RS_ProgressIndicator = TProgressBar();
    var da = TArray;
    var da_num = 0;
    var q_acc, cmd_acc, rs_acc;
    var q_cntr, cmd_cntr, rs_cntr;
    var q_cl, cmd_cl, rs_cl;
    var avr_q, avr_cmd, avr_rs;
    var A5 = $0.0, A6 = $0.0, A7 = $0.0, A8 = $0.0, A9 = $0.0, Itog = $0.0;
    var ok, cr = $0, i;
   
    var Ar_acc = TArray; /*GAA*/
    var ar_Party, ar_size; /*GAA*/

if (not DEBUG_NO_CALC)

    /***********************************************************************************************/
    Query = "select ? as t_SessionID, t.t_partyid as party, t.t_shortname sname, t.t_name name, case when Rsb_Secur.DL_GetNotResidentForBrokClientRep(t.t_partyid, ?) = 'X' then 'X' else '0' end rsdnt, case when t.t_LegalForm != 1 then 'X' else '0' end  fl, t.t_NRCountry t_NameObject, sfcontr.t_ID, sfcontr.t_number sfnum, sfcontr.t_datebegin sfbeg, sfcontr.t_dateclose sfcls, sfcontr.t_servkind sfsk, sfcontr.t_ServKindSub subkind, " +       
            " RSI_RSBPARTY.GetPartyCode(t.t_PartyID, 1) as ClientCode, "
            " case when "
                    "( EXISTS (SELECT 1 " +
                    "  FROM DV_SCQINVHIST hist " +
                    " WHERE hist.t_PartyID   = t.t_PartyID" +
                    "   AND hist.t_State     = 1 " +
                    "   AND hist.t_BegDate  <= ? " +
                    "   AND (hist.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY') OR hist.t_EndDate > ?))) then 'X' else '0' end as qi, "
                    " case when ("
                        "exists(select 1" +
                        "         from dsfcontr_dbt sf " +
                        "        where sf.t_PartyID = t.t_PartyID and (" +
                        "              sf.t_ServKind = " + string(PTSK_STOCKDL) + " AND " +
                                      " exists (SELECT /*+ index(tick DDL_TICK_DBT_IDX_u1)*/ 1 " +
                                      "         FROM ddl_tick_dbt tick " +
                                      "         WHERE TICK.T_BOFFICEKIND = " + string(DL_SECURITYDOC) +
                                      "         AND tick.t_DealStatus > 0 " +
                                      "         AND (Tick.t_ClientContrID = sf.t_ID /*OR (Tick.t_PartyContrID = sf.t_ID AND Tick.t_IsPartyClient = 'X')*/) " +
                                      "         AND tick.t_DealDate BETWEEN ? AND ? " +
                                      "         AND (Tick.t_ClientID = t.t_partyID /*OR (Tick.t_PartyID = t.t_partyID AND Tick.t_IsPartyClient = 'X')*/))) " +
                    ") or "+ // Golovkin 15.04.2021 ID : 526738 Разбил на два подзапроса, чтобы подтягивались два индекса
                        "exists(select 1" +
                        "         from dsfcontr_dbt sf " +
                        "        where sf.t_PartyID = t.t_PartyID and (" +
                        "              sf.t_ServKind = " + string(PTSK_STOCKDL) + " AND " +
                                      " exists (SELECT /*+ index(tick DDL_TICK_DBT_IDX_u2)*/ 1 " +
                                      "         FROM ddl_tick_dbt tick " +
                                      "         WHERE TICK.T_BOFFICEKIND = " + string(DL_SECURITYDOC) +
                                      "         AND tick.t_DealStatus > 0 " +
                                      "         AND (/*Tick.t_ClientContrID = sf.t_ID OR*/ (Tick.t_PartyContrID = sf.t_ID AND Tick.t_IsPartyClient = 'X')) " +
                                      "         AND tick.t_DealDate BETWEEN ? AND ? " +
                                      "         AND (/*Tick.t_ClientID = t.t_partyID OR*/ (Tick.t_PartyID = t.t_partyID AND Tick.t_IsPartyClient = 'X')))) " +
                    ") or "+
                        "exists(select 1" +
                        "         from dsfcontr_dbt sf " +
                        "        where sf.t_PartyID = t.t_PartyID and (" +
                        "              sf.t_ServKind in (" + string(PTSK_DV) + "," + string(PTSK_CM) + ") AND " +
                                " (exists(SELECT 1 " +
                                "         FROM DDVNDEAL_DBT dvndeal " +
                                "         WHERE DVNDEAL.T_CLIENT = T.T_PARTYID " +
                                "           AND DVNDEAL.T_CLIENTCONTR = sf.t_ID " +
                                "           AND DVNDEAL.T_DATE BETWEEN ? AND ? " +
                                "           AND DVNDEAL.T_STATE > 0) " +
                                "      OR " +
                                " exists (SELECT /*+ index(dvdeal DDVDEAL_DBT_IDX_u1)*/ 1 " +
                                "         FROM DDVDEAL_DBT dvdeal" +
                                "         WHERE DVDEAL.T_CLIENT = T.T_PARTYID " +
                                "         AND DVDEAL.T_CLIENTCONTR = sf.t_ID " +
                                "         AND DVDEAL.T_DATE BETWEEN ? AND ? " +
                                "         AND DVDEAL.T_STATE > 0)) " +
                    "))) then 'X' else '0' end as is_active, " +
            " NVL(Rsb_Secur.GetMainObjAttr(" + OBJTYPE_PARTY + ", LPAD(t.t_partyid, 10, '0'), " + PARTY_ATTR_GROUP_RISKLEVEL + ", ?), 0) as risklevel " +
            "  from dparty_dbt t, dsfcontr_dbt sfcontr, ddlcontrmp_dbt mp, ddlcontr_dbt dlc, dsfcontr_dbt sfc " +
            " where t.t_PartyID <> " + string({OurBank}) + 
            " and mp.t_sfcontrid = sfcontr.t_id" +
            " and dlc.t_dlcontrid = mp.t_dlcontrid" +
            " and sfc.t_id = dlc.t_sfcontrid " +
//"and t.t_PartyID = 114800 and sfcontr.t_Id = 24795 " + 
//"and t.t_PartyID in ( 144164, 144211) " + 
              " and sfcontr.t_PartyID = t.t_PartyID" +
              " and (" +
              "         (sfcontr.t_DateClose > ?" +
              "             or" +
              "         sfcontr.t_DateClose = to_date('01010001', 'ddmmyyyy'))" +
              "         and" +
              "         sfcontr.t_DateBegin <= ?" +
              "     )" +
              " and (" +
IIF(m_IsSecur, "          sfcontr.t_ServKind = " + string(PTSK_STOCKDL), "") +
IIF(m_IsDV and m_IsSecur, " or ", "") +
IIF(m_IsDV,    "          sfcontr.t_ServKind in (" + string(PTSK_DV) +","+ string(PTSK_CM) +")", "") + 
IIF(m_IsVA and (m_IsDV or m_IsSecur), " or ", "") +
IIF(m_IsVA,    "          (sfcontr.t_ServKind = " + string(PTSK_VEKSACC) + " and not exists(select 1 from ddlcontr_dbt dlcontr where dlcontr.t_SfContrID = sfcontr.t_ID))", "") +
IIF(m_IsDepo and (m_IsDV or m_IsSecur or m_IsVA), " or ", "") +
IIF(m_IsDepo,  "          sfcontr.t_ServKind = " + string(PTSK_DEPOS), "") +
              "     ) " +
              " ORDER BY t.t_PartyID, sfc.t_number, 15 desc "; /*GAA:527609, old: 16  */
              //" ORDER BY t.t_PartyID ) s  where o.t_objecttype = 3 and o.t_groupid = 12 and o.t_attrid in (18, 11, 60, 53, 56) and o.t_object = s.party";
/*******************************************************************************
********************************************************************************
********************************************************************************/

    var DS_ProgressIndicator = TProgressBar();

DS_ProgressIndicator.init(4, "Подготовка данных", "Предварительная подготовка данных" );

    execSQL("DELETE FROM D707ds_DBT ");
    SQL_DML = RSDCommand ("begin insert into D707DS_DBT "+Query+"; ?:=sql%rowcount ; end;");
    SQL_DML.NullConversion = false;
    SQL_DML.addParam( "", RSDBP_IN, SessionID);
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, Report707.m_BegDate);
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, Report707.m_BegDate); 
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, Report707.m_BegDate);
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, Report707.m_BegDate);
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
    SQL_DML.addParam( "p_out", RSDBP_OUT,V_INTEGER); 
    SQL_DML.execute();

    var DS_Nrec = SQL_DML.value("p_out");
    DS_ProgressIndicator.Use;

    execSQL("DELETE FROM D707STOCK1_DBT ");

    SQL_DML = RSDCommand ("insert into D707STOCK1_DBT select r.t_SessionID, r.t_party, r.t_id, r.t_kind kind, r.t_amount amount, r.t_fiid vn, " +
            "    (select Rsb_Secur.IsSale(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(r.t_DealType,r.t_BofficeKind),r.t_BofficeKind)) from dual) IsSale, " +
            "    (select Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(r.t_DealType,r.t_BofficeKind),r.t_BofficeKind)) from dual) IsRepo, " +
            "     r.t_type type " +
         " from (select /*+ ordered cardinality(rq1 10)  index(rq1 DDLRQ_DBT_IDX5) use_nl(tick)  index(tick DDL_TICK_DBT_IDX0) use_nl(rq) index(rq.rq DDLRQ_DBT_IDX0) index(rq.rqbcex.rqbc DDLRQBC_DBT_IDX1) */ " +
           "      ds.t_SessionID, ds.t_party, ds.t_id, rq.t_kind, rq.t_amount, rq.t_fiid, tick.t_DealType,tick.t_BofficeKind,rq.t_type,rq.t_instance,rq.t_changedate, "+
           "    max(rq.T_INSTANCE) over ( partition by rq.t_rqid,CASE WHEN rq.t_changedate <= ? THEN 1 ELSE 0 END ) as max_INSTANCE "+
            "  from ddlrq_dbt rq1, ddl_tick_dbt tick, D707ds_DBT ds,  v_rqhistex rq  " +
            " where ds.t_SessionID = ? "
            "   and ds.t_sfsk = "+PTSK_STOCKDL +" "+
            "   and ds.t_party = tick.t_clientid and ds.t_id = tick.t_clientcontrid" +
            "   and tick.t_bofficekind = " + DL_SECURITYDOC + " " +
            "   and tick.t_dealstatus != " + DL_PREPARING + " " +
            "   and tick.t_dealid = rq1.t_docid " + // rq.t_docid
            "   and tick.t_bofficekind = rq1.t_dockind  " + // rq.t_DocKind
            "   and rq.t_rqid = rq1.t_id  "  +
            "   and rq.t_docid = rq1.t_docid " +
            "   and decode(rq.t_dockind,rq1.t_dockind,1,0)=1" +
            "   and decode(rq.t_type,rq1.t_type,1,0)=1" +
            "   and decode(rq.t_dealpart,rq1.t_dealpart,1,0)=1" +
            "   and tick.t_dealdate <= ? " +
            //"   and (tick.t_closedate >= ? or tick.t_closedate = to_date('01010001', 'ddmmyyyy')) " +
            "   and case when ( rq.t_type in (" + DLRQ_TYPE_PAYMENT + "," + DLRQ_TYPE_INCREPO + ")" +
            "           and rq.t_state not in (" + DLRQ_STATE_EXEC + "," + DLRQ_STATE_REJECT + ") " +
            "        or     rq.t_type = " + DLRQ_TYPE_COMISS +
            "           and not exists (select 1 from ddlcomis_dbt comis where rq.t_SourceObjKind = " + DL_SECURITYCOM + " AND comis.t_Id = rq.t_SourceObjId AND comis.t_IsBankExpenses = CHR(88))) " +
            "      then 1 else 0 end = 1 " +
            "   and (rq1.t_factdate > ? or rq1.t_factdate = to_date('01010001', 'ddmmyyyy')) ) r, dfininstr_dbt fin " +
        " where fin.t_fiid = r.t_fiid and r.t_instance = max_INSTANCE and (r.t_changedate <= ? or r.t_type = " + DLRQ_TYPE_COMISS + ")");
 
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, SessionID);
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());

      SQL_DML.execute();
     DS_ProgressIndicator.Use;


    execSQL("DELETE FROM D707STOCK2_DBT ");

    SQL_DML = RSDCommand ("insert into D707STOCK2_DBT select r.t_SessionID, r.t_party, r.t_id, r.t_kind kind, r.t_amount amount, r.t_fiid fiid, fin.t_faceValueFi vn, fin.t_name fi_name, " +
            "       (select Rsb_Secur.IsSale(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(t_DealType, t_BofficeKind), t_BofficeKind)) from dual) IsSale, " +
            "       (select Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(t_DealType, t_BofficeKind), t_BofficeKind)) from dual) IsRepo, " +
            "       t_MarketId "+
         " from (select /*+ ordered cardinality(rq1 10) index(rq1 DDLRQ_DBT_IDX5) use_nl(tick)  index(tick DDL_TICK_DBT_IDX0) use_nl(rq) index(rq.rq DDLRQ_DBT_IDX1) index(rq.rqbcex.rq DDLRQ_DBT_IDX1)*/ " + 
            "       ds.t_SessionID, ds.t_party,ds.t_id,rq.t_kind, rq.t_amount, rq.t_fiid," +
            "       tick.t_DealType, tick.t_BofficeKind, " +
            "       tick.t_MarketId,rq.t_changedate,rq.T_INSTANCE, " +
            "       max(rq.T_INSTANCE) over ( partition by rq.t_rqid,CASE WHEN rq.t_changedate <= ? THEN 1 ELSE 0 END ) as max_INSTANCE "+
            "  from  ddlrq_dbt rq1,ddl_tick_dbt tick, D707ds_DBT  ds,  v_rqhistex rq " +
            " where ds.t_SessionID = ? "
            "   and ds.t_sfsk = "+PTSK_STOCKDL +" "+
            "   and ds.t_party = tick.t_clientid and ds.t_id = tick.t_clientcontrid "+
            "   and tick.t_bofficekind = " + DL_SECURITYDOC + " " +
            "   and tick.t_dealstatus != " + DL_PREPARING + " " +
            "   and tick.t_dealid = rq1.t_docid " + //rq.t_docid
            "   and tick.t_bofficekind = rq1.t_dockind  " + // rq.t_DocKind
            "   and rq.t_docid = tick.t_dealid " + //rq1.t_docid
            "   and rq.t_dockind = tick.t_bofficekind" + // rq1.t_dockind
            "   and decode(rq.t_type, rq1.t_type, 1, 0) = 1" +
            "   and decode(rq.t_dealpart , rq1.t_dealpart, 1, 0) = 1" +
            "   and tick.t_dealdate <= ? " +
//          "   and (tick.t_closedate >= ? or tick.t_closedate = to_date('01010001', 'ddmmyyyy')) " +
            "   and decode(rq.t_type , " + DLRQ_TYPE_DELIVERY + " , 1, 0) = 1" +
            "   and decode(rq.t_state ," + DLRQ_STATE_EXEC + ",0," + DLRQ_STATE_REJECT + ",0,1) = 1 " +
            "   and (rq1.t_factdate > ? or rq1.t_factdate = to_date('01010001', 'ddmmyyyy')) " +
            "   ) r , dfininstr_dbt fin" +
        " where r.t_instance = r.max_INSTANCE and r.t_changedate <= ? and fin.t_fiid = r.t_fiid");

      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, SessionID);
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());

      SQL_DML.execute();
      DS_ProgressIndicator.Use;

      execSQL("DELETE FROM D707ACC_DBT ");

      SQL_DML = RSDCommand ("INSERT INTO D707ACC_DBT (t_SessionID, t_ContrID, t_AccountID, t_Account, t_Currency, t_rest, t_cr)       " +
                            "  WITH cat AS (SELECT t_ID                                                                               " +
                            "                 FROM dmccateg_dbt                                                                       " +
                            "                WHERE     t_LevelType = 1                                                                " +
                            "                      AND t_Code IN ('ДС клиента, ц/б', 'Брокерский счет ДБО'))                          " +
                            " SELECT ? t_SessionId, mcacc.t_ContrId, mcacc.t_AccountId, mcacc.t_Account, mcacc.t_Code_Currency t_Cur, " +
                            "        CASE WHEN FIRST_VALUE(mcacc.t_ContrId)                                                           " +
                            "                    OVER (PARTITION BY mcacc.t_AccountID                                                 " +
                            "                          ORDER BY mcacc.t_sfnum, mcacc.t_active ) = mcacc.t_ContrId                     " +
                            "            THEN ( select rsb_account.restac (mcacc.t_Account,                                           " +
                            "                                        mcacc.t_Code_Currency,                                           " +
                            "                                        ?,                                                               " +
                            "                                        mcacc.t_Chapter,                                                 " +
                            "                                        NULL) from dual )                                                " +
                            "             ELSE 0                                                                                      " +
                            "        END t_Rest,                                                                                      " +
                            "        CASE WHEN mcacc.t_Code_Currency != 0                                                             " +
                            "               THEN (select RSB_SPREPFUN.GetRateOnDateCrossDbl_Ex(?, mcacc.t_Code_Currency, 0, 1) from dual) " +
                            "             ELSE 1                                                                                      " +
                            "        END t_cr                                                                                         " +
                            "   FROM (SELECT /*+ ordered use_nl(mc) index(mc DMCACCDOC_DBT_IDXC) */ DISTINCT acc.t_Code_Currency, acc.t_Account, acc.t_Chapter, " +
                            "                         acc.t_AccountId, ds.t_id t_contrid, ds.t_sfnum, ds.t_active                     " +
                            "           FROM cat, d707ds_dbt ds, dmcaccdoc_dbt mc, daccount_dbt acc                                    " +
                            "          WHERE     ds.t_SessionID = ?                                                                   " +
                            "                AND mc.t_CatID = cat.t_ID                                                                " +
                            "                AND mc.t_owner = ds.t_Party AND mc.t_ClientContrID = ds.t_ID                             " +
                            "                AND acc.t_Account = mc.t_Account                                                         " +
                            "                AND acc.t_Chapter = mc.t_Chapter                                                         " +
                            "                AND acc.t_Code_Currency = mc.t_Currency                                                  " +
                            "                AND acc.t_Open_Date <= ?                                                                 " +
                            "                AND (   acc.t_Close_Date = TO_DATE('01.01.0001', 'DD.MM.YYYY')                           " +
                            "                     OR acc.t_Close_Date >= ?) ) mcacc                                                   ");

      SQL_DML.addParam( "", RSDBP_IN, SessionID);
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, SessionID);
      SQL_DML.addParam( "", RSDBP_IN, H1_ReportDate());
      SQL_DML.addParam( "", RSDBP_IN, Report707.m_BegDate);

      SQL_DML.execute();
      DS_ProgressIndicator.Use;
      DS_ProgressIndicator.Remove;

      execSQL("DELETE FROM d707deal_dbt ");
      execSQL("DELETE FROM daidecr_dbt ");
      execSQL("DELETE FROM darnureperr_dbt WHERE t_SessionID = " + string(SessionID));
      execSQL("COMMIT;");

      var PartitionNum;
      var q, cmd, rs;
      var old_contr = -1, old_party = -1;
//      var group;
//      var IfNeedNKD = false, FindCourseFi = 0.0, DealCode = "", DealFiid = NULL, DealPrice = NULL, НКД = 0.0;

      DS_ProgressIndicator.init(PARTITION_COUNT, "Подготовка данных по договорам клиентов", "Предварительная подготовка данных" );
    
      FOR (PartitionNum, 1, PARTITION_COUNT)
        cmd = RSDCommand("CALL RSB_DLAIREP.CreateAllData(?,?,?,?,?,?)");

        cmd.addParam( "", RSDBP_IN, Report707.m_BegDate );
        cmd.addParam( "", RSDBP_IN, H1_ReportDate() );
        cmd.addParam( "", RSDBP_IN, SessionID );
        cmd.addParam( "", RSDBP_IN, PARALLEL_LEVEL );
        cmd.addParam( "", RSDBP_IN, PARTITION_COUNT );
        cmd.addParam( "", RSDBP_IN, PartitionNum );

        cmd.execute();

        DS_ProgressIndicator.Use;
      end;
      DS_ProgressIndicator.Remove;
    end;


///////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////

        Report707.SetActiveSheet("Отчет");
        Report707.PrintReportHead();
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_ReportHead", 0, "Отчет");
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_TableHead1", 0, "Отчет");

        //@Kliko
        Report707.PrintKlikoHead("<F707N_1>");

        if(m_InDelta)
          m_DeltaReport.PrintInfo();
        end;

        PrintTable_1();

        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_Table2", 0, "Отчет");
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_TableHead3", 0, "Отчет");
       
        //@Kliko
        Report707.PrintKlikoHead("<F707N_2_1>");    
        Report707.PrintKlikoHead("<F707_2_N2>");    
        Report707.PrintKlikoHead("<F707N_3N>");        
        dbg("Start DEPO");

        if( m_IsDepo ) 
           Report707.GetInfoByDepo();
        end;
        Report707.PrintTable_3();

        if(m_InDelta)
          m_DeltaReport.EndData707();
        end;

        //@Kliko
        Report707.PrintKlikoHead("<F707_3>");
        Report707.PrintKlikoHead("<F707_4>");
        dbg("Finish DEPO");

        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_Table4", 0, "Отчет");
        Report707.AddStandardFooter("N_");
        Report707.CopyAllSheetInTotalBook("Отчет", false, "N1_Footer", 0, "Отчет");

        if (m_IsSecur or m_IsDV or m_IsVA)
          var ServKind:string = "";
          old_party = -1;/*GAA*/
          var Ar_acc1 = TArray; /*GAA*/
          dbg("Start DECRIPTION");
          Report707.SetActiveSheet("Расшифровка");
          Report707.PrintFormatString(NULL, "N2_H1", "по состоянию на " + H1_ReportDate() + " г.");

          Report707.CopyAllSheetInTotalBook("Расшифровка", false, "N2_ReportHead", 0, "Расшифровка");
          Report707.CopyAllSheetInTotalBook("Расшифровка", false, "N2_TableHead", 0, "Расшифровка");
/*
          q_cl = "select decr.*, ds.t_sname t_Client, ds.t_name t_ClientFull, ds.t_ClientCode, ds.t_sfnum t_number, ds.*, "
                 "       ds.t_sfbeg t_DateBegin, case when ds.t_sfcls = to_date('01.01.0001','dd.mm.yyyy') then to_date('01.01.2000','dd.mm.yyyy') else ds.t_sfcls end t_DateClose, "
                 "       acc.t_Account, acc.t_rest, acc.t_cr "
                 "  from DAIDecr_dbt decr, d707ds_dbt ds, d707acc_dbt acc "
                 "  WHERE decr.t_SessionID = ? "
                 "    AND ds.t_SessionID = decr.t_SessionID "
                 "    AND ds.t_ID = decr.t_ContrID "
                 "    AND acc.t_SessionID(+) = decr.t_SessionID "
                 "    AND acc.t_ContrID(+) = decr.t_ContrID "
//                 "    AND NOT ( INSTR(ds.t_sfnum, '_v') > 0 AND ds.t_Active = '0' AND t_rest = 0) "
                 "  Order by ds.T_CLIENTCODE, ds.t_sfnum, ds.t_active desc ";
          cmd_cl = DL_RSDCommand(q_cl);
          cmd_cl.AddParam(SessionID);

          DS_ProgressIndicator = TProgressBar();
          DS_Nrec = cmd_cl.GetCount();
          DS_ProgressIndicator.init(DS_Nrec, "Печать листа расшифровок", "Печать листа расшифровок" );
          rs_cl = cmd_cl.execute();
          Report707.RegisterTable("N2_TableLine", "", "N2_ClientCode", "N2_Client", "N2_ClientFull", "N2_A01", "N2_ResidenceStatus", "N2_RegisterType", "N2_Activity", "N2_QualifiedInvestor", "N2_ContractNumber", "N2_ContractOpenDate", "N2_ContractCloseDate", "N2_Industry", "N2_Account", "N2_CrNom", "N2_A05", "N2_NumDEPO", "N2_SecQnty", "N2_MarketSecCost", "N2_A06", "N2_A07", "N2_A08", "N2_A09", "N2_A10");

          while (rs_cl.MoveNext)
            dbg("Client " + rs_cl.T_CLIENT);
            // перебор счетов по договору. 
/*GAA*/
/*if ( old_party != rs_cl.T_CLIENT)
   ar_size = 0; /*GAA*/
   Ar_acc1.size = 0;/*GAA*/
   old_party = rs_cl.T_CLIENT;
end;*/
/*GAA*/
            if ( old_contr != rs_cl.ContrID )
              if ( old_party != rs_cl.T_CLIENT)
                old_party = rs_cl.T_CLIENT;
              end;
              old_contr = rs_cl.ContrID;
              i = 1;
            end;
/*
            q = " select mc2.acc, mc2.cur, rsb_account.restac(mc2.acc, mc2.cur, ?, mc2.t_Chapter, null) sum " +
                "   from (select mc.acc, mc.cur, mc.t_Chapter                                               " +
                "           from                                                                            " +
                "                ( select ac.t_account acc, ac.t_code_currency cur, ac.t_Chapter            " +
                "                    from daccount_dbt ac, dsettacc_dbt sa, dSfssi_dbt ss                   " +
                "                   where sa.t_settaccid = ss.t_setaccid                                    " +
                "                     and ss.t_objecttype = 659                                             " +
                "                     and ss.t_objectid = LPAD(?, 10, '0')                                  " +
                "                     and ac.t_Balance in ('30601', '30606')                                " +
                "                     and ac.t_account = sa.t_account                                       " +
                "                     and ac.t_chapter = sa.t_chapter                                       " +
                "                     and ac.t_code_currency = sa.t_fiid                                    " +
                "                ) mc                                                                       " +
                "                group by mc.acc, mc.cur, mc.t_Chapter                                      " +
                "        ) mc2                                                                              ";

            cmd = DL_RSDCommand(q);
            cmd.AddParam(H1_ReportDate());
            cmd.AddParam(int(rs_cl.ContrID));
            rs = cmd.execute();
            ok = rs.MoveNext;
            if (ok == false)
*/
            if(rs_cl.SfSK == PTSK_STOCKDL)
               ServKind = iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок");
            elif(rs_cl.SfSK == PTSK_VEKSACC)
               ServKind = "Учтенные векселя";  
            else
               ServKind = iif(rs_cl.SfSK == PTSK_DV, "Срочный рынок", "Валютный рынок");
            end;

            if (ValType(rs_cl.Account) == V_UNDEF)
              msgbox("Счетов для ДО " + string(rs_cl.Number) + " не найдено");
              //выведем строку без счетов
              Report707.PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, date(rs_cl.DATEBEGIN), date(rs_cl.DATECLOSE), iif(rs_cl.SfSK == PTSK_STOCKDL, iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок"), iif(rs_cl.SfSK == PTSK_DV, "Срочный рынок", "Валютный рынок")), "", "", "", NumDEPO, SecQnty, MarketSecCost, rs_cl.A6, Round(rs_cl.A7/ 1000, 2), Round(rs_cl.A8/ 1000, 2), Round(rs_cl.A9/ 1000, 2), Round(rs_cl.Itog/ 1000, 2), GetRiskName(rs_cl.RiskLevel));
              continue;
            else
/*
              i = 1;
              while (ok)
               tmp_sum = 0;
                if (Int(rs.cur) != NATCUR)
                  //ConvSum(tmp_sum, rs.sum, H1_ReportDate(), int(rs.cur), NATCUR);
                  cr = GetRateOnDateCrossDbl(H1_ReportDate(), int(rs.cur), NATCUR, true);
                  tmp_sum = cr * rs.sum;
                else
                  tmp_sum = rs.sum;
                  cr = $1;
                end;
                //tmp_sum = Round(tmp_sum/ 1000, 0);
                if((index(string(rs_cl.NUMBER), "_v") > 0) and (rs_cl.T_ACTIVE == "0") and (tmp_sum == 0))
                  //Chesnokov D.S. Если договор заканчивается на _v и неактивный и нет средств, то не печатаем
                  ok = rs.MoveNext;
                  i = i + 1;
                  continue;
                end;

/*GAA*/
ar_size = Ar_acc1.size;
var ii = 0;                                /*SVE DEF-20802  для ii и add_Acc добавлено var */
var add_acc = 1; //добавлять счет в массив
if (tmp_sum != 0)
  while ((ii <= ar_size) and (ar_size != 0))
    if (Ar_acc1.value(ii)== rs.Acc)
      tmp_sum = 0;
      add_acc = 0;
    end;
    ii = ii +1;
  end;
else
  add_acc = 0;  
end;

if (add_acc == 1)
    Ar_acc1.value(ar_size) = rs.Acc;
end;
/*GAA*/
*/
              tmp_sum = rs_cl.rest * rs_cl.cr;

              if(i == 1)
/*                  if(rs_cl.SfSK == PTSK_STOCKDL)
                     ServKind = iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок");
                  elif(rs_cl.SfSK == PTSK_VEKSACC)
                     ServKind = "Учтенные векселя";  
                  else
                   ServKind = iif(rs_cl.SfSK == PTSK_DV, "Срочный рынок", "Валютный рынок");
                  end;
*/

                Report707.PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, date(rs_cl.DATEBEGIN), date(rs_cl.DATECLOSE), iif(rs_cl.SfSK == PTSK_STOCKDL, iif(rs_cl.SubKind == 8 , "Биржевой рынок", "Внебиржевой рынок"), iif(rs_cl.SfSK == PTSK_DV, "Срочный рынок", "Валютный рынок")), rs_cl.Account, rs_cl.cr, round(tmp_sum/1000, 5), NumDEPO, SecQnty, MarketSecCost, rs_cl.A6, Round(rs_cl.A7/ 1000, 2), Round(rs_cl.A8/ 1000, 2), Round(rs_cl.A9/ 1000, 2), Round(rs_cl.Itog/ 1000, 0), GetRiskName(rs_cl.RiskLevel));
              else
                Report707.PrintLineDecription(rs_cl.T_CLIENTCODE, rs_cl.T_CLIENT, rs_cl.T_CLIENTFULL, rs_cl.T_COUNTRY, rs_cl.T_NOTRESIDENT, rs_cl.T_FL, rs_cl.T_ACTIVE, rs_cl.T_KI, rs_cl.NUMBER, date(rs_cl.DATEBEGIN), date(rs_cl.DATECLOSE), "", rs_cl.Account, rs_cl.cr, round(tmp_sum/1000, 5), "", "", "", "", "", "", "", "", GetRiskName(rs_cl.RiskLevel));
              end;
              //ok = rs.MoveNext;
              i = i + 1;
            end;
//            end;
            DS_ProgressIndicator.Use;
          end;
          Report707.EndTable();
          Report707.CopyAllSheetInTotalBook("Расшифровка", true, Report707.GetTableRange(), 0, "Расшифровка");
*/
          SaveDecriptionInCSV();

          DS_ProgressIndicator.Remove;
          dbg("Finish DECRIPTION");
        end;

        /**/
        Report707.SetActiveSheet("Бумаги");
        Report707.PrintFormatString(NULL, "N3_H1", "по состоянию на " + date_as_string(1, H1_ReportDate() + 1, false) + " г.");

        Report707.CopyAllSheetInTotalBook("Бумаги", false, "N3_ReportHead", 0, "Бумаги");
        Report707.CopyAllSheetInTotalBook("Бумаги", false, "N3_TableHead", 0, "Бумаги");
        
        avr_q = "select deal.*, replace((case when substr(to_char(deal.T_SecQnty), 1, 1) =  '.' then '0' || to_char(deal.T_SecQnty) else to_char(deal.T_SecQnty) end), '.', ',') T_QNTYSTR, ds.t_sname t_Client, ds.t_name t_ClientFull, ds.t_sfnum t_number, ds.t_sfbeg t_DateBegin, ds.t_sfcls t_DateClose, ds.* from D707DEAL_DBT deal, d707ds_dbt ds "
                " where deal.t_SessionID = ? "
                "   and ds.t_SessionID = deal.t_SessionID "
                "   and ds.t_ID = deal.t_ContrID "
                " Order by ds.T_CLIENTCODE ";
        avr_cmd = DL_RSDCommand(avr_q);
        avr_cmd.AddParam(SessionID);

        DS_ProgressIndicator = TProgressBar();
        DS_Nrec = avr_cmd.GetCount();
        DS_ProgressIndicator.init(DS_Nrec, "Печать листа ценных бумаг", "Печать листа ценных бумаг" );
        avr_rs = avr_cmd.execute();
        Report707.RegisterTable("N3_TableLine", "", "N3_ClientCode", "N3_Client", "N3_A01", "N3_ContractNumber", "N3_KindAvr", "N3_TypeAvr", "N3_FIName", "N3_ISIN", "N3_SecQnty", "N3_Nominal", "N3_FiID", "N3_MarketPrice", "N3_Rate", "N3_TotalCost");
        
        while (avr_rs.MoveNext)
          Report707.PrintLineAvoiriss(avr_rs.T_CLIENTCODE, avr_rs.T_CLIENTFULL, avr_rs.T_COUNTRY, avr_rs.T_NUMBER, avr_rs.T_AVRKIND, avr_rs.T_AVRTYPE, avr_rs.T_FINAME, avr_rs.T_ISIN, avr_rs.T_QNTYSTR, avr_rs.T_Nominal, avr_rs.T_FIID, avr_rs.T_MARKETPRICE, avr_rs.T_Rate, avr_rs.T_TotalCost);
          DS_ProgressIndicator.Use;
        end;
        
        Report707.EndTable();
        Report707.CopyAllSheetInTotalBook("Бумаги", false, Report707.GetTableRange(), 0, "Бумаги");
        DS_ProgressIndicator.Remove;
        //msgbox("Завершение отчета: " + Time());

        PrintMessages();
        if(m_InDelta and (not m_IsDataExist))
          m_DeltaReport.NoData();
        end;
        if(m_InDelta)
          m_DeltaReport.PrintProtocol();
        end;

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
  end;

  MACRO PrintKlikoValLine(SubjectCode:STRING, CountryCode:STRING, Val1,   
                          RestInAccPlus, SecurInAccPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,
                          RestInAccMinus,SecurInAccMinus,RestMoneyMinus,RestSecurMinus,RestOtherMinus,
                          t1:integer, _StrCount:@INTEGER, _PrCount:@INTEGER, _substr:BOOL)
   
        private macro __insertLine(A1,A2,A3,A4, A5,A6,A7,A8,A9, A10,A11,A12,A13,A14, A15,A16,A17,A18)
          var s:string =  Kliko_Fld( A1  ) +","+
                          Kliko_Fld( A2  ) +","+
                          Kliko_Fld( A3  ) +","+
                          Kliko_Fld( A4, 0  ) +","+ // Golovkin 10.05.2021 SD6630971
                          Kliko_Fld( A5, 0  ) +","+
                          Kliko_Fld( A6  ) +","+      
                          Kliko_Fld( A7  ) +","+
                          Kliko_Fld( A8 ) +","+
                          Kliko_Fld( A9 ) +","+
                          Kliko_Fld( A10 ) +","+
                          Kliko_Fld( A11 ) +","+
                          Kliko_Fld( A12 ) +","+
                          Kliko_Fld( A13 ) +","+
                          Kliko_Fld( A14 ) +","+
                          Kliko_Fld( A15 ) +","+
                          Kliko_Fld( A16 ) +","+
                          Kliko_Fld( A17 ) +","+
                          Kliko_Fld( A18 );

          return Kliko_InsertInTxtFile(s);   
        end;
    
    var StrCount = "";
    if (_StrCount != null)
      if (_substr != true)
        StrCount=_StrCount+1;
      else
        StrCount=_StrCount;
      end;
      _StrCount = StrCount;
    end;

    var PrCount = "";
    if (_PrCount != null)
      if (_substr != true)
        PrCount = _PrCount + 1;
      else
        PrCount = _PrCount;
      end;
      _PrCount = PrCount;
    end;

    if ( _substr != true )
      return __insertLine( "", SubJectCode, CountryCode, Val1,  RestInAccPlus, SecurInAccPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,  
                           RestInAccMinus, SecurInAccMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus,  PrCount, t1, StrCount, "");
    else
      return __insertLine( "", SubJectCode, CountryCode, Val1,  RestInAccPlus, SecurInAccPlus, RestMoneyPlus, RestSecurPlus, RestOtherPlus,  
                           RestInAccMinus, SecurInAccMinus, RestMoneyMinus, RestSecurMinus, RestOtherMinus,  PrCount, t1, 0, StrCount);
    end;
  END;

MACRO PrintKlikoValLineDepo(SubjectCode:STRING, CountryCode:STRING, ValSum, Val1, Val2,  
                              t1:integer, _StrCount:@INTEGER, _PrCount:@INTEGER, _substr: BOOL)
   
        private macro __insertLine(A1,A2,A3,A4,A5,A6, A7,A8,A9,A10)
          var s:string =  Kliko_Fld( A1  ) +","+
                          Kliko_Fld( A2  ) +","+
                          Kliko_Fld( A3  ) +","+
                          Kliko_Fld( A4  ) +","+ 
                          Kliko_Fld( A5  ) +","+
                          Kliko_Fld( A6  ) +","+ 
                          Kliko_Fld( A7  ) +","+
                          Kliko_Fld( A8  ) +","+
                          Kliko_Fld( A9  ) +","+
                          Kliko_Fld( A10 );
          return Kliko_InsertInTxtFile(s);   
        end;
    
    var StrCount = "";
    if (_StrCount != null)
      if (_substr != true)
        StrCount=_StrCount+1;
      else
        StrCount=_StrCount;
      end;
      _StrCount = StrCount;
    end;

    var PrCount = "";
    if (_PrCount != null)
      if (_substr != true)
        PrCount = _PrCount + 1;
      else
        PrCount = _PrCount;
      end;
      _PrCount = PrCount;
    end;

    if ( _substr != true )
      return __insertLine( "", SubJectCode, CountryCode, ValSum, Val1, Val2,  PrCount, t1, StrCount, "");
    else
      return __insertLine( "", SubJectCode, CountryCode, ValSum, Val1, Val2,  PrCount, t1, 0, StrCount);
    end;
  END;

  MACRO InsDepoTMP(PartyId, Country, IsNotResident, IsFL, IsActive)
    var insq = "INSERT INTO D707DEPO_TMP (T_PARTYID, T_COUNTRY, T_NOTRESIDENT, T_FL, T_ACTIVE) VALUES (?,?,?,?,?)";
    var inscmd;
    inscmd = RSDCommand (insq);
    inscmd.NullConversion = false;
    inscmd.addParam( "", RSDBP_IN, PartyId);
    inscmd.addParam( "", RSDBP_IN, Country);
    inscmd.addParam( "", RSDBP_IN, iif(IsNotResident == "X", "X", "0"));
    inscmd.addParam( "", RSDBP_IN, iif(IsFL == "X", "X", "0"));
    inscmd.addParam( "", RSDBP_IN, iif(IsActive == "X", "X", "0"));
    inscmd.execute();
  END;

  PRIVATE MACRO PrintSubsectionTable_3( SubTitle, SubTitleNumber, IsNotResident, IsOnlyActive, StCount:@integer, PrCount:@integer )
    var q, cmd, rs;
    var IsNotEmpty = false;
    var Part3DeltaSubsection;
                                       
    PrintDepoOneTableHeader( SubTitle + " [" + SubTitleNumber + "]" );

    var KlikoTitleStr = IIF((not IsNotResident) and (not IsOnlyActive), SubTitle, SubTitle+":"); // Ошибка в описателе, требующая, чтобы в первом названии не было двоеточия
    PrintKlikoTitle(null, KlikoTitleStr, IIF(IsNotResident, "2","1"), @StCount);
         
    if( m_IsDepo )
       q = "select count(case when T_FL = 'X' then 1 else null end) cntFL, " + 
           "       count(case when T_FL != 'X' then 1 else null end) cntUL " + 
           "  from D707DEPO_TMP " + 
           " where T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + IIF(IsOnlyActive," and T_ACTIVE = 'X' ", "");
     
       cmd = DL_RSDCommand(q);
       rs = cmd.execute();

       if( rs.MoveNext() and ((rs.cntFL > 0) or (rs.cntUL > 0)) )           
          PrintDepoRepTableLine("", rs.cntFL, rs.cntUL);
          PrintKlikoValLineDepo("", "", rs.cntFL+rs.cntUL, rs.cntFL, rs.cntUL,  IIF(IsNotResident, "2","1"), @StCount, @PrCount, false);

          if(m_InDelta)
            if(SubTitleNumber == "1")
              m_DeltaReport.BeginPart3();
              Part3DeltaSubsection = SUBSECTION_PART3_DELTA_RES;
            elif(SubTitleNumber == "1.2")
              Part3DeltaSubsection = SUBSECTION_PART3_DELTA_ACTIVE_RES;
            elif(SubTitleNumber == "2")
              Part3DeltaSubsection = SUBSECTION_PART3_DELTA_NOT_RES;
            elif(SubTitleNumber == "2.2")
              Part3DeltaSubsection = SUBSECTION_PART3_DELTA_ACTIVE_NOT_RES;
            end;

            m_DeltaReport.PrintLinePart3(Part3DeltaSubsection, "", rs.cntFL + rs.cntUL, rs.cntFL, rs.cntUL);
          end;
          IsNotEmpty = true;
       end;
    end;
    if( IsNotEmpty == false )
       PrintDepoRepTableLine("", 0, 0);
       PrintKlikoValLineDepo("", "", "", "", "",  IIF(IsNotResident, "2","1"), @StCount, @PrCount, false);
    end;

    PrintDepoOneTableHeader(IIF(IsNotResident, "В том числе по странам [" + SubTitleNumber + ".1]", "В том числе по субъектам [" + SubTitleNumber + ".1]"));
    PrintKlikoTitle(null, IIF(IsNotResident, "в том числе по странам:", "в том числе по субъектам:"), IIF(IsNotResident, "2","1"), @StCount);

    if( IsNotEmpty )
       q = "select T_COUNTRY, " + 
           "       count(case when T_FL = 'X' then 1 else null end) cntFL, " + 
           "       count(case when T_FL != 'X' then 1 else null end) cntUL " + 
           "  from D707DEPO_TMP " + 
           " where T_NOTRESIDENT " + IIF(IsNotResident, " = 'X' ", " != 'X' ") + IIF(IsOnlyActive," and T_ACTIVE = 'X' ", "") +
           " group by T_COUNTRY order by T_COUNTRY asc";     

       cmd = DL_RSDCommand(q);
       rs = cmd.execute();

       var CountCountry = 0;
       while( rs.MoveNext() )
          PrintDepoRepTableLine(rs.t_Country, rs.cntFL, rs.cntUL);
          PrintKlikoValLineDepo(IIF(IsNotResident,"",rs.t_Country), IIF(IsNotResident,rs.t_Country,""), 
                                rs.cntFL+rs.cntUL, rs.cntFL, rs.cntUL,
                                IIF(IsNotResident, "2","1"), @StCount, @PrCount, (CountCountry > 0)
                           );

         if(m_InDelta)
           if(SubTitleNumber == "1")
             Part3DeltaSubsection = SUBSECTION_PART3_DELTA_RES_SUB;
           elif(SubTitleNumber == "1.2")
             Part3DeltaSubsection = SUBSECTION_PART3_DELTA_ACTIVE_RES_SUB;
           elif(SubTitleNumber == "2")
             Part3DeltaSubsection = SUBSECTION_PART3_DELTA_NOT_RES_CON;
           elif(SubTitleNumber == "2.2")
             Part3DeltaSubsection = SUBSECTION_PART3_DELTA_ACTIVE_NOT_RES_CON;
           end;

           m_DeltaReport.PrintLinePart3(Part3DeltaSubsection, rs.t_Country, rs.cntFL + rs.cntUL, rs.cntFL, rs.cntUL);
         end;

         CountCountry = CountCountry + 1;
       end;
    else
       PrintDepoRepTableLine("", 0, 0);
       PrintKlikoValLineDepo("", "", "", "", "",  IIF(IsNotResident, "2","1"), @StCount, @PrCount, false);
    end;

    return PrCount;
  END;

  MACRO PrintTable_3()
    var StCount = 0; //сквозная нумерация строк данных для kliko
    var PrCount = 0; //сквозная нумерация пунктов для kliko
    var DS_ProgressIndicator = TProgressBar();

    if( m_IsDepo )
       DS_ProgressIndicator.init(4, "Печать сведений о депозитарной деятельности", "Печать сведений о депозитарной деятельности" );
    end;
    PrintSubsectionTable_3("Клиентов - резидентов", "1", false, false, @StCount, @PrCount);
    DS_ProgressIndicator.Use;
    PrintSubsectionTable_3("Активных клиентов - резидентов", "1.2",false, true, @StCount, @PrCount);
    DS_ProgressIndicator.Use;
    StCount = 0; //Нумерация для нерезидентов идет заново
    PrintSubsectionTable_3("Клиентов - нерезидентов", "2", true, false, @StCount, @PrCount);
    DS_ProgressIndicator.Use;
    PrintSubsectionTable_3("Активных клиентов - нерезидентов", "2.2", true, true, @StCount, @PrCount);
    DS_ProgressIndicator.Remove; 

    if(m_InDelta)
      m_DeltaReport.EndPart3();
    end;
  END;

  MACRO GetInfoByDepo()
    var DS_ProgressIndicator = TProgressBar();

    execSQL("BEGIN EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE D707DEPO_TMP (T_PARTYID NUMBER, T_COUNTRY VARCHAR2(5), T_NOTRESIDENT CHAR, T_FL CHAR, T_ACTIVE CHAR) ON COMMIT PRESERVE ROWS'; EXCEPTION WHEN OTHERS THEN NULL; END;");
    execSQL("DELETE FROM D707DEPO_TMP");

    var Query = "select t.t_PartyID, t.t_NRCountry, Rsb_Secur.DL_GetNotResidentForBrokClientRep(t.t_PartyID, ?) rsdnt, t.t_LegalForm, " +
                "case when exists(select 1 " +
                "                   from dsfcontr_dbt sfcontr " +
                "                  where sfcontr.t_PartyID = t.t_PartyID " +
                "                    and (sfcontr.t_DateClose > ? or sfcontr.t_DateClose = ?) " +
                "                    and sfcontr.t_DateBegin <= ? " +
                "                    and sfcontr.t_ServKind = " + string(PTSK_DEPOS) +
                "                    and sfcontr.t_Department = cl.t_Department " +
                "                    and " + GetDepoClients() + ") then 'X' else '0' end active " +
                "  from dparty_dbt t, dclient_dbt cl " +
                " where cl.t_PartyID = t.t_PartyID " +
                "   and t.t_PartyID <> " + string({OurBank}) +
                "   and cl.t_ServiceKind = " + string(PTSK_DEPOS) +
                "   and exists(select 1 " +
                "                from dsfcontr_dbt sfcontr " +
                "               where sfcontr.t_PartyID = t.t_PartyID " +
                "                 and (sfcontr.t_DateClose > ? or sfcontr.t_DateClose = ?) " +
                "                 and sfcontr.t_DateBegin <= ? " +
                "                 and sfcontr.t_ServKind = " + string(PTSK_DEPOS) +
                "                 and sfcontr.t_Department = cl.t_Department) " +
                "   and cl.t_StartDate <= ? " +
                "   and (cl.t_FinishDate > ? or cl.t_FinishDate = ?) "; 

    var Select = DL_RSDCommand(Query);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());

    //Передаются в GetDepoClients()
    Select.AddParam(m_BegDate);
    Select.AddParam(H1_ReportDate());
    Select.AddParam(m_BegDate);
    Select.AddParam(H1_ReportDate());

    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(H1_ReportDate());
    Select.AddParam(date(0, 0, 0));

    var DS_Nrec = Select.GetCount();    
    if( DS_Nrec > 0 )
       DS_ProgressIndicator.init(DS_Nrec, "Сбор данных о депозитарной деятельности", "Сбор данных о депозитарной деятельности" );

       var rs = Select.execute();
       while( rs.MoveNext() )

         var ResidenceStatus = rs.rsdnt;
         var A01 = "";
         if( ResidenceStatus == "X" )
            if( CheckPartyType(rs.partyID, PTK_INTERNATIONAL_ORG) == true )
              if( hasOGRN(rs.partyID) )
                A01 = "996";
              else
                A01 = "998";
              end;
            else
              A01 = GetCountryCode( rs.NRCountry );
            end;
          else
            A01 = GetOkatoCode( rs.partyID, H1_ReportDate() );
            if( A01 == "" )
              A01 = "00";
            end;
          end;
          if( (A01 == "") or (A01 == null) )
            A01 = "999";
          end;

          InsDepoTMP(rs.partyID, A01, ResidenceStatus, IIF(rs.legalForm != 1, "X", 0), rs.active);
          DS_ProgressIndicator.Use;
       end;
       DS_ProgressIndicator.Remove;
    end;
  END;

  PRIVATE MACRO ExecuteReport( ObjReport:OBJECT )
    var Pr; //Обработанных разделов
    
    if ( m_InKliko )
      Kliko_OpenTxtFile(this.H1_ReportDate());
    end;

    Cals_Sums(H1_ReportDate, m_IsSecur, m_IsDV, m_IsVA, m_IsDepo, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, H1_EndWorkDate, m_ProtocolTxt, m_InDelta, m_DeltaReport);
  END;

  MACRO Create()
    /*m_ClientData = ReportClientData();
    if( m_InKliko )
      Dl_CallInsertStat (DL_OUTREPORT_KLIKO);
      if( not Kliko_OpenTxtFile(this.H1_ReportDate()) )
        return;
      end;
    end;*/
    SetXLSXFormat();
    ExecuteReport();
  END;

  MACRO EndReport()
    if( m_InKliko )
      Kliko_CloseTxtFile( true );
    end;

    if(m_InDelta)
      if(m_DeltaReport.CreateXMLFile())
        msgbox("Создан файл " + m_DeltaReport.GetFileName());
      else
        msgbox("Ошибка выгрузки в Delta");
      end;

      var delta_file_name_term = "$" + SC_GetFullPath(true) + m_DeltaReport.GetFileName();
      if(ExistFile(delta_file_name_term))
         RemoveFile(delta_file_name_term);
      end;
      if (not copyFile(m_DeltaReport.GetFileName(),delta_file_name_term,true,"Копирование на терминал"))
         msgbox("Ошибка при копировании " + m_DeltaReport.GetFileName() + " на терминал");
      else
         RemoveFile(m_DeltaReport.GetFileName());
      end;
    end;
    SaveTotalbook();
  END;

  macro GetAuditMsg(panel:DL_CPanel):String
    var msg:string = "";
    var period:string = "";
    var deals1:string = "";
    var deals2:string = "";
    var deals3:string = "";
    var deals4:string = "";

    period = PeriodName_GetMonthsAndQuart(
                panel.GetFieldValue(PNFLD_FORM707_PERIOD),
                panel.GetFieldValue(PNFLD_FORM707_YEAR));

    deals1 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISSECUR) == "X",
                 "Модуля \"Бэк-офис ценных бумаг\"\n",
                 "");

    deals2 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISVA) == "X",
                 "Модуля \"Учтенные векселя\"\n",
                 "");

    deals3 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISDV) == "X",
                 "Модуля \"ФИСС и КО\"\n",
                 "");

    deals4 = IIF(panel.GetFieldValue(PNFLD_FORM707_ISDEPO) == "X",
                 "Модуля \"Депозитарий\"\n",
                 "");

    msg =
    "Отчет:              Сведения об осуществляемой деятельности (ф.707)\n\n" +
    "Отчет за:           " + period + "\n" +
    "По договорам:\n"  +
    deals1 + deals2 + deals3 + deals4 +
    "\n----------------------------------------\n";

    return msg;
  end;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, true );
END;

MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: CTxReportForm
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)

  var stat = true;
  var FullReportFileNames = TArray();
  WebMenuItem = menuItem;

  if( not IsWebService )
    Form707 = DL_ActivitiesInfo_Form707();
/*TODO:
   else
    if( ValType( FormData ) != V_UNDEF )
      Form707 = WS_Pane707( FormData );
    else
      stat = false;
    end;*/
  end;

  while( stat )
    if( not IsWebService )
      stat = Form707.Run();
    end;

    if( stat )
      Report707 = DlActivitiesInfo_Report707( null, "Report_ActivitiesInfo_4927y.xlsx", true, IsWebService, ReportHashCode, POI_MODE );
      Report707.Run(null, Report707.GetAuditMsg(Form707));

      if( IsWebService )
        Dl_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem );
        FullReportFileNames = Report707.GetFullReportFileNames();
        stat = false;
      else
        Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
      end;
    end;
  end;

  return FullReportFileNames;
END;
