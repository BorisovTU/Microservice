/*
$Name:        DlReport_h.mac
$Module:      Производные инструменты
$Description: Базовые классы для создания отчетов
*/

/*
 PROGRAMMED BY:   Леонов И. Е.
 CREATION DATE:   05.10.06
*/

import "CbReport_h.mac","dlrepfun.mac", "dlreport.mac";

CONST DL_REDCOLOR = RGB(0,0,255);

PRIVATE CONST DL_FORMULA  = "formula=";

CLASS (CB_CReport) DL_CReport( Form:DL_CPanel, TableHeader:STRING )
//  PRIVATE VAR m_TableHeader = TableHeader,
//              m_Report;
/*
  MACRO AddStandardFooter( IsCurDate:BOOL )
     after_44_footer( m_Report, NULL, IsCurDate );
  END;
*/
  InitCB_CReport( Form, TableHeader );
  END;

CLASS (CB_CReportTemplate) DL_CReportTemplate( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL, UseBigReportMode:BOOL, FocreFormatRep:INTEGER )
  PRIVATE VAR DL_DecimalSeparator; 
/*
  MACRO AddStandardFooter( CellPrefix:STRING, _IsCurDate:BOOL )
     MACRO НачальникОтдела()
         var RS = TRsbDataSet("SELECT party.t_Name " +
                              "  FROM dofficer_dbt officer, dparty_dbt party " +
                              " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                              "       officer.t_OfficeID = " + string(SelfDivision) + " AND " +
                              "       officer.t_IsFirstOfficePerson = 'X' AND "
                              "       party.t_PartyID = officer.t_PersonID "
                             );

         if( RS.MoveNext() )
            return RS.Name;
         end;
         return "";
     END;

     MACRO Операционист()
         var RS = TRsbDataSet("SELECT person.t_Name " +
                              "  FROM dperson_dbt person " +
                              " WHERE person.t_oper = " + string({oper})
                             );

         if( RS.MoveNext() )
            return RS.Name;
         end;
         return "";
     END;

     MACRO ДолжностьОперациониста()
         var RS = TRsbDataSet("SELECT officer.t_Post " +
                              "  FROM dofficer_dbt officer, dperson_dbt person " +
                              " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
            "       person.t_oper = " + string({oper}) + " AND " +
            "       officer.t_PersonID = person.t_PartyID "
                             );

         if( RS.MoveNext() )
            return RS.Post;
         end;
         return "Ответственный сотрудник";
     END;

     var IsCurDate = False, m_Date, PostBoss;
     /* IsCurDate добавлен по запросу 102303 */
     if( IsCurDate != NULL )
        IsCurDate = _IsCurDate;
     end;

     if( m_UseTemplate )
        if( CellPrefix == null )
           CellPrefix = "";
        end;
        if( IsCurDate )
           m_Date = string({curdate});
        else
           m_Date = string(Date());
        end;

     if( {Name_Boss} )
        PostBoss = {Name_Boss};
     else
        PostBoss = "Директор банка";
     end;

        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"ДатаСоставления" , m_Date+" "+string(Time()) );
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"ДолжностьДиректора" , PostBoss + " _____________ " );
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"Директор" ,        {FIO_Boss});
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"ГлавБух" ,         {FIO_Book});
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"НачальникОтдела",  НачальникОтдела() );
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"ДолжностьОперациониста", ДолжностьОперациониста() + " _____________ " );
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"Операционист",     Операционист() );
     else 
        m_ObjWinRep.AddStandardFooter( IsCurDate );
     end;
  END;
*/

  MACRO AddStandardFooter_Reg2014( CellPrefix:STRING, _IsCurDate:BOOL, _IsPrintOperNum:bool )
     var ДолжностьРуководителяПодразделения = "Руководитель подразделения",
         РуководительПодразделения = ""; 

     MACRO ПолучитьПостИИмяРукПодразделения()
         var RS = TRsbDataSet("SELECT party.t_Name, officer.t_Post " +
                              "  FROM dofficer_dbt officer, dparty_dbt party " +
                              " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                              "       officer.t_OfficeID = " + string(SelfDivision) + " AND " +
                              "       officer.t_IsFirstOfficePerson = 'X' AND "
                              "       party.t_PartyID = officer.t_PersonID "
                             );
         if( RS.MoveNext() )
            ДолжностьРуководителяПодразделения = RS.Post;
            РуководительПодразделения = RS.Name;
         end;
     END;

     MACRO ДолжностьОперациониста()
         var RS = TRsbDataSet("SELECT officer.t_Post " +
                              "  FROM dofficer_dbt officer, dperson_dbt person " +
                              " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                              "       person.t_oper = " + string({oper}) + " AND " +
                              "       officer.t_PersonID = person.t_PartyID "
                             );

         if( RS.MoveNext() )
            return string(RS.Post);
         end;
         return "Ответственный сотрудник";
     END;

     var IsCurDate = False, m_Date, PostBoss, IsPrintOperNum = false;
     if( _IsCurDate != NULL )
        IsCurDate = _IsCurDate;
     end;
     if( _IsPrintOperNum != NULL )
        IsPrintOperNum = _IsPrintOperNum;
     end;

     if( m_UseTemplate )
        if( CellPrefix == null )
           CellPrefix = "";
        end;

        ПолучитьПостИИмяРукПодразделения();

        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"ДолжностьРуководителяПодразделения",  ДолжностьРуководителяПодразделения + " _____________ "  );
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"РуководительПодразделения", РуководительПодразделения );
        m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"ДолжностьОперациониста", ДолжностьОперациониста() + " _____________ " );
        if(IsPrintOperNum)
           m_ObjTemplateXLS.SetValue_NameCell( CellPrefix+"Операционист", {Name_Oper} );
        end;
     else 
        m_ObjWinRep.AddStandardFooter( IsCurDate );
     end;
  END;

  MACRO FormulaSUMIF():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "SUMIF";
     else
        RetVal = "СУММЕСЛИ";
     end;

     return RetVal;
  END;

  MACRO FormulaSUM():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "SUM";
     else
        RetVal = "СУММ";
     end;

     return RetVal;
  END;

  MACRO FormulaIF():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "IF";
     else
        RetVal = "ЕСЛИ";
     end;

     return RetVal;
  END;

  MACRO FormulaISNUMBER():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "ISNUMBER";
     else
        RetVal = "ЕЧИСЛО";
     end;

     return RetVal;
  END;

  MACRO FormulaAND():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "AND";
     else
        RetVal = "И";
     end;

     return RetVal;
  END;

  MACRO FormulaOR():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "OR";
     else
        RetVal = "ИЛИ";
     end;

     return RetVal;
  END;

  MACRO FormulaSUMPRODUCT():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "SUMPRODUCT";
     else
        RetVal = "СУММПРОИЗВ";
     end;

     return RetVal;
  END;

  MACRO FormulaROUND():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "ROUND";
     else
        RetVal = "ОКРУГЛ";
     end;

     return RetVal;
  END;

  MACRO FormulaSubtotal():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "SUBTOTAL";
     else
        RetVal = "ПРОМЕЖУТОЧНЫЕ.ИТОГИ";
     end;

     return RetVal;
  END;

  MACRO FormulaDate():string
     var RetVal = "";
     if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )
        RetVal = "DATE";
     else
        RetVal = "ДАТА";
     end;

     return RetVal;
  END;

  PRIVATE MACRO ReplaceSeparator( Str:@string, Separator:string )
     if( DL_DecimalSeparator != Separator )
        var index_ = Index(Str, Separator);
        while ((index_ != 0) and (index_ <= strlen(Str)))
           StrSet(Str, index_, DL_DecimalSeparator);
           index_ = Index(Str, Separator);
        end;
     end;
  END;

  MACRO DL_ReplaceSeparator( Str:@string, Separator:string )
     ReplaceSeparator( @Str, Separator);
  END;

  MACRO GetDL_FORMULA():string
     return DL_FORMULA;
  END;

  MACRO F( Str:string ):string
     /* заменим разделитель целой и дробной частей */
     ReplaceSeparator( @Str, "." );
     ReplaceSeparator( @Str, "," );

     return GetDL_FORMULA() + Str;
  END;

  MACRO ReplaceFormulaAndCalculate()
    if( m_UseTemplate )
      ReplaceAndCalculate(GetDL_FORMULA(), "=");
    end;
  END;

  MACRO ВыводЧерезФормулу(pSum,pPoint)
    var vPoint = 12;

    if( pSum == null )
       return null;
    end;

    if( (pPoint != null) and (pPoint >= 0) and (pPoint <= 12) )
       vPoint = pPoint;
    end;
    /*приводим к money, чтобы числа с кол-вом цифр <=16 не портились*/
    return substr(F(WR_ЧислоCЗаданнойТочностью(money(pSum),vPoint)),strlen(GetDL_FORMULA())+1);/*substr, чтобы не было символа "=" перед числом в строке формул*/
  END;

  //override
  macro SetIFFormulaShort(FirstColumn, SecondColumn, ThirdColumn, Condition) :string
    var Formula:string = "";
    var SheetName:string = "";

    if(m_UseTemplate)
      SheetName = m_ObjTemplateXLS.SheetName();

      if( m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS )  Formula = "IF";
      else                                                                  Formula = "ЕСЛИ";
      end;

      return GetDL_FORMULA() + Formula + "(" + FirstColumn + Condition + ";" + SecondColumn + ";" + ThirdColumn + ")";
    end;
  end;

  InitCB_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI, UseBigReportMode, FocreFormatRep );
  DL_DecimalSeparator = GetLocaleInfo(0,LOCALE_SDECIMAL, m_IsWebService);
END;
