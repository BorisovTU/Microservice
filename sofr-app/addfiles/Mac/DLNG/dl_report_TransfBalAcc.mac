/**
 @file dl_report_TransfBalAcc.mac
 @brief Отчет "Перенос по балансовым счетам" 

 Отчет "Перенос по балансовым счетам"  БО ЦБ/ФИССиКО/УВ/СВ/МБК
 
*/

IMPORT "DLReport_h.mac", "dl_Report_TransfBalAcc_Form.mac", "dl_report_log.mac", oralib, vsbnrfd, mmcateg, dv_categ, "scsrvrepfun.mac";

PRIVATE VAR ReportHeader = 
" ##############################################                                                                        \n" + 
"                                                                                                                       \n" +
"                                    ################################################################################## \n";

PRIVATE VAR TableHeader = 
"┌────────────────────────────────┬──────────────────────────────┬───────────────────────────────────────────┬────────────────────────────┬───────────────────────────────┬───────────────────────────────┬─────────────────────────────┬──────────────────┐\n"+
"│          Номер сделки          │    Дата заключения сделки    │                Вид операции               │             Т/О            │        Счет срочности         │    Срок до исполнения Т/О,    │            Сумма            │      Валюта      │\n"+
"│                                │                              │                                           │                            │                               │           (дней)              │                             │                  │\n"+
"├────────────────────────────────┼──────────────────────────────┼───────────────────────────────────────────┼────────────────────────────┼───────────────────────────────┼───────────────────────────────┼─────────────────────────────┼──────────────────┤";

/**
@brief Символы подсистем
*/
PRIVATE CONST Id_Sec = "S", Id_DV = "Ю", Id_VA = "N", Id_VS = "Y", Id_MBK = "J";

PRIVATE CONST BASIS_30360        = 1,    ///360 дней в году, 30 в месяце
              BASIS_ACT360       = 2,    ///360 дней в году, в месяце по календ.
              BASIS_ACTACT       = 4,    ///в году и в месяце по календарю
              BASIS_ACT365       = 8,    ///в году и в месяце по календарю без учета високосности
              BASIS_31360        = 1001; ///360 дней в году, 31 в месяце

PRIVATE VAR
  m_Date:DATE,            /// ДАта отчета
  m_DepartmentID:INTEGER, /// Депортамент
  IsSec:STRING,           /// По ЦБ
  IsDV:STRING,            /// По ФИССиКО
  IsVA:STRING,            /// По УВ
  IsVS:STRING,            /// По СВ
  IsMBK:STRING,           /// По МБК
  IsApostr:STRING,        /// Признак апострофов
  IsExcel:STRING;         /// Признак выпуска в excel

PRIVATE VAR Report_TransfBalAcc_Form;

/**
@brief Получить имя операциониста
*/
PRIVATE MACRO Операционист()
  var RS = TRsbDataSet("SELECT person.t_Name " +
                       "  FROM dperson_dbt person " +
                       " WHERE person.t_Oper = " + string({oper})
                       );

  if( RS.MoveNext() )
    return RS.Name;
  end;
  return "";
END;

/**
@brief Получить название подсистемы
@param[in] IdentProg Символ подсистемы
*/
PRIVATE MACRO ПолучитьНазваниеПодсист(IdentProg)
  if((IdentProg == Id_Sec))
    return "\"Бэк-офис ценных бумаг\"";
  elif((IdentProg == Id_DV))
    return "\"ФИССиКО\"";
  elif((IdentProg == Id_VA))
    return "\"Учтенные векселя\"";
  elif((IdentProg == Id_VS))
    return "\"CB\"";
  elif((IdentProg == Id_MBK))
    return "\"Межбанк. кредиты\"";
  end;
  return "";
END;

/**
@brief Получить КУ с учетом знака
@param[in] IdentProg Символ подсистемы
@param[in] IsRest Флаг для КУ, по которым проверяем остаток на дату, без учета срочности
*/
PRIVATE MACRO ПолучитьКУсУчетомЗнака(IdentProg, IsRest)
  if((IdentProg == Id_Sec) and IsRest)
  return  "SELECT CAT.T_ID T_CATID, ' ' T_SIGN, CAT.T_CODE " +
          "  FROM DMCCATEG_DBT CAT " +
          " WHERE CAT.T_CODE IN ('ОЭБ%, к погашению', 'ОЭБ%, к исполнению', 'ОЭБ купон, к погашению') ";
  elif((IdentProg == Id_Sec) OR (IdentProg == Id_DV))
  return  "SELECT CAT.T_ID T_CATID, SUBSTR (CAT.T_CODE, 0, 1) T_SIGN, CAT.T_CODE " +
          "  FROM DMCCATEG_DBT CAT " +
          " WHERE CAT.T_CODE IN ('+Форвард,дрейф внебирж ПП','-Форвард,дрейф внебирж ПП', " +
          "                      '+Форвард, дрейф Проц.СВОП','-Форвард, дрейф Проц.СВОП', " +
          "                      '+Форвард, дрейф','-Форвард, дрейф', " +
          "                      '+Форвард, дрейф внебирж','-Форвард, дрейф внебирж', " +
          "                      '+Форвард, дрейф внебирж0','-Форвард, дрейф внебирж0', " +
          "                      '+Форвард, дрейф0', " +
          "                      '+Форвард, дрейф внебирж1','-Форвард, дрейф внебирж1', " +
          "                      '+Форвард, дрейф1','-Форвард, дрейф1', " +
          "                      '+Форвард, ПФИ внебирж','-Форвард, ПФИ внебирж') ";
  elif((IdentProg == Id_VA))
  return  "SELECT CAT.T_ID T_CATID, SUBSTR (CAT.T_CODE, 0, 1) T_SIGN, CAT.T_CODE " +
          "  FROM DMCCATEG_DBT CAT " +
          " WHERE CAT.T_CODE IN ('+Форвард, дрейф','-Форвард, дрейф') ";
  elif((IdentProg == Id_VS)and IsRest)
  return  "SELECT CAT.T_ID T_CATID, ' ' T_SIGN, CAT.T_CODE " +
          "  FROM DMCCATEG_DBT CAT " +
          " WHERE CAT.T_CODE IN ('Свексель к исполнению','Дисконт, СВексель к исп.','Обяз%, СВексель к исп.', 'Обяз%,СВексель') ";
  elif((IdentProg == Id_VS))
  return  "SELECT CAT.T_ID T_CATID, '-' T_SIGN, CAT.T_CODE " +
          "  FROM DMCCATEG_DBT CAT " +
          " WHERE CAT.T_CODE IN ('Наш вексель', 'Дисконт, Свексель') ";
  elif((IdentProg == Id_MBK))
  return  "SELECT CAT.T_ID T_CATID, ' ' T_SIGN, CAT.T_CODE " +
          "  FROM DMCCATEG_DBT CAT " +
          " WHERE CAT.T_CODE IN ('ОД') ";
  end;
  return "";
END;

/**
@brief Стандартный класс отчета
@param[in] Form Форма отчета
@param[in] TemplateName Название шаблона
@param[in] UseCSV 
@param[in] IsWebService вызов из веб-сервиса
@param[in] ReportHashCode 
@param[in] UsePOI Ипользовать пои
*/
PRIVATE CLASS ( DL_CReportTemplate ) DL_Report_TransfBalAcc( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER, UsePOI:BOOL )
    VAR ErrorCount;
    Var CurDate = date(), CurTime = time(),
    m_CurrSheetName = "";
    var CurLog = DL_ReportLog(ReportBIQ8582_TransfBalAcc, CurDate, CurTime, m_Date);
    
    /**
    @brief Вид печати: excel или текстовый файл
    */
    PRIVATE MACRO PrintMode():INTEGER
        if (IsExcel == SET_CHAR)
          return DL_OUTREPORT_EXCEL;
        end;
        return DL_OUTREPORT_STD;
    END;

    /**
    @brief Апострофы в числах
    @param[in] digit Число
    */
    PRIVATE MACRO DigitIsApp(digit)
      if( IsExcel == UNSET_CHAR)
         if(IsApostr == SET_CHAR)
            if(ValType(digit) != V_UNDEF)
              return string(digit:a);
            end;
         else
            return string(digit);
         end;
      else
         return digit;
      end;
    end;

    /**
    @brief Печать строки отчета
    @param[in] A1, A2, A3, A4, A5, A6, A7, A8 данные одной строки отчета
    */
    PRIVATE MACRO PrintLine(A1, A2, A3, A4, A5, A6, A7, A8)
      ErrorCount = ErrorCount + 1;
      PrintTableLine( "N1_A1",  A1,             null,
                      "N1_A2",  A2,             null,
                      "N1_A3",  A3,             null,
                      "N1_A4",  A4,             null,
                      "N1_A5",  A5,             null,
                      "N1_A6",  A6,             null,
                      "N1_A7",  DigitIsApp(A7), null,
                      "N1_A8",  A8,             null);
    END;

    /**
    @brief Проверка остатка счета и вывод в отчет, в случае ошибки
    @param[in] CurRs Текущая обрабатываемые сделка/облигация/вексель
    @param[in] Dост Дата, следующая после погашения, для проверки остатка
    */
    PRIVATE MACRO GetAccRestOutPeriodAndPrint(CurRs, Dост, RetDealID, Qоб)
      var DocID = 0, DocKind = 0;
      if((CurRs.IdentProg == Id_Sec))
        CurLog.AddLogRow("Определение параметра QСОБЛ по выпуску собственных облигаций " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), "выполнено");
        DocID = RetDealID;
        DocKind = 4832;
      elif(CurRs.IdentProg == Id_VS)
        if(Qоб == 0)
          CurLog.AddLogRow("Определение параметра QСВ по векселю " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), "выполнено");
        end;
        DocID = CurRs.DealID;
        DocKind = CurRs.DocKind;
      end;
      if (DocID == 0)
        return;
      end;
      var m_DataQuery_Acc = "SELECT ACCDOC.T_ACCOUNT, " +
                            "       CATEG.T_SIGN, " +
                            "        ABS (RSB_ACCOUNT.RESTAC (ACCDOC.T_ACCOUNT, " +
                            "                                    ACCDOC.T_CURRENCY, " +
                            "                                    ?, " +
                            "                                    ACCDOC.T_CHAPTER, " +
                            "                                    ACCDOC.T_CURRENCY)) REST, " +
                            "        (SELECT FIN.T_CCY " +
                            "           FROM DFININSTR_DBT FIN " +
                            "          WHERE FIN.T_FIID = ACCDOC.T_CURRENCY) CCY" +
                            "  FROM (" + ПолучитьКУсУчетомЗнака(CurRs.IdentProg, true) + ") " +
                            "       CATEG, " +
                            "       DMCACCDOC_DBT ACCDOC " +
                            " WHERE     ACCDOC.T_DOCID = ? " +
                            "       AND ACCDOC.T_DOCKIND = ? " +
                            "       AND ACCDOC.T_CATID = CATEG.T_CATID " +
                            "       AND ABS (RSB_ACCOUNT.RESTAC (ACCDOC.T_ACCOUNT, " +
                            "                                    ACCDOC.T_CURRENCY, " +
                            "                                    ?, " +
                            "                                    ACCDOC.T_CHAPTER, " +
                            "                                    ACCDOC.T_CURRENCY)) > 0 " +
                            "  ORDER BY ACCDOC.T_ACCOUNT, REST";
      var m_DataQuery_exec_Acc = DL_RSDCommand(m_DataQuery_Acc);
      m_DataQuery_exec_Acc.AddParam( Dост);
      m_DataQuery_exec_Acc.AddParam( DocID);
      m_DataQuery_exec_Acc.AddParam( DocKind);
      m_DataQuery_exec_Acc.AddParam( Dост);
      var accountsCount = m_DataQuery_exec_Acc.GetCount();
      if((CurRs.IdentProg == Id_Sec))
        CurLog.AddLogRow("Поиск счетов по выпуску собственных облигаций " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF(accountsCount > 0, "найдены", "не найдено"));
      elif(CurRs.IdentProg == Id_VS)
        CurLog.AddLogRow("Поиск счетов по векселю " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF(accountsCount > 0, "найдены", "не найдено"));
      end;
      var m_RS_Acc = m_DataQuery_exec_Acc.execute();
      while(m_RS_Acc.MoveNext())
        PrintLine(CurRs.DealCode, SQL_ConvTypeDate(CurRs.DealDate), CurRs.Name, "Обязательство", m_RS_Acc.Account, Qоб, m_RS_Acc.REST, m_RS_Acc.CCY);
      end;
    END;

    /**
    @brief Проверка скрочности счетов и вывод в отчет, в случае ошибки
    @param[in] CurRs Текущая обрабатываемые сделка/облигация/вексель
    @param[in] Qт Срок требования
    @param[in] Qоб Срок обязательства
    */
    PRIVATE MACRO GetAccOutPeriodAndPrint(CurRs, Qт, Qоб)
      if(CurRs.IdentProg == Id_VS)
        CurLog.AddLogRow("Определение параметра QСВ по векселю " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF((Qоб != 0), "выполнено", "не выполнено"));
      elif(CurRs.IdentProg == Id_MBK)
        CurLog.AddLogRow("Определение параметра QМБК по сделке " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF((Qт != 0) OR (Qоб != 0), "выполнено", "не выполнено"));
      else
        CurLog.AddLogRow("Определение параметров Qт и Qоб по сделке " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF((Qт != 0) OR (Qоб != 0), "выполнено", "не выполнено"));
      end;
      if((Qт >= 0) OR (Qоб >= 0))
        var m_DataQuery_Acc = "SELECT ACCDOC.T_ACCOUNT, " +
                              "       CATEG.T_SIGN, " +
                              "       CATEG.T_CODE, " +
                              "       PERIOD.T_LOWBOUND, " +
                              "       PERIOD.T_LOWBOUNDUNIT, " +
                              "       PERIOD.T_ISLOWINCLUDE, " +
                              "       PERIOD.T_HIGHBOUND, " +
                              "       PERIOD.T_HIGHBOUNDUNIT, " +
                              "       PERIOD.T_ISHIGHINCLUDE, " +
                              "        ABS (RSB_ACCOUNT.RESTAC (ACCDOC.T_ACCOUNT, " +
                              "                                    ACCDOC.T_CURRENCY, " +
                              "                                    ?, " +
                              "                                    ACCDOC.T_CHAPTER, " +
                              "                                    ACCDOC.T_CURRENCY)) REST, " +
                              "        (SELECT FIN.T_CCY " +
                              "           FROM DFININSTR_DBT FIN " +
                              "          WHERE FIN.T_FIID = ACCDOC.T_CURRENCY) CCY" +
                              "  FROM (" + ПолучитьКУсУчетомЗнака(CurRs.IdentProg, IIF((CurRs.IdentProg == Id_Sec) and (CurRs.DocKind == DLDOC_ISSUE), true, false)) + ") " +
                              "       CATEG, " +
                              "       DMCACCDOC_DBT ACCDOC, " +
                              "       DMCPERIOD_DBT PERIOD " +
                              " WHERE     ACCDOC.T_DOCID = ? " +
                              "       AND ACCDOC.T_DOCKIND = ? " +
                              "       AND ACCDOC.T_CATID = CATEG.T_CATID " +
                              "       AND ACCDOC.T_ISUSABLE = CHR (88) " +
                              "       AND ABS (RSB_ACCOUNT.RESTAC (ACCDOC.T_ACCOUNT, " +
                              "                                    ACCDOC.T_CURRENCY, " +
                              "                                    ?, " +
                              "                                    ACCDOC.T_CHAPTER, " +
                              "                                    ACCDOC.T_CURRENCY)) > 0 " +
                              "       AND PERIOD.T_GROUPNUM = ACCDOC.T_GROUPNUM " +
                              "       AND PERIOD.T_ID = ACCDOC.T_PERIODID ORDER BY ACCDOC.T_ACCOUNT, REST";
        var m_DataQuery_exec_Acc = DL_RSDCommand(m_DataQuery_Acc);
        m_DataQuery_exec_Acc.AddParam( m_Date);
        m_DataQuery_exec_Acc.AddParam( CurRs.DealID);
        m_DataQuery_exec_Acc.AddParam( CurRs.DocKind);
        m_DataQuery_exec_Acc.AddParam( m_Date);
        var accountsCount = m_DataQuery_exec_Acc.GetCount();
        
        if(CurRs.IdentProg == Id_VS)
          if (accountsCount == 0)
            GetAccRestOutPeriodAndPrint(CurRs, m_Date, 0, Qоб);
          else
          CurLog.AddLogRow("Поиск счетов по векселю " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF(accountsCount > 0, "найдены", "не найдено"));
          end;
        else
          CurLog.AddLogRow("Поиск счетов по сделке " + CurRs.DealCode + " модуля " + ПолучитьНазваниеПодсист(CurRs.IdentProg), IIF(accountsCount > 0, "найдены", "не найдено"));
        end;
        
        var m_RS_Acc = m_DataQuery_exec_Acc.execute();
        while(m_RS_Acc.MoveNext())
          
          var MIN_PERIOD = 0, MAX_PERIOD = 0;
          var days = 0, months = 0, years = 0;
          if(m_RS_Acc.LOWBOUNDUNIT == 3)
            if (CurRs.Basis == BASIS_ACTACT)
              DateSplit(SQL_ConvTypeDate(CurRs.DealDate), days, months, years);
              MIN_PERIOD = date(days, months, years + m_RS_Acc.LOWBOUND) - SQL_ConvTypeDate(CurRs.DealDate);
            elif((CurRs.Basis == BASIS_30360) AND (CurRs.Basis == BASIS_31360) AND (CurRs.Basis == BASIS_ACT360))
              MIN_PERIOD = m_RS_Acc.LOWBOUND * 360;
            elif(CurRs.Basis == BASIS_ACT365)
              MIN_PERIOD = m_RS_Acc.LOWBOUND * 365;
            end;
          else
            MIN_PERIOD = m_RS_Acc.LOWBOUND;
          end;
          if (m_RS_Acc.ISLOWINCLUDE == UNSET_CHAR)
          MIN_PERIOD = MIN_PERIOD + 1;
          end;
          
          if(m_RS_Acc.HIGHBOUNDUNIT == 3)
            if (CurRs.Basis == BASIS_ACTACT)
              DateSplit(SQL_ConvTypeDate(CurRs.DealDate), days, months, years);
              MAX_PERIOD = date(days, months, years + m_RS_Acc.HIGHBOUND) - SQL_ConvTypeDate(CurRs.DealDate);
            elif((CurRs.Basis == BASIS_30360) AND (CurRs.Basis == BASIS_31360) AND (CurRs.Basis == BASIS_ACT360))
              MAX_PERIOD = m_RS_Acc.HIGHBOUND * 360;
            elif(CurRs.Basis == BASIS_ACT365)
              MAX_PERIOD = m_RS_Acc.HIGHBOUND * 365;
            end;
          else
            MAX_PERIOD = m_RS_Acc.HIGHBOUND;
          end;
          
          if (m_RS_Acc.ISHIGHINCLUDE == UNSET_CHAR)
            MAX_PERIOD = MAX_PERIOD - 1;
          end;

          if (((m_RS_Acc.SIGN == "+") AND (CurRs.IdentProg != Id_MBK) OR (CurRs.IdentProg == Id_MBK)) AND 
            (Qт >= 0) AND 
            ((MIN_PERIOD > 0) AND (Qт < MIN_PERIOD) OR (MAX_PERIOD > 0) AND (Qт > MAX_PERIOD)))
            PrintLine(CurRs.DealCode, SQL_ConvTypeDate(CurRs.DealDate), CurRs.Name, "Требование", m_RS_Acc.Account, Qт, m_RS_Acc.REST, m_RS_Acc.CCY);
          elif (((m_RS_Acc.SIGN == "-") AND (CurRs.IdentProg != Id_MBK) OR (CurRs.IdentProg == Id_MBK)) AND 
                (Qоб >= 0) AND 
                ((MIN_PERIOD > 0) AND (Qоб < MIN_PERIOD) OR (MAX_PERIOD > 0) AND (Qоб > MAX_PERIOD)))
            PrintLine(CurRs.DealCode, SQL_ConvTypeDate(CurRs.DealDate), CurRs.Name, "Обязательство", m_RS_Acc.Account, Qоб, m_RS_Acc.REST, m_RS_Acc.CCY);
          end;
        end;
      end;
    END;

    /**
    @brief Получение даты началы сдлки МБК с учетом пролонгации
    @param[in] DealID ID Сделки
    @param[in] leg документ сделки
    */
    PRIVATE MACRO GetStartDateMBK(DealID, leg)
      var retVal   = date(0, 0, 0), 
          orleg    = TBFile("dl_leg.dbt");
      var orDealID = 0;
      while (DealID > 0)
        orDealID = DealID;
        DealID  = MM_DefineOriginalID(DealID);
      end;

      if (orDealID > 0)
        orleg.rec.LegKind = LEG_KIND_DL_TICK;
        orleg.rec.DealID  = orDealID;
        orleg.rec.LegID   = 1;
        if (GetEQ(orleg))
          retVal = orleg.rec.Start;
        end;
      else
        retVal = leg.rec.Start;
      end;
      return retVal;
    END;
    
    /**
    @brief Основная обработка данных для отчета: сбор, расчет и вызов проверок
    @param[in] progress счетчик прогресса обработки отчета
    */
    PRIVATE MACRO GetDateAndPrint(progress)
      var m_DataQuery_sel = "";
      var m_DataQuery_ins = "";
      var m_DataQuery_exec;
      var m_RS, m_DataQuery, Query;
      var m_RecsOnDate = 0;
      var result = "";

      execSQL("truncate table DDL_REPORT_TRANSFBALACC_TMP");

      m_DataQuery_ins =     "INSERT INTO DDL_REPORT_TRANSFBALACC_TMP (T_IDENTPROG, " +
                            "           T_DEALID, " +
                            "           T_DOCKIND, " +
                            "           T_DEALCODE, " +
                            "           T_NAME, " +
                            "           T_DEALDATE, " +
                            "           T_BASIS)";
      
      if(IsSec == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT  \'" + Id_Sec + "\', " +
                            "          TICK.T_DEALID, " +
                            "          TICK.T_BOFFICEKIND, " +
                            "          tick.t_dealcode, " +
                            "          oper.t_name, " +
                            "          TICK.T_DEALDATE, " +
                            "          leg.T_BASIS " +
                            "     FROM ddl_tick_dbt tick, DOPRKOPER_DBT oper, DDL_LEG_DBT leg " +
                            "    WHERE     TICK.T_BOFFICEKIND IN ( " + DL_SECURITYDOC + ", " +
                            "                                      " + DL_RETIREMENT + ", " +
                            "                                      " + DL_AVRWRT + ", " +
                            "                                      " + DL_CONVAVR + ", " +
                            "                                      " + DL_INVESTSHARE + ", " +
                            "                                      " + DL_GET_DIVIDEND + ", " +
                            "                                      " + DL_SECUROWN + ", " +
                            "                                      " + DL_AVRWRTOWN + ", " +
                            "                                      " + DL_RETIREMENT_OWN + ") " +
                            "          AND (TICK.T_DEALSTATUS = 10 OR TICK.T_DEALSTATUS = 20 AND TICK.T_CLOSEDATE > ?) " +
                            "          AND (? > 0 AND TICK.T_DEPARTMENT = ? OR ? < 0) " +
                            "          AND TICK.T_CLIENTID = -1 " +
                            "          AND LEG.T_DEALID = TICK.T_DEALID AND LEG.T_LEGKIND =  " + LEG_KIND_DL_TICK +
                            "          AND rsb_secur.IsToday (rsb_secur.get_OperationGroup (rsb_secur.get_OperSysTypes (TICK.t_DealType,TICK.t_BofficeKind))) != 1  " +
                            "          AND TICK.T_DEALDATE < ? " +
                            "          AND ? < (SELECT MIN(RQ.T_PLANDATE) FROM ddlrq_dbt rq WHERE RQ.T_DOCID = TICK.T_DEALID AND RQ.T_DOCKIND = TICK.T_BOFFICEKIND ) " +
                            "          AND OPER.T_KIND_OPERATION = TICK.T_DEALTYPE ";
      end;

      if(IsSec == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ALL ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "SELECT  \'" + Id_Sec + "\', " +
                            "       fin.t_fiid, " +
                            "       " + DLDOC_ISSUE + ", " +
                            "       fin.t_name, " +
                            "       'размещение облигации РСХБ', " +
                            "       fin.t_issued, " +
                            "       0 " + 
                            "  FROM dfininstr_dbt fin " + 
                            " WHERE     fin.t_fi_kind = " + FIKIND_AVOIRISS +
                            "       AND fin.t_avoirkind IN (SELECT t_AvoirKind " +
                            "                                 FROM davrkinds_dbt " +
                            "                                WHERE t_FI_Kind = " + FIKIND_AVOIRISS +
                            "                                  AND t_Root = " + AVOIRISSKIND_BOND + ") " +
                            "       AND fin.t_issuer = " + {OurBank} +
                            "       AND fin.t_issued <= ? " +
                            "       AND fin.t_drawingdate > ? ";
      end;

      if(IsDV == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ALL ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "SELECT \'" + Id_DV + "\', " +
                            "       DVN.T_ID, " +
                            "       DVN.T_DOCKIND, " +
                            "       CASE WHEN DVN.T_EXTCODE = CHR(1)  THEN DVN.T_CODE ELSE DVN.T_EXTCODE END, " +
                            "       oper.t_name, " +
                            "       DVN.T_DATE, " +
                            "       dvnfi.T_BASIS " +
                            "  FROM ddvndeal_dbt dvn, ddvnfi_dbt dvnfi, DOPRKOPER_DBT oper " +
                            " WHERE     DVN.T_DOCKIND IN ( " + DL_DVNDEAL + ", " +  DL_DVFXDEAL + ", " +  DL_DVDEALT3 + ") " +
                            "       AND (       DVN.T_STATE = 2 " +
                            "               AND (CASE " +
                            "                       WHEN     DVNFI.T_SUPLDATE = TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "                            AND DVNFI.T_PAYDATE = TO_DATE ('01/01/0001', 'dd/mm/yyyy') " +
                            "                       THEN " +
                            "                          DVNFI.T_EXECDATE " +
                            "                       WHEN     DVNFI.T_EXECDATE >= DVNFI.T_SUPLDATE " +
                            "                            AND DVNFI.T_EXECDATE >= DVNFI.T_PAYDATE " +
                            "                       THEN " +
                            "                          DVNFI.T_EXECDATE " +
                            "                       WHEN DVNFI.T_SUPLDATE >= DVNFI.T_PAYDATE " +
                            "                       THEN " +
                            "                          DVNFI.T_SUPLDATE " +
                            "                       ELSE " +
                            "                          DVNFI.T_PAYDATE " +
                            "                    END) > ? " +
                            "            OR DVN.T_STATE = 1) " +
                            "       AND (? > 0 AND DVN.T_DEPARTMENT = ? OR ? < 0) " +
                            "       AND DVN.T_CLIENT = -1 " +
                            "       AND DVN.T_PERIODCLS = 3 " +
                            "       AND DVN.T_DATE < ? " +
                            "       AND ? < " +
                            "              (SELECT MAX (T_VALUEDATE) " +
                            "                 FROM (SELECT bact.T_VALUEDATE " +
                            "                         FROM dpmpaym_dbt bact " +
                            "                        WHERE     bact.t_documentid = dvn.t_id " +
                            "                              AND bact.t_dockind = DVN.T_DOCKIND " +
                            "                              AND bact.t_purpose in (1,3) " +
                            "                       UNION ALL " +
                            "                       SELECT CACT.T_VALUEDATE " +
                            "                         FROM dpmpaym_dbt cact " +
                            "                        WHERE     cact.t_documentid = dvn.t_id " +
                            "                              AND cact.t_dockind = DVN.T_DOCKIND " +
                            "                              AND cact.t_purpose in (2,4))) " +
                            "       AND OPER.T_KIND_OPERATION = DVN.T_KIND " +
                            "       AND DVNFI.T_DEALID = DVN.T_ID " +
                            "       AND (   DVN.T_DVKIND IN (3, 4, 6) AND DVNFI.T_TYPE = 2 " +
                            "            OR DVNFI.T_TYPE >= 0) " +
                            "UNION " +
                            "SELECT \'" + Id_DV + "\', " +
                            "       DV.T_ID, " +
                            "       " + DL_DVDEAL + ", " +
                            "       CASE WHEN DV.T_EXTCODE = '' THEN DV.T_CODE ELSE DV.T_EXTCODE END, " +
                            "       oper.t_name, " +
                            "       DV.T_DATE, " +
                            "       4 " +
                            "  FROM ddvdeal_dbt dv,  DOPRKOPER_DBT oper " +
                            " WHERE     (   DV.T_STATE = 1 " +
                            "            OR     DV.T_STATE = 2 " +
                            "           AND     DV.T_AMOUNT > " +
                            "                  (SELECT TURN.T_EXECUTION " +
                            "                    FROM DDVDLTURN_DBT TURN " +
                            "                   WHERE     TURN.T_DEALID = DV.T_ID " +
                            "                     AND TURN.T_DATE = " +
                            "                           (SELECT MAX (TURN_MAX.T_DATE )" +
                            "                              FROM DDVDLTURN_DBT TURN_MAX " +
                            "                             WHERE     TURN_MAX.T_DEALID = DV.T_ID  " +
                            "                               AND TURN_MAX.T_DATE <= ?)))" +
                            "       AND (? > 0 AND DV.T_DEPARTMENT = ? OR ? < 0) " +
                            "       AND DV.T_DATE < ? " +
                            "       AND OPER.T_KIND_OPERATION = DV.T_KIND ";
                          
        
      end;

      if(IsVA == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ALL ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "SELECT \'" + Id_VA + "\', " +
                            "       TICK.T_DEALID, " +
                            "       TICK.T_BOFFICEKIND, " +
                            "       tick.t_dealcode, " +
                            "       oper.t_name, " +
                            "       TICK.T_DEALDATE, " +
                            "       leg.T_BASIS " +
                            "  FROM ddl_tick_dbt tick, DOPRKOPER_DBT oper, DDL_LEG_DBT leg " +
                            " WHERE     TICK.T_BOFFICEKIND = " + DL_VEKSELACCOUNTED  +
                            "       AND (   TICK.T_DEALSTATUS = 10 " +
                            "            OR     TICK.T_DEALSTATUS = 20 " +
                            "               AND TICK.T_CLOSEDATE > ?) " +
                            "       AND TICK.T_CLIENTID = -1 " +
                            "       AND (? > 0 AND TICK.T_DEPARTMENT = ? OR ? < 0) " +
                            "       AND LEG.T_DEALID = TICK.T_DEALID " +
                            "       AND LEG.T_LEGKIND = " + LEG_KIND_DL_TICK +
                            "       AND TICK.T_DEALDATE + 3 <= " +
                            "              (CASE " +
                            "                  WHEN LEG.T_MATURITY <= LEG.T_EXPIRY THEN LEG.T_MATURITY " +
                            "                  ELSE LEG.T_EXPIRY " +
                            "               END) " +
                            "       AND TICK.T_DEALDATE < ? " +
                            "       AND ? < " +
                            "              (CASE " +
                            "                  WHEN LEG.T_MATURITY <= LEG.T_EXPIRY THEN LEG.T_MATURITY " +
                            "                  ELSE LEG.T_EXPIRY " +
                            "               END) " +
                            "       AND OPER.T_KIND_OPERATION = TICK.T_DEALTYPE ";
      end;

      if(IsVS == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ALL ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "SELECT \'" + Id_VS + "\', " +
                            "       bnr.t_bcid, " +
                            "       " + DL_VSBANNER + ", " +
                            "       (bnr.t_bcseries || ' ' || LTRIM (bnr.t_bcnumber, ' ')), " +
                            "       'Выпуск векселя РСХБ', " +
                            "       bnr.T_ISSUEDATE, " +
                            "       leg.T_BASIS " +
                            "  FROM dvsbanner_dbt bnr, DDL_LEG_DBT leg " +
                            " WHERE     bnr.T_ISSUER =  " + {OurBank} +
                            "       AND (   rsb_bill.GetVSBnrStatusOnDate ( " +
                            "                  bnr.t_BCID, " +
                            "                  ?) = " + VSBANNER_STATUS_SENDED  +
                            "            OR rsb_bill.GetVSBnrStatusOnDate ( " +
                            "                  bnr.t_BCID, " +
                            "                  ?) = " + VSBANNER_STATUS_PAWN + ") " +
                            "       AND (? > 0 AND bnr.T_BRANCH = ? OR ? < 0) " +
                            "       AND leg.T_DEALID = bnr.T_BCID " +
                            "       AND leg.T_LEGKIND = " + LEG_KIND_VSBANNER;
        
      end;

      if(IsMBK == SET_CHAR)
        m_DataQuery_sel = m_DataQuery_sel + IIF (m_DataQuery_sel != "", "   UNION ALL ", "");
        m_DataQuery_sel = m_DataQuery_sel +
                            "   SELECT \'" + Id_MBK + "\', " +
                            "       TICK.T_DEALID, " +
                            "       TICK.T_BOFFICEKIND, " +
                            "       tick.t_dealcode, " +
                            "       oper.t_name, " +
                            "       tick.T_DEALDATE, " +
                            "       leg.T_BASIS" +
                            "  FROM ddl_tick_dbt tick, DOPRKOPER_DBT oper, DDL_LEG_DBT leg " +
                            " WHERE     TICK.T_BOFFICEKIND = " + DL_IBCDOC +
                            "       AND (   TICK.T_DEALSTATUS = 10 " +
                            "            OR     TICK.T_DEALSTATUS = 20 " +
                            "               AND TICK.T_CLOSEDATE > ?) " +
                            "       AND (? > 0 AND TICK.T_DEPARTMENT = ? OR ? < 0) " +
                            "       AND TICK.T_DEALTYPE IN (12300, 12305) " +
                            "       AND OPER.T_KIND_OPERATION = TICK.T_DEALTYPE " +
                            "       AND leg.T_DEALID = TICK.T_DEALID " +
                            "       AND leg.T_LEGKIND = " + LEG_KIND_DL_TICK;
      end;
      m_DataQuery_ins = m_DataQuery_ins + m_DataQuery_sel;

      m_DataQuery_exec = RSDCommand(m_DataQuery_ins);
      if (IsSec == SET_CHAR )
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      end;

      if (IsSec == SET_CHAR )
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      end; 

      if (IsDV == SET_CHAR )
      /*dvndeal*/
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      /*dvdeal*/
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      end;

      if (IsVA == SET_CHAR )
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
      end;

      if (IsVS == SET_CHAR )
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      end;

      if (IsMBK == SET_CHAR )
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_Date);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
        m_DataQuery_exec.AddParam( "", RSDBP_IN, m_DepartmentID);
      end;

      m_DataQuery_exec.execute();

      if (IsSec == SET_CHAR )
        m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP WHERE T_IDENTPROG = \'" + Id_Sec + "\' AND T_DOCKIND != " + DLDOC_ISSUE;
        m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
        CurLog.AddLogRow("Поиск сделок модуля \"Бэк-офис ценных бумаг\" с переносом по счетам", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
      end;

      if (IsSec == SET_CHAR )
        m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP WHERE T_IDENTPROG = \'" + Id_Sec + "\' AND T_DOCKIND = " + DLDOC_ISSUE;
        m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
        CurLog.AddLogRow("Поиск выпуска собственных облигаций модуля \"Бэк-офис ценных бумаг\" с переносом по счетам", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
      end;

      if (IsDV == SET_CHAR )
        m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP WHERE T_IDENTPROG = \'" + Id_DV + "\'";
        m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
        CurLog.AddLogRow("Поиск сделок модуля  \"ФИССиКО\" с переносом по счетам", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
      end;

      if (IsVA == SET_CHAR )
        m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP WHERE T_IDENTPROG = \'" + Id_VA + "\'";
        m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
        CurLog.AddLogRow("Поиск сделок модуля \"Учтенные векселя\" с переносом по счетам", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
      end;

      if (IsVS == SET_CHAR )
        m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP WHERE T_IDENTPROG = \'" + Id_VS + "\'";
        m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
        CurLog.AddLogRow("Поиск векселя модуля \"Векселя банка\" с переносом по счетам", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
      end;

      if (IsMBK == SET_CHAR )
        m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP WHERE T_IDENTPROG = \'" + Id_MBK + "\'";
        m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
        CurLog.AddLogRow("Поиск сделок модуля \"Межбанк. кредиты\" с переносом по счетам", IIF(m_RecsOnDate > 0, "найдены", "не найдено"));
      end;

      m_DataQuery = "SELECT * FROM DDL_REPORT_TRANSFBALACC_TMP ORDER BY T_DEALCODE";
      m_RecsOnDate = SQL_GetNRecs( m_DataQuery );
       
      if(m_RecsOnDate > 0)
        m_RS = TRsbDataSet( m_DataQuery );
        while(m_RS.MoveNext())
          var fininstr = Trechandler( "fininstr.dbt" );
          var Qт = -1, Qоб = -1, Dост = date(0,0,0), Dост2 = date(0,0,0), RetDealID = 0, RetDealID2 = 0;
          var m_DataQuery_RQ;
          var m_DataQuery_exec_RQ;
          var m_RS_RQ ;
          var m_DataQuery_Ret,m_DataQuery_exec_Ret, m_RS_Ret; 
          var FD = NULL;
          if ((m_Rs.IdentProg == Id_Sec) and (m_Rs.DocKind != DLDOC_ISSUE))
            m_DataQuery_RQ = "SELECT * FROM DDLRQ_DBT RQ WHERE T_DOCID = ? AND T_DOCKIND = ?";
            m_DataQuery_exec_RQ = DL_RSDCommand(m_DataQuery_RQ);
            m_DataQuery_exec_RQ.AddParam(m_RS.DealID);
            m_DataQuery_exec_RQ.AddParam(m_RS.DocKind);
            m_RS_RQ = m_DataQuery_exec_RQ.execute();
            while(m_RS_RQ.MoveNext())
              if (m_RS_RQ.Kind == DLRQ_KIND_REQUEST) /*требование*/
                Qт = GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.PlanDate), 0) - m_Date; 
              elif (m_RS_RQ.Kind == DLRQ_KIND_COMMIT) /*обязательство*/
                Qоб = GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.PlanDate), 0) - m_Date; 
              end;
            end;
          elif ((m_Rs.IdentProg == Id_Sec) and (m_Rs.DocKind == DLDOC_ISSUE))
            
            if( ПолучитьФинИн( m_RS.DealID, fininstr, NULL) != 0 ) 
              continue;
            end;
            Qоб = fininstr.rec.DrawingDate - fininstr.rec.Issued;
            m_DataQuery_RQ =  "SELECT fiw.t_drawingdate drawingdate, t_number number_coupon FROM DFIWARNTS_DBT fiw WHERE fiw.t_FIID = ? AND fiw.t_drawingdate = (" +
                              "SELECT max(fiw1.t_drawingdate) FROM DFIWARNTS_DBT fiw1 WHERE fiw1.t_FIID = fiw.t_FIID  AND fiw1.t_drawingdate < ?) ";
            m_DataQuery_exec_RQ = DL_RSDCommand(m_DataQuery_RQ);
            m_DataQuery_exec_RQ.AddParam(m_RS.DealID);
            m_DataQuery_exec_RQ.AddParam(m_Date);
            m_RS_RQ = m_DataQuery_exec_RQ.execute();
            if(m_RS_RQ.MoveNext())
              Dост = IIF(IsWorkDay(SQL_ConvTypeDate(m_RS_RQ.drawingdate)),SQL_ConvTypeDate(m_RS_RQ.drawingdate),GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.drawingdate), 0))  + 1;
              m_DataQuery_Ret = "SELECT tick.t_dealid FROM DDL_TICK_DBT tick WHERE tick.t_PFI = ? AND tick.t_number_coupon = ? and T_BOFFICEKIND = 4832";
              m_DataQuery_exec_Ret = DL_RSDCommand(m_DataQuery_Ret);
              m_DataQuery_exec_Ret.AddParam(m_RS.DealID);
              m_DataQuery_exec_Ret.AddParam(m_RS_RQ.Number_coupon);
              m_RS_Ret = m_DataQuery_exec_Ret.execute();
              if(m_RS_Ret.MoveNext())
                 RetDealID =  m_RS_Ret.dealid;
              end;
            end;
            m_DataQuery_RQ =  "SELECT fiw.t_drawingdate drawingdate, t_number number_coupon FROM DFIWARNTS_DBT fiw WHERE fiw.t_FIID = ? AND fiw.t_drawingdate = (" +
                              "SELECT min(fiw1.t_drawingdate) FROM DFIWARNTS_DBT fiw1 WHERE fiw1.t_FIID = fiw.t_FIID  AND fiw1.t_drawingdate >= ?) ";
            m_DataQuery_exec_RQ = DL_RSDCommand(m_DataQuery_RQ);
            m_DataQuery_exec_RQ.AddParam(m_RS.DealID);
            m_DataQuery_exec_RQ.AddParam(m_Date);
            m_RS_RQ = m_DataQuery_exec_RQ.execute();
            if(m_RS_RQ.MoveNext())
              Dост2 = GetDateAfterWorkDays(IIF(IsWorkDay(SQL_ConvTypeDate(m_RS_RQ.drawingdate)),SQL_ConvTypeDate(m_RS_RQ.drawingdate),GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.drawingdate), 0)), -1);
              m_DataQuery_Ret = "SELECT tick.t_dealid FROM DDL_TICK_DBT tick WHERE tick.t_PFI = ? AND tick.t_number_coupon = ? and T_BOFFICEKIND = 4832";
              m_DataQuery_exec_Ret = DL_RSDCommand(m_DataQuery_Ret);
              m_DataQuery_exec_Ret.AddParam(m_RS.DealID);
              m_DataQuery_exec_Ret.AddParam(m_RS_RQ.Number_coupon);
              m_RS_Ret = m_DataQuery_exec_Ret.execute();
              if(m_RS_Ret.MoveNext())
                 RetDealID2 =  m_RS_Ret.dealid;
              end;
            end;
          elif(m_Rs.IdentProg == Id_DV)
            if (m_Rs.DocKind == DL_DVDEAL)
                FD = DVFirstDocDeal(DL_DVDEAL, m_RS.DealID);
                if( ПолучитьФинИн( FD.Deal.rec.FIID, fininstr, NULL) != 0 ) 
                    continue;
                end;
                Qоб = fininstr.rec.DrawingDate - m_Date;
                Qт = fininstr.rec.DrawingDate - m_Date;
            else
                m_DataQuery_RQ = "SELECT pmpaym.* FROM dpmpaym_dbt pmpaym WHERE pmpaym.t_documentid = ? AND pmpaym.t_dockind = ? AND pmpaym.t_purpose IN (1, 2)";
                m_DataQuery_exec_RQ = DL_RSDCommand(m_DataQuery_RQ);
                m_DataQuery_exec_RQ.AddParam(m_RS.DealID);
                m_DataQuery_exec_RQ.AddParam(m_RS.DocKind);
                m_RS_RQ = m_DataQuery_exec_RQ.execute();
                while(m_RS_RQ.MoveNext())
                  if (m_RS_RQ.Purpose == 1) /*требование*/
                    Qт = GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.ValueDate), 0) - m_Date; 
                  elif (m_RS_RQ.Purpose == 2) /*обязательство*/
                    Qоб = GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.ValueDate), 0) - m_Date; 
                  end;
                end;
            end;
          elif(m_Rs.IdentProg == Id_VA)
            m_DataQuery_RQ = "SELECT pmpaym.* FROM dpmpaym_dbt pmpaym WHERE pmpaym.t_documentid = ? AND pmpaym.t_dockind = ? AND pmpaym.t_purpose IN (1, 2)";
            m_DataQuery_exec_RQ = DL_RSDCommand(m_DataQuery_RQ);
            m_DataQuery_exec_RQ.AddParam(m_RS.DealID);
            m_DataQuery_exec_RQ.AddParam(m_RS.DocKind);
            m_RS_RQ = m_DataQuery_exec_RQ.execute();
            while(m_RS_RQ.MoveNext())
              if (m_RS_RQ.Purpose == 1) /*требование*/
                Qт = GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.ValueDate), 0) - m_Date; 
              elif (m_RS_RQ.Purpose == 2) /*обязательство*/
                Qоб = GetDateAfterWorkDays(SQL_ConvTypeDate(m_RS_RQ.ValueDate), 0) - m_Date; 
              end;
            end;
          elif(m_Rs.IdentProg == Id_VS)
            FD = VSBannerFD( DL_VSBANNER, m_RS.DealID );
            var D2: date = date(0,0,0);
            var MaturityDate: Date = Date(0,0,0);
            
            if (FD.GetBnr().rec.BCTermFormula == VS_TERMF_ATSIGHT)
              if (FD.GetLeg().rec.Maturity >= FD.GetLeg().rec.Start)
                D2 = FD.GetLeg().rec.Maturity;
              end;
            elif ((FD.GetBnr().rec.BCTermFormula == VS_TERMF_FIXEDDAY) OR (FD.GetBnr().rec.BCTermFormula == VS_TERMF_INATIME))
              D2 = FD.GetLeg().rec.Maturity;
            elif(FD.GetBnr().rec.BCTermFormula == VS_TERMF_DURING)
              MaturityDate = IIF(FD.GetBnr().rec.RepaymentDate != date(0,0,0), FD.GetBnr().rec.RepaymentDate, FD.GetBnr().rec.BCPresentationDate + FD.GetLeg().rec.Diff);
            end;

            if ((FD.GetLeg().rec.Start <= m_Date) and (m_Date < D2))
              Qоб = D2 - FD.GetBnr().rec.IssueDate;
              if (m_Date == (D2 - 1)) 
                Dост = m_Date;
              end;
            elif( (FD.GetBnr().rec.BCTermFormula == VS_TERMF_DURING) and 
                  (FD.GetBnr().rec.BCPresentationDate <= m_Date) and 
                  (m_Date < MaturityDate))
              Qоб = MaturityDate - FD.GetLeg().rec.BCPresentationDate;
              if (m_Date != MaturityDate)
                Dост = m_Date;
              end;
            end;
          elif(m_Rs.IdentProg == Id_MBK)
            FD = MMFirstDoc(DL_IBCDOC, m_RS.DealID , false);
            if (Index(m_Rs.Name, "привлечение") > 0)
              Qт = FD.GetLeg().Start + Int(FD.GetLeg().Duration) - GetStartDateMBK(m_RS.DealID, FD.GetLeg());
            else
              Qоб = FD.GetLeg().Start + Int(FD.GetLeg().Duration) - GetStartDateMBK(m_RS.DealID, FD.GetLeg());
            end;
          end;
          GetAccOutPeriodAndPrint(m_RS, Qт, Qоб);
          if(m_Rs.IdentProg == Id_DV)
            if (m_Rs.DocKind == DL_DVNDEAL)
              m_DataQuery_RQ = "SELECT pmgr.* FROM DV_DVNPMGR pmgr WHERE pmgr.t_type = 3 and pmgr.t_dealid = ? AND pmgr.t_begdate < ?";
              m_DataQuery_exec_RQ = DL_RSDCommand(m_DataQuery_RQ);
              m_DataQuery_exec_RQ.AddParam(m_RS.DealID);
              m_DataQuery_exec_RQ.AddParam(m_Date);
              m_DataQuery_exec_RQ.AddParam(m_Date);
              m_RS_RQ = m_DataQuery_exec_RQ.execute();
              while(m_RS_RQ.MoveNext())
                if(m_RS_RQ.side == 1)
                  Qоб = IIF( (SQL_ConvTypeDate(m_RS_RQ.PayDate) - m_Date) >= 0, SQL_ConvTypeDate(m_RS_RQ.PayDate) - m_Date, 0);
                else
                  Qт = IIF( (SQL_ConvTypeDate(m_RS_RQ.PayDate) - m_Date) >= 0, SQL_ConvTypeDate(m_RS_RQ.PayDate) - m_Date, 0);
                end;
                var tmp = m_Rs;
                tmp.DealID = m_RS_RQ.ID;
                tmp.DocKind = DL_DVNDEALPMGR;
                GetAccOutPeriodAndPrint(tmp, Qт, Qоб); 
              end;
            end;
          end;
          if((Dост != date(0,0,0)) OR (Dост2 != date(0,0,0)))
            if(((m_Rs.IdentProg == Id_VS) OR ((m_Rs.IdentProg == Id_Sec) and (m_Rs.DocKind == DLDOC_ISSUE))))
              if ((Dост2 != date(0,0,0)) AND (Dост <= m_Date)) 
                GetAccRestOutPeriodAndPrint(m_RS, Dост, RetDealID, 0);
              end;
              if ((Dост2 != date(0,0,0)) AND (Dост2 >= m_Date)) 
                GetAccRestOutPeriodAndPrint(m_RS, m_Date, RetDealID2, 0);
              end;
            end;
          end;
          progress = progress + 1;
          UseProgress(progress);
        end;
      end;
    END;

    /**
    @brief Начало формирования отчета (стандратный)
    @param[in] NumCopy Количество копий
    */
    PRIVATE MACRO BeginReport( NumCopy:INTEGER )
      m_CurrSheetName = "Отчет";

      Dl_CallInsertStat( PrintMode() );

      SetActiveSheet (m_CurrSheetName);
      CreateTotalBook();

    END;
    
    /**
    @brief Формирование отчета: заголовок, регистрация таблица, завершение таблицы (стандратный)
    @param[in] NumCopy Количество копий
    */
    PRIVATE MACRO Create( NumCopy:INTEGER )
        var progress = 0;
        ErrorCount = 0;

        CurLog.BeginLogging();

        PrintFormatString(ReportHeader,
                     "N1_DateTime",  " Перенос по балансовым счетам _ " + ZeroInFirst(CurDate, true) + " " + ZeroInFirst(CurTime, false),
                     "N1_TitleDate", "Отчет по переносам по балансовым счетам (для всех модулей СОФР) за дату " + ZeroInFirst(m_Date, true));
        CopyAllSheetInTotalBook(m_CurrSheetName, false, "N1_Header", 0, m_CurrSheetName);
        InitProgress( -1, "Идет формирование отчета", "Формирование отчета Перенос по балансовым счетам за " + m_Date);
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_TableHeader", 0, m_CurrSheetName, true );
        RegisterTable( "N1_TableData", TableHeader,
                       "N1_A1", "N1_A2", "N1_A3", "N1_A4", "N1_A5", "N1_A6");
        GetDateAndPrint(progress);
        CurLog.EndLoggingTable();
        CurLog.EndLogging();
        if ( ErrorCount > 0)
          EndTable();
          CopyAllSheetInTotalBook( m_CurrSheetName, false, GetTableRange(), 0, m_CurrSheetName, true );
          CurLog.ErrorHistoryRec();
        end;
        RemProgress();

        PrintFormatString(NULL,
                     "N1_Error", "Ошибок: " + ErrorCount);
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_Error", 0, m_CurrSheetName, true );
        PrintFormatString(NULL,
                     "N1_Executor", "Исполнитель " + Операционист());
        CopyAllSheetInTotalBook( m_CurrSheetName, false, "N1_Executor", 0, m_CurrSheetName, true );
    END;
    
    /**
    @brief Окончание отчета (стандратный)
    @param[in] NumCopy Количество копий
    */
    PRIVATE MACRO EndReport( NumCopy:INTEGER )
      SaveTotalBook();
    END;

    /**
    @brief Вывод отчета на экран (стандратный)
    @param[in] NumCopy Количество копий
    */
    PRIVATE MACRO CReport_Show( NumCopy:INTEGER )
      SetLastTotalBookName("Report_TransfBalAcc_" + 
                    ПолучитьДатуВСтроке(m_Date) + "_" + StrSubst(StrSubst(string(date()),".",""), " ", "") + StrSubst(string(time()),":",""));
      CReport_Show(NumCopy);
    end;

     initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, UsePOI );
END;

/**
@brief Запуск отчета: панель, формирование
*/
MACRO RunReport()

  var stat = true;

  Report_TransfBalAcc_Form = DL_Report_TransfBalAcc_Form();
   
  while(stat)
    stat = Report_TransfBalAcc_Form.Run();
   
     // Проверяем можем ли мы делать отчет по предоставленным данным
    if (not stat)
      break;
    else
      m_DepartmentID  = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_DEPARTCODE );
      m_Date          = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_DATE );
      IsSec           = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_SEC );
      IsDV            = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_DV );
      IsVA            = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_VA );
      IsVS            = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_VS );
      IsMBK           = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_MBK );
      IsApostr        = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_ISAPOSTR );
      IsExcel         = Report_TransfBalAcc_Form.GetFieldValue( PNFLD_TRANSFBALACC_EXCEL );
    end;
   
    if( stat )
      var namefiles;
      var i = 0;  
      var Report_TransfBalAcc = DL_Report_TransfBalAcc( null, "Report_TransfBalAcc.xlsx", null, null, null, true );   
      Report_TransfBalAcc.setisshowAppl(false);    
      Report_TransfBalAcc.Run();
      namefiles = Report_TransfBalAcc.GetFullReportFileNames();
      Report_TransfBalAcc = NULL;
      for(i, namefiles)       
        СохранениеКонтрольныхОтчетов(i, ПолучитьДатуВСтроке(m_Date));
        ВыгрузкаКонтрольныхОтчетов(i);
        if (IsExcel == SET_CHAR)
          //CDAOMSExcel(i,true).Show();
          var fileName, fileExt;
          var filePath = SplitFile(i, fileName, fileExt);

          if( not isStandAlone() )
            filePath = "$" + filePath;
          end;

          SC_ShowFile(filePath, fileName+fileExt, true);
        end;
      end;
    end;
  end;

END;

RunReport();
exit(1); 