/*
$Name:        dlclordio.mac
$Module:      Ядро Securities
$Description: Отчет "Поручения на вывод/зачисление клиентских средств"
*/

IMPORT FIInter,"DLReport_h.mac";

import SecInter, DealsInter, SfInter, "sp_class.mac", "spRepFun.mac", "DVRepFun2.mac";
IMPORT "dlclordio_form.mac";
import "or_rep_h.mac";
import or_tpl_h;
import or_const;

var csvFile, fName, csvTable, printEngine;
PRIVATE VAR  m_Form = DL_Clordio_Panel();

macro initRep()
		   printEngine = CTemplateSXLSX(NULL);

         if(printEngine.UsePoi())
            printEngine.SetXLSXFormat();
         end;

         printEngine.CreateTotalBook();
         printEngine.OpenTemplate("Report_dlclordio.xlsx", true);
         printEngine.SheetChange(1);

         csvTable = printEngine.RegisterTable("templateTable", "templateTableHeader", true);

         csvFile = C_CSVFile();

         if (printEngine.UsePoi())
             csvFile.SetLimitRow(FLUSH_COUNT_XLSX);
         end;
         fName = csvFile.CreateFullFileName("Report_dlclordio_csv.txt");
         csvFile.FileOpen(fName, true);
end;

private macro TableFooter( Data )
  record rClient(party);
  file   FOfficer( "officer" ) key 1;
  file   person("person");

  var ClientName = "", BrokerName = "";
  /*Уполномоченный сотрудник клиента*/
  if( not ПолучитьСубъекта( Data.ClientID, rClient) )
    if( rClient.LegalForm == 2 ) /* Если физ лицо то ФИО*/
      ClientName = rClient.ShortName;
    else /*Сотрудник с признаком директор*/
      clearrecord( FOfficer );
      FOfficer.PartyID = rClient.PartyID;
      FOfficer.IsFirstPerson = SET_CHAR;
      if( GetEQ(FOfficer) AND not ПолучитьСубъекта( FOfficer.PersonID, rClient))
         ClientName = rClient.ShortName;
      end;
    end;
  end;
  /*уполномоченный сотрудник брокера*/
  ClearRecord( person );
  person.oper = Data.OperID;
  if( GetEQ(person) ) 
     BrokerName = person.Name;
  end;
      printEngine.SetValue_NameCell("ClientName", ClientName);
      printEngine.SetValue_NameCell("curdate", MakeStrDate({curdate}));
      printEngine.SetValue_NameCell("BrokerName", BrokerName);
end;

macro showRep(Data)
  		csvFile.FileClose();
      csvTable.FillTabelFromCSV(csvFile.GetlsFileName());
      csvTable.EndTable();
      printEngine.CopyAllSheetInTotalBook(null, false, csvTable.GetTableRange(), 0, "Отчет");
      TableFooter(Data);
      printEngine.CopyAllSheetInTotalBook(null, false, "templateFooter", 0, "Отчет");
      printEngine.Close();
      printEngine.SaveTotalBook();
end;

PRIVATE MACRO GetDataFromFormFields()

   DlClordioRepFormData.ClientCode     = m_Form.GetFieldValue( PNFLD_CLORDIO_CLIENT_CODE           );
   DlClordioRepFormData.ClientName     = m_Form.GetFieldValue( PNFLD_CLORDIO_CLIENT_NAME           );
   DlClordioRepFormData.IsForm         = m_Form.GetFieldValue( PNFLD_CLORDIO_ISFORM                );
   DlClordioRepFormData.FormSub        = m_Form.GetFieldValue( PNFLD_CLORDIO_FORMSUB               );
   DlClordioRepFormData.IsVid          = m_Form.GetFieldValue( PNFLD_CLORDIO_ISVID                 );
   DlClordioRepFormData.VidSub         = m_Form.GetFieldValue( PNFLD_CLORDIO_VIDSUB                );
   DlClordioRepFormData.Noresident     = m_Form.GetFieldValue( PNFLD_CLORDIO_NORESIDENT            );
   DlClordioRepFormData.ServKind_BO    = m_Form.GetFieldValue( PNFLD_CLORDIO_SERVICE_KIND_BO       );
   DlClordioRepFormData.ServKind_DV    = m_Form.GetFieldValue( PNFLD_CLORDIO_SERVICE_KIND_DV       );
   DlClordioRepFormData.ServKind_VA    = m_Form.GetFieldValue( PNFLD_CLORDIO_SERVICE_KIND_VA       );
   DlClordioRepFormData.ContrName      = m_Form.GetFieldValue( PNFLD_CLORDIO_CONTR_NAME            );
   DlClordioRepFormData.OperConclusion = m_Form.GetFieldValue( PNFLD_CLORDIO_OPERATIONS_CONCLUSION );
   DlClordioRepFormData.OperTransfer   = m_Form.GetFieldValue( PNFLD_CLORDIO_OPERATIONS_TRANSFER   );
   DlClordioRepFormData.OperPlanned    = m_Form.GetFieldValue( PNFLD_CLORDIO_PRINT_OPERATIONS_PLANNED    );
   DlClordioRepFormData.BegDate        = m_Form.GetFieldValue( PNFLD_CLORDIO_BEGINDATE             );
   DlClordioRepFormData.EndDate        = m_Form.GetFieldValue( PNFLD_CLORDIO_ENDDATE               );
   DlClordioRepFormData.OperNum        = m_Form.GetFieldValue( PNFLD_CLORDIO_OPER_NUM              );
   DlClordioRepFormData.OperName       = m_Form.GetFieldValue( PNFLD_CLORDIO_OPER_NAME             );
   DlClordioRepFormData.IsUseApp       = m_Form.GetFieldValue( PNFLD_CLORDIO_WITH_APP              );
   DlClordioRepFormData.IsExportToExel = m_Form.GetFieldValue( PNFLD_CLORDIO_TO_EXEL               );
  
END;

private var _ReportRun = false;
private var IsApp = true;

/* Структура с исходными данными */
class SourceData( _ClientID: integer,
                  _IsFormID:integer,
                  _FormSubID:integer,
                  _IsVidID:integer,
                  _VidSubID:integer,
                  _NoResident:bool, 
                  _ContrID: integer,
                  _PrintOut: bool, 
                  _PrintIn: bool, 
                  _PrintPlan: bool, 
                  _dateMin: date,
                  _dateMax: date,
                  _OperID:integer,
                  _apostrSum: bool,
                  _ServKind_BO: bool,
                  _ServKind_DV: bool,
                  _ServKind_VA: bool ) 

   var 
       ClientID      = _ClientID,
       IsFormID      = _IsFormID,
       FormSubID     = _FormSubID,
       IsVidID       = _IsVidID,
       VidSubID      = _VidSubID,
       NoResident    = _NoResident,
       ContrID       = _ContrID,
       PrintOut      = _PrintOut, 
       PrintIn       = _PrintIn, 
       PrintPlan     = _PrintPlan, 
       dateMin       = _dateMin,
       dateMax       = _dateMax,
       OperID        = _OperID,
       apostrSum     = _apostrSum,
       ServKind_BO   = _ServKind_BO,
       ServKind_DV   = _ServKind_DV,
       ServKind_VA   = _ServKind_VA;

   var CurDate, ContractNumber, ContractDate;

   var ArrayCarry = TArray;

   var IsApp = this.apostrSum;

end;

class ArrayCarry( Data, _NumberCarry, _TimeCarry, _ClientID, _FIID, _Account, _Account2, _AccountName2, _Sum, _OperName, _Ground, _Oper, _DocState, _SPGroundID, _RegistrDate, _ClientName, _ContractNumber, _ContractDate, _BrokerName )

  var NumberCarry = _NumberCarry,
      TimeCarry   = _TimeCarry,
      ClientID    = _ClientID, 
      FIID        = _FIID, 
      Account     = _Account,
      Account2    = _Account2,
      AccountName2= _AccountName2,
      Sum         = _Sum,
      OperName    = _OperName,
      Ground      = _Ground,
      Oper        = _Oper,
      DocState    = _DocState,
      SPGroundID  = _SPGroundID,
      RegistrDate = _RegistrDate,
      ClientName  = _ClientName,
      ContractNumber = _ContractNumber,
      ContractDate = _ContractDate,
      BrokerName  = _BrokerName;
end;

private macro cmpDataAscendingOrder( key, elem )

  if( key.NumberCarry > elem.NumberCarry ) return 1;  end;
  if( key.NumberCarry < elem.NumberCarry ) return -1; end;

  return 0;
end;


 private macro PrintHeader()
   printEngine.SetValue_NameCell("templateTitle", "Журнал регистрации поручений(требований) клиентов № 1");
   printEngine.CopyAllSheetInTotalBook(null, false, "templateHeader", 0, "Отчет");
 end;

private macro PrintLine1 (Numb:String, TimeCarry:time, OperName:string, Account:string, Account1:string, AccountName:string, Sum1, FIID:string,CurDate:date,
                          Client,
                          ClientCode,
                          ContractNumber,
                          ContractDate,
                          BrokerName,
                          OrdState,
                          method,
                          RegistrDate )

   csvFile.AddCell(Numb);
   csvFile.AddCell(String(RegistrDate));
   csvFile.AddCell(String(TimeCarry));
   csvFile.AddCell(Client);
   csvFile.AddCell(String(ContractNumber+" от "+String(ContractDate)));
   csvFile.AddCell(BrokerName);
   csvFile.AddCell(OrdState);
   csvFile.AddCell(method);
   csvFile.AddCell(" ");
   csvFile.AddCell(" ");
   csvFile.AddRow();
end;



private macro НомерПоручения( GroundID )

   var sqlQuery, SqlSelect, Select;

   sqlQuery = " SELECT spground.T_XLD " +
              " FROM dspground_dbt spground " + 
             " WHERE spground.T_SPGROUNDID = ? "  ;

   SqlSelect = RSDCommand( sqlQuery );
   SqlSelect.addParam( "", RSDBP_IN, GroundID );
   SqlSelect.execute();
   Select =  TRsbDataSet( SqlSelect );

   if( Select.MoveNext() )
      return Select.XLD;
   end;

   return null;
end;

private macro СпособПодачиПоручения( GroundID )

   var sqlQuery, SqlSelect, Select;

   sqlQuery = " SELECT (select t_sznamealg from dnamealg_dbt where t_itypealg = 3172 and t_inumberalg = spground.t_methodapplic) methodapplic " +
              " FROM dspground_dbt spground " + 
             " WHERE spground.T_SPGROUNDID = ? "  ;

   SqlSelect = RSDCommand( sqlQuery );
   SqlSelect.addParam( "", RSDBP_IN, GroundID );
   SqlSelect.execute();
   Select =  TRsbDataSet( SqlSelect );

   if( Select.MoveNext() )

      if(not Select.methodapplic)
         return "";
      end;

      return Select.methodapplic;
   end;

   return "";
end;

private macro PrintLine( Data, ArrayStr )   
   file person("person");

   var ClientCode = "";
   var BrokerName = "";
   var OrdState = "";

   if((ValType(ArrayStr.BrokerName) != V_UNDEF) and (ArrayStr.BrokerName != ""))
     BrokerName = ArrayStr.BrokerName;
   else;
     ClearRecord( person );
     person.oper = ArrayStr.Oper;
     if( GetEQ(person) ) 
       BrokerName = person.Name;
     end;
   end;

   if(ArrayStr.DocState == 0)
     OrdState = "Зарегистрировано";
   elif(ArrayStr.DocState == 2)
     OrdState = "Исполнено";
   end;

   var Sum1;
   var Numb = "";  
var СпособПодачи =  СпособПодачиПоручения(ArrayStr.SPGroundID);
   Sum1 = IIF(ArrayStr.Sum, ArrayStr.Sum, "" );
   Numb = IIF(ArrayStr.NumberCarry, ArrayStr.NumberCarry, "");
   PrintLine1 (Numb, ArrayStr.TimeCarry, ArrayStr.OperName, ArrayStr.Account,ArrayStr.Account2, ArrayStr.AccountName2, Sum1, ArrayStr.FIID, Data.CurDate,
               ArrayStr.ClientName, 
               ClientCode,
               ArrayStr.ContractNumber,
               ArrayStr.ContractDate,
               BrokerName,
               OrdState,
              СпособПодачи,
               ArrayStr.RegistrDate
      );

end;

private macro PrintData(Data )

    var StrNum = 0;      /*Номер строки в отчете*/


   /*печатаем поручения*/   
   while(StrNum < Data.ArrayCarry.Size)

     _ReportRun = true;
     PrintLine( Data, Data.ArrayCarry[StrNum]);
     StrNum = StrNum + 1;

   end;     

end;

private macro ПолучитьPO( Data )

  var sqlQuery, strBOFFICE = "", strOPERTYPE = "", First:bool = true;

  sqlQuery = " SELECT acc.T_CLIENT, acc.T_CLIENTCONTR, acc.T_DATE, acc.T_VALUEDATE, acc.T_ID, acc.T_Ground, sfcontr.T_Number, sfcontr.T_DateConc,NVL( spground.t_AltXLD, '')t_AltXLD, " +
             "        acc.T_SUM, acc.t_FiKind, acc.t_FIID, inacc.t_KredAcc, inacc.t_DebAcc,  acc.t_Oper, inacc.t_Chapter, lvalues.t_Name NameOper, acc.T_DOCSTATE, spground.t_SPGroundID, " +
             "        spground.t_registrdate, spground.t_registrtime, '' as BrokerName "
             "   FROM ddl_acc_dbt acc " +
             "   left outer join  dsfcontr_dbt sfcontr "  +
             "     on  sfcontr.T_ID = acc.T_CLIENTCONTR  " +
             "   inner join ddlinacc_dbt inacc " +
             "     on inacc.t_DealKind =  acc.t_DocKind " +        
             "       AND inacc.t_DocumentID = acc.t_ID "  +
             "       AND inacc.t_FIID = acc.t_FIID " +
             "       AND inacc.t_Opertype = acc.t_Opertype " +
             "       AND rownum = 1 "  
             "   left outer join  dspground_dbt spground " +
             "     on spground.t_SPGroundID = acc.T_GROUND " + 
             "   left outer join dllvalues_dbt lvalues " + 
             "     on lvalues.T_LIST = " + string(OBJTYPE_CALCOPKIND) +
             "       and lvalues.T_ELEMENT = inacc.T_OPERTYPE " +
             "   left outer join  dparty_dbt Pt " +
             "     on  Pt.T_PARTYID = acc.T_CLIENT  "+
             "  WHERE acc.T_OPERTYPE in ( 1, 2, 3, 4, 5, 6, 7 ) " +
             "    AND acc.T_BOFFICE in( ";


  if( Data.ServKind_BO == true )
     if( not First )
        sqlQuery = sqlQuery + ",";
     end;
     sqlQuery = sqlQuery + "?";
     First = false;
  end;

  if( Data.ServKind_DV == true )
     if( not First )
        sqlQuery = sqlQuery + ",";
     end;
     sqlQuery = sqlQuery + "?";
     First = false;
  end;

  if( Data.ServKind_VA == true )
     if( not First )
        sqlQuery = sqlQuery + ",";
     end;
     sqlQuery = sqlQuery + "?";
     First = false;
  end;

  sqlQuery = sqlQuery + ") ";

  if(Data.ClientID != -1)
     sqlQuery = sqlQuery + " and acc.T_CLIENT = ? ";
  end;

  if( (Data.IsFormID > 0) and (Data.FormSubID != 0) )
    if(Data.IsFormID == 1)
      sqlQuery = sqlQuery + "  and     Pt.T_LEGALFORM = ?  ";
    end;
    if(Data.IsFormID == 2)            	
      sqlQuery = sqlQuery + "  and     Pt.T_LEGALFORM != ?  ";
    end;
  end;

  if( (Data.IsVidID > 0) and (Data.VidSubID != 0) )
    if(Data.IsVidID == 1)
      sqlQuery = sqlQuery + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
    end;
    if(Data.IsVidID == 2)            	
      sqlQuery = sqlQuery + "   and    NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
    end;
  end;

  if(Data.NoResident)
    sqlQuery = sqlQuery +  " and  Pt.T_NOTRESIDENT = 'X'  ";
  end;

  if(Data.ContrID > 0)
     sqlQuery = sqlQuery + " and acc.T_CLIENTCONTR = ? ";
  end;

  sqlQuery = sqlQuery + "   and acc.T_DATE >= ? " +
                        "   and acc.T_DATE <= ? ";


  sqlQuery = sqlQuery + " UNION ALL "
                      + " SELECT nptxop.T_CLIENT T_CLIENT, "
                      + "        nptxop.T_CONTRACT T_CLIENTCONTR, "
                      + "        nptxop.T_OPERDATE, "
                      + "        nptxop.T_OPERDATE, "
                      + "        nptxop.T_ID, "
                      + "        ground.t_spgroundid, "
                      + "        sfcontr.T_Number, "
                      + "        sfcontr.T_DateConc, "
                      + "        NVL (ground.t_XLD, '') t_AltXLD, "
                      + "        nptxop.t_outsum, "
                      + "        0 t_FiKind, "
                      + "        nptxop.t_fiid, "
                      + "        nptxop.t_account t_KredAcc, "
                      + "        '' t_DebAcc, "
                      + "        ground.t_receptionist t_Oper, "
                      + "        1 t_Chapter, "
                      + "        (SELECT t_sznamealg "
                      + "           FROM dnamealg_dbt "
                      + "          WHERE t_itypealg = 7334 "
                      + "                AND t_inumberalg = nptxop.t_subkind_operation) "
                      + "           NameOper, "
                      + "        NPTXOP.T_STATUS, "
                      + "        ground.t_SPGroundID, "
                      + "        ground.t_registrdate, "
                      + "        ground.t_registrtime, "
                      + "        NVL((SELECT decode(req.src, 'DBO', 'ДБО ФЛ', 'EFR', 'ЕФР', 'DBO UL', 'ДБО ЮЛ', req.src) "
                      + "               FROM nontrading_orders_buffer req "
                      + "              WHERE req.operation_id = nptxop.T_ID), '') BrokerName "
                      + "   FROM dnptxop_dbt nptxop, "
                      + "        dsfcontr_dbt sfcontr, "
                      + "        (SELECT spgrdoc.t_sourcedocid docid, spground.* "
                      + "           FROM dspgrdoc_dbt spgrdoc, dspground_dbt spground "
                      + "          WHERE     spgrdoc.t_sourcedockind = 4607 "
                      + "                AND spground.t_spgroundid = spgrdoc.t_spgroundid "
                      + "                AND spground.t_kind = 251) ground, "
                      + "        dparty_dbt Pt "
                      + "  WHERE     sfcontr.T_ID = nptxop.T_CONTRACT "
                      + "        AND ground.docid = nptxop.T_ID "
                      + "        AND Pt.T_PARTYID = nptxop.T_CLIENT "
                      + "        AND ((nptxop.t_subkind_operation = 30 AND sfcontr.t_servkind = 0) OR"  // Перевод м/у субсчетами ДБО 30
                      + "             (nptxop.t_subkind_operation = 20 AND sfcontr.t_servkind IN ( ";   // Списание 20

  First = true;
  if( Data.ServKind_BO == true )
     sqlQuery = sqlQuery + "1";
     First = false;
  end;

  if( Data.ServKind_DV == true )
     if( not First )
        sqlQuery = sqlQuery + ",";
     end;
     sqlQuery = sqlQuery + "15";
     First = false;
  end;

  sqlQuery = sqlQuery + "))) ";

  if(Data.ClientID != -1)
     sqlQuery = sqlQuery + " and nptxop.T_CLIENT = ? ";
  end;

  if( (Data.IsFormID > 0) and (Data.FormSubID != 0) )
    if(Data.IsFormID == 1)
      sqlQuery = sqlQuery + "  and     Pt.T_LEGALFORM = ?  ";
    end;
    if(Data.IsFormID == 2)             
      sqlQuery = sqlQuery + "  and     Pt.T_LEGALFORM != ?  ";
    end;
  end;

  if( (Data.IsVidID > 0) and (Data.VidSubID != 0) )
    if(Data.IsVidID == 1)
      sqlQuery = sqlQuery + "   and    EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
    end;
    if(Data.IsVidID == 2)              
      sqlQuery = sqlQuery + "   and    NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = ? and Pt.T_PARTYID = Pto.T_PARTYID)  ";
    end;
  end;

  if(Data.NoResident)
    sqlQuery = sqlQuery +  " and  Pt.T_NOTRESIDENT = 'X'  ";
  end;

  if(Data.ContrID > 0)
     sqlQuery = sqlQuery + " and nptxop.T_CONTRACT = ? ";
  end;

  sqlQuery = sqlQuery + "   and nptxop.T_OPERDATE >= ? "
                      + "   and nptxop.T_OPERDATE <= ? ";

  sqlQuery = sqlQuery + " order by t_registrdate, t_registrtime, T_CLIENT, T_CLIENTCONTR ";

  return sqlQuery;

end;

private macro ПолучитьСчёт()

  var sqlQuery;

  sqlQuery = " select distinct accdoc.T_ACCOUNT, accdoc.T_CURRENCY " +
             " from dmcaccdoc_dbt accdoc" +
             " where (accdoc.T_ACCOUNT = ? or " +
             "        accdoc.T_ACCOUNT = ? ) " +
             "   and accdoc.T_CURRENCY = ? " +
             "   and accdoc.T_CHAPTER = ? " +
             "   and accdoc.T_CATNUM = 531 ";

  return sqlQuery;

end;
  macro getClientMpCode(_sfcontrid)
    var sqlQuery = RSDCommand(" SELECT t_mpcode                 " +
                              "   FROM ddlcontrmp_dbt           " +
                              "  WHERE t_sfcontrid = :sfcontrid ");

    sqlQuery.addParam("", RSDBP_IN, _sfcontrid);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.mpcode;
    end;

    return "";
  end;


  macro getContrName(_sfcontrid)
    var sqlQuery = RSDCommand(" SELECT T_NAME                                                          " +
                              "   FROM DSFCONTR_DBT                                                    " +
                              "  WHERE T_ID = (SELECT t_sfcontrid                                      " +
                              "                  FROM ddlcontr_dbt                                     " +
                              "                 WHERE t_dlcontrid = (SELECT t_dlcontrid                " +
                              "                                        FROM ddlcontrmp_dbt             " +
                              "                                       WHERE t_sfcontrid = :sfcontrid)  " +
                              "                    OR t_sfcontrid = :sfcontrid)                         ");

    sqlQuery.addParam("sfcontrid", RSDBP_IN, _sfcontrid);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.name;
    end;

    return "";
  end;

  macro getContrNumber(_sfcontrid)
    var sqlQuery = RSDCommand(" SELECT T_NUMBER                                                        " +
                              "   FROM DSFCONTR_DBT                                                    " +
                              "  WHERE T_ID = (SELECT t_sfcontrid                                      " +
                              "                  FROM ddlcontr_dbt                                     " +
                              "                 WHERE t_dlcontrid = (SELECT t_dlcontrid                " +
                              "                                        FROM ddlcontrmp_dbt             " +
                              "                                       WHERE t_sfcontrid = :sfcontrid)  " +
                              "                    OR t_sfcontrid = :sfcontrid)                        ");

    sqlQuery.addParam("sfcontrid", RSDBP_IN, _sfcontrid);
    sqlQuery.execute();

    var sqlData = TRsbDataSet(sqlQuery);

    if(sqlData.movenext)
        return sqlData.number;
    end;

    return "";
  end;

  MACRO getClientName(_clientid, _sfcontrid):STRING
     Var pt = TRecHandler ("party");
     var m_Client = _clientid;
     var m_mp_code = getClientMpCode(_sfcontrid);
     var m_client_name = "";

     if( m_Client > 0 )
       if( not ПолучитьСубъекта(m_Client,pt) )
          if(pt.rec.LegalForm == 2/*PTLEFG_PERSN*/) // Golovkin 08.04.2019
              m_client_name = pt.rec.Name;
          else
              m_client_name = getContrName(_sfcontrid);
          end;

          if(m_mp_code != "")
              m_client_name = m_client_name + "/" + m_mp_code; // Golovkin 08.04.2019
          end;

          return m_client_name;
        end;
     end;
     return "";
  END;

 macro ReportRun( ClientID: integer,
                 IsFormID:integer, 
                 FormSubID:integer, 
                 IsVidID:integer, 
                 VidSubID:integer, 
                 NoResident:bool, 
                 ContrID: integer,
                 PrintOut: bool, 
                 PrintIn: bool, 
                 PrintPlan: bool, 
                 dateMin: date,
                 dateMax: date,
                 OperID:integer,
                 apostrSum: bool,
                 IsExcel:bool,
                 ServKind_BO:bool,
                 ServKind_DV:bool,
                 ServKind_VA:bool )

   VAR ReportFileName, TblName = "clordio", errcode, errtext;
   FILE ReportOutFile() txt write; /*файл вывода для отчета*/
   file person("person");
   Dl_CallInsertStat( IIF( IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   var Data = SourceData( ClientID, IsFormID, FormSubID, IsVidID, VidSubID, Noresident,
                          ContrID, PrintOut, PrintIn, PrintPlan, dateMin, dateMax, OperID, apostrSum, ServKind_BO, ServKind_DV, ServKind_VA ); 

   var sqlQuery, sqlQuery2, sqlOper, sqlConducting;
   var Num = 0, AmountRec, Amount, nRecs, SqlSelect, AccClient = "", textPrefix = "", CodeCurrency = "", Select, Account2 = "", AccountName2 = "";
   record   RecAccount2(account); 
   _ReportRun = false;
   IsApp = true;
     initRep();
    PrintHeader();
   if( (Data.ServKind_BO == true) or (Data.ServKind_DV == true) or (Data.ServKind_VA == true) )

      AmountRec = RSDCommand ( "select COUNT(1) nRecs " + 
                               "  FROM (" + ПолучитьPO( Data ) + ")" );

      if( Data.ServKind_BO == true )
         AmountRec.addParam( "", RSDBP_IN, 5 );
      end;
      if( Data.ServKind_DV == true )
         AmountRec.addParam( "", RSDBP_IN, 8 );
      end;
      if( Data.ServKind_VA == true )
         AmountRec.addParam( "", RSDBP_IN, 7 );
      end;
      if(Data.ClientID != -1)
         AmountRec.addParam( "", RSDBP_IN, Data.ClientID );
      end;

      if( (Data.IsFormID > 0) and (Data.FormSubID !=0) )
        AmountRec.addParam( "", RSDBP_IN, Data.FormSubID);
      end;
      if( (Data.IsVidID > 0) and (Data.VidSubID !=0) )
        AmountRec.addParam( "", RSDBP_IN, Data.VidSubID);
      end;

      if(Data.ContrID > 0)
         AmountRec.addParam( "", RSDBP_IN, Data.ContrID );
      end;
      AmountRec.addParam( "", RSDBP_IN, Data.dateMin );
      AmountRec.addParam( "", RSDBP_IN, Data.dateMax );

         if(Data.ClientID != -1)
            AmountRec.addParam( "", RSDBP_IN, Data.ClientID );
         end;

         if( (Data.IsFormID > 0) and (Data.FormSubID !=0) )
           AmountRec.addParam( "", RSDBP_IN, Data.FormSubID);
         end;
         if( (Data.IsVidID > 0) and (Data.VidSubID !=0) )
            AmountRec.addParam( "", RSDBP_IN, Data.VidSubID);
         end;

         if(Data.ContrID > 0)
            AmountRec.addParam( "", RSDBP_IN, Data.ContrID );
         end;
         
         AmountRec.addParam( "", RSDBP_IN, Data.dateMin );
         AmountRec.addParam( "", RSDBP_IN, Data.dateMax );

      AmountRec.execute();
    
      Amount = TRsbDataSet(AmountRec);
      if ( Amount.moveNext() ) 
           nRecs = Int(Amount.nRecs);
      end;
    
      if( nRecs > 0 )
    
         InitProgress( nRecs, "Отчет \"Поручения на вывод/зачисление клиентских средств\"", "Просмотр данных за интервал дат" );
    
         sqlQuery = RSDCommand( ПолучитьPO( Data ) );
         if( Data.ServKind_BO == true )
            sqlQuery.addParam( "", RSDBP_IN, 5 );
         end;
         if( Data.ServKind_DV == true )
            sqlQuery.addParam( "", RSDBP_IN, 8 );
         end;
         if( Data.ServKind_VA == true )
            sqlQuery.addParam( "", RSDBP_IN, 7 );
         end;
         if(Data.ClientID != -1)
            sqlQuery.addParam( "", RSDBP_IN, Data.ClientID );
         end;

         if( (Data.IsFormID > 0) and (Data.FormSubID !=0) )
           sqlQuery.addParam( "", RSDBP_IN, Data.FormSubID);
         end;
         if( (Data.IsVidID > 0) and (Data.VidSubID !=0) )
            sqlQuery.addParam( "", RSDBP_IN, Data.VidSubID);
         end;

         if(Data.ContrID > 0)
            sqlQuery.addParam( "", RSDBP_IN, Data.ContrID );
         end;
         sqlQuery.addParam( "", RSDBP_IN, Data.dateMin );
         sqlQuery.addParam( "", RSDBP_IN, Data.dateMax );

         if(Data.ClientID != -1)
            sqlQuery.addParam( "", RSDBP_IN, Data.ClientID );
         end;

         if( (Data.IsFormID > 0) and (Data.FormSubID !=0) )
           sqlQuery.addParam( "", RSDBP_IN, Data.FormSubID);
         end;
         if( (Data.IsVidID > 0) and (Data.VidSubID !=0) )
            sqlQuery.addParam( "", RSDBP_IN, Data.VidSubID);
         end;

         if(Data.ContrID > 0)
            sqlQuery.addParam( "", RSDBP_IN, Data.ContrID );
         end;

         sqlQuery.addParam( "", RSDBP_IN, Data.dateMin );
         sqlQuery.addParam( "", RSDBP_IN, Data.dateMax );


         sqlQuery.execute();
         sqlOper = TRsbDataSet( sqlQuery );
    
         while( sqlOper.MoveNext() )
            _ReportRun = true;

            Data.CurDate = date(sqlOper.ValueDate);

            if( (Data.CurDate <= {Curdate}) or ( (Data.CurDate > {Curdate}) and (Data.PrintPlan == true) ) )

                Data.ClientID = sqlOper.Client;
                Data.ContrID  = sqlOper.clientcontr;//sqlOper.Id;
                 
                SqlSelect = RSDCommand( ПолучитьСчёт() );
                SqlSelect.addParam( "", RSDBP_IN, sqlOper.DebAcc );
                SqlSelect.addParam( "", RSDBP_IN, sqlOper.KredAcc );
                SqlSelect.addParam( "", RSDBP_IN, sqlOper.FIID );
                SqlSelect.addParam( "", RSDBP_IN, sqlOper.Chapter );
                SqlSelect.execute();
                Select =  TRsbDataSet( SqlSelect );
                if( Select.MoveNext() )
                  AccClient = Select.ACCOUNT;
                  CodeCurrency = Select.Currency;                     

                  if(AccClient == sqlOper.DebAcc)
                    Account2 = sqlOper.KredAcc;
                    textPrefix = "Со счета ";
                  else
                    Account2 = sqlOper.DebAcc;
                    textPrefix = "На счет " ;
                  end;

                  if( GetAccount( sqlOper.Chapter, CodeCurrency, Account2, RecAccount2 ) )
                    AccountName2 = RecAccount2.NameAccount;
                  end;
                else
                  textPrefix = "";
                  Account2 = "";
                  AccClient = sqlOper.KredAcc;
                end;

                

   var ClientCode = "";
   var BrokerName = "";
   var OrdState = "";
   if((ValType(sqlOper.BrokerName) != V_UNDEF) and (sqlOper.BrokerName != ""))
     BrokerName = sqlOper.BrokerName;
   else;
     ClearRecord( person );
     person.oper = sqlOper.Oper;
     if( GetEQ(person) ) 
       BrokerName = person.Name;
     end;
   end;

   if(sqlOper.DocState == 0)
     OrdState = "Зарегистрировано";
   elif(sqlOper.DocState == 2)
     OrdState = "Исполнено";
   end;

   var Sum1;
   var Numb = "";                          
   var СпособПодачи =  СпособПодачиПоручения(sqlOper.SPGroundID);
   Sum1 = IIF(sqlOper.Sum, sqlOper.Sum, "" );
   Numb = IIF(sqlOper.AltXLD, sqlOper.AltXLD, "");
   PrintLine1 (Numb, time(sqlOper.registrtime), sqlOper.NameOper, AccClient,textPrefix + Account2, AccountName2, Sum1, GetCCY(sqlOper.FIID), Data.CurDate,
              getClientName(sqlOper.Client, sqlOper.clientcontr), 
               ClientCode,
               getContrNumber(sqlOper.clientcontr),
               SQL_ConvTypeDate(sqlOper.DateConc),
               BrokerName,
               OrdState,
              СпособПодачи,
              date(sqlOper.registrdate)
      );
            end;
    
            Num = Num + 1;
            UseProgress( Num );
         end;
    

         RemProgress();    
      end;
   end;

   if( _ReportRun == false )
      MsgBox("В указанный период операций, соответствующих параметрам отчета, не проводилось.");
   else
      if( IsExcel )
         ShowRep(Data);
      else

         ReportFileName = GetTxtFileName( TblName );

         if( Open( ReportOutFile, ReportFileName ) == false )
            errcode = status( errtext );
            MsgBox( "Ошибка при открытии файла отчета|"+ ReportFileName +"|(" + errcode + ") " + errtext);
            break;
         end;

         SetOutput( ReportFileName );
         SetOutput( NULL, true );
         close( ReportOutFile );
         ViewFile( ReportOutFile );

      end;
   end;

end;

macro MakeReports()
  var stat = 0;
  
  stat = m_Form.Run();
  
  // Проверяем можем ли мы делать отчет по предоставленным данным
  if (not stat)
     return;
  end;

  GetDataFromFormFields();

  ReportRun( DlClordioRepFormData.ClientCode,
             DlClordioRepFormData.IsForm,
             DlClordioRepFormData.FormSub,
             DlClordioRepFormData.IsVid,
             DlClordioRepFormData.VidSub,
             DlClordioRepFormData.Noresident,
             DlClordioRepFormData.ContrName,
             DlClordioRepFormData.OperConclusion,
             DlClordioRepFormData.OperTransfer,
             DlClordioRepFormData.OperPlanned,
             DlClordioRepFormData.BegDate,
             DlClordioRepFormData.EndDate,
             DlClordioRepFormData.OperNum,
             DlClordioRepFormData.IsUseApp,
             DlClordioRepFormData.IsExportToExel,
             DlClordioRepFormData.ServKind_BO,
             DlClordioRepFormData.ServKind_DV,
             DlClordioRepFormData.ServKind_VA
           );  
  MakeReports();

end;
MakeReports();
exit(1);