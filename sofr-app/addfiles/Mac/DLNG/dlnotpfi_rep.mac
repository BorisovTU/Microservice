/*
$Name:        dlnotpfi_rep.mac
$Module:      Ядро Securities
$Description: Отчет <Внутренний учет>/ <Отчеты>/ <Регистры ВУ> / <Реестр ВУ сделок ПУРЦБ> / <Сделки с финансовыми активами (кроме ПФИ)>
*/
import "dlnotpfi_form.mac", "dlquery.mac", DVInter, "spserv.mac";

PRIVATE VAR DlNotPFI_Form;

private const KIND_EX_1 = 1,
              KIND_IN   = 2,  
              KIND_OUT  = 3,  
              KIND_EX_2 = 4;  

private const СДЕЛКА_БАНКА   = 0,
              СДЕЛКА_КЛИЕНТА = 1;  

var RestRUR, RestUSD, RestEUR, RestCHF, RestGBP;

// 21.01.2021 MAA: iS - 519390
var arRestPlanRUR = TArray(), arRestPlanUSD = TArray(), arRestPlanEUR = TArray(), arRestPlanCHF = TArray(), arRestPlanGBP = TArray();


private macro GetOption_ShowDealChange( )
   var
      ErrCode, OptionValue;

   GetRegistryValue( "SECUR\\SHOW_DEAL_CHANGE_IN_REPS", V_BOOL,
                     OptionValue, ErrCode );

   return OptionValue and (ErrCode == 0);
end;

private macro GetSpGroundByEns(Kind:integer)
   var vSpGround = "";

   if( (Kind == KIND_IN) or (Kind == KIND_OUT) )
      vSpGround = "Компенсация";
   elif( Kind == KIND_EX_1 )
      vSpGround = "Поставка";
   else
      vSpGround = "Исполнение";
   end;

   return vSpGround;
end;

private macro GetOperKindByEns(Kind:integer)
   var vSpGround = "";

   if( (Kind == KIND_EX_1) or (Kind == KIND_IN) )
      vSpGround = "Передача";
   else
      vSpGround = "Принятие";
   end;

   return vSpGround;
end;

private macro GetRegistrarByDeal(DealID:integer, RegistrarShortName:@String, RegistrarContrNum:@String)
   var Select, DataSet;

   RegistrarShortName = ""; 
   RegistrarContrNum  = "";

   Select = DL_RSDCommand("select (select t.t_ShortName from dparty_dbt t where t.t_Partyid = LEG.T_REGISTRAR) RegistrarShortName, "+
                          "       (select t.t_Number from dsfcontr_dbt t where t.t_id = LEG.T_REGISTRARCONTRID) REGISTRARCONTRNUM from ddl_leg_dbt leg "+
                          " where LEG.T_DEALID  = ? "+ 
                          "   and LEG.T_LEGID = 0 "+
                          "   and LEG.T_LEGKIND = ?"
                         );

   Select.AddParam(DealID);
   Select.AddParam(LEG_KIND_DL_TICK);

   DataSet = Select.Execute();

   if(DataSet.moveNext())
      RegistrarShortName = DataSet.RegistrarShortName; 
      RegistrarContrNum  = DataSet.REGISTRARCONTRNUM;
      return true;
   end;

   return false;
end;

private macro GetTotalSumFromLot(Kind:integer, DealID:integer, FIID:integer, OnDate:date, Amount:@money, Cost:@money, NKD:@money)
   var Select, DataSet, query;

   Amount = Cost = NKD = $0;

   query = "SELECT nvl(sum(T.T_AMOUNT),0) T_AMOUNT, nvl(sum(T.T_COST),0) T_COST, nvl(sum(T.T_NKDAMOUNT),0) T_NKDAMOUNT "+
           "  FROM v_scwrthistex t, ddlrq_dbt dlrq "+
           " where T.T_DOCKIND = ? "+
           "   and T.T_DOCID = DLRQ.T_ID "+
           "   and DLRQ.T_DOCID = ? "+
           "   and DLRQ.T_TYPE = ? "+
           "   and DLRQ.T_NUM = 0 "+ 
           "   and DLRQ.T_DEALPART = 2 "+
           "   and T.T_FIID = ? ";

   if( Kind == KIND_OUT )
      query = query +
           "   and t.t_instance = (SELECT min(t_instance) - 1 "+
           "                         FROM v_scwrthistex "+
           "                        WHERE t_sumid = t.t_sumid "+
           "                          AND t_action = 480 "+
           "                          AND t_changedate = ? "+
           "                      ) ";
   else
      query = query +
           "   and t.t_instance = (SELECT max(t_instance) "+
           "                         FROM v_scwrthistex "+
           "                        WHERE t_sumid = t.t_sumid "+
           "                          AND t_state != 1 "+
           "                          AND t_changedate <= ? "+
           "                      ) ";
   end;

   Select = DL_RSDCommand( query );

   Select.AddParam(DLDOC_PAYMENT);
   Select.AddParam(DealID);
   Select.AddParam(DLRQ_TYPE_DELIVERY);
   Select.AddParam(FIID);
   Select.AddParam(OnDate);

   DataSet = Select.Execute();

   if(DataSet.moveNext())
      Amount = DataSet.Amount;
      Cost   = DataSet.Cost;
      NKD    = DataSet.NKDAMOUNT;
      return true;
   end;

   return false;
end;

PRIVATE CLASS (DL_CReportTemplate) DL_NotPFI_Report(Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  private var m_IsPrint = false, m_IsDepHeadPrint = false, m_IsFilterHeadPrint = false, m_IsDealHeadPrint = false, m_IsBasketHeadPrint = false, 
              m_IsSetActiveSheet = false, m_SheetName = "";
  private var m_IsFirstUse = true, m_IsExistsData = false;

  var m_ReportDate = date(0,0,0), m_dateMin = Date(0,0,0), m_dateMax = Date(0,0,0);
  var m_DprtID = -1, m_DprtName = "", m_IsPartDate = false, m_Numb = 0, m_Deal;

  var m_DealClosed, m_DealReadied, m_DealAll,
      m_prev_department,
      m_prev_dealDATE,  
      m_prev_KINDBO,    
      m_prev_dealtype,
      m_prev_dealkind,
      m_BO, m_VA, m_DV, m_IsOwn, m_IsClient, m_ClientID, m_H_0 = "", m_H_4 = "", m_H_2 = "", m_H_3 = "", m_H_1 = "", m_H_5 = "", m_DealMarket,
      m_MarketID, m_DealNotMarket, m_DealBroker, m_BrokerID, m_Qualified, m_FI_Kinds,
      m_AvrID, m_EmiID, m_AvrTypeID, m_NoResident, m_IsForm, m_FormSub, m_IsVid, m_VidSub, m_AgentId, m_ShowDealChange = DL_IIF(GetOption_ShowDealChange(),1,0),
      m_CCA_NatCUR = DL_GetISOCurr(643);

  PRIVATE MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO GetFIID(ccy)
    var q = "select t_fiid fiid from dfininstr_dbt where t_ccy = ?";
    var cmd = DL_RSDCommand();
    cmd.AddParam(ccy);
    var ds = cmd.Execute(q);
    if (ds.moveNext)
      return ds.fiid
    end;
    return -1;
  END;

  PRIVATE MACRO EndReport()
     if( m_IsPrint )
        EndTable();
        CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0, m_SheetName );
        this.PrintBasket();
        AddStandardFooter( "N1_" );
        CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1, m_SheetName );
        m_IsPrint = false;
     end;

     if( not m_IsExistsData )
        msgbox("Нет данных для формирования отчета.");
     end;
     SaveTotalBook();
  END;

  macro PrintReportHead()


     if( not m_IsDepHeadPrint )
        if( m_IsPrint )
           EndTable();
           CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0, m_SheetName );
           this.PrintBasket();
           AddStandardFooter( "N1_" );
           CopyAllSheetInTotalBook( NULL, false, "N1_Footer", 1, m_SheetName );
           m_IsPrint = false;
        end;

        if( not m_IsSetActiveSheet )
           m_DprtName = DL_getDP_DEP_Name(m_deal.department);
           m_SheetName = DL_getDP_DEP_Code(m_deal.department);
           UseNewSheetInTotalBook();
           m_IsSetActiveSheet = true;
        end;

        PrintFormatString( "",
                           "N1_DprtName", "Филиал: "+m_DprtName,
                           "N1_ReportDate", DL_IIF((m_IsPartDate == true), string(m_ReportDate:f), string(m_dateMin:f) + " - " + string(m_dateMax:f))
                         );
        CopyAllSheetInTotalBook( NULL, false, "N1_Header", DL_IIF(m_IsFirstUse,0,1), m_SheetName );
      
        if( m_IsFirstUse )
           m_IsFirstUse = false;
        end;
        m_IsDepHeadPrint = true;
     end;

     if( (not m_IsFilterHeadPrint) or (m_deal.dealkind != m_prev_dealkind) )

        if( not m_IsFilterHeadPrint )
           /*PNV 531250*/
           /*if( m_IsPrint )
              EndTable();
              CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0, m_SheetName );
              this.PrintBasket();
              m_IsPrint = false;
           end;
          
           if( m_deal.KINDBO == 0 )
              if( m_deal.DealType == 0 )
                 m_H_0 = "Сделки с квалифицированными ценными бумагами";
              elif( m_deal.DealType == 1 )
                 m_H_0 = "Сделки с иностранными финансовыми инструментами, не квалифицированными в качестве ценных бумаг";
              elif( m_deal.DealType == 2 )
                 m_H_0 = "Сделки покупки иностранных финансовых инструментов, не квалифицированных в качестве ценных бумаг";
              end;
           elif( m_deal.KINDBO == 1 )
              if( m_deal.DealType == FIKIND_CURRENCY )
                 m_H_0 = "Сделки с иностранной валютой";
              elif( m_deal.DealType == FIKIND_AVOIRISS )
                 m_H_0 = "Сделки с ценными бумагами";
              elif( m_deal.DealType == FIKIND_METAL )
                 m_H_0 = "Сделки с драгоценными металлами";
              end;
           elif( m_deal.KINDBO == 2 )
              m_H_0 = "Сделки с неэмиссионными ценными бумагами";
           end;
          
           PrintFormatString( "",
                              "N1_H_0", m_H_0,
                              "N1_H_1", m_H_1,
                              "N1_H_2", m_H_2,
                              "N1_H_3", m_H_3,
                              "N1_H_4", m_H_4,
                              "N1_H_5", m_H_5
                            );*/
          if( m_IsPrint )
              EndTable();
              CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0, m_SheetName );
              this.PrintBasket();
              m_IsPrint = false;
           end;
           if ( m_Deal.KINDBO == 2 )

             CopyAllSheetInTotalBook( NULL, false, "N1_TableHeader", 1, m_SheetName );

           else

             CopyAllSheetInTotalBook( NULL, false, "N3_TableHeader", 1, m_SheetName );

           end;
          
           m_Numb = 0;
          
           m_IsFilterHeadPrint = true;

        end;

        /*if( m_IsPrint )
           EndTable();
           CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0, m_SheetName );
           m_IsPrint = false;
        end;*/

        if ( m_Deal.KINDBO == 2 )

        PrintFormatString( "",
                           "N1_A0", DL_IIF(m_deal.dealkind==СДЕЛКА_КЛИЕНТА,"Сделки, совершенные за счет клиентов","Собственные сделки")
                         );
        CopyAllSheetInTotalBook( NULL, false, "N1_A0_1", 0, m_SheetName );
        
        RegisterTable( "N1_MainTable", "",
                       "N1_CurNumber", 
                       "N1_DealCode", 
                       "N1_DealCodeTS", 
                       "N1_Date", 
                       "N1_Time", 
                       "N1_ChangeInfo",
                       "N1_PartyShort",   
                       "N1_DealKindName",  
                       "N1_ContrShortName",   
                       "N1_ClientShortName",
                       "N1_N_gs",
                       "N1_DocNumber", 
                       "N1_RecNumber",
                       "N1_SfContrNumber", 
                       "N1_IssShortName",  
                       "N1_AvrKind",  
                       "N1_AvrCode",  
                       "N1_AvrSeries", 
                       "N1_AvrISIN",  
                       "N1_PayCCY",   
                       "N1_Amount",   
                       "N1_Price", 
                       "N1_PriceISO", 
                       "N1_SumInNom", 
                       "N1_SumInCalc", 
                       "N1_SumInNatcur",
                       "N1_CalcMethod",
                       "N1_StateDate", 
                       "N1_StateFactDate", 
                       "N1_PayDate",  
                       "N1_PayFactDate",   
                       "N1_RejectInfo",
                       "N1_Status"
                     );
        else

        PrintFormatString( "",
                           "N3_A0", DL_IIF(m_deal.dealkind==СДЕЛКА_КЛИЕНТА,"Сделки, совершенные за счет клиентов","Собственные сделки")
                         );
        CopyAllSheetInTotalBook( NULL, false, "N3_A0_1", 0, m_SheetName );

        RegisterTable( "N3_MainTable", "",
                       "N3_DealCode",           // Номер сделки 
                       "N3_Date1",              // Дата заключения сделки 
                       "N3_Time1",              // Время заключения сделки 
                       "N3_X42",                // Дата исполнения сделки
                       "N3_PartyShort1",        // Место совершения сделки
                       "N3_X1",                 // Секция организатора торговли и (или) режим торгов
                       "N3_X2",                 // Номер соглашения с клиентом
                       "N3_X3",                 // Дата заключения
                       "N3_X4",                 // Дата расторжения
                       "N3_ClientShortName",    // Наименование или уникальный код (номер) клиента
                       "N3_X5",                 // Представитель клиента
                       "N3_X6",                 // Данные по доверенности клиента
                       "N3_X7",                 // Сторона 1
                       "N3_X8",                 // Сторона 2
                       "N3_N_gs",               // Номер и дата генерального соглашения
                       "N3_X9",                 // Клиент стороны 2
                       "N3_X10",                // Комиссия брокера в валюте расчетов
                       "N3_X11",                // Вид заявки (Адресная/Безадресная)
                       "N3_DocNumber",          // Номер поручения / Номер договора с клиентом
                       "N3_X12",                // Направление сделки (покупка-продажа)
                       "N3_X13",                // Вид сделки (купля-продажа, заём, РЕПО и др.)
                       "N3_X14",                // Инструмент
                       "N3_AvrKind",            // Вид ФИ
                       "N3_AvrCode",            // Код ФИ
                       "N3_PayCCY",             // Валюта расчетов
                       "N3_Amount",             // Количество
                       "N3_Price",              // Цена
                       "N3_PriceISO",           // Валюта цены
                       "N3_SumInNom",           // Сумма сделки
                       "N3_SumInCalc",          // 
                       "N3_SumInNatcur",        // 
                       "N3_X15",                // Клиент является ФЛ/ЮЛ/ИП
                       "N3_X16",                // Гражданство Клиента
                       "N3_X17",                // Клиент является/не является налоговым резидентом
                       "N3_X18",                // Клиент является/не является квалифицированным инвестором
                       "N3_X19",                // Категория клиента
                       "N3_X20",                // Порядок исполнения обязательств
                       "N3_X21",                // Способ исполнения обязательств
                       "N3_CalcMethod",         // Форма расчетов
                       "N3_X22",                // Качество, в котором действует Банк
                       "N3_X23",                // Дата принятия поручения Банком
                       "N3_X24",                // ПФИ/не ПФИ
                       "N3_X25",                // Право использование денежных средств Клиента Банком
                       "N3_X26_RUR",            // Остаток денежных средств на внутреннем счете(рубли)
                       "N3_X26_USD",            // Остаток денежных средств на внутреннем счете(доллары)
                       "N3_X26_EUR",            // Остаток денежных средств на внутреннем счете(евро)
                       "N3_X26_CHF",            // Остаток денежных средств на внутреннем счете(франки)
                       "N3_X26_GBP",            // Остаток денежных средств на внутреннем счете(фунты)
                       "N3_X27_RUR",            // Плановый исходящий остаток денежных средств на внутреннем счете(рубли)ы
                       "N3_X27_USD",            // Плановый исходящий остаток денежных средств на внутреннем счете(доллары)
                       "N3_X27_EUR",            // Плановый исходящий остаток денежных средств на внутреннем счете(евро)
                       "N3_X27_CHF",            // Плановый исходящий остаток денежных средств на внутреннем счете(франки)
                       "N3_X27_GBP",            // Плановый исходящий остаток денежных средств на внутреннем счете(фунты)
                       "N3_X28",                // Валюта требований/обязательств
                       "N3_X29",                // Обязательства денежных средств
                       "N3_X30",                // 
                       "N3_X31",                // 
                       "N3_X32",                // 
                       "N3_X33",                // 
                       "N3_X34",                // Требования денежных средств
                       "N3_X35",                // 
                       "N3_X36",                // 
                       "N3_X37",                // 
                       "N3_X38",                // 
                       "N3_X39",                // Наличие подтверждающих документов
                       "N3_X40",                // Наименование внешнего брокера
                       "N3_X41");               // Номер договора с внешним брокером
        end;

     end;

  end;

  macro PrintLine1(DealCode, DealCodeTS, Date1, Time1, ChangeInfo, PartyShort1,DealKindName, ContrShortName,
                   ClientShortName, N_gs, DocNumber, DocDate, RecNumber, SfContrNumber, IssShortName, AvrKind,
                   AvrCode, AvrSeries, AvrISIN, PayCCY, Amount, AmountPrecision,  Price, PriceISO, SumInNom, SumInCalc,SumInNatcur,
                   CalcMethod, StateDate, StateFactDate, PayDate, PayFactDate,
                   RejectInfo, ClientStatus,
                   x1, x2, x3, x4, x5, x6, x7, x8, x9, x10,
                   x11, x12, x13, x14, x15, x16, x17, x18, x19, x20,
                   x21, x22, x23, x24, x25, x26_RUR, x26_USD, x26_EUR, x26_CHF, x26_GBP,
                   x27_RUR, x27_USD, x27_EUR, x27_CHF, x27_GBP, x28, x29, x30,
                   x31, x32, x33, x34, x35, x36, x37, x38, x39, x40, x41, x42)

     if( m_deal.department != m_prev_department )

        m_IsDepHeadPrint = false;
        m_IsSetActiveSheet = false;
        m_IsFirstUse = true;
        m_IsFilterHeadPrint = false;

     elif( m_IsPartDate and (m_deal.dealDATE != m_prev_dealDATE) )

        m_IsDepHeadPrint = false;
        m_IsFilterHeadPrint = false;

     elif( (m_deal.KINDBO != m_prev_KINDBO) or (m_deal.dealtype != m_prev_dealtype) )
        m_IsFilterHeadPrint = false;
     end;

     PrintReportHead();

     m_Numb = m_Numb + 1;
     if( m_Deal.KINDBO == 2 )
     PrintTableLine(   "N1_CurNumber",        m_Numb,           null,
                       "N1_DealCode",         DealCode,         null,
                       "N1_DealCodeTS",       DealCodeTS,       null,
                       "N1_Date",             Date1,            null, 
                       "N1_Time",             Time1,            null,
                       "N1_ChangeInfo",       ChangeInfo,       null,
                       "N1_PartyShort",       PartyShort1,      null,
                       "N1_DealKindName",     DealKindName,     null,
                       "N1_ContrShortName",   ContrShortName,   null,
                       "N1_ClientShortName",  ClientShortName,  null,
                       "N1_N_gs",             N_gs,             null,
                       "N1_DocNumber",        DocNumber,        null,
                       "N1_DocDate",          DocDate,          null,
                       "N1_RecNumber",        RecNumber,        null,
                       "N1_SfContrNumber",    SfContrNumber,    null,
                       "N1_IssShortName",     IssShortName,     null,
                       "N1_AvrKind",          AvrKind,          null,
                       "N1_AvrCode",          AvrCode,          null,
                       "N1_AvrSeries",        AvrSeries,        null,
                       "N1_AvrISIN",          AvrISIN,          null,
                       "N1_PayCCY",           PayCCY,           null,
                       "N1_Amount",           Amount,           AmountPrecision,
                       "N1_Price",            Price,            null,
                       "N1_PriceISO",         PriceISO,         null,
                       "N1_SumInNom",         SumInNom,         null,
                       "N1_SumInCalc",        SumInCalc,        null,
                       "N1_SumInNatcur",      SumInNatcur,      null,
                       "N1_CalcMethod",       CalcMethod,       null,
                       "N1_StateDate",        StateDate,        null,
                       "N1_StateFactDate",    StateFactDate,    null,
                       "N1_PayDate",          PayDate,          null,
                       "N1_PayFactDate",      PayFactDate,      null,
                       "N1_RejectInfo",       RejectInfo,       null,
                       "N1_Status",           ClientStatus,     null
                    );
else

     PrintTableLine(   "N3_DealCode",            DealCode,           null,
                       "N3_Date1",               Date1,              null,
                       "N3_Time1",               Time1,              null,
                       "N3_X42",                 X42,                null,
                       "N3_PartyShort1",         PartyShort1,        null,
                       "N3_X1",                  X1,                 null,
                       "N3_X2",                  X2,                 null,
                       "N3_X3",                  X3,                 null,
                       "N3_X4",                  X4,                 null,
                       "N3_ClientShortName",     ClientShortName,    null,
                       "N3_X5",                  X5,                 null,
                       "N3_X6",                  X6,                 null,
                       "N3_X7",                  X7,                 null,
                       "N3_X8",                  X8,                 null,
                       "N3_N_gs",                N_gs,               null,
                       "N3_X9",                  X9,                 null,
                       "N3_X10",                 X10,                null,
                       "N3_X11",                 X11,                null,
                       "N3_DocNumber",           DocNumber,          null,
                       "N3_X12",                 X12,                null,
                       "N3_X13",                 X13,                null,
                       "N3_X14",                 X14,                null,
                       "N3_AvrKind",             AvrKind,            null,
                       "N3_AvrCode",             AvrCode,            null,
                       "N3_PayCCY",              PayCCY,             null,
                       "N3_Amount",              Amount,             AmountPrecision,
                       "N3_Price",               Price,              4,/*12.03.2020 RAS:506872*/
                       "N3_PriceISO",            PriceISO,           null,
                       "N3_SumInNom",            SumInNom,           null,
                       "N3_SumInCalc",           SumInCalc,          null,
                       "N3_SumInNatcur",         SumInNatcur,        null,
                       "N3_X15",                 X15,                null,
                       "N3_X16",                 X16,                null,
                       "N3_X17",                 X17,                null,
                       "N3_X18",                 X18,                null,
                       "N3_X19",                 X19,                null,
                       "N3_X20",                 X20,                null,
                       "N3_X21",                 X21,                null,
                       "N3_CalcMethod",          CalcMethod,         null,
                       "N3_X22",                 X22,                null,
                       "N3_X23",                 X23,                null,
                       "N3_X24",                 X24,                null,
                       "N3_X25",                 X25,                null,
                       "N3_X26_RUR",             X26_RUR,            null,
                       "N3_X26_USD",             X26_USD,            null,
                       "N3_X26_EUR",             X26_EUR,            null,
                       "N3_X26_CHF",             X26_CHF,            null,
                       "N3_X26_GBP",             X26_GBP,            null,
                       "N3_X27_RUR",             X27_RUR,            null,
                       "N3_X27_USD",             X27_USD,            null,
                       "N3_X27_EUR",             X27_EUR,            null,
                       "N3_X27_CHF",             X27_CHF,            null,
                       "N3_X27_GBP",             X27_GBP,            null,
                       "N3_X28",                 X28,                null,
                       "N3_X29",                 X29,                null,
                       "N3_X30",                 X30,                null,
                       "N3_X31",                 X31,                null,
                       "N3_X32",                 X32,                null,
                       "N3_X33",                 X33,                null,
                       "N3_X34",                 X34,                null,
                       "N3_X35",                 X35,                null,
                       "N3_X36",                 X36,                null,
                       "N3_X37",                 X37,                null,
                       "N3_X38",                 X38,                null,
                       "N3_X39",                 X39,                null,
                       "N3_X40",                 X40,                null,
                       "N3_X41",                 X41,                null
                    );
 end;
     m_prev_department = m_deal.department;
     m_prev_dealDATE   = m_deal.dealDATE;
     m_prev_KINDBO     = m_deal.KINDBO;
     m_prev_dealtype   = m_deal.dealtype;
     m_prev_dealkind   = m_deal.dealkind; 

     m_IsExistsData = true; 
     m_IsPrint = true;                                                                                                                                                                                                
  end;      

  PRIVATE MACRO BeginReport()

     m_dateMin       = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_DateBegin);
     m_dateMax       = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_DateEnd);
     m_IsPartDate    = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_IsEveryDate);
                    
     m_DealClosed    = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_DealClosed);
     m_DealReadied   = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_DealReadied);
     m_DealAll       = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_DealAll);
                    
     m_DprtID        = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_Dprt);
                    
     m_BO            = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_BODeals);
     m_VA            = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_VADeals);
     m_DV            = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_DVDeals);
                    
     m_IsOwn         = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_IsOwn);
     m_IsClient      = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_IsClient);
                    
     m_ClientID      = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_ClientCode,@m_H_4);

     m_DealMarket    = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_IsMarket);
     m_MarketID      = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_MarketCode);
     m_DealNotMarket = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_IsOutMkt);
     m_DealBroker    = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_IsBroker);
     m_BrokerID      = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_BrokerCode);

     m_Qualified     = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_FI_Qualified);
     m_AvrID         = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_AvrCode,@m_H_2);
     m_EmiID         = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_EmiCode,@m_H_3);

     m_AvrTypeID     = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_FI_AvoirKind);
     m_FI_Kinds      = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_FI_Kinds,@m_H_1);
     m_NoResident    = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_Cl_NotRes);

     m_IsForm  = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_Cl_Form_Sign);
     m_FormSub       = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_Cl_Form);
     m_IsVid  = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_Cl_Kind_Sign);
     m_VidSub       = DlNotPFI_Form.GetFieldValue(PNFLD_DLNOTPFI_Cl_Kind);

     m_H_5 = "";
     if( m_DealMarket == true )
        m_H_5 = m_H_5 + "Биржевые ";
        if ( m_DealNotMarket == true )
           m_H_5 = m_H_5 + "и внебиржевые ";
        else m_H_5 = m_H_5 + "";
        end;
     else 
        if ( m_DealNotMarket == true )
           m_H_5 = m_H_5 + "Внебиржевые ";
        else m_H_5 = m_H_5 + "";
        end;
     end;
    
     if( m_H_5 != "" )
        m_H_5 = m_H_5 + "сделки";
     end;
    
     if( m_DealBroker == true ) 
        if ( m_H_5 == "" )
           m_H_5 = m_H_5 + "Сделки через брокера";
        else 
           m_H_5 = m_H_5 + " и сделки через брокера";
        end;
     end;

     CreateTotalBook();
     
  END;

  macro ПолучитьНомерПоручения(DocKind:integer,DocID:integer,PartyID:integer,IsBack:bool,DocDate:@variant)

     DocDate = "";

     var XLD = "";
     var Select =  "SELECT t.T_XLD, t.t_RegistrDate                                           "
                  +"FROM dspground_dbt t                                                         "
                  +"WHERE t_SPGroundID in (SELECT spgrd.t_SPGroundID                             "
                  +"                         FROM dspgrdoc_dbt spgrd                             "
                  +"                        WHERE spgrd.t_SourceDocKind = ? AND spgrd.t_SourceDocID = ? ) "
                  +"  AND t_Kind = 251 "
                  +"  AND t_Party = ? "
                  +"ORDER BY t.t_registrdate"+dl_iif(IsBack," desc", " asc");

     var cmd = DL_RSDCommand(Select);

     cmd.addParam(DocKind);    
     cmd.addParam(DocID);    
     cmd.addParam(PartyID);    

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )
        XLD = SQL_ConvTypeStr(DataSet.XLD);
        DocDate = SQL_ConvTypeDate(DataSet.RegistrDate);
     end;
     return XLD;
  end;

  macro ПолучитьНомерЗаявки(DocKind:integer,DocID:integer)
    var N_z = "";
    var Select =  "SELECT dl_req.T_CODE"
                 +" FROM ddl_req_dbt dl_req,"
                 +" dspgrdoc_dbt spgrdocreq,"
                 +" dspgrdoc_dbt spgrdocdeal,"
                 +" dspground_dbt spground"
                 +" WHERE spgrdocdeal.t_SourceDocID = ? " 
                 +" AND spgrdocdeal.t_SourceDocKind = ? " 
                 +" AND spgrdocreq.t_SourceDocID <> spgrdocdeal.t_SourceDocID"
                 +" AND spgrdocreq.t_SourceDocKind <> spgrdocdeal.t_SourceDocKind"
                 +" AND spground.T_SPGroundID = spgrdocdeal.T_SPGroundID"
                 +" AND spground.T_SPGroundID = spgrdocreq.T_SPGroundID"
                 +" AND spgrdocreq.t_SourceDocKind = dl_req.T_KIND"
                 +" AND spgrdocreq.t_SourceDocID = dl_req.T_ID";

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( DocID );
     cmd.addParam( DocKind );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )
        N_z = DataSet.CODE;
     end;
     return N_z;
  end;
                                                                                                              
  private macro CollectDataByBO()
    var Query = "";

    var Select = " DECLARE \n"                                                                                                               
                 +"    TYPE notpfi_t IS TABLE OF DDLNOTPFI_TMP%ROWTYPE; \n"                                                                
                 +"        g_notpfi_ins notpfi_t := notpfi_t(); \n"                                                                        
                 +"        notpfi DDLNOTPFI_TMP%rowtype; \n"                                                                               
                 +"     BEGIN \n"                                                                                                          
                 +"    FOR one_rec IN  \n"                                                                                                 
                 +"(select TICK.T_DEALID, TICK.T_BOFFICEKIND, TICK.T_DEALTIME, TICK.T_DEPARTMENT, Tick.T_ChangeKind, \n"                        
                 +"        TICK.T_DEALCODE, TICK.T_DEALCODETS, TICK.T_DEALDATE, TICK.t_IsPartyClient, Pty.T_PARTYID, TICK.T_CHANGEDATE, TICK.T_INSTANCE, \n"
                 +"        fin_BA.t_FIID, fin_BA.t_fi_KIND \n"                               
                 +"       ,NVL ( \n"
                 +"        (SELECT 1 FROM DDLRQ_DBT rq \n"
                 +"        WHERE (    rq.t_docKind = TICK.T_BOFFICEKIND \n"
                 +"          AND rq.T_docid = TICK.T_DEALID \n"
                 +"          AND rq.t_TYPE IN (" + DLRQ_TYPE_AVANCE +"," + DLRQ_TYPE_DEPOSIT + ") \n"
                 +"          AND rq.t_DEALPART IN(1,2) \n"
                 +"          AND ROWNUM = 1)), \n"
                 +"            0 ) isAvance \n"
                 +"   from ddl_tick_dbt tick left outer join dparty_dbt Pty "
                 +"         on ((Pty.T_PARTYID = TICK.T_CLIENTID and TICK.T_CLIENTID >0) or (Pty.T_PARTYID = TICK.T_PARTYID and TICK.T_ISPARTYCLIENT = 'X') or (Pty.T_PARTYID = "+{OurBank}+" and TICK.T_CLIENTID <=0)), "
                 +"        dfininstr_dbt fin_BA, (select max (t_factDate) as t_FactDate, t_DocKind, t_DocID from ddlrq_dbt rq group by t_DocKind, t_DocID ) rq_query, \n"                          
                 +"        ddl_leg_dbt l1 left join ddl_leg_dbt l2 on l1.t_dealid = l2.t_dealid and l2.t_legkind = 2                              \n"                          
                 +"  where TICK.T_BOFFICEKIND = "+DL_SECURITYDOC+"     \n"
                 +"    and L1.T_LEGKIND =0 and rq_query.t_DocKind = TICK.T_BOFFICEKIND and rq_query.t_DocID = TICK.T_DealID      \n"
                 +"    and l1.t_dealid = tick.t_dealid \n "
                 +"    and ("
                 +"              (TICK.T_DEALDATE < " + GetSQLDate(m_dateMin) + " and rq_query.t_FactDate between " + GetSQLDate(m_dateMin) +
                                                                                                           " and " + GetSQLDate(m_dateMax)
                 +"           ) or (TICK.T_DEALDATE >= " + GetSQLDate(m_dateMin) + " and rq_query.t_FactDate <= " + GetSQLDate(m_dateMax)
                 +"           ) or (TICK.T_DEALDATE <= " + GetSQLDate(m_dateMin) + " and rq_query.t_FactDate > " + GetSQLDate(m_dateMax)
                 +"           ) or (TICK.T_DEALDATE between " + GetSQLDate(m_dateMin) + " and " + GetSQLDate(m_dateMax) + " and rq_query.t_FactDate > " + GetSQLDate(m_dateMax)
                 +"        ) )";
    if( m_DealClosed )
       Select = Select
                 +"    and TICK.T_DEALSTATUS = 20      \n"
                 +"    and ( l1.t_expiry  <= " + GetSQLDate(m_dateMax) 
                 +"    and l1.t_maturity   <= " + GetSQLDate(m_dateMax) 
                 +"    and NVL(l2.t_expiry," + GetSQLDate(m_dateMax) + ")  <= " + GetSQLDate(m_dateMax) 
                 +"    and NVL(l2.t_maturity, " + GetSQLDate(m_dateMax) + ") <=  " + GetSQLDate(m_dateMax) + ")";
    elif( m_DealReadied )
       Select = Select
                 +"    and (TICK.T_DEALSTATUS <=10   or     \n"
/*bpv добавил в выборку пару leg'ов и условие на даты. Чтобы открытые сделки можно было как-то отобрать и в архиве*/
                 +"    ( TICK.T_DEALSTATUS =20 and (l1.t_expiry  > " + GetSQLDate(m_dateMax) 
                 +"    or l1.t_maturity   > " + GetSQLDate(m_dateMax) 
                 +"    or l2.t_expiry  > " + GetSQLDate(m_dateMax) 
                 +"    or l2.t_maturity >  " + GetSQLDate(m_dateMax) + ")))";
    else
//       Select = Select
//                 +"    and TICK.T_DEALSTATUS >=10        \n";
    end;
    
    if( m_DprtID != -1 )
       Select = Select
                 +"    and TICK.T_DEPARTMENT = "+m_DprtID+"\n";
    end;

    Select = Select
                 +"    and exists(select 1 from ddp_dep_dbt where t_code = TICK.T_DEPARTMENT)";

    if( m_DealMarket and (m_MarketID <= 0) and m_DealNotMarket and m_DealBroker and (m_BrokerID <= 0) )
       /*не накладываем условия*/
    else

       Select = Select + " and ( ";

       if( m_DealMarket )
          Select = Select + "  ( (rsb_secur.IsExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind)), 1)=1 ";
          if( m_MarketID > 0 )
             Select = Select + " and tick.t_MarketID = "+m_MarketID;
          end;

          Select = Select + "       )"
                          + "       or ( rsb_secur.IsOutExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind)))=1 "
                          + "            and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND ="+PTK_MARKETPLASE+" and Pto.T_PARTYID = tick.t_BrokerID) ";

          if( m_MarketID > 0 )
             Select = Select + " and tick.t_BrokerID = "+m_MarketID;
          end;

          Select = Select + "       ) "
                          + " )";
       end;

       if( m_DealNotMarket )
          if( m_DealMarket )
             Select = Select + " or ";
          end;
          Select = Select + " rsb_secur.IsOutExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind)), 1)=1 ";
       end;

       if( m_DealBroker )
          if( m_DealMarket or m_DealNotMarket )
             Select = Select + " or ";
          end;
          Select = Select + " ( rsb_secur.IsBroker(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind)))=1 ";
          if( m_BrokerID > 0 )
             Select = Select + " and tick.t_BrokerID = "+m_BrokerID;
          end;
          Select = Select + " ) ";
       end;

       Select = Select + " ) ";
    end;

    if( m_IsOwn )
       Select = Select
               +"    and (Pty.T_PartyID = "+{OurBank};
    end;

    if( m_IsClient )

       if( m_IsOwn )
          Select = Select
               +" or ";
       else
          Select = Select
               +" and ";
       end;

       if( m_ClientID > 0 )
          Select = Select
                  +"    Pty.T_PartyID = "+m_ClientID+"\n";
       else
          Select = Select
                  +"         (Pty.T_PartyID != " +{OurBank};

          if( (m_IsForm > 0) and (m_FormSub != 0) )
            if(m_IsForm == 1)
              Select = Select + " and Pty.T_LEGALFORM = " + String (m_FormSub);
            end;
            if(m_IsForm == 2)             
              Select = Select + " and Pty.T_LEGALFORM !=   " + String (m_FormSub);
            end;
          end;
         
          if(m_NoResident)
            Select = Select + " and Pty.T_NOTRESIDENT = 'X' "; 
          end;
         
          if( (m_IsVid > 0) and (m_VidSub != 0) )            
            if(m_IsVid == 1)
              Select = Select + "   and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (m_VidSub) +" and Pto.T_PARTYID = Pty.T_PartyID ) ";
            end;
            if(m_IsVid == 2)             
              Select = Select + "   and NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (m_VidSub)+ " and Pto.T_PARTYID = Pty.T_PartyID ) " ;
            end;
          end;
         
          Select = Select +")";

       end;

    end;

    if( m_IsOwn )
       Select = Select +")";
    end;
    /*В отчете выводится та ценная бумага, которая была указана при заключении сделки, поэтому по ней и ведем все проверки по условиям ц\б*/
    Select = Select +"  and fin_BA.t_fiid = case when tick.t_ChangeDate = to_date('01.01.0001','DD.MM.YYYY') "
                    +"                           then (select leg.T_PFI from ddl_leg_dbt leg "
                    +"                                  where leg.t_DealID = tick.t_DealID "
                    +"                                    and leg.T_LEGID = 0 "
                    +"                                    and leg.T_LEGKind = 0 "
                    +"                                ) "
                    +"                           else (select ch.t_OldPFI1 from dsptkchng_dbt ch "
                    +"                                  where ch.t_DealID = tick.t_DealID "
                    +"                                    and ch.t_OldInstance = 0 "
                    +"                                ) end  \n";                                                                                   
 
    if( m_AvrID != -1 )
       Select = Select + " and fin_BA.t_FIID = "+m_AvrID;
    else
       if( m_AvrTypeID != -1 )
          Select = Select + " and RSB_FIInstr.FI_AvrKindsEQ(2,"+m_AvrTypeID+", fin_BA.t_AvoirKind) = 1 ";
       end;

       if( m_FI_Kinds != -1 )
          Select = Select + " and fin_BA.t_FI_KIND = "+m_FI_Kinds;
       end;
       
       if( m_EmiID > 0 )
          Select = Select + " and fin_BA.t_Issuer = " + string(m_EmiID);
       end;
    end;

    if( m_Qualified != -1 )
       if( m_Qualified == 0 )/*Квалифицированные*/
          Select = Select + " and RSB_FIInstr.FI_IsQualified(fin_BA.t_fiid,tick.t_DealDate) = 1 ";
       elif( m_Qualified == 1 )/*Неквалифицированные (все сделки)*/
          Select = Select + " and RSB_FIInstr.FI_IsQualified(fin_BA.t_fiid,tick.t_DealDate) != 1 ";
       else/*Неквалифицированные (только покупки)*/
          Select = Select + " and RSB_FIInstr.FI_IsQualified(fin_BA.t_fiid,tick.t_DealDate) != 1 ";
          Select = Select + " and ( Rsb_Secur.IsBuy(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) = 1 "
                          + "       or ( Rsb_Secur.IsSale(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) = 1 "
                          + "            and TICK.T_ISPARTYCLIENT = 'X'"
                          + "          )"
                          + "     )";
          Select = Select + " and Rsb_Secur.IsTwoPart(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) != 1 ";
       end;
    end;
                      // Кроме Покупки/Продажи, у которых выставлен признак ПФИ
    Select = Select + " and  NOT ( tick.t_ISPFI = chr(88) and tick.t_BofficeKind = 101 and  1 <> Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) )";

    Select = Select +")"
                 +" LOOP \n"
                 +"    notpfi.T_DEPARTMENT   := one_rec.T_DEPARTMENT; \n"                                                                      
                 +"    notpfi.T_KINDBO       := 0;               \n";

    if( m_Qualified != -1 )
       if( m_Qualified == 0 )/*Квалифицированные*/
          Select = Select + " notpfi.T_DEALTYPE  := 0; \n ";
       elif( m_Qualified == 1 )/*Неквалифицированные (все сделки)*/
          Select = Select + " notpfi.T_DEALTYPE  := 1; \n ";
       else/*Неквалифицированные (только покупки)*/
          Select = Select + " notpfi.T_DEALTYPE  := 2; \n ";
       end;
    else
       Select = Select
                 +"    if(RSB_FIInstr.FI_IsQualified(one_rec.t_fiid,one_rec.t_DealDate)=1)then "                                                   
                 +"       notpfi.T_DEALTYPE  := 0; \n"                                  
                 +"    else "                                                   
                 +"       notpfi.T_DEALTYPE  := 1; \n"                                  
                 +"    end if; ";
    end;

    Select = Select
                 +"    notpfi.T_DEALKIND     := case when one_rec.T_PartyID = "+{OurBank}+" then 0 else 1 end; \n"                                  
                 +"    notpfi.T_DEALID       := one_rec.t_DEAlID;   \n"                                                                
                 +"    notpfi.T_BOFFICEKIND  := one_rec.t_BofficeKind; \n"                                                                
                 +"    notpfi.T_LEGKIND      := 0;   \n"                                                                
                 +"    notpfi.T_DEALCODE     := one_rec.T_DEALCODE;   \n"                                                                
                 +"    notpfi.T_DEALCODETS   := one_rec.T_DEALCODETS; \n"                                                                
                 +"    notpfi.T_DEALTIME     := one_rec.T_DEALTIME;   \n"
                 +"    notpfi.T_ClientID     := case when one_rec.T_PartyID = "+{OurBank}+" then -1 else one_rec.T_PartyID end; \n"                                  
                 +"    notpfi.T_STATEAVANCE  := one_rec.isAvance; \n"  
                 +"    notpfi.T_FIID         := one_rec.t_FIID; \n";                                  

    if( not m_ShowDealChange )
       Select = Select
                 +"    notpfi.T_DEALDATE     := one_rec.T_DEALDATE; \n"                                                                
                 +"    notpfi.T_BCID         := 0;  \n"                                                                
                 +"    g_notpfi_ins.extend;                          \n"                                                      
                 +"    g_notpfi_ins(g_notpfi_ins.LAST) := notpfi;    \n";
    else
       Select = Select
                 +"    if( one_rec.T_CHANGEDATE = to_date('01.01.0001','DD.MM.YYYY') or ( one_rec.T_CHANGEDATE <= "+GetSQLDate(m_dateMax)+" and one_rec.T_ChangeKind not in(2,3,9) ) )then \n"
                 +"       notpfi.T_DEALDATE     := case when one_rec.T_CHANGEDATE > to_date('01.01.0001','DD.MM.YYYY') then one_rec.T_CHANGEDATE else one_rec.T_DEALDATE end; \n"                                                                
                 +"       notpfi.T_BCID         := one_rec.T_INSTANCE;  \n"                                                                
                 +"       g_notpfi_ins.extend;                          \n"                                                      
                 +"       g_notpfi_ins(g_notpfi_ins.LAST) := notpfi;    \n"
                 +"    end if; \n"
                 +"    for tkch_rec IN                                 \n"                                                
                 +"      (select CH.T_OLDCHANGEDATE, CH.T_OLDINSTANCE  \n"
                 +"        from dsptkchng_dbt ch                       \n"
                 +"       where ch.t_dealid = one_rec.t_DealID         \n"
                 +"         and ( CH.T_OLDCHANGEDATE = to_date('01.01.0001','DD.MM.YYYY') "
                 +"               or (CH.T_OLDCHANGEDATE <= "+GetSQLDate(m_dateMax)
                 +"                    and /*костыль для битых записей в базе(да, такие могут быть)*/ CH.T_OLDINSTANCE != one_rec.T_INSTANCE "
                 +"                  ) \n"
                 +"             )      \n"
                 +"         and CH.T_OldChangeKind not in(2,3,4,9) "
                 +"         and ch.t_oldchangedate != one_rec.t_dealdate "
                 +"      )             \n"
                 +"    loop            \n"
                 +"       notpfi.T_DEALDATE     := case when tkch_rec.T_OLDCHANGEDATE > to_date('01.01.0001','DD.MM.YYYY') then tkch_rec.T_OLDCHANGEDATE else one_rec.T_DEALDATE end; \n"                                                                
                 +"       notpfi.T_BCID         := tkch_rec.T_OLDINSTANCE; \n"                                                                
                 +"       notpfi.T_STATEAVANCE  := 0; \n"
                 +"       g_notpfi_ins.extend;                          \n"                                                      
                 +"       g_notpfi_ins(g_notpfi_ins.LAST) := notpfi;    \n"
                 +"    end loop; \n";
    end;

    Select = Select                                                  
                 +" END LOOP;                                               \n"                                                     
                 +" IF g_notpfi_ins IS NOT EMPTY THEN                       \n"                                         
                 +"     FORALL i IN g_notpfi_ins.FIRST .. g_notpfi_ins.LAST \n"                                                   
                 +"       INSERT INTO DDLNOTPFI_TMP VALUES g_notpfi_ins(i); \n"                                                                     
                 +"     g_notpfi_ins.delete;                                \n"                                                   
                 +" END IF;                                                 \n"                                                   
                 +"END; ";

    SQL_Execute(Select, "Подготовка данных модуля \"Ценные бумаги\"", true);

  end;

  private macro CollectDataByDV()
    var Query = "";


    var Select = " DECLARE \n"                                                                                                               
                 +"    TYPE notpfi_t IS TABLE OF DDLNOTPFI_TMP%ROWTYPE; \n"                                                                
                 +"        g_notpfi_ins notpfi_t := notpfi_t(); \n"                                                                        
                 +"        notpfi DDLNOTPFI_TMP%rowtype; \n"                                                                               
                 +"     BEGIN \n"                                                                                                          
                 +"    FOR one_rec IN  \n"                                                                                                 
                 +"(select TICK.T_ID T_DEALID, TICK.T_DOCKIND T_BOFFICEKIND, LEG.T_TYPE T_LEGKIND, TICK.T_TIME T_DEALTIME, TICK.T_DEPARTMENT, \n"                        
                 +"        TICK.T_CODE T_DEALCODE, TICK.T_EXTCODE T_DEALCODETS, TICK.T_DATE T_DEALDATE, TICK.T_CLIENT T_CLIENTID, fin_BA.t_FIID, fin_BA.t_fi_KIND \n"                               
                 +"   from ddvndeal_dbt tick, ddvnfi_dbt leg, dfininstr_dbt fin_BA                              \n"                          
                 +"  where TICK.T_DOCKIND in( " + DL_DVFXDEAL + ", " + DL_DVNDEAL + " ) and TICK.t_IsPFI = chr(0) \n" /*PNV 510212*/
                 +"    and tick.t_DvKind in( " + DV_CURSWAP + ", " + DV_CURSWAP_FX + ", " + DV_FORWARD_FX + " ) " /*PNV 510212*/
                 +"    and TICK.T_STATE > 0        \n"
                 +"    and ("
                 +"              TICK.T_DATE < " + GetSQLDate(m_dateMin) + " and (case when leg.t_SuplDate > leg.t_PayDate then leg.t_SuplDate else leg.t_PayDate end) between " + GetSQLDate(m_dateMin)
                                                                                                                                                                       + " and " + GetSQLDate(m_dateMax)
                 +"           or TICK.T_DATE >= " + GetSQLDate(m_dateMin) + " and (case when leg.t_SuplDate > leg.t_PayDate then leg.t_SuplDate else leg.t_PayDate end) <= " + GetSQLDate(m_dateMax)
                 +"           or TICK.T_DATE <= " + GetSQLDate(m_dateMin) + " and (case when leg.t_SuplDate > leg.t_PayDate then leg.t_SuplDate else leg.t_PayDate end) > " + GetSQLDate(m_dateMax)
                 +"           or TICK.T_DATE < " + GetSQLDate(m_dateMin) + " and (case when leg.t_SuplDate > leg.t_PayDate then leg.t_SuplDate else leg.t_PayDate end) > " + GetSQLDate(m_dateMax)
                 +"           OR TICK.T_DATE between " + GetSQLDate(m_dateMin) + " and " + GetSQLDate(m_dateMax) /*PNV 518847*/ 
                 +"        )"

                 +"    and ( "
                 +"          ( TICK.T_CLIENT > 0 and (fin_BA.t_FI_KIND = "+FIKIND_CURRENCY+ /*" or fin_BA.t_FI_KIND = "+FIKIND_METAL+ */ ") )\n"
                 +"        )";

    if( m_DealClosed )
       Select = Select
                 +"    and TICK.T_STATE = 2      \n";
    elif( m_DealReadied )
       Select = Select
                 +"    and TICK.T_STATE = 1      \n";
    end;

    if( m_DprtID != -1 )
       Select = Select
                 +"    and TICK.T_DEPARTMENT = "+m_DprtID+"\n";
    end;

    Select = Select
                 +"    and exists(select 1 from ddp_dep_dbt where t_code = TICK.T_DEPARTMENT)";

    if( m_DealMarket and (m_MarketID <= 0) and m_DealNotMarket and m_DealBroker and (m_BrokerID <= 0) )
       /*не накладываем условия*/
    else

       Select = Select + " and ( ";

       if( m_DealMarket )
          Select = Select +" (((EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + String (PTK_MARKETPLASE) +" and Pto.T_PARTYID = TICK.T_CONTRACTOR ) and TICK.T_MarketKind = "+DV_MARKETKIND_SPFIMARKET+" )"
                          +"  or TICK.T_Sector = 'X')";
          if( m_MarketID > 0 )
             Select = Select + " and TICK.T_CONTRACTOR = "+m_MarketID;
          end;

          Select = Select + " )";
       end;

       if( m_DealNotMarket )
          if( m_DealMarket )
             Select = Select + " or ";
          end;
          Select = Select +" not (EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + String (PTK_MARKETPLASE) +" and Pto.T_PARTYID = TICK.T_CONTRACTOR ) and TICK.T_Sector = 'X')";
       end;

       if( m_DealBroker )
          if( m_DealMarket or m_DealNotMarket )
             Select = Select + " or ";
          end;
          Select = Select +" ( (EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + String (PTK_MARKETPLASE) +" and Pto.T_PARTYID = TICK.T_CONTRACTOR ) and TICK.T_Sector = 'X') and TICK.T_Agent > 0 ";
          if( m_BrokerID > 0 )
             Select = Select + " and TICK.T_Agent = "+m_BrokerID;
          end;
          Select = Select + " ) ";
       end;

       Select = Select + " ) ";
    end;

    if( m_IsOwn )
       Select = Select
               +"    and (TICK.T_CLIENT <= 0 \n";
    end;

    if( m_IsClient )

       if( m_IsOwn )
          Select = Select
               +" or ";
       else
          Select = Select
               +" and ";
       end;

       if( m_ClientID > 0 )
          Select = Select
                  +"    TICK.T_CLIENT = "+m_ClientID+"\n";
       else
          Select = Select
                  +"         (TICK.T_CLIENT > 0 \n";

          if( (m_IsForm > 0) and (m_FormSub != 0) )
            if(m_IsForm == 1)
              Query = Query + " and Pty.T_LEGALFORM = " + String (m_FormSub);
            end;
            if(m_IsForm == 2)             
              Query = Query + " and Pty.T_LEGALFORM !=   " + String (m_FormSub);
            end;
          end;
         
          if(m_NoResident)
            if( Query != "" )
               Query = Query + " and "; 
            end;
            Query = Query + " Pty.T_NOTRESIDENT = 'X' "; 
          end;
         
          if( Query != "" )
             Select = Select + " and EXISTS (select 1 from dparty_dbt pty where "+Query+") ";
          end;
          
          if( (m_IsVid > 0) and (m_VidSub != 0) )            
            if(m_IsVid == 1)
              Select = Select + "   and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (m_VidSub) +" and Pto.T_PARTYID = TICK.T_CLIENT ) ";
            end;
            if(m_IsVid == 2)             
              Select = Select + "   and NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (m_VidSub)+ " and Pto.T_PARTYID = TICK.T_CLIENT ) " ;
            end;
          end;
         
          Select = Select +")";

       end;

    end;

    if( m_IsOwn )
       Select = Select +")";
    end;

    Select = Select
                 +"    and leg.T_DEALID = TICK.T_ID  \n"                                                                                   
                 +"    and fin_BA.t_fiid =  leg.T_FIID   \n";                                                                                   
 
    if( m_AvrID != -1 )
       Select = Select + " and fin_BA.t_FIID = "+m_AvrID;
    else
       if( m_AvrTypeID != -1 )
          Select = Select + " and RSB_FIInstr.FI_AvrKindsEQ(2,"+m_AvrTypeID+", fin_BA.t_AvoirKind) = 1 ";
       end;

       if( m_FI_Kinds != -1 )
          Select = Select + " and fin_BA.t_FI_KIND = "+m_FI_Kinds;
       end;
       
       if( m_EmiID > 0 )
          Select = Select + " and fin_BA.t_Issuer = " + string(m_EmiID);
       end;
    end;

    Select = Select +")"
                 +" LOOP                                 \n"                                                                      
                 +"    notpfi.T_DEPARTMENT   := one_rec.T_DEPARTMENT; \n"                                                                      
                 +"    notpfi.T_KINDBO       := 1;               \n"                                                                    
                 +"    notpfi.T_DEALTYPE     := one_rec.t_FI_KIND; \n"                                  
                 +"    notpfi.T_DEALKIND     := case when one_rec.T_CLIENTID > 0 then 1 else 0 end; \n"                                  
                 +"    notpfi.T_DEALID       := one_rec.t_DEAlID;   \n"                                                                
                 +"    notpfi.T_BOFFICEKIND  := one_rec.t_BofficeKind;  \n"                                                                
                 +"    notpfi.T_LEGKIND      := one_rec.T_LEGKIND;   \n"                                                                
                 +"    notpfi.T_DEALCODE     := one_rec.T_DEALCODE;    \n"                                                                
                 +"    notpfi.T_DEALCODETS   := one_rec.T_DEALCODETS;    \n"                                                                
                 +"    notpfi.T_DEALDATE     := one_rec.T_DEALDATE;    \n"                                                                
                 +"    notpfi.T_DEALTIME     := one_rec.T_DEALTIME;   \n"                                                                
                 +"    notpfi.T_CLIENTID     := one_rec.T_CLIENTID;   \n"                                                                
                 +"    notpfi.T_BCID         := 0;  \n"                                                                
                 +"    g_notpfi_ins.extend;                               \n"                                                      
                 +"    g_notpfi_ins(g_notpfi_ins.LAST) := notpfi;         \n"                                                      
                 +" END LOOP;                                             \n"                                                     
                 +" IF g_notpfi_ins IS NOT EMPTY THEN                       \n"                                         
                 +"     FORALL i IN g_notpfi_ins.FIRST .. g_notpfi_ins.LAST \n"                                                   
                 +"       INSERT INTO DDLNOTPFI_TMP VALUES g_notpfi_ins(i); \n"                                                                     
                 +"     g_notpfi_ins.delete;                                \n"                                                   
                 +" END IF;                                                 \n"                                                   
                 +"END; ";

    SQL_Execute(Select, "Подготовка данных модуля \"ФИСС и КО\"", true);

  END;

  private macro CollectDataByVA()
    var Query = "";
    var Select = " DECLARE \n"                                                                                                               
                 +"    TYPE notpfi_t IS TABLE OF DDLNOTPFI_TMP%ROWTYPE; \n"                                                                
                 +"        g_notpfi_ins notpfi_t := notpfi_t(); \n"                                                                        
                 +"        notpfi DDLNOTPFI_TMP%rowtype; \n"                                                                               
                 +"     BEGIN \n"                                                                                                          
                 +"    FOR one_rec IN  \n"                                                                                                 
                 +"(select TICK.T_DEALID, TICK.T_BOFFICEKIND, LEG.T_LEGKIND, TICK.T_DEALTIME, TICK.T_DEPARTMENT, \n"                        
                 +"        TICK.T_DEALCODE, TICK.T_DEALCODETS, TICK.T_DEALDATE, TICK.T_CLIENTID, bnr.T_BCID \n"                               
                 +"   from ddl_tick_dbt tick, DVSORDLNK_DBT vs, DVSBANNER_DBT bnr, ddl_leg_dbt leg, DOPRKOPER_DBT opr  \n"                          
                 +"  where TICK.T_BOFFICEKIND = "+DL_VEKSELACCOUNTED+"     \n"
                 +"    and TICK.T_DEALSTATUS >=10        \n"                                                                                   
                 +"    and TICK.T_DEALDATE between "+GetSQLDate(m_dateMin)+" and "+GetSQLDate(m_dateMax)
                 +"    and vs.T_CONTRACTID = tick.T_DEALID "
                 +"    and bnr.T_BCID = vs.T_BCID "
                 +"    AND not exists(SELECT t_PartyID FROM ddp_dep_dbt WHERE t_PartyID = bnr.t_Issuer) "
                 +"    AND opr.T_KIND_OPERATION = tick.T_DEALTYPE "
                 +"    AND opr.T_SysTypes <> 'X' AND opr.T_SysTypes <> 'XF' AND opr.T_SysTypes <> 'XW' and opr.T_SysTypes <> 'WB' and opr.T_SysTypes <> 'WS' ";

    if( m_DealClosed )
       Select = Select
                 +"    and TICK.T_DEALSTATUS = 20      \n";
    elif( m_DealReadied )
       Select = Select
                 +"    and TICK.T_DEALSTATUS = 10      \n";
    end;

    if( m_DprtID != -1 )
       Select = Select
                 +"    and TICK.T_DEPARTMENT = "+m_DprtID+"\n";
    end;

    Select = Select
                 +"    and exists(select 1 from ddp_dep_dbt where t_code = TICK.T_DEPARTMENT)";

    if( m_IsOwn )
       Select = Select
               +"    and (TICK.T_CLIENTID <= 0 \n";
    end;

    if( m_IsClient )

       if( m_IsOwn )
          Select = Select
               +" or ";
       else
          Select = Select
               +" and ";
       end;

       if( m_ClientID > 0 )
          Select = Select
                  +"    TICK.T_CLIENTID = "+m_ClientID+"\n";
       else
          Select = Select
                  +"         (TICK.T_CLIENTID > 0 \n";

          if( (m_IsForm > 0) and (m_FormSub != 0) )
            if(m_IsForm == 1)
              Query = Query + " and Pty.T_LEGALFORM = " + String (m_FormSub);
            end;
            if(m_IsForm == 2)             
              Query = Query + " and Pty.T_LEGALFORM !=   " + String (m_FormSub);
            end;
          end;
         
          if(m_NoResident)
            if( Query != "" )
               Query = Query + " and "; 
            end;
            Query = Query + " Pty.T_NOTRESIDENT = 'X' "; 
          end;
         
          if( Query != "" )
             Select = Select + " and EXISTS (select 1 from dparty_dbt pty where "+Query+") ";
          end;
          
          if( (m_IsVid > 0) and (m_VidSub != 0) )            
            if(m_IsVid == 1)
              Select = Select + "   and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (m_VidSub) +" and Pto.T_PARTYID = TICK.T_CLIENTID ) ";
            end;
            if(m_IsVid == 2)             
              Select = Select + "   and NOT EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND =" + String (m_VidSub)+ " and Pto.T_PARTYID = TICK.T_CLIENTID ) " ;
            end;
          end;
         
          Select = Select +")";

       end;

    end;

    if( m_IsOwn )
       Select = Select +")";
    end;

    Select = Select                                                                      
                 +"    and leg.T_DEALID = TICK.T_DEALID  \n"                                                                                   
                 +"    and leg.T_LEGID = 0  \n"                                                                                   
                 +"    and leg.T_LEGKind = "+LEG_KIND_DL_TICK;                                                                                   
 
    if( (m_FI_Kinds == 2) and (m_AvrTypeID != -1) )
       if( FI_AvrKindsEQ(2,AVOIRISSKIND_BILL,m_AvrTypeID) ) // Вексель
          Select = Select +  "AND bnr.T_BCFormKind = 1 ";
       elif( FI_AvrKindsEQ(2,AVOIRISSKIND_BANKCERT,m_AvrTypeID) ) // Банковский Сертификат
          Select = Select +  "AND bnr.T_BCFormKind = 2 ";
       else
          Select = Select +  "AND bnr.T_BCFormKind = -1 ";
       end;
    elif( (m_FI_Kinds == 2) or (m_FI_Kinds == -1) )
       Select = Select +  "AND (bnr.T_BCFormKind = 1 OR bnr.T_BCFormKind = 2 )";
    end;
    
    if( m_EmiID > 0 )
       Select = Select + " and vs.T_ISSUER = " + string(m_EmiID);
    end;

    Select = Select +")"
                 +" LOOP                                 \n"                                                                      
                 +"    notpfi.T_DEPARTMENT   := one_rec.T_DEPARTMENT; \n"                                                                      
                 +"    notpfi.T_KINDBO       := 2;               \n"                                                                    
                 +"    notpfi.T_DEALTYPE     := 2; \n"                                  
                 +"    notpfi.T_DEALKIND     := case when one_rec.T_CLIENTID > 0 then 1 else 0 end; \n"                                  
                 +"    notpfi.T_DEALID       := one_rec.t_DEAlID;   \n"                                                                
                 +"    notpfi.T_BOFFICEKIND  := one_rec.t_BofficeKind;  \n"                                                                
                 +"    notpfi.T_LEGKIND      := one_rec.T_LEGKIND;   \n"                                                                
                 +"    notpfi.T_DEALCODE     := one_rec.T_DEALCODE;    \n"                                                                
                 +"    notpfi.T_DEALCODETS   := one_rec.T_DEALCODETS;    \n"                                                                
                 +"    notpfi.T_DEALDATE     := one_rec.T_DEALDATE;    \n"                                                                
                 +"    notpfi.T_DEALTIME     := one_rec.T_DEALTIME;   \n"                                                                
                 +"    notpfi.T_CLIENTID     := one_rec.T_CLIENTID;   \n"                                                                
                 +"    notpfi.T_BCID         := one_rec.t_BCID;  \n"                                                                
                 +"    g_notpfi_ins.extend;                               \n"                                                      
                 +"    g_notpfi_ins(g_notpfi_ins.LAST) := notpfi;         \n"                                                      
                 +" END LOOP;                                             \n"                                                     
                 +" IF g_notpfi_ins IS NOT EMPTY THEN                       \n"                                         
                 +"     FORALL i IN g_notpfi_ins.FIRST .. g_notpfi_ins.LAST \n"                                                   
                 +"       INSERT INTO DDLNOTPFI_TMP VALUES g_notpfi_ins(i); \n"                                                                     
                 +"     g_notpfi_ins.delete;                                \n"                                                   
                 +" END IF;                                                 \n"                                                   
                 +"END; ";

    SQL_Execute(Select, "Подготовка данных модуля \"Учтенные векселя\"", true);

  END;

  macro CollectData()
     if( m_BO == "X" )
        CollectDataByBO();
     end;
     if (m_DV == "X" )
        CollectDataByDV();  
     end;
     if (m_VA == "X" )
        CollectDataByVA();  
     end;
  end;

  macro PrintByFXDeal()

    var DealKindName = "", CalcMethod = "", SumInNatCur = $0, DocNumber = "", RecNumber = "", Place = "", DocDate = "", ContrShortName = "";
    var trnOutRUR = 0, trnOutUSD = 0, trnOutEUR = 0, trnOutCHF = 0, trnOutGBP = 0, trnInRUR = 0, trnInUSD = 0, trnInEUR = 0, trnInCHF = 0, trnInGBP = 0; /*PNV 531250*/
    // 23.01.2020 KS Определение остатков
    
    var Select = " select TICK.T_AGENT T_BROKERID, TICK.T_CONTRACTOR T_PARTYID, "
                +"        TICK.T_TYPE T_DEALTYPE,  "
                +"        FIN_KA.T_FIID KA_FIID,"
                +"        FIN_BA.T_FIID BA_FIID,"
                +"        leg.T_AMOUNT Amount_BA," 
                +"        LEG.T_PRICE Price_KA,               "
                +"        leg.T_COST Cost_KA,       "
                +"        leg.T_SUPLDATE  PlanDate_BA," 
                +"        leg.T_PAYDATE PlanDate_KA,   "
                +"        leg.T_DVP,   "
                +"        case when fin_BA.t_FI_KIND = "+FIKIND_CURRENCY+" then (case when FIN_BA.T_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else FIN_BA.T_CCY end) else FIN_BA.T_FI_CODE end AvrCode, "
                +"        case when FIN_KA.T_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else FIN_KA.T_CCY end KA_CCY,"
                +"        case when EXISTS (select 1 from dpartyown_dbt Pto "
                +"                           where Pto.T_PARTYKIND = " + String (PTK_MARKETPLASE) 
                +"                              and Pto.T_PARTYID = TICK.T_CONTRACTOR) and TICK.T_Sector = 'X' then 1 else 0 end IsExchange, "
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_CONTRACTOR) ContrShortName, "
                +"        (party.t_ShortName) ClientShortName, "
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_AGENT) BROKERShortName, "
                +"        TICK.T_CLIENT Client, " //20.03.2020 Chesnokov D.S. 506872 Сборная солянка из отчета брокера по определению планового остатка
                +"        TICK.T_AGENTContr BROKERContr, "
                // KS 17.02.2020 I-Sup 503651 Колонка Номер соглашения с клиентом должна заполняться значением номер договора, а не субдоговора
                + "        NVL((sfcontr.t_number), CHR(1)) as SfContrNumber, "
                +"        case when fin_BA.t_FI_KIND = 2 "
                +"             then (select avr.t_shortname from davrkinds_dbt avr where avr.t_fi_kind = 2 and avr.t_avoirkind = fin_BA.t_avoirkind) "
                +"             else (select avr.t_name from dfikinds_dbt avr where avr.t_fi_kind = fin_BA.t_FI_KIND) end AvrKind, "
                +"        case when fin_BA.t_FI_KIND = 2 "
                +"             then (select avr.t_Series||', '||avr.t_Tranche from davoiriss_dbt avr where avr.t_fiid = fin_BA.t_FIID) end AvrSeries, "
                +"        case when fin_BA.t_FI_KIND = 2 "
                +"             then (select NVL(avr.t_ISIN,NVL(avr.t_LSIN,'')) from davoiriss_dbt avr where avr.t_fiid = fin_BA.t_FIID) end AvrISIN, "
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = fin_BA.t_Issuer) IssShortName, "
                +"        (select PM.T_VALUEDATE from dpmpaym_dbt pm "
                +"          where PM.T_DOCUMENTID = TICK.T_ID and PM.T_DOCKIND = TICK.T_DOCKIND "
                +"            and ((PM.T_PURPOSE =1 and LEG.T_Type = 0) or (PM.T_PURPOSE =3 "
                +"            and LEG.T_Type = 2)) and (PM.T_PAYMSTATUS >= 3000 or PM.T_PAYMSTATUS = 150 ) and rownum = 1) FactDate_BA, "
                +"        (select PM.T_VALUEDATE from dpmpaym_dbt pm "
                +"          where PM.T_DOCUMENTID = TICK.T_ID and PM.T_DOCKIND = TICK.T_DOCKIND "
                +"            and ((PM.T_PURPOSE =2 and LEG.T_Type = 0) or (PM.T_PURPOSE =4 and LEG.T_Type = 2)) "
                +"            and  (PM.T_PAYMSTATUS >= 3000 or PM.T_PAYMSTATUS = 150 ) and rownum = 1 ) FactDate_KA, "
                +"        case when Tick.T_CLIENT > 0 then "
                +"         (Select ATTR.T_NAME             "
                +"            From dobjatcor_dbt AtCor, dobjattr_dbt Attr " 
                +"           Where AtCor.t_ObjectType = "+OBJTYPE_SFCONTR
                +"             And AtCor.t_GroupID    = 1                 "
                +"             And AtCor.t_Object     = LPAD(TICK.T_CLIENTCONTR, 10, '0' ) "
                +"             And Attr.t_AttrID      = AtCor.t_AttrID     "
                +"             And Attr.t_ObjectType  = AtCor.t_ObjectType "
                +"             And Attr.t_GroupID     = AtCor.t_GroupID    "
                +"             and ATCOR.T_VALIDFROMDATE <= Tick.t_DATE "
                +"             and ATCOR.T_VALIDTODATE >= Tick.t_DATE "
                +"             and rownum = 1 "
                +"         )                                               "
                +"        else 'Хоз. субъект' end ClientStatus,            "
                +"        (select GR.T_CODE from DDL_GENAGR_DBT gr where gr.t_GenAgrID = tick.t_GenAgrID) N_gs, "
                +"        TICK.T_CLIENTCONTR CLIENTCONTR, "
                +"        nvl((select 'Валютный рынок/Режим торгов - Несистемный режим' "
                +"               from dnotetext_dbt notetext "
                +"              where notetext.t_objecttype=tick.t_kind "
                +"                and notetext.t_documentid=lpad(tick.t_id,34,'0') "
                +"                and notetext.t_notekind=150 and lower(utl_raw.cast_to_varchar2(t_text)) = 'spec' "
                +"                and rownum=1),'Валютный рынок/Режим торгов - Системный режим') as x1, "
                // KS 17.02.2020 I-Sup 503651 Колонка Дата заключения должна заполняться значением даты заключения договора, а не субдоговора
                + "        (sfcontr.T_DATECONC) as x3, "
                + "        (sfcontr.T_DATECLOSE) as x4, "
                +"         (party.t_Name) ClientName, "
                + "       NVL((select objcode.t_code "
                + "              from ddlobjcode_dbt objcode "
                + "             where objcode.t_objectid = dcm.t_DlContrID "
                + "               and objcode.t_codekind = 1 "
                + "               and objcode.t_objecttype = 207), "
                + "           CHR(1)) as ClientCode, "
                + "       leg.t_execdate, "
                + "       Tick.t_DATE, "
                // KS 17.02.2020 I-Sup 503651 Колонка Комиссия брокера в валюте расчетов должна заполняться значение комиссии Банка в разрезе сделок
                //Chesnokov D.S. 24.03.2020 Исправил отбор комиссии брокера в валюте расчетов
                +"        nvl((select sum(dlc.t_sum) from ddlcomis_dbt dlc, dsfcomiss_dbt sfc where dlc.t_docid = tick.t_id and dlc.t_dockind = tick.t_dockind and dlc.t_feetype = sfc.t_feetype and dlc.t_comnumber = sfc.t_number and upper(sfc.t_code) like 'МСКБ_ВБ_ДН%'),0) as x10, "
                +"        (select FIN.T_CCY from ddlcomis_dbt dlc, dsfcomiss_dbt sfc, dfininstr_dbt fin where dlc.t_docid = tick.t_id and dlc.t_dockind = tick.t_dockind and dlc.t_feetype = sfc.t_feetype and dlc.t_comnumber = sfc.t_number and upper(sfc.t_code) like 'МСКБ_ВБ_ДН%' and fin.t_fiid = sfc.t_fiid_comm ) as fiid_comm, " /*PNV 518846*/
                +"        nvl((select sum(dlc.t_sum) from ddlcomis_dbt dlc, dsfcomiss_dbt sfc where dlc.t_docid = tick.t_id and dlc.t_dockind = tick.t_dockind and dlc.t_feetype = sfc.t_feetype and dlc.t_comnumber = sfc.t_number and upper(sfc.t_code) not like 'МСКБ_ВБ_ДН%'),0) as CommsumRub, "  // 21.01.2021 MAA: iS - 519390
                +"        nvl((Select utl_raw.cast_to_varchar2(t_text) from dnotetext_dbt t where t_notekind=102 and t_documentid in (lpad(tick.T_ID,34,'0')) and t_objecttype = 140),'Адресная заявка') as x11, "
                +"        (decode(party.t_legalform, 2, 'ФЛ', 'ЮЛ') ) as x15, "
                +"        (party.t_nrcountry) as x16, "
                +"        (decode(party.t_notresident, chr(0), 'является', 'не является') ) as x17, "
                +"        NVL((select decode(t_state, 1, 'является', 'не является') from DSCQINV_DBT sih where sih.t_partyid = tick.T_CLIENT and sih.T_REGDATE <= tick.T_DATE and (sih.T_CHANGEDATE >= tick.T_DATE or sih.T_CHANGEDATE = to_date('01.01.0001', 'DD.MM.YYYY'))),'не является') as x18, "
                +"        NVL((select oa.t_name from dobjatcor_dbt oac, dobjattr_dbt oa                                  "
                +"              where oa.t_objecttype = 207 and oa.t_groupid = 103                                                           "
                +"                and oac.t_objecttype = oa.t_objecttype and oac.t_groupid = oa.t_groupid                                    "
                +"                and oac.t_object = lpad(dcm.t_dlcontrid, 34, '0') and oa.t_attrid = oac.t_attrid                           "
                +"                and oac.t_validfromdate <= tick.T_DATE and oac.t_validtodate >= tick.T_DATE and rownum = 1),chr(1)) as x19, "
                +"        (select oa.t_name from dobjattr_dbt oa where oa.t_objecttype = 659 and oa.t_groupid = 1 and dcm.t_role = oa.t_attrid) as x22, "
                +"        NVL(( SELECT SpGround.T_REGISTRDATE FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = tick.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ), tick.T_DATE) as x23 "
                +"   from ddvndeal_dbt tick, ddvnfi_dbt leg, dfininstr_dbt fin_BA, dfininstr_dbt fin_KA, ddlcontrmp_dbt dcm, dsfcontr_dbt sfcontr, ddlcontr_dbt dlcontr,  dparty_dbt party "
                +"  where TICK.T_ID = ?  "
                +"    and leg.T_DEALID = ?   "
                +"    and LEG.T_Type =  ? "
                +"    and fin_BA.t_fiid = leg.T_FIID"
                +"    and fin_KA.t_fiid = leg.T_PriceFIID "
                +"    AND dcm.t_sfcontrid = tick.T_CLIENTCONTR "
                +"    AND SFCONTR.T_ID = dlcontr.t_sfcontrid "
                +"    AND dlcontr.t_DlContrID = dcm.t_DlContrID "
                +"    AND SFCONTR.T_PARTYID = TICK.T_CLIENT "
                +"    AND Party.T_PARTYID = tick.T_CLIENT ";

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( m_Deal.DealID );
     cmd.addParam( m_Deal.DealID );
     cmd.addParam( m_Deal.LegKind );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )

       if( (DataSet.DEALTYPE == 1) or ((DataSet.DEALTYPE == 5)and(m_Deal.LegKind==0)) or ((DataSet.DEALTYPE == 6)and(m_Deal.LegKind==2))  )
          DealKindName = "Покупка";
       else
          DealKindName = "Продажа";
       end;

       if( DataSet.DVP == SET_CHAR )
          CalcMethod = "Поставка против платежа";
       else
          CalcMethod = "платежное поручение";
       end;

// KS Колонка по курсу ЦБ на дату заключения должна заполняться значением аналогично идентичной колонки отчета брокера
       if(DataSet.BA_FIID != NATCUR)
          SmartConvertSum(SumInNatCur, money(DataSet.Amount_BA), m_Deal.DEALDATE, DataSet.BA_FIID, NATCUR, true);
       else
          SumInNatCur = money(DataSet.Amount_BA);
       end;

       if( (DataSet.BROKERID > 0) and ВидСубъекта(DataSet.BrokerID, PTK_BROKER) )
          Place = "брокер "+DataSet.BrokerShortName;
       elif( DataSet.IsExchange )
          Place = DataSet.ContrShortName;
       else
          Place = "ПАО ""Московская Биржа"""; // I-Sup 503651 Колонка "Место совершения сделки" должно заполняться значением "ПАО "Московская Биржа" (Валютная секция)
          //Place = "вне биржи";
       end;
 
       if( ((DataSet.BROKERID > 0) and ВидСубъекта(DataSet.BrokerID, PTK_BROKER)) or (ВидСубъекта(DataSet.PartyID, PTK_CENTRALCONTR)) )
          ContrShortName = "";
       else
          ContrShortName = DataSet.ContrShortName;
       end;
            
       if( m_Deal.DEALKIND == СДЕЛКА_КЛИЕНТА )
          DocNumber = ПолучитьНомерПоручения(DL_DVFXDEAL,m_Deal.DealID,m_Deal.ClientID,(m_Deal.LegKind==2),@DocDate);
          if( (DocNumber == "") or (DocDate == date(0,0,0)) )
             DocDate = "";
          end;
       end;

       if( DataSet.IsExchange )
          RecNumber = ПолучитьНомерЗаявки(DL_DVFXDEAL,m_Deal.DealID);
       end;


       // 23.01.2020 KS Определение остатков
       var RestQuery;
       var RestDataSet;
       var tmpInd, dtEx;
       
       // 21.01.2021 MAA: iS - 519390
       if (DataSet.ExecDate < m_dateMin)
         dtEx = m_dateMin - 1;
       elif (DataSet.ExecDate > m_dateMax)
         dtEx = m_dateMax;
       else
         dtEx = date(DataSet.ExecDate) - 1;
       end;

       if (m_deal.dealkind!=СДЕЛКА_КЛИЕНТА)
           // Определим счет, на котором консолидировался остаток на 01.01.2019.
           RestQuery = RSdCommand( "select t_account            " +
                                   "  From dmcaccdoc_dbt t      " +
                                   " where t.t_catnum = 536     " +
                                   "   and t_iscommon = chr(88) " +
                                   "   and rsb_account.restac(t_account, t_currency, to_date('01012019', 'DDMMYYYY'), t_chapter, 0, 0) != 0");
           RestDataSet = TRsbDataSet( RestQuery );
           RestQuery.execute();

           if(RestDataSet.MoveNext()) // Определим остаток на этом счёте. Считаем, что счёт один
             RestQuery = RSdCommand( "select rsb_account.restac(t_account, acc.t_code_currency," + GetSQLDate( dtEx ) + ", acc.t_chapter, 0, 0)*decode(acc.t_kind_account, 'А', -1, 1) rest, " +
                                    // "       rsb_account.restac(t_account, acc.t_code_currency," + GetSQLDate( m_dateMax ) + ", acc.t_chapter, 0, 0)*decode(acc.t_kind_account, 'А', -1, 1) restPlan, " +
                                     "       FI.T_CCY AS CCY"
                                     "  from daccount_dbt acc, DFININSTR_DBT FI                             " +
                                     " where acc.t_account ='" + RestDataSet.account + "'                   " +
                                     "   and acc.t_chapter = 21                                             " +
                                     "   and fi.t_fiid = acc.t_code_currency                                " +
                                     "   and fi.t_fi_kind = 1                                               ");
           else
             RestQuery = "select 0 rest, 0 restPlan, 'RUR' CCY from dual";
           end;
       else
           RestQuery = RSdCommand( "select rsb_account.restac(ac.t_account,ac.t_code_currency," + GetSQLDate( dtEx ) + ",ac.t_chapter, null) rest, " + //20.03.2020 Chesnokov D.S. 506872 Сборная солянка из отчета брокера по определению планового остатка
                                   "       FI.T_CCY AS CCY                                                                                       " +
                                   "  from DSFCONTR_DBT SF, DACCOUNT_DBT AC, DSETTACC_DBT SA, DSFSSI_DBT SI, DFININSTR_DBT FI                    " +
                                   " where SF.T_ID = " + DataSet.CLIENTCONTR + "                                                                 " +
                                   "   AND SF.T_SERVKIND = 21                                                                                    " +
                                   "   AND SI.T_OBJECTTYPE = 659                                                                                 " +
                                   "   AND SI.T_OBJECTID = LPAD(SF.T_ID, 10, '0')                                                                " +
                                   "   AND SA.T_SETTACCID = SI.T_SETACCID                                                                        " +
                                   "   AND AC.T_ACCOUNT = SA.T_ACCOUNT                                                                           " +
                                   "   AND AC.T_CHAPTER = SA.T_CHAPTER                                                                           " +
                                   "   AND AC.T_CODE_CURRENCY = SA.T_FIID                                                                        " +
                                   "   AND AC.T_BALANCE IN ('30601', '30606')                                                                    " +
                                   "   AND FI.T_FIID = SA.T_FIID                                                                                 " +
                                   "   AND FI.T_FI_KIND = 1                                                                                      ");
       end;
       
       RestDataSet = TRsbDataSet( RestQuery );
       RestQuery.execute();
       RestRUR = RestUSD = RestEUR = RestCHF = RestGBP = 0.0;
       //arRestPlanRUR[indCID] = arRestPlanUSD[indCID] = arRestPlanEUR[indCID] = arRestPlanCHF[indCID] = arRestPlanGBP[indCID] = 0.0;
       While(RestDataSet.MoveNext())
         if (RestDataSet.CCY == "RUB")
           RestRUR = RestDataSet.rest;
         elif (RestDataSet.CCY == "USD")
           RestUSD = RestDataSet.rest;
         elif (RestDataSet.CCY == "EUR")
           RestEUR = RestDataSet.rest;
         elif (RestDataSet.CCY == "CHF")
           RestCHF = RestDataSet.rest;
         elif (RestDataSet.CCY == "GBP")
           RestGBP = RestDataSet.rest;
         end;
       end;

       // 21.01.2021 MAA: iS - 519390       
       if (m_Deal.clEn == 1)
         arRestPlanRUR[m_Deal.clNo] = RestRUR;
         arRestPlanUSD[m_Deal.clNo] = RestUSD;
         arRestPlanEUR[m_Deal.clNo] = RestEUR;
         arRestPlanCHF[m_Deal.clNo] = RestCHF;
         arRestPlanGBP[m_Deal.clNo] = RestGBP;
       else  /*PNV 531250 обнуление? Нет, не слышал*/
         arRestPlanRUR[m_Deal.clNo] = 0;
         arRestPlanUSD[m_Deal.clNo] = 0;
         arRestPlanEUR[m_Deal.clNo] = 0;
         arRestPlanCHF[m_Deal.clNo] = 0;
         arRestPlanGBP[m_Deal.clNo] = 0;
       end;
       
       //GetRestPlan(DataSet.CLIENT, DataSet.CLIENTCONTR, RestRUR, RestUSD, RestEUR, RestCHF, RestGBP, @RestPlanRUR, @RestPlanUSD, @RestPlanEUR, @RestPlanCHF, @RestPlanGBP); //20.03.2020 Chesnokov D.S. 506872 Сборная солянка из отчета брокера по определению планового остатка
       //lastCLIENTCONTR = DataSet.CLIENTCONTR;
       if (m_Deal.LegKind != 0) /* 11.05.2021 MAA: iS - 519390 */
           Dataset.CommSumRub = 0;
       end; 
       trnOutRUR = iif(DealKindName == "Продажа", iif(DataSet.AvrCode == "RUB", DataSet.Amount_BA + Dataset.CommSumRub + IIF(DataSet.fiid_comm == "RUB", DataSet.x10, 0), Dataset.CommSumRub + IIF(DataSet.fiid_comm == "RUB", DataSet.x10, 0)), iif(DataSet.KA_CCY == "RUB", DataSet.Cost_KA + Dataset.CommSumRub + IIF(DataSet.fiid_comm == "RUB", DataSet.x10, 0), Dataset.CommSumRub + IIF(DataSet.fiid_comm == "RUB", DataSet.x10, 0))); /*PNV 518846*/
       trnOutUSD = iif(DealKindName == "Продажа", iif(DataSet.AvrCode == "USD", DataSet.Amount_BA + IIF(DataSet.fiid_comm == "USD", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, "")), iif(DataSet.KA_CCY == "USD", DataSet.Cost_KA + IIF(DataSet.fiid_comm == "USD", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, ""))); /*PNV 518846*/
       trnOutEUR = iif(DealKindName == "Продажа", iif(DataSet.AvrCode == "EUR", DataSet.Amount_BA + IIF(DataSet.fiid_comm == "EUR", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, "")), iif(DataSet.KA_CCY == "EUR", DataSet.Cost_KA + IIF(DataSet.fiid_comm == "EUR", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, ""))); /*PNV 518846*/
       trnOutCHF = iif(DealKindName == "Продажа", iif(DataSet.AvrCode == "CHF", DataSet.Amount_BA + IIF(DataSet.fiid_comm == "CHF", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, "")), iif(DataSet.KA_CCY == "CHF", DataSet.Cost_KA + IIF(DataSet.fiid_comm == "CHF", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, ""))); /*PNV 518846*/
       trnOutGBP = iif(DealKindName == "Продажа", iif(DataSet.AvrCode == "GBP", DataSet.Amount_BA + IIF(DataSet.fiid_comm == "GBP", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, "")), iif(DataSet.KA_CCY == "GBP", DataSet.Cost_KA + IIF(DataSet.fiid_comm == "GBP", DataSet.x10, 0), IIF(DataSet.fiid_comm == "USD", DataSet.x10, ""))); /*PNV 518846*/

       trnInRUR  = iif(DealKindName == "Покупка", iif(DataSet.AvrCode == "RUB", DataSet.Amount_BA, ""), iif(DataSet.KA_CCY == "RUB", DataSet.Cost_KA, ""));
       trnInUSD  = iif(DealKindName == "Покупка", iif(DataSet.AvrCode == "USD", DataSet.Amount_BA, ""), iif(DataSet.KA_CCY == "USD", DataSet.Cost_KA, ""));
       trnInEUR  = iif(DealKindName == "Покупка", iif(DataSet.AvrCode == "EUR", DataSet.Amount_BA, ""), iif(DataSet.KA_CCY == "EUR", DataSet.Cost_KA, ""));
       trnInCHF  = iif(DealKindName == "Покупка", iif(DataSet.AvrCode == "CHF", DataSet.Amount_BA, ""), iif(DataSet.KA_CCY == "CHF", DataSet.Cost_KA, ""));
       trnInGBP  = iif(DealKindName == "Покупка", iif(DataSet.AvrCode == "GBP", DataSet.Amount_BA, ""), iif(DataSet.KA_CCY == "GBP", DataSet.Cost_KA, ""));

       // 21.01.2021 MAA: iS - 519390
       arRestPlanRUR[m_Deal.clNo] = arRestPlanRUR[m_Deal.clNo] - money(trnOutRUR) + money(trnInRUR);
       arRestPlanUSD[m_Deal.clNo] = arRestPlanUSD[m_Deal.clNo] - money(trnOutUSD) + money(trnInUSD);
       arRestPlanEUR[m_Deal.clNo] = arRestPlanEUR[m_Deal.clNo] - money(trnOutEUR) + money(trnInEUR);
       arRestPlanCHF[m_Deal.clNo] = arRestPlanCHF[m_Deal.clNo] - money(trnOutCHF) + money(trnInCHF);
       arRestPlanGBP[m_Deal.clNo] = arRestPlanGBP[m_Deal.clNo] - money(trnOutGBP) + money(trnInGBP);

       /*для конверсионных ВР нет, поэтому ВР и сумму сделки в ВР не заполняем*/            
       PrintLine1(m_Deal.DealCode, m_Deal.DealCodeTS, SQL_ConvTypeDate(m_Deal.DEALDATE), SQL_ConvTypeTime(m_Deal.DEALTIME), "", Place, DealKindName, ContrShortName,
                  DataSet.ClientName + "/" + DataSet.ClientCode, DataSet.N_gs, /*DocNumber*/m_Deal.DealCodeTS, DocDate, RecNumber, DataSet.SfContrNumber, DataSet.IssShortName, DataSet.AvrKind,
                  DataSet.AvrCode, DataSet.AvrSeries, DataSet.AvrISIN, DataSet.KA_CCY, DataSet.Amount_BA, 0, DataSet.Price_KA, /*DataSet.KA_CCY*/DataSet.AvrCode, /*DataSet.Cost_KA*/DataSet.Amount_BA, DataSet.Cost_KA, SumInNatcur,
                  CalcMethod, SQL_ConvTypeDate(DataSet.PlanDate_BA), SQL_ConvTypeDate(DataSet.FactDate_BA), SQL_ConvTypeDate(DataSet.PlanDate_KA), SQL_ConvTypeDate(DataSet.FactDate_KA), "", SQL_ConvTypeStr(DataSet.ClientStatus),
                  // KS 23.01.2020 Дополнительные поля под форму банка
                  DataSet.x1,
                  DataSet.SfContrNumber,
                  SQL_ConvTypeDate(DataSet.x3),
                  SQL_ConvTypeDate(DataSet.x4),
                  "_",
                  "_",
                  "АО \"Россельхозбанк\"",
                  "", // x8
                  IIF(m_deal.dealkind==СДЕЛКА_КЛИЕНТА,"БАНК НКЦ (АО)",""),
                  DataSet.x10, // x10
                  DataSet.x11, // x11
                  DealKindName, // x12
                  "Купля-продажа", // x13
                  DataSet.AvrCode+DataSet.KA_CCY+
                       ternary((date(DataSet.Date) == date(DataSet.Execdate)),
                       "_TOD", "_TOM"), // x14
                  DataSet.x15, // x15
                  DataSet.x16, // x16
                  DataSet.x17, // x17
                  DataSet.x18, // x18
                  DataSet.x19, // x19
                  "клиринг", // x20
                  "неттинг", // x21
                  iif(m_deal.dealkind!=СДЕЛКА_КЛИЕНТА,"от своего имени и за свой счет",DataSet.x22), // x22
                  SQL_ConvTypeDate(DataSet.x23), // x23
                  "не ПФИ",
                  IIF(m_deal.dealkind==СДЕЛКА_КЛИЕНТА,"право предоставлено", ""),
                  string(money(RestRUR)), // x26_RUR
                  string(money(RestUSD)), // x26_USD
                  string(money(RestEUR)), // x26_EUR
                  string(money(RestCHF)), // x26_CHF
                  string(money(RestGBP)), // x26_GBP
                  string(money(arRestPlanRUR[m_Deal.clNo])), // x27_RUR
                  string(money(arRestPlanUSD[m_Deal.clNo])), // x27_USD
                  string(money(arRestPlanEUR[m_Deal.clNo])), // x27_EUR
                  string(money(arRestPlanCHF[m_Deal.clNo])), // x27_CHF
                  string(money(arRestPlanGBP[m_Deal.clNo])), // x27_GBP
                  DataSet.AvrCode,
                  trnOutRUR,
                  trnOutUSD,
                  trnOutEUR,
                  trnOutCHF,
                  trnOutGBP,

                  trnInRUR,
                  trnInUSD,
                  trnInEUR,
                  trnInCHF,
                  trnInGBP,

                  "да",
                  DataSet.BROKERShortName,
                  iif(DataSet.BROKERContr==0, "", DataSet.BROKERContr),
                  SQL_ConvTypeDate(DataSet.ExecDate) //X42
                  );
       
     end;

  end;

  macro PrintByVA()

    var CalcMethod = "Предоплата", AvrKind = "", AvrSeries = "", Price_KA, KA_CCY;

    var Select = " select bnr.T_BCFormKind, bnr.T_BCSERIES,bnr.T_BCID, bnr.T_BCNUMBER, "
                +"        LEG.T_PRINCIPAL, "
                +"        LEG.T_CFI, LEG.T_Cost, "
                +"        vs.T_BCCost,     "
                +"        leg.T_PayFIID,   "
                +"        case when FIN_KA.T_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else FIN_KA.T_CCY end KA_CCY,"
                +"        case when instr(opr.t_SysTypes,'B') = 1 then 'Покупка' else 'Продажа' end  DealKindName,  "
                +"        case when leg.t_maturityisprincipal = 'X' then leg.T_MATURITY else leg.T_EXPIRY end PlanDate_BA," 
                +"        case when leg.t_maturityisprincipal != 'X' then leg.T_MATURITY else leg.T_EXPIRY end PlanDate_KA,   "
                +"        case when leg.T_PayFIID != -1 then (select (case when f.T_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.T_CCY end) from dfininstr_dbt f where f.t_FIID = leg.T_PayFIID) else '' end PayCCY, "
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_PARTYID) ContrShortName, "
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_CLIENTID) ClientShortName, "
                +"        (select t.t_Number from dsfcontr_dbt t where t.t_id = TICK.T_CLIENTCONTRID) SfContrNumber,"
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = vs.T_ISSUER) IssShortName, "
                +"        (select PM.T_VALUEDATE from dpmpaym_dbt pm "
                +"          where PM.T_DOCUMENTID = TICK.T_DEALID and PM.T_DOCKIND = TICK.T_BOFFICEKIND "
                +"            and PM.T_PURPOSE =1 and PM.T_FIID = bnr.t_FIID and (PM.T_PAYMSTATUS >= 3000 or PM.T_PAYMSTATUS = 150 ) and rownum = 1) FactDate_BA, "
                +"        (select PM.T_VALUEDATE from dpmpaym_dbt pm "
                +"          where PM.T_DOCUMENTID = TICK.T_DEALID and PM.T_DOCKIND = TICK.T_BOFFICEKIND "
                +"            and PM.T_PURPOSE =2 "
                +"            and (PM.T_PAYMSTATUS >= 3000 or PM.T_PAYMSTATUS = 150 ) and rownum = 1 ) FactDate_KA "
                +"   from ddl_tick_dbt tick, ddl_leg_dbt leg, DVSORDLNK_DBT vs, DVSBANNER_DBT bnr, doprkoper_dbt opr, dfininstr_dbt fin_KA "
                +"  where TICK.T_DEALID = ?  "
                +"    and leg.T_DEALID = ?   "
                +"    and LEG.T_LEGKIND =  ? "
                +"    and leg.T_LEGID = 0    "
                +"    and vs.T_CONTRACTID = tick.T_DEALID "
                +"    and vs.T_BCID = ? "
                +"    and bnr.T_BCID = vs.T_BCID "
                +"    and opr.t_Kind_Operation = TICK.T_DEALTYPE "
                +"    and fin_KA.t_fiid = vs.T_BCCFI ";

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( m_Deal.DealID );
     cmd.addParam( m_Deal.DealID );
     cmd.addParam( m_Deal.LegKind );
     cmd.addParam( m_Deal.BCID );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )

       if( DataSet.BCFormKind == 1 )
          AvrKind = "Векс.прост.";
       else
          AvrKind = "Деп.серт.";
       end;

       AvrSeries = string(DataSet.BCSERIES, " №", trim(DataSet.BCNUMBER));

       /*если цена по векселям указана в разных валютах, то поле НЕ заполняется*/
       if( SQL_ConvTypeInteger(DataSet.CFI) == -1 )
          KA_CCY = null;
          Price_KA = "";
       else
          KA_CCY = DataSet.KA_CCY;
          Price_KA = DataSet.Cost;
       end;

       PrintLine1(m_Deal.DealCode, m_Deal.DealCodeTS, SQL_ConvTypeDate(m_Deal.DEALDATE), "", "", "вне биржи", DataSet.DealKindName, DataSet.ContrShortName,
                  DataSet.ClientShortName, "", "", "", "", DataSet.SfContrNumber, DataSet.IssShortName, AvrKind,
                  "", AvrSeries, "", DataSet.PayCCY, SQL_ConvTypeInteger(DataSet.PRINCIPAL), 0, Price_KA, KA_CCY, DataSet.BCCost, "", "",
                  CalcMethod, SQL_ConvTypeDate(DataSet.PlanDate_BA), SQL_ConvTypeDate(DataSet.FactDate_BA), SQL_ConvTypeDate(DataSet.PlanDate_KA), SQL_ConvTypeDate(DataSet.FactDate_KA), "", "Дилер","1416");
     end;

  end;

  macro GetDealKind(TickData,IsBack:bool)

     var DealKindName = "", part = dl_iif(IsBack," 2 ч."," 1 ч.");
     var ЭтоСторонаКонтрагентаД = ((m_Deal.DEALKIND == СДЕЛКА_КЛИЕНТА) and (TickData.IsPartyClient == SET_CHAR) and (TickData.PartyID == m_Deal.ClientID));

     if( not TickData.IsTwoPart )
        /*для сделки с контрагентом Д (для стороны контрагента Д) противоположная направленность*/
        if( ЭтоСторонаКонтрагентаД )
           if( TickData.IsBuy )
              DealKindName = "Продажа";
           else
              DealKindName = "Покупка";
           end;
        else
           if( TickData.IsBuy )
              DealKindName = "Покупка";
           else
              DealKindName = "Продажа";
           end;
        end;
     elif( TickData.IsRepo )
        if( TickData.IsBasket )
           if( TickData.IsBuy )
              DealKindName = "Обратное РЕПО на корзину ц/б";
           else
              DealKindName = "Прямое РЕПО на корзину ц/б";
           end;
        elif( TickData.IsDealKSU )
           if( TickData.IsBuy )
              DealKindName = "Обратное РЕПО с КСУ";
           else
              DealKindName = "Прямое РЕПО с КСУ";
           end;
        else
           /*для сделки с контрагентом Д (для стороны контрагента Д) противоположная направленность*/
           if( ЭтоСторонаКонтрагентаД )
              if( TickData.IsBuy )
                 DealKindName = "Прямое РЕПО";
              else
                 DealKindName = "Обратное РЕПО";
              end;
           else
              if( TickData.IsBuy )
                 DealKindName = "Обратное РЕПО";
              else
                 DealKindName = "Прямое РЕПО";
              end;
           end;
        end;
        DealKindName = DealKindName + part;
     elif( TickData.IsLoan )
        /*для сделки с контрагентом Д (для стороны контрагента Д) противоположная направленность*/
        if( ЭтоСторонаКонтрагентаД )
           if( TickData.IsBuy )
              DealKindName = "Заем размещение";
           else
              DealKindName = "Заем привлечение";
           end;
        else
           if( TickData.IsBuy )
              DealKindName = "Заем привлечение";
           else
              DealKindName = "Заем размещение";
           end;
        end;
        DealKindName = DealKindName + part;
     end;

     return DealKindName;

  end;

  macro ФактическаяДатаПоставки(IsBack:bool)
    var FactDate = null;
    var Select = " SELECT dlrq.t_FactDate "
                +"    FROM ddlrq_dbt dlrq " 
                +"   WHERE dlrq.t_DocKind = ? "
                +"     AND dlrq.t_DocID = ? "
                +"     AND dlrq.t_Type   = " + string(DLRQ_TYPE_DELIVERY)
                +"     AND dlrq.t_DealPart = "+DL_IIF(IsBack==true,2,1)
                +"     AND dlrq.t_FactDate != to_date('01.01.0001','DD.MM.YYYY') "
                +" order by dlrq.t_FactDate "+DL_IIF(IsBack==true," desc","");

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( m_Deal.BOFFICEKIND );
     cmd.addParam( m_Deal.DealID );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )
        FactDate = SQL_ConvTypeDate(DataSet.FactDate);
     end;
     return FactDate;
  end;

  macro ФактическаяДатаОплаты(IsBack:bool)
    var FactDate = null;
    var Select = " SELECT dlrq.t_FactDate "
                +"    FROM ddlrq_dbt dlrq " 
                +"   WHERE dlrq.t_DocKind = ? "
                +"     AND dlrq.t_DocID = ? "
                +"     AND dlrq.t_Type in( " + string(DLRQ_TYPE_AVANCE) + "," + string(DLRQ_TYPE_DEPOSIT) + "," + string(DLRQ_TYPE_PAYMENT) + ")"
                +"     AND dlrq.t_DealPart = "+DL_IIF(IsBack==true,2,1)
                +"     AND dlrq.t_FactDate != to_date('01.01.0001','DD.MM.YYYY') "
                +" order by dlrq.t_FactDate "+DL_IIF(IsBack==true," desc","");

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( m_Deal.BOFFICEKIND );
     cmd.addParam( m_Deal.DealID );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )
        FactDate = SQL_ConvTypeDate(DataSet.FactDate);
     end;
     return FactDate;
  end;

  macro ПолучитьДанныеПоАвансу( IsBack, СумАвВСд:@variant, ДатаАвПлан:@variant, ДатаАвФакт:@variant)
    var Select = " SELECT dlrq.t_FactDate, dlrq.t_PlanDate, dlrq.t_Amount"
                +"    FROM ddlrq_dbt dlrq " 
                +"   WHERE dlrq.t_DocKind = ? "
                +"     AND dlrq.t_DocID = ? "
                +"     AND dlrq.t_Type in( " + string(DLRQ_TYPE_AVANCE) + "," + string(DLRQ_TYPE_DEPOSIT) + ")"
                +"     AND dlrq.t_DealPart = "+DL_IIF(IsBack==true,2,1)
                +"     AND ROWNUM = 1 ";

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( m_Deal.BOFFICEKIND );
     cmd.addParam( m_Deal.DealID );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )
        ДатаАвФакт = SQL_ConvTypeDate(DataSet.FactDate);
        ДатаАвПлан = SQL_ConvTypeDate(DataSet.PlanDate);
        СумАвВСд   = SQL_ConvTypeSum(DataSet.Amount);
     end;

  end;

  macro PrintByBODeal( TickData, CostData )
    var DealKindName = "", CalcMethod = "", SumInNatCur = $0, ChangeInfo = "", Place = "", DocNumber = "", RecNumber = "",
        ContrShortName = "", ClientShortName = "", SfContrNumber = "", Amount_BA = 0.0, RejectInfo = "", DocDate = "",
        Price_KA = 0.0, KA_CCY = "", TotalCost = $0, PayCCY = "", SumInPayIID = $0, ЭтоБиржеваяСделка = false, ВыводитьСтрокуТолькоПо2ч = false, SumPrecision = null,
        ЭтоСделкаЧерезБрокера = ( (TickData.IsExchange and (ВидСубъекта(TickData.BrokerID, PTK_BROKER)))
                                  or (TickData.IsOutExchange and ( not TickData.IsOTC ) and (ВидСубъекта(TickData.BrokerID, PTK_BROKER))) 
                                  or TickData.IsBroker 
                                  or ((TickData.IsTwoPart) and (TickData.Flag4) and (TickData.BrokerID > 0))
                                );
       var СумАвВСд = 0.0, СумАвНВ = 0.0, СумАвВР = 0.0, ДатаАвПлан = Date(0,0,0), ДатаАвФакт = Date(0,0,0);
       if( m_Deal.Stateavance == 1 )//есть аванс
         ПолучитьДанныеПоАвансу(false, @СумАвВСд,@ДатаАвПлан, @ДатаАвФакт); 
       end;
       if( SQL_ConvTypeDate(TickData.RejectDate) != Date(0,0,0) )
          RejectInfo = string(SQL_ConvTypeDate(TickData.RejectDate):f)+" \n"+"отк. от сделки";
       elif( SQL_ConvTypeDate(TickData.RejectDate_2) != Date(0,0,0) )
          RejectInfo = string(SQL_ConvTypeDate(TickData.RejectDate_2):f)+" \n"+"отк. от 2ч";
       end;

       if( m_ShowDealChange )
          if( m_Deal.BCID == 0 )
             ChangeInfo = "заключение";
          else
             ChangeInfo = "изменение";
          end;
       end;

       if( TickData.IsLoan )
          if( ВидСубъекта(TickData.BrokerID, PTK_MARKETPLASE) )
             Place = TickData.BrokerShortName;
          elif( ВидСубъекта(TickData.BrokerID, PTK_BROKER) )
             Place = "брокер "+TickData.BrokerShortName;
          else
             Place = "вне биржи";
          end;
       elif( not ЭтоСделкаЧерезБрокера )
          if( TickData.IsExchange )
             Place = TickData.MarketShortName+" \n"+ПолучитьНаименованиеСектора( TickData.MarketID, TickData.MarketOfficeID );
             ЭтоБиржеваяСделка = true;
          elif( TickData.IsOutExchange and (not TickData.IsOTC) and (ВидСубъекта(TickData.BrokerID, PTK_MARKETPLASE )) )
             Place = TickData.BrokerShortName;
             ЭтоБиржеваяСделка = true;
          elif( TickData.IsOutExchange )
             Place = "вне биржи";
          end;
       else
          Place = "брокер "+TickData.BrokerShortName;
       end;

       if( TickData.IsLoan )
          if( TickData.IsPartyClient!=SET_CHAR )
             ContrShortName = DL_getPartyShortName(TickData.PartyID);
          end;
       elif( ( (TickData.IsBasket and (not TickData.IsExchange)) or TickData.IsInterDealerRepo )
           OR
           ( (not ЭтоСделкаЧерезБрокера)
            AND(
                (TickData.IsOutExchange and (TickData.IsPartyClient!=SET_CHAR))
                 OR
                (TickData.IsExchange and (TickData.PartyID > 0) and (not ВидСубъекта(TickData.PartyID, PTK_CENTRALCONTR)))
               )
           )
         )
          if( TickData.IsBasket )/*простое РЕПО на корзину НЕ ЦК или междилерское*/
             ContrShortName = "Банк России";
          else
             ContrShortName = DL_getPartyShortName(TickData.PartyID);
          end;
       end;

       if( m_Deal.DEALKIND == СДЕЛКА_КЛИЕНТА)
          ClientShortName = DL_getPartyShortName(m_Deal.ClientID);
          if( m_Deal.ClientID == TickData.ClientID )
             SfContrNumber = TickData.CLIENTCONTRNumber;
          else
             SfContrNumber = TickData.PartyContrNumber;
          end;
       end;

       if(ЭтоБиржеваяСделка)
          RecNumber = ПолучитьНомерЗаявки(m_Deal.BofficeKind,m_Deal.DealID);
       end;

       if( TickData.AvoirKind == AVOIRISSKIND_INVESTMENT_SHARE )
          SumPrecision = int(TickData.SumPrecision);
       end;

       /*здесь изменения только по 2 части*/
       if( m_ShowDealChange and ((CostData.ChangeKind == SPTKCHNG_COUPON)or(CostData.ChangeKind == SPTKCHNG_PARTIAL)or(CostData.ChangeKind == SPTKCHNG_COMPENS)) )
          ВыводитьСтрокуТолькоПо2ч = true;
       end;

       if( not ВыводитьСтрокуТолькоПо2ч )
           if( TickData.IsBasket )
              Amount_BA = 1;
              Price_KA  = null;
              KA_CCY    = m_CCA_NatCUR;
           else
              Amount_BA = SQL_ConvTypeSum(CostData.Principal_1);
          
              if( not TickData.IsDealKSU )
                 Price_KA  = SQL_ConvTypeSum(CostData.Price_1);
              else
                 Price_KA  = null;
              end;
          
              KA_CCY    = SQL_ConvTypeStr(CostData.CFI_CCY_1);
           end;
          
           TotalCost = SQL_ConvTypeSum(CostData.TotalCOST_1)- СумАвВСд;
           PayCCY    = SQL_ConvTypeStr(CostData.PayCCY);
          
           if(CostData.PayFIID != -1)
              if(CostData.PayFIID != CostData.CFI_1)
                 SmartConvertSum(SumInPayIID, money(TotalCost), SQL_ConvTypeDate(TickData.DEALDATE), CostData.CFI_1, CostData.PayFIID, true);
                 if( not(СумАвВСд == 0.0))
                    SmartConvertSum(СумАвВР, money(СумАвВСд), SQL_ConvTypeDate(TickData.DEALDATE), CostData.CFI_1, CostData.PayFIID, true);
                 end;
              else
                 SumInPayIID = TotalCost;
                 СумАвВР = СумАвВСд;
              end;
           else
              SumInPayIID = null;
              СумАвВР = null;
           end;
          
           if( CostData.CFI_1 != NATCUR )
              SmartConvertSum(SumInNatcur, money(TotalCOST), m_ReportDate, CostData.CFI_1, NATCUR, true);
              if( not(СумАвВСд == 0.0))
                SmartConvertSum(СумАвНВ, money(СумАвВСд), m_ReportDate, CostData.CFI_1, NATCUR, true);
              end;
           else
              SumInNatcur = money(TotalCOST);
              СумАвНВ = money(СумАвВСд);
           end;
          
           CalcMethod = SQL_ConvTypeStr(CostData.CalcMethod_1);
          
           DealKindName = GetDealKind(TickData,false);
              
           if( m_Deal.DEALKIND == СДЕЛКА_КЛИЕНТА )
              DocNumber = ПолучитьНомерПоручения(m_Deal.BofficeKind,m_Deal.DealID,m_Deal.ClientID,false,@DocDate);
              if( (DocNumber == "") or (DocDate == date(0,0,0)) )
                 DocDate = "";
              end;
           end;

           PrintLine1(m_Deal.DealCode, m_Deal.DealCodeTS, SQL_ConvTypeDate(m_Deal.DEALDATE), SQL_ConvTypeTime(m_Deal.DEALTIME), ChangeInfo, Place, DealKindName, ContrShortName,
                      ClientShortName, TickData.N_gs, DocNumber, DocDate, RecNumber, SfContrNumber, TickData.IssShortName, TickData.AvrKind,
                      TickData.AvrCode, TickData.AvrSeries, TickData.AvrISIN, PayCCY, Amount_BA, SumPrecision, Price_KA, KA_CCY, TotalCost, SumInPayIID, SumInNatcur,
                      CalcMethod, SQL_ConvTypeDate(CostData.PlanDate_BA_1), ФактическаяДатаПоставки(false), SQL_ConvTypeDate(CostData.PlanDate_KA_1), 
                      ФактическаяДатаОплаты(false), RejectInfo, SQL_ConvTypeStr(TickData.ClientStatus), "1679");
           if( (not(СумАвВСд == 0.0)) AND ( m_ShowDealChange ) )
             PrintLine1(m_Deal.DealCode, m_Deal.DealCodeTS, SQL_ConvTypeDate(m_Deal.DEALDATE), SQL_ConvTypeTime(m_Deal.DEALTIME), ChangeInfo, Place, DealKindName, ContrShortName,
                        ClientShortName, TickData.N_gs, DocNumber, DocDate, RecNumber, SfContrNumber, TickData.IssShortName, TickData.AvrKind,
                        TickData.AvrCode, TickData.AvrSeries, TickData.AvrISIN, PayCCY, Amount_BA, SumPrecision, Price_KA, KA_CCY, СумАвВСд, СумАвВР, СумАвНВ,
                        CalcMethod, SQL_ConvTypeDate(CostData.PlanDate_BA_1), ФактическаяДатаПоставки(false), ДатаАвПлан, 
                        ДатаАвФакт, RejectInfo, SQL_ConvTypeStr(TickData.ClientStatus));
           end;
       end;

       /*для сделок из двух частей выводим дополнительно строку по 2 части*/
       if( TickData.IsTwoPart )
          СумАвВСд = 0.0;
          СумАвНВ = 0.0;
          СумАвВР = 0.0; 
          ДатаАвПлан = Date(0,0,0);
          ДатаАвФакт = Date(0,0,0);
          if(m_Deal.Stateavance == 1 )//есть аванс
            ПолучитьДанныеПоАвансу(true, @СумАвВСд,@ДатаАвПлан, @ДатаАвФакт); 
          end;

          if( TickData.IsBasket )
             Amount_BA = 1;
             Price_KA  = null;
             KA_CCY    = m_CCA_NatCUR;
          else
             Amount_BA = SQL_ConvTypeSum(CostData.Principal_2);
             Price_KA  = ДЛ_ЧислоCЗаданнойТочностью(money(SQL_ConvTypeSum(CostData.INCOMERATE)),(SQL_ConvTypeInteger(CostData.Point)))+" %";
             KA_CCY    = SQL_ConvTypeStr(CostData.CFI_CCY_2);
          end;
         
          TotalCost = SQL_ConvTypeSum(CostData.TotalCOST_2) - СумАвВСд;
          PayCCY    = SQL_ConvTypeStr(CostData.PayCCY);
         
          if(CostData.PayFIID != -1)
             if(CostData.PayFIID != CostData.CFI_2)
                SmartConvertSum(SumInPayIID, money(TotalCost), SQL_ConvTypeDate(TickData.DEALDATE), CostData.CFI_2, CostData.PayFIID, true);
                if( not(СумАвВСд == 0.0))
                   SmartConvertSum(СумАвВР, money(СумАвВСд), SQL_ConvTypeDate(TickData.DEALDATE), CostData.CFI_2, CostData.PayFIID, true);
                end;
             else
                SumInPayIID = TotalCost;
                СумАвВР = СумАвВСд;
             end;
          else
             SumInPayIID = null;
             СумАвВР = null;
          end;

          if( CostData.CFI_2 != NATCUR )
             SmartConvertSum(SumInNatcur, money(TotalCOST), m_ReportDate, CostData.CFI_2, NATCUR, true);
             if( not(СумАвВСд == 0.0))
               SmartConvertSum(СумАвНВ, money(СумАвВСд), m_ReportDate, CostData.CFI_2, NATCUR, true);
             end;
          else
             SumInNatcur = money(TotalCOST);
             СумАвНВ = money(СумАвВСд);
          end;

          CalcMethod = SQL_ConvTypeStr(CostData.CalcMethod_2);
          DealKindName = GetDealKind(TickData,true);
              
          DocDate = "";
          if( m_Deal.DEALKIND == СДЕЛКА_КЛИЕНТА )
             DocNumber = ПолучитьНомерПоручения(m_Deal.BofficeKind,m_Deal.DealID,m_Deal.ClientID,true,@DocDate);
             if( (DocNumber == "") or (DocDate == date(0,0,0)) )
                DocDate = "";
             end;
          end;

          PrintLine1(m_Deal.DealCode, m_Deal.DealCodeTS, SQL_ConvTypeDate(m_Deal.DEALDATE), SQL_ConvTypeTime(m_Deal.DEALTIME), ChangeInfo, Place, DealKindName, ContrShortName,
                     ClientShortName, TickData.N_gs, DocNumber, DocDate, RecNumber, SfContrNumber, TickData.IssShortName, TickData.AvrKind,
                     TickData.AvrCode, TickData.AvrSeries, TickData.AvrISIN, PayCCY, Amount_BA, SumPrecision, Price_KA, KA_CCY, TotalCost, SumInPayIID, SumInNatcur,
                     CalcMethod, SQL_ConvTypeDate(CostData.PlanDate_BA_2), ФактическаяДатаПоставки(true), SQL_ConvTypeDate(CostData.PlanDate_KA_2), 
                     ФактическаяДатаОплаты(true), RejectInfo, SQL_ConvTypeStr(TickData.ClientStatus));
          if( ( not(СумАвВСд == 0.0) ) AND ( m_ShowDealChange ))
            PrintLine1(m_Deal.DealCode, m_Deal.DealCodeTS, SQL_ConvTypeDate(m_Deal.DEALDATE), SQL_ConvTypeTime(m_Deal.DEALTIME), ChangeInfo, Place, DealKindName, ContrShortName,
                       ClientShortName, TickData.N_gs, DocNumber, DocDate, RecNumber, SfContrNumber, TickData.IssShortName, TickData.AvrKind,
                       TickData.AvrCode, TickData.AvrSeries, TickData.AvrISIN, PayCCY, Amount_BA, SumPrecision, Price_KA, KA_CCY, СумАвВСд, СумАвВР, СумАвНВ,
                       CalcMethod, SQL_ConvTypeDate(CostData.PlanDate_BA_2), ФактическаяДатаПоставки(true), ДатаАвПлан, 
                       ДатаАвФакт, RejectInfo, SQL_ConvTypeStr(TickData.ClientStatus));
          end;

       end;

  end;                                                                                                        

  macro PrintByBO()

    var DealKindName = "", CalcMethod = "", SumInNatCur = $0, ChangeInfo = "", Place = "",
        ContrShortName = "", ClientShortName = "", SfContrNumber = "", Amount_BA = 0.0, 
        Price_KA = 0.0, KA_CCY = "", TotalCost = $0, PayCCY = "", SumInPayIID = $0;

    var Select = " select TICK.T_BROKERID, tick.t_MarketID, tick.t_MarketOfficeID, tick.t_PartyID, tick.t_DEALDATE, tick.t_Flag4, "
                +"        TICK.T_TYPEDOC, tick.t_IsPartyClient, tick.t_PartyContrID, tick.t_Instance, tick.t_ChangeKind, "
                +"        TICK.T_CLIENTID, TICK.T_CLIENTCONTRID, TICK.T_BrokerContrID, "
                +"        FIN_BA.T_FI_CODE AvrCode, FIN_BA.T_SumPrecision, "
                +"        FIN_BA.t_avoirkind, "
                +"        (select avr.t_shortname from davrkinds_dbt avr where avr.t_fi_kind = 2 and avr.t_avoirkind = fin_BA.t_avoirkind) AvrKind, "
                +"        (select avr.t_Series||', '||avr.t_Tranche from davoiriss_dbt avr where avr.t_fiid = fin_BA.t_FIID) AvrSeries, "
                +"        (select NVL(avr.t_ISIN,NVL(avr.t_LSIN,'')) from davoiriss_dbt avr where avr.t_fiid = fin_BA.t_FIID) AvrISIN, "
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = fin_BA.t_Issuer) IssShortName, "
                +"        rsb_secur.IsExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind)), 1) t_IsExchange, "
                +"        rsb_secur.IsOutExchange(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind)), 1) t_IsOutExchange, "
                +"        rsb_secur.IsOTC(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsOTC, "
                +"        rsb_secur.IsBroker(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsBroker, "
                +"        rsb_secur.IsBuy(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsBuy, "
                +"        rsb_secur.IsRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsRepo, "
                +"        rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsBasket, "
                +"        rsb_secur.IsTwoPart(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsTwoPart, "
                +"        rsb_secur.IsDealKSU(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsDealKSU, "
                +"        rsb_secur.IsLoan(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsLoan, "
                +"        rsb_secur.IsInterDealerRepo(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType,tick.t_BofficeKind))) t_IsInterDealerRepo, "
                +"        (select t.t_Number from dsfcontr_dbt t where t.t_id = TICK.T_CLIENTCONTRID) CLIENTCONTRNumber,"
                +"        (select t.t_Number from dsfcontr_dbt t where t.t_id = TICK.T_PartyContrID) PartyContrNumber,"
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_MarketID) MarketShortName,"
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_BrokerID) BrokerShortName,"
                +"        (select t.t_ShortName from dparty_dbt t where t.t_Partyid = TICK.T_PartyID) ContrShortName,"
                +"        (select t.t_Number from dsfcontr_dbt t where t.t_id = TICK.T_BrokerContrID) BrokerContrNumber,"
                +"        (select leg_1.t_RejectDate from ddl_leg_dbt leg_1 where leg_1.t_DealID = TICK.T_DEALID and leg_1.t_LegKind = 0 and leg_1.t_LegID = 0) RejectDate, "
                +"        (select leg_2.t_RejectDate from ddl_leg_dbt leg_2 where leg_2.t_DealID = TICK.T_DEALID and leg_2.t_LegKind = 2 and leg_2.t_LegID = 0) RejectDate_2, "
                +"        case when ( Tick.T_PARTYID > 0 and Tick.T_PARTYID = ? and tick.t_IsPartyClient = 'X') or (Tick.T_CLIENTID > 0 and Tick.T_CLIENTID = ?) then "
                +"         (Select ATTR.T_NAME             "
                +"            From dobjatcor_dbt AtCor, dobjattr_dbt Attr " 
                +"           Where AtCor.t_ObjectType = "+OBJTYPE_SFCONTR
                +"             And AtCor.t_GroupID    = 1                 "
                +"             And AtCor.t_Object     = LPAD(case when Tick.T_CLIENTID = ? then TICK.T_CLIENTCONTRID else tick.t_PartyContrID end, 10, '0' ) "
                +"             And Attr.t_AttrID      = AtCor.t_AttrID     "
                +"             And Attr.t_ObjectType  = AtCor.t_ObjectType "
                +"             And Attr.t_GroupID     = AtCor.t_GroupID    "
                +"             and ATCOR.T_VALIDFROMDATE <= Tick.t_DEALDATE "
                +"             and ATCOR.T_VALIDTODATE >= Tick.t_DEALDATE "
                +"             and rownum = 1 "
                +"         )                                               "
                +"        else 'Хоз. субъект' end ClientStatus,            "
                +"        (select GR.T_CODE from DDL_GENAGR_DBT gr where gr.t_GenAgrID = tick.t_GenAgrID) N_gs "
                +"   from ddl_tick_dbt tick, dfininstr_dbt fin_BA "
                +"  where TICK.T_DEALID = ?  "
                +"    and fin_BA.t_FIID = ? ";

     var cmd = DL_RSDCommand(Select);
     cmd.addParam( m_Deal.ClientID );
     cmd.addParam( m_Deal.ClientID );
     cmd.addParam( m_Deal.ClientID );
     cmd.addParam( m_Deal.DealID );
     cmd.addParam( m_Deal.FIID );

     var DataSet = cmd.Execute();

     if( DataSet.MoveNext() )

       if( m_ShowDealChange and (m_Deal.BCID != DataSet.Instance) )

           var Select_CH =  " select CH.T_OldChangeKind ChangeKind, CH.T_OLDCFI1 CFI_1, CH.T_OLDCFI2 CFI_2, CH.T_OLDINCOMERATE INCOMERATE, "
                        +"        CH.T_OLDPAYFIID1 PAYFIID, CH.T_OLDPRICE1 PRICE_1, CH.T_OLDPRICE2 PRICE_2, CH.T_OLDPRINCIPAL PRINCIPAL_1, CH.T_OLDPRINCIPAL2 PRINCIPAL_2, "
                        +"        case when CH.T_OLDMATURITYISPRINCIPAL1 = 'X' then CH.T_OLDMATURITY1 else CH.T_OLDEXPIRY1 end PlanDate_BA_1," 
                        +"        case when CH.T_OLDMATURITYISPRINCIPAL1 != 'X' then CH.T_OLDMATURITY1 else CH.T_OLDEXPIRY1 end PlanDate_KA_1,   "
                        +"        case when CH.T_OLDMATURITYISPRINCIPAL2 = 'X' then CH.T_OLDMATURITY2 else CH.T_OLDEXPIRY2 end PlanDate_BA_2," 
                        +"        case when CH.T_OLDMATURITYISPRINCIPAL2 != 'X' then CH.T_OLDMATURITY2 else CH.T_OLDEXPIRY2 end PlanDate_KA_2,   "
                        +"        CH.T_OLDTOTALCOST1 TOTALCOST_1, CH.T_OLDTOTALCOST2 TOTALCOST_2, CH.T_OLDINCOMERATE INCOMERATE, "
                        +"        CH.T_OLDPOINT1 POINT, "
                        +"        (select case when f.t_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.t_CCY end from dfininstr_dbt f where f.t_FIID = CH.T_OLDPAYFIID1) PayCCY, "
                        +"        (select case when f.t_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.t_CCY end from dfininstr_dbt f where f.t_FIID = CH.T_OLDCFI1) CFI_CCY_1 , "
                        +"        (select case when f.t_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.t_CCY end from dfininstr_dbt f where f.t_FIID = CH.T_OLDCFI2) CFI_CCY_2 , "
                        +"           (select T.T_CONTENS from dtypeac_dbt t                                       "
                        +"             where T.T_INUMTYPE = 155                                                   "
                        +"               and T.T_TYPE_ACCOUNT = chr(CH.T_OLDFORMULA1)) CalcMethod_1,                   "
                        +"           (select T.T_CONTENS from dtypeac_dbt t                                   "
                        +"             where T.T_INUMTYPE = 155                                                   "
                        +"               and T.T_TYPE_ACCOUNT = chr(CH.T_OLDFORMULA2)) CalcMethod_2                    "
                        +"       from dSPTKCHNG_dbt CH     "
                        +"       where CH.T_DEALID = ?  "
                        +"       and CH.T_OLDINSTANCE = ? ";
          
           var cmd_ch = DL_RSDCommand(Select_CH);
           cmd_ch.addParam( m_Deal.DealID );
           cmd_ch.addParam( m_Deal.BCID );
          
           var DataSet_ch = cmd_ch.Execute();
           if( DataSet_ch.MoveNext() )
              PrintByBODeal(DataSet,DataSet_ch);
           end;

       else

           var Select_leg =  " select "+DataSet.ChangeKind+" ChangeKind, leg_1.T_PRINCIPAL PRINCIPAL_1, "
                        +"        LEG_1.T_PRICE PRICE_1,                                                            "
                        +"        leg_1.T_TotalCOST TotalCOST_1,                                                    "
                        +"        LEG_2.T_INCOMERATE,                         "
                        +"        leg_1.T_CFI CFI_1, leg_1.T_PayFIID,                                               "
                        +"        leg_2.T_CFI CFI_2, leg_2.T_PRINCIPAL PRINCIPAL_2,                                 "
                        +"        LEG_2.T_PRICE PRICE_2,                                                            "
                        +"        leg_2.T_TotalCOST TotalCOST_2,                                                    "
                        +"        leg_1.T_PayFIID, "
                        +"        case when leg_1.t_maturityisprincipal = 'X' then leg_1.T_MATURITY else leg_1.T_EXPIRY end PlanDate_BA_1, " 
                        +"        case when leg_1.t_maturityisprincipal != 'X' then leg_1.T_MATURITY else leg_1.T_EXPIRY end PlanDate_KA_1,"
                        +"        case when leg_2.t_maturityisprincipal = 'X' then leg_2.T_MATURITY else leg_2.T_EXPIRY end PlanDate_BA_2, " 
                        +"        case when leg_2.t_maturityisprincipal != 'X' then leg_2.T_MATURITY else leg_2.T_EXPIRY end PlanDate_KA_2,"
                        +"        leg_1.T_POINT POINT, "
                        +"        (select case when f.t_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.t_CCY end from dfininstr_dbt f where f.t_FIID = leg_1.T_PayFIID) PayCCY,    "
                        +"        (select case when f.t_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.t_CCY end from dfininstr_dbt f where f.t_FIID = leg_1.T_CFI) CFI_CCY_1,     "
                        +"        (select case when f.t_FIID = "+NATCUR+" then '"+string(m_CCA_NatCUR)+"' else f.t_CCY end from dfininstr_dbt f where f.t_FIID = leg_2.T_CFI) CFI_CCY_2,     "
                        +"        (select T.T_CONTENS from dtypeac_dbt t                                            "
                        +"          where T.T_INUMTYPE = 155                                                        "
                        +"            and T.T_TYPE_ACCOUNT = chr(leg_1.T_Formula)) CalcMethod_1,                         "
                        +"        (select T.T_CONTENS from dtypeac_dbt t                                        "
                        +"          where T.T_INUMTYPE = 155                                                        "
                        +"            and T.T_TYPE_ACCOUNT = chr(leg_2.T_Formula)) CalcMethod_2                          "
                        +"   from ddl_leg_dbt leg_1, ddl_leg_dbt leg_2 "
                        +"  where leg_1.T_DEALID = ? "
                        +"    and LEG_1.T_LEGKIND = 0   "
                        +"    and leg_1.T_LEGID = 0     "
                        +"    and leg_2.T_DEALID = ? "
                        +"    and LEG_2.T_LEGKIND = case when ? = 1 then 2 else 0 end "
                        +"    and leg_2.T_LEGID = 0 ";
          
          
           var cmd_leg = DL_RSDCommand(Select_leg);
           cmd_leg.addParam( m_Deal.DealID );
           cmd_leg.addParam( m_Deal.DealID );
           cmd_leg.addParam( DataSet.IsTwoPart );
          
           var DataSet_leg = cmd_leg.Execute();                                                          
           if( DataSet_leg.MoveNext() )
              PrintByBODeal(DataSet,DataSet_leg);
           end;

       end;

     end;

  end;

  macro PrintLine2(CurNumber:integer, DealCode:string, DealCodeTS:string, Date1:string, OperKind:string, SpGround:string, RegistrarShortName:string, RegistrarContrNum:string,
                   IssShortName:string, AvrKind:string, AvrCode:string, AvrSeries:string,  AvrIssue:string,  AvrISIN:string, 
                   Amount:money, Price:double, PriceISO:string, Cost:money, NKD:money, TotalCost:money )
  
     PrintTableLine(  "N2_CurNumber",       CurNumber,                                         null,
                      "N2_DealCode",        DealCode,                                          null,
                      "N2_DealCodeTS",      DealCodeTS,                                        null,
                      "N2_Date",            Date1,                                             null, 
                      "N2_OperKind",        OperKind,                                          null,
                      "N2_Ground",          SpGround,                                          null,
                      "N2_Registrar",       RegistrarShortName,                                null,
                      "N2_RegistrarContr",  RegistrarContrNum,                                 null,
                      "N2_Issuer",          IssShortName,                                      null,
                      "N2_AvrKind",         AvrKind,                                           null,
                      "N2_AvrCode",         AvrCode,                                           null,
                      "N2_AvrSeries",       AvrSeries,                                         null,
                      "N2_AvrIssue",        AvrIssue,                                          null,
                      "N2_AvrISIN",         AvrISIN,                                           null,
                      "N2_Amount",          Amount,                                            null,
                      "N2_Price",           ВыводЧерезФормулу(Price,6),                        null,
                      "N2_PriceISO",        PriceISO,                                          null,
                      "N2_Cost",            Cost,                                              null,
                      "N2_NKD",             DL_IIF(NKD == $0,"",NKD),                          null,
                      "N2_TotalCost",       TotalCost,                                         null
                    );

  end;      

  macro PrintBasket()
     record rFininstr( "fininstr" );
     record rAvoiriss( "avoiriss" );

     var query, DataSet, Select, cnt = 0, i = 0;
  
     var CurNumber = 1;
  
     var SpGround = "", RegistrarShortName = "", RegistrarContrNum = "", RegistrarID, RegistrarContrID,
         IssShortName = "", AvrKind = "", AvrCode = "", AvrSeries = "",  AvrIssue = "",  AvrISIN = "", OperKind = "",
         Amount = $0, Price = 0.0, PriceISO = "", Cost = $0, NKD = $0, TotalCost = $0;
  
     var TotalAmount = $0, TotalNKD = $0;
     var dateMin, dateMax;

     if( m_prev_KINDBO == 0 )/*только для БОЦБ*/

        if(m_IsPartDate)
           dateMin = m_ReportDate;
        else
           dateMin = m_dateMin;
        end;
       
        if(m_IsPartDate)
           dateMax = m_ReportDate;
        else
           dateMax = m_dateMax;
        end;
       
        query = " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS,  ENS.T_DATE T_DATE, ENS.T_FIID, ENS.T_PRINCIPAL,  ENS.T_NKD, ENS.T_TOTALCOST, 2 T_KIND "+
                "   from (select distinct dlnotpfi.t_DealID t_DealID from ddlnotpfi_tmp dlnotpfi "+
                "          where dlnotpfi.t_KindBO = 0 and dlnotpfi.t_dealtype = "+m_prev_dealtype+" and dlnotpfi.t_Department = "+m_prev_department+" ) dlnotpfi, "+
                "        ddl_tick_dbt tick, ddl_tick_ens_dbt ens "+
                "  where tick.t_DealID = dlnotpfi.t_DealID "+
                "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
                "    and ENS.T_DEALID  = dlnotpfi.t_DealID "+
                "    and ENS.T_KIND   = ? "+
                "    and ENS.T_DATE   >= ? "+
                "    and ENS.T_DATE   <= ? "+
                "    and ENS.T_DATE   != TICK.T_DEALDATE "+
                "    and ENS.T_ID     != (select min(ens1.t_ID) from ddl_tick_ens_dbt ens1 where ENS1.T_DEALID = ENS.T_DEALID and ENS1.T_FIID = ENS.T_FIID and ens1.t_Kind = ENS.T_KIND) "+
                " union all "+       
                " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS,  ENS.T_DATE T_DATE, ENS.T_FIID, ENS.T_PRINCIPAL,  ENS.T_NKD, ENS.T_TOTALCOST, 3 T_KIND "+
                "   from (select distinct dlnotpfi.t_DealID t_DealID from ddlnotpfi_tmp dlnotpfi "+
                "          where dlnotpfi.t_KindBO = 0 and dlnotpfi.t_dealtype = "+m_prev_dealtype+" and dlnotpfi.t_Department = "+m_prev_department+" ) dlnotpfi, "+
                "        ddl_tick_dbt tick, ddl_tick_ens_dbt ens "+
                "  where tick.t_DealID = dlnotpfi.t_DealID "+
                "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
                "    and ENS.T_DEALID  = dlnotpfi.t_DealID "+
                "    and ENS.T_KIND    = ? "+
                "    and ENS.T_DATE   >= ? "+
                "    and ENS.T_DATE   <= ? "+
                " union all "+       
                " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS, DLRQ.T_FACTDATE T_DATE, ENS.T_FIID,  ENS.T_PRINCIPAL,  ENS.T_NKD,ENS.T_TOTALCOST, 1 T_KIND "+
                "   from (select distinct dlnotpfi.t_DealID t_DealID from ddlnotpfi_tmp dlnotpfi "+
                "          where dlnotpfi.t_KindBO = 0 and dlnotpfi.t_dealtype = "+m_prev_dealtype+" and dlnotpfi.t_Department = "+m_prev_department+" ) dlnotpfi, "+
                "        ddl_tick_dbt tick, ddl_tick_ens_dbt ens, ddlrq_dbt dlrq "+
                "  where tick.t_DealID   = dlnotpfi.t_DealID "+
                "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
                "    and DLRQ.T_DOCID    = dlnotpfi.t_DealID "+
                "    and DLRQ.T_DOCKIND  = TICK.T_BOFFICEKIND "+
                "    and DLRQ.T_TYPE     = ? "+ 
                "    and DLRQ.T_NUM      = 0 "+
                "    and DLRQ.T_DEALPART = 1 "+
                "    and DLRQ.T_FACTDATE >= ? "+
                "    and DLRQ.T_FACTDATE <= ? "+
                "    and ENS.T_DEALID     = dlnotpfi.t_DealID "+
                "    and ENS.T_KIND       = ? "+
                "    and ENS.T_ID         = (select min(ens1.t_ID) from ddl_tick_ens_dbt ens1 where ENS1.T_DEALID = ENS.T_DEALID and ENS1.T_FIID = ENS.T_FIID and ens1.t_Kind = ENS.T_KIND) "+
                " union all "+           
                " select tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS t_DealCodeTS, DLRQ.T_FACTDATE T_DATE, "+
                "        ENS.T_FIID, sum (case when ens.t_kind = 0 then nvl(ens.t_principal,0)  else nvl(-ens.t_principal, 0) end) t_principal, "+
                "        SUM(CASE WHEN ens.T_KIND = 0 THEN NVL(ens.T_NKD,0) ELSE NVL(-ens.T_NKD,0) END) T_NKD, "+
                "        SUM(CASE WHEN ens.T_KIND = 0 THEN NVL(ens.T_TOTALCOST,0) ELSE NVL(-ens.T_TOTALCOST,0) END) T_TOTALCOST, 4 T_KIND "+
                "   from (select distinct dlnotpfi.t_DealID t_DealID from ddlnotpfi_tmp dlnotpfi "+
                "          where dlnotpfi.t_KindBO = 0 and dlnotpfi.t_dealtype = "+m_prev_dealtype+" and dlnotpfi.t_Department = "+m_prev_department+" ) dlnotpfi, "+
                "        ddl_tick_dbt tick, ddl_tick_ens_dbt ens, ddlrq_dbt dlrq "+
                "  where tick.t_DealID   = dlnotpfi.t_DealID "+
                "    and rsb_secur.IsBasket(rsb_secur.get_OperationGroup(rsb_secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind)))=1 "+
                "    and DLRQ.T_DOCID    = dlnotpfi.t_DealID "+
                "    and DLRQ.T_DOCKIND  = TICK.T_BOFFICEKIND "+
                "    and DLRQ.T_TYPE     = ? "+
                "    and DLRQ.T_NUM      = 0 "+
                "    and DLRQ.T_DEALPART = 2 "+
                "    and DLRQ.T_FACTDATE >= ? "+
                "    and DLRQ.T_FACTDATE <= ? "+
                "    and ENS.T_DEALID     = dlnotpfi.t_DealID "+
                " group by ENS.T_FIID, tick.t_DealID, tick.t_DealCode, tick.t_DealCodeTS, DLRQ.T_FACTDATE "+
                " order by T_DATE, t_DealCodeTS, T_KIND, T_FIID";
       
        Select = DL_RSDCommand();
       
        Select.AddParam(TICKENS_KIND_IN);
        Select.AddParam(dateMin);
        Select.AddParam(dateMax);
       
        Select.AddParam(TICKENS_KIND_OUT);
        Select.AddParam(dateMin);
        Select.AddParam(dateMax);
       
        Select.AddParam(DLRQ_TYPE_PAYMENT);
        Select.AddParam(dateMin);
        Select.AddParam(dateMax);
        Select.AddParam(TICKENS_KIND_IN);
       
        Select.AddParam(DLRQ_TYPE_PAYMENT);
        Select.AddParam(dateMin);
        Select.AddParam(dateMax);
       
        cnt = Select.GetCount(query);
        
        if(cnt > 0)
       
          CopyAllSheetInTotalBook( NULL, false, "N2_TableHeader", 0, m_SheetName );
          
          RegisterTable( "N2_MainTable", "",
                         "N2_CurNumber", 
                         "N2_DealCode",  
                         "N2_DealCodeTS", 
                         "N2_Date", 
                         "N2_OperKind",  
                         "N2_Ground",    
                         "N2_Registrar", 
                         "N2_RegistrarContr",    
                         "N2_Issuer",    
                         "N2_AvrKind",   
                         "N2_AvrCode",   
                         "N2_AvrSeries", 
                         "N2_AvrIssue",  
                         "N2_AvrISIN",   
                         "N2_Amount",    
                         "N2_Price", 
                         "N2_PriceISO",  
                         "N2_Cost",  
                         "N2_NKD",   
                         "N2_TotalCost"
                       );
       
       
          DataSet = Select.Execute(query);
       
          InitProgress( Int(cnt), "Отчет \"Регистр операций с обеспечением по сделкам РЕПО с корзиной ценных бумаг\"",
                        "Просмотр сделок с корзиной ценных бумаг" );
       
          while(DataSet.moveNext())
       
             SpGround = GetSpGroundByEns(DataSet.Kind);
             OperKind = GetOperKindByEns(DataSet.Kind);
       
             RegistrarShortName = RegistrarContrNum = "";
             GetRegistrarByDeal(DataSet.DealID,@RegistrarShortName,@RegistrarContrNum);
       
             if( ПолучитьФинИн( DataSet.FIID, rFininstr, rAvoiriss ) == 0 )
                IssShortName = ПолучитьКороткоеИмяСубъекта( FI_GetIssuerOnDate( rFininstr, dateMax), Date(DataSet.Date) );
                /* Сокращенное наименование вида ценной бумаги */
                AvoirKindName( rFininstr.AvoirKind, AvrKind );
                /* Код ц/б (Fininstr.FI_Code) */
                AvrCode = rFininstr.FI_Code;
                /* Серия ц/б */
                AvrSeries = rAvoiriss.Series;
                /* Транш ц/б */
                AvrIssue = rAvoiriss.Tranche;
                AvrISIN  = rAvoiriss.ISIN;
       
                Amount = DataSet.principal;
                
                Price = NKD = Cost = TotalCost = $0;
       
                if( (DataSet.Kind == KIND_EX_1) or ( DataSet.Kind == KIND_IN ) )
                  Cost = DataSet.TOTALCOST;
                  if( Amount != $0 )
                    Price = Cost/Amount;
                  end;
                  
                  PriceISO = m_CCA_NatCUR;
                  NKD = DataSet.NKD*Amount;                                
                  TotalCost = Cost + NKD;
                else
                  GetTotalSumFromLot(DataSet.Kind, DataSet.DealID, DataSet.FIID, SQL_ConvTypeDate(DataSet.Date), @TotalAmount, @Cost, @TotalNKD);
                  if( DataSet.Kind == KIND_EX_2 )
                    if( Amount != $0 )
                      Price = (Cost/Amount);                    
                      NKD = (TotalNKD/Amount);
                    end;                
                  else                   
                    if( Amount != $0 )
                      Price = Cost/Amount; 
                    end;
                    if( (Amount != $0) and (TotalAmount != $0) )
                      NKD = TotalNKD/TotalAmount*Amount;
                    end;
                  end;
                  
                  Cost = Price*Amount;
                  PriceISO = m_CCA_NatCUR;
                  TotalCost = Cost + NKD;
                end;
       
                this.PrintLine2(CurNumber, DataSet.DealCode, DataSet.DealCodeTS, SQL_ConvTypeDate(DataSet.Date), OperKind, SpGround, RegistrarShortName, RegistrarContrNum,
                                  IssShortName, AvrKind, AvrCode, AvrSeries,  AvrIssue,  AvrISIN, 
                                  Amount, Price, PriceISO, Cost, NKD, TotalCost);
             else
                msgBox ("Не найдена ц/б с FIID = "+string(DataSet.FIID));    
             end;
       
             UseProgress(CurNumber = CurNumber + 1);
       
          end;
       
          RemProgress();
       
          EndTable();
          CopyAllSheetInTotalBook( NULL, false, GetTableRange(), 0, m_SheetName );
       
        end;

     end;
  
  end;

  macro PrintByDeal()
     if( m_Deal.KINDBO == 0 )
        PrintByBO();
     elif( m_Deal.KINDBO == 1 )
        PrintByFXDeal();
     elif( m_Deal.KINDBO == 2 )
        PrintByVA();
     end;
  end;

  macro PrintByEveryDay()
     var NRec = 0, Num = 0;
     var vOrderBy = " order by t.T_DEPARTMENT, t.T_DEALDATE, t.T_KINDBO, t.T_DEALTYPE, t.T_DEALKIND, t.T_DEALTIME, t.T_DEALCODE, T_CLIENTID, T_BCID";
     var Select =  "select DENSE_RANK() OVER(ORDER BY t.t_clientid) clNo, ROW_NUMBER() OVER(PARTITION BY t.t_clientid " + vOrderBy + ") clEn, t.* " // 21.01.2021 MAA: iS - 519390
                  +"  from DDLNOTPFI_TMP t "
                 + vOrderBy;

     var cmd = DL_RSDCommand(Select);
                                                                                
     NRec = cmd.GetCount();
     if( NRec > 0 )
        InitProgress( NRec, "Печать данных по отобранным сделкам", "Печать данных по отобранным сделкам");
        m_Deal = cmd.Execute();
        while( m_Deal.MoveNext() )
           m_ReportDate = SQL_ConvTypeDate(m_Deal.DealDate);
           PrintByDeal();
           UseProgress( Num = Num + 1);
        end;
        RemProgress();
     end;
  end;

  macro PrintByPeriod()
     var NRec = 0, Num = 0;
     var vOrderBy = " order by t.T_DEPARTMENT, t.T_KINDBO, t.T_DEALTYPE, t.T_DEALKIND, t.T_DEALDATE, t.T_DEALTIME, t.T_DEALCODE, T_CLIENTID, T_BCID";
     var Select =  "select DENSE_RANK() OVER(ORDER BY t.t_clientid) clNo, ROW_NUMBER() OVER(PARTITION BY t.t_clientid " + vOrderBy + ") clEn, t.* " // 21.01.2021 MAA: iS - 519390
                  +"  from DDLNOTPFI_TMP t "
                  + vOrderBy ;

     var cmd = DL_RSDCommand(Select);
                                                                                
     NRec = cmd.GetCount();
     if( NRec > 0 )
        InitProgress(NRec, "Печать данных по отобранным сделкам", "Печать данных по отобранным сделкам");
        m_Deal = cmd.Execute();
        m_ReportDate = m_dateMax;
        while( m_Deal.MoveNext() )
           PrintByDeal();
           UseProgress( Num = Num + 1);
        end;
        RemProgress();
     end;
  end;

  macro ExecuteReport()

     CollectData();

     m_prev_department = -1;
     m_prev_dealDATE = date(0,0,0);  
     m_prev_KINDBO = -1;    
     m_prev_dealtype = -1;  
     m_prev_dealkind = -1;  

     if( m_IsPartDate )
        PrintByEveryDay();
     else
        PrintByPeriod();
     end;

  end;

  PRIVATE MACRO Create()
     SQL_Truncate( "DDLNOTPFI_TMP" );
     ExecuteReport();
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode, true, true );  
END;

MACRO RunReport()

  var stat = true;
  DlNotPFI_Form = Dl_NotPFI_Panel();

  var DlNotExec = Dl_NotPFI_Report( DlNotPFI_Form, "Report_DlNotPFI_usr.xlsx" );
  DlNotExec.SetRowFlushCount(2000); 
  stat = DlNotExec.Run(); 

  // Проверяем можем ли мы делать отчет по предоставленным данным
  if (not stat)
     return;
  end;

  if( stat )
    Dl_CallInsertStat( DL_OUTREPORT_EXCEL );
  end;

END;

RunReport();
exit(1);