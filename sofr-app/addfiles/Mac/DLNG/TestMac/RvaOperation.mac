/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : RvaOperation.mac
  Programmer  : Кастелин А.Н.
  Comment     : контрольные примеры для RsVox объекта RvaOperation
└───────────────────────────────────────────────────────────────────────────*/

IMPORT RsbObjFactory, dlmisc, HTMLRep;

PRIVATE MACRO DecodeOperationType(t)
    if   (t == 10)
        return "покупка";
    elif (t == 20)
        return "продажа";
    elif (t == 30)
        return "прямое РЕПО";
    elif (t == 40)
        return "обратное РЕПО";
    elif (t == 50)
        return "погашение";
    elif (t == 60)
        return "мена";
    elif (t == 70)
        return "зачисление";
    elif (t == 80)
        return "списание";
    else
        return "---";
    end;
END;
//=========================================================

PRIVATE MACRO HTMLDecodeCOType(t)
    if   (t == "C")
        return "требования&nbsp(C)";
    elif (t == "O")
        return "обязательства&nbsp(O)";
    else
        return "-";
    end;
END;
//===================================================================

var factory = RsbObjectFactory();
if (factory == NULL)
    msgbox("can't create RsbObjFactory");
    return;
end;

var op = factory.GetObject("RvaOperation");
if (op == NULL)
    msgbox("can't create RvaOperation");
    return;
end;

var rep_date = date(01, 01, 9999),
    dcode = "";
/*
if (GetString(dcode, "Введите код сделки:"))
    op.SetFilter("DealCode = " + dcode);
else
    return;
end;
*/

if (not GetDate(rep_date, "Введите отчётную дату:"))
    return;
end;

op.SetParmValue("EndDate", rep_date);

op.AddSortFld("DealDate");
op.AddSortFld("DealID");

rep_start("..\\txtfile\\RvaOperation_rep.html", "RvaOperation " + string(rep_date));

op.ApplyFilter();

rep_br("контрольные примеры для RsVox объекта RvaOperation");
rep_br("выборка на дату " + string(rep_date));
rep_br("");

rep_tbl_start();

rep_hdr("DealID");
rep_hdr("Код операции");
rep_hdr("Дата операции");
rep_hdr("Дата завершения операции");
rep_hdr("Код вида опреации");
rep_hdr("Код контрагента");
rep_hdr("Код клиента");
rep_hdr("Ставка РЕПО");
rep_hdr("Дата постановки сделки на баланс");
rep_hdr("Дата постановки на баланс 2 части");
rep_hdr("Группа риска");
rep_hdr("Процент РВП");
rep_hdr("Сумма созданного РВП");
rep_hdr("Сумма расчётного РВП");
rep_hdr("Номер Л/С по счёту РВП");
rep_hdr("Категория качества");
rep_hdr("Процент РВПС");
rep_hdr("Сумма созданного РВПС");
rep_hdr("Сумма расчётного РВПС");
rep_hdr("Номер Л/С по РВПС");
rep_hdr("Сумма обеспечения");
rep_hdr("Филиал");

rep_tbl_hdrend();

var stat = op.Next();
while (stat)
    rep_tbl_group(op.dealid);
    rep_tbl_row_start();

    rep_cell(op.dealid);                            // DealID
    rep_cell(op.DealCode);                          // Код операции
    rep_cell(op.DealDate);                          // Дата операции
    rep_cell(op.CloseDate);                         // Дата завершения операции
    rep_cell(DecodeOperationType(op.OperType));     // Код вида опреации
    rep_cell(op.PartyCode);                         // Код контрагента
    rep_cell(op.ClientCode);                        // Код клиента
    rep_cell(op.Rate);                              // Ставка РЕПО
    rep_cell(op.BalanceDate1);                      // Дата постановки сделки на баланс
    rep_cell(op.BalanceDate2);                      // Дата постановки на баланс 2 части
    rep_cell(op.QualityCategoryExp);                // Группа риска
    rep_cell(op.ReservePercentExp);                 // Процент РВП
    rep_cell(op.ReserveAmountExp);                  // Сумма созданного РВП
    rep_cell(op.ReserveCLCExp);                     // Сумма расчётного РВП
    rep_cell(op.ReserveAccountExp);                 // Номер Л/С по счёту РВП
    rep_cell(op.QualityCategory);                   // Категория качества
    rep_cell(op.ReservePercent);                    // Процент РВПС
    rep_cell(op.ReserveAmount);                     // Сумма созданного РВПС
    rep_cell(op.ReserveCLC);                        // Сумма расчётного РВПС
    rep_cell(op.ReserveAccount);                    // Номер Л/С по РВПС
    rep_cell(op.SecurityAmount);                    // Сумма обеспечения
    rep_cell(DL_DepartmentName(op.DepartmentID));   // Филиал

    rep_tbl_row_end();

    stat = op.Next();
end;

rep_tbl_end();

rep_end();
