/*──────────────────────────────────────────────────────────────────────────┐
  RS-Bank 6.0                                          R-Style Software Lab

  File Name   : RmmDeal.mac
  Programmer  : Кастелин А.Н.
  Comment     : контрольные примеры для RsVox объекта RmmDeal
└───────────────────────────────────────────────────────────────────────────*/

IMPORT RsbObjFactory;

PRIVATE MACRO PrintAccounts(acc)
var stat = acc.Next(),
    data = false;

    if (stat)
    [┌─────┬───────────────────────────┬──────────┬────────────┐];
    [│ Тип │        Лицевой счёт       │Балансовый│Используемый│];
    [│     │                           │   счёт   │            │];
    [├─────┼───────────────────────────┼──────────┼────────────┤];
        data = true;
    end;

    while (stat)
    [│ ### │ ######################### │ #####    │ ######     │]
        (acc.AccType, acc.Account, acc.Balance, acc.IsUsable);

        stat = acc.Next();
    end;

    if (data)
    [└─────┴───────────────────────────┴──────────┴────────────┘];
    end;

    return data;
END;
//=========================================================

MACRO PrintCarries(car)
var stat = car.Next(),
    data = false;

    if (stat)
    [┌────────────┬────────────┬──────┬───────────────────────────┬───────────────────────────┐];
    [│    Дата    │            │      │                           │                           │];
    [│  значения  │    Сумма   │Валюта│           Дебет           │           Кредит          │];
    [│  остатка   │            │      │                           │                           │];
    [├────────────┼────────────┼──────┼───────────────────────────┼───────────────────────────┤];
        data = true;
    end;

    while (stat)
    [│ ########## │ ########## │ ###  │ ######################### │ ######################### │]
        (car.CarryDate, car.Amount, car.Currency, car.DebitAccount, car.CreditAccount);

        stat = car.Next();
    end;

    if (data)
    [└────────────┴────────────┴──────┴───────────────────────────┴───────────────────────────┘];
    end;

    return data;
END;
//=========================================================

PRIVATE MACRO PrintRemainders(rm)
var stat = rm.Next(),
    data = false;

    if (stat)
    [┌────────────┬────────────┬────────────┬───────┐];
    [│            │    Дата    │  Остаток   │       │];
    [│ Изменяемая │ изменения  │   суммы    │Валюта │];
    [│   сумма    │   суммы    │   после    │остатка│];
    [│            │            │ изменения  │       │];
    [├────────────┼────────────┼────────────┼───────┤];
        data = true;
    end;

    while (stat)
    [│ ########## │ ########## │ ########## │ ###   │]
        (rm.Type, rm.ValueDate, rm.Amount, rm.Currency);

        stat = rm.Next();
    end;

    if (data)
    [└────────────┴────────────┴────────────┴───────┘];
    end;

    return data;
END;
//=========================================================

PRIVATE MACRO PrintProlongation(prl)
var stat = prl.Next(),
    data = false;

    if (stat)
    [┌────────────┬────────────┬────────────┬───────────┐];
    [│    Дата    │Новая план. │   Сумма    │  Валюта   │];
    [│пролонгации │    дата    │пролонгации │пролонгации│];
    [│            │ погашения  │            │           │];
    [├────────────┼────────────┼────────────┼───────────┤];
        data = true;
    end;

    while (stat)
    [│ ########## │ ########## │ ########## │ ###       │]
        (prl.ExecDate, prl.NewDate, prl.Amount, prl.Currency);

        stat = prl.Next();
    end;

    if (data)
    [└────────────┴────────────┴────────────┴───────────┘];
    end;

    return data;
END;
//=========================================================

PRIVATE MACRO PrintPercent(prc)
var stat = prc.Next(),
    data = false;

    if (stat)
    [┌────────────┬────────────┬───────────┐];
    [│    Дата    │   Сумма    │  Валюта   │];
    [│ начисления │начисленных │начисленных│];
    [│            │ процентов  │ процентов │];
    [├────────────┼────────────┼───────────┤];
        data = true;
    end;

    while (stat)
    [│ ########## │ ########## │ ###       │]
        (prc.AddDate, prc.AddSum, prc.Currency);

        stat = prc.Next();
    end;

    if (data)
    [└────────────┴────────────┴───────────┘];
    end;

    return data;
END;
//=========================================================

PRIVATE MACRO PrintReserve(res)
var stat = res.Next(),
    data = false;

    if (stat)
    [┌─────────────┬─────┬──────────┬────────────┬───────────┬────────────┬────────────┐];
    [│     Дата    │     │          │   Сумма    │  Валюта   │   Сумма    │    Дата    │];
    [│  изменения  │ ККС │ Процент  │обеспечения │обеспечения│  резерва   │формирования│];
    [│ ККС и Проц. │     │          │            │           │            │  резерва   │];
    [├─────────────┼─────┼──────────┼────────────┼───────────┼────────────┼────────────┤];
        data = true;
    end;

    while (stat)
    [│ ##########  │ ### │ ######## │ ########## │ ###       │ ########## │ ########## │]
        (res.ExecDate, res.QualityCategory, res.ReservePercent, res.SecurityAmount, res.SecurityCurrency, res.ReserveAmount, res.ReserveDate);

        stat = res.Next();
    end;

    if (data)
    [└─────────────┴─────┴──────────┴────────────┴───────────┴────────────┴────────────┘];
    end;

    return data;
END;
//=========================================================

PRIVATE MACRO PrintResParam(rp)
var stat = rp.Next(),
    data = false;

    if (stat)
    [┌─────────────┬─────┬──────────┐];
    [│     Дата    │ ККС │ Процент  │];
    [│  изменения  │     │          │];
    [├─────────────┼─────┼──────────┤];
        data = true;
    end;

    while (stat)
    [│ ##########  │ ### │ ######## │]
        (rp.ExecDate, rp.QualityCategory, rp.ReservePercent);

        stat = rp.Next();
    end;

    if (data)
    [└─────────────┴─────┴──────────┘];
    end;

    return data;
END;
//=========================================================

PRIVATE MACRO PrintGuarantee(gr)
var stat = gr.Next(),
    data = false;

    if (stat)
    [┌─────────────┬───────────┬─────────────────┬────────────┬───────────┬────────────┐];
    [│             │           │                 │  Рыночная  │  Валюта   │Коэффициент │];
    [│     Код     │    Вид    │     Эмитент     │ стоимость  │ рыночной  │ категории  │];
    [│   сделки    │обеспечения│                 │обеспечения │ стоимости │  качества  │];
    [│             │           │                 │            │обеспечения│обеспечения │];
    [├─────────────┼───────────┼─────────────────┼────────────┼───────────┼────────────┤];
        data = true;
    end;

    while (stat)
    [│ ##########  │ ######### │ ############### │ ########## │ ###       │ ########## │]
        (gr.DealCode, gr.Type, gr.Issuer.FullName, gr.Cost, gr.Currency, gr.QualityCategory);

        stat = gr.Next();
    end;

    if (data)
    [└─────────────┴───────────┴─────────────────┴────────────┴───────────┴────────────┘];
    end;

    return data;
END;
//=========================================================

var factory = RsbObjectFactory();
if (factory == NULL)
    msgbox("can't create RsbObjFactory");
    return;
end;

var deal = factory.GetObject("RmmDeal");
if (deal == NULL)
    msgbox("can't create RmmDeal");
    return;
end;

var rep_date = date(01, 01, 9999),
    dcode = "",
    filter = "";

if (GetString(dcode, "Введите код сделки:"))
    filter = "DealCode = " + dcode;
else
    return;
end;

if (GetDate(rep_date, "Введите отчётную дату:"))
    deal.SetParmValue("EndDate", rep_date);
end;

deal.SetFilter(filter);

deal.ApplyFilter();

println("контрольные примеры для RsVox объекта RmmDeal");
println("");
println("выборка на дату " + rep_date);
println("");

    [┌──────┬──────────┬────────────┬────────────┬────────────┬──────┬──────┬─────────────────┬────────────┬────────────┬──────┬────────────┬─────────────┬────────────┬────────────┬────────────┬────────────┬────────────┬─────────────┬────────────┬───────────┐];
    [│      │          │            │            │            │      │      │                 │            │            │      │            │             │            │            │            │            │            │             │   Сумма    │ Основание │];
    [│      │          │    Дата    │Фактич. дата│Планир. дата│      │      │                 │            │            │      │   Сумма    │    Сумма    │   Сумма    │    Дата    │            │ Категория  │  Процент   │    Сумма    │ расчётного │ отнесения │];
    [│DealID│   Код    │возникновен.│ погашения  │ погашения  │ Вид  │ Тип  │   Контрагент    │    Срок    │   Сумма    │Валюта│требований/ │просроченного│просроченных│  закрытия  │ Процентная │  качества  │  резерва   │ созданного  │  резерва,  │  сделки   │];
    [│      │  сделки  │требований/ │требований/ │требований/ │сделки│сделки│    по сделке    │   сделки   │   сделки   │сделки│обязательств│  основного  │ процентов  │   сделки   │   ставка   │   сделки   │  на дату   │   резерва   │скорректир. │  к более  │];
    [│      │          │обязательств│обязательств│обязательств│      │      │                 │            │            │      │ по сделке  │    долга    │            │            │            │            │            │             │ на сумму   │  высокой  │];
    [│      │          │            │            │            │      │      │                 │            │            │      │            │             │            │            │            │            │            │             │обеспечения │ кат. кач. │];
    [├──────┼──────────┼────────────┼────────────┼────────────┼──────┼──────┼─────────────────┼────────────┼────────────┼──────┼────────────┼─────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼─────────────┼────────────┼───────────┤];
//  [│ #### │ ######## │ ########## │ ########## │ ########## │ #### │ #### │ ############### │ ########## │ ########## │  ### │ ########## │ ##########  │ ########## │ ########## │ ########## │ ########## │ ########## │ ##########  │ ########## │ ######### │]

var stat = deal.Next(),
    party;
while (stat)
    party = "-";
    if (valtype(deal.party) != V_UNDEF)
        party = deal.party.FullName;
    end;

    [│ #### │ ######## │ ########## │ ########## │ ########## │ #### │ #### │ ############### │ ########## │ ########## │  ### │ ########## │ ##########  │ ########## │ ########## │ ########## │ ########## │ ########## │ ##########  │ ########## │ ######### │]
        (deal.dealid, deal.DealCode, deal.Start, deal.RepaymentDate, deal.Maturity, deal.Direction, deal.DealKind, party, deal.AbsoluteTerm, deal.CreditAmount, deal.CreditCurrency, deal.CreditAmountRep, deal.ExpCreditAmount, deal.ExpInterestAmount, deal.CloseDate, deal.Rate, deal.QualityCategory, deal.ReservePercent, deal.ReserveAmount, deal.ReserveCLC, deal.RiseQC);

    stat = deal.Next();
end;

    [└──────┴──────────┴────────────┴────────────┴────────────┴──────┴──────┴─────────────────┴────────────┴────────────┴──────┴────────────┴─────────────┴────────────┴────────────┴────────────┴────────────┴────────────┴─────────────┴────────────┴───────────┘];
    println();

    stat = deal.Next();
while (stat)

    println("Счета для сделки " + deal.DealCode + ":");
    PrintAccounts(deal.AccDoc);
    println();

    println("Доходы и расходы по сделке " + deal.DealCode + ":");
    PrintCarries(deal.Carries);
    println();

    println("История изменений для сделки " + deal.DealCode + ":");
    PrintRemainders(deal.RemainderH);
    println();

    println("История пролонгаций для сделки " + deal.DealCode + ":");
    PrintProlongation(deal.ProlongationH);
    println();

    println("История начисления процентов для сделки " + deal.DealCode + ":");
    PrintPercent(deal.PcAddH);
    println();

    println("Обеспечение сделки " + deal.DealCode + ":");
    PrintGuarantee(deal.Guarantee);
    println();

    stat = deal.Next();
end;


