/*
$Name:             IISContrMonitor_Form.mac
$Module:           Ценные бумаги
$Description:      Отчеты по договорам ИИС для обеспечения мониторинга своевременного предоставления клиентами документов о расторжении договора ИИС, открытого у другого ПУ.
                   Форма ввода параметров выпуска отчетов
*/

import "DlRepForm_h.mac";

PRIVATE CONST PNFLD_IISMONITOR_REQUIRED_REP       = 0,   
              PNFLD_IISMONITOR_NOT_PROVIDED_REP   = 1,  
              PNFLD_IISMONITOR_DAYS_TO_CLOSE      = 2,
              PNFLD_IISMONITOR_PROVIDED_REP       = 3,
              PNFLD_IISMONITOR_PROVIDED_BEGINDATE = 4,    
              PNFLD_IISMONITOR_PROVIDED_ENDDATE   = 5,    
              PNFLD_IISMONITOR_CLOSE_REP          = 6,
              PNFLD_IISMONITOR_CLOSE_BEGINDATE    = 7,    
              PNFLD_IISMONITOR_CLOSE_ENDDATE      = 8,   
              PNFLD_IISMONITOR_BYEXCEL            = 9,   
              PNFLD_IISMONITOR_REPORTDATE         = 10;   

PRIVATE CONST H_PNFLD_NOT_PROVIDED_REP   = 100,
              H_PNFLD_DAYS_TO_CLOSE      = 101,
              H_PNFLD_PROVIDED_REP       = 102,
              H_PNFLD_PROVIDED_BEGINDATE = 103,
              H_PNFLD_PROVIDED_ENDDATE   = 104,
              H_PNFLD_CLOSE_REP          = 105,
              H_PNFLD_CLOSE_BEGINDATE    = 106,
              H_PNFLD_CLOSE_ENDDATE      = 107,
              H_PNFLD_REPORTDATE         = 108;

PRIVATE MACRO FldProc_CheckBox1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
    FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
    if( Key == KEY_SPACE )
      if( FldRealValue != "X" )
        FldShowValue = FldRealValue = "X";
        EnableFields(pThis.Data(), PNFLD_IISMONITOR_DAYS_TO_CLOSE);
      else
        FldShowValue = FldRealValue = "";
        DisableFields(pThis.Data(), PNFLD_IISMONITOR_DAYS_TO_CLOSE);
      end;
    end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_CheckBox2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
    FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
    if( Key == KEY_SPACE )
      if( FldRealValue != "X" )
        FldShowValue = FldRealValue = "X";
        EnableFields(pThis.Data(), PNFLD_IISMONITOR_PROVIDED_BEGINDATE);
        EnableFields(pThis.Data(), PNFLD_IISMONITOR_PROVIDED_ENDDATE);
      else
        FldShowValue = FldRealValue = "";
        DisableFields(pThis.Data(), PNFLD_IISMONITOR_PROVIDED_BEGINDATE);
        DisableFields(pThis.Data(), PNFLD_IISMONITOR_PROVIDED_ENDDATE);
      end;
    end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_CheckBox3( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = "";
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE )
    FldRealValue = FldShowValue;
  elif( Cmd == DLG_KEY )
    if( Key == KEY_SPACE )
      if( FldRealValue != "X" )
        FldShowValue = FldRealValue = "X";
        EnableFields(pThis.Data(), PNFLD_IISMONITOR_CLOSE_BEGINDATE);
        EnableFields(pThis.Data(), PNFLD_IISMONITOR_CLOSE_ENDDATE);
      else
        FldShowValue = FldRealValue = "";
        DisableFields(pThis.Data(), PNFLD_IISMONITOR_CLOSE_BEGINDATE);
        DisableFields(pThis.Data(), PNFLD_IISMONITOR_CLOSE_ENDDATE);
      end;
    end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_DaysToClose( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(Cmd == DLG_INIT)
    if(FldRealValue == null)          
       FldRealValue = 5;
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
    if( (FldRealValue < 1) or (FldRealValue > 30) )
       MsgBox("Кол-во дней до расторж. договора ИИС может принимать значения от 1 до 30");
       return CM_IGNORE;
    end;
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Provided_BeginDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = {curdate} - 30;
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
    if( (FldRealValue != null) AND (pThis.GetLinkedValue(H_PNFLD_PROVIDED_ENDDATE) != null) )
      if( FldRealValue > pThis.GetLinkedValue(H_PNFLD_PROVIDED_ENDDATE) )
        MsgBox( "Дата окончания не может быть меньше даты начала периода");
        return CM_IGNORE;
      end;
    end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Provided_EndDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
    if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_PROVIDED_BEGINDATE) != null) )
      if( FldRealValue < pThis.GetLinkedValue(H_PNFLD_PROVIDED_BEGINDATE) )
        MsgBox("Дата окончания не может быть меньше даты начала периода");
        return CM_IGNORE;
      end;
    end;
    if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_REPORTDATE) != null) )
      if( FldRealValue > pThis.GetLinkedValue(H_PNFLD_REPORTDATE) )
        MsgBox("Дата окончания периода не может быть больше даты отчета");  
        return CM_IGNORE;
      end;
    end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Close_BeginDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
      FldRealValue = {curdate} - 30;
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
    if( (FldRealValue != null) AND (pThis.GetLinkedValue(H_PNFLD_CLOSE_ENDDATE) != null) )
      if( FldRealValue > pThis.GetLinkedValue(H_PNFLD_CLOSE_ENDDATE) )
        MsgBox("Дата окончания не может быть меньше даты начала периода");
        return CM_IGNORE;
      end;
    end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Close_EndDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
    if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_CLOSE_BEGINDATE) != null) )
      if( FldRealValue < pThis.GetLinkedValue(H_PNFLD_CLOSE_BEGINDATE) )
        MsgBox("Дата окончания не может быть меньше даты начала периода");
        return CM_IGNORE;
      end;
    end;
    if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_REPORTDATE) != null) )
      if( FldRealValue > pThis.GetLinkedValue(H_PNFLD_REPORTDATE) )
        MsgBox("Дата окончания периода не может быть больше даты отчета");  
        return CM_IGNORE;
      end;
    end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_ReportDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT ) /*Установка значения в поле*/
    if( FldRealValue == null ) /*инициализация по умолчанию*/
       FldRealValue = {curdate};
    end;
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) 
    FldRealValue = FldShowValue;
    if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_PROVIDED_ENDDATE) != null) )
      if( FldRealValue < pThis.GetLinkedValue(H_PNFLD_PROVIDED_ENDDATE) )
        MsgBox("Дата окончания периода не может быть больше даты отчета");  
        return CM_IGNORE;
      end;
    end;
    if( (FldRealValue != NULL) AND (pThis.GetLinkedValue(H_PNFLD_CLOSE_ENDDATE) != null) )
      if( FldRealValue < pThis.GetLinkedValue(H_PNFLD_CLOSE_ENDDATE) )
        MsgBox("Дата окончания периода не может быть больше даты отчета");  
        return CM_IGNORE;
      end;
    end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) )
    FldRealValue = GetDateByCalendar(FldRealValue);
    FldShowValue = FldRealValue;
  end;

  return CM_DEFAULT;
END;
                    
CLASS (DL_CPanel) IISContrMonitor_Panel()
  var IsRequiredRep     = UNSET_CHAR,   
      IsNotProvidedRep  = UNSET_CHAR,   
      DaysToClose       = 5,            
      IsProvidedRep     = UNSET_CHAR,   
      ProvidedBeginDate = {curdate} - 30,
      ProvidedEndDate   = {curdate},    
      IsCloseRep        = UNSET_CHAR,   
      CloseBeginDate    = {curdate} - 30,
      CloseEndDate      = {curdate},    
      ReportDate        = {curdate};    

  PRIVATE MACRO Init()
    AddFieldProc(0, PNFLD_IISMONITOR_REQUIRED_REP,       DL_PNFLD_CHECKBOX,          @DL_FldProc_CheckBox,        IsRequiredRep);
    AddFieldProc(0, PNFLD_IISMONITOR_NOT_PROVIDED_REP,   H_PNFLD_NOT_PROVIDED_REP,   @FldProc_CheckBox1,          IsNotProvidedRep);                 
    AddFieldProc(0, PNFLD_IISMONITOR_DAYS_TO_CLOSE,      H_PNFLD_DAYS_TO_CLOSE,      @FldProc_DaysToClose,        DaysToClose);
    AddFieldProc(0, PNFLD_IISMONITOR_PROVIDED_REP,       H_PNFLD_PROVIDED_REP,       @FldProc_CheckBox2,          IsProvidedRep);
    AddFieldProc(0, PNFLD_IISMONITOR_PROVIDED_BEGINDATE, H_PNFLD_PROVIDED_BEGINDATE, @FldProc_Provided_BeginDate, ProvidedBeginDate);
    AddFieldProc(0, PNFLD_IISMONITOR_PROVIDED_ENDDATE,   H_PNFLD_PROVIDED_ENDDATE,   @FldProc_Provided_EndDate,   ProvidedEndDate);
    AddFieldProc(0, PNFLD_IISMONITOR_CLOSE_REP,          H_PNFLD_CLOSE_REP,          @FldProc_CheckBox3,          IsCloseRep);          
    AddFieldProc(0, PNFLD_IISMONITOR_CLOSE_BEGINDATE,    H_PNFLD_CLOSE_BEGINDATE,    @FldProc_Close_BeginDate,    CloseBeginDate);  
    AddFieldProc(0, PNFLD_IISMONITOR_CLOSE_ENDDATE,      H_PNFLD_CLOSE_ENDDATE,      @FldProc_Close_EndDate,      CloseEndDate);  
    AddFieldProc(0, PNFLD_IISMONITOR_BYEXCEL,            DL_PNFLD_EXCEL,             @DL_FldProc_CheckBox,        SET_CHAR);  
    AddFieldProc(0, PNFLD_IISMONITOR_REPORTDATE,         H_PNFLD_REPORTDATE,         @FldProc_ReportDate,         ReportDate); 

    DisableFields(This.Data(), PNFLD_IISMONITOR_BYEXCEL); 

    if( This.GetFieldValue(PNFLD_IISMONITOR_NOT_PROVIDED_REP) == UNSET_CHAR )
      DisableFields(this.Data(), PNFLD_IISMONITOR_DAYS_TO_CLOSE);
    end;
    if( This.GetFieldValue(PNFLD_IISMONITOR_PROVIDED_REP) == UNSET_CHAR )
      DisableFields(this.Data(), PNFLD_IISMONITOR_PROVIDED_BEGINDATE);
      DisableFields(this.Data(), PNFLD_IISMONITOR_PROVIDED_ENDDATE);
    end;
    if( This.GetFieldValue(PNFLD_IISMONITOR_CLOSE_REP) == UNSET_CHAR )
      DisableFields(this.Data(), PNFLD_IISMONITOR_CLOSE_BEGINDATE);
      DisableFields(this.Data(), PNFLD_IISMONITOR_CLOSE_ENDDATE);
    end;
  END;

  PRIVATE MACRO Check():BOOL
    if((This.GetFieldValue(PNFLD_IISMONITOR_REQUIRED_REP) == UNSET_CHAR) AND 
       (This.GetFieldValue(PNFLD_IISMONITOR_NOT_PROVIDED_REP) == UNSET_CHAR) AND 
       (This.GetFieldValue(PNFLD_IISMONITOR_PROVIDED_REP) == UNSET_CHAR) AND
       (This.GetFieldValue(PNFLD_IISMONITOR_CLOSE_REP) == UNSET_CHAR) 
      )
      MsgBox("Необходимо выбрать формирование хотя бы одного отчета");
      return false;
    end;

    return true;
  END;

  MACRO Run()
    var stat = Run();
    IsRequiredRep     = GetFieldValue(PNFLD_IISMONITOR_REQUIRED_REP);
    IsNotProvidedRep  = GetFieldValue(PNFLD_IISMONITOR_NOT_PROVIDED_REP);
    DaysToClose       = GetFieldValue(PNFLD_IISMONITOR_DAYS_TO_CLOSE);
    IsProvidedRep     = GetFieldValue(PNFLD_IISMONITOR_PROVIDED_REP);
    ProvidedBeginDate = GetFieldValue(PNFLD_IISMONITOR_PROVIDED_BEGINDATE);
    ProvidedEndDate   = GetFieldValue(PNFLD_IISMONITOR_PROVIDED_ENDDATE);
    IsCloseRep        = GetFieldValue(PNFLD_IISMONITOR_CLOSE_REP);
    CloseBeginDate    = GetFieldValue(PNFLD_IISMONITOR_CLOSE_BEGINDATE);
    CloseEndDate      = GetFieldValue(PNFLD_IISMONITOR_CLOSE_ENDDATE);
    ReportDate        = GetFieldValue(PNFLD_IISMONITOR_REPORTDATE);

    return stat;
  END;
  
  initDL_CPanel( "sp_rep.lbr", "IISCMREP" ); 
END;
