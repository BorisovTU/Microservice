import rsd, RsbDataSet, oprinter;

MACRO DL_GetGroundRecByDeal (DealID, KindDoc, SerialNumRec, BOfficeKind)
      
   if( SerialNumRec == null )
      SerialNumRec = 1;
   end;

   if( BOfficeKind == null )
      BOfficeKind = DL_SECURITYDOC;
   end;
   
   var cmd, DataSet;   

   cmd = RsdCommand ( "SELECT  t.*                                                                   "+
                      "FROM dspground_dbt t                                                          "+
                      "WHERE (t_SPGroundID in (SELECT spgrd.t_SPGroundID                             "+
                      "FROM dspgrdoc_dbt spgrd                                                       "+
                      "WHERE spgrd.t_SourceDocKind = ? AND spgrd.t_SourceDocID = ? ) AND t_Kind = ?) "+
                      "ORDER BY t.t_spgroundid");

   cmd.addParam("",  RSDBP_IN, BOfficeKind);    
   cmd.addParam("",  RSDBP_IN, DealID     );    
   cmd.addParam("",  RSDBP_IN, KindDoc    );    
   cmd.execute();  

   DataSet = TRSBDataSet(cmd);
  
   while( DataSet.MoveNext() )  
      if( SerialNumRec == 1 )  
        return DataSet.rec;
      else 
        SerialNumRec = SerialNumRec - 1;  
      end;                         
   end;     

   /*во многих местах использования предполагается, что при отсутствии данных 
     нам вернется инициалиированная по умолчанию структура, а не структура с undefined*/
   if( ValType(DataSet.rec.SpgroundID) == V_UNDEF )
      DataSet = TRecHandler( "spground.dbt" );
   end;

   return DataSet.rec; 
END;
