/*
$Name:        dvfxmet010.mac
$Module:      Производные инструменты
$Description: Покупка/Продажа слитков. Шаг: Подтверждение сделки
*/

import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

macro ExecuteStep( doc, FDoc)

  record ndeal(dvndeal);
  var query, DataSet, cmd;
  var  FD, dat;
  var AttrID = 0;
  var flag = false;
  var stat = -1;
  SetBuff( ndeal, FDoc );
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, ndeal);
  /* Выполнить печать тикета, распорядительной записки */

  if( ( not DisconnectObjAttr(OBJTYPE_FXOPER_DV,  UniID( FD.deal, OBJTYPE_FXOPER_DV), 6 /* Формирование SWIFT */) ) OR
      ( not ConnectObjAttr(stat, OBJTYPE_FXOPER_DV, UniID( FD.deal, OBJTYPE_FXOPER_DV), 6 /* Формирование SWIFT */, 2, null, null, {curdate}) ) OR
      ( stat != 0 ) )
        msgbox( "Ошибка при установке Категории <Формирование SWIFT>" );
        return 1;
  end;

  if(FD.deal.rec.GenagrID > 0)   // если в ген. соглашении Основной способ подтверждения = SWIFT
      query = "Select gen.T_CONFIRMMETHOD Method From ddl_genagr_dbt gen Where gen.t_GenagrID = ?" ;
      cmd = DL_RSDCommand(query);
      cmd.AddParam(FD.deal.rec.GenagrID);
      DataSet = cmd.Execute();
      if( (DataSet.moveNext()) and (DataSet.Method == 0) )    // метод подтверждения- Swift
        if( ( not DisconnectObjAttr(OBJTYPE_FXOPER_DV,  UniID( FD.deal, OBJTYPE_FXOPER_DV), 6 /* Формирование SWIFT */) ) OR
            ( not ConnectObjAttr(stat, OBJTYPE_FXOPER_DV, UniID( FD.deal, OBJTYPE_FXOPER_DV), 6 /* Формирование SWIFT */, 1, null, null, {curdate}) ) OR
            ( stat != 0 ) )
             msgbox( "Ошибка при установке Категории <Формирование SWIFT>" );
             return 1;
        end;
      end;
  end;
  
  if( GetMainObjAttr( null, OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 6 /* Формирование SWIFT */, AttrID ) )
    if(AttrID == 1)
      flag = true;
    end;
  end;

  return 0;
end;
