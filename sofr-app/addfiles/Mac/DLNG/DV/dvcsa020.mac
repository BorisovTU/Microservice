/*
$Name:        dvcsa020.mac
$Module:      ФИССиКО
$Description: Сопровождение CSA: Подготовка маржевого платежа
*/
import "dv_car.mac", "dvcsalib.mac";

PRIVATE VAR CSAPayment = TRecHandler("dvcsapm.dbt");
private const GLOB_PARAM_CSAPayment_PMID= "dvcsa020_PMID";

PRIVATE MACRO НайтиСПИ(CSA, CSAPM,_accRest)/*CHVA 520030*/
    private macro ClearParams(command:RsdCommand)
        command.close;
        command.deleteParam(0);
        command.deleteParam(0);
        command.deleteParam(0);
        command.deleteParam(0);
        command.deleteParam(0);
    end;

    var СПИ = TBFile("settacc.dbt");
    
    var query = "SELECT sc.t_SettAccID SettAccID "
               +"  FROM DSETTACC_DBT sc, DPMAUTOAC_DBT pc "
               +" WHERE     pc.t_SettAccID = sc.t_SettAccID "
               +"       AND sc.t_PartyID = ? "     // 1) Контрагент
               +"       AND pc.t_ServiceKind = ? " // 2) Вид обслуживания
               +"       AND pc.t_KindOper = ? "    // 3) Вид операции
               +"       AND pc.t_FIID = ? "        // 4) Валюта
               +"       AND pc.t_Purpose = ?";     // 5) Назначение платежа
    /*PNV 525768 для АльфаБанка подбор такой же как для Промсвязьбанка*/
    if ((CSAPayment.rec.Direction == 0) and ((CSA.rec.PartyID == 1597) or (CSA.rec.PartyID == 1231))) /*для Промсвязьбанка - требование*/
       query = query + "and substr(sc.t_account, 1, 5) = '31501' ";
    elif ((CSAPayment.rec.Direction == 1) and ((CSA.rec.PartyID == 1597) or (CSA.rec.PartyID == 1231))) /*для Промсвязьбанка - обязательство*/
       if(_accRest == "322")/*CHVA 520030 если держателем маржевой суммы является Россельхоз банк, то есть если деньги на пассивном балансовом счете 31501,то у контрагента, соответственно, деньги отражаются на противоположном активном балансовом счете 32201 */
        query = query + "and substr(sc.t_account, 1, 5) = '31501' ";
       else
        query = query + "and substr(sc.t_account, 1, 5) = '32201' ";
       end;
    end;
    var cmd = RsdCommand(query);
    
    // 1. Все задано
    cmd.addParam("", RSDBP_IN, CSA.rec.PartyID);     // Контрагент
    cmd.addParam("", RSDBP_IN, PTSK_DV);             // Вид обслуживания - Срочные контракты - PTSK_DV - 15
    cmd.addParam("", RSDBP_IN, 2795);                // Вид операции - Операция сопровождения CSA
    cmd.addParam("", RSDBP_IN, CSAPM.rec.SumPayCur); // Валюта
    cmd.addParam("", RSDBP_IN, PM_PURP_CSA_MARGIN);  // Назначение платежа - Маржевый платеж CSA - PM_PURP_CSA_MARGIN - 86
    cmd.execute;
    var DataSet = TRsbDataSet(cmd);
    if (DataSet and DataSet.moveNext)
        СПИ.rec.SettAccID = DataSet.SettAccID;
        if (not СПИ.getEQ)
            return null;
        end;
    else
        ClearParams(cmd);
        // 2. Не задан вид операции
        cmd.addParam("", RSDBP_IN, CSA.rec.PartyID);     // Контрагент
        cmd.addParam("", RSDBP_IN, PTSK_DV);             // Вид обслуживания - Срочные контракты - PTSK_DV - 15
        cmd.addParam("", RSDBP_IN, 0);                   // Вид операции - не задан
        cmd.addParam("", RSDBP_IN, CSAPM.rec.SumPayCur); // Валюта
        cmd.addParam("", RSDBP_IN, PM_PURP_CSA_MARGIN);  // Назначение платежа - Маржевый платеж CSA - PM_PURP_CSA_MARGIN - 86
        cmd.execute;
        DataSet = TRsbDataSet(cmd);
        if (DataSet and DataSet.moveNext)
            СПИ.rec.SettAccID = DataSet.SettAccID;
            if (not СПИ.getEQ)
                return null;
            end;
        else
            ClearParams(cmd);
            // 3. Не задан вид операции и назначение платежа
            cmd.addParam("", RSDBP_IN, CSA.rec.PartyID);     // Контрагент
            cmd.addParam("", RSDBP_IN, PTSK_DV);             // Вид обслуживания - Срочные контракты - PTSK_DV - 15
            cmd.addParam("", RSDBP_IN, 0);                   // Вид операции - не задан
            cmd.addParam("", RSDBP_IN, CSAPM.rec.SumPayCur); // Валюта
            cmd.addParam("", RSDBP_IN, 0);                   // Назначение платежа - не задано
            cmd.execute;
            DataSet = TRsbDataSet(cmd);
            if (DataSet and DataSet.moveNext)
                СПИ.rec.SettAccID = DataSet.SettAccID;
                if (not СПИ.getEQ)
                    return null;
                end;
            end;
        end;
    end;
    
    return СПИ;
END;

private macro GetCSAMonth(mm)
   if   (mm ==  1) mm = "JAN"
   elif (mm ==  2) mm = "FEB"
   elif (mm ==  3) mm = "MAR"
   elif (mm ==  4) mm = "APR"
   elif (mm ==  5) mm = "MAY"
   elif (mm ==  6) mm = "JUN"
   elif (mm ==  7) mm = "JUL"
   elif (mm ==  8) mm = "AUG"
   elif (mm ==  9) mm = "SEP"
   elif (mm == 10) mm = "OCT"
   elif (mm == 11) mm = "NOV"
   elif (mm == 12) mm = "DEC" else mm = "ERR" end;
   return mm;
end;
    
private macro СформироватьНазначение(PaymentObj, SPI)
   var dd, mm, yyyy;
   var vd, md;
   var Ground = "";

   datesplit( CSAPayment.rec.PlanPayDate, dd, mm, yyyy );
   vd = dd + GetCSAMonth(mm) + substr(string(yyyy),3,2);
   datesplit( CSAPayment.rec.NextDate, dd, mm, yyyy );
   md = dd + GetCSAMonth(mm) + substr(string(yyyy),3,2);
   if (strlen(vd) == 6) vd = "0" + vd end;
   if (strlen(md) == 6) md = "0" + md end;

   /*
   MERRILL LYNCH:FVR MERRILL LYNCH INT.Collateral TRF VD18SEP10 MD18SEP11 under CSA DD2017JUL10 OF ISDA MASTER AGRM DD2013MAR28 FX Options Portfolio.RUAGRUMM is counterparty of CSA(credit support annex)
   Credit Suisse: Collateral TRF VD18SEP10 MD18SEP11 under CSA(credit support annex)DD 16/07/12 ISDA Master AGRM DD 15/04/23 for FX Options Portfolio Russian Agricultural Bank is counterparty of CSA
   J.P. MORGAN SECURITIES PLC : Collateral TRF VD18NOV21 MD18NOV23 under CSA(credit support annex)DD 16/05/17  ISDA Master AGRM DD 16/05/17 for FX Options Portfolio Russian Agricultual Bank is counterparty of CSA   
   GOLDMAN SACHS INTERNATIONAL: Collateral TRF VD19APR03 MD19APR04 under CSA(credit support annex)DD 31/10/17  ISDA Master AGRM DD 09MAR07 for FX Options Portfolio Russian Agricultual Bank is counterparty of CSA   
   SOCIETE GENERALE : Collateral TRF VD19APR03 MD19APR04 under CSA(credit support annex)DD 10/08/16 ISDA Master AGRM DD 14/09/12 for FX Options Portfolio Russian Agricultual Bank is counterparty of CSA   
   CITI BANK: REF BEL5162 02 0 REGVM Collateral TRF VD19APR02 MD19APR03 under CSA(credit support annex)DD 15NOV18 ISDA Master AGRM DD 16AUG12 FX Options counterparty  of CSA 
   ING: Collateral TRF VD19APR03 MD19APR04 under CSA(credit  support annex)DD 04/04/17 ISDA Master AGRM DD 02/04/2010 for FX Options Portfolio Russian Agricultual Bank is counterparty of CSA 
    
   Назначение по рублёвым платежам CSA  
   Сбербанк: Перечисление маржевой суммы по сделке от 17.12.2014 в соответствии с Договором о порядке уплаты плавающих маржевых сумм №78 от 01/10/2014. НДС не облагается."
   Райффайзенбанк : Перечисление маржевой суммы в соответствии с Договором о порядке уплаты  плавающих маржевых сумм №728-CSA/17 от  24/10/2017. НДС не облагается.
   ВТБ : Перечисление маржевой суммы в соответствии с Договором о порядке уплаты  плавающих маржевых сумм №63 от 23/05/2017. НДС не облагается.
   */
   // KS 08.07.2019 Назначение берём из поля "Описание" панели СПИ
   if ((ValType(SPI) != 0) and (SPI.rec.description != ""))
     Ground = SPI.rec.description;
     Ground = StrSubSt(Ground, "VD#", "VD"+vd);
     Ground = StrSubSt(Ground, "MD#", "MD"+md);
   else
     Ground = "Collateral TRF under CSA for FX Options Portfolio Russian Agricultural Bank is counterparty of CSA";
   end;

   return Ground
end;

MACRO ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
    record csaBuf(dvcsa);
    SetBuff(csaBuf, FDoc);
    var FD = DVFirstCSA(DocKind, csaBuf.CSAID);
    var accRest = ""; /*CHVA 520030*/
   
    var SPI = НайтиСПИ(FD.CSA, CSAPayment);
    var SPI2 = НайтиСПИ(FD.CSA, CSAPayment);  /*PNV 525768*/
    if (SPI.rec.SettAccID == 0)
        msgbox("Не найдена СПИ");
        return 1;
    end;

    var isKvit = ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей();
    
    var accBuf = TRecHandler("account.dbt");
    var minusRest = $0, plusRest = $0;
    
    if (FD.IsExistAccount("-МС", null, true, null, accBuf, null, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur))
        minusRest = abs(DL_GetRestAccount(accBuf.rec, CSAPayment.rec.PlanPayDate));
    end;
    
    if (FD.IsExistAccount("+МС", null, true, null, accBuf, null, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur))
        plusRest = abs(DL_GetRestAccount(accBuf.rec, CSAPayment.rec.PlanPayDate));
    end;
/*CHVA 520030 определяем на каком из счетов есть остаток*/
    if (minusRest !=0) 
     accRest ="315";
    elif (plusRest !=0)
     accRest = "322";
    end;
/*CHVA 520030*/
    SPI = НайтиСПИ(FD.CSA, CSAPayment,accRest);/*CHVA 520030*/
    if (SPI.rec.SettAccID == 0)
        msgbox("Не найдена СПИ");
        return 1;
    end;
    var PaymentObj = RsbPayment();
    var PaymentObj2;
    
    PaymentObj.DocKind = 4627; // Платеж по CSA
    PaymentObj.DocumentID = CSAPayment.rec.PMID;
    PaymentObj.OrderFIID = CSAPayment.rec.SumPayCur;
    PaymentObj.OrderAmount = CSAPayment.rec.SumPay;
    PaymentObj.BaseFIID = CSAPayment.rec.SumPayCur;
    PaymentObj.PayerAmount = CSAPayment.rec.SumPay;
    PaymentObj.BaseAmount = CSAPayment.rec.SumPay;
    PaymentObj.ValueDate = CSAPayment.rec.PlanPayDate;
    PaymentObj.Purpose = PM_PURP_CSA_MARGIN; // Маржевый платеж CSA
    PaymentObj.SubPurpose = 1;
    if (CSAPayment.rec.Direction == 0 /*Требование - Входящий платеж*/)
        PaymentObj.Ground = "Получение маржевой суммы по договору " + FD.CSA.rec.Code + " за " + CSAPayment.rec.enddate;
    else /*Обязательство - Исходящий платеж*/
//        PaymentObj.Ground = "Уплата маржевой суммы по договору " + FD.CSA.rec.Code;
        PaymentObj.Ground = СформироватьНазначение(PaymentObj, SPI);
    end;
    PaymentObj.Department = CSAPayment.rec.Department;
   //PaymentObj.Oper = {oper};
   //TEG 02.05.19 ролевая модель   
   /* Определяем конечного операциониста для проводки */
    PaymentObj.Oper = GetMainOperInGroup(PaymentObj.DocKind);
    if ( PaymentObj.Oper<= 0)
           PaymentObj.Oper = {Oper};
     end;
   /*PNV 509050*/
    if ((PaymentObj.BaseFIID == NATCUR) and (PaymentObj.BaseAmount >= 100000000) )
         PaymentObj.paymentkind = "С";
    end;
/*PNV 509050*/
   /**/

    PaymentObj.PaymStatus = IIF(((CSAPayment.rec.Direction == 0) and isKvit), PM_READIED, PM_PREPARING);
 
    var CorrSchem;
    if   ((SPI.rec.BankCorrID > 0) and (SPI.rec.BankCorrID != {OurBank}))
        CorrSchem = ПолучитьКорсхемуПоУмолчанию(SPI.rec.BankCorrID, SPI.rec.FIID, 1);
    elif ((SPI.rec.BankID > 0) and (SPI.rec.BankID != {OurBank}))
        CorrSchem = ПолучитьКорсхемуПоУмолчанию(SPI.rec.BankID, SPI.rec.FIID, 1);
    else
        CorrSchem = 0;
    end;
    
    var OurBankName:string = "";
    DV_GetPartyName({OurBank}, @OurBankName);
 
    if (CSAPayment.rec.Direction == 0 /*Требование*/)
        
        if( (plusRest != $0) and (plusRest < CSAPayment.rec.SumPay) )
            PaymentObj.OrderAmount = plusRest;
            PaymentObj.PayerAmount = plusRest;
            PaymentObj.BaseAmount = plusRest;
            
            PaymentObj2 = RsbPayment();
            PaymentObj2.DocKind = 4627; // Платеж по CSA
            PaymentObj2.DocumentID = CSAPayment.rec.PMID;
            PaymentObj2.OrderFIID = CSAPayment.rec.SumPayCur;
            PaymentObj2.OrderAmount = CSAPayment.rec.SumPay - plusRest;
            PaymentObj2.BaseFIID = CSAPayment.rec.SumPayCur;
            PaymentObj2.PayerAmount = CSAPayment.rec.SumPay - plusRest;
            PaymentObj2.BaseAmount = CSAPayment.rec.SumPay - plusRest;
            PaymentObj2.ValueDate = CSAPayment.rec.PlanPayDate;
            PaymentObj2.Purpose = PM_PURP_CSA_MARGIN; // Маржевый платеж CSA
            PaymentObj2.SubPurpose = 2;
            if (CSAPayment.rec.Direction == 0 /*Требование - Входящий платеж*/)
                PaymentObj2.Ground = "Получение маржевой суммы по договору " + FD.CSA.rec.Code + " за " + CSAPayment.rec.enddate;
            else /*Обязательство - Исходящий платеж*/
//                PaymentObj2.Ground = "Уплата маржевой суммы по договору " + FD.CSA.rec.Code;
                PaymentObj2.Ground = СформироватьНазначение(PaymentObj2, SPI);
            end;
            PaymentObj2.Department = CSAPayment.rec.Department;
           //PaymentObj2.Oper = {oper};
           //TEG 02.05.19 ролевая модель   
           /* Определяем конечного операциониста для проводки */
             PaymentObj2.Oper = GetMainOperInGroup(PaymentObj2.DocKind);
             if ( PaymentObj2.Oper<= 0)
                PaymentObj2.Oper = {Oper};
             end;
           /*PNV 509050*/
             if ((PaymentObj2.BaseFIID == NATCUR) and (PaymentObj2.BaseAmount >= 100000000) )
                  PaymentObj2.paymentkind = "С";
             end;
           /*PNV 509050*/

           /**/
            PaymentObj2.PaymStatus = IIF(isKvit,PM_READIED,PM_PREPARING);
            
            PaymentObj2.SetPayerPI( PAYMENTS_GROUP_UNDEF,
                                    SPI.rec.BankID,
                                    SPI.rec.BankCodeKind,
                                    SPI.rec.BankCode,
                                    SPI.rec.BankName,
                                    SPI.rec.CorrAcc,
                                    SPI.rec.FIID,
                                    SPI.rec.Chapter,
                                    SPI.rec.Account,
                                    SPI.rec.PartyID,
                                    SPI.rec.RecName,
                                    SPI.rec.INN,
                                    PTCK_CONTR,
                                    GetCodeParty(SPI.rec.PartyID, PTCK_CONTR),
                                    CorrSchem,
                                    0
                                  );
            
            PaymentObj2.SetReceiverPI( PAYMENTS_GROUP_INTERNAL,
                                       {OurBank},
                                       PTCK_CONTR,
                                       GetCodeParty({OurBank}, PTCK_CONTR),
                                       OurBankName,
                                       "",
                                       CSAPayment.rec.SumPayCur,
                                       1,
                                       "",
                                       {OurBank},
                                       OurBankName,
                                       GetCodeParty({OurBank}, PTCK_INN),
                                       PTCK_CONTR,
                                       GetCodeParty({OurBank}, PTCK_CONTR),
                                       0,
                                       0
                                     );
            
            PaymentObj2.Actuate();
        end;
        
        
        
        
        PaymentObj.SetPayerPI( PAYMENTS_GROUP_UNDEF,
                               SPI.rec.BankID,
                               SPI.rec.BankCodeKind,
                               SPI.rec.BankCode,
                               SPI.rec.BankName,
                               SPI.rec.CorrAcc,
                               SPI.rec.FIID,
                               SPI.rec.Chapter,
                               SPI.rec.Account,
                               SPI.rec.PartyID,
                               SPI.rec.RecName,
                               SPI.rec.INN,
                               PTCK_CONTR,
                               GetCodeParty(SPI.rec.PartyID, PTCK_CONTR),
                               CorrSchem,
                               0
                             );
        
        PaymentObj.SetReceiverPI( PAYMENTS_GROUP_INTERNAL,
                                  {OurBank},
                                  PTCK_CONTR,
                                  GetCodeParty({OurBank}, PTCK_CONTR),
                                  OurBankName,
                                  "",
                                  CSAPayment.rec.SumPayCur,
                                  1,
                                  "",
                                  {OurBank},
                                  OurBankName,
                                  GetCodeParty({OurBank}, PTCK_INN),
                                  PTCK_CONTR,
                                  GetCodeParty({OurBank}, PTCK_CONTR),
                                  0,
                                  0
                                );
        
    else /* CSAPayment.rec.Direction == 1 Обязательство*/
        
        if( (minusRest != $0) and (minusRest < CSAPayment.rec.SumPay) )
            PaymentObj.OrderAmount = minusRest;
            PaymentObj.PayerAmount = minusRest;
            PaymentObj.BaseAmount = minusRest;

            /*PNV 525768 подбор СПИ для второго платежа PaymentObj2 - нужен счет 315**/
            if(accRest == "315")
               accRest = "322";
            end; 
            SPI2 = НайтиСПИ(FD.CSA, CSAPayment, accRest);
            /*PNV*/

            PaymentObj2 = RsbPayment();
            PaymentObj2.DocKind = 4627; // Платеж по CSA
            PaymentObj2.DocumentID = CSAPayment.rec.PMID;
            PaymentObj2.OrderFIID = CSAPayment.rec.SumPayCur;
            PaymentObj2.OrderAmount = CSAPayment.rec.SumPay - minusRest;
            PaymentObj2.BaseFIID = CSAPayment.rec.SumPayCur;
            PaymentObj2.PayerAmount = CSAPayment.rec.SumPay - minusRest;
            PaymentObj2.BaseAmount = CSAPayment.rec.SumPay - minusRest;
            PaymentObj2.ValueDate = CSAPayment.rec.PlanPayDate;
            PaymentObj2.Purpose = PM_PURP_CSA_MARGIN; // Маржевый платеж CSA
            PaymentObj2.SubPurpose = 2;
            if (CSAPayment.rec.Direction == 0 /*Требование - Входящий платеж*/)
                PaymentObj2.Ground = "Получение маржевой суммы по договору " + FD.CSA.rec.Code  + " за " + CSAPayment.rec.enddate;
            else /*Обязательство - Исходящий платеж*/
//                PaymentObj2.Ground = "Уплата маржевой суммы по договору " + FD.CSA.rec.Code;
                PaymentObj2.Ground = СформироватьНазначение(PaymentObj2, SPI2);
            end;
            PaymentObj2.Department = CSAPayment.rec.Department;
            //PaymentObj2.Oper = {oper};
            //TEG 02.05.19 ролевая модель   
            /* Определяем конечного операциониста для проводки */
            PaymentObj2.Oper = GetMainOperInGroup(PaymentObj2.DocKind);
            if ( PaymentObj2.Oper<= 0)
                PaymentObj2.Oper = {Oper};
            end;
            /**/
          /*PNV 509050*/
            if ((PaymentObj2.BaseFIID == NATCUR) and (PaymentObj2.BaseAmount >= 100000000))
                 PaymentObj2.paymentkind = "С";
            end;
         /*PNV 509050*/

            PaymentObj2.PaymStatus = PM_PREPARING;
            /*PNV 525768 SPI2 вместо SPI*/
            PaymentObj2.SetReceiverPI( PAYMENTS_GROUP_UNDEF,
                                       SPI2.rec.BankID,
                                       SPI2.rec.BankCodeKind,
                                       SPI2.rec.BankCode,
                                       SPI2.rec.BankName,
                                       SPI2.rec.CorrAcc,
                                       SPI2.rec.FIID,
                                       SPI2.rec.Chapter,
                                       SPI2.rec.Account,
                                       SPI2.rec.PartyID,
                                       SPI2.rec.RecName,
                                       SPI2.rec.INN,
                                       PTCK_CONTR,
                                       GetCodeParty(SPI2.rec.PartyID, PTCK_CONTR),
                                       CorrSchem,
                                       0
                                     );
            /*PNV 525768*/
            PaymentObj2.SetPayerPI( PAYMENTS_GROUP_INTERNAL,
                                    {OurBank},
                                    PTCK_CONTR,
                                    GetCodeParty({OurBank}, PTCK_CONTR),
                                    OurBankName,
                                    "",
                                    CSAPayment.rec.SumPayCur,
                                    1,
                                    "",
                                    {OurBank},
                                    OurBankName,
                                    GetCodeParty({OurBank}, PTCK_INN),
                                    PTCK_CONTR,
                                    GetCodeParty({OurBank}, PTCK_CONTR),
                                    0,
                                    0
                                  );
                                  
            // KS 22.03.2019 CSAPayment недоступен из PostStep, а связка ещё не создана. Сохраняем
            setGlobalParameter(GLOB_PARAM_CSAPayment_PMID, CSAPayment.rec.PMID);
      
            PaymentObj2.isFactPaym = "X"; // ВР. Создаём операцию 4001 по исходящему платежу
           /*PNV 525768 SPI2 вместо SPI*/
       /* ВР. Дозаполняем реквизиты для получателя */
            PaymentObj2.ReceiverBankCorrAcc      = SPI2.rec.CorrAcc;
            PaymentObj2.ReceiverBankCorrCode     = SPI2.rec.BankCorrCode;
            PaymentObj2.ReceiverBankCorrCodeKind = SPI2.rec.BankCorrCodeKind;
            PaymentObj2.ReceiverBankCorrName     = SPI2.rec.BankCorrName;
            /*PNV 525768*/
            PaymentObj2.NumberPack = 80; // ВР

            PaymentObj2.Actuate();
        end;
    
        PaymentObj.SetReceiverPI( PAYMENTS_GROUP_UNDEF,
                                  SPI.rec.BankID,
                                  SPI.rec.BankCodeKind,
                                  SPI.rec.BankCode,
                                  SPI.rec.BankName,
                                  SPI.rec.CorrAcc,
                                  SPI.rec.FIID,
                                  SPI.rec.Chapter,
                                  SPI.rec.Account,
                                  SPI.rec.PartyID,
                                  SPI.rec.RecName,
                                  SPI.rec.INN,
                                  PTCK_CONTR,
                                  GetCodeParty(SPI.rec.PartyID, PTCK_CONTR),
                                  CorrSchem,
                                  0
                                );
        
        PaymentObj.SetPayerPI( PAYMENTS_GROUP_INTERNAL,
                               {OurBank},
                               PTCK_CONTR,
                               GetCodeParty({OurBank}, PTCK_CONTR),
                               OurBankName,
                               "",
                               CSAPayment.rec.SumPayCur,
                               1,
                               "",
                               {OurBank},
                               OurBankName,
                               GetCodeParty({OurBank}, PTCK_INN),
                               PTCK_CONTR,
                               GetCodeParty({OurBank}, PTCK_CONTR),
                               0,
                               0
                             );
      // KS 22.03.2019 CSAPayment недоступен из PostStep, а связка ещё не создана. Сохраняем
      setGlobalParameter(GLOB_PARAM_CSAPayment_PMID, CSAPayment.rec.PMID);

      PaymentObj.isFactPaym = "X"; // ВР. Создаём операцию 4001 по исходящему платежу

/* ВР. Дозаполняем реквизиты для получателя */
      PaymentObj.ReceiverBankCorrAcc      = SPI.rec.CorrAcc;
      PaymentObj.ReceiverBankCorrCode     = SPI.rec.BankCorrCode;
      PaymentObj.ReceiverBankCorrCodeKind = SPI.rec.BankCorrCodeKind;
      PaymentObj.ReceiverBankCorrName     = SPI.rec.BankCorrName;
    end;
    
    PaymentObj.NumberPack = 80; // ВР
   /*PNV 509050*/
    if ((PaymentObj.BaseFIID == NATCUR) and (PaymentObj.BaseAmount >= 100000000))
         PaymentObj.paymentkind = "С";
    end;
   /*PNV 509050*/

    PaymentObj.Actuate();
    
    if (isKvit)
        if(ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj) and ПИ_ПлатежКвитуетсяПоВидуФИ(PaymentObj) )
            if (CSA_АктуализацияСчета(FD, false, CSAPayment.rec.PMID, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, CSAPayment.rec.SumPay, CSAPayment.rec.Direction, PaymentObj, PaymentObj2 ))
                return 1;
            end;
        end;
    end;
    
    return 0;
END;

// KS Макрос постобработки шага "Исполнение обязательств"
MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

  var PaymentObj;
  var CSAPayment_PMID = getGlobalParameter(GLOB_PARAM_CSAPayment_PMID, false);
  if ((CommitOrRollback==1)and(CSAPayment_PMID != null)) /* Обязательство и мы знаем ИД платежа */
    // Статус меняем сначала
    var query = "update dpmpaym_dbt t " +
                "   set t_paymstatus = ? " +
                " where t.t_dockind = ? " +
                "   and t.t_documentid = ?";
    var cmd = RsdCommand(query);
    cmd.addParam("", RSDBP_IN, PM_READY_TO_SEND);
    cmd.addParam("", RSDBP_IN, 4627);
    cmd.addParam("", RSDBP_IN, CSAPayment_PMID);
    cmd.execute;

/*ak - Генерация SWIFT-сообщения*/
    ExecMacroFile("paymswift_dv", "PostStepSWIFT", CommitOrRollback, errTrn, FirstDoc, ID_Operation, Num_Step, Kind_Operation, KindDoc, KindStep, ID_Step);
/*~ak*/
    setGlobalParameter(GLOB_PARAM_CSAPayment_PMID, null);
  end;

  return 0;
END;
