/*  
$Name:        dvswift.mac
$Module:      Производные инструменты
$Description: Печать сообщений SWIFT
*/
import "dv_categ.mac", "DvRepFun2.mac", "dldlngfun.mac", "commonutil.mac", dv_lib /*Simanov. Избавляемся от библиотеки ,CommonInter*/, funk;
import "wlgenmes.mac";
import "wlgenmes_usr.mac", "dvswiftprint.mac";
import "WLTOOLS.mac";
import "u_mtprep_utils.mac";
import "mtedit.mac";

PRIVATE VAR settacc = TRecHandler("settacc.dbt");

private macro ЧислоЗнаковПослеЗапятой(number)
     var str = ЧислоCЗаданнойТочностью(number,12);
     var len = strlen(str);
     var separator = GetLocaleDecimalSeparator();                                         
     var i = 0, j = 0;
     var dec = 0;

     str = StrSubst( str, ".", separator );
     str = StrSubst( str, ",", separator );

     i = Index(str, separator);
     if(i > 0)
       j = i + 1;
       while(j < len)                                              
         
         if(Index("123456789", substr(str, j, 1)))
           dec = j - i;
         end;
                                                                   
         j = j + 1;                                                
                                                                   
       end;
     end;

     return dec;
end;

PRIVATE MACRO ЧислоСЗаданнойТочностью( _var, _point:integer, _parm:string ) 
  var TmpStr:string;
  if( (valtype (_var) == V_DOUBLE) OR (valtype (_var) == V_MONEY) )
    if((valtype (_parm) == V_UNDEF) OR (_parm == ""))
      TmpStr = "String(_var:0" + ":" + string(_point) + ")";
    else
      TmpStr = "String(_var:0" + ":" + string(_point) + ":" + _parm + ")";
    end;
    return ExecExp(TmpStr);
  else
    return String(_var);
  end;
END;      

//DAN 03/05/2020 Получаем транспорт указанный в сделке
private macro getTransportFromDeal(DealID:integer,transport:@string):string

  var query, DataSet, cmd;

  query = String("SELECT dvndeal.t_id,   \n"
                ,"       dvndeal.T_CONFTPID,   \n"
                ,"       TRANSP.T_NAME,   \n"
                ,"       (select nalg.t_sznamealg   \n"
                ,"          from ddl_genagr_dbt ga, dnamealg_dbt nalg   \n"
                ,"         where nalg.t_itypealg = 3182   \n"
                ,"           and nalg.t_inumberalg = ga.t_confirmmethod   \n"
                ,"           and ga.t_genagrid = dvndeal.t_genagrid) t_name_ga   \n"
                ,"  FROM ddvndeal_dbt dvndeal, dwltransp_dbt transp   \n"
                ," WHERE dvndeal.t_conftpid = TRANSP.T_TPID   \n"
                ,"   AND dvndeal.t_id = ?;   \n");
  cmd = DL_RSDCommand(query);
  cmd.AddParam(DealID);
  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    transport = DataSet.Name;
    if(transport == "")
      transport = DataSet.Name_ga;
    end;
  end;        

end;

//mda 19/02/2019 Определяем яв-ся ли контрагент банком
private macro ContrIsBank(pid):bool
  var sql;
  var que = "SELECT p.t_partyid as PID FROM dpartyown_dbt p WHERE p.t_partyid = ? AND p.t_partykind = 2";
  sql = DL_RSDCommand(que);
  sql.addParam( pid );
  var rs = sql.execute();
  if( rs.MoveNext() )
    if (rs.PID > 0)
      return true;
    else
      return false;
    end;
  end;
end;

//Simanov. Заменна CommonInter. Поиск записи о клиенте
private macro iFindBankClnt (partyid, name, inn, kpp)
  var sql;
  var que = " select client.t_name, "
      + "       case when instr(inn.t_code, '/') > 0 "
      + "            then substr(inn.t_code, 1, instr(inn.t_code, '/')-1) "
      + "            else inn.t_code "
      + "       end inn, "
      + "       case when instr(inn.t_code, '/') > 0 "
      + "            then substr(inn.t_code, instr(inn.t_code, '/')+1) "
      + "            else chr(1) "
      + "       end kpp "
      + "from dparty_dbt client "
      + "join dpartyown_dbt own ON own.t_partyid = client.t_partyid and "
      + "                          own.t_partykind = 1 "
      + "join dobjcode_dbt inn ON inn.t_objecttype = 3 and "
      + "                         inn.t_codekind = 16 and "
      + "                         inn.t_state = 0 and "
      + "                         inn.t_objectid = client.t_partyid "
      + "where client.t_partyid = ? ";
  sql = DL_RSDCommand(que);
  sql.addParam( partyid );
  var rs = sql.execute();
  if ( rs.MoveNext() )
    SetParm(1, rs.value("name"));
    SetParm(2, rs.value("inn"));
    SetParm(3, rs.value("kpp"));
    return true;
  end;

  return false;
OnError()
  return false;
End;

private macro получитьКорСчет(BankId)
  var query, DataSet, cmd;
  var queryAcc, DataSetAcc, cmdAcc;
  query = "Select bank.t_Coracc Coracc From dbankdprt_dbt bank Where bank.t_PartyID = ?" ;
  cmd = DL_RSDCommand(query);
  cmd.AddParam(BankId);
  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    return DataSet.Coracc;
  end;
  return "";
end;

private macro DateToStrDDMMYYYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + DV_LZ(Year, 4);
end;

private macro DateToStrDDMMYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + InvertStr(SubStr(InvertStr(string(Year)), 1, 2));
end;

private macro DateToStrYYYYMMDD( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Year, 4) + DV_LZ(Month, 2) + DV_LZ(Day, 2);
end;

private macro DateToStrYYMM( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return InvertStr(SubStr(InvertStr(string(Year)), 1, 2)) + DV_LZ(Month, 2);
end;

private macro DateToStrYYMMDD( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return InvertStr(SubStr(InvertStr(string(Year)), 1, 2)) + DV_LZ(Month, 2) + DV_LZ(Day, 2);
end;

private macro DeleteFakeSymbols( Str ):string
  var resstr = "", symb, i=0;

  for( i, 1, StrLen(str) )
     symb = SubStr(str, i, 1);
     if( (symb != ",") and (symb != ".") )
        resstr = resstr + symb;
     end;
  end;

  return resstr;
end;

private macro MakeCommonRef( BIC_A, BIC_B, Rate:string )
  var CommonRef, Bank1, Place1, RefCode, Bank2, Place2, LastNonZero, i, symb;

  if( StrLen(BIC_A) < 8 )
     RunError("|SWIFT-код банка нашего банка меньше 8 символов");
  end;

  if( StrLen(BIC_B) < 8 )
     RunError("|SWIFT-код банка-контрагента по сделке меньше 8 символов");
  end;

  if( BIC_A > BIC_B )
     Bank1  = SubStr(BIC_B, 1, 4);
     Place1 = SubStr(BIC_B, 7, 2);
     Bank2  = SubStr(BIC_A, 1, 4);
     Place2 = SubStr(BIC_A, 7, 2);
  else
     Bank1  = SubStr(BIC_A, 1, 4);
     Place1 = SubStr(BIC_A, 7, 2);
     Bank2  = SubStr(BIC_B, 1, 4);
     Place2 = SubStr(BIC_B, 7, 2);
  end;

  Rate = DeleteFakeSymbols(Rate);

  LastNonZero = 0;
  for( i, 1, StrLen(Rate) )
     symb = SubStr(Rate, i, 1);
     if( (symb != "0") and (symb != ",") and (symb != ".") )
        LastNonZero = i;
     end;
  end;

  if( LastNonZero >=4 )
     RefCode = SubStr(Rate, LastNonZero-3, 4);
  else
     RefCode = SubStr(Rate, 1, LastNonZero);
     while( StrLen(RefCode) < 4 )
        RefCode = "0" + RefCode;
     end;
  end;

  CommonRef = Bank1 + Place1 + RefCode + Bank2 + Place2;

  return CommonRef;
END;

private macro GetField_22C( Code1:string, Code2:string, pDate:date ):string
  var RetVal:string = "";

  private macro RetStr( _Code1:string, _Code2:string, _pDate:date ):string
     return SubStr(_Code1, 1, 4) + SubStr(_Code1, 7, 2) + DateToStrYYMM(_pDate) + SubStr(_Code2, 1, 4) + SubStr(_Code2, 7, 2);
  end;

  if( Code1 < Code2 )
     RetVal = RetStr(Code1, Code2, pDate);
  else
     RetVal = RetStr(Code2, Code1, pDate);
  end;

  return RetVal;
end;

private macro GetQueryGenAgrISDA():string
  var query = "SELECT t.T_DATE_GENAGR,              "+
              "       dl.t_code Version,            "+
              "       ag.t_code Type                "+
              "  FROM DDL_GENAGR_DBT t,             "+
              "       DLLVALUES_DBT dl,             "+
              "       DIR_TYPEAGREEMENT_DBT ag      "+
              " WHERE t.t_genagrid = ?              "+ 
              "   AND dl.t_list = 4018              "+
              "   AND dl.t_element = t.t_version_gs "+
              "   AND ag.t_id = t.t_type_gs";
  return query;
end;

private macro GetField_77H( ID:integer ):string
  var sql = DL_RSDCommand(GetQueryGenAgrISDA());
  sql.addParam( ID );
  var Field = sql.execute();
  if( Field.MoveNext() )
     var str = Field.Type + "/" + DateToStrYYYYMMDD(Field.t_date_genagr) + "//" + Field.Version;
     return str;
  else
     return "OTHER";
  end;
end;

private macro GetQueryGenAgr():string
  var query = "SELECT t.T_CODE Code,   "+
              "       t.T_DATE_GENAGR  "+
              "  FROM DDL_GENAGR_DBT t "+
              " WHERE t.T_GENAGRID = ?";
  return query;
end;

private macro GetField_77D( ID:integer ):string
  var sql = DL_RSDCommand(GetQueryGenAgr());
  sql.addParam( ID );
  var Field = sql.execute();
  if( Field.MoveNext() )
     return DateToStrYYYYMMDD(Field.t_date_genagr) + "/" + Field.Code;
  else
     return "OTHER";
  end;
end;

private macro GetField_57D( ID, DOCKIND, BS ,buy):string
  var str,name,inn,kpp,sql;
  var query = "SELECT p.t_payer, p.t_receiver,p.t_payeraccount,p.t_receiveraccount "+
              "  FROM dpmpaym_dbt p           "+
              " WHERE p.t_documentid = ?      "+
              "   AND p.t_dockind = ?    "+
              "   AND p.t_purpose = ?";
  sql = DL_RSDCommand(query);
  sql.addParam( ID );
  sql.addParam( DOCKIND );
  sql.addParam( BS );
  var Pay = sql.execute();
  if( Pay.MoveNext() )
    if (buy)
      if ( not iFindBankClnt(Pay.t_payer,name,inn,kpp) )
        name ="";
        inn = "";
        kpp = "";
      end;
      if(DOCKIND == 4813)
        str = "\r\n/"+Pay.t_payeraccount+"\r\nBIC "+ПолучитьКодСубъекта(Pay.t_payer, PTCK_BIC)+"\r\n";
      else
        str = "\r\n /"+Pay.t_payeraccount+"\r\n K/S "+Pay.t_receiveraccount+"\r\n BIC "+ПолучитьКодСубъекта(Pay.t_payer, PTCK_BIC)+"\r\n INN "+inn;
      end;
    else
      if ( not iFindBankClnt(Pay.t_receiver,name,inn,kpp) )
        name ="";
        inn = "";
        kpp = "";
      end;
      if(DOCKIND == 4813)
        str = "\r\n/"+Pay.t_receiveraccount+"\r\nBIC "+ПолучитьКодСубъекта(Pay.t_receiver, PTCK_BIC)+"\r\n";
      else
        str = "\r\n /"+Pay.t_receiveraccount+"\r\n K/S "+Pay.t_payeraccount+"\r\n BIC "+ПолучитьКодСубъекта(Pay.t_receiver, PTCK_BIC)+"\r\n INN "+inn;
      end;
    end;
  end;
  return str;
end;

private macro GetGenAgrType( TypeGS ):string
  var sql = DL_RSDCommand("SELECT t_code FROM dir_typeagreement_dbt WHERE t_id = ? ");
  sql.addParam( TypeGS );
  var rs = sql.execute();
  
  if( rs.moveNext() )
    return rs.Code;
  else
    return ""; 
  end;
end;

//mda 20.02.2019 Пока отдельно для 305 , потом сделать общую и совместить!
private macro GetField_57D_305( FD ):string
  record Account(account);
  const NOACC:string = "ACC YOUR INSTRUCTIONS";
  const SYMB_END:string = "\r\n";
  var PaymentID:integer = 0,RecAcc:string = "";
  var Платеж:RsbPayment;
  var MTStr:string = "";

  if (FD.deal.rec.Netting == SET_CHAR)
    MTStr = "NETTING";
    return MTStr;
  end;

  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, PRi/*6 - премия*/, 0, FD.deal.rec.bonusdate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж = RsbPayment(PaymentID);
  end;

  if (Платеж)
    if (FD.IsBuy())
      /*Тут мы премию платим*/
      MTStr = "/" + IIF(strlen(Платеж.ReceiverAccount) > 1,Платеж.ReceiverAccount,NOACC) + SYMB_END;
      if (strlen(Платеж.ReceiverBankCode) > 1)
        MTStr = MTStr + "BIC " + Платеж.ReceiverBankCode + SYMB_END;
      end; 
      if (strlen(Платеж.ReceiverCorrAccNostro) > 1)
        MTStr = MTStr + "CA " + Платеж.ReceiverCorrAccNostro + SYMB_END; 
      end;
      if (strlen(Платеж.ReceiverINN) > 1)
        MTStr = MTStr + "INN " + IIF(strlen(Платеж.ReceiverINN) > 10,SubStr(Платеж.ReceiverINN,1,10),Платеж.ReceiverINN) ;
      end;

    else
      /*Тут мы премию получаем*/
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, null, FD.deal.rec.bonusdate, FD.deal.rec.bonusfiid)) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.bonusdate, FD.deal.rec.bonusfiid)) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
      MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
      MTStr = MTStr + "INN " + {INN_Bank}; 
    end;
  end;

  return MTStr;

end;

/*PNV 515758 отдельно для IRS*/
private macro GetField_57D_36X_IRS( FD, IsBuy, Kind ):string
  record Account(account);
  const NOACC:string = "ACC YOUR INSTRUCTIONS";
  const SYMB_END:string = "\r\n";
  var PaymentID:integer = 0,RecAcc:string = "";
  var Платеж:RsbPayment;
  var MTStr:string = "";

  if (FD.deal.rec.Netting == SET_CHAR)
    MTStr = "NETTING";
    return MTStr;
  end;

  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, IIF(Kind == 360, 1, 2),  0, FD.deal.rec.begindate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж = RsbPayment(PaymentID);
  end;
  if (Платеж)
    if (IsBuy)
      /*Тут мы премию платим*/
      MTStr = "/" + IIF(strlen(Платеж.PayerAccount) > 1,Платеж.PayerAccount,NOACC) + SYMB_END;
      if (strlen(Платеж.PayerBankCode) > 1)
        MTStr = MTStr + "BIC " + Платеж.PayerBankCode + SYMB_END;
      end; 
      if (strlen(Платеж.PayerCorrAccNostro) > 1)
        MTStr = MTStr + "CA " + Платеж.PayerCorrAccNostro + SYMB_END; 
      end;
      if (strlen(Платеж.PayerINN) > 1)
        MTStr = MTStr + "INN " + IIF(strlen(Платеж.PayerINN) > 10, SubStr(Платеж.PayerINN, 1, 10), Платеж.PayerINN);
      end;

    else
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      /*pnv 506160*/
        MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
        if (strlen(Платеж.ReceiverBankCode) > 1)
            MTStr = MTStr + "BIC " + Платеж.ReceiverBankCode + SYMB_END;
        end; 
        if (strlen(Платеж.ReceiverCorrAccNostro) > 1)
           MTStr = MTStr + "CA " + Платеж.ReceiverCorrAccNostro + SYMB_END; 
        end;
        if (strlen(Платеж.ReceiverINN) > 1)
          MTStr = MTStr + "INN " + IIF(strlen(Платеж.ReceiverINN) > 10, SubStr(Платеж.ReceiverINN, 1, 10), Платеж.ReceiverINN);
        end;

       /*pnv 506160*/
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, MC_PAIRACCMODE_MANUAL, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования(),null,null,MC_PAIRACCMODE_MANUAL)) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
        MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
        MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
        MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
        MTStr = MTStr + "INN " + {INN_Bank}; 
      end;
    end;
  else
    if (IsBuy)
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, MC_PAIRACCMODE_MANUAL, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования(),null,null,MC_PAIRACCMODE_MANUAL)) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
      MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
      MTStr = MTStr + "INN " + {INN_Bank}; 
    else
      FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, 1/*FiKind*/, FD.nfi_baseactiv.rec.FIID, 15/*ServiceKind*/, 0/*KindOper*/, 0/*Purpose*/, 0/*BankID*/, Settacc);
      MTStr = "/" + IIF(strlen(Settacc.rec.account) > 1, Settacc.rec.account, NOACC) + SYMB_END;
      if (strlen(Settacc.rec.bankcode) > 1)
         MTStr = MTStr + "BIC " + Settacc.rec.bankcode + SYMB_END;
      end;
      if (strlen(Settacc.rec.corracc) > 1)
         MTStr = MTStr + "CA " + Settacc.rec.corracc + SYMB_END; 
      end;
      if (strlen(Settacc.rec.inn) > 1)
         MTStr = MTStr + "INN " + IIF(strlen(Settacc.rec.inn) > 10, SubStr(Settacc.rec.inn, 1, 10), Settacc.rec.inn);
      end;
    end;
  end;

  return MTStr;
end;
/*PNV 515758 отдельно для IRS*/

//kvv 26.02.2019 Пока отдельно для 360-362!
private macro GetField_57D_36X( FD, IsBuy, pmgr ):string
  record Account(account);
  const NOACC:string = "ACC YOUR INSTRUCTIONS";
  const SYMB_END:string = "\r\n";
  var PaymentID:integer = 0,RecAcc:string = "";
  var Платеж:RsbPayment;
  var MTStr:string = "";
  if (pmgr == null)
      pmgr = false;
  end;

  if (FD.deal.rec.Netting == SET_CHAR)
    MTStr = "NETTING";
    return MTStr;
  end;

  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, 2, 0, FD.deal.rec.begindate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж = RsbPayment(PaymentID);
  end;
  if ((Платеж) and (not pmgr))
    if (IsBuy)
      /*Тут мы премию платим*/
      MTStr = "/" + IIF(strlen(Платеж.ReceiverAccount) > 1,Платеж.ReceiverAccount,NOACC) + SYMB_END;
      if (strlen(Платеж.ReceiverBankCode) > 1)
        MTStr = MTStr + "BIC " + Платеж.ReceiverBankCode + SYMB_END;
      end; 
      if (strlen(Платеж.ReceiverCorrAccNostro) > 1)
        MTStr = MTStr + "CA " + Платеж.ReceiverCorrAccNostro + SYMB_END; 
      end;
      if (strlen(Платеж.ReceiverINN) > 1)
        MTStr = MTStr + "INN " + IIF(strlen(Платеж.ReceiverINN) > 10, SubStr(Платеж.ReceiverINN, 1, 10), Платеж.ReceiverINN);
      end;

    else
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      /*pnv 506160*/
        MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
        if (strlen(Платеж.ReceiverBankCode) > 1)
            MTStr = MTStr + "BIC " + Платеж.ReceiverBankCode + SYMB_END;
        end; 
        if (strlen(Платеж.ReceiverCorrAccNostro) > 1)
           MTStr = MTStr + "CA " + Платеж.ReceiverCorrAccNostro + SYMB_END; 
        end;
        if (strlen(Платеж.ReceiverINN) > 1)
          MTStr = MTStr + "INN " + IIF(strlen(Платеж.ReceiverINN) > 10, SubStr(Платеж.ReceiverINN, 1, 10), Платеж.ReceiverINN);
        end;
       /*pnv 506160*/
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, MC_PAIRACCMODE_MANUAL, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования(),null,null,MC_PAIRACCMODE_MANUAL)) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
        MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
        MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
        MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
        MTStr = MTStr + "INN " + {INN_Bank}; 
      end;
    end;
  else
    if ((IsBuy) and (not pmgr))
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, MC_PAIRACCMODE_MANUAL, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования(),null,null,MC_PAIRACCMODE_MANUAL)) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
      MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
      MTStr = MTStr + "INN " + {INN_Bank}; 
    else
      FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, 1/*FiKind*/, FD.nfi_baseactiv.rec.FIID, 15/*ServiceKind*/, 0/*KindOper*/, 0/*Purpose*/, 0/*BankID*/, Settacc);
      MTStr = "/" + IIF(strlen(Settacc.rec.account) > 1, Settacc.rec.account, NOACC) + SYMB_END;
      if (strlen(Settacc.rec.bankcode) > 1)
         MTStr = MTStr + "BIC " + Settacc.rec.bankcode + SYMB_END;
      end;
      if (strlen(Settacc.rec.corracc) > 1)
         MTStr = MTStr + "CA " + Settacc.rec.corracc + SYMB_END; 
      end;
      if (strlen(Settacc.rec.inn) > 1)
         MTStr = MTStr + "INN " + IIF(strlen(Settacc.rec.inn) > 10, SubStr(Settacc.rec.inn, 1, 10), Settacc.rec.inn);
      end;
    end;
  end;

  return MTStr;
end;

private macro GetField_14C( ID:integer ):string
  var sql = DL_RSDCommand(GetQueryGenAgrISDA());
  sql.addParam( ID );
  var Field = sql.execute();
  if( Field.MoveNext() )
     var str = Field.Version;
     return str;
  else
     return "0000";
  end;
end;

private macro GetField_22( Code1:string, Code2:string, Course:string ):string
  var RetVal:string = "";
  Course = StrSubst(Course, ",", "");
  var len = StrLen(Course);

  if( len > 4 )
     Course = SubStr(Course, len - 3);
  elif( len < 4 )
     while( len < 4 )
           Course = "0" + Course;
           len = StrLen(Course);
     end;
  end;

  private macro RetStr( _Code1:string, _Code2:string, _Course:string ):string
     return SubStr(_Code1, 1, 4) + SubStr(_Code1, 7, 2) + _Course + SubStr(_Code2, 1, 4) + SubStr(_Code2, 7, 2);
  end;

  if( Code1 < Code2 )
     RetVal = RetStr(Code1, Code2, Course);
  else
     RetVal = RetStr(Code2, Code1, Course);
  end;

  return RetVal;
end;

private macro GetField_22B( PartId ):string
  var query = "SELECT substr(p.t_nrcountry, 1, 2)||                  "+
              "       CASE WHEN pt.t_city like '% %'                 "+
              "            THEN substr(pt.t_city, 1 , 1)||           "+
              "                 substr(pt.t_city,                    "+
              "                        instr(pt.t_city, ' ') + 1, 1) "+
              "            ELSE substr(pt.t_city, 1, 2)              "+
              "       END fc                                         "+
              "  FROM dparty_dbt p,                                  "+
              "       dptbicdir_dbt pt                               "+
              " WHERE p.t_partyid = pt.t_partyid                     "+
              "   AND p.t_partyid = ?";
  var sql = DL_RSDCommand(query);
  sql.addParam( PartId );
  var FC = sql.execute();
  if( FC.MoveNext() )
     if( FC.fc == "RUMO" )
        println(":18A:1");
        println(":22B:RUMO");
     else
        println(":18A:2");
        println(":22B:RUMO");
        println(":22B:" + FC.fc);
  end;
  else
  println(":18A:1");
     println(":22B:RUMO");
  end;
end;

private macro GetField_23A( Type:integer, ПоставочныйКонтракт:bool ):string
  var RetVal:string = "";

  if( Type == ALG_DV_FIX_FLOAT )
     RetVal = "FIXEDFLOAT";
  elif( Type == ALG_DV_FLOAT_FIX )
     RetVal = "FLOATFIXED";
  elif( Type == ALG_DV_FIX_FIX )
     RetVal = "FIXEDFIXED";
  elif( Type == ALG_DV_FLOAT_FLOAT )
     RetVal = "FLOATFLOAT";
  end;
/*
  if( ПоставочныйКонтракт )
     RetVal = RetVal + "/GROSS";
  else
     RetVal = RetVal + "/NET";
  end;
*/
  return RetVal;
end;

private macro GetField_23( Type:integer, OptionType:integer, OptionStyle:integer, Валюта ):string
  var RetVal:string = "";

  if( Type == ALG_DV_BUY )
     RetVal = "BUY";
  elif( Type == ALG_DV_SALE )
     RetVal = "SELL";
  end;

  if( OptionType == OPTIONKIND_CALL )
     RetVal = RetVal + "/CALL";
  elif( OptionType == OPTIONKIND_PUT)
     RetVal = RetVal + "/PUT";
  end;

  if( OptionStyle == DVSTYLE_AMERICAN )
     RetVal = RetVal + "/A";
  else
     RetVal = RetVal + "/E";
  end;

  RetVal = RetVal + "/" + Валюта;

  return RetVal;
end;

private macro GetField_14A( TypeCalc:integer ):string
  var RetVal:string = "OTHER";

  if( TypeCalc == ALG_DV_TYPECALC_FOLLOWING )
     RetVal = "FOLLOWING";
  elif( TypeCalc == ALG_DV_TYPECALC_MODIFIED )
     RetVal = "MODIFIEDF";
  elif( TypeCalc == ALG_DV_TYPECALC_PRECEDING )
     RetVal = "PRECEDING";
  end;

  return RetVal;
end;

private macro NumToStr( Number, Point:integer, DelR:bool ):string
  var RetVal = ЧислоCЗаданнойТочностью(Number, Point);
  var index_ = Index(RetVal, ".");

  if( index_ == 0 ) /* нет дробной части */
     RetVal = RetVal + ",";
  else
     var i:integer = 0;
     if( (DelR != NULL) and (DelR == true) )
        RetVal = SubStr(RetVal, 1, index_ - 1) + "," + SubStr(RetVal, index_ + 1, strlen(RetVal) - 1);
        /* убираем нули справа */
        i = strlen(RetVal);
        while( i > 0 )
          if( SubStr(RetVal, i, 1) == "0" )
             RetVal = SubStr(RetVal, 1, i-1);
             i = strlen(RetVal);
          else
             break;
          end;
        end;
     else
        var ExFlag:bool = false;
        var Estr = SubStr(RetVal, index_ + 1, strlen(RetVal) - 1); /* дробная часть */
        i = strlen(Estr);
        while( i > 0 )
           if( SubStr(Estr, i, 1) != "0" )
              ExFlag = true;
              break;
           end;
           i = i - 1;
        end;

        RetVal = SubStr(RetVal, 1, index_ - 1) + ",";

        if( ExFlag )
           RetVal = RetVal + Estr;
        end;
     end;
  end;

  return RetVal;
end;

private macro GetCountPmGr( DealID:integer, Side:integer, Netting ):integer
  var RetVal:integer = 0;
  var Query, Data, Sql;

  Sql = " SELECT count(1) as cnt " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID  = ? " +
        "    AND t_Side    = ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting != SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     RetVal = SQL_ConvTypeInteger(Data.cnt);
  end;

  return RetVal;
end;

private macro GetNumberPmGr( PmGr:TRecHandler ):integer
  var RetVal:integer = 0;
  var Query, Data, Sql;

  Sql = " SELECT q.t_Num " +
        "   FROM (SELECT row_number() over(ORDER BY pmgr.t_BegDate) t_Num, pmgr.* " +
        "           FROM ddvnpmgr_dbt pmgr " +
        "          WHERE pmgr.t_DealID = ? " +
        "            AND pmgr.t_Side   = ?) q " +
        "  WHERE q.t_ID = ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, PmGr.rec.DealID);
  Query.addParam("", RSDBP_IN, PmGr.rec.Side);
  Query.addParam("", RSDBP_IN, PmGr.rec.ID);
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     RetVal = SQL_ConvTypeInteger(Data.Num);
  end;

  return RetVal;
end;

private macro GetPmGrViewByNumber( DealID:integer, Side:integer, Number:integer, Netting )
  var RetVal = NULL;
  var Query, Data, Sql;

  Sql = " SELECT pm.* " +
        "   FROM (SELECT row_number() over(ORDER BY pmgr.t_BegDate) t_Num, pmgr.* " +
        "           FROM ddvnpmgr_dbt pmgr " +
        "          WHERE pmgr.t_DealID = ? "
        "            AND pmgr.t_Side = ?) q, dv_dvnpmgr pm " +
        "  WHERE q.t_Num = ? " +
        "    AND pm.t_ID = q.t_ID " +
        "    AND pm.t_Type = 3 ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting != SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.addParam("", RSDBP_IN, Number);
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     RetVal = Data;
  end;

  return RetVal;
end;

private macro GetBegEndDatePmGr( DealID:integer, Side:integer, Netting, BegDate:@date, EndDate:@date )
  var RetVal:integer = 0;
  var Query, Data, Sql;

  BegDate = date(0,0,0);
  EndDate = date(0,0,0);

  Sql = " SELECT Min(t_BegDate) as t_BDate, Max(t_EndDate) as t_EDate " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID = ? " +
        "    AND t_Side   = ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting != SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     BegDate = SQL_ConvTypeDate(Data.BDate);
     EndDate = SQL_ConvTypeDate(Data.EDate);
  end;
end;

private macro Print_30F_32M( DealID:integer, Side:integer, Netting, Currency:string, print32M:bool )
  var Query, Data, Sql;

  Sql = " SELECT t_PayDate, t_DemandSum, t_LiabilitySum " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID  = ? " +
        "    AND t_Side    = ? " +
        " ORDER BY t_PayDate ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting !=SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.execute();

  Data = TRsbDataSet(Query);
  while( Data.MoveNext() )
     /* Дата платежа */
     println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(Data.PayDate)));
     if( print32M )
        /* Валюта, сумма платежа */
        println(":32M:" + Currency + NumToStr(SQL_ConvTypeSum(IIF(Side == ALG_DV_PMGR_SIDE_DEMAND, Data.DemandSum, Data.LiabilitySum)), 2));
     end;
  end;
end;

private macro Print_18A_30F_32M( nFi, DealID:integer, Side:integer, Netting, Currency:string, print32M:bool )
  var Query, Data, Data32M, Sql, i = 0, countpaym = 0;
  Sql = "SELECT CASE WHEN F.T_PERIODKIND = 1                              "+
        "            THEN F.T_EXECDATE - D.T_BEGINDATE                    "+
        "            WHEN F.T_PERIODKIND = 2                              "+
        "            THEN months_between(F.T_EXECDATE,  D.T_BEGINDATE)    "+
        "            WHEN F.T_PERIODKIND = 3                              "+
        "            THEN months_between(F.T_EXECDATE,  D.T_BEGINDATE)/12 "+
        "       END dif,                                                  "+
        "       D.T_BEGINDATE BeginDate,                                  "+
        "       f.T_EXECDATE ExecDate                                     "+
        "  FROM ddvndeal_dbt d,                                           "+
        "       ddvnfi_dbt f                                              "+
        " WHERE D.T_ID = ?                                                "+
        "   AND F.T_DEALID = D.T_ID                                       "+
        "   AND F.T_TYPE = ?";
  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, nFi.rec.DealID);
  Query.addParam("", RSDBP_IN, IIF(Side == 1, 0, 2));
  Query.execute();
  Data = TRsbDataSet(Query);

  if( Data.MoveNext() )   
     var BeginDate = date(Data.BeginDate);
     var ExecDate = date(Data.ExecDate);
     var NextDate:Date;
     var Rest = mod(Data.dif, nFi.rec.Period);
     var Cnt = round(Data.dif/nFi.rec.Period, 0, 2);
     var str30F = "";

     /* Дата платежа */
     if( Data.dif/nFi.rec.Period > Cnt )
        if( nFi.rec.PeriodKind == 1)
           NextDate = DateShift(BeginDate, int(round(Rest, 0, 1)));
        end;
        if( nFi.rec.PeriodKind == 2)
           NextDate = DateShift(BeginDate, int(round(30 * Rest, 0, 1)));
        end;
        if( nFi.rec.PeriodKind == 3)
           NextDate = DateShift(BeginDate, int(round(365 * Rest, 0, 1)));
        end;
          // str30F = ":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(NextDate));/*PNV 515758*/
        BeginDate = NextDate;
     end;

     /* Дата платежа */
     while(i <= cnt)
       
       if( nFi.rec.PeriodKind == 1)
          NextDate = DateShift(BeginDate, nFi.rec.Period);
       end;
       if( nFi.rec.PeriodKind == 2)
          NextDate = DateShift(BeginDate, null, nFi.rec.Period);
       end;
       if( nFi.rec.PeriodKind == 3)
          NextDate = DateShift(BeginDate, null, null, nFi.rec.Period);
       end;

       if( NextDate > ExecDate ) 
          str30F = IIF(strlen(str30F) > 0, str30F + "\r\n", str30F) + ":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(ExecDate));
          countpaym = countpaym + 1;
          if( print32M )
             /* Валюта, сумма платежа */
             Sql = "SELECT t_DemandSum, t_LiabilitySum " +
                   "  FROM ddvnpmgr_dbt " +
                   " WHERE t_DealID  = ? " +
                   "   AND t_Side    = ? " +
                   " ORDER BY t_PayDate ";
             Query = RSDCommand( Sql );
             Query.NullConversion = true;
             Query.addParam("", RSDBP_IN, DealID);
             Query.addParam("", RSDBP_IN, IIF(Netting !=SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
             Query.execute();
             Data32M = TRsbDataSet(Query);
            
             if( Data32M.MoveNext() )
                str30F = str30F + "\r\n:32M:" + Currency + NumToStr(SQL_ConvTypeSum(IIF(Side == ALG_DV_PMGR_SIDE_DEMAND, Data32M.DemandSum, Data32M.LiabilitySum)), 2);
             end;
          end;
          i = i + 1;
          break;
       end;
       
       str30F = IIF(strlen(str30F) > 0, str30F + "\r\n", str30F) + ":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(NextDate));
       countpaym = countpaym + 1;
       if( print32M )
          /* Валюта, сумма платежа */
          Sql = "SELECT t_DemandSum, t_LiabilitySum " +
                "  FROM ddvnpmgr_dbt " +
                " WHERE t_DealID  = ? " +
                "   AND t_Side    = ? " +
                " ORDER BY t_PayDate ";
          Query = RSDCommand( Sql );
          Query.NullConversion = true;
          Query.addParam("", RSDBP_IN, DealID);
          Query.addParam("", RSDBP_IN, IIF(Netting !=SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
          Query.execute();
          Data32M = TRsbDataSet(Query);

          if( Data32M.MoveNext() )
             str30F = str30F + "\r\n:32M:" + Currency + NumToStr(SQL_ConvTypeSum(IIF(Side == ALG_DV_PMGR_SIDE_DEMAND, Data32M.DemandSum, Data32M.LiabilitySum)), 2);
          end;
       end;
       BeginDate = NextDate;
       i = i + 1;
    end;

    if( Data.dif/nFi.rec.Period > Cnt )
       i = i + 1;
    end;
    /* Количество повторений */
    println(":18A:" + countpaym);
    println(str30F);
  end;
end;

private macro GetBasis( Basis:integer ):string
  var RetVal:string = "";

  if( Basis == DV_BASIS_ACTACT )
     RetVal = "ACT/365";
  elif( Basis == DV_BASIS_ACT365 )
     RetVal = "AFI/365";
  elif( Basis == DV_BASIS_ACT360 )
     RetVal = "ACT/360";
  elif( Basis == DV_BASIS_30360 )
     RetVal = "360/360";
  elif( Basis == DV_BASIS_31360 )
     RetVal = "36E/360";
  end;

  return RetVal;
end;

private macro GetPeriod( Period:integer, PeriodKind:integer ):string
  var RetVal:string = string(Period);

  if( PeriodKind == ALG_DV_PERIODKIND_PRRATE_DAY )
     RetVal = RetVal + "D";
  elif( PeriodKind == ALG_DV_PERIODKIND_PRRATE_MONTH )
     RetVal = RetVal + "M";
  elif( PeriodKind == ALG_DV_PERIODKIND_PRRATE_YEAR )
     RetVal = RetVal + "Y";
  end;

  return RetVal;
end;

PRIVATE MACRO GetIsNotResident ( PartyID:integer )
  var sqlPartcode, PartyRow;

  sqlPartcode = RSDCommand("select t_NotResident "+
                           "  from dparty_dbt    "+
                           " where t_PartyID = ? "+
                           "   and t_NotResident = 'X'");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartyRow = TRsbDataSet(sqlPartcode);
  if( PartyRow.MoveNext() )
     return true;
  end;

  return false;
END;

PRIVATE MACRO GetCode_103 ( PartyID:integer )
  var sqlPartcode, PartyRow;

  sqlPartcode = RSDCommand("SELECT t_code FROM dobjcode_dbt WHERE t_objecttype = 3 AND t_codekind = 103 AND t_objectid = ?");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartyRow = TRsbDataSet(sqlPartcode);
  if( PartyRow.MoveNext() )
     return PartyRow.t_code;
  end;

  return "";
END;

private macro PrintFixMT360_MT361( nFI:TRecHandler, Deal:TBFile, Side:integer, Netting, Валюта:integer, Kind:integer/*360,361*/ )
  if( nFi.rec.RateId == -1 )
     /* Фиксированная ставка */
     println(":37M:" + NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true));
  else
     /* Детали процентной ставки */
     println(":37N:");
  end;       
  /* Количество повторений */
  //Print_18A_30F_32M(nFI, Deal.rec.ID, Side, Netting, ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING), IIF(nFi.rec.RateId == -1, false, true));
  println(":18A:" + GetCountPmGr(Deal.rec.ID, Side, Netting));
  /* :30F: Дата платежа */
  /* :32M: Валюта, сумма платежа */
  Print_30F_32M(Deal.rec.ID, Side, Netting, ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING), IIF(nFi.rec.RateId == -1, false, true));
  if( nFi.rec.RateId == -1 )
     /* Признак корректировки даты окончания периода */
     println(":17F:" + IIF(Deal.rec.CorrectDate == SET_CHAR, "Y", "N"));
     /* Порядок расчета рабочих дней */
     println(":14D:" + GetBasis(nFI.rec.Basis));
  end;
  println(":14A:" + GetField_14A(nFI.rec.TypeCalc));
  /* Финансовый центр */
  GetField_22B(Deal.rec.Contractor);
end;

private macro GetField_14F( nFi )
  var sqlQuery, ret; 
      sqlQuery = RSDCommand("select t_NAME, decode(nvl(t_DEFINITION, chr(1)), chr(1), 'OTHER', t_DEFINITION) t_DEFINITION from dfininstr_dbt where t_FIID = ?"); /*i-support 506573*/
      sqlQuery.addParam( "", RSDBP_IN, nFi.rec.RateId );
      sqlQuery.execute();
      ret = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
      ret.MoveLast();
      if( (not ret.DEFINITION) or (ret.DEFINITION == "OTHER") )
         println(":14F:OTHER");
         /* Детали процентной ставки */
         println(":37N:/FROP/" + ret.NAME);
      else
         println(":14F:" + /*ПолучитьКодФинИн(nFi.rec.FiId, null, FICK_ISOSTRING) + "-" + */ ret.DEFINITION);
      end;
end;

private macro GetField_14F_MT340( nFi )
  var sqlQuery, ret; 
      sqlQuery = RSDCommand("select t_NAME, decode(nvl(t_DEFINITION, chr(1)), chr(1), 'OTHER', t_DEFINITION) t_DEFINITION from dfininstr_dbt where t_FIID = ?"); /*i-support 506573*/
      sqlQuery.addParam( "", RSDBP_IN, nFi.rec.RateId );
      sqlQuery.execute();
      ret = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
      ret.MoveLast();
      setparm(1,ret.NAME);
      return ret.DEFINITION;
end;

private macro GetField_14J( ID, nFI )/*PNV i-support 496982*/
  var sql; 
  var Query = "SELECT  distinct CASE WHEN BD.T_BEGDATE >= BD.T_FIXDATE "+
                     "            THEN 'FIRST'                      "+
                     "            ELSE 'LAST'                       "+
                     "       END str                                "+
                     "  FROM ddvnpmgr_dbt bd,                       "+
                     "       ddvndeal_dbt nd                        "+
                     " WHERE nd.T_ID = ?                            "+
                     "   AND BD.T_SIDE = 1                          "+
                     "   /*AND BD.T_BEGDATE = ND.T_BEGINDATE*/      "+ /*PNV i-support 504624*/
                     "   AND BD.T_DEALID = nd.T_ID";
  sql = DL_RSDCommand(Query);
  sql.addParam( ID );
  var rs = sql.execute();
  if( rs.MoveNext() )
     println(":14J:" + rs.str);
     /*PNV i-support 496982 заполнять 38E: только если есть 14J*/
     /* Расчетный срок погашения*/ 
     println(":38E:" + GetPeriod(nFI.rec.Period, nFI.rec.PeriodKind));
     /*PNV i-support 496982*/
  end;
end;

/*PNV 515758*/
private macro ДатаНачала( ID )
  var sql;
  var begdate  = "";
  var Query = "SELECT   min(bd.t_begdate) begdate"+
                     "  FROM ddvnpmgr_dbt bd  "+
                     " WHERE bd.T_dealID = ?  ";
  sql = DL_RSDCommand(Query);
  sql.addParam( ID );
  var rs = sql.execute();
  if( rs.MoveNext() )
     begdate =  rs.begdate;
  end;
  return begdate;
end;
/*PNV 515758*/

private macro PrintFloatMT360_MT361( nFI:TRecHandler, Deal:TBFile, Side:integer, Netting, Kind:integer/*360,361*/ )
  /* Вариант плавающей ставки */
  GetField_14F(nFi);
  /* Определение даты изменения ставки */
  GetField_14J( Deal.rec.Id, nFI);

  /*PNV i-support 496982 заполнение 38E: перенесено в private macro GetField_14J*/
  /* Расчетный срок погашения 
  println(":38E:" + GetPeriod(nFI.rec.Period, nFI.rec.PeriodKind));*/

  /* Количество повторений */
  //Print_18A_30F_32M(nFI, Deal.rec.ID, Side, Netting, null, false);
  println(":18A:" + GetCountPmGr(Deal.rec.ID, Side, Netting));
  /* :30F: Дата платежа */
  Print_30F_32M(Deal.rec.ID, Side, Netting, NULL/*не используется*/, false);
  /* Признак корректировки даты окончания периода */
  println(":17F:" + IIF(Deal.rec.CorrectDate == SET_CHAR, "Y", "N"));
  /* Порядок расчета рабочих дней */
  println(":14D:" + GetBasis(nFI.rec.Basis));
  println(":14A:" + GetField_14A(nFI.rec.TypeCalc));
  /* Финансовый центр */
  GetField_22B(Deal.rec.Contractor);
  if( Kind == 361 )
     if( nFI.rec.Spread != 0.0 )
        /* Спред */
        println(":37R:" + NumToStr(nFI.rec.Spread, 4, true));
     end;
  end;
end;

private macro PrintCommonMT360_MT361( FD, Kind:integer/*360,361*/ )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  println(":20:" + substr(DateToStrDDMMYYYY(FD.ДатаСделки()) + "-" + FD.DealCode(), 1, 16));
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  end;
  /* Тип операции */
  println(":22A:NEWT");
  /* Общий референс */
  println(":22C:" + GetField_22C(CodeSWIFT_Our, CodeSWIFT_Contr, FD.ДатаИсполнения()));
  /* Определение свопа */
  println(":23A:" + GetField_23A(FD.Deal.rec.Type) + "/" + IIF(Kind == "361", "GROSS", 
                                                                              IIF(FD.Deal.rec.netting_pmgr == "X", "NET", 
                                                                                                                   "GROSS")));
  /* Номер контракта */
  println(":21N:" + FD.DealCode() + IIF(Kind == 361, "-CCYIRS", "-IRS"));
  /* Дата сделки */
  println(":30T:" + DateToStrYYYYMMDD(FD.ДатаСделки()));
  /* Дата вступления в силу */
  /*PNV 515758*/
  if (ДатаНачала(FD.deal.rec.ID) == "")
      println(":30V:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
  else
      println(":30V:" + DateToStrYYYYMMDD(ДатаНачала(FD.deal.rec.ID) ));
  end;
  /*PNV 515758*/
 
  /* Дата закрытия */
  println(":30P:" + DateToStrYYYYMMDD(FD.ДатаИсполнения()));
  /* Порядок расчета рабочих дней */
  println(":14A:" + GetField_14A(FD.nFI_BaseActiv.rec.TypeCalc));

  if( Kind == 361 )
     /* Валюта, условная основная сумма стороны B */
     println(":32B:" + ПолучитьКодФинИн(FD.ВалютаТребования(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаТребования(), 2));
     /* Валюта, условная основная сумма стороны A */
     println(":33B:" + ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));
  elif( Kind == 360 )
     /* Валюта, сумма */
     println(":32B:" + ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));
  end;

  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  if( GetField_77H(FD.Deal.rec.GenAgrId) == "OTHER" )
     println(":77H:OTHER");
     /* Условия контракта */
     println(":77D:" + GetField_77D(FD.Deal.rec.GenAgrId));
  else
     /* Тип, дата, версия соглашения */
     println(":77H:" + GetField_77H(FD.Deal.rec.GenAgrId));
  end;
  /* Год версий определений */
  if(Kind == 361)
	println(":14C:" + GetField_14C(FD.Deal.rec.genagrid));
  elif( Kind == 360 )
    var vers_year = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_YEARDEFINITIONS);
    if(vers_year == "")
      vers_year = "0000";
    end;
    println(":14C:" + vers_year);
  end;
  /* Фиксированный процент, выплачиваемый стороной B */
  if( (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX) or (FD.Deal.rec.Type == ALG_DV_FIX_FIX) )
     println(":15B:");
     PrintFixMT360_MT361(FD.nFI_BAOther, FD.Deal, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, FD.ВалютаТребования(), Kind);
  end;

  /* Плавающий процент, выплачиваемый стороной B */
  if( (FD.Deal.rec.Type == ALG_DV_FIX_FLOAT) or (FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT) )
     println(":15C:");
     PrintFloatMT360_MT361(FD.nFI_BAOther, FD.Deal, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, Kind);
  end;

     /* Платежные инструкции для процентов выплачиваемых контрагентом */
     println(":15D:");
     /* Агент получатель */
     if( GetIsNotResident(FD.Deal.rec.Contractor))
        if( получитьКорСчет(1))
           println(":57A:/" + получитьКорСчет(1));
           println(trim(CodeSWIFT_Our));
        else
           println(":57A:" + trim(CodeSWIFT_Our));
        end;
     elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
        println(":57D:" + GetField_57D_36X_IRS( FD, false, Kind)); /*выплачиваемых контрагентом - мы получаем*/
     else
        if( получитьКорСчет(1))
           println(":57A:/" + получитьКорСчет(1));
           println(trim(CodeSWIFT_Our));
        else
           println(":57A:" + trim(CodeSWIFT_Our));
        end;
     end;
  /* Фиксированный процент, выплачиваемый стороной A */
  if( (FD.Deal.rec.Type == ALG_DV_FIX_FLOAT) or (FD.Deal.rec.Type == ALG_DV_FIX_FIX) )
        println(":15E:");
        PrintFixMT360_MT361(FD.nFI_BaseActiv, FD.Deal, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, FD.ВалютаОбязательства(), Kind);
  end;

  /* Плавающий процент, выплачиваемый стороной A */
  if( (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX) or (FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT) )
       println(":15F:");
        PrintFloatMT360_MT361(FD.nFI_BaseActiv, FD.Deal, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, Kind);
  end;

  /* Платежные инструкции для процентов выплачиваемых контрагенту */
  println(":15G:");
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     if( получитьКорСчет(FD.Deal.rec.Contractor) )
        println(":57A:/" + получитьКорСчет(FD.Deal.rec.Contractor));
        println(trim(CodeSWIFT_Contr));
     else
        println(":57A:" + trim(CodeSWIFT_Contr));
     end;
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X_IRS( FD, true, Kind )); /*выплачиваемых контрагенту - платим мы*/
  else
     if( получитьКорСчет(FD.Deal.rec.Contractor) )
        println(":57A:/" + получитьКорСчет(FD.Deal.rec.Contractor));
        println(trim(CodeSWIFT_Contr));
     else
        println(":57A:" + trim(CodeSWIFT_Contr));
     end;
  end;
end;

private macro PrintPaymMT361_15K( BegDate:date, EndDate:date, Платеж, Платеж2, CodeSWIFT:string, TypeCalc:integer, FD )
  var str;
  var DemandPayment;
  /* Количество повторений */
  println(":18A:2");
  /* Тип обмена */
  println(":22X:INLX");
  /* Дата, валюта, сумма платежа */
  println(":30F:" + DateToStrYYYYMMDD(BegDate));
  println(":32M:" + ПолучитьКодФинИн(Платеж.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж.rec.OrderAmount, 2));
  DemandPayment = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  /* Агент получатель */
  Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
  println(str);
/*
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
     println(":57A:/" + str);
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
     println(":57A:/" + str);
  end;
*/
  /* Тип обмена */
  println(":22X:FINX");
  /* Дата, валюта, сумма платежа */
  println(":30F:" + DateToStrYYYYMMDD(EndDate));
  println(":32M:" + ПолучитьКодФинИн(Платеж2.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж2.rec.OrderAmount, 2));
  DemandPayment = RsbPayment(FD.ПлатежОб.rec.PaymentID);
  /* Агент получатель */
  Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
  println(str);
/*
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
     println(":57A:/" + str);
  elif( ПолучитьКодФинИн(FD.ВалютаТребования(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
     println(":57A:/" + str);
  end;
*/
  /* Порядок расчета рабочих дней */
  println(":14A:" + GetField_14A(TypeCalc));
  /* Финансовый центр */
  GetField_22B(FD.Deal.rec.Contractor);
end;

private macro PrintPaymMT361_15L( BegDate:date, EndDate:date, Платеж, Платеж2, CodeSWIFT:string, TypeCalc:integer, FD )
  var str;
  var DemandPayment;
  /* Количество повторений */
  println(":18A:2");
  /* Тип обмена */
  println(":22X:INLX");
  /* Дата, валюта, сумма платежа */
  println(":30F:" + DateToStrYYYYMMDD(BegDate));
  println(":32M:" + ПолучитьКодФинИн(Платеж.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж.rec.OrderAmount, 2));
  DemandPayment = RsbPayment(FD.ПлатежОб.rec.PaymentID);
  /* Агент получатель */
  Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
  println(str);
  /* Тип обмена */
  println(":22X:FINX");
  /* Дата, валюта, сумма платежа */
  println(":30F:" + DateToStrYYYYMMDD(EndDate));
  println(":32M:" + ПолучитьКодФинИн(Платеж2.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж2.rec.OrderAmount, 2));
  DemandPayment = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  /* Агент получатель */
  Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
  println(str);
  /* Порядок расчета рабочих дней */
  println(":14A:" + GetField_14A(TypeCalc));
  /* Финансовый центр */
  GetField_22B(FD.Deal.rec.Contractor);
end;

private macro PrintBsMT362( PmGr, nFI:TRecHandler, Deal:TBFile, Валюта:integer, Сумма:money, Side:integer, Это_ВП_СВОП:bool )
  /* Валюта, величина условной основной суммы */
  println(":33F:"+ ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(SQL_ConvTypeSum(PmGr.BaseSum), 2));
  /* Дата начала периода */
  println(":30X:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.BegDate)));
  /* Дата окончания периода */
  println(":30Q:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.EndDate)));
  /* Новая ставка */
  var Rate:money = 0.0;
  var Point:integer = 0;
  if( not DV_NDealSideFix(Side, Deal) )
     Rate  = SQL_ConvTypeSum(PmGr.FloatRateValue);
     Point = SQL_ConvTypeInteger(PmGr.FloatRatePoint);
  else
     Rate  = SQL_ConvTypeSum(PmGr.FixRate);
     Point = nFI.rec.RatePoint;
  end;
  println(":37G:" + NumToStr(Rate, Point, true));
  /* Спред */
  println(":37R:" + NumToStr(SQL_ConvTypeSum(PmGr.Spread), 4, true));
  /* Общая величина ставки */
  println(":37M:" + NumToStr(SQL_ConvTypeSum(PmGr.Spread) + Rate, max(4, Point), true));
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.PayDate)));
  /* Валюта, сумма процентов */
  if( not Это_ВП_СВОП )
     println(":32H:"+ ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(Сумма, 2));
  end;
end;

private macro PrintClMT362_15C( PmGr, Валюта:integer, Сумма:money, CodeSWIFT:string, FD )
  var str;
  var DemandPayment;
  /* Количество повторений */
  println(":18A:1");
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.PayDate)));
  /* Валюта, сумма платежа */
  println(":32M:" + ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(Сумма, 2));
  if (FD.Поставочныйконтракт()) /*PNV 515580 в расчетных сделках нет платежей*/
      DemandPayment = RsbPayment(FD.ПлатежОб.rec.PaymentID);
  end;
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
//     println(":57A:/" + str);
     println(str);
  elif( ПолучитьКодФинИн(FD.ВалютаТребования(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD, IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), true, false), true)); /*PNV 506160*/
  else
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
//     println(":57A:/" + str);
     println(str);
  end;
end;

private macro PrintClMT362_15E( PmGr, Валюта:integer, Сумма:money, CodeSWIFT:string, FD )
  var str;
  var DemandPayment;
  /* Количество повторений */
  println(":18A:1");
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.PayDate)));
  /* Валюта, сумма платежа */
  println(":32M:" + ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(Сумма, 2));
  if (FD.ПоставочныйКонтракт())/*PNV 515580 в расчетных сделках нет платежей*/
      DemandPayment = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  end;
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
//     println(":57A:/" + str);
     println(str);
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD, IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), true, false), true));
  else
     Записать_информацию_о_получателе_MT36X (@str, DemandPayment);
//     println(":57A:/" + str);
     println(str);
  end;
end;

/*PNV 506160*/
private macro PrintClMT362( PmGr, Валюта:integer, Сумма:money, CodeSWIFT:string )
  /* Количество повторений */
  println(":18A:1");
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.PayDate)));
  /* Валюта, сумма платежа */
  println(":32M:" + ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(Сумма, 2));
  /* Агент получатель */
  println(":57A:" + CodeSWIFT);
end;
/*PNV 506160*/

macro DV_MsgSWIFT_MT360( DealID:integer ):integer

  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  if (FD.Поставочныйконтракт())/*PNV 515580 в расчетных сделках нет платежей*/
      FD.ПлатежТреб();
      FD.ПлатежОб();
  end;

   ReportFileName = GetTxtFileName(FD.DealCode() + "_MT360");
   if( Open(ReportOutFile, ReportFileName) == false )
       errcode = status(errtext);
       MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
       return 1;
   end;
   SetOutput(ReportFileName);

   message("Печать...");

   PrintCommonMT360_MT361(FD, 360);

   SetOutput(NULL, true);
   close(ReportOutFile);
   array MenuItems;
   MenuItems[0] = "Печатать сообщение";
   MenuItems[1] = "Отправить сообщение";

   var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
  
     if(exec_send)
        set_mtsend_flag(1);
        //var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";/*PNV правки от Зленко - 515833 связанная 515758*/
        var query = " begin\n ? := RSP_SECURITY.CREATEPAYMFROMSEC(?,?,?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT360");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
        cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;

  end;

  return RetVal;
end;

macro DV_MsgSWIFT_MT361( DealID:integer ):integer

  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();
  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT361");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT360_MT361(FD, 361);

  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var FD2 = DVFirstDocNDeal(DL_DVNDEAL, DealID, 2);
  var BegDate:date = date(0,0,0), EndDate:date = date(0,0,0);

  GetBegEndDatePmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, @BegDate, @EndDate);
  /* Обмены основных сумм стороной В */
  println(":15K:");
  PrintPaymMT361_15K(BegDate, EndDate, FD.ПлатежТреб, FD2.ПлатежТреб, CodeSWIFT_Our, FD.nFI_BAOther.rec.TypeCalc, FD);

  GetBegEndDatePmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, @BegDate, @EndDate);
  /* Обмены основных сумм стороной A */
  println(":15L:");
  PrintPaymMT361_15L(BegDate, EndDate, FD.ПлатежОб, FD2.ПлатежОб, CodeSWIFT_Contr, FD.nFI_BaseActiv.rec.TypeCalc, FD);

  SetOutput(NULL, true);
  close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
  
     if(exec_send)
        set_mtsend_flag(1);

        var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT361");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
        cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;

  end;

  return RetVal;
end;

macro DV_MsgSWIFT_MT362( PmGrID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport; 
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  var PmGr = TRecHandler("dvnpmgr.dbt");
  var DemandPmGr, LiabilityPmGr, Это_ВП_СВОП = false;
  array MenuItems;
  if( DL_GetRecHandler( PmGr, " SELECT * " +
                              "   FROM ddvnpmgr_dbt " +
                              "  WHERE t_ID = " + string(PmGrID)
                      ) )
     var FD = DVFirstDocNDeal(DL_DVNDEAL, PmGr.rec.DealID);
     var Number:integer = GetNumberPmGr(PmGr);
     //Это_ВП_СВОП = (FD.IsPctSWAP() and (FD.ВалютаТребования() != FD.ВалютаОбязательства()));
     Это_ВП_СВОП = true;
     /* проверка на равенство количества периодов - ограничение реализации */
/*
     if( FD.ПоставочныйКонтракт() and (GetCountPmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_DEMAND, true) != GetCountPmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, true)) )
        MsgBox("Количество периодов требований и обязательств не равны");
        return 1;
     end;
*/

     /* Найдём строки view требования и обязательства */
     DemandPmGr    = GetPmGrViewByNumber(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_DEMAND, Number, FD.Deal.rec.netting_pmgr);
     LiabilityPmGr = GetPmGrViewByNumber(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, Number, FD.Deal.rec.netting_pmgr);

     //mda 21.02.2019 c OR никогда не отработает , надо ставить AND , если не FRA //if( (DemandPmGr == NULL) or (LiabilityPmGr == NULL) )
     if( (DemandPmGr == NULL) and (LiabilityPmGr == NULL) )
        MsgBox("Не найдена строка графика");
        return 1;
     end;

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT362");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
     var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

     /* Общая информация */
     println(":15A:");
     /* Референс отправителя */
     println(":20:" + DateToStrDDMMYY(FD.ДатаСделки()) + "-" + FD.DealCode() + "-" + string(Number));
     /* Связанный референс */
     var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
     if( RelatedReference != "" )
        println(":21:" + RelatedReference);
     end;
     /* Тип операции */
     println(":22A:NEWT");
     /* Общий референс */
     println(":22C:" + GetField_22C(CodeSWIFT_Our, CodeSWIFT_Contr, FD.ДатаИсполнения()));
     /* Определение свопа */
     println(":23A:" + GetField_23A(FD.Deal.rec.Type) + "/" + IIF(FD.Deal.rec.netting_pmgr == "X", "NET", "GROSS"));
//     println(":23A:" + GetField_23A(FD.Deal.rec.Type, FD.Deal.rec.netting_pmgr));
     /* Номер контракта */
     println(":21N:" + FD.DealCode() + "-IRS");
     /* Дата вступления в силу */
     println(":30V:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
     /* Дата закрытия */
     println(":30P:" + DateToStrYYYYMMDD(FD.ДатаИсполнения()));
     /* Сторона А */
     println(":82A:" + CodeSWIFT_Our);
     /* Сторона В */
     println(":87A:" + CodeSWIFT_Contr);

     if( DemandPmGr )
        /* Процентная ставка/основная сумма, выплачиваемая контрагентом */
        println(":15B:");
        PrintBsMT362(DemandPmGr, FD.nFI_BAOther, FD.Deal, FD.ВалютаТребования(), SQL_ConvTypeSum(DemandPmGr.Demand), ALG_DV_PMGR_SIDE_DEMAND, Это_ВП_СВОП);

        /* Чистая (неттинг) сумма, выплачиваемая контрагентом */
        var PaySum:money = $0;

        if( Это_ВП_СВОП )
           PaySum = SQL_ConvTypeSum(DemandPmGr.Demand);
        else
           PaySum = SQL_ConvTypeSum(LiabilityPmGr.Demand) - SQL_ConvTypeSum(DemandPmGr.Liability);
        end;

        if( PaySum > 0 )
           println(":15C:");
           PrintClMT362_15C(DemandPmGr, FD.ВалютаТребования(), PaySum, CodeSWIFT_Our, FD);
        end;
     end;
 
     if( LiabilityPmGr )
        /* Процентная ставка/основная сумма, выплачиваемая Банком (нами) контрагенту */
        println(":15D:");
        PrintBsMT362(LiabilityPmGr, FD.nFI_BaseActiv, FD.Deal, FD.ВалютаОбязательства(), SQL_ConvTypeSum(LiabilityPmGr.Liability), ALG_DV_PMGR_SIDE_LIABILITY, Это_ВП_СВОП);

        /* Чистая (неттинг) сумма, выплачиваемая контрагенту */
        if( Это_ВП_СВОП )
           PaySum = SQL_ConvTypeSum(LiabilityPmGr.Liability);
        else
           PaySum = SQL_ConvTypeSum(LiabilityPmGr.Demand) - SQL_ConvTypeSum(DemandPmGr.Liability);
           if( PaySum < 0 )
               PaySum = abs(PaySum);
           else
               PaySum = 0;
           end;
        end;

        if( PaySum > 0 )
           println(":15E:");
           PrintClMT362_15E(LiabilityPmGr, FD.ВалютаОбязательства(), PaySum, CodeSWIFT_Contr, FD);
        end;
     end;

     SetOutput(NULL, true);
     close(ReportOutFile);

     MenuItems[0] = "Печатать сообщение";
     MenuItems[1] = "Отправить сообщение";
     var MenuResult = Menu(MenuItems, "Выбрать действие");

     if( MenuResult == 0 )
        ViewFile(ReportOutFile);
     elif( MenuResult == 1 )
        var Text;
        var Msg = "";
        Open(ReportInFile, ReportFileName);

        while(next(ReportInFile))
           Msg = Msg + ReportInFile.str+"\n";
        end;
        Msg = Trim(Msg);/*PNV i-support 506640*/

        getTransportFromDeal(FD.Deal.rec.Id,@transport);
        close(ReportInFile);
        var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT362");
        cmd.AddParam("p_DraftID", RSDBP_IN, PmGr.rec.DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_BIC", RSDBP_IN, CodeSWIFT_Contr);
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
        cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     end;

  else
     MsgBox("Не найдена строка графика с ID=" + string(PmGrID));
     RetVal = 1;
  end;

  return RetVal;
end;

private macro PrintCommonMT305( FD, Kind:integer/*305*/ )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var Comment_ = ""; /*PNV 505931*/
  var Платеж_премия:RsbPayment;
  var PaymentID = 0;
  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, PRi/*6 - премия*/, 0, FD.deal.rec.bonusdate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж_премия = RsbPayment(PaymentID);
  end;
  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  //mda 21.02.19 Транслит , по просьбе банка
  var deal_tr;
  StrChangeRusXSet( StrSubst(FD.DealCode(),":",""),deal_tr );
  println(":20:" + DateToStrDDMMYYYY(FD.ДатаСделки()) + deal_tr);
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  else
     println(":21:NEW");
  end;
  /* Код/Общий референс */
  //mda 20.02.19 для опциона не FD.nfi_baseactiv.rec.course ,а FD.nfi_baseactiv.rec.price
  println(":22:NEW/" + MakeCommonRef(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi_baseactiv.rec.price, 2)));
//  println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi_baseactiv.rec.price, 2)));
  /* Дополнительное определение */
  println(":23:" + GetField_23(FD.Deal.rec.Type, FD.Deal.rec.OptionType, FD.Deal.rec.OptionStyle, ПолучитьКодФинИн(FD.nfi_baseactiv.rec.fiid, null, FICK_ISOSTRING)));
  /* Характер операции */
  println(":94A:BILA");
  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  /* Фонд или клиент-бенефициар */
//  println(":83A:");
  /* Дата заключения/изменения контракта */
  println(":30:" + DateToStrYYMMDD(FD.ДатаСделки()));
  /* Начальная дата исполнения */
  if( FD.Deal.rec.OptionStyle == 1)
     println(":31C:" + DateToStrYYMMDD(FD.ДатаНачала()));
  end;
  /* Детали истечения срока */
  println(":31G:" + DateToStrYYMMDD(FD.ДатаИстеченияСрокаДействия()) + "/" + trim(Substr(StrSubst(String(FD.nfi_baseactiv.rec.exectime), ":", ""), 1, 4)) + "/" + IIF( FD.nfi_baseactiv.rec.EXECPLACE != "", FD.nfi_baseactiv.rec.EXECPLACE, "EMTA")) ;/*PNV 499091*/ /*PNV 505931*//*PNV 532804*/
  /* Дата окончательного расчета */
  if (FD.ПоставочныйКонтракт())
    println(":31E:" + DateToStrYYMMDD(FD.ДатаПоставки()));
  else
    println(":31E:" + DateToStrYYMMDD(FD.ДатаИсполнения()));
  end;
  /* Тип расчетов  */
  if( FD.nfi_baseactiv.rec.exectype == DVSETTLEMET_STATE )
    println(":26F:PRINCIPAL");
  else
    println(":26F:NETCASH");
  end;
  /* Индикатор отсутствия поставок */
//  println(":17F:");
  /* Источник значения курса для расчетов */
//  println(":14S:");
  /* Валюта расчета */
  if( FD.nfi_baseactiv.rec.exectype != DVSETTLEMET_STATE )
//     println(":32E:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING));
  end;
  /* Расчетный агент */
  var sGenType = GetGenAgrType(FD.GenAgr().rec.type_gs);
  if( ((sGenType == "ISDA") or (sGenType == "ISDACN") or (sGenType == "ISDACN")) and (FD.GenAgr().rec.SenderSideFR != SENDERFRVL_NO_SELECTED_SIDE) ) 
     println(":26K:ISDA");
  end;
  /* Базисная валюта и сумма */
  println(":32B:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.fiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.amount, 2));
  /* Цена исполнения */
  //println(":36:" + NumToStr(FD.nfi_baseactiv.rec.price, 2));
  println(":36:" + NumToStr(FD.nfi_baseactiv.rec.price, FD.nfi_baseactiv.rec.point));/*PNV i-support 497371*/
  /* Валюта и сумма оплаты */
  println(":33B:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.cost, 2));
  /* Цена опциона (премия) */
  println(":37K:" + ПолучитьКодФинИн(FD.Deal.rec.bonusfiid, null, FICK_ISOSTRING) + NumToStr(FD.Deal.rec.bonus, 2));
  /* Оплата премии */
  var TypeDeal;
  if( FD.Deal.rec.type == ALG_DV_BUY )
     TypeDeal = "P";
  elif( FD.Deal.rec.type == ALG_DV_SALE )
     TypeDeal = "R";
  end;
  //println(":34" + TypeDeal +":" + DateToStrYYMMDD(FD.ДатаНачала()) + ПолучитьКодФинИн(FD.Deal.rec.bonusfiid, null, FICK_ISOSTRING) + NumToStr(FD.Deal.rec.bonus, 2));
  println(":34" + TypeDeal +":" + DateToStrYYMMDD(FD.Deal.rec.bonusdate) + ПолучитьКодФинИн(FD.Deal.rec.bonusfiid, null, FICK_ISOSTRING) + NumToStr(FD.Deal.rec.bonus, 2));
  /* Корреспондент Отправителя*/
//  println(":53a:");
  /* Посредник */
//  println(":56a:");
  /* Банк бенефициара */
  if ((FD.Deal.rec.bonusfiid != 0) and (Платеж_премия.paymentid > 0))
    println(":57A:" + ПолучитьКодСубъекта(Платеж_премия.payerbankid, PTCK_SWIFT)); /*PNV 532804*/
  end;
  /*Год версии определений*/
    /*println(":14C:" + GetField_14C(FD.Deal.rec.genagrid));*/
  /*Если рубли то такое поле*/
  if (FD.Deal.rec.bonusfiid == 0)
    println(":57D:" + GetField_57D_305(FD));
  end;
  /* Условия контракта */
  println(":77H:" + GetField_77H(FD.Deal.rec.genagrid));
  /* Информация Отправителя Получателю */
  if( FD.Deal.rec.Comment)     
     StrChangeRusXSet( FD.Deal.rec.Comment, Comment_ ); /*PNV 505931*/
     println(":72:" + Trim(substr(Comment_, 1, 35))); /*PNV 505931*/
  end;
  if( substr(FD.Deal.rec.Comment, 36, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 36, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 71, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 71, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 116, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 116, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 151, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 151, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 176, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 176, 35));
  end;

/*
  if( (FD.v_pm_BA) or (FD.v_pm_CA) )
    /* Отчетная информация */
    println(":15B:");
//    PrintBsMT305(DemandPmGr, FD.nFI_BAOther, FD.Deal, FD.ВалютаТребования(), SQL_ConvTypeSum(DemandPmGr.Demand), ALG_DV_PMGR_SIDE_DEMAND, Это_ВП_СВОП);
  end;
*/

end;

macro DV_MsgSWIFT_MT305( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT305");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT305(FD, 305);

     SetOutput(NULL, true);
     close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
    
     if(exec_send)
       set_mtsend_flag(1);

       var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
       var cmd = RSDCommand(query);
       cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
       cmd.AddParam("p_KindMes", RSDBP_IN, "MT305");
       cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
       cmd.AddParam("p_Msg", RSDBP_IN, Msg);
       cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
       cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
       cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
       cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
       cmd.Execute();
       var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
       Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
       MsgBox(Text);

     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;

  end;

  return RetVal;

  OnError
      MsgBox("Не удалось отправить сообщение в Payments");
      return -1;      
end;

private macro GetQueryPayment():string
  //var query = "SELECT p.t_payer, p.t_receiver,p.t_payeraccount,p.t_receiveraccount "+  //SVE
  var query = "SELECT p.t_payerbankid, p.t_receiverbankid,p.t_payeraccount,p.t_receiveraccount "+   
              "  FROM dpmpaym_dbt p           "+
              " WHERE p.t_documentid = ?      "+
              "   AND p.t_dockind = ?         "+
              "   AND p.t_purpose = ?";
  return query;
end;

private macro GetField_87A15( ID, DOCKIND, BS ):string
  var str;
  var sql = DL_RSDCommand(GetQueryPayment());
  sql.addParam( ID );
  sql.addParam( DOCKIND );
  sql.addParam( BS );
  var Pay = sql.execute();
  if( Pay.MoveNext() )
     if( BS == 1 )
        //str = ПолучитьКодСубъекта(Pay.t_payer, PTCK_SWIFT); //SVE
        str = ПолучитьКодСубъекта(Pay.t_payerbankid, PTCK_SWIFT);
     else
        //str = ПолучитьКодСубъекта(Pay.t_receiver, PTCK_SWIFT);  //SVE
        str = ПолучитьКодСубъекта(Pay.t_receiverbankid, PTCK_SWIFT);
     end;
  end;
  return str;
end;

private macro GetQueryFIID():string
  var query = "SELECT p.t_definition  "+
              "  FROM dfininstr_dbt p "+
              " WHERE p.t_fiid = ?";
  return query;
end;

private macro GetFiidDefinition( ID ):string
  var str;
  var sql = DL_RSDCommand(GetQueryFIID());
  sql.addParam( ID );
  var FIID = sql.execute();
  if( FIID.MoveNext() )
     str = FIID.t_definition;
  end;
  return str;
end;

private macro GetField_57A( ID, BS ):string
  var str;
  var sql = DL_RSDCommand(GetQueryPayment());
  sql.addParam( ID );
  sql.addParam( BS );
  var Pay = sql.execute();
  if( Pay.MoveNext() )
     if( BS == 2 )
        str = ПолучитьКодСубъекта(Pay.t_receiver, PTCK_SWIFT);
     else
        str = ПолучитьКодСубъекта(Pay.t_payer, PTCK_SWIFT);
     end;
  end;
  return str;
end;

PRIVATE MACRO GetLoco(comment)
  var i = 0;
  var loco = "";
    for (i, 0, StrLen(comment), i+1)
      if ( (SubStr(comment, i, 1) != ".") and (SubStr(comment, i, 1) != " ") )
        loco = loco + SubStr(comment, i, 1);
      else
        break;
      end;
    end;
  return loco;  
END;

private macro GetField_26C( FD, NoteKind ):string
  var doc;
  var str = "";
  var loco_v1 = index(FD.deal.rec.comment, "Loco");
  var loco_v2 = index(FD.deal.rec.comment, "loco");  //SVE город в комментарии укзывается так: ...Loco/loco 
  var loco_v3 = index(FD.deal.rec.comment, "локо");  
  var loco_v4 = index(FD.deal.rec.comment, "Локо");  
  //SVE
  if  (loco_v1 != 0)
      str = GetLoco( Substr(FD.deal.rec.comment, loco_v1+ 5));
  elif (loco_v2 != 0)
      str = GetLoco( Substr(FD.deal.rec.comment, loco_v2+ 5));
  elif (loco_v3 != 0)
      str = GetLoco( Substr(FD.deal.rec.comment, loco_v3+ 5));
  elif (loco_v4 != 0) 
     str = GetLoco( Substr(FD.deal.rec.comment, loco_v4+ 5));
  end;
  //Костыль чтобы по уже заведенным сделкам где город сокращен ставился верный город
  if ( (str == "Ldn") or (str == "ldn") or (str == "London") or (str == "london") or (str == "лондон")  or (str == "Лондон"))
    str = "LONDON";
  elif ( (str == "Moscow") or (str == "moscow") or (str == "Msk") or (str == "msk") or (str == "Mokcow") or (str == "mokcow"))
    str = "MOSCOW";
  elif ( (str == "Zrch") or (str == "zrch") or (str == "Zurich") or (str == "zurich") )
    str = "ZURICH";
  end;
  
  if ( (index(FD.deal.rec.comment, "bars") != 0) or (index(FD.deal.rec.comment, "gram") != 0) )
     str = str + "/ALLOC";
  else
     str = str + "/UNALL";
  end;
	
  return str;
end;

private macro GetISONumber(fiid)  //SVE
  var sql = DL_RSDCommand("select t_ccy from dfininstr_dbt where t_fiid = ?");
  sql.addParam( fiid );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.ccy;
  end;
  return -1;
end;

private macro GetSWIFTCode(partyid) //SVE
  var sql = DL_RSDCommand("select t_code from dobjcode_dbt where t_codekind = 6 and t_objectid = ?");
  sql.addParam( partyid );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.code;
  end;
  return -1; 
end;
private macro GetCorrAcc(PaymentID, FIID, IsBuy)
  var query;
  if (IsBuy)
    query = "select t_coraccount from DCORSCHEM_DBT where  t_fiid = ? and  t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 0)";
  else
    query = "select t_account from DCORSCHEM_DBT where t_fiid = ? and  t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 1)";
  end;
  var sql = DL_RSDCommand(query);
  sql.addParam( FIID );
  sql.addParam( PaymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    if (IsBuy)
       return "\n" + Data.coraccount;
    else
       return "\n" + Data.account;
    end;
  end;
  return "";
end;

/*PNV 506160*/
private macro GetCorrAcc_(PaymentID, IsBuy)
  var query;
  if (IsBuy)
    query = "select t_corracc from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 0";
  else
    query = "select t_corracc from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 1";
  end;
  var sql = DL_RSDCommand(query);
  sql.addParam( PaymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    if (IsBuy)
       return "\n" + Data.corracc;
    else
       return "\n" + Data.corracc;
    end;
  end;
  return "";
end;

private macro GetCorrAcc_2(PaymentID, IsBuy)
  var query;
  if (IsBuy)
    query = "select t_coraccount from DCORSCHEM_DBT where t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 0)";
  else
    query = "select t_account from DCORSCHEM_DBT where t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 1)";
  end;
  var sql = DL_RSDCommand(query);
  sql.addParam( PaymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    if (IsBuy)
       return Data.coraccount;
    else
       return Data.account;
    end;
  end;
  return "";
end;
/*PNV 506160*/

/*PNV 539350*/
private macro GetCorrAcc_604(PaymentID, IsBuy)
  var query;
  if (IsBuy)
    query = "select t_coraccount from DCORSCHEM_DBT where t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 0)";
  else
    query = "select t_coraccount from DCORSCHEM_DBT where t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 1)";
  end;
  var sql = DL_RSDCommand(query);
  sql.addParam( PaymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    if (IsBuy)
       return Data.coraccount;
    else
       return Data.coraccount;
    end;
  end;
  return "";
end;
/*PNV 539350*/

private macro GetINCorrSWIFTCode(PaymentID, FIID , FD) //SVE получить id субъекта по входящему платежу
  var query;
  query = "select t_corrid from DCORSCHEM_DBT where t_fiid = ? and t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ?  and t_debetcredit = 0)";
  var sql = DL_RSDCommand(query);
  sql.addParam( FIID );
  sql.addParam( PaymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.corrid;
  end;
  return -1;
end;

private macro GetOUTCorrSWIFTCode(PaymentID, FIID , FD) //SVE получить id субъекта по исходящему платежу
  var query;
  query = "select t_corrid from DCORSCHEM_DBT where t_fiid = ? and t_number in (select t_corschem from dpmprop_dbt where t_paymentid = ? and t_debetcredit = 1)";
  var sql = DL_RSDCommand(query);
  sql.addParam( FIID );
  sql.addParam( PaymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.corrid;
  end;
  return -1;
end;


private macro GetPoint(paymentID)
  var query;

  query = "select t_point from dpmpaym_dbt where t_paymentid = ?";
  var sql = DL_RSDCommand(query);
  sql.addParam( paymentID );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.point;
  end;
  return -1;
end;

private macro del0(s)
var i = 0, len = 0;
var s1 = "";
  for (i, 0, StrLen(s), i+1)
    len = StrLen(s) - i;
    if (SubStr(s, len, 1) == "0")
      s1 = SubStr(s, 1, StrLen(s)-i-1);
    else
      s1 = SubStr(s, 1, StrLen(s)-i);
      break;
    end;
  end;
  return StrSubst(s1 , ".", ",");
end;

private macro GetPrim_toz(FD, dockind, dealpart, get_)
  var toz_amount, toz_price;
  if (dockind == 199)
    if (dealpart == 1)
      toz_amount = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.deal, OBJTYPE_OUTOPER_DV), 101);
      toz_price =  readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.deal, OBJTYPE_OUTOPER_DV), 102);
    else
      toz_amount = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.deal, OBJTYPE_OUTOPER_DV), 105);
      toz_price =  readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.deal, OBJTYPE_OUTOPER_DV), 106);
    end;
  else
    if (dealpart == 1)
      toz_amount = readNoteForObject(OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 101);
      toz_price = readNoteForObject(OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 102);
    else
      toz_amount = readNoteForObject(OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 105);
      toz_price = readNoteForObject(OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 106);
    end;
  end;
  if ( (get_ == "amount") and (toz_amount != 0) )
    return toz_amount;
  elif ( (get_ == "price") and (toz_price != 0) )
    return toz_price;
  else
    return "";
  end;
end;

private macro GetPrim_191(FD)
  var prim_191;
  prim_191 = GetPrim_toz(FD, FD.deal.rec.dockind, FD.dealpart, "price");
  prim_191 = del0(string(prim_191));
    
  return prim_191;
end;

PRIVATE MACRO Get57(FD)
  var field57D = "";
  var field57A = "";
  var receiver = FD.v_pm_CA.rec.receiver;
  var receiver_account = FD.v_pm_CA.rec.receiveraccount;
  var corr_receiver_account = /*FD.v_pm_CA.rec.futurereceiveraccount*/GetCorrAcc_(FD.v_pm_CA.rec.paymentID, FD.IsSale()); /*PNV 506160*/
  /*PNV 506160*/
  if (corr_receiver_account == "") 
      corr_receiver_account = FD.v_pm_CA.rec.futurereceiveraccount;
  end;
  /*PNV 506160*/

  var contractiv = FD.v_pm_CA.rec.fiid;
 /*PNV 535978*/
  if (FD.ВидБазовогоАктива() == FIKIND_METAL) 
    field57A = ":57A:";
    if (receiver_account != "")
        field57A = field57A + "/" + receiver_account + "\n";
    end;
    if ( FD.IsBuy() )   // Если продажа -> входящий платеж и SWIFT-code нужно брать из корр. схемы, иначе из СПИ
	field57A = field57A + ПолучитьКодСубъекта(FD.v_pm_CA.rec.receiverbankid, PTCK_SWIFT);
    else
        field57A = field57A + ПолучитьКодСубъекта(GetINCorrSWIFTCode(FD.v_pm_CA.rec.paymentID, FD.v_pm_CA.rec.fiid, FD), PTCK_SWIFT);     
    end;
/*PNV 535978*/
  elif (contractiv != 0)  //Для валютных платежей всегда будет поле 57А
    field57A = ":57A:";
    if (receiver_account != "")
        field57A = field57A + "/" + receiver_account + "\n";
    end;
    if ( FD.IsBuy() )   // Если продажа -> входящий платеж и SWIFT-code нужно брать из корр. схемы, иначе из СПИ
	field57A = field57A + ПолучитьКодСубъекта(FD.v_pm_CA.rec.receiverbankid, PTCK_SWIFT);
    else
        field57A = field57A + ПолучитьКодСубъекта(GetINCorrSWIFTCode(FD.v_pm_CA.rec.paymentID, FD.v_pm_CA.rec.fiid, FD), PTCK_SWIFT);     
    end;
  else   // Рублевый платеж - поле 57D
    if ( GetIsNotResident(receiver) == "")   // Для резидентов структура: /счет или "ACC YOUR...", BIC, CA, INN
	    field57D = ":57D:";
        if (receiver_account != "")
            field57D = field57D + "/" + receiver_account;
        else
            field57D = field57D + "ACC YOUR INSTRUCTION";
        end;
        if (ПолучитьКодСубъекта(receiver, PTCK_BIC) != "")
            field57D = field57D + "\nBIC " + ПолучитьКодСубъекта(receiver, PTCK_BIC);
        end;
        if (corr_receiver_account != "")
            field57D = field57D + "\nK/S " + strsubst(corr_receiver_account, "\n", "");
        end;
	    if (ПолучитьКодСубъекта(receiver, PTCK_INN) != "")
            field57D = field57D + "\nINN " + ПолучитьКодСубъекта(receiver, PTCK_INN);
        end;
    else    //Для нерезидентов поле 57А и соответствующая структура поля
	    field57A = ":57A:";
	    if (receiver_account != "")
            field57A = field57A + "/" + receiver_account + "\n";
        end;
        if ( FD.IsBuy() )
	    field57A = field57A + ПолучитьКодСубъекта(FD.v_pm_CA.rec.receiverbankid, PTCK_SWIFT);
        else
            field57A = field57A + ПолучитьКодСубъекта(GetINCorrSWIFTCode(FD.v_pm_CA.rec.paymentID, FD.v_pm_CA.rec.fiid, FD), PTCK_SWIFT);     
        end;
    end;		
  end;
  
  if (field57A != "")
    return field57A;
  else
    return field57D;
  end;
END;

macro GetGenCode(genagrid)
  var Code = ""; /*PNV 506930*/

  var query = DL_RSDCommand("select t_code, T_DATE_GENAGR from ddl_genagr_dbt where t_genagrid = ?");
  query.AddParam(genagrid);
  var data = query.Execute();
  if ( data.MoveNext() )
     StrChangeRusXSet( data.code, Code ); /*PNV 506930*/
     return Code + " DD " + Date(data.DATE_GENAGR); //код Ген. Соглашения
  end;
  return "";
end;


private macro PrintCommonMT600( FD, Kind:integer/*600*/, Y )

  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var ssu;
  var contractiv = FD.v_pm_CA.rec.fiid;
  var baseactiv = FD.v_pm_BA.rec.basefiid;
  var Point = GetPoint(FD.v_pm_BA.rec.paymentid);
  var gr_amount, gr_price;
  var field_77h;
  if (GetIsNotResident(FD.deal.rec.contractor) != true)
     if (FD.deal.rec.kind == 199)
        gr_amount = FD.nfi_baseactiv.rec.amount;
        gr_price = FD.nfi_baseactiv.rec.price;
     else
        gr_amount = FD.nfi.rec.amount;
        gr_price = FD.nfi.rec.price;
     end;
  end;
  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  println(":20:" + /*DateToStrDDMMYY(FD.ДатаСделки()) +*/ GetCode_103(FD.Deal.rec.Contractor) + Y + substr(FD.DealCode(), strlen(FD.DealCode()) - 4));
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  else
     println(":21:NEW");
  end;

  /* Код/Общий референс */
  //println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi_baseactiv.rec.price, 2)));  //SVE
//  println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, GetPrim_191(FD) ));
    /*CHVA*/
    if ( StrUpr(genclassname(FD))== StrUpr("DVFIRSTDOCNDEAL")) /*CHVA*/
    println(":22:NEW/" + MakeCommonRef(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr( FD.nfi_baseactiv.rec.price, 2)));
    else
    println(":22:NEW/" + MakeCommonRef(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr( FD.nfi.rec.price, FD.nfi.rec.point /*2*/)));
    end;
   /*CHVA*/
  /* Характер операции */
//  println(":94A:BILA");

  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);

  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);

  /* Дата заключения/изменения контракта */
  println(":30:" + DateToStrYYMMDD(FD.ДатаСделки()));

  /* Идентификация металла  */
  println(":26C:/" + GetField_26C(FD, 191) + GetFiidDefinition(baseactiv));

  /* Цена за единицу */
  /*SVE для СВОПов значение OBJTYPE_FXOPER_DV(148) не подходит необходимо OBJTYPE_OUTOPER_DV(145)*/
  if (GetIsNotResident(FD.Deal.rec.Contractor) == true)
     println(":33G:" + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + GetPrim_191(FD) );  
  else
     println(":33G:" +  ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) +  del0(ЧислоСЗаданнойТочностью(gr_price, ЧислоЗнаковПослеЗапятой(gr_price))) );  //по рублевым платежам почему то не разносится поле в альянсе как надо
  end;

  //println(":33G:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.price, 2));
  /* Условия контракта */
  field_77h = GetField_77H(FD.Deal.rec.genagrid);
  println(":77H:" + field_77h);
  if (field_77h == "OTHER")
     println(":77D:" + GetGenCode(FD.Deal.rec.genagrid));
  end;

  /* Информация Отправителя Получателю */ //SVE сейчас город берется из примечания на сделке, так как объект account не используется нигде в данном макросе, нужно обсудить с банком
  println(":72:/ELEC/");
  if ( (FD.IsBuy() != true) and (contractiv != 0) )
    println("//PAYMENT IN " + GetISONumber(baseactiv) + " FROM " + ПолучитьКодСубъекта(GetINCorrSWIFTCode(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, FD), PTCK_SWIFT));  
  elif ( (FD.IsBuy() == true) and (contractiv != 0) )
    println("//PAYMENT IN " + GetISONumber(baseactiv) + " TO " + ПолучитьКодСубъекта(GetOUTCorrSWIFTCode(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, FD), PTCK_SWIFT));
  elif ( (FD.IsBuy() != true) and (contractiv == 0) )
    println("//PAYMENT IN " + GetISONumber(baseactiv) + " FROM");
  elif ( (FD.IsBuy() == true) and (contractiv == 0) )
    println("//PAYMENT IN " + GetISONumber(baseactiv) + " TO");
  end;

  if (FD.dealpart == 1)
    println("//DD "+ DateToStrYYMMDD(FD.v_rm_CA.rec.date) + IIF(FD.Deal.rec.netting == true, " NETTING", "") /*+ IIF(GetIsNotResident(FD.Deal.rec.Contractor) != true, " TOZ " + GetPrim_toz(FD, FD.deal.rec.dockind, FD.dealpart, "amount"), "")*/); 
  else
    println("//DD "+ DateToStrYYMMDD(FD.v_rm_CA.rec.date) + IIF(FD.Deal.rec.netting2 == true, " NETTING", "") /*+ IIF(GetIsNotResident(FD.Deal.rec.Contractor) != true, " TOZ " + GetPrim_toz(FD, FD.deal.rec.dockind, FD.dealpart, "amount"), "")*/); 
  end;
  if( (FD.IsBuy() == true) and (FD.v_pm_BA.rec.PAYER == GetINCorrSWIFTCode(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, FD)))
	println("//ACC " + strsubst(GetCorrAcc(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, true), "\n", ""));
  elif ( (FD.IsBuy() == true) and (contractiv == 0) )
    println("//ACC " + strsubst( FD.v_pm_BA.rec.receiveraccount, "\n", ""));
  elif ( (FD.IsBuy() != true) and (contractiv == 0) )
    println("//ACC " + strsubst(GetCorrAcc(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, false), "\n", ""));
  end;
  if( (FD.Deal.rec.type == 1) or (FD.Deal.rec.type == 5) )

    /* Купленный металл */
    if (FD.dealpart == 1)
      println(":15B:");
    else
      println(":15C:");
    end;
  elif( (FD.Deal.rec.type == 2) or (FD.Deal.rec.type == 6) )

    /* Проданный металл */
    if (FD.dealpart == 1)
      println(":15C:");
    else
      println(":15B:");
    end;
  end;
  
  /* Количество металла */
  if (GetIsNotResident(FD.Deal.rec.Contractor) == true)
     ssu = GetPrim_toz(FD, FD.deal.rec.dockind, FD.dealpart, "amount");
  else
     ssu = gr_amount;
  end;

  if (GetIsNotResident(FD.deal.rec.contractor) != true)
    println(":32F:GRM" + NumToStr(ssu, 3));
  elif( GetFiidDefinition(baseactiv) == "GOLD" )
    println(":32F:FOZ" + NumToStr(ssu, 3));  //SVE
  else
    println(":32F:GOZ" + NumToStr(ssu, 3));  //SVE
  end;

  /* Получатель/поставщик металла */
//SVE 27/03/19 Если это покупка, то нужно смотреть SWIFT-code из корр схемы, так как входящая корр схема для получателя в БАЗОВОМ активе, иначе смотрим в платеже
  if ( FD.IsBuy() )
	if(FD.v_pm_BA.rec.PAYER == GetINCorrSWIFTCode(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, FD))
		println(":87A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT)); 
	else
    println(":87A:/" + FD.v_pm_BA.rec.receiveraccount + "\n" + ПолучитьКодСубъекта(FD.v_pm_CA.rec.payerbankid, PTCK_SWIFT));    
	end;
    //println(":87A:" + ПолучитьКодСубъекта(GetINCorrSWIFTCode(FD.v_pm_BA.rec.paymentID, FD.v_pm_BA.rec.fiid, FD), PTCK_SWIFT));   
  else
    println(":87A:" + ПолучитьКодСубъекта(FD.v_pm_CA.rec.payerbankid, PTCK_SWIFT));    
  end;
  /* Выполнение */
  if( (FD.Deal.rec.type == 1) or ((FD.Deal.rec.type == 5) and (FD.Dealpart == 1)) or  ((FD.Deal.rec.type == 6) and (FD.Dealpart == 2)) )  //SVE
    println(":34P:" + DateToStrYYMMDD(FD.v_rm_CA.rec.date) + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(FD.v_pm_CA.rec.amount, 2));
  elif( (FD.Deal.rec.type == 2) or ((FD.Deal.rec.type == 6) and (FD.Dealpart == 1)) or ((FD.Deal.rec.type == 5) and (FD.Dealpart == 2)) )  //SVE
    println(":34R:" + DateToStrYYMMDD(FD.v_rm_CA.rec.date) + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(FD.v_pm_CA.rec.amount, 2));
  end;

  /* Счет в банке */
//SVE 27/03/19 Если это продажа, то нужно смотреть SWIFT-code из корр схемы, так как входящая корр схема для получателя в КОНТРАКТИВЕ, иначе смотрим в платеже
  //SVE составление структуры поля полностью перенес в функцию выше
  println( Get57(FD) );
  return true;
end;

/* Определение Генерального соглашения */
private macro ОпределитьГС( PartyID, GenAgrID, GenCode:@String, GenDate:@String):Bool
  var que = "select count(*) from DDL_GENAGR_DBT where t_partyid = " + PartyID + " and t_genagrid = " + GenAgrID;
  var rs01 = LnGetRecordSet(que);
  if(rs01 != null)
    if (rs01.moveNext)
      if (int(rs01.value(0)) > 0 )
        que = "select t_code,to_char(t_date_genagr,'dd.mm.yyyy'),to_char(t_date_genagr,'yyyy') from DDL_GENAGR_DBT where t_partyid = " + PartyID + " and t_genagrid = " + genagrid;
        var rs02 = LnGetRecordSet(que);
        if(rs02 != null)
          if (rs02.moveNext)
            StrChangeRusXSet(rs02.value(0), GenCode); /* ВР. Транслитерация номера ГС */
            StrChangeRusXSet(rs02.value(1), GenDate); /* ВР. Транслитерация даты ГС */
            return True;
          end;
        end;
      end;
    end;
  end;
  return False;

end;

private macro PrintCommonMT604( FD, Kind:integer/*604*/, Y )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var CodeSWIFT_Receiver:string = IIF(ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT) == "", CodeSWIFT_Our, ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT));
  var ssu, amount;
  var contractiv = FD.v_pm_CA.rec.fiid;
  var baseactiv = FD.v_pm_BA.rec.basefiid;
  var GenCode:String, GenDate:String;

  /* Идентификация металла и металлический счет */
  println(":26C:/" + GetField_26C(FD, 191) + GetFiidDefinition(baseactiv));
  if (strlen(GetCorrAcc_604(FD.v_pm_BA.rec.PaymentID, FD.Isbuy())) > 1)
      println(":25:" + GetCorrAcc_604(FD.v_pm_BA.rec.PaymentID, FD.Isbuy()));
   end;

  /*  Идентификация счета */
  /* Дата валютирования */
  println(":30:" + DateToStrYYMMDD(FD.ДатаИсполнения()));

  if(ОпределитьГС(FD.deal.rec.Contractor, FD.deal.rec.genagrid,@GenCode,@GenDate) )
       println(":72:/ELEC/" + GenCode + " DD " + GenDate);
  end;

/*Повторяющаяся последовательность должна появляться хотя бы один раз, но не более десяти раз*/
  /* Референс операции */
  println(":20:" + GetCode_103(FD.Deal.rec.Contractor) + Y + substr(FD.DealCode(), strlen(FD.DealCode()) - 4));
  /* Связанный референс */
/*Если связанным сообщением является Подтверждение сделки с металлом MT 600, это поле должно содержать общую ссылку этого МТ 600*/


  println(":21:NONREF");


  /* Дополнительное определение */
  println(":23:TRANSFER");

  /* Номер сертификата и / или номера слитка */
  /* Количество металла */
  ssu = readNoteForObject( IIF( ((FD.Deal.rec.type != 5) AND (FD.Deal.rec.type != 6)), OBJTYPE_FXOPER_DV, OBJTYPE_OUTOPER_DV ),
                           UniID( FD.deal, IIF( ((FD.Deal.rec.type != 5) AND (FD.Deal.rec.type != 6)), OBJTYPE_FXOPER_DV, OBJTYPE_OUTOPER_DV )),
                           IIF( Y == 2, 105, 101));
  if( Y == 0 )
     amount = FD.nfi.rec.Amount;
  else
     amount = FD.nfi_baseactiv.rec.Amount;
  end;
 
  /*PNV 506930*/
  if (GetIsNotResident(FD.deal.rec.contractor) != true)
    println(":32F:GRM" + NumToStr(amount, 3));
 /*PNV 506930*/
  elif( GetFiidDefinition(baseactiv) == "GOLD" )
     println(":32F:FOZ" + IIF(GetIsNotResident(FD.Deal.rec.Contractor) == true, NumToStr(ABS(ssu), 3), amount));
  else
     println(":32F:GOZ" + IIF(GetIsNotResident(FD.Deal.rec.Contractor) == true, NumToStr(ABS(ssu), 3), amount));
  end;

  /* Инструктирующая сторона */
/*В этом поле указывается инициатор транзакции, если он отличается от Отправителя.*/
  if( FD.v_pm_BA.rec.payer != {OurBank} )
    println(":82A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.payer, PTCK_SWIFT));
  end;
  /* Получатель металла */
  FindSETTACC_PMAUTO (FD.v_pm_BA.rec.receiver, 6 /*FiKind*/, baseactiv, 15 /*ServiceKind*/, 0 /*KindOper*/, 0 /*Purpose*/, FD.v_pm_BA.rec.receiver /*BankID*/, Settacc);

  if(Settacc.rec.settAccId == 0)
    FindSETTACC_PMAUTO (FD.v_pm_BA.rec.receiver, 6 /*FiKind*/, baseactiv, 15 /*ServiceKind*/, 0 /*KindOper*/, 0 /*Purpose*/, 0 /*BankID*/, Settacc);
  end;

 
  if (( Settacc.rec.Bankid != -1 ) and ( Settacc.rec.BankCorrId != -1 ) and ( Settacc.rec.Bankid != Settacc.rec.BankCorrId) )
    /*В этом поле указывается сторона, если она отличается от Получателя сообщения, которому металл должен быть доставлен / передан в пользу стороны, указанной в поле 88a*/
      println(":87A:" + ПолучитьКодСубъекта(Settacc.rec.BankCorrId, PTCK_SWIFT));
  end;

  if(Settacc.rec.Account != "")
    println(":88A:/" +  Settacc.rec.Account + "\n" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiver, PTCK_SWIFT));
  else
    /* Бенефициар металла */
    println(":88A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiver, PTCK_SWIFT));
  /* Информация Отправителя Получателю */
  end;
end;

macro DV_MsgSWIFT_MT604( DealID:integer,dockind:integer, i, FD ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var stat, cmd, query, MenuResult, Text, Msg;
  var transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  array MenuItems;

  if( not FD )
    FD = DVFirstDocFXDeal(dockind, DealID, IIF(i == 0, null, i));
    FD.ПлатежТреб();
    FD.ПлатежОб();
  end;

  MenuItems[0] = "Печатать сообщение MT604";
  MenuItems[1] = "Отправить сообщение";
  MenuItems[2] = "Просмотр отправленного MT604";
  MenuResult = Menu(MenuItems, "Выбрать действие");

  if( (MenuResult == 0) or (MenuResult == 1))
    ReportFileName = GetTxtFileName(FD.DealCode() + "_MT604");

    if( Open(ReportOutFile, ReportFileName) == false )
      errcode = status(errtext);
      MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
      return 1;
    end;

    SetOutput(ReportFileName);
    message("Печать...");
    PrintCommonMT604(FD, 604, i);
    SetOutput(NULL, true);
    close(ReportOutFile);
  
    if( MenuResult == 0 )
      ViewFile(ReportOutFile);
    elif( MenuResult == 1 )
      Text;
      Msg = "";
      Open(ReportInFile, ReportFileName);

      while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
      end;
      Msg = Trim(Msg);/*PNV i-support 501082*/

      var exec_send = true;
      runmtedit(@msg, @exec_send);

      if(exec_send)
      getTransportFromDeal(DealID,@transport);
      close(ReportInFile);
      query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
      cmd = RSDCommand(query);
      cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
      cmd.AddParam("p_KindMes", RSDBP_IN, "MT604");
      cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
      cmd.AddParam("p_Msg", RSDBP_IN, Msg);
  //      cmd.AddParam("p_BIC", RSDBP_IN, IIF(ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT) == "", ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT)));
        cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(ПолучитьКодСубъекта(FD.v_pm_BA.rec.receivercode,FD.v_pm_BA.rec.receivercodekind), PTCK_SWIFT));
      cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
      cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
      cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
      cmd.Execute();
      stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
      Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
      MsgBox(Text);
      else
        MsgBox("Отправка отменена.");
      end;
    end;

  elif( MenuResult == 2 )
    PrintSWIFTMessage(DealID, false, FD.Deal.rec.DocKind, "604");
  end;

  return RetVal;
end;

private macro PrintCommonMT605( FD, Kind:integer/*605*/, Y )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var CodeSWIFT_Receiver:string = IIF(ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiverbankid, PTCK_SWIFT) == "", CodeSWIFT_Our, ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiverbankid, PTCK_SWIFT));
  var CodeSWIFT_PAYER:string = IIF(ПолучитьКодСубъекта(FD.v_pm_BA.rec.PAYERbankid, PTCK_SWIFT) == "", CodeSWIFT_Our, ПолучитьКодСубъекта(FD.v_pm_BA.rec.PAYERbankid, PTCK_SWIFT)); /*PNV 506930*/
  var ssu, amount;
  var contractiv = FD.v_pm_CA.rec.fiid;
  var baseactiv = FD.v_pm_BA.rec.basefiid;

  /* Референс операции */
  println(":20:" + DateToStrDDMMYY(FD.ДатаСделки()) + GetCode_103(FD.v_pm_BA.rec.payerbankid) + Y + substr(FD.DealCode(), strlen(FD.DealCode()) - 4));

  /* Идентификация металла и металлический счет */
  println(":26C:/" + GetField_26C(FD, 191) + GetFiidDefinition(baseactiv));

  /*  Идентификация счета */
  /* Дата валютирования */
  println(":30:" + DateToStrYYMMDD(FD.ДатаСделки()));

/*Повторяющаяся последовательность должна появляться хотя бы один раз, но не более десяти раз*/
  /* Референс операции */
//  println(":20:" + DateToStrDDMMYY(FD.ДатаСделки()) + GetCode_103(FD.v_pm_BA.rec.payerbankid) + Y + substr(FD.DealCode(), strlen(FD.DealCode()) - 4));

  /* Связанный референс */
  /*Если связанным сообщением является Подтверждение сделки с металлом MT 600, это поле должно содержать общую ссылку этого МТ 600*/
  //println(":21:" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, GetPrim_191(FD) ));
  /*PNV 506930*/
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  else
     println(":21:NONREF");
  end;
 /*PNV 506930*/

  /* Дополнительное определение */
  println(":23:DELIVERY");

  /* Номер сертификата и / или номера бара */

  /* Количество металла */
  ssu = readNoteForObject( IIF( ((FD.Deal.rec.type != 5) AND (FD.Deal.rec.type != 6)), OBJTYPE_FXOPER_DV, OBJTYPE_OUTOPER_DV ),
                           UniID( FD.deal, IIF( ((FD.Deal.rec.type != 5) AND (FD.Deal.rec.type != 6)), OBJTYPE_FXOPER_DV, OBJTYPE_OUTOPER_DV )),  //SVE
                           IIF( Y == 2, 105, 101));
  if( Y == 0 )
     amount = FD.nfi.rec.Amount;
  else
     amount = FD.nfi_baseactiv.rec.Amount;
  end;

  /*PNV 506930*/
  if (GetIsNotResident(FD.deal.rec.contractor) != true)
    println(":32F:GRM" + NumToStr(amount, 3));
  /*PNV 506930*/
  elif( GetFiidDefinition(baseactiv) == "GOLD" )
     println(":32F:FOZ" + IIF(GetIsNotResident(FD.Deal.rec.Contractor) == true, NumToStr(ssu, 3), amount));
  else
     println(":32F:GOZ" + IIF(GetIsNotResident(FD.Deal.rec.Contractor) == true, NumToStr(ssu, 3), amount));
  end;

  /* Инструктирующая сторона */
/*В этом поле указывается сторона, по заказу которой металл должен быть передан / доставлен Получателю сообщение, если отличается от отправителя.*/
  if( ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiver, PTCK_SWIFT) != CodeSWIFT_Our )
    println(":82A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiver, PTCK_SWIFT));
  end;

  /* Получатель металла */
/*В этом поле указывается сторона, которой металл будет доставлен / передан Получателю*/
  println(":87A:" + CodeSWIFT_PAYER); /*PNV 506930*/

  /* Бенефициар металла */
/*Где это применимо, в этом поле указывается сторона, для которой Отправитель является уполномоченным агентом.*/
//  if( ПолучитьКодСубъекта(FD.v_pm_BA.rec.PAYER, PTCK_SWIFT) != CodeSWIFT_Our ) /*PNV 506930*/
    println(":88A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.PAYER, PTCK_SWIFT));
//    println("//" + GetCorrAcc_2(FD.v_pm_BA.rec.paymentID, FD.isbuy())); /*PNV 506930*/
//  end;

end;

macro DV_MsgSWIFT_MT605( DealID:integer,dockind:integer, i, FD ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var stat, cmd, query, MenuResult, Text, Msg;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  array MenuItems;

  if( not FD )
    FD = DVFirstDocFXDeal(dockind, DealID, IIF(i == 0, null, i));
    FD.ПлатежТреб();
    FD.ПлатежОб();
  end;

  MenuItems[0] = "Печатать сообщение MT605";
  MenuItems[1] = "Отправить сообщение";
  MenuItems[2] = "Просмотр отправленного сообщения";
  MenuResult = Menu(MenuItems, "Выбрать действие");

  if( (MenuResult == 0) or (MenuResult == 1))
    ReportFileName = GetTxtFileName(FD.DealCode() + "_MT605");

    if( Open(ReportOutFile, ReportFileName) == false )
      errcode = status(errtext);
      MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
      return 1;
    end;

    SetOutput(ReportFileName);
    message("Печать...");
    PrintCommonMT605(FD, 605, i);
    SetOutput(NULL, true);
    close(ReportOutFile);

    if( MenuResult == 0 )
      ViewFile(ReportOutFile);
    elif( MenuResult == 1 )
      Text;
      Msg = "";
      Open(ReportInFile, ReportFileName);

      while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
      end;
      Msg = Trim(Msg);/*PNV i-support 501082*/

      getTransportFromDeal(DealID,@transport);
      close(ReportInFile);
       var exec_send = true;
       runmtedit(@msg, @exec_send);
    
       if(exec_send)
         set_mtsend_flag(1);

         query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
         cmd = RSDCommand(query);
         cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
         cmd.AddParam("p_KindMes", RSDBP_IN, "MT605");
         cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
         cmd.AddParam("p_Msg", RSDBP_IN, Msg);
         cmd.AddParam("p_BIC", RSDBP_IN, IIF(ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT) == "", ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT)));
         cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
         cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
         cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
         cmd.Execute();
         stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
         Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
         MsgBox(Text);
       else
         MsgBox("отмена отправки.");
         set_mtsend_flag(0);
       end;

    end;

  elif( MenuResult == 2 )
    PrintSWIFTMessage(DealID, false, FD.Deal.rec.DocKind, "605");
  end;

  return RetVal;
end;

macro DV_MsgSWIFT_MT600( DealID:integer,dockind:integer, fl ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var stat, cmd, query, MenuResult, MenuResult1, Text, Msg;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  array MenuItems;
  array MenuItems1;
  if(dockind != 199)

    var FD = DVFirstDocFXDeal(dockind, DealID);
    FD.ПлатежТреб();
    FD.ПлатежОб();

    MenuItems[0] = "Формирование MT600";
    
    if (FD.Deal.rec.Type == 2)
      MenuItems[1] = "Формирование MT604"; 
    elif (FD.Deal.rec.Type == 1)
      MenuItems[1] = "Формирование MT605";
    end;

    MenuResult = Menu(MenuItems, "Выбрать действие");

    if( MenuResult == 0 )
      MenuItems1[0] = "Печатать сообщение";
      MenuItems1[1] = "Отправить сообщение";
      MenuItems1[2] = "Просмотр исходящего МТ600";
      MenuItems1[3] = "Просмотр сквитованного МТ600"; 
      MenuResult1 = Menu(MenuItems1, "Выбрать действие");

      if( (MenuResult1 == 0) or (MenuResult1 == 1) )
        ReportFileName = GetTxtFileName(FD.DealCode() + "_MT600");

        if( Open(ReportOutFile, ReportFileName) == false )
          errcode = status(errtext);
          MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
          return 1;
        end;

        SetOutput(ReportFileName);
        message("Печать...");
        PrintCommonMT600(FD, 600, 0);
        SetOutput(NULL, true);
        close(ReportOutFile);

        if( MenuResult1 == 0 )
            ViewFile(ReportOutFile);
        elif( MenuResult1 == 1 )
            Text;
            Msg = "";
            Open(ReportInFile, ReportFileName);

            while(next(ReportInFile))
                  Msg = Msg + ReportInFile.str+"\n";
            end;
            Msg = Trim(Msg);/*PNV i-support 501082*/
            getTransportFromDeal(DealID,@transport);
            close(ReportInFile);

         var exec_send = true;
         runmtedit(@msg, @exec_send);
      
          if(exec_send)
            set_mtsend_flag(1);
          //query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?);\n end; ";
            query = " begin\n ? := RSP_SECURITY.CREATEPAYMFROMSEC(?,?,?,?,?,?,?);\n end; ";
            cmd = RSDCommand(query);
            cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
            cmd.AddParam("p_KindMes", RSDBP_IN, "MT600");
            cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
            cmd.AddParam("p_Msg", RSDBP_IN, Msg);
            cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
            cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
            cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
            cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
            cmd.Execute();
            stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
            Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
            MsgBox(Text);
          else
            MsgBox("отмена отправки.");
            set_mtsend_flag(0);
          end;

        end;

      elif( MenuResult1 == 2 )
        PrintSWIFTMessage(DealID, false, FD.Deal.rec.DocKind, "600");
      elif( MenuResult1 == 3 )
        PrintSWIFTMessage(DealID, true, FD.Deal.rec.DocKind, "600");
      end;
    elif( (MenuResult == 1) and (FD.Deal.rec.Type == 2) )
      DV_MsgSWIFT_MT604(FD.Deal.rec.Id, FD.Deal.rec.dockind, 0);
    elif( (MenuResult == 1) and (FD.Deal.rec.Type == 1) )
      DV_MsgSWIFT_MT605(FD.Deal.rec.Id, FD.Deal.rec.dockind, 0);
    end;

  else
    var i = 0;

    while(i != 2)
      i = i + 1;
      /*Авторский финт ушами*/
      FD = null;
      FD = DVFirstDocNDeal(dockind, DealID, i);
      FD.ПлатежТреб();
      FD.ПлатежОб();
      MenuItems[0] = "Печатать сообщение по " + i + "-й части";
      MenuItems[1] = "Отправить сообщение по " + i + "-й части";

      if ((FD.Deal.rec.type == 6) and (i == 1))
        MenuItems[2] = "Формирование МТ604";
      elif ((FD.Deal.rec.type == 5) and (i == 1))
        MenuItems[2] = "Формирование МТ605";
      elif ((FD.Deal.rec.type == 5) and (i == 2))
        MenuItems[2] = "Формирование МТ604";
      elif ((FD.Deal.rec.type == 6) and (i == 2))
        MenuItems[2] = "Формирование МТ605";
      end;

      MenuItems[3] = "Просмотр исходящего МТ600 по " + i + "-й части";
      MenuItems[4] = "Просмотр сквитованного МТ600 по " + i + "-й части"; 

      if (fl == 1 )
        MenuResult = 1;
      else
        MenuResult = Menu(MenuItems, "Выбрать действие");
      end;

      if( (MenuResult == 0) or (MenuResult == 1) )
      ReportFileName = GetTxtFileName(FD.DealCode() + "_MT600");

      if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
      end;

      SetOutput(ReportFileName);
      message("Печать...");
      PrintCommonMT600(FD, 600, i);
      SetOutput(NULL, true);
      close(ReportOutFile);

        if(MenuResult == 0) 
          ViewFile(ReportOutFile);
        elif( MenuResult == 1 )
          Text;
          Msg = "";
          Open(ReportInFile, ReportFileName);

          while(next(ReportInFile))
            Msg = Msg + ReportInFile.str+"\n";
          end;
          Msg = Trim(Msg);/*PNV i-support 501082*/

          getTransportFromDeal(DealID,@transport);

          exec_send = true;
          runmtedit(@msg, @exec_send);
    
          if(exec_send)
            set_mtsend_flag(1);
            close(ReportInFile);
    //        query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
            query = " begin\n ? := RSP_SECURITY.CREATEPAYMFROMSEC(?,?,?,?,?,?,?);\n end; ";
            cmd = RSDCommand(query);
            cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
            cmd.AddParam("p_KindMes", RSDBP_IN, "MT600");
            cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
            cmd.AddParam("p_Msg", RSDBP_IN, Msg);
            cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
            cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
            cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
            cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
            cmd.Execute();

            stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
            Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
            MsgBox(Text);
          else
            MsgBox("отмена отправки.");
            set_mtsend_flag(0);
          end;

        end;

      elif( MenuResult == 3 )
          PrintSWIFTMessage(DealID, false, FD.Deal.rec.DocKind, "600", i);
      elif( MenuResult == 4 )
          PrintSWIFTMessage(DealID, true, FD.Deal.rec.DocKind, "600", i);
      elif (MenuResult == 2) 
        if ((FD.Deal.rec.type == 6) and (i == 1))
            DV_MsgSWIFT_MT604( DealID, dockind, i, FD )
        elif ((FD.Deal.rec.type == 5) and (i == 1))
            DV_MsgSWIFT_MT605( DealID, dockind, i, FD )
        elif ((FD.Deal.rec.type == 6) and (i == 2))
            DV_MsgSWIFT_MT605( DealID, dockind, i, FD )
        elif ((FD.Deal.rec.type == 5) and (i == 2))
            DV_MsgSWIFT_MT604( DealID, dockind, i, FD )
        end;
      end;
    end;
  end;
  return RetVal;
end;

macro DV_MsgSWIFT_MT305_Send( DealID:integer ):integer

  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Text;
  var Msg = "";
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;


  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT305");
  if( Open(ReportOutFile, ReportFileName) == false )
    errcode = status(errtext);
    MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
    return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT305(FD, 305);

  SetOutput(NULL, true);
  close(ReportOutFile);


  Open(ReportInFile, ReportFileName);

  while(next(ReportInFile))
    Msg = Msg + ReportInFile.str+"\n";
  end;
  Msg = Trim(Msg);/*PNV i-support 506640*/

  getTransportFromDeal(DealID,@transport);
  close(ReportInFile);
  var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
  var cmd = RSDCommand(query);
  cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("p_KindMes", RSDBP_IN, "MT305");
  cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
  cmd.AddParam("p_Msg", RSDBP_IN, Msg);
  cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
  cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
  cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
  cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
  cmd.Execute();
  var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
  Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
  MsgBox(Text);

  return RetVal;
end;


macro DV_MsgSWIFT_MT360_Send( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Text;
  var Msg = "";
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT360");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT360_MT361(FD, 360);

     SetOutput(NULL, true);
     close(ReportOutFile);

     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
  
     if(exec_send)
       set_mtsend_flag(1);
       var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
       var cmd = RSDCommand(query);
       cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
       cmd.AddParam("p_KindMes", RSDBP_IN, "MT360");
       cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
       cmd.AddParam("p_Msg", RSDBP_IN, Msg);
       cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
       cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
       cmd.Execute();
       var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
       Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
       MsgBox(Text);
    else
      MsgBox("отмена отправки.");
      set_mtsend_flag(0);
    end;

  return RetVal;
end;

private macro PrintCommonMT340_MT341( FD, Kind:integer/*340,341*/ )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var nFI = IIF(FD.Deal.rec.Type == ALG_DV_FLOAT_FIX, FD.nFI_BaOther, FD.nFI_BaseActiv);

  /* Общая информация */
  println(":15A:");
  /* Референс отправителя */
  println(":20:" + substr(DateToStrDDMMYYYY(FD.ДатаСделки()) + "-" + FD.DealCode(), 1, 16));
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  end;
  /* Тип операции */
  if( Kind == 340 )
  println(":22A:NEWT");
  elif(( Kind == 341 ))
     println(":22A:SETT");
  end;
  /* Общий референс */
//  println(":22C:" + GetField_22C(CodeSWIFT_Our, CodeSWIFT_Contr, FD.ДатаИсполнения()));
  println(":22C:" + MakeCommonRef(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true)));

  /* Тип FRA */
  println(":23D:" + GetField_23A(FD.Deal.rec.Type));
  /* Номер контракта стороны А */
  println(":21N:" + FD.DealCode() + IIF(Kind == 341, "-CCYFRA", "-FRA"));
  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  var str77H = GetField_77H(FD.Deal.rec.GenAgrId);
  if( Kind == 340 )
    /* Тип, дата, версия соглашения */
    if( str77H == "OTHER" )
       println(":77H:OTHR");
    else
    println(":77H:" + str77H);
    end;
    if( index(str77H, "ISDA") )
      /* Год версий определений */
      println(":14C:" + GetField_14C(FD.Deal.rec.genagrid));
    end;
  end;

  /* Детали операции */
  println(":15B:");
  /* Дата сделки */
  println(":30T:" + DateToStrYYYYMMDD(FD.ДатаСделки()));
  /* Валюта, условная основная сумма */
  println(":32B:" + ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));
  /* Дата вступления в силу */
  println(":30F:" + DateToStrYYYYMMDD(FD.ДатаСделки()));
  /* Дата закрытия */
  println(":30P:" + DateToStrYYYYMMDD(FD.ДатаИсполнения()));
  /* Фиксированная ставка */
  println(":37M:" + NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true));
  if( Kind == 340 )
    /* Вариант плавающей ставки */
//    var str14F = GetField_14F(nFi);
    var str72;
    var str14F = GetField_14F_MT340(IIF(FD.nFI_BaOther.rec.rateid != -1, FD.nFI_BaOther, FD.nFI_BaseActiv), str72);/*DAN исправлена ошибка в определении индекса*/
    if ((not str14F) or (str14F == "OTHER")) 
      println(":14F:OTHER");
    else
      println(":14F:" + str14F);
    end;
  end;

  /* Детали AFB и FRABBA */
  if( index(str77H, "AFB") or index(str77H, "FRABBA") )
    /* Дата фиксации */
    println(":30V:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
    /* Период контракта */
    println(":38D:");
  end;

  /* Прочие детали */
  if( Kind == 340 )
    var str38G = GetPeriod(nFI.rec.Period, nFI.rec.PeriodKind);
    /* Расчетный срок погашения */
    println(":38G:" + str38G + "/" + str38G);
    var str14D = GetBasis(nFI.rec.Basis);
    /* Число дней при расчете плавающей ставки */
    println(":14D:" + str14D);
    /* Дисконт FRA */
    println(":17F:" + IIF(FD.Deal.rec.CorrectDate == SET_CHAR, "Y", "N"));
    /* Финансовый центр */
    GetField_22B(FD.Deal.rec.Contractor);
  end;

  if( Kind == 340 )
    /* Расчетные инструкции для сумм, выплачиваемых стороной B */
    println(":15C:");
    /* Агент получатель */
    if( GetIsNotResident(FD.Deal.rec.Contractor))
       if( получитьКорСчет(1))
          println(":57A:/" + получитьКорСчет(1));
          println(trim(CodeSWIFT_Our));
       else
          println(":57A:" + trim(CodeSWIFT_Our));
       end;
    elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
       println(":57D:" + GetField_57D_36X( FD, true ));
    else
       if( получитьКорСчет(1))
          println(":57A:/" + получитьКорСчет(1));
          println(trim(CodeSWIFT_Our));
       else
          println(":57A:" + trim(CodeSWIFT_Our));
       end;
    end;
  elif( Kind == 341 )
    /* Расчетные инструкции для перевода суммы расчетов */
    println(":15C:");

    /* Расчетная ставка */
    var retValue = $0;
    var rec_rate = TRecHandler("ratedef.dbt");
    var err = ПолучитьКурс (rec_rate, IIF(FD.nFI_BaOther.rec.rateid != -1, FD.nFI_BaOther.rec.rateid, FD.nFI_BaseActiv.rec.rateid), -10);
    if (not err)
      err = ПолучитьЗначениеКурса (rec_rate, {curdate});
          if (not err)
             ПолучитьСтрокуЗначенияКурса(rec_rate,1,retValue);
          end;
    end;      

    println(":37R:"+NumToStr(retValue,2, true));
//доработать
    /* Валюта и сумма расчетов */
    println(":34E:"+ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));




    /* Агент получатель */
    if( GetIsNotResident(FD.Deal.rec.Contractor))
       if( получитьКорСчет(1))
          println(":57A:/" + получитьКорСчет(1));
          println(trim(CodeSWIFT_Our));
       else
          println(":57A:" + trim(CodeSWIFT_Our));
       end;
    elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
       println(":57D:" + GetField_57D_36X( FD, true ));
    else
       if( получитьКорСчет(1))
          println(":57A:/" + получитьКорСчет(1));
          println(trim(CodeSWIFT_Our));
       else
          println(":57A:" + trim(CodeSWIFT_Our));
       end;
    end;
  end;

  if( Kind == 340 )
    /* Расчетные инструкции для сумм, выплачиваемых стороной A */
    println(":15D:");
    /* Агент получатель */
    if( GetIsNotResident(FD.Deal.rec.Contractor))
       if( получитьКорСчет(FD.Deal.rec.Contractor) )
          println(":57A:/" + получитьКорСчет(FD.Deal.rec.Contractor));
          println(trim(CodeSWIFT_Contr));
       else
          println(":57A:" + trim(CodeSWIFT_Contr));
       end;
    elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
       println(":57D:" + GetField_57D_36X( FD ));
    else
       if( получитьКорСчет(FD.Deal.rec.Contractor) )
          println(":57A:/" + получитьКорСчет(FD.Deal.rec.Contractor));
          println(trim(CodeSWIFT_Contr));
       else
          println(":57A:" + trim(CodeSWIFT_Contr));
       end;
    end;
  
    if((str14F == "OTHER" ) and (not str72))
      msgboxex("Предупреждение.|Не удалось определить плавающую ставку. |Проверьте что в параметрах сделки указана плавающая ставка.|Возможны ошибки генерации сообщения.", MB_OK, IND_OK,"Формирование МТ34х.");
    end;

    if((str14F == "OTHER" ) and (str72))
       println(":15E:");
       println(":72:/FROP/" + str72);
    end;

    if( (index(str14F, "OTHR")) or (index(str38G, "O")) or (index(str14D, "OTHR")) )
      /* Дополнительная информация */
      println(":15E:");
      println(":72:");
    end;
  end;

end;

macro DV_MsgSWIFT_MT340( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT340");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT340_MT341(FD, 340);

     SetOutput(NULL, true);
     close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
    
     if(exec_send)
        set_mtsend_flag(1);

        var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT340");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
        cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;

  end;

  return RetVal;
end;
macro DV_MsgSWIFT_MT341( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT341");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT340_MT341(FD, 341);

     SetOutput(NULL, true);
     close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
    
     if(exec_send)
        set_mtsend_flag(1);

        var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT341");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
        cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;

  end;

  return RetVal;
end;

private macro PrintFixMT364_MT365( nFI:TRecHandler, Deal:TBFile, Side:integer, Netting, Валюта:integer, Kind:integer/*360,361*/ )
  /* Действующая фиксированная ставка */
  println(":37M:" + NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true));
  /* Новая фиксированная ставка */
  if( ("22B" == "PTRC") or ("22B" == "RCPN") )
     println(":37G:" + NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true));
  end;
end;

private macro PrintPaymMT364( BegDate:date, EndDate:date, Платеж, Платеж2, CodeSWIFT:string, TypeCalc:integer, FD )
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(BegDate));
  /* Валюта, сумма платежа */
  println(":32M:" + ПолучитьКодФинИн(Платеж.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж.rec.OrderAmount, 2));
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     println(":57A:/" + получитьКорСчет(IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), 1, FD.Deal.rec.Contractor)));
     println(trim(CodeSWIFT));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     println(":57A:/" + получитьКорСчет(IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), 1, FD.Deal.rec.Contractor)));
     println(trim(CodeSWIFT));
  end;
end;

private macro PrintCommonMT364_MT365( FD, Kind:integer/*364,365*/ )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var Comment_ = ""; /*PNV 505931*/

  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  println(":20:" + substr(DateToStrDDMMYYYY(FD.ДатаСделки()) + "-" + FD.DealCode(), 1, 16));
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  end;
  /* Тип операции */
  println(":22A:NEWT");
  /* Характер операции */
  println(":94A:BILA");
  /* Тип события */
  //println(":22B:PTRC PTRM RCPN TERM");
  var str22B = "TERM";
  println(":22B:" + str22B);

  /* Общий референс */
  println(":22C:" + GetField_22C(CodeSWIFT_Our, CodeSWIFT_Contr, FD.ДатаИсполнения()));
  /* Определение свопа */
  println(":23A:" + GetField_23A(FD.Deal.rec.Type, FD.Deal.rec.netting_pmgr) + IIF(Kind == 364, "/NET", "/GROSS"));
  /* Номер контракта */
  println(":21N:" + FD.DealCode() + IIF(Kind == 364, "-CCYIRS", "-IRS"));
  /* Дата соглашения о закрытии/пересмотре ставок */
  println(":30T:" + DateToStrYYYYMMDD(FD.ДатаСделки()));
  /* Дата вступления в силу закрытия/пересмотра ставок */
  println(":30Q:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
  /* Исходная дата закрытия */
  println(":30P:" + DateToStrYYYYMMDD(FD.ДатаИсполнения()));
  /* Дата вступления в силу */
  println(":30V:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
  /* Валюта, величина действующей условной основной суммы */
  if( Kind == 364 )
     println(":32B:" + ПолучитьКодФинИн(FD.ВалютаТребования(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаТребования(), 2));
  elif( Kind == 365 )
     println(":32B:" + ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));
     println(":33B:" + ПолучитьКодФинИн(FD.ВалютаТребования(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаТребования(), 2));
  end;
  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  /* Порядок начисления процентов */
  if( str22B != "TERM" )
     println(":22D:LAST NEXT OTHR");
  end;
  /* Валюта, величина новой условной основной суммы */
  if( (str22B == "PTRC") or (str22B == "PTRM") )
     println(":32G:");
  end;
  /* Детали процентной ставки */
  if( "22D" == "OTHR" )
     println(":37N:");
  end;
  /* Информация Отправителя Получателю */
  if( FD.Deal.rec.Comment)
     StrChangeRusXSet( FD.Deal.rec.Comment, Comment_ ); /*PNV 505931*/
     println(":72:" + trim(substr(Comment_, 1, 35))); /*PNV 505931*/
  end;
  if( substr(FD.Deal.rec.Comment, 36, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 36, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 71, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 71, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 116, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 116, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 151, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 151, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 176, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 176, 35));
  end;
  var BegDate:date = date(0,0,0), EndDate:date = date(0,0,0);
  /* Фиксированный процент, выплачиваемый стороной B */
  if( (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX) or (FD.Deal.rec.Type == ALG_DV_FIX_FIX) )
     println(":15B:");
     PrintFixMT364_MT365(FD.nFI_BAOther, FD.Deal, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, FD.ВалютаТребования(), Kind);
     var FD2 = DVFirstDocNDeal(DL_DVNDEAL, FD.Deal.rec.ID, 2);

     GetBegEndDatePmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, @BegDate, @EndDate);
     /* Комиссии, оплачиваемые стороной B */
     println(":15L:");
     PrintPaymMT364(BegDate, EndDate, FD.ПлатежОб, FD2.ПлатежОб, CodeSWIFT_Contr, FD.nFI_BaseActiv.rec.TypeCalc, FD);
  end;
  /* Фиксированный процент, выплачиваемый стороной A */
  if( (FD.Deal.rec.Type == ALG_DV_FIX_FLOAT) or (FD.Deal.rec.Type == ALG_DV_FIX_FIX) )
     println(":15E:");
     PrintFixMT364_MT365(FD.nFI_BaseActiv, FD.Deal, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, FD.ВалютаОбязательства(), Kind);
     FD2 = DVFirstDocNDeal(DL_DVNDEAL, FD.Deal.rec.ID, 2);
     BegDate = date(0,0,0);
     EndDate = date(0,0,0);

     GetBegEndDatePmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, @BegDate, @EndDate);
     /* Комиссии, оплачиваемые стороной A */
     println(":15M:");
     PrintPaymMT364(BegDate, EndDate, FD.ПлатежОб, FD2.ПлатежОб, CodeSWIFT_Contr, FD.nFI_BaseActiv.rec.TypeCalc, FD);
  end;
end;

macro DV_MsgSWIFT_MT364( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();
  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT364");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT364_MT365(FD, 364);

  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

  SetOutput(NULL, true);
  close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);

     if(exec_send)
        set_mtsend_flag(1);
   
        var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT364");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
        cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     else
       MsgBox("отмена отправки.");
       set_mtsend_flag(0);
     end;

  end;

  return RetVal;
end;

macro DV_MsgSWIFT_MT365( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();
  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT365");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT364_MT365(FD, 365);

  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

  SetOutput(NULL, true);
  close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
    
     if(exec_send)
       set_mtsend_flag(1);

       var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?,?,?);\n end; ";
       var cmd = RSDCommand(query);
       cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
       cmd.AddParam("p_KindMes", RSDBP_IN, "MT365");
       cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
       cmd.AddParam("p_Msg", RSDBP_IN, Msg);
       cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
       cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
       cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
       cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
       cmd.Execute();
       var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
       Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
       MsgBox(Text);
    else
      MsgBox("отмена отправки.");
      set_mtsend_flag(0);
    end;

  end;

  return RetVal;
end;

private macro PrintCommonMT392( FD, Msg, Num, Date, Type )
  /* Референс отправителя */
  println(":20:" + substr(DateToStrDDMMYYYY(FD.ДатаСделки()) + "-" + FD.DealCode(), 1, 16));
  /* Связанный референс */
  println(":21:" + Num);
  /* MT и дата исходного сообщения */
  println(":11S:" + strsubst(Type,"MT","")/*Type + Date*/);
  println(Date);
  /* Копия полей */
  println(Msg);
end;

macro DV_MsgSWIFT_MT392( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Transport;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();
  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT392");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

//var TypeMT = "MT340";
   var TypeMT;
   if(GetTypeMessage4Cancel(DealID, @TypeMT))
     TypeMT = "MT" + TypeMT;

//     var query = " begin\n ? := RSP_SECURITY.CREATEMTN92(?,?,?,?,?,?);\n end; "; GETMSGFORMTN92
  var query = " begin\n ? := RSP_SECURITY.GETMSGFORMTN92(?,?,?,?,?,?,?);\n end; "; 
  var cmd = RSDCommand(query);
  cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("p_KindMes", RSDBP_IN, TypeMT);
  cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
  cmd.AddParam("p_Msg", RSDBP_OUT, V_STRING, 10000);
  cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, 4000);
  cmd.AddParam("p_Num", RSDBP_OUT, V_STRING);
  cmd.AddParam("p_Date", RSDBP_OUT, V_STRING);
  cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
  cmd.Execute();

  if( SQL_ConvTypeInteger(cmd.value("p_Stat")) == 1 )
    MsgBox(SQL_ConvTypeInteger(cmd.value("p_Text")));
    return RetVal;
  end;

  PrintCommonMT392(FD, SQL_ConvTypeInteger(cmd.value("p_Msg")), SQL_ConvTypeInteger(cmd.value("p_Num")), SQL_ConvTypeInteger(cmd.value("p_Date")), TypeMT);

  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

  SetOutput(NULL, true);
  close(ReportOutFile);

//     array MenuItems;
     var  MenuItems = TArray;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить сообщение";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text = "";
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;
     Msg = Trim(Msg);/*PNV i-support 506640*/

     getTransportFromDeal(DealID,@transport);
     close(ReportInFile);

     var exec_send = true;
     runmtedit(@msg, @exec_send);
    
      if(exec_send)
         set_mtsend_flag(1);
 
         query = " begin\n ? := RSP_SECURITY.CREATEMTN92(?,?,?,?,?,?);\n end; ";
         cmd = null;
         cmd = RSDCommand(query);
         cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
         cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
         cmd.AddParam("p_Msg", RSDBP_IN, Msg);
         cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
         cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
         cmd.AddParam("p_Transport", RSDBP_IN, Transport);  
         cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
         cmd.Execute(); 
         var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
         Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
         MsgBox(Text);
      else
        MsgBox("отмена отправки.");
        set_mtsend_flag(0);
      end;

  end;
  end;

  return RetVal;
end;
