/*
$Name:        dvopcur060.mac
$Module:      Производные инструменты
$Description: Расчеты по производным инструментам на валютном рынке/рынке СПФИ. Шаг "Возврат средств с клирингового счета"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_carop.mac";

var TransAmount;
var TransCurr;
var TransAction;
var TransAmount_Clir;
var TransCurr_Clir;

/*CHVA*/
private macro DL_GetRestAccountParam( Chapter, Code_Currency, Account, Dat )
   var Rest = $0, PlanRest = $0;
   OprGetAccountRest(Chapter, Code_Currency, Account, Dat, Rest, PlanRest);
   return Rest;
end;

private macro DL_GetRestAccount( accbuf, Dat )
   return DL_GetRestAccountParam(accbuf.rec.Chapter, accbuf.rec.Code_Currency, accbuf.rec.Account, Dat);
end;
/*CHVA*/
macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record oper(dvoper);

  SetBuff(oper, FDoc);

  var FD_Oper = DVFirstDocOper(DL_DVOPER, oper);

  if( (ValType(TransAction) == V_UNDEF) and (ValType(TransAmount_Clir) == V_UNDEF) and (ValType(TransCurr_Clir) == V_UNDEF) )
     MsgBox("Вставка цепочек возможна только из панели 'Перемещение средств'");  
     return 1;
  elif( TransAction == DV_KINDTRANS_RETURN_CLEARING_ACCOUNT )
     var OurAcc   = TRecHandler("account"),
         CredProp = TRecHandler("pmprop.dbt"),
         PaymentObj:RsbPayment;

   /*CHVA При возврате средств с клирингового счета биржи необходимо проверять остаток на счете 47404*0004. Если остаток >0 , то используется только этот счет, если входящий остаток = 0, то */
              /* используется счет по смыслу проведения операции если платим(обязательство), то 47404, если получаем(требования), то 47403*/
           var CheckAcc = TRecHandler("account");
           var rest = false;
           var CatCode;
           if( not FD_Oper.IsExistAccount("Клиринговый счетВ", null, true, null, CheckAcc,MC_PAIRACCMODE_MANUAL/* null*/, FD_Oper.DVOper.rec.Date, TransCurr_Clir) )
               MsgBox("Ошибка: не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(TransCurr_Clir));
               return 1;
           end;
     
           if ( ABS(DL_GetRestAccount(CheckAcc, FD_Oper.DVOper.rec.Date)) > 0)
               rest = true;
           end; 
    
      if (FD_Oper.kind == 194)
        if (FD_Oper.dvoper.rec.operkind == 12602)//валютный рынок
               if (TransCurr_Clir == 0)
                  CatCode = "Клиринговый счетР" ;
               else
                  if (rest)
                     CatCode = "Клиринговый счетВ" ;
                  else 
                     CatCode = "Клиринговый счетВ3";
                  end;
               end;
        end; 
      end;   
           /*CHVA*/
     if( not FD_Oper.IsExistAccount(CatCode/*"Клиринговый счет"*/, null, true, null, OurAcc, MC_PAIRACCMODE_MANUAL/*null*/, FD_Oper.DVOper.rec.Date, TransCurr_Clir) )/*CHVA*/
        MsgBox("Ошибка: не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(TransCurr_Clir));
        return 1;
     end;

     if( DVND_CreatePayment( FD_Oper, PM_PURP_REPAYMENT, FD_Oper.Kind, FD_Oper.ID, 
                             FD_Oper.DVOper.rec.Date,
                             FD_Oper.GetContractorID(), -1,
                             {ourbank}, {ourbank},
                             TransAmount_Clir, TransCurr_Clir,
                             ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_CLIR),
                             NULL, OurAcc,
                             FD_Oper.DVOper.rec.Department, NULL, NULL,
                             @PaymentObj, NULL,
                             NULL, @CredProp
                           ) != 0 )
        return 1;
     end;

     if( not ПИ_ПроводкаПоПлатежу(FD_Oper, PaymentObj) )
        return 1;
     end;

     if( ПИ_ИсполнитьПлатеж(PaymentObj) )
        return 1;
     end;

     if( FD_Oper.IsClient() )
        if( ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3 )
           if( not ПИ_ВУ_ПереводСредствСКлирСчетаКлиента(FD_Oper, doc, TransCurr_Clir) )
              return 1;
           end;
        end;
     else
        if( TransCurr_Clir != NATCUR )
           FD_Oper.SetBankID(GetCorrID(CredProp.rec.CorSchem, TransCurr_Clir, FIKIND_CURRENCY));
        end;
        FD_Oper.SetParametr(MC_TYPE_PARAMETR_FIID, TransCurr_Clir);
        if( not ПроводкаПоКатегориямВнутреннегоУчета( 4,
                                                      FD_Oper,
                                                      doc,
                                                      FD_Oper.DVOper.rec.Date,
                                                      TransCurr_Clir,
                                                      TransAmount_Clir
                                                    )
          )
           return 1;
        end;
     end;

     if( DL_InsertDL_VALUE(FD_Oper.Kind, FD_Oper.ID, ALG_DV_TYPE_CALC_OUT_CLEARING, date(0,0,0), TransAmount_Clir, TransCurr_Clir, 0) != 0 )
        return 1;
     end;
  end;

  return 0;
end;
