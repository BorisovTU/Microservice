/*
$Name:        dvfx005.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Настройка операции"
*/
IMPORT InsCarryDoc, "dv_categ.mac", "dv_car.mac" ,funk, dv_lib;
IMPORT "Print_rasp.mac"; /*PNV*/

/*PNV*/
PRIVATE MACRO SfIsOurFilial( ReceiverID )   
  var rs;  
  rs = RsdRecordset( "SELECT T_PARTYID FROM DDP_DEP_DBT WHERE T_PARTYID = " + ReceiverID + " and T_PARTYID <> " + {Ourbank} );
                    
  if( rs.movenext )    
    return true;   
  end;

  return false;
END;
/*PNV*/

macro executeParamStep( kind_oper, BOf_kind, FDoc, ID_Operation, ID_Step )

record deal(dvndeal);
  var FD, FD2;

  var Contractor = TRecHandler( "party.dbt" );/*PNV*/
  
  SetBuff(deal, FDoc);

  DL_SetBalanceDateEQMinTODate(DV_FXDEAL_OPRDATE_EXEC, DV_FXDEAL_OPRDATE_REQ, DV_FXDEAL_OPRDATE_OBL);

  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  DL_CalendDefineOprDate(FD ,DV_FXDEAL_OPRDATE_BEGIN_OP, FD.ДатаСделки());
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_EXEC,     FD.ДатаИсполнения());
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_REQ,      FD.ДатаТребования());
    DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_OBL, FD.ДатаОбязательства());
  if(not FD.IsDealMet()) 
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_COMISS, DL_GetMinComPlanDateByOper(FD.Kind, FD.ID));
  end;
  if( FD.IsSWAP() )
     FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, deal, 2);

     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_EXEC_2, FD2.ДатаИсполнения());
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_REQ_2,  FD2.ДатаТребования());
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_OBL_2,  FD2.ДатаОбязательства());
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_CLOSE,  FD2.ДатаЗавершения());
  else
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_CLOSE,  FD.ДатаЗавершения());
  end;

  if( FD.IsDealMet())
   DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_CALCCOMISS,  FD.ДатаСделки());
  end;

  if( ПИ_ИнтегрРежимРаботы() and FD.IsBNote() )
     if( not УстановитьКатегориюПрихКассСимвол(FD, OBJTYPE_FXOPER_DV, FD.ДатаСделки()) )
        return 1;
     end;
     if( not УстановитьКатегориюРасхКассСимвол(FD, OBJTYPE_FXOPER_DV, FD.ДатаСделки()) )
        return 1;
     end;
  end; 
 
  /*PNV*/
  if( not FD.IsSWAP() )
      if( ПИКО_АктуализироватьПлатежи(FD,"") != 0 )
          return 1;
      end;
  end;

  if ( (ПолучитьСубъекта(FD.ПлатежТреб.rec.payer, Contractor) == 0)) 
     if ( (not FD.IsBNote()) and (Contractor.rec.LegalForm != PTLEGF_PERSN) and (SfIsOurFilial(FD.ПлатежТреб.rec.payerbankid )) and (not FD.Биржевая()))  
          СформироватьРаспоряжение(deal.date, FD, FD.ПлатежТреб, "Rasp_Konv.dotx");
     end; 
  end;
  /*PNV*/

  return 0;
END;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

  record deal(dvndeal);
  SetBuff(deal, FirstDoc );
  var nn, que, rs5, su = 0.00, paymentid;

  if ( CommitOrRollback == 1 )
    if (deal.kind == 12740 )
       nn = 4;
    else
       nn = 2;
    end;
  end;

  if ( CommitOrRollback == 1 )
       if (dmdm(deal.id) > 0)
           que = "select  RSB_Struct.GetDouble(t_text) from dnotetext_dbt  where t_notekind = 101 and t_objecttype = 148 and t_documentid = lpad(" + deal.id + ",34,'0')";
           rs5 = LnGetRecordSet(que);
           if(rs5 != null)
              if (rs5.moveNext) 
                  su = rs5.value(0);
              end;
           end;
           if (su > 0 )
               paymentid = plat_dil5(deal.id, 4813, 1, "paymentid");
               que = "update dpmpaym_dbt SET  t_FUTUREPAYERAMOUNT = '" + su + "' ,  t_FUTURERECEIVERAMOUNT = '" + su + "' ,  t_AMOUNT = '" + su + "',  t_BASEAMOUNT = '" + su + "' ,   t_PAYAMOUNT ='" + su + "' ";
               que = que + " where t_paymentid = " + paymentid; 
               rs5 = LnGetRecordSet(que);
           end;
       end;
  end;
  return 0;
END;

