/*
$Name:        dv_comiss.mac
$Module:      Производные инструменты
$Description: Операция расчетов по ПИ/Процедуры для работы с комиссиями
*/
IMPORT "dv_fun.mac";

FILE FindOper(oproper) key 1; 

PRIVATE MACRO ПолучитьОперациюПоСделке( Deal, oper )
  ClearRecord( FindOper );
  FindOper.DocKind    = DL_DVDEAL;   
  FindOper.DocumentID = UniID( Deal, OBJTYPE_OPER_DV );
  FindOper.Start_Date = Deal.Date; 

  if( not GetEQ(FindOper) )
     msgbox( "Не найдена операция по сделке " + Deal.Code );
     return false;
  end;
  copy( oper, FindOper );
  return true;
END;

private var sfcom = TRecHandler("sfcomiss.dbt");
MACRO ПолучитьИСохранитьСуммуКомиссийПоСделке( deal, ByClient:bool )
   
   record Operation( oproper );
   record OprCom( oprsfcom );               
   record settacc(settacc);
   var    ErrMsg = "";

   if( not ПолучитьОперациюПоСделке( deal, Operation ) )
      return false;
   end;

   ClearRecord( OprCom );
   while( SfGetOperCommission( Operation.ID_Operation, -1, OprCom ) )

      if( OprCom.Sum != $0 ) 
                    
         if( not SfGetComiss( OprCom.FeeType, OprCom.CommNumber, sfcom ) )
            MsgBox( "Не найдена комиссия по операции" );
            return false;
         end;                                    

         if( ((ByClient == false) and (sfcom.rec.ReceiverID != {OurBank})) /*комиссии контрагенту*/ or
             ((ByClient == true) and (sfcom.rec.ReceiverID == {OurBank}) AND (deal.Client > 0)) /*комиссии банку*/
           ) 
            if( DVInsertDlCom( deal.ID, sfcom.rec.ComissID, (OprCom.Sum + OprCom.SumNDS), OprCom.SumNDS ) != 0 )
               ErrMsg = GetErrMsg();
               MsgBox( "Ошибка вставки комиссии с номером \""+sfcom.rec.Number+"\" по сделке с кодом = "+string(deal.Code)+": "+ErrMsg) ;
               return false;
            end;
         end;
      end;
   end; 

   return true;
END;
