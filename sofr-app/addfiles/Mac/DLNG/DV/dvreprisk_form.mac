/*
$Name:        dvreprisk_form.mac
$Module:      Производные инструменты
$Description: форма отчета "Сведения о риске процентной ставки (ф.127)"
*/

import "DlRepForm_h.mac";

CONST 
      PNFLD_REPRISK_REPDATE        = 0,
      PNFLD_REPRISK_CURRENCY_CODE  = 1,
      PNFLD_REPRISK_CURRENCY_NAME  = 2,
      PNFLD_REPRISK_BYFISSKO       = 3,
      PNFLD_REPRISK_BYVA           = 4,
      PNFLD_REPRISK_BYVBANK        = 5,
      PNFLD_REPRISK_BYSECUR        = 6;

private MACRO GetFI_Name(fiid)
var ds, q;

    if (valtype(fiid) != V_UNDEF)
        q = String("select t_name from dfininstr_dbt where t_fiid = ", fiid);
        ds = TRsbDataset(q);
        if (ds.next())
            return ds.t_name;
        end;
    end;

    return "";
END;

/* Валюта */
PRIVATE MACRO DL_FldProc_FI_Name( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
record FI( fininstr );

  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue < 0 )
        FldShowValue = "";
     else
        FldShowValue = GetFI_Name(FldRealValue);
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = "";
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) ) // Вызов листалки и заполнение FldShowValue и FldRealValue
     if (ListFI (FIKIND_CURRENCY, 0, FI))
        FldRealValue = FI.FIID;
        FldShowValue = GetFI_Name(FldRealValue); // наименование валюты
     end;
  end;
  return CM_DEFAULT;
END;

CLASS (DL_CPanel) DV_REPRISK_Panel()

  PRIVATE MACRO Init()
     AddFieldProc( 0, PNFLD_REPRISK_REPDATE,       DL_PNFLD_BEGINDATE, @DL_FldProc_BeginDate,   {curdate} );
     AddFieldProc( 0, PNFLD_REPRISK_CURRENCY_CODE, DL_PNFLD_FI,        @DL_FldProc_FI_ISO_Num,      -1 );
     AddFieldProc( 0, PNFLD_REPRISK_CURRENCY_NAME, DL_PNFLD_FI_NAME,   @DL_FldProc_FI_Name );
     AddFieldProc( 0, PNFLD_REPRISK_BYFISSKO,      DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox, "X" );
     AddFieldProc( 0, PNFLD_REPRISK_BYVA,          DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox, "X" );
     AddFieldProc( 0, PNFLD_REPRISK_BYVBANK,       DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox, "X" );
     AddFieldProc( 0, PNFLD_REPRISK_BYSECUR,       DL_PNFLD_CHECKBOX,  @DL_FldProc_CheckBox, "X" );
  END;

  PRIVATE MACRO Check():BOOL
     var i = PNFLD_REPRISK_BYFISSKO;
     while (i <= PNFLD_REPRISK_BYSECUR)
      if(m_Panel.(i) == SET_CHAR) 
	     return true; 
	  end;
      i = i + 1;
     end;
     msgbox("Необходимо выбрать хотя бы один из модулей для формирования отчёта.");
      return false;
  END;

  initDL_CPanel( "dv.lbr", "REPRISK" );
END;