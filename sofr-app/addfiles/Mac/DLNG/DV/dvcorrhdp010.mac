/*
$Name:        dvcorrhdp010.mac
$Module:      Производные инструменты
$Description: Корректировка РХДП. Шаг: Расчет сумм корректировок РХДП 
*/
IMPORT InsCarryDoc, RsbDataSet, "dvservop.mac", "dv_car.mac", dvinter, "dvopcorrhdprep.mac", "u_common_email_utils.mac";

VAR SvOpDL_COMM = TRecHandler("dl_comm");

private macro SaveFileToAppServ(filepath:string, FileName):string
    
  if(not isStandAlone()) // когда мы на терминале, копируем файл на СП     
    var path_appserv = "..\\workfile\\" + FileName;
      
    if(not CopyFile("$" + filepath, path_appserv, true, "Копируется файл на сервер приложений..."))
      msgbox("Ошибка при передаче файла на сервер приложений");
    end;
      filepath = path_appserv;
  end;
    
  return filepath;
end;

Private macro Send(attach:string)
   var email = c_email_proc_env();
   var FileName, ExtName;
   var tittle = "", message = "";
   splitfile(attach, FileName, ExtName);
   FileName = FileName + ExtName;
   tittle = "Внимание! Хеджирование. Корректировка РХДП. " + FileName;
   message = "Сообщение отправлено автоматически. Выполнен расчет сумм корректировок в файл " + FileName;
   email.m_set_msg_head(tittle);
   email.m_add_row_to_msg_text(message);
   attach = SaveFileToAppServ(attach, FileName);
   email.m_add_attach_to_list(attach);
   email.m_save_to_submit_grp(31/* HedgGroup */);
   email.m_submit_email_synch();
End;

MACRO ExecuteCaseStep(  Kind_Operation, Number_Step, FDoc, KindDoc )
  record Comm( dl_comm );
  SetBuff( Comm, FDoc );
  var attachPath = "";

  var cmd = RsdCommand("{CALL RSB_Derivatives.FillHdgCorRHDPTable(?, ?, ?) }");

  cmd.addParam("", RSDBP_IN, Comm.DocumentID );
  cmd.addParam("", RSDBP_IN, Comm.CommDate );
  cmd.addParam("", RSDBP_IN, IIF(Comm.Deal1 > 0, Comm.Deal1, -1) );
      
  SQL_Execute( cmd, "Выполняется расчет сумм корректировок РХДП", true );

  if (Comm.CreateReport == SET_CHAR)
    CorRHDPPrintProtocol(Comm.DocumentID, @attachPath);
    Send(attachPath);
    return "20"; // Шаг без автовыполнения
  else
    return "21"; // Шаг с автовыполнения
  end;
END;
