/*
$Name:        dvfxmet150.mac
$Module:      Производные инструменты
$Description: Покупка/Продажа слитков. Шаг "Перенос обязательств на просрочку"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

private macro DV_ПроверитьСуществованиеШага(ID_Operation, Symb, IsExecute)
  var cmd = DL_RSDCommand();
   var query = " SELECT COUNT(1) AS CountStep " +
    "   FROM doprstep_dbt step" +
    "  WHERE step.t_ID_Operation = ? AND " +
    "        step.t_Symbol       = ? AND " +
    "        step.t_IsExecute    = ? ";
  cmd.AddParam(ID_Operation);
  cmd.AddParam(Symb);
  cmd.AddParam(IsExecute);
  var DataSet = cmd.Execute(query);
  DataSet.moveNext();
  return DataSet.CountStep;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dvndeal);
  var FD;
  var ДатаИсполненияШага = {curdate};

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  if(FD.nFI.rec.OperState == DL_LEG_OUTBAL)
    MsgBox("Перенос на просрочку можно выполнять только после установки обязательств на баланс.");
    return 1;
  end;

  if( DV_ПроверитьСуществованиеШага(ID_Operation, "Т", "X") OR DV_ПроверитьСуществованиеШага(ID_Operation, "Б", "X"))
    MsgBox("Перенос на просрочку можно выполнять только до исполнения Т/О.");
    return 1;
  end;

  if( not ПроводкаПоКатегориямУчета( FD,
                                           "-Форвард, РПИ", "Обяз. с н.с.",
                                           ДатаИсполненияШага,
                                           1,
                                           FD.ВалютаКонтрАктива(), FD.nFI.rec.Cost,
                                           doc,
                                           INPCARRY, "", "",
                                           "Перенос суммы обязательств на просрочку сделки "+FD.DealCode(),
                                           null,
                                           FIROLE_FICOM, null, FD.ВалютаКонтрАктива(), FD.ВалютаКонтрАктива())
    )
      return 1;
  end;

  return 0;
end;
