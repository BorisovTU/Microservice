import "dvrepfun.mac";
import "dvRepFun2.mac";
import RsbDataSet;
import "or_rep_h.mac", "globals.mac";

const FontStyleTitel =  "ex_FS(b)";
/* FIID валюты в которой происходит отображение сумм */
const RUR = 0;

var IsApp, DateStart, DateEnd;
var MarketDeal;

var TableHead = "┌────┬───────────────────────────────────────────────────┬─────────────────────────┬─────────────────────────┐\n" +
                "│ №  │              Наименование показателя              │    Сделки по покупке    │    Сделки по продаже    │\n" +
                "│    │                                                   │       (тыс." + string({CCYNatCur}:5) + ".)      │        (тыс." + string({CCYNatCur}:5) + ".)     │\n" +
                "├────┼───────────────────────────────────────────────────┼─────────────────────────┼─────────────────────────┤";


var Rep = CMakeReport(TableHead);

private macro ПечатьЗаголовка()
                       
[                                          
                                          ОТЧЕТ
                       СВЕДЕНИЯ О СДЕЛКАХ С ЦЕННЫМИ БУМАГАМИ
];
end;

macro ReportHead( Period, Year )

   Rep.AddPrintCell("СВЕДЕНИЯ О СДЕЛКАХ С ЦЕННЫМИ БУМАГАМИ, СОВЕРШЕННЫХ ПРОФЕССИОНАЛЬНЫМ УЧАСТНИКОМ", Rep.GetHeaderWidth(), 0, "c:" + FontStyleTitel, REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell("за " + PeriodName_GetMonthsAndQuart( Period, Year ), Rep.GetHeaderWidth(), 0, "c:" + FontStyleTitel, REP_ELEM_STR);
   Rep.AddStr();
end;

macro PrintLine( Str:string, Name:string, SumBuy:money, SumSale:money, Frmt:string )
   Rep.AddPrintCell( Str, 0, 0, "l:" + FontStyleTitel );
   Rep.AddPrintCell( Name, 0, 0, Frmt );
   if( SumBuy or SumSale )
      if( IsApp ) 
         Rep.AddPrintCell(SumBuy, 0, 0, "14:5:a:c");
         Rep.AddPrintCell(SumSale, 0, 0, "14:5:a:c");
      else
         Rep.AddPrintCell(SumBuy, 0, 0, "14:5:c");
         Rep.AddPrintCell(SumSale, 0, 0, "14:5:c");
      end;
   else
      Rep.AddPrintCell(" ", 0, 0, "c");
      Rep.AddPrintCell(" ", 0, 0, "c");
   end;
   Rep.AddStr();
end;

macro ПолучитьДанныеПоБиржевымСделкам()
  var sqlQuery;
/* Создаем SQL запрос для того чтобы в один прием выгрести все данные для отчета. */

   sqlQuery = RSDCommand("SELECT MarketDVDeal.T_AMOUNT, MarketDVDeal.T_PRICE, MarketDVDeal.T_PRICEFIID, " +
              "      (MarketDVDeal.T_AMOUNT * MarketDVDeal.T_PRICE) CostDeal, " +
              "       MarketDVDeal.T_KIND, " +
              "       ContrFI.T_ISSUER, " +
              "       ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER ) IssuerName " +
              "  FROM ddvdeal_dbt MarketDVDeal, dfininstr_dbt ContrFI " +
              " WHERE MarketDVDeal.T_STATE = 2 and " +
              "       ContrFI.T_FIID = MarketDVDeal.T_FIID " +
              "       and MarketDVDeal.T_KIND <> ? " +
              "       and MarketDVDeal.T_KIND <> ? " +
              "       and MarketDVdeal.T_DATE >= ? " +
              "       and MarketDVdeal.T_DATE <= ? " + 
              "ORDER BY ContrFI.T_ISSUER;");

   query.addParam( "", RSDBP_IN, EXEC_F );
   query.addParam( "", RSDBP_IN, EXEC_O );
   query.addParam( "", RSDBP_IN, DateStart );
   query.addParam( "", RSDBP_IN, DateEnd );
   query.execute();
   
   MarketDeal = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
   MarketDeal.MoveLast();
   return MarketDeal.GetRecCount();
end;

/* расчет осуществляется только по биржевым сделкам
   Организатор торгов = Эмитент ПИ     */
macro РасчитатьДляОрганизаторов()
  var IsNotEof;
  var SumBuy = $0, SumSale = $0;
  var SumConv = $0;
  var Пункт = 1;
  var Issuer, IssuerName;

   IsNotEof = MarketDeal.MoveFirst();
   while( IsNotEof )
      Issuer = MarketDeal.Issuer;
      IssuerName = MarketDeal.IssuerName;
      SumBuy = $0;
      SumSale = $0;
      SumConv = $0;
      while( (Issuer == MarketDeal.Issuer) and IsNotEof )
          if( MarketDeal.PriceFIID == RUR )
             if( MarketDeal.Kind == BUY_DEAL_F )
                 SumBuy = SumBuy + MarketDeal.CostDeal;
             else
                 SumSale = SumSale + MarketDeal.CostDeal;
             end;
          else
             DV_SmartConvertSum( SumConv, MarketDeal.CostDeal, {curdate}, MarketDeal.PriceFIID, RUR );
             if( MarketDeal.Kind == BUY_DEAL_F )
                 SumBuy = SumBuy + SumConv;
             else
                 SumSale = SumSale + SumConv;
             end;
          end;
          IsNotEof = MarketDeal.MoveNext();
      end;
      PrintLine("1."+String(Пункт), IssuerName, Money(SumBuy/1000.0), Money(SumSale/1000.0), "r" );
      Пункт = Пункт + 1;
   end;
end;

/*  Пока реализован только расчет с биржевими сделками 
    нужно будет добавить внебиржевые*/
macro РасчитатьОбщиеСуммы()
  var IsNotEof;
  var SumBuy = $0, SumSale = $0;
  var SumMarketBuy = $0, SumMarketSale = $0;
  var SumOutMarketBuy = $0, SumOutMarketSale = $0;
  var SumConv = $0;
   IsNotEof = MarketDeal.MoveFirst();
   while( IsNotEof )
      if( MarketDeal.PriceFIID == RUR )
         if( MarketDeal.Kind == BUY_DEAL_F )
             SumBuy = SumBuy + MarketDeal.CostDeal;
         else
             SumSale = SumSale + MarketDeal.CostDeal;
         end;
      else
         DV_SmartConvertSum( SumConv, MarketDeal.CostDeal, {curdate}, MarketDeal.PriceFIID, RUR );
         if( MarketDeal.Kind == BUY_DEAL_F )
             SumBuy = SumBuy + SumConv;
         else
             SumSale = SumSale + SumConv;
         end;
      end;
      IsNotEof = MarketDeal.MoveNext();
   end;

   SumMarketBuy = SumBuy;
   SumMarketSale = SumSale;

   /* Сдесь должны быть внебиржевые сделки */


   PrintLine(" ", "Совершенные сделки - всего", Money(SumBuy/1000.0), Money(SumSale/1000.0), "l" + FontStyleTitel );
   PrintLine("1", "Сделки, совершенные через организатора\n" +
                  "торговли, - всего", Money(SumMarketBuy/1000.0), Money(SumMarketSale/1000.0), "r");
   PrintLine(" ", "- в том числе по организаторам\n" +
                  "торговли", NULL, NULL, "r" );
   РасчитатьДляОрганизаторов();
   PrintLine("2", "Сделки, совершенные на внебиржевом рынке", Money(SumOutMarketBuy/1000.0), Money(SumOutMarketSale/1000.0), "r");
end;

macro ReportRun( _Period:integer, _Year:integer, _IsApp:bool, _IsExcel:bool )

   IsApp = _IsApp;
   Period_GetInterval( _Period, _Year, @DateStart, @DateEnd );

   if( ПолучитьДанныеПоБиржевымСделкам() != 0 )
      ReportHead( _Period, _Year );
      РасчитатьОбщиеСуммы();
      after_44_footer( Rep );

      if( _IsExcel )
         Rep.PrintWinRep();
         Rep.ShowWinRep();
      else
         Rep.PrintRep();
      end;
   else
     if ( not _IsExcel )
      ПечатьЗаголовка();
      PrintLn("\nНе найдено данных для формирования отчета.");
     else
       MsgBox( "Не найдено данных для формирования отчета.");
     end;
   end;

end;
