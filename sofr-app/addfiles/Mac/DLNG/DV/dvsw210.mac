/*
$Name:        dvsw210.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг: Исполнение без поставки 2ч
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";
import dv_carchng;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  VAR ДатаИсполненияШага, FD;
  var ДатаПланируемаяШага = DV_GetPlanDateStep(ID_Operation, ID_Step);

  SetBuff( ndeal, FDoc );

  FD = DVFirstDocNDeal(DocKind, ndeal, 2);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;
  ДатаИсполненияШага = FD.ДатаИсполнения();

  if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
     if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  if( not FD.ВыполненУчетВариационнойМаржи( ДатаИсполненияШага ) )
     if( MsgBoxEx( "Не выполнен расчет вариационной маржи!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  if( not FD.IsClient() )
     if( СписаниеССПриПрекращенииПризнания( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;

     if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;

     if( ОтнесениеФинРезультата( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND_2(), DV_OPERSTATUS_DL_COMPLETE) )
     MsgBox("Ошибка при установке статуса <Требования 2ч> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_LIABILITY_2(), DV_OPERSTATUS_DL_COMPLETE) )
     MsgBox("Ошибка при установке статуса <Обязательства 2ч> по операции.");
     return 1;
  end;

  if(((FD.IsSWAPNDeal()) or (FD.IsPctSWAP())) and (РАБОТА_С_РЕПОЗИТАРИЕМ()) and (ДатаПланируемаяШага > {curdate}))
    if(ИзменениеСостоянияОбязательств_ДосрочноеИсполнение(FD, {curdate}, DocKind) )
       return 1;
    end;
  end;

  return 0;
end;
