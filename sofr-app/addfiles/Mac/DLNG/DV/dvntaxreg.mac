/*
$Name:        dvntaxreg.mac
$Module:      Производные инструменты
$Description: Отчет "Налоговый регистр по сделкам КО и внебиржевым ПИ"
*/
IMPORT DVInter, "DLReport_h.mac", "dvntaxreg_form.mac", "dvRepFun.mac", "DvRepFun2.mac", "dv_categ.mac", "dldlngfun.mac", "dv_car.mac";

private var m_Form = DV_NTaxReg_Panel();
PRIVATE CONST GREYCOLOR = RGB(192,192,192);

PRIVATE CONST REDCOLOR_N = RGB(0,0,255); // BGR
PRIVATE CONST GREYCOLOR_N = RGB(217,217,217);

PRIVATE CONST НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_rshb = 13;
PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb = 14;
private const NoDataTxt = "ДАННЫХ НЕТ";

private const dvcalc = "\"Расчетный\"";
private const dvstate = "\"Поставочный\"";
private const N3_ItogTxt = "ИТОГО";

private const FISection_Currency = 1;
private const FISection_Metal = 4;
private const FISection_End = 6;

//Категории учёта
PRIVATE CONST КатПлПФИ        = "+ПФИ";
PRIVATE CONST КатМнПФИ        = "-ПФИ";
PRIVATE CONST КатДохПФИ       = "Доходы ПФИ";
PRIVATE CONST КатДохПФИ_usr   = "Доходы ПФИ0"; /*PNV 524629*/
PRIVATE CONST КатРсхПФИ       = "Расходы ПФИ";
PRIVATE CONST КатРсхПФИ_usr   = "Расходы ПФИ0"; /*PNV 524629*/
PRIVATE CONST КатПлМаржаИВиДМ = "+Маржа, ИВ и ДМ";
PRIVATE CONST КатМнМаржаИВиДМ = "-Маржа, ИВ и ДМ";
PRIVATE CONST КатПлФрвРПИ     = "+Форвард, РПИ";
PRIVATE CONST КатМнФрвРПИ     = "-Форвард, РПИ";
PRIVATE CONST КатВыбПФИ       = "Выбытие ПФИ";
PRIVATE CONST КатПлФрвРасч    = "+Форвард, расчеты";
PRIVATE CONST КатМнФрвРасч    = "-Форвард, расчеты";

PRIVATE VAR ReportHeader =
"\nФилиал:#\n" +
"          Доходы (расходы) от операций с внебиржевыми производными инструментами\n" +
" за период с ########## по ##########\n" +
" Направление сделок:   #\n" +
" Вид контракта:        #\n" +
" Вид исходного актива: #\n";

PRIVATE VAR TableHeader1 =
"┌───────────────────┬──────────────────┬────────────────────┬────────────────────┬───────────────────────────────┬───────────────────────────────┬────────────────────┬────────────────────┬────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬─────────────────────────────────┬──────────────────────────────────────────┬────────────────────┬────────────────────┬─────────────────────────┬──────────────────────┬──────────────────────┬─────────────────────────┬──────────────────────┬──────────────────────┬──────────────────────────┐\n"+
"│                   │                  │                    │                    │                               │                               │                    │                    │                    │                     │                     │                     │                    │                    │                    │                    │     Сумма полученной(+) /       │                                          │                    │                    │                         │                      │                      │                         │                      │                      │                          │\n"+
"│                   │                  │                    │                    │         Базовый актив         │         Исходный актив        │                    │                    │                    │                     │                     │                     │                    │                    │                    │                    │ уплаченной(-) вариационной маржи│ Финансовый результат (в отчетном периоде)│                    │                    │                         │                      │                      │                         │                      │                      │                          │\n"+
"│                   │                  │                    │                    │                               │                               │   Дата исполнения  │   Сумма сделки в   │    Наименование    │ Курс базовой валюты │     Курс ЦБ РФ      │     Курс ЦБ РФ      │                    │     Курс спот      │     Курс ЦБ РФ     │     Курс ЦБ РФ     │                                 │                                          │   Налоговая база   │                    │                         │ Доходы(+)/Расходы(-) │  Доходы(+)/Расходы(-)│      Остаток по сч      │     Остаток по сч    │ Доходы(+)/Расходы(-) │                          │\n"+
"│  Дата заключения  │   Номер сделки   │ Направление сделки │    Вид контракта   ├───────────────┬───────────────┼───────────────┬───────────────┤                    │                    │                    │  на дату заключения │   базовой валюты    │  валюты исполнения  │  Валюта исполнения │   в соответствии   │   базовой валюты   │  валюты исполнения ├────────────────┬────────────────┤─────────────────────┬────────────────────┤(в отчётном периоде)│ Признак исполнения │     Тип исполнения      │    отражённые в      │     отражённые в     │    52601(+)/52602(-)    │   52601(+)/52602(-)  │    учтённые в НОБ    │   Внешний номер сделки   │\n"+
"│      сделки       │                  │       (B/S)        │     (форвард)      │               │               │               │               │       сделки       │   базовой валюте   │    контрагента     │       сделки        │  на дату заключения │  на дату заключения │       сделки       │  с Соглашением о   │      на дату       │      на дату       │                │                │                     │                    │                    │ контракта (да/нет) │ (расчетный/поставочный) │ бухгалтерском учёте  │  бухгалтерском учётё │       на начало ОП      │     на конец ОП      │     в предыдущих     │                          │\n"+
"│                   │                  │                    │                    │      код      │  наименование │     код       │  наименование │                    │                    │                    │                     │       сделки        │       сделки        │                    │     неттинге       │  исполнения сделки │  исполнения сделки │    в валюте    │    в рублях    │        Доход        │       Расход       │                    │                    │                         │в отчётном (налоговом)│     в предыдущем     │                         │                      │  налоговых периодах  │                          │\n"+
"│                   │                  │                    │                    │               │               │               │               │                    │                    │                    │                     │                     │                     │                    │                    │                    │                    │                │                │                     │                    │                    │                    │                         │      периоде         │   налоговом периоде  │                         │                      │                      │                          │\n"+
"│                   │                  │                    │                    │               │               │               │               │                    │                    │                    │                     │                     │                     │                    │                    │                    │                    │                │                │                     │                    │                    │                    │                         │                      │                      │                         │                      │                      │                          │\n"+
"├───────────────────┼──────────────────┼────────────────────┼────────────────────┼───────────────┼───────────────┼───────────────┼───────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────┼────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────┼──────────────────────────┤\n"+
"│        1          │        1.1       │         2          │         3          │       4       │       5       │       6       │       7       │         8          │          9         │         10         │         11          │         12          │         13          │         14         │         15         │         16         │         17         │       18       │       19       │         20          │         21         │         22         │         23         │           24            │          25          │          26          │            27           │          28          │          29          │            30            │\n"+
"├───────────────────┼──────────────────┼────────────────────┼────────────────────┼───────────────┼───────────────┼───────────────┼───────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────┼────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────┼──────────────────────────┤";

PRIVATE VAR TableHeader5 =
"┌───────────────────┬──────────────────┬────────────────────┬────────────────────┬────────────────────┬───────────────────────────────┬────────────────────┬───────────────────────────────┬────────────────────┬───────────────────────────────┬────────────────────┬────────────────────┬─────────────────────┬─────────────────────┬────────────┬─────────────────────────────────┬─────────────────────┬─────────────────────────────────┬────────────────────┬─────────────────────────────────┬────────────────────┬─────────────────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬─────────────────────────┬──────────────────────┬────────────────────────┬────────────────────────┬─────────────────────────┬──────────────────────┬──────────────────────────┐\n"+
"│                   │                  │                    │                    │                    │                               │                    │                               │                    │                               │                    │                    │                     │                     │            │     Сумма полученной(+) /       │                     │                                 │                    │             Сумма               │                    │                                 │                    │                    │                    │                    │                         │                      │                        │                        │                         │                      │                          │\n"+
"│                   │                  │                    │                    │                    │        Базовая валюта         │                    │      Сопряжённая валюта       │                    │          Тип опциона          │                    │                    │                     │                     │            │ уплаченной(-) вариационной маржи│                     │         Валюта премии           │                    │   полученной(+)/уплаченной(-)   │                    │      Финансовый результат       │                    │                    │                    │                    │     Требования(+) /     │    Требования(+)     │  Доходы(+)/Расходы(-)  │  Доходы(+)/Расходы(-)  │                         │                      │                          │\n"+
"│                   │                  │                    │                    │                    │                               │                    │                               │  Сумма опциона в   │                               │   Дата истечения   │  Дата исполнения   │ Курс базовой валюты │ Курс базовой валюты,│   Валюта   │                                 │   Дата расчётов по  │                                 │ Курс валюты премии │             премии              │    Доход/Расход    │      (в отчётном периоде)       │   Налоговая база   │ Признак исполнения │   Тисп исполнения  │Доходы(+)/расходы(-)│     Обязательства(-)    │   Обязательства(-)   │      по опциону        │      по опциону        │      Остаток по сч      │     Остаток по сч    │                          │\n"+
"│  Дата заключения  │   Номер сделки   │    Наименование    │ Направление сделки │   Вид контракта    ├───────────────┬───────────────┤   Сумма опциона    ├───────────────┬───────────────┤ сопряжённой валюте ├───────────────┬───────────────┤   срока действия   │     опциона,       │    по контракту     │ установленный ЦБ РФ │  платежа   ├────────────────┬────────────────┤       премии        ├────────────────┬────────────────┤     по опциону,    ├────────────────┬────────────────┤  от купли/продажи  ├────────────────┬────────────────┤(в отчётном периоде)│     контракта      │     (расчётный/    │  учтённые в НОБ    │    по опциону (руб.)    │  по опциону (руб.)   │(справедливая стоимость)│(справедливая стоимость)│    52601(+)/52602(-)    │   52601(+)/52602(-)  │   Внешний номер сделки   │\n"+
"│     опциона       │                  │    контрагента     │       (B/S)        │                    │               │               │        в           │               │               │      по курсу      │               │               │     контракта      │  определённая при  │                     │  на дату исполнения │вариационной│                │                │                     │                │                │ установленный ЦБ РФ│                │                │   базового актива  │                │                │                    │     (да/нет)       │     поставочный)   │предыдущих периодов │ за предыдущие налоговые │  за отчетный период  │    отражённые в БУ     │    отражённые в БУ     │       на начало ОП      │     на конец ОП      │                          │\n"+
"│                   │                  │                    │                    │                    │      код      │  наименование │  базовой валюте    │     код       │  наименование │    по контракту    │ европейский / │   call/put    │                    │заключении контракта│                     │       опциона       │   маржи    │    в валюте    │    в рублях    │                     │      код       │  наименование  │ на дату расчётов по│    в валюте    │    в рублях    │       в руб.       │     Доход      │     Расход     │                    │                    │                    │                    │        периоды          │                      │     в предыдущих       │       в отчётном       │                         │                      │                          │\n"+
"│                   │                  │                    │                    │                    │               │               │                    │               │               │                    │ американский  │               │                    │                    │                     │                     │            │                │                │                     │                │                │       премии       │                │                │                    │                │                │                    │                    │                    │                    │                         │                      │   налоговых периодах   │        периоде         │                         │                      │                          │\n"+
"│                   │                  │                    │                    │                    │               │               │                    │               │               │                    │               │               │                    │                    │                     │                     │            │                │                │                     │                │                │                    │                │                │                    │                │                │                    │                    │                    │                    │                         │                      │                        │                        │                         │                      │                          │\n"+
"├───────────────────┼──────────────────┼────────────────────┼────────────────────┼────────────────────┼───────────────┼───────────────┼────────────────────┼───────────────┼───────────────┼────────────────────┼───────────────┼───────────────┼────────────────────┼────────────────────┼─────────────────────┼─────────────────────┼────────────┼────────────────┼────────────────┼─────────────────────┼────────────────┼────────────────┼────────────────────┼────────────────┼────────────────┼────────────────────┼────────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼──────────────────────┼────────────────────────┼────────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────────┤\n"+
"│        1          │        1.1       │         2          │         3          │         4          │       5       │       6       │         7          │       8       │       9       │         10         │      11       │      12       │         13         │         14         │         15          │          16         │    16.1    │      16.2      │      16.3      │         17          │       18       │       19       │         20         │       21       │       22       │        22.1        │       23       │       24       │         25         │         26         │         27         │         28         │          29             │         30           │          31            │          32            │            33           │         34           │            35            │\n"+
"├───────────────────┼──────────────────┼────────────────────┼────────────────────┼────────────────────┼───────────────┼───────────────┼────────────────────┼───────────────┼───────────────┼────────────────────┼───────────────┼───────────────┼────────────────────┼────────────────────┼─────────────────────┼─────────────────────┼────────────┼────────────────┼────────────────┼─────────────────────┼────────────────┼────────────────┼────────────────────┼────────────────┼────────────────┼────────────────────┼────────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼──────────────────────┼────────────────────────┼────────────────────────┼─────────────────────────┼──────────────────────┼──────────────────────────┤";


PRIVATE VAR TableHeader2 =
"┌───────────────────┬──────────────────┬──────────────────────────┬────────────────────┬─────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬──────────────────────────────────────────┬────────────────────┬────────┬─────────────────────────────────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬──────────────────────────────────────────┬────────────────────┬──────────────────────────────────────────┬────────────────────┬─────────────────────────┬─────────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────────┬─────────────────────────┬─────────────────────────┬──────────────────────────┐\n"+
"│                   │                  │                          │                    │             │                    │                    │                    │                    │                                          │                    │        │     Сумма полученной(+) /       │                    │                    │                    │                    │                                          │                    │                                          │                    │                         │                         │                     │                     │                     │                         │                         │                         │                          │\n"+
"│                   │                  │                          │                    │             │                    │                    │                    │                    │       На дату исполнения 1 части         │                    │ Валюта │ уплаченной(-) вариационной маржи│                    │                    │                    │                    │       На дату исполнения 2 части         │                    │ Финансовый результат (в отчетном периоде)│                    │                         │                         │                     │                     │                     │                         │                         │                         │                          │\n"+
"│                   │                  │                          │                    │             │                    │                    │                    │                    │                                          │  Курс ЦБ РФ валюты │ платежа│                                 │                    │                    │                    │                    │                                          │  Курс ЦБ РФ валюты │                                          │   Налоговая база   │                         │   Доходы(+)/Расходы(-), │Доходы(+)/Расходы(-),│Доходы, отраженные в │Расходы, отраженные в│  Доходы(+)/Расходы(-),  │                         │                         │                          │\n"+
"│  Дата заключения  │   Номер сделки   │ Наименование контрагента │ Направление сделки │ Код базовой │   Сумма сделки в   │   Дата исполнения  │    Курс 1 части    │ Сумма контрактива  ├─────────────────────┬────────────────────┤    исполнения на   │ вариа- ├────────────────┬────────────────┤     Код валюты     │   Дата исполнения  │    Курс 2 части    │ Сумма контрактива  ├─────────────────────┬────────────────────┤ исполнения на дату ├─────────────────────┬────────────────────┤(в отчётном периоде)│     Тип исполнения      │     учтённые в НОБ в    │    отраженные в     │ бухгалтерском учете │ бухгалтерском учете │       отраженные        │      Остаток по сч      │      Остаток по сч      │   Внешний номер сделки   │\n"+
"│      сделки       │                  │                          │                    │    валюты   │   базовой валюте   │       1 части      │       сделки       │     по 1 части     │                     │                    │    дату 1 части    │ ционной│                │                │     исполнения     │       2 части      │       сделки       │     по 2 части     │                     │                    │   2 части сделки   │                     │                    │                    │ (расчетный/поставочный) │   предыдущих налоговых  │бухгалтерском учете в│     в отчетном      │     в отчетном      │  в бухгалтерском учёте  │    52601(+)/52602(-)    │    52601(+)/52602(-)    │                          │\n"+
"│                   │                  │                          │                    │             │                    │                    │                    │                    │    Курс ЦБ РФ       │ Стоимость базовой  │       сделки       │ маржи  │     в валюте   │    в рублях    │                    │                    │                    │                    │    Курс ЦБ РФ       │ Стоимость базовой  │                    │        Доход        │       Расход       │                    │                         │        пероидах         │отчетном (налоговом) │ (налоговом) периоде │ (налоговом) периоде │ в предыдущем налоговом  │      на начало ОП       │      на конец ОП        │                          │\n"+
"│                   │                  │                          │                    │             │                    │                    │                    │                    │   базовой валюты    │  валюты в рублях   │                    │        │                │                │                    │                    │                    │                    │   базовой валюты    │  валюты в рублях   │                    │                     │                    │                    │                         │                         │периоде(70613/70614) │       (70601)       │       (70606)       │  периоде (70613/70614)  │                         │                         │                          │\n"+
"│                   │                  │                          │                    │             │                    │                    │                    │                    │                     │    по курсу ЦБ     │                    │        │                │                │                    │                    │                    │                    │                     │    по курсу ЦБ     │                    │                     │                    │                    │                         │                         │                     │                     │                     │                         │                         │                         │                          │\n"+
"├───────────────────┼──────────────────┼──────────────────────────┼────────────────────┼─────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────┼────────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────────────────┤\n"+
"│        1          │        1.1       │             2            │         3          │      4      │         5          │         6          │         7          │         8          │         9           │         10         │         11         │  11.1  │       12       │       13       │         14         │         15         │         16         │         17         │         18          │         19         │         20         │         21          │         22         │         23         │            24           │           25            │         26          │        26.1         │         26.2        │            27           │            28           │           29            │            30            │\n"+
"├───────────────────┼──────────────────┼──────────────────────────┼────────────────────┼─────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼────────┼────────────────┼────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┼─────────────────────────┼─────────────────────────┼─────────────────────────┼──────────────────────────┤";

PRIVATE VAR TableHeader3 =
"┌───────────────────┬──────────────────┬───────────────────────┬────────────────────┬──────────────────────┬────────────────────┬───────────────────────────────────────────────┬───────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────┬────────────────────┬──────────────────┬───────────────────────┬────────────────────┬──────────────────────┬────────────────────────┬────────────────────────┬──────────────────────┬──────────────────────┬──────────────────────────┐\n"+
"│                   │                  │                       │                    │                      │                    │                                               │                                               │                                                                                                        │                                                                                                        │        Финансовый результат        │                    │                  │                       │                    │                      │                        │                        │                      │                      │                          │\n"+
"│                   │                  │                       │                    │    Дата окончания    │                    │          Привлечённый условный депозит        │          Размещённый условный депозит         │                                    Привлечённый условный депозит                                       │                                     Размещённый условный депозит                                       │        (в отчётном периоде)        │                    │                  │                       │   Требования(+) /  │    Требования(+) /   │  Доходы(+)/Расходы(-)  │  Доходы(+)/Расходы(-)  │                      │                      │                          │\n"+
"│                   │                  │                       │                    │       сделки /       │     Тип ставки     │                                               │                                               │                                                                                                        │                                                                                                        │                                    │  Налогооблагаемая  │  Тип исполнения  │Доходы (+)/Расходы (-),│ Обязательства (-), │  Обязательства (-),  │       по сделке        │       по сделке        │    Остаток по сч.    │    Остаток по сч.    │                          │\n"+
"│  Дата заключения  │   Номер сделки   │      Наименование     │     Дата начала    │   Дата соглашения о  │   (привлечённый /  ├─────────────┬───────────────────┬─────────────┼─────────────┬───────────────────┬─────────────┼─────────────┬───────────────────┬────────────────┬────────────────┬───────────────────┬────────────────┼─────────────┬───────────────────┬────────────────┬────────────────┬───────────────────┬────────────────┼───────────────────┬────────────────┤        база        │   (расчётный /   │    учтённые в НОБ     │   выплаченные по   │    выплаченные по    │(справедливая стоимость)│(справедливая стоимость)│ 52601 (+) / 52602(-) │ 52601 (+) / 52602(-) │   Внешний номер сделки   │\n"+
"│      сделки       │                  │      контрагента      │       сделки       │     расторжении      │    размещённый)    │             │                   │             │             │                   │             │ Дата начала │   Дата окончания  │      Дата      │      Сумма     │    Курс валюты,   │      Сумма     │ Дата начала │   Дата окончания  │      Дата      │      Сумма     │    Курс валюты,   │      Сумма     │                   │                │(в отчётном периоде)│   поставочный)   │  предыдущих периодов  │ сделке предыдущих  │   сделке отчётного   │    отражённые в БУ     │    отражённые в БУ     │    на начало ОП      │     на конец ОП      │                          │\n"+
"│                   │                  │                       │                    │       сделки         │                    │  Код валюты │  Сумма депозита,  │   Ставка,   │  Код валюты │  Сумма депозита,  │   Ставка,   │ процентного │    процентного    │ промежуточного │     платежа    │   установленный   │     платежа    │ процентного │    процентного    │ промежуточного │     платежа    │   установленный   │     платежа    │       Доход       │     Расход     │                    │                  │                       │   периодов (руб)   │     периода (руб)    │ в предыдущих нагоговых │  в отчётном периоде    │                      │                      │                          │\n"+
"│                   │                  │                       │                    │                      │                    │             │     в валюте      │  % годовых  │             │     в валюте      │  % годовых  │   периода   │      периода      │     платежа    │    в валюте    │   ЦБ РФ на дату   │    в рублях    │   периода   │      периода      │     платежа    │    в валюте    │   ЦБ РФ на дату   │    в рублях    │                   │                │                    │                  │                       │                    │                      │  периодах (справочно)  │                        │                      │                      │                          │\n"+
"│                   │                  │                       │                    │                      │                    │             │                   │             │             │                   │             │             │                   │                │                │ платежа, в рублях │                │             │                   │                │                │ платежа, в рублях │                │                   │                │                    │                  │                       │                    │                      │                        │                        │                      │                      │                          │\n"+
"├───────────────────┼──────────────────┼───────────────────────┼────────────────────┼──────────────────────┼────────────────────┼─────────────┼───────────────────┼─────────────┼─────────────┼───────────────────┼─────────────┼─────────────┼───────────────────┼────────────────┼────────────────┼───────────────────┼────────────────┼─────────────┼───────────────────┼────────────────┼────────────────┼───────────────────┼────────────────┼───────────────────┼────────────────┼────────────────────┼──────────────────┼───────────────────────┼────────────────────┼──────────────────────┼────────────────────────┼────────────────────────┼──────────────────────┼──────────────────────┼──────────────────────────┤\n"+
"│        1          │       1.1        │           2           │         3          │           4          │         5          │      6      │         7         │      8      │      9      │         10        │      11     │      12     │         13        │       14       │       15       │         16        │        17      │      18     │         19        │       20       │       21       │         22        │        23      │         24        │        25      │         26         │        27        │          28           │         29         │          30          │           31           │           32           │          33          │          34          │            35            │\n"+
"├───────────────────┼──────────────────┼───────────────────────┼────────────────────┼──────────────────────┼────────────────────┼─────────────┼───────────────────┼─────────────┼─────────────┼───────────────────┼─────────────┼─────────────┼───────────────────┼────────────────┼────────────────┼───────────────────┼────────────────┼─────────────┼───────────────────┼────────────────┼────────────────┼───────────────────┼────────────────┼───────────────────┼────────────────├────────────────────┼──────────────────┼───────────────────────┼────────────────────┼──────────────────────┼────────────────────────┼────────────────────────┼──────────────────────┼──────────────────────┼──────────────────────────┤";

PRIVATE VAR TableHeader4 =
"┌───────────────────┬──────────────────┬──────────────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────────┬────────────────────┬────────────────────┬─────────────────────┬────────────────────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────┬────────────────────┬─────────────────────────┬─────────────────────────┬──────────────────────────┐\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                                                                                                           │                                                                                                         │                    │                    │                    │                     │                                                                                    │          Итого налоговая база            │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │            На дату заключения сделки (на начало налогового периода по длящимся сделкам)                   │            Рыночная цена на дату заключения сделки с однородным ПФИ                                     │                    │                    │                    │                     │                                    На дату исполнения                              │      отчетного (налогового) периода      │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                                                                                                           │                                                                                                         │                    │                    │                    │                     │                                                                                    │                                          │                    │                         │                         │                          │\n"+
"│   Номер тикета    │    Тип сделки    │ Наименование контрагента │  Дата заключения │  Дата исполнения │   Покупка или    │  Базовая валюта  │  Кол-во базовой  │ Валюта расчетов  │ Стоимость исполнения ├────────────────────┬────────────────────┬──────────────────────┬────────────────────┬─────────────────────┼─────────────────────────┬───────────────────┬───────────────────┬────────────────────┬──────────────────┤    Общая сумма     │     Общая сумма    │ Способ расчетов по │ Способ расчетов по  ├────────────────────┬───────────────────┬──────────────────────┬────────────────────┼─────────────────────┬────────────────────┤  Обращение на ОРЦБ │         Доходы от       │       Расходы от        │   Внешний номер сделки   │\n"+
"│                   │                  │                          │      сделки      │      сделки      │     продажа      │     договора     │      валюты      │    по сделке     │   сделки в валюте    │                    │                    │                      │                    │                     │                         │                   │                   │                    │                  │  отклонений цены   │  отклонений цены   │ сделке на момент   │ сделке (условие на  │                    │                   │                      │                    │                     │                    │                    │          не ПФИ         │        не ПФИ           │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │      расчетов        │ Курс ЦБ РФ базовой │ Курс ЦБ РФ валюты  │ Cтоимость исполнения │ Стоимость базовой  │ Цена базовой валюты │  Организатор торговли   │ Min значение цены │ Max значение цены │  Средневзвешенная  │  Расчетная цена  │ исполнения сделки  │ исполнения сделки  │ исполнения:        │ момент заключения): │     Курс ЦБ РФ     │    Курс ЦБ РФ     │ Стоимость исполнения │ Стоимость базовой  │    Всего доходов    │   Всего расходов   │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │   валюты на дату   │ расчетов на дату   │ сделки в рублях -    │ валюты в рублях -  │ по сделке в валюте  │ или источник информации │                   │                   │        цена        │                  │  от рыночной цены  │  от расчетной цены │ реальная поставка  │    поставка или     │   базовой валюты   │  валюты расчетов  │ сделки в рублях -    │ валюты в рублях -  │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │  заключения сделки │ заключения сделки  │ cумма требований     │ сумма обязательств │ расчетов на дату    │ по ценам по аналогичным │                   │                   │                    │                  │                    │                    │ или взаимозачет    │     взаимозачет     │                    │                   │ сумма требований     │ сумма обязательств │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                    │                    │ (обязательств) по    │ (требований) по    │ заключения сделки   │       инструментам      │                   │                   │                    │                  │                    │                    │                    │                     │                    │                   │ (обязательств) по    │ (требований) по    │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                    │                    │ курсу ЦБ валюты      │ поставке базовой   │                     │                         │                   │                   │                    │                  │                    │                    │                    │                     │                    │                   │ курсу ЦБ             │ поставке базовой   │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                    │                    │ расчетов на дату     │ валюты по курсу ЦБ │                     │                         │                   │                   │                    │                  │                    │                    │                    │                     │                    │                   │ валюты расчетов      │ валюты по курсу ЦБ │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                    │                    │ заключения сделки    │ на дату заключения │                     │                         │                   │                   │                    │                  │                    │                    │                    │                     │                    │                   │                      │                    │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                    │                    │                      │      сделки        │                     │                         │                   │                   │                    │                  │                    │                    │                    │                     │                    │                   │                      │                    │                     │                    │                    │                         │                         │                          │\n"+
"│                   │                  │                          │                  │                  │                  │                  │                  │                  │                      │                    │                    │                      │                    │                     │                         │                   │                   │                    │                  │                    │                    │                    │                     │                    │                   │                      │                    │                     │                    │                    │                         │                         │                          │\n"+
"├───────────────────┼──────────────────┼──────────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────────┼────────────────────┼────────────────────┼──────────────────────┼────────────────────┼─────────────────────┼─────────────────────────┼───────────────────┼───────────────────┼────────────────────┼──────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼───────────────────┼──────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼─────────────────────────┼──────────────────────────┤\n"+
"│        1          │        2         │            3             │        4         │        5         │        6         │        7         │        8         │        9         │          10          │          11        │         12         │          13          │         14         │          15         │           16            │         17        │         18        │         19         │        20        │         21         │         22         │         23         │         24          │         25         │         26        │          27          │         28         │         29          │         30         │         31         │            32           │            33           │            34            │\n"+
"├───────────────────┼──────────────────┼──────────────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────────┼────────────────────┼────────────────────┼──────────────────────┼────────────────────┼─────────────────────┼─────────────────────────┼───────────────────┼───────────────────┼────────────────────┼──────────────────┼────────────────────┼────────────────────┼────────────────────┼─────────────────────┼────────────────────┼───────────────────┼──────────────────────┼────────────────────┼─────────────────────┼────────────────────┼────────────────────┼─────────────────────────┼─────────────────────────┼──────────────────────────┤";


private var C_Flag;
private var C_DealDate;
private var C_DealCode;
private var C_Contragent;
private var C_Direction;
private var C_ContractType;
private var C_BaseActiveCode;
private var C_BaseActiveName;
private var C_Qnty;
private var C_InitialActiveCode;
private var C_InitialActiveName;
private var C_QntyInitialActive;
private var C_ExpirationType;
private var C_OptionDirectionType;
private var C_ExpirationDate;
private var C_N5_14;
private var C_ExpirationPriceCur;
private var C_RateBaseCurDateExec;
private var C_MarginCurrCode;
private var C_MarginSumCurr;
private var C_MarginSumRub;
private var C_PremiumDate;
private var C_PremiumCurrency;
private var C_PremiumCurrencyName;
private var C_N5_20;
private var C_PremiumSumCur;
private var C_PremiumSumRub;
private var C_AddCost;
private var C_N5_23;
private var C_N5_24;
private var C_N5_25;
private var C_ExpirationFact;
private var C_N5_27;
private var C_N5_28;
private var C_N5_29;
private var C_N5_30;
private var C_N5_31;
private var C_N5_32;
private var C_N5_33;
private var C_N5_34;
private var C_ExtCode;
private var C_NU_1;
private var C_NU_2;
private var C_NU_3;
private var C_NU_4;
private var C_K_1;
private var C_K_2;

private var C_RateBaseCurDealDate;
private var C_RateExecCurDealDate;
private var C_PriceCurrency;
private var C_RateSpot;
private var C_RateExecCurDateExec;
private var C_MarginCur;
private var C_MarginRub;
private var C_N1_20;
private var C_N1_21;
private var C_N1_22;
private var C_N1_24;
private var C_N1_25;
private var C_N1_26;
private var C_N1_27;
private var C_N1_28;
private var C_N1_29;

private var   C_N2_1;
private var   C_N2_1_1;
private var   C_N2_2;
private var   C_N2_3;
private var   C_N2_4;
private var   C_N2_5;
private var   C_N2_6;
private var   C_N2_7;
private var   C_N2_8;
private var   C_N2_9;
private var   C_N2_10;
private var   C_N2_11;
private var   C_N2_11_1;
private var   C_N2_12;
private var   C_N2_13;
private var   C_N2_14;
private var   C_N2_15;
private var   C_N2_16;
private var   C_N2_17;
private var   C_N2_18;
private var   C_N2_19;
private var   C_N2_20;
private var   C_N2_21;
private var   C_N2_22;
private var   C_N2_23;
private var   C_N2_24;
private var   C_N2_25;
private var   C_N2_26;
private var   C_N2_26_1;
private var   C_N2_26_2;
private var   C_N2_27;
private var   C_N2_28;
private var   C_N2_29;

private var   C_N3_1;
private var   C_N3_1_1;
private var   C_N3_2;
private var   C_N3_3;
private var   C_N3_4;
private var   C_N3_5;
private var   C_N3_6;
private var   C_N3_7;
private var   C_N3_8;
private var   C_N3_9;
private var   C_N3_10;
private var   C_N3_11;
private var   C_N3_12;
private var   C_N3_13;
private var   C_N3_14;
private var   C_N3_15;
private var   C_N3_16;
private var   C_N3_17;
private var   C_N3_18;
private var   C_N3_19;
private var   C_N3_20;
private var   C_N3_21;
private var   C_N3_22;
private var   C_N3_23;
private var   C_N3_24;
private var   C_N3_25;
private var   C_N3_26;
private var   C_N3_27;
private var   C_N3_28;
private var   C_N3_29;
private var   C_N3_30;
private var   C_N3_31;
private var   C_N3_32;
private var   C_N3_33;
private var   C_N3_34;
  

private macro FillCellNamesOP()
   C_Flag	               = "A";
   C_DealDate	           = "B";
   C_DealCode	           = "C";
   C_Contragent	         = "D";
   C_Direction	         = "E";
   C_ContractType        = "F";
   C_BaseActiveCode      = "G";
   C_BaseActiveName      = "H";
   C_Qnty                = "I";
   C_InitialActiveCode   = "J";
   C_InitialActiveName   = "K";
   C_QntyInitialActive   = "L";
   C_ExpirationType      = "M";
   C_OptionDirectionType = "N";
   C_ExpirationDate      = "O";
   C_N5_14               = "P";
   C_ExpirationPriceCur  = "Q";
   C_RateBaseCurDateExec = "R";
   C_MarginCurrCode      = "S";
   C_MarginSumCurr       = "T";
   C_MarginSumRub        = "U";
   C_PremiumDate         = "V";
   C_PremiumCurrency     = "W";
   C_PremiumCurrencyName = "X";
   C_N5_20               = "Y";
   C_PremiumSumCur       = "Z";
   C_PremiumSumRub       = "AA";
   C_AddCost             = "AB";
   C_N5_23               = "AC";
   C_N5_24               = "AD";
   C_N5_25               = "AE";
   C_ExpirationFact      = "AF";
   C_N5_27               = "AG";
   C_N5_28               = "AH";
   C_N5_29               = "AI";
   C_N5_30               = "AJ";
   C_N5_31               = "AK";
   C_N5_32               = "AL";
   C_N5_33               = "AM";
   C_N5_34               = "AN";
   C_ExtCode             = "AO";
   C_NU_1                = "AP";
   C_NU_2                = "AQ";
   C_NU_3                = "AR";
   C_NU_4                = "AS";
   C_K_1                 = "AT";
   C_K_2                 = "AU";

end;

private macro FillCellNamesN1()
   C_Flag                = "A";
   C_DealDate            = "B";
   C_DealCode            = "C";
   C_Direction           = "D";
   C_ContractType        = "E";
   C_BaseActiveCode      = "F";
   C_BaseActiveName      = "G";
   C_InitialActiveCode   = "H";
   C_InitialActiveName   = "I";
   C_ExpirationDate      = "J";
   C_Qnty                = "K";
   C_Contragent          = "L";
   C_ExpirationPriceCur  = "M";
   C_RateBaseCurDealDate = "N";
   C_RateExecCurDealDate = "O";
   C_PriceCurrency       = "P";
   C_RateSpot            = "Q";
   C_RateBaseCurDateExec = "R";
   C_RateExecCurDateExec = "S";
   C_MarginCur           = "T";
   C_MarginRub           = "U";
   C_N1_20               = "V";
   C_N1_21               = "W";
   C_N1_22               = "X";
   C_ExpirationFact      = "Y";
   C_N1_24               = "Z";
   C_N1_25               = "AA";
   C_N1_26               = "AB";
   C_N1_27               = "AC";
   C_N1_28               = "AD";
   C_N1_29               = "AE";
   C_ExtCode             = "AF";
   C_NU_1                = "AG";
   C_NU_2                = "AH";
   C_NU_3                = "AI";
   C_NU_4                = "AJ";
   C_K_1                 = "AK";
   C_K_2                 = "AL";

end;

private macro FillCellNamesN2()
   C_Flag      = "A";
   C_N2_1      = "B";
   C_N2_1_1    = "C";
   C_N2_2      = "D";
   C_N2_3      = "E";
   C_N2_4      = "F";
   C_N2_5      = "G";
   C_N2_6      = "H";
   C_N2_7      = "I";
   C_N2_8      = "J";
   C_N2_9      = "K";
   C_N2_10     = "L";
   C_N2_11     = "M";
   C_N2_11_1   = "N";
   C_N2_12     = "O";
   C_N2_13     = "P";
   C_N2_14     = "Q";
   C_N2_15     = "R";
   C_N2_16     = "S";
   C_N2_17     = "T";
   C_N2_18     = "U";
   C_N2_19     = "V";
   C_N2_20     = "W";
   C_N2_21     = "X";
   C_N2_22     = "Y";
   C_N2_23     = "Z";
   C_N2_24     = "AA";
   C_N2_25     = "AB";
   C_N2_26     = "AC";
   C_N2_26_1   = "AD";
   C_N2_26_2   = "AE";
   C_N2_27     = "AF";
   C_N2_28     = "AG";
   C_N2_29     = "AH";
   C_ExtCode   = "AI";
   C_NU_1      = "AJ";
   C_NU_2      = "AK";
   C_NU_3      = "AL";
   C_NU_4      = "AM";
   C_K_1       = "AN";
   C_K_2       = "AO";
end;

private macro FillCellNamesN3()
   C_Flag      = "A";
   C_N3_1      = "B";
   C_N3_1_1    = "C";
   C_N3_2      = "D";
   C_N3_3      = "E";
   C_N3_4      = "F";
   C_N3_5      = "G";
   C_N3_6      = "H";
   C_N3_7      = "I";
   C_N3_8      = "J";
   C_N3_9      = "K";
   C_N3_10     = "L";
   C_N3_11     = "M";
   C_N3_12     = "N";
   C_N3_13     = "O";
   C_N3_14     = "P";
   C_N3_15     = "Q";
   C_N3_16     = "R";
   C_N3_17     = "S";
   C_N3_18     = "T";
   C_N3_19     = "U";
   C_N3_20     = "V";
   C_N3_21     = "W";
   C_N3_22     = "X";
   C_N3_23     = "Y";
   C_N3_24     = "Z";
   C_N3_25     = "AA";
   C_N3_26     = "AB";
   C_N3_27     = "AC";
   C_N3_28     = "AD";
   C_N3_29     = "AE";
   C_N3_30     = "AF";
   C_N3_31     = "AG";
   C_N3_32     = "AH";
   C_N3_33     = "AI";
   C_N3_34     = "AJ";
   C_ExtCode   = "AK";
   C_NU_1      = "AL";
   C_NU_2      = "AM";
   C_NU_3      = "AN";
   C_NU_4      = "AO";
   C_K_1       = "AP";
   C_K_2       = "AQ";

end;

private macro Oper_rshb():string
  var fio = GetPersnFIOByID(GetOperRecByID({oper}).PartyID);
  if(fio == "")
     return GetOperRecByID({oper}).Name;
  else
     return ConvetFIO_Report(fio);
  end;  
end;

PRIVATE CLASS (DL_CReportTemplate) DV_NTaxReg_Report

  PRIVATE CONST NUM_LIST_FO       = 1, /*Лист Форвард_ПФИ_BS_Т+3*/
                NUM_LIST_OP       = 2, /*Лист Опцион_ПФИ*/
                NUM_LIST_CS       = 3, /*Лист Валютный_СВОП_ПФИ*/
                NUM_LIST_PS       = 4, /*Лист Процентный_СВОП_ПФИ*/
                NUM_LIST_NOT_FISS = 5; /*Лист Форварды_Валютные_СВОПы*/
  PRIVATE CONST NUM_LIST_FO_2     = 6; /*Лист ПП Т+3*/
  
  PRIVATE var NUM_LIST_FO_EXST:bool       = false /*Лист Форвард_ПФИ_BS_Т+3*/
             ,NUM_LIST_OP_EXST:bool       = false /*Лист Опцион_ПФИ*/
             ,NUM_LIST_CS_EXST:bool       = false /*Лист Валютный_СВОП_ПФИ*/
             ,NUM_LIST_PS_EXST:bool       = false /*Лист Процентный_СВОП_ПФИ*/
             ,NUM_LIST_NOT_FISS_EXST:bool = false /*Лист Форварды_Валютные_СВОПы*/
             ,NUM_LIST_FO_2_EXST:bool     = false; /*Лист ПП Т+3*/
  
  
  PRIVATE var /*CONST*/ НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА = 13; //10;
  PRIVATE CONST НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ = 14; //12;
  PRIVATE VAR CreateBook:bool = false;
  PRIVATE VAR vSheetName:string = ""
            , vDepSheetName:string = ""
            , vPrefixH:string = ""
            , vPrefixN:string = ""
            , noData = true;

  private const Delta_FISS_List_Start_Val = 12;
  private const Delta_NotFISS_List_Start_Val = 13;
  private const Delta_FISS_List_Start_Val_rshb = 0; //НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА_rshb;
  PRIVATE VAR Delta = 12;
  
  private var UseCSV_:bool = true;
  private var UsePOI_:bool = true;
  private var UseBigReportMode_:bool = true;

  private var NumStr_N1 = 0;
  private var NumStr_N2 = 0;
  private var NumStr_N3 = 0;
  private var NumStr_N5 = 0;
  
  PRIVATE CONST FORMULA = "formula=";

  PRIVATE MACRO PrintMode():INTEGER
     if( DVNTaxRegRepFormData.IsExportToExel == "X" )
        return DL_OUTREPORT_EXCEL;
     else
        return DL_OUTREPORT_STD;
     end;
  END;

  private macro IsRshbList(NumList):BOOL
    if ( (NumList == NUM_LIST_OP) 
      or (NumList == NUM_LIST_FO)
      or (NumList == NUM_LIST_FO_2)  
      or (NumList == NUM_LIST_CS)
      or (NumList == NUM_LIST_PS)
    )
      return true;
    end;
    return false;
  end;

  PRIVATE MACRO BeginReport()
    Dl_CallInsertStat(PrintMode());
  END;

  PRIVATE MACRO EndReport();
     if (CreateBook == true)
        SaveTotalBook();
        if( PrintMode() != DL_OUTREPORT_STD )
           ReplaceAndCalculate(FORMULA, "=");
        end;
     else
        MsgBox( "Нет данных, удовлетворяющих параметрам отчета." );
     end;
  END;

  PRIVATE MACRO FRP(Str:string, short_rpl:bool):string
    if (short_rpl == true)
      return (StrSubst(FORMULA, "=", "") + Str);
    else
      return (FORMULA + Str);
    end;
  END;
  

   macro sumBeginLine()
      return НОМЕР_НАЧАЛЬНОЙ_СТРОКИ_СУММ_rshb;
   end;


   macro FullRange(sheet, col):string
      //unused sheet
      var s:string = "";
      var e:integer = sumBeginLine() + MAXROWSHEET;
      /*if((strlen(sheet) == 0) or (sheet == null) or (sheet = ""))
         s = "";
      else
         s = "'" + sheet + "'!";
      end;
      s = s + "$" + col + "$" + sumBeginLine();
      s = s + ":$" + col + "$" + e;*/
      s = s +  col + sumBeginLine();
      s = s + ":" + col + e;
      return s;
   end;

   macro GetColRange(sheet, col, rangeSize):string
      //unused sheet
      var s:string = "";
      var e:integer = sumBeginLine() + rangeSize - 1;
      if(rangeSize < 1) 
         return "";
      end;
      /*if ((strlen(sheet) != 0) or (sheet == null) or (sheet = ""))
         s = "";
      else
         s = "'" + sheet + "'!";
      end;
      s = s + "$" + col + "$" + sumBeginLine();
      s = s + ":$" + col + "$" + e;*/
      s = s + col + sumBeginLine();
      s = s + ":" + col + e;
      return s;
   end;

   MACRO SetOLD_SUMIFSFormula_1Cond(FirstColumn, SecondColumn, ThirdColumn, point )
      var Formula1 = "";
      var SheetName = "";
      if (point == null) point = "2"; end;

      if (m_UseTemplate)
         SheetName = m_ObjTemplateXLS.SheetName();
        
         if (m_ObjTemplateXLS.ExcelLanguageInterface != EXCEL_INTERFACE_RUS) 
          Formula1 = "ROUND(SUMPRODUCT";
         else
          Formula1 = "ОКРУГЛ(СУММПРОИЗВ";
         end;

         var str_formula = (Formula1 + "((" + SecondColumn + ThirdColumn + ")*1;(" + FirstColumn + "));" + point + ")");
         str_formula = StrSubst(str_formula, "$", "");
         return FRP( str_formula );
         
         
      end;
   END;

   macro FSum_Col_NotFlag(sheet, col, rangeSize)
      var cond1 = "<>\"N\"";
      return this.SetOLD_SUMIFSFormula_1Cond(
             FullRange(sheet, col) // GetColRange(sheet, col, rangeSize),
            ,FullRange(sheet, C_Flag) // GetColRange(sheet, C_Flag, rangeSize),
            ,cond1
      );
   end;

   macro FSum_Col_H3(sheet, col)
      var cond1 = "=\""+N3_ItogTxt+"\"";
      return this.SetOLD_SUMIFSFormula_1Cond(
             FullRange(sheet, col) // GetColRange(sheet, col, rangeSize),
            ,FullRange(sheet, C_N3_5) // GetColRange(sheet, C_Flag, rangeSize),
            ,cond1
      );
   end;

  PRIVATE MACRO FSUBTOTAL( Str:string, NRec:integer ):string
     return FRP( FormulaSubtotal() + "(9;" + Str + string(Delta-НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА) + ":" + Str + string(Delta+NRec-1-НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА) + ")" );
  END;

  PRIVATE MACRO FSUM( Col:string, Str:integer, NRec:integer ):string
   var strBeg = string(Str);
   var strEnd = string(Str + NRec -1);
     return FRP(FormulaSUM() + "(" + Col + strBeg + ":" + Col + strEnd + ")");

  END;

  PRIVATE MACRO F_N5_NU1():string
      var strNum = string(1+NumStr_N5);
     return FRP(SetIFFormula(C_N5_27+strNum, C_N5_23+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N5_NU2():string
      var strNum = string(1+NumStr_N5);
     return FRP(SetIFFormula(C_N5_27+strNum, "-"+C_N5_24+strNum, "0", "="+dvstate, null) , true);
  END;

  PRIVATE MACRO F_N5_NU3():string
      var strNum = string(1+NumStr_N5);
     return FRP(SetIFFormula(C_N5_27+strNum, C_N5_23+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N5_NU4():string
      var strNum = string(1+NumStr_N5);
     return FRP(SetIFFormula(C_N5_27+strNum, "-"+C_N5_24+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N5_K1():string
      var strNum = string(1+NumStr_N5);
     return FRP(C_NU_1+strNum+"-"+C_NU_2+strNum+"+"+C_NU_3+strNum+"-"+C_NU_4+strNum);
  END;

  PRIVATE MACRO F_N5_K2():string
      var strNum = string(1+NumStr_N5);
     return FRP(C_N5_23+strNum+"+"+C_N5_24+strNum+"-"+C_K_1+strNum);
  END;

  PRIVATE MACRO F_N1_NU1():string
      var strNum = string(1+NumStr_N1);
     return FRP(SetIFFormula(C_N1_24+strNum, C_N1_20+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N1_NU2():string
      var strNum = string(1+NumStr_N1);
     return FRP(SetIFFormula(C_N1_24+strNum, C_N1_21+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N1_NU3():string
      var strNum = string(1+NumStr_N1);
     return FRP(SetIFFormula(C_N1_24+strNum, C_N1_20+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N1_NU4():string
     var strNum = string(1+NumStr_N1);
     return FRP(SetIFFormula(C_N1_24+strNum, C_N1_21+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N1_K1():string
      var strNum = string(1+NumStr_N1);
     return FRP(C_NU_1+strNum+"-"+C_NU_2+strNum+"+"+C_NU_3+strNum+"-"+C_NU_4+strNum);
  END;

  PRIVATE MACRO F_N1_K2():string
      var strNum = string(1+NumStr_N1);
     return FRP(C_N1_20+strNum+"-"+C_N1_21+strNum+"-"+C_K_1+strNum);
  END;

  PRIVATE MACRO F_N2_NU1():string
      var strNum = string(1+NumStr_N2);
     return FRP(SetIFFormula(C_N2_24+strNum, C_N2_21+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N2_NU2():string
      var strNum = string(1+NumStr_N2);
     return FRP(SetIFFormula(C_N2_24+strNum, "-"+C_N2_22+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N2_NU3():string
      var strNum = string(1+NumStr_N2);
     return FRP(SetIFFormula(C_N2_24+strNum, C_N2_21+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N2_NU4():string
      var strNum = string(1+NumStr_N2);
     return FRP(SetIFFormula(C_N2_24+strNum, "-"+C_N2_22+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N2_K1():string
      var strNum = string(1+NumStr_N2);
     return FRP(C_NU_1+strNum+"-"+C_NU_2+strNum+"+"+C_NU_3+strNum+"-"+C_NU_4+strNum);
  END;

  PRIVATE MACRO F_N2_K2():string
     var strNum = string(1+NumStr_N2);
     return FRP(C_N2_21+strNum+"+"+C_N2_22+strNum+"-"+C_K_1+strNum);
  END;

//////// N3 /////////
  PRIVATE MACRO F_N3_NU1():string
      var strNum = string(1+NumStr_N3);
     return FRP(SetIFFormula(C_N3_27+strNum, C_N3_24+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N3_NU2():string
      var strNum = string(1+NumStr_N3);
     return FRP(SetIFFormula(C_N3_27+strNum, "-"+C_N3_25+strNum, "0", "="+dvstate, null), true);
  END;

  PRIVATE MACRO F_N3_NU3():string
      var strNum = string(1+NumStr_N3);
     return FRP(SetIFFormula(C_N3_27+strNum, C_N3_24+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N3_NU4():string
      var strNum = string(1+NumStr_N3);
     return FRP(SetIFFormula(C_N3_27+strNum, "-"+C_N3_25+strNum, "0", "="+dvcalc, null), true);
  END;

  PRIVATE MACRO F_N3_K1():string
      var strNum = string(1+NumStr_N3);
     return FRP(C_NU_1+strNum+"-"+C_NU_2+strNum+"+"+C_NU_3+strNum+"-"+C_NU_4+strNum);
  END;

  PRIVATE MACRO F_N3_K2():string
      var strNum = string(1+NumStr_N3);
     return FRP(C_N3_24+strNum+"+"+C_N3_25+strNum+"-"+C_K_1+strNum);
  END;

////////////////////

  PRIVATE MACRO GetFromForm_GROWTH()
      if(DVNTaxRegRepFormData.GrowingItog == "X")
          return true;
      end;
    return false;
  END;

  PRIVATE MACRO GetFromForm_PERIOD()
    return DVNTaxRegRepFormData.Period;
  END;


   macro GetYear():string
     return string(DVNTaxRegRepFormData.Year);
   end;

   macro GetPeriodCode():string
      var code = "";
      var p, p2;
      var gr:bool = false;

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3)))
         code = "21";
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "31";
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "33";
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = "34";
      end;

      return code;
   end;

   macro GetPeriodTxt():string
      const ytxt = " ГОДА";
      const y2txt = " ГОД";
      const mtxt = " МЕСЯЦЕВ ";
      const m2txt = " МЕСЯЦА ";
      const qtxt = " КВАРТАЛ ";

      var code = "";
      var p, p2;
      var gr:bool = false;
      var y = GetYear();

      gr = GetFromForm_GROWTH();
      p2 = GetFromForm_PERIOD();
      if((p2 == 13) or (gr and (p2 == 3))) // 1 кв
         code = "1"+qtxt+y+ytxt;
      elif(gr and ((p2 == 14) or (p2 == 6)))
         code = "I ПОЛУГОДИЕ " + y + ytxt;
      elif(gr and ((p2 == 15) or (p2 == 9)))
         code = "9" + mtxt + y + ytxt;
      elif(gr and ((p2 == 16) or (p2 == 12)))
         code = y + y2txt;
      elif((p2 == 1))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      elif(gr and (p2 > 1) and (p2 < 5))
         code = string(p2) + m2txt + y + ytxt;
      elif(gr and (p2 > 4) and (p2 < 12))
         code = string(p2) + mtxt + y + ytxt;
      elif((not gr) and (p2 > 13) and (p2 < 17))
         code = string(p2-12) + qtxt + y + ytxt;
      elif((not gr) and (p2 > 0) and (p2 < 13))
         code = StrUpr( MonName(p2) ) + " " + y + ytxt;
      end;

      return code;
   end;

   private macro GetPointForNumList(NumList):integer
      if(NumList == NUM_LIST_FO_2)
         return 9;
      end;
      return null; //6;
   end;


  PRIVATE MACRO PrintRepHeader_rshb_common( Header, Prefix )
  PrintFormatString(Header
                      ,Prefix + "Операционист",  Oper_rshb()
                      ,Prefix + "Year",          GetYear()
                      ,Prefix + "PeriodCode",    GetPeriodCode()
                      ,Prefix + "PeriodTxt",     GetPeriodTxt()
                      );
  end;

   PRIVATE MACRO PrintRepHeader_rshb_N5( Header )
      var Prefix = "H5_";
      PrintFormatString(Header
                       ,Prefix + "23",   FSum_Col_NotFlag(null, C_N5_23, null)
                       ,Prefix + "24",   FSum_Col_NotFlag(null, C_N5_24, null)
                       ,Prefix + "25",   FSum_Col_NotFlag(null, C_N5_25, null)
                       ,Prefix + "NU_1", FSum_Col_NotFlag(null, C_NU_1, null)
                       ,Prefix + "NU_2", FSum_Col_NotFlag(null, C_NU_2, null)
                       ,Prefix + "NU_3", FSum_Col_NotFlag(null, C_NU_3, null)
                       ,Prefix + "NU_4", FSum_Col_NotFlag(null, C_NU_4, null)
                       ,Prefix + "K_1",  FSum_Col_NotFlag(null, C_K_1, null)
                       ,Prefix + "K_2",  FSum_Col_NotFlag(null, C_K_2, null)
                      );
   end;

   PRIVATE MACRO PrintRepHeader_rshb_N1( Header )
      var Prefix = "H1_";
      PrintFormatString(Header
                       ,Prefix + "MarginRub", FSum_Col_NotFlag(null, C_MarginRub, null),
                       Prefix + "20",        FSum_Col_NotFlag(null, C_N1_20, null),
                       Prefix + "21",        FSum_Col_NotFlag(null, C_N1_21, null),
                       Prefix + "22",        FSum_Col_NotFlag(null, C_N1_22, null),
                       Prefix + "25",        FSum_Col_NotFlag(null, C_N1_25, null),
                       Prefix + "26",        FSum_Col_NotFlag(null, C_N1_26, null),
                       Prefix + "27",        FSum_Col_NotFlag(null, C_N1_27, null),
                       Prefix + "28",        FSum_Col_NotFlag(null, C_N1_28, null),
                       Prefix + "29",        FSum_Col_NotFlag(null, C_N1_29, null),
                       Prefix + "NU_1",      FSum_Col_NotFlag(null, C_NU_1, null),
                       Prefix + "NU_2",      FSum_Col_NotFlag(null, C_NU_2, null),
                       Prefix + "NU_3",      FSum_Col_NotFlag(null, C_NU_3, null),
                       Prefix + "NU_4",      FSum_Col_NotFlag(null, C_NU_4, null),
                       Prefix + "K_1",       FSum_Col_NotFlag(null, C_K_1, null),
                       Prefix + "K_2",       FSum_Col_NotFlag(null, C_K_2, null)
                     );
   end;

   PRIVATE MACRO PrintRepHeader_rshb_N1_FO2( Header )
      var Prefix = "H1_";
      PrintFormatString(Header
                       ,Prefix + "AnRegCode",  "АР-17-6",
                       Prefix + "AnRegName",  "Аналитический регистр № АР-17-6",
                       Prefix + "AnRegTxt",   "Доходы (расходы) от операций с внебиржевыми производными инструментами (СПОТ)",
                       Prefix + "NU_1_Name",  "2-020000-ИАР-17-1/5",
                       Prefix + "NU_2_Name",  "5-020000-ИАР-17-4/5",
                       Prefix + "NU_3_Name",  "2-040200-ИАР-17-3/5",
                       Prefix + "NU_4_Name",  "5-040200-ИАР-17-6/5"
                     );
   end;


   PRIVATE MACRO PrintRepHeader_rshb_N2( Header )
      var Prefix = "H2_";
      PrintFormatString(Header
                       ,Prefix + "10",   FSum_Col_NotFlag(null, C_N2_10, null),
                       Prefix + "13",   FSum_Col_NotFlag(null, C_N2_13, null),
                       Prefix + "19",   FSum_Col_NotFlag(null, C_N2_19, null),
                       Prefix + "21",   FSum_Col_NotFlag(null, C_N2_21, null),
                       Prefix + "22",   FSum_Col_NotFlag(null, C_N2_22, null),
                       Prefix + "23",   FSum_Col_NotFlag(null, C_N2_23, null),
                       Prefix + "25",   FSum_Col_NotFlag(null, C_N2_25, null),
                       Prefix + "26",   FSum_Col_NotFlag(null, C_N2_26, null),
                       Prefix + "26_1", FSum_Col_NotFlag(null, C_N2_26_1, null),
                       Prefix + "26_2", FSum_Col_NotFlag(null, C_N2_26_2, null),
                       Prefix + "27",   FSum_Col_NotFlag(null, C_N2_27, null),
                       Prefix + "28",   FSum_Col_NotFlag(null, C_N2_28, null),
                       Prefix + "29",   FSum_Col_NotFlag(null, C_N2_29, null),
                       Prefix + "NU_1", FSum_Col_NotFlag(null, C_NU_1, null),
                       Prefix + "NU_2", FSum_Col_NotFlag(null, C_NU_2, null),
                       Prefix + "NU_3", FSum_Col_NotFlag(null, C_NU_3, null),
                       Prefix + "NU_4", FSum_Col_NotFlag(null, C_NU_4, null),
                       Prefix + "K_1",  FSum_Col_NotFlag(null, C_K_1, null),
                       Prefix + "K_2",  FSum_Col_NotFlag(null, C_K_2, null)
                     );
   end;

   PRIVATE MACRO PrintRepHeader_rshb_N3( Header )
      var Prefix = "H3_";
      PrintFormatString(Header
                       ,Prefix + "17",  FSum_Col_H3(null, C_N3_17),

                       Prefix + "23",   FSum_Col_H3(null, C_N3_23),
                       Prefix + "24",   FSum_Col_H3(null, C_N3_24),
                       Prefix + "25",   FSum_Col_H3(null, C_N3_25),
                       Prefix + "26",   FSum_Col_H3(null, C_N3_26),

                       Prefix + "28",   FSum_Col_H3(null, C_N3_28),
                       Prefix + "29",   FSum_Col_H3(null, C_N3_29),
                       Prefix + "30",   FSum_Col_H3(null, C_N3_30),
                       Prefix + "31",   FSum_Col_H3(null, C_N3_31),
                       Prefix + "32",   FSum_Col_H3(null, C_N3_32),
                       Prefix + "33",   FSum_Col_H3(null, C_N3_33),
                       Prefix + "34",   FSum_Col_H3(null, C_N3_34),

                       Prefix + "NU_1", FSum_Col_H3(null, C_NU_1),
                       Prefix + "NU_2", FSum_Col_H3(null, C_NU_2),
                       Prefix + "NU_3", FSum_Col_H3(null, C_NU_3),
                       Prefix + "NU_4", FSum_Col_H3(null, C_NU_4),
                       Prefix + "K_1",  FSum_Col_H3(null, C_K_1),
                       Prefix + "K_2",  FSum_Col_H3(null, C_K_2)
                     );
   end;


   private macro PrintRepHeader_rshb( Header, NumList )
   
      if(NumList == NUM_LIST_OP)
         PrintRepHeader_rshb_N5( Header );
      elif(NumList == NUM_LIST_FO)
         PrintRepHeader_rshb_N1( Header );
      elif(NumList == NUM_LIST_FO_2)
         PrintRepHeader_rshb_N1( Header );
         PrintRepHeader_rshb_N1_FO2( Header );
      elif(NumList == NUM_LIST_CS)
         PrintRepHeader_rshb_N2( Header );
      elif(NumList == NUM_LIST_PS)
         PrintRepHeader_rshb_N3( Header );
      end;
   end;

   private macro PrintRepHeaderNoData(Dep, NumList)
      if(not IsRshbList(NumList) ) 
         return;
      end;

      if( CreateBook == false )
         CreateTotalBook();
         CreateBook = true;
      end;

      UseNewSheetInTotalBook();
      SetActiveSheet( vSheetName );
      
      if (PrintMode() != DL_OUTREPORT_STD)
        ReportHeader = vPrefixN + "TableHeader";
      end;

      PrintRepHeader_rshb_common( ReportHeader, vPrefixH );
      PrintRepHeader_rshb( ReportHeader, NumList );
      CopyAllSheetInTotalBook( vSheetName, false, vPrefixN + "TableHeader", 0, vDepSheetName);
   end;

  PRIVATE MACRO PrintRepHeader( Dep:integer, NumList )

     if( CreateBook == false )
        CreateTotalBook();
        CreateBook = true;
     end;

     UseNewSheetInTotalBook();
     SetActiveSheet( vSheetName );
     SetRowFlushCount(2000);
     
     if (PrintMode() != DL_OUTREPORT_STD)
        ReportHeader = vPrefixN + "TableHeader";
      end;

      if( IsRshbList(NumList) )
         PrintRepHeader_rshb_common( ReportHeader, vPrefixH );
         PrintRepHeader_rshb( ReportHeader, NumList );
      else
        PrintFormatString(ReportHeader
                             ,vPrefixH + "1", DL_GetDepartmentNameByCode(Dep),
                              vPrefixH + "2", DVNTaxRegRepFormData.BegDate,
                              vPrefixH + "3", DVNTaxRegRepFormData.EndDate,
                              vPrefixH + "4", DL_GetNameAlg(ALG_DV_DIRECTION, DVNTaxRegRepFormData.Direction),
                              vPrefixH + "5", DL_GetNameAlg(ALG_DV_DVKIND, DVNTaxRegRepFormData.DVKind),
                              vPrefixH + "6", DL_GetNameAlg(ALG_DV_FIKIND_PRRATE, DVNTaxRegRepFormData.KindInitialFI) );
      end;

  
    CopyAllSheetInTotalBook( vSheetName, false, ReportHeader, 0, vDepSheetName );
  END;

  PRIVATE MACRO PrintRepFooter( Dep:integer, NumList )
      if(not IsRshbList(NumList))
         AddStandardFooter( vPrefixN );
         CopyAllSheetInTotalBook( vSheetName, false, vPrefixN + "Footer", 1, vDepSheetName );
      else
         CopyAllSheetInTotalBook( vSheetName, false, vPrefixN + "Footer", 0, vDepSheetName );
      end;
  END;

  PRIVATE MACRO PrintLine1( DealDate, DealCode, Direction, ContractType, BaseActiveCode, BaseActiveName, InitialActiveCode, InitialActiveName,
                            ExpirationDate, Qnty, Contragent, ExpirationPriceCur, RateBaseCurDealDate, RateExecCurDealDate, PriceCurrency,
                            RateSpot, RateBaseCurDateExec, RateExecCurrDateExec, 
                            MarginCur, MarginRub, N1_20, N1_21, N1_22,
                            EхpirationFact, N1_24, N1_25, N1_26, N1_27, N1_28, N1_29, ExtCode,
                            Point, /*точность сделки для установки кол-ва знаков после запятой (иначе в Excel фиксированная)*/ 
                            N1_NU_1, N1_NU_2, N1_NU_3, N1_NU_4, N1_K_1, N1_K_2 )

      var point1 = null; //6;
      var point2 = Point;

     PrintTableLine( "DealDate",            DealDate,            null,
                     "DealCode",            DealCode,            null,
                     "Direction",           Direction,           null,
                     "ContractType",        ContractType,        null,
                     "BaseActiveCode",      BaseActiveCode,      null,
                     "BaseActiveName",      BaseActiveName,      null,
                     "InitialActiveCode",   InitialActiveCode,   null,
                     "InitialActiveName",   InitialActiveName,   null,
                     "ExpirationDate",      ExpirationDate,      null,
                     "Qnty",                IIF(Qnty =="", Qnty, money(Qnty)), null,
                     "Contragent",          Contragent,          null,
                     "ExpirationPriceCur",  ExpirationPriceCur,  point2,
                     "RateBaseCurDealDate", RateBaseCurDealDate, point1,
                     "RateExecCurDealDate", RateExecCurDealDate, point1,
                     "PriceCurrency",       PriceCurrency,       null,
                     "RateSpot",            RateSpot,            point2,
                     "RateBaseCurDateExec", RateBaseCurDateExec, point1,
                     "RateExecCurrDateExec",RateExecCurrDateExec,null,
                     "MarginCur",           MarginCur,           null,
                     "MarginRub",           MarginRub,           null,
                     "N1_20",               N1_20,               null,
                     "N1_21",               N1_21,               null,
                     "N1_22",               N1_22,               null,
                     "EхpirationFact",      EхpirationFact,      null,
                     "N1_24",               N1_24,               null,
                     "N1_25",               N1_25,               null,
                     "N1_26",               N1_26,               null,
                     "N1_27",               N1_27,               null,
                     "N1_28",               N1_28,               null,
                     "N1_29",               N1_29,               null,
                     "N1_ExtCode",          ExtCode,             null,

                     "N1_NU_1",             N1_NU_1,             null,
                     "N1_NU_2",             N1_NU_2,             null,
                     "N1_NU_3",             N1_NU_3,             null,
                     "N1_NU_4",             N1_NU_4,             null,
                     "N1_K_1",              N1_K_1,              null,
                     "N1_K_2",              N1_K_2,              null
                      );

      NumStr_N1 = NumStr_N1 + 1;
  END;

  PRIVATE MACRO PrintLine1itog( DealDate, 
                            MarginRub, N1_20, N1_21, N1_22,
                            N1_25, N1_26, N1_27, N1_28, N1_29, 
                            N1_NU_1, N1_NU_2, N1_NU_3, N1_NU_4, N1_K_1, N1_K_2 )

      SetCellFont( "N1_Flag", 10, true, null, null, REDCOLOR_N, GREYCOLOR_N );
      SetCellAlignment( "DealDate", ALIGN_LEFT );
      SetClearCell(  "DealCode",           
                     "Direction",          
                     "ContractType",       
                     "BaseActiveCode",     
                     "BaseActiveName",     
                     "InitialActiveCode",  
                     "InitialActiveName",  
                     "ExpirationDate",     
                     "Qnty",               
                     "Contragent",         
                     "ExpirationPriceCur", 
                     "RateBaseCurDealDate",
                     "RateExecCurDealDate",
                     "PriceCurrency",      
                     "RateSpot",           
                     "RateBaseCurDateExec",
                     "RateExecCurDateExec",
                     "MarginCur",          
                     "EхpirationFact",
                     "N1_24",              
                     "N1_ExtCode"  );

     PrintTableLine( "N1_Flag",             "N",                 null,
                     "DealDate",            DealDate,            null,
                     "MarginRub",           MarginRub,           null,
                     "N1_20",               N1_20,               null,
                     "N1_21",               N1_21,               null,
                     "N1_22",               N1_22,               null,
                     "N1_25",               N1_25,               null,
                     "N1_26",               N1_26,               null,
                     "N1_27",               N1_27,               null,
                     "N1_28",               N1_28,               null,
                     "N1_29",               N1_29,               null,
                     "N1_NU_1",             N1_NU_1,             null,
                     "N1_NU_2",             N1_NU_2,             null,
                     "N1_NU_3",             N1_NU_3,             null,
                     "N1_NU_4",             N1_NU_4,             null,
                     "N1_K_1",              N1_K_1,              null,
                     "N1_K_2",              N1_K_2,              null
                     );

      NumStr_N1 = NumStr_N1 + 1;
  END;


  PRIVATE MACRO PrintLine5( DealDate, DealCode, Contragent, Direction, ContractType, BaseActiveCode, BaseActiveName, Qnty, InitialActiveCode, InitialActiveName, QntyInitialActive, 
                            ExpirationType, OptionDirectionType, ExpirationDate, N5_14, ExpirationPriceCur, RateBaseCurDateExec,
                            MarginCurrCode, MarginSumCurr, MarginSumRub, PremiumDate, PremiumCurrency, PremiumCurrencyName,
                            N5_20, PremiumSumCur, PremiumSumRub, AddCost, N5_23, N5_24, N5_25, EхpirationFact, N5_27, N5_28, N5_29, N5_30, N5_31, N5_32, N5_33, N5_34, ExtCode, Point,
                            N5_NU_1, N5_NU_2, N5_NU_3, N5_NU_4, N5_K_1, N5_K_2 )
     PrintTableLine( "N5_DealDate",            DealDate,            null,
                     "N5_DealCode",            DealCode,            null,
                     "N5_Contragent",          Contragent,          null,
                     "N5_Direction",           Direction,           null,
                     "N5_ContractType",        ContractType,        null,
                     "N5_BaseActiveCode",      BaseActiveCode,      null,
                     "N5_BaseActiveName",      BaseActiveName,      null,
                     "N5_Qnty",                IIF(Qnty =="", Qnty, money(Qnty)), null,
                     "N5_InitialActiveCode",   InitialActiveCode,   null,
                     "N5_InitialActiveName",   InitialActiveName,   null,
                     "N5_QntyInitialActive",   QntyInitialActive,   null,
                     "N5_ExpirationType",      ExpirationType,      null,
                     "N5_OptionDirectionType", OptionDirectionType, null, 
                     "N5_ExpirationDate",      ExpirationDate,      null,
                     "N5_14",                  N5_14,               null,
                     "N5_ExpirationPriceCur",  ExpirationPriceCur,  null,
                     "N5_RateBaseCurDateExec", RateBaseCurDateExec, null,
                     "N5_MarginCurrCode",      MarginCurrCode,      null,
                     "N5_MarginSumCurr",       MarginSumCurr,       null,
                     "N5_MarginSumRub",        MarginSumRub,        null,
                     "N5_PremiumDate",         PremiumDate,         null, 
                     "N5_PremiumCurrency",     PremiumCurrency,     null,
                     "N5_PremiumCurrencyName", PremiumCurrencyName, null,
                     "N5_20",                  N5_20,               null,
                     "N5_PremiumSumCur",       PremiumSumCur,       null,
                     "N5_PremiumSumRub",       PremiumSumRub,       null,
                     "N5_AddCost",             AddCost,             null,
                     "N5_23",                  N5_23,               null,
                     "N5_24",                  N5_24,               null,
                     "N5_25",                  N5_25,               null,
                     "N5_EхpirationFact",      EхpirationFact,      null,
                     "N5_27",                  N5_27,               null,
                     "N5_28",                  N5_28,               null,
                     "N5_29",                  N5_29,               null,
                     "N5_30",                  N5_30,               null,
                     "N5_31",                  N5_31,               null,
                     "N5_32",                  N5_32,               null,
                     "N5_33",                  N5_33,               null,
                     "N5_34",                  N5_34,               null,
                     "N5_ExtCode",             ExtCode,             null,
                     "N5_NU_1",                N5_NU_1,             null,
                     "N5_NU_2",                N5_NU_2,             null,
                     "N5_NU_3",                N5_NU_3,             null,
                     "N5_NU_4",                N5_NU_4,             null,
                     "N5_K_1",                 N5_K_1,              null,
                     "N5_K_2",                 N5_K_2,              null

                       );
      NumStr_N5 = NumStr_N5 + 1;
  END;

  PRIVATE MACRO PrintLine5itog( DealDate, MarginSumRub, PremiumSumRub, AddCost, N5_23, N5_24, N5_25, N5_28, N5_29, N5_30, N5_31, N5_32, N5_33, N5_34, 
                            N5_NU_1, N5_NU_2, N5_NU_3, N5_NU_4, N5_K_1, N5_K_2 )

     SetCellFont( "N5_Flag", 10, true, null, null, REDCOLOR_N, GREYCOLOR_N );
      SetCellAlignment( "N5_DealDate", ALIGN_LEFT );
      SetClearCell(  "N5_DealCode",
                     "N5_Contragent",
                     "N5_Direction",
                     "N5_ContractType",
                     "N5_BaseActiveCode",
                     "N5_BaseActiveName",
                     "N5_Qnty",
                     "N5_InitialActiveCode",
                     "N5_InitialActiveName",
                     "N5_QntyInitialActive",
                     "N5_ExpirationType",
                     "N5_OptionDirectionType",
                     "N5_ExpirationDate",
                     "N5_14",
                     "N5_ExpirationPriceCur",
                     "N5_RateBaseCurDateExec",
                     "N5_MarginCurrCode",
                     "N5_MarginSumCurr",
                     "N5_PremiumDate",
                     "N5_PremiumCurrency",
                     "N5_PremiumCurrencyName",
                     "N5_20",
                     "N5_PremiumSumCur",
                     "N5_EхpirationFact",
                     "N5_27",
                     "N5_ExtCode"  );

     PrintTableLine( "N5_Flag",                "N",                 null,
                     "N5_DealDate",            DealDate,            null,
                     "N5_DealCode",            "",                  null,
                     "N5_MarginSumRub",        MarginSumRub,        null,
                     "N5_PremiumSumRub",       PremiumSumRub,       null,
                     "N5_AddCost",             AddCost,             null,
                     "N5_23",                  N5_23,               null,
                     "N5_24",                  N5_24,               null,
                     "N5_25",                  N5_25,               null,
                     "N5_28",                  N5_28,               null,
                     "N5_29",                  N5_29,               null,
                     "N5_30",                  N5_30,               null,
                     "N5_31",                  N5_31,               null,
                     "N5_32",                  N5_32,               null,
                     "N5_33",                  N5_33,               null,
                     "N5_34",                  N5_34,               null,
                     "N5_NU_1",                N5_NU_1,             null,
                     "N5_NU_2",                N5_NU_2,             null,
                     "N5_NU_3",                N5_NU_3,             null,
                     "N5_NU_4",                N5_NU_4,             null,
                     "N5_K_1",                 N5_K_1,              null,
                     "N5_K_2",                 N5_K_2,              null
                       );

      NumStr_N5 = NumStr_N5 + 1;

  END;

  PRIVATE MACRO PrintLineNoData_N5()
     PrintTableLine( "N5_DealDate",             NoDataTxt,            null);
     NumStr_N5 = NumStr_N5 + 1;
  END;

  PRIVATE MACRO PrintLineNoData_N1()
     PrintTableLine( "DealDate",            NoDataTxt,            null);
     NumStr_N1 = NumStr_N1 + 1;
  END;

  PRIVATE MACRO PrintLineNoData_N2()
     PrintTableLine( "N2_1",            NoDataTxt,            null);
     NumStr_N2 = NumStr_N2 + 1;
  END;

  PRIVATE MACRO PrintLineNoData_N3()
     PrintTableLine( "N3_1",            NoDataTxt,            null);
     NumStr_N3 = NumStr_N3 + 1;
  END;

   private macro PrintLineNoData( NumList )
      if(NumList == NUM_LIST_OP)
         PrintLineNoData_N5();
      elif(NumList == NUM_LIST_FO)
         PrintLineNoData_N1();
      elif(NumList == NUM_LIST_FO_2)
         PrintLineNoData_N1();
      elif(NumList == NUM_LIST_CS)
         PrintLineNoData_N2();
      elif(NumList == NUM_LIST_PS)
         PrintLineNoData_N3();
      end;
   end;


  PRIVATE MACRO PrintLine2(N2_1, N2_1_1, N2_2, N2_3, N2_4, N2_5, N2_6, N2_7, N2_8, N2_9, N2_10, N2_11, N2_11_1, N2_12, N2_13, N2_14, N2_15, N2_16, N2_17, N2_18, N2_19, N2_20,
                           N2_21, N2_22, N2_23, N2_24, N2_25, N2_26, N2_26_1, N2_26_2, N2_27, N2_28, N2_29, ExtCode, Point,
                           N2_NU_1, N2_NU_2, N2_NU_3, N2_NU_4, N2_K_1, N2_K_2 )

     PrintTableLine( "N2_1",  N2_1,  null,
                     "N2_1_1",N2_1_1,null,
                     "N2_2",  N2_2,  null,
                     "N2_3",  N2_3,  null,
                     "N2_4",  N2_4,  null,
                     "N2_5",  N2_5,  null,
                     "N2_6",  N2_6,  null,
                     "N2_7",  N2_7,  null,
                     "N2_8",  N2_8,  null,
                     "N2_9",  N2_9,  null,
                     "N2_10", N2_10, null,
                     "N2_11", N2_11, null,
                     "N2_11_1", N2_11_1, null,
                     "N2_12", N2_12, null,
                     "N2_13", N2_13, null,
                     "N2_14", N2_14, null,
                     "N2_15", N2_15, null,
                     "N2_16", N2_16, null,
                     "N2_17", N2_17, null,
                     "N2_18", N2_18, null,
                     "N2_19", N2_19, null,
                     "N2_20", N2_20, null,
                     "N2_21", N2_21, null,
                     "N2_22", N2_22, null,
                     "N2_23", N2_23, null,
                     "N2_24", N2_24, null,
                     "N2_25", N2_25, null,
                     "N2_26", N2_26, null,
                     "N2_26_1", N2_26_1, null,
                     "N2_26_2", N2_26_2, null,
                     "N2_27", N2_27, null,
                     "N2_28", N2_28, null,
                     "N2_29", N2_29, null,
                     "N2_ExtCode", ExtCode, null, 
                     "N2_NU_1",                N2_NU_1,             null,
                     "N2_NU_2",                N2_NU_2,             null,
                     "N2_NU_3",                N2_NU_3,             null,
                     "N2_NU_4",                N2_NU_4,             null,
                     "N2_K_1",                 N2_K_1,              null,
                     "N2_K_2",                 N2_K_2,              null
                     );
      NumStr_N2 = NumStr_N2 + 1;
  END;

  PRIVATE MACRO PrintLine2itog(N2_1, N2_10, N2_13, N2_19, 
                           N2_21, N2_22, N2_23, N2_25, N2_26, N2_26_1, N2_26_2, N2_27, N2_28, N2_29, 
                           N2_NU_1, N2_NU_2, N2_NU_3, N2_NU_4, N2_K_1, N2_K_2 )

      SetCellFont( "N2_Flag", 10, true, null, null, REDCOLOR_N, GREYCOLOR_N );                           
      SetCellAlignment( "N2_1", ALIGN_LEFT );
      SetClearCell(  "N2_1_1",
                     "N2_2",
                     "N2_3",
                     "N2_4",
                     "N2_5",
                     "N2_6",
                     "N2_7",
                     "N2_8",
                     "N2_9",
                     "N2_11",
                     "N2_11_1",
                     "N2_12",
                     "N2_14",
                     "N2_15",
                     "N2_16",
                     "N2_17",
                     "N2_18",
                     "N2_20",
                     "N2_24",
                     "N2_ExtCode" );


     PrintTableLine( "N2_Flag",  "N",     null,
                     "N2_1",     N2_1,    null,
                     "N2_10",    N2_10,   null,
                     "N2_13",    N2_13,   null,
                     "N2_19",    N2_19,   null,
                     "N2_21",    N2_21,   null,
                     "N2_22",    N2_22,   null,
                     "N2_23",    N2_23,   null,
                     "N2_25",    N2_25,   null,
                     "N2_26",    N2_26,   null,
                     "N2_26_1",  N2_26_1, null,
                     "N2_26_2",  N2_26_2, null,
                     "N2_27",    N2_27,   null,
                     "N2_28",    N2_28,   null,
                     "N2_29",    N2_29,   null,
                     "N2_NU_1",  N2_NU_1, null,
                     "N2_NU_2",  N2_NU_2, null,
                     "N2_NU_3",  N2_NU_3, null,
                     "N2_NU_4",  N2_NU_4, null,
                     "N2_K_1",   N2_K_1,  null,
                     "N2_K_2",   N2_K_2,  null
                     );
      NumStr_N2 = NumStr_N2 + 1;
  END;


  PRIVATE MACRO PrintLine3( N3_1, N3_1_1, N3_2, N3_3, N3_4, N3_5, N3_6, N3_7, N3_8, N3_9, N3_10, N3_11, N3_12, N3_13, N3_14, N3_15, N3_16, N3_17, N3_18, N3_19, N3_20, N3_21, N3_22, N3_23, N3_24, N3_25, N3_26, N3_27, N3_28, N3_29, N3_30, N3_31, N3_32, N3_33, N3_34, ExtCode, DealItog )
     PrintTableLine( "N3_1",  N3_1,  null,
                     "N3_1_1",N3_1_1,null,
                     "N3_2",  N3_2,  null,
                     "N3_3",  N3_3,  null,
                     "N3_4",  N3_4,  null,
                     "N3_5",  N3_5,  null,
                     "N3_6",  N3_6,  null,
                     "N3_7",  N3_7,  null,
                     "N3_8",  N3_8,  null,
                     "N3_9",  N3_9,  null,
                     "N3_10", N3_10, null,
                     "N3_11", N3_11, null,
                     "N3_12", N3_12, null,
                     "N3_13", N3_13, null,
                     "N3_14", N3_14, null,
                     "N3_15", N3_15, null,
                     "N3_16", N3_16, null,
                     "N3_17", N3_17, null,
                     "N3_18", N3_18, null,
                     "N3_19", N3_19, null,
                     "N3_20", N3_20, null,
                     "N3_21", N3_21, null,
                     "N3_22", N3_22, null,
                     "N3_23", N3_23, null,
                     "N3_24", N3_24, null,
                     "N3_25", N3_25, null,
                     "N3_26", N3_26, null,
                     "N3_27", N3_27, null,
                     "N3_28", N3_28, null,
                     "N3_29", N3_29, null,
                     "N3_30", N3_30, null,
                     "N3_31", N3_31, null,
                     "N3_32", N3_32, null,
                     "N3_33", N3_33, null,
                     "N3_34", N3_34, null,
                     "N3_ExtCode", ExtCode, null  );
     NumStr_N3 = NumStr_N3 + 1;
  END;

  PRIVATE MACRO PrintLine3itog( N3_1_1, N3_2, N3_5, N3_15, N3_17, N3_21, N3_23, N3_24, N3_25, N3_26, N3_27, N3_28, N3_29, N3_30, N3_31, N3_32, N3_33, N3_34, NU_1, NU_2, NU_3, NU_4, K_1, K_2 )
     SetCurrentLineFont( 8, true, false, null, null, DefaultBkGrColor );
      SetClearCell(  "N3_Flag",
                     "N3_1",
                     "N3_3",
                     "N3_4",
                     "N3_6",
                     "N3_7",
                     "N3_8",
                     "N3_9",
                     "N3_10",
                     "N3_11",
                     "N3_12",
                     "N3_13",
                     "N3_14",
                     "N3_16",
                     "N3_18",
                     "N3_19",
                     "N3_20",
                     "N3_22",
                     "N3_ExtCode" );

     PrintTableLine( 
                     "N3_1_1",N3_1_1,null,
                     "N3_2",  N3_2,  null,
                     "N3_5",  N3_5,  null,
                     "N3_15", N3_15, null,
                     "N3_17", N3_17, null,
                     "N3_21", N3_21, null,
                     "N3_23", N3_23, null,
                     "N3_24", N3_24, null,
                     "N3_25", N3_25, null,
                     "N3_26", N3_26, null,
                     "N3_27", N3_27, null,
                     "N3_28", N3_28, null,
                     "N3_29", N3_29, null,
                     "N3_30", N3_30, null,
                     "N3_31", N3_31, null,
                     "N3_32", N3_32, null,
                     "N3_33", N3_33, null,
                     "N3_34", N3_34, null,
                     "N3_NU_1",  NU_1, null,
                     "N3_NU_2",  NU_2, null,
                     "N3_NU_3",  NU_3, null,
                     "N3_NU_4",  NU_4, null,
                     "N3_K_1",   K_1,  null,
                     "N3_K_2",   K_2,  null
                       );
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
     NumStr_N3 = NumStr_N3 + 1;
  END;

  PRIVATE MACRO PrintLine4( N4_1, N4_2, N4_3, N4_4, N4_5, N4_6, N4_7, N4_8, N4_9, N4_10, N4_11, N4_12, N4_13, N4_14, N4_15, N4_16, N4_17, N4_18, N4_19, N4_20, N4_21, N4_22, N4_23, N4_24, N4_25, N4_26, N4_27, N4_28, N4_29, N4_30, N4_31, N4_32, N4_33, ExtCode)
     PrintTableLine( "N4_1",  N4_1,  null,
                     "N4_2",  N4_2,  null,
                     "N4_3",  N4_3,  null,
                     "N4_4",  N4_4,  null,
                     "N4_5",  N4_5,  null,
                     "N4_6",  N4_6,  null,
                     "N4_7",  N4_7,  null,
                     "N4_8",  N4_8,  null,
                     "N4_9",  N4_9,  null,
                     "N4_10", N4_10, null,
                     "N4_11", N4_11, null,
                     "N4_12", N4_12, null,
                     "N4_13", N4_13, null,
                     "N4_14", N4_14, null,
                     "N4_15", N4_15, null,
                     "N4_16", N4_16, null,
                     "N4_17", N4_17, null,
                     "N4_18", N4_18, null,
                     "N4_19", N4_19, null,
                     "N4_20", N4_20, null,
                     "N4_21", N4_21, null,
                     "N4_22", N4_22, null,
                     "N4_23", N4_23, null,
                     "N4_24", N4_24, null,
                     "N4_25", N4_25, null,
                     "N4_26", N4_26, null,
                     "N4_27", N4_27, null,
                     "N4_28", N4_28, null,
                     "N4_29", N4_29, null,
                     "N4_30", N4_30, null,
                     "N4_31", N4_31, null,
                     "N4_32", N4_32, null,
                     "N4_33", N4_33, null,
                     "N4_ExtCode", ExtCode, null  );
  END;

  PRIVATE MACRO BeginRepTab( NumList:integer )
  var TblHeader = vPrefixN + "TableHeader";
     if(( NumList == NUM_LIST_FO ) or ( NumList == NUM_LIST_FO_2 ))
        RegisterTable( "N1_TableLine", IIF(PrintMode == DL_OUTREPORT_STD, TableHeader1, TblHeader),
                       "N1_Flag",
                       "DealDate",
                       "DealCode",
                       "Direction",
                       "ContractType",
                       "BaseActiveCode",
                       "BaseActiveName",
                       "InitialActiveCode",
                       "InitialActiveName",
                       "ExpirationDate",
                       "Qnty",
                       "Contragent",
                       "ExpirationPriceCur",
                       "RateBaseCurDealDate",
                       "RateExecCurDealDate",
                       "PriceCurrency",
                       "RateSpot",
                       "RateBaseCurDateExec",
                       "RateExecCurDateExec",
                       "MarginCur",
                       "MarginRub",
                       "N1_20",
                       "N1_21",
                       "N1_22",
                       "EхpirationFact",
                       "N1_24",
                       "N1_25",
                       "N1_26",
                       "N1_27",
                       "N1_28",
                       "N1_29",
                       "N1_ExtCode",
                       "N1_NU_1",
                       "N1_NU_2",
                       "N1_NU_3",
                       "N1_NU_4",
                       "N1_K_1",
                       "N1_K_2" );

         NumStr_N1 = 0;

     elif( NumList == NUM_LIST_OP )
        RegisterTable( "N5_TableLine", IIF(PrintMode == DL_OUTREPORT_STD, TableHeader5, TblHeader),
                       "N5_Flag",
                       "N5_DealDate",
                       "N5_DealCode",
                       "N5_Contragent",
                       "N5_Direction",
                       "N5_ContractType",
                       "N5_BaseActiveCode",
                       "N5_BaseActiveName",
                       "N5_Qnty",
                       "N5_InitialActiveCode",
                       "N5_InitialActiveName",
                       "N5_QntyInitialActive",
                       "N5_ExpirationType",
                       "N5_OptionDirectionType",
                       "N5_ExpirationDate",
                       "N5_14",
                       "N5_ExpirationPriceCur",
                       "N5_RateBaseCurDateExec",
                       "N5_MarginCurrCode",
                       "N5_MarginSumCurr",
                       "N5_MarginSumRub",
                       "N5_PremiumDate",
                       "N5_PremiumCurrency",
                       "N5_PremiumCurrencyName",
                       "N5_20",
                       "N5_PremiumSumCur",
                       "N5_PremiumSumRub",
                       "N5_AddCost",
                       "N5_23",
                       "N5_24",
                       "N5_25",
                       "N5_EхpirationFact",
                       "N5_27",
                       "N5_28",
                       "N5_29",
                       "N5_30",
                       "N5_31",
                       "N5_32",
                       "N5_33",
                       "N5_34",
                       "N5_ExtCode",
                       "N5_NU_1",
                       "N5_NU_2",
                       "N5_NU_3",
                       "N5_NU_4",
                       "N5_K_1",
                       "N5_K_2" );
         NumStr_N5 = 0;

     elif( NumList == NUM_LIST_CS )
        RegisterTable( "N2_TableLine", IIF(PrintMode == DL_OUTREPORT_STD, TableHeader2, TblHeader),
                       "N2_Flag",
                       "N2_1",
                       "N2_1_1",
                       "N2_2",
                       "N2_3",
                       "N2_4",
                       "N2_5",
                       "N2_6",
                       "N2_7",
                       "N2_8",
                       "N2_9",
                       "N2_10",
                       "N2_11",
                       "N2_11_1",
                       "N2_12",
                       "N2_13",
                       "N2_14",
                       "N2_15",
                       "N2_16",
                       "N2_17",
                       "N2_18",
                       "N2_19",
                       "N2_20",
                       "N2_21",
                       "N2_22",
                       "N2_23",
                       "N2_24",
                       "N2_25",
                       "N2_26",
                       "N2_26_1",
                       "N2_26_2",
                       "N2_27",
                       "N2_28",
                       "N2_29",
                       "N2_ExtCode",
                       "N2_NU_1",
                       "N2_NU_2",
                       "N2_NU_3",
                       "N2_NU_4",
                       "N2_K_1",
                       "N2_K_2" );
         NumStr_N2 = 0;

     elif( NumList == NUM_LIST_PS )
        RegisterTable( "N3_TableLine", IIF(PrintMode == DL_OUTREPORT_STD, TableHeader3,TblHeader),
                       "N3_Flag",
                       "N3_1",
                       "N3_1_1",
                       "N3_2",
                       "N3_3",
                       "N3_4",
                       "N3_5",
                       "N3_6",
                       "N3_7",
                       "N3_8",
                       "N3_9",
                       "N3_10",
                       "N3_11",
                       "N3_12",
                       "N3_13",
                       "N3_14",
                       "N3_15",
                       "N3_16",
                       "N3_17",
                       "N3_18",
                       "N3_19",
                       "N3_20",
                       "N3_21",
                       "N3_22",
                       "N3_23",
                       "N3_24",
                       "N3_25",
                       "N3_26",
                       "N3_27",
                       "N3_28",
                       "N3_29",
                       "N3_30",
                       "N3_31",
                       "N3_32",
                       "N3_33",
                       "N3_24",
                       "N3_ExtCode",
                       "N3_NU_1",
                       "N3_NU_2",
                       "N3_NU_3",
                       "N3_NU_4",
                       "N3_K_1",
                       "N3_K_2" );
         NumStr_N3 = 0;
                       
     elif( NumList == NUM_LIST_NOT_FISS )
        RegisterTable( "N4_TableLine", IIF(PrintMode == DL_OUTREPORT_STD, TableHeader4, TblHeader),
                       "N4_1",
                       "N4_2",
                       "N4_3",
                       "N4_4",
                       "N4_5",
                       "N4_6",
                       "N4_7",
                       "N4_8",
                       "N4_9",
                       "N4_10",
                       "N4_11",
                       "N4_12",
                       "N4_13",
                       "N4_14",
                       "N4_15",
                       "N4_16",
                       "N4_17",
                       "N4_18",
                       "N4_19",
                       "N4_20",
                       "N4_21",
                       "N4_22",
                       "N4_23",
                       "N4_24",
                       "N4_25",
                       "N4_26",
                       "N4_27",
                       "N4_28",
                       "N4_29",
                       "N4_30",
                       "N4_31",
                       "N4_32",
                       "N4_33",
                       "N4_ExtCode" );
     end;
  END;

  PRIVATE MACRO PrintItogFO_rshb( NRec:integer, FiKind:string )
      var str = NumStr_N1 + 2;
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
        PrintLine1itog( "по виду актива - "+FiKind 
            ,FSUM(C_MarginRub, str, NRec)
            ,FSUM(C_N1_20, str, NRec) 
            ,FSUM(C_N1_21, str, NRec) 
            ,FSUM(C_N1_22, str, NRec)
            ,FSUM(C_N1_25, str, NRec) 
            ,FSUM(C_N1_26, str, NRec) 
            ,FSUM(C_N1_27, str, NRec) 
            ,FSUM(C_N1_28, str, NRec) 
            ,FSUM(C_N1_29, str, NRec) 
            ,FSUM(C_NU_1, str, NRec) 
            ,FSUM(C_NU_2, str, NRec) 
            ,FSUM(C_NU_3, str, NRec) 
            ,FSUM(C_NU_4, str, NRec) 
            ,FSUM(C_K_1, str, NRec) 
            ,FSUM(C_K_2, str, NRec)
            );
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;


  PRIVATE MACRO PrintItogFO( NRec:integer, All_MarginRub:money, All_N1_20:money, All_N1_21:money, FiKind:string, All_N1_25:money, All_N1_26:money, All_N1_27:money, All_N1_28:money, All_N1_29:money )
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
     if( PrintMode() == DL_OUTREPORT_STD )
        
        PrintLine1( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "",  
                    "", "", "", "", "", "", "", "", "", All_MarginRub,
                    All_N1_20, All_N1_21, 
                    All_N1_20 - All_N1_21, "", "", All_N1_25, All_N1_26, All_N1_27, All_N1_28, All_N1_29, "" );
     else
        merge("DealDate", "Direction");
        PrintLine1( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "",
                    "", "", "", "", "", "", "", "", "", FSUBTOTAL("T", NRec),
                    FSUBTOTAL("U", NRec), FSUBTOTAL("V", NRec), 
                    FSUBTOTAL("W", NRec), "", "", FSUBTOTAL("Z", NRec), FSUBTOTAL("AA", NRec), FSUBTOTAL("AB", NRec), FSUBTOTAL("AC", NRec), FSUBTOTAL("AD", NRec), "" );
     end;
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;

  PRIVATE MACRO PrintItogOP_rshb( NRec:integer,  FiKind:string )
      var str = NumStr_N5 + 2;
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
        PrintLine5itog( "по виду актива - "+FiKind, 
            FSUM(C_MarginSumRub, str, NRec), 
            FSUM(C_PremiumSumRub, str, NRec), 
            FSUM(C_AddCost, str, NRec), 
            FSUM(C_N5_23, str, NRec), 
            FSUM(C_N5_24, str, NRec), 
            FSUM(C_N5_25, str, NRec), 
            FSUM(C_N5_28, str, NRec), 
            FSUM(C_N5_29, str, NRec), 
            FSUM(C_N5_30, str, NRec), 
            FSUM(C_N5_31, str, NRec), 
            FSUM(C_N5_32, str, NRec), 
            FSUM(C_N5_33, str, NRec), 
            FSUM(C_N5_34, str, NRec), 

            FSUM(C_NU_1, str, NRec), 
            FSUM(C_NU_2, str, NRec), 
            FSUM(C_NU_3, str, NRec), 
            FSUM(C_NU_4, str, NRec), 
            FSUM(C_K_1, str, NRec), 
            FSUM(C_K_2, str, NRec)
            );
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;

  PRIVATE MACRO PrintItogOP( NRec:integer, All_MarginSumRub:money, All_PremiumSumRub:money, All_AddCost:money, All_N5_23:money, All_N5_24:money, All_N5_25:money, All_N5_28:money, All_N5_29:money, All_N5_30:money, All_N5_31:money, All_N5_32:money, All_N5_33:money, All_N5_34:money, FiKind:string )
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
     if( PrintMode() == DL_OUTREPORT_STD )
        
        PrintLine5( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "",  
                    "", "", "", "", "", "", "", "", "", All_MarginSumRub, "", "", "",
                    "", "", All_PremiumSumRub, All_AddCost, All_N5_23, All_N5_24, 
                    All_N5_25, "", "", All_N5_28, All_N5_29, All_N5_30, All_N5_31, All_N5_32, All_N5_33, All_N5_34, "" );
     else
        merge("N5_DealDate", "N5_Contragent");
        PrintLine5( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "",
                    "", "", "", "", "", "", "", "", "", FSUBTOTAL("T", NRec), "", "", "",
                    "", "", FSUBTOTAL("Z", NRec), FSUBTOTAL("AA", NRec), FSUBTOTAL("AB", NRec), FSUBTOTAL("AC", NRec), 
                    FSUBTOTAL("AD", NRec), "", "", FSUBTOTAL("AG", NRec), FSUBTOTAL("AH", NRec), FSUBTOTAL("AI", NRec), FSUBTOTAL("AJ", NRec), FSUBTOTAL("AK", NRec), FSUBTOTAL("AL", NRec), FSUBTOTAL("AM", NRec), "" );
     end;
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;

  PRIVATE MACRO PrintItogCS_rshb( NRec:integer,  FiKind:string )
      var str = NumStr_N2 + 2;
      SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
      PrintLine2itog( "по виду актива - "+FiKind, 
         FSUM(C_N2_10, str, NRec), 
         FSUM(C_N2_13, str, NRec), 
         FSUM(C_N2_19, str, NRec), 

         FSUM(C_N2_21, str, NRec), 
         FSUM(C_N2_22, str, NRec), 
         FSUM(C_N2_23, str, NRec), 

         FSUM(C_N2_25, str, NRec), 
         FSUM(C_N2_26, str, NRec), 
         FSUM(C_N2_26_1, str, NRec), 
         FSUM(C_N2_26_2, str, NRec), 
         FSUM(C_N2_27, str, NRec), 
         FSUM(C_N2_28, str, NRec), 
         FSUM(C_N2_29, str, NRec), 

         FSUM(C_NU_1, str, NRec), 
         FSUM(C_NU_2, str, NRec), 
         FSUM(C_NU_3, str, NRec), 
         FSUM(C_NU_4, str, NRec), 
         FSUM(C_K_1, str, NRec), 
         FSUM(C_K_2, str, NRec)
      );
      SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );

  END;


  PRIVATE MACRO PrintItogCS( NRec:integer, SumN2_10:money, SumN2_13:money, SumN2_19:money, SumN2_21:money, SumN2_22:money, SumN2_25:money, SumN2_26:money, SumN2_26_1:money, SumN2_26_2:money, SumN2_27:money, SumN2_28:money, SumN2_29:money, FiKind:string )
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
     if( PrintMode() == DL_OUTREPORT_STD )
        PrintLine2( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "", 
                    SumN2_10, "", "", "", SumN2_13, "", "", "", "", "",
                    SumN2_19, "", SumN2_21, SumN2_22, "", "", SumN2_25,
                    SumN2_26, SumN2_26_1, SumN2_26_2, SumN2_27, SumN2_28, SumN2_29, "" );
     else
        merge("N2_1", "N2_2");
        PrintLine2( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "", 
                    FSUBTOTAL("K", NRec), "", "", "", FSUBTOTAL("O", NRec), "", "", "", "", "",
                    FSUBTOTAL("U", NRec), "", FSUBTOTAL("W", NRec), FSUBTOTAL("X", NRec), "", "", FSUBTOTAL("AA", NRec),
                    FSUBTOTAL("AB", NRec), FSUBTOTAL("AC", NRec), FSUBTOTAL("AD", NRec), FSUBTOTAL("AE", NRec), FSUBTOTAL("AF", NRec), FSUBTOTAL("AG", NRec), "" );
     end;
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;

  PRIVATE MACRO PrintItogPS( NRec:integer, SumN3_17:money, SumN3_23:money, SumN3_24:money, SumN3_25:money, SumN3_28:money, SumN3_29:money, SumN3_30:money, SumN3_31:money, SumN3_32:money, SumN3_33:money, SumN3_34:money  )
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
     if( NRec == 0 )
        PrintLine3( "x", "x", "x", "x", "x", "x", "x", "x", "x", "x",
                    "x", "x", "x", "x", "x", "x", "x", "x", "x", "x",
                    "x", "x", "x", "x", "x", "x", "x", "x", "x",
                    "x", "x", "x", "x", "x", "x", "x");
     else
        PrintLine3( "Итого", "", "", "", "", "", "", "", "", "", 
                    "", "", "", "", "", "", "", SumN3_17, "","",
                    "", "", "", SumN3_23, SumN3_24, SumN3_25, SumN3_24 - abs(SumN3_25), "", SumN3_28,
                    SumN3_29, SumN3_30, SumN3_31, SumN3_32, SumN3_33, SumN3_34, "" );
     end;
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;


  PRIVATE MACRO PrintItogNotFISS( NRec:integer, SumN4_29:money, SumN4_30:money, FiKind:string, PlusNotPFI:money, MinusNotPFI:money  )
     SetCurrentLineFont( 8, true, false, null, null, GREYCOLOR );
     if( PrintMode() == DL_OUTREPORT_STD )
        PrintLine4( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                    SumN4_29,
                    SumN4_30,
                    "", PlusNotPFI, MinusNotPFI, "" );
     else
        merge("N4_1", "N4_3");
        PrintLine4( "по виду актива - "+FiKind, "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
                    FSUBTOTAL("AC", NRec),
                    FSUBTOTAL("AD", NRec),
                    "", PlusNotPFI, MinusNotPFI,"" );
     end;
     SetCurrentLineFont( 8, false, false, null, null, DefaultBkGrColor );
  END;

  PRIVATE MACRO Direction( FD ):string
     var RetVal:string = "";

     if( FD.Deal.rec.Type == ALG_DV_BUY )
        RetVal = "B";
     elif( FD.Deal.rec.Type == ALG_DV_SALE )
        RetVal = "S";
     elif( FD.Deal.rec.Type == ALG_DV_BS )
        RetVal = "B/S";
     elif( FD.Deal.rec.Type == ALG_DV_SB )
        RetVal = "S/B";
     elif( FD.Deal.rec.Type == ALG_DV_FIX_FLOAT )
        RetVal = "Fix/Float";
     elif( FD.Deal.rec.Type == ALG_DV_FLOAT_FIX )
        RetVal = "Float/Fix";
     elif( FD.Deal.rec.Type == ALG_DV_FIX_FIX )
        RetVal = "Fix/Fix";
     elif( FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT )
        RetVal = "Float/Float";
     end;

     return RetVal;
  END;

  macro SetAutoSize(NumList:integer, sheet) //Автоматическая ширина для столбцов
    if( (NumList == NUM_LIST_FO) or (NumList == NUM_LIST_FO_2) )
      m_ObjTemplateXLS.SetAutoFitTotalbook("C:AL", sheet);             
    elif( NumList == NUM_LIST_OP )
      m_ObjTemplateXLS.SetAutoFitTotalbook("C:AU", sheet);
    elif( NumList == NUM_LIST_CS )
      m_ObjTemplateXLS.SetAutoFitTotalbook("C:AO", sheet);
    elif( NumList == NUM_LIST_PS )
      m_ObjTemplateXLS.SetAutoFitTotalbook("C:AQ", sheet);
    end;
  end;

  /**
   @brief Метод установки фильтров по колонкам
   @param[in] sheet наименование листа отчёта
   @param[in] range для каких колонок добавлять фильтр
  */
  MACRO SetOnAutoFilter(sheet, range)                     
    if( m_ObjTemplateXLS.ExistSheetTotalbook( sheet ) )
      m_ObjTemplateXLS.SetAutoFilterTotalbook(range, sheet);
    end; 
  end;

  PRIVATE MACRO BaseActive( BaseActivFIID:integer, CodeBA:@string, NameBA:@string, SumPrecision:@integer )
     CodeBA = ""; NameBA = "";
     SumPrecision = 0;

     if( BaseActivFIID != ALLFININSTR )
        var FI = TRecHandler("fininstr.dbt");
        if( ПолучитьФинИн(BaseActivFIID, FI) != 0 )
           MsgBox("Не найден финансовый инструмент (FIID = " + string(BaseActivFIID) + ")");
        else
           CodeBA = FI.rec.FI_Code;
           NameBA = FI.rec.Name;
           SumPrecision = FI.rec.SumPrecision;
        end;
     end;
  END;

  PRIVATE MACRO ПолучитьИмяСубъекта( PartyID )
     var _rParty = TRecHandler( "party.dbt" );
     var party_name = "";
     if( PartyID >= 0 )
       if( not ПолучитьСубъекта( PartyID, _rParty ) )
          party_name = _rParty.rec.Name;
       end;
     end;
     return party_name;
  END;

  PRIVATE MACRO GetMarginSum( FD, MarginCur:@money, MarginRub:@money, PriceCurrency:integer, beforePeriod:bool, NumList:integer, MarginFI_Code:@string, ReceivedMarginRub:@money, PaidMarginRub:@money )
     var Query, Data;
     var TempMargin:money = $0.0, TempMarginCur:money = $0.0, TempMarginRub:money = $0.0, TempReceivedMarginRub = $0.0, TempPaidMarginRub = $0.0;
     var QueryString = "", FirstRound = true;

     MarginCur = $0.0;
     MarginRub = $0.0;
     MarginFI_Code = "";

     QueryString = " SELECT t_Direction, t_Sum, t_AccFIID, t_Date, " +
                         "  FIRST_VALUE(t_AccFIID) OVER (ORDER BY t_Date, t_id) AS t_FirstAccFIID " +
                         "   FROM ddvnacdl_dbt " +
                         "  WHERE t_DealID = ? " +
                         "    AND t_PayKind = ? ";
     if( beforePeriod )
        QueryString = QueryString + " AND t_Date   < ? ";
     else
        QueryString = QueryString + " AND t_Date   >= ? " + " AND t_Date <= ? ";
     end;

     Query = RSDCommand( QueryString );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, DV_CALCOP_PAYKIND_MARGIN );
     if( beforePeriod )
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
     else
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
     end;

     Query.execute();
     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )

        var Sign = IIF(Data.Direction == DV_CALCOP_DIRECTION_PAYMENT, -1, 1);

        if( ((NumList == NUM_LIST_CS) or (NumList == NUM_LIST_OP)) and FirstRound )
           PriceCurrency = Data.FirstAccFIID;
           MarginFI_Code = GetFI_CODE(Data.FirstAccFIID);
           FirstRound = false;
        end;

        if( Data.AccFIID == PriceCurrency )
           TempMargin = Data.Sum;
        else
           if( not DV_SmartConvertSum( TempMargin, Data.Sum, Data.Date, Data.AccFIID, PriceCurrency, true ) )
              return false;
           end;
        end;
        TempMarginCur = TempMarginCur + (Sign*TempMargin);

        if( Data.AccFIID == NATCUR )
           TempMargin = Data.Sum;
        else
           if( not DV_SmartConvertSum( TempMargin, Data.Sum, Data.Date, Data.AccFIID, NATCUR, true ) )
              return false;
           end;
        end;
        TempMarginRub = TempMarginRub + (Sign*TempMargin);

        if( Sign == 1 )
           TempReceivedMarginRub = TempReceivedMarginRub + TempMargin;
        else
           TempPaidMarginRub = TempPaidMarginRub + TempMargin;
        end;
     end;

     MarginCur = TempMarginCur;
     MarginRub = TempMarginRub;

     if( (ReceivedMarginRub != NULL) AND (PaidMarginRub != NULL) )
        ReceivedMarginRub = TempReceivedMarginRub;
        PaidMarginRub = TempPaidMarginRub;
     end;
  END;

  PRIVATE MACRO GetComissionSum( FD, ComissionRub:@money )
     var Query, Data;
     var TempComission:money = $0.0, TempComissionRub:money = $0.0;

     ComissionRub = $0.0;

     Query = RSDCommand( " SELECT t_Sum, t_AccFIID, t_Date " +
                         "   FROM ddvnacdl_dbt " +
                         "  WHERE t_DealID = ? " +
                         "    AND t_Date   >= ? " +
                         "    AND t_Date   <= ? " +
                         "    AND t_PayKind = ? " +
                         "    AND t_Direction = ? ");
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
     Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
     Query.addParam("", RSDBP_IN, DV_CALCOP_PAYKIND_COMMAGENT );
     Query.addParam("", RSDBP_IN, DV_CALCOP_DIRECTION_PAYMENT );

     Query.execute();
     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )

        if( Data.AccFIID == NATCUR )
           TempComission = Data.Sum;
        else
           if( not DV_SmartConvertSum( TempComission, Data.Sum, Data.Date, Data.AccFIID, NATCUR, true ) )
              return false;
           end;
        end;
        TempComissionRub = TempComissionRub + TempComission;

     end;

     ComissionRub = TempComissionRub;
  END;

  PRIVATE MACRO GetComissionSumByDLComis( DocKind:integer, DocID:integer, ComissionRub:@money, beforePeriod:bool )
     var Query, Data;
     var TempComission:money = $0.0, TempComissionRub:money = $0.0;
     var QueryString = "";

     ComissionRub = $0.0;

     QueryString = " SELECT dlcomis.t_Sum, dlcomis.t_NDS, comis.t_FIID_Comm, dlcomis.t_FactPayDate " +
                         "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis " +
                         "  WHERE dlcomis.t_DocKind     = ? " +
                         "    AND dlcomis.t_DocID       = ? " +
                         "    AND dlcomis.t_FeeType     = comis.t_FeeType " +
                         "    AND dlcomis.t_ComNumber   = comis.t_Number " +
                         "    AND comis.t_ReceiverID    <> ?";
     if( beforePeriod )
        QueryString = QueryString + " AND dlcomis.t_FactPayDate < ? ";
     else
        QueryString = QueryString + " AND dlcomis.t_FactPayDate >= ? " + " AND dlcomis.t_FactPayDate <= ? ";
     end;

     Query = RSDCommand( QueryString );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, DocKind );
     Query.addParam("", RSDBP_IN, DocID );
     Query.addParam("", RSDBP_IN, {OurBank} );

     if( beforePeriod )
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
     else
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
     end;

     Query.execute();
     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )

        if( Data.FIID_Comm == NATCUR )
           TempComission = Data.Sum - Data.NDS;
        else
           if( not DV_SmartConvertSum(TempComission, (Data.Sum - Data.NDS), Data.FactPayDate, Data.FIID_Comm, NATCUR, true) )
              return false;
           end;
        end;
        TempComissionRub = TempComissionRub + TempComission;

     end;

     ComissionRub = TempComissionRub;
  END;

  PRIVATE MACRO GetInterimSum( FD, InterimCurPayment:@money, InterimRubPayment:@money, InterimCurReception:@money, InterimRubReception:@money )
     var Query, Data;
     var TempInterim:money = $0.0;

     InterimCurPayment   = $0.0;
     InterimRubPayment   = $0.0;
     InterimCurReception = $0.0;
     InterimRubReception = $0.0;

     Query = RSDCommand( " SELECT t_Direction, t_Sum, t_AccFIID, t_Date " +
                         "   FROM ddvnacdl_dbt " +
                         "  WHERE t_DealID = ? " +
                         "    AND t_Date   >= ? " +
                         "    AND t_Date   <= ? " +
                         "    AND t_PayKind = ? ");
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
     Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
     Query.addParam("", RSDBP_IN, DV_CALCOP_PAYKIND_INTERIM );

     Query.execute();
     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )
        if( SQL_ConvTypeInteger(Data.Direction) == DV_CALCOP_DIRECTION_PAYMENT )
           InterimCurPayment = InterimCurPayment + SQL_ConvTypeSum(Data.Sum);

           if( SQL_ConvTypeInteger(Data.AccFIID) != NATCUR )
              if( not DV_SmartConvertSum( TempInterim, SQL_ConvTypeSum(Data.Sum), SQL_ConvTypeDate(Data.Date), SQL_ConvTypeInteger(Data.AccFIID), NATCUR, true ) )
                 TempInterim = $0.0;
              end;
           else
              TempInterim = SQL_ConvTypeSum(Data.Sum);
           end;
           InterimRubPayment = InterimRubPayment + TempInterim;
        else
           InterimCurReception = InterimCurReception + SQL_ConvTypeSum(Data.Sum);

           if( SQL_ConvTypeInteger(Data.AccFIID) != NATCUR )
              if( not DV_SmartConvertSum( TempInterim, SQL_ConvTypeSum(Data.Sum), SQL_ConvTypeDate(Data.Date), SQL_ConvTypeInteger(Data.AccFIID), NATCUR, true ) )
                 TempInterim = $0.0;
              end;
           else
              TempInterim = SQL_ConvTypeSum(Data.Sum);
           end;
           InterimRubReception = InterimRubReception + TempInterim;
        end;

     end;
  END;

  PRIVATE MACRO EхpirationFact( FD, ObjType, Obj ):string
     var RetVal = "нет";
     var Query, Data;

     Query = RSDCommand( " SELECT COUNT(1) AS CountStep " +
                         "   FROM doprstep_dbt step, doproper_dbt oper " +
                         "  WHERE oper.t_DocKind      = ? AND " +
                         "        oper.t_DocumentID   = ? AND " +
                         "        step.t_ID_Operation = oper.t_ID_Operation AND " +
                         "        step.t_Symbol       in('i','Б','b','З') AND " +
                         "        step.t_IsExecute    = chr(88) AND " + 
                         "        step.t_Fact_Date    <= ? ");
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Kind );
     Query.addParam("", RSDBP_IN, UniID(Obj, ObjType) );
     Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
     Query.execute();

     Data = TRsbDataSet(Query);
     if( Data.MoveNext() and (Data.CountStep > 0) )
        RetVal = "да";
     end;

     return RetVal;
  END;

  PRIVATE MACRO ТипИсполнения( FD ):string
     var RetVal:string = "";

     if( FD.Kind == DL_DVFXDEAL )
        RetVal = "Поставочный";
     elif( FD.ПоставочныйКонтракт() )
        RetVal = "Поставочный";
     else
        RetVal = "Расчетный";
     end;

     return RetVal;
  END;

  private macro ЧислоСЗаданнойТочностью( _var, _point:integer, _parm:string ) 
    var TmpStr:string;
    if( (valtype (_var) == V_DOUBLE) OR (valtype (_var) == V_MONEY) )
      if((valtype (_parm) == V_UNDEF) OR (_parm == ""))
        TmpStr = "String(_var:0" + ":" + string(_point) + ")";
      else
        TmpStr = "String(_var:0" + ":" + string(_point) + ":" + _parm + ")";
      end;
      return ExecExp(TmpStr);
    else
      return String(_var);
    end;
  end;

  private macro IsControlDeal( FD )
     var Contractor = TRecHandler("party.dbt");
     var NumInList = "", ValidFromDate = DATE(0,0,0);
     var ObjType, Obj, ContractorID;

     if( FD.Kind == DL_DVNDEAL )
        ObjType = OBJTYPE_OUTOPER_DV;
     else
        ObjType = OBJTYPE_FXOPER_DV;
     end;

     Obj     = FD.Deal;
     ContractorID = FD.Deal.rec.Contractor;

     return ( (StrUpr(DL_GetObjAttrName(ObjType, 2/*Контролируемая сделка (НК)*/, DL_GetMainObjAttr(Obj, 2/*Контролируемая сделка (НК)*/, ObjType))) == "ДА") OR
              ( (ПолучитьСубъекта(ContractorID, Contractor) == 0) and 
                (GetMainObjAttr(null, OBJTYPE_PARTY, UniID(Contractor, OBJTYPE_PARTY), PARTY_ATTR_GROUP_KIND_INTERDEPENDENCE, NULL, NULL, NumInList, FD.ДатаСделки(), ValidFromDate) == true) and
                (ValidFromDate <= FD.ДатаСделки()) and
                (NumInList != "")
              )
            );
  end;

  PRIVATE MACRO ПолучитьСуммуПлюсМинусПфи( NumList:integer, BA_Kind_1824:integer, DvKind:integer, isPlus:bool):money

     file RepFile() txt write;
     var AccBuf  = TRecHandler("account");
     var NRec = 0; 
     var CatCode = "",  CatCode_2 = " "; /*PNV 524629*/
     var RsdDVQuery  = DL_RSdCommand(); var DVNDealData;
     var DVQuery = "", DvQueryTmp = "";
     var RetVal = $0.0;
     var Query, Data, Sql;

     if (NumList != NUM_LIST_NOT_FISS)
        CatCode = IIF(isPlus, КатДохПФИ, КатРсхПФИ);
        CatCode_2 = IIF(isPlus, КатДохПФИ_usr, КатРсхПФИ_usr);/*PNV 524629*/
     else
        CatCode = IIF(isPlus, КатПлМаржаИВиДМ, КатМнМаржаИВиДМ);
     end;
     DVQuery = " SELECT acd.t_Account as Account " +
                   " FROM dmcaccdoc_dbt acd, dmccateg_dbt cat, dmctempl_dbt tpl " +
                   "   WHERE acd.t_Chapter = 1 " +
                   "    AND acd.t_CatID = cat.t_ID      " +
                   "    AND cat.T_CODE  in( '" + CatCode + "', '" + CatCode_2 + "' )" +/*PNV 524629*/
                   "    AND cat.T_LEVELTYPE = 1     " +
                   "    AND tpl.t_CatID = cat.t_ID      " +
                   "    AND acd.t_TemplNum = tpl.t_Number     " +
                   "    AND acd.t_CatID = tpl.t_CatID            ";
     DvQueryTmp = DvQuery;
     if( (NumList == NUM_LIST_FO) or (NumList == NUM_LIST_OP) or (NumList == NUM_LIST_FO_2) )
        if ( (DvKind == DV_FORWARD) or (DvKind == DV_FORWARD_T3) or (DvKind == 0) )
           DvQuery = DvQueryTmp;
           DvQuery = DvQuery + " AND DECODE( 1825, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = 2";

           DvQuery = DvQuery + " AND DECODE( 1824, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = " + BA_Kind_1824;
           DVQuery = DVQuery + " group by  acd.t_Account ";

           NRec = RsdDVQuery.GetCount(DVQuery);
           if( NRec > 0 )
              DVNDealData = RsdDVQuery.execute(DVQuery);
              DVNDealData.MoveNext();
              if( DV_GetAccount( null, null, DVNDealData.Account, AccBuf, true ) == true )
                 RetVal = RetVal + DL_GetRestAccount( AccBuf.rec, DVNTaxRegRepFormData.EndDate );   
              end;
           end;
        end;  
        if ( (DvKind == DV_OPTION) or (DvKind == 0) )
           DvQuery = DvQueryTmp;
           DvQuery = DvQuery + " AND DECODE( 1825, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = 3";

           DvQuery = DvQuery + " AND DECODE( 1824, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = " + BA_Kind_1824;
           DVQuery = DVQuery + " group by  acd.t_Account ";
           NRec = RsdDVQuery.GetCount(DVQuery);

           if( NRec > 0 )
              DVNDealData = RsdDVQuery.execute(DVQuery);
              DVNDealData.MoveNext();

              Sql = " SELECT COALESCE(Sum(trans.T_SUM_NATCUR),0) as SumPay  " +
                    "   FROM doprkoper_dbt oprkind, doproper_dbt operation, doprdocs_dbt oprdocs, dacctrn_dbt trans  " +
                    "  WHERE trans.T_ACCOUNT_PAYER  = '" + DVNDealData.Account +"'"+
                    "  AND trans.T_STATE = 1 "+
                    "  AND trans.T_DATE_CARRY <= ? "+
                    "  AND trans.T_DATE_CARRY >= ?"+
                    "  AND oprdocs.T_ACCTRNID = trans.T_ACCTRNID " +
                    "  AND operation.T_ID_OPERATION = oprdocs.T_ID_OPERATION " +
                    "  AND oprkind.T_KIND_OPERATION = operation.T_KIND_OPERATION "+
                    "  AND OPRKIND.T_NOTINUSE != chr(88) " +
                    "  AND OPRKIND.T_DOCKIND = " + DL_DVNDEAL +
                    "  AND OPRKIND.T_SYSTYPES = 'NO' ";      
              Query = RSDCommand( Sql );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
              Query.execute();
              Data = TRsbDataSet(Query);
              if( Data.MoveNext() )
                 if (isPlus)
                    RetVal = RetVal - Data.SumPay;
                 else
                    RetVal = RetVal + Data.SumPay;
                 end;
              end;

              Sql = " SELECT COALESCE(Sum(trans.T_SUM_NATCUR),0) as SumReceive  " +
                    "   FROM doprkoper_dbt oprkind, doproper_dbt operation, doprdocs_dbt oprdocs, dacctrn_dbt trans  " +
                    "  WHERE trans.T_ACCOUNT_RECEIVER  = '" + DVNDealData.Account +"'"+
                    "  AND trans.T_STATE = 1 "+
                    "  AND trans.T_DATE_CARRY <= ? "+
                    "  AND trans.T_DATE_CARRY >= ?"+
                    "  AND oprdocs.T_ACCTRNID = trans.T_ACCTRNID " +
                    "  AND operation.T_ID_OPERATION = oprdocs.T_ID_OPERATION " +
                    "  AND oprkind.T_KIND_OPERATION = operation.T_KIND_OPERATION "+
                    "  AND OPRKIND.T_NOTINUSE != chr(88) " +
                    "  AND OPRKIND.T_DOCKIND = " + DL_DVNDEAL +
                    "  AND OPRKIND.T_SYSTYPES = 'NO' ";                    
              Query = RSDCommand( Sql );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
              Query.execute();
              Data = TRsbDataSet(Query);
              if( Data.MoveNext() )
                 if (isPlus)
                    RetVal = RetVal + Data.SumReceive;
                 else
                    RetVal = RetVal - Data.SumReceive;
                 end;
              end;
            end; 
        end;
     elif( NumList == NUM_LIST_CS )
        if ( (DvKind == DV_CURSWAP) or (DvKind == DV_CURSWAP_FX) or (DvKind == 0) )
           DvQuery = DvQueryTmp;
           DvQuery = DvQuery + " AND DECODE( 1825, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = 4";

           DvQuery = DvQuery + " AND DECODE( 1824, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = " + BA_Kind_1824;
           DVQuery = DVQuery + " group by  acd.t_Account ";
           
           NRec = RsdDVQuery.GetCount(DVQuery);
           if( NRec > 0 )
              DVNDealData = RsdDVQuery.execute(DVQuery);
              DVNDealData.MoveNext();

              Sql = " SELECT COALESCE(Sum(trans.T_SUM_NATCUR),0) as SumPay  " +
                    "   FROM doprkoper_dbt oprkind, doproper_dbt operation, doprdocs_dbt oprdocs, dacctrn_dbt trans  " +
                    "  WHERE trans.T_ACCOUNT_PAYER  = '" + DVNDealData.Account +"'"+
                    "  AND trans.T_STATE = 1 "+
                    "  AND trans.T_DATE_CARRY <= ? "+
                    "  AND trans.T_DATE_CARRY >= ?"+
                    "  AND oprdocs.T_ACCTRNID = trans.T_ACCTRNID " +
                    "  AND operation.T_ID_OPERATION = oprdocs.T_ID_OPERATION " +
                    "  AND oprkind.T_KIND_OPERATION = operation.T_KIND_OPERATION ";
              /*учитываем 4813 и 4815, чтобы вошли старые сделки по закрытым операциям 2740 и 2746*/
              if (DvKind == 0)
                 Sql = Sql + "  AND ((OPRKIND.T_DOCKIND = "+DL_DVNDEAL+" AND OPRKIND.T_SYSTYPES IN('NS','NH')) or (OPRKIND.T_DOCKIND in("+DL_DVFXDEAL+","+DL_DVDEALT3+") and OPRKIND.T_SYSTYPES = 'S')) ";
              elif (DvKind == DV_CURSWAP)
                 Sql = Sql + "  AND ((OPRKIND.T_DOCKIND = "+DL_DVNDEAL+" AND OPRKIND.T_SYSTYPES = 'NS') or (OPRKIND.T_DOCKIND = "+DL_DVDEALT3+" and OPRKIND.T_SYSTYPES = 'S')) ";
              else
                 Sql = Sql + "  AND ((OPRKIND.T_DOCKIND = "+DL_DVNDEAL+" AND OPRKIND.T_SYSTYPES = 'NH') or (OPRKIND.T_DOCKIND = "+DL_DVFXDEAL+" and OPRKIND.T_SYSTYPES = 'S')) ";
              end;      
              Query = RSDCommand( Sql );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
              Query.execute();
              Data = TRsbDataSet(Query);
              if( Data.MoveNext() )
                 if (isPlus)
                    RetVal = RetVal - Data.SumPay;
                 else
                    RetVal = RetVal + Data.SumPay;
                 end;
              end;

              Sql = " SELECT COALESCE(Sum(trans.T_SUM_NATCUR),0) as SumReceive  " +
                    "   FROM doprkoper_dbt oprkind, doproper_dbt operation, doprdocs_dbt oprdocs, dacctrn_dbt trans  " +
                    "  WHERE trans.T_ACCOUNT_RECEIVER  = '" + DVNDealData.Account +"'"+
                    "  AND trans.T_STATE = 1 "+
                    "  AND trans.T_DATE_CARRY <= ? "+
                    "  AND trans.T_DATE_CARRY >= ?"+
                    "  AND oprdocs.T_ACCTRNID = trans.T_ACCTRNID " +
                    "  AND operation.T_ID_OPERATION = oprdocs.T_ID_OPERATION " +
                    "  AND oprkind.T_KIND_OPERATION = operation.T_KIND_OPERATION ";
              /*учитываем 4813 и 4815, чтобы вошли старые сделки по закрытым операциям 2740 и 2746*/
              if (DvKind == 0)
                 Sql = Sql + "  AND ((OPRKIND.T_DOCKIND = "+DL_DVNDEAL+" AND OPRKIND.T_SYSTYPES IN('NS','NH')) or (OPRKIND.T_DOCKIND in("+DL_DVFXDEAL+","+DL_DVDEALT3+") and OPRKIND.T_SYSTYPES = 'S')) ";
              elif (DvKind == DV_CURSWAP)
                 Sql = Sql + "  AND ((OPRKIND.T_DOCKIND = "+DL_DVNDEAL+" AND OPRKIND.T_SYSTYPES = 'NS') or (OPRKIND.T_DOCKIND = "+DL_DVDEALT3+" and OPRKIND.T_SYSTYPES = 'S')) ";
              else
                 Sql = Sql + "  AND ((OPRKIND.T_DOCKIND = "+DL_DVNDEAL+" AND OPRKIND.T_SYSTYPES = 'NH') or (OPRKIND.T_DOCKIND = "+DL_DVFXDEAL+" and OPRKIND.T_SYSTYPES = 'S')) ";
              end;      
              Query = RSDCommand( Sql );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
              Query.execute();
              Data = TRsbDataSet(Query);
              if( Data.MoveNext() )
                 if (isPlus)
                    RetVal = RetVal + Data.SumReceive;
                 else
                    RetVal = RetVal - Data.SumReceive;
                 end;
              end;
           end;
        end;
     elif( NumList == NUM_LIST_PS )
        if ( (DvKind == DV_PCTSWAP) or (DvKind == 0) )
           DvQuery = DvQueryTmp;
           DvQuery = DvQuery + " AND DECODE( 1825, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = 4";

           DvQuery = DvQuery + " AND DECODE( 1824, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = " + BA_Kind_1824;
           DVQuery = DVQuery + " group by  acd.t_Account ";
           
           NRec = RsdDVQuery.GetCount(DVQuery);
           if( NRec > 0 )
              DVNDealData = RsdDVQuery.execute(DVQuery);
              DVNDealData.MoveNext();

              Sql = " SELECT COALESCE(Sum(trans.T_SUM_NATCUR),0) as SumPay  " +
                    "   FROM doprkoper_dbt oprkind, doproper_dbt operation, doprdocs_dbt oprdocs, dacctrn_dbt trans  " +
                    "  WHERE trans.T_ACCOUNT_PAYER  = '" + DVNDealData.Account +"'"+
                    "  AND trans.T_STATE = 1 "+
                    "  AND trans.T_DATE_CARRY <= ? "+
                    "  AND trans.T_DATE_CARRY >= ?"+
                    "  AND oprdocs.T_ACCTRNID = trans.T_ACCTRNID " +
                    "  AND operation.T_ID_OPERATION = oprdocs.T_ID_OPERATION " +
                    "  AND oprkind.T_KIND_OPERATION = operation.T_KIND_OPERATION "+
                    "  AND OPRKIND.T_NOTINUSE != chr(88) " +
                    "  AND OPRKIND.T_DOCKIND = " + DL_DVNDEAL +
                    "  AND OPRKIND.T_SYSTYPES = 'NP' ";      
              Query = RSDCommand( Sql );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
              Query.execute();
              Data = TRsbDataSet(Query);
              if( Data.MoveNext() )
                 if (isPlus)
                    RetVal = RetVal - Data.SumPay;
                 else
                    RetVal = RetVal + Data.SumPay;
                 end;
              end;

              Sql = " SELECT COALESCE(Sum(trans.T_SUM_NATCUR),0) as SumReceive  " +
                    "   FROM doprkoper_dbt oprkind, doproper_dbt operation, doprdocs_dbt oprdocs, dacctrn_dbt trans  " +
                    "  WHERE trans.T_ACCOUNT_RECEIVER  = '" + DVNDealData.Account +"'"+
                    "  AND trans.T_STATE = 1 "+
                    "  AND trans.T_DATE_CARRY <= ? "+
                    "  AND trans.T_DATE_CARRY >= ?"+
                    "  AND oprdocs.T_ACCTRNID = trans.T_ACCTRNID " +
                    "  AND operation.T_ID_OPERATION = oprdocs.T_ID_OPERATION " +
                    "  AND oprkind.T_KIND_OPERATION = operation.T_KIND_OPERATION "+
                    "  AND OPRKIND.T_NOTINUSE != chr(88) " +
                    "  AND OPRKIND.T_DOCKIND = " +DL_DVNDEAL+
                    "  AND OPRKIND.T_SYSTYPES = 'NP' ";                    
              Query = RSDCommand( Sql );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
              Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
              Query.execute();
              Data = TRsbDataSet(Query);
              if( Data.MoveNext() )
                 if (isPlus)
                    RetVal = RetVal + Data.SumReceive;
                 else
                    RetVal = RetVal - Data.SumReceive;
                 end;
              end;
            end;
        end;
     elif( NumList == NUM_LIST_NOT_FISS )
        if ( ((DvKind == DV_FORWARD_FX) or (DvKind == DV_BANKNOTE_FX) or (DvKind == 0)) and (BA_Kind_1824 == 1) or (BA_Kind_1824 == 4) )
           DvQuery = DvQueryTmp;

           DvQuery = DvQuery + " AND DECODE( 701, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = "+IIF(BA_Kind_1824 == 1, 1, 2);

           DvQuery = DvQuery + " AND DECODE( 1821, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = " + IIF(BA_Kind_1824 == 1, 2, -1);

           DvQuery = DvQuery + " AND DECODE( 1819, "+
                                  "cat.t_Class1, tpl.t_Value1,"+
                                  "cat.t_Class2, tpl.t_Value2,"+
                                  "cat.t_Class3, tpl.t_Value3,"+
                                  "cat.t_Class4, tpl.t_Value4,"+
                                  "cat.t_Class5, tpl.t_Value5,"+
                                  "cat.t_Class6, tpl.t_Value6,"+
                                  "cat.t_Class7, tpl.t_Value7,"+
                                  "cat.t_Class8, tpl.t_Value8, -1"+               
                                ") = 0";
           DVQuery = DVQuery + " group by  acd.t_Account ";

           NRec = RsdDVQuery.GetCount(DVQuery);
           if( NRec > 0 )
              DVNDealData = RsdDVQuery.execute(DVQuery);
              DVNDealData.MoveNext();
              if( DV_GetAccount( null, null, DVNDealData.Account, AccBuf, true ) == true )
                 RetVal = RetVal + DL_GetRestAccount( AccBuf.rec, DVNTaxRegRepFormData.EndDate );   
              end;
           end;
        end;  
     end;
     return RetVal;   
  END;


  PRIVATE MACRO ПолучитьСуммуИзПроводок( FD, DVNTaxRegRepFormData, isDemand:bool, inPeriod:bool ):money
 
     var DVQuery, DVNData;
     var RsdDVQuery  = DL_RSdCommand();
     var i = 0;
     var RetVal:money = $0.0;
     file RepFile() txt write;
 
     DVQuery = " SELECT COALESCE(Sum(TRANS.T_SUM_NATCUR),0) SumDL " +
               " FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper " +
               " WHERE ltrim(oper.T_DOCUMENTID) = ? and oper.T_DOCKIND = ? and oprdocs.T_ID_OPERATION = oper.T_ID_OPERATION AND trans.T_ACCTRNID = OPRDOCS.T_ACCTRNID and trans.T_STATE = 1 ";
     RsdDVQuery.addParam(FD.Deal.rec.ID);
     RsdDVQuery.addParam(DL_DVNDEAL);

     if (isDemand)
        DVQuery = DVQuery +
                  " AND EXISTS (select * from dmccateg_dbt mccat, dmcaccdoc_dbt accdoc where accdoc.t_Account = TRANS.T_ACCOUNT_PAYER /*AND accdoc.T_DOCKIND = oper.T_DOCKIND */AND mccat.T_ID = accdoc.T_CATID AND mccat.T_CODE = ?) "+
                  " AND EXISTS (select * from dmccateg_dbt mccat, dmcaccdoc_dbt accdoc where accdoc.t_Account = TRANS.T_ACCOUNT_RECEIVER  /*AND accdoc.T_DOCKIND = oper.T_DOCKIND*/  AND mccat.T_ID = accdoc.T_CATID AND mccat.T_CODE = ?) ";

        RsdDVQuery.addParam(КатВыбПФИ);
        RsdDVQuery.addParam(КатПлПФИ);
     else
        DVQuery = DVQuery +
                  " AND EXISTS (select * from dmccateg_dbt mccat, dmcaccdoc_dbt accdoc where accdoc.t_Account = TRANS.T_ACCOUNT_RECEIVER /*AND accdoc.T_DOCKIND = oper.T_DOCKIND*/ AND mccat.T_ID = accdoc.T_CATID AND mccat.T_CODE IN(?,?, ?, ?) ) "; /*PNV 524629*/

        RsdDVQuery.addParam(КатДохПФИ);
        RsdDVQuery.addParam(КатДохПФИ_usr); /*PNV 524629*/
        RsdDVQuery.addParam(КатРсхПФИ);        
        RsdDVQuery.addParam(КатРсхПФИ_usr); /*PNV 524629*/        
     end;

     if (not inPeriod)
        DVQuery = DVQuery + " AND trans.T_DATE_CARRY < ?";
        RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);
     else
        DVQuery = DVQuery + " AND trans.T_DATE_CARRY >= ? AND trans.T_DATE_CARRY <= ? ";
        RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);
        RsdDVQuery.addParam(DVNTaxRegRepFormData.EndDate);
     end;

     DVQuery = DVQuery + 
               " UNION ALL SELECT COALESCE(-Sum(TRANS.T_SUM_NATCUR),0) SumDL " +
               " FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper "+
               " WHERE ltrim(oper.T_DOCUMENTID) = ? and oper.T_DOCKIND = ? and oprdocs.T_ID_OPERATION = oper.T_ID_OPERATION AND trans.T_ACCTRNID = OPRDOCS.T_ACCTRNID and trans.T_STATE = 1 ";
     RsdDVQuery.addParam(FD.Deal.rec.ID);
     RsdDVQuery.addParam(DL_DVNDEAL);

     if (isDemand)
        DVQuery = DVQuery +
                  " AND EXISTS (select * from dmccateg_dbt mccat, dmcaccdoc_dbt accdoc where accdoc.t_Account = TRANS.T_ACCOUNT_PAYER /*AND accdoc.T_DOCKIND = oper.T_DOCKIND*/ AND mccat.T_ID = accdoc.T_CATID AND mccat.T_CODE = ?) " +
                  " AND EXISTS (select * from dmccateg_dbt mccat, dmcaccdoc_dbt accdoc where accdoc.t_Account = TRANS.T_ACCOUNT_RECEIVER  /*AND accdoc.T_DOCKIND = oper.T_DOCKIND*/ AND mccat.T_ID = accdoc.T_CATID AND mccat.T_CODE = ? ) ";

        RsdDVQuery.addParam(КатМнПФИ);
        RsdDVQuery.addParam(КатВыбПФИ);
     else
        DVQuery = DVQuery +
                  " AND EXISTS (select * from dmccateg_dbt mccat, dmcaccdoc_dbt accdoc where accdoc.t_Account = TRANS.T_ACCOUNT_PAYER /*AND accdoc.T_DOCKIND = oper.T_DOCKIND*/ AND mccat.T_ID = accdoc.T_CATID AND mccat.T_CODE IN(?, ?, ?, ?) ) "; /*PNV 524629*/
        RsdDVQuery.addParam(КатДохПФИ);
        RsdDVQuery.addParam(КатДохПФИ_usr); /*PNV 524629*/
        RsdDVQuery.addParam(КатРсхПФИ);
        RsdDVQuery.addParam(КатРсхПФИ_usr); /*PNV 524629*/

     end;

     if (not inPeriod)
        DVQuery = DVQuery + " AND trans.T_DATE_CARRY < ?";
        RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);
     else
        DVQuery = DVQuery + " AND trans.T_DATE_CARRY >= ? AND trans.T_DATE_CARRY <= ? ";
        RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);
        RsdDVQuery.addParam(DVNTaxRegRepFormData.EndDate);
     end;

     DVNData = RsdDVQuery.execute(DVQuery);
     while( DVNData.MoveNext() )
        RetVal = RetVal + DVNData.SumDL;
     end;
     return RetVal;
  END;

  PRIVATE MACRO ПолучитьСуммуИзПроводокПоМаскам( FD, DateFrom, DateTo ):money

     var DVQuery, DVNData;
     var RsdDVQuery  = DL_RSdCommand();
     var RetVal:money = $0.0;
     file RepFile() txt write;

     DVQuery = " SELECT COALESCE(Sum(TRANS.T_SUM_NATCUR),0) SumDL " +
               " FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper " +
               " WHERE ltrim(oper.T_DOCUMENTID) = ? and oper.T_DOCKIND = ? and oprdocs.T_ID_OPERATION = oper.T_ID_OPERATION AND trans.T_ACCTRNID = OPRDOCS.T_ACCTRNID and trans.T_STATE = 1 " +
               " AND trans.T_ACCOUNT_PAYER LIKE '47408%' " + 
               " AND trans.T_ACCOUNT_RECEIVER LIKE '61601%' " + 
               " AND trans.T_DATE_CARRY <= ? ";
     RsdDVQuery.addParam(FD.Deal.rec.ID);
     RsdDVQuery.addParam(DL_DVNDEAL);
     RsdDVQuery.addParam(DateTo);
     if ( valtype(DateFrom) != V_UNDEF)
       DVQuery = DVQuery + " AND trans.T_DATE_CARRY >= ?";
       RsdDVQuery.addParam(DateFrom);
     end;
     

     DVQuery = DVQuery + 
               " UNION ALL SELECT COALESCE(-Sum(TRANS.T_SUM_NATCUR),0) SumDL " +
               " FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper "+
               " WHERE ltrim(oper.T_DOCUMENTID) = ? and oper.T_DOCKIND = ? and oprdocs.T_ID_OPERATION = oper.T_ID_OPERATION AND trans.T_ACCTRNID = OPRDOCS.T_ACCTRNID and trans.T_STATE = 1 " +
               " AND trans.T_ACCOUNT_PAYER LIKE '61601%' " + 
               " AND trans.T_ACCOUNT_RECEIVER LIKE '47407%' " +
               " AND trans.T_DATE_CARRY <= ? ";
     RsdDVQuery.addParam(FD.Deal.rec.ID);
     RsdDVQuery.addParam(DL_DVNDEAL);
     RsdDVQuery.addParam(DateTo);
     if ( valtype(DateFrom) != V_UNDEF)
       DVQuery = DVQuery + " AND trans.T_DATE_CARRY >= ?";
       RsdDVQuery.addParam(DateFrom);
     end;

     DVNData = RsdDVQuery.execute(DVQuery);
     while( DVNData.MoveNext() )
        RetVal = RetVal + DVNData.SumDL;
     end;
     return RetVal;
  END;

  PRIVATE MACRO ПолучитьСуммуИзПроводокПоМаскамОднаЧасть( FD, DVNTaxRegRepFormData, isIncome:bool ):money

     var DVQuery, DVNData;
     var RsdDVQuery  = DL_RSdCommand();
     var RetVal:money = $0.0;
     file RepFile() txt write;
 
     DVQuery = " SELECT COALESCE(Sum(TRANS.T_SUM_NATCUR),0) SumDL " +
               " FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper " +
               " WHERE ltrim(oper.T_DOCUMENTID) = ? and oper.T_DOCKIND = ? and oprdocs.T_ID_OPERATION = oper.T_ID_OPERATION AND trans.T_ACCTRNID = OPRDOCS.T_ACCTRNID and trans.T_STATE = 1 " +
               " AND trans.T_DATE_CARRY >= ? AND trans.T_DATE_CARRY <= ? ";
     RsdDVQuery.addParam(FD.Deal.rec.ID);
     RsdDVQuery.addParam(DL_DVNDEAL);
     RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);
     RsdDVQuery.addParam(DVNTaxRegRepFormData.EndDate);

     if( isIncome )
        DVQuery = DVQuery + 
                  " AND (trans.T_ACCOUNT_PAYER LIKE '47408%' OR trans.T_ACCOUNT_PAYER LIKE '47407%') " + 
                  " AND trans.T_ACCOUNT_RECEIVER LIKE '70601%' ";
     else
        DVQuery = DVQuery + 
                  " AND trans.T_ACCOUNT_PAYER LIKE '70606%' " + 
                  " AND (trans.T_ACCOUNT_RECEIVER LIKE '47408%' OR trans.T_ACCOUNT_RECEIVER LIKE '47407%') ";
     end;

     DVNData = RsdDVQuery.execute(DVQuery);
     while( DVNData.MoveNext() )
        RetVal = RetVal + DVNData.SumDL;
     end;
     return RetVal;
  END;

  PRIVATE MACRO ПолучитьСуммуИзПроводокПоБА( FD, isBuy:bool, BegDate, EndDate, SettlementState:bool):money
 
     var DVQuery, DVNData;
     var RsdDVQuery  = DL_RSdCommand();
     var RetVal:money = $0.0;
     file RepFile() txt write;

     DVQuery = " SELECT COALESCE(Sum(TRANS.T_SUM_NATCUR),0) SumDL " +
               " FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper " +
               " WHERE ltrim(oper.T_DOCUMENTID) = ? and oper.T_DOCKIND = ? and oprdocs.T_ID_OPERATION = oper.T_ID_OPERATION AND trans.T_ACCTRNID = OPRDOCS.T_ACCTRNID and trans.T_STATE = 1 " +
               " AND  ? <= trans.T_DATE_CARRY AND trans.T_DATE_CARRY <= ? ";
     RsdDVQuery.addParam(FD.Deal.rec.ID);
     RsdDVQuery.addParam(DL_DVNDEAL);
     RsdDVQuery.addParam(BegDate);
     RsdDVQuery.addParam(EndDate);
     
     if( isBuy )
       DVQuery = DVQuery + " AND ((trans.T_ACCOUNT_PAYER LIKE '47408%' OR trans.T_ACCOUNT_PAYER LIKE '47407%') " + 
                           " AND trans.T_ACCOUNT_RECEIVER LIKE '52601%' ";
       if( not SettlementState )
          DVQuery = DVQuery + "  OR trans.T_ACCOUNT_PAYER LIKE '47408%' " + 
                           " AND trans.T_ACCOUNT_RECEIVER LIKE '61601%' )";
       else
          DVQuery = DVQuery + " )";
       end;
     else
       DVQuery = DVQuery + " AND (trans.T_ACCOUNT_PAYER LIKE '52602%' " + 
                           " AND (trans.T_ACCOUNT_RECEIVER LIKE '47408%' OR trans.T_ACCOUNT_RECEIVER LIKE '47407%') ";
       if( not SettlementState )
          DVQuery = DVQuery + "  OR trans.T_ACCOUNT_PAYER LIKE '61601%' " + 
                           " AND trans.T_ACCOUNT_RECEIVER LIKE '47407%' )";
       else
          DVQuery = DVQuery + " )";
       end;
     end;

     DVNData = RsdDVQuery.execute(DVQuery);
     while( DVNData.MoveNext() )
        RetVal = RetVal + DVNData.SumDL;
     end;
     return RetVal;
  END;


  PRIVATE MACRO GetPremiumSum( FD, PremiumRub:@money, beforePeriod:bool )
     var Query, Data;
     var TempPremium:money = $0.0, TempPremiumRub:money = $0.0;
     var QueryString = "";

     PremiumRub = $0.0;
     
     QueryString = " SELECT * " +
                         "   FROM dpmpaym_dbt  " +
                         "  WHERE t_DocumentID = ? " +
                         "  AND   t_Purpose = 6 " +
                         "  AND   t_DocKind = 199  ";

     if( beforePeriod )
        QueryString = QueryString + " AND t_ValueDate   < ? ";
     else
        QueryString = QueryString + " AND t_ValueDate   >= ? " + " AND t_ValueDate <= ? ";
     end;

     Query = RSDCommand( QueryString );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
     if( beforePeriod )
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
     else
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.BegDate );
        Query.addParam("", RSDBP_IN, DVNTaxRegRepFormData.EndDate );
     end;

     Query.execute();
     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )
        TempPremium = Data.Amount;
        if( Data.FIID != NATCUR )
           if( not DV_SmartConvertSum( TempPremium, TempPremium, Data.ValueDate, Data.FIID, NATCUR, true ) )
              return false;
           end;
        end;
        TempPremiumRub = TempPremiumRub + TempPremium;
     end;
     PremiumRub = TempPremiumRub;

     if( FD.Deal.rec.Type == ALG_DV_BUY )
        PremiumRub = -PremiumRub;
     end;
  END;

  PRIVATE MACRO ОстатокНаПарномСчёте(FD, Дата:date, AccRest:@money)

     var DVQuery, DVNData_ПлПФИ, DVNData_МнПФИ;
     var RsdDVQuery_ПлПФИ  = DL_RSdCommand();
     var RsdDVQuery_МнПФИ  = DL_RSdCommand();
     var AccBuf  = TRecHandler("account");
     AccRest = $0.0;

     DVQuery = "SELECT T_ACCOUNT " + 
               "  FROM (  SELECT ACCDOC.T_ACCOUNT " + 
               "            FROM dmccateg_dbt mccat, dmcaccdoc_dbt accdoc " + 
               "           WHERE     ACCDOC.T_DOCID = ? " + 
               "                 AND accdoc.T_DOCKIND = ? " + 
               "                 AND mccat.T_ID = accdoc.T_CATID " + 
               "                 AND mccat.T_CODE = ? " + 
               "                 AND (   ACCDOC.T_DISABLINGDATE > " + 
               "                            ? " + 
               "                      OR (    ACCDOC.T_ACTIVATEDATE <= " + 
               "                                 ? " + 
               "                          AND ACCDOC.T_DISABLINGDATE = " + 
               "                                 TO_DATE ('01/01/0001', 'dd/mm/yyyy'))) " + 
               "        ORDER BY ACCDOC.T_ACTIVATEDATE DESC, ACCDOC.T_DISABLINGDATE DESC) " + 
               " WHERE ROWNUM = 1; ";
     RsdDVQuery_ПлПФИ.addParam(FD.Deal.rec.ID);
     RsdDVQuery_ПлПФИ.addParam(DL_DVNDEAL);
     RsdDVQuery_ПлПФИ.addParam(КатПлПФИ);
     RsdDVQuery_ПлПФИ.addParam(Дата);
     RsdDVQuery_ПлПФИ.addParam(Дата);

     DVNData_ПлПФИ = RsdDVQuery_ПлПФИ.execute(DVQuery);
     while ( DVNData_ПлПФИ.MoveNext() )
       if( DV_GetAccount( null, null, DVNData_ПлПФИ.Account, AccBuf, true ) == true )
         AccRest = AccRest + abs(DL_GetRestAccount( AccBuf.rec, Дата ));   
       end;
     end;

     if (AccRest == $0.0)
       RsdDVQuery_МнПФИ.addParam(FD.Deal.rec.ID);
       RsdDVQuery_МнПФИ.addParam(DL_DVNDEAL);
       RsdDVQuery_МнПФИ.addParam(КатМнПФИ);
       RsdDVQuery_МнПФИ.addParam(Дата);
       RsdDVQuery_МнПФИ.addParam(Дата);
     
       DVNData_МнПФИ = RsdDVQuery_МнПФИ.execute(DVQuery);
       while ( DVNData_МнПФИ.MoveNext() )
         if( DV_GetAccount( null, null, DVNData_МнПФИ.Account, AccBuf, true ) == true )
           AccRest = AccRest - abs(DL_GetRestAccount( AccBuf.rec, Дата ));   
         end;
       end;
     end;

  END;  

  MACRO ДатаПлатежаПремииПоОпциону(FD)
     var Query, Data;
     var QueryString = "";
     var DateString:date = zerodate;
     var cnt = 0;

     var pm_Pr = TRecHandler( "pmpaym.dbt" ); 


     if ( NOT FindPayment( null, PRi, 0, DL_DVNDEAL, FD.Deal.rec.ID, true, pm_Pr, NULL, NULL, NULL ) )
       DateString = SQL_ConvTypeDate(pm_Pr.rec.ValueDate);
     end;
     return DateString;
  END;

  PRIVATE MACRO ПечататьФорвард( FD, NumStr:integer, All_MarginRub:@money, All_N1_20:@money, All_N1_21:@money, All_N1_22:@money, All_N1_25:@money, All_N1_26:@money, All_N1_27:@money, All_N1_28:@money, All_N1_29:@money, NumList )
     var BaseActivFIID:integer = ALLFININSTR, BaseActiveCode:string = "", BaseActiveName:string = "", SumPrecision:integer = 0;
     var MarginCur:money = $0.0, MarginRub:money = $0.0;
     var MarketPrice:money = $0.0;
     var ExpirationPriceCur, Point:integer = 0, Qnty:money = 0, PriceCurrency:integer = ALLFININSTR, ContractType:string = "";
     var InitialActiveCode:string = "", InitialActiveName:string = "";
     var Contractor:integer = -1;
     var ObjType, Obj, NoteKind;
     var N1_20, N1_21, CurCB = 0.0, CurCB_Str = "", CurPrC = 0.0, CurPrC_Str = "", ExpPrCur = 0.0,  ExpPrCur_Str = "";

     var QntyInitialActive:money = $0.0; 
     var RateBaseCurDealDate:money = $0.0, RateExecCurDealDate:money = $0.0, RateSpot:money = $0.0, RateBaseCurDateExec:money = $0.0;
     var RateExecCurDateExec:money = $0.0, N1_22:money = $0.0, N1_25:money = $0.0, N1_26:money = $0.0, N1_27:money = $0.0, N1_28:money = $0.0, N1_29:money = $0.0;
     var DeltaStr:string = string(Delta + NumStr);
     var RateCur:money = $0.0, MrgCur:money = $0.0, MrgRub:money = $0.0, ComissRub:money = $0.0, PremSumRub:money = $0.0, PremSumCur:money = $0.0;

     if( FD.Kind == DL_DVNDEAL )
        BaseActivFIID      = FD.nFI_BaseActiv.rec.FIID;
        ExpirationPriceCur = FD.nFI_BaseActiv.rec.Price;
        Point              = FD.nFI_BaseActiv.rec.Point;
        Qnty               = FD.nFI_BaseActiv.rec.Amount;
        PriceCurrency      = FD.nFI_BaseActiv.rec.PriceFIID;
        ContractType       = FD.DvKindName();
        InitialActiveCode  = FD.InitialFI().rec.FI_Code;
        InitialActiveName  = FD.InitialFI().rec.Name;
        Contractor         = FD.Deal.rec.Contractor;
        ObjType            = OBJTYPE_OUTOPER_DV;
        Obj                = FD.Deal;
        NoteKind           = NOTEKIND_DVNDEAL_MARKETPRICE;
        GetMarginSum(FD, @MarginCur, @MarginRub, PriceCurrency);
        QntyInitialActive  = Qnty * ExpirationPriceCur + FD.nFI_BaseActiv.rec.NKD;
     end;

     BaseActive(BaseActivFIID, @BaseActiveCode, @BaseActiveName, @SumPrecision);

     var ControlDeal = IsControlDeal(FD);

     MarketPrice = readNoteForObject(ObjType, UniID(Obj, ObjType), NoteKind);

     if( (MarketPrice == 0) and
         ((FD.ДатаСделки() >= Date(1,1,2016)) and (ControlDeal != true))
        )
        MarketPrice = ExpirationPriceCur;
     end;

     if( (MarketPrice == 0) and (FD.Kind == DL_DVNDEAL) )
        var Demand:money = $0, Liability:money = $0;
        GetSetDVSSCost(FD.Deal.rec.ID, DEALKIND_MRK_OUT, FD.ДатаСделки(), @Demand, @Liability);
        if( FD.IsBuy() and (Liability != 0) )
           MarketPrice = Demand * ExpirationPriceCur / Liability;
        elif( FD.IsSale() and (Demand != 0) )
           MarketPrice = Liability * ExpirationPriceCur / Demand;
        end;
     end;

     if( ПолучитьКурсЗаданногоTипа( @RateBaseCurDealDate, BaseActivFIID, NATCUR, DV_RATETYPE_CBR, FD.ДатаСделки(), true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаСделки()));
        RateBaseCurDealDate = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа( @RateExecCurDealDate, PriceCurrency, NATCUR, DV_RATETYPE_CBR, FD.ДатаСделки(), true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(PriceCurrency) + " на дату " + String(FD.ДатаСделки()));
        RateExecCurDealDate = 0.0;
     end;

     RateSpot = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RATESPOT);

     if ( FD.ДатаИсполнения() != date(0,0,0) )
        if( ПолучитьКурсЗаданногоTипа( @RateBaseCurDateExec, BaseActivFIID, NATCUR, DV_RATETYPE_CBR, FD.ДатаИсполнения(), true ) == false )
           MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаИсполнения()));
           RateBaseCurDateExec = 0.0;
        end;

        if( ПолучитьКурсЗаданногоTипа( @RateExecCurDateExec, PriceCurrency, NATCUR, DV_RATETYPE_CBR, FD.ДатаИсполнения(), true ) == false )
           MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(PriceCurrency) + " на дату " + String(FD.ДатаИсполнения()));
           RateExecCurDateExec = 0.0;
        end;
     end;

     N1_20 = N1_21 = 0.0;

     if( (FD.ДатаИсполнения() != date(0,0,0)) and 
         (FD.ДатаИсполнения() <= DVNTaxRegRepFormData.EndDate) and
         not( (FD.BaseFI().rec.FI_Kind == FIKIND_AVOIRISS) or      // не FD.ВидБазовогоАктива(), т.к. там для индексов возвращается их вид
              (FD.BaseFI().rec.FI_Kind == FIKIND_METAL) or 
              (FD.BaseFI().rec.FI_Kind == FIKIND_ARTICLE) or 
              (FD.BaseFI().rec.FI_Kind == FIKIND_INDEX)
            )
       )
        if( FD.ПоставочныйКонтракт() )
           if( (RateSpot != 0) or (RateBaseCurDateExec != 0) )
              if( (PriceCurrency != NATCUR) and (RateExecCurDateExec == 0) )
                 N1_20 = N1_21 = 0.0;
              else
                 RateCur = IIF(RateSpot == 0, RateBaseCurDateExec, RateSpot);
                 ExpPrCur = ExpirationPriceCur;
                 if( PriceCurrency != NATCUR )
                    ExpPrCur = ExpPrCur * RateExecCurDateExec;
                 end;
                 if( FD.Deal.rec.Type == ALG_DV_BUY )
                    if( (Qnty * (RateCur - ExpPrCur)) > 0 )
                       N1_20 = Qnty * (RateCur - ExpPrCur);
                    else
                       N1_21 = abs(Qnty * (RateCur - ExpPrCur));
                    end;
                 else
                    if( (Qnty * (ExpPrCur - RateCur)) > 0 )
                       N1_20 = Qnty * (ExpPrCur - RateCur);
                    else
                       N1_21 = abs(Qnty * (ExpPrCur - RateCur));
                    end;
                 end;
              end;
           end;
        else
           if( MarginRub > 0 )
              N1_20 = MarginRub;
           else
              N1_21 = abs(MarginRub);
           end;
        end;
     end;

     N1_22 = N1_20 - N1_21;
 
     if ( (FD.ДатаСделки() < DVNTaxRegRepFormData.BegDate) and (FD.ДатаИсполнения() >= DVNTaxRegRepFormData.BegDate) )
        GetMarginSum(FD, @MrgCur, @MrgRub, PriceCurrency, true);
        GetComissionSumByDLComis(FD.Kind, FD.ID, @ComissRub, true);
        N1_29 = MrgRub - ComissRub;      
     end;

     N1_25 = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, true);
     N1_26 = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, false);   

     if( (FD.ДатаСделки() < DVNTaxRegRepFormData.BegDate) and ( (FD.ДатаИсполнения() > DVNTaxRegRepFormData.BegDate) or (FD.ДатаИсполнения() == date(0,0,0)) ) )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.BegDate, @N1_27);
     end;
     if( (FD.ДатаИсполнения() > DVNTaxRegRepFormData.EndDate) or (FD.ДатаИсполнения() == date(0,0,0)) )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.EndDate, @N1_28);
     end;

     PrintLine1( FD.ДатаСделки(),
                 FD.DealCode(),
                 Direction(FD),
                 ContractType,
                 BaseActiveCode,
                 BaseActiveName,
                 InitialActiveCode,
                 InitialActiveName,
                 IIF((FD.ДатаИсполнения() == date(0,0,0) ), "00.00.0000",  FD.ДатаИсполнения()),
                 Qnty,
                 ПолучитьИмяСубъекта(Contractor),
                 ЧислоСЗаданнойТочностью(ExpirationPriceCur, Point, ""),
                 ЧислоСЗаданнойТочностью(RateBaseCurDealDate, 6, ""),
                 ЧислоСЗаданнойТочностью(RateExecCurDealDate, 6, ""),           
                 GetFI_CODE(PriceCurrency),
                 ЧислоСЗаданнойТочностью(RateSpot, Point, ""),
                 ЧислоСЗаданнойТочностью(RateBaseCurDateExec, 6, ""),           
                 ЧислоСЗаданнойТочностью(RateExecCurDateExec, 6, ""),           
                 MarginCur,
                 MarginRub,
                 N1_20,
                 N1_21,
                 N1_22,
                 EхpirationFact(FD, ObjType, Obj),
                 ТипИсполнения(FD),
                 N1_25, N1_26, N1_27, N1_28, N1_29, FD.Deal.rec.ExtCode, 
                 GetPointForNumList(NumList) 
                 ,F_N1_NU1()
                 ,F_N1_NU2()
                 ,F_N1_NU3()
                 ,F_N1_NU4()
                 ,F_N1_K1()
                 ,F_N1_K2()
               );

     All_MarginRub     = All_MarginRub     + MarginRub;
     All_N1_20         = All_N1_20         + N1_20;
     All_N1_21         = All_N1_21         + N1_21;
     All_N1_22         = All_N1_22         + N1_22;
     All_N1_25         = All_N1_25         + N1_25;
     All_N1_26         = All_N1_26         + N1_26;
     All_N1_27         = All_N1_27         + N1_27;
     All_N1_28         = All_N1_28         + N1_28;
     All_N1_29         = All_N1_29         + N1_29;
  END;  

  PRIVATE MACRO ПечататьОпцион( FD, NumStr:integer, All_MarginRub:@money, All_PremiumSumRub:@money, All_AddCost:@money, All_N5_23:@money, All_N5_24:@money, All_N5_25:@money, All_N5_28:@money, All_N5_29:@money, All_N5_30:@money, All_N5_31:@money, All_N5_32:@money, All_N5_33:@money, All_N5_34:@money, NumList )
     var BaseActivFIID:integer = ALLFININSTR, BaseActiveCode:string = "", BaseActiveName:string = "", SumPrecision:integer = 0;
     var PremiumSumCur:money = $0.0, PremiumSumRub:money = $0.0;
     var MarginCur:money = $0.0, MarginRub:money = $0.0, ComissionRub:money = $0.0;
     var MarketPrice:money = $0.0, MarketPrice_Deal:money = $0.0;
     var ExpirationPriceCur, Point:integer = 0, Qnty:money = 0, ContractType:string = "";
     var InitialActiveCode:string = "", InitialActiveName:string = "", ExpirationType:string = "", OptionDirectionType:string = "";
     var Contractor:integer = -1, PremiumCurrency:integer = ALLFININSTR;
     var ObjType, Obj, NoteKind;
     var N5_23, N5_24, CurCB = 0.0, CurCB_Str = "", CurPrC = 0.0, CurPrC_Str = "", ExpPrCur = 0.0,  ExpPrCur_Str = "";
     var MarginCurrCode:string = "", AddCost:money = $0.0;
     var ExpiryDate = date(0,0,0), DateFrom = date(0,0,0), DateTo = date(0,0,0);

     var QntyInitialActive:money = $0.0; 
     var RateBaseCurDealDate:money = $0.0, RateExecCurDealDate:money = $0.0, RateSpot:money = $0.0, RateBaseCurDateExec:money = $0.0;
     var RateExecCurDateExec:money = $0.0, N5_25:money = $0.0, N5_28:money = $0.0, N5_29:money = $0.0, N5_30:money = $0.0, N5_31:money = $0.0, N5_32:money = $0.0, N5_33:money = $0.0, N5_34:money = $0.0;
     var DeltaStr:string = string(Delta + NumStr);
     var RateCur:money = $0.0, RatePremCurPremDate:money = $0.0;
     var MrgCur:money = $0.0, MrgRub:money = $0.0, ComissRub:money = $0.0, PremSumRub:money = $0.0, PremSumCur:money = $0.0;
     var PremiumCurrencyCode:string = "", PremiumCurrencyName:string = "", PremiunSumPrecision:integer = 0; 

     if( FD.Kind == DL_DVNDEAL )
        BaseActivFIID      = FD.nFI_BaseActiv.rec.FIID;
        ExpirationPriceCur = FD.nFI_BaseActiv.rec.Price;
        Point              = FD.nFI_BaseActiv.rec.Point;
        Qnty               = FD.nFI_BaseActiv.rec.Amount;
        ExpiryDate         = FD.nFI_BaseActiv.rec.ExpiryDate;
        ContractType       = FD.DvKindName();
        InitialActiveCode  = FD.InitialFI().rec.FI_Code;
        InitialActiveName  = FD.InitialFI().rec.Name;
        ExpirationType     = FD.OptionStyle();
        OptionDirectionType= FD.OptionType();
        Contractor         = FD.Deal.rec.Contractor;
        PremiumCurrency    = FD.Deal.rec.BonusFIID;
        ObjType            = OBJTYPE_OUTOPER_DV;
        Obj                = FD.Deal;
        NoteKind           = NOTEKIND_DVNDEAL_MARKETPRICE;
        GetMarginSum(FD, @MarginCur, @MarginRub, -1, false, NUM_LIST_OP, @MarginCurrCode);
        QntyInitialActive  = Qnty * ExpirationPriceCur + FD.nFI_BaseActiv.rec.NKD;
     end;

     BaseActive(BaseActivFIID, @BaseActiveCode, @BaseActiveName, @SumPrecision);

     BaseActive(PremiumCurrency, @PremiumCurrencyCode, @PremiumCurrencyName, @PremiunSumPrecision);
     PremiumSumCur = FD.Deal.rec.Bonus;
     if( ПолучитьКурсЗаданногоTипа( @RatePremCurPremDate, PremiumCurrency, NATCUR, DV_RATETYPE_CBR,  FD.Deal.rec.BonusDate, true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(PremiumCurrency) + " на дату " + String(FD.Deal.rec.BonusDate) );
        RateBaseCurDateExec = 0.0;
     end;
     PremiumSumRub = PremiumSumCur * RatePremCurPremDate;
     if( FD.Deal.rec.Type == ALG_DV_BUY )
        PremiumSumCur = -PremiumSumCur;
        PremiumSumRub = -PremiumSumRub;
     end;

     GetComissionSumByDLComis(FD.Kind, FD.ID, @ComissionRub);

     var ControlDeal = IsControlDeal(FD);

     MarketPrice_Deal = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_MARKETCOST);

     if( Qnty != 0 )
        MarketPrice = MarketPrice_Deal / Qnty;
     end;

     if( (MarketPrice == 0) and
       (((FD.ДатаСделки() >= date(1,1,2014)) and FD.СделкаСЦентральнымКонтрагентом()) OR
        ((FD.ДатаСделки() >= Date(1,1,2016)) and (ControlDeal != true))
          )
        )
        MarketPrice = PremiumSumCur / Qnty;
     end;

     if( ПолучитьКурсЗаданногоTипа( @RateBaseCurDateExec, BaseActivFIID, NATCUR, DV_RATETYPE_CBR,  FD.ДатаИстеченияСрокаДействия(), true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаИстеченияСрокаДействия()));
        RateBaseCurDateExec = 0.0;
     end;

     if( FD.Deal.rec.Type == ALG_DV_BUY ) 
        AddCost = ПолучитьСуммуИзПроводокПоБА( FD, true, DVNTaxRegRepFormData.BegDate, DVNTaxRegRepFormData.EndDate, FD.ПоставочныйКонтракт() );
     elif( FD.Deal.rec.Type == ALG_DV_SALE )
        AddCost = ПолучитьСуммуИзПроводокПоБА( FD, false, DVNTaxRegRepFormData.BegDate, DVNTaxRegRepFormData.EndDate, FD.ПоставочныйКонтракт() ) * (-1);
     end;

     N5_23 = N5_24 = 0.0;
     
     if ( (ДатаПлатежаПремииПоОпциону(FD) >= DVNTaxRegRepFormData.BegDate) AND ( ДатаПлатежаПремииПоОпциону(FD) <= DVNTaxRegRepFormData.EndDate ) )
        if( PremiumSumRub > 0 )
          N5_23 = N5_23 + PremiumSumRub;
        elif( PremiumSumRub < 0 )
          N5_24 = N5_24 + PremiumSumRub;
        end;
     end;

     if( AddCost > 0 )
       N5_23 = N5_23 + AddCost;
     elif( AddCost < 0 )
       N5_24 = N5_24 + AddCost ;
     end;

     N5_25 = N5_23 - abs(N5_24); 

     if ( (FD.ДатаСделки() < DVNTaxRegRepFormData.BegDate) and (FD.ДатаИсполнения() >= DVNTaxRegRepFormData.BegDate) )
        GetPremiumSum(FD, @PremSumRub, true); 
        GetComissionSumByDLComis(FD.Kind, FD.ID, @ComissRub, true);
        N5_28 = PremSumRub - ComissRub;      
     end;

     DateFrom = NULL;
     DateTo = DVNTaxRegRepFormData.BegDate - 1;      
     if( (FD.ДатаСделки() < DVNTaxRegRepFormData.BegDate) and (FD.ДатаИсполнения() > DVNTaxRegRepFormData.BegDate) ) 
        N5_29 = ПолучитьСуммуИзПроводокПоМаскам(FD, DateFrom, DateTo);
     end;

     DateFrom = DVNTaxRegRepFormData.BegDate;
     DateTo = DVNTaxRegRepFormData.EndDate;      
     if( (FD.ДатаСделки() >= DVNTaxRegRepFormData.BegDate) or (FD.ДатаИсполнения() > DVNTaxRegRepFormData.BegDate) ) 
        N5_30 = ПолучитьСуммуИзПроводокПоМаскам(FD, DateFrom, DateTo);
     end;

     N5_31 = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, false);
     N5_32 = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, true);

     if( (FD.ДатаСделки() < DVNTaxRegRepFormData.BegDate) and (FD.ДатаИсполнения() > DVNTaxRegRepFormData.BegDate) )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.BegDate, @N5_33);
     end;
     if( FD.ДатаИсполнения() > DVNTaxRegRepFormData.EndDate )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.EndDate, @N5_34); 
     end;

     PrintLine5( FD.ДатаСделки(),
                 FD.DealCode(),
                 ПолучитьИмяСубъекта(Contractor),
                 Direction(FD),
                 ContractType,
                 BaseActiveCode,
                 BaseActiveName,
                 Qnty,
                 InitialActiveCode,
                 InitialActiveName,
                 QntyInitialActive,
                 ExpirationType,
                 OptionDirectionType,
                 ExpiryDate,
                 FD.ДатаИсполнения(),
                 ЧислоСЗаданнойТочностью(ExpirationPriceCur, Point, ""),
                 ЧислоСЗаданнойТочностью(RateBaseCurDateExec, 6, ""),
                 MarginCurrCode,
                 MarginCur,
                 MarginRub,
                 IIF(ДатаПлатежаПремииПоОпциону(FD) != zerodate, ДатаПлатежаПремииПоОпциону(FD), ""),
                 PremiumCurrencyCode,
                 PremiumCurrencyName,
                 ЧислоСЗаданнойТочностью(RatePremCurPremDate, 6, ""),
                 PremiumSumCur,
                 PremiumSumRub,
                 AddCost,
                 N5_23, 
                 N5_24,
                 N5_25,
                 EхpirationFact(FD, ObjType, Obj),
                 ТипИсполнения(FD),
                 N5_28,
                 N5_29,
                 N5_30,
                 N5_31,
                 N5_32,
                 N5_33,
                 N5_34,
                 FD.Deal.rec.ExtCode,
                 Point
                 ,F_N5_NU1()
                 ,F_N5_NU2()
                 ,F_N5_NU3()
                 ,F_N5_NU4()
                 ,F_N5_K1()
                 ,F_N5_K2()
                 );

     All_MarginRub     = All_MarginRub     + MarginRub;
     All_PremiumSumRub = All_PremiumSumRub + PremiumSumRub;
     All_AddCost       = All_AddCost       + AddCost;
     All_N5_23         = All_N5_23         + N5_23;
     All_N5_24         = All_N5_24         + N5_24;
     All_N5_25         = All_N5_25         + N5_25;
     All_N5_28         = All_N5_28         + N5_28;
     All_N5_29         = All_N5_29         + N5_29;
     All_N5_30         = All_N5_30         + N5_30;
     All_N5_31         = All_N5_31         + N5_31;
     All_N5_32         = All_N5_32         + N5_32;
     All_N5_33         = All_N5_33         + N5_33;
     All_N5_34         = All_N5_34         + N5_34;
  END;  

  PRIVATE MACRO ПечататьВалютныйСВОП( FD, NumStr:integer, SumN2_10:@money, SumN2_13:@money, SumN2_19:@money, SumN2_21:@money, SumN2_22:@money, SumN2_25:@money, SumN2_26:@money, SumN2_26_1:@money, SumN2_26_2:@money, SumN2_27:@money, SumN2_28:@money, SumN2_29:@money )

     var Course1:double = 0.0, Course2:double = 0.0;
     var MarginCur:money = $0.0, MarginRub:money = $0.0, RecievedMarginRub:money = $0.0, PaidMarginRub:money = $0.0, ComissionRub:money = $0.0;
     var BaseActivFIID:integer = ALLFININSTR, CostFIID:integer = ALLFININSTR, Contractor:integer = -1, Point:integer = 0, Qnty:money = $0.0, Qnty2:money = $0.0, Cost:money = $0.0, Cost2:money = $0.0;
     var N2_21, N2_22;
     var FD1 = null, FD2 = null, ДатаИсполнения_1ч = date(0,0,0), ДатаИсполнения_2ч = date(0,0,0);
     var DeltaStr:string = string(Delta + NumStr);
     var N2_7:money  = $0.0, N2_11_1 = "", N2_11:money = $0.0, N2_16:money = $0.0, N2_20:money = $0.0, N2_23:money = $0.0;
     var N2_25:money = $0.0, N2_26:money = $0.0, N2_26_1:money = $0.0, N2_26_2:money = $0.0, N2_27:money = $0.0, N2_28:money = $0.0, N2_29:money = $0.0;
     var MrgCur:money = $0.0, MrgRub:money = $0.0;
     var Sector:string = "", MarketKind:integer = 0;

     if( FD.DealPart == 2 )
        FD2 = FD;
        if( FD.Kind == DL_DVFXDEAL )
           FD1 = DVFirstDocFXDeal(FD.Kind, FD.deal, 1);
        elif( FD.Kind == DL_DVNDEAL )
           FD1 = DVFirstDocNDeal(FD.Kind, FD.Deal, 1);
        end;
     else
        FD1 = FD;
        if( FD.Kind == DL_DVFXDEAL )
           FD2 = DVFirstDocFXDeal(FD.Kind, FD.Deal, 2);
        elif( FD.Kind == DL_DVNDEAL )
           FD2 = DVFirstDocNDeal(FD.Kind, FD.Deal, 2);
        end;
     end;

     if( FD.Kind == DL_DVFXDEAL )

        BaseActivFIID      = FD1.nfi.rec.FIID;
        CostFIID           = FD1.nfi.rec.PriceFIID;
        Contractor         = FD1.Deal.rec.Contractor;
        Point              = FD1.nfi.rec.Point; 
        Qnty               = FD1.nfi.rec.Amount;
        Qnty2              = FD2.nfi.rec.Amount;
        Cost               = FD1.nfi.rec.Cost;
        Cost2              = FD2.nfi.rec.Cost;
        N2_7               = FD1.nfi.rec.Price;
        N2_16              = FD2.nfi.rec.Price;
        Sector             = FD1.Deal.rec.Sector;
        MarketKind         = FD1.Deal.rec.MarketKind;

        /*для СВОП (КО) - наименьшая из дат валютирования БА и КА по 1 части*/
        ДатаИсполнения_1ч = FD1.ДатаИсполнения();
        /*для СВОП (КО) -  наименьшая из дат валютирования БА и КА по 2 части*/
        ДатаИсполнения_2ч = FD2.ДатаИсполнения();

     elif( FD.Kind == DL_DVNDEAL )

        BaseActivFIID      = FD1.nFI_BaseActiv.rec.FIID;
        CostFIID           = FD1.nFI_BaseActiv.rec.PriceFIID;
        Contractor         = FD1.Deal.rec.Contractor;
        Point              = FD1.nFI_BaseActiv.rec.Point; 
        Qnty               = FD1.nFI_BaseActiv.rec.Amount;
        Qnty2              = FD2.nFI_BaseActiv.rec.Amount;
        Cost               = FD1.nFI_BaseActiv.rec.Cost;
        Cost2              = FD2.nFI_BaseActiv.rec.Cost;
        N2_7               = FD1.nFI_BaseActiv.rec.Price;
        N2_16              = FD2.nFI_BaseActiv.rec.Price;
        Sector             = FD1.Deal.rec.Sector;
        MarketKind         = FD1.Deal.rec.MarketKind;

        /*Для валютного СВОПа - Наименьшая из дат поставки и оплаты базового актива 1 части*/
        ДатаИсполнения_1ч = min(FD1.nFI_().rec.SuplDate,FD1.nFI_().rec.PayDate);
        /*Для валютного СВОПа - Наименьшая из дат поставки и оплаты базового актива 2 части*/
        ДатаИсполнения_2ч = min(FD2.nFI_().rec.SuplDate,FD2.nFI_().rec.PayDate);

        GetMarginSum(FD1, @MarginCur, @MarginRub, -1, false, NUM_LIST_CS, @N2_11_1, @RecievedMarginRub, @PaidMarginRub);
     end;

     if( ПолучитьКурсЗаданногоTипа( @Course1, BaseActivFIID, NATCUR, DV_RATETYPE_CBR, ДатаИсполнения_1ч, true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(ДатаИсполнения_1ч));
        Course1 = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа( @N2_11, CostFIID, NATCUR, DV_RATETYPE_CBR, ДатаИсполнения_1ч, true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(CostFIID) + " на дату " + String(ДатаИсполнения_1ч));
        N2_11 = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа( @Course2, BaseActivFIID, NATCUR, DV_RATETYPE_CBR, ДатаИсполнения_2ч, true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(ДатаИсполнения_2ч));
        Course2 = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа( @N2_20, CostFIID, NATCUR, DV_RATETYPE_CBR, ДатаИсполнения_2ч, true ) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(CostFIID) + " на дату " + String(ДатаИсполнения_2ч));
        N2_20 = 0.0;
     end;

     if( CostFIID != NATCUR )
       DV_SmartConvertSum( Cost, Cost, ДатаИсполнения_1ч, CostFIID, NATCUR, true );
       DV_SmartConvertSum( Cost2, Cost2, ДатаИсполнения_2ч, CostFIID, NATCUR, true );
     end;

     GetComissionSumByDLComis(FD1.Kind, FD1.ID, @ComissionRub);

     N2_26_1 = ПолучитьСуммуИзПроводокПоМаскамОднаЧасть(FD, DVNTaxRegRepFormData, true);
     N2_26_2 = ПолучитьСуммуИзПроводокПоМаскамОднаЧасть(FD, DVNTaxRegRepFormData, false) * (-1);

     N2_21 = N2_22 = 0.0;

     if( (ДатаИсполнения_1ч >= DVNTaxRegRepFormData.BegDate) and (ДатаИсполнения_1ч <= DVNTaxRegRepFormData.EndDate) )
        if( (FD2.Deal.rec.Type == ALG_DV_SB) and (Cost > (Qnty * Course1)) ) /* (Если <3> = "S/B" И <8> больше <10>, то <8>-<10>) */
           N2_21 = N2_21 + (Cost - (Qnty * Course1));
        elif( (FD2.Deal.rec.Type == ALG_DV_BS) and (Cost < (Qnty * Course1)) ) /* (Если <3> = "B/S" И <8> меньше <10>, то <10>-<8>) */
           N2_21 = N2_21 + ((Qnty * Course1) - Cost);
        end;
     end;
     if( (ДатаИсполнения_2ч >= DVNTaxRegRepFormData.BegDate) and (ДатаИсполнения_2ч <= DVNTaxRegRepFormData.EndDate) )
        if( (FD2.Deal.rec.Type == ALG_DV_BS) and (Cost2 > (Qnty2 * Course2)) ) /* (Если <3> = "B/S" И <17> больше <19>, то <17>-<19>) */
           N2_21 = N2_21 + (Cost2 - (Qnty2 * Course2));
        elif( (FD2.Deal.rec.Type == ALG_DV_SB) and (Cost2 < (Qnty2 * Course2)) ) /* (Если <3> = "S/B" И <17> меньше <19>, то <19>-<17>) */
           N2_21 = N2_21 + ((Qnty2 * Course2) - Cost2);
        end;
     end;
     if( (Sector == SET_CHAR) and (MarketKind == DV_MARKETKIND_CURRENCY) ) /* Если установлен признак "Биржевая сделка" и параметр "Биржевой рынок"="Валютный" */ 
        N2_21 = N2_21 + RecievedMarginRub;
     end;

     if( (ДатаИсполнения_1ч >= DVNTaxRegRepFormData.BegDate) and (ДатаИсполнения_1ч <= DVNTaxRegRepFormData.EndDate) )
        if( (FD2.Deal.rec.Type == ALG_DV_BS) and (Cost > (Qnty * Course1)) ) /* (Если <3> = "B/S" И <8> больше <10>, то <8>-<10>) */
           N2_22 = N2_22 + (Cost - (Qnty * Course1));
        elif( (FD2.Deal.rec.Type == ALG_DV_SB) and (Cost < (Qnty * Course1)) ) /* (Если <3> = "S/B" И <8> меньше <10>, то <10>-<8>) */
           N2_22 = N2_22 + ((Qnty * Course1) - Cost);
        end;
     end;
     if( (ДатаИсполнения_2ч >= DVNTaxRegRepFormData.BegDate) and (ДатаИсполнения_2ч <= DVNTaxRegRepFormData.EndDate) )
        if( (FD2.Deal.rec.Type == ALG_DV_SB) and (Cost2 > (Qnty2 * Course2)) ) /* (Если <3> = "S/B" И <17> больше <19>, то <17>-<19>) */
           N2_22 = N2_22 + (Cost2 - (Qnty2 * Course2));
        elif( (FD2.Deal.rec.Type == ALG_DV_BS) and (Cost2 < (Qnty2 * Course2)) ) /* (Если <3> = "B/S" И <17> меньше <19>, то <19>-<17>) */
           N2_22 = N2_22 + ((Qnty2 * Course2) - Cost2);
        end;
     end;
     if( (Sector == SET_CHAR) and (MarketKind == DV_MARKETKIND_CURRENCY) ) /* Если установлен признак "Биржевая сделка" и параметр "Биржевой рынок"="Валютный" */ 
        N2_22 = IIF(abs(PaidMarginRub) != 0, abs(PaidMarginRub), N2_22); /*PNV*/
     end;
     N2_22 = N2_22 * (-1);
     
     N2_23 = N2_21 - abs(N2_22);

     N2_26 = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, true);
     N2_27 = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, false);

     GetMarginSum(FD1, @MrgCur, @MrgRub, BaseActivFIID, true);
     N2_25 = MrgRub;  
     if ( ДатаИсполнения_1ч < DVNTaxRegRepFormData.BegDate )
        if(FD2.Deal.rec.Type == ALG_DV_BS)
           N2_25 = N2_25 + (Qnty * Course1) - Cost;
        elif(FD2.Deal.rec.Type == ALG_DV_SB)
           N2_25 = N2_25 +  Cost - (Qnty * Course1);
        end;   
     end;

     if( (ДатаИсполнения_1ч < DVNTaxRegRepFormData.BegDate) and (ДатаИсполнения_2ч > DVNTaxRegRepFormData.BegDate) )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.BegDate, @N2_28);
     end;
     if( ДатаИсполнения_2ч > DVNTaxRegRepFormData.EndDate )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.EndDate, @N2_29);
     end;

     PrintLine2( FD1.ДатаСделки(),
                 FD1.DealCode(),
                 ПолучитьИмяСубъекта(Contractor),
                 Direction(FD1),
                 ПолучитьКодФинИн(BaseActivFIID),
                 Qnty,
                 ДатаИсполнения_1ч,
                 ЧислоСЗаданнойТочностью(N2_7, Point, ""),
                 Cost,
                 ЧислоСЗаданнойТочностью(Course1, 6, ""),
                 Qnty * Course1,
                 ЧислоСЗаданнойТочностью(N2_11, 6, ""),
                 N2_11_1,
                 MarginCur,
                 MarginRub,
                 GetFI_CODE(CostFIID),
                 ДатаИсполнения_2ч,
                 ЧислоСЗаданнойТочностью(N2_16, Point, ""),
                 Cost2,
                 ЧислоСЗаданнойТочностью(Course2, 6, ""),
                 Qnty2 * Course2,
                 ЧислоСЗаданнойТочностью(N2_20, 6, ""),
                 N2_21,
                 N2_22,
                 N2_23,
                 ТипИсполнения(FD1),
                 N2_25,
                 N2_26,
                 N2_26_1,
                 N2_26_2,
                 N2_27,
                 N2_28,
                 N2_29,
                 FD.Deal.rec.ExtCode,
                 Point
                 ,F_N2_NU1()
                 ,F_N2_NU2()
                 ,F_N2_NU3()
                 ,F_N2_NU4()
                 ,F_N2_K1()
                 ,F_N2_K2()
                  );

     SumN2_10 = SumN2_10 + (Qnty * Course1);
     SumN2_13 = SumN2_13 + MarginRub;
     SumN2_19 = SumN2_19 + (Qnty2 * Course2);
     SumN2_21 = SumN2_21 + N2_21;
     SumN2_22 = SumN2_22 + N2_22;
     SumN2_25 = SumN2_25 + N2_25;
     SumN2_26 = SumN2_26 + N2_26;
     SumN2_26_1 = SumN2_26_1 + N2_26_1;
     SumN2_26_2 = SumN2_26_2 + N2_26_2;
     SumN2_27 = SumN2_27 + N2_27;
     SumN2_28 = SumN2_28 + N2_28;
     SumN2_29 = SumN2_29 + N2_29;
  END;

   CLASS DVNpmgrData(PaymData)
      var PayDate:date;
      var BegDate:date;
      var EndDate:date;
      var Type:integer;
      var Status_liab:integer;
      var Status_dem:integer;
      var Demand:money;
      var Liability:money;
      var Side:integer;
      var FixRate_liab:money;
      var FloatRateValue_liab:money;
      var FixRate_dem:money;
      var FloatRateValue_dem:money;
      var FillPaym:bool;

      MACRO SetData(PaymData)
         if ( ValType (PaymData) != V_UNDEF )
            PayDate = PaymData.PayDate;
            BegDate = PaymData.BegDate;
            EndDate = PaymData.EndDate;
            Type = PaymData.Type;
            Status_liab = PaymData.Status_liab;
            Status_dem = PaymData.Status_dem;
            Demand = PaymData.Demand;
            Liability = PaymData.Liability;
            Side = PaymData.Side;
            FixRate_liab = PaymData.FixRate_liab;
            FloatRateValue_liab = PaymData.FloatRateValue_liab;
            FixRate_dem = PaymData.FixRate_dem;
            FloatRateValue_dem = PaymData.FloatRateValue_dem;
            FillPaym = true;
         else
            PayDate = zerodate;
            BegDate = zerodate;
            EndDate = zerodate;
            Type = 0;
            Status_liab = 0;
            Status_dem = 0;
            Demand = $0.0;
            Liability = $0.0;
            Side = -1;
            FixRate_liab = $0.0;
            FloatRateValue_liab = $0.0;
            FixRate_dem = $0.0;
            FloatRateValue_dem = $0.0;
            FillPaym = false;
         end;
      END;

      MACRO Construct (PaymData)
         SetData(PaymData)
      end;

      this.Construct(PaymData);
   END;

   CLASS DV_DVNPMGR_Row (_liab, _dem)
      var DVNpmgrData_liab;
      var DVNpmgrData_dem;

      MACRO SetLineData(_liab, _dem)
         DVNpmgrData_liab = _liab;
         DVNpmgrData_dem = _dem;
      end;

      MACRO Construct (_liab, _dem)
         SetLineData(_liab, _dem);
      end;

      this.Construct(_liab, _dem);
   end;

  PRIVATE MACRO ПечататьПроцентныйСВОП( FD:DVFirstDocNDeal, NumStr:@integer, SumN3_17:@money, SumN3_23:@money, SumN3_24:@money, SumN3_25:@money, SumN3_28:@money, SumN3_29:@money, SumN3_30:@money, SumN3_31:@money, SumN3_32:@money, SumN3_33:@money, SumN3_34:@money )

     var MarginCur:money = $0.0, MarginRub:money = $0.0, ComissionRub:money = $0.0;
     var InterimCurPayment:money = $0.0, InterimRubPayment:money = $0.0, InterimCurReception:money = $0.0, InterimRubReception:money = $0.0;
     var N3_18, N3_19;
     var SubRub = 0.0, CurCB01 = 0.0, CurCB02 = 0.0, CurCB1 = 0.0, CurCB2 = 0.0;
     var CurCB01_Str = "", CurCB02_Str = "", CurCB1_Str = "", CurCB2_Str = "";
     var Year, Month, Day, ДатаНачала_Str = "";

     var NumPs_liab = 0, NumPs_demand = 0;
     var SumN3_15_Deal:money = $0.0, SumN3_17_Deal:money = $0.0, SumN3_21_Deal:money = $0.0, SumN3_23_Deal:money = $0.0, SumN3_24_Deal:money = $0.0, SumN3_25_Deal:money = $0.0;
     var SumN3_28_Deal:money = $0.0, SumN3_29_Deal:money = $0.0, SumN3_30_Deal:money = $0.0, SumN3_31_Deal:money = $0.0, SumN3_32_Deal:money = $0.0, SumN3_33_Deal:money = $0.0, SumN3_34_Deal:money = $0.0;
     var DVQuery_liab, DVQuery_demand, DVNpmgrData_main, DVNpmgrData_other;
     var RsdDVQuery_liab  = DL_RSdCommand();
     var RsdDVQuery_dem  = DL_RSdCommand();
     var DeltaStr:string = string(Delta + NumStr);
     var MainIsLiability:bool;
     var SeparateLine:bool;
     var DV_DVNPMGR_Massive = TArray();

     if (  (NOT FD.ПоставочныйКонтракт()) AND 
            (NOT FD.Netting()) AND 
            (FD.nFI_BaseActiv.rec.FIID == FD.nFI_BAOther.rec.FIID) AND 
            (FD.nFI_BaseActiv.rec.Period == FD.nFI_BAOther.rec.Period) AND 
            (FD.nFI_BaseActiv.rec.PeriodKind == FD.nFI_BAOther.rec.PeriodKind) 
            AND (FD.DealRecHandler.rec.Netting_pmgr == SET_CHAR))
         DVQuery_liab = "  SELECT PM_GR.t_DealID AS DealID, " + 
                        "         PM_GR.t_PayDate Paydate, " + 
                        "         PM_GR.t_BegDate BegDate, " + 
                        "         PM_GR.t_EndDate EndDate, " + 
                        "         PM_GR.t_Type TYPE, " + 
                        "         PM_GR.t_Status Status_liab, " + 
                        "         0 as Status_dem, " + 
                        "         PM_GR.t_Demand, " + 
                        "         PM_GR.t_Liability, " + 
                        "         CASE " + 
                        "            WHEN PM_GR.T_SIDE = 1 OR PM_GR.T_SIDE = 0 AND PM_GR.T_LIABILITY > 0 " + 
                        "            THEN " + 
                        "               1 " + 
                        "            ELSE " + 
                        "               0 " + 
                        "         END " + 
                        "            AS Side, " + 
                        "         PM_GR.t_FixRate FixRate_liab, " + 
                        "         PM_GR.T_FLOATRATEVALUE FLOATRATEVALUE_liab, " + 
                        "         PM_GR.t_FixRate FixRate_dem, " + 
                        "         PM_GR.T_FLOATRATEVALUE FLOATRATEVALUE_dem " + 
                        "    FROM DV_DVNPMGR PM_GR " + 
                        "   WHERE PM_GR.T_DEALID = ? " + 
                        "     AND (PM_GR.T_SIDE = 1 OR PM_GR.T_SIDE = 0 AND PM_GR.T_LIABILITY > 0) " +
                        "UNION " + 
                        "  SELECT PM_GR.t_DealID AS DealID, " + 
                        "         PM_GR.t_PayDate Paydate, " + 
                        "         PM_GR.t_BegDate BegDate, " + 
                        "         PM_GR.t_EndDate EndDate, " + 
                        "         PM_GR.t_Type TYPE, " + 
                        "         0 as Status_liab, " + 
                        "         PM_GR.t_Status Status_dem, " + 
                        "         PM_GR.t_Demand, " + 
                        "         PM_GR.t_Liability, " + 
                        "         CASE " + 
                        "            WHEN PM_GR.T_SIDE = 2 OR PM_GR.T_SIDE = 0 AND PM_GR.T_DEMAND > 0 " + 
                        "            THEN " + 
                        "               2 " + 
                        "            ELSE " + 
                        "               0 " + 
                        "         END " + 
                        "            AS Side, " + 
                        "         PM_GR.t_FixRate FixRate_liab, " + 
                        "         PM_GR.T_FLOATRATEVALUE FLOATRATEVALUE_liab, " + 
                        "         PM_GR.t_FixRate FixRate_dem, " + 
                        "         PM_GR.T_FLOATRATEVALUE FLOATRATEVALUE_dem " + 
                        "    FROM DV_DVNPMGR PM_GR " + 
                        "   WHERE PM_GR.T_DEALID = ? " + 
                        "     AND (PM_GR.T_SIDE = 2 OR PM_GR.T_SIDE = 0 AND PM_GR.T_DEMAND > 0) " +
                        "ORDER BY TYPE, " + 
                        "         BegDate, " + 
                        "         EndDate, " + 
                        "         PayDate ";
         RsdDVQuery_liab.addParam(FD.Deal.rec.ID);
         RsdDVQuery_liab.addParam(FD.Deal.rec.ID);
         DVNpmgrData_main = RsdDVQuery_liab.execute(DVQuery_liab);
         MainIsLiability = false;
         SeparateLine = true;
      else

         DVQuery_liab = DVQuery_demand =  "SELECT   pmgr_liab.t_PayDate Paydate, " +
                                          "         pmgr_liab.t_BegDate BegDate, " +
                                          "         pmgr_liab.t_EndDate EndDate, " +
                                          "         pmgr_liab.t_Type TYPE, ";
         DVQuery_liab = DVQuery_liab + 
                                          "         pmgr_dem.t_Demand, " +
                                          "         pmgr_liab.t_Liability, " +
                                          "         pmgr_liab.t_Side Side, " +
                                          "         pmgr_liab.t_FixRate FixRate_liab, " +
                                          "         pmgr_liab.T_FLOATRATEVALUE FLOATRATEVALUE_liab, " +
                                          "         pmgr_dem.t_FixRate FixRate_dem, " +
                                          "         pmgr_liab.t_Status Status_liab, " +
                                          "         pmgr_dem.T_FLOATRATEVALUE FLOATRATEVALUE_dem, " +
                                          "         CASE WHEN pmgr_dem.t_Status IS NULL THEN 0 ELSE pmgr_dem.t_Status END AS Status_dem, " +
                                          "         CASE WHEN pmgr_dem.t_Dealid IS NULL THEN 1 ELSE 2 END AS pm_row " +
                                          "    FROM (SELECT PM_GR.t_DealID, " +
                                          "                 PM_GR.t_PayDate, " +
                                          "                 PM_GR.t_BegDate, " +
                                          "                 PM_GR.t_EndDate, " +
                                          "                 PM_GR.t_Type, " +
                                          "                 PM_GR.t_Status, " +
                                          "                 PM_GR.t_Demand, " +
                                          "                 PM_GR.t_Liability, "
                                          "                 1 AS t_Side, " +
                                          "                 PM_GR.t_FixRate, " +
                                          "                 PM_GR.T_FLOATRATEVALUE " +
                                          "            FROM DV_DVNPMGR PM_GR " +
                                          "           WHERE     PM_GR.t_DealID = ? " +
                                          "                 AND (   PM_GR.t_side = 1 " +
                                          "                      OR PM_GR.t_side = 0 AND PM_GR.T_LIABILITY > 0)) pmgr_liab " + 
                                          "         LEFT OUTER JOIN " +
                                          "         (SELECT PM_GR.t_DealID, " +
                                          "                 PM_GR.t_PayDate, " +
                                          "                 PM_GR.t_BegDate, " +
                                          "                 PM_GR.t_EndDate, " +
                                          "                 PM_GR.t_Type, " +
                                          "                 PM_GR.t_Status, " +
                                          "                 PM_GR.t_Demand, " +
                                          "                 PM_GR.t_Liability, " +
                                          "                 2 AS t_Side, " +
                                          "                 PM_GR.t_FixRate, " +
                                          "                 PM_GR.T_FLOATRATEVALUE " +
                                          "            FROM DV_DVNPMGR PM_GR " +
                                          "           WHERE PM_GR.t_side = 2 OR PM_GR.t_side = 0 AND PM_GR.T_Demand > 0) " +
                                          "         pmgr_dem " +
                                          "            ON     pmgr_liab.t_DealID = pmgr_dem.t_DealID " +
                                          "               AND pmgr_liab.t_Paydate = pmgr_dem.t_Paydate " +
                                          "               AND pmgr_liab.t_BegDate = pmgr_dem.t_BegDate " +
                                          "               AND pmgr_liab.t_EndDate = pmgr_dem.t_EndDate " +
                                          "ORDER BY TYPE, " +
                                          "         begdate, " +
                                          "         enddate, " +
                                          "         paydate ";

         DVQuery_demand = DVQuery_demand + 
                                          "         pmgr_liab.t_Demand, " +
                                          "         pmgr_dem.t_Liability, " +
                                          "         pmgr_liab.t_Side Side, " +
                                          "         pmgr_liab.t_FixRate FixRate_dem, " +
                                          "         pmgr_liab.T_FLOATRATEVALUE FLOATRATEVALUE_dem, " +
                                          "         pmgr_liab.t_Status Status_dem, " +
                                          "         pmgr_dem.t_FixRate FixRate_liab, " +
                                          "         pmgr_dem.T_FLOATRATEVALUE FLOATRATEVALUE_liab, " +
                                          "         CASE WHEN pmgr_dem.t_Status IS NULL THEN 0 ELSE pmgr_dem.t_Status END AS Status_liab, " +
                                          "         CASE WHEN pmgr_dem.t_Dealid IS NULL THEN 1 ELSE 2 END AS pm_row " +
                                          "    FROM (SELECT PM_GR.t_DealID, " +
                                          "                 PM_GR.t_PayDate, " +
                                          "                 PM_GR.t_BegDate, " +
                                          "                 PM_GR.t_EndDate, " +
                                          "                 PM_GR.t_Type, " +
                                          "                 PM_GR.t_Status, " +
                                          "                 PM_GR.t_Demand, " +
                                          "                 PM_GR.t_Liability, " +
                                          "                 2 AS t_Side, " +
                                          "                 PM_GR.t_FixRate, " +
                                          "                 PM_GR.T_FLOATRATEVALUE " +
                                          "            FROM DV_DVNPMGR PM_GR " +
                                          "           WHERE     PM_GR.t_DealID = ? " +
                                          "                 AND (   PM_GR.t_side = 2 " + 
                                          "                      OR PM_GR.t_side = 0 AND PM_GR.T_Demand > 0)) pmgr_liab " +
                                          "         LEFT OUTER JOIN " +
                                          "         (SELECT PM_GR.t_DealID, " +
                                          "                 PM_GR.t_PayDate, " +
                                          "                 PM_GR.t_BegDate, " +
                                          "                 PM_GR.t_EndDate, " +
                                          "                 PM_GR.t_Type, " +
                                          "                 PM_GR.t_Status, " +
                                          "                 PM_GR.t_Demand, " +
                                          "                 PM_GR.t_Liability, " +
                                          "                 1 AS t_Side, " +
                                          "                 PM_GR.t_FixRate, " +
                                          "                 PM_GR.T_FLOATRATEVALUE " +
                                          "            FROM DV_DVNPMGR PM_GR " +
                                          "           WHERE PM_GR.t_side = 1 OR PM_GR.t_side = 0 AND PM_GR.t_liability > 0) " +
                                          "         pmgr_dem " +
                                          "            ON     pmgr_liab.t_DealID = pmgr_dem.t_DealID " +
                                          "               AND pmgr_liab.t_Paydate = pmgr_dem.t_Paydate " +
                                          "               AND pmgr_liab.t_BegDate = pmgr_dem.t_BegDate " +
                                          "               AND pmgr_liab.t_EndDate = pmgr_dem.t_EndDate " +
                                          "ORDER BY TYPE, " +
                                          "         begdate, " +
                                          "         enddate, " +
                                          "         paydate ";
         RsdDVQuery_liab.addParam(FD.Deal.rec.ID);
         RsdDVQuery_dem.addParam(FD.Deal.rec.ID);
         NumPs_liab = RsdDVQuery_liab.GetCount(DVQuery_liab);
         NumPs_demand = RsdDVQuery_dem.GetCount(DVQuery_demand);
         if( NumPs_liab >= NumPs_demand )
               DVNpmgrData_main = RsdDVQuery_liab.execute(DVQuery_liab);
               DVNpmgrData_other = RsdDVQuery_dem.execute(DVQuery_demand);
               MainIsLiability = true;
         else
               DVNpmgrData_main = RsdDVQuery_dem.execute(DVQuery_demand);
               DVNpmgrData_other = RsdDVQuery_liab.execute(DVQuery_liab);
               MainIsLiability = false;
         end;
         SeparateLine = false;
      end;

     while( DVNpmgrData_main.MoveNext() )
         var liab = DVNpmgrData(NULL), dem = DVNpmgrData(NULL);
         var stat = 1;
         if ( MainIsLiability AND NOT SeparateLine)
            liab.SetData(DVNpmgrData_main);
            if (DVNpmgrData_main.pm_row == 1)
               if ( DVNpmgrData_other.MoveNext() )
                  while( (DVNpmgrData_other.pm_row == 2) and stat )
                     stat = DVNpmgrData_other.MoveNext();
                  end;
                  if (stat)
                     dem.SetData(DVNpmgrData_other);
                  end;
               end;
            else
               dem.SetData(DVNpmgrData_main);
            end;
         elif ( NOT MainIsLiability AND NOT SeparateLine )
            dem.SetData(DVNpmgrData_main);
            if (DVNpmgrData_main.pm_row == 1)
               if ( DVNpmgrData_other.MoveNext() )
                  while( (DVNpmgrData_other.pm_row == 2) and stat )
                     stat = DVNpmgrData_other.MoveNext();
                  end;
                  if (stat)
                     liab.SetData(DVNpmgrData_other);
                  end;
               end;
            else
               liab.SetData(DVNpmgrData_main);
            end;
         else
            if ( DVNpmgrData_main.Side == 1 )
               liab.SetData(DVNpmgrData_main);
            elif ( DVNpmgrData_main.Side == 2 )
               dem.SetData(DVNpmgrData_main);
            end;
         end;
         DV_DVNPMGR_Massive[DV_DVNPMGR_Massive.Size] = DV_DVNPMGR_Row(liab, dem);
     end;

     for( var c, DV_DVNPMGR_Massive)
         var AttrProc = $0.0, HostProc = $0.0;
         var AttrSum = $0.0, HostSum = $0.0;
         var AttrCourse = $0.0, HostCourse = $0.0;
         var ПДатаНачалаПроц_liab:date, ПДатаКонцаПроц_liab:date, ПДатаПрПлатежа_liab:date, ПДатаНачалаПроц_dem:date, ПДатаКонцаПроц_dem:date, ПДатаПрПлатежа_dem:date;
         var N3_17:money = $0.0, N3_23:money = $0.0, N3_24:money = $0.0, N3_25:money = $0.0, N3_28:money = $0.0;

        if( FD.Deal.rec.Type == ALG_DV_FIX_FLOAT )
            if ( (c.DVNpmgrData_liab.FillPaym AND (c.DVNpmgrData_liab.Type != 3)) OR (c.DVNpmgrData_dem.FillPaym AND (c.DVNpmgrData_dem.Type != 3)))
               AttrProc = FD.nFI_BAOther.rec.Rate;
               HostProc = 100 * GetDvNRate(IIF(c.DVNpmgrData_dem.FillPaym, c.DVNpmgrData_liab.PayDate, c.DVNpmgrData_dem.PayDate), 2, FD.DealRecHandler, FD.nFI_BAOther, FD.nFI_BaseActiv);
            else
               AttrProc = IIF(c.DVNpmgrData_liab.FillPaym, c.DVNpmgrData_liab.FixRate_liab, 0);
               HostProc = IIF(c.DVNpmgrData_dem.FillPaym, c.DVNpmgrData_dem.FloatRateValue_dem, 0);
            end;
        elif (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX)
            if ( (c.DVNpmgrData_liab.FillPaym AND (c.DVNpmgrData_liab.Type != 3)) OR (c.DVNpmgrData_dem.FillPaym AND (c.DVNpmgrData_dem.Type != 3)))
               AttrProc = 100 * GetDvNRate(IIF(c.DVNpmgrData_liab.FillPaym, c.DVNpmgrData_liab.PayDate, c.DVNpmgrData_dem.PayDate), 1, FD.DealRecHandler, FD.nFI_BAOther, FD.nFI_BaseActiv);  
               HostProc = FD.nFI_BaseActiv.rec.Rate;
            else
               AttrProc = IIF(c.DVNpmgrData_liab.FillPaym, c.DVNpmgrData_liab.FloatRateValue_liab, 0);
               HostProc = IIF(c.DVNpmgrData_dem.FillPaym, c.DVNpmgrData_dem.FixRate_dem, 0);
            end;
        elif (FD.Deal.rec.Type == ALG_DV_FIX_FIX)
            if ( (c.DVNpmgrData_liab.FillPaym AND (c.DVNpmgrData_liab.Type != 3)) OR (c.DVNpmgrData_dem.FillPaym AND (c.DVNpmgrData_dem.Type != 3)))
               AttrProc = FD.nFI_BAOther.rec.Rate;  
               HostProc = FD.nFI_BaseActiv.rec.Rate;
            else
               AttrProc = IIF(c.DVNpmgrData_liab.FillPaym, c.DVNpmgrData_liab.FixRate_liab, 0);
               HostProc = IIF(c.DVNpmgrData_dem.FillPaym, c.DVNpmgrData_dem.FixRate_dem, 0);
            end;
        elif (FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT)
            if ( (c.DVNpmgrData_liab.FillPaym AND (c.DVNpmgrData_liab.Type != 3)) OR (c.DVNpmgrData_dem.FillPaym AND (c.DVNpmgrData_dem.Type != 3)))
               AttrProc = 100 * GetDvNRate(IIF(c.DVNpmgrData_liab.FillPaym, c.DVNpmgrData_liab.PayDate, c.DVNpmgrData_dem.PayDate), 1, FD.DealRecHandler, FD.nFI_BAOther, FD.nFI_BaseActiv);  
               HostProc = 100 * GetDvNRate(IIF(c.DVNpmgrData_dem.FillPaym, c.DVNpmgrData_dem.PayDate, c.DVNpmgrData_liab.PayDate), 2, FD.DealRecHandler, FD.nFI_BAOther, FD.nFI_BaseActiv); 
            else
               AttrProc = IIF(c.DVNpmgrData_liab.FillPaym, c.DVNpmgrData_liab.FloatRateValue_liab, 0);
               HostProc = IIF(c.DVNpmgrData_dem.FillPaym, c.DVNpmgrData_dem.FloatRateValue_dem, 0);
            end;
        end;
         if (c.DVNpmgrData_liab.FillPaym)
               ПДатаПрПлатежа_liab  = c.DVNpmgrData_liab.PayDate;
               ПДатаНачалаПроц_liab = IIF(c.DVNpmgrData_liab.BegDate == zerodate, c.DVNpmgrData_liab.PayDate, c.DVNpmgrData_liab.BegDate);
               ПДатаКонцаПроц_liab  = IIF(c.DVNpmgrData_liab.EndDate == zerodate, c.DVNpmgrData_liab.PayDate, c.DVNpmgrData_liab.EndDate);
         end;

         if (c.DVNpmgrData_dem.FillPaym)
            ПДатаПрПлатежа_dem  = c.DVNpmgrData_dem.PayDate;
            ПДатаНачалаПроц_dem = IIF(c.DVNpmgrData_dem.BegDate == zerodate, c.DVNpmgrData_dem.PayDate, c.DVNpmgrData_dem.BegDate);
            ПДатаКонцаПроц_dem  = IIF(c.DVNpmgrData_dem.EndDate == zerodate, c.DVNpmgrData_dem.PayDate, c.DVNpmgrData_dem.EndDate);
        end;


        if (c.DVNpmgrData_liab.FillPaym)
            DV_SmartConvertSumDbl(AttrCourse, 1, ПДатаПрПлатежа_liab, FD.ВалютаОбязательства(), NATCUR, true);
            AttrSum = IIF(c.DVNpmgrData_liab.Liability, c.DVNpmgrData_liab.Liability, FD.СуммаОбязательства());
            N3_17 = AttrSum*AttrCourse;
            SumN3_15_Deal = SumN3_15_Deal + AttrSum;
            SumN3_17_Deal = SumN3_17_Deal + N3_17;
        end;

        if (c.DVNpmgrData_dem.FillPaym)
            DV_SmartConvertSumDbl(HostCourse, 1, ПДатаПрПлатежа_dem, FD.ВалютаТребования(), NATCUR, true);
            HostSum = IIF(c.DVNpmgrData_dem.Demand, c.DVNpmgrData_dem.Demand, FD.СуммаТребования());
            N3_23 = HostSum*HostCourse;
            SumN3_21_Deal = SumN3_21_Deal + HostSum;
            SumN3_23_Deal = SumN3_23_Deal + N3_23;
        end;

         if (c.DVNpmgrData_dem.FillPaym)
            if ( (ПДатаПрПлатежа_dem < DVNTaxRegRepFormData.BegDate) or (ПДатаПрПлатежа_dem > DVNTaxRegRepFormData.EndDate) )
               N3_24 = 0;
            else
               if ( (c.DVNpmgrData_dem.Status_dem == 2) /* Оплачен */)
                  if ( c.DVNpmgrData_dem.Type == 3 /* Промежуточный платеж*/ )
                     N3_24 = N3_23;
                  else
                        if ( (ПДатаПрПлатежа_dem == FD.ДатаНачала()) AND (ПДатаПрПлатежа_liab == FD.ДатаНачала()) AND (N3_17 > N3_23) and (c.DVNpmgrData_liab.FillPaym and (c.DVNpmgrData_liab.Status_liab == 2)) )
                        N3_24 = N3_17 - N3_23;
                     elif( (ПДатаПрПлатежа_dem == FD.ДатаИсполнения()) AND (ПДатаПрПлатежа_liab == FD.ДатаИсполнения()) AND (N3_17 < N3_23) )
                        N3_24 = N3_23 - N3_17;
                     else
                        N3_24 = 0;
                     end;
                  end;
               else
                  N3_24 = 0;
               end;
            end;
         end;

         if (c.DVNpmgrData_liab.FillPaym)
            if ( (ПДатаПрПлатежа_liab < DVNTaxRegRepFormData.BegDate) or (ПДатаПрПлатежа_liab > DVNTaxRegRepFormData.EndDate) )
               N3_25 = 0;
            else
               if ( (c.DVNpmgrData_liab.Status_liab == 2) /* Оплачен */)
                  if ( c.DVNpmgrData_liab.Type == 3 /* Промежуточный платеж*/ )
                     N3_25 = N3_17;
                  else
                     if ( (ПДатаПрПлатежа_liab == FD.ДатаНачала()) AND (ПДатаПрПлатежа_dem == FD.ДатаНачала()) AND (N3_17 < N3_23) )
                        N3_25 = N3_17 - N3_23;
                        elif( (ПДатаПрПлатежа_liab == FD.ДатаИсполнения()) AND (ПДатаПрПлатежа_dem == FD.ДатаИсполнения()) AND (N3_17 > N3_23) and (c.DVNpmgrData_dem.FillPaym and (c.DVNpmgrData_dem.Status_dem == 2)))
                        N3_25 = N3_23 - N3_17;
                     else
                        N3_25 = 0;
                     end;
                  end;
               else
                  N3_25 = 0;
               end;
            end;
         end;

        N3_25 = -abs(N3_25);

        SumN3_24_Deal = SumN3_24_Deal + N3_24;
        SumN3_25_Deal = SumN3_25_Deal + N3_25;

        N3_28 = 0;    

        if ((c.DVNpmgrData_liab.FillPaym AND (c.DVNpmgrData_liab.Type == 1) and (c.DVNpmgrData_liab.Status_liab == 2)) or (c.DVNpmgrData_dem.FillPaym and (c.DVNpmgrData_dem.Type == 2) and (c.DVNpmgrData_dem.Status_dem == 2)))
           N3_28 = IIF((c.DVNpmgrData_liab.FillPaym AND (ПДатаПрПлатежа_liab < DVNTaxRegRepFormData.BegDate) and (c.DVNpmgrData_liab.Status_liab == 2)), N3_17, 0) - IIF((c.DVNpmgrData_dem.FillPaym AND (ПДатаПрПлатежа_dem < DVNTaxRegRepFormData.BegDate) and (c.DVNpmgrData_dem.Status_dem == 2)), N3_23, 0);
        else
           N3_28 = IIF((c.DVNpmgrData_dem.FillPaym AND (ПДатаПрПлатежа_dem < DVNTaxRegRepFormData.BegDate) and (c.DVNpmgrData_dem.Status_dem == 2)), N3_23, 0) - IIF((c.DVNpmgrData_liab.FillPaym AND (ПДатаПрПлатежа_liab < DVNTaxRegRepFormData.BegDate) and (c.DVNpmgrData_liab.Status_liab == 2)), N3_17, 0);
        end;

        SumN3_28_Deal = SumN3_28_Deal + N3_28;

        PrintLine3( FD.ДатаСделки(),
                    FD.Deal.rec.Code,
                    ПолучитьИмяСубъекта(FD.Deal.rec.Contractor),
                    FD.ДатаНачала(),
                    FD.ДатаИсполнения(),
                    Direction(FD),
                    IIF(c.DVNpmgrData_liab.FillPaym, ПолучитьКодФинИн(FD.ВалютаОбязательства()), ""),
                    IIF(c.DVNpmgrData_liab.FillPaym, FD.СуммаОбязательства(),""),
                    IIF(c.DVNpmgrData_liab.FillPaym, AttrProc, ""),
                    IIF(c.DVNpmgrData_dem.FillPaym, ПолучитьКодФинИн(FD.ВалютаТребования()), ""),
                    IIF(c.DVNpmgrData_dem.FillPaym, FD.СуммаТребования(), ""),
                    IIF(c.DVNpmgrData_dem.FillPaym, HostProc, ""),
                    IIF(c.DVNpmgrData_liab.FillPaym, ПДатаНачалаПроц_liab, ""),
                    IIF(c.DVNpmgrData_liab.FillPaym, ПДатаКонцаПроц_liab, ""),
                    IIF(c.DVNpmgrData_liab.FillPaym, ПДатаПрПлатежа_liab, ""),
                    AttrSum,
                    ЧислоСЗаданнойТочностью(AttrCourse, 6, ""),
                    N3_17,
                    IIF(c.DVNpmgrData_dem.FillPaym, ПДатаНачалаПроц_dem,""),
                    IIF(c.DVNpmgrData_dem.FillPaym, ПДатаКонцаПроц_dem,""),
                    IIF(c.DVNpmgrData_dem.FillPaym, ПДатаПрПлатежа_dem,""),
                    HostSum,
                    ЧислоСЗаданнойТочностью(HostCourse, 6, ""),
                    N3_23,
                    N3_24,
                    N3_25,
                    N3_24 - abs(N3_25),
                    "",
                    N3_28,
                    ""  );
        NumStr = NumStr + 1;
     end;

     SumN3_29_Deal = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, true, false);
     SumN3_30_Deal = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, true, true);
     SumN3_31_Deal = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, false);
     SumN3_32_Deal = ПолучитьСуммуИзПроводок(FD, DVNTaxRegRepFormData, false, true);

     if( (FD.ДатаСделки() < DVNTaxRegRepFormData.BegDate) and (FD.ДатаИсполнения() > DVNTaxRegRepFormData.BegDate) )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.BegDate, @SumN3_33_Deal);
     end;
     if( FD.ДатаИсполнения() > DVNTaxRegRepFormData.EndDate )
        ОстатокНаПарномСчёте(FD, DVNTaxRegRepFormData.EndDate, @SumN3_34_Deal);
     end;

     PrintLine3itog( 
                 FD.Deal.rec.Code,
                 ПолучитьИмяСубъекта(FD.Deal.rec.Contractor),
                 N3_ItogTxt,
                 SumN3_15_Deal,
                 SumN3_17_Deal,
                 SumN3_21_Deal,
                 SumN3_23_Deal,
                 SumN3_24_Deal,
                 SumN3_25_Deal,
                 SumN3_24_Deal - abs(SumN3_25_Deal),
                 ТипИсполнения(FD),
                 SumN3_28_Deal, SumN3_29_Deal, SumN3_30_Deal, SumN3_31_Deal,
                 SumN3_32_Deal, SumN3_33_Deal, SumN3_34_Deal
                 ,F_N3_NU1()
                 ,F_N3_NU2()
                 ,F_N3_NU3()
                 ,F_N3_NU4()
                 ,F_N3_K1()
                 ,F_N3_K2()
               );


     SumN3_17 = SumN3_17 + SumN3_17_Deal;
     SumN3_23 = SumN3_23 + SumN3_23_Deal;
     SumN3_24 = SumN3_24 + SumN3_24_Deal;
     SumN3_25 = SumN3_25 + SumN3_25_Deal;
     SumN3_28 = SumN3_28 + SumN3_28_Deal;
     SumN3_29 = SumN3_29 + SumN3_29_Deal; 
     SumN3_30 = SumN3_30 + SumN3_30_Deal; 
     SumN3_31 = SumN3_31 + SumN3_31_Deal; 
     SumN3_32 = SumN3_32 + SumN3_32_Deal; 
     SumN3_33 = SumN3_33 + SumN3_33_Deal; 
     SumN3_34 = SumN3_34 + SumN3_34_Deal;  
  END;

  PRIVATE MACRO ПечататьНеФИСС( FD, NumStr:integer, SumN4_29:@money, SumN4_30:@money )

     var Contractor:integer = -1, ТипСделки:string = "", ContractType:string = "", BaseActivFIID:integer = ALLFININSTR, Qnty:money = $0.0;
     var PriceCurrency:integer = ALLFININSTR, Cost:money = $0.0, ОбращениеНаОРЦБ:bool = (FD.КонтрагентБиржа() or FD.IsSector());
     var Course1:double = 0.0, Course2:double = 0.0, Course3:double = 0.0, Course4:double = 0.0, Course5:double = 0.0, Course6:double = 0.0, Course7:double = 0.0;
     var YFC1:double = 0.0, YFC2:double = 0.0, r1:double = 0.0, r2:double = 0.0, S:double = 0.0, DF1:double = 0.0, DF2:double = 0.0, MarketPrice:double = 0.0;
     var N4_21, N4_22, N4_23:string = "", N4_24:string = "", N4_27_STD:money = $0.0, N4_28_STD:money = $0.0, N4_29, N4_30, N4_32;
     var Ex_N4_29:bool = true, Ex_N4_30:bool = true, Price1:double = 0.0, Price2:double = 0.0, FD1, FD2, ДатаЗакрытия:date = FD.ДатаИсполнения();

     var DeltaStr:string = string(Delta + NumStr);

     if( FD.Kind == DL_DVFXDEAL )
        Contractor         = FD.Deal.rec.Contractor;
        BaseActivFIID      = FD.nfi.rec.FIID;
        ContractType       = IIF(FD.IsSalePart(), "Продажа", "Покупка");
        Qnty               = FD.nfi.rec.Amount;
        PriceCurrency      = FD.nfi.rec.PriceFIID;
        Cost               = FD.nfi.rec.Cost;

        if( FD.IsSWAP() )
           if( FD.DealPart == 1 )
              FD2 = DVFirstDocFXDeal(FD.Kind, FD.Deal, 2);
          
              Price1 = FD.nfi.rec.Price;
              Price2 = FD2.nfi.rec.Price;
              ДатаЗакрытия = FD2.ДатаИсполнения();
           else
              FD1 = DVFirstDocFXDeal(FD.Kind, FD.Deal, 1);
          
              Price1 = FD1.nfi.rec.Price;
              Price2 = FD.nfi.rec.Price;
           end;
        end;

     elif( FD.Kind == DL_DVNDEAL )
        Contractor         = FD.Deal.rec.Contractor;
        BaseActivFIID      = FD.nFI_BaseActiv.rec.FIID;
        ContractType       = IIF(FD.IsSale(), "Продажа", "Покупка");
        Qnty               = FD.nFI_BaseActiv.rec.Amount;
        PriceCurrency      = FD.nFI_BaseActiv.rec.PriceFIID;
        Cost               = FD.nFI_BaseActiv.rec.Cost;

        if( FD.IsSWAP() )
           if( FD.DealPart == 1 )
              FD2 = DVFirstDocNDeal(FD.Kind, FD.Deal, 2);

              Price1 = FD.nFI_BaseActiv.rec.Price;
              Price2 = FD2.nFI_BaseActiv.rec.Price;
              ДатаЗакрытия = FD2.ДатаИсполнения();
           else
              FD1 = DVFirstDocNDeal(FD.Kind, FD.Deal, 1);
          
              Price1 = FD1.nFI_BaseActiv.rec.Price;
              Price2 = FD.nFI_BaseActiv.rec.Price;
           end;
        end;
     end;

     var nday = FD.ДатаИсполнения() - FD.ДатаСделки();
     if( nday == 0 )
        ТипСделки = "TOD";
     elif( nday == 1 )
        ТипСделки = "TOM";
     elif( nday == 2 )
        ТипСделки = "SPOT";
     elif( nday > 2 )
        ТипСделки = "FW";
     end;

     if( FD.IsSWAP() )
       ТипСделки = string(FD.DealPart) + " часть swap " + ТипСделки;
     end;

     if( ПолучитьКурсЗаданногоTипа(@Course1, BaseActivFIID, NATCUR, DV_RATETYPE_CBR, FD.ДатаСделки(), true) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаСделки()));
        Course1 = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа(@Course2, PriceCurrency, NATCUR, DV_RATETYPE_CBR, FD.ДатаСделки(), true) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(PriceCurrency) + " на дату " + String(FD.ДатаСделки()));
        Course2 = 0.0;
     end;

     if( ОбращениеНаОРЦБ )
        if( ПолучитьКурсЗаданногоTипа(@Course3, BaseActivFIID, NATCUR, ПИ_ПолучитьВидКурса(RATETYPE_MIN_PRICE), FD.ДатаСделки(), true) == false )
           MsgBox("Невозможно получить курс вида 'Минимальная цена' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаСделки()));
           Course3 = 0.0;
        end;

        if( ПолучитьКурсЗаданногоTипа(@Course4, BaseActivFIID, NATCUR, ПИ_ПолучитьВидКурса(RATETYPE_MAX_PRICE), FD.ДатаСделки(), true) == false )
           MsgBox("Невозможно получить курс вида 'Максимальная цена' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаСделки()));
           Course4 = 0.0;
        end;

        if( ПолучитьКурсЗаданногоTипа(@Course5, BaseActivFIID, NATCUR, ПИ_ПолучитьВидКурса(RATETYPE_AVR_PRICE), FD.ДатаСделки(), true) == false )
           MsgBox("Невозможно получить курс вида 'Средневзвешенная цена' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаСделки()));
           Course5 = 0.0;
        end;
     end;

     if( BaseActivFIID == NATCUR ) 
        YFC1 = nday + 1 / 365;
     else
        YFC1 = nday + 1 / 360;
     end;

     if( PriceCurrency == NATCUR ) 
        YFC2 = nday + 1 / 365;
     else
        YFC2 = nday + 1 / 360;
     end;

     if( ПолучитьКурсЗаданногоTипа(@r1, BaseActivFIID, NATCUR, ПИ_ПолучитьВидКурса(22), FD.ДатаСделки(), true) == false )
        MsgBox("Невозможно получить курс вида 'Для операций с ФИСС' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаСделки()));
        r1 = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа(@r2, PriceCurrency, NATCUR, ПИ_ПолучитьВидКурса(22), FD.ДатаСделки(), true) == false )
        MsgBox("Невозможно получить курс вида 'Для операций с ФИСС' для FIID = " + String(PriceCurrency) + " на дату " + String(FD.ДатаСделки()));
        r2 = 0.0;
     end;

     if( Course2 != 0 )
        S = Course1 / Course2;
     end;

     DF1 = 1 / (1 + r1 * YFC1);
     DF2 = 1 / (1 + r2 * YFC2);

     MarketPrice = S * DF1 / DF2;

     if( ContractType == "Покупка" )
        N4_21 = 0.8 * Course5 - Cost;
     else
        N4_21 = Cost - 1.2 * Course5;
     end;

     if( ПолучитьКурсЗаданногоTипа(@Course6, BaseActivFIID, NATCUR, DV_RATETYPE_CBR, FD.ДатаИсполнения(), true) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(BaseActivFIID) + " на дату " + String(FD.ДатаИсполнения()));
        Course6 = 0.0;
     end;

     if( ПолучитьКурсЗаданногоTипа(@Course7, PriceCurrency, NATCUR, DV_RATETYPE_CBR, FD.ДатаИсполнения(), true) == false )
        MsgBox("Невозможно получить курс вида 'ЦБ РФ' для FIID = " + String(PriceCurrency) + " на дату " + String(FD.ДатаИсполнения()));
        Course7 = 0.0;
     end;

     N4_27_STD = Cost * Course7;
     N4_28_STD = Qnty * Course6;

     if( (ContractType == "Покупка") and (N4_27_STD < N4_28_STD) )
        N4_29 = N4_28_STD - N4_27_STD;
     elif( (ContractType == "Продажа") and (N4_27_STD > N4_28_STD) )
        N4_29 = N4_27_STD - N4_28_STD;
     else
        N4_29 = "";
        Ex_N4_29 = false;
     end;

     if( (ContractType == "Покупка") and (N4_28_STD < N4_27_STD) )
        N4_30 = N4_27_STD - N4_28_STD;
     elif( (ContractType == "Продажа") and (N4_28_STD > N4_27_STD) )
        N4_30 = N4_28_STD - N4_27_STD;
     else
        N4_30 = "";
        Ex_N4_30 = false;
     end;

     if( FD.Kind == DL_DVNDEAL )
        if( FD.IsSWAP() )
           if( Ex_N4_29 )
              N4_22 = MarketPrice * 0.8 * Qnty - (Price2 - Price1) * Qnty;
           elif( Ex_N4_30 )
              N4_22 = (Price2 - Price1) * Qnty - MarketPrice * 1.8 * Qnty;
           end;
        else
           if( Ex_N4_29 )
              N4_22 = MarketPrice * 0.8 * Qnty - Cost;
           elif( Ex_N4_30 )
              N4_22 = Cost - MarketPrice * 1.8 * Qnty;
           end;
        end;
     else
        N4_22 = "";
     end;

     if( ДатаЗакрытия <= DVNTaxRegRepFormData.EndDate )
        if( ПИ_СтутусПлатежИсполнен(FD.pm_BA().rec.PaymStatus)  )
           N4_23 = "Поставка";
        else
           N4_23 = "Неттинг";
        end;
     else
        N4_23 = "х";
     end;

     if( FD.Kind == DL_DVNDEAL )
        N4_24 = IIF(FD.ПоставочныйКонтракт(), "Поставка", "Неттинг");
        N4_32 = GetSetDVSSCost(FD.Deal.rec.ID, DEALKIND_MRK_OUT, DVNTaxRegRepFormData.EndDate);
     else
        N4_24 = IIF(FD.Netting(), "Неттинг", "Поставка");
        N4_32 = "";
     end;

     PrintLine4( FD.DealCode(),
                 ТипСделки,
                 ПолучитьИмяСубъекта(Contractor),
                 FD.ДатаСделки(),
                 FD.ДатаИсполнения(),
                 ContractType,
                 ПолучитьКодФинИн(BaseActivFIID),
                 Qnty,
                 GetFI_CODE(PriceCurrency),
                 Cost,
                 ЧислоСЗаданнойТочностью(Course1, 6, ""), 
                 ЧислоСЗаданнойТочностью(Course2, 6, ""), 
                 IIF(PrintMode() == DL_OUTREPORT_STD, (Cost * Course2),        FRP("J" + DeltaStr + "*L" + DeltaStr)),
                 IIF(PrintMode() == DL_OUTREPORT_STD, (Qnty * Course1),        FRP("H" + DeltaStr + "*K" + DeltaStr)),
                 IIF(PrintMode() == DL_OUTREPORT_STD, (Cost * Course2 / Qnty), FRP("M" + DeltaStr + "/H" + DeltaStr)),
                 IIF(ОбращениеНаОРЦБ, ПолучитьИмяСубъекта(Contractor), ""),    
                 IIF(ОбращениеНаОРЦБ, Course3, ""),
                 IIF(ОбращениеНаОРЦБ, Course4, ""),
                 IIF(ОбращениеНаОРЦБ, Course5, ""),
                 MarketPrice,
                 N4_21,
                 N4_22,
                 N4_23,
                 N4_24,
                 ЧислоСЗаданнойТочностью(Course6, 6, ""), 
                 ЧислоСЗаданнойТочностью(Course7, 6, ""), 
                 IIF(PrintMode() == DL_OUTREPORT_STD, (N4_27_STD),             FRP("J" + DeltaStr + "*Z" + DeltaStr)),
                 IIF(PrintMode() == DL_OUTREPORT_STD, (N4_28_STD),             FRP("H" + DeltaStr + "*Y" + DeltaStr)),
                 N4_29,
                 N4_30,
                 IIF(ОбращениеНаОРЦБ, "Обращается", "Не обращается"),
                 "",
                 "",
                 FD.Deal.rec.ExtCode );

     SumN4_29 = SumN4_29 + IIF(Ex_N4_29, N4_29, 0.0);
     SumN4_30 = SumN4_30 + IIF(Ex_N4_30, N4_30, 0.0);
  END;

   private macro IterateFISectionCS(FISection)
      if(FISection == FISection_Currency)
         return FISection_Metal;
      end;
      return FISection_End;
   end;

   private macro FISectionNext_CS(FISection, KindInitialFI)
      if(KindInitialFI == ALG_DV_FIKIND_PRRATE_UNDEF)
         return IterateFISectionCS(FISection);
      elif(KindInitialFI > 0)
         return FISection_End;
      end;
      return FISection_End;
   end;

   private macro FISectionNext( FISection, NumList, KindInitialFI)

      if(NumList == NUM_LIST_CS)
         return FISectionNext_CS(FISection, KindInitialFI);
      end;

      return (FISection + 1);
   end;

   private macro GetDepSheetName(NumList:integer, SheetName:String ):String

      if(NumList == NUM_LIST_FO_2)
         return ("АР-17-6");
      end;

      return (SheetName);
   end;

PRIVATE MACRO PrintDep( Dep:integer, NumList:integer )
  var NRec:integer = 0, RsdDVQuery, DVNDealData;
  var FISection = 1;
  var FiKind = "", FiKindNum = 0, DvKindNum = 0, BA_Kind_1824 = 0;

  while (FISection < 6)
     RsdDVQuery  = DL_RSdCommand();
     var DVQuery = "";
     if( (DVNTaxRegRepFormData.KindInitialFI > 0) or ( NumList == NUM_LIST_PS )  )
        FISection = 6;
     end;
     DvKindNum = 0; FiKindNum = 0;

     DVQuery = " SELECT DVNDeal.t_ID as ID, decode(DVNDeal.t_DocKind,?,?,DVNDeal.t_DocKind) as BofficeKind, nFI.t_Type as LegKind, DVNDeal.t_Date as DealDate, DVNDeal.t_Time as DealTime, fin.t_FI_KIND " +
                   "   FROM ddvndeal_dbt DVNDeal, ddvnfi_dbt nFI, dfininstr_dbt fin " +
                   "  WHERE DVNDeal.t_Department = ?        " +
                   "    and DVNDeal.t_IsTrust    = chr(0)   " +
                   "    and DVNDeal.t_Client     = -1       " +
                   "    and DVNDeal.t_State      > 0        " +
                   "    and DVNDeal.t_Date       <= ?       " +
                   "    and (     (DVNDeal.t_Forvard = 'X'  " + 
                   "          and (SELECT nFIba.t_ExecDate  " + 
                   "                 FROM ddvnfi_dbt nFIba  " +
                   "                WHERE nFIba.t_DealID = DVNDeal.t_ID "
                   "                  and nFIba.t_Type = ? ) >= ? ) " +
                   "        or    (DVNDeal.t_Forvard <> 'X' " +
                   "          and nFI.t_ExecDate  >=        " +
                   "          CASE                          " +
                   "            WHEN (nFI.t_OpenDate = 'X'  " +   
                   "              AND nFI.t_ExecDate = TO_DATE ('01.01.0001', 'dd.mm.yyyy')) " +
                   "              THEN nFI.t_ExecDate       " +
                   "            ELSE ?                      " +
                   "          END) )                        " +
                   "    and nFI.t_DealID   = DVNDeal.t_ID   " +
                   "    and fin.t_fiid     = nFI.t_fiid     "; 

     RsdDVQuery.addParam(DL_DVDEALT3);
     RsdDVQuery.addParam(DL_DVNDEAL);
     RsdDVQuery.addParam(Dep);
     RsdDVQuery.addParam(DVNTaxRegRepFormData.EndDate);
     RsdDVQuery.addParam(DV_NFIType_BaseActiv);
     RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);
     RsdDVQuery.addParam(DVNTaxRegRepFormData.BegDate);

     DVQuery = DVQuery + " and nFI.t_Type     = case when DVNDeal.t_Forvard = 'X' then ? when DVNDeal.t_DVKind in(?, ?, ?) then ? else ? end " +
                         " and DVNDeal.t_Type = case when ((? > 0) and DVNDeal.t_DVKind not in(?, ?, ?)) then ? else DVNDeal.t_Type end ";

     RsdDVQuery.addParam(DV_NFIType_Forward);
     RsdDVQuery.addParam(DV_CURSWAP);
     RsdDVQuery.addParam(DV_CURSWAP_FX);
     RsdDVQuery.addParam(DV_PCTSWAP);
     RsdDVQuery.addParam(DV_NFIType_BaseActiv2);
     RsdDVQuery.addParam(DV_NFIType_BaseActiv);
     RsdDVQuery.addParam(DVNTaxRegRepFormData.Direction);
     RsdDVQuery.addParam(DV_CURSWAP);
     RsdDVQuery.addParam(DV_CURSWAP_FX);
     RsdDVQuery.addParam(DV_PCTSWAP);
     RsdDVQuery.addParam(IIF(DVNTaxRegRepFormData.Direction == 1/*Покупка*/, ALG_DV_BUY, ALG_DV_SALE));

     if( DVNTaxRegRepFormData.DVKind > 0 )
        DVQuery = DVQuery + " and DVNDeal.t_DVKind = ? ";
        DvKindNum = DVNTaxRegRepFormData.DVKind;
        RsdDVQuery.addParam(DVNTaxRegRepFormData.DVKind);
     end;

     if( NumList != NUM_LIST_NOT_FISS )
        if( NumList == NUM_LIST_FO )
           DVQuery = DVQuery + " and DVNDeal.t_DVKind = ? ";
           RsdDVQuery.addParam(DV_FORWARD);
        elif( NumList == NUM_LIST_FO_2 )
           DVQuery = DVQuery + " and DVNDeal.t_DVKind = ? ";
           RsdDVQuery.addParam(DV_FORWARD_T3);
        elif( NumList == NUM_LIST_OP )
           DVQuery = DVQuery + " and DVNDeal.t_DVKind = ? ";
           RsdDVQuery.addParam(DV_OPTION);
        elif( NumList == NUM_LIST_CS )
           DVQuery = DVQuery + " and DVNDeal.t_DVKind in(?, ?) ";
           RsdDVQuery.addParam(DV_CURSWAP);
           RsdDVQuery.addParam(DV_CURSWAP_FX);
        elif( NumList == NUM_LIST_PS )
           DVQuery = DVQuery + " and DVNDeal.t_DVKind = ? ";
           RsdDVQuery.addParam(DV_PCTSWAP);
        end;
     else
        DVQuery = DVQuery + " and DVNDeal.t_DVKind in(?,?) ";
        RsdDVQuery.addParam(DV_FORWARD_FX);
        RsdDVQuery.addParam(DV_BANKNOTE_FX);
     end;

     if( DVNTaxRegRepFormData.KindInitialFI > 0 )
        DVQuery = DVQuery + " and fin.t_FI_KIND = ? ";
        if( DVNTaxRegRepFormData.KindInitialFI == 1 )
           FiKind = "ценные бумаги";
           FiKindNum = FIKIND_AVOIRISS;
           BA_Kind_1824 = 3;
        elif( DVNTaxRegRepFormData.KindInitialFI == 2 )
           FiKind = "иностранная валюта";
           FiKindNum = FIKIND_CURRENCY;
           BA_Kind_1824 = 1;
        elif( DVNTaxRegRepFormData.KindInitialFI == 3 )
           FiKind = "процентные ставки";
           FiKindNum = FIKIND_INDEX;
           BA_Kind_1824 = 2;
        elif( DVNTaxRegRepFormData.KindInitialFI == 4 )
           FiKind = "драгоценные металлы";
           FiKindNum = FIKIND_METAL;
           BA_Kind_1824 = 4;
        else /* ( DVNTaxRegRepFormData.KindInitialFI == 5 ) */
           FiKind = "прочие активы";
           FiKindNum = FIKIND_ARTICLE;
           BA_Kind_1824 = 5;
        end;
        RsdDVQuery.addParam(FiKindNum);
     elif ( NumList != NUM_LIST_PS )
        BA_Kind_1824 = FISection;
        DVQuery = DVQuery + " and fin.t_FI_KIND = ? ";
        if( FISection   == 1 )
           FiKind = "иностранная валюта";
           FiKindNum = FIKIND_CURRENCY;
        elif( FISection == 2 )
           FiKind = "процентные ставки";
           FiKindNum = FIKIND_INDEX;
        elif( FISection == 3 )
           FiKind = "ценные бумаги";
           FiKindNum = FIKIND_AVOIRISS;
        elif( FISection == 4 )
           FiKind = "драгоценные металлы";
           FiKindNum = FIKIND_METAL;
        else /* ( FISection == 5 ) */
           FiKind = "прочие активы";
           FiKindNum = FIKIND_ARTICLE;
        end;
        RsdDVQuery.addParam(FiKindNum);        
     else
        BA_Kind_1824 = 2;/*"процентные ставки"*/
     end;

     DVQuery = DVQuery + "  /*and DVNDEAL.T_ID =  2556*/ order by DealDate, DealTime ";

     NRec = RsdDVQuery.GetCount(DVQuery);

     if( NRec > 0 )
        var All_PremiumSumRub:money = $0.0, All_MarginRub:money = $0.0, All_AddCost:money = $0.0; 
        var All_N1_20:money = $0.0, All_N1_21:money = $0.0, All_N1_22:money = $0.0, All_N1_25:money = $0.0, All_N1_26:money = $0.0, All_N1_27:money = $0.0, All_N1_28:money = $0.0, All_N1_29:money = $0.0;
        var All_N5_23:money = $0.0, All_N5_24:money = $0.0, All_N5_25:money = $0.0, All_N5_28:money = $0.0, All_N5_29:money = $0.0, All_N5_30:money = $0.0, All_N5_31:money = $0.0, All_N5_32:money = $0.0, All_N5_33:money = $0.0, All_N5_34:money = $0.0;
        var SumN2_10:money = $0.0, SumN2_13:money = $0.0, SumN2_19:money = $0.0, SumN2_21:money = $0.0, SumN2_22:money = $0.0;
        var SumN2_25:money = $0.0, SumN2_26:money = $0.0, SumN2_26_1:money = $0.0, SumN2_26_2:money = $0.0, SumN2_27:money = $0.0, SumN2_28:money = $0.0, SumN2_29:money = $0.0;
        var SumN3_17:money = $0.0, SumN3_23:money = $0.0, SumN3_24:money = $0.0, SumN3_25:money = $0.0, SumN3_28:money = $0.0, SumN3_29:money = $0.0, SumN3_30:money = $0.0, SumN3_31:money = $0.0, SumN3_32:money = $0.0, SumN3_33:money = $0.0, SumN3_34:money = $0.0;
        var SumN4_29:money = $0.0, SumN4_30:money = $0.0;
        if( PrintMode() == DL_OUTREPORT_EXCEL )
           if( ( NumList == NUM_LIST_FO ) or ( NumList == NUM_LIST_FO_2 ))
              PrintItogFO_rshb(NRec, FiKind );
           elif( NumList == NUM_LIST_OP )
              PrintItogOP_rshb(NRec, FiKind );
           elif( NumList == NUM_LIST_CS )
              PrintItogCS_rshb(NRec,  FiKind );
           elif( NumList == NUM_LIST_PS )
            // не выводим итогов
           elif( NumList == NUM_LIST_NOT_FISS )
              PrintItogNotFISS(NRec, SumN4_29, SumN4_30, FiKind, ПолучитьСуммуПлюсМинусПфи(NumList, BA_Kind_1824, DvKindNum, true), ПолучитьСуммуПлюсМинусПфи(NumList, BA_Kind_1824, DvKindNum, false));
           end;
        end;

        DVNDealData = RsdDVQuery.execute(DVQuery);

        var Progress = TProgressBar;
        Progress.Init(NRec, "Просмотр сделок", "Просмотр сделок");

        var i:integer = 0;

        while( DVNDealData.MoveNext() )

           var FD;
           if( DVNDealData.BofficeKind != DL_DVFXDEAL )
              FD = DVFirstDocNDeal(DVNDealData.BofficeKind, DVNDealData.ID, IIF(DVNDealData.LegKind == DV_NFIType_BaseActiv2, 2, 1));
           else
              FD = DVFirstDocFXDeal(DVNDealData.BofficeKind, DVNDealData.ID, IIF(DVNDealData.LegKind == DV_NFIType_BaseActiv2, 2, 1));
           end;

           if(( NumList == NUM_LIST_FO ) or ( NumList == NUM_LIST_FO_2 ))
              ПечататьФорвард(FD, i, @All_MarginRub, @All_N1_20, @All_N1_21, @All_N1_22, @All_N1_25, @All_N1_26, @All_N1_27, @All_N1_28, @All_N1_29, NumList);
           elif( NumList == NUM_LIST_OP )
              ПечататьОпцион(FD, i, @All_MarginRub, @All_PremiumSumRub, @All_AddCost, @All_N5_23, @All_N5_24, @All_N5_25, @All_N5_28, @All_N5_29, @All_N5_30, @All_N5_31, @All_N5_32, @All_N5_33, @All_N5_34, NumList);
           elif( NumList == NUM_LIST_CS )
              ПечататьВалютныйСВОП(FD, i, @SumN2_10, @SumN2_13, @SumN2_19, @SumN2_21, @SumN2_22, @SumN2_25, @SumN2_26, @SumN2_26_1, @SumN2_26_2, @SumN2_27, @SumN2_28, @SumN2_29);
           elif( NumList == NUM_LIST_PS )
              ПечататьПроцентныйСВОП(FD, @i, @SumN3_17, @SumN3_23, @SumN3_24, @SumN3_25, @SumN3_28, @SumN3_29, @SumN3_30, @SumN3_31, @SumN3_32, @SumN3_33, @SumN3_34);
           elif( NumList == NUM_LIST_NOT_FISS )
              ПечататьНеФИСС(FD, i, @SumN4_29, @SumN4_30);
           end;
 
           if (noData)
             noData = false;
           end;
           i = i + 1;
           Progress.Use();
        end;

        Progress.Remove();
        

        if( PrintMode() == DL_OUTREPORT_STD )
           if( NumList == NUM_LIST_FO )
              PrintItogFO(NRec, All_MarginRub, All_N1_20, All_N1_21, FiKind, All_N1_25, All_N1_26, All_N1_27, All_N1_28, All_N1_29 );
           elif( NumList == NUM_LIST_OP )
              PrintItogOP(NRec, All_MarginRub, All_PremiumSumRub, All_AddCost, All_N5_23, All_N5_24, All_N5_25, All_N5_28, All_N5_29, All_N5_30, All_N5_31, All_N5_32, All_N5_33, All_N5_34, FiKind );
           elif( NumList == NUM_LIST_CS )
              PrintItogCS(NRec,  SumN2_10, SumN2_13, SumN2_19, SumN2_21, SumN2_22, SumN2_25, SumN2_26, SumN2_26_1, SumN2_26_2, SumN2_27, SumN2_28, SumN2_29, FiKind);
           elif( NumList == NUM_LIST_NOT_FISS )
              PrintItogNotFISS(NRec, SumN4_29, SumN4_30, FiKind);
           end;
        end;
        Delta = Delta+i+1;
     elif(NumList == NUM_LIST_FO_2)
        PrintRepHeader_rshb_N1_FO2(ReportHeader);
     end;
     FISection = FISectionNext( FISection, NumList, DVNTaxRegRepFormData.KindInitialFI);

  end;
END;

  PRIVATE MACRO ПечататьЛист( NumList:integer )
     var Department, query, NumDep = 0;

     if( (NumList == NUM_LIST_FO) or (NumList == NUM_LIST_FO_2) )
        vSheetName = "АР-17-4"; //"Форвард_ПФИ_BS_Т+3";
        vPrefixH = "H1_";
        vPrefixN = "N1_";
        FillCellNamesN1();
     elif( NumList == NUM_LIST_CS )
        vSheetName = "АР-17-5"; //"Валютный_СВОП_ПФИ";
        vPrefixH = "H2_";
        vPrefixN = "N2_";
        FillCellNamesN2();
     elif( NumList == NUM_LIST_PS )
        vSheetName = "АР-17-1"; //"Процентный_СВОП_ПФИ";
        vPrefixH = "H3_";
        vPrefixN = "N3_";
        FillCellNamesN3();
     elif( NumList == NUM_LIST_NOT_FISS )
        vSheetName = "BS_не_ПФИ";
        vPrefixH = "H4_";
        vPrefixN = "N4_";
     elif( NumList == NUM_LIST_OP )
        vSheetName = "АР-17-3"; // "Опцион_ПФИ";
        vPrefixH = "H5_";
        vPrefixN = "N5_";
        FillCellNamesOP();
     end;

     noData = true;
     
     vDepSheetName = GetDepSheetName(NumList, vSheetName);
     PrintRepHeader(1, NumList);
     
     BeginRepTab(NumList);
     
     if( DVNTaxRegRepFormData.DepartmentID != -1 )
        PrintDep(DVNTaxRegRepFormData.DepartmentID, NumList);
        if(noData)
          PrintLineNoData( NumList );
        end;
     else 
        query = " SELECT t_Code " +
                "   FROM ddp_dep_dbt ";
        Department = TRsbDataSet(query);
        InitProgress(SQL_GetNRecs(query), "Отчет: Налоговый регистр по сделкам КО и внебиржевым ПИ", "Просмотр филиалов...");

        while( Department.MoveNext() )
           PrintDep(Department.Code, NumList);
           UseProgress(NumDep = NumDep + 1);
        end;

        if(noData)
          PrintLineNoData( NumList );
        end;
        RemProgress();
     end;
     EndTable();
     CopyAllSheetInTotalBook(vSheetName, false, GetTableRange(), 0, vDepSheetName);
     if(( NumList == NUM_LIST_FO ) or ( NumList == NUM_LIST_FO_2 ))
       SetOnAutoFilter(vDepSheetName, "B13:AL13"); 
     elif( NumList == NUM_LIST_OP )
       SetOnAutoFilter(vDepSheetName, "B13:AU13"); 
     elif( NumList == NUM_LIST_CS )
       SetOnAutoFilter(vDepSheetName, "B13:AO13"); 
     elif( NumList == NUM_LIST_PS )
       SetOnAutoFilter(vDepSheetName, "B13:AQ13"); 
     end;
     //SetAutoSize(NumList, vDepSheetName);
     PrintRepFooter(vDepSheetName, NumList);
  END;

  PRIVATE MACRO Create()
  
     Delta = 12;
     if( DVNTaxRegRepFormData.FISS == SET_CHAR )
        if( (DVNTaxRegRepFormData.DVKind == DV_DVKIND_UNDEF) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_FORWARD)
          )
           Delta = Delta_FISS_List_Start_Val_rshb;
           ПечататьЛист(NUM_LIST_FO);
           NUM_LIST_FO_EXST = true;
        end;

        if( (DVNTaxRegRepFormData.DVKind == DV_DVKIND_UNDEF) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_FORWARD_T3)
          )
           Delta = Delta_FISS_List_Start_Val_rshb;
           ПечататьЛист(NUM_LIST_FO_2);
           NUM_LIST_FO_2_EXST = true;
        end;

        if( (DVNTaxRegRepFormData.DVKind == DV_DVKIND_UNDEF) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_OPTION)
          )
           Delta = Delta_FISS_List_Start_Val_rshb;
           ПечататьЛист(NUM_LIST_OP);
           NUM_LIST_OP_EXST = true;
        end;

        if( (DVNTaxRegRepFormData.DVKind == DV_DVKIND_UNDEF) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_CURSWAP) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_CURSWAP_FX  ) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_CURSWAP_COMBO  )
          )
           Delta = Delta_FISS_List_Start_Val_rshb;
           ПечататьЛист(NUM_LIST_CS);
           NUM_LIST_CS_EXST = true;
        end;

        if( (DVNTaxRegRepFormData.DVKind == DV_DVKIND_UNDEF) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_PCTSWAP)
          )
           Delta = 0;
           ПечататьЛист(NUM_LIST_PS);
           NUM_LIST_PS_EXST = true;
        end;
     end;

     Delta = 13;
     if( DVNTaxRegRepFormData.NotFISS == SET_CHAR )
        if( (DVNTaxRegRepFormData.DVKind == DV_DVKIND_UNDEF) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_FORWARD_FX) or
            (DVNTaxRegRepFormData.DVKind == DV_DVKIND_BANKNOTE_FX)
          )
           Delta = Delta_FISS_List_Start_Val_rshb; //12
           НОМЕР_КОНЕЧНОЙ_СТРОКИ_ЗАГОЛОВКА = 0;
           ПечататьЛист(NUM_LIST_NOT_FISS);
           NUM_LIST_NOT_FISS_EXST = true;
        end;
     end;

     if ( not NUM_LIST_FO_EXST and (NUM_LIST_FO < m_ObjTemplateXLS.SheetCount)) m_ObjTemplateXLS.SheetDelete(NUM_LIST_FO); end;
     if ( not NUM_LIST_FO_2_EXST and (NUM_LIST_FO_2 < m_ObjTemplateXLS.SheetCount)) m_ObjTemplateXLS.SheetDelete(NUM_LIST_FO_2); end;
     if ( not NUM_LIST_OP_EXST and (NUM_LIST_OP < m_ObjTemplateXLS.SheetCount)) m_ObjTemplateXLS.SheetDelete(NUM_LIST_OP); end;
     if ( not NUM_LIST_CS_EXST and (NUM_LIST_CS < m_ObjTemplateXLS.SheetCount)) m_ObjTemplateXLS.SheetDelete(NUM_LIST_CS); end;
     if ( not NUM_LIST_PS_EXST and (NUM_LIST_PS < m_ObjTemplateXLS.SheetCount)) m_ObjTemplateXLS.SheetDelete(NUM_LIST_PS); end;
     if ( not NUM_LIST_NOT_FISS_EXST and (NUM_LIST_NOT_FISS < m_ObjTemplateXLS.SheetCount)) m_ObjTemplateXLS.SheetDelete(NUM_LIST_NOT_FISS); end;
     
  END;

  initDL_CReportTemplate(null, "Report_DVNTaxReg.xlsx", UseCSV_, null, null, UsePOI_, UseBigReportMode_);
  SetRowFlushCount(2000);
END;



PRIVATE MACRO GetDataFromFormFields()
  DVNTaxRegRepFormData.DepartmentID   = m_Form.GetFieldValue( PNFLD_NTAXREG_DEPARTMENT    );
  DVNTaxRegRepFormData.Period         = m_Form.GetFieldValue( PNFLD_NTAXREG_PERIOD        );
  DVNTaxRegRepFormData.Year           = m_Form.GetFieldValue( PNFLD_NTAXREG_YEAR          );
  DVNTaxRegRepFormData.GrowingItog    = m_Form.GetFieldValue( PNFLD_NTAXREG_GROWTH        );
  DVNTaxRegRepFormData.BegDate        = m_Form.GetFieldValue( PNFLD_NTAXREG_BEGINDATE     );
  DVNTaxRegRepFormData.EndDate        = m_Form.GetFieldValue( PNFLD_NTAXREG_ENDDATE       );
  DVNTaxRegRepFormData.Direction      = m_Form.GetFieldValue( PNFLD_NTAXREG_DIRECTION     );
  DVNTaxRegRepFormData.DVKind         = m_Form.GetFieldValue( PNFLD_NTAXREG_DVKIND        );
  DVNTaxRegRepFormData.KindInitialFI  = m_Form.GetFieldValue( PNFLD_NTAXREG_KINDINITIALFI );
  DVNTaxRegRepFormData.FISS           = m_Form.GetFieldValue( PNFLD_NTAXREG_FISS          );
  DVNTaxRegRepFormData.NotFISS        = m_Form.GetFieldValue( PNFLD_NTAXREG_NOT_FISS      );
  DVNTaxRegRepFormData.IsExportToExel = m_Form.GetFieldValue( PNFLD_NTAXREG_TO_EXEL       );
END;

macro MakeReports()
  var ObjRep:object;
  while(m_Form.Run())
    GetDataFromFormFields();
    //setRecreateSheets(true);
    ObjRep = DV_NTaxReg_Report();
    ObjRep.Run();
  end;
end;

MakeReports();
exit(1);
