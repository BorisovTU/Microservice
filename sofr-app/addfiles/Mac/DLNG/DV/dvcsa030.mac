/*
$Name:        dvcsa030.mac
$Module:      ФИССиКО
$Description: Сопровождение CSA: Обработка маржевого платежа
*/
import "dv_car.mac";
import DVInter;

PRIVATE VAR CSAPayment = TRecHandler("dvcsapm.dbt");

MACRO ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
    record csaBuf(dvcsa);
    SetBuff(csaBuf, FDoc);
    var FD = DVFirstCSA(DocKind, csaBuf.CSAID);
    FD.SetParametr(MC_TYPE_PARAMETR_FIID, CSAPayment.rec.SumPayCur);
    var PaymentObj:RsbPayment;
    var PaymentObj2:RsbPayment;
    
    var query = "SELECT t_PaymentID ID "
               +"  FROM DPMPAYM_DBT "
               +" WHERE     t_DocKind = 4627 " /*Платеж по CSA*/
               +"       AND t_DocumentID = " + CSAPayment.rec.PMID;
    
    var cmd = RsdCommand(query);
    cmd.execute;
    var sysPaymData = TRsbDataSet(cmd);
    if (sysPaymData and sysPaymData.moveNext)
        PaymentObj = RsbPayment(sysPaymData.ID);
    else
        msgbox("Не найден платеж");
        return 1;
    end;

    /*PNV 508144*/
    if (PaymentObj.PaymStatus == PM_FINISHED)
       return 0;
    end;
    /*PNV 508144*/

    var plusMC  = TRecHandler("account");
    var minusMC = TRecHandler("account");
    var plusRest = $0, minusRest = $0;
    
    if (FD.IsExistAccount("-МС", null, true, null, minusMC, null, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur))
        minusRest = abs(DL_GetRestAccount(minusMC.rec, CSAPayment.rec.PlanPayDate));
    end;
    
    if (FD.IsExistAccount("+МС", null, true, null, plusMC, null, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur))
        plusRest = abs(DL_GetRestAccount(plusMC.rec, CSAPayment.rec.PlanPayDate));
    end;
    
    if (CSAPayment.rec.Direction == 0 /*Требование, входящий платеж*/)
    
        if (plusRest == $0) // Нет остатка на активном счете - Ва
        
            if(not FD.OpenAccount("-МС", null, false, null, minusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL))
                return 1;
            end;
            PaymentObj.SetReceiverAccount(minusMC.rec.Code_Currency, minusMC.rec.Chapter, minusMC.rec.Account, {OurBank});
            PaymentObj.Actuate(PaymentObj);
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, CSAPayment.rec.PlanPayDate);
        
        elif ((plusMC.rec.Code_Currency == PaymentObj.BaseFIID) and (plusRest >= CSAPayment.rec.SumPay)) // Есть остаток в валюте платежа и он больше либо равен сумме платежа - Вб
        
            if(not FD.OpenAccount("+МС", null, false, null, plusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL))
                return 1;
            end;
            PaymentObj.SetReceiverAccount(plusMC.rec.Code_Currency, plusMC.rec.Chapter, plusMC.rec.Account, {OurBank});
            PaymentObj.Actuate(PaymentObj);
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, CSAPayment.rec.PlanPayDate);
            
        else // Остаток меньше суммы платежа - Вв1, Вв2
            
            /*var payerAccount = TRecHandler("account");
            
            if( not DL_GetAccount(1, CSAPayment.rec.SumPayCur, PaymentObj.FuturePayerAccount, payerAccount) )
                return 1;
            end;*/
            
            if( not FD.OpenAccount("+МС", null, false, null, plusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL) )
                return 1;
            end;
            
            if( not FD.OpenAccount("-МС", null, false, null, minusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL) )
                return 1;
            end;
            
            if( not sysPaymData.moveNext )
                msgbox("Не найден платеж");
                return 1;
            else
                PaymentObj2 = RsbPayment(sysPaymData.ID);
            end;
            
            if (PaymentObj.SubPurpose == 1)
                PaymentObj.SetReceiverAccount(plusMC.rec.Code_Currency, plusMC.rec.Chapter, plusMC.rec.Account, {OurBank});
                PaymentObj.Actuate(PaymentObj);
                PaymentObj2.SetReceiverAccount(minusMC.rec.Code_Currency, minusMC.rec.Chapter, minusMC.rec.Account, {OurBank});
                PaymentObj2.Actuate(PaymentObj2);
            else
                PaymentObj.SetReceiverAccount(minusMC.rec.Code_Currency, minusMC.rec.Chapter, minusMC.rec.Account, {OurBank});
                PaymentObj.Actuate(PaymentObj);
                PaymentObj2.SetReceiverAccount(plusMC.rec.Code_Currency, plusMC.rec.Chapter, plusMC.rec.Account, {OurBank});
                PaymentObj2.Actuate(PaymentObj2);
            end;
            
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, CSAPayment.rec.PlanPayDate);
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj2, null, CSAPayment.rec.PlanPayDate);
            
            // ПроводкаПоКатегориямУчета( FD, 
                                       // payerAccount, plusMC,              /* КатегДеб , КатегКредит*/
                                       // CSAPayment.rec.PlanPayDate,        /* Дата */
                                       // 1,                                 /* Глава */
                                       // CSAPayment.rec.SumPayCur,          /* Валюта */
                                       // plusRest,                          /* Сумма  */
                                       // null,                              /* Документ */
                                       // INPCARRY,                          /* Result_Carry */
                                       // "",                                /* Kind_Oper */
                                       // "",                                /* Numb_Document */
                                       // PaymentObj.Ground, PaymentObj.PaymentID
                                     // );
            
            // ПроводкаПоКатегориямУчета( FD, 
                                       // payerAccount, minusMC,             /* КатегДеб , КатегКредит*/
                                       // CSAPayment.rec.PlanPayDate,        /* Дата */
                                       // 1 ,                                /* Глава */
                                       // CSAPayment.rec.SumPayCur,          /* Валюта */
                                       // PaymentObj.BaseAmount - plusRest,  /* Сумма  */
                                       // null,                              /* Документ */
                                       // INPCARRY,                          /* Result_Carry */
                                       // "",                                /* Kind_Oper */
                                       // "",                                /* Numb_Document */
                                       // PaymentObj.Ground, PaymentObj.PaymentID
                                     // );
            
        end;
    
    else /*CSAPayment.rec.Direction == 1 Обязательство, исходящий платеж*/
    
        if (minusRest == $0) // Нет остатка на пассивном счете - Иа
        
            if(not FD.OpenAccount("+МС", null, false, null, plusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL))
                return 1;
            end;
            PaymentObj.SetPayerAccount(plusMC.rec.Code_Currency, plusMC.rec.Chapter, plusMC.rec.Account, {OurBank});
            PaymentObj.Actuate(PaymentObj);
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, CSAPayment.rec.PlanPayDate);
            
        elif ((minusMC.rec.Code_Currency == PaymentObj.BaseFIID) and (minusRest >= CSAPayment.rec.SumPay)) // Есть остаток в валюте платежа и он больше либо равен сумме платежа - Иб
            
            if(not FD.OpenAccount("-МС", null, false, null, minusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL))
                return 1;
            end;
            PaymentObj.SetPayerAccount(minusMC.rec.Code_Currency, minusMC.rec.Chapter, minusMC.rec.Account, {OurBank});
            PaymentObj.Actuate(PaymentObj);
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, CSAPayment.rec.PlanPayDate);
            
        else // Остаток меньше суммы платежа - Ив1, Ив2
            
            /*var receiverAccount = TRecHandler("account");
            
            if( not DL_GetAccount(1, CSAPayment.rec.SumPayCur, PaymentObj.FutureReceiverAccount, receiverAccount) )
                return 1;
            end;*/
            
            if(not FD.OpenAccount("-МС", null, false, null, minusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL))
                return 1;
            end;
            
            if(not FD.OpenAccount("+МС", null, false, null, plusMC, CSAPayment.rec.PlanPayDate, CSAPayment.rec.SumPayCur, null, null, MC_PAIRACCMODE_MANUAL))
                return 1;
            end;
            
            if( not sysPaymData.moveNext )
                msgbox("Не найден платеж");
                return 1;
            else
                PaymentObj2 = RsbPayment(sysPaymData.ID);
            end;
            
            if (PaymentObj.SubPurpose == 1)
                PaymentObj.SetPayerAccount(minusMC.rec.Code_Currency, minusMC.rec.Chapter, minusMC.rec.Account, {OurBank});
                PaymentObj.Actuate(PaymentObj);
                PaymentObj2.SetPayerAccount(plusMC.rec.Code_Currency, plusMC.rec.Chapter, plusMC.rec.Account, {OurBank});
                PaymentObj2.Actuate(PaymentObj2);
            else
                PaymentObj.SetPayerAccount(plusMC.rec.Code_Currency, plusMC.rec.Chapter, plusMC.rec.Account, {OurBank});
                PaymentObj.Actuate(PaymentObj);
                PaymentObj2.SetPayerAccount(minusMC.rec.Code_Currency, minusMC.rec.Chapter, minusMC.rec.Account, {OurBank});
                PaymentObj2.Actuate(PaymentObj2);
            end;
            
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, CSAPayment.rec.PlanPayDate);
            ПИ_ПроводкаПоПлатежу(FD, PaymentObj2, null, CSAPayment.rec.PlanPayDate);
            
            // ПроводкаПоКатегориямУчета( FD,
                                       // minusMC, receiverAccount,          /* КатегДеб , КатегКредит*/
                                       // CSAPayment.rec.PlanPayDate,        /* Дата */
                                       // 1,                                 /* Глава */
                                       // CSAPayment.rec.SumPayCur,          /* Валюта */
                                       // minusRest,                         /* Сумма  */
                                       // null,                              /* Документ */
                                       // INPCARRY,                          /* Result_Carry */
                                       // "",                                /* Kind_Oper */
                                       // "",                                /* Numb_Document */
                                       // PaymentObj.Ground, PaymentObj.PaymentID
                                     // );
            
            // ПроводкаПоКатегориямУчета( FD,
                                       // plusMC, receiverAccount,           /* КатегДеб , КатегКредит*/
                                       // CSAPayment.rec.PlanPayDate,        /* Дата */
                                       // 1 ,                                /* Глава */
                                       // CSAPayment.rec.SumPayCur,          /* Валюта */
                                       // PaymentObj.BaseAmount - minusRest, /* Сумма  */
                                       // null,                              /* Документ */
                                       // INPCARRY,                          /* Result_Carry */
                                       // "",                                /* Kind_Oper */
                                       // "",                                /* Numb_Document */
                                       // PaymentObj.Ground, PaymentObj.PaymentID
                                     // );
            
        end;
        
    end;
    
    // KS PM_FINISHED устанавливаем тольео для входящих платежей
    if (CSAPayment.rec.Direction == 0 /*Требование, входящий платеж*/)
      PaymentObj.PaymStatus = PM_FINISHED;
    end;
    PaymentObj.Actuate(PaymentObj);
    
    if (ValType(PaymentObj2) != V_UNDEF)
        if (CSAPayment.rec.Direction == 0 /*Требование, входящий платеж*/)
            PaymentObj2.PaymStatus = PM_FINISHED;
        end;
        PaymentObj2.Actuate(PaymentObj2);
    end;
    
    return 0;
END;