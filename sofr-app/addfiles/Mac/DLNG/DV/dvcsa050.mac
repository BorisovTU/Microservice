/*
$Name:        dvcsa050.mac
$Module:      ФИССиКО
$Description: Сопровождение CSA: Обработка исходящих платежей по процентам
*/
import "dv_car.mac";

PRIVATE VAR CSAPayment = TRecHandler("dvcsapm.dbt");

MACRO ExecuteStep( doc, Fdoc, DocKind, ID_Operation, ID_Step )
    record csaBuf(dvcsa);
    SetBuff(csaBuf, FDoc);
    var FD = DVFirstCSA(DocKind, csaBuf.CSAID);
    var PaymentObj:RsbPayment;
    var inGround = "Перечисление процентов контрагентом по договору " + FD.CSA.rec.Code;
    
    var query = "SELECT t_PaymentID ID "
               +"  FROM DPMPAYM_DBT "
               +" WHERE     t_DocKind = 4627 " /*Платеж по CSA*/
               +"       AND t_DocumentID = " + CSAPayment.rec.PMID
               +"       AND t_PaymStatus <> " + PM_FINISHED;
    
    var cmd = RsdCommand(query);
    cmd.execute;
    var StepPayments = TRsbDataSet(cmd);
    
    if (StepPayments)
        var bankAccount = TRecHandler("account");
        
        while (StepPayments.moveNext)
            PaymentObj = RsbPayment(StepPayments.ID);
            
            //if ( PaymentObj.Ground == inGround ) /*Входящий платеж*/
            if( PaymentObj.Payer != {OurBank}) /*Входящий платеж определяется по ground?? Бред какой. PNV 511247*/
                
                continue;
                
            else /*Исходящий платеж*/
                
                if (CSAPayment.rec.IsNetting == SET_CHAR)
                    if(not FD.OpenAccount("-Расчеты_CSA", null, false, null, bankAccount, CSAPayment.rec.PlanPayDate, PaymentObj.BaseFIID, null, null, MC_PAIRACCMODE_MANUAL))/*PNV i-support 508247*/
                        return 1;
                    end;
                else
                    /*CHVA*/
                     query = "SELECT t_IncPaid incPaid, t_ExpPaid expPaid, t_IncAcc incAcc, t_ExpAcc expAcc, t_Cur cur, t_PlanDate PlanDate "
                                 +"  FROM DDVCSAPMPRC_DBT "
                                 +" WHERE t_PMID = " + CSAPayment.rec.PMID;
    
                      var cmd1 = RsdCommand(query);
                      cmd1.execute;
                      var DataSet = TRsbDataSet(cmd1);
                      if (DataSet.moveNext)
                          if (DataSet.exppAid != 0) /*расход*/
                                if(not FD.OpenAccount("-%МС", null, false, null, bankAccount, CSAPayment.rec.PlanPayDate, PaymentObj.BaseFIID, null, null, MC_PAIRACCMODE_MANUAL))
                                   return 1;
                                end; 
                          elif (FD.CSA.rec.BaseCurrency == 8)
                                if(not FD.OpenAccount( "+Треб. по%, отриц. ставка", null, false, null, bankAccount, CSAPayment.rec.PlanPayDate, PaymentObj.BaseFIID, null, null, MC_PAIRACCMODE_MANUAL))
                                   return 1;
                                end;
                          else
                                if(not FD.OpenAccount("-%МС", null, false, null, bankAccount, CSAPayment.rec.PlanPayDate, PaymentObj.BaseFIID, null, null, MC_PAIRACCMODE_MANUAL))
                                   return 1;
                                end; 
                          end;                   
                    end;
                  /*CHVA*/  
                end;
                
                PaymentObj.SetPayerAccount(bankAccount.rec.Code_Currency, bankAccount.rec.Chapter, bankAccount.rec.Account, {OurBank});
            
                PaymentObj.Actuate();
                
                var receiverAccount = TRecHandler("account");
            
                if( not DL_GetAccount(1,  PaymentObj.FutureReceiverFIID, PaymentObj.FutureReceiverAccount, receiverAccount) )
                    MsgBox("В АБС не найден счет "+PaymentObj.FutureReceiverAccount);
                    return 1;
                end;
                
                ПроводкаПоКатегориямУчета( FD, 
                                           bankAccount, receiverAccount,      /* КатегДеб , КатегКредит*/
                                           GetDateAfterWorkDays(PaymentObj.ValueDate,0,FD.ПолучитьКалендСвязанный()),/* Дата */
                                           1,                                 /* Глава */
                                           PaymentObj.BaseFIID,               /* Валюта */
                                           PaymentObj.BaseAmount,             /* Сумма  */
                                           null,                              /* Документ */
                                           INPCARRY,                          /* Result_Carry */
                                           "",                                /* Kind_Oper */
                                           "",                                /* Numb_Document */
                                           PaymentObj.Ground, PaymentObj.PaymentID
                                         );
                
                //PaymentObj.PaymStatus = PM_FINISHED; // KS 16.05.2019
                PaymentObj.Actuate();
                
            end;
            
        end;
    end;
    
    return 0;
END;