/*
$Name:        dvfx060.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Исполнение требований"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac",dv_lib,funk,dv_dm;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dvndeal);
  var FD;
  var sta,bs;
  var ДатаИсполненияШага:date;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  GetOprDate(DV_FXDEAL_OPRDATE_REQ, ДатаИсполненияШага);

    if( ПИКО_ИсполнитьТребованиеБанкнотнойСделки(FD, ДатаИсполненияШага, doc) != 0 )
      return 1;
    end;

  /* в проекте через платеж, здесь через статусы операции */
  if( GetOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY) == DV_FX_OPERSTATUS_DL_COMPLETE )
     if( not DV_ОбновитьСтатусЧастиСделки(FD.nFI, DL_LEG_FORM) )
        MsgBox("Ошибка при изменении статуса сделки");
        return 1;
     end;

     if( FD.IsSWAP() and (not FD.IsClient()))
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_BALANCE_2, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Баланс 2ч> по операции.");
           return 1;
        end;
     end;
  end;
  var kindbnote = "";                                                                         
  GetMainObjAttr(null, OBJTYPE_FXOPER_DV, uniid(deal, OBJTYPE_FXOPER_DV), 202, null, null, kindbnote);
  if ( FD.IsBuy() )
     if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, 3) )   //Установка значения сегмента статуса "Ожидание акцепта требования"
        MsgBox("Ошибка при установке статуса <Требования> по операции.");
        return 1;
     end;
  else
        if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_COMPLETE) )
           MsgBox("Ошибка при установке статуса <Требования> по операции.");
           return 1;
        end;
        //Необходимо запланировать шаг Исполнение обязательств
        if (kindbnote == 2) //Предоплата                  
           if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
              MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
              return 1;
           end;         
        end;          
  end;          

  if( FD.IsClient() )
     if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND_2, DV_FX_OPERSTATUS_DL_RUN) )
        MsgBox("Ошибка при установке статуса <Требования 2ч> по операции.");
        return 1;
     end;
  end;
                                              
  return 0;
end;
