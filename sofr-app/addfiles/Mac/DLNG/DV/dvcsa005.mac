/*
$Name:        dvcsa005.mac
$Module:      ФИССиКО
$Description: Сопровождение CSA: Открытие CSA
*/
import "dv_car.mac", "dl_grfun.mac";

private macro RepozBuff(CSA:TRecHandler,
                        GA:TRecHandler,
                        STMES:TRecHandler)
                       
   var cmd = DL_RSDCommand();
    var PTID;
    private var repozdeal = TRecHandler("dl_repozdeal.dbt");
   
    repozdeal.rec.dockind = DV_CSA;
    repozdeal.rec.reporting = SET_CHAR;
    repozdeal.rec.docid = CSA.rec.CSAID;
    repozdeal.rec.date_start = CSA.rec.begDate;
    repozdeal.rec.autoclose = UNSET_CHAR;
    if(GA.rec.GENAGRID>0)
        repozdeal.rec.Reporter_Bank         =   GA.rec.reporter_bank;
        repozdeal.rec.date_end              =   CSA.rec.EndDate;
        repozdeal.rec.TYPESECUR             =   GA.rec.TYPESECUR;
        repozdeal.rec.FORMSECUR             =   GA.rec.FORMSECUR;
        repozdeal.rec.INITIATOR             =   GA.rec.INITIATOR;
        repozdeal.rec.METHOD_WAYTWOWAY      =   GA.rec.METHOD_WAYTWOWAY;
        repozdeal.rec.METHOD_REG            =   GA.rec.METHOD_REG;
        repozdeal.rec.CONTRACT_CONTR        =   GA.rec.NUMCONTR;
        repozdeal.rec.REPORTER_CONTR        =   GA.rec.REPORTER_CONTR;
        repozdeal.rec.CREATOR_UTI           =   GA.rec.CREATOR_UTI;
        repozdeal.rec.REPOZID_BANK          =   GA.rec.CODE_DEAL;
        repozdeal.rec.TYPE_RECONCILIATION	=   GA.rec.TYPE_sver;
        repozdeal.rec.Creator_UTI	        =   GA.rec.Creator_UTI;
    end;

    GetRegistryValue("РЕПОЗИТАРИЙ\\СРОК ОЖИД.ЗАПР. ПРИ КОМБ.ПОДТВ.", V_INTEGER, repozdeal.rec.RequestTimeout, null);
    
    // РИК Банка
    var BankRIC;
        var cmdRIC = DL_RSDCommand();
        var queryRIC = //" SELECT rsi_rsbparty.PT_GetPartyCode(?, 70) AS RIC FROM DUAL" ;
        "SELECT t_code as RIC"
    +"  FROM (  SELECT OBJ.T_CODE"
    +"            FROM dobjcode_dbt obj"
    +"           WHERE     OBJ.T_OBJECTTYPE = 3"
    +"                 AND OBJ.T_OBJECTID = "+{OurBank}
    +"                 AND OBJ.T_CODEKIND = 70"
    +"                 AND OBJ.T_BANKDATE <="+getsqldate(CSA.rec.begDate)
    +"                 AND (   OBJ.T_BANKCLOSEDATE ="
    +"                            TO_DATE ('01.01.0001', 'dd.mm.yyyy')"
    +"                      OR OBJ.T_BANKCLOSEDATE >"+getsqldate(CSA.rec.begDate)+")"
    +"        ORDER BY OBJ.T_BANKDATE DESC)"
    +" WHERE ROWNUM = 1";
        
        var DataSetRIC = cmdRIC.Execute(queryRIC);
        if(DataSetRIC.moveNext())
            repozdeal.rec.RepozID_Bank = DataSetRIC.RIC;
        else
            repozdeal.rec.RepozID_Bank = "";
        end;
    //BankRIC = ПолучитьКодСубъекта({OurBank}, PTCK_RIC);
    //repozdeal.rec.RepozID_Bank = BankRIC;

    repozdeal.rec.STATUS_IR     =   1;
    if(repozdeal.rec.TYPESECUR<=0)
        repozdeal.rec.TYPESECUR     =   4;
    end;
    if(repozdeal.rec.FORMSECUR<=1)
        repozdeal.rec.FORMSECUR     =   3;
    end;
    //var contr=GetContract(CSA.rec.id);

    repozdeal.rec.TYPEPRODUCT=STMES.rec.TYPEPRODUCT;
    repozdeal.rec.TYPEDEAL=STMES.rec.TYPEDEAL;
    repozdeal.rec.messagecode=STMES.rec.MessageCode;
    
    var ArrRepozDeal = RepozDealData();
    ArrRepozDeal.Add(repozdeal);
    ArrRepozDeal.insert;

    return 0;
end;
/*************/

private macro getMessage(STMES:TRecHandler)
    var query = " SELECT * " +
                "   FROM DIR_SETUPMESSAGE_DBT STPMSG" +
                "  WHERE STPMSG.T_KIND_OPERATION = 2795 " + //todo добавить константу!!!!!ы
                "    AND STPMSG.T_REPORTING = 'X'"    +
                "    AND STPMSG.T_DOCKIND = " + DV_CSA;

    var cmd = RSDCommand(query);
    var DataSet = TRsbDataSet(cmd);
    
    if (DataSet.MoveNext())
        STMES.rec.FI_KIND		    =   DataSet.FI_KIND;		
        STMES.rec.KIND_OPERATION    =   DataSet.KIND_OPERATION;
        STMES.rec.MESSAGECODE	    =   DataSet.MESSAGECODE;	
        STMES.rec.REPORTGROUP	    =   DataSet.REPORTGROUP;	
        STMES.rec.REPORTING		    =   DataSet.REPORTING	;	
        STMES.rec.STYLEOPTIONS	    =   DataSet.STYLEOPTIONS;	
        STMES.rec.SYSTEM	        =   DataSet.SYSTEM;	
        STMES.rec.TYPE_EXEC	        =   DataSet.TYPE_EXEC	;
        STMES.rec.TYPEDEAL	        =   DataSet.TYPEDEAL	;
        STMES.rec.TYPEPRODUCT	    =   DataSet.TYPEPRODUCT;
    else
        return 1;
    end;
    return 0;
end;

MACRO CreateRepozDealParametr(csaBuf)
    var CSA = TRecHandler("dvcsa.dbt");
    var GA = TRecHandler("dl_genagr.dbt");
    var STMES = TRecHandler("ir_setupmessage.dbt");
    copy(CSA, csaBuf);

    var Query = " SELECT NVL(GA.t_genagrid,-1) AS GAID"
              + " ,NVL(GA.T_REPORTER_BANK, -1) AS GAREPORTER_BANK"
              + " ,NVL(GA.T_CODE, CHR (1)) AS GACODE"
              + " ,NVL(GA.T_NUMREPOZ, CHR (1)) AS GANUMREPOZ"
              + " ,NVL(GA.T_DATE_END,TO_DATE ('03.03.0003', 'DD.MM.YYYY')) AS GADATE_END"
              + " ,NVL(GA.T_NUMCONTR, CHR (1)) AS GANUMCONTR"
              + " ,NVL(GA.T_REPORTER_CONTR, 0) AS GAREPORTER_CONTR"
              + " ,NVL(GA.T_CREATOR_UTI, -1) AS GACREATOR_UTI"
              + " ,NVL(GA.T_CODE_DEAL, CHR (1)) AS GACODE_DEAL"
              + " ,NVL(GA.T_METHOD_REG, 0) AS GAMETHOD_REG"
              + " ,NVL(GA.T_METHOD_WAYTWOWAY, 0) AS GAMETHOD_WAYTWOWAY"
              + " ,NVL(GA.T_INITIATOR, -1) AS GAINITIATOR"
              + " ,NVL((CASE WHEN GA.T_FORMSECUR = 0 THEN 3 ELSE GA.T_FORMSECUR END), 3) AS GAFORMSECUR"
              + " ,NVL((CASE WHEN GA.T_TYPESECUR = 0 THEN 4 ELSE GA.T_TYPESECUR END),4) AS GATYPESECUR"
              + " ,NVL (GA.T_SCANCOPY, CHR (1)) AS GASCANCOPY"
              + " ,NVL (GA.T_TYPE_SVER, 0) AS GATYPESVER"
              + "   FROM ddl_genagr_dbt GA "
              + "  WHERE    (GA.t_genagrid = " + CSA.rec.GenAgrID + " AND " + CSA.rec.GenAgrID + " <> 0) "
              + "        OR (    " + CSA.rec.GenAgrID + " = 0 "
              + "            AND GA.t_GenAgrID IN (SELECT NVL ( "
              + "                                            (SELECT ga1.t_GenAgrID "
              + "                                               FROM DDL_GENAGR_DBT ga1 "
              + "                                              WHERE     ga1.t_PartyID = " + CSA.rec.partyid
              + "                                                    AND ga1.t_PseudoGA = "
              + "                                                           CHR (88) "
              + "                                                    AND ga1.t_Status = 10), "
              + "                                            -1) "
              + "                                    FROM DUAL)) ";

    var Cmd = DL_RSDCommand(Query);

    var DataSet = Cmd.Execute();

    if ((DataSet.MoveNext()) AND (DataSet.GAID > 0))
        GA.Clear();
        GA.rec.genagrid=DataSet.GAID;
        GA.rec.reporter_bank=DataSet.GAREPORTER_BANK;
        GA.rec.CODE=DataSet.GACODE;
        GA.rec.NUMREPOZ= DataSet.GANUMREPOZ;
        GA.rec.DATE_END= SQL_ConvTypeDate(DataSet.GADATE_END);
        GA.rec.numcontr= dataset.ganumcontr;
        GA.rec.reporter_contr= dataset.gareporter_contr;
        GA.rec.creator_uti= dataset.gacreator_uti;
        GA.rec.code_deal= dataset.gacode_deal;
        GA.rec.method_reg= dataset.gamethod_reg;
        GA.rec.method_waytwoway= dataset.gamethod_waytwoway;
        GA.rec.initiator= dataset.gainitiator;
        GA.rec.formsecur = dataset.gaformsecur;
        GA.rec.typesecur =  dataset.gatypesecur;
        GA.rec.scancopy= dataset.gascancopy;
        GA.rec.type_sver= dataset.gatypesver;
    end;

    if(not getMessage(@STMES))
        RepozBuff(CSA, GA, STMES);
    end;
END;

MACRO ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
    record csaBuf(dvcsa);
    SetBuff(csaBuf, FDoc);
    var FD = DVFirstCSA(DocKind, csaBuf.CSAID);
    
    if(csaBuf.ReposRep == SET_CHAR)
        CreateRepozDealParametr(csaBuf);
    end;

    return 0;
END;
