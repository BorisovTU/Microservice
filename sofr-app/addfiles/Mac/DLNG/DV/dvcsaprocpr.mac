/*Клон макроса dvcsamppr.mac , оригинальный макрос не найден*/

/*
$Name:        dvcsamppr.mac
$Module:      ФИСС и КО
$Description: Печать маржевого платежа CSA
*/
/*  Рисуем форму "Маржевый платеж" 
                          ╔═══════════════════════════════ Маржевый платеж ══════════════════════════════╗
                          ║ Дата <Dstep>                                                                 ║
                          ║ Контрагент     <ContrCode> <ContrName>                                       ║
                          ║ Генеральное соглашение  <GenAgr>          CSA: <CSA>                         ║
                          ║ ─────────────────────────────────────────────────────────────────────────────║
                          ║ Плавающая  маржевая сумма:   <SumPay> <Cur>    Направление:   <Dir>          ║
                          ║ Общая маржевая сумма:        <SumTotal> <CurT>                               ║
                          ║ Дата расчета маржевой суммы:  <Dcalc>                                        ║
                          ║ Дата оплаты плановая:         <Dplan>                                        ║
                          ║ Дата следующего расчета:      <Dnext>                                        ║
                          ║──────────────────────────────────────────────────────────────────────────────║
                          ║ Комментарии                                                                  ║
                          ║ <Comments>                                                                   ║
                          ║                                                                              ║
                          ║ Филиал <Filial>            Исполнитель <UserCode>  <UserName>                ║
                          ╚══════════════════════════════════════════════════════════════════════════════╝
*/

import RsbDataSet, "dvcsalib.mac";
/*CSA*/
//IMPORT dlwreps;
IMPORT "Print_docs_PFI.mac";


private var TableHeader = "┌────────────────────────────── Маржевый платеж ──────────────────────────────┐\n" +
                          "├─────────────────────────────────────────────────────────────────────────────┤";
private var TableErrors = "┌─────────────────────────────────────── Протокол выполнения ────────────────────────────────────────┐\n" +
                          "├────────────────────────────────────────────────────────────────────────────────────────────────────┤";

/* для обработки ошибок */
private var ErrorStr = 0;
private var Errors = TArray();
private var ErrorsReportLog = false;
/* данные для отчета */
private var ReportData;
private var Rep = CMakeReport(TableHeader);
/*CSA*/
private CONST TemplateName = "Print_proc_CSA.dot";

CLASS SourceData( _CSAID:integer, _PMID:integer )
  var PMID          = _PMID,
      CSAID         = _CSAID;
  var DateRep:date = {curdate};  
END;

/*------------------------------------------------------------------------------------------------------------------*/

/* Добовление ошибки с массив*/
macro ErrorLog( msg:string )
   Errors[ErrorStr]  = msg;
   ErrorStr = ErrorStr + 1;
end;

/* печать */
macro PrintLog()
  var count = 0;
   if( ErrorsReportLog )
      Rep.AddNewSheetBreak("Протокол", TableErrors);
      while( count < ErrorStr )

         Rep.AddPrintCell( Errors[count] , 0, 0, "l");
         Rep.AddStr();

         count = count + 1;
      end;
   end;
end;

MACRO СозданиеОтчёта()

  var Query, Data;
  var CSACode, PartyID, GenAgrID, GenAgrCode = "";
  var Direction, DirectionName = "", SumPay, SumPayCurFIID = 0, SumPayCurCCY = "";
  var SumTotal, SumTotalFIID = 0, SumTotalCCY = "";
  var CalcDate:date, PlanDate:date, NextDate:date;
  var Comment = "", Oper, Department;

   Rep.GetCurSheet().SetSheetName( "Отчёт" );

  /*Получаем данные для формирования отчета */
  Query = "SELECT T_Code, T_PartyID, T_GenAgrID FROM ddvcsa_dbt WHERE T_CSAID = " + ReportData.CSAID;
  Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
  if ( Data.MoveFirst() )
    CSACode = Data.Code;
    PartyID = Data.PartyID;
    GenAgrID = Data.GenAgrID;
  else
    ErrorLog( "Отсутствует договор CSAID=" + ReportData.CSAID );
    ErrorsReportLog = true;
    return 1;
  end;

  // T_Kind = 1 - маржевый платеж (2 - процентный платеж)
  Query = "SELECT T_Direction, T_SumPay, T_SumPayCur, T_SumTotal, T_SumTotalCur, T_CalcDate, T_PlanPayDate, T_NextDate, T_Comment, T_Oper, T_Department"
        + " FROM ddvcsapm_dbt "
        + " WHERE T_Kind = 1 "
        + " AND T_CSAID = " + ReportData.CSAID 
        + " AND T_PMID = "+ ReportData.PMID; 
  Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
  if ( Data.MoveFirst() )
    Direction = Data.Direction;
    SumPay = Data.SumPay;
    SumPayCurFIID = Data.SumPayCur;
    SumTotal = Data.SumTotal;
    SumTotalFIID = Data.SumTotalCur;
    CalcDate = Data.CalcDate;
    PlanDate = Data.PlanPayDate;
    NextDate = Data.NextDate;
    Comment = Data.Comment;
    Oper = Data.Oper;
    Department = Data.Department;
  else
    ErrorLog( "Отсутствует маржевый платеж PMID=" + ReportData.PMID + " по договору CSAID=" + ReportData.CSAID );
    ErrorsReportLog = true;
    return 1;
  end;

/*║ Дата <Dstep>                                                                 ║
  ║ Контрагент     <ContrCode> <ContrName>                                       ║
  ║ Генеральное соглашение  <GenAgr>          CSA: <CSA>                         ║ */
   Rep.SetFlagShowMidSeparator(false);
   Rep.AddPrintCell( "Дата: "+ ReportData.DateRep, 0, 0, "l");
   Rep.AddStr();

  if( PartyID > 0 )
    Query = " SELECT p.T_Name, pc.T_Code FROM dparty_dbt p, dpartcode_dbt pc WHERE pc.T_PartyID = p.T_PartyID AND p.T_PartyID = " + PartyID;
    Data =  TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
    if( Data.MoveNext() )
      Rep.AddPrintCell( "Контрагент: "+ Data.Code + "  " + Data.Name, Rep.GetHeaderWidth(), 0, "l");
      Rep.AddStr();
    end;
  end;

  if( GenAgrID > 0 )
    Query = "SELECT T_Code FROM ddl_genagr_dbt WHERE t_GenAgrID = " + GenAgrID;
    Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
    if (Data.MoveFirst())
      GenAgrCode = Data.Code;
    end;
  end;

  Rep.AddPrintCell( "Генеральное соглашение: "+ GenAgrCode + "  CSA: " + CSACode, 0, 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "─────────────────────────────────────────────────────────────────────────────", 0, 0, "l");
  Rep.AddStr();
/*║ Плавающая  маржевая сумма:   <SumPay> <Cur>    Направление:   <Dir>          ║
  ║ Общая маржевая сумма:        <SumTotal> <CurT>                               ║
  ║ Дата расчета маржевой суммы:  <Dcalc>                                        ║
  ║ Дата оплаты плановая:         <Dplan>                                        ║
  ║ Дата следующего расчета:      <Dnext>                                        ║ */
  Query = "SELECT T_CCY FROM dfininstr_dbt WHERE T_FIID = " + SumPayCurFIID;
  Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
  if (Data.MoveFirst())
    SumPayCurCCY = Data.CCY;
  end;
  Query = "SELECT T_CCY FROM dfininstr_dbt WHERE T_FIID = " + SumTotalFIID;
  Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
  if (Data.MoveFirst())
    SumTotalCCY = Data.CCY;
  end;
  Query = "SELECT T_SZNameAlg FROM dnamealg_dbt WHERE T_iTypeAlg=7516 AND T_iNumberAlg = " + Direction;
  Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
  if (Data.MoveFirst())
    DirectionName = Data.SZNameAlg;
  end;  
  Rep.AddPrintCell( "Плавающая маржевая сумма: "+ SumPay +" "+ SumPayCurCCY +"    Направление: "+ DirectionName, 0, 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "Общая маржевая сумма:     "+ SumTotal +" "+ SumTotalCCY, 0, 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "Дата расчета маржевой суммы: "+ CalcDate, 0, 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "Дата оплаты плановая:        "+ PlanDate, 0, 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "Дата следующего расчета:     "+ NextDate, 0, 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "─────────────────────────────────────────────────────────────────────────────", 0, 0, "l");
  Rep.AddStr();
  /*║ Комментарии                                                                  ║
    ║ <Comments>                                                                   ║
    ║                                                                              ║
    ║ Филиал <Filial>            Исполнитель <UserCode>  <UserName>                ║ */
  Query = "SELECT T_Name FROM dperson_dbt WHERE T_Oper = " + Oper;
  Data = TRsbDataSet( Query, RSDVAL_CLIENT, RSDVAL_STATIC );
  Data.MoveFirst();
  Rep.AddPrintCell( "Комментарии:\n"+ Comment, Rep.GetHeaderWidth(), 0, "l");
  Rep.AddStr();
  Rep.AddPrintCell( "Филиал: "+ Department +"     Исполнитель: "+ Oper +" "+ Data.Name, 0, 0, "l");
  Rep.AddStr();
  Rep.AddEmptyStr();
END;

//ожидается оригинальная процедура в оригинальном макросе, а пока используем эту
macro PrintProcRun( _CSAID:integer, _PMID:integer )   

  var ReportFileName, TblName = "CSAMMP", errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода для отчета*/
  if( MsgBoxEx( "Открыть печатную форму в текстовом редакторе?", MB_YES+MB_NO, IND_YES ) == IND_NO )  
      msgbox("Дистрибутивная форма для данного вида платежа отсутствует.");
      /*
      ReportData = SourceData( _CSAID, _PMID );
      СозданиеОтчёта();   
      PrintLog();
      if( Rep.GetCountSheet == 0 )
        MsgBox("\nНет данных для печати.");
      end;

      ReportFileName = GetTxtFileName( TblName );

      if( Open( ReportOutFile, ReportFileName ) == false )
        errcode = status( errtext );
        MsgBox( "Ошибка при открытии файла отчета|"+ ReportFileName +"|(" + errcode + ") " + errtext);
        break;
      end;

      SetOutput( ReportFileName );
      Rep.PrintRep();
      SetOutput( NULL, true );
      close( ReportOutFile );
      ViewFile( ReportOutFile );*/
  else
     СформироватьУведомление_о_Процентах (_CSAID, _PMID);
  end;
  return 0;
end;

//PrintProcPrRun ( );

//PrintMPRun(81, 320);