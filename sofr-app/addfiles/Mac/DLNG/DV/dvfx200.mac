
import InsCarryDoc, "dvserv.mac", "dv_fun.mac", "dv_carop.mac";

macro ExecuteStep( doc, FDoc )

   record deal(dvndeal);
   SetBuff(deal, FDoc);
   var FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);
   var kindbnote = "";
   GetMainObjAttr(null, OBJTYPE_FXOPER_DV, uniid(deal, OBJTYPE_FXOPER_DV), 202, null, null, kindbnote);
   var isSelfIncas = "";
   if ( FD.IsBuy() )
      //Если покупка, необходимо запланировать шаг
      if (kindbnote == 1)  //Предпоставка                  
         //Планируем Исполнение обязательств согласно значению сегмента статуса
         if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
            MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
            return 1;
         end;
         //Завершаем Исполнение Т/О, к которому относится акцепт
         if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_COMPLETE) )
            MsgBox("Ошибка при установке статуса <Требования> по операции.");
            return 1;
         end;
      else
         //Если это покупка, шаг планировать не требуется, то завершаем Исполнение Т/О, к которому относится акцепт
         if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_COMPLETE) )
            MsgBox("Ошибка при установке статуса <Требования> по операции.");
            return 1;
         end;
      end;
   else
      //Если это продажа, шаг планировать не требуется, то завершаем Исполнение Т/О, к которому относится акцепт
      if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_COMPLETE) )
         MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
         return 1;
      end;
      if (kindbnote == 1)  //Предпоставка
         if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
            MsgBox("Ошибка при установке статуса <Требования> по операции.");
            return 1;
         end;
      end;            
   end;
   GetMainObjAttr(null, OBJTYPE_FXOPER_DV, uniid(deal, OBJTYPE_FXOPER_DV), 203, null, null, isSelfIncas);
   if (isSelfIncas == 1)   //Собственная инкассация
      Opr_InsertBranch("B", OPRBR_INSERT, true);
   end;
   return 0;
END;