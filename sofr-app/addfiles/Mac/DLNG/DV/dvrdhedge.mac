/*
$Name:        dvrdhedge.mac
$Module:      ФИСС и КО
$Description: Отчет "Проверка распределения корректировок хеджирования"
*/

import "dvrepfun.mac", "dvRepFun2.mac", RsbDataSet, "or_rep_h.mac", "dv_categ.mac", "dv_fun.mac", "dvserv.mac", "dv_car.mac", "dldlngfun.mac";

const FontBold =  "ex_FS(b)";
const FontTitle = "ex_FS(b):ex_FN(Arial):ex_FZ(12)";

private var TableCb = "┌────────────────┬─────────────────────┬────────────────┬─────────────┬──────────────┬───────────────┬────────────────┬────────────────┬──────────────────┬───────────────┬───────────────┬───────────────┬───────────────────────────┬───────────────┬───────────────┬──────────────┬──────────────────┬─────────────────┬───────────────┬────────────────────┬─────────────────────┬─────────────────────────────┐\n" +
                      "│    Эмитент     │ Наименование ценной │     № гос.     │    ISIN     │ Дата выпуска │     Дата      │ Номинал за ед. │     Валюта     │    Кол-во шт.    │   Величина    │    Валюта     │  Дата учёта   │  Величина корректировки,  │    Валюта     │     Дата      │ Дата начала  │  Дата окончания  │ Код инструмента │  Тип сделки   │   Дата заключения  │   Номер лицевого    │   Остаток лицевого счёта    │\n" +
                      "│                │        бумаги       │  регистрации   │             │              │   погашения   │                │    номинала    │                  │ корректировки │ корректировки │ корректировки │  подлежащей амортизации   │ корректировки │   последней   │  отношений   │     отношений    │  хеджирования   │  инструмента  │ сделки инструмента │ счёта корректировок │ корректировок хеджирования, │\n" +
                      "│                │                     │                │             │              │               │                │                │                  │ хеджирования  │ хеджирования  │ хеджирования  │                           │               │  амортизации  │ хеджирования │   хеджирования   │                 │  хеджирования │    хеджирования    │     хеджирования    │          руб                │\n" +
                      "├────────────────┼─────────────────────┼────────────────┼─────────────┼──────────────┼───────────────┼────────────────┼────────────────┼──────────────────┼───────────────┼───────────────┼───────────────┼───────────────────────────┼───────────────┼───────────────┼──────────────┼──────────────────┼─────────────────┼───────────────┼────────────────────┼─────────────────────┼─────────────────────────────┤";
private var TableBn = "┌────────────────┬───────────────────┬────────────────┬──────────────────┬────────────┬───────────────┬────────────────┬───────────────┬───────────────┬───────────────┬──────────────┬──────────────────┬─────────────────┬───────────────┬────────────────────┬─────────────────────┬─────────────────────────────┐\n" +
                      "│                │                   │                │                  │            │    Валюта     │      Дата      │   Величина    │    Валюта     │  Дата учёта   │ Дата начала  │  Дата окончания  │ Код инструмента │  Тип сделки   │   Дата заключения  │   Номер лицевого    │   Остаток лицевого счёта    │\n" +
                      "│ Векселедатель  │       Серия       │     Номер      │ Дата составления │  Номинал   │   номинала    │  приобретения/ │ корректировки │ корректировки │ корректировки │  отношений   │     отношений    │  хеджирования   │  инструмента  │ сделки инструмента │ счёта корректировок │ корректировок хеджирования, │\n" +
                      "│                │                   │                │                  │            │               │   Дата выдачи  │ хеджирования  │ хеджирования  │ хеджирования  │ хеджирования │   хеджирования   │                 │  хеджирования │    хеджирования    │     хеджирования    │          руб                │\n" +
                      "├────────────────┼───────────────────┼────────────────┼──────────────────┼────────────┼───────────────┼────────────────┼───────────────┼───────────────┼───────────────┼──────────────┼──────────────────┼─────────────────┼───────────────┼────────────────────┼─────────────────────┼─────────────────────────────┤";
private var TableMBC = "┌────────────────┬───────────────────┬───────────┬────────────┬─────────────────┬─────────────────┬───────────────┬───────────────┬───────────────┬──────────────┬──────────────────┬─────────────────┬───────────────┬────────────────────┬─────────────────────┬─────────────────────────────┐\n" +
                       "│                │                   │           │            │                 │                 │   Величина    │    Валюта     │  Дата учёта   │ Дата начала  │  Дата окончания  │ Код инструмента │  Тип сделки   │   Дата заключения  │   Номер лицевого    │   Остаток лицевого счёта    │\n" +
                       "│ Код сделки МБК │    Тип сделки     │   Сумма   │   Валюта   │ Дата заключения │ Дата исполнения │ корректировки │ корректировки │ корректировки │  отношений   │     отношений    │  хеджирования   │  инструмента  │ сделки инструмента │ счёта корректировок │ корректировок хеджирования, │\n" +
                       "│                │                   │           │            │                 │                 │ хеджирования  │ хеджирования  │ хеджирования  │ хеджирования │   хеджирования   │                 │  хеджирования │    хеджирования    │     хеджирования    │          руб                │\n" +
                       "├────────────────┼───────────────────┼───────────┼────────────┼─────────────────┼─────────────────┼───────────────┼───────────────┼───────────────┼──────────────┼──────────────────┼─────────────────┼───────────────┼────────────────────┼─────────────────────┼─────────────────────────────┤";


private var TableErrors = "┌────────────────────────────────────────────────────────────────────────────────────────────────────┐\n" +
                          "│                                          Ошибки выполнения                                         │\n" +
                          "├────────────────────────────────────────────────────────────────────────────────────────────────────┤";



/* для обработки ошибок */
private var ErrorStr = 0;
private var Errors = TArray();
private var ErrorsReportLog = TRUE;
private var ReportData;
private var Rep;

var IsID = -1;

CLASS SourceData( _DateRep:date,
                 _isAccCb:bool,
                 _AccCbFIID:integer,
                 _IsEmissCb:bool,
                 _EmissCbFIID:integer,
                 _IsAccBn:bool,
                 _AccBnFIID:integer,
                 _IsEmissBn:bool,
                 _EmissBnFIID:integer,
                 _IsDealMBCRaise:bool,
                 _DealMBCRaiseFIID:integer,
                 _IsDealMBCPlace:bool,
                 _DealMBCPlaceFIID:integer,
                 _IsApp:bool,
                 _IsExcel:bool )
   /* данные для отчета */
   var dateRep   = _DateRep,
       isAccCb   = _isAccCb,
       AccCbFIID   = _AccCbFIID,
       IsEmissCb = _IsEmissCb,
       EmissCbFIID = _EmissCbFIID,
       IsAccBn   = _IsAccBn,
       AccBnFIID   = _AccBnFIID,
       IsEmissBn = _IsEmissBn,
       EmissBnFIID = _EmissBnFIID,
       IsDealMBCRaise     = _IsDealMBCRaise,
       DealMBCRaiseFIID   = _DealMBCRaiseFIID,
       IsDealMBCPlace     = _IsDealMBCPlace,
       DealMBCPlaceFIID = _DealMBCPlaceFIID,
       IsApp     = _IsApp,
       IsExcel   = _IsExcel,
       ReportRun = false;

   var FirstSheet = NULL;
   var FirstPage  = -1;
   var Fltr       = "";
END;

/*------------------------------------------------------------------------------------------------------------------*/
MACRO ЗаписиЦБ(HgObjType, CbFIID)
   var Sql = "SELECT fin.t_Name FIName, fin.t_Issued, fin.t_DrawingDate, fin.t_FaceValue, fin.t_FaceValueFI, fin.t_FIID, avr.t_LSIN, avr.t_ISIN, iss.t_ShortName IssuerName, " +
             " (SELECT NVL(SUM(LOT.T_AMOUNT),0) " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND (LOT.t_HedgCorrDate <= "+GetSQLDate(ReportData.dateRep) +" OR LOT.t_AmortHedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+")"+   
             "                 AND LOT.t_Amount       > 0) LotAmount, " +
             " (SELECT NVL(SUM(LOT.T_HEDGCORR),0) " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND LOT.t_HedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+   
             "                 AND LOT.t_Amount       > 0) HedgCorr, " +
             " (SELECT NVL(MAX(LOT.T_HEDGCORRDATE),TO_DATE('01.01.0001', 'DD.MM.YYYY')) " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND LOT.t_HedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+   
             "                 AND LOT.t_Amount       > 0) HedgCorrDate, " +
             " (SELECT LOT.t_Currency " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND LOT.t_HedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+   
             "                 AND LOT.t_Amount       > 0         "+    
             "                 AND ROWNUM = 1 ) HedgCurrency, " +
             " (SELECT NVL(SUM(LOT.T_AMORTHEDGCORR),0) " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND LOT.t_AmortHedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+   
             "                 AND LOT.t_Amount       > 0) AmortCorr, " +
             " (SELECT NVL(MAX(LOT.t_AmortHedgCorrDate),TO_DATE('01.01.0001', 'DD.MM.YYYY')) " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND LOT.t_AmortHedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+   
             "                 AND LOT.t_Amount       > 0) AmortCorrDate, " +
             " (SELECT LOT.t_Currency " +
             "               FROM DPMWRTSUM_DBT LOT " +
             "                 WHERE LOT.t_FIID       = fin.t_FIID  " +
             "                 AND LOT.t_Party        = -1 " +
             "                 AND ( (LOT.t_Portfolio = "+KINDPORT_ASCB+" AND LOT.t_State IN ("+PM_WRTSUM_FORM+", "+PM_WRTSUM_SALE_BPP+")) "+
             "                 OR (LOT.t_Portfolio  IN (40, -1) AND LOT.t_State = "+PM_WRTSUM_PLACE_OWN+")) " +
             "                 AND LOT.t_Contract     = 0 " 
             "                 AND LOT.t_Date         <= "+GetSQLDate(ReportData.dateRep)+  
             "                 AND LOT.t_AmortHedgCorrDate <= "+GetSQLDate(ReportData.dateRep)+   
             "                 AND LOT.t_Amount       > 0         "+    
             "                 AND ROWNUM = 1 ) AmortCurrency " +
             " FROM dfininstr_dbt fin, dparty_dbt iss, davoiriss_dbt avr "+
             "  WHERE iss.t_PartyID = fin.t_Issuer "+
             "  AND avr.t_FIID = fin.t_FIID " +
             "   AND  EXISTS ( SELECT 1 FROM ddlhdgrelation_dbt hdr " +
             "                  WHERE hdr.t_ObjID = fin.t_FIID " +
             "                   AND  hdr.t_ObjType IN ( " +DL_DV_HEDGEOBJTYPE_CB_ACQUIRED+ "," +DL_DV_HEDGEOBJTYPE_CB_EMISSED+ " ) " +
             "  AND hdr.t_BeginDate <= " + GetSQLDate(ReportData.dateRep) +
             "  AND ((hdr.t_EndDate >= " + GetSQLDate(ReportData.dateRep) + " ) or (hdr.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY')))) ";

   if(CbFIID != -1)
      Sql = Sql + " AND fin.t_FIID = " + string(CbFIID); 
   end;
   if(HgObjType == DL_DV_HEDGEOBJTYPE_CB_EMISSED)
      Sql = Sql + " AND fin.t_Issuer = " + {OurBank};
   else
      Sql = Sql + " AND fin.t_Issuer <> " + {OurBank};
   end;
   return Sql;
END;

MACRO ЗаписиИХвЦБ(vFIID)
   var Sql = "SELECT " +
             " deal.t_Code, deal.t_ID DealID, deal.t_DocKind DealDocKind, deal.t_Date DealDate, hdr.t_BeginDate, hdr.t_EndDate, nfi.t_ExecType, nfi.t_FIID BFIID, " +
             " ( SELECT t_FIID FROM ddvnfi_dbt WHERE t_DealID = deal.t_ID AND t_Type = "+string(DV_NFIType_BaseActiv2)+" ) BFIID2 "+ 
             " FROM ddvndeal_dbt deal, ddlhdgrelation_dbt hdr, ddvnfi_dbt nfi "+
             "  WHERE hdr.t_ObjID = "+vFIID+
             "   AND  hdr.t_ObjType IN ( " +DL_DV_HEDGEOBJTYPE_CB_ACQUIRED+ "," +DL_DV_HEDGEOBJTYPE_CB_EMISSED+ " ) " +
             "   AND  hdr.t_BeginDate <= " + GetSQLDate(ReportData.dateRep) +
             "   AND  ((hdr.t_EndDate >= " + GetSQLDate(ReportData.dateRep) + " ) or (hdr.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY'))) "+
             "  AND deal.t_ID = hdr.t_InstrID "+
             "  AND nfi.t_DealID = deal.t_ID "+
             "   AND  nfi.t_Type =  "+string(DV_NFIType_BaseActiv);

   return Sql;
END;

MACRO ЗаписиВексель(HgObjType, BnFIID)
   var Sql = "SELECT bnr.t_BCID, bnr.t_IssuerName, bnr.t_BCSeries, bnr.T_BCNumber, leg.t_Start Issued, leg.t_Principal FaceValue, leg.t_PFI FaceValueFI, " +
             " ( select Max(t_ChangeDate) from dvsbnrbck_dbt where t_BCID = bnr.t_BCID AND "+
             IIF(HgObjType == DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED, "t_ABCStatus = 'X' AND t_NewABCStatus = "+string(VABANNER_STATUS_ACCOUNT), " t_BCStatus = 'X' AND t_NewABCStatus = "+string(VSBANNER_STATUS_SENDED) )+" ) ChangeDate"+  
             " FROM dvsbanner_dbt bnr, ddl_leg_dbt leg, dficert_dbt ficert "+
             "  WHERE bnr.t_BCID = leg.t_DealID "+
             "  AND ficert.t_CertID = bnr.t_BCID "+
             "  AND " + IIF(HgObjType == DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED, " bnr.t_ABCStatus = "+string(VABANNER_STATUS_ACCOUNT), " bnr.t_BCStatus = "+string(VSBANNER_STATUS_SENDED))+
             "  AND leg.t_LegKind =  "+LEG_KIND_VSBANNER +
             "   AND  EXISTS ( SELECT 1 FROM ddlhdgrelation_dbt hdr " +
             "                  WHERE hdr.t_ObjID =  bnr.t_BCID " +
             "                   AND  hdr.t_ObjType IN ( " +DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED+ "," +DL_DV_HEDGEOBJTYPE_BN_EMISSED+ " ) " +
             "  AND hdr.t_BeginDate <= " + GetSQLDate(ReportData.dateRep) +
             "  AND ((hdr.t_EndDate >= " + GetSQLDate(ReportData.dateRep) + " ) or (hdr.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY')))) ";
   if(BnFIID != -1)
      Sql = Sql + " AND bnr.t_BCID = " + string(BnFIID); 
   end;
   return Sql;
END;

MACRO ЗаписиИХВексель(vBanner)
   var Sql = "SELECT " +
             " deal.t_Code, deal.t_ID DealID, deal.t_DocKind DealDocKind, deal.t_Date DealDate, hdr.t_BeginDate, hdr.t_EndDate,  nfi.t_ExecType, nfi.t_FIID BFIID,  "+
             " ( SELECT t_FIID FROM ddvnfi_dbt WHERE t_DealID = deal.t_ID AND t_Type = "+string(DV_NFIType_BaseActiv2)+" ) BFIID2 "+ 
             " FROM ddlhdgrelation_dbt hdr, ddvndeal_dbt deal, ddvnfi_dbt nfi "+
             "  WHERE hdr.t_ObjID = "+vBanner+
             "   AND  hdr.t_ObjType IN ( " +DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED+ "," +DL_DV_HEDGEOBJTYPE_BN_EMISSED+ " ) "+
             "   AND  hdr.t_BeginDate <= " + GetSQLDate(ReportData.dateRep) +
             "   AND  ((hdr.t_EndDate >= " + GetSQLDate(ReportData.dateRep) + " ) or (hdr.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY'))) "+
             "  AND deal.t_ID = hdr.t_InstrID "+
             "  AND nfi.t_DealID = deal.t_ID "+
             "   AND  nfi.t_Type =  "+string(DV_NFIType_BaseActiv); 

   return Sql;
END;

MACRO ЗаписиМБК(HgObjType, DealMBCFIID)
   var Sql = "SELECT tick.t_DealID, tick.t_DealCode, tick.t_DealDate MBCDealDate, leg.t_Principal DealSum, leg.t_PFI DealSumFI, leg.t_Maturity MBCExecDate,  "+
             " (CASE WHEN oprkoper.t_SysTypes LIKE ('%S%') THEN "+DL_DV_HEDGEOBJTYPE_MBK_PLACEMENT+" ELSE "+DL_DV_HEDGEOBJTYPE_MBK_RAISING+" END) AS ObjType "+
             " FROM ddl_tick_dbt tick, ddl_leg_dbt leg, doprkoper_dbt oprkoper "+
             "  WHERE tick.t_BofficeKind =  "+ DL_IBCDOC+
             "  AND leg.t_DealID =  tick.t_DealID " +
             "  AND oprkoper.t_DocKind = tick.t_BofficeKind " +
             "  AND oprkoper.t_Kind_Operation = tick.t_DealType " +
             "   AND  EXISTS ( SELECT * FROM ddlhdgrelation_dbt hdr "+
             "                 WHERE hdr.t_ObjID =  tick.t_DealID "+
             "                  AND  hdr.t_ObjType IN ( " +DL_DV_HEDGEOBJTYPE_MBK_PLACEMENT+ "," +DL_DV_HEDGEOBJTYPE_MBK_RAISING+ " ) "+
             "                  AND  hdr.t_ObjType = " + HgObjType +
             "  AND hdr.t_BeginDate <= " + GetSQLDate(ReportData.dateRep) +
             "  AND ((hdr.t_EndDate >= " + GetSQLDate(ReportData.dateRep) + " ) or (hdr.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY')))) ";
   if(DealMBCFIID != -1)
      Sql = Sql + " AND tick.t_DealID = " + string(DealMBCFIID); 
   end;
   return Sql;
END;

MACRO ЗаписиИХвМБК(vDealID)
   var Sql = "SELECT " +
             " hdr.t_BeginDate, hdr.t_EndDate,  hdr.t_InstrID DvNDealID, deal.t_Code, deal.t_Date DealDate, nfi.t_ExecType, nfi.t_FIID BFIID, " +
             " (SELECT t_FIID FROM ddvnfi_dbt WHERE t_DealID = deal.t_ID AND t_Type = "+string(DV_NFIType_BaseActiv2)+" ) BFIID2 "+ 
             " FROM ddlhdgrelation_dbt hdr, ddvndeal_dbt deal, ddvnfi_dbt nfi "+
             "  WHERE hdr.t_ObjID = "+vDealID+
             "   AND  hdr.t_ObjType IN ( " +DL_DV_HEDGEOBJTYPE_MBK_PLACEMENT+ "," +DL_DV_HEDGEOBJTYPE_MBK_RAISING+ " ) "+
             "   AND  hdr.t_BeginDate <= " + GetSQLDate(ReportData.dateRep) +
             "   AND  ((hdr.t_EndDate >= " + GetSQLDate(ReportData.dateRep) + " ) or (hdr.t_EndDate = TO_DATE('01.01.0001','DD.MM.YYYY'))) "+
             "  AND deal.t_ID = hdr.t_InstrID "+
             "  AND nfi.t_DealID = deal.t_ID "+
             "   AND  nfi.t_Type =  "+string(DV_NFIType_BaseActiv);
   return Sql;
END;

MACRO ПолучитьДатуПоследнейПроводки(Account):date
   var sql = " SELECT Max(trn.T_DATE_CARRY) trnDate " +
               " FROM dacctrn_dbt trn " +
               " WHERE (trn.T_ACCOUNT_PAYER =  '" + Account + "' OR trn.T_ACCOUNT_RECEIVER =  '" + Account + "') "
               " AND trn.T_DATE_CARRY <=  " + GetSQLDate(ReportData.dateRep);
   var cmd = DL_RsdCommand(sql);
   var DataSet = cmd.execute();
   if( DataSet.MoveNext() )
      return DataSet.trnDate;
   else
      return ZeroDate;
   end;
END;

/* Добовление ошибки с массив*/
macro ErrorLog( msg:string )
   Errors[ErrorStr]  = msg;
   ErrorStr = ErrorStr + 1;
end;

/* печать */
macro PrintLog()
  var count = 0;
   if( ErrorsReportLog )
      Rep.AddNewSheetBreak("Ошибки", TableErrors);
      while( count < ErrorStr )

         Rep.AddPrintCell( Errors[count] , 0, 0, "l");
         Rep.AddStr();

         count = count + 1;
      end;
   end;
end;

/*------------------------------------------------------------------------------------------------------------------*/
/*
Филиал: <H0.1>
                                                     Проверка распределения корректировок от хеджирования
Дата отчета:    <H0.2>
*/
macro PrintHead0( SheetName, DateRep, Table )
   var HeaderText = ""; var AvoirCode = ""; var AvoirName = "";
   var FI = TRecHandler("fininstr.dbt");
   if( ReportData.FirstSheet != NULL )
      Rep.AddNewSheetBreak( SheetName, Table );
   else
      ReportData.FirstSheet = SheetName;
   end;
 
   if(Table == TableCb)
      HeaderText = "Проверка распределения корректировок от хеджирования по лотам для ценных бумаг"; 
   elif(Table == TableBn)
      HeaderText = "Проверка распределения корректировок от хеджирования для векселей";
   else
      HeaderText = "Проверка распределения корректировок от хеджирования для сделок МБК";
   end;

   Rep.AddPrintCell( HeaderText, Rep.GetHeaderWidth(), 0, "c:" + FontTitle, REP_ELEM_STR);
   Rep.AddStr();
   Rep.AddPrintCell( "на дату: " + DateRep, Rep.GetHeaderWidth(), 0, "c:", REP_ELEM_STR);
   Rep.AddStr();
   if(Table == TableCb)
      var cbFIID = IIF(SheetName == "Приобретённые ЦБ", ReportData.AccCbFIID, ReportData.EmissCbFIID);
      if ( cbFIID > 0 )
         if( ПолучитьФинИн( cbFIID, @FI ) !=0 )
            ErrorLog( "Не удалось получить финансовый инструмент с FIID = " + String( cbFIID ) );
            AvoirCode = " "; AvoirName = " ";
         else
            AvoirCode = FI.rec.FI_Code; AvoirName = FI.rec.Name;
         end;
      else
         AvoirCode = "все"; AvoirName = " ";
      end;
      Rep.AddPrintCell( "Выпуск: ", 12, 0, "l", REP_ELEM_STR);
      Rep.AddPrintCell( AvoirCode, 24, 0, "l", REP_ELEM_STR);
      Rep.AddPrintCell( AvoirName, Rep.GetHeaderWidth() - 36, 0, "l", REP_ELEM_STR);
   Rep.AddStr();
end;
   Rep.AddEmptyStr();
end;

MACRO PrintDate(vDate)
   return IIF(((vDate == ZeroDate) or (vDate == null)), " ", Date(vDate));
END;

MACRO GetDealType(ExecType, BFIID, BFIID2)
   if( (ExecType == DVSETTLEMET_CALC) and (BFIID == BFIID2) )
      return "Процентный своп";
   else
      return "Валютно-процентный своп";
   end;
END;

macro PrintLineCb( IssuerName, FIName, LSIN, ISIN, Issued, DrawingDate, FaceValue, FaceValueFI, LotAmount, CorrHedge, CorrHedgeFI, CorrHedgeDate, AmortCorr, AmortCorrFI, AmortCorrDate, BeginDate, EndDate, Code, DealType, DealDate, HgAccount, HgAccountRest )

   Rep.AddPrintCell( IssuerName, 0, 0, "c");
   Rep.AddPrintCell( FIName, 0, 0, "c");
   Rep.AddPrintCell( LSIN, 0, 0, "c");
   Rep.AddPrintCell( ISIN, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(Issued), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(DrawingDate), 0, 0, "c");
   if(FaceValue == " ")
      Rep.AddPrintCell( FaceValue, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(FaceValue), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( FaceValueFI, 0, 0, "c");
   if(LotAmount == " ")
      Rep.AddPrintCell( LotAmount, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(LotAmount), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   if(CorrHedge == " ")
      Rep.AddPrintCell( CorrHedge, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(CorrHedge), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( CorrHedgeFI, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(CorrHedgeDate), 0, 0, "c");
   if(AmortCorr == " ")
      Rep.AddPrintCell( AmortCorr, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(AmortCorr), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( AmortCorrFI, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(AmortCorrDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(BeginDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(EndDate), 0, 0, "c");
   Rep.AddPrintCell( Code, 0, 0, "c");
   Rep.AddPrintCell( DealType, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(DealDate), 0, 0, "c");
   Rep.AddPrintCell( HgAccount, 0, 0, "c");
   if(HgAccountRest == " ")
      Rep.AddPrintCell( HgAccountRest, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(HgAccountRest), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddStr();
end;

macro PrintLineBn( IssuerName, BCSeries, BCNumber, Issued, FaceValue, FaceValueFI, ChangeDate, CorrHedge, CorrHedgeFI, CorrHedgeDate, BeginDate, EndDate, Code, DealType, DealDate, HgAccount, HgAccountRest )

   Rep.AddPrintCell( IssuerName, 0, 0, "c");
   Rep.AddPrintCell( BCSeries, 0, 0, "c");
   Rep.AddPrintCell( BCNumber, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(Issued), 0, 0, "c");
   if(FaceValue == " ")
      Rep.AddPrintCell( FaceValue, 0, 0, "c");
   else
      Rep.AddPrintCell( Money(FaceValue), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( FaceValueFI, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(ChangeDate), 0, 0, "c");
   if(CorrHedge == " ")
      Rep.AddPrintCell( CorrHedge, 0, 0, "c");
   else
      Rep.AddPrintCell( Money(CorrHedge), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( CorrHedgeFI, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(CorrHedgeDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(BeginDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(EndDate), 0, 0, "c");
   Rep.AddPrintCell( Code, 0, 0, "c");
   Rep.AddPrintCell( DealType, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(DealDate), 0, 0, "c");
   Rep.AddPrintCell( HgAccount, 0, 0, "c");
   if(HgAccountRest == " ")
      Rep.AddPrintCell( HgAccountRest, 0, 0, "c");
   else
      Rep.AddPrintCell( Money(HgAccountRest), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddStr();
end;

macro PrintLineMBC( DealCode, MBCDealType, DealSum, DealSumFI, MBCDealDate, MBCExecDate, CorrHedge, CorrHedgeFI, CorrHedgeDate, BeginDate, EndDate, Code, DealType, DealDate, HgAccount, HgAccountRest )

   Rep.AddPrintCell( DealCode, 0, 0, "c");
   Rep.AddPrintCell( MBCDealType, 0, 0, "c");
   if(DealSum == " ")
      Rep.AddPrintCell( DealSum, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(DealSum), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( DealSumFI, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(MBCDealDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(MBCExecDate), 0, 0, "c");
   if(CorrHedge == " ")
      Rep.AddPrintCell( CorrHedge, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(CorrHedge), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddPrintCell( CorrHedgeFI, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(CorrHedgeDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(BeginDate), 0, 0, "c");
   Rep.AddPrintCell( PrintDate(EndDate), 0, 0, "c");
   Rep.AddPrintCell( Code, 0, 0, "c");
   Rep.AddPrintCell( DealType, 0, 0, "c");
   Rep.AddPrintCell( PrintDate(DealDate), 0, 0, "c");
   Rep.AddPrintCell( HgAccount, 0, 0, "c");
   if(HgAccountRest == " ")
      Rep.AddPrintCell( HgAccountRest, 0, 0, "c"); 
   else
      Rep.AddPrintCell( Money(HgAccountRest), 0, 2, IIF(ReportData.IsApp, "r:a", "r"));
   end;
   Rep.AddStr();
end;

MACRO СозданиеОтчёта()
   var NotEofFile;
   var Progress = TProgressBar;
   var cmd, DataSet;
   var cmdHg, DataSetHg;
   var A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21, A22;
   var B1, B2, B3, B4, B5, B6, B7, B8, B9, B10, B11, B12, B13, B14, B15, B16, B17;
   var C1, C2, C3, C4, C5, C6, C7, C8, C9, C10, C11, C12, C13, C14, C15, C16;
   var first = true;
   var rownum = 0;
   var ExtAccount = TRecHandler("account");
   ReportData.ReportRun = false;

   if(ReportData.isAccCb)
      cmd = DL_RsdCommand(ЗаписиЦБ(DL_DV_HEDGEOBJTYPE_CB_ACQUIRED, ReportData.AccCbFIID));
      DataSet = cmd.execute();
      if( DataSet.MoveNext() )
         rownum = 0;
         Progress.Init( SQL_GetNRecs(cmd.m_Query), "Отбор объектов хеджирования", "Отбор приобретённых ц/б" );
         NotEofFile = true;	
         while( NotEofFile )
            if( (DataSet.HedgCorr == 0) AND (DataSet.AmortCorr == 0))
               NotEofFile = DataSet.MoveNext();
               Progress.Use();
               continue;
            end;
            cmdHg = DL_RsdCommand(ЗаписиИХвЦБ(DataSet.FIID));
            DataSetHg = cmdHg.execute();
            first = true;
            while( DataSetHg.MoveNext() )
               ClearRecord(ExtAccount);
               if(first) // Только в первой по выпуску строке выводим информацию о самой ц/б
                  first = false;
                  A1 = DataSet.IssuerName; A2 = DataSet.FIName; A3 = DataSet.LSIN; A4 = DataSet.ISIN; A5 = DataSet.Issued; A6 = DataSet.DrawingDate;
                  A7 = DataSet.FaceValue;  A8 = GetFI_CODE(DataSet.FaceValueFI); A9 = DataSet.LotAmount; A10 = DataSet.HedgCorr; 
                  A11 = IIF(DataSet.HedgCurrency == null, " ", GetFI_CODE(DataSet.HedgCurrency)); A12 = DataSet.HedgCorrDate;                     
                  A13 = DataSet.AmortCorr; A14 = IIF(DataSet.AmortCurrency == null, " ", GetFI_CODE(DataSet.AmortCurrency)); A15 = DataSet.AmortCorrDate;                       
               else
                  A1 = A2 = A3 = A4 = A5 = A6 = A7 = A8 = A9 = A10 = A11 = A12 = A13 = A14 = A15 = " ";                   
               end;
               if (ПолучитьВнешнийСчётХеджирования(DataSetHg.DealID, DataSetHg.DealDocKind, ReportData.dateRep, DL_DV_HEDGEOBJTYPE_CB_ACQUIRED, DataSet.FIID, 1, ExtAccount))
                  A21 = ExtAccount.rec.Account;
                  A22 = DL_GetRestAccount(ExtAccount.rec, ReportData.dateRep);
               else
                  A21 = " "; A22 = 0;
               end;
               A16 = DataSetHg.BeginDate; A17 = DataSetHg.EndDate; A18 = DataSetHg.Code; A19 = GetDealType(DataSetHg.ExecType, DataSetHg.BFIID, DataSetHg.BFIID2);
               A20 = DataSetHg.DealDate;
               if(rownum == 0) // Для первой строки на листе выводим заголовок
                  if(ReportData.FirstPage == -1)
                     ReportData.FirstPage = DL_DV_HEDGEOBJTYPE_CB_ACQUIRED;
                     Rep = CMakeReport(TableCb);
                  end;
                  PrintHead0( "Приобретённые ЦБ", ReportData.DateRep, TableCb ); 
               end; 
               PrintLineCb(A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21, A22);
               first = false;
               rownum = rownum + 1;
            end;
            if(not first) // Проверяем были ли записи по отношениям хеджирования 
               ReportData.ReportRun = true;
            end;
            NotEofFile = DataSet.MoveNext();
            Progress.Use();
         end;
         Progress.Remove();
         if(rownum != 0)
            after_44_footer( Rep );
         end;
      end;  
   end;  
   if(ReportData.IsEmissCb) 
      cmd = DL_RsdCommand(ЗаписиЦБ(DL_DV_HEDGEOBJTYPE_CB_EMISSED, ReportData.EmissCbFIID));
      DataSet = cmd.execute();
      if( DataSet.MoveNext() )
         rownum = 0;
         Progress.Init( SQL_GetNRecs(cmd.m_Query), "Отбор объектов хеджирования", "Отбор выпущенных ц/б" );
         NotEofFile = true;	
         while( NotEofFile )
            if( (DataSet.HedgCorr == 0) AND (DataSet.AmortCorr == 0))
               NotEofFile = DataSet.MoveNext();
               Progress.Use();
               continue;
            end;
            cmdHg = DL_RsdCommand(ЗаписиИХвЦБ(DataSet.FIID));
            DataSetHg = cmdHg.execute();
            first = true;
            while( DataSetHg.MoveNext() )
               ClearRecord(ExtAccount);
               if(first) // Только в первой по выпуску строке выводим информацию о самой ц/б
                  first = false;
                  A1 = DataSet.IssuerName; A2 = DataSet.FIName; A3 = DataSet.LSIN; A4 = DataSet.ISIN; A5 = DataSet.Issued; A6 = DataSet.DrawingDate;
                  A7 = DataSet.FaceValue;  A8 = GetFI_CODE(DataSet.FaceValueFI);   A9 = DataSet.LotAmount; A10 = DataSet.HedgCorr; 
                  A11 = IIF(DataSet.HedgCurrency == null, " ", GetFI_CODE(DataSet.HedgCurrency)); A12 = DataSet.HedgCorrDate;                      
                  A13 = DataSet.AmortCorr; A14 = IIF(DataSet.AmortCurrency == null, " ", GetFI_CODE(DataSet.AmortCurrency)); A15 = DataSet.AmortCorrDate;                       
               else
                  A1 = A2 = A3 = A4 = A5 = A6 = A7 = A8 = A9 = A10 = A11 = A12 = A13 = A14 = A15 = " ";                   
               end; 
               if (ПолучитьВнешнийСчётХеджирования(DataSetHg.DealID, DataSetHg.DealDocKind, ReportData.dateRep, DL_DV_HEDGEOBJTYPE_CB_EMISSED, DataSet.FIID, 1, ExtAccount))
                  A21 = ExtAccount.rec.Account;
                  A22 = DL_GetRestAccount(ExtAccount.rec, ReportData.dateRep);
               else
                  A21 = " "; A22 = 0;
               end;
               A16 = DataSetHg.BeginDate; A17 = DataSetHg.EndDate; A18 = DataSetHg.Code; A19 = GetDealType(DataSetHg.ExecType, DataSetHg.BFIID, DataSetHg.BFIID2);
               A20 = DataSetHg.DealDate;
               if(rownum == 0) // Для первой строки на листе выводим заголовок
                  if(ReportData.FirstPage == -1)
                     ReportData.FirstPage = DL_DV_HEDGEOBJTYPE_CB_EMISSED;
                     Rep = CMakeReport(TableCb);
                  end;
                  PrintHead0( "Выпущенные ЦБ", ReportData.DateRep, TableCb ); 
               end;
               PrintLineCb(A1, A2, A3, A4, A5, A6, A7, A8, A9, A10, A11, A12, A13, A14, A15, A16, A17, A18, A19, A20, A21, A22);
               rownum = rownum + 1;
            end;
            if(not first) // Проверяем были ли записи по отношениям хеджирования 
               ReportData.ReportRun = true;
            end;
            NotEofFile = DataSet.MoveNext();
            Progress.Use();
         end;
         Progress.Remove();
         if(rownum != 0)
            after_44_footer( Rep );
         end;
      end;     
   end;     
   if(ReportData.IsAccBn)
      cmd = DL_RsdCommand(ЗаписиВексель(DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED, ReportData.AccBnFIID));
      DataSet = cmd.execute();
      if( DataSet.MoveNext() )
         rownum = 0;
         Progress.Init( SQL_GetNRecs(cmd.m_Query), "Отбор объектов хеджирования", "Отбор приобретённых векселей" );
         NotEofFile = true;	
         while( NotEofFile )
            cmdHg = DL_RsdCommand(ЗаписиИХВексель(DataSet.BCID));
            DataSetHg = cmdHg.execute();
            first = true;
            while( DataSetHg.MoveNext() )
               ClearRecord(ExtAccount);
               if(first) // Только в первой по выпуску строке выводим информацию о самой ц/б
                  B1 = DataSet.IssuerName; B2 = DataSet.BCSeries; B3 = DataSet.BCNumber; B4 = DataSet.Issued; B5 = DataSet.FaceValue; B6 = GetFI_CODE(DataSet.FaceValueFI);
                  B7 = DataSet.ChangeDate;                    
               else
                  B1 = B2 = B3 = B4 = B5 = B6 = B7 = " ";                   
               end;
               if (ПолучитьВнешнийСчётХеджирования(DataSetHg.DealID, DataSetHg.DealDocKind, ReportData.dateRep, DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED, DataSet.BCID, 1, ExtAccount))
                  B8 = B17 = DL_GetRestAccount(ExtAccount.rec, ReportData.dateRep);
                  B9 = GetFI_CODE(ExtAccount.rec.CODE_CURRENCY);
                  B10 = ПолучитьДатуПоследнейПроводки(ExtAccount.rec.Account);
                  B16 = ExtAccount.rec.Account;
               else
                  B8 = 0; B9 = " "; B10 =  date(0,0,0); B16 = " "; B17 = 0; 
               end;
               B11 = DataSetHg.BeginDate; B12 = DataSetHg.EndDate; B13 = DataSetHg.Code; B14 = GetDealType(DataSetHg.ExecType, DataSetHg.BFIID, DataSetHg.BFIID2);
               B15 = DataSetHg.DealDate; 
               if(B17 != 0) // Отбираются только записи с ненулевыми остатками на счетах
                  if(rownum == 0) // Для первой строки на листе выводим заголовок
                     if(ReportData.FirstPage == -1)
                        ReportData.FirstPage = DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED;
                        Rep = CMakeReport(TableBn);
                     end;
                     PrintHead0( "Приобретённые векселя", ReportData.DateRep, TableBn );
                  end;
               PrintLineBn(B1, B2, B3, B4, B5, B6, B7, B8, B9, B10, B11, B12, B13, B14, B15, B16, B17);
                  first = false;
                  rownum = rownum + 1;
               else
                  continue;
            end;
            end;
            if(not first) // Проверяем были ли записи с ненулевыми счетами
               ReportData.ReportRun = true;
            end;
            NotEofFile = DataSet.MoveNext();
            Progress.Use();
         end;
         Progress.Remove();
         if(rownum != 0)
         after_44_footer( Rep );
      end;
   end; 
   end; 
   if(ReportData.IsEmissBn)
      cmd = DL_RsdCommand(ЗаписиВексель(DL_DV_HEDGEOBJTYPE_BN_EMISSED, ReportData.EmissBnFIID));
      DataSet = cmd.execute();
      if( DataSet.MoveNext() )
         rownum = 0;
         Progress.Init( SQL_GetNRecs(cmd.m_Query), "Отбор объектов хеджирования", "Отбор выпущенных векселей" );
         NotEofFile = true;	
         while( NotEofFile )
            cmdHg = DL_RsdCommand(ЗаписиИХВексель(DataSet.BCID));
            DataSetHg = cmdHg.execute();
            first = true;
            while( DataSetHg.MoveNext() )
               ClearRecord(ExtAccount);
               if(first) // Только в первой по выпуску строке выводим информацию о самой ц/б
                  B1 = DataSet.IssuerName; B2 = DataSet.BCSeries; B3 = DataSet.BCNumber; B4 = DataSet.Issued; B5 = DataSet.FaceValue; B6 = GetFI_CODE(DataSet.FaceValueFI);
                  B7 = DataSet.ChangeDate;                    
               else
                  B1 = B2 = B3 = B4 = B5 = B6 = B7 = " ";                   
               end;
               if (ПолучитьВнешнийСчётХеджирования(DataSetHg.DealID, DataSetHg.DealDocKind, ReportData.dateRep, DL_DV_HEDGEOBJTYPE_BN_EMISSED, DataSet.BCID, 1, ExtAccount))
                  B8 = B17 = DL_GetRestAccount(ExtAccount.rec, ReportData.dateRep);
                  B9 = GetFI_CODE(ExtAccount.rec.CODE_CURRENCY);
                  B10 = ПолучитьДатуПоследнейПроводки(ExtAccount.rec.Account);
                  B16 = ExtAccount.rec.Account;
               else
                  B8 = 0; B9 = " "; B10 =  date(0,0,0); B16 = " "; B17 = 0; 
               end;
               B11 = DataSetHg.BeginDate; B12 = DataSetHg.EndDate; B13 = DataSetHg.Code; B14 = GetDealType(DataSetHg.ExecType, DataSetHg.BFIID, DataSetHg.BFIID2);
               B15 = DataSetHg.DealDate; 
               if(B17 != 0)// Отбираются только записи с ненулевыми остатками на счетах
                  if(rownum == 0) // Для первой строки на листе выводим заголовок
                     if(ReportData.FirstPage == -1)
                        ReportData.FirstPage = DL_DV_HEDGEOBJTYPE_BN_EMISSED;
                        Rep = CMakeReport(TableBn);
                     end;
                     PrintHead0( "Выпущенные векселя", ReportData.DateRep, TableBn );
                  end;
               PrintLineBn(B1, B2, B3, B4, B5, B6, B7, B8, B9, B10, B11, B12, B13, B14, B15, B16, B17);
                  first = false;
                  rownum = rownum + 1;
               else
                  continue;
               end;   
            end;
            if(not first) // Проверяем были ли записи с ненулевыми счетами
               ReportData.ReportRun = true;
            end;
            NotEofFile = DataSet.MoveNext();
            Progress.Use();
         end;
         Progress.Remove();
         if(rownum != 0)
            after_44_footer( Rep );
         end;
      end;
   end;
   rownum = 0;
   if(ReportData.IsDealMBCRaise)
      cmd = DL_RsdCommand(ЗаписиМБК(DL_DV_HEDGEOBJTYPE_MBK_RAISING, ReportData.DealMBCRaiseFIID));
      DataSet = cmd.execute();
      if( DataSet.MoveNext() )
         Progress.Init( SQL_GetNRecs(cmd.m_Query), "Отбор объектов хеджирования", "Отбор сделок МБК" );
         NotEofFile = true;	
         while( NotEofFile )
            cmdHg = DL_RsdCommand(ЗаписиИХвМБК(DataSet.DealID));
            DataSetHg = cmdHg.execute();
            first = true;
            while( DataSetHg.MoveNext() )
               ClearRecord(ExtAccount);
               if(first) // Только в первой по сделке строке выводим общую информацию о ней
                  //first = false;
                  C1 = DataSet.DealCode; C2 = "Привлечение МБК"; C3 = DataSet.DealSum; 
                  C4 = GetFI_CODE(DataSet.DealSumFI); C5 = DataSet.MBCDealDate; C6 =DataSet.MBCExecDate;                   
               else
                  C1 = C2 = C3 = C4 = C5 = C6 = " ";                   
               end;
               if (ПолучитьВнешнийСчётХеджирования(DataSetHg.DvNDealID, 199, ReportData.dateRep, DataSet.ObjType, DataSet.DealID, 1, ExtAccount))
                  C7 = C16 = DL_GetRestAccount(ExtAccount.rec, ReportData.dateRep);
                  C8 = GetFI_CODE(ExtAccount.rec.CODE_CURRENCY);
                  C9 = ПолучитьДатуПоследнейПроводки(ExtAccount.rec.Account);
                  C15 = ExtAccount.rec.Account;
               else
                  C7 = 0; C8 = " "; C9 =  date(0,0,0); C15 = " "; C16 = 0; 
               end;
               C10 = DataSetHg.BeginDate; C11 = DataSetHg.EndDate; C12 = DataSetHg.Code; C13 = GetDealType(DataSetHg.ExecType, DataSetHg.BFIID, DataSetHg.BFIID2);
               C14 = DataSetHg.DealDate;
               if(C16 != 0)// Отбираются только записи с ненулевыми остатками на счетах
                  if(rownum == 0) // Для первой строки на листе выводим заголовок
                     if(ReportData.FirstPage == -1)
                        ReportData.FirstPage = DL_DV_HEDGEOBJTYPE_MBK_RAISING;
                        Rep = CMakeReport(TableMBC);
                     end;
                     PrintHead0( "Сделки МБК", ReportData.DateRep, TableMBC );
                  end;
                  PrintLineMBC(C1, C2, C3, C4, C5, C6, C7, C8, C9, C10, C11, C12, C13, C14, C15, C16);
                  first = false;
                  rownum = rownum + 1;
               else
                  continue;
               end;
            end;
            if(not first) // Проверяем были ли записи с ненулевыми счетами
               ReportData.ReportRun = true;
            end;
            NotEofFile = DataSet.MoveNext();
            Progress.Use();
         end;
         Progress.Remove();
         /*if(rownum != 0)
            after_44_footer( Rep );
         end;*/
      end; 
   end;
   if(ReportData.IsDealMBCPlace)
      cmd = DL_RsdCommand(ЗаписиМБК(DL_DV_HEDGEOBJTYPE_MBK_PLACEMENT, ReportData.DealMBCPlaceFIID));
      DataSet = cmd.execute();
      if( DataSet.MoveNext() )
         //rownum = 0;
         Progress.Init( SQL_GetNRecs(cmd.m_Query), "Отбор объектов хеджирования", "Отбор сделок МБК" );
         NotEofFile = true;	
         while( NotEofFile )
            cmdHg = DL_RsdCommand(ЗаписиИХвМБК(DataSet.DealID));
            DataSetHg = cmdHg.execute();
            first = true;
            while( DataSetHg.MoveNext() )
               ClearRecord(ExtAccount);
               if(first) // Только в первой по сделке строке выводим общую информацию о ней
                  C1 = DataSet.DealCode; C2 = "Размещение МБК"; C3 = DataSet.DealSum; 
                  C4 = GetFI_CODE(DataSet.DealSumFI); C5 = DataSet.MBCDealDate; C6 =DataSet.MBCExecDate;                   
               else
                  C1 = C2 = C3 = C4 = C5 = C6 = " ";                   
               end;
               if (ПолучитьВнешнийСчётХеджирования(DataSetHg.DvNDealID, 199, ReportData.dateRep, DataSet.ObjType, DataSet.DealID, 1, ExtAccount))
                  C7 = C16 = DL_GetRestAccount(ExtAccount.rec, ReportData.dateRep);
                  C8 = GetFI_CODE(ExtAccount.rec.CODE_CURRENCY);
                  C9 = ПолучитьДатуПоследнейПроводки(ExtAccount.rec.Account);
                  C15 = ExtAccount.rec.Account;
               else
                  C7 = 0; C8 = " "; C9 =  date(0,0,0); C15 = " "; C16 = 0; 
               end;
               C10 = DataSetHg.BeginDate; C11 = DataSetHg.EndDate; C12 = DataSetHg.Code; C13 = GetDealType(DataSetHg.ExecType, DataSetHg.BFIID, DataSetHg.BFIID2);
               C14 = DataSetHg.DealDate;
               if(C16 != 0)// Отбираются только записи с ненулевыми остатками на счетах
                  if(rownum == 0) // Для первой строки на листе выводим заголовок
                     if(ReportData.FirstPage == -1)
                        ReportData.FirstPage = DL_DV_HEDGEOBJTYPE_MBK_RAISING;
                        Rep = CMakeReport(TableMBC);
                     end;
                     PrintHead0( "Сделки МБК", ReportData.DateRep, TableMBC );
                  end;
                  PrintLineMBC(C1, C2, C3, C4, C5, C6, C7, C8, C9, C10, C11, C12, C13, C14, C15, C16);
                  first = false;
                  rownum = rownum + 1;
               else
                  continue;
               end;
            end;
            if(not first) // Проверяем были ли записи с ненулевыми счетами
               ReportData.ReportRun = true;
            end;
            NotEofFile = DataSet.MoveNext();
            Progress.Use();
         end;
         Progress.Remove();
         /*if(rownum != 0)
            after_44_footer( Rep );
         end;*/
         end; 
      end;
   if( (rownum != 0) AND ( (ReportData.IsDealMBCRaise) OR (ReportData.IsDealMBCPlace) ) )
      after_44_footer( Rep );
   end;
END;

macro ReportRun( _DateRep:date,
                 _isAccCb:bool,
                 _AccCbFIID:integer,
                 _IsEmissCb:bool,
                 _EmissCbFIID:integer,
                 _IsAccBn:bool,
                 _AccBnFIID:integer,
                 _IsEmissBn:bool,
                 _EmissBnFIID:integer,
                 _IsDealMBCRaise:bool,
                 _DealMBCRaiseFIID:integer,
                 _IsDealMBCPlace:bool,
                 _DealMBCPlaceFIID:integer,
                 _IsApp:bool,
                 _IsExcel:bool )

   Dl_CallInsertStat( IIF( _IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   ReportData = SourceData( _DateRep, _isAccCb, _AccCbFIID, _IsEmissCb, _EmissCbFIID, _IsAccBn, _AccBnFIID, _IsEmissBn, _EmissBnFIID, _IsDealMBCRaise, _DealMBCRaiseFIID, _IsDealMBCPlace, _DealMBCPlaceFIID,  _IsApp, _IsExcel);

   СозданиеОтчёта();   

   if( ReportData.ReportRun == false )                                                                  
      MsgBox("\nНет данных, удовлетворяющих параметрам отчета.");
   else
     if( ReportData.FirstSheet != NULL )
        if(ErrorStr > 0)
           PrintLog();
        end;
        if( _IsExcel )
           Rep.PrintWinRep(ReportData.FirstSheet);
           Rep.ShowWinRep();
        else
           Rep.PrintRep();
        end;
     end;
   end;
end;
