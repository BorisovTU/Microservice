/*
$Name:        dvfc_rep.mac
$Module:      è‡Æ®ß¢Æ§≠Î• ®≠·‚‡„¨•≠‚Î
$Description: é‚Á•‚ ØÆ ÆØ•‡†Ê®® "îÆ‡¨®‡Æ¢†≠®• ™Æ¨®··®© èáé" 
*/
import BankInter, RsbDataSet, "cb_sql.mac", "dvserv.mac", "dvrepfun2.mac";

PRIVATE VAR dvoper = TrecHandler( "dvoper" );

PRIVATE MACRO FindDVOPER( OperID:INTEGER ):BOOL
  var   Data = TRsbDataSet( "SELECT * FROM ddvoper_dbt WHERE t_ID = " + string(OperID) );

  if( Data.MoveNext() )
     Data.GetRecord().CopyTo( dvoper.rec );
     return true;
  end;
  return false;
END;

PRIVATE VAR InvestorSumma = TArray();
PRIVATE CLASS CInvSum( _PaySum, _TaxSum, _FIID )
  VAR PaySum = _PaySum, TaxSum = _TaxSum, FIID = _FIID;
END;

PRIVATE MACRO StoreInvestorSumm( PaySum:MONEY, TaxSum:MONEY, FIID:INTEGER )
  VAR i = 0;

  while( i < InvestorSumma.size)
     if( InvestorSumma[i].FIID == FIID )
        InvestorSumma[i].PaySum = InvestorSumma[i].PaySum + PaySum;
        InvestorSumma[i].TaxSum = InvestorSumma[i].TaxSum + TaxSum;
        return;
     end;

     i = i + 1;
  end;

  InvestorSumma[InvestorSumma.Size] = CInvSum( PaySum, TaxSum, FIID );
END;

PRIVATE MACRO PrintInvestor( DS )
[≥ à≠¢•·‚Æ‡ ##################################  §Æ£Æ¢Æ‡ ¸  ################                            ≥
 √ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
]( èà_èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†( DS.Investor ), DS.OrderNum );

  InvestorSumma.Size = 0;
END;

PRIVATE MACRO PrintInvestorFooter( DS, IsLast:BOOL )
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];

  VAR i = 0;
  while( i < InvestorSumma.size)

[≥ à‚Æ£Æ ØÆ ®≠¢•·‚Æ‡„ ß† §•≠Ï                           ≥################# ###≥########################≥
](InvestorSumma[i].PaySum, 
  GetCCY(InvestorSumma[i].FIID), 
  InvestorSumma[i].TaxSum
);
     i = i + 1;
  end;

 if( IsLast )
[¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
];
 else
[√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
];
 end;

END;

PRIVATE MACRO PrintCommission( DS );
[≥#################≥####################################≥################# ###≥########################≥
]( DS.ComCode, 
   èà_èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†( DS.ComReceiverID ):w,
   DS.PaySum, 
   GetCCY(DS.AccFIID), 
   DS.TaxSum
);

   StoreInvestorSumm( DS.PaySum, DS.TaxSum, DS.AccFIID )
END;

PRIVATE MACRO Report():BOOL

  VAR DS, cmd, NumRec, LastInv = -1, LastOrder = -1;

[                        èêéíéäéã éèÖêÄñàà îéêåàêéÇÄçàü äéåàëëàâ èáé
  Ñ†‚† ÆØ•‡†Ê®®: ##########  ™Æ§: #
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥   äÆ§ ™Æ¨®··®®  ≥          èÆ´„Á†‚•´Ï ™Æ¨®··®®       ≥         ë„¨¨†       ≥       Ç ‚.Á. çÑë       ≥
√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¡ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
]( dvoper.rec.Date, dvoper.rec.Code );

  InitProgress( -1, "èÆ§£Æ‚Æ¢™† Æ‚Á•‚† ...", "é‚Á•‚ ØÆ ÆØ•‡†Ê®® ‰Æ‡¨®‡Æ¢†≠®Ô ™Æ¨®··®© èáé" );

  cmd = RSDCommand( " select contr.t_partyID Investor, contr.t_ID OrderID, contr.t_Number OrderNum, commiss.t_Code ComCode, commiss.t_receiverid ComReceiverID, oper.t_PaySum PaySum, oper.t_TaxSum TaxSum, oper.t_AccFIID AccFIID, " +
                    "        commiss.t_number comNumber, commiss.t_feetype FeeType " + 
                    "   from ddvnacdl_dbt oper, dsfcontr_dbt contr, dsfcomiss_dbt commiss, dsfconcom_dbt concom " +
                    "  where oper.t_servoperid = ? " +
                    "    and commiss.t_feetype = concom.t_feetype " +
                    "    and commiss.t_number  = concom.t_commnumber " +
                    "    and contr.t_id        = concom.t_objectid " +
                    "    and concom.t_id       = oper.t_comid " +

                    " UNION ALL " +

                    " select contr.t_partyID Investor, contr.t_ID OrderID, contr.t_Number OrderNum, commiss.t_Code ComCode, commiss.t_receiverid ComReceiverID, dlcom.t_Sum PaySum, dlcom.t_NDS TaxSum, commiss.T_FIID_COMM AccFIID, " +
                    "        dlcom.t_comnumber comNumber, commiss.t_feetype FeeType " +
                    "   from ddlcomis_dbt dlcom, dsfcontr_dbt contr, dsfcomiss_dbt commiss " +
                    "  where dlcom.t_servoperid = ? "+
                    "    and commiss.t_feetype  = dlcom.t_feetype " +
                    "    and commiss.t_number   = dlcom.t_comnumber " +
                    "    and contr.t_id         = dlcom.T_Contract " +

                    " UNION ALL " +

                    " select contr.t_partyID Investor, contr.t_ID OrderID, contr.t_Number OrderNum, commiss.t_Code ComCode, commiss.t_receiverid ComReceiverID, dvdlcom.t_Sum PaySum, dvdlcom.t_NDS TaxSum, commiss.T_FIID_COMM AccFIID, " +
                    "        commiss.t_number comNumber, commiss.t_feetype FeeType " +
                    "   from ddvdlcom_dbt dvdlcom, dsfcontr_dbt contr, dsfcomiss_dbt commiss, ddvdeal_dbt deal " +
                    "  where dvdlcom.t_servoperid = ? " +
                    "    and deal.t_ID = dvdlcom.t_DealID " +
                    "    and commiss.t_ComissID   = dvdlcom.t_ComissID " +
                    "    and contr.t_id           = (case when commiss.t_ReceiverID = ? then deal.t_ClientContr " +
                    "                                     when deal.t_BrokerContr > 0 then deal.t_BrokerContr " +
                    "                                     else NVL((select sfcontr.t_ID " +
                    "                                                 from dsfcontr_dbt sfcontr " +
                    "                                                where rownum = 1 " +
                    "                                                  and sfcontr.t_servkind = ? " +
                    "                                                  and sfcontr.t_partyID = ? " +
                    "                                                  and sfcontr.t_ContractorID = (SELECT fin.t_ISSUER FROM dfininstr_dbt fin WHERE fin.t_FIID = deal.t_FIID) " +
                    "                                                  and sfcontr.t_DateBegin <= deal.t_date " +
                    "                                                  and (sfcontr.t_DateClose >= deal.t_date or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY'))), -1) end) " +

                    " order by Investor, FeeType, comNumber "
                    
                  );

  cmd.addParam( "", RSDBP_IN, dvoper.rec.ID );
  cmd.addParam( "", RSDBP_IN, dvoper.rec.ID );
  cmd.addParam( "", RSDBP_IN, dvoper.rec.ID );
  cmd.addParam( "", RSDBP_IN, {OurBank} );
  cmd.addParam( "", RSDBP_IN, PTSK_DV );
  cmd.addParam( "", RSDBP_IN, {OurBank} );
  cmd.execute();
  DS = TRsbDataSet( cmd );
  NumRec = 0;
  while( DS.MoveNext() )

     if( (LastInv != DS.Investor) OR ( LastOrder != DS.OrderID) )
        if( (LastInv > 0) AND (LastInv != DS.Investor) )
           PrintInvestorFooter( DS, false )
        end;
        PrintInvestor( DS );
     end;

     PrintCommission( DS );

     LastInv   = DS.Investor;
     LastOrder = DS.OrderID;
     UseProgress( NumRec = NumRec + 1 );
  end;

  if( LastInv > 0 )
     PrintInvestorFooter( DS, true )
  end;

  RemProgress();

  return true;
END;

MACRO PrintReport( OperID:INTEGER )
  VAR ReportFileName, errtext, errcode;
  FILE ReportOutFile() txt write; /*‰†©´ ¢Î¢Æ§† §´Ô Æ‚Á•‚†*/

  if( not FindDVOPER( OperID ) )
     MsgBox( "ç• ≠†©§•≠† ·•‡¢®·≠†Ô ÆØ•‡†Ê®Ô ‰Æ‡¨®‡Æ¢†≠®Ô ™Æ¨®··®© (ID="+string(OperID)+")" );
     return false;
  end;

  ReportFileName = GetTxtFileName( "dvfc_" + dvoper.rec.Code );
  if( not Open( ReportOutFile, ReportFileName ) )
     errcode = status(errtext);
     RunError( "éË®°™† Ø‡® ·Æß§†≠®® ‰†©´†|"+ReportFileName+"|(" + errcode + ") " + errtext );
  end;
  SetOutput( ReportFileName );

  Report();

  SetOutput( NULL, true );
  close( ReportOutFile );
  ViewFile( ReportOutFile );
  return true;
END;
