/*
$Name:        dvnop075.mac
$Module:      Производные инструменты
$Description: Внебиржевая операция. Шаг: Ожидание неттинга вариационной маржи
*/
import InsCarryDoc, "dv_car.mac", "cb_sql.mac";

var CalcgGp;
CalcgGp = getGlobalParameter("CalcSt", false);

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var Payment:RsbPayment;
  var PaymentID:integer = 0;
  var ДатаИсполненияШага:date;

  SetBuff(ndeal, FDoc);
  var FD = DVFirstDocNDeal(DocKind, ndeal);

  if (FD.ОтказОтИсполнения())
     return 0;
  end;

  if( GetOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_VM()) == DV_OPERSTATUS_PAYM_EX )
     GetOprDate( DV_NDEAL_OPRDATE_VM, ДатаИсполненияШага );

     if( (DV_FindPaymentID(DocKind, ndeal.ID, PM_PURP_MARGA, 0, ДатаИсполненияШага, @PaymentID) == true) and (PaymentID > 0) )
        Payment = RsbPayment(PaymentID);
   
        if (Payment.PaymStatus == PM_OVERDUE)
          var stat = true;
          var findAccount = "";
          stat = FD.FindNumberAccount( "Треб. с н.с.",  FindAccount );
         Payment.FutureReceiverAccount = FindAccount;
        end;

        if( ПИ_ИсполнениеПлатежаНаШагеОжидания(FD, Payment) != 0 )
           return 1;
        end;

        if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_VM(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Квитовка/Неттинг платежа по вариационной марже> для операции.");
           return 1;
        end;

        // если по операции все уже было выполнено и оставалось выполнить только квитовку/неттинг маржи, то закрываем операцию
        if( (not FD.IsSWAP()) and
            (GetOprStatus(FD.DV_OPERSTATUS_LIABILITY()) == DV_OPERSTATUS_DL_COMPLETE) and
            (GetOprStatus(FD.DV_OPERSTATUS_DEMAND()) == DV_OPERSTATUS_DL_COMPLETE)
          )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_DOC(), DV_OPERSTATUS_DOC_CLOSE) )
              MsgBox("Ошибка при установке статуса <Документооборот> по операции.");
              return 1;
           end;
        end;
     else
        MsgBox("Не найден платеж по вариационной марже.");
        return 1;
     end;
  end;

  return 0;
end;
