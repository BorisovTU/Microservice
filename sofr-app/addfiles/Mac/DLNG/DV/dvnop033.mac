/*
$Name:        dvnop033.mac
$Module:      Производные инструменты
$Description: Внебиржевая операция. Шаг: Ожидание неттинга премии
*/
import InsCarryDoc, "dv_car.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var Pm = Trechandler( "pmpaym.dbt" ), Payment:RsbPayment;

  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);
  if (ВстроенныйПФИ(FD))
     return 0;
  end;
  if (FD.ОтказОтИсполнения())
     return 0;
  end;

  if( FindPayment( null, PRi, 0, DocKind, ndeal.ID, true, Pm ) != 0 )
     MsgBox("Не найден платеж по премии.");
     return 1;
  end;

  Payment = RsbPayment(Pm.rec.PaymentID);
  if( ПИ_ИсполнениеПлатежаНаШагеОжидания(FD, Payment) != 0 )
     return 1;
  end;

  if( not InsertOprStatus(DV_OPERSTATUS_KIND_NETTING_PAYM_PR, DV_OPERSTATUS_PAYM_NOTEX) )
     MsgBox("Ошибка при установке статуса <Квитовка/неттинг платежа по премии> для операции.");
     return 1;
  end;

  return 0;
end;
