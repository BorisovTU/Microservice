/*
$Name:        dvndeals.mac
$Module:      Производные инструменты
$Description: Макрос скроллинга внебиржевых операций
*/
import FIInter, DVInter, TSInter, RsbDataSet, BankInter, "dldlngfun.mac",funk,oralib,likepy,dv_lib;
import dvswift, dvswiftMT300, dvswiftMT399;
import "UpdateStatusDeal.mac";  // Интеграция: сервис выгрузки статуса сделки
import "sp_imp.mac";

PRIVATE VAR Документ       = TRecHandler("dvndeal");
PRIVATE VAR СтарыйДокумент = TRecHandler("dvndeal"); /* заполняется при редактировании */

PRIVATE VAR DVNFI       = TRecHandler("dvnfi");
PRIVATE VAR OldDVNFI    = TRecHandler("dvnfi"); /* заполняется при редактировании */

//доступны только в валютном и процентном свопах
PRIVATE VAR DVNFI_2    = TRecHandler("dvnfi");
PRIVATE VAR OldDVNFI_2 = TRecHandler("dvnfi"); /* заполняется при редактировании */

PRIVATE VAR ClntRep = TRecHandler("spground");

PRIVATE CLASS GenAgrRep()
	var NumDeal = "",
			Result  = "",
			Comment = "";
END;

Private Macro UpdDeal(ID)
    var query = "update ddl_tick_dbt  " +
                "   set t_isPFI = 'X' " +
                " where t_dealid = ? ";
    var cmd = RsdCommand(query);
    cmd.addParam("", RSDBP_IN, ID);
    cmd.execute;

End;

private macro IsNeedInsertIRGraths(DealID)
/*DAN проверка на необходимость вставки по сделке графиков РУ возвращает True если для ГС по сделке установлен признак репортинга, 
   но в то же время отсутствуют сформированные репозитарные параметры в ddl_repozdeal_dbt */  
   
  var sql, cmd, rs;
  sql = "select dvn.t_dockind, dvn.t_kind, dvn.t_id " +
        "  from ddvndeal_dbt dvn, ddl_genagr_dbt ga " +
        " where t_id = ? " +
        "   and ga.t_genagrid = dvn.t_genagrid " +
        "   and ga.t_reporting = chr(88) " +
        "   and not exists (select 1 " +
        "                     from ddl_repozdeal_dbt rdl " +
        "                   where rdl.t_dockind = dvn.t_dockind " +
        "                     and rdl.t_docid = dvn.t_id) " ;
  cmd = RSDCommand(sql);
  cmd.AddParam("",rsdbp_in,DealID);
  rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  if (rs.movenext) 
   return True;
  end;
  return False;
end;

Private Macro InsertFrVal(ID_from, ID_to)
var query, query1, cmd, cmd1 ;
    query = " select * from ddvnfrval_dbt  " +
                "   where t_dockind = 199 and t_dealid =  ? order by t_date asc ";
    cmd = DL_RSDCommand(query);
    cmd.AddParam(ID_from);
    var DataSet = cmd.Execute();
    While( DataSet.MoveNext() )
       query1 = "insert into ddvnfrval_dbt values(0, ?, ?, ?, 0, chr(0), chr(0), 0, chr(0), 0, chr(0), 0, chr(0), 0, 101, 'X', 0, 0, 0)";
       cmd1 = RsdCommand(query1);
       cmd1.addParam("", RSDBP_IN, ID_to);
       cmd1.addParam("", RSDBP_IN, DataSet.date);
       cmd1.addParam("", RSDBP_IN, DataSet.fairvalue);
       cmd1.execute;
    end;

End;

Private Macro UpdInsAccounts(ID_from, ID_to, FIID)
var query, cmd;
    query = "update dmcaccdoc_dbt set t_account =  " +
                " (select t_account from dmcaccdoc_dbt where t_dockind = 199 and t_docid = ? and t_catnum =  1224) " +
                " where t_dockind = 101 and t_docid = ? and t_catnum = 303 ";
    cmd = RsdCommand(query);
    cmd.addParam("", RSDBP_IN, ID_from);
    cmd.addParam("", RSDBP_IN, ID_to);
    cmd.execute;

    query = " update dmcaccdoc_dbt set t_account =  " +
                " (select t_account from dmcaccdoc_dbt where t_dockind = 199 and t_docid = ? and t_catnum =  1225) " +
                " where t_dockind = 101 and t_docid = ? and t_catnum = 304 ";
    cmd = RsdCommand(query);
    cmd.addParam("", RSDBP_IN, ID_from);
    cmd.addParam("", RSDBP_IN, ID_to);
    cmd.execute;

    query = " Insert into DMCACCDOC_DBT "+
            " (T_ID, T_ISCOMMON, T_DOCKIND, T_DOCID, T_CATID, T_CATNUM, T_CHAPTER, T_ACCOUNT, T_CURRENCY, T_TEMPLNUM, T_GROUPNUM, T_PERIODID, T_ACTIVATEDATE, T_DISABLINGDATE, T_ISUSABLE, T_FIID, T_OWNER, T_PLACE, T_ISSUER, T_KIND_ACCOUNT, T_CENTR, T_CENTROFFICE, T_ACTIONDATE, T_FIID2, T_CLIENTCONTRID, T_BANKCONTRID, T_MARKETPLACEID, T_MARKETPLACEOFFICEID, T_FIROLE, T_INDEXDATE, T_DEPARTMENTID, T_CONTRACTOR, T_BRANCH, T_CORRDEPARTMENTID, T_CURRENCYEQ, T_CURRENCYEQ_RATETYPE, T_CURRENCYEQ_RATEDATE, T_CURRENCYEQ_RATEEXTRA, T_MCBRANCH)" + 
            "  Values" + 
            "    (0, chr(0), 101, ?, 453, " + 
            "     1217, 1, (select t_account from dmcaccdoc_dbt where t_dockind = 199 and t_docid = ? and t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') and t_catnum =  1217), 0, 1, " + 
            "     0, 0, TO_DATE('11/26/2018 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), 'X', " + 
            "     ?, -1, -1, -1, 'А', " + 
            "     -1, -1, TO_DATE('11/26/2018 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), -1, -1, " + 
            "     -1, -1, -1, 3, -1, " + 
            "     1, -1, 1, 0, -1, " + 
            "     0, 0, 0, 1) "; /*+ПФИ*/
    cmd = RsdCommand(query);
    cmd.addParam("", RSDBP_IN, ID_to);
    cmd.addParam("", RSDBP_IN, ID_from);
    cmd.addParam("", RSDBP_IN, FIID);

    cmd.execute;


    query = " Insert into DMCACCDOC_DBT " + 
            " (T_ID, T_ISCOMMON, T_DOCKIND, T_DOCID, T_CATID, T_CATNUM, T_CHAPTER, T_ACCOUNT, T_CURRENCY, T_TEMPLNUM, T_GROUPNUM, T_PERIODID, T_ACTIVATEDATE, T_DISABLINGDATE, T_ISUSABLE, T_FIID, T_OWNER, T_PLACE, T_ISSUER, T_KIND_ACCOUNT, T_CENTR, T_CENTROFFICE, T_ACTIONDATE, T_FIID2, T_CLIENTCONTRID, T_BANKCONTRID, T_MARKETPLACEID, T_MARKETPLACEOFFICEID, T_FIROLE, T_INDEXDATE, T_DEPARTMENTID, T_CONTRACTOR, T_BRANCH, T_CORRDEPARTMENTID, T_CURRENCYEQ, T_CURRENCYEQ_RATETYPE, T_CURRENCYEQ_RATEDATE, T_CURRENCYEQ_RATEEXTRA, T_MCBRANCH) " + 
            " Values " + 
            " (0, chr(0), 101, ?, 454,  " + 
            " 1218, 1, (select t_account from dmcaccdoc_dbt where t_dockind = 199 and t_docid =? and t_disablingdate = to_date('01.01.0001','dd.mm.yyyy') and t_catnum =  1218 ), 0, 1,  " + 
            " 0, 0, TO_DATE('11/26/2018 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), TO_DATE('01/01/0001 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), 'X',  " + 
            " ?, -1, -1, -1, 'П',  " + 
            " -1, -1, TO_DATE('11/26/2018 00:00:00', 'MM/DD/YYYY HH24:MI:SS'), -1, -1,  " + 
            " -1, -1, -1, 3, -1,  " + 
            " 1, -1, 1, 0, -1,  " + 
            " 0, 0, 0, 1) "; /*-ПФИ*/

    cmd = RsdCommand(query);
    cmd.addParam("", RSDBP_IN, ID_to);
    cmd.addParam("", RSDBP_IN, ID_from);
    cmd.addParam("", RSDBP_IN, FIID);

    cmd.execute;



End;


/******/
PRIVATE CLASS (TArray) DV_PmGrAccSumCollector

  PRIVATE CLASS PmGrAccSum( _Account:TRecHandler, _Sum:money, _Side:integer, _OldSum:money )
     var Account = TRecHandler("account");
     var Sum     = _Sum;
     var Side    = _Side;
     var OldSum = _OldSum;

     copy(Account, _Account);
  END;

  MACRO ClearArray()
     this.Size = 0;
  END;

  MACRO ExistAccount( CheckAccount ):bool /*используется в отчёте*/
     var Ex:bool = false;
     var i:integer = 0;

     while( i < this.Size )
        if( this.(i).Account.rec.Account == CheckAccount )
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     return Ex;
  END;

  PRIVATE MACRO _AddData( Account:TRecHandler, Sum:money, Side:integer, _OldSum:money )
     var Ex:bool = false;
     var i:integer = 0;
     var OldSum:money = $0.0;

     if( _OldSum != NULL )
        OldSum = _OldSum;
     end;

     while( i < this.Size )
        if( (this.(i).Account.rec.Account == Account.rec.Account) and (this.(i).Side == Side) )
           this.(i).Sum = this.(i).Sum + Sum;
           this.(i).OldSum = this.(i).OldSum + OldSum;
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     if( Ex == false )
        this.(this.size) = PmGrAccSum(Account, Sum, Side, OldSum);
     end;
  END;

  MACRO AddData( DemandAccount:TRecHandler, LiabilityAccount:TRecHandler, DemandSum:money, LiabilitySum:money, Side:integer, DemandOldSum:money, LiabilityOldSum:money )
     if( Side == ALG_DV_PMGR_SIDE_UNDEF )
        _AddData(DemandAccount, DemandSum, ALG_DV_PMGR_SIDE_DEMAND, DemandOldSum);
        _AddData(LiabilityAccount, LiabilitySum, ALG_DV_PMGR_SIDE_LIABILITY, LiabilityOldSum);
     elif( Side == ALG_DV_PMGR_SIDE_DEMAND )
        _AddData(DemandAccount, DemandSum, ALG_DV_PMGR_SIDE_DEMAND, DemandOldSum);
     elif( Side == ALG_DV_PMGR_SIDE_LIABILITY )
        _AddData(LiabilityAccount, LiabilitySum, ALG_DV_PMGR_SIDE_LIABILITY, LiabilityOldSum);
     end;
  END;

  MACRO GetSum( Account:TRecHandler, Side:integer, Sum:@money ):bool
     var RetVal:bool = false;
     var i:integer = 0;

     if( Sum != NULL )
        Sum = 0.0;
     end;

     while( i < this.Size )
        if( (this.(i).Account.rec.Account == Account.rec.Account) and (this.(i).Side == Side) )
           if( Sum != NULL )
              Sum = this.(i).Sum;
           end;
           RetVal = true;
           break;
        end;
        i = i + 1;
     end;

     return RetVal;
  END;
END;
/*******/

PRIVATE VAR nDealToGenAgrRep = TArray;

/* Макрофункция инициализации новой операции
	 необходимо заполнить структуру "Документ"
	 возвращаемое значение
	 0 - ошибок не было
	 1 - была ошибка
*/
PRIVATE MACRO Create_MT54x(_Doc:variant)
  record ndeal(dvndeal);
  var DebAccBuf  = TRecHandler("account");
  var CredAccBuf = TRecHandler("account");
  var docKind = 199;
  SetBuff( ndeal, GetMemAddrFrom(_Doc) );
  var FD_DV = DVFirstDocNDeal(DocKind, ndeal);
  CreateMsg54X(FD_DV, FD_DV.ДатаИсполнения(),   FD_DV.ДатаИсполнения(), FD_DV.ДатаИсполнения());
    return 1;
end;
PRIVATE MACRO Новый_Документ()
	return 0;
END;

private macro ЗаполнитьЗаявку()
	if( Документ.rec.Client > 0 )
		 var MarketID:integer = -1;

		 if( Документ.rec.Sector == SET_CHAR )
				MarketID = Документ.rec.Contractor;
		 end;

		 DL_СкорректироватьДатуЗаявки(Документ.rec.Date, Документ.rec.Time, @ClntRep.rec.RegistrDate, @ClntRep.rec.RegistrTime);
		 ClntRep.rec.XLD = DL_СформироватьНомерЗаявки(MarketID, ClntRep.rec.RegistrDate, ClntRep.rec.RegistrTime);
		 ClntRep.rec.SignedDate = ClntRep.rec.RegistrDate;
		 ClntRep.rec.SignedTime = ClntRep.rec.RegistrTime;
	end;
end;

/* Макрофункция проверки операции при вводе, редактировании, удалении
	 возвращаемое значение
	 0 - ошибок не было
	 1 - была ошибка
*/

private macro GetISOByFIID(code)
    var sql,rs;
    sql = " SELECT f.t_ccy "
    + " FROM dfininstr_dbt f "
    + " WHERE f.t_Fiid = "+code+" AND f.t_fi_kind = 1";

    rs = ExecSqlSelect(sql, MakeArray(SqlParam("1", code)), false);
    if (rs.MoveNext())
        return rs.value(0);
    else
        return null;
    end;
end;
PRIVATE MACRO Проверить_Документ(Режим:INTEGER)
	var err = 0;

	if ((Режим == TS_INSERT) OR (Режим == TS_EDIT)) //ввод или редактирование
		//для процентного свопа
		if (Документ.rec.DVKind == DV_PCTSWAP)
			// Если валюты НЕ равны, то ВТ не равна RUR
		 /* if ((DVNFI.rec.ExecType == DVSETTLEMET_STATE) and (DVNFI_2.rec.FIID != DVNFI.rec.FIID) and (DVNFI_2.rec.FIID == NATCUR))
				msgbox("В качестве базового актива требования для валютно-процентного СВОПа не может выступать национальная валюта");
				err = 1;
			end;*/
		end;

		ЗаполнитьЗаявку();
	end;

    if ( (Режим == TS_INSERT) and (Документ.rec.DVKind == DV_PCTSWAP) and (DVNFI.rec.EXECTYPE == 0) )
        if (DVNFI_2.rec.FIID == DVNFI.rec.FIID)
            if( MsgBoxEx("Изменить валюту и сумму требований ?", MB_YES + MB_NO, IND_YES) == IND_YES )
                //DVNFI_2.rec.FIID = 7;
            end;
        end;
    end;
    //mda В расчетном опционе не считается стоимость базового актива , пользователям не с чем сверить. Добавим значение в базу,
    //и оно выведется в нередактируемое окно
    if ( ((Режим == TS_INSERT) or (Режим == TS_EDIT)) and (Документ.rec.DVKind == DV_OPTION) and (DVNFI.rec.EXECTYPE == 0) )
        DVNFI.rec.COST = DVNFI.rec.PRICE * DVNFI.rec.AMOUNT;
    end;
    //mda в пут опционе не давал выбрать валюту!
    if ( ((Режим == TS_INSERT) or (Режим == TS_EDIT)) and (Документ.rec.DVKind == DV_OPTION) and (DVNFI.rec.PRICEFIID != 0) )
        if( MsgBoxEx("Изменить валюту цены базового актива с "+GetISOByFIID(DVNFI.rec.PRICEFIID)+" на RUB ?", MB_YES + MB_NO, IND_YES) == IND_YES )
            DVNFI.rec.PRICEFIID = 0;
            MsgBox("Валюта успешно изменена! Не забудьте зайти в сделку ещё раз и нажать F9 , для формирования корректных платежей!");
        end;
    end;
	return err;
END;

private macro DV_ПроверитьСуществованиеШага(nDeal, Symb, IsExecute)
  var sql, cmd, rs;
  sql = " select step.* " +
        "   from doproper_dbt oper, doprstep_dbt step " +
        "  where oper.t_DocumentID = ? " +
        "    and  oper.t_DocKind = ? " +
        "    and step.t_ID_Operation = oper.t_ID_Operation " +
        "    and step.t_Symbol = ? " +
        "    and step.t_IsExecute = ?" ;
  cmd = RSDCommand(sql);
  cmd.AddParam("",rsdbp_in,UniID( nDeal.Deal, IIF(nDeal.Deal.rec.DocKind == DL_DVNDEAL, OBJTYPE_OUTOPER_DV, OBJTYPE_FXOPER_DV) ));
  cmd.AddParam("",rsdbp_in,nDeal.Deal.rec.DocKind);
  cmd.AddParam("",rsdbp_in,Symb);
  cmd.AddParam("",rsdbp_in,IsExecute);
  rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  if (rs.movenext) 
   return True;
  end;
  return False;
end;

private macro СнятьПоставитьНеттинг(DealID,IsNeting,DealCode,DocKind)
	var sql,rs,sqli,rsi;
    var FD_DV = DVFirstDocNDeal(DocKind, DealID);
    if((FD_DV.ВидБазовогоАктива() == FIKIND_METAL) and DV_ПроверитьСуществованиеШага(FD_DV, "б", "X"))
        MsgBox("Изменение признака неттинга по сделке невозможно, так как выполнен шаг постановки на балансовый учёт." + 
        "Откатите шаг постановки на балансовый учёт и повторите попытку изменить признак неттинга по сделке");
        return 1;
    end;
	if (IsNeting)
		if( MsgBoxEx("Вы хотите снять признак неттинга со сделки "+DealCode+" ?", MB_YES + MB_NO, IND_YES) == IND_YES )
			sql = "UPDATE ddvndeal_dbt d SET d.t_netting = chr(0) WHERE d.t_id = "+DealID;
			rs = ExecSql(sql);
			if (rs != null)
				//снимем признак неттинга также и с платежей по данной сделке
				sql = "SELECT p.t_paymentid FROM dpmpaym_dbt p WHERE p.t_documentid = :DealID AND p.t_dockind = :DocKind AND p.t_netting = chr(88)";
				rs = ExecSqlSelect(sql, MakeArray(SqlParam("DealID", DealID),
                                               SqlParam("DocKind", DocKind)));
				while (rs.MoveNext())
					//апдейт по платежам к сделке в цикле
				   sqli = "UPDATE dpmpaym_dbt t SET t.t_netting = chr(0) WHERE t.t_paymentid = "+rs.value(0);
				   rsi = ExecSql(sqli);
				   if (rsi == null)
				   	MsgBox("Ошибка при попытке снять признак неттинга с платежа "+rs.value(0)+" по сделке "+DealCode);
				   	continue;
				   end;
				end;
			else
				MsgBox("Ошибка при попытке снять признак неттинга со сделки "+DealCode);
				return 1;
			end;
		MsgBox("Признак неттинга успешно снят по сделке "+DealCode+" и платежам по сделке!");
		end;

	else
		if( MsgBoxEx("Вы хотите установить признак неттинга на сделку "+DealCode+" ?", MB_YES + MB_NO, IND_YES) == IND_YES )
			sql = "UPDATE ddvndeal_dbt d SET d.t_netting = chr(88) WHERE d.t_id = "+DealID;
			rs = ExecSql(sql);
			if (rs != null)
				//установим признак неттинга также и на платежи по данной сделке
				sql = "SELECT p.t_paymentid FROM dpmpaym_dbt p WHERE p.t_documentid = :DealID AND p.t_dockind = :DocKind AND p.t_netting <> chr(88)";
				rs = ExecSqlSelect(sql, MakeArray(SqlParam("DealID", DealID),
                                               SqlParam("DocKind", DocKind)));
				while (rs.MoveNext())
					//апдейт по платежам к сделке в цикле
				   sqli = "UPDATE dpmpaym_dbt t SET t.t_netting = chr(88) WHERE t.t_paymentid = "+rs.value(0);
				   rsi = ExecSql(sqli);
				   if (rsi == null)
				   	MsgBox("Ошибка при попытке установить признак неттинга на платеже "+rs.value(0)+" по сделке "+DealCode);
				   	continue;
				   end;
				end;
			else
				MsgBox("Ошибка при попытке установить признак неттинга со сделки "+DealCode);
				return 1;
			end;
		MsgBox("Признак неттинга успешно установлен по сделке "+DealCode+" и платежам по сделке!");
		end;
	end;

end;


/* Макрофункция вызывается по Ctrl-Z из скроллинга/панели */
PRIVATE MACRO Функция_Пользователя()
        record accdoc_plus(mcaccdoc); /*PNV*/
        record accdoc_minus(mcaccdoc); /*PNV*/

        macro IsDM(dealid)
            var sql, q, DataSet;
            sql = RsdCommand("select t_fi_kind from dfininstr_dbt where t_fiid in (select t_fiid from ddvnfi_dbt where t_dealid = ?)");
            sql.addParam( "", RSDBP_IN, dealid );
            sql.execute();
            DataSet = TRsbDataSet(sql);
            if ( DataSet.MoveNext() )
                if(DataSet.fi_kind == 6)
                    return true;
                else
                    return false;
                end;
            end;
            return false;
        end;
		var que,rs09,dealid,IsNeting;
		array MenuItems;
		var MenuResult;

       /*  Щербинин начало изменений*/
	private var i, FieldName, sep = "                         ", 
                   pa_menu = TArray(), pa_choice,
                   TmpOutPutFileName = "acctrn_"+UserNumber+".txt";  
	if (index(";1;9990;9995;9996;",";"+{oper}+";"))           
         if (GetTrue(false,"Показать меню Прикладного администратора?"))
  	    pa_menu.value(0) = "Отобразить ВСЕ поля записи"; 
  	    pa_menu.value(1) = "Создать сделку в БОЦБ"; 

           pa_choice = menu(pa_menu, "Выберите действие", "Меню прикладного администратора");

           if(pa_choice == 0)                                     
             SetOutPut(TmpOutPutFileName,false);
             println(Документ.TblName,"\n");
             for(i,0,10000)
               FieldName = FldName(Документ,i);
               if (FieldName != "Нет_имени")
                 println("T_", FieldName, substr(sep,1,strlen(sep)-strlen(FieldName)), "=\t", Документ.item(i));
               else
                 break;
               end;
             end;
             SetOutPut(NULL, true);
             ViewFile(TmpOutPutFileName);
           elif(pa_choice == 1)

              var FD1 = DVFirstDocNDeal(DL_DVNDEAL, Документ.rec.ID);
              var dealparameters = SP_DealParm();
              dealparameters.dealcodets = Документ.rec.Extcode;
              dealparameters.dealcode = Документ.rec.code;
              dealparameters.dealdate = Документ.rec.date;
              dealparameters.dealtime = Документ.rec.Time;
              dealparameters.supplytime = Документ.rec.Time;

              dealparameters.partyid = Документ.rec.Contractor;
              If(Документ.rec.Type == 1)
                 dealparameters.dealtype = 12183;
              else
                 dealparameters.dealtype = 12193;
              end;
              dealparameters.portfolio = 1;
              dealparameters.amount = FD1.nfi_baseactiv.rec.amount;
              dealparameters.fi_code = ПолучитьКОдФИнИН(FD1.nfi_baseactiv.rec.fiid);
              dealparameters.cost = FD1.nfi_baseactiv.rec.cost-FD1.nfi_baseactiv.rec.nkd;
              dealparameters.nkd = FD1.nfi_baseactiv.rec.nkd;
              dealparameters.inperc = "X";
              dealparameters.depositid = 4;
              dealparameters.point = 2;
	      dealparameters.TypeCalc = "2";
              dealparameters.price = (FD1.nfi_baseactiv.rec.cost-FD1.nfi_baseactiv.rec.nkd)/FD1.nfi_baseactiv.rec.amount/GetFaceValue(FD1.nfi_baseactiv.rec.fiid, Документ.rec.date)*100;
              dealparameters.paydate = FD1.nfi_baseactiv.rec.paydate;
              dealparameters.supplydate = FD1.nfi_baseactiv.rec.supldate;

              var InsDEalError = SP_InsUpdDeal(dealparameters);
              If(InsDEalError == 0)
                 UpdDeal(dealparameters.dealid);
                 InsertFrVal(Документ.rec.id, dealparameters.dealid);
                 if(SP_ExecDeal(dealparameters.dealid, false) != 0)
                     MsgBox("Ошибка старта операции по сделке " + dealparameters.dealid);
                 end;
                 UpdInsAccounts(Документ.rec.id, dealparameters.dealid, FD1.nfi_baseactiv.rec.fiid);
                 MsgBox("Сделка создана успешно!");

              else
                 MsgBox("Ошибка создания сделки " + InsDEalError);
              end;


           end;
           exit(1);
         end;
       end;
       /*  Щербинин конец изменений */  

/*DAN Для опционов с БИО контрагентом выступает Наш Банк. В этом случае отправка сообщения не требуется*/
/*введена переменная, значение которой проверяется при выборе пункта для вормирования МТ*/
        var SendMT = True;	
        if ((Документ.rec.KIND == 12695) and (Документ.rec.contractor == {OurBank})) 
          SendMT = False;
        end;


        /*if (Документ.rec.DVKind == 7) SVE формирование МТ600 должно быть по внебиржевым сделкам*/
        if ((Документ.rec.MarketKind == 0) and (IsDM(Документ.rec.id)) and (SendMT))
          if( MsgBoxEx("Формировать сообщения MT6xx?", MB_YES + MB_NO, IND_YES) == IND_YES )
            DV_MsgSWIFT_MT600(Документ.rec.Id,Документ.rec.dockind, 0);
          end;
	end;
		if ( (Документ.rec.KIND == 12690) or 
				(Документ.rec.KIND == 12695) or 
				(Документ.rec.KIND == 22710) or 
                            (Документ.rec.KIND == 12720) or 
                                //(Документ.rec.KIND == 2710) or 
                     (Документ.rec.KIND == 2730) or 
                     (Документ.rec.KIND == 12730) or 
                     (Документ.rec.KIND == 22730) or 
                     (Документ.rec.KIND == 12735) or 
				(Документ.rec.KIND == 22720)
			 )
			//Есть ли признак неттинга на сделке
			IsNeting = false;
  	
  			if (Документ.rec.netting == SET_CHAR)
  				IsNeting = true;
  			end;

  			MenuItems[0] = "Снять/установить признак неттинга";
                      if (Документ.rec.KIND == 12695)
  			MenuItems[1] = "Формирование подтверждения MT"; 
                      end;
  			MenuItems[2] = "Разблокировка сделки в Кондор";
                        MenuItems[3] = "Повторно отправить подтверждение в АСУДР";
  			MenuItems[4] = "Информация по полям сделки";
  			MenuItems[5] = "Изменить сумму БА по сделке!";
  			MenuItems[6] = "Изменить дату исполнения опциона";/*PNV*/
  			MenuItems[7] = "Открыть для платежей внебал. счета по Процетному СВОПУ";/*PNV*/
                        MenuItems[8] = "Создать промежуточный платеж"; /*CHVA*/
			MenuItems[9] = "Состояние репортинга в НРД по сделкам"; /*DAN*/
                        MenuItems[10] = "Формирование сообщения MT300";
                        MenuItems[11] = "Формирование сообщения MT340";
                        MenuItems[12] = "Формирование сообщения MT341";
                        MenuItems[13] = "Формирование сообщения MT364";
                        MenuItems[14] = "Формирование сообщения MT365";
                        MenuItems[15] = "Формирование сообщения MT399";
                        MenuItems[16] = "Отмена сообщения (MT392)";
                      If(IsNeedInsertIRGraths(Документ.rec.id))
                        MenuItems[17] = "Создание репозитарных параметров для сделки";
                      end;

  			MenuResult = Menu(MenuItems, "Выбрать действие");

  			if (MenuResult == 0)
  				СнятьПоставитьНеттинг(Документ.rec.Id,IsNeting,Документ.rec.Code, Документ.rec.DocKind);
  			elif (MenuResult == 1)
  				if (Документ.rec.KIND == 12695)
  					DV_MsgSWIFT_MT305(Документ.rec.Id);
  				end;
  			elif (MenuResult == 2)
                          //интеграция: выгрузка статуса сделки при помещении в отложенные
                          UpdateStatusDeal(CreateObjectForExport( Документ.rec, EXPORT_DEAL_ROLLED_BACK, "VNDEAL" ), true);
 
                       elif(MenuResult == 3) //А.Киселев 02.04.2020 Здесь отправляем в АСУДР Request
                         //А.Киселев 02.04.2020 Здесь отправляем в АСУДР два Request
                        //закомментировано до окончания тестирования функционала
                          //  DemandLiabilityExt = Null;
                          //  DemandLiabilityExt = c_DemandLiabilityExt( Документ, Null, -1, "D" );
                          //  ExecDemandLiability( DemandLiabilityExt );
                          //  DemandLiabilityExt = Null;
                          //  DemandLiabilityExt = c_DemandLiabilityExt( Документ, Null, -1, "L" );
                          //  ExecDemandLiability( DemandLiabilityExt);
                          //  DemandLiabilityExt = Null;
                        //закомментировано до окончания тестирования функционала
                        //А.Киселев 02.04.2020 Здесь отправляем в АСУДР два Request

  			elif (MenuResult == 4)
  				if ((Документ.rec.KIND == 12690) or (Документ.rec.KIND == 12695))
  					var sql,rs,str;
  					sql = "SELECT t.t_amount,t.t_cost FROM ddvnfi_dbt t WHERE t.t_dealid = "+Документ.rec.Id;
  					rs = ExecSqlSelect(sql);
  					if (rs.MoveNext())
  						str = "Количество - "+rs.value(0)+"\r\n"+"Стоимость базового актива - "+rs.value(1);
  						MsgBox(str);
  					end;
  				end;
  			elif (MenuResult == 5)
                          var sba,sql1,rs1,sql2,rs2;
  			  if (GetDouble(sba))
  			    if( MsgBoxEx("Изменить сумму базового актива на "+sba+" ?", MB_YES + MB_NO, IND_YES) == IND_YES )
                              sql1 = "UPDATE ddvnfi_dbt d SET d.t_amount = "+sba+" WHERE d.t_dealid = "+Документ.rec.Id;
                              rs1 = ExecSql(sql1);
                              sql2 = "UPDATE dpmpaym_dbt p SET  p.t_amount = "+sba+", p.t_payamount = "+sba+", p.t_baseamount = "+sba+", p.t_futurebaseamount = "+sba+", p.t_orderamount  = "+sba+" WHERE ";
                              sql2 = sql2 + " p.t_dockind = 199 AND p.t_documentid = "+Документ.rec.Id+" and p.t_purpose = 1 ";
                              rs2 = ExecSql(sql2); 

                              if (rs1 and rs2)
                                  MsgBox("Изменено!");
                              end;
  			   end;
  			  end;
                        elif (MenuResult == 6)/*PNV*/
      			  var stat = 0, sql3, rs3;
                           var PayDate, EXECDATE;
                           sql = "SELECT t.t_EXECDATE FROM ddvnfi_dbt t WHERE t.t_dealid = "+Документ.rec.Id;
      			  rs = ExecSqlSelect(sql);
      			  if (rs.MoveNext())
                               PayDate = Date(rs.value(0));
                               EXECDATE = Date(rs.value(0));
                           else
                              stat = 1;
      			  end;
                           if ((Документ.rec.KIND != 12695) and (Документ.rec.KIND != 22695))
                                stat = 1;
                           end;    
                           if (not GetDate(PayDate, "Введите дату исполнения"))
                               stat = 1;
                           end;
  	                   if (stat == 0)
  			       if( MsgBoxEx("Изменить дату исполния опциона на " + PayDate + " ?", MB_YES + MB_NO, IND_YES) == IND_YES )
                                 sql1 = "UPDATE ddvnfi_dbt d SET d.T_EXECDATE = to_date('" + PayDate + "','DD.MM.YYYY')  WHERE d.t_dealid = " + Документ.rec.Id;
                                 rs1 = ExecSql(sql1);
                                 sql2 = "UPDATE DOPRDATES_DBT p SET  p.t_date = to_date('" + PayDate + "','DD.MM.YYYY') WHERE P.T_ID_OPERATION = (select T_ID_OPERATIOn from DOPROPER_DBT where t_kind_operation = " + Документ.rec.KIND + " and t_documentid =  LPAD(" + Документ.rec.Id +", 34, '0')) and t_date = to_date('" + EXECDATE + "','DD.MM.YYYY')";
                                 rs2 = ExecSql(sql2); 
                                 sql3 = "UPDATE DOPRstep_DBT p SET  p.t_plan_date = to_date('" + PayDate + "','DD.MM.YYYY') WHERE P.T_ID_OPERATION = (select T_ID_OPERATIOn from DOPROPER_DBT where t_kind_operation = " + Документ.rec.KIND + " and t_documentid =  LPAD(" + Документ.rec.Id +", 34, '0')) and t_plan_date = to_date('" + EXECDATE + "','DD.MM.YYYY') and t_isexecute = 'R'";
                                 rs3 = ExecSql(sql3);
                                 if (rs1 and rs2 and rs3)
                                     MsgBox("Изменено!");
                                 end;
  	   		       end;
  			   end;
       		   elif (MenuResult == 7)/*PNV*/
                            var DebAccBuf  = TRecHandler("account");
                            var CredAccBuf = TRecHandler("account");
                            var PmGrAccSum = DV_PmGrAccSumCollector();

                            if (Документ.rec.KIND != 22720)
                                stat = 1;
                            end;
                            var DebAcc = "+Форвард, дрейф Проц.СВОП";
                            var CredAcc = "-Форвард, дрейф Проц.СВОП";
                            var DebFiRole  = FIROLE_FIREQ;
                            var CredFiRole  = FIROLE_FICOM;

                            var FD = DVFirstDocNDeal(DL_DVNDEAL, Документ.rec.ID);
                            var query = "select rownum, pay.* from DDVNPMGR_DBT pay where pay.t_dealid  = ? order by t_paydate";
                            var cmd = RSDCommand(query);
                            cmd.addParam( "", RSDBP_IN, Документ.rec.ID /*1*/ );
                            cmd.execute();
                            rs = TRsbDataSet(cmd);
                            while(rs.MoveNext())
                                  var GrFD = DVFirstDocPmGr(DL_DVNDEALPMGR, SQL_ConvTypeInteger(rs.ID));
                                  //NUM = rs.rownum; 
                                  DebAccBuf.clear();
                                  if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_LIABILITY ) /* требование или не задано */
                                      if( not GrFD.ReOpenAccount(DebAcc, null, null, DebFiRole, DebAccBuf, Документ.rec.Date, FD.ВалютаТребования(), null) )
                                          return 1;
                                      end;
          			         sql = "UPDATE DDVNPMGR_DBT d SET d.T_DEMANDACCOUNT = '" + DebAccBuf.rec.Account + "'  WHERE d.t_id = " + rs.ID;
         			         rs1 = ExecSql(sql);
     			         if (rs1 != null)
     			         end;
                                  end;

                                  CredAccBuf.clear();
                                  if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_DEMAND ) /* обязательство или не задано */
                                      if( not GrFD.ReOpenAccount(CredAcc, null, null, CredFiRole, CredAccBuf, Документ.rec.Date, FD.ВалютаОбязательства(), null) )
                                          return 1;
                                      end;
          			         sql = "UPDATE DDVNPMGR_DBT d SET d.T_LIABILITYACCOUNT = '" + CredAccBuf.rec.account + "'  WHERE d.t_id = " + rs.ID;
         			         rs1 = ExecSql(sql);
     			         if (rs1 != null)
     			         end;
                                  end;
                                  PmGrAccSum.AddData(DebAccBuf, CredAccBuf, GrFD.ReqSum(), GrFD.ComSum(), GrFD.PmGr.rec.Side);
                            end;
                            msgbox("Успешно!");
                   elif (MenuResult == 8)
                       var CalcOp = TRecHandler("dvnacdl");
                       FD = DVFirstDocNDeal(DL_DVNDEAL, Документ.rec.ID);
                       CalcOp.rec.DealID    = FD.Deal.rec.Id;
                       CalcOp.rec.AccFIID   = FD.nFI_BaseActiv.rec.PriceFIID;
                       CalcOp.rec.PayKind   = DV_CALCOP_PAYKIND_INTERIM;
                       query = "select rownum, pay.* from DDVNPMGR_DBT pay where pay.t_dealid  = ? and  pay.t_paydate <= ? and not exists (select * from ddvnacdl_dbt acdl where pay.t_dealid = acdl.t_dealid and pay.t_paydate = acdl.t_date and acdl.t_paysum = pay.t_paymentsum ) order by t_paydate";
                       cmd = RSDCommand(query);
                       cmd.addParam( "", RSDBP_IN, Документ.rec.ID /*1*/ );
                       cmd.addParam( "", RSDBP_IN, {curdate} /*2*/ );
                       cmd.execute();
                       rs = TRsbDataSet(cmd);
                       while(rs.MoveNext())
                          CalcOp.rec.Direction = rs.side;
                          CalcOp.rec.Date = rs.paydate;
                          CalcOp.rec.Sum = rs.paymentsum;
                          CalcOp.rec.Paysum = rs.paymentsum;
                          
                      var cmd2 = rsdcommand("INSERT INTO ddvnacdl_dbt (T_ID,T_DEALID,T_DATE,T_DIRECTION,T_PAYKIND,T_SUM,T_ACCFIID,T_TAXSUM,T_PAYSUM,T_COMID,T_SERVOPERID,T_NETTING,T_DEMAND,T_LIABILITY)"+
                                    " VALUES (?,?,?,?,?,?,?,0,?,0,0,CHR(0),0,0)");
                              cmd2.AddParam ("", RSDBP_IN, 0);
                              cmd2.AddParam ("", RSDBP_IN, CalcOp.rec.DealID);
                              cmd2.AddParam ("", RSDBP_IN, CalcOp.rec.Date);
                              cmd2.AddParam ("", RSDBP_IN, CalcOp.rec.Direction);
                              cmd2.AddParam ("", RSDBP_IN, 70);
                              cmd2.AddParam ("", RSDBP_IN, CalcOp.rec.Sum);
                              cmd2.AddParam ("", RSDBP_IN, CalcOp.rec.AccFIID);
                          //    cmd2.AddParam ("", RSDBP_IN, 0);
                              cmd2.AddParam ("", RSDBP_IN, CalcOp.rec.Paysum);
                          //    cmd2.AddParam ("", RSDBP_IN, 0);
                          //    cmd2.AddParam ("", RSDBP_IN, 0);
                           //   cmd2.AddParam ("", RSDBP_IN, CHR(0));
                           //   cmd2.AddParam ("", RSDBP_IN, 0);
                           //   cmd2.AddParam ("", RSDBP_IN, 0);
                              
                              cmd2.execute();

                             MsgBox("Платеж вставлен.");
                          /* if( DV_InsCalcOpPanel(CalcOp) == 0 )
                              if( DV_InsertCalcOp(CalcOp) != 0 )
                                 MsgBox("Ошибка при вставке записи расчётов по сделке.");
                              return 1;
                              end;
                           else
                             return 1;
                           end;*/
                       end;  
                   elif (MenuResult == 9)
                     ExecMacroFile ("ir_report.mac","exec_ir_rep");
  	           elif ((MenuResult == 10) and (SendMT))
                     if( (Документ.rec.TYPE == 1) or (Документ.rec.TYPE == 2)  or (Документ.rec.TYPE == 6)  or (Документ.rec.TYPE == 5) )
  		        DV_DealsGenMesMT300Paym(Документ.rec.Id, Документ.rec.DocKind/*DL_DVFXDEAL*/);
                     end;
  	           elif ((MenuResult == 11) and (SendMT))
                     if( (Документ.rec.TYPE == 7) or (Документ.rec.TYPE == 8) )
  		        DV_MsgSWIFT_MT340(Документ.rec.Id);
    		     end;
  	           elif ((MenuResult == 12) and (SendMT))
                     if( (Документ.rec.TYPE == 7) or (Документ.rec.TYPE == 8) )
  		        DV_MsgSWIFT_MT341(Документ.rec.Id);
                     end;
  	           elif ((MenuResult == 13) and (SendMT))
                     if( (Документ.rec.TYPE == 7) or (Документ.rec.TYPE == 8) )
  		        DV_MsgSWIFT_MT364(Документ.rec.Id);
                     end;
  	           elif ((MenuResult == 14) and (SendMT))
                     if( (Документ.rec.TYPE == 7) or (Документ.rec.TYPE == 8) )
  		        DV_MsgSWIFT_MT365(Документ.rec.Id);
                     end;
  	           elif ((MenuResult == 16) and (SendMT))
                     if( (Документ.rec.TYPE == 7) or (Документ.rec.TYPE == 8) )
  		        DV_MsgSWIFT_MT392(Документ.rec.Id);
                     end;
  	           elif ((MenuResult == 15) and (SendMT))
                     if( Документ.rec.kind == 12735 )
  		        DV_DealsGenMesMT399Paym(Документ.rec.Id);
                     end;
  	           elif (MenuResult == 17)
                        ExecMacroFile("deal_ir_parms", "InsertIRGrathsParms", Документ.rec.ID);
  		   end;  
                   /*PNV*/		
		else
			MenuItems[0] = "СПИ";
  			MenuItems[1] = "Разблокировка сделки в Кондор";
		        MenuItems[2] = "Снять/установить признак неттинга";
                        //MenuItems[3] = "Повторно отправить подтверждение в АСУДР";
  	
                     if((Документ.rec.KIND == 2690) or (Документ.rec.KIND == 2695))
                       MenuItems[3] = "Формирование MT54x";  
                     elif((Документ.rec.KIND == 12715) or ( Документ.rec.KIND == 12745))/*CHVA 523288*/
                       MenuItems[3] = "Формирование MT300";  
                     end;
                     If(IsNeedInsertIRGraths(Документ.rec.id))
                       MenuItems[4] = "Создание репозитарных параметров для сделки";
                     end;

  			MenuResult = Menu(MenuItems, "Выбрать действие");

  			if (MenuResult == 0)
				que = "select t_id from ddvndeal_dbt  where  t_code='"+Документ.rec.code+"'";
				rs09 = LnGetRecordset(que);
				if(rs09 != null)
						if (rs09.moveNext)
							dealid     = rs09.value(0);
							execmacrofile("dl_mt.mac", "Kontr300",dealid,2) ;
						end;
				end;

				que = "update  ddvndeal_dbt set t_conftpid=2  where  t_code='"+Документ.rec.code+"'";
				rs09 = LnGetRecordset(que);
                        elif (MenuResult == 1)
                          //интеграция: выгрузка статуса сделки при помещении в отложенные
                          UpdateStatusDeal(CreateObjectForExport( Документ.rec, EXPORT_DEAL_ROLLED_BACK, "VNDEAL" ), true);
                        elif (MenuResult == 2)
 			      //Есть ли признак неттинга на сделке
			     IsNeting = false;
  			     if (Документ.rec.netting == SET_CHAR)
  			      	IsNeting = true;
  			     end;
    	                   СнятьПоставитьНеттинг(Документ.rec.Id,IsNeting,Документ.rec.Code,Документ.rec.DocKind);

                        //elif(MenuResult == 3) //А.Киселев 02.04.2020 Здесь отправляем в АСУДР Request

                        //А.Киселев 02.04.2020 Здесь отправляем в АСУДР два Request

                         // DemandLiabilityExt = Null;
                         // DemandLiabilityExt = c_DemandLiabilityExt( Документ, Null, -1, "D" );
                         // ExecDemandLiability( DemandLiabilityExt );
                         // DemandLiabilityExt = Null;
                         // DemandLiabilityExt = c_DemandLiabilityExt( Документ, Null, -1, "L" );
                         // ExecDemandLiability( DemandLiabilityExt);
                         // DemandLiabilityExt = Null;

                        //А.Киселев 02.04.2020 Здесь отправляем в АСУДР два Request

                        elif (MenuResult == 3)
                           if((Документ.rec.KIND == 2690) or (Документ.rec.KIND == 2695))
                           Create_MT54x(Документ);
                           elif( (Документ.rec.KIND == 12715) or (Документ.rec.KIND == 12745) )/*CHVA 523288*/
        		     DV_DealsGenMesMT300Paym(Документ.rec.Id, Документ.rec.DocKind/*DL_DVFXDEAL*/);
                           end;
                        elif (MenuResult == 4)
                           ExecMacroFile("deal_ir_parms", "InsertIRGrathsParms", Документ.rec.ID);
			end;
		end;

	return 0;
END;

MACRO Привязать_к_ГС (DealID, GenAgrID, FI)
	var cmd = "", rs = NULL, rsG = NULL, rep = NULL, DealCode = "", retVal = 0;

	if (GenAgrID > 0)
		//
		// привязка
		//
		rs = TRsbDataSet("select * " +
										 "from ddvndeal_dbt ndeal " +
										 "where ndeal.t_ID = " + String(DealID));

		rsG = TRsbDataSet("select * " +
											"from ddl_genagr_dbt gagr " +
											"where gagr.t_GenAgrID = " + String(GenAgrID));

		if (not rs.MoveNext)
			rep = GenAgrRep;
			rep.NumDeal = "";
			rep.Result  = "не привязана";
			rep.Comment = "Сделка с ID = " + String(DealID) + " не найдена.";
		else
			DealCode = rs.Code;
		end;

		if ((rep == NULL) and (not rsG.MoveNext))
			rep = GenAgrRep;
			rep.NumDeal = "";
			rep.Result  = "не привязана";
			rep.Comment = "ГС с ID = " + String(GenAgrID) + " не найдено.";
		end;

		if ((rep == NULL) and (rs.GenAgrID > 0))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "Сделка с ID = " + String(DealID) + " уже привязана к ГС.";
		end;

		if ((rep == NULL) and (date(rs.Date) < date(rsG.Start)))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "Дата сделки меньше даты начала ГС.";
		end;

		if (rsG.Date_End != zerodate)
			if ((rep == NULL) and
					(date(rs.Date) > date(rsG.Date_End)))
				rep = GenAgrRep;
				rep.NumDeal = rs.Code;
				rep.Result  = "не привязана";
				rep.Comment = "Дата сделки больше даты окончания ГС.";
			end;
		end;

		if ((rep == NULL) and (rs.Contractor != rsG.PartyID))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "Контрагент по сделке не совпадает с контрагентом по ГС.";
		end;

		if ((rep == NULL) and
				((rs.State != DVDEAL_OPEN) and (rs.State != DVDEAL_PREP)))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "Сделка должна быть открыта или отложена.";
		end;

		if ((rep == NULL) and
				((rsG.Status != 0) and (rsG.Status != 10)))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "ГС должно быть открыто или отложено.";
		end;

		if ((rep == NULL) and
				((rs.State == DVDEAL_OPEN) and (rsG.Status != 10)))
			rep = GenAgrRep;
			rep.NumDeal = rs.DealCode;
			rep.Result  = "не привязана";
			rep.Comment = "Открытую сделку можно привязать только к открытому ГС.";
		end;

		if ((rep == NULL) and
				((rs.DVKind == DV_CURSWAP) or
				 (rs.DVKind == DV_PCTSWAP) or
				 (rs.DVKind == DV_CURSWAP_FX)
				) and
				(not rsG.Can_SVOP))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "Тип сделки не соответствует ГС.";
		end;

		if ((rep == NULL) and
				((rs.DVKind == DV_OPTION) or
				 (rs.DVKind == DV_FORWARD) or
				 (rs.DVKind == DV_FORWARD_T3) or
				 (rs.DVKind == DV_FORWARD_FX) //or
				 //(rs.DVKind == DV_BANKNOTE_FX)
				) and
				(not rsG.Can_Buy_Sale))
            rep = GenAgrRep;
            rep.NumDeal = rs.Code;
            rep.Result  = "не привязана";
            rep.Comment = "Тип сделки не соответствует ГС.";
        end;
 
    if ((rep == NULL) and (rs.DVKind == DV_BANKNOTE_FX) and
        (not rsG.Can_BankNote)
         )
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "Тип сделки не соответствует ГС.";
		end;

		if ((rep == NULL) and
				(rs.IsPFI) and
				(not rsG.Can_PFI))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не привязана";
			rep.Comment = "ФИ сделки не соответствует ГС.";
		end;

		if ((rep == NULL) and
				(FI != NULL) and (FI > 0))
			if (((FI == 40) and (not rsG.Can_Currency)) or
					((FI == 60) and (not rsG.Can_Metall)) or
					((FI != 40) and (FI != 60) and
					 (not rsG.Can_Secur)))
				rep = GenAgrRep;
				rep.NumDeal = rs.Code;
				rep.Result  = "не привязана";
				rep.Comment = "ФИ сделки не соответствует ГС.";
			end;
		end;

	else
		//
		// отвязка
		//
		rs = TRsbDataSet("select * " +
										 "from ddvndeal_dbt ndeal " +
										 "where ndeal.t_ID = " + String(DealID));

		if (rs.MoveNext)
			DealCode = rs.Code;
			if (rs.State == DVDEAL_CLOSE)
				rep = GenAgrRep;
				rep.NumDeal = rs.Code;
				rep.Result  = "не отвязана";
				rep.Comment = "Нельзя отвязать закрытую сделку от ГС.";
			end;
		else
			rep = GenAgrRep;
			rep.NumDeal = "";
			rep.Result  = "не отвязана";
			rep.Comment = "Сделка с ID = " + String(DealID) + " не найдена.";
		end;

		if ((rep == NULL) and (rs.GenAgrID <= 0))
			rep = GenAgrRep;
			rep.NumDeal = rs.Code;
			rep.Result  = "не отвязана";
			rep.Comment = "Сделка с ID = " + String(DealID) + " не привязана к ГС.";
		end;

		if (rep == NULL)
			rs = TRsbDataSet("select * " +
											 "from ddl_genagr_dbt gagr " +
											 "where gagr.t_GenAgrID = " + String(GenAgrID));

			if (rs.MoveNext)
				if (rs.Status == 20)
					rep = GenAgrRep;
					rep.NumDeal = rs.Code;
					rep.Result  = "не отвязана";
					rep.Comment = "Нельза отвязать сделку от закрытого ГС.";
				end;
			else
				 // все равно отвяжем, если ГС не нашли
			end;
		end;
	end;

	if (rep == NULL)
		cmd = "update ddvndeal_dbt deal set deal.t_GenAgrID = " + String(GenAgrID) +
					" where deal.t_ID = " + String(DealID);

		RsdCommand(cmd).Execute;

		rep = GenAgrRep;
		rep.NumDeal = DealCode;
		if (GenAgrID > 0)
			rep.Result  = "привязана";
			rep.Comment = "Сделка привязана к ГС.";
		else
			rep.Result  = "отвязана";
			rep.Comment = "Сделка отвязана от ГС.";
		end;
	else
		retVal = 1;
	end;

	nDealToGenAgrRep[nDealToGenAgrRep.size] = rep;

	return retVal;
END;

MACRO Отчет_Привязки_к_ГС(GenAgrID)
	var ReportFile = NULL, rs = NULL, idx = 0;

	file RepFile() txt write;

	if (nDealToGenAgrRep.size == 0)
		;//ничего не делаем
	elif (nDealToGenAgrRep.size == 1)
		msgbox(nDealToGenAgrRep[0].Comment);
	else
	open(RepFile, GetTxtFileName("dvgenagr"));

	if (GenAgrID > 0)// привязка
		rs = TRsbDataSet("select * " +
										 "from ddl_genagrview_dbt gagr " +
										 "where gagr.t_GenAgrID = " + String(GenAgrID));
		rs.MoveNext;

		insert(RepFile, "Протокол привязки сделок к ГС " + rs.Code +
										", контрагент " + rs.Party);
	else // отвязка
		insert(RepFile, "Протокол отвязки сделок от ГС");
	end;

	insert(RepFile, "┌────────────────────┬────────────────┬────────────────────────────────────────────────────────────────────────────────┐");
	insert(RepFile, "│    Номер сделки    │   Результат    │                              Сообщение                                         │");
	insert(RepFile, "│                    │   процедуры    │                                                                                │");
	insert(RepFile, "├────────────────────┼────────────────┼────────────────────────────────────────────────────────────────────────────────┤");

	while (idx < nDealToGenAgrRep.size)
		insert(RepFile, "│" + String(nDealToGenAgrRep[idx].NumDeal:20) + "│" +
													String(nDealToGenAgrRep[idx].Result:16) + "│" +
													String(nDealToGenAgrRep[idx].Comment:80) + "│");

		idx = idx + 1;
	end;

	insert(RepFile, "└────────────────────┴────────────────┴────────────────────────────────────────────────────────────────────────────────┘");

	close(RepFile);
	ViewFile(RepFile);
	end;

	nDealToGenAgrRep.size = 0;

	return 0;
END;

