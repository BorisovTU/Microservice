/*
$Name:        dvcorrhdp020.mac
$Module:      Производные инструменты
$Description: Корректировка РХДП. Шаг:Бухгалтерский учет корректировок РХДП 
*/
IMPORT InsCarryDoc, RsbDataSet, OprInter, dlquery, DealsInter, dvinter,globals;

VAR SvOpDL_COMM = TRecHandler("dl_comm");

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )
  var stat = 0;
  record Comm( dl_comm );
  SetBuff( Comm, FirstDoc );
  var ErrorStr = "";
  stat = DV_InsertCorRHDPInDeals(Comm, ErrorStr);
  if (stat and (ErrorStr != ""))
    SetOutPut(gettxtfilename("dvcorrhdp020_"+StrSubst(string(date()),".","")+StrSubst(string(time()),":","")),false);
    println(ErrorStr);
    ViewFile(SetOutPut(null, true));
    SetOutPut(null, true);
  end;
  return stat;
END;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */
    if (CommitOrRollback==1)
        /* Произошла ошибка или происходит откат */
        return;
    end;
   record Comm( dl_comm );
   SetBuff( Comm, FirstDoc );
   var stat = 0;
   var ErrorStr = "";
   stat = DV_BackOutCorRHDPInDeals(Comm,ErrorStr);
   if (stat and (ErrorStr != ""))
    SetOutPut(gettxtfilename("dvcorrhdp020_"+StrSubst(string(date()),".","")+StrSubst(string(time()),":","")),false);
    println(ErrorStr);
    ViewFile(SetOutPut(null, true));
    SetOutPut(null, true);
   end;
 
    return 1;
END;
