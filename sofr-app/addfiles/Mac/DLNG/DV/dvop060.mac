/*
$Name:        dvop060.mac
$Module:      ФИСС и КО
$Description: Операция расчетов. Шаг "Завершение торгового дня"
*/
import InsCarryDoc, "dv_fun.mac", "dv_class.mac", "dv_car.mac", "dv_categ.mac", "dv_carop.mac", "dvoprmassexec.mac";

private var Docum;
private record oper(dvoper) btr write;

/* FactSum  //Фактические переводы по валютам
   Currency //Валюта
   InSum    //Входящая сумма на биржу
   OutSum   //Исходящая сумма на биржу */

private var Currency = DV_TDataCurrency();
private var FactSum  = DV_TDataFactSum();

private var ID_Operation = 0;
private var ID_Step = 0;

private var ErrorStatus  = 1362;
private var ErrorMessage = "";

private macro ExitStep()
   var QueryErr = "UPDATE doprtemp_tmp SET t_errorstatus = ?, t_errormessage = ? where t_errorstatus = 0 and t_SkipDocument = 0 and t_id_operation = ? and t_id_step = ?";
   var cmdErr = RSDCommand(QueryErr);

   ErrorMessage = IIF(ErrorMessage == "", DVOP_GetCarryError(), ErrorMessage);
   cmdErr.addParam( "", RSDBP_IN, ErrorStatus ); 
   cmdErr.addParam( "", RSDBP_IN, ErrorMessage ); 
   cmdErr.addParam( "", RSDBP_IN, ID_Operation ); 
   cmdErr.addParam( "", RSDBP_IN, ID_Step );  
   cmdErr.NullConversion = true;
   cmdErr.Execute();

   return 0;    
end;

private macro ВыполнитьПроверкиНеттоПозицииПриИсполнении()
 var Query =
          " SELECT Count(TURN.T_ID) aa "+ 
          "   FROM ddvfiturn_dbt TURN, ddvfipos_dbt POS, dfininstr_dbt fin " + 
          "  WHERE " + PositionByOperation(oper) + "  " +
          "    AND " + TurnByPosition(null,null,"POS") + "  " +
          "    AND TURN.T_DATE        = ( SELECT max(t_Date) " +
          "                                 FROM ddvfiturn_dbt TURN " +
          "                                WHERE TURN.T_DEPARTMENT  = POS.T_DEPARTMENT  " +
          "                                  AND TURN.T_FIID        = POS.T_FIID        " +
          "                                  AND TURN.T_BROKER      = POS.T_BROKER      " +
          "                                  AND TURN.T_CLIENTCONTR = POS.T_CLIENTCONTR " +
          "                                  AND TURN.t_GenAgrID    = POS.t_GenAgrID " +
          "                                  AND TURN.T_DATE        <=  " + GetSQLDate(oper.DATE) + ") " +
          "    AND TURN.T_FIID       = fin.T_FIID " +
          "    AND fin.T_drawingdate =  " + GetSQLDate(oper.DATE) +
          "    AND ( (TURN.T_LONGPosition != TURN.T_SHORTPosition) ) ";

  var Data = TRsbDataSet(Query);

  if( Data.MoveNext() and (Data.aa > 0  )  )
    if( MsgBoxEx("Имеются ненулевые позиции по фьючерсам, для которых наступила дата исполнения. Продолжить?", MB_YES+MB_NO, IND_YES) != IND_YES )
      return false;
    end;    
  end;
  return true;
end;

private macro ВыполнитьПроверкиНеттоСделкиПриИсполнении()
  var Query = " SELECT count(DEAL.t_ID) aa" + 
          "   FROM ddvdeal_dbt DEAL, ddvdlturn_dbt TURN, dfideriv_dbt DV, dfininstr_dbt FI " +
          "  WHERE " + DealByOperation(oper) + " "+ 
          "    AND TURN.t_DealID = DEAL.t_ID " +
          "    AND TURN.T_DATE   = ( SELECT max(t_Date)                                " +
          "                            FROM ddvdlturn_dbt turn1                         " +
          "                           WHERE turn1.t_DealID = DEAL.t_ID  " +
          "                             AND turn1.T_DATE <=  " + GetSQLDate(oper.DATE) + ") " +            
          "    AND DEAL.t_State = " + string(DVDEAL_OPEN) + " "+
          "    AND DEAL.t_Type in('B', 'S', 'D', 'G') " +
          "    AND FI.t_FIID = DEAL.t_FIID " +
          "    AND DV.t_FIID = DEAL.t_FIID " +
          "    AND fi.T_drawingdate =  " + GetSQLDate(oper.DATE) +
          "    AND ( DEAL.t_Amount !=TURN.t_Execution) ";

  var Data = TRsbDataSet(Query);

  if( Data.MoveNext() and (Data.aa > 0  ) )
    if( MsgBoxEx("Имеются неисполненные фьючерсные сделки, для которых наступила дата исполнения. Продолжить?", MB_YES+MB_NO, IND_YES) != IND_YES )
      return false;
    end;    
  end;
  return true;
end;

/*private macro ВыполнитьВУ_МаржиПремииПоСделкам()
  var Query, cmd, Data, FD_Deal, Bonus = $0, Curr = -1, ВидРО = 0, IsOut = false, NRec = 0;
  var Count:integer = 0;

  Query = " SELECT DEAL.t_ID, TURN.t_Margin  /*, DEAL.t_PositionBonus Bonus */  " +
          "   FROM ddvdeal_dbt DEAL, ddvdlturn_dbt TURN " +
          "  WHERE " + DLTurnByOperationDate(oper) +
          "    AND DEAL.t_Date = " + GetSQLDate(oper.Date) +
          "    AND DEAL.t_Type in('B', 'S', 'D', 'G') " +
          "    AND (TURN.t_Margin != 0 /*or DEAL.t_PositionBonus != 0*/)"; //TEG 25.03.19 мы обрабатываем только вармаржу

  cmd = DL_RSDCommand(Query);
  NRec = cmd.GetCount();

  if( NRec > 0)
    Data = cmd.execute();
    Count = 0;
    InitProgress( NRec, "Выполнение проводок по учету вар. маржи и премий по сделкам", "Выполнение..." );
    
    while( Data.MoveNext() )

       FD_Deal = DVFirstDocDeal(DL_DVDEAL, Data.ID);
      /* Bonus = FD_Deal.Deal.rec.PositionBonus;
       if( not FD_Deal.IsBuy() )
          Bonus = -Bonus;
       end;
     */
       Curr = FD_Deal.FI.rec.ParentFI;
    
       UseProgress( Count = Count + 1 );
    
       if( Bonus != $0 )
          ВидРО = 29;
          IsOut = iif(Bonus > $0, false, true);
          if( not ПроводкаПоКатегориямУчета( FD_Deal, 
                                             FD_Deal.ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut ), 
                                             FD_Deal.ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut ),
                                             oper.Date,
                                             21,
                                             Curr,
                                             abs(Bonus),
                                             Docum,
                                             INPCARRY,
                                             "",
                                             "",
                                             FD_Deal.ВУ_ОснованиеПроводки(ВидРО,IsOut),
                                             0,
                                             null, 
                                             null,
                                             Curr, Curr,
                                             null, null, NULL, null,
                                             true,
                                             ВидРО
                                           ) )
             return false;
          end;
       end;
    
       if( Data.Margin != $0 )
          ВидРО = 28;
          IsOut = iif(Data.Margin > $0, false, true);
          if( not ПроводкаПоКатегориямУчета( FD_Deal, 
                                             FD_Deal.ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut ), 
                                             FD_Deal.ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut ),
                                             oper.Date,
                                             21,
                                             Curr,
                                             abs(Data.Margin),
                                             Docum,
                                             INPCARRY,
                                             "",
                                             "",
                                             FD_Deal.ВУ_ОснованиеПроводки(ВидРО,IsOut),
                                             0,
                                             null, 
                                             null,
                                             Curr, Curr,
                                             null, null, NULL, null,
                                             true,
                                             ВидРО
                                           ) )
             return false;
          end;
       end;
    end;
    RemProgress();
  end;

  /*Учет вар. маржи по позиции, полученной на начало дня*/
  if( not ВыполнитьПроводкиПоПозициямВУ(true) )
     return false;
  end;

  return true;
end;

private macro ВыполнитьВУ_КомиссийПоСделкам()
  var Query, cmd, Data, FD_Deal, Curr = -1, ВидРО = 0, IsOut = false, NRec = 0;
  var Count:integer = 0;

  Query = " SELECT DEAL.t_ID, sfcom.t_ReceiverID, DEAL.T_CLIENT, DEAL.T_CLIENTCONTR, sfcom.t_FIID_COMM as COMFIID, sfcom.t_Code ComCode, " +
           "       COM.T_SUM S_OF, COM.T_NDS SN_OF " +
           "  FROM ddvdlcom_dbt COM, dsfcomiss_dbt sfcom, ddvdeal_dbt DEAL " +
           " WHERE " + DealByOperation(oper) +
           "   AND DEAL.t_Date = " + GetSQLDate(oper.Date) +
           "   AND DEAL.t_Type in('B', 'S', 'D', 'G','E') " +
           "   AND sfcom.t_ComissID = COM.t_ComissID " +
           "   AND COM.T_DEALID = DEAL.t_ID " +
           " ORDER BY DEAL.t_ID";

  cmd = DL_RSDCommand(Query);
  NRec = cmd.GetCount();

  if( NRec > 0)
    Data = cmd.execute();
    Count = 0;
    InitProgress( NRec, "Выполнение проводок по учету комиссий по сделкам", "Выполнение..." );
    
    while( Data.MoveNext() )

       FD_Deal = DVFirstDocDeal(DL_DVDEAL, Data.ID);
       Curr = Data.COMFIID;
    
       UseProgress( Count = Count + 1 );
    
       if( Data.ReceiverID != {OurBank} )
          ВидРО = IIF(oper.PartyKind == PTK_MARKETPLASE,9,10);
       else
          if( Data.Client > 0 )
             ВидРО = 8;
          else
             continue;
          end;
       end;

       if( not ПроводкаПоКатегориямУчета( FD_Deal, 
                                          FD_Deal.ВУ_ПолучитьКатегориюДебет( ВидРО, true ), 
                                          FD_Deal.ВУ_ПолучитьКатегориюКредит( ВидРО, true ),
                                          oper.Date,
                                          21,
                                          Curr,
                                          Data.S_OF,
                                          Docum,
                                          INPCARRY,
                                          "",
                                          "",
                                          FD_Deal.ВУ_ОснованиеПроводки(ВидРО,true),
                                          0,
                                          null, 
                                          null,
                                          Curr, Curr,
                                          null, null, NULL, null,
                                          true,
                                          ВидРО
                                        ) )
          return false;
       end;
    end;
    RemProgress();
  end;

  return true;
end;
//TEG добавил функцию которая по разовым комиссиям делает ВУ
private macro ВыполнитьПроводкиПоРазовымКомиссиямВУ()
   var Query, cmd, Data;
  var FD_Oper:DVFirstDocOper;
  var Count:integer = 0;
  var curr;
  var Operdate = FD_Oper.DVOper.rec.Date;
  var NRec;
 var ВидРО;

  record DebAcc ("account.dbt");
  FD_Oper = DVFirstDocOper( DL_DVOPER, oper );
  
  Query = " SELECT  sfcom.t_ReceiverID,   "+
                   " decode(sfc.t_partyid,1,-1,sfc.t_partyid) T_CLIENT,  "+
                  "  decode(sfc.t_partyid,1,0,COM.T_SFCONTRID) T_CLIENTCONTR,  "+
                  "  sfcom.t_FIID_COMM as COMFIID, sfcom.t_Code ComCode,  "+
                  "   COM.T_SUM S_OF, COM.T_SUMNDS SN_OF "+
                  "   FROM dsfdef_dbt COM, dsfcomiss_dbt sfcom,dsfcontr_dbt sfc   "+
                  "   WHERE   "+
                  "   sfcom.t_number = COM.t_Commnumber AND com.t_Feetype=sfcom.t_feetype AND sfc.t_id=COM.T_SFCONTRID  "+
                  "   AND COM.T_DATEFEE=  " + GetSQLDate(oper.Date) +
                 "   AND decode(sfc.t_partyid,1,-1,sfc.t_partyid) = -1 " +
                "   AND decode(sfc.t_partyid,1,1,2)= "+oper.Flag1  ;

  cmd = DL_RSDCommand(Query);
  NRec = cmd.GetCount();
if( NRec > 0)
     Data = cmd.execute();
     Count = 0;
     InitProgress( NRec, "Выполнение проводок по разовым комиссиям", "Выполнение..." );
  
   while(Data.MoveNext )
     curr=data.COMFIID;
      FD_Oper.SetParametr( MC_TYPE_PARAMETR_FIID, curr);

     UseProgress( Count = Count + 1 );

     if(abs(data.S_OF )> $0 )

        FD_Oper.ВУ_ЗаполнитьВидНомерСделки(  );
  
         if( not ПроводкаПоОперациямВУ( IIF(oper.PartyKind == PTK_MARKETPLASE,9,10), 
                                          FD_Oper, 
                                          Docum, 
                                          oper.Date, 
                                         curr ,
                                          Abs(data.S_OF),
                                           false
                                                       ) )

                return false;
            end;
       end;
    end;
  end;  

  RemProgress();
  return true;
end;


private macro СформироватьПроводкиВУ( FD )

  /*данные по позициям собираем всегда*/
  ПолучитьСуммыПоПозициям();

  if( УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_DEAL )
     if( not ВыполнитьВУ_МаржиПремииПоСделкам() )
        return false;
     end;
  else
     if( not ВыполнитьПроводкиПоПозициямВУ() )/*по марже и премии*/
        return false;
     end;
  end;

  if( ПИ_ВестиПосделочныйУчетКомиссий() )
     if( not ВыполнитьВУ_КомиссийПоСделкам() )
        return false;
     end;
     if( not ВыполнитьПроводкиПоРазовымКомиссиямВУ() )
        return false;
     end;
  else
     if( not ВыполнитьПроводкиПоКомиссиямПоПозициямВУ() )
        return false;
     end;
  end;

  return true;
  end;*/

macro PrepMassExecuteStep()
  var doc;

  var Query =   " SELECT to_number(oper.t_DocumentID) DocID, oprtemp.t_ID_Operation, oprtemp.t_ID_Step " +
                "   FROM doprtemp_view oprtemp, doproper_dbt oper " +
                "   WHERE oper.t_ID_Operation = oprtemp.t_ID_Operation " + 
                "     AND oprtemp.t_DocKind = " + DL_DVOPER; 

  var cmd = DL_RSDCommand(Query); 
  var DataSet = cmd.Execute();
  if(DataSet.moveNext())
     ID_Operation = DataSet.ID_Operation;
     ID_Step = DataSet.ID_Step;
     oper.id = DataSet.DocID;
     getEq(oper);
  else
     return 1;
  end;

  SQL_Execute("DELETE FROM dacctrn_add_dbt WHERE T_OPERID="+ID_Operation+" AND T_STEP="+ID_Step );

  accDvdealTrnArr.size = 0;

  Docum = doc;

  var FD_Oper = DVFirstDocOper(DL_DVOPER, oper);

  DL_MassOprDocsBegin();

  if( УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_DEAL )
    if( not ВыполнитьПроверкиНеттоСделкиПриИсполнении() )
       ErrorMessage = "Ошибка при проверке нетто-остатков по сделкам";
       return ExitStep();
    end;
  else
    if( not ВыполнитьПроверкиНеттоПозицииПриИсполнении() )
       ErrorMessage = "Ошибка при проверке нетто-остатков по позициям";
       return ExitStep();
    end;
  end;

  /*if( ПИ_ВестиВнутреннийУчет() )
     if( not СформироватьПроводкиВУ(FD_Oper) )
        return ExitStep();
     end;
  end;*/

  if( (УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_POS) and (ОбнулятьИтоги() != 0) )
     if( OprNullingPositions(oper) == false )
        ErrorMessage = "Ошибка при обнулении позиций";
        return ExitStep();
     end;
  end;

  return 0;
end;

MACRO MassExecuteStep(_oper)
  var stat = 0;
  var fdOper = DVFirstDocOper(DL_DVOPER, _oper);
  DL_CalendDynMassPlanAccTrn(accTrnBatch, makeArray(
     DL_KeyPair("ObjectType",fdOper.ПолучитьКалендТип()),
     DL_KeyPair("Market",fdOper.ПолучитьКалендБиржа())
    ), fdOper.ПолучитьКалендКонтрагент());

  if( DV_MassSaveRecoilDvdealTrnLink() != 0 )
    MsgBox("Ошибка при сохранении информации о связи проводок со сделками срочного рынка");
    accDvdealTrnArr.size = 0;
    return 1;
  end;

  stat = DL_MassOprDocsExecute();

  if (stat == 0)
    var Query =   " SELECT to_number(oper.t_DocumentID) DocID, oprtemp.t_ID_Operation, oprtemp.t_ID_Step " +
                 "   FROM doprtemp_view oprtemp, doproper_dbt oper " +
                 "   WHERE oper.t_ID_Operation = oprtemp.t_ID_Operation " + 
                 "     AND oprtemp.t_DocKind = " + DL_DVOPER; 
  
    var cmd = DL_RSDCommand(Query); 
    var DataSet = cmd.Execute();
    if(DataSet.moveNext())
       ID_Operation = DataSet.ID_Operation;
       ID_Step = DataSet.ID_Step;
       oper.id = DataSet.DocID;
       getEq(oper);
    else
       return 1;
    end;
  end;

  if (stat == 0)
    if ( МассоваяОбработкаПроводок(ID_Operation, ID_Step) == false)
       stat = 1;
    else
       /*Закрытие сделок*/
       /*выполнить ХП: RSB_Derivatives.DV_CloseDeals и сохранить информацию для отката изменений*/
       if( УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_DEAL )
          if (DV_SaveMassCloseDvDeals() != 0)
             MsgBox("Ошибка при закрытии сделок");
             stat = 1;
          end;
          if (DV_MassCloseDvDeals(oper) != 0)
             MsgBox("Ошибка при закрытии сделок");
             stat = 1;
          end;
       end;
     
       /*Закрытие позиций*/
       /*выполнить ХП: RSB_Derivatives.DV_ClosePositions и сохранить информацию для отката изменений*/
       if (DV_SaveMassClosePosition() != 0)
          MsgBox("Ошибка при закрытии позиций");
          stat = 1;
       end;
       if (DV_MassClosePosition(oper) != 0)
          MsgBox("Ошибка при закрытии позиций");
          stat = 1;
       end;
    end;
  end;
  return stat;
END; 