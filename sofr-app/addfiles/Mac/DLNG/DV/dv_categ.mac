/*
$Name:        dv_categ.mac
$Module:      Производные инструменты
$Description: Классы для работы c категориями учета
*/
IMPORT RsbDataSet, CTInter, OprInter, "cb_sql.mac", "dvserv.mac", "dv_class.mac", "mccatacf.mac", "dvRepFun.mac", globals, "WLTOOLS.MAC";/*PNV*/

// Виды операций для оснований пользовательских проводок
CONST GROUND_GUARANT_MARGIN = 15;

PRIVATE RECORD empty_turn( "dvfiturn.dbt" ); /*пустая структура - используется, если запись оборотов не найдена*/

Private Macro GetFinName(Fin)
       If(fin.definition =="")
          return Fin.Name;
       else
          return fin.definition;
       end;
end;

macro PFI_isBIO(dealid)
var query = "select count(1) from dobjlink_dbt where t_groupid = 2 and t_objecttype = 145 and t_objectid = ? ";
var cmd = RSDCommand(query);
    cmd.AddParam("p_dealid", RSDBP_IN, string(dealid:o:34));
var rs = RSDRecordset(cmd, rsdval_client, rsdval_static);   
    if(rs.movenext)
      return rs.value(0);
    end; 
end;


/*PNV*/
PRIVATE MACRO StrChangeRusXSet_(AGRCODE)
     var Code = AGRCODE;
     StrChangeRusXSet(AGRCODE, Code);
     return Code;
END;
/*PNV*/

Private Macro User_GetLsin(fiid)
record avoir("avoiriss");
ПолучитьФинИн(fiid, null, avoir); 
   If(avoir.Lsin != "")
      return avoir.Lsin;
   else
      return avoir.Isin;
   end;
End;
PRIVATE MACRO DV_Get_OBJTYPE_BA_DV( FI_Kind ):integer
  var Parametr:integer = -1;

  if( FI_Kind > FIKIND_ALLFI )
     if( FI_Kind == FIKIND_CURRENCY )
        Parametr = 1; /*Валюта*/
     elif( FI_Kind == FIKIND_INDEX )
        Parametr = 2; /*Процентная ставка*/
     elif( FI_Kind == FIKIND_AVOIRISS )
        Parametr = 3; /*Ценная бумага*/
     elif( FI_Kind == FIKIND_METAL )
        Parametr = 4; /*Драг. металл*/
     elif( FI_Kind == FIKIND_ARTICLE )
        Parametr = 5; /*Другой*/
     else
        Parametr = 5; /*Другой*/
     end;
  end;

  return Parametr;
END;

CLASS (DVFirst) DVFirstDoc( DocKind, Oper )

  VAR v_FI:TRecHandler,
      v_BaseFI:TRecHandler,
      v_BaseFI_NotDV:TRecHandler,
      v_fideriv:TBFile;

  MACRO GetDoc()
  END;

  MACRO FI()
     if( v_FI == NULL )
        v_FI = TRecHandler( "fininstr.dbt" );
        if( ПолучитьФинИн( GetDoc().rec.FIID, v_FI ) != 0 )
           this.SetError( "Не найдена финансовый инструмент (FIID = " + string(GetDoc().rec.FIID) + ") " );
        end;
     end;

     return v_FI;
  END;

  MACRO BaseFI()
     if( v_BaseFI == NULL )
        v_BaseFI = TRecHandler( "fininstr.dbt" );
        if( ПолучитьФинИн( FI.rec.FaceValueFI, v_BaseFI ) != 0 )
           v_BaseFI.Clear();
        end;
     end;

     return v_BaseFI;
  END;

  /* получить базовый актив - но не ПИ, если текущий базовый актив - ПИ, то опускаемся еще на уровень ниже */
  MACRO BaseFI_NotDV()
     var query, data;
     if( v_BaseFI_NotDV == NULL )

        v_BaseFI_NotDV = TRecHandler( "fininstr.dbt" ); /* фин. инструмент */

        if( this.BaseFI.rec.FI_Kind == FIKIND_DERIVATIVE  ) /*текущий базовый актив - ПИ*/
           if( ПолучитьФинИн( this.BaseFI.rec.FaceValueFI, v_BaseFI_NotDV ) != 0 )
              v_BaseFI_NotDV.Clear();
           end;
        else
           copy( v_BaseFI_NotDV, this.BaseFI );
        end;
     end;
     return v_BaseFI_NotDV;
  END;

  MACRO fideriv()
     if( v_fideriv == NULL )
        v_fideriv = TBFile( "fideriv.dbt" );
        v_fideriv.rec.FIID = GetDoc().rec.FIID;
        if( v_fideriv.GetEQ() == false )
           v_fideriv.Clear();
        end;
     end;

     return v_fideriv;
  END;

  MACRO SourceFI( prm_FI, prm_BaseFI )

     VAR ParentFI, _FI, _BaseFI;

     if( prm_FI == null )
        _FI = this.FI;
     else
        _FI = prm_FI;
     end;
     if( prm_BaseFI == null )
        _BaseFI = this.BaseFI;
     else
        _BaseFI = prm_BaseFI;
     end;

     if( (_BaseFI.rec.FI_Kind == FIKIND_DERIVATIVE) AND (_BaseFI.rec.AvoirKind == DERIVATIVE_FUTURES) )
        ParentFI = TRecHandler( "fininstr.dbt" );
        if( ПолучитьФинИн( _BaseFI.rec.FaceValueFI, ParentFI ) == 0 )
           return SourceFI( _BaseFI, ParentFI );
        else
           return -1;
        end;
     elif( _BaseFI.rec.FI_Kind == FIKIND_INDEX )
        if( _BaseFI.rec.Settlement_Code == FIKIND_AVOIRISS )
           return _FI.rec.ParentFI; /*валюта СМШЦ*/
        elif( _BaseFI.rec.Settlement_Code == FIKIND_CREDIT )
           return NATCUR;
        else// ( (_BaseFI.rec.Settlement_Code == FIKIND_CURRENCY) or (_BaseFI.rec.Settlement_Code == FIKIND_OTHER) )
           return _BaseFI.rec.FaceValueFI;
        end;
     end;

     return _FI.rec.FaceValueFI;
  END;

  MACRO SourceFIMarginKind( prm_FI, prm_BaseFI )

     VAR ParentFI, _FI, _BaseFI;

     if( prm_FI == null )
        _FI = this.FI;
     else    
        _FI = prm_FI;
     end;
     if( prm_BaseFI == null )
        _BaseFI = this.BaseFI;
     else    
        _BaseFI = prm_BaseFI;
     end;

     if( (_BaseFI.rec.FI_Kind == FIKIND_DERIVATIVE) AND (_BaseFI.rec.AvoirKind == DERIVATIVE_FUTURES) )

        ParentFI =  TRecHandler( "fininstr.dbt" );
        if( ПолучитьФинИн( _BaseFI.rec.FaceValueFI, ParentFI ) == 0 )         
           return SourceFIMarginKind( _BaseFI, ParentFI );
        else
           return -1;            
        end;

     elif( _BaseFI.rec.FI_Kind == FIKIND_AVOIRISS )
        return 5; //Изменение курса ц/б
     elif( _BaseFI.rec.FI_Kind == FIKIND_CURRENCY )
        return 6; //Изменение валютного курса
     elif( _BaseFI.rec.FI_Kind == FIKIND_INDEX )
        if( _BaseFI.rec.Settlement_Code == FIKIND_CREDIT ) 
           return 4; //Изменение ставки процента
        elif( _BaseFI.rec.Settlement_Code == FIKIND_CURRENCY )
           return 6; //Изменение валютного курса
        elif( _BaseFI.rec.Settlement_Code == FIKIND_AVOIRISS )
           return 5; //Изменение курса ц/б
        end;
     else
        return 8; //Изменение других переменных
     end;
  END;

  PRIVATE MACRO GetContractorID()
     if( GetDoc().rec.Broker != -1 )
        return GetDoc().rec.Broker;
     end;
     return FI.rec.Issuer;
  END;

  MACRO Department():integer
     return GetDoc().rec.Department;
  END;

  /*получить РЦ ОРЦБ*/
  macro GetCentr( OperDate:Date )
     var Query, Data;
     var Flag1:integer = 0;

     if( GetDoc().rec.IsTrust == SET_CHAR )
        Flag1 = ALG_SP_MONEY_SOURCE_TRUST;
     elif( GetDoc().rec.Client > 0 )
        Flag1 = ALG_SP_MONEY_SOURCE_CLIENT;
     else
        Flag1 = ALG_SP_MONEY_SOURCE_OWN;
     end;

     Query = RSDCommand("select OPER.t_Centr from ddvoper_dbt OPER " +
                        " where OPER.T_DOCKIND = ? " +
                        "   and OPER.T_DEPARTMENT = ? " +
                        "   and OPER.T_PARTYKIND = ? " +
                        "   and OPER.t_Flag1 = ? " +
                        "   and OPER.t_GenAgrID = ? " +
                        "   and OPER.T_PARTY = (select fin1.T_ISSUER from dfininstr_dbt fin1 where fin1.t_fiid = ?) " +
                        "   and NVL((SELECT 1 " +
                        "              FROM doprkoper_dbt oprkoper " +
                        "             WHERE oprkoper.t_Kind_Operation = OPER.t_OperKind " +
                        "               AND instr(oprkoper.t_SysTypes, 'C') <= 0 " +
                        "               AND instr(oprkoper.t_SysTypes, 'S') <= 0 ),0) > 0 " +
                        "   and OPER.T_Date = (select max(t.t_Date) from ddvoper_dbt t " +
                        "                       where t.t_DocKind = OPER.T_DOCKIND " +
                        "                         and t.T_DEPARTMENT = OPER.T_DEPARTMENT " +
                        "                         and t.t_Flag1 = OPER.t_Flag1 " +
                        "                         and t.t_GenAgrID = OPER.t_GenAgrID " +
                        "                         and t.t_PARTYKIND = OPER.T_PARTYKIND " +
                        "                         and t.T_PARTY = OPER.T_PARTY " +
                        "                         and t.t_OperKind = OPER.t_OperKind " +
                        "                         and t.t_Date <= ? " +
                        "                     )"
                       );

     Query.addParam("", RSDBP_IN, DL_DVOPER);
     Query.addParam("", RSDBP_IN, GetDoc().rec.Department);
     Query.addParam("", RSDBP_IN, PTK_MARKETPLASE);
     Query.addParam("", RSDBP_IN, Flag1);
     Query.addParam("", RSDBP_IN, GetDoc().rec.GenAgrID);
     Query.addParam("", RSDBP_IN, GetDoc().rec.FIID);
     Query.addParam("", RSDBP_IN, OperDate);
     Query.execute();

     Data = TRsbDataSet(Query);

     if( Data.MoveNext() )
        return Data.Centr;
     end;

     return -1;
  end;

  /*получить сектор РЦ ОРЦБ*/
  macro GetCentrOffice( OperDate:Date )
     var Query, Data;
     var Flag1:integer = 0;

     if( GetDoc().rec.IsTrust == SET_CHAR )
        Flag1 = ALG_SP_MONEY_SOURCE_TRUST;
     elif( GetDoc().rec.Client > 0 )
        Flag1 = ALG_SP_MONEY_SOURCE_CLIENT;
     else
        Flag1 = ALG_SP_MONEY_SOURCE_OWN;
     end;

     Query = RSDCommand("select market.t_CentrOffice from ddlmarket_dbt market " +
                        " where market.t_ID = (select OPER.t_MarketSchemeID " +
                        "                        from ddvoper_dbt OPER " +
                        "                       where OPER.T_DOCKIND = ? " +
                        "                         and OPER.T_DEPARTMENT = ? " +
                        "                         and OPER.T_PARTYKIND = ? " +
                        "                         and OPER.t_Flag1 = ? " +
                        "                         and OPER.t_GenAgrID = ? " +
                        "                         and OPER.T_PARTY = (select fin1.T_ISSUER from dfininstr_dbt fin1 where fin1.t_fiid = ?) " +
                        "                         and NVL((SELECT 1 " +
                        "                                    FROM doprkoper_dbt oprkoper " +
                        "                                   WHERE oprkoper.t_Kind_Operation = OPER.t_OperKind " +
                        "                                     AND instr(oprkoper.t_SysTypes, 'C') <= 0 " +
                        "                                     AND instr(oprkoper.t_SysTypes, 'S') <= 0 ),0) > 0 " +
                        "                         and OPER.T_Date = (select max(t.t_Date) from ddvoper_dbt t " +
                        "                                             where t.t_DocKind = OPER.T_DOCKIND " +
                        "                                               and t.T_DEPARTMENT = OPER.T_DEPARTMENT " +
                        "                                               and t.t_Flag1 = OPER.t_Flag1 " +
                        "                                               and t.t_GenAgrID = OPER.t_GenAgrID " +
                        "                                               and t.t_PARTYKIND = OPER.T_PARTYKIND " +
                        "                                               and t.T_PARTY = OPER.T_PARTY " +
                        "                                               and t.t_OperKind = OPER.t_OperKind " +
                        "                                               and t.t_Date <= ? " +
                        "                                           )" +
                        "                     )"
                       );

     Query.addParam("", RSDBP_IN, DL_DVOPER);
     Query.addParam("", RSDBP_IN, GetDoc().rec.Department);
     Query.addParam("", RSDBP_IN, PTK_MARKETPLASE);
     Query.addParam("", RSDBP_IN, Flag1);
     Query.addParam("", RSDBP_IN, GetDoc().rec.GenAgrID);
     Query.addParam("", RSDBP_IN, GetDoc().rec.FIID);
     Query.addParam("", RSDBP_IN, OperDate);
     Query.execute();

     Data = TRsbDataSet(Query);

     if( Data.MoveNext() )
        return Data.CentrOffice;
     end;

     return -1;
  end;

  macro Get_OBJTYPE_BA_DV():integer
     return DV_Get_OBJTYPE_BA_DV(BaseFI_NotDV.rec.FI_Kind);
  end;

  macro Get_OBJTYPE_KIND_OPER_DV():integer
     var Parametr:integer = -1;

     if( FI.rec.AvoirKind == DERIVATIVE_FUTURES )
        Parametr = 1; /*Фьючерс*/
     elif( FI.rec.AvoirKind == DERIVATIVE_OPTION )
        Parametr = 3; /*Опцион*/
     end;

     return Parametr;
  end;

  initDVFirst();
END;

CLASS (DVFirstDoc) DVFirstDocPos( DocKind, Pos )

  VAR DVPos = TBFile( "dvfipos", "R", 0 );       

  PRIVATE VAR v_fiturnFirst:variant, /*TRecHandler делать нельзя так как GetRecord не умеет делать честный TRecHandler  */
              v_fiturnLast:variant;  /* и результат выполнения GetRecord нельзя скопировать в TRecHandler.              */
                                     /* GetRecord на самом деле возвращает  "псевдозапись" к полям которой нужно        */
                                     /*  обращаться без "rec"                                                           */

  MACRO GetDoc()
     return DVPos;
  END;

  MACRO IsTrust()
     if( DVPos.rec.IsTrust == SET_CHAR )
        return true;
     end;
     return false;
  END;

  MACRO IsCurrMarket():bool
     return ((DVPos.rec.ClientContr > 0) and (GetSfContr(DVPos.rec.ClientContr).rec.ServKind == PTSK_CM));
  END;

  MACRO ОснованиеПереносаПоСрокам( Требование:bool ):string
     var Ground:string = "";
     if( Требование )
        Ground = "Перенос требований по ПИ: " + FI.rec.FI_Code;
     else
        Ground = "Перенос обязательств по ПИ: " + FI.rec.FI_Code;
     end;

     return Ground;
  END;

  MACRO GetFITurnOnDate( Turn:@variant, MaxOrMin:STRING, FindDate:DATE )
     VAR TurnDS, Query;

     Query =
       "SELECT * FROM ddvfiturn_dbt turn " +
       " WHERE turn.t_IsTrust    = "+ IIF( DVPos.rec.IsTrust == SET_CHAR, "'X'","chr(0)" )    + " AND " +
       "       turn.t_FIID       = "+ string(DVPos.rec.FIID)       + " AND " +
       "       turn.t_Client     = "+ string(DVPos.rec.Client)     + " AND " +
       "       turn.t_Department = "+ string(DVPos.rec.Department) + " AND " +
       "       turn.t_Broker     = "+ string(DVPos.rec.Broker)     + " AND " +
       "       turn.T_GenAgrID   = "+ string(DVPos.rec.GenAgrID)   + " AND " +
       "       turn.t_Date       = ( SELECT "+MaxOrMin+"(turn_1.t_Date) "   +
       "                               FROM ddvfiturn_dbt turn_1 " +
       "                              WHERE turn_1.t_IsTrust    = turn.t_IsTrust    AND "+
       "                                    turn_1.t_FIID       = turn.t_FIID       AND "+
       "                                    turn_1.t_Client     = turn.t_Client     AND "+
       "                                    turn_1.t_Department = turn.t_Department AND "+
       "                                    turn_1.t_Broker     = turn.t_Broker     AND " +
       "                                    turn_1.t_GenAgrID   = turn.t_GenAgrID     ";
     if( FindDate != NULL )
        Query = Query + " AND turn_1.t_Date <= "+ GetSQLDate(FindDate) + ")";
     else
        Query = Query + ")";
     end;  

     TurnDS = TRsbDataSet( Query );
     if( TurnDS.MoveNext() )
        Turn = TurnDS.GetRecord();
        return true;
     else
        Turn = empty_turn;
     end;
     ClearRecord( Turn );
     return false;
  end;

  MACRO FITurnLast()
     if( v_fiturnLast == NULL )
        GetFITurnOnDate( @v_fiturnLast, "MAX" );
     end;
     return v_fiturnLast;
  END;

  MACRO FITurnFirst()
     if( v_fiturnFirst == NULL )
        GetFITurnOnDate( @v_fiturnFirst, "MIN" );
     end;
     return v_fiturnFirst;
  END;

  MACRO GetContractorID()
     return this.GetContractorID();
  END;

  /************************************************/
  /* инициализация массива параметров              */
  /************************************************/
  MACRO InitParmArray()
      ParmA[MC_TYPE_PARAMETR_DOCKIND]    = this.Kind;
      ParmA[MC_TYPE_PARAMETR_DOCID]      = this.ID;
  END;

  MACRO InitFIRoleBArray()
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIDOC; 
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BA;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_SETTL_AGENT; /*Расчеты с посредником*/
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FUTURES;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPTION;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_PRICEFI;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BA_NOTDV;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_ACTIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_PASSIVE;
  END;

  /*Позиция длинная */  
  MACRO PositionLong()
     return ( FITurnLast.LONGPOSITION >= FITurnLast.SHORTPOSITION );
  END;

  /*Позиция короткая*/
  MACRO PositionShort()
     return (PositionLong() == false);
  END;

  /*Старая позиция длинная*/
  MACRO OldPositionLong()
     return ( (FITurnLast.LONGPOSITION  - FITurnLast.BUY + FITurnLast.LONGEXECUTION) >= (FITurnLast.SHORTPOSITION - FITurnLast.SALE + FITurnLast.SHORTEXECUTION) );
  END;

  /*Старая позиция короткая*/
  MACRO OldPositionShort()
     return (OldPositionLong() == false);
  END;

  /*Позиция по фьючерсу*/
  MACRO PositionByFutures()
     return (FI.rec.AvoirKind == DERIVATIVE_FUTURES);
  END;

  /*Позиция по опциону*/
  MACRO PositionByOption()
     return (FI.rec.AvoirKind == DERIVATIVE_OPTION);
  END;

  MACRO isMargin()
     return ( (FI.rec.AvoirKind == DERIVATIVE_FUTURES) or (fideriv.rec.IsMarginOp == SET_CHAR) );
  END;

  /*Позиция по опциону call*/
  MACRO PositionByOptionCALL()
     return (fideriv.rec.OptionType == OPTIONKIND_CALL);
  END;

  /*Позиция по опциону put*/
  MACRO PositionByOptionPUT()
     return (fideriv.rec.OptionType == OPTIONKIND_PUT);
  END;

  MACRO УсловиеПоСтороне():bool
     return ( ( PositionLong() AND (PositionByFutures() OR PositionByOptionCALL()) ) OR
              ( PositionShort() AND PositionByOptionPUT() ) );
  END;

  MACRO СтароеУсловиеПоСтороне():bool
     return ( ( OldPositionLong() AND (PositionByFutures() OR PositionByOptionCALL()) ) OR
              ( OldPositionShort() AND PositionByOptionPUT() ) );
  END;

  MACRO УсловиеПоСторонеПоРасчЦене():bool
     return ( ( PositionLong() AND (PositionByFutures() OR PositionByOptionPUT()) ) OR
              ( PositionShort() AND PositionByOptionCALL() ) );
  END;

  MACRO СтароеУсловиеПоСторонеПоРасчЦене():bool
     return ( ( OldPositionLong() AND (PositionByFutures() OR PositionByOptionPUT()) ) OR
              ( OldPositionShort() AND PositionByOptionCALL() ) );
  END;

  macro IsSector():bool
     return (DVPos.rec.Sector == SET_CHAR);
  end;

  MACRO GetBasisFIRole( FIRole, NoMsgErr )
     var i = 0;

     if( (FIRole == null) OR (FIRole == FIROLE_UNDEF) OR (FIRole == FIROLE_FIDOC) )
        return FIROLE_FIDOC;
     end;

     while( i < FIRoleBArray.Size )
        if( FIRoleBArray[i] == FIRole )
           return FIRole;
        end;
        i = i + 1;
     end;

     if( FIRole == FIROLE_SETTL_AGENT )
        return FIROLE_SETTL_AGENT;
     end;

     if( (NoMsgErr == null) OR (NoMsgErr == false) )      
        this.SetError( "Неверно задана роль ФИ", false );      
     end;

     return FIROLE_UNDEF;
  END;

  /*конструктор */
  MACRO Construct( DocKind, Pos ) 
     if( ValType( Pos ) == V_INTEGER ) /*Id позиции*/
        this.DVPos.rec.ID = Pos;

        if( not this.DVPos.GetEQ() )
           this.SetError( "Не найдена позиция ПИ (Id =" + string(Pos) + ")" );
        end;
     elif( (ValType(Pos) == V_STRUC) OR (ValType(Pos) == V_FILE) OR (ValType(Pos) == V_GENOBJ) )
        copy( DVPos, Pos );
     else
        this.SetError( "Неверные параметры инициализации объекта" );
     end; 

     this.ID   = DVPos.rec.Id;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  PRIVATE MACRO GetMC_TYPE_PARAMETR_FIID( FIRole )

     VAR Parametr = null;

     if( (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_PRICEFI) or (FIRole == FIROLE_FUTURES) or (FIRole == FIROLE_OPTION) )
        Parametr = FI.rec.FIID;
     elif( FIRole == FIROLE_BA_NOTDV )
        Parametr = BaseFI_NotDV.rec.FIID;
     elif( FIRole == FIROLE_BA )
        Parametr = FI.rec.FaceValueFI;
     elif( (FIRole == FIROLE_CORACC_ACTIVE) or (FIRole == FIROLE_CORACC_PASSIVE) )
        Parametr = GetFIIDForCorAccNum();
     end;

     return Parametr;
  END;

  /*Получить НЕкэшируемый параметр (меняющийся в зависимости от контекста вызова GetParametr())
    например для разных FIRole */
  PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole )

     VAR Rec_FI = TRecHandler( "fininstr.dbt" );
     VAR FICodeInAcc = "", ContractorCode = "", Contractor;
     VAR Parametr = null;
      
     /*фининструмент*/
     if( ParmKind == MC_TYPE_PARAMETR_FIID )

        Parametr = GetMC_TYPE_PARAMETR_FIID( FIRole );

     /*валюта номинала для ценных бумаг */
     elif( ParmKind == MC_TYPE_PARAMETR_CURRENCY ) 

        Parametr = GetMC_TYPE_PARAMETR_FIID( FIRole );
        if( Parametr != -1 )
           if( ПолучитьФинИн( Parametr, Rec_FI ) == 0 )
              if( Rec_FI.rec.FI_Kind == FIKIND_AVOIRISS ) 
                 Parametr = Rec_FI.rec.FaceValueFI;
              end;
           end;
        end;

     elif( ParmKind == MC_TYPE_PARAMETR_NUMBER )
        /*Код "НННННН" документа по позиции определяется следующим образом:
          - первые две позиции - код субъекта из параметра "Контрагент" вида "Код для срочных контрактов"
          - остальные позиции - код ФИ для л/с (то же что и VVVV)*/
        Contractor = GetContractorID();

        if( Contractor != -1 )
           ContractorCode = ПолучитьКодСубъекта( Contractor, PTCK_CONTRACT );
        end;

        if( FI.rec.CodeInAccount != "")
           FICodeInAcc = FI.rec.CodeInAccount;
        else
           FICodeInAcc = FI.rec.FI_Code;
        end;
        Parametr = LZ_acc( ContractorCode, 2, false ) + LZ_acc( FICodeInAcc, 4, false );
     elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
        if( FIRole == FIROLE_SETTL_AGENT )
           if( DVPos.rec.Broker != -1 )
              Parametr = DVPos.rec.Broker;
           else
              Parametr = GetCentr(OperDate);
           end;
        elif( FIRole == FIROLE_FIDOC )
           Parametr = GetContractorID();          
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
        if( FIRole == FIROLE_SETTL_AGENT )
           if( DVPos.rec.Broker == -1 )
              Parametr = GetCentr(OperDate);
           else
              Parametr = 0;
           end;
        else
           Parametr = 0;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
        if( FIRole == FIROLE_SETTL_AGENT )
           if( DVPos.rec.Broker == -1 )
              Parametr = GetCentrOffice(OperDate);
           else
              Parametr = 0;
           end;
        else
           Parametr = 0;
        end;
     end;

     return Parametr;
  END;  

  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null, InCache;

     if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
        return ParmA[ParmKind];
     end;
     /*пробуем определить значение среди некэшируемых параметров*/     
     Parametr = GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole );

     /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
     if( Parametr == null ) 
       InCache = true;

       /*кэшируемые параметры - эти параметры НЕ меняются после создания объекта класса, поэтому их можно занести в кэш*/
       if( ParmKind == MC_TYPE_PARAMETR_DEPARTMENT )
          Parametr = DVPos.rec.Department;
       elif( ParmKind == MC_TYPE_PARAMETR_BEGDATE )
          Parametr = date(FITurnFirst.Date);
       elif( ParmKind == MC_TYPE_PARAMETR_FINDATE)/* дата базовая*/
          Parametr = FI.rec.DrawingDate;
       /*контрагент*/ 
       elif( ParmKind == MC_TYPE_PARAMETR_CONTRACTOR )
          Parametr = GetContractorID();
       /*контрагент*/ 
       elif( ParmKind == MC_TYPE_PARAMETR_PARTY )
          Parametr = GetContractorID();
       elif( ParmKind == MC_TYPE_PARAMETR_OWNER )
          if( DVPos.rec.Client != -1)
              Parametr = DVPos.rec.Client;
          else
              Parametr = {OurBank};
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_CONTR_CLIENT ) 
          if( DVPos.rec.Client != -1)
              Parametr = DVPos.rec.ClientContr;
          end;
       else
          InCache = false;
          Parametr = -1;
       end;

       if( InCache == true )
          ParmA[ParmKind] = Parametr;
       end;
     end;

     return Parametr;
  END;
  
  /*  получение параметров шаблонов для категорий учета       */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )         

     var Parametr:variant;
     var FindAttr:bool;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );           

     if( Parametr == -1 )
        /*Вид актива требований\Вид актива обязательств\Вид актива*/
        if( ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_REQ)  ) OR
            ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_COMM) ) OR
            ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK) ) )
           if( (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_BA) )
              if( BaseFI().rec.FI_Kind == FIKIND_AVOIRISS )
                 Parametr = 3; /*Ценные бумаги*/
              elif( BaseFI().rec.FI_Kind == FIKIND_METAL )
                 Parametr = 2; /*Драг. металл*/
              elif( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
                 Parametr = 1; /*Денежные средства*/
              elif( BaseFI().rec.FI_Kind == FIKIND_DERIVATIVE )
                 Parametr = 6; /*Фьючерс*/
              elif( BaseFI().rec.FI_Kind == FIKIND_ARTICLE )
                 Parametr = 7; /*Артикул*/   
              elif( BaseFI().rec.FI_Kind == FIKIND_INDEX )
                if(BaseFI().rec.Settlement_Code == FI_INDEX_AVOIRISS)
                 Parametr = 8; /*Индекс*/
              else
                 Parametr = 1; /*Денежные средства*/
              end;
              else
                 Parametr = 1; /*Денежные средства*/
              end;
           elif( FIRole == FIROLE_BA_NOTDV )
              if( FI.rec.Settlement_Code == DVSETTLEMET_STATE )
                 Parametr = 3;/*Ценные бумаги*/
              else
                 Parametr = 1; /*по умолчанию - Денежные средства*/
              end;
           elif( FIRole == FIROLE_PRICEFI )
              Parametr = 1;/*Денежные средства*/
           elif( (FIRole == FIROLE_FUTURES) or (FIRole == FIROLE_OPTION) )
              Parametr = 6;/*Фьючерс*/
           end;
        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_FI_KIND) )
           if( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
              Parametr = 1; /*Денежные средства*/
           elif( BaseFI().rec.FI_Kind == FIKIND_METAL )
              Parametr = 2; /*Драгоценные металлы*/
           end;
        elif( ObjectID == OBJTYPE_KINDRESERV )
           Parametr = 7; /*по срочным сделкам*/
        elif( Classificator == LLCLASS_KIND_MARG_FUTURES )
           Parametr = SourceFIMarginKind( this.FI, this.BaseFI );
        /*вид субъекта - категория эмитента доходы\расходы*/
        elif( (Classificator == LLCLASS_KINDSUBJ_ISSUER_DR) OR (Classificator == LLCLASS_KINDSUBJ_SHARE_ISSUER_DR) )
           Parametr = MC_GetKindIssuerDR( this.BaseFI.rec.Issuer, false );
        elif( ObjectID == OBJTYPE_KINDCB )
           if( Classificator == LLCLASS_KINDCB_DVKIND )
              if( FIRole == FIROLE_FUTURES )
                 Parametr = 100; /*Фьючерс*/ 
              elif( FIRole == FIROLE_OPTION )
                 Parametr = 101; /*Опцион*/ 
              end;
           end;
        elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           Parametr = Get_OBJTYPE_BA_DV();
        elif( ObjectID == OBJTYPE_KIND_OPER_DV )
           Parametr = Get_OBJTYPE_KIND_OPER_DV();
        end; 
     end;
     return Parametr;
  END;

    MACRO ВУ_ПолучитьРольФИ( ВидРО, DebCred )
      var FIRole = FIROLE_UNDEF;
         
      if((ВидРО == 70) or (ВидРО == 71) or (ВидРО == 72) ) 
         FIRole = FIROLE_FIDOC;
      elif( (ВидРО == 9) or (ВидРО == 10) or (ВидРО == 28) or (ВидРО == 29) )
         FIRole = FIROLE_SETTL_AGENT;
      end;

      return FIRole;
    END;

    macro ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut:bool )
      var Категория = "";  

       if( (ВидРО == 29) or (ВидРО == 28) or (ВидРО == 9) or (ВидРО == 10) )
          if( not IsOut )
             Категория = "ДС Клиента, ВУ";
          else
             Категория = "ДС, Расч. с клиентом, ВУ";
          end;
       elif( (ВидРО == 70) or ((ВидРО == 72) and IsOut ) )
          if( DVPos.rec.Client == -1 )
             Категория = "ФО Банка, ВУ";
          else
             Категория = "ФО Клиента, ВУ";
          end;
       elif( (ВидРО == 71) or (ВидРО == 72) )
          if( DVPos.rec.Client == -1 )
             Категория = "ФО, Прч. счета банка, ВУ";
          else
             Категория = "ФО, Расч. с клиентом, ВУ";
          end;
       elif( ВидРО == 8 )
          Категория = "ДС, Расч. с клиентом, ВУ";
       end;

       return Категория;
    end;

    macro ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut:bool )
      var Категория = "";

       if( (ВидРО == 29) or (ВидРО == 28) or (ВидРО == 9) or (ВидРО == 10) )
          if( not IsOut )
             Категория = "ДС, Расч. с клиентом, ВУ";
          else
             Категория = "ДС Клиента, ВУ";
          end;
       elif( (ВидРО == 70) or ((ВидРО == 72) and IsOut ) )
          if( DVPos.rec.Client == -1 )
             Категория = "ФО, Прч. счета банка, ВУ";
          else
             Категория = "ФО, Расч. с клиентом, ВУ";
          end;
       elif( (ВидРО == 71) or (ВидРО == 72) )
          if( DVPos.rec.Client == -1 )
             Категория = "ФО Банка, ВУ";
          else
             Категория = "ФО Клиента, ВУ";
          end;
       elif( ВидРО == 8 )
          Категория = "ДС Клиента, ВУ";
       end;

       return Категория;
    end;

    macro ВУ_ОснованиеПроводки( ВидРО, IsOut:bool )
      var Ground = "";

       if( ВидРО == 28 )
          if( not IsOut )
             Ground = "Зачисление вариационной маржи";
          else
             Ground = "Списание вариационной маржи";
          end;
       elif( ВидРО == 29 )
          if( not IsOut )
             Ground = "Зачисление премий";
          else
             Ground = "Списание премий";
          end;
       elif( ВидРО == 9 )
          Ground = "Оплата комиссии бирже";
       elif( ВидРО == 10 )
          Ground = "Оплата комиссии брокеру";
       elif( ВидРО == 70 )
          Ground = "Покупка срочных контрактов";
       elif( ВидРО == 71 )
          Ground = "Продажа срочных контрактов";
       elif( ВидРО == 72 )
          if( not IsOut )
             Ground = "Исполнение длинных позиций по срочным контрактам";
          else
             Ground = "Исполнение коротких позиций по срочным контрактам";
          end;
       elif( ВидРО == 8 )
          Ground = "Оплата комиссии банку";
       end;

       return Ground;
    end;

  initDVFirstDoc();
  this.Construct( DocKind, Pos );
END;

/**************************************************************************/
/*  класс - первичные документы для работы с категориями учета по операциям расчетов по ПИ*/ 
/**************************************************************************/
CLASS (DVFirst) DVFirstDocOper( DocKind, Oper )
  VAR DVOper = TBFile( "dvoper", "R", 0 );       
  var DealKindInner = DL_DVOPER, DealCodeInner = "";/* номер и вид сделки\операции в проводке ВУ */
  var m_BankID:integer = -1;
  var m_FI_Kind:integer = -1;
  private var dlmarket_other = TRecHandler("dlmarket.dbt" ); /*схема расчета для другого клирингового счета*/

  /************************************************/
  /* инициализация массива параметров              */
  /************************************************/
  MACRO InitParmArray()
      ParmA[MC_TYPE_PARAMETR_DOCKIND]    = this.Kind;
      ParmA[MC_TYPE_PARAMETR_DOCID]      = this.ID;
  END;

  MACRO IsTrust()
     return (DVOper.rec.Flag1 == ALG_SP_MONEY_SOURCE_TRUST);
  END;

  MACRO IsCurrMarket():bool
     return false;
  END;

  MACRO InitFIRoleBArray()
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIDOC; 
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FUTURES;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPTION;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BANKROLL_BANK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_SETTL_AGENT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_ORCB_OTHCLIRACC;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_NAT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_FRG;
  END;

  /*MACRO GetMarketSchemeID():INTEGER
     return DVOper.rec.MarketSchemeID;
  END;*/

  MACRO IsClient():BOOL
     return (DVOper.rec.Flag1 == ALG_SP_MONEY_SOURCE_CLIENT);
  END;

  MACRO GetBasisFIRole( FIRole, NoMsgErr )
     var i = 0;

     if( (FIRole == null) OR (FIRole == FIROLE_UNDEF) OR (FIRole == FIROLE_FIDOC) )
        return FIROLE_FIDOC;
     end;

     while( i < FIRoleBArray.Size )
        if( FIRoleBArray[i] == FIRole )
           return FIRole;
        end;
        i = i + 1;
     end;

     if( (NoMsgErr == null) OR (NoMsgErr == false) )      
        this.SetError( "Неверно задана роль ФИ", false );      
     end;
     return FIROLE_UNDEF;
  END;

  /*конструктор */
  MACRO Construct( DocKind, Oper ) 
     if( ValType( Oper ) == V_INTEGER ) /*Id позиции*/
        this.DVOper.rec.ID = Oper;

        if( not this.DVOper.GetEQ() ) 
           this.SetError( "Не найдена операция по ПИ (Id =" + string(Oper) + ")" );
        end;
     elif( (ValType(Oper) == V_STRUC) OR (ValType(Oper) == V_FILE) OR (ValType(Oper) == V_GENOBJ) )
        copy( DVOper, Oper );
     else
        this.SetError( "Неверные параметры инициализации объекта" );        
     end; 

     this.ID   = DVOper.rec.Id;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  MACRO GetContractorID()
     return this.DVOper.rec.Party;
  END;

  macro ClientID():integer
     return -1;
  end;

  macro ClientContrID():integer
     return -1;
  end;

  macro BrokerID():integer
     return -1;
  end;

  macro BrokerContrID():integer
     return -1;
  end;

  macro Kind_Operation():integer
     return DVOper.rec.OperKind;
  end;

  macro ПолучитьКалендВалютуВидаДаты(НомерДаты):integer
    return -1;
  end;

  macro ПолучитьКалендКонтрагент()
    return this.DVOper.rec.Party;
  end;

  macro ПолучитьКалендТип():integer
    return DL_CALLNK_MARKET;
  end;

  macro ПолучитьКалендБиржа()
    return IIF(this.DVOper.rec.PartyKind == PTK_MARKETPLASE,ПолучитьКалендКонтрагент(),0);
  end;

  macro ПолучитьКалендСвязанный(dayType):integer
    var dTp = 0;
    if (ValType(dayType) == V_INTEGER)
      dTp = dayType;
    end;
    return DL_GetCalendByDynParam(158,makeArray(
        DL_KeyPair("Object",DL_CalendGetOperNameByKind(Kind_Operation())),
        DL_KeyPair("ObjectType",ПолучитьКалендТип()),
        DL_KeyPair("Market",ПолучитьКалендБиржа()),
        DL_KeyPair("DayType",dTp),
        DL_KeyPair("MarketPlace", iif(this.НаВалютномРынке(),DL_CALLNK_MARKETPLACE_CUR,DL_CALLNK_MARKETPLACE_SPFI))
      )
    );
  end;

  /*Получить НЕкэшируемый параметр (меняющийся в зависимости от контекста вызова GetParametr())
    например для разных FIRole */
  PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null;
     /*контрагент*/ 
     if( ParmKind == MC_TYPE_PARAMETR_FIID )
        Parametr = DVOper.rec.FIID;
     elif( ParmKind == MC_TYPE_PARAMETR_NUMBER )
     elif( ParmKind == MC_TYPE_PARAMETR_CONTRACTOR )
        Parametr = DVOper.rec.Party;
     elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
        if( FIRole == FIROLE_BANKROLL_BANK )
           if( m_BankID > 0 )
              Parametr = m_BankID;
           else
              Parametr = this.РКЦБанкИзСПИ(ParmA[MC_TYPE_PARAMETR_FIID]); 
           end;
        elif( FIRole == FIROLE_SETTL_AGENT )
           if( ВидСубъекта( DVOper.rec.Party, PTK_MARKETPLASE ) == true )
              Parametr = DVOper.rec.Centr;
           else
              Parametr = DVOper.rec.Party;
           end;
        end;
     elif( (ParmKind == MC_TYPE_PARAMETR_BEGDATE) or
           (ParmKind == MC_TYPE_PARAMETR_FINDATE) )
        Parametr = DVOper.rec.Date;
     elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
        if( FIRole == FIROLE_ORCB_OTHCLIRACC )
           Parametr = dlmarket_other.rec.Centr;
        else
            if( ВидСубъекта( DVOper.rec.Party, PTK_MARKETPLASE ) == true )
               Parametr = DVOper.rec.Centr;
            else
               Parametr = -1;
            end;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
        if( FIRole == FIROLE_ORCB_OTHCLIRACC )
           Parametr = dlmarket_other.rec.CentrOffice;
        else
            if( ВидСубъекта( DVOper.rec.Party, PTK_MARKETPLASE ) == true )
               Parametr = IIF((DL_ЕдиныйПулОбеспеченияСобств == 1) and (not IsClient()), IIF(DVOper.rec.PartyOffice == 8, 15 , DVOper.rec.PartyOffice), DVOper.rec.PartyOffice);
            else
               Parametr = -1;
            end;
        end;
     end;

     return Parametr;
  END;  

  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null, InCache;

     if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
        return ParmA[ParmKind];
     end;
     /*пробуем определить значение среди некэшируемых параметров*/     
     Parametr = GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole );

     /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
     if( Parametr == null ) 
       InCache = true;

       /*кэшируемые параметры - эти параметры НЕ меняются после создания объекта класса, поэтому их можно занести в кэш*/
       if( ParmKind == MC_TYPE_PARAMETR_DEPARTMENT )
          Parametr = DVOper.rec.Department;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
          if( ВидСубъекта( DVOper.rec.Party, PTK_MARKETPLASE ) == true )
             Parametr = DVOper.rec.Centr;
          else
             Parametr = -1;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
          if( ВидСубъекта( DVOper.rec.Party, PTK_MARKETPLASE ) == true )
             Parametr = DVOper.rec.PartyOffice;
          else
             Parametr = -1;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_CONTRACTOR )
           Parametr = this.DVOper.rec.Party;
       elif( ParmKind == MC_TYPE_PARAMETR_PARTY )
           Parametr = this.DVOper.rec.Party;            
       elif( ParmKind == MC_TYPE_PARAMETR_OWNER )
          Parametr = {OurBank};
       elif( ParmKind == MC_TYPE_PARAMETR_CONTR_BANK ) 
          Parametr = DVOper.rec.PartyContr; 
       else
          InCache = false;
          Parametr = -1;
       end;

       if( InCache == true )
          ParmA[ParmKind] = Parametr;
       end;
     end;

     return Parametr;
  END;

  /*  получение параметров шаблонов для категорий учета       */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )         
     var Parametr;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );           

     if( Parametr == -1 )
        /*другие расходы*/
        if( ObjectID == OBJTYPE_KINDCB )
           if( Classificator == LLCLASS_KINDCB_DVKIND )
              if( FIRole == FIROLE_FUTURES )
                 Parametr = 100; /*Фьючерс*/ 
              elif( FIRole == FIROLE_OPTION )
                 Parametr = 101; /*Опцион*/ 
              end;
           end;
        elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           Parametr = DV_Get_OBJTYPE_BA_DV(m_FI_Kind);
        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK) )
           Parametr = 1; /*Денежные средства*/
        elif( (ObjectID == OBJTYPE_CUR_STOCK_MARKET_CALC) AND (Classificator == LLCLASS_CUR_STOCK_MARKET_CALC) ) /*Расчеты с валютными и фондовыми биржами*/
           Parametr = 0;
        elif(Classificator == 5021)
           Parametr = 0;
        end;
     end;

     return Parametr;
  END;

  MACRO ВУ_ЗаполнитьВидНомерСделки( DealKind:integer, DealCode:string )
     if( (DealKind != null) and (DealCode != null) and (ПечатьНомеровСделокВУ() == true ) )
        DealKindInner = DealKind;
        DealCodeInner = DealCode;
     else
        DealKindInner = DL_DVOPER;
        DealCodeInner = DVOper.rec.Code;
     end;
  END;

  MACRO ВУ_ПолучитьРольФИ( ВидРО, DebCred )
    var FIRole = FIROLE_UNDEF;
       
        if( DebCred == true)
            if((ВидРО == 4) or (ВидРО == 5)) 
                FIRole = FIROLE_BANKROLL_BANK;    
            elif((ВидРО == 2) or (ВидРО == 3) or (ВидРО == 9) or (ВидРО == 10) or (ВидРО == 28) or (ВидРО == 29) )  
                FIRole = FIROLE_SETTL_AGENT;    
            end;
        elif( DebCred == false)
            if((ВидРО == 4) or (ВидРО == 5) or (ВидРО == 9) or (ВидРО == 10) or (ВидРО == 28) or (ВидРО == 29) ) 
                FIRole = FIROLE_SETTL_AGENT;
            elif((ВидРО == 2) or (ВидРО == 3)) 
                FIRole = FIROLE_BANKROLL_BANK;
            end;
        end;
     return FIRole;
  END;

  macro ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut:bool )
    var Категория = "";  

     if( (ВидРО == 4) or (ВидРО == 5) )
        Категория = "ДС Банка, ВУ";
     elif( ВидРО == 2 )
        Категория = "ДС в РЦ ОРЦБ, ВУ";
     elif( ВидРО == 3 )
        Категория = "ДС у брокера, ВУ";
     elif( (ВидРО == 9) or (ВидРО == 10)  )
        Категория = "ДС, Прч. счета банка, ВУ";
     elif( (ВидРО == 29) or (ВидРО == 28)  )
        if( not IsOut )
           if( this.DVOper.rec.PartyKind == PTK_BROKER )
              Категория = "ДС у брокера, ВУ";
           else
              Категория = "ДС в РЦ ОРЦБ, ВУ";
           end;
        else
           Категория = "ДС, Прч. счета банка, ВУ";
        end;
     end;

     return Категория;
  end;

  macro ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut:bool )
    var Категория = "";

     if( ВидРО == 4 )
        Категория = "ДС в РЦ ОРЦБ, ВУ";
     elif( ВидРО == 5 )
        Категория = "ДС у брокера, ВУ";
     elif( (ВидРО == 2) or (ВидРО == 3) )
        Категория = "ДС Банка, ВУ";
     elif( (ВидРО == 9) or (ВидРО == 10) )
        if( this.DVOper.rec.PartyKind == PTK_BROKER )
           Категория = "ДС у брокера, ВУ";
        else
           Категория = "ДС в РЦ ОРЦБ, ВУ";
        end;
     elif( (ВидРО == 29) or (ВидРО == 28)  )
        if( not IsOut )
           Категория = "ДС, Прч. счета банка, ВУ";
        else
           if( this.DVOper.rec.PartyKind == PTK_BROKER )
              Категория = "ДС у брокера, ВУ";
           else
              Категория = "ДС в РЦ ОРЦБ, ВУ";
           end;
        end;
     end;

     return Категория;
  end;

  macro ВУ_ОснованиеПроводки( ВидРО, IsOut:bool )
    var Ground = "";

     if( (ВидРО == 1) and (this.DVOper.rec.PartyKind == PTK_MARKETPLASE) )
        if( not IsOut )
           Ground = "Перевод средств клиента на биржу";
        else
           Ground = "Вывод средств клиента с биржи";
        end;
     elif( (ВидРО == 1) and (this.DVOper.rec.PartyKind == PTK_BROKER) )
        if( not IsOut )
           Ground = "Перевод средств клиента брокеру";
        else
           Ground = "Перевод средств от брокера";
        end;
     elif( ВидРО == 4 )
        Ground = "Возврат средств с торгового счета"; 
     elif( ВидРО == 5 )
        Ground = "Возврат средств от брокера";
     elif( ВидРО == 2 )
        Ground = "Перевод средств на торговый счет "; 
     elif( ВидРО == 3 )
        Ground = "Перевод средств брокеру";
     elif( ВидРО == 28 )
        if( not IsOut )
           Ground = "Зачисление вариационной маржи";
        else
           Ground = "Списание вариационной маржи";
        end;
     elif( ВидРО == 29 )
        if( not IsOut )
           Ground = "Зачисление премий";
        else
           Ground = "Списание премий";
        end;
     elif( ВидРО == 9 )
        Ground = "Оплата комиссии бирже";
     elif( ВидРО == 10 )
        Ground = "Оплата комиссии брокеру";
     end;

     return Ground;
  end;

  macro SetBankID( BankID:integer )
     m_BankID = BankID;
  end;

  macro SetFI_Kind( FI_Kind:integer )
     m_FI_Kind = FI_Kind;
  end;

  MACRO SetDlMarketOther(parm1)
     dlmarket_other = TRecHandler("dlmarket.dbt" ); /*схема расчета для другого клирингового счета*/
  
     if ( ValType(parm1)==V_INTEGER )
         if( FindDLMARKET(parm1,dlmarket_other) != 0 )
            this.SetError( "Не найдена схема расчетов для определения другого клирингового счета." );
         end;
     else
        /*Конструктор из структур*/
        if( (ValType(parm1)==V_STRUC) OR (ValType(parm1)==V_FILE) OR (ValType(parm1) == V_GENOBJ) )
            copy ( dlmarket_other, parm1 );
        else
           this.SetError( "Неверные параметры определения другого клирингового счета." );        
        end; 
     end;
  END;

  MACRO GetMarketSchemeIDOther()
     return dlmarket_other.rec.ID;
  END;

  MACRO GetMarketSchemeCentrOther()
     return dlmarket_other.rec.Centr;
  END;

  MACRO GetMarketSchemeCentrOfficeOther()
     return dlmarket_other.rec.CentrOffice;
  END;

  MACRO ЕстьСуммыПеревода():BOOL
     var RetVal:bool = false;
     var Query, Data;

     Query = RSDCommand( " SELECT count(1) cnt " +
                         "   FROM ddl_value_dbt dlvalue " +
                         "  WHERE dlvalue.t_DocKind = ? " +
                         "    AND dlvalue.t_DocID   = ? " );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Kind);
     Query.addParam("", RSDBP_IN, this.ID);
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() AND (Data.cnt > 0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO ЕстьСуммыГарантийногоОбеспечения():BOOL
     var RetVal:bool = false;
     var Query, Data;

     Query = RSDCommand( " SELECT count(1) cnt " +
                         "   FROM ddl_value_dbt dlvalue " +
                         "  WHERE dlvalue.t_DocKind = ? " +
                         "    AND dlvalue.t_DocID   = ? " +
                         "    AND dlvalue.t_Kind in(?, ?) " +
                         "    AND dlvalue.t_ID_Operation = 0 " +
                         "    AND dlvalue.t_ID_Step      = 0 " );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Kind);
     Query.addParam("", RSDBP_IN, this.ID);
     Query.addParam("", RSDBP_IN, ALG_DV_TYPE_CALC_PAYMENT_GUARANTEE);
     Query.addParam("", RSDBP_IN, ALG_DV_TYPE_CALC_REFUND_GUARANTEE);
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() AND (Data.cnt > 0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO ЕстьСуммыПереводаНаКлиринговыйСчет():BOOL
     var RetVal:bool = false;
     var Query, Data;

     Query = RSDCommand( " SELECT count(1) cnt " +
                         "   FROM ddl_value_dbt dlvalue " +
                         "  WHERE dlvalue.t_DocKind = ? " +
                         "    AND dlvalue.t_DocID   = ? " +
                         "    AND dlvalue.t_Kind    = ? " +
                         "    AND dlvalue.t_ID_Operation = 0 " +
                         "    AND dlvalue.t_ID_Step      = 0 " );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Kind);
     Query.addParam("", RSDBP_IN, this.ID);
     Query.addParam("", RSDBP_IN, ALG_DV_TYPE_CALC_ADD_CLEARING);
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() AND (Data.cnt > 0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO НаВалютномРынке()
     return DV_OperIsCur(DvOper.rec.OperKind);
  END;

  MACRO НаРынкеСПФИ()
     return DV_OperIsSPFI(DvOper.rec.OperKind);
  END;

  MACRO GetMarketKind()
     return iif( НаВалютномРынке(), DL_MARKETKIND_SETTLE_CURRENCY, DL_MARKETKIND_SETTLE_SPFIMARKET );
  END;
/*TEG 26.06.19*/
  MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)

  if( not CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate) )
       return false;
    end;
   //TEG 25.06.19 ролевая модель   
   /* Определяем конечного операциониста для Счета */
     Account.rec.Oper = GetMainOperInGroup(this.kind,DVOPER.rec.operkind);
 
     if (Account.rec.Oper <= 0)
         Account.rec.Oper = {Oper};
     end;
    return true;
  END;

  initDVFirst();
  this.Construct(DocKind, Oper);
END;
/**************************************************************************/
/*  класс - первичные документы для работы с категориями учета            */ 
/*  по договору обслуживания                                              */
/**************************************************************************/
CLASS (DVFirst) DVFirstDocContract( DocKind, Contract )

  var Contr = TBfile("sfcontr.dbt");
  var m_FI_Kind:integer = -1;
  private var m_BankID:integer = -1;

  /* инициализация массива параметров              */
  PRIVATE MACRO InitParmArray
      ParmA[MC_TYPE_PARAMETR_FIID]        = 0;
      ParmA[MC_TYPE_PARAMETR_PAYCURRENCY] = 0;
      ParmA[MC_TYPE_PARAMETR_CURRENCY]    = 0;
      ParmA[MC_TYPE_PARAMETR_MARKET_PLACE]= 0;
      ParmA[MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE]= 0;

      ParmA[MC_TYPE_PARAMETR_PARTY]        = Contr.rec.PartyID;  /*так как нам нужен при оплате комиссии счет для контрагента (плательщика комиссии) по +КВ,ц/б */
      ParmA[MC_TYPE_PARAMETR_CLIENT]       = Contr.rec.PartyID;
      ParmA[MC_TYPE_PARAMETR_OWNER]        = Contr.rec.PartyID;
      ParmA[MC_TYPE_PARAMETR_DOCKIND]      = this.Kind;
      ParmA[MC_TYPE_PARAMETR_DOCID]        = this.ID;
      ParmA[MC_TYPE_PARAMETR_CONTR_CLIENT] = this.ID;
      ParmA[MC_TYPE_PARAMETR_CONTR_BANK]   = this.ID;
      ParmA[MC_TYPE_PARAMETR_DEPARTMENT]   = {OperDprt};
  END;

  MACRO InitFIRoleBArray
      FIRoleBArray[FIRoleBArray.Size] = FIROLE_BANKROLL_BANK;
      FIRoleBArray[FIRoleBArray.Size] = FIROLE_SETTL_AGENT;
      FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIREQ;
      FIRoleBArray[FIRoleBArray.Size] = FIROLE_FICOM;
  END;

  /*Получить параметры                            */
  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )
    VAR Parametr = ParmA[ParmKind];

    if( Parametr == null ) 
       if( ParmKind == MC_TYPE_PARAMETR_CONTRACTOR )  /*контрактор из договора*/
          Parametr = Contr.rec.ContractorID;            
       elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
          if( FIRole == FIROLE_BANKROLL_BANK )
             if( m_BankID > 0 )
                Parametr = m_BankID;
             else
                Parametr = this.РКЦБанкИзСПИ(ParmA[MC_TYPE_PARAMETR_FIID]); 
             end;
          else
          Parametr = {OurBank};
          end;
       else
          Parametr = -1;  
       end; 
    end;
    return Parametr;
  END;

  /*  получение параметров шаблонов для категорий учета       */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )         
     var Parametr;

     FIRole   = GetBasisFIRole(FIRole);
     Parametr = GetParametrTemplate(ObjectID, Classificator, OperDate, FIRole);

     if( Parametr == -1 )
        if( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           Parametr = DV_Get_OBJTYPE_BA_DV(m_FI_Kind);
        end;
     end;

     return Parametr;
  END;

  /*конструктор класса                            */
  MACRO Construct( DocKind, _Contr ) 

     if( ValType( _Contr ) == V_INTEGER ) /*Id договора*/
        ClearRecord( Contr );
        Contr.rec.Id = _Contr;
        if( not GetEQ(Contr) )  
           this.SetError( "Не найден договор обслуживания при инициализации объекта" );        
        end;
     elif( (ValType(_Contr) == V_STRUC) OR (ValType(_Contr) ==V_FILE) OR (ValType(_Contr) == V_GENOBJ) )
        copy( Contr, _Contr );
     else
        this.SetError( "Неверные параметры инициализации объекта" );        
     end; 

     this.ID   = Contr.rec.Id;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  macro SetFI_Kind( FI_Kind:integer )
     m_FI_Kind = FI_Kind;
  end;

  macro SetBankID( BankID:integer )
     m_BankID = BankID;
  end;

  MACRO IsCurrMarket():bool
     return (Contr.rec.ServKind == PTSK_CM);
  END;

  initDVFirst();
  this.Construct(DocKind, Contract);
  InitFIRoleBArray();
END;

/* ПД по внебиржевым сделкам */
CLASS (DVFirst) DVFirstDocNDeal( DocKind, Oper, _DealPart:INTEGER, _nFI )
  VAR Deal = TBFile( "dvndeal", "R", 0 ),
      nFI_BaseActiv = TRecHandler("dvnfi"),
      nFI_BAOther = TRecHandler("dvnfi"),
      nFI_Forward = TRecHandler("dvnfi"),
      DealPart = 1,
      v_pm_BA:TRecHandler, 
      v_dt_BA:TRecHandler, 
      v_ct_BA:TRecHandler, 
      v_rm_BA:TRecHandler, 
      v_pm_CA:TRecHandler, 
      v_dt_CA:TRecHandler, 
      v_ct_CA:TRecHandler,
      v_rm_CA:TRecHandler,
      v_BaseFI:TRecHandler,
      v_InitialFI:TRecHandler, /* Исходный финансовый инструмент*/
      v_GenAgr:TRecHandler,
      v_MarketScheme:TRecHandler;

  if( _DealPart != NULL )
     DealPart = _DealPart;
  end;

  MACRO GetDoc()
     return Deal;
  END;

  macro IsDealMet()
     return IsDVFXDEALMET(DV_GetOperationGroup(this.Deal.rec.Kind));
  end;


  macro GetGround(type)

    const UCHET_OBYAZ = 1;
    const UCHET_TREB = 2;
    const PERENOS_OBYAZ = 3;
    const PERENOS_TREB = 4;
    const UCHET_SS = 5;
    var RecAcc = "";

    private macro GenAgr()
     if( v_GenAgr == null )
        v_GenAgr = Trechandler("dl_genagr.dbt");
        if( Deal.rec.GenAgrID > 0 )
           DL_GetRecHandler(v_GenAgr, " SELECT * FROM ddl_genagr_dbt WHERE t_GenAgrID = " + string(Deal.rec.GenAgrID));
        end;
     end;
     return v_GenAgr;
    end;

    macro GetPFIType ()
      var type = "";
      if ((Deal.rec.Kind == 12690) or (Deal.rec.Kind == 2690) or (Deal.rec.Kind == 12745) )/*PNV 518756*/
        type = "ФОРВАРД";
      elif ((Deal.rec.Kind == 12695) or (Deal.rec.Kind == 22695))/*PNV*/
        type = "валютный опцион";
      elif ((Deal.rec.Kind == 22710) or (Deal.rec.Kind == 2715) or (Deal.rec.Kind == 12710) or (Deal.rec.Kind == 2710) or (Deal.rec.Kind == 12715))/*PNV*/
        type = "СВОП";
      elif ((Deal.rec.Kind == 22720) or (Deal.rec.Kind == 12720))/*PNV*/
         type = this.PctSwapTypeName(true);
      end;
      return type;
    End;

    /*PNV*/
    macro IsPFI()
       if (Deal.rec.IsPFI == SET_CHAR)
           return true;
       else
           return false;  
       end;
    end;
    /*PNV*/

    macro GetCCYByFIID(code,codekind)
      var sql,rs;
      sql = " SELECT f.t_ccy fiid "
      + " FROM dfininstr_dbt f "
      + " WHERE f.t_fiid = '"+code+"' AND f.t_fi_kind = "+ codekind;

      rs = ExecSqlSelect(sql);
      if (rs.MoveNext())
        return rs.value(0);
      else
        sql = " SELECT f.t_ccy fiid "
            + " FROM dfininstr_dbt f "
            + " WHERE f.t_fiid = '"+code+"' AND f.t_fi_kind = 6";/*PNV для драг.металлов*/

        rs = ExecSqlSelect(sql);
        if (rs.MoveNext())
            return rs.value(0);
        else
            return null;
        end;
      end;
    end;

    var ground,exectype ="" , dealdate, routedeal , routeopc, fiid1, fiid2 , enddate, contrag, dealcode;
    if (nFI_BaseActiv.rec.exectype == 1)
      exectype = "поставочный";
    elif (nFI_BaseActiv.rec.exectype == 0)
      exectype = "расчетный";
    else
      exectype = "";
    end;

    if (deal.rec.type == 1)
      routedeal = "покупке";
    elif (deal.rec.type == 2)
      routedeal = "продаже";
    elif ((deal.rec.type == 5) and (Dealpart == 1))
      routedeal = "покупке";
    elif ((deal.rec.type == 5) and (Dealpart == 2))
      routedeal = "продаже";
    elif ((deal.rec.type == 6) and (Dealpart == 1))
      routedeal = "продаже";
    elif ((deal.rec.type == 6) and (Dealpart == 2))
      routedeal = "покупке";
    else
      routedeal = "";
    end;

    if (Deal.rec.Kind == 12695)
      if (deal.rec.OptionType == 1)
        routeopc = "продажу";
      elif (deal.rec.OptionType == 2)
        routeopc = "покупку";
      else
        routeopc = "";
      end;
    end;

    if (Deal.rec.Kind == 22710)
      dealcode = string(deal.rec.code) + "("+string(DealPart)+")";
    else
      dealcode = string(deal.rec.code);
    end;

    fiid1 = GetCCYByFIID(nFI_BaseActiv.rec.fiid,1);
    fiid2 = GetCCYByFIID(nFI_BaseActiv.rec.pricefiid,1);

    contrag = GetPartyNames(Deal.rec.Contractor, 2)[0];
    contrag = StrSubst(contrag, "'", ""); /*PNV 513219*/
    enddate = StrSubSt(String(nFI_BaseActiv.rec.ExecDate:f), ".", "/");
    var startdate = StrSubSt(String(deal.rec.Date:f), ".", "/");
    if ((this.deal.rec.kind != 12690) and (this.deal.rec.kind != 22720)  )/*PNV 515146*/              //SVE 515044 28.08.2020 Для сделок с типом 12690 пока не проверяем платежи, так как у многих сделок нет платежей и это приводик к ошибке при переносе средств, я посмотрел переменная RecAccне нужна для данных проводок.
       if ( this.ПлатежОб.rec.PaymentID > 0 )
          RecAcc = this.ПлатежОб.rec.ReceiverAccount;
       end;
    else
       RecAcc = "";
    end;
    
    if (type == 1)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Учет обязательств для сделки N "+dealcode+" от "+startdate + IIF(this.IsPctSwap, ""," по "+routedeal+" ");
      if(this.IsPctSwap)//Информация о направлении и валюте не заполняется для процетных СВОПов
      elif(not PFI_isBIO(Deal.rec.id))
        if (this.ВидБазовогоАктива() == FIKIND_METAL)
          ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
        else
          ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
        end;
      else
        if(Deal.rec.OPTIONTYPE == 1)
          ground = ground + "опциона на покупку ДМ";
        else
          ground = ground + "опциона на продажу ДМ";
        end;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
        ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
        ground = ground + "Учет обязательств для сделки N "+dealcode+" от "+startdate + " ";
        ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 2)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Учет требований для сделки N "+dealcode+" от "+startdate + IIF(this.IsPctSwap, ""," по "+routedeal+" ");
      if(this.IsPctSwap)//Информация о направлении и валюте не заполняется для процетных СВОПов
      elif(not PFI_isBIO(Deal.rec.id))
        if (this.ВидБазовогоАктива() == FIKIND_METAL)
          ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
        else
          ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
        end; 
      else
        if(Deal.rec.OPTIONTYPE == 1)
          ground = ground + "опциона на покупку ДМ";
        else
          ground = ground + "опциона на продажу ДМ";
        end;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
        ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
        ground = ground + "Учет требований для сделки N "+dealcode+" от "+startdate+" ";
        ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 3)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Перенос обязательств для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if(not PFI_isBIO(Deal.rec.id))
         if (this.ВидБазовогоАктива() == FIKIND_METAL)
             ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
         else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
         end; 
      else
       if(Deal.rec.OPTIONTYPE == 1)
         ground = ground + "опциона на покупку ДМ";
       else
         ground = ground + "опциона на продажу ДМ";
       end;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Перенос обязательств для сделки N "+dealcode+" от "+startdate+" ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 4)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Перенос требований для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if(not PFI_isBIO(Deal.rec.id))
         if (this.ВидБазовогоАктива() == FIKIND_METAL)
             ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
         else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
         end;
      else
       if(Deal.rec.OPTIONTYPE == 1)
         ground = ground + "опциона на покупку ДМ";
       else
         ground = ground + "опциона на продажу ДМ";
       end;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Перенос требований для сделки N "+dealcode+" от "+startdate+ " ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 5)
      if (not IsPFI()) 
           ground = "";
      else
           ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      end;
      ground = ground + "Списание обязательств для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Списание обязательств для сделки N "+dealcode+" от "+startdate+" ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 6)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Списание требований для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if(not PFI_isBIO(Deal.rec.id))
         if (this.ВидБазовогоАктива() == FIKIND_METAL)
             ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price; 
         else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI_BaseActiv.rec.price;
         end; 
      else
       if(Deal.rec.OPTIONTYPE == 1)
         ground = ground + "опциона на покупку ДМ";
       else
         ground = ground + "опциона на продажу ДМ";
       end;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Списание требований для сделки N "+dealcode+" от "+startdate+ " ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 7)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение справедливой стоимости сделка N "+dealcode+" от "+startdate+". К/агент: " +contrag;
    elif (type == 8)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Списание справедливой стоимости сделка N "+dealcode+" от "+startdate+". К/агент: " +contrag;
    elif (type == 9)
	  if(Deal.rec.Kind == 22720)
	    ground = "ПФИ (CIRS). Отражение финансового результата по сделке N " + dealcode + " от "+startdate + ". К/агент: " + contrag;
	  else
        ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение требований / обязательств сделка N "+dealcode+" от "+startdate+". К/агент: " +contrag;
      end;
	elif (type == 10)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Списание справедливой стоимости сделка N "+dealcode+" от "+startdate+" в связи с отказом от опциона. К/агент: " +contrag;
    elif (type == 11)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Урегулирование парных счетов по сделке N "+dealcode+" от "+startdate+" . К/агент: " +contrag;
    elif (type == 12)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение обязательств/требований по уплате премии по сделке N "+dealcode+" от "+startdate+" . К/агент: " +contrag;
    elif (type == 13)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение справедливой стоимости (премии) по сделке N "+dealcode+" от "+startdate+" . К/агент: " +contrag;
    elif (type == 14)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение фин.результата на дату прекращ. признания сделка N "+dealcode+" от "+startdate+" в связи с отказом от опциона. К/агент: " +contrag;
    elif (type == GROUND_GUARANT_MARGIN)/*15*/
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Учет депозитной маржи по сделке N "+dealcode+" от "+startdate+". К/агент: " +contrag;
    //mda 14/02/19 с 1000 идут граунды для платежей! 
    elif (type == 16)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Списание справедливой стоимости сделка N "+dealcode+" от "+startdate+" в связи с отказом от исполнения. К/агент: " +contrag;
    elif (type == 17)
      ground = "ПФИ (СВОП). Реализованная курсовая разница по сделке N " + dealcode + " от "+startdate+" по " + routedeal + " валюты " + fiid1 + "/" + fiid2 + ". Контрагент: " + contrag;
   	elif (type == 1001)
      /*PNV если ген.соглашения в сделке нет, в платеж не выводить*/
      if (GenAgr().rec.code != "")
          if(Deal.rec.Kind == 12690)/*CHVA*/
             ground = StrUpr("ВОЗВРАТ ДЕНЕЖНЫХ СРЕДСТВ ПО СДЕЛКЕ " + dealcode + " ОТ " + startdate + "ГЕН. СОГЛАШЕНИЕ № "+GenAgr().rec.code+" ОТ "+GenAgr().rec.date_genagr+" . НДС НЕ ОБЛАГАЕТСЯ. К/агент: " +contrag + ". Счет получателя: "+RecAcc);
          else
             ground = StrUpr("ВОЗВРАТ ДЕНЕЖНЫХ СРЕДСТВ ПО ДЕПОЗИТУ "+contrag+" СДЕЛКА № " + dealcode + " ОТ " + startdate + " ГЕН. СОГЛАШЕНИЕ № "+GenAgr().rec.code+" ОТ "+GenAgr().rec.date_genagr+" . НДС НЕ ОБЛАГАЕТСЯ. К/агент: " +contrag + ". Счет получателя: "+RecAcc);
          end;      
      else
          ground = StrUpr("ВОЗВРАТ ДЕНЕЖНЫХ СРЕДСТВ ПО ДЕПОЗИТУ "+contrag+ ". НДС НЕ ОБЛАГАЕТСЯ. К/агент: " +contrag + ". Счет получателя: "+RecAcc);
      end;
      /*PNV*/ 
    elif (type == 1002)
      ground = StrUpr("ОПЛАТА ПРЕМИИ ПО ОПЦИОНУ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1003)
      ground = StrUpr("ПОЛУЧЕНИЕ ПРЕМИИ ПО ОПЦИОНУ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1004)
      ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО ОПЦИОНУ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1005)
      ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО НЕТТИНГУ от "+{curdate}+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1006)
       if (Deal.rec.Kind == 32715)/*bpv client*/
          ground = "Перевод средств по сделке СВОП " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
       else
          ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО СДЕЛКЕ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
       end;
    elif (type == 1007)
      if (GenAgr().rec.code != "")
          if (Deal.rec.Kind == 22720)
            ground = StrUpr("TRANSFER OF FUNDS UNDER FX" + GetPFIType() + " "+SubStr (dealcode,index (dealcode, ":")+1) + " TRADE DATE " + startdate + " VALUE " + StrSubSt(String({curdate}:f ), ".", "/") + "" );/*CHVA*/
          elif (Deal.rec.Kind == 32715) /*bpv client*/
            ground = "Перевод средств по сделке СВОП " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
          else
            ground = StrUpr("TRANSFER OF FUNDS UNDER FX DEAL " + SubStr (dealcode,index (dealcode, ":")+1) + " TRADE DATE " + startdate + " VALUE " + StrSubSt(String({curdate}:f ), ".", "/") + " AGRM N " + StrChangeRusXSet_(GenAgr().rec.code) + " DD "+ StrSubSt(String(GenAgr().rec.date_genagr:f ), ".", "/"));/*CHVA*/
          end;      
      else
         if (Deal.rec.Kind == 32715) /*bpv client*/
            ground = "Перевод средств по сделке СВОП " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
         else
            ground = StrUpr("TRANSFER OF FUNDS UNDER FX DEAL " + SubStr (dealcode,index (dealcode, ":")+1) + " TRADE DATE " + startdate + " VALUE " + StrSubSt(String({curdate}:f ), ".", "/") + "" );/*CHVA*/
         end;
      end;
   /*pnv 504472*/
    elif (type == 1008)
      ground = StrUpr("PAY PREMIUM OPTIONS DEAL " + dealcode + " DD " + startdate + " " + contrag ); 
   /*pnv 504472*/
    elif (type == 1009)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение обязательства по уплате денежных средств по сделке " + dealcode + " от "  + startdate + ". Контрагент: " + contrag;
    elif (type == 1010)
      Ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение фин. рез-а по сделке " + dealcode + " от " + startdate + ". Контрагент: " + contrag;
    elif (type == 1011)
      Ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение требований по получению денежных средств по сделке " + dealcode + " от "  + startdate + ". Контрагент: " + contrag; 
    elif (type == 1012)
      Ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение обязательства по сделке " + dealcode + " от " + startdate + ". Контрагент: "+ contrag;
    elif (type == 1013)
      Ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение требований по сделке "+ dealcode + " от " + startdate + ". Контрагент: "+ contrag;
    elif (type == 1014)
      Ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Списание суммы справедливой стоимости по сделке " + dealcode + " от " + startdate + ". Контрагент: " + contrag;
     end;
    return ground;
  end;

  macro GenAgr()
     if( v_GenAgr == null )
        v_GenAgr = Trechandler("dl_genagr.dbt");

        if( Deal.rec.GenAgrID > 0 )
           DL_GetRecHandler(v_GenAgr, " SELECT * FROM ddl_genagr_dbt WHERE t_GenAgrID = " + string(Deal.rec.GenAgrID));
        end;
     end;

     return v_GenAgr;
  end;

  macro GetGenAgrCode():string
     return GenAgr().rec.Code;
  end;

  macro GetGenAgrExtCode():string
     return GenAgr().rec.ExtCode;
  end;

  macro GetGenAgrID():string
     return string(GenAgr().rec.GenAgrID);
  end;
  macro GetGenAgrCodeInAccount():string
     return GenAgr().rec.CodeInAccount;
  end;


  macro OpenAccByGenAgr():bool
     var RetVal:bool = false;

     if( (GenAgr().rec.GenAgrID > 0) and (GenAgr().rec.AccMode == 2) )
        RetVal = true;
     end;

     return RetVal;
  end;

  macro MarketScheme()
     if( v_MarketScheme == null )
        v_MarketScheme = Trechandler("dlmarket.dbt");

        if( Deal.rec.MarketSchemeID > 0 )
           DL_GetRecHandler(v_MarketScheme, " SELECT * FROM ddlmarket_dbt WHERE t_ID = " + string(Deal.rec.MarketSchemeID));
        end;
     end;

     return v_MarketScheme;
  end;

  macro GetMarketSchemeCode():string
     return MarketScheme().rec.Code;
  end;

  macro GetCentrID():integer
     return MarketScheme().rec.Centr;
  end;

  macro GetCentrOfficeID():integer
     return MarketScheme().rec.CentrOffice;
  end;

  macro IsSWAPDealT3():bool
     return ((this.Deal.rec.DVKind == DV_CURSWAP) and (this.Deal.rec.DocKind==DL_DVDEALT3));
  end;

  macro IsSWAPNDeal():bool
     return ((this.Deal.rec.DVKind == DV_CURSWAP) and (this.Deal.rec.DocKind==DL_DVNDEAL));
  end;

  macro IsSHORTSWAP():bool
     return (this.Deal.rec.DVKind == DV_CURSWAP_FX);
  end;

  macro IsSWAP():bool
     return (IsSWAPNDeal() or IsSWAPDealT3() or IsSHORTSWAP()); // пока так, что бы везде не протаскивать
  end;

  macro NotCreateMarginPaym():bool
     return ((IsSWAPNDeal() or this.IsForward()) and this.БиржеваяСделка() and (not DV_CreateMarginPaymSWAP()));
  end;

  macro IsPctSWAP():bool
     return this.Deal.rec.DVKind == DV_PCTSWAP;
  end;

  macro IsOption():bool
     return this.Deal.rec.DVKind == DV_OPTION;
  end;

  macro IsForwardDealT3():bool
     return (this.Deal.rec.DVKind == DV_FORWARD_T3);
  end;

  macro IsForwardNDeal():bool
     return (this.Deal.rec.DVKind == DV_FORWARD);
  end;

  macro IsForward():bool
     return (IsForwardNDeal() or IsForwardDealT3()); // пока так, что бы везде не протаскивать
  end;

  MACRO БазовыеВалютыРавны():bool
     var RetVal:bool = false;
     if( IsSWAP() or IsPctSWAP() )
        RetVal = (nFI_BaseActiv.rec.FIID == nFI_BAOther.rec.FIID);
     end;
     return RetVal;
  END;

  MACRO ОтказОтИсполнения():bool
     return (this.Deal.rec.ChangeKind > 1);   
  END;

  macro ДляФорвардаПлатежПоБАНеНужен():bool
     return (IsForward() and this.ПоставочныйКонтракт() and (nFI_BaseActiv.rec.OpenDate == SET_CHAR) and (nFI_BaseActiv.rec.ExecDate == date(0,0,0)) );
  end;

  MACRO pm_BA() /* платеж по БА */
     var PmAvrKind;

     if( v_pm_BA == null )
        v_pm_BA = Trechandler( "pmpaym.dbt" ); 
        v_dt_BA = Trechandler( "pmprop.dbt" ); 
        v_ct_BA = Trechandler( "pmprop.dbt" ); 
        v_rm_BA = Trechandler( "pmrmprop.dbt" ); 

        if( (not ДляФорвардаПлатежПоБАНеНужен()) and DVND_NeedPaymentsBA( this.Deal, nFI_BaseActiv, IIF((IsSWAP() or IsPctSWAP()), nFI_BAOther, nFI_Forward) ) )
           if( this.DealPart == 2 )
              PmAvrKind   = BRi;
           else
              PmAvrKind   = BAi;
           end;

           if( FindPayment ( null, PmAvrKind, 0, this.Kind, this.Deal.rec.ID, true, v_pm_BA, v_dt_BA, v_ct_BA, v_rm_BA ) != 0 )
              this.SetError("Не найден платеж по базовому активу для сделки " + this.DealCode() );
           end;  
        end;
     end;
     return v_pm_BA;
  END;    

  MACRO pm_CA() /* платеж по контрактиву */
     var PmAvrKind;

     if( v_pm_CA == null )
        v_pm_CA = Trechandler( "pmpaym.dbt" ); 
        v_dt_CA = Trechandler( "pmprop.dbt" ); 
        v_ct_CA = Trechandler( "pmprop.dbt" ); 
        v_rm_CA = Trechandler( "pmrmprop.dbt" ); 

        if( DVND_NeedPaymentsBA( this.Deal, nFI_BaseActiv, IIF((IsSWAP() or IsPctSWAP()), nFI_BAOther, nFI_Forward) ) )
           if( this.DealPart == 2 )
              PmAvrKind   = CRi;
           else
              PmAvrKind   = CAi;
           end;

           if( FindPayment ( null, PmAvrKind, 0, this.Kind, this.Deal.rec.ID, true, v_pm_CA, v_dt_CA, v_ct_CA, v_rm_CA ) != 0 )
              this.SetError("Не найден платеж по контрактиву для сделки " + this.DealCode() );
           end;  
        end;
     end;
     return v_pm_CA;
  END;    

  MACRO ПлатежТреб():TRecHandler /* платеж по требованию */
     if( IsPctSWAP() )
        return this.pm_BA();
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           return this.pm_CA();
        else
           return this.pm_BA();
        end;
     end;
  END; 

  MACRO ПлатежОб():TRecHandler /* платеж по обязательству */
     if( IsPctSWAP() )
        return this.pm_CA();
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           return this.pm_BA();
        else
           return this.pm_CA();
        end;
     end;
  END;

  MACRO InitParmArray()
      ParmA[MC_TYPE_PARAMETR_DOCKIND]    = this.Kind;
      ParmA[MC_TYPE_PARAMETR_DOCID]      = this.ID;
  END;

  MACRO IsTrust()                       
     return IIF( this.Deal.rec.IsTrust == "X", true, false ) ;
  END;

  MACRO IsCurrMarket():bool
     return ((Deal.rec.ClientContr > 0) and (GetSfContr(Deal.rec.ClientContr).rec.ServKind == PTSK_CM));
  END;

  MACRO DealCode():STRING  
     return this.Deal.rec.Code;
  END;

  MACRO InitFIRoleBArray()
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FUTURES;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPTION;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIREQ;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FICOM;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BONUS;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BA;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIDOC;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_PRICEFI;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIREQ_BACK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FICOM_BACK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_SETTL_AGENT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_ACTIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_PASSIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_ACTIVE_BACK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_PASSIVE_BACK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_COMISS_CLIENT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_NAT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_FRG;
  END;

  MACRO GetBasisFIRole( FIRole, NoMsgErr )
     return FIRole;
  END;

  MACRO ПоставочныйКонтракт():BOOL
     return (nFI_BaseActiv.rec.ExecType == DVSETTLEMET_STATE);
  END;

  MACRO ПоставочныйКонтрактSQL():BOOL
    var sql,rs;
    sql = "SELECT DISTINCT g.t_exectype FROM ddvnfi_dbt g WHERE g.t_dealid = "+this.Deal.rec.Id;
    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      if (rs.value(0) == 1)
        return true;
      else
        return false;
      end;
    end;
    
  END;

  /*конструктор */
  MACRO Construct( DocKind, pDeal, pFI ) 
     if( ValType( pDeal ) == V_INTEGER ) 
        this.Deal.rec.ID = pDeal;

        if( not this.Deal.GetEQ() ) 
           this.SetError( "Не найдена сделка по ПИ (Id = " + string(pDeal) + ")" );
        end;
     elif( (ValType(pDeal) == V_STRUC) OR (ValType(pDeal) == V_FILE) OR (ValType(pDeal) == V_GENOBJ) )
        copy( Deal, pDeal );
     else
        this.SetError( "Неверные параметры инициализации объекта" );        
     end; 

     if( ValType(pFI) == V_GENOBJ )
        copy( nFI_BaseActiv, pFI );
     elif( FindDVNFI(this.Deal.rec.Id, IIF( DealPart == 2, DV_NFIType_BaseActiv2, DV_NFIType_BaseActiv ), nFI_BaseActiv) != 0 )
        this.SetError( "Не найден актив внебиржевой операции (DealID = " + string(this.Deal.rec.Id) + ", Type = " + string(IIF( DealPart == 2, DV_NFIType_BaseActiv2, DV_NFIType_BaseActiv )) + ")" );
     end;

     if( this.Deal.rec.Forvard == SET_CHAR )
        if( FindDVNFI(this.Deal.rec.Id, DV_NFIType_Forward, nFI_Forward) != 0 )
           MsgBox("Не найден актив внебиржевой операции (DealID = " + string(this.Deal.rec.Id) + ", Type = " + string(DV_NFIType_Forward) + ")" );
        end;
     elif( IsSWAP() or IsPctSWAP() )
        if( FindDVNFI(this.Deal.rec.Id, IIF(DealPart == 2, DV_NFIType_BaseActiv, DV_NFIType_BaseActiv2), nFI_BAOther) != 0 )
           this.SetError( "Не найден актив внебиржевой операции (DealID = " + string(this.Deal.rec.Id) + ", Type = " + string(IIF(DealPart == 2, DV_NFIType_BaseActiv, DV_NFIType_BaseActiv2)) + ")" );
        end;
     end;

     this.ID   = this.Deal.rec.Id;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  MACRO Department():integer
     return this.Deal.rec.Department;
  END;

  MACRO ОснованиеПереносаПоСрокам( Требование:bool ):string
     var Ground:string = "";
     if( Требование )
        //Ground = "Перенос требований по";
        Ground = GetGround(4);
     else
        //Ground = "Перенос обязательств по";3
        Ground = GetGround(3);
     end;
     //Ground = Ground + IIF( this.DealPart == 1," сделке "," второй части сделки ")+ this.DealCode();
     return Ground;
  END;

  macro nFI_()
     return IIF(this.Deal.rec.Forvard == SET_CHAR, nFI_Forward, nFI_BaseActiv);
  end;

  macro IsOptionForForward():bool
     return (this.IsOption() and (this.Deal.rec.Forvard == SET_CHAR));
  end;

  macro IsClient():bool
     return this.Deal.rec.Client > 0;
  end;

  macro IsAgent():bool
     return this.Deal.rec.Agent > 0;
  end;

  macro ВалютныйРынок():bool
     return (this.Deal.rec.MarketKind==DV_MARKETKIND_CURRENCY);
  end;

  macro РынокСПФИ():bool
     return (this.Deal.rec.MarketKind==DV_MARKETKIND_SPFIMARKET);
  end;

  macro ФондовыйРынок():bool
     return (this.Deal.rec.MarketKind==DV_MARKETKIND_STOCK);
  end;

  macro IsSector():bool
     return (this.Deal.rec.Sector == SET_CHAR);
  end;

  macro Биржевая():bool
     return IsSector();
  end;

  macro БиржеваяСделкаНаВалРынке():bool
     return (this.Биржевая() and this.ВалютныйРынок());
  end;

  macro БиржеваяСделкаСПФИ()
     return (this.Биржевая() and this.РынокСПФИ() and (this.Deal.rec.TypeSPFI == DV_TYPE_SPFI_EXCHANGE));
  end;

  macro ВнеБиржеваяСделкаСПФИ()
     return (this.Биржевая() and this.РынокСПФИ() and (this.Deal.rec.TypeSPFI == DV_TYPE_SPFI_OTC));
  end;

  macro КонтрагентБиржа():bool
     return (ВидСубъекта(this.Deal.rec.Contractor, PTK_MARKETPLASE));
  end;

  macro КонтрагентНКЦ():bool
     return ВидСубъекта(this.Deal.rec.Contractor, PTK_CENTRALCONTR);
  end;

  macro СрокСделки():integer
     return this.Deal.rec.PeriodCls;
  end;

  macro БиржеваяСделка():bool
     return Биржевая();   //ВнеБиржеваяСделкаСПФИ() в общем случае тоже является биржевой и отличается только в обращение с вар- и деп- маржей
  end;

  macro БиржеваяСделкаКромеВнебиржСПФИ():bool
     return (Биржевая() and (not ВнеБиржеваяСделкаСПФИ()));   
  end;

  macro СобствБиржеваяСделка():bool
     return ((not IsClient()) and БиржеваяСделка());
  end;

  macro IsBuy():bool
     return ( (this.Deal.rec.Type == ALG_DV_BUY) OR
              ( (this.Deal.rec.Type == ALG_DV_BS) AND (this.DealPart == 1) ) OR
              ( (this.Deal.rec.Type == ALG_DV_SB) AND (this.DealPart == 2) )
            );
  end;

  macro IsOptionAmerican():bool
     return (IsOption() and (this.Deal.rec.OptionStyle == DVSTYLE_AMERICAN));
  end;

  macro IsOptionCall():bool
     return (IsOption() and (this.Deal.rec.OptionType == DVTYPE_CALL));
  end;

  macro IsOptionPut():bool
     return (IsOption() and (this.Deal.rec.OptionType == DVTYPE_PUT));
  end;

  //mda 15/02/2019 Покупка/продажа, определение направление для опциона
  macro IsBuyOption():bool
    if ( ( (IsBuy()) and (IsOptionCall()) ) or ( (IsBuy() == false) and (IsOptionPut()) ) )
      return true;
    else
      return false;
    end;
  end;
  macro IsGenerated():bool
     return this.Deal.rec.ParentID > 0;
  end;

  macro ДатаСделки():DATE  
     return this.Deal.rec.Date;
  end;

  macro ДатаНачала():DATE
     return this.Deal.rec.BeginDate;
  end;

  macro ДатаПоставки():DATE
     return nFI_().rec.SuplDate;
  end;

  macro ДатаОплаты():DATE
     return nFI_().rec.PayDate;
  end;

  macro ДатаИстеченияСрокаДействия():DATE
     return nFI_BaseActiv.rec.ExpiryDate;
  end;

  macro ДатаИсполнения( DealDateFlag:bool ):DATE
     var RetVal = date(0,0,0);
     if( nFI_BaseActiv.rec.ExecDate != date(0,0,0) )
        RetVal = nFI_BaseActiv.rec.ExecDate;
     elif( (DealDateFlag != NULL) and (DealDateFlag == true) )
        RetVal = ДатаСделки();
     end;
     return RetVal;
  end;

  macro ДатаИсполненияОпцион():DATE
     if ( ((nFI_.rec.SUPLDATE == NULL ) or (nFI_.rec.SUPLDATE == date(0,0,0) )) and (( nFI_.rec.PAYDATE == NULL ) or ( nFI_.rec.PAYDATE == date(0,0,0) )) )
        return ДатаИсполнения();
     elif ( (nFI_.rec.SUPLDATE == NULL ) or (nFI_.rec.SUPLDATE == date(0,0,0) ) )
        return nFI_.rec.PAYDATE;
     elif ( ( nFI_.rec.PAYDATE == NULL ) or ( nFI_.rec.PAYDATE == date(0,0,0) ) )
        return nFI_.rec.SUPLDATE;
     else
        if ( nFI_.rec.PAYDATE < nFI_.rec.SUPLDATE )
           return nFI_.rec.PAYDATE;
        else
           return nFI_.rec.SUPLDATE;
        end;
     end; 
  end;

  //ВБАт == ВБАо: внебаланс один, с даты заключения сделки до даты исполнения всей сделки. 
  //ВБАт != ВБАо: внебаланса два, 1) с даты заключения до даты начала, 2) с даты заключения до даты исполнения. 
  macro ДатаИсполненияЧасти( DealDateFlag:bool ):DATE
     var RetVal = date(0,0,0);
     if( (DealPart == 1) and IsPctSWAP() )
        if (БазовыеВалютыРавны())
        RetVal = ДатаИсполнения(DealDateFlag);
        else
        RetVal = ДатаНачала();
        end;
     else
        RetVal = ДатаИсполнения(DealDateFlag);
     end;
     return RetVal;
  end;

  macro ДатаИсполненияСвопа():DATE
    var RetVal = date(0,0,0);
    var sql,rs;

    sql = "SELECT d.t_execdate FROM ddvnfi_dbt d WHERE d.t_type = 2 AND d.t_dealid = "+this.Deal.rec.id;
    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      RetVal = rs.value(0);
    end;
    return RetVal;
  end;

  macro IsToDay()
     var RetVal:bool = false;
     if( ДатаИсполненияЧасти() == ДатаСделки() )
        RetVal = true;
     end;
     return RetVal;
  end;

  macro IsForwardZeroExecDate():bool
     return (IsForward() and (nFI_BaseActiv.rec.ExecDate == date(0,0,0)));
  end;

  macro IsForwardOpenDate():bool
     return (IsForward() and (nFI_BaseActiv.rec.OpenDate == SET_CHAR));
  end;

  macro ДатаТребования(pPayDate:date, pSuplDate:date):DATE
     var RetVal:date = date(0,0,0);
     var PayDate:date, SuplDate:date;

     if( IsPctSWAP() )
        RetVal = ДатаИсполненияЧасти();
     else
        if( (pPayDate != NULL) and (pPayDate != date(0,0,0)) )
           PayDate = pPayDate;
        else
           PayDate = nFI_().rec.PayDate;
        end;
        if( (pSuplDate != NULL) and (pSuplDate != date(0,0,0)) )
           SuplDate = pSuplDate;
        else
           SuplDate = nFI_().rec.SuplDate;
        end;

        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = PayDate;
        else
           RetVal = SuplDate;
        end;

        if( RetVal == date(0,0,0) )
           RetVal = ДатаИсполнения(true);
        end;
     end;

     return RetVal;
  end;

  macro ДатаОбязательства(pPayDate:date, pSuplDate:date):DATE
     var RetVal:date = date(0,0,0);
     var PayDate:date, SuplDate:date;

     if( IsPctSWAP() )
        RetVal = ДатаИсполненияЧасти();
     else
        if( (pPayDate != NULL) and (pPayDate != date(0,0,0)) )
           PayDate = pPayDate;
        else
           PayDate = nFI_().rec.PayDate;
        end;
        if( (pSuplDate != NULL) and (pSuplDate != date(0,0,0)) )
           SuplDate = pSuplDate;
        else
           SuplDate = nFI_().rec.SuplDate;
        end;

        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = SuplDate;
        else
           RetVal = PayDate;
        end;

        if( RetVal == date(0,0,0) )
           RetVal = ДатаИсполнения(true);
        end;
     end;

     return RetVal;
  end;

  macro СуммаТребования():MONEY
     var RetVal:MONEY = $0.0;
     if( IsPctSWAP() )
        RetVal = IIF(DealPart == 2, nFI_BaseActiv.rec.Amount, nFI_BAOther.rec.Amount);
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = this.ПолучитьСтоимостьБАвВалютеЦены();
        else
           RetVal = nFI_().rec.Amount;
        end;
     end;
     return RetVal;
  end;

  macro СуммаОбязательства():MONEY
     var RetVal:MONEY = $0.0;
     if( IsPctSWAP() )
        RetVal = IIF(DealPart == 2, nFI_BAOther.rec.Amount, nFI_BaseActiv.rec.Amount);
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = nFI_().rec.Amount;
        else
           RetVal = this.ПолучитьСтоимостьБАвВалютеЦены();
        end;
     end;
     return RetVal;
  end;

  macro ВалютаТребования_():INTEGER
     var RetVal:integer = ALLFININSTR;

     if( IsPctSWAP() )
        RetVal = IIF(DealPart == 2, nFI_BaseActiv.rec.FIID, nFI_BAOther.rec.FIID);
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = this.ВалютаЦены();
        else
           RetVal = nFI_().rec.FIID;
        end;
     end;

     return RetVal;
  end;

  macro ВалютаОбязательства_():INTEGER
     var RetVal:integer = ALLFININSTR;

     if( IsPctSWAP() )
        RetVal = IIF(DealPart == 2, nFI_BAOther.rec.FIID, nFI_BaseActiv.rec.FIID);
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = nFI_().rec.FIID;
        else
           RetVal = this.ВалютаЦены();
        end;
     end;

     return RetVal;
  end;

  macro ВалютаТребования( ВВалютеРасчетов:@bool ):INTEGER
     var RetVal:integer = ALLFININSTR;

     if( ВВалютеРасчетов != NULL )
        ВВалютеРасчетов = false;
     end;

      if( IsPctSWAP() )
        RetVal = IIF(DealPart == 2, nFI_BaseActiv.rec.FIID, nFI_BAOther.rec.FIID);
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = this.ВалютаРасчётов();

           if( ВВалютеРасчетов != NULL )
              ВВалютеРасчетов = true;
           end;
        else
           RetVal = this.ВалютаБазовогоАктива();
        end;
     end;
     return RetVal;
  end;

  macro ВалютаОбязательства( ВВалютеРасчетов:@bool ):INTEGER
     var RetVal:integer = ALLFININSTR;

     if( ВВалютеРасчетов != NULL )
        ВВалютеРасчетов = false;
     end;

      if( IsPctSWAP() )
        RetVal = IIF(DealPart == 2, nFI_BAOther.rec.FIID, nFI_BaseActiv.rec.FIID);
     else
        if( this.IsSale_BuyPutOrSaleCall() )
           RetVal = this.ВалютаБазовогоАктива();
        else
           RetVal = this.ВалютаРасчётов();

           if( ВВалютеРасчетов != NULL )
              ВВалютеРасчетов = true;
           end;
        end;
     end;
     return RetVal;
  end;

  macro ПолучитьКалендВалютуВидаДаты(НомерДаты):integer
    var dateNumber = НомерДаты;
    var idOpr,idStep,docKind,docId;
    if ((not DL_CheckCallFromStep()) and (ValType(dateNumber)!=V_INTEGER))
       return -2;
    end;
    if (ValType(dateNumber)!=V_INTEGER)
      DL_GetCalendCurOperStepData(docKind, idOpr, idStep, docId);
      dateNumber = DL_GetDateKindByOprID(idOpr,idStep);
    end;
    if (DL_Calend_DV_AddCheck(this, dateNumber))
      if (DL_Calend_DV_DateDefineIsReq(Kind, dateNumber))
         return ВалютаТребования();
      elif (DL_Calend_DV_DateDefineIsObl(Kind, dateNumber))
         return ВалютаОбязательства();
      end;
    end;
    return -1;
  end;

  macro ПолучитьКалендКонтрагент()
    return this.Deal.rec.Contractor;
  end;

  macro ПолучитьКалендТип():integer
    return IIF(Биржевая(),DL_CALLNK_MARKET,DL_CALLNK_OUTMARKET);
  end;

  macro ПолучитьКалендБиржа()
    return IIF(ПолучитьКалендТип()==DL_CALLNK_MARKET,ПолучитьКалендКонтрагент(),0);
  end;

  macro ПолучитьКалендСвязанный(dayType):integer
    var dTp = 0;
    var curId;
    if (ValType(dayType) == V_INTEGER)
      dTp = dayType;
    end;
    var params = makeArray(
        DL_KeyPair("Object",DL_CalendGetOperNameByKind(this.Kind_Operation())),
        DL_KeyPair("ObjectType",ПолучитьКалендТип()),
        DL_KeyPair("Market",ПолучитьКалендБиржа()),
        DL_KeyPair("Currency",this.ВалютаБазовогоАктива()),
        DL_KeyPair("DayType",dTp));
    if (Биржевая())
      if (ВалютныйРынок())
        params[params.size] = DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_CUR);
      elif (РынокСПФИ())
        params[params.size] = DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_SPFI);
      elif (ФондовыйРынок())
        params[params.size] = DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_SEC);
      end;
    end;
    return DL_GetCalendByDynParam(158,params);
  end;

  macro УстановитьКалендРанРасч(DateNumbs):integer
    var stat = 0;
    var status = IIF(Kind == DL_DVNDEAL,DV_OPERSTATUS_EARLY_SETTLEMENT,DV_OPERSTATUS_T3_EARLY_SETTLEMENT);
    if (DL_CheckCallFromStep() and 
       (((Kind == DL_DVNDEAL) and (not DL_CalendCheckKindOperHasSymb("P", Kind, this.Kind_Operation()))) or
       (Kind == DL_DVDEALT3))
       )
      if (DealPart == 2)
        status = IIF(Kind == DL_DVNDEAL,DV_OPERSTATUS_EARLY_SETTLEMENT_2,DV_OPERSTATUS_T3_EARLY_SETTLEMENT_2);
      end;
      if( not InsertOprStatus(status, DV_EARLY_SETT_OPERSTATUS_YES) )
        stat = 1;
      end;
    end;
    return stat;
  end;

  MACRO IsEarlySettlement():bool
    var status = IIF(Kind == DL_DVNDEAL,DV_OPERSTATUS_EARLY_SETTLEMENT,DV_OPERSTATUS_T3_EARLY_SETTLEMENT);
    if (DealPart == 2)
      status = IIF(Kind == DL_DVNDEAL,DV_OPERSTATUS_EARLY_SETTLEMENT_2,DV_OPERSTATUS_T3_EARLY_SETTLEMENT_2);
     end;
     return DVGetOprStatus(status) == DV_EARLY_SETT_OPERSTATUS_YES;
  END;

   MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)
    var BalAcc; /*SVE */
    var isEast = 0; /*PNV i-support 503434*/

  /*PNV 515850*/
    var v_FI = TRecHandler( "fininstr.dbt" );
    if( ПолучитьФинИн( nFI_BaseActiv.rec.FIID, v_FI ) != 0 )
       v_FI.Clear();
    end;
  /*PNV 515850*/

    private macro GetPFIType ()
      var type = "";
      if ((Deal.rec.Kind == 12690) or (Deal.rec.Kind == 2690) or (Deal.rec.Kind == 12745) )/*PNV 518756*/
        type = "Форвард";
      elif ((Deal.rec.Kind == 12695) or (Deal.rec.Kind == 22695))
         /*DEF-36146*/
        if( v_FI.rec.FI_Kind == FIKIND_METAL )
            type = "опцион ДМ";      
        elif( v_FI.rec.FI_Kind == FIKIND_ARTICLE )
            type = "опцион на артикул";      
        else
         type = "Валютный опцион";
        end;
      elif ((Deal.rec.Kind == 22710) or (Deal.rec.Kind == 12710) or (Deal.rec.Kind == 2710) )
        /*PNV 515850*/
        if( v_FI.rec.FI_Kind == FIKIND_METAL )
            type = "СВОП ДМ";      
        else
        type = "Валютный СВОП";
        end;
        /*PNV 515850*/
      elif ((Deal.rec.Kind == 22720) or (Deal.rec.Kind == 12720))
        type = "Процентный СВОП";
      elif (Deal.rec.Kind == 12735)
        type = "Банкнотная сделка";
      elif ((Deal.rec.Kind == 2715) or (Deal.rec.Kind == 12715)) /*MDA 25.02.2019*/
        type = "СВОП"; 
      end;
      return type;
    End;
     /*CHVA*/
    var exectype2="", type2 = false;
    if (nFI_BaseActiv.rec.exectype == 1)
      exectype2 = "Поставочный";
    elif (nFI_BaseActiv.rec.exectype == 0)
      exectype2 = "Расчетный";
    else
      exectype2 = "";
    end;
    
    if( (GetPFIType()=="Форвард") or (GetPFIType()=="Процентный СВОП") or (GetPFIType()=="Валютный опцион") )
      type2 = true;
    end;
    /*CHVA*/
   //TEG 25.06.19 ролевая модель   
   /* Определяем конечного операциониста для проводки */
   if ((this.kind==140) or (this.kind==152) or (this.kind==4626) or (this.kind==4627))
         Account.rec.Oper = GetMainOperInGroup(this.kind);
   elif(this.kind==199)
      if(this.ВидБазовогоАктива() == FIKIND_AVOIRISS)
         Account.rec.Oper = GetMainOperInGroup(101);
      else
         Account.rec.Oper = GetMainOperInGroup(this.kind,deal.rec.kind);
      end;
   else  
           Account.rec.Oper = GetMainOperInGroup(this.kind,deal.rec.kind);
   end;

   if (Account.rec.Oper <= 0)
         Account.rec.Oper = {Oper};
   end;

   /*PNV i-support 503434*/
   if (not GetMainObjAttr( null, 2, strLpad(string(account.rec.code_currency), 10, "0"), 101, isEast))
       isEast = 0;
   end;
   /*PNV i-support 503434*/

    /*ставим признак овердрафта на счета открываеммые по указанным категориям*/
    if( (categ.rec.Code == "+Форвард, расчеты") OR ((categ.rec.Code == "-Форвард, расчеты")) )
       if( Index(account.rec.Type_Account,"О") == 0 ) 
          account.rec.Type_Account = account.rec.Type_Account + "О";
       end;
    end;

    if( (categ.rec.Code == "+За ц/б") OR ((categ.rec.Code == "-За ц/б")) )
       if( (Index(account.rec.Type_Account,"О") == 0) AND (Index(account.rec.Kind_Account,"АП") == 0) ) 
          account.rec.Type_Account = account.rec.Type_Account + "О";
       end;
    end;
    
    if( (categ.rec.Code == "ФО Банка, ВУ") OR (categ.rec.Code == "ФО Клиента, ВУ") OR (categ.rec.Code == "ФО, Прч. счета банка, ВУ") OR
        (categ.rec.Code == "ФО, Расч. с клиентом, ВУ") )
       if( Index(account.rec.Type_Account,"О") == 0 ) 
          account.rec.Type_Account = account.rec.Type_Account + "О";
       end;
    end;

    BalAcc = SubStr(Account.rec.Account,1,3);
    if ((categ.rec.Code == "+Форвард, дрейф внебирж") OR (categ.rec.Code == "+Форвард, дрейф внебирж0") OR (categ.rec.Code == "+Форвард, прочие0"))
      if ((BalAcc == "933") OR (BalAcc == "939"))
          if (this.IsPctSWAP())     /*PNV i-support 488706*/ 
              Account.rec.NameAccount = Deal.rec.Code + " ПФИ. Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке от "+ StrSubSt(String(Deal.rec.Date:f), ".", "/") ; 
          else
		      if (categ.rec.Code == "+Форвард, прочие0")
			    Account.rec.NameAccount ="Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0];
			  else
                Account.rec.NameAccount ="ПФИ ("+ IIF(type2==true,exectype2,"") + " " + GetPFIType() + ") Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке " + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
              end;
		  end;
      else                                                                                
         /*PNV 515850*/
		  if (categ.rec.Code == "+Форвард, прочие0")		  
               Account.rec.NameAccount = " Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0];
          else
			  if( v_FI.rec.FI_Kind == FIKIND_METAL )
				  Account.rec.NameAccount = "ПФИ ("+ IIF(type2==true,exectype2,"") + " " + GetPFIType() + ") Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке "+IIF(Deal.rec.Kind == 12695,"(опцион) ","") + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
			  else
			   /*PNV 515850*/
				  Account.rec.NameAccount = "Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке "+IIF(Deal.rec.Kind == 12695,"(опцион) ","") + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
			  end;
	      end;
      end;
    elif ((categ.rec.code == "-Форвард, дрейф внебирж") OR (categ.rec.code == "-Форвард, прочие0") or (categ.rec.code == "-Форвард, дрейф внебирж0"))  /*KOA ID : 537216*/
      if ((BalAcc=="963") OR (BalAcc=="969") )
          if (this.IsPctSWAP())     /*PNV i-support 488706*/ 
              Account.rec.NameAccount = Deal.rec.Code + " ПФИ. Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке от "+ StrSubSt(String(Deal.rec.Date:f), ".", "/") ;
          else
		      if (categ.rec.Code == "-Форвард, прочие0")
                Account.rec.NameAccount ="Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0];
              else
			    Account.rec.NameAccount ="ПФИ ("+ IIF(type2==true,exectype2,"") + " " +GetPFIType() + ") Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке " + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
              end;
		  end;
      else
         /*PNV 515850*/
		 if (categ.rec.Code == "-Форвард, прочие0")
		   Account.rec.NameAccount = "Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0];
		 else
           if( v_FI.rec.FI_Kind == FIKIND_METAL )                                                                               
              Account.rec.NameAccount = "ПФИ ("+ IIF(type2==true,exectype2,"") + " " + GetPFIType() + ") Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке "+IIF(Deal.rec.Kind == 12695,"(опцион) ","") + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
           else
             Account.rec.NameAccount = "Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по сделке "+IIF(Deal.rec.Kind == 12695,"(опцион) ","") + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
           end;
		 end;
         /*PNV 515850*/
      end;
    elif ((categ.rec.Code == "+Форвард, расчеты") or (categ.rec.code == "-Форвард, расчеты")  or (categ.rec.code == "+Форвард, расчеты0Б") or (categ.rec.code == "-Форвард, расчеты0Б") or (categ.rec.code == "+Форвард, расчетыДМ") or (categ.rec.code == "-Форвард, расчетыДМ") or (categ.rec.code == "+Форвард, расчеты0") or (categ.rec.code == "-Форвард, расчеты0"))/*PNV*/
      Account.rec.NameAccount = "Расчеты с " + GetPartyNames(Deal.rec.Contractor, 2)[0];      
     /*PNV i-support 503434*/
      if( ( Index(account.rec.Type_Account,"Ф") == 0 ) and (isEast != 0)) 
          account.rec.Type_Account = account.rec.Type_Account + "Ф";
      end;
     /*PNV i-support 503434*/
    elif ((categ.rec.Code == "+ПФИ") or (categ.rec.code == "-ПФИ") or (categ.rec.code == "Выбытие ПФИ"))
      Account.rec.NameAccount = Deal.rec.Code + " ПФИ " + IIF (((this.ВидБазовогоАктива() == FIKIND_METAL) and (not this.IsOption())), "СВОП ДМ" , GetPFIType()) + " сделка от " + StrSubSt(String(Deal.rec.Date:f), ".", "/") + ". К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];
    elif ((categ.rec.Code == "+Незавершенные"))  
      Account.rec.NameAccount = "Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке денежных средств по сделке "+IIF(Deal.rec.Kind == 12695,"(опцион) ","") + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif ((categ.rec.code == "-Незавершенные")) 
      Account.rec.NameAccount = "Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке денежных средств по сделке "+IIF(Deal.rec.Kind == 12695,"(опцион) ","") + Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
   /*PNV 526800*/
    elif  ((categ.rec.Code == "Расходы ПФИ0") or (categ.rec.code == "Доходы ПФИ0") or (categ.rec.Code == "Расходы ПФИ") or (categ.rec.code == "Доходы ПФИ") )
          if ((categ.rec.Code == "Расходы ПФИ0") or (categ.rec.Code == "Расходы ПФИ") )
              Account.rec.NameAccount = "Расходы от операций с производными финансовыми инструментами, базисным активом которых являются";
          else
               Account.rec.NameAccount = "Доходы от операций с производными финансовыми инструментами, базисным активом которых являются";
          end;
          if (templ.rec.number == 1) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - фьючерс";
          elif (templ.rec.number == 2) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - форвард";
          elif (templ.rec.number == 3) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - опцион";
          elif (templ.rec.number == 4) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - СВОП";
          elif (templ.rec.number == 5) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - фьючерс";
          elif (templ.rec.number == 6) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - форвард";
          elif (templ.rec.number == 7) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - опцион";
          elif (templ.rec.number == 8) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - СВОП";
          elif (templ.rec.number == 9) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - фьючерс";
          elif (templ.rec.number == 10) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - форвард";
          elif (templ.rec.number == 11) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - опцион";
          elif (templ.rec.number == 12) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - СВОП";
          elif (templ.rec.number == 13) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - фьючерс";
          elif (templ.rec.number == 14) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - форвард";
          elif (templ.rec.number == 15) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - опцион";
          elif (templ.rec.number == 16) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - СВОП";
          elif (templ.rec.number == 17) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - фьючерс";
          elif (templ.rec.number == 18) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - форвард";
          elif (templ.rec.number == 19) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - опцион";
          elif (templ.rec.number == 20) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - СВОП";         
          end;
    /*PNV 526800*/
    end;

    /*КД*/
     if( categ.rec.Code == "Реализация, ц/б") 
        var FI = TRecHandler( "fininstr.dbt" );
        if( ПолучитьФинИн( nFI_BaseActiv.rec.FIID, FI ) == 0 )
           account.rec.nameaccount = "Выбытие (реализация) для ЦБ " + GetFinName(fi.rec) + ", гос. рег.№ " + User_GetLsin(fi.rec.fiid);
        end;

    end;

    if (categ.rec.code == "+ОД")
       Account.rec.NameAccount = "Отражение требований по депозитной марже с НКО НКЦ (АО) по сделке "+ Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif(categ.rec.code == "-ОД")
       Account.rec.NameAccount = "Отражение обязательств по депозитной марже с НКО НКЦ (АО) по сделке "+ Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif (categ.rec.code == "+%МС")
       Account.rec.NameAccount = "Отражение требований по уплате %% по сделке по сделке "+ Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif(categ.rec.code == "-%МС")
       Account.rec.NameAccount = "Отражение обязательств по уплате %% по сделке по сделке "+ Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    end;

    /*BIQ-12103 Доп.требования.*/
    if (categ.rec.code == "+ОД, СПФИ")
       Account.rec.NameAccount = "Отражение требований по депозитной марже с НКО НКЦ (АО) по сделкам СПФИ от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif(categ.rec.code == "-ОД, СПФИ")
       Account.rec.NameAccount = "Отражение обязательств по депозитной марже с НКО НКЦ (АО) по сделкам СПФИ от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif (categ.rec.code == "+% к погашению, СПФИ")
       Account.rec.NameAccount = "Отражение требований по уплате %% по сделке по сделкам СПФИ от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    elif(categ.rec.code == "-% к погашению, СПФИ")
       Account.rec.NameAccount = "Отражение обязательств по уплате %% по сделке по сделкам СПФИ от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
    end;

      if( not CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate) )
         return false;
      end;

      if( IsEarlySettlement() )
         if( (categ.rec.Code == "+Форвард, РПИ") OR (categ.rec.Code == "-Форвард, РПИ") )
            if( Index(account.rec.Type_Account,"Ф") == 0 )
               account.rec.Type_Account = account.rec.Type_Account + "Ф";
            end;
         end;
      end;
    
      return true;
   END;

  macro IsSale():bool
     return ( (this.Deal.rec.Type == ALG_DV_SALE) OR 
              ( (this.Deal.rec.Type == ALG_DV_BS) AND (this.DealPart == 2) ) OR
              ( (this.Deal.rec.Type == ALG_DV_SB) AND (this.DealPart == 1) )
            );
  end;

  macro ВидБазовогоАктива( Forward:bool ):integer
     var RetVal:integer = FIKIND_ALLFI;
     var dvnFI = TRecHandler("dvnfi");
     var FI = TRecHandler( "fininstr.dbt" );

     if( (Forward != NULL) and (Forward == true) )
        dvnFI = nFI_();
     else
        dvnFI = nFI_BaseActiv;
     end;

     if( ПолучитьФинИн( dvnFI.rec.FIID, FI ) != 0 )
        if( (this.Deal.rec.Forvard == SET_CHAR) and (dvnFI.rec.FIID == ALLFININSTR) and ((Forward == NULL) or (Forward == false)) ) /*опцион на не стандартный форвард*/
           RetVal = FIKIND_DERIVATIVE;
        else
           MsgBox("Не найден финансовый инструмент (FIID = " + string(dvnFI.rec.FIID) + ")");
        end;
     else
        if( FI.rec.FI_Kind == FIKIND_INDEX )
           RetVal = FI.rec.Settlement_Code;
        else
           RetVal = FI.rec.FI_Kind;
        end;
     end;

     return RetVal;
  end;

  macro ВалютаЦены():integer
     return nFI_().rec.PriceFIID;
  end;

  macro ВалютаРасчётов():integer
     return IIF( nFI_().rec.AccFIID < 0, this.ВалютаЦены(), nFI_().rec.AccFIID );
  end;

  macro ВалютаБазовогоАктива():integer

     var RetVal:integer = ALLFININSTR;
     var FI = TRecHandler( "fininstr.dbt" );

     if( this.Deal.rec.Forvard == UNSET_CHAR )
        if( ПолучитьФинИн( nFI_BaseActiv.rec.FIID, FI ) != 0 )
           MsgBox("Не найден финансовый инструмент (FIID = " + string(nFI_BaseActiv.rec.FIID) + ")");
        else
           if( FI.rec.FI_Kind == FIKIND_AVOIRISS )
              RetVal = FI.rec.FaceValueFI;
           elif( (FI.rec.FI_Kind == FIKIND_CURRENCY) or (FI.rec.FI_Kind == FIKIND_METAL) )
              RetVal = nFI_BaseActiv.rec.FIID;
           elif( FI.rec.FI_Kind == FIKIND_ARTICLE )
              RetVal = ВалютаРасчётов();
           elif( FI.rec.FI_Kind == FIKIND_INDEX )
              if( FI.rec.Settlement_Code == FIKIND_AVOIRISS )
                 RetVal = ВалютаРасчётов();
              elif( FI.rec.Settlement_Code == FIKIND_CREDIT )
                 RetVal = NATCUR;
              else //( (FI.rec.Settlement_Code == FIKIND_CURRENCY) or (FI.rec.Settlement_Code == FIKIND_OTHER) )
                 RetVal = FI.rec.FaceValueFI;
              end;
           end;
        end;
     else
        if( ПолучитьФинИн( nFI_Forward.rec.FIID, FI ) != 0 )
           MsgBox("Не найден финансовый инструмент (FIID = " + string(nFI_Forward.rec.FIID) + ")");
        else
           if( FI.rec.FI_Kind == FIKIND_AVOIRISS )
              RetVal = FI.rec.FaceValueFI;
           elif( (FI.rec.FI_Kind == FIKIND_CURRENCY) or (FI.rec.FI_Kind == FIKIND_METAL) )
              RetVal = nFI_Forward.rec.FIID;
           elif( FI.rec.FI_Kind == FIKIND_ARTICLE )
              RetVal = ВалютаРасчётов();
           elif( FI.rec.FI_Kind == FIKIND_INDEX )
              if( FI.rec.Settlement_Code == FIKIND_AVOIRISS )
                 RetVal = ВалютаРасчётов();
              elif( FI.rec.Settlement_Code == FIKIND_CREDIT )
                 RetVal = NATCUR;
              else //( (FI.rec.Settlement_Code == FIKIND_CURRENCY) or (FI.rec.Settlement_Code == FIKIND_OTHER) )
                 RetVal = FI.rec.FaceValueFI;
              end;
           end;
        end;
     end;

     return RetVal;
  end;

  macro BaseFI()
     if( v_BaseFI == null )
        v_BaseFI = TRecHandler("fininstr.dbt");
        if( ПолучитьФинИн(nFI_().rec.FIID, v_BaseFI) != 0 )
           MsgBox("Не найден финансовый инструмент (FIID = " + string(nFI_().rec.FIID) + ")");
        end;
     end;

     return v_BaseFI;
  end;

  macro ClientID():integer
     return Deal.rec.Client;
  end;

  macro ClientContrID():integer
     return Deal.rec.ClientContr;
  end;

  /*PNV*/
  MACRO GetContractorID():integer
     return this.Deal.rec.Contractor;
  END;
  /*PNV*/

  //start //Morozov Denis . 31/10/2018 . В назначение нужно наименование клиента и брокер. дог. + закрытие сделки

  macro ПроцСвопНеттингТО():bool
    if (Deal.rec.Netting_pmgr == SET_CHAR)
      return true;
    else
      return false;
    end;
  end;

  macro IsMigrDeal():bool
    if (Deal.rec.Comment == "MIGR")
      return true;
    else
      return false;
    end;
  end;

  macro КонвТипПрСвоп(type):bool
  var sql,rs;

    if (type == 0)
      sql = "UPDATE ddvnfi_dbt d SET d.t_exectype = 0 WHERE d.t_dealid = "+Deal.rec.id;
      rs = ExecSql(sql);
      if (not rs)
        return false;
      else
        return true;
      end;
    elif (type == 1)
      sql = "UPDATE ddvnfi_dbt d SET d.t_exectype = 1 WHERE d.t_dealid = "+Deal.rec.id;
      rs = ExecSql(sql);
      if (not rs)
        return false;
      else
        return true;
      end;
    end;

  end;

  macro SetCloseDeal():bool
	var sql,rs;
	sql = "UPDATE ddvndeal_dbt d SET d.t_state = 2 WHERE d.t_id = "+int(Deal.rec.id);
	rs = ExecSql(sql);
	if (not rs)
		return false;
	else
		return true;
	end;

  end;
  macro ClientCodeByID():string
    var sql,rs;
    sql = " SELECT c.t_code AS code "
    + " FROM dpartcode_dbt c "
    + " WHERE c.t_partyid = "+this.ClientID()+" AND c.t_codekind = 1 ";

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      return rs.value("code");
    end;
  end;

  macro ClientContrName():string
    var sql,rs;
    sql = " SELECT t.t_number contr "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_id =  "+this.ClientContrID();

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      return rs.value("contr");
    end;
  end;

  /*BPV*/
  macro ClientDBOContrName():string
    var RetVal:string = "";
    var sql,rs;
    sql = " SELECT t.t_number contr "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_id = ( select t_sfcontrid from ddlcontr_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid =  "+this.ClientContrID() + "))";

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      RetVal = rs.value("contr");
    end;
    return RetVal;
  end;
  /*BPV*/

  macro ClientDBOContrDate():date
    var RetVal:date = date(0,0,0);
    var sql,rs;
    sql = " SELECT t.t_datebegin contrdate "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_id = ( select t_sfcontrid from ddlcontr_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid =  "+this.ClientContrID() + "))";

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      RetVal = SQL_ConvTypeDate(rs.value("contrdate"));
    end;
    return RetVal;
  end;

  macro БивалютнаяСделка():bool
    if ( (ВалютаОбязательства() == NATCUR) or (ВалютаТребования() == NATCUR) )
      return false;
    else
      return true;
    end;
  end;
  macro BrokerID():integer
     return Deal.rec.Agent;
  end;

  macro BrokerContrID():integer
     return Deal.rec.AgentContr;
  end;

  macro Kind_Operation():integer
     return Deal.rec.Kind;
  end;
  /*PNV*/
  private macro ВидАктива( FIID:integer ):integer
     var RetVal:integer = FIKIND_ALLFI;
     var FI = TRecHandler("fininstr.dbt");
     if( ПолучитьФинИн(FIID, FI) != 0 )
        MsgBox("Не найден финансовый инструмент (FIID = " + string(FIID) + ")");
     else
        RetVal = FI.rec.FI_Kind;
     end;
     return RetVal;
  end;
  macro ВидАктиваТребования():integer
     return ВидАктива(ВалютаТребования());
  end;
  macro ВидАктиваОбязательства():integer
     return ВидАктива(ВалютаОбязательства());
  end;
  /*PNV*/

  /*Получить НЕкэшируемый параметр (меняющийся в зависимости от контекста вызова GetParametr())
    например для разных FIRole */
  PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole )

     VAR Parametr = null;

     if( ParmKind == MC_TYPE_PARAMETR_FIID )
        if( FIRole == FIROLE_BONUS )
           Parametr = this.Deal.rec.BonusFIID;
        elif( (FIRole == FIROLE_BA) or (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_PRICEFI) )
           Parametr = this.nFI_().rec.FIID;
        elif( (FIRole == FIROLE_CORACC_ACTIVE) or (FIRole == FIROLE_CORACC_PASSIVE) or (FIRole == FIROLE_CORACC_ACTIVE_BACK) or (FIRole == FIROLE_CORACC_PASSIVE_BACK) )
           Parametr = GetFIIDForCorAccNum();
        else
           Parametr = ВалютаРасчётов();
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_PAYCURRENCY )
        if( FIRole == FIROLE_BONUS )
           Parametr = this.Deal.rec.BonusFIID;
        else
           Parametr = ВалютаРасчётов();
        end;
     elif( (ParmKind == MC_TYPE_PARAMETR_CONTRACTOR) or (ParmKind == MC_TYPE_PARAMETR_PARTY) )
        if( (FIRole == FIROLE_SETTL_AGENT) and (this.IsAgent() == true) )
           Parametr = this.Deal.rec.Agent;
        elif( FIRole == FIROLE_COMISS_CLIENT )
           Parametr = this.Deal.rec.Client;
        else
           Parametr = this.Deal.rec.Contractor;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
        if( this.IsAgent() == true )
           Parametr = this.Deal.rec.Agent;
        else
           if( FIRole == FIROLE_BONUS )
              Parametr = this.РКЦБанкИзСПИ(this.Deal.rec.BonusFIID);
           else
              Parametr = this.РКЦБанкИзСПИ(this.ВалютаРасчётов());
           end;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_FINDATE)
        if( (CatCode == "-ОД") or (CatCode == "+ОД") )
           Parametr = this.GetParametr(MC_TYPE_PARAMETR_BEGDATE, OperDate, CatCode, FIRole); /*до востребования*/
        elif( FIRole == FIROLE_SETTL_AGENT )
           Parametr = this.GetParametr(MC_TYPE_PARAMETR_BEGDATE, OperDate, CatCode, FIRole);
        else
           if( this.Deal.rec.Forvard == SET_CHAR )
              Parametr = this.nFI_BaseActiv.rec.ExecDate; /*176415*/
           else
              if( IsForwardZeroExecDate() )
                 Parametr = date(31,12,9999);
              else
                 if( (FIRole == FIROLE_FIREQ) or (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_FIREQ_BACK) )
                    Parametr = this.ДатаТребования();
                 elif( (FIRole == FIROLE_FICOM) or (FIRole == FIROLE_PRICEFI) or (FIRole == FIROLE_FICOM_BACK) )
                    Parametr = this.ДатаОбязательства();
                 end;
              end;
           end;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_CURRENCYEQ )
        Parametr = ALLFININSTR;
        if( (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS) and (nFI_().rec.AccFIID == NATCUR) and (nFI_().rec.AccFIID != this.ВалютаЦены()) )
           if( this.GetParametrTemplate(OBJTYPE_KINDFI, LLCLASS_KIND_AKT_REQ/*LLCLASS_KIND_AKT_COMM*/, OperDate, FIRole) == 1/*Денежные средства*/ )
              Parametr = this.ВалютаЦены();
           end;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_CURRENCYEQ_RATETYPE )
        if( this.GetParametr( MC_TYPE_PARAMETR_CURRENCYEQ, OperDate, CatCode, FIRole ) != ALLFININSTR )
           Parametr = ПИ_ПолучитьВидКурса(DV_RATETYPE_CBR);
        end;
     end;

     return Parametr;
  END;  

  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null, InCache;
     VAR DLMarket = TRecHandler( "dlmarket.dbt" );

     if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
        return ParmA[ParmKind];
     end;

     /*пробуем определить значение среди некэшируемых параметров*/     
     Parametr = GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole );

     /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
     if( Parametr == null ) 
       InCache = true;

       /*кэшируемые параметры - эти параметры НЕ меняются после создания объекта класса, поэтому их можно занести в кэш*/
       if( ParmKind == MC_TYPE_PARAMETR_DEPARTMENT )
          Parametr = this.Deal.rec.Department;
       elif( ParmKind == MC_TYPE_PARAMETR_OWNER )
          Parametr = IIF( this.Deal.rec.Client > 0, this.Deal.rec.Client, {ourbank} );
       elif( ParmKind == MC_TYPE_PARAMETR_CONTR_CLIENT ) 
          Parametr = this.Deal.rec.ClientContr;
       elif( ParmKind == MC_TYPE_PARAMETR_NUMBER )
          Parametr = this.Deal.rec.Code;
       elif( ParmKind == MC_TYPE_PARAMETR_BEGDATE )
          Parametr = this.Deal.rec.Date;
       elif( ParmKind == MC_TYPE_PARAMETR_CONTR_BANK )
          Parametr = this.Deal.rec.AgentContr;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
          if( ВалютныйРынок() or РынокСПФИ() )
             Parametr = GetCentrID();
          elif( this.КонтрагентБиржа() )
             Parametr = this.Deal.rec.Contractor;
          else
             Parametr = 0;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
          if( ВалютныйРынок() or РынокСПФИ() )
             Parametr = GetCentrOfficeID();
          elif( this.КонтрагентБиржа() )
             /*попробуем найти схему расчетов с биржей и оттуда взять ID сектора*/
             Parametr = -1;
             if( not FindDLMARKETbyMarket(this.Deal.rec.Contractor, true, false, FIKIND_DERIVATIVE, DLMarket) )
                Parametr = DLMarket.rec.CentrOffice;
             end;
             if( Parametr == -1 )
                MsgBox("Не найдена схема расчетов с биржей \""+string(this.Deal.rec.Contractor)+"\"");
             end;
          else
             Parametr = 0;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_ACCTYPE )
         var Client = TBfile("party.dbt");
         if( ПолучитьСубъекта(this.Deal.rec.Client, Client) == 0 ) 
            if ((ВидСубъекта(Client.rec.PartyID, PTK_CLIENT) AND ВидСубъекта(Client.rec.PartyID, PTK_BANK)) OR
                 ВидСубъекта(Client.rec.PartyID, PTK_DEPOSITORY) OR ВидСубъекта(Client.rec.PartyID, PTK_BROKER))
               Parametr = 2; // счет внутреннего учета другого профессионального участника
            else
               Parametr = 1; // специальный брокерский счет в драгоценных металлах
            end;
         end;
       else
          InCache = false;
          Parametr = -1;
       end;

       if( InCache == true )
          ParmA[ParmKind] = Parametr;
       end;
     end;

     return Parametr;
  END;

  /*  получение параметров шаблонов для категорий учета       */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )         
     var Parametr;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );

     if( Parametr == -1 )
        if( ( ObjectID == OBJTYPE_KINDCB ) AND ( Classificator == LLCLASS_KINDCB_DVKIND ) )
           if( IsForward() )
              Parametr = 100; /*Фьючерс*/
           elif( IsOption() )
              Parametr = 101; /*Опцион*/
           end;
        elif( ((ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_REQ)) OR
              ((ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_COMM)) OR
              ((ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK)) )
           if( (FIRole == FIROLE_FIREQ_BACK) or (FIRole == FIROLE_FICOM_BACK) )
              Parametr = 1; /*Денежные средства*/
           else /*(FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_PRICEFI) и прочее */
              if( BaseFI().rec.FI_Kind == FIKIND_INDEX ) // НЕ ВидБазовогоАктива
                if(BaseFI().rec.Settlement_Code == FI_INDEX_AVOIRISS)
                  Parametr = 8; /*Индекс*/
                else
                 Parametr = 1; /*Денежные средства*/
                end;
              else
                 if( ВидБазовогоАктива(true) == FIKIND_AVOIRISS )
                    Parametr = 3; /*Ценные бумаги*/
                 elif( ВидБазовогоАктива(true) == FIKIND_METAL )
                    Parametr = 2; /*Драгоценные металлы*/
                 elif( ВидБазовогоАктива(true) == FIKIND_ARTICLE )
                    Parametr = 7; /*Артикул*/
                 elif( ВидБазовогоАктива(true) == FIKIND_INDEX )
                   if(BaseFI().rec.Settlement_Code == FI_INDEX_AVOIRISS)
                    Parametr = 8; /*Индекс*/
                 else
                    Parametr = 1; /*Денежные средства*/
                 end;
                 else
                    Parametr = 1; /*Денежные средства*/
              end;
           end;
           end;
        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_FI_KIND) )
           if( ВидБазовогоАктива(true) == FIKIND_CURRENCY )
              Parametr = 1; /*Денежные средства*/
           elif( ВидБазовогоАктива(true) == FIKIND_METAL )
              Parametr = 2; /*Драгоценные металлы*/
           end;
        elif( (ObjectID == OBJTYPE_KIND_ACCOUNT_CALC) AND (Classificator == LLCLASS_KIND_ACC_IN_FUTURES) )
           if( ВидБазовогоАктива(true) == FIKIND_AVOIRISS )
              Parametr = this.DealPart;
           else
              Parametr = 4;
           end;
        elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           //TEG if( IsPctSWAP() AND БазовыеВалютыРавны() )
          if( IsPctSWAP())
              Parametr = 2; /*Процентная ставка*/
           elif( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
              Parametr = 1; /*Валюта*/
           elif( BaseFI().rec.FI_Kind == FIKIND_INDEX )
              Parametr = 2; /*Процентная ставка*/
           elif( BaseFI().rec.FI_Kind == FIKIND_AVOIRISS )
              Parametr = 3; /*Ценная бумага*/
           elif( BaseFI().rec.FI_Kind == FIKIND_METAL )
              Parametr = 4; /*Драг. металл*/
           elif( BaseFI().rec.FI_Kind == FIKIND_ARTICLE )
              Parametr = 5; /*Другой*/
           else
              Parametr = 5; /*Другой*/
           end;
        elif( ObjectID == OBJTYPE_KIND_OPER_DV )
           if( IsForward() )
              Parametr = 2; /*Форвард*/
           elif( IsOption() )
              Parametr = 3; /*Опцион*/
           elif( IsSWAP() or IsPctSWAP() )
              Parametr = 4; /*Своп*/
           end;
        elif ( Classificator == LLCLASS_UNCS_FITYPE )
          /*bpv*/
           if ((ObjectID = 1611) and IsClient() and ВалютныйРынок())
              if (ВалютаЦены() != 0)
                 Parametr = 0;
              else   
                 Parametr = 1; 
              end;  
           else
              if ( ВалютаБазовогоАктива()==NATCUR )
                 Parametr = 1; 
              else
                 Parametr = 0;
              end;  
           end;
	elif ( Classificator == 5023 ) /*PNV*/
            if(( FIRole == FIROLE_FIREQ ) or ( FIRole == FIROLE_FIRST_OVERVAL)) 
                if( ВидАктиваТребования() == FIKIND_METAL )
                    Parametr = 2; /*Драгоценные металлы*/
                else
                    Parametr = 1; /*Денежные средства*/
                end;
            elif( ( FIRole == FIROLE_FICOM ) or ( FIRole == FIROLE_SECOND_OVERVAL)) 
                if( ВидАктиваОбязательства() == FIKIND_METAL )
                    Parametr = 2; /*Драгоценные металлы*/
                else
                    Parametr = 1; /*Денежные средства*/
                end;
            end;    
        elif (Classificator == 5021)
           if(ВалютаЦены() == NATCUR)
              Parametr = 0;
           else
              Parametr = 1;
           end;                   
        end;
     end;

     return Parametr;
  END;

  MACRO ВУ_ПолучитьРольФИ( ВидРО, DebCred )
     var FIRole = FIROLE_UNDEF;
       
     if( ВидРО == 29 )
        FIRole = FIROLE_BONUS;
     elif ( (ВидРО == 100) OR (ВидРО == 101))
        FIRole = FIROLE_FIDOC;
     end;

     return FIRole;
  END;

  macro ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut:bool )
     var Категория = "";

     if( (ВидРО == 29) or (ВидРО == 28) or (ВидРО == 33) or (ВидРО == 34) or (ВидРО == 35) )
        if( IsOut )
           if( IsClient() )
              Категория = "ДС, Расч. с клиентом, ВУ";
           else
              Категория = "ДС, Прч. счета банка, ВУ";
           end;
        else
           if( IsClient() )
              Категория = "ДС Клиента, ВУ";
           else
              if( IsAgent() )
                 Категория = "ДС у брокера, ВУ";
              else
                 Категория = "ДС Банка, ВУ";
              end;
           end;
        end;
     elif( ВидРО == 18 )
        if( IsClient() )
           Категория = "ДС, Расч. с клиентом, ВУ";
        else
           Категория = "ДС, Прч. счета банка, ВУ";
        end;
     elif( ВидРО == 19 )
        if( IsClient() )
           Категория = "ДС Клиента, ВУ";
        else
           if( IsAgent() )
              Категория = "ДС у брокера, ВУ";
           else
              Категория = "ДС Банка, ВУ";
           end;
        end;
     elif( (ВидРО == 12) or (ВидРО == 9) )
        if( IsClient() )
           Категория = "ДС, Расч. с клиентом, ВУ";
        else
           Категория = "ДС, Прч. счета банка, ВУ";
        end;
     elif( ВидРО == 8 )
        if( IsClient() )
           Категория = "ДС, Расч. с клиентом, ВУ";
        end;
     elif( ВидРО == 17 )
         Категория = "ДС, Расч. с клиентом, ВУ";
     elif( ВидРО == 99 )
         if( IsClient() )
            if(IsOut)
               Категория = "ДС, Расч. с клиентом, ВУ";
            else
               Категория = "ДС Клиента, ВУ";
            end;
        end;
     elif( ВидРО == 100 )
         if( IsClient() )
            Категория = "ДМ клиента, ВУ";
         end;
     elif( ВидРО == 101 )
         if( IsClient() )
           Категория = "ДМ, Расч. С клиентом, ВУ";
        end;
     end;

     return Категория;
  end;

  macro ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut:bool )
     var Категория = "";

     if( (ВидРО == 29) or (ВидРО == 28) or (ВидРО == 33) or (ВидРО == 34) or (ВидРО == 35) )
        if( IsOut )
           if( IsClient() )
              Категория = "ДС Клиента, ВУ";
           else
              if( IsAgent() )
                 Категория = "ДС у брокера, ВУ";
              else
                 Категория = "ДС Банка, ВУ";
              end;
           end;
        else
           if( IsClient() )
              Категория = "ДС, Расч. с клиентом, ВУ";
           else
              Категория = "ДС, Прч. счета банка, ВУ";
           end;
        end;
     elif( ВидРО == 18 )
        if( IsClient() )
           Категория = "ДС Клиента, ВУ";
        else
           if( IsAgent() )
              Категория = "ДС у брокера, ВУ";
           else
              Категория = "ДС Банка, ВУ";
           end;
        end;
     elif( ВидРО == 19 )
        if( IsClient() )
           Категория = "ДС, Расч. с клиентом, ВУ";
        else
           Категория = "ДС, Прч. счета банка, ВУ";
        end;
     elif( (ВидРО == 12) or (ВидРО == 9) )
        if( IsClient() )
           Категория = "ДС Клиента, ВУ";
        else
           Категория = "ДС у брокера, ВУ";
        end;
     elif( ВидРО == 8 )
        if( IsClient() )
           Категория = "ДС Клиента, ВУ";
        end;
     elif( ВидРО == 17 )
         Категория = "ДС Клиента, ВУ";
     elif( ВидРО == 99 )
         if( IsClient() )
            if(IsOut)
               Категория = "ДС Клиента, ВУ";
            else
               Категория = "ДС, Расч. с клиентом, ВУ";
            end;
        end;
     elif( ВидРО == 100 )
         if( IsClient() )
            Категория = "ДМ, Расч. С клиентом, ВУ";
         end;
     elif( ВидРО == 101 )
         if( IsClient() )
           Категория = "ДМ клиента, ВУ";
        end;
     end;

     return Категория;
  end;

  macro ВУ_ОснованиеПроводки( ВидРО, IsOut:bool )
     var Ground = "";

     if( ВидРО == 29 )
        if( IsOut )
           Ground = "Оплата премий";
        else
           Ground = "Получение премий";
        end;
     elif( ВидРО == 28 )
        if( IsOut )
           Ground = "Оплата вариационной маржи";
        else
           Ground = "Получение вариационной маржи";
        end;
     elif( ВидРО == 18 )
        ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_GUARANT);
     elif( ВидРО == 19 )
        ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_GUARANT);
     elif( ВидРО == 12 )
        Ground = "Оплата комиссий посреднику";
     elif( ВидРО == 9 )
        //ОснованиеПроводкиПИ(DV_GRNUM_COMM_MARKET);
        Ground = "Комиссия биржи. Сделка "+IIF(this.deal.rec.kind == 32715,"СВОП ", "")+"N " + this.deal.rec.code + " от " + this.deal.rec.date + " по брокерскому договору N " + this.ClientDBOContrName() + " от " + this.ClientDBOContrDate() + ". НДС не облагается";
     elif( ВидРО == 8 )
       //BPV  Ground = "Оплата комиссии банку";
        Ground = "Комиссия брокера. Сделка "+IIF(this.deal.rec.kind == 32715,"СВОП ", "")+"N " + this.deal.rec.code + " от " + this.deal.rec.date + " по брокерскому договору N " + this.ClientDBOContrName() + " от " + this.ClientDBOContrDate() + ". НДС не облагается";
     elif( ВидРО == 33 )
        if( IsOut )
           Ground = "Оплата промежуточного платежа";
        else
           Ground = "Получение промежуточного платежа";
        end;
     elif( ВидРО == 34 )
        if( IsOut )
           if (this.deal.rec.kind == 32730) 
              ground = "Перевод средств по сделке " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
           elif (this.deal.rec.kind == 32715) 
              ground = "Перевод средств по сделке СВОП " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
           else
              Ground = "Исполнение обязательств";
           end;
        else
          if (this.deal.rec.kind == 32730) 
             ground = "Перевод средств по сделке " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
          elif (this.deal.rec.kind == 32715) 
             ground = "Перевод средств по сделке СВОП " + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
          else
            Ground = "Исполнение требований";
          end;
        end;
     elif( ВидРО == 35 )
        if ( IsOut )
           Ground = "Оплата штрафа";
        else
           Ground = "Получение штрафа";
        end;
     elif( ВидРО == 17 )
        Ground = "Удержание налога по сделке продажи";
     elif( ВидРО == 99 )
        if( IsOut )
           Ground = "Оплата ДМ по сделке покупки";
        else
           Ground = "Оплата ДМ по сделке продажи";
        end;
     elif( ВидРО == 100 )
        Ground = "Поставка ДМ по сделке покупки";
     elif( ВидРО == 101 )
        Ground = "Поставка ДМ по сделке продажи";
     end;

     return Ground;
  end;

  macro СчетПоДоговору( pFIID:integer, Contr:integer, BankName:@string )
     var sfcontr     = TBFile("sfcontr.dbt"),
         settacc     = TRecHandler("settacc.dbt"),
         ReceiverAcc = TRecHandler("account.dbt"),
         Result      = false;

     sfcontr.rec.ID = Contr;
     if( sfcontr.GetGE )
        if( SfSelectSETTACC( pFIID, OBJTYPE_SFCONTR, sfcontr, settacc ) == 0 )
           if( BankName != null )
              BankName = settacc.rec.BankName;
           end;
           Result = DV_GetAccount( 1, pFIID, settacc.rec.Account, ReceiverAcc );
        end;
     end;

     if( not Result )
        ReceiverAcc.Clear;
     end;

     return ReceiverAcc;
  end;

  macro СчетПосредника( pFIID:integer, BankName:@string )
     return СчетПоДоговору( pFIID, this.Deal.rec.AgentContr, @BankName );
  end;

  macro СчетКлиента( pFIID:integer )
     return СчетПоДоговору( pFIID, this.Deal.rec.ClientContr );
  end;

  /*получим стоимость:
   для поставочного - напрямую
   для расчетного - считать*/
  macro ПолучитьСтоимостьБАвВалютеЦены()
     var RetVal:money = $0.0;
     if( nFI_().rec.ExecType == DVSETTLEMET_STATE )
        RetVal = nFI_().rec.Cost;
     else
        if( (nFI_().rec.NKD != 0) and (ВалютаБазовогоАктива() != ВалютаЦены()) )
           var НКД:money = $0.0;
           if( not DV_SmartConvertSumDbl(НКД, nFI_().rec.NKD, ДатаСделки(), ВалютаБазовогоАктива(), ВалютаЦены()) )
              MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(ВалютаБазовогоАктива())) + " в " + string(ПолучитьКодФинИн(ВалютаЦены())) );
              НКД = $0.0;
           end;
           RetVal = nFI_().rec.Price * nFI_().rec.Amount + НКД;
        else
           RetVal = nFI_().rec.Price * nFI_().rec.Amount + nFI_().rec.NKD;
        end;
     end;

     return RetVal;
  end;

  private macro СуммаВВалюте( pDate:date, Валюта:integer, ВВалютеРасчетов:bool ):money

     var RetVal:money = $0.0;
     var Price:money = $0.0;
     var ContinueCalc:bool = true;

     if( (ВидБазовогоАктива(true) == FIKIND_AVOIRISS) and (ВВалютеРасчетов) and (ВалютаРасчётов() == NATCUR) and (ВалютаБазовогоАктива() != NATCUR) )
        var DealRate:double = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_DEALRATE);
        if( DealRate != 0.0 )
           ContinueCalc = false;
           /* переводим сначала в ВБА */
           if( not DV_SmartConvertSumDbl(RetVal, this.ПолучитьСтоимостьБАвВалютеЦены(), pDate, ВалютаЦены(), ВалютаБазовогоАктива()) )
              MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(ВалютаЦены())) + " в " + string(ПолучитьКодФинИн(ВалютаБазовогоАктива())) );
              RetVal = $0.0;
           else
              /* из ВБА переводим в ВР по курсу из примечания */
              RetVal = RetVal * DealRate;
           end;
        end;
     end;

     if( ContinueCalc )
        if( Валюта == this.ВалютаЦены() )
           RetVal = this.ПолучитьСтоимостьБАвВалютеЦены();
        else
           if( not DV_SmartConvertSumDbl(RetVal, this.ПолучитьСтоимостьБАвВалютеЦены(), pDate, this.ВалютаЦены(), Валюта) )
              MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(this.ВалютаЦены())) + " в " + string(ПолучитьКодФинИн(Валюта)) );
              RetVal = $0.0;
           end;
        end;
     end;

     return RetVal;
  end;

  private macro СуммаТребованияВнеб():money
     var RetVal:money = $0.0;

     if( (ВидБазовогоАктива(true) == FIKIND_AVOIRISS) or (ВидБазовогоАктива(true) == FIKIND_ARTICLE) OR (ВидБазовогоАктива(true) == FIKIND_INDEX) )
        var ВВалютеРасчетов:bool = false;
        var Валюта = ВалютаТребования(@ВВалютеРасчетов);
        RetVal = СуммаВВалюте( ДатаСделки(), Валюта, ВВалютеРасчетов );
     else
        RetVal = СуммаТребования();
     end;

     return RetVal;
  end;
 
  private macro СуммаОбязательстваВнеб():money
     var RetVal:money = $0.0;

     if( (ВидБазовогоАктива(true) == FIKIND_AVOIRISS) or (ВидБазовогоАктива(true) == FIKIND_ARTICLE) OR (ВидБазовогоАктива(true) == FIKIND_INDEX) )
        var ВВалютеРасчетов:bool = false;
        var Валюта = ВалютаОбязательства(@ВВалютеРасчетов);
        RetVal = СуммаВВалюте( ДатаСделки(), Валюта, ВВалютеРасчетов );
     else
        RetVal = СуммаОбязательства();
     end;

     return RetVal;
  end;

  macro ReqSum():money
     return IIF((IsPctSWAP() and (DealPart == 1)), СуммаОбязательстваВнеб(), СуммаТребованияВнеб());
  end;

  macro ReqSumFIID()
     return IIF((IsPctSWAP() and (DealPart == 1)), ВалютаОбязательства(), ВалютаТребования());
  end;

  macro ComSum():money
     return IIF((IsPctSWAP() and (DealPart == 1)), СуммаТребованияВнеб(), СуммаОбязательстваВнеб());
  end;

  macro ComSumFIID()
     return IIF((IsPctSWAP() and (DealPart == 1)), ВалютаТребования(), ВалютаОбязательства());
  end;

  macro ЧастьСделкиНеРанееТретьегоДня():bool
     return ((IsForwardZeroExecDate() == true) or (ДатаИсполненияЧасти() > GetDateAfterWorkDays(this.Deal.rec.Date, 2)));
  end;

  macro СделкаНеРанееТретьегоДня():bool
     return ((IsForwardZeroExecDate() == true) or (ДатаИсполнения() > GetDateAfterWorkDays(this.Deal.rec.Date, 2)));
  end;

  macro BuyCallOrSalePut()
     var RetVal:bool = false;
     if( (this.IsBuy() and (this.Deal.rec.OptionType == DVTYPE_CALL)) or
         (this.IsSale() and (this.Deal.rec.OptionType == DVTYPE_PUT)) )
        RetVal = true;
     end;

     return RetVal;
  end;

  macro IsSale_BuyPutOrSaleCall():bool
     var RetVal = false;
     if( ((this.IsOption() == false) and this.IsSale()) or
         ((this.IsOption() == true)  and (this.BuyCallOrSalePut() == false)) )
        RetVal = true;
     end;

     return RetVal;
  end;

  macro IsPayNalog():bool
     /* Контрагент - (юр. Лицо и нерезидент) и ставка налога НЕ равна 0 */
     var RetVal:bool = false;
     var Contractor = TRecHandler( "party.dbt" );
     var Rate = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(this.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RATE);
     if( (ПолучитьСубъекта(this.Deal.rec.Contractor, Contractor) == 0) and
         (Contractor.rec.LegalForm == 1) and
         (Contractor.rec.NotResident == SET_CHAR) and
         (Rate > 0.0) /* сделал > 0 */
       )
        RetVal = true;
     end;

     return RetVal;
  end;

  macro SumNalog( CalcDate:date ):money
     var RetVal:money = $0.0;
     var Rate = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(this.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RATE);
     RetVal = this.Deal.rec.Bonus * Rate / 100.0;
     if( not DV_SmartConvertSumDbl(RetVal, RetVal, CalcDate, this.Deal.rec.BonusFIID, NATCUR) )
        MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(this.Deal.rec.BonusFIID)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        RetVal = 0.0;
     else
        RetVal = money(round(RetVal, 2));
     end;

     return RetVal;
  end;

  PRIVATE MACRO ExistRecACDL( pDate:DATE, PayKind:integer ):BOOL
     var Query, Data;

     Query = RSDCommand( " SELECT t_id " +
                         "   FROM ddvnacdl_dbt " +
                         "  WHERE t_dealid  = ? " +
                         "    AND t_Date    = ? " +
                         "    AND t_PayKind = ? ");
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, pDate );
     Query.addParam("", RSDBP_IN, PayKind );
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() AND (Data.id > 0) )
        return true;
     end;

     return false;
  END;

  MACRO ВыполненУчетВариационнойМаржи( pDate:DATE ):BOOL
     return ExistRecACDL(pDate, DV_CALCOP_PAYKIND_MARGIN);
  END;

  MACRO ВыполненаПереоценкаПоИзменениям( pDate:DATE ):BOOL
     var RetVal:bool = false;
     var Query, Data;

     Query = RSDCommand( " SELECT count(1) cnt " +
                         "   FROM ddvoperps_dbt ps, ddvoper_dbt oper " +
                         "  WHERE ps.t_DocKind = ? " +
                         "    AND ps.t_DocID   = ? " +
                         "    AND ps.t_OperID  = oper.t_ID " +
                         "    AND oper.t_Date  = ? " +
                         "    AND oper.t_Flag1 = ? " );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Kind );
     Query.addParam("", RSDBP_IN, this.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, pDate );
     Query.addParam("", RSDBP_IN, DV_KIND_OVERVALUE_CHANGE );
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() AND (Data.cnt > 0) )
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO ВыполненаПереоценкаСС( pDate:DATE, pFrVal:TrecHandler ):BOOL
     VAR FrVal = TRecHandler("dvnfrval");

     if( FindDVNFRVAL( this.Deal.rec.Id, this.Deal.rec.DocKind, pDate, FrVal) != 0 )
        return false;
     end;

     if( pFrVal != NULL )
        Copy( pFrVal, FrVal );
     end;
     return true;
  END;

  macro GetLastFrValSum():money
     var RetVal:money = $0.0;
     var Query, Data;

     Query = RSDCommand( " select frval.t_FairValue   " +
                         "   from ddvnfrval_dbt frval " +
                         "  where frval.t_DealID = ?  " +
                         "    and frval.t_DocKind= ?  " +
                         " order by frval.t_Date desc, frval.t_ID desc" 
                       );
     Query.addParam("", RSDBP_IN, this.Deal.rec.ID);
     Query.addParam("", RSDBP_IN, this.Deal.rec.DocKind);
     Query.execute();
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() and (Data.FairValue != NULL) )
        RetVal = Data.FairValue;
     end;

     return RetVal;
  end;

  MACRO FairValueAlg():integer
     return nFI_BaseActiv.rec.FairValueAlg;
  END;

  MACRO DealRecHandler():TRecHandler
     VAR NDeal = TRecHandler("dvndeal");
     Copy(NDeal, this.Deal);
     return NDeal;
  END;

  macro InitialFI()/*исходный инструмент*/
     var BaseFIID:integer = ALLFININSTR;
     var FI = TRecHandler( "fininstr.dbt" );

     if( v_InitialFI == null )
        v_InitialFI = TRecHandler( "fininstr.dbt" );

        if( this.Deal.rec.Forvard == UNSET_CHAR )
           BaseFIID = nFI_BaseActiv.rec.FIID;
        else
           BaseFIID = nFI_Forward.rec.FIID;
        end;
        
        if( ПолучитьФинИн( BaseFIID, FI ) != 0 )
           MsgBox("Не найден финансовый инструмент (FIID = " + string(BaseFIID) + ")");
        end;
        
        v_InitialFI.clear();

        if( (FI.rec.FI_Kind == FIKIND_AVOIRISS) OR (FI.rec.FI_Kind == FIKIND_CURRENCY)
           OR (FI.rec.FI_Kind == FIKIND_ARTICLE) OR (FI.rec.FI_Kind == FIKIND_METAL) )
           copy( v_InitialFI, FI );
        elif( FI.rec.FI_Kind == FIKIND_INDEX )
           if( FI.rec.FaceValueFI == ALLFININSTR )
              copy( v_InitialFI, FI );
           else
              if( ПолучитьФинИн( FI.rec.FaceValueFI, v_InitialFI ) != 0 )
                 MsgBox("Не найден финансовый инструмент (FIID = " + string(FI.rec.FaceValueFI) + ")");
              end;
           end;
        end;
     end;

     return v_InitialFI;
  end;

  macro OptionType():string
     if( this.IsOption() == false )
        return "";
     end;
     if( this.IsOptionPut() )
        return "Put";
     else
        return "Call";
     end;
  end;

  macro OptionStyle():string
     if( this.IsOption() == false )
        return "";
     end;
     if( this.IsOptionAmerican() )
        return "American";
     else
        return "European";
     end;
  end;

  MACRO DvKindName( Pct:bool ):string
     if( this.IsForwardDealT3() )
        return "Покупка/продажа Т+3";     
     elif( this.IsForward() )
        return "Форвард";
     elif( this.IsOption() )
        return "Опцион";
     elif( this.IsSHORTSWAP() )
        return "Своп";
     elif( this.IsSWAP() )
         return "Валютный своп";
     elif( this.IsPctSWAP() )
        if( (Pct != NULL) and (Pct == true) and (not БазовыеВалютыРавны()) )
           return "Валютно-процентный своп";
        else
           return "Процентный своп";
        end;
     end;
     return "";
  END;

  MACRO PctSwapTypeName(isRSHB:bool):string
     if(this.IsPctSwap())
        if(isRSHB)
           if((this.Deal.rec.SwapType == DLSWAP_IRS) or (this.Deal.rec.SwapType == DLSWAP_OIS))
              return "IRS";
           elif(this.Deal.rec.SwapType == DLSWAP_XCCY)
              return "CIRS";
           else
              return "СВОП";
           end;
        else
           if(this.Deal.rec.SwapType == DLSWAP_IRS)
              return "IRS";
           elif(this.Deal.rec.SwapType == DLSWAP_OIS)
              return "OIS";
           elif(this.Deal.rec.SwapType == DLSWAP_XCCY)
              return "XCCY";
           else
              return "СВОП";
           end;
        end;
     elif(this.IsSWAP())
        return "СВОП";
     else
        return "";   
     end;
  END;

  /*проверяет, исполнена ли сделка*/
  MACRO IsDealExcecute(OnDate:Date,FactDate:@Date)
     var RetVal = false;
     var Query, Data, Sql;

     Sql = " SELECT step.t_Fact_Date " +
           "   FROM doprstep_dbt step, doproper_dbt oper " +
           "  WHERE oper.t_DocKind      = ? AND " +
           "        oper.t_DocumentID   = ? AND " +
           "        step.t_ID_Operation = oper.t_ID_Operation AND " +
           "        step.t_Symbol       in('i','Б','b') AND " +
           "        step.t_IsExecute    = chr(88) ";

     if( OnDate != null ) 
        Sql = Sql + 
              "     AND step.t_Fact_Date    <= ? ";
     end;

     Query = RSDCommand( Sql );

     Query.addParam("", RSDBP_IN, this.Kind );
     Query.addParam("", RSDBP_IN, UniID(this.Deal, OBJTYPE_OUTOPER_DV) );

     if( OnDate != null ) 
        Query.addParam("", RSDBP_IN, OnDate );
     end;

     Query.execute();
  
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() )
        FactDate = SQL_ConvTypeDate(Data.Fact_Date);
        RetVal = true;
     end;

     return RetVal;
  END;

  /*проверяет, отказ от исполнения сделки*/
  MACRO IsRejectDealExcecute(OnDate:Date,FactDate:@Date)
     var RetVal = false;
     var Query, Data, Sql;

     Sql = " SELECT step.t_Fact_Date " +
           "   FROM doprstep_dbt step, doproper_dbt oper " +
           "  WHERE oper.t_DocKind      = ? AND " +
           "        oper.t_DocumentID   = ? AND " +
           "        step.t_ID_Operation = oper.t_ID_Operation AND " +
           "        step.t_Symbol       in('у','щ') AND " +
           "        step.t_IsExecute    = chr(88) ";

     if( OnDate != null ) 
        Sql = Sql + 
           "    AND step.t_Fact_Date    <= ? ";
     end;

     Query = RSDCommand( Sql );

     Query.addParam("", RSDBP_IN, this.Kind );
     Query.addParam("", RSDBP_IN, UniID(this.Deal, OBJTYPE_OUTOPER_DV) );

     if( OnDate != null ) 
        Query.addParam("", RSDBP_IN, OnDate );
     end;

     Query.execute();
  
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() )
        FactDate = SQL_ConvTypeDate(Data.Fact_Date);
        RetVal = true;
     end;

     return RetVal;
  END;

  MACRO GetDatePmGr( Side:integer, OldDate:date ):date
     var RetVal:date = date(0,0,0);
     var Query, Data, Sql;

     Sql = " SELECT MIN(t_PayDate) as NewDate " +
           "   FROM ddvnpmgr_dbt " +
           "  WHERE t_DealID  = ? " +
           "    AND t_Side    = (case when ? = -1 then t_Side else ? end) " +
           "    AND t_PayDate > ? ";

     Query = RSDCommand( Sql );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, Side );
     Query.addParam("", RSDBP_IN, Side );
     Query.addParam("", RSDBP_IN, OldDate );
     Query.execute();
  
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() )
        RetVal = SQL_ConvTypeDate(Data.NewDate);
     end;

     return RetVal;
  END;

  MACRO GetPaymentsCount(): integer
     var RetVal = 0;
     var Query, Data;
     Query = RSDCommand( "SELECT COUNT(1) nRecs FROM ddvnpmgr_dbt WHERE t_DealID = ?" );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Deal.rec.ID );
     Query.execute();
  
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() )
        RetVal = Int(Data.nRecs);
     end;

     return RetVal;
  END;

  MACRO GetPmFloatRate(): money
     var RetVal = $0;
     var Query, Data, Sql;

     Sql = " SELECT t_FloatRateValue FROM ddvnpmgr_dbt "
            " WHERE t_DealID = ? and T_FLOATRATEVALUE <> 0 "
         " ORDER BY t_Side, t_BegDate";

     Query = RSDCommand( Sql );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, this.Deal.rec.ID );
     Query.execute();
  
     Data = TRsbDataSet(Query);
     if( Data.MoveNext() )
        RetVal = SQL_ConvTypeSum(Data.FloatRateValue);
     end;

     return RetVal;
  END;

  MACRO Netting():bool
     if (DealPart == 2)/*PNV 514305*/
         return this.Deal.rec.Netting2 == SET_CHAR;
     else
         return this.Deal.rec.Netting == SET_CHAR;
     end;
  END;

  MACRO Netting2():bool
     return this.Deal.rec.Netting2 == SET_CHAR;
  END;

  MACRO РольСчКорреспГлаваГВнб(pFiRole:integer)
     if( DealPart == 2 )
        if(pFiRole == FIROLE_CORACC_ACTIVE)
           return FIROLE_CORACC_ACTIVE_BACK;
        else
           return FIROLE_CORACC_PASSIVE_BACK;
        end;
     end;
     return pFiRole;
  END;

  MACRO СделкаСЦентральнымКонтрагентом()
     return ((Deal.rec.Contractor > 0) and ВидСубъекта(Deal.rec.Contractor, PTK_CENTRALCONTR));
  END;
  
  MACRO InsertFairValue(stepDate:date, newFV:money, currency:integer):bool
     if( currency != NATCUR )
        MsgBox("Загрузка СС в валюте, отличной от RUR, не поддерживается");
        return false;
        /*if( not DV_SmartConvertSumDbl(newFV, newFV, stepDate, currency, NATCUR, false) )
           MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(currency)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        end;*/
     else
        return DV_InsertFairValue(this.deal.rec.ID, this.deal.rec.DocKind, stepDate, newFV, currency);
     end;
  END;

  MACRO DV_OPERSTATUS_DOC():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_DOC, DV_OPERSTATUS_KIND_DOC);
  END;

  MACRO DV_OPERSTATUS_COTERMS():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_COTERMS, DV_OPERSTATUS_KIND_COTERMS);
  END;

  MACRO DV_OPERSTATUS_EXEC():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_EXEC, DV_OPERSTATUS_KIND_EXEC);
  END;

  MACRO DV_OPERSTATUS_DEMAND():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_DEMAND, DV_OPERSTATUS_KIND_DEMAND);
  END;

  MACRO DV_OPERSTATUS_LIABILITY():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_LIABILITY, DV_OPERSTATUS_KIND_LIABILITY);
  END;

  MACRO DV_OPERSTATUS_EXECTYPE():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_EXECTYPE, DV_OPERSTATUS_KIND_EXECTYPE);
  END;

  MACRO DV_OPERSTATUS_PAYM():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_PAYM, DV_OPERSTATUS_KIND_PAYM);
  END;

  MACRO DV_OPERSTATUS_PAYM_L():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_PAYM_L, DV_OPERSTATUS_KIND_PAYM_L);
  END;

  MACRO DV_OPERSTATUS_PAYM_D():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_PAYM_D, DV_OPERSTATUS_KIND_PAYM_D);
  END;

  MACRO DV_OPERSTATUS_COTERMS_2():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_COTERMS_2, DV_OPERSTATUS_KIND_COTERMS_2);
  END;

  MACRO DV_OPERSTATUS_DEMAND_2():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_DEMAND_2, DV_OPERSTATUS_KIND_DEMAND_2);
  END;

  MACRO DV_OPERSTATUS_LIABILITY_2():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_LIABILITY_2, DV_OPERSTATUS_KIND_LIABILITY_2);
  END;

  MACRO DV_OPERSTATUS_NETTING_PAYM_VM():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_NETTING_PAYM_VM, DV_OPERSTATUS_KIND_NETTING_PAYM_VM);
  END;

  MACRO DV_OPERSTATUS_NETTING_PAYM_OD():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_NETTING_PAYM_OD, DV_OPERSTATUS_KIND_NETTING_PAYM_OD);
  END;

  MACRO DV_OPERSTATUS_NETTING_PAYM_ED():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_NETTING_PAYM_ED, DV_OPERSTATUS_KIND_NETTING_PAYM_ED);
  END;

  MACRO DV_OPERSTATUS_EXEC_2():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_EXEC_2, DV_OPERSTATUS_KIND_EXEC_2);
  END;

  MACRO DV_OPERSTATUS_OFFBALANCE():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_OFFBALANCE, DV_OPERSTATUS_KIND_OFFBALANCE);
  END;

  MACRO DV_OPERSTATUS_OFFBALANCE_2():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_OFFBALANCE_2, DV_OPERSTATUS_KIND_OFFBALANCE_2);
  END;

  MACRO DV_OPERSTATUS_COMISS():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_COMISS, DV_OPERSTATUS_KIND_COMISS);
  END;

  MACRO DV_OPERSTATUS_KVIT_PAYM_GO():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_KVIT_PAYM_GO, DV_OPERSTATUS_KIND_KVIT_PAYM_GO);
  END;

  MACRO DV_OPERSTATUS_KVIT_PAYM_COM_BROKER():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_KVIT_PAYM_COM_BROKER, DV_OPERSTATUS_KIND_KVIT_PAYM_COM_BROKER);
  END;

  MACRO DV_OPERSTATUS_KVIT_PAYM_COM_BANK():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_KVIT_PAYM_COM_BANK, DV_OPERSTATUS_KIND_KVIT_PAYM_COM_BANK);
  END;

  MACRO DV_OPERSTATUS_KVIT_PAYM_COM():integer
     return IIF(this.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_KIND_KVIT_PAYM_COM, DV_OPERSTATUS_KIND_KVIT_PAYM_COM);
  END;

  /*DEF-51281*/
  MACRO ПолучитьНакопВарМаржу():money
	var que, cmd, rs;
	que = 	"SELECT NVL ( " + 
			"           SUM ( " + 
			"               CASE " + 
			"                   WHEN dvnac.t_direction = 1 THEN dvnac.t_sum * (-1) " + 
			"                   ELSE dvnac.t_sum " + 
			"               END), " + 
			"           0) marg_sum" + 
			"  FROM ddvnacdl_dbt dvnac " + 
			" WHERE dvnac.T_DEALID = ? AND dvnac.t_PayKind = 20 /*DV_CALCOP_PAYKIND_MARGIN*/ ";
	cmd = RSDCommand( que );
    cmd.addParam("", RSDBP_IN, this.Deal.rec.ID );
    cmd.execute();
  
    rs = TRsbDataSet(cmd);
    if( rs.MoveNext() )
		return money(rs.marg_sum);
	end;
	
	return $0;
  END;

  initDVFirst();
  this.Construct( DocKind, Oper, _nFI );
END;

/* ПД по биржевым сделкам */
CLASS (DVFirstDoc) DVFirstDocDeal( DocKind, Oper )
  VAR Deal = TBFile( "dvdeal", "R", 0 );
  var v_MarketScheme:TRecHandler;

  MACRO GetDoc()
     return Deal;
  END;

  MACRO InitParmArray()
      ParmA[MC_TYPE_PARAMETR_DOCKIND] = this.Kind;
      ParmA[MC_TYPE_PARAMETR_DOCID]   = this.ID;
  END;

  MACRO InitFIRoleBArray()
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIDOC;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BA;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FUTURES;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPTION;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_PRICEFI;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BA_NOTDV;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_ACTIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_PASSIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_NAT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_FRG;
  END;

  /*конструктор */
  MACRO Construct( DocKind, pDeal )
     if( ValType( pDeal ) == V_INTEGER )
        this.Deal.rec.ID = pDeal;

        if( not this.Deal.GetEQ() )
           this.SetError( "Не найдена сделка по ПИ (Id = " + string(pDeal) + ")" );
        end;
     elif( (ValType(pDeal) == V_STRUC) OR (ValType(pDeal) == V_FILE) OR (ValType(pDeal) == V_GENOBJ) )
        copy( Deal, pDeal );
     else
        this.SetError( "Неверные параметры инициализации объекта" );
     end;

     this.ID   = this.Deal.rec.Id;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  macro MarketScheme()
     if( v_MarketScheme == null )
        v_MarketScheme = Trechandler("dlmarket.dbt");

        if( Deal.rec.MarketSchemeID > 0 )
           DL_GetRecHandler(v_MarketScheme, " SELECT * FROM ddlmarket_dbt WHERE t_ID = " + string(Deal.rec.MarketSchemeID));
        end;
     end;

     return v_MarketScheme;
  end;

  macro GetCentrID():integer
     return MarketScheme().rec.Centr;
  end;

  macro GetCentrOfficeID():integer
     return MarketScheme().rec.CentrOffice;
  end;

  MACRO DealCode():String
     return Deal.rec.Code;
  END;

  MACRO IsBuy():bool
     return ((Deal.rec.Type == "B") OR (Deal.rec.Type == "D"));
  END;

  MACRO IsSale():bool
     return ((Deal.rec.Type == "S") OR (Deal.rec.Type == "G"));
  END;

  MACRO isClient():bool
     return (Deal.rec.Client > 0);
  END;

  MACRO DealWithFutures()
     return (FI.rec.AvoirKind == DERIVATIVE_FUTURES);
  END;

  MACRO DealWithOption()
     return (FI.rec.AvoirKind == DERIVATIVE_OPTION);
  END;

  MACRO isMargin()
     return ( (FI.rec.AvoirKind == DERIVATIVE_FUTURES) or (fideriv.rec.IsMarginOp == SET_CHAR) );
  END;

  MACRO DealWithOptionCALL()
     return (fideriv.rec.OptionType == DVTYPE_CALL);
  END;

  MACRO DealWithOptionPUT()
     return (fideriv.rec.OptionType == DVTYPE_PUT);
  END;

  MACRO УсловиеПоСтороне():bool
     return ( (IsBuy() and (DealWithFutures() or DealWithOptionCALL())) OR
              (IsSale() and DealWithOptionPUT()) );
  END;

  MACRO СтароеУсловиеПоСтороне():bool
     return УсловиеПоСтороне();
  END;

  MACRO УсловиеПоСторонеПоРасчЦене():bool
     return ( (IsBuy() and (DealWithFutures() or DealWithOptionPUT())) OR
              (IsSale() and DealWithOptionCALL()) );
  END;

  MACRO СтароеУсловиеПоСторонеПоРасчЦене():bool
     return УсловиеПоСторонеПоРасчЦене();
  END;

  MACRO ОснованиеПереносаПоСрокам( Требование:bool ):string
     var Ground:string = "";
     var vGround:string = "";//TEG
     var Query,Data;
     Query = " SELECT DEAL.t_fiid, DEAL.t_type , SUM(DEAL.t_amount) " +
              "   FROM ddvdeal_dbt DEAL " +
              "  WHERE 1=1 "// + DealOpenOnOperationDate(oper) +
              "    AND DEAL.t_Type = '" + deal.rec.type +"'"+//in('B', 'S', 'D', 'G') " +
              "    AND DEAL.t_State < " + string(DVDEAL_CLOSE) +
              "    AND DEAL.t_Client = -1 " +
              "    AND DEAL.t_FIID =  " + DEAL.rec.fiid +
              "    AND DEAL.t_Date <  " + GetSQLDate({curdate}) +
              "  GROUP BY DEAL.t_fiid, DEAL.t_type ";
   
     Data = TRsbDataSet(Query);
     if( Data )
       if ( Data.MoveNext() )
         vGround=Get_FinameDVFUN(DATA.value(0))+iif(DATA.value(1)=="S"," по продаже ПФИ "," по покупке ПФИ ")+", количество "+string(DATA.value(2):*:*,5,0);
       end;
     end;    
     //TEG
     if (УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_DEAL)//TEG 24.06.19
       if( Требование )
          Ground = "Перенос требований по срокам "+vGround;
       else
          Ground = "Перенос обязательств по срокам "+vGround;
       end;
     else 
       if( Требование )
          Ground = "Перенос требований по сделке: " + Deal.rec.Code;
       else
          Ground = "Перенос обязательств по сделке: " + Deal.rec.Code;
       end;
      end;
     return Ground;
  END;

  MACRO GetContractorID()
     return this.GetContractorID();
  END;

  macro IsSector():bool
     return (Deal.rec.Sector == SET_CHAR);
  end;

  MACRO GetBasisFIRole( FIRole, NoMsgErr )

     var i = 0;

     if( (FIRole == null) OR (FIRole == FIROLE_UNDEF) OR (FIRole == FIROLE_FIDOC) )
        return FIROLE_FIDOC;
     end;

     while( i < FIRoleBArray.Size )
        if( FIRoleBArray[i] == FIRole )
           return FIRole;
        end;
        i = i + 1;
     end;
     if( (NoMsgErr == null) OR (NoMsgErr == false) )
        this.SetError( "Неверно задана роль ФИ", false );
     end;

     return FIROLE_UNDEF;
  END;

  PRIVATE MACRO GetMC_TYPE_PARAMETR_FIID( FIRole )

     VAR Parametr = null;

     if( (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_PRICEFI) or (FIRole == FIROLE_FUTURES) or (FIRole == FIROLE_OPTION) )
        Parametr = FI.rec.FIID;
     elif( FIRole == FIROLE_BA_NOTDV )
        Parametr = BaseFI_NotDV.rec.FIID;
     elif( FIRole == FIROLE_BA )
        Parametr = FI.rec.FaceValueFI;
     elif( (FIRole == FIROLE_CORACC_ACTIVE) or (FIRole == FIROLE_CORACC_PASSIVE) )
        Parametr = GetFIIDForCorAccNum();
     end;

     return Parametr;
  END;

  /*Получить НЕкэшируемый параметр (меняющийся в зависимости от контекста вызова GetParametr())
    например для разных FIRole */
  PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole )

     VAR Rec_FI = TRecHandler( "fininstr.dbt" );
     VAR Parametr = null;

     /*фининструмент*/
     if( ParmKind == MC_TYPE_PARAMETR_FIID )
        Parametr = GetMC_TYPE_PARAMETR_FIID( FIRole );
     /* валюта номинала для ценных бумаг */
     elif( ParmKind == MC_TYPE_PARAMETR_CURRENCY ) 
        Parametr = GetMC_TYPE_PARAMETR_FIID( FIRole );
        if( Parametr != -1 )
           if( ПолучитьФинИн( Parametr, Rec_FI ) == 0 )
              if( Rec_FI.rec.FI_Kind == FIKIND_AVOIRISS ) 
                 Parametr = Rec_FI.rec.FaceValueFI;
              end;
           end;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_NUMBER )
        Parametr = this.Deal.rec.Code;
     elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
        if( FIRole == FIROLE_FIDOC )
           Parametr = GetContractorID();          
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
        if( Deal.rec.Broker == -1 )
           Parametr = GetCentrID();
        else
           Parametr = 0;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
        if( Deal.rec.Broker == -1 )
           if( CatCode == "Клиринговый счет" ) // 292992 - использование счетов по КУ "Клиринговый счет"
              Parametr = DV_GetSinglePoolOfficeID(Deal.rec.MarketSchemeID);
           else
           Parametr = GetCentrOfficeID();
           end;
        else
           Parametr = 0;
        end;
     end;

     return Parametr;
  END;

  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )

     VAR Parametr = null, InCache;

     if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
        return ParmA[ParmKind];
     end;

     /*пробуем определить значение среди некэшируемых параметров*/     
     Parametr = GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole );

     /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
     if( Parametr == null ) 
       InCache = true;

       /*кэшируемые параметры - эти параметры НЕ меняются после создания объекта класса, поэтому их можно занести в кэш*/
       if( ParmKind == MC_TYPE_PARAMETR_DEPARTMENT )
          Parametr = Deal.rec.Department;
       elif( ParmKind == MC_TYPE_PARAMETR_BEGDATE )
          Parametr = Deal.rec.Date;
       elif( ParmKind == MC_TYPE_PARAMETR_FINDATE ) /* дата базовая */
          Parametr = FI.rec.DrawingDate;
       /*контрагент*/ 
       elif( ParmKind == MC_TYPE_PARAMETR_CONTRACTOR )
          Parametr = GetContractorID();
       /*контрагент*/ 
       elif( ParmKind == MC_TYPE_PARAMETR_PARTY )
         //teg  Parametr = GetContractorID();
                Parametr = Deal.rec.Client;

       elif( ParmKind == MC_TYPE_PARAMETR_OWNER )
          if( Deal.rec.Client != -1 )
              Parametr = Deal.rec.Client;
          else
              Parametr = {OurBank};
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_CONTR_CLIENT ) 
          if( Deal.rec.Client != -1 )
              Parametr = Deal.rec.ClientContr;
          end;
       else
          InCache = false;
          Parametr = -1;
       end;

       if( InCache == true )
          ParmA[ParmKind] = Parametr;
       end;
     end;

     return Parametr;
  END;

  /*  получение параметров шаблонов для категорий учета       */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )         

     var Parametr:variant;
     var FindAttr:bool;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );           

     if( Parametr == -1 )
        /*Вид актива требований\Вид актива обязательств\Вид актива*/
        if( ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_REQ)  ) OR
            ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_COMM) ) OR
            ( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK) ) )
           if( (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_BA) )
              if( BaseFI().rec.FI_Kind == FIKIND_AVOIRISS )
                 Parametr = 3; /*Ценные бумаги*/
              elif( BaseFI().rec.FI_Kind == FIKIND_METAL )
                 Parametr = 2; /*Драг. металл*/
              elif( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
                 Parametr = 1; /*Денежные средства*/
              elif( BaseFI().rec.FI_Kind == FIKIND_DERIVATIVE )
                 Parametr = 6; /*Фьючерс*/
              elif( BaseFI().rec.FI_Kind == FIKIND_INDEX )
                if(BaseFI().rec.Settlement_Code == FI_INDEX_AVOIRISS)
                 Parametr = 8; /*Индекс*/
                else
                  Parametr = 1; /*Денежные средства*/
                end;
              elif( BaseFI().rec.FI_Kind == FIKIND_ARTICLE )
                 /*ВРЕМЕННОЕ РЕШЕНИЕ ДЛЯ ОШИБОЧНЫХ ФЬЮЧЕРСОВ НА ДМ*/
                 if(DealWithFutures() AND (not isClient())  and (FI.rec.Settlement_Code == DVSETTLEMET_CALC) AND
                     ((BaseFI().rec.FI_Code == "GOLD") OR 
                      (BaseFI().rec.FI_Code == "SILV") OR 
                      (BaseFI().rec.FI_Code == "PLT") OR 
                      (BaseFI().rec.FI_Code == "PLD") ))
                   Parametr = 2; /*Драгоценные металлы*/
                 else
                   Parametr = 7; /*Артикул*/
                 end;
              else
                 Parametr = 1; /*Денежные средства*/
              end;
           elif( FIRole == FIROLE_BA_NOTDV )
              if( FI.rec.Settlement_Code == DVSETTLEMET_STATE )
                 Parametr = 3;/*Ценные бумаги*/
              else
                 Parametr = 1; /*по умолчанию - Денежные средства*/
              end;
           elif( FIRole == FIROLE_PRICEFI )
              Parametr = 1;/*Денежные средства*/
           elif( (FIRole == FIROLE_FUTURES) or (FIRole == FIROLE_OPTION) )
              Parametr = 6;/*Фьючерс*/
           end;
        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_FI_KIND) )
           if( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
              Parametr = 1; /*Денежные средства*/
           elif( BaseFI().rec.FI_Kind == FIKIND_METAL )
              Parametr = 2; /*Драгоценные металлы*/
           end;
        elif( ObjectID == OBJTYPE_KINDRESERV )
           Parametr = 7; /*по срочным сделкам*/
        elif( Classificator == LLCLASS_KIND_MARG_FUTURES )
           Parametr = SourceFIMarginKind( this.FI, this.BaseFI );
        /*вид субъекта - категория эмитента доходы\расходы*/
        elif( (Classificator == LLCLASS_KINDSUBJ_ISSUER_DR) OR (Classificator == LLCLASS_KINDSUBJ_SHARE_ISSUER_DR) )
           Parametr = MC_GetKindIssuerDR( this.BaseFI.rec.Issuer, false );
        elif( ObjectID == OBJTYPE_KINDCB )
           if( Classificator == LLCLASS_KINDCB_DVKIND )
              if( FIRole == FIROLE_FUTURES )
                 Parametr = 100; /*Фьючерс*/ 
              elif( FIRole == FIROLE_OPTION )
                 Parametr = 101; /*Опцион*/ 
              end;
           end;
        elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
         /*ВРЕМЕННОЕ РЕШЕНИЕ*/
         if(DealWithFutures() AND (not isClient())  and (FI.rec.Settlement_Code == DVSETTLEMET_CALC) AND
                     ((BaseFI().rec.FI_Code == "GOLD") OR 
                      (BaseFI().rec.FI_Code == "SILV") OR 
                      (BaseFI().rec.FI_Code == "PLT") OR 
                      (BaseFI().rec.FI_Code == "PLD") ))
            Parametr = 4; /*Драг. металл*/
         else
           Parametr = Get_OBJTYPE_BA_DV();
           if (Parametr == 2)/*индекс*/
             if(BaseFI().rec.Settlement_Code != FI_INDEX_AVOIRISS)
              Parametr = 1;/*валюта*/
           end;
         end;
         end;
        elif( ObjectID == OBJTYPE_KIND_OPER_DV )
           Parametr = Get_OBJTYPE_KIND_OPER_DV();
        elif ( Classificator == LLCLASS_UNCS_FITYPE )
            if ((v_catcode == "+КВ, ц/б") and (this.kind == DL_DVDEAL))
               Parametr = 1; /*PNV 544548*/
            elif( BaseFI().rec.FI_Kind == FIKIND_CURRENCY )
                 /*Денежные средства*/
                if (BaseFI().rec.FIID==NATCUR)
                  Parametr = 1;
                else   
                  Parametr = 0; 
                end;  
            else
                 Parametr = 1; /*иначе в рублях*/
            end;
        end;
     end;

     return Parametr;
  END;

  macro ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut:bool )
    var Категория = "";  

     if( (ВидРО == 29) or (ВидРО == 28) or (ВидРО == 9) or (ВидРО == 10) )
        if( not IsOut )
           if(Deal.rec.Client > 0)
              Категория = "ДС Клиента, ВУ";
           else
              Категория = "ДС Банка, ВУ";
           end;
        else
           if(Deal.rec.Client > 0)
              Категория = "ДС, Расч. с клиентом, ВУ";
           else
              Категория = "ДС, Прч. счета банка, ВУ";
           end;
        end;
     elif( ВидРО == 8 )
        if(Deal.rec.Client > 0)
           Категория = "ДС, Расч. с клиентом, ВУ";
        end;
     end;

     return Категория;
  end;

  macro ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut:bool )
    var Категория = "";

     if( (ВидРО == 29) or (ВидРО == 28) or (ВидРО == 9) or (ВидРО == 10) )
        if( not IsOut )
           if(Deal.rec.Client > 0)
              Категория = "ДС, Расч. с клиентом, ВУ";
           else
              Категория = "ДС, Прч. счета банка, ВУ";
           end;
        else
           if(Deal.rec.Client > 0)
              Категория = "ДС Клиента, ВУ";
           else
              Категория = "ДС Банка, ВУ";
           end;
        end;
     elif( ВидРО == 8 )
        if(Deal.rec.Client > 0)
           Категория = "ДС Клиента, ВУ";
        end;
     end;

     return Категория;
  end;

  macro ВУ_ОснованиеПроводки( ВидРО, IsOut:bool )
    var Ground = "";

     if( ВидРО == 28 )
        if( not IsOut )
           Ground = "Зачисление вариационной маржи по сделке №"+Deal.rec.EXTCode;
        else
           Ground = "Списание вариационной маржи по сделке №"+Deal.rec.EXTCode;
        end;
     elif( ВидРО == 29 )
        if( not IsOut )
           Ground = "Зачисление премий по сделке №"+Deal.rec.EXTCode;
        else
           Ground = "Списание премий по сделке №"+Deal.rec.EXTCode;
        end;
     elif( ВидРО == 9 )
        Ground = "Оплата комиссии бирже по сделке №"+Deal.rec.EXTCode;
     elif( ВидРО == 10 )
        Ground = "Оплата комиссии брокеру по сделке №"+Deal.rec.EXTCode;
     elif( ВидРО == 8 )
        Ground = "Оплата комиссии банку по сделке №"+Deal.rec.EXTCode;
     end;

     return Ground;
  end;

  macro ПолучитьКалендВалютуВидаДаты(НомерДаты):integer
    return -1;
  end;

  macro ПолучитьКалендКонтрагент()
    return GetContractorID();
  end;

  macro ПолучитьКалендТип():integer
    return IIF(IsSector(),DL_CALLNK_MARKET,DL_CALLNK_OUTMARKET);
  end;

  macro ПолучитьКалендБиржа()
    return IIF(ПолучитьКалендТип() == DL_CALLNK_MARKET,ПолучитьКалендКонтрагент(),0);
  end;

  macro ПолучитьКалендСвязанный(dayType):integer
    var dTp = 0;
    if (ValType(dayType) == V_INTEGER)
      dTp = dayType;
    end;
    return DL_GetCalendByDynParam(158,makeArray(
        DL_KeyPair("Object",DL_CalendGetOperNameByKind(this.Deal.rec.Kind)),
        DL_KeyPair("ObjectType",ПолучитьКалендТип()),
        DL_KeyPair("Market",ПолучитьКалендБиржа()),
        DL_KeyPair("DayType",dTp)
      )
    );
  end;

MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)
    var BalAcc;
    var vBankName="Банк НКЦ (АО)";
    const ИД_НКЦ = 1181; 
    private macro GetPFIType ()
      var type = "";
      if (Deal.rec.Kind == 12690)
        type = "Внебиржевой форвард";
      elif (Deal.rec.Kind == 12695)
        type = "Внебиржевой опцион";
      elif (Deal.rec.Kind == 22710)
        type = "Валютный СВОП";
      elif (Deal.rec.Kind == 22720)
        type = "Процентный СВОП";
      elif (Deal.rec.Kind == 12735)
        type = "Банкнотная сделка";
      elif ((Deal.rec.Kind == 2715) or (Deal.rec.Kind == 12715))
        type = "СВОП"; 
      end;
      return type;
   End;
   if( not CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate) )
       return false;
   end;
    /*
        933  ФЬЮЧЕРС. Требование по поставке денежных средств по RTS-9.19, контрагент Банк  НКЦ (АО)  
        937  Требование по поставке RTS-3.19, контрагент НКЦ    
        963  ФЬЮЧЕРС. Обязательства по поставке денежных средств по RTS-6.19, контрагент Банк  НКЦ (АО)  
        967  RTS-3.19 Обязательства  по поставке RTS-3.19, контрагент НКЦ  
        47407 Расчеты по обязательствам по контракту RTS-9.19 от 17/06/2019. Банк НКЦ (АО) 
        47408 Расчеты по требованиям по контракту RTS-6.19 от 19/03/2019. Банк  НКЦ (АО) 
        52601 Фьючерсный контракт RTS-9.19. ПФИ, от которых ожидается получение экономических выгод.Фьючерсный контракт RTS-9.19   
        52602 Фьючерсный контракт RTS-9.19. ПФИ, по которым ожидается уменьшение экономических выгод.Фьючерсный контракт RTS-9.19  
        61601 ФЬЮЧЕРС. Вспомогательный счет для расчетов по контракту RTS-9.19   
 
    */
   //TEG 25.06.19 ролевая модель   
   /* Определяем конечного операциониста для проводки */
     if ((this.kind==140) or (this.kind==152) or (this.kind==4626) or (this.kind==4627))
         Account.rec.Oper = GetMainOperInGroup(this.kind);
     elif (this.kind==194)
         Account.Rec.Oper = GetMainOperInGroup(this.kind,this.DVOPER.rec.operkind);
     elif(this.kind==199)
        if(this.ВидБазовогоАктива() == FIKIND_AVOIRISS)
            Account.Rec.Oper = GetMainOperInGroup(101);
        else
            Account.Rec.Oper = GetMainOperInGroup(this.kind,deal.rec.kind);
        end;
     else  
           Account.Rec.Oper = GetMainOperInGroup(this.kind,deal.rec.kind);
     end;

     if (Account.Rec.Oper <= 0)
         Account.Rec.Oper = {Oper};
     end;
   /**/
   if ((categ.rec.Code == "+Форвард, дрейф1") or (categ.rec.code == "-Форвард, дрейф1") ) 
       BalAcc=SubStr(Account.rec.Account,1,3);
       if ( (BalAcc=="933"))
              Account.rec.NameAccount = "ФЬЮЧЕРС. Требование по поставке денежных средств по "+Get_FinameDVFUN (Deal.rec.Fiid)+" контрагент "+vBankName;  
       elif ((BalAcc=="937") )
              Account.rec.NameAccount = "Требование по поставке "+Get_FinameDVFUN (Deal.rec.Fiid)+", контрагент " +vBankName; 
       elif ( (BalAcc=="963"))
              Account.rec.NameAccount = "ФЬЮЧЕРС. Обязательства по поставке денежных средств по "+Get_FinameDVFUN (Deal.rec.Fiid)+", контрагент "+vBankName; 
       elif ((BalAcc=="967") )
              Account.rec.NameAccount = "Обязательства  по поставке "+Get_FinameDVFUN (Deal.rec.Fiid)+", контрагент "+vBankName ; 
       elif (BalAcc=="934") 
              Account.rec.NameAccount = "ФЬЮЧЕРС. Требование по поставке "+Get_FinameDVFUN (Deal.rec.Fiid)+" контрагент "+vBankName;  
       elif (BalAcc=="964") 
              Account.rec.NameAccount = "ФЬЮЧЕРС. Обязательства по поставке "+Get_FinameDVFUN (Deal.rec.Fiid)+", контрагент "+vBankName; 
       end; 
       Account.rec.Client = ИД_НКЦ; 
   elif (categ.rec.code == "Выбытие ПФИ1")
        BalAcc=SubStr(Account.rec.Account,1,3);
        if ( (BalAcc=="616"))
             Account.rec.NameAccount = "ФЬЮЧЕРС. Вспомогательный счет для расчетов по контракту "+Get_FinameDVFUN (Deal.rec.Fiid);
        end;
   elif  ((categ.rec.Code == "+ПФИ1") or (categ.rec.code == "-ПФИ1") )
        BalAcc=SubStr(Account.rec.Account,1,5);
        if ( BalAcc=="52601")
             Account.rec.NameAccount = "Фьючерсный контракт "+Get_FinameDVFUN (Deal.rec.Fiid)+". ПФИ, от которых ожидается получение экономических выгод.Фьючерсный контракт "+vBankName;
        elif  (BalAcc=="52602")
             Account.rec.NameAccount = "Фьючерсный контракт "+Get_FinameDVFUN (Deal.rec.Fiid)+". ПФИ, по которым ожидается уменьшение экономических выгод.Фьючерсный контракт "+vBankName;
        end;
   elif  ((categ.rec.Code == "+Форвард, РПИ1") or (categ.rec.code == "-Форвард, РПИ1") )
       BalAcc=SubStr(Account.rec.Account,1,5);
       if  (BalAcc=="47407")
             Account.rec.NameAccount = "Расчеты по обязательствам по контракту "+Get_FinameDVFUN (Deal.rec.Fiid)+" от "+StrSubSt(String(Deal.rec.Date:f), ".", "/")+". "+vBankName;
       elif (BalAcc=="47408")
             Account.rec.NameAccount = "Расчеты по требованиям по контракту "+Get_FinameDVFUN (Deal.rec.Fiid)+" от "+StrSubSt(String(Deal.rec.Date:f), ".", "/")+". "+vBankName; //GetPartyNames(Deal.rec.Contractor, 2);
       end;
   /*PNV 526800*/
    elif  ((categ.rec.Code == "Расходы ПФИ0") or (categ.rec.code == "Доходы ПФИ0") or (categ.rec.Code == "Расходы ПФИ") or (categ.rec.code == "Доходы ПФИ") )
          if ((categ.rec.Code == "Расходы ПФИ0") or (categ.rec.Code == "Расходы ПФИ") )
              Account.rec.NameAccount = "Расходы от операций с производными финансовыми инструментами, базисным активом которых являются";
          else
               Account.rec.NameAccount = "Доходы от операций с производными финансовыми инструментами, базисным активом которых являются";
          end;
          if (templ.rec.number == 1) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - фьючерс";
          elif (templ.rec.number == 2) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - форвард";
          elif (templ.rec.number == 3) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - опцион";
          elif (templ.rec.number == 4) 
              Account.rec.NameAccount = Account.rec.NameAccount + " иностранная валюта - СВОП";
          elif (templ.rec.number == 5) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - фьючерс";
          elif (templ.rec.number == 6) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - форвард";
          elif (templ.rec.number == 7) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - опцион";
          elif (templ.rec.number == 8) 
              Account.rec.NameAccount = Account.rec.NameAccount + " процетные ставки - СВОП";
          elif (templ.rec.number == 9) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - фьючерс";
          elif (templ.rec.number == 10) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - форвард";
          elif (templ.rec.number == 11) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - опцион";
          elif (templ.rec.number == 12) 
              Account.rec.NameAccount = Account.rec.NameAccount + " ценные бумаги - СВОП";
          elif (templ.rec.number == 13) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - фьючерс";
          elif (templ.rec.number == 14) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - форвард";
          elif (templ.rec.number == 15) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - опцион";
          elif (templ.rec.number == 16) 
              Account.rec.NameAccount = Account.rec.NameAccount + " драгоценные металлы - СВОП";
          elif (templ.rec.number == 17) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - фьючерс";
          elif (templ.rec.number == 18) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - форвард";
          elif (templ.rec.number == 19) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - опцион";
          elif (templ.rec.number == 20) 
              Account.rec.NameAccount = Account.rec.NameAccount + " другие базисные активы - СВОП";         
          end;
     /*PNV 526800*/
   end;
  end;  

  initDVFirstDoc();
  this.Construct( DocKind, Oper );
END;

/* ПД по строке графика платежей */
CLASS (DVFirst) DVFirstDocPmGr( DocKind, Oper )
  VAR PmGr = TBFile("dvnpmgr", "R", 0),
      DealFD:DVFirstDocNDeal; /* FD по 2-ой части сделки */

  MACRO GetDoc()
     return PmGr;
  END;

  MACRO InitParmArray()
      ParmA[MC_TYPE_PARAMETR_DOCKIND] = this.Kind;
      ParmA[MC_TYPE_PARAMETR_DOCID]   = this.ID;
  END;

  MACRO InitFIRoleBArray()
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIREQ;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FICOM;
  END;

  MACRO GetBasisFIRole( FIRole, NoMsgErr )
     return FIRole;
  END;

  /*конструктор */
  MACRO Construct( DocKind, pPmGr )
     if( ValType( pPmGr ) == V_INTEGER ) 
        this.PmGr.rec.ID = pPmGr;

        if( not this.PmGr.GetEQ() ) 
           this.SetError( "Не найдена строка графика промежуточных платежей (Id = " + string(pPmGr) + ")" );
        end;
     elif( (ValType(pPmGr) == V_STRUC) OR (ValType(pPmGr) == V_FILE) OR (ValType(pPmGr) == V_GENOBJ) )
        copy( PmGr, pPmGr );
     else
        this.SetError( "Неверные параметры инициализации объекта" );        
     end; 

     DealFD = DVFirstDocNDeal(DL_DVNDEAL, PmGr.rec.DealID, 2);

     this.ID   = this.PmGr.rec.Id;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  /*Получить НЕкэшируемый параметр (меняющийся в зависимости от контекста вызова GetParametr())
    например для разных FIRole */
  PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null;
     return Parametr;
  END;

  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null, InCache;

     if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
        return ParmA[ParmKind];
     end;

     /*пробуем определить значение среди некэшируемых параметров*/
     Parametr = GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole );

     /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
     if( Parametr == null ) 
       InCache = true;

       /*кэшируемые параметры - эти параметры НЕ меняются после создания объекта класса, поэтому их можно занести в кэш*/
       if( ParmKind == MC_TYPE_PARAMETR_BEGDATE )
          Parametr = DealFD.ДатаСделки();
       elif( ParmKind == MC_TYPE_PARAMETR_FINDATE )
          Parametr = PmGr.rec.PayDate;
       else
          InCache = false;
          Parametr = DealFD.GetParametr(ParmKind, OperDate, CatCode, FIRole);
       end;

       if( InCache == true )
          ParmA[ParmKind] = Parametr;
       end;
     end;

     return Parametr;
  END;

  /*  получение параметров шаблонов для категорий учета       */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )
     var Parametr;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );           

     if( Parametr == -1 )
        Parametr = DealFD.GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );
     end;

     return Parametr;
  END;

  MACRO Department():integer
     return DealFD.Department();
  END;

  MACRO ReqSum():money
     return PmGr.rec.DemandSum;
  END;

  MACRO ComSum():money
     return PmGr.rec.LiabilitySum;
  END;

  /*PNV*/
  MACRO EndDate():date
     return PmGr.rec.EndDate;
  END;

  MACRO BegDate():date
     return PmGr.rec.BegDate;
  END;
  /*PNV*/

  macro GetPidFromAccMigr():integer
    var pid = "",sql,rs;
    if (PmGr.rec.SIDE == 1)
      pid = SubStr(PmGr.rec.LIABILITYACCOUNT,4,2);
    else
      pid = SubStr(PmGr.rec.DEMANDACCOUNT,4,2);
    end;
    if (pid != "")
      sql = "SELECT p.t_id FROM dmcperiod_dbt p WHERE p.t_id BETWEEN 43 AND 53 AND p.t_periodcode = "+pid;
      rs = ExecSqlSelect(sql);
      if(rs.MoveNext())
        return rs.value(0);
      end;
    end;
    return 0;
  end;

  MACRO ОснованиеПереносаПоСрокам( Требование:bool ):string
     var Ground:string = "";
     if( Требование )
        Ground = "ПФИ (" + DealFD.PctSwapTypeName(true) + "). Перенос требований по промежуточному платежу за период с " + StrSubSt(String(BegDate():f), ".", "/")  + " по " + StrSubSt(String(EndDate():f), ".", "/") + " по сделке " + DealFD.DealCode() + " от " + StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") + ". К/агент: " + GetPartyNames(DealFD.Deal.rec.Contractor, 2)[0];
     else
        Ground = "ПФИ (" + DealFD.PctSwapTypeName(true) + "). Перенос обязательств по промежуточному платежу за период с " + StrSubSt(String(BegDate():f), ".", "/")  + " по " + StrSubSt(String(EndDate():f), ".", "/") + " по сделке " + DealFD.DealCode() + " от " + StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") + ". К/агент: " + GetPartyNames(DealFD.Deal.rec.Contractor, 2)[0];
     end;

     return Ground;
  END;
    /*SVE*/
   MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)
    var BalAcc;
    private macro GetPFIType ()
      var type = "";
      if (DealFD.Deal.rec.Kind == 12690)
        type = "Внебиржевой форвард";
      elif (DealFD.Deal.rec.Kind == 12695)
        type = "Внебиржевой опцион";
      elif (DealFD.Deal.rec.Kind == 22710)
        type = "Валютный СВОП";
      elif (DealFD.Deal.rec.Kind == 22720)
        type = "Процентный СВОП";
      elif (DealFD.Deal.rec.Kind == 12735)
        type = "Банкнотная сделка";
      elif ((DealFD.Deal.rec.Kind == 2715) or (DealFD.Deal.rec.Kind == 12715))/*MDA 25.02.2019*/
        type = "СВОП"; 
      end;
      return type;
    End;
    if( not CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate) )
       return false;
    end;

   //TEG 25.06.19 ролевая модель   
   /* Определяем конечного операциониста для Счета */
   if ((DealFD.kind==140) or (DealFD.kind==152) or (DealFD.kind==4626) or (DealFD.kind==4627))
         Account.rec.Oper = GetMainOperInGroup(DealFD.kind);
   elif(DealFD.kind==199)
        if(DealFD.ВидБазовогоАктива() == FIKIND_AVOIRISS)
              Account.rec.Oper = GetMainOperInGroup(101);
        else
              Account.rec.Oper = GetMainOperInGroup(DealFD.kind,DealFD.deal.rec.kind);
       end;
   else  
         Account.rec.Oper = GetMainOperInGroup(DealFD.kind,DealFD.deal.rec.kind);
   end;

   if (Account.rec.Oper <= 0)
        Account.rec.Oper = {Oper};
   end;
    /*939, 933 - Требования по поставке денежных средств (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ
      969, 963 - Обязательства по поставке денежных средств (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ
      940 - Требования по поставке ДМ (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ
      970 - Обязательства по поставке ДМ (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ*/
    if ( (categ.rec.Code == "+Форвард, прочие0")  or (categ.rec.Code == "-Форвард, прочие0") or (categ.rec.Code == "+Форвард, дрейф внебирж") or (categ.rec.code == "-Форвард, дрейф внебирж")  or (categ.rec.code == "-Форвард, дрейф внебирж0"))  /*KOA ID : 537216*/
       BalAcc=SubStr(Account.rec.Account,1,3);
       if ((BalAcc=="939") or (BalAcc=="933"))
	      if(categ.rec.Code == "+Форвард, прочие0")
		    Account.rec.NameAccount = "ПФИ (" + GetPFIType() + ") Требования по поставке денежных средств (валютный рынок ММВБ).";  
          elif (DealFD.IsPctSWAP())     /*PNV i-support 488706*/ 
              Account.rec.NameAccount = DealFD.Deal.rec.Code + " ПФИ. Требования к " + GetPartyNames(DealFD.Deal.rec.Contractor, 2)[0] + " по сделке от "+ StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") ;  /*SVE*/
          else
              Account.rec.NameAccount = "ПФИ (" + GetPFIType() + ") Требования по поставке денежных средств (валютный рынок ММВБ). Сделка "+DealFD.Deal.rec.Code +" от "+ StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") ;  /*SVE*/
		  end; 
       elif ((BalAcc=="969") or (BalAcc=="963"))
	      if(categ.rec.Code == "-Форвард, прочие0")
		    Account.rec.NameAccount = "Обязательства по поставке денежных средств (валютный рынок ММВБ)."; 
          elif (DealFD.IsPctSWAP())     /*PNV i-support 488706*/ 
              Account.rec.NameAccount = DealFD.Deal.rec.Code + " ПФИ. Обязательства перед " + GetPartyNames(DealFD.Deal.rec.Contractor, 2)[0] + " по сделке от "+ StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") ;  /*SVE*/
          else
              Account.rec.NameAccount = "ПФИ (" + GetPFIType() + ") Обязательства по поставке денежных средств (валютный рынок ММВБ). Сделка "+DealFD.Deal.rec.Code +" от "+ StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") ;  /*SVE*/
          end; 
       elif (BalAcc=="940")
	      if(categ.rec.Code == "+Форвард, прочие0")
            Account.rec.NameAccount = " Требования по поставке ДМ (валютный рынок ММВБ). "; 
          else
		    Account.rec.NameAccount = DealFD.Deal.rec.Code + " Требования по поставке ДМ (валютный рынок ММВБ). Сделка от "+ StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") ; 
		  end;
	   elif (BalAcc=="970")
	      if(categ.rec.Code == "-Форвард, прочие0")
            Account.rec.NameAccount = " Обязательства по поставке ДМ  (валютный рынок ММВБ). "; 
          else
		    Account.rec.NameAccount = DealFD.Deal.rec.Code + " Обязательства по поставке ДМ  (валютный рынок ММВБ). Сделка от "+ StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") ; 
          end;
	   end; 
    /*PNV i-support 488706*/   
    elif (categ.rec.code == "-Форвард, дрейф Проц.СВОП")
        Account.rec.NameAccount = DealFD.Deal.rec.Code + " ПФИ. Обяз. по промеж. плат. по сд. от " + StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") + " за период с " + StrSubSt(String(BegDate():f), ".", "/") + " по " + StrSubSt(String(EndDate():f), ".", "/"); /*GAA: 521289*/
//old:        Account.rec.NameAccount = DealFD.Deal.rec.Code + " ПФИ. Обязательства по промежуточному платежу по сделке от " + StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") + " за период с " + StrSubSt(String(BegDate():f), ".", "/") + " по " + StrSubSt(String(EndDate():f), ".", "/");
        if (DealFD.Deal.rec.Type == ALG_DV_FIX_FLOAT) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по фикс. ставке";
        elif (DealFD.Deal.rec.Type == ALG_DV_FLOAT_FIX) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по плав. ставке";
        elif (DealFD.Deal.rec.Type == ALG_DV_FIX_FIX) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по фикс. ставке";
        elif (DealFD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по плав. ставке";
        end;
        Account.rec.NameAccount = Account.rec.NameAccount  + " К/агент: " + GetPartyNames(DealFD.Deal.rec.Contractor, 2)[0] ; 
    elif (categ.rec.code == "+Форвард, дрейф Проц.СВОП")
        Account.rec.NameAccount = DealFD.Deal.rec.Code + " ПФИ. Треб. по промеж. плат. по сд. от " + StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") + " за период с " + StrSubSt(String(BegDate():f), ".", "/")  + " по " + StrSubSt(String(EndDate():f), ".", "/"); /*GAA: 521289*/
//old:        Account.rec.NameAccount = DealFD.Deal.rec.Code + " ПФИ. Требования по промежуточному платежу по сделке от " + StrSubSt(String(DealFD.Deal.rec.Date:f), ".", "/") + " за период с " + StrSubSt(String(BegDate():f), ".", "/")  + " по " + StrSubSt(String(EndDate():f), ".", "/");
        if (DealFD.Deal.rec.Type == ALG_DV_FIX_FLOAT) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по плав. ставке";
        elif (DealFD.Deal.rec.Type == ALG_DV_FLOAT_FIX) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по фикс. ставке";
        elif (DealFD.Deal.rec.Type == ALG_DV_FIX_FIX) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по фикс. ставке";
        elif (DealFD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT) 
            Account.rec.NameAccount = Account.rec.NameAccount  + " по плав. ставке";
        end;
        Account.rec.NameAccount = Account.rec.NameAccount  + " К/агент: " + GetPartyNames(DealFD.Deal.rec.Contractor, 2)[0] ; 
    end;
    /*PNV i-support 488706*/
    return true;
  END;

  macro OpenAccByGenAgr():bool
     return DealFD.OpenAccByGenAgr();
  end;

  macro GenAgr()
     return DealFD.GenAgr();
  end;

  macro GetGenAgrCode():string
     return DealFD.GetGenAgrCode();
  end;

  macro GetGenAgrCodeInAccount(): string
    return DealFD.GetGenAgrCodeInAccount();
  end;

  initDVFirst();
  this.Construct(DocKind, Oper);
END;

/* ПД по конверсионным сделкам */
CLASS (DVFirst) DVFirstDocFXDeal( DocKind, Oper, _DealPart:INTEGER, _nFI )
  VAR Deal = TBFile("dvndeal", "R", 0),
      nFI = TRecHandler("dvnfi"),
      DealPart = 1,
      Group:integer,
      v_pm_BA:TRecHandler, 
      v_dt_BA:TRecHandler, 
      v_ct_BA:TRecHandler, 
      v_rm_BA:TRecHandler, 
      v_pm_CA:TRecHandler, 
      v_dt_CA:TRecHandler, 
      v_ct_CA:TRecHandler,
      v_rm_CA:TRecHandler,
      v_BaseFI:TRecHandler,
      v_GenAgr:TRecHandler,
      v_MarketScheme:TRecHandler;

  if( _DealPart != NULL )
     DealPart = _DealPart;
  end;

  macro InitParmArray()
     ParmA[MC_TYPE_PARAMETR_DOCKIND] = this.Kind;
     ParmA[MC_TYPE_PARAMETR_DOCID]   = this.ID;
  end;

  macro InitFIRoleBArray()
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIREQ;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FICOM;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_ACTIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_PASSIVE;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_ACTIVE_BACK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_CORACC_PASSIVE_BACK;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_COMISS_CLIENT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIRST_OVERVAL;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_SECOND_OVERVAL;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_BA;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_RESERV_RSOP;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_NAT;
     FIRoleBArray[FIRoleBArray.Size] = FIROLE_OPCL_MOEX_FRG;
  end;

  macro GenAgr()
     if( v_GenAgr == null )
        v_GenAgr = Trechandler("dl_genagr.dbt");

        if( this.Deal.rec.GenAgrID > 0 )
           DL_GetRecHandler(v_GenAgr, " SELECT * FROM ddl_genagr_dbt WHERE t_GenAgrID = " + string(this.Deal.rec.GenAgrID));
        end;
     end;

     return v_GenAgr;
  end;

  macro GetGenAgrCode():string
     return GenAgr().rec.Code;
  end;

  macro GetGenAgrExtCode():string
     return GenAgr().rec.ExtCode;
  end;
  macro GetGenAgrCodeInAccount(): string
    return GenAgr().rec.CodeInAccount;
  end;

  macro OpenAccByGenAgr():bool
     var RetVal:bool = false;

     if( (GenAgr().rec.GenAgrID > 0) and (GenAgr().rec.AccMode == 2) )
        RetVal = true;
     end;

     return RetVal;
  end;

  macro MarketScheme()
     if( v_MarketScheme == null )
        v_MarketScheme = Trechandler("dlmarket.dbt");

        if( Deal.rec.MarketSchemeID > 0 )
           DL_GetRecHandler(v_MarketScheme, " SELECT * FROM ddlmarket_dbt WHERE t_ID = " + string(Deal.rec.MarketSchemeID));
        end;
     end;

     return v_MarketScheme;
  end;

  macro GetMarketSchemeCode():string
     return MarketScheme().rec.Code;
  end;

  macro GetCentrID():integer
     return MarketScheme().rec.Centr;
  end;

  macro GetCentrOfficeID():integer
     return MarketScheme().rec.CentrOffice;
  end;

  private macro IsDealHasState(statusKind:integer)
    var query = 
      " SELECT curs.T_NUMVALUE " 
     +"   FROM doprcurst_dbt curs, doproper_dbt oper " 
     +"  WHERE oper.t_DocKind      = ? AND " 
     +"        oper.t_DocumentID   = ? AND " 
     +"        curs.t_ID_Operation = oper.t_ID_Operation AND " 
     +"        curs.t_statuskindid = ? AND"
     +"        curs.t_dockind      = oper.t_DocKind ";
    var cmd = DL_RSDCommand(query);
    cmd.addParam(this.Kind);
    cmd.addParam(UniID(this.Deal, OBJTYPE_OUTOPER_DV));
    cmd.addParam(statusKind);
    var DataSet = cmd.Execute();
    return DataSet.moveNext();
  end;

  macro IsBuy():bool
     return ( (this.Deal.rec.Type == ALG_DV_BUY) OR
              ( (this.Deal.rec.Type == ALG_DV_BS) AND (this.DealPart == 1) ) OR
              ( (this.Deal.rec.Type == ALG_DV_SB) AND (this.DealPart == 2) )
            );
  end;

  macro IsSale():bool
     return ( (this.Deal.rec.Type == ALG_DV_SALE) OR
              ( (this.Deal.rec.Type == ALG_DV_BS) AND (this.DealPart == 2) ) OR
              ( (this.Deal.rec.Type == ALG_DV_SB) AND (this.DealPart == 1) )
            );
  end;

  macro IsSalePart():bool
     return IsSale();
  end;

  macro IsBuyPart():bool
     return IsBuy();
  end;

  macro IsSWAP()
     return IsDVFXSWAP(Group);
  end;

  macro IsBNote()
     return IsDVFXBNOTE(Group);
  end;

  macro IsDealMet()
     return IsDVFXDEALMET(Group);
  end;

  macro pm_BA() /* платеж по БА */
     var PmKind;

     if( v_pm_BA == null )
        v_pm_BA = Trechandler("pmpaym.dbt");
        v_dt_BA = Trechandler("pmprop.dbt");
        v_ct_BA = Trechandler("pmprop.dbt");
        v_rm_BA = Trechandler("pmrmprop.dbt");

        if( DealPart == 2 )
           PmKind = BRi;
        else
           PmKind = BAi;
        end;

        if( FindPayment(null, PmKind, 0, /*DL_DVFXDEAL*/int(kind), this.Deal.rec.ID, true, v_pm_BA, v_dt_BA, v_ct_BA, v_rm_BA) != 0 )
           this.SetError("Не найден платеж по базовому активу для сделки " + this.DealCode());
        end;
     end;

     return v_pm_BA;
  end;

  macro pm_CA() /* платеж по контрактиву */
     var PmKind;

     if( v_pm_CA == null )
        v_pm_CA = Trechandler("pmpaym.dbt");
        v_dt_CA = Trechandler("pmprop.dbt");
        v_ct_CA = Trechandler("pmprop.dbt");
        v_rm_CA = Trechandler("pmrmprop.dbt");

        if( DealPart == 2 )
           PmKind = CRi;
        else
           PmKind = CAi;
        end;

        if( FindPayment( null, PmKind, 0, /*DL_DVFXDEAL*/int(kind), this.Deal.rec.ID, true, v_pm_CA, v_dt_CA, v_ct_CA, v_rm_CA) != 0 )
           this.SetError("Не найден платеж по контрактиву для сделки " + this.DealCode());
        end;  
     end;

     return v_pm_CA;
  end;

  macro ПлатежТреб():TRecHandler
     if( IsSalePart() )
        return pm_CA();
     else
        return pm_BA();
     end;
  end; 

  macro ПлатежОб():TRecHandler
     if( IsSalePart() )
        return pm_BA();
     else
        return pm_CA();
     end;
  end;

  macro ПолучитьЦенуБезНДС()
    var cost = this.nFI.rec.Cost;
    if (IsDealMet())
      cost = cost - IIF((this.nFI.rec.VatSum >= $0), this.nFI.rec.VatSum, $0);
    end;
    return cost;
  end;

  macro IsClient():bool
     return (this.Deal.rec.Client > 0);
  end;

  MACRO IsCurrMarket():bool
     return ((this.Deal.rec.ClientContr > 0) and (GetSfContr(Deal.rec.ClientContr).rec.ServKind == PTSK_CM));
  END;

  macro ВалютныйРынок():bool
     return (this.Deal.rec.MarketKind==DV_MARKETKIND_CURRENCY);
  end;

  macro РынокСПФИ():bool
     return (this.Deal.rec.MarketKind==DV_MARKETKIND_SPFIMARKET);
  end;

  macro ФондовыйРынок():bool
     return (this.Deal.rec.MarketKind==DV_MARKETKIND_STOCK);
  end;

  macro IsSector():bool
     return (this.Deal.rec.Sector == SET_CHAR);
  end;

  macro Биржевая():bool
     return IsSector();
  end;

  macro БиржеваяСделкаНаВалРынке():bool
     return (this.Биржевая() and this.ВалютныйРынок());
  end;

  macro БиржеваяСделкаСПФИ()
     return (this.Биржевая() and this.РынокСПФИ() and (this.Deal.rec.TypeSPFI == DV_TYPE_SPFI_EXCHANGE));
  end;

  macro ВнеБиржеваяСделкаСПФИ()
     return (this.Биржевая() and this.РынокСПФИ() and (this.Deal.rec.TypeSPFI == DV_TYPE_SPFI_OTC));
  end;

  macro КонтрагентБиржа():bool
     return (ВидСубъекта(this.Deal.rec.Contractor, PTK_MARKETPLASE));
  end;

  macro КонтрагентНКЦ():bool
     return ВидСубъекта(this.Deal.rec.Contractor, PTK_CENTRALCONTR);
  end;

  macro СрокСделки():integer
     return this.Deal.rec.PeriodCls;
  end;

  macro БиржеваяСделка():bool
     return Биржевая();   //ВнеБиржеваяСделкаСПФИ() в общем случае тоже является биржевой и отличается только в обращение с вар- и деп- маржей
  end;

  macro БиржеваяСделкаКромеВнебиржСПФИ():bool
     return (Биржевая() and (not ВнеБиржеваяСделкаСПФИ()));   
  end;
        
  macro СобствБиржеваяСделка():bool
     return ((not IsClient()) and БиржеваяСделка());
  end;

  macro ВалютаТребования():integer
     var RetVal:integer = ALLFININSTR;

     if( IsBuyPart() )
        RetVal = nFI.rec.FIID;
     elif( IsSalePart() )
        RetVal = nFI.rec.PriceFIID;
     end;

     return RetVal;
  end;

  macro ВалютаОбязательства():integer
     var RetVal:integer = ALLFININSTR;

     if( IsSalePart() )
        RetVal = nFI.rec.FIID;
     elif( IsBuyPart() )
        RetVal = nFI.rec.PriceFIID;
     end;

     return RetVal;
  end;

  macro БивалютнаяСделка():bool
    if ( (ВалютаОбязательства() == NATCUR) or (ВалютаТребования() == NATCUR) )
      return false;
    else
      return true;
    end;
  end;

  macro ПолучитьКалендВалютуВидаДаты(НомерДаты):integer
    var dateNumber = НомерДаты;
    var idOpr,idStep,docKind,docId;
    if ((not DL_CheckCallFromStep()) and (ValType(dateNumber)!=V_INTEGER))
      return -2;
    end;
    if (ValType(dateNumber)!=V_INTEGER)
      DL_GetCalendCurOperStepData(docKind, idOpr, idStep, docId);
      dateNumber = DL_GetDateKindByOprID(idOpr,IDStep);
    end;
    if (DL_Calend_DV_AddCheck(this, dateNumber))
      if (DL_Calend_DV_DateDefineIsReq(Kind, dateNumber))
         return ВалютаТребования();
      elif (DL_Calend_DV_DateDefineIsObl(Kind, dateNumber))
         return ВалютаОбязательства();
      end;
    end;
    return -1;
  end;

  macro ПолучитьКалендКонтрагент()
    return IIF(this.Deal.rec.MarketID > 0, this.Deal.rec.MarketID, this.Deal.rec.Contractor);
  end;

  macro ПолучитьКалендТип():integer
    return IIF(Биржевая(),DL_CALLNK_MARKET,DL_CALLNK_OUTMARKET);
  end;

  macro ПолучитьКалендБиржа()
    return IIF(ПолучитьКалендТип()==DL_CALLNK_MARKET,ПолучитьКалендКонтрагент(),0);
  end;

  macro ПолучитьКалендСвязанный(dayType):integer
    var dTp = 0;
    var curId;
    if (ValType(dayType) == V_INTEGER)
      dTp = dayType;
    end;
    var params = makeArray(
        DL_KeyPair("Object",DL_CalendGetOperNameByKind(this.Kind_Operation())),
        DL_KeyPair("ObjectType",ПолучитьКалендТип()),
        DL_KeyPair("Market",ПолучитьКалендБиржа()),
        DL_KeyPair("Currency",this.ВалютаБазовогоАктива()),
        DL_KeyPair("DayType",dTp)
      );
    if (Биржевая())
      curId = ПолучитьКалендВалютуВидаДаты();
      if (curId > 0)
        params[params.size] = DL_KeyPair("Currency",curId);
      end;
      if (ВалютныйРынок())
        params[params.size] = DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_CUR);
      elif (РынокСПФИ())
        params[params.size] = DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_SPFI);
      elif (ФондовыйРынок())
        params[params.size] = DL_KeyPair("MarketPlace",DL_CALLNK_MARKETPLACE_SEC);
      end;
    end;
    return DL_GetCalendByDynParam(158,params);
  end;

  macro УстановитьКалендРанРасч(DateNumb):integer
    var stat = 0;
    var query = 
       " SELECT T_BLOCKID"
      +"   FROM DOPROSTEP_DBT opro"
      +"  WHERE     opro.T_BLOCKID IN (SELECT T_BLOCKID"
      +"                                 FROM DOPROBLCK_DBT"
      +"                                WHERE T_KIND_OPERATION = ?)"
      +"        AND OPRO.T_DATEKINDID = ?";
    var cmd = DL_RSDCommand(query);
    cmd.addParam(this.Kind_Operation());
    cmd.addParam(DL_GetDateKindIdByKindNumb(DateNumb, Kind));
    var DataSet = cmd.Execute();
    while (DataSet.moveNext() and (stat == 0))
      if ((DataSet.BlockId == 273004) or (DataSet.BlockId == 20000239) or (DataSet.BlockId == 20000247) or (DataSet.BlockId == 40001122) or (DataSet.BlockId == 40001273) )
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
          stat = 1;
        end;
      elif ((DataSet.BlockId == 273005) or (DataSet.BlockId == 20000240) or (DataSet.BlockId == 20000248) or (DataSet.BlockId == 40001123) or (DataSet.BlockId == 40001274))
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
          stat = 1;
        end;
      elif (DataSet.BlockId == 274001)
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND_2, DV_FX_OPERSTATUS_DL_RUN) )
          stat = 1;
        end;
      elif (DataSet.BlockId == 274002)
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY_2, DV_FX_OPERSTATUS_DL_RUN) )
          stat = 1;
        end;
      end;
    end;
    if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_EARLY_SETTLEMENT, DV_EARLY_SETT_OPERSTATUS_YES) )
      stat = 1;
    end;
    return stat;
  end;

  macro ОдновалютнаяБанкнотная()
     return (IsBNote() and (ВалютаТребования() == ВалютаОбязательства()));
  end;

  private macro ВидАктива( FIID:integer ):integer
     var RetVal:integer = FIKIND_ALLFI;
     var FI = TRecHandler("fininstr.dbt");

     if( ПолучитьФинИн(FIID, FI) != 0 )
        MsgBox("Не найден финансовый инструмент (FIID = " + string(FIID) + ")");
     else
        RetVal = FI.rec.FI_Kind;
     end;

     return RetVal;
  end;

  macro ВалютаБазовогоАктива():integer
     return nFI.rec.FIID;
  end;

  macro ВалютаКонтрАктива():integer
     return nFI.rec.PriceFIID;
  end;

  macro ВидБазовогоАктива():integer
     return ВидАктива(ВалютаБазовогоАктива());
  end;

  macro ВидКонтрАктива():integer
     return ВидАктива(ВалютаКонтрАктива());
  end;

  macro ВидАктиваТребования():integer
     return ВидАктива(ВалютаТребования());
  end;

  macro ВидАктиваОбязательства():integer
     return ВидАктива(ВалютаОбязательства());
  end;

  macro КонтрагентКлиент():bool
     return ВидСубъекта(this.Deal.rec.Contractor, PTK_CLIENT);
  end;

  macro РольСчКорреспГлаваГВнб( pFiRole:integer ):integer
     if( DealPart == 2 )
        if( pFiRole == FIROLE_CORACC_ACTIVE )
           return FIROLE_CORACC_ACTIVE_BACK;
        else
           return FIROLE_CORACC_PASSIVE_BACK;
        end;
     end;
     return pFiRole;
  end;

  MACRO КредитнаяОрганизацияХранилищаДрагМеталла(ID)
   var MetStorage  = TBfile("dvmetstorage.dbt");
   MetStorage.KeyNum = 0;
   MetStorage.rec.ID = ID;

   if(MetStorage.GetEQ())
      return MetStorage.rec.BankID;
   end; 
      
   return -1;
  END;

  PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole )

     var Parametr = null;

     if( ParmKind == MC_TYPE_PARAMETR_FIID )
        if( FIRole == FIROLE_FIREQ )
           if ((CatCode == "+Форвард, прочие0") OR (CatCode == "-Форвард, прочие0"))
             Parametr = this.ВалютаБазовогоАктива();
           else
             Parametr = ВалютаТребования();
           end;
        elif( FIRole == FIROLE_FICOM )
           if ((CatCode == "+Форвард, прочие0") OR (CatCode == "-Форвард, прочие0"))
             Parametr = this.ВалютаБазовогоАктива();
           else
             Parametr = ВалютаОбязательства();
           end;
        elif( (FIRole == FIROLE_CORACC_ACTIVE) or (FIRole == FIROLE_CORACC_PASSIVE) or (FIRole == FIROLE_CORACC_ACTIVE_BACK) or (FIRole == FIROLE_CORACC_PASSIVE_BACK) )
           Parametr = GetFIIDForCorAccNum();
        elif( (FIRole == FIROLE_BA) or (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_FIRST_OVERVAL) or (FIRole == FIROLE_SECOND_OVERVAL)) /*PNV*/
           Parametr = this.ВалютаБазовогоАктива();
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_PAYCURRENCY	 )
      if ((CatCode == "+Форвард, прочие0") OR (CatCode == "-Форвард, прочие0"))
        if( FIRole == FIROLE_FIREQ )
             Parametr = ВалютаТребования();
        elif( FIRole == FIROLE_FICOM )
             Parametr = ВалютаОбязательства();
        elif( (FIRole == FIROLE_CORACC_ACTIVE) or (FIRole == FIROLE_CORACC_PASSIVE) or (FIRole == FIROLE_CORACC_ACTIVE_BACK) or (FIRole == FIROLE_CORACC_PASSIVE_BACK) )
           Parametr = GetFIIDForCorAccNum();
        elif( (FIRole == FIROLE_BA) or (FIRole == FIROLE_FIDOC) or (FIRole == FIROLE_FIRST_OVERVAL) or (FIRole == FIROLE_SECOND_OVERVAL)) /*PNV*/
           Parametr = this.ВалютаБазовогоАктива();
        end;
      end;
     elif( (ParmKind == MC_TYPE_PARAMETR_CONTRACTOR) or (ParmKind == MC_TYPE_PARAMETR_PARTY) )
        if( FIRole == FIROLE_COMISS_CLIENT )
           Parametr = this.Deal.rec.Client;
        else
           Parametr = this.Deal.rec.Contractor;
        end;
     elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
         if(IsDealMet())
            Parametr = КредитнаяОрганизацияХранилищаДрагМеталла(this.nFI.rec.BankStorage);
         else
        Parametr = this.РКЦБанкИзСПИ(GetNonCacheParametr(MC_TYPE_PARAMETR_FIID, OperDate, CatCode, FIRole)); 
     end;
     end;

     return Parametr;
  END;

  MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole )
     VAR Parametr = null, InCache;

     if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
        return ParmA[ParmKind];
     end;

     /*пробуем определить значение среди некэшируемых параметров*/     
     Parametr = GetNonCacheParametr(ParmKind, OperDate, CatCode, FIRole);

     /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
     if( Parametr == null ) 
       InCache = true;

       /*кэшируемые параметры - эти параметры НЕ меняются после создания объекта класса, поэтому их можно занести в кэш*/
       if( ParmKind == MC_TYPE_PARAMETR_DEPARTMENT )
          Parametr = this.Deal.rec.Department;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
          if( ВалютныйРынок() )
             Parametr = GetCentrID();
          else
             Parametr = 0;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
          if( ВалютныйРынок() )
             Parametr = GetCentrOfficeID();
          else
             Parametr = 0;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_NUMBER )
          Parametr = this.Deal.rec.Code;
       elif( ParmKind == MC_TYPE_PARAMETR_OWNER )
          if( this.Deal.rec.Client != -1 )
              Parametr = this.Deal.rec.Client;
          else
              Parametr = {OurBank};
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_CONTR_CLIENT ) 
          Parametr = this.Deal.rec.ClientContr;
       elif( ParmKind == MC_TYPE_PARAMETR_BEGDATE )
          Parametr = this.Deal.rec.Date;
       elif( ParmKind == MC_TYPE_PARAMETR_FINDATE)
          if( (FIRole == FIROLE_FIREQ) )
             Parametr = this.ДатаТребования();
          elif( (FIRole == FIROLE_FICOM) )
             Parametr = this.ДатаОбязательства();
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_PLACESTORAGE )
         Parametr = this.nFI.rec.BankStorage;
       elif( ParmKind == MC_TYPE_PARAMETR_ACCTYPE )
         var Client = TBfile("party.dbt");
         if( ПолучитьСубъекта(this.Deal.rec.Client, Client) == 0 ) 
            if ((ВидСубъекта(Client.rec.PartyID, PTK_CLIENT) AND ВидСубъекта(Client.rec.PartyID, PTK_BANK)) OR
                 ВидСубъекта(Client.rec.PartyID, PTK_DEPOSITORY) OR ВидСубъекта(Client.rec.PartyID, PTK_BROKER))
               Parametr = 2; // счет внутреннего учета другого профессионального участника
            else
               Parametr = 1; // специальный брокерский счет в драгоценных металлах
            end;
         end;
       else
          InCache = false;
          Parametr = -1;
       end;

       if( InCache == true )
          ParmA[ParmKind] = Parametr;
       end;
     end;

     return Parametr;
  END;

  /*  получение параметров шаблонов для категорий учета */
  MACRO GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole )
     var Parametr;

     FIRole   = GetBasisFIRole( FIRole );
     Parametr = GetParametrTemplate( ObjectID, Classificator, OperDate, FIRole );

     if( Parametr == -1 )
        if( (ObjectID == OBJTYPE_KINDFI) AND ( (Classificator == LLCLASS_KIND_AKT_REQ) OR (Classificator == LLCLASS_FI_KIND) )  )
           if( FIRole == FIROLE_BA )
              if( ВидБазовогоАктива() == FIKIND_METAL )
                 Parametr = 2; /*Драгоценные металлы*/
              else
                 Parametr = 1; /*Денежные средства*/
              end;
           else
              if( ВидАктиваТребования() == FIKIND_METAL )
                 Parametr = 2; /*Драгоценные металлы*/
              else
                 Parametr = 1; /*Денежные средства*/
              end;
           end;

        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_COMM) )
           if( ВидАктиваОбязательства() == FIKIND_METAL )
              Parametr = 2; /*Драгоценные металлы*/
           else
              Parametr = 1; /*Денежные средства*/
           end;

        elif( (ObjectID == OBJTYPE_FX_DEALPART) AND (Classificator == LLCLASS_KIND_FX_DEALPART) )
           
           if( FIRole == FIROLE_FIRST_OVERVAL )
             Parametr = 1; //первая часть 
           else
              Parametr = 2; //вторая часть
           end;

        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK) )
           Parametr = 1; /*Денежные средства*/
        elif( (ObjectID == OBJTYPE_KINDCLCB) AND (Classificator == LLCLASS_CATEG_CONTR_FOREX) )
           if( КонтрагентБиржа() )
              Parametr = 3;
           elif( КонтрагентКлиент() )
              Parametr = 1;
           end;
        elif( (ObjectID == OBJTYPE_SECTORMARKT) AND (Classificator == LLCLASS_SECTR_MARKET_BANK_OP) )
           Parametr = 2;
        elif( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           if( ВидБазовогоАктива() == FIKIND_METAL )
              Parametr = 4; /*Драг. металл*/
           elif( ВидБазовогоАктива() == FIKIND_CURRENCY )
              Parametr = 1; /*Валюта*/
           end;
        elif( (ObjectID == OBJTYPE_KIND_ACCOUNT_CALC) AND (Classificator == LLCLASS_KIND_ACC_IN_FUTURES) )
           Parametr = 4;
        elif( ObjectID == OBJTYPE_KIND_OPER_DV )
           if( IsSWAP() )
              Parametr = 4; /*Своп*/
           end;
        elif( (ObjectID == OBJTYPE_METAL_STORAGE) AND (Classificator == LLCLASS_METAL_STORAGE) )
            var BankStorageID = КредитнаяОрганизацияХранилищаДрагМеталла(this.nFI.rec.BankStorage);
            if( BankStorageID == {ourbank} )
               Parametr = 1; // Наш банк
            else
               var BankStorage = TBfile("party.dbt");
               if( ПолучитьСубъекта(BankStorageID, BankStorage) == 0 ) 
                  if (ВидСубъекта(BankStorage.rec.PartyID, PTK_BANK) AND (BankStorage.rec.NotResident == SET_CHAR))
                     Parametr = 3; // Кредитная организация нерезидент (не наш банк)
                  elif(ВидСубъекта(BankStorage.rec.PartyID, PTK_BANK) AND (BankStorage.rec.NotResident == UNSET_CHAR))
                     Parametr = 2; // Кредитная организация резидент (не наш банк)
                  end;
               end;
            end;
         elif((ObjectID == OBJTYPE_KIND_METALL) AND (Classificator == LLCLASS_KIND_METALL))
            var FI = TRecHandler("fininstr.dbt");
            if( ПолучитьФинИн(ВалютаБазовогоАктива(), FI) != 0 )
               MsgBox("Не найден финансовый инструмент (FIID = " + string(ВалютаБазовогоАктива()) + ")");
            else
               if( ((FI.rec.FI_code == "GOLD") OR (FI.rec.FI_code == "A98"))   AND (КредитнаяОрганизацияХранилищаДрагМеталла(this.nFI.rec.BankStorage) == {ourbank}) )
                  Parametr = 1; // Золото
               elif( ((FI.rec.FI_code != "GOLD")  OR (FI.rec.FI_code != "A98") )AND (КредитнаяОрганизацияХранилищаДрагМеталла(this.nFI.rec.BankStorage) == {ourbank}) )
                  Parametr = 2; // Кроме золота
               else 
                  Parametr = 3; // Любой
               end;
            end;
        elif ( Classificator == LLCLASS_UNCS_FITYPE ) //teg шаблонный вариант. Если нужно банку иначе надо уточнять алгоритм
            /*bpv*/
            if ((ObjectID = 1611) and IsClient() and ВалютныйРынок())
               if (nfi.rec.pricefiid != 0)
                  Parametr = 0;
               else   
                  Parametr = 1; 
               end;  
            else
            if(  ВидБазовогоАктива() == FIKIND_CURRENCY )
                 /*Денежные средства*/
                if (ВалютаБазовогоАктива()==NATCUR)
                  Parametr = 1;
                else   
                  Parametr = 0; 
                end;  
            else
                  Parametr = 1; /*иначе в рублях*/
            end;
           end;
        elif ( Classificator == 5023 )/*PNV*/
            if(( FIRole == FIROLE_FIREQ ) or ( FIRole == FIROLE_FIRST_OVERVAL)) 
                if( ВидАктиваТребования() == FIKIND_METAL )
                    Parametr = 2; /*Драгоценные металлы*/
                else
                    Parametr = 1; /*Денежные средства*/
                end;
            elif( ( FIRole == FIROLE_FICOM ) or ( FIRole == FIROLE_SECOND_OVERVAL)) 
                if( ВидАктиваОбязательства() == FIKIND_METAL )
                    Parametr = 2; /*Драгоценные металлы*/
                else
                    Parametr = 1; /*Денежные средства*/
                end;
            end;
        end;

     end;

     return Parametr;
  END;

  MACRO ВУ_ПолучитьРольФИ( ВидРО, DebCred, IsOut:bool )
     var FIRole = FIROLE_UNDEF;
       
     if( (ВидРО == 34) or (ВидРО == 8) )
        if( IsOut )
           FIRole = FIROLE_FICOM;
        else
           FIRole = FIROLE_FIREQ;
        end;
     end;

     return FIRole;
  END;

  macro ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut:bool )
     var Категория = "";

     if( ВидРО == 34 )
        if( IsOut )
           if( IsClient() )
              Категория = "ДС, Расч. с клиентом, ВУ";
           else
              Категория = "ДС, Прч. счета банка, ВУ";
           end;
        else
           if( IsClient() )
              Категория = "ДС Клиента, ВУ";
           else
              Категория = "ДС Банка, ВУ";
           end;
        end;
     elif( (ВидРО == 12) or (ВидРО == 9) )
        if( IsClient() )
           Категория = "ДС, Расч. с клиентом, ВУ";
        else
           Категория = "ДС, Прч. счета банка, ВУ";
        end;
     elif( ВидРО == 8 )
        if( IsClient() )
           Категория = "ДС, Расч. с клиентом, ВУ";
        end;
     elif( ВидРО == 17 )
         Категория = "ДС, Расч. с клиентом, ВУ";
     elif( ВидРО == 99 )
         if( IsClient() )
            if(IsOut)
               Категория = "ДС, Расч. с клиентом, ВУ";
            else
               Категория = "ДС Клиента, ВУ";
            end;
        end;
     elif( ВидРО == 100 )
         if( IsClient() )
            Категория = "ДМ клиента, ВУ";
         end;
     elif( ВидРО == 101 )
         if( IsClient() )
           Категория = "ДМ, Расч. С клиентом, ВУ";
        end;
     end;
     return Категория;
  end;

  macro ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut:bool )
     var Категория = "";

     if( ВидРО == 34 )
        if( IsOut )
           if( IsClient() )
              Категория = "ДС Клиента, ВУ";
           else
              Категория = "ДС Банка, ВУ";
           end;
        else
           if( IsClient() )
              Категория = "ДС, Расч. с клиентом, ВУ";
           else
              Категория = "ДС, Прч. счета банка, ВУ";
           end;
        end;
     elif( (ВидРО == 12) or (ВидРО == 9) )
        if( IsClient() )
           Категория = "ДС Клиента, ВУ";
        else
           Категория = "ДС у брокера, ВУ";
        end;
     elif( ВидРО == 8 )
        if( IsClient() )
           Категория = "ДС Клиента, ВУ";
        end;
     elif( ВидРО == 17 )
         Категория = "ДС Клиента, ВУ";
     elif( ВидРО == 99 )
         if( IsClient() )
            if(IsOut)
               Категория = "ДС Клиента, ВУ";
            else
               Категория = "ДС, Расч. с клиентом, ВУ";
            end;
        end;
     elif( ВидРО == 100 )
         if( IsClient() )
            Категория = "ДМ, Расч. С клиентом, ВУ";
         end;
     elif( ВидРО == 101 )
         if( IsClient() )
           Категория = "ДМ клиента, ВУ";
        end;
     end;

     return Категория;
  end;

  macro ВУ_ОснованиеПроводки( ВидРО, IsOut:bool )
     var Ground = "";

     if( ВидРО == 12 )
        Ground = "Оплата комиссий посреднику";
     elif( ВидРО == 9 )
        // bpv ОснованиеПроводкиПИ(DV_GRNUM_COMM_MARKET);
        Ground = "Комиссия биржи. Сделка "+IIF(this.deal.rec.kind == 32715, "СВОП ", "")+"N " + this.deal.rec.code + " от " + this.deal.rec.date + " по брокерскому договору N " + this.ClientDBOContrName() + " от " + this.ClientDBOContrDate() + ". НДС не облагается";
     elif( ВидРО == 8 )
//bpv        Ground = "Оплата комиссии банку";
        Ground = "Комиссия брокера. Сделка "+IIF(this.deal.rec.kind == 32715, "СВОП ", "")+"N " + this.deal.rec.code + " от " + this.deal.rec.date + " по брокерскому договору N " + this.ClientDBOContrName() + " от " + this.ClientDBOContrDate() + ". НДС не облагается";
     elif( ВидРО == 34 )
        if( IsOut )
//bpv           Ground = "Исполнение обязательств";
         ground = "Перевод средств по сделке "+IIF(this.deal.rec.kind == 32715, "СВОП ", "")+ this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
        else
//bpv           Ground = "Исполнение требований";
         ground = "Перевод средств по сделке "+IIF(this.deal.rec.kind == 32715, "СВОП ", "") + this.deal.rec.code + " от " + String(this.deal.rec.date:f ) + ", дата валютирования " + String(this.nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
        end;
     elif( ВидРО == 17 )
        Ground = "Удержание налога по сделке продажи";
     elif( ВидРО == 99 )
        if( IsOut )
           Ground = "Оплата ДМ по сделке покупки";
        else
           Ground = "Оплата ДМ по сделке продажи";
        end;
     elif( ВидРО == 100 )
        Ground = "Поставка ДМ по сделке покупки";
     elif( ВидРО == 101 )
        Ground = "Поставка ДМ по сделке продажи";
     end;

     return Ground;
  end;

  /* конструктор */
  MACRO Construct( DocKind, pDeal, pFI ) 

     if( ValType( pDeal ) == V_INTEGER ) 
        this.Deal.rec.ID = pDeal;

        if( not this.Deal.GetEQ() ) 
           this.SetError( "Не найдена конверсионная сделка по (Id = " + string(pDeal) + ")" );
        end;
     elif( (ValType(pDeal) == V_STRUC) OR (ValType(pDeal) == V_FILE) OR (ValType(pDeal) == V_GENOBJ) )
        copy(Deal, pDeal);
     else
        this.SetError( "Неверные параметры инициализации объекта" );        
     end; 

     if( ValType(pFI) == V_GENOBJ )
        copy( nFI, pFI );
     elif( FindDVNFI(this.Deal.rec.Id, IIF( DealPart == 2, DV_NFIType_BaseActiv2, DV_NFIType_BaseActiv ), nFI) != 0 )
        this.SetError( "Не найден актив внебиржевой операции (DealID = " + string(this.Deal.rec.Id) + ", Type = " + string(IIF( DealPart == 2, DV_NFIType_BaseActiv2, DV_NFIType_BaseActiv )) + ")" );
     end;

     Group = DV_GetOperationGroup(this.Deal.rec.Kind);

     this.ID   = this.Deal.rec.ID;
     this.Kind = DocKind;

     InitParmArray(); /*инициализация массива параметров*/
     InitFIRoleBArray();
  END;

  macro ДатаСделки():DATE
     return this.Deal.rec.Date;
  end;

  macro ДатаИсполнения(FromOprDate):DATE
     var RetVal:date = date(0,0,0);
     if ((ValType(FromOprDate) == V_BOOL) and (FromOprDate == true))
       RetVal = DV_GetDateKindVal(this.Kind, this.ID, IIF(DealPart == 2,DV_FXDEAL_OPRDATE_EXEC_2,DV_FXDEAL_OPRDATE_EXEC));
       if (RetVal > date(0,0,0))
         return RetVal;
       else
         return nFI.rec.EXECDATE;
       end;
     else
       return nFI.rec.EXECDATE;
     end;
  end;


  macro ДатаИсполненияСвопа():DATE
    var RetVal = date(0,0,0);
    var sql,rs;

    sql = "SELECT d.t_execdate FROM ddvnfi_dbt d WHERE d.t_type = 2 AND d.t_dealid = "+this.Deal.rec.id;
    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      RetVal = rs.value(0);
    end;
    return RetVal;
  end;

  macro ДатаТребования():DATE
     var RetVal:date = date(0,0,0);

     if( IsBuyPart() )
        RetVal = nFI.rec.SUPLDATE;
     elif( IsSalePart() )
        RetVal = nFI.rec.PAYDATE;
     end;

     return RetVal;
  end;

  macro ДатаОбязательства():DATE
     var RetVal:date = date(0,0,0);

     if( IsSalePart() )
        RetVal = nFI.rec.SUPLDATE;
     elif( IsBuyPart() )
        RetVal = nFI.rec.PAYDATE;
     end;

     return RetVal;
  end;

  macro ДатаЗавершения():DATE
     return max(nFI.rec.PAYDATE, nFI.rec.SUPLDATE);
  end;

  macro СуммаТребования():money
     var RetVal:money = $0.0;

     if( IsBuyPart() )
        RetVal = nFI.rec.Amount;
     elif( IsSalePart() )
        RetVal = nFI.rec.Cost;
     end;

     return RetVal;
  end;

  macro СуммаТребованияБезНДС():money
     var RetVal:money = $0.0;

     if( IsBuyPart() )
        RetVal = nFI.rec.Amount;
     elif( IsSalePart() )
        RetVal = nFI.rec.Cost - IIF((this.nFI.rec.VatSum >= $0), this.nFI.rec.VatSum, $0);
     end;

     return RetVal;
  end;

  macro СуммаОбязательства():money
     var RetVal:money = $0.0;

     if( IsSalePart() )
        RetVal = nFI.rec.Amount;
     elif( IsBuyPart() )
        RetVal = nFI.rec.Cost;
     end;

     return RetVal;
  end;

  macro СуммаОбязательстваБезНДС():money
     var RetVal:money = $0.0;

     if( IsSalePart() )
        RetVal = nFI.rec.Amount;
     elif( IsBuyPart() )
        RetVal = nFI.rec.Cost - IIF((this.nFI.rec.VatSum >= $0), this.nFI.rec.VatSum, $0);
     end;

     return RetVal;
  end;

  macro ClientID():integer
     return this.Deal.rec.Client;
  end;

  macro ClientContrID():integer
     return this.Deal.rec.ClientContr;
  end;

  macro BrokerID():integer
     return this.Deal.rec.Agent;
  end;

  macro BrokerContrID():integer
     return this.Deal.rec.AGENTCONTR;
  end;

  macro Kind_Operation():integer
     return this.Deal.rec.Kind;
  end;

  macro DealCode():String
     return this.Deal.rec.Code;
  end;

  macro Netting():bool
     return (this.Deal.rec.Netting == SET_CHAR);
  end;

  macro BaseFI()
     if( v_BaseFI == null )
        v_BaseFI = TRecHandler("fininstr.dbt");
        if( ПолучитьФинИн(ВалютаБазовогоАктива(), v_BaseFI) != 0 )
           MsgBox("Не найден финансовый инструмент (FIID = " + string(ВалютаБазовогоАктива()) + ")");
        end;
     end;

     return v_BaseFI;
  end;

  MACRO Department():integer
     return this.Deal.rec.Department;
  END;

  /*BPV*/
  macro ClientDBOContrName():string
    var RetVal:string = "";
    var sql,rs;
    sql = " SELECT t.t_number contr "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_id = ( select t_sfcontrid from ddlcontr_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid =  "+this.ClientContrID() + "))";

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      RetVal = rs.value("contr");
    end;
    return RetVal;
  end;
  /*BPV*/

  macro ClientDBOContrDate():date
    var RetVal:date = date(0,0,0);
    var sql,rs;
    sql = " SELECT t.t_datebegin contrdate "
    + " FROM dsfcontr_dbt t "
    + " WHERE t.t_id = ( select t_sfcontrid from ddlcontr_dbt where t_dlcontrid = (select t_dlcontrid from ddlcontrmp_dbt where t_sfcontrid =  "+this.ClientContrID() + "))";

    rs = ExecSqlSelect(sql);
    if (rs.MoveNext())
      RetVal = SQL_ConvTypeDate(rs.value("contrdate"));
    end;
    return RetVal;
  end;

  /*PNV*/
  MACRO GetContractorID():integer
     return this.Deal.rec.Contractor;
  END;
  /*PNV*/

  MACRO ОснованиеПереносаПоСрокам( Требование:bool ):string
     var Ground:string = "";
     if( Требование )
        Ground = "Перенос требований по";
     else
        Ground = "Перенос обязательств по";
     end;
     Ground = Ground + IIF( this.DealPart == 1," сделке "," второй части сделки ")+ this.DealCode();
     return Ground;
  END;
/*PNV*/
     macro GetGround(type,Paym)

    const UCHET_OBYAZ = 1;
    const UCHET_TREB = 2;
    const PERENOS_OBYAZ = 3;
    const PERENOS_TREB = 4;
    const UCHET_SS = 5;
    var RecAcc = "";
    private macro GenAgr()
     if( v_GenAgr == null )
        v_GenAgr = Trechandler("dl_genagr.dbt");

        if( Deal.rec.GenAgrID > 0 )
           DL_GetRecHandler(v_GenAgr, " SELECT * FROM ddl_genagr_dbt WHERE t_GenAgrID = " + string(Deal.rec.GenAgrID));
        end;
     end;
     return v_GenAgr;
    end;
    macro GetPFIType ()
      var type = "";
      if ((Deal.rec.Kind == 12690) or (Deal.rec.Kind == 2690) or (Deal.rec.Kind == 12745) )/*PNV 518756*/
        type = "ФОРВАРД";
      elif ((Deal.rec.Kind == 12695) or (Deal.rec.Kind == 22695))/*PNV*/
        type = "валютный опцион";
      elif ((Deal.rec.Kind == 22710) or (Deal.rec.Kind == 2715) or (Deal.rec.Kind == 12715) or (Deal.rec.Kind == 12710) or (Deal.rec.Kind == 2710))/*PNV*/
        type = "СВОП";
      elif ((Deal.rec.Kind == 22720) or (Deal.rec.Kind == 12720))/*PNV*/
        //type = "Процентный СВОП";
        if (ВалютаБазовогоАктива() == ВалютаКонтрАктива())
          type = "IRS";
        else
          type = "CIRS";
        end;
      end;
      return type;
    End;

    /*PNV*/
    macro IsPFI()
       if (Deal.rec.IsPFI == SET_CHAR)
           return true;
       else
           return false;  
       end;
    end;

    macro GetCCYByFIID(code,codekind)
      var sql,rs;
      sql = " SELECT f.t_ccy fiid "
      + " FROM dfininstr_dbt f "
      + " WHERE f.t_fiid = '"+code+"' AND f.t_fi_kind = "+ codekind;
      rs = ExecSqlSelect(sql);
      if (rs.MoveNext())
        return rs.value(0);
      else
        sql = " SELECT f.t_ccy fiid "
            + " FROM dfininstr_dbt f "
            + " WHERE f.t_fiid = '"+code+"' AND f.t_fi_kind = 6";/*PNV для драг.металлов*/
        rs = ExecSqlSelect(sql);
        if (rs.MoveNext())
            return rs.value(0);
        else
            return null;
        end;
     end;
    end;
    var ground,exectype ="" , dealdate, routedeal , routeopc, fiid1, fiid2 , enddate, genagrdate, contrag, dealcode;
    if (nFI.rec.exectype == 1)
      exectype = "поставочный";
    elif (nFI.rec.exectype == 0)
      exectype = "расчетный";
    else
      exectype = "";
    end;
    if (deal.rec.type == 1)
      routedeal = "покупке";
    elif (deal.rec.type == 2)
      routedeal = "продаже";
    elif ((deal.rec.type == 5) and (Dealpart == 1))
      routedeal = "покупке";
    elif ((deal.rec.type == 5) and (Dealpart == 2))
      routedeal = "продаже";
    elif ((deal.rec.type == 6) and (Dealpart == 1))
      routedeal = "продаже";
    elif ((deal.rec.type == 6) and (Dealpart == 2))
      routedeal = "покупке";
    else
      routedeal = "";
    end;
    if (Deal.rec.Kind == 12695)
      if (deal.rec.OptionType == 1)
        routeopc = "продажу";
      elif (deal.rec.OptionType == 2)
        routeopc = "покупку";
      else
        routeopc = "";
      end;
    end;
    if (Deal.rec.Kind == 22710)
      dealcode = string(deal.rec.code) + "("+string(DealPart)+")";
    else
      dealcode = string(deal.rec.code);
    end;
    fiid1 = GetCCYByFIID(nFI.rec.fiid,1);
    fiid2 = GetCCYByFIID(nFI.rec.pricefiid,1);
    contrag = GetPartyNames(Deal.rec.Contractor, 2)[0];
    enddate = StrSubSt(String(nFI.rec.ExecDate:f), ".", "/");
    genagrdate = StrSubSt(String(GenAgr().rec.date_genagr:f),".","/");/*CHVA*/
    var startdate = StrSubSt(String(deal.rec.Date:f), ".", "/");
    if( this.ПлатежОб.rec.PaymentID > 0 )
      RecAcc = this.ПлатежОб.rec.ReceiverAccount;
    end;
  
    if (type == 1)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Учет обязательств для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Учет обязательств для сделки N "+dealcode+" от "+startdate + " ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 2)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Учет требований для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Учет требований для сделки N "+dealcode+" от "+startdate+" ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 3)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Перенос обязательств для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Перенос обязательств для сделки N "+dealcode+" от "+startdate+" ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 4)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Перенос требований для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Перенос требований для сделки N "+dealcode+" от "+startdate+ " ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 5)
      if (not Ispfi()) 
           ground = "";
      else
          ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      end;
      ground = ground + "Списание обязательств для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      end; 
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Списание обязательств для сделки N "+dealcode+" от "+startdate+" ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 6)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
      ground = ground + "Списание требований для сделки N "+dealcode+" от "+startdate+" по "+routedeal+" ";
      if (this.ВидБазовогоАктива() == FIKIND_METAL)
         ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" ДМ","ДМ")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      else
      ground = ground + IIF(Deal.rec.Kind == 12695,"опциона на "+routeopc+" валюты","валюты")+" "+fiid1+"/"+fiid2+" по курсу "+nFI.rec.price;
      end;
      ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      If((Deal.rec.Kind == 2690) and (this.ВидБазовогоАктива(true) == FIKIND_AVOIRISS))
         ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). ";
         ground = ground + "Списание требований для сделки N "+dealcode+" от "+startdate+ " ";
         ground = ground + ". Дата исполнения сделки: "+enddate+". К/агент: "+contrag;
      end;
    elif (type == 7)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение справедливой стоимости сделка N "+dealcode+" от "+startdate+". К/агент: " +contrag;
    elif (type == 8)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Списание справедливой стоимости сделка N "+dealcode+" от "+startdate+". К/агент: " +contrag;
    elif (type == 9)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Отражение требований / обязательств сделка N "+dealcode+" от "+startdate+". К/агент: " +contrag;
    elif (type == 10)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Списание справедливой стоимости сделка N "+dealcode+" от "+startdate+" в связи с отказом от опциона. К/агент: " +contrag;
    elif (type == 11)
      ground = "ПФИ ("+IIF(Deal.rec.Kind == 12695,exectype+" "+GetPFIType(),GetPFIType())+"). Урегулирование парных счетов по сделке N "+dealcode+" от "+startdate+" . К/агент: " +contrag;
    //mda 14/02/19 с 1000 идут граунды для плаежей! 
    elif (type == 1001)
      /*PNV если ген.соглашения в сделке нет, в платеж не выводить*/
      if (GenAgr().rec.code != "")
          if(Deal.rec.Kind == 12690)/*CHVA*/
             ground = StrUpr("ВОЗВРАТ ДЕНЕЖНЫХ СРЕДСТВ ПО СДЕЛКЕ " + dealcode + " ОТ " + startdate + "ГЕН. СОГЛАШЕНИЕ № "+GenAgr().rec.code+" ОТ "+GenAgr().rec.date_genagr+" . НДС НЕ ОБЛАГАЕТСЯ. К/агент: " +contrag + ". Счет получателя: "+RecAcc);
          else
          ground = StrUpr("ВОЗВРАТ ДЕНЕЖНЫХ СРЕДСТВ ПО ДЕПОЗИТУ "+contrag+" СДЕЛКА № " + dealcode + " ОТ " + startdate + " ГЕН. СОГЛАШЕНИЕ № "+GenAgr().rec.code+" ОТ "+GenAgr().rec.date_genagr+" . НДС НЕ ОБЛАГАЕТСЯ. К/агент: " +contrag + ". Счет получателя: "+RecAcc);
          end;   
      else
          ground = StrUpr("ВОЗВРАТ ДЕНЕЖНЫХ СРЕДСТВ ПО ДЕПОЗИТУ "+contrag+ " СДЕЛКА № " + dealcode + " ОТ " + startdate + ". НДС НЕ ОБЛАГАЕТСЯ. К/агент: " +contrag + ". Счет получателя: "+RecAcc);
      end;
      /*PNV*/ 
    elif (type == 1002)
      ground = StrUpr("ОПЛАТА ПРЕМИИ ПО ОПЦИОНУ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1003)
      ground = StrUpr("ПОЛУЧЕНИЕ ПРЕМИИ ПО ОПЦИОНУ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1004)
      ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО ОПЦИОНУ "+dealcode+" от "+startdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1005)
      ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО НЕТТИНГУ от "+{curdate}+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
    elif (type == 1006)
      if(Deal.rec.Kind == 32730) /*bpv client*/
         ground = "Перевод средств по сделке " + SubStr (dealcode,index (dealcode, ":")+1) + " от " + String(deal.rec.date:f ) + ", дата валютирования " + String(nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
      else
         ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО СДЕЛКЕ "+dealcode+" от "+startdate+", ДАТА ВАЛЮТИРОВАНИЯ "+ enddate+" дог."+GenAgr().rec.code+" от " +genagrdate+" с "+contrag+". НДС НЕ ОБЛАГАЕТСЯ.");
      end;
    elif (type == 1007)
      if (GenAgr().rec.code != "")
          ground = StrUpr("TRANSFER OF FUNDS UNDER FX DEAL " + SubStr (dealcode,index (dealcode, ":")+1) + " TRADE DATE " + startdate +  " VALUE DATE " + StrSubSt(String({curdate}:f ), ".", "/")  + " AGRM N " + StrChangeRusXSet_(GenAgr().rec.code)  + " DD "+ StrSubSt(String(GenAgr().rec.date_genagr:f ), ".", "/"));/*CHVA*/
      else
          ground = StrUpr("TRANSFER OF FUNDS UNDER FX DEAL " + SubStr (dealcode,index (dealcode, ":")+1) + " TRADE DATE " + startdate + " VALUE DATE " + StrSubSt(String({curdate}:f ), ".", "/")  + "");/*CHVA*/
      end; 
      if(Deal.rec.Kind == 32730) /*bpv client*/
         ground = "Перевод средств по сделке " + SubStr (dealcode,index (dealcode, ":")+1) + " от " + String(deal.rec.date:f ) + ", дата валютирования " + String(nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
      elif(Deal.rec.Kind == 32715) /*bpv client*/
//         ground = "Перевод средств по сделке " + SubStr (dealcode,index (dealcode, ":")+1) + " от " + String(deal.rec.date:f ) + ", дата валютирования " + String(nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
      end;
    elif (type == 1008)
       if(IsSale())
         if ( (Paym.purpose == 1) and ( (SubStr(Paym.ReceiverAccount,1,5) == "20202")  or (SubStr(Paym.ReceiverAccount,1,5) == "20209")) ) 
            ground = StrUpr("БАНКНОТНАЯ СДЕЛКА С " + contrag +" (продажа "+ fiid1+"). СДЕЛКА № "+dealcode+ " ОТ " + startdate /*+ " (ВАЛЮТА " + fiid1+")"*/);/*CHVA*/
         else
            ground = StrUpr("PAYMENT UNDER MONEY MARKET RUSSIAN AGRICULTURAL BANK IS BUYS CASH FROM " + contrag + " TD " + startdate + " VD " + StrSubSt(String({curdate}:f), ".", "/")  + "");/*PNV 491858*/
         end;
       else
         if ( (Paym.purpose == 1) and ( (SubStr(Paym.payeraccount,1,5) == "20202")  or (SubStr(Paym.payeraccount,1,5) == "20209")) ) 
            ground = StrUpr("БАНКНОТНАЯ СДЕЛКА С " + contrag + " (покупка "+ fiid1+"). СДЕЛКА № "+dealcode+ " ОТ " + startdate /*+ " (ВАЛЮТА " + fiid1+")"*/);/*CHVA*/
         else
            ground = StrUpr("PAYMENT UNDER MONEY MARKET RUSSIAN AGRICULTURAL BANK IS BUYS CASH FROM " + StrChangeRusXSet_(contrag) + " TD " + startdate + " VD " + StrSubSt(String({curdate}:f), ".", "/")  + "");/*PNV 491858*//*CHVA 492070*/
         end;
       end;
    elif (type == 1009)
      if(Deal.rec.Kind == 32730) /*bpv client*/
         ground = "Перевод средств по сделке " + SubStr (dealcode,index (dealcode, ":")+1) + " от " + String(deal.rec.date:f ) + ", дата валютирования " + String(nfi.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
      elif(Deal.rec.Kind == 32715) /*bpv client*/
  //       ground = "Перевод средств по сделке " + SubStr (dealcode,index (dealcode, ":")+1) + " от " + String(deal.rec.date:f ) + ", дата валютирования " + String(nfi_baseactiv.rec.paydate:f ) + " по брокерскому договору N " + this.ClientDBOContrName();/*bpv*/
      else
         ground = StrUpr("ПЕРЕВОД СРЕДСТВ ПО СДЕЛКЕ "+dealcode+" от "+startdate+", ДАТА ВАЛЮТИРОВАНИЯ "+ enddate+" дог."+GenAgr().rec.code+" от " +genagrdate+" с "+contrag+".");
      end;
   
    end;
    return ground;
  end;
  /*PNV*/

  MACRO IsEarlySettlement():bool
     return DVGetOprStatus(DV_FX_OPERSTATUS_KIND_EARLY_SETTLEMENT) == DV_EARLY_SETT_OPERSTATUS_YES;
  END;

  MACRO CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate)
    var BalAcc;
    var isEast = 0; /*PNV i-support 503434*/

    /*SVE получение названия вида сделки*/
    var oprkind;
    var sql = "select t_name from doprkoper_dbt where t_kind_operation = " + Deal.rec.kind;
    var q = DL_RSDCommand(sql);
    var Data = q.execute();
    if( Data.MoveNext() )
      oprkind = Data.name;
    end;

   /*PNV i-support 503434*/
   if (not GetMainObjAttr( null, 2, strLpad(string(account.rec.code_currency), 10, "0"), 101, isEast))
       isEast = 0;
   end;
   /*PNV i-support 503434*/

   if( not CorrectAccount(account, accblnc, ORScheme, categ, templ, accdoc,  OperDate) )
       return false;
    end;
    if( (categ.rec.Code == "+Переоц.,поставка ИВ и ДМ") OR (categ.rec.Code == "-Переоц.,поставка ИВ и ДМ") )
       if( Index(account.rec.Type_Account,"Ш") == 0 )
          /*для данных категорий принудительно делаем парным*/
          var PairAcc = TRecHandler("account");
          var FiRole = null, PairCode = "";
          if(DealPart == 1)
             FiRole = FIROLE_FIRST_OVERVAL;
          else
             FiRole = FIROLE_SECOND_OVERVAL;
          end;
          if( categ.rec.Code == "+Переоц.,поставка ИВ и ДМ" )
             PairCode = "-Переоц.,поставка ИВ и ДМ";
          else
             PairCode = "+Переоц.,поставка ИВ и ДМ";
          end;
          if( not this.OpenAccount(PairCode, null, false, FiRole, PairAcc, OperDate, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
             return false;
          end;
          account.rec.PairAccount = PairAcc.rec.Account;
          account.rec.Type_Account = account.rec.Type_Account + "Ш";
       end;
    end;

   //TEG 25.06.19 ролевая модель   
   /* Определяем конечного операциониста для Счета */
    if ((this.kind==140) or (this.kind==152) or (this.kind==4626) or (this.kind==4627))
         Account.rec.Oper = GetMainOperInGroup(this.kind);
    elif(this.kind==199)
            if(this.ВидБазовогоАктива() == FIKIND_AVOIRISS)
              Account.rec.Oper = GetMainOperInGroup(101);
            else
              Account.rec.Oper = GetMainOperInGroup(this.kind,deal.rec.kind);
           end;
     else  
           Account.rec.Oper = GetMainOperInGroup(this.kind,deal.rec.kind);
     end;

     if (Account.rec.Oper <= 0)
         Account.rec.Oper = {Oper};
     end;

    /*939, 933 - Требования по поставке денежных средств (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ
      969, 963 - Обязательства по поставке денежных средств (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ
      940 - Требования по поставке ДМ (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ
      970 - Обязательства по поставке ДМ (валютный рынок ММВБ). Сделка ХХХХХХ от ДД/ММ/ГГГГ*/
      //mda 18/02/19 Добавил fix по наименованию счетов для внебиржевых сделок!
    if (((categ.rec.Code == "+Форвард, прочие0")  or (categ.rec.Code == "-Форвард, прочие0") or (categ.rec.Code == "+Форвард, дрейф внебирж") or (categ.rec.code == "-Форвард, дрейф внебирж") or (categ.rec.code == "-Форвард, дрейф внебирж0") /*KOA ID : 537216*/) /*and (ВалютныйРынок())*/ )
       BalAcc=SubStr(Account.rec.Account,1,3);
       if (BalAcc=="939")
          if (ВалютныйРынок())
              Account.rec.NameAccount = " Требования по поставке денежных средств (валютный рынок ММВБ)  К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];    
          else
              Account.rec.NameAccount = "Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке денежных средств";
          end;
	   elif (BalAcc=="933")
          if (ВалютныйРынок())
              Account.rec.NameAccount = Deal.rec.Code + " Требования по поставке денежных средств (валютный рынок ММВБ) сделка  от " + StrSubSt(String(Deal.rec.Date:f), ".", "/") + " К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];    
          else
                  Account.rec.NameAccount = "Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке денежных средств по сделке "+ Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
          end;
       elif (BalAcc=="969")
            if (ВалютныйРынок())
                Account.rec.NameAccount = " Обязательства по поставке денежных средств по сделке  (валютный рынок ММВБ) К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];    
            else
                Account.rec.NameAccount = "Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке денежных средств";
            end;
       elif (BalAcc=="963")
            if (ВалютныйРынок())
                Account.rec.NameAccount = Deal.rec.Code + " Обязательства по поставке денежных средств по сделке  (валютный рынок ММВБ) сделка от " + StrSubSt(String(Deal.rec.Date:f), ".", "/") + " К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];    
            else
                  Account.rec.NameAccount = "Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке денежных средств по сделке "+ Deal.rec.Code + " от " + StrSubSt(String(Deal.rec.Date:f), ".", "/");
            end;
       elif (BalAcc=="940")
          if (ВалютныйРынок())  
            Account.rec.NameAccount = " Требования по поставке ДМ (валютный рынок ММВБ). К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];     
          else
            Account.rec.NameAccount = "Требования к " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке ДМ";
          end;
       elif (BalAcc=="970")
          if (ВалютныйРынок())
            Account.rec.NameAccount = " Обязательства по поставке ДМ  (валютный рынок ММВБ). К/агент: " + GetPartyNames(Deal.rec.Contractor, 2)[0];     
          else
            Account.rec.NameAccount = "Обязательства перед " + GetPartyNames(Deal.rec.Contractor, 2)[0] + " по поставке ДМ ";
          end;
       end;    
    end;
    if ((categ.rec.code == "+Расчеты") or (categ.rec.code == "-Расчеты")) /*CHVA */
      BalAcc = SubStr(Account.rec.Account,1,5);
      if ( BalAcc == "47423")
         Account.rec.NameAccount = "Требования к "+ GetPartyNames(Deal.rec.Contractor, 2)[0] + " по банкнотным операциям. ГЕН. СОГЛАШЕНИЕ № " + GenAgr().rec.code + " ОТ " + GenAgr().rec.date_genagr; /*PNV 510918*/
      elif ( BalAcc == "47422")
         Account.rec.NameAccount = "Обязательства перед "+ GetPartyNames(Deal.rec.Contractor, 2)[0]  + " по банкнотным операциям. ГЕН. СОГЛАШЕНИЕ № " + GenAgr().rec.code + " ОТ " + GenAgr().rec.date_genagr; /*PNV 510918*/
      end;
    end;
    if ((categ.rec.Code == "+Незавершенные") or (categ.rec.code == "-Незавершенные"))/*CHVA */
        Account.rec.NameAccount = "Незавершенные расчеты с "+ GetPartyNames(Deal.rec.Contractor, 2)[0];
    end;
    if ((categ.rec.code == "+Форвард, расчеты0") or (categ.rec.code == "-Форвард, расчеты0") or (categ.rec.code == "+Форвард, расчеты0Б") or (categ.rec.code == "-Форвард, расчеты0Б")) /*CHVA */
      BalAcc = SubStr(Account.rec.Account,1,5);
      if ( BalAcc == "47408")
         Account.rec.NameAccount = "Расчеты по требованиям с "+ IIF(Deal.rec.Contractor == GetCodeParty("АО СПВБ",1), "СПВБ по конверсионным операциям", GetPartyNames(Deal.rec.Contractor, 2)[0] );
      elif ( BalAcc == "47407")
         Account.rec.NameAccount = "Расчеты по обязательствам с "+ IIF(Deal.rec.Contractor == GetCodeParty("АО СПВБ",1), "СПВБ по конверсионным операциям", GetPartyNames(Deal.rec.Contractor, 2)[0] );
      end;
     /*PNV i-support 503434*/
      if( ( Index(account.rec.Type_Account,"Ф") == 0 ) and (isEast != 0)) 
          account.rec.Type_Account = account.rec.Type_Account + "Ф";
      end;
      /*PNV i-support 503434*/
    end;
    if (categ.rec.code == "-Форвард, расчетыДМ") /*PNV*/
      Account.rec.NameAccount = "Расчеты по ОБДМ с "+ GetPartyNames(Deal.rec.Contractor, 2)[0] ;
     /*PNV i-support 503434*/
      if( ( Index(account.rec.Type_Account,"Ф") == 0 ) and (isEast != 0)) 
          account.rec.Type_Account = account.rec.Type_Account + "Ф";
      end;
      /*PNV i-support 503434*/
    elif (categ.rec.code == "+Форвард, расчетыДМ") /*PNV*/
      Account.rec.NameAccount = "Расчеты по ТРДМ с "+ GetPartyNames(Deal.rec.Contractor, 2)[0] ;
     /*PNV i-support 503434*/
      if( ( Index(account.rec.Type_Account,"Ф") == 0 ) and (isEast != 0)) 
          account.rec.Type_Account = account.rec.Type_Account + "Ф";
      end;
      /*PNV i-support 503434*/
    end;
    //mda 19.02.19 Добавим счета по переоценке
    if ( (categ.rec.code == "+Переоц.,поставка0") or (categ.rec.code == "-Переоц.,поставка0") )
      BalAcc = SubStr(Account.rec.Account,1,5);
      if ( (BalAcc == "47421") or (BalAcc == "47424") )
        Account.rec.NameAccount = "Переоценка требований и обязательств по сделкам с "+ GetPartyNames(Deal.rec.Contractor, 2)[0] + " в " + string(ПолучитьКодФинИн(accdoc.rec.fiid, null, 3));
      end;
    end;

   if( IsEarlySettlement() )
      if( (categ.rec.Code == "+Форвард, РПИ") OR (categ.rec.Code == "-Форвард, РПИ") )
         if( Index(account.rec.Type_Account,"Ф") == 0 )
            account.rec.Type_Account = account.rec.Type_Account + "Ф";
         end;
      end;
    end;

    return true;
  END;

  MACRO ВыполненаПереоценкаСС( pDate:DATE, pFrVal:TrecHandler ):BOOL
     VAR FrVal = TRecHandler("dvnfrval");

     if( FindDVNFRVAL( this.Deal.rec.Id, this.Deal.rec.DocKind, pDate, FrVal) != 0 )
        return false;
     end;

     if( pFrVal != NULL )
        Copy( pFrVal, FrVal );
     end;
     return true;
  END;

  initDVFirst();
  this.Construct(DocKind, Oper, _nFI);
END;

/**************************************************************************/
/*  класс - первичные документы для работы с категориями учета            */ 
/*    для @Обработка итогов биржевых валютных торгов@                     */
/*    для @Расчеты с биржей@                                              */
/**************************************************************************/
CLASS (DVFirst) DVFirstDocDLCOMM( parm1, parm2 )

    VAR comm  = TBfile("dl_comm.dbt");  /* сервисная операция */
    private var dlmarket_other = TRecHandler("dlmarket.dbt" ); /*схема расчета для другого клирингового счета*/
    private var dlmarket_totaloffi = TRecHandler("dlmarket.dbt" ); /*схема расчета для расчета итогов по ФИ*/
    private var m_FI_Kind:integer = -1;
    private var v_fininstr = NULL;
    private var m_BankID:integer = -1; /*PNV*/
    private var v_ClientID = -1, v_ClientContrID = -1, v_OfficeID = -1;
    /************************************************/
    /* инициализация массива параметров              */
    /************************************************/
    PRIVATE MACRO InitParmArray
        ParmA[MC_TYPE_PARAMETR_DOCKIND]      = this.Kind;
        ParmA[MC_TYPE_PARAMETR_DOCID]        = this.ID;
        ParmA[MC_TYPE_PARAMETR_DEPARTMENT]   = {OperDprt}; /*PNV*/
    END;

    MACRO InitFIRoleBArray
       if( comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_OWN )
          FIRoleBArray[FIRoleBArray.Size] = FIROLE_MONEYSOURCE_OWN;
       elif( comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT )
          FIRoleBArray[FIRoleBArray.Size] = FIROLE_MONEYSOURCE_CLIENT;
       end;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_ORCB_OTHCLIRACC;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_ORCB_OTHCLIRACC_CLIENT;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_FICOM;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIREQ;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_BANKROLL;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_PRECIOUS_METALS;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_FIDOC; 
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_BANKROLL_BANK;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_SETTL_AGENT;
       FIRoleBArray[FIRoleBArray.Size] = FIROLE_ORCB_OTHCLIRACC;
    END;

    /*Получить НЕкэшируемый параметр (меняющийся в зависимости от контекста вызова GetParametr())
      например для разных FIRole */
    PRIVATE MACRO GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole, CurryCurrency )
   
       VAR Parametr = null;
   
       /*торговая площадка*/
       if( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE )
          if( comm.rec.DocKind == DL_DVCURMARKET )
             Parametr = dlmarket_totaloffi.rec.Centr; 
          elif( (FIRole == FIROLE_ORCB_OTHCLIRACC) or (FIRole == FIROLE_ORCB_OTHCLIRACC_CLIENT) )
             Parametr = dlmarket_other.rec.Centr;
          else
             Parametr = comm.rec.TraderID;
          end;
       elif( ParmKind == MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE )
          if( comm.rec.DocKind == DL_DVCURMARKET )
             if( CatCode == "Клиринговый счет" ) // 292992 - использование счетов по КУ "Клиринговый счет", открытых для фондового сектора ЕП  
                Parametr = DV_GetSinglePoolOfficeID(dlmarket_totaloffi.rec.ID);
             else
             Parametr = dlmarket_totaloffi.rec.CentrOffice; 
             end; 
          elif( (FIRole == FIROLE_ORCB_OTHCLIRACC) or (FIRole == FIROLE_ORCB_OTHCLIRACC_CLIENT) )
             Parametr = dlmarket_other.rec.CentrOffice;
          else
                if( v_OfficeID > 0 )
                   Parametr = v_OfficeID;
                else
             Parametr = comm.rec.PartyOfficeID;            
             end;
          end;
      elif( ParmKind == MC_TYPE_PARAMETR_FIID )
             this.SetFI(CurryCurrency);
             Parametr = v_fininstr.rec.fiid;
       elif( ParmKind == MC_TYPE_PARAMETR_CURRENCY )
          Parametr = CurryCurrency;            
       end;
   
       return Parametr;
    END;

    /*Получить параметры шаблона                    */
    MACRO GetParametrTemplate
    ( 
        ObjectID,       /*   параметр - номер справочника                 */
        Classificator,  /*   классификатор - номер классификатора, если он задан */
        OperDate,       /*   дата, на которую надо вернуть характеристики*/
        FIRole,
        CurryCurrency   /*   валюта счета*/
    )         
      var Parametr = -1;           /*по умолчанию*/

      FIRole   = GetBasisFIRole(FIRole);
      Parametr = GetParametrTemplate(ObjectID, Classificator, OperDate, FIRole);

      if( Parametr == -1 )
        if( (ObjectID == OBJTYPE_BA_DV) AND (Classificator == LLCLASS_KIND_BA) )
           Parametr = DV_Get_OBJTYPE_BA_DV(m_FI_Kind);
        elif( (ObjectID == OBJTYPE_KINDFI) AND (Classificator == LLCLASS_KIND_AKT_BANK) )

           if( FIRole == FIROLE_BANKROLL )
              Parametr = 1; /*Денежные средства*/
           elif(  FIRole == FIROLE_PRECIOUS_METALS  )
              Parametr = 2; /*Драгоценный металл*/
           else
           this.SetFI(CurryCurrency);
           if( (v_fininstr != null) and (v_fininstr.rec.FI_Kind == FIKIND_METAL) )
              Parametr = 2; /*Драгоценный металл*/
           else
              Parametr = 1; /*Денежные средства*/
           end;
           end;
        elif( (ObjectID == OBJTYPE_CUR_STOCK_MARKET_CALC) AND (Classificator == LLCLASS_CUR_STOCK_MARKET_CALC) ) /*Расчеты с валютными и фондовыми биржами*/
           this.SetFI(CurryCurrency);
           if( (v_fininstr != null) and (v_fininstr.rec.FI_KIND == FIKIND_CURRENCY) and (v_fininstr.rec.FIID != NATCUR) and (this.IsCurrMarket() or ((not this.IsClient()) and this.IsSinglePool())) )
              Parametr = 1;
           else
              Parametr = 0;
           end;
        elif(Classificator == 5021)
           this.SetFI(CurryCurrency); 
           if( (v_fininstr != null) AND (v_fininstr.rec.FIID == NATCUR) )
              Parametr = 0;
           else
              Parametr = 1;
           end;                
        end;
      end;

      return Parametr;
    END;

    /************************************************/
    /*Получить параметры                            */
    /************************************************/
    MACRO GetParametr( ParmKind, OperDate, CatCode, FIRole, CurryCurrency )
      VAR Parametr = null, InCache;
      if( ParmA[ParmKind] != null ) /*если уже есть в кэше, берем значение параметра оттуда*/
         return ParmA[ParmKind];
      end;
      /*пробуем определить значение среди некэшируемых параметров*/     
      Parametr = GetNonCacheParametr( ParmKind, OperDate, CatCode, FIRole, CurryCurrency );
      /*среди некэшируемых параметров значение не определили, пробуем среди кэшируемых */
      if( Parametr == null ) 
          InCache = true;
          /*организатор торговли*/  
          if( (ParmKind == MC_TYPE_PARAMETR_PARTY) or (ParmKind == MC_TYPE_PARAMETR_CONTRACTOR) )
             Parametr = comm.rec.PartyID;                     
             if( (v_fininstr != null) and (v_fininstr.rec.FI_Kind == FIKIND_METAL) )
                Parametr =  1181;         
             end; 
          elif( ParmKind == MC_TYPE_PARAMETR_OWNER )
             Parametr = {OurBank};
          elif( ParmKind == MC_TYPE_PARAMETR_PLACE )
             if( FIRole == FIROLE_BANKROLL_BANK )
                 if( m_BankID > 0 )
                     Parametr = m_BankID;
                 else
                     Parametr = this.РКЦБанкИзСПИ(ParmA[MC_TYPE_PARAMETR_FIID]); 
                 end;
            elif( FIRole == FIROLE_SETTL_AGENT )
                  Parametr = comm.rec.TRADERID;
            end;
          else
             InCache = false;
             Parametr = -1;
          end;
          if( InCache == true )
             ParmA[ParmKind] = Parametr;
          end;
      end;

      return Parametr;
    END;

    /************************************************/
    /*конструктор класса                            */
    /************************************************/
    MACRO Construct( parm1, parm2 ) 

       ClearRecord (comm);

       /*Конструктор из DocKind, parm2*/
       if ( (ValType(parm1)==V_INTEGER) AND (ValType(parm2)==V_INTEGER) )
           comm.rec.DocumentID = parm2;
           if( comm.GetEQ == false ) 
              this.SetError( "Операция \""+DL_GetDocKindName(parm1)+"\" c ID = "+string(parm2)+" не найдена" );
           end;
       else
          /*Конструктор из структур*/
          if( (ValType(parm1)==V_STRUC) OR (ValType(parm1)==V_FILE) OR (ValType(parm1) == V_GENOBJ) )
              copy ( comm, parm1 );
          else
             this.SetError( "Неверные параметры инициализации объекта" );        
          end; 
       end;

       this.ID   = comm.rec.DocumentID;
       this.Kind = comm.rec.DocKind;

       InitParmArray(); /*инициализация массива параметров*/
       InitFIRoleBArray();
    END;

    MACRO GetMarketSchemeID():INTEGER
       if( comm.rec.DocKind == DL_DVCURMARKET )
          return dlmarket_totaloffi.rec.ID;
       else
       return comm.rec.MarketSchemeID;
       end;
    END;

    macro SetFI_Kind( FI_Kind:integer )
        m_FI_Kind = FI_Kind;
    end;

    MACRO SetFI( FIID:Integer )
       if( ((v_fininstr == null) or (v_fininstr.rec.FIID != FIID)) and (FIID != ALLFININSTR) )
          v_fininstr = Trechandler( "fininstr.dbt" ); /* фин. инструмент           */
          if( ПолучитьФинИн( FIID, v_fininstr ) != 0 ) 
             this.SetError( "Не найден финансовый инструмент с ID = " + string(FIID) );
          end;
       end;
    END;
   
    /*PNV*/
    MACRO SetBankID( BankID:integer )
          m_BankID = BankID;
    END;
    /*PNV*/ 

    MACRO ВУ_ПолучитьРольФИ( ВидРО, DebCred )
    var FIRole = FIROLE_UNDEF;
       
        if( DebCred == true)
            if((ВидРО == 4) or (ВидРО == 5)) 
                FIRole = FIROLE_BANKROLL_BANK;    
            elif((ВидРО == 2) or (ВидРО == 3) or (ВидРО == 9) or (ВидРО == 10) or (ВидРО == 28) or (ВидРО == 29) )  
                FIRole = FIROLE_SETTL_AGENT;    
            end;
        elif( DebCred == false)
            if((ВидРО == 4) or (ВидРО == 5) or (ВидРО == 9) or (ВидРО == 10) or (ВидРО == 28) or (ВидРО == 29) ) 
                FIRole = FIROLE_SETTL_AGENT;
            elif((ВидРО == 2) or (ВидРО == 3)) 
                FIRole = FIROLE_BANKROLL_BANK;
            end;
        end;
     return FIRole;
   END;

    MACRO ВУ_ОснованиеПроводки( ВидРО )
      var Ground = "";
    
       if( ВидРО == 2 )
          Ground = "Перевод денежных средств на биржу";
       elif( ВидРО == 3 )
          Ground = "Перевод денежных средств брокеру";
       elif( ВидРО == 4 )
          Ground = "Возврат денежных средств с биржи";
       elif( ВидРО == 5 )
          Ground = "Возврат денежных средств от брокера";
       end;
    
       return Ground;
    END;

    MACRO ВУ_ПолучитьКатегориюДебет( ВидРО, IsOut:bool )
       var Категория = "";  

        if( (ВидРО == 4) or (ВидРО == 5) )
             Категория = "ДС Банка, ВУ";
        elif( ВидРО == 2 )
             Категория = "ДС в РЦ ОРЦБ, ВУ";
        elif( ВидРО == 3 )
             Категория = "ДС у брокера, ВУ";
        elif( (ВидРО == 9) or (ВидРО == 10)  )
             Категория = "ДС, Прч. счета банка, ВУ";
        elif( (ВидРО == 29) or (ВидРО == 28)  )
           if( not IsOut )
               if( this.DVOper.rec.PartyKind == PTK_BROKER )
                   Категория = "ДС у брокера, ВУ";
               else
                   Категория = "ДС в РЦ ОРЦБ, ВУ";
               end;
           else
               Категория = "ДС, Прч. счета банка, ВУ";
           end;
         end;
         return Категория;
    END;    

    MACRO ВУ_ПолучитьКатегориюКредит( ВидРО, IsOut:bool )
     var Категория = "";

     if( ВидРО == 4 )
        Категория = "ДС в РЦ ОРЦБ, ВУ";
     elif( ВидРО == 5 )
        Категория = "ДС у брокера, ВУ";
     elif( (ВидРО == 2) or (ВидРО == 3) )
        Категория = "ДС Банка, ВУ";
     elif( (ВидРО == 9) or (ВидРО == 10) )
        if( this.DVOper.rec.PartyKind == PTK_BROKER )
           Категория = "ДС у брокера, ВУ";
        else
           Категория = "ДС в РЦ ОРЦБ, ВУ";
        end;
     elif( (ВидРО == 29) or (ВидРО == 28)  )
        if( not IsOut )
           Категория = "ДС, Прч. счета банка, ВУ";
        else
           if( this.DVOper.rec.PartyKind == PTK_BROKER )
              Категория = "ДС у брокера, ВУ";
           else
              Категория = "ДС в РЦ ОРЦБ, ВУ";
           end;
        end;
     end;

     return Категория;
    END;

    MACRO ВУ_ПолучитьРО( ВидРО )
       return ВидРО;
    END;

    MACRO IsTrust()
       return false;
    END;

    MACRO IsClient():BOOL
       return (comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT);
    END;

    macro SetClientID(p_ClientID:integer):integer
       v_ClientID = iif(p_ClientID>0,p_ClientID,-1);
    end;

    macro SetClientContrID(p_ClientContrID:integer):integer
       v_ClientContrID = iif(p_ClientContrID>0,p_ClientContrID,-1);
    end;

    macro ClientID():integer
       return v_ClientID;
    end;

    macro ClientContrID():integer
       return v_ClientContrID;
    end;
    
    macro BrokerID():integer
       if( (comm.rec.DocKind == DL_SETTLEMENTFCURM ) and (comm.rec.DestBuyGoal == 2/*DV_CONTRACTOR_BROKER*/) )
          return comm.rec.PartyID;
       end;
       return -1;
    end;
    
    macro IsBroker():BOOL
       return( (comm.rec.DocKind == DL_SETTLEMENTFCURM ) and (comm.rec.DestBuyGoal == 2/*DV_CONTRACTOR_BROKER*/) );
    end;

    macro IsMARKET():BOOL
       return( not((comm.rec.DocKind == DL_SETTLEMENTFCURM ) and (comm.rec.DestBuyGoal == 2/*DV_CONTRACTOR_BROKER*/)) );
    end;
    
    macro BrokerContrID():integer
       if( (comm.rec.DocKind == DL_SETTLEMENTFCURM ) and (comm.rec.DestBuyGoal == 2/*DV_CONTRACTOR_BROKER*/) )
          return comm.rec.ContractID;
       end;
       return -1;
    end;
    
    macro Kind_Operation():integer
       return comm.rec.OperationKind;
    end;

    MACRO SetDlMarketOther(parm1)
       dlmarket_other = TRecHandler("dlmarket.dbt" ); /*схема расчета для другого клирингового счета*/
    
       if ( ValType(parm1)==V_INTEGER )
           if( FindDLMARKET(parm1,dlmarket_other) != 0 )
              this.SetError( "Не найдена схема расчетов для определения другого клирингового счета." );
           end;
       else
          /*Конструктор из структур*/
          if( (ValType(parm1)==V_STRUC) OR (ValType(parm1)==V_FILE) OR (ValType(parm1) == V_GENOBJ) )
              copy ( dlmarket_other, parm1 );
          else
             this.SetError( "Неверные параметры определения другого клирингового счета." );        
          end; 
       end;
    END;

    MACRO SetDVMarketSchemeByTotalOfFI(parm1)
       dlmarket_totaloffi = TRecHandler("dlmarket.dbt" ); /*схема расчета для расчетов по финансовому инструменту валютного рынка*/
    
       if ( ValType(parm1)==V_INTEGER )
           if( FindDLMARKET(parm1, dlmarket_totaloffi) != 0 )
              this.SetError( "Не найдена схема расчетов для расчетов по финансовому инструменту." );
           end;
       else
          /*Конструктор из структур*/
          if( (ValType(parm1)==V_STRUC) OR (ValType(parm1)==V_FILE) OR (ValType(parm1) == V_GENOBJ) )
              copy ( dlmarket_totaloffi, parm1 );
          else
             this.SetError( "Неверные параметры определения схемы расчетов для расчетов по финансовому инструменту." );        
          end; 
       end;
    END;

    macro ВидБиржевогоРынка():integer
       return comm.rec.ContractKind;
    end;

    MACRO IsStockMarket():bool
       return (this.ВидБиржевогоРынка() == DL_MARKETKIND_SETTLE_STOCK_T0) or (this.ВидБиржевогоРынка() == DL_MARKETKIND_SETTLE_STOCK_TPLUS);
    END;

    MACRO IsCurrMarket():bool
       return (this.ВидБиржевогоРынка() == DL_MARKETKIND_SETTLE_CURRENCY);
    END;

    MACRO IsDerivMarket():bool
       return (this.ВидБиржевогоРынка() == DL_MARKETKIND_SETTLE_DERIV);
    END;

    MACRO IsSPFIMarket():bool
       return (this.ВидБиржевогоРынка() == DL_MARKETKIND_SETTLE_SPFIMARKET);
    END;

    MACRO IsSinglePool():bool
       return (this.ВидБиржевогоРынка() == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (comm.rec.Flag1 == SET_CHAR);
    END;

    MACRO IsExistsAnalytics():bool
       return (comm.rec.Flag2 == SET_CHAR);
    END;

    MACRO GetAnalyticsMarketSchemeID(p_MarketKind:integer):string
       var Query, cmd, Data;

       if( this.IsExistsAnalytics() )
          cmd = DL_RsdCommand();
          Query = " SELECT DISTINCT LISTAGG(T_MarketSchemeID, ', ') WITHIN GROUP (ORDER BY T_MarketSchemeID) over() MarketSchemeIDStr " +         
                  "   FROM (SELECT Analytics.T_MarketSchemeID " +
                  "           FROM DDL_EXTSETTLECODE_DBT ExtCode, DDL_EXTSCANALYTICS_DBT Analytics " +
                  "          WHERE ExtCode.T_MarketSchemeID = ? " +
                  "            AND ExtCode.T_ParentID = 0 ";
          cmd.addParam( this.GetMarketSchemeID() );

          if( (p_MarketKind != null) and (p_MarketKind > 0) )
             Query = Query + "            AND Analytics.T_MarketKind = ? ";
             cmd.addParam( p_MarketKind );
          end;

          Query = Query + "            AND Analytics.T_CodeID = ExtCode.T_ID ) ";

          Data = cmd.execute(Query);
          if( Data.MoveNext() )
             return Data.MarketSchemeIDStr;
          end;
       end; 
          
       return String(this.GetMarketSchemeID());
    END;

    macro SetOfficeID(p_OfficeID:integer):integer
       v_OfficeID = iif(p_OfficeID>0,p_OfficeID,-1);
    end;

    macro ПолучитьКалендВалютуВидаДаты(НомерДаты):integer
      return -1;
    end;
  
    macro ПолучитьКалендКонтрагент()
      return comm.rec.partyid;
    end;
  
    macro ПолучитьКалендТип():integer
      return DL_CALLNK_MARKET;
    end;
  
    macro ПолучитьКалендБиржа()
      return ПолучитьКалендКонтрагент()
    end;
  
    macro ПолучитьКалендСвязанный(dayType):integer
      var dTp = 0;
      if (ValType(dayType) == V_INTEGER)
        dTp = dayType;
      end;
      return DL_GetCalendByDynParam(158,makeArray(
          DL_KeyPair("Object",DL_CalendGetOperNameByKind(Kind_Operation())),
          DL_KeyPair("ObjectType",ПолучитьКалендТип()),
          DL_KeyPair("Market",ПолучитьКалендБиржа()),
          DL_KeyPair("DayType",dTp),
          DL_KeyPair("MarketPlace", DL_Calend_MarketPlaceConverter(ALG_DL_MARKETKIND_SETTLE, ВидБиржевогоРынка()))
        )
      );
    end;

    initDVFirst();
    this.Construct( parm1, parm2 );
END;
