/*
$Name:        dvnop035.mac
$Module:      Производные инструменты
$Description: Процентный СВОП. Шаг: Исполнение (2 часть) . MDA изменен и переписан под РСХБ
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac","dv_period.mac";
import FIInter, globals;
import dv_carchng;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var FD, RateL, RateD;
  var ДатаИсполненияШага:date, Netting:bool = false;
  var ДатаВведеннойОперации:date = date();
  var KvitNetting:bool = false;
  var ДатаПланируемаяШага = DV_GetPlanDateStep(ID_Operation, ID_Step);
  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal(DocKind, ndeal, 2);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;
  GetOprDate( DV_NDEAL_OPRDATE_EXEC_2, ДатаИсполненияШага );
  /*if( IsDealReady(FD) == false )
     MsgBox( "Шаг не может быть выполнен. Остальные шаги операции должны иметь статуc \"Выполнен\"." );
     return 1;
  end;*/

  if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
     if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  if (FD.ПоставочныйКонтракт())
     var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );
     var ПлатежОб = RsbPayment( FD.ПлатежОб.rec.PaymentID );
     var stat = true;
     var findAccount = "";

     if ( АктуализироватьПлатежи(FD, ДатаИсполненияШага) != 0 )
        return 1;
     end;

     if (ПлатежТреб.PaymStatus == PM_OVERDUE)
        stat = FD.FindNumberAccount( "Треб. с н.с.",  FindAccount );
        ПлатежТреб.FutureReceiverAccount = FindAccount;
     end;

     if (ПлатежОб.PaymStatus == PM_OVERDUE)
        stat = FD.FindNumberAccount( "Обяз. с н.с.",  FindAccount );
        ПлатежОб.FuturePayerAccount = FindAccount;
     end;
  end;

  if( FD.СобствБиржеваяСделка() )
     if( ВозвратПолучениеДепозитнойМаржи(FD, doc, ДатаИсполненияШага) != 0 )
        return 1;
     end;

     if( FD.БазовыеВалютыРавны() == false )
        if( ИсполнитьОбязательство(FD, ДатаИсполненияШага, doc) != 0 )
           return 1;
        end;
    
        if( ИсполнитьТребование(FD, ДатаИсполненияШага, doc) != 0 )
           return 1;
        end;

        if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_ED(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Неттинг платежей Т/О 2ч> для операции.");
           return 1;
        end;
     end;
  else
     if( FD.БазовыеВалютыРавны() == false )
        if( FD.Netting() )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_ED(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Неттинг платежей Т/О 2ч> для операции.");
              return 1;
           end;
        else
           if( ИсполнитьОбязательство(FD, ДатаИсполненияШага, doc) != 0 )
              return 1;
           end;
          
           if( ИсполнитьТребование(FD, ДатаИсполненияШага, doc) != 0 )
              return 1;
           end;

           if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_ED(), DV_OPERSTATUS_PAYM_NOTEX) )
              MsgBox("Ошибка при установке статуса <Неттинг платежей Т/О 2ч> для операции.");
              return 1;
           end;
        end;
     end;
  end;

  if( not FD.IsClient() )
     if( FD.БазовыеВалютыРавны() == false )
        if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
           return 1;
        end;

        if( ОтражениеКонверсионнойОперацииВБалансе( FD, doc, ДатаИсполненияШага ) != 0 )
           return 1;
        end;
     else // Golovkin 13.07.2021 ID : 530584
        if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
           return 1;
        end;
     end;
/* Golovkin 13.07.2021 ID : 530584
     if( СписаниеССПриПрекращенииПризнания( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;

    if( ОтнесениеФинРезультата( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;
*/
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_EXEC_2(), DV_OPERSTATUS_PAYM_NOTEX) )
     MsgBox("Ошибка при установке статуса <Исполнение 2ч> по операции.");
     return 1;
  end;

  if( (GetOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_ED()) != DV_OPERSTATUS_PAYM_EX) and
      (GetOprStatus( DV_OPERSTATUS_KIND_NETTING_PAYM ) != DV_OPERSTATUS_PAYM_EX) and
      (GetOprStatus( DV_OPERSTATUS_KIND_NETTING_PAYM_L ) != DV_OPERSTATUS_PAYM_EX) and
      (GetOprStatus( DV_OPERSTATUS_KIND_NETTING_PAYM_D ) != DV_OPERSTATUS_PAYM_EX)
    )
    if( not InsertOprStatus( FD.DV_OPERSTATUS_DOC(), DV_OPERSTATUS_DOC_CLOSE) )
       MsgBox("Ошибка при установке статуса <Документооборот> по операции.");
       return 1;
    end;
  end;

  if((FD.IsPctSWAP()) and (РАБОТА_С_РЕПОЗИТАРИЕМ()) and (ДатаПланируемаяШага > {curdate}))
    if(ИзменениеСостоянияОбязательств_ДосрочноеИсполнениеCПлатежами(FD, ДатаИсполненияШага, DocKind) )
       return 1;
    end;
  end;

  return 0;
end;
