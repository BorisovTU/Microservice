/*
$Name:        dvsw150.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг "Исполнение требований  2 ч"
*/
import "dv_car.mac";
import dv_carchng;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  VAR FD;
  VAR ДатаИсполненияШага;
  var ДатаПланируемаяШага = DV_GetPlanDateStep(ID_Operation, ID_Step);

  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal( DocKind, ndeal, 2 );
  if (FD.ОтказОтИсполнения())
     return 0;
  end;
  var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );

  ДатаИсполненияШага = ДатаПланируемаяШага;
  if( ДатаИсполненияШага == date(0,0,0) )
     ДатаИсполненияШага = FD.ДатаТребования();
  end;

  if (FD.Netting2())//TEG 08.02.19
      if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND_2(), DV_OPERSTATUS_DL_COMPLETE) )
          MsgBox("Ошибка при установке статуса <Требования> по операции.");
          return 1;
      end;
      if (ПлатежТреб.PaymStatus != PM_FINISHED) 
          if ( (FD.ВалютныйРынок()) and (not FD.IsClient()) )
                if( ПИ_УстановитьСтатусПлатежа(ПлатежТреб, PM_CLOSED_W_M_MOVEMENT) )
                    MsgBox("Ошибка при установке платежу статуса \"Исполнен\"");
                    return 1;
                end; 
          end;
      end;
      return 0;
  end;



  if (ПлатежТреб.PaymStatus == PM_OVERDUE)

   var stat = true;
   var findAccount = "";

      stat = FD.FindNumberAccount( "Треб. с н.с.",  FindAccount );
      ПлатежТреб.FutureReceiverAccount = FindAccount;

  end;

  if (ПлатежТреб.PaymStatus != PM_FINISHED) 
      if ( (FD.ВалютныйРынок()) and (not FD.IsClient()) )
            if( ПИ_УстановитьСтатусПлатежа(ПлатежТреб, PM_CLOSED_W_M_MOVEMENT) )
                MsgBox("Ошибка при установке платежу статуса \"Исполнен\"");
                return 1;
            end; 
      else
            if( ИсполнитьТребование(FD, ДатаИсполненияШага, doc) != 0 )
                return 1;
            end;
      end;
  end;

 if ( (not FD.IsClient()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsBuy() )
     if (ОтнесениеФинРезультатаДМ( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND_2(), DV_OPERSTATUS_DL_COMPLETE) )
     MsgBox("Ошибка при установке статуса <Требования 2ч> по операции.");
     return 1;
  end;

  if(((FD.IsSWAPNDeal()) or (FD.IsPctSWAP())) and (РАБОТА_С_РЕПОЗИТАРИЕМ()) and (ДатаПланируемаяШага > {curdate}))
    if(ИзменениеСостоянияОбязательств_ДосрочноеИсполнениеCПлатежами(FD, ДатаИсполненияШага, DocKind) )
       return 1;
    end;
  end;

  return 0;
end;
