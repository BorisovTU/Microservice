/*
$Name:        dvswiftMT300.mac
$Module:      Производные инструменты
$Description: Печать сообщений SWIFT
*/
import "dv_categ.mac", "DvRepFun2.mac", "dldlngfun.mac", "commonutil.mac", dv_lib;
import "wlgenmes.mac";
import "wlgenmes_usr.mac", "dvswiftprint.mac";
import "WLTOOLS.mac", "swtools.mac";
import "mtedit.mac";

PRIVATE VAR settacc = TRecHandler("settacc.dbt");
private const NOACC:string = "ACC YOUR INSTRUCTIONS";

private macro getTransportFromDeal(DealID:integer,transport:@string):string

  var query, DataSet, cmd;

  transport = "СПФС";

  query = "SELECT dvndeal.t_id, dvndeal.T_CONFTPID, TRANSP.T_NAME, "+
          "       (select nalg.t_sznamealg from ddl_genagr_dbt ga, dnamealg_dbt nalg where nalg.t_itypealg = 3182 "+ 
                                                                                     " and nalg.t_inumberalg = ga.t_confirmmethod "+
                                                                                     " and ga.t_genagrid = dvndeal.t_genagrid) t_name_ga "+
          "FROM ddvndeal_dbt dvndeal, dwltransp_dbt transp "+
          "WHERE dvndeal.t_conftpid = TRANSP.T_TPID AND dvndeal.t_id = ?";
  cmd = DL_RSDCommand(query);
  cmd.AddParam(DealID);
  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    transport = DataSet.Name;
    if(transport == "")
      transport = DataSet.Name_ga;
    end;
  end;        

end;

private macro DeleteFakeSymbols( Str ):string
  var resstr = "", symb, i=0;

  for( i, 1, StrLen(str) )
     symb = SubStr(str, i, 1);
     if( (symb != ",") and (symb != ".") )
        resstr = resstr + symb;
     end;
  end;

  return resstr;
end;

private macro DateToStrDDMMYYYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + DV_LZ(Year, 4);
end;

private macro DateToStrYYYYMMDD( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Year, 4) + DV_LZ(Month, 2) + DV_LZ(Day, 2);
end;

private macro получитьКорСчетФИ(BankId, FIID)
  var query, DataSet, cmd;
  var queryAcc, DataSetAcc, cmdAcc;
  query = "select t.t_coraccount Coracc from DCORSCHEM_DBT t where t.t_corrid = ? and t.t_fiid = ?" ;
  cmd = DL_RSDCommand(query);
  cmd.AddParam(BankId);
  cmd.AddParam(FIID);
  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    return DataSet.Coracc;
  end;
  return "";
end;

PRIVATE MACRO GetIsNotResident ( PartyID:integer )
  var sqlPartcode, PartyRow;

  sqlPartcode = RSDCommand("select t_NotResident "+
                           "  from dparty_dbt    "+
                           " where t_PartyID = ? "+
                           "   and t_NotResident = 'X'");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartyRow = TRsbDataSet(sqlPartcode);
  if( PartyRow.MoveNext() )
     return true;
  end;

  return false;
END;

private macro MakeCommonRef( BIC_A, BIC_B, Rate:string )
  var CommonRef, Bank1, Place1, RefCode, Bank2, Place2, LastNonZero, i, symb;

  if( StrLen(BIC_A) < 8 )
     RunError("|SWIFT-код банка нашего банка меньше 8 символов");
  end;

  if( StrLen(BIC_B) < 8 )
     RunError("|SWIFT-код банка-контрагента по сделке меньше 8 символов");
  end;

  if( BIC_A > BIC_B )
     Bank1  = SubStr(BIC_B, 1, 4);
     Place1 = SubStr(BIC_B, 7, 2);
     Bank2  = SubStr(BIC_A, 1, 4);
     Place2 = SubStr(BIC_A, 7, 2);
  else
     Bank1  = SubStr(BIC_A, 1, 4);
     Place1 = SubStr(BIC_A, 7, 2);
     Bank2  = SubStr(BIC_B, 1, 4);
     Place2 = SubStr(BIC_B, 7, 2);
  end;

  Rate = DeleteFakeSymbols(Rate);

  LastNonZero = 0;
  for( i, 1, StrLen(Rate) )
     symb = SubStr(Rate, i, 1);
     if( (symb != "0") and (symb != ",") and (symb != ".") )
        LastNonZero = i;
     end;
  end;

  if( LastNonZero >=4 )
     RefCode = SubStr(Rate, LastNonZero-3, 4);
  else
     RefCode = SubStr(Rate, 1, LastNonZero);
     while( StrLen(RefCode) < 4 )
        RefCode = "0" + RefCode;
     end;
  end;

  CommonRef = Bank1 + Place1 + RefCode + Bank2 + Place2;

  return CommonRef;
END;

/* Определение типа операции */
private macro ОпределитьТипОперации( ObjType, ObjID, Sending, DocKind )
  var rs:object;
  var select:string;
  var params:TArray;

   var query = " begin\n ? := RSP_SECURITY.getcountmsg(?, ?, ?);\n end; ";
   var cmd = RSDCommand(query);
   cmd.AddParam("n_Count", RSDBP_OUT, V_INTEGER);
   cmd.AddParam("p_KindMes", RSDBP_IN, "MT300");
   cmd.AddParam("p_DraftID", RSDBP_IN, ObjID);
   cmd.AddParam("p_DraftKind", RSDBP_IN, DocKind);
   cmd.Execute();
   var mCount = SQL_ConvTypeInteger(cmd.value("n_Count"));

   if (mCount > 0)
     setparm( 2, TRUE );
     setparm( 3,"/" + mCount );

     return TYPE_OPERATION_AMND;
   end;
     return TYPE_OPERATION_NEWT;





  select = " select lnk.t_ObjID " +
           "   from dwlmeslnk_dbt lnk " +
           " where lnk.t_ObjID   = :ObjID and "+
           "       lnk.t_ObjKind = :ObjType and "+
           "       lnk.t_Direct  = chr(0) ";
  params = makeArray( SQLParam("ObjID",   ObjID),
                      SQLParam("ObjType", ObjType) );
  rs = execSQLselect( select, params, FALSE );

  if( rs.moveNext() )
     SetParm(2, TRUE);
     return TYPE_OPERATION_AMND;
  else
     return TYPE_OPERATION_NEWT;
  end;
end;

/* Определение Связанного референса */
private macro ОпределитьСвязанныйРеференс( ObjType, ObjID )
  var rs:object;
  var select:string;
  var params:TArray;
  select = "SELECT t.t_trn                                      "+
           "  FROM DWLMES_DBT t                                 "+
           " WHERE t.t_mesid = (select max(lnk.t_mesid)         "+
           "                      from dwlmeslnk_dbt lnk        "+
           "                     where lnk.t_ObjID = :ObjID     "+
           "                       and lnk.t_ObjKind = :ObjType "+
           "                       and lnk.t_Direct = chr(0))";
  params = makeArray( SQLParam("ObjID",   ObjID),
                      SQLParam("ObjType", ObjType) );
  rs = execSQLselect( select, params, FALSE );

  if( rs.moveNext() )
     return rs.value(0);
  else
     return null;
  end;
end;

private macro СформироватьПоле20(DealDate, PartyID, DealCodePS, IsDealSWAP, IsDealReverse);
   var day, mon, year, СтрокаИтого, s, err;
   СтрокаИтого = "";
   DateSplit(DealDate, day, mon, year);
//DAN отключено так как нарушается максимальная длина поля
//   СтрокаИтого = СтрокаИтого + string(day:2:o, mon:2:o, SubStr(String(year),3));
   s = ПолучитьКодСубъекта(PartyID, 103, err);
   if(err)
      s = "UNDF";
   else
      s = SubStr(s, 1, 4);
   end;
   СтрокаИтого = СтрокаИтого + s;

   if(IsDealSWAP)
      s = IsDealReverse;
   else
      s = "0";
   end;
   СтрокаИтого = СтрокаИтого + s;

   s = SubStr(DealCodePS, StrLen(DealCodePS) - 4); /* Последние 5 символов номера сделки */
   СтрокаИтого = СтрокаИтого + s;

   return СтрокаИтого
end;

PRIVATE MACRO IsCorschem_LORO (corrid, FIid)

        FILE crs(corschem) key 1;
        crs.Number  = corrid;
        crs.FI_Kind = 1;
        crs.FIid = FIid;
        if( getEQ(crs) )
            if (crs.ISNOSTRO == SET_CHAR)
                return false;
            else
                return true;
            end;
        else
            return false;
        end;
END;

/* Определение Генерального соглашения */
private macro ОпределитьГС( PartyID, GenAgrID )
  var sGenType;
  var que = "select count(*) from DDL_GENAGR_DBT where t_partyid = " + PartyID + " and t_genagrid = " + GenAgrID;
  var rs01 = LnGetRecordSet(que);
  if(rs01 != null)
    if (rs01.moveNext)
      if (int(rs01.value(0)) > 0 )
        que = "select t_code,to_char(t_date_genagr,'dd.mm.yyyy') from DDL_GENAGR_DBT where t_partyid = " + PartyID + " and t_genagrid = " + genagrid;
        var rs02 = LnGetRecordSet(que);
        if(rs02 != null)
          if (rs02.moveNext)
            StrChangeRusXSet(rs02.value(0) + " " + rs02.value(1), sGenType); /* ВР. Транслитерация номера ГС */
            return sGenType;
          end;
        end;
      end;
    end;
  end;
end;

/* Получение связанного референса */
private macro GetRelatedReference( DealID, TypeMsg, DocKind )
  var query = " begin\n ? := RSP_SECURITY.GetRelatedReference(?,?,?);\n end; ";
  var cmd = RSDCommand(query);
  cmd.AddParam("p_Refer", RSDBP_OUT, V_STRING);
  cmd.AddParam("p_KindMes", RSDBP_IN, TypeMsg);
  cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
  cmd.AddParam("p_DraftKind", RSDBP_IN, DocKind);
  cmd.Execute();
  var refer = SQL_ConvTypeInteger(cmd.value("p_Refer"));
  return refer;
end;

/* Количество ссобщений по сделке */
private macro GetCountMsg( DealID, TypeMsg/*, ObjID DAN*/, DocKind )
  var query = " begin\n ? := RSP_SECURITY.GetCountMsg(?,?,?);\n end; ";
  var cmd = RSDCommand(query);
  cmd.AddParam("p_Count", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("p_KindMes", RSDBP_IN, "MT300");
  cmd.AddParam("p_DraftID", RSDBP_IN, /*ObjID DAN*/DealID);
  cmd.AddParam("p_DraftKind", RSDBP_IN, DocKind);
  cmd.Execute();
  var cnt = SQL_ConvTypeInteger(cmd.value("p_Count"));
  return cnt;
end;

private macro GetField_57a_300( PartyID, CodeKind, CodeValue, BankName, CorrAccount, FIID, Netting )
  FILE bankdprt(bankdprt) key 0;
  record RecordAdress ( adress );
  var field_value = "", Tag, tempv, ID, BankCode, error, INN = "", KPP = "", isNetting;

  /*Проверим пришел ли параметр неттинга*/
  /*PNV 517626 во-первых, параметр должен быть 6-ой, во-вторых - зачем еще одна переменная isNetting? Уже есть Netting, почему бы ее не использовать?*/
  /*GetParm(7, isNetting);
  if (ValType(isNetting) == V_UNDEF)
    isNetting = "";
  end;*/
  isNetting = Netting;

  /* Только по наименованию пока банк не заполняем */
  if( (PartyID != 0) OR ((CodeKind != 0) AND (CodeValue != "")) )
    if( (CodeKind != 0) AND (CodeValue != "") )
      ID = ПолучитьКодСубъекта( CodeValue, CodeKind, error );
      if( error ) RunError( "|Не найден банк c кодом: " + CodeValue + " и видом кода: " + CodeKind ); end;
    else
      ID = PartyID;
    end;

    if( FIID != NATCUR )
      BankCode = ПолучитьКодСубъекта( ID, PTCK_SWIFT, error );
      CodeKind = PTCK_SWIFT;
      if( (BankCode != "") AND (CodeKind == PTCK_SWIFT) )
        Tag = ":57A:";
      else
        Tag = ":57J:";
      end;
    else
      BankCode = ПолучитьКодСубъекта( ID, PTCK_BIC, error );
      CodeKind = PTCK_BIC;
      if( (BankCode != "") AND (CodeKind == PTCK_BIC) )
        Tag = ":57J:";
      else
        BankCode = ПолучитьКодСубъекта( ID, PTCK_SWIFT, error );
        CodeKind = PTCK_SWIFT;
        if( (BankCode != "") AND (CodeKind == PTCK_SWIFT) )
          Tag = ":57A:";
        else
          Tag = ":57J:";
        end;
      end;
    end;

    if (isNetting == "X")
      Tag = ":57J:";
    end;

    if( Tag == ":57A:" )
      if( CorrAccount != "" )
        println(Tag + "/" + CorrAccount);
      else
        println(Tag + "/" + NOACC);
      end;
      println(BankCode);
    else
      if(isNetting == "X")
        println(Tag + "/NOSI/NETS");
      else
/*
        if( (BankName == "") and ( not ПолучитьСубъекта(PartyID, wlparty) ) )
          BankName = wlparty.ShortName;
        end;
*/
        if( (BankCode != "") AND (CodeKind == PTCK_BIC) )
          bankdprt.PartyID = ID;
          GetEQ(bankdprt);

          if(bankdprt.CorAcc != "")
            println(String(Tag + "//RU" + BankCode, ".", bankdprt.CorAcc));
          else
            println(Tag + "//RU" + BankCode);
          end;

          INN = RemoveKPP( GetPartyINN( ID, 1 ) );
          KPP = RemoveINN( GetPartyINN( ID, 1 ) );
          if( INN != "" )
            println(String("INN", INN));
            if ( KPP != "")
              println(String(".KPP", KPP));
            end;
          end;

          if( BankName != "" )
            if( (bankdprt.PlaceName!="") AND (Index(strUpr(BankName), strUpr(trim(bankdprt.PlaceName)))==0) )
              BankName = string( BankName, SYMB_ENDL, trim(bankdprt.Place),trim(bankdprt.PlaceName) );
            end;
            StrChangeRusXSet( BankName, tempv );
            StrMultyToFormat( tempv, tempv, 35, 3 );
            println(tempv);
          end;

        else
          if(CorrAccount != "")
            println("/" + CorrAccount);
          else
            println("/" + NOACC);
          end;

          if( (ID) AND НайтиЮридическийАдресСубъекта(ID,RecordAdress) AND
           (RecordAdress.Place!="") AND (Index(strUpr(BankName), strUpr(trim(RecordAdress.Place)))==0) )
            if(RecordAdress.CodePlace!="")
              BankName = string( BankName, SYMB_ENDL, trim(RecordAdress.CodePlace),".",trim(RecordAdress.Place) );
            else
              BankName = string( BankName, SYMB_ENDL, trim(RecordAdress.Place) );
            end;
          end;
          StrChangeRusXSet( BankName, tempv );
          StrMultyToFormat( tempv, tempv, 35, 4 );
          println(tempv);
        end;
      end;
    end;
  end;

end;

private macro PrintCommonMT300( FD, ObjKind:integer, Y, Transp )
  FILE crs(corschem) key 1;
  var field_value, error, Sending = FALSE, DemandPayment,
      LiabilityPayment, IsDealSWAP, IsDealReverse, PartyID, ObjID, DealCodePS, DealDate,genagrid,
      PartyABIC, PartyBBIC, SwiftRate, IsSale = FALSE, CorrID = 0, CorrAcc = "", Netting = "", TypeOper;
  var IsPFI; /* ВР */
  private var tempv;/*CHVA*/

  IsDealReverse = IsDealReverseMode();

  DemandPayment    = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  LiabilityPayment = RsbPayment(FD.ПлатежОб.rec.PaymentID);

  IsDealSWAP = FD.IsSWAP();
  IsSale     = FD.IsSale();
  PartyID    = FD.deal.rec.Contractor;
  ObjID      = FD.deal.rec.ID;

  DealCodePS = FD.deal.rec.Code;
  IsPFI      = FD.deal.rec.IsPFI;

  DealDate   = FD.deal.rec.Date;
  Netting    = FD.deal.rec.netting;

  if( ObjKind == OBJTYPE_OUTOPER_DV )
     if( FD.NFI_baseactiv.rec.type == 2 )
         Netting = FD.deal.rec.netting2;
     end;
  elif( ObjKind == OBJTYPE_FXOPER_DV )
     if (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL")/*CHVA добавил для  операции 4815 */
          if( FD.NFI_baseactiv.rec.type == 2 )
         Netting = FD.deal.rec.netting2;
         end;
     elif (FD.NFI.rec.type == 2)
         Netting = FD.deal.rec.netting2;
     end;
  end;

  PartyABIC = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT, error);
  if( error )
     RunError("|Не найден SWIFT-код банка нашего банка");
  end;

  PartyBBIC = ПолучитьКодСубъекта(PartyID, PTCK_SWIFT, error);
  if( error )
     RunError("|Не найден SWIFT-код банка-контрагента по сделке");
  end;

  if( ObjKind == OBJTYPE_OUTOPER_DV )
     SwiftRate = GetSWIFTRate(FD.nFI_().rec.Price);
  elif( ObjKind == OBJTYPE_FXOPER_DV )
      if (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL")/*CHVA добавил для  операции 4815 */
          SwiftRate = GetSWIFTRate(FD.NFI_baseactiv.rec.Price) ;
      else
         SwiftRate = GetSWIFTRate(FD.nFI.rec.Price);
     end;
  end;

  /* Основная последовательность "Общая информация"*/
  println(":15A:");
  /* Референс отправителя */
  var cnt = GetCountMsg(ObjID, "MT300", FD.deal.rec.DocKind);
  println(":20:" + СформироватьПоле20(FD.deal.rec.Date, PartyID, DealCodePS, IsDealSWAP, Y) + IIF(cnt != 0, "-" + cnt,""));

  /* Определяем тип операции */
  var sCount = "";
  if( IsDealSWAP == TRUE )
     TypeOper = TYPE_OPERATION_NEWT;
  else
     TypeOper = ОпределитьТипОперации(ObjKind, ObjID, Sending, sCount, FD.deal.rec.DocKind);
  end;


  /* Связанный референс */
  var RelatedReference = GetRelatedReference(ObjID, "MT300", FD.deal.rec.DocKind);
  if( (IsDealSWAP == FALSE) AND (Sending == TRUE) AND (RelatedReference != "") )
     println(":21:" + substr(RelatedReference, 1, 16));
  end;
  /* Тип операции */
  println(":22A:" + TypeOper);
  /* Характер операции */
  println(":94A:BILA");
  /* Общий референс */
  println(":22C:" + MakeCommonRef(PartyABIC, PartyBBIC, SwiftRate));
  /* Сторона А */
  println(":82A:" + PartyABIC);
  /* Сторона В */
  println(":87A:" + PartyBBIC);
  /* Условия контракта */
  if( FD.deal.rec.genagrid > 0 )
     if( IsPFI )
        println(":77D:DERIVATIVE");
        println(ОпределитьГС(PartyID, FD.deal.rec.genagrid));
     else
        println(":77D:" + ОпределитьГС(FD.deal.rec.Contractor, FD.deal.rec.genagrid));
     end;
  end;
  /*дополнительные поля для расчетного форварда*/
  /*DAN 12.11.2020 i-support#517657*/
  if((FD.deal.rec.kind == 12690) and (FD.ПоставочныйКонтракт == false))
    println(":17F:" + "Y");
    println(":17O:" + "Y");
    println(":32E:" + ПолучитьКодВалютыЛог(FD.nfi_baseactiv.rec.pricefiid));
    println(":30U:" + GetSWIFTDateFull(GetDateAfterWorkDays(FD.ДатаИсполнения(), -1) ));
    println(":14S:" + "RUB05");
  end;
  /*DAN*/

  /* Основная последовательность "Детали операции" */
  println(":15B:");
  /* Дата сделки */
  println(":30T:" + DateToStrYYYYMMDD(FD.ДатаСделки()));
  /* Дата валютирования */
  println(":30V:" + GetSWIFTDateFull(FD.ДатаИсполнения()));
  /* Курс конвертации */
  println(":36:" + SwiftRate);
  /* Валюта, "Купленная сумма" */
  println(":32B:" + ПолучитьКодВалютыЛог(DemandPayment.BaseFIID) + GetSWIFTAmount(DemandPayment.BaseAmount));

  crs.Number  = DemandPayment.OutCorschem;
  crs.FI_Kind = 1;
  crs.FIID    = DemandPayment.BaseFIID;
  if( getEQ(crs) )
     CorrID  = crs.CorrID;
     CorrAcc = crs.CorAccount;
  else
     CorrID = 0;
  end;
  /* Агент-получатель 57a */
  if( DemandPayment.BaseFIID == 0 )
     if(Netting == "X")
       println(":57J:/NOSI/NETS");
     else
       StrChangeRusXSet( DemandPayment.ReceiverName, tempv );
       println(":57J:/ABIC/" + PartyABIC);
       println("/NAME/ " + tempv);
       println("/TXID/INN " + {INN_Bank} + " BIC " + {MFO_Bank});
       println("/ADD1/CA " + DemandPayment.ReceiverCorrAccNostro);
       println("/ACCT/ " + IIF(strlen(DemandPayment.ReceiverAccount) > 1, DemandPayment.ReceiverAccount, NOACC));
     end;
  else
     crs.Number  = DemandPayment.inCorschem;
     crs.FI_Kind = 1;
     crs.FIID    = DemandPayment.BaseFIID;
     if( getEQ(crs) )
        CorrID  = crs.CorrID;
        CorrAcc = crs.coraccount;
     else
        CorrID = 0;
     end;
     if( ObjKind == OBJTYPE_FXOPER_DV )
        if( (DemandPayment.PayerBankID == {Ourbank}) and (DemandPayment.ReceiverBankID == {Ourbank}) )
           GetField_57a_300(DemandPayment.ReceiverBankID, DemandPayment.ReceiverBankCodeKind, DemandPayment.ReceiverBankCode, DemandPayment.ReceiverBankName,
                            DemandPayment.ReceiverAccount, DemandPayment.BaseFIID, Netting);
        elif( (CorrID != 0) and (DemandPayment.PayerBankID != {Ourbank}) and DemandPayment.IsExternal )
           GetField_57a_300(CorrID, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName,
                            CorrAcc, DemandPayment.BaseFIID, Netting);
        end;
     else
        if( (CorrID != 0) and (not IsCorschem_LORO(DemandPayment.inCorschem, DemandPayment.BaseFIID)) )
           GetField_57a_300(CorrID, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName,
                            CorrAcc, DemandPayment.BaseFIID, Netting);
        elif( (CorrID != 0) and (DemandPayment.PayerBankID != {Ourbank}) and (DemandPayment.ReceiverBankID != {Ourbank}) and DemandPayment.IsExternal )
           GetField_57a_300(CorrID, DemandPayment.ReceiverBankCorrCodeKind, DemandPayment.ReceiverBankCorrCode, DemandPayment.ReceiverBankCorrName,
                            CorrAcc, DemandPayment.BaseFIID, Netting);
        else
           GetField_57a_300(DemandPayment.ReceiverBankID, DemandPayment.ReceiverBankCodeKind, DemandPayment.ReceiverBankCode, DemandPayment.ReceiverBankName,
                            DemandPayment.ReceiverAccount, DemandPayment.BaseFIID, Netting);
        end;
     end;
  end;
  /* Валюта, "Проданная сумма" */
  println(":33B:" + ПолучитьКодВалютыЛог(LiabilityPayment.BaseFIID) + GetSWIFTAmount(LiabilityPayment.BaseAmount));
  /* Агент-получатель 57a */
  if( LiabilityPayment.BaseFIID == 0 )
     if( Netting == "X" )
       println(":57J:/NOSI/NETS");
     else
        var txid = "/TXID/";
        if (strlen(LiabilityPayment.ReceiverAccount) > 1 )
           if (GetIsNotResident(PartyID) == false)
              StrChangeRusXSet( LiabilityPayment.ReceiverName, tempv );
              println(":57J:/ABIC/" + PartyBBIC);
              println("/NAME/ " + tempv);
              if (strlen(LiabilityPayment.ReceiverINN) > 1)
                 txid = txid + "INN " + IIF(strlen(LiabilityPayment.ReceiverINN) > 10, SubStr(LiabilityPayment.ReceiverINN, 1, 10), LiabilityPayment.ReceiverINN) ;
              end;
              if (strlen(LiabilityPayment.ReceiverBankCode) > 1)
                 txid = txid + " BIC " + LiabilityPayment.ReceiverBankCode;
              end;
              println(txid);
              println("/ADD1/CA " + LiabilityPayment.ReceiverCorrAccNostro);
              println("/ACCT/" + LiabilityPayment.ReceiverAccount);
           else
              println(":57A:/" + LiabilityPayment.ReceiverAccount);
              if ( LiabilityPayment.ReceiverBankID == {Ourbank})
                 println(ПолучитьКодСубъекта({Ourbank}, PTCK_SWIFT));
              else
                 println(ПолучитьКодСубъекта(LiabilityPayment.ReceiverBankID, PTCK_SWIFT));
              end;
           end;
        else
           if (GetIsNotResident(PartyID) == false)
              println(":57J:/" + NOACC);
              if (strlen(LiabilityPayment.ReceiverBankCode) > 1)
                 println("BIC " + LiabilityPayment.ReceiverBankCode);
              end;
              if (strlen(LiabilityPayment.ReceiverCorrAccNostro) > 1)
                 println("CA " + LiabilityPayment.ReceiverCorrAccNostro);
              end;
              if (strlen(LiabilityPayment.ReceiverINN) > 1)
                 println("INN " + IIF(strlen(LiabilityPayment.ReceiverINN) > 10, SubStr(LiabilityPayment.ReceiverINN, 1, 10), LiabilityPayment.ReceiverINN));
              end;
              StrChangeRusXSet( LiabilityPayment.ReceiverName, tempv );
              println("/ABIC/" + PartyBBIC + "/NAME/ " + tempv);
/*
              if (strlen(LiabilityPayment.ReceiverINN) > 1)
                 txid = txid + "INN " + IIF(strlen(LiabilityPayment.ReceiverINN) > 10, SubStr(LiabilityPayment.ReceiverINN, 1, 10), LiabilityPayment.ReceiverINN);
              end;
              if (strlen(LiabilityPayment.ReceiverBankCode) > 1)
                 txid = txid + " BIC " + LiabilityPayment.ReceiverBankCode;
              end;
              println(txid);
              println("/ACCT/" + LiabilityPayment.ReceiverAccount);
*/
           else
              println(":57A:/" + NOACC);
              println(ПолучитьКодСубъекта(LiabilityPayment.Receiver, PTCK_SWIFT));
           end;
        end;
     end;
  else
     GetField_57a_300(LiabilityPayment.ReceiverBankID, LiabilityPayment.ReceiverBankCodeKind, LiabilityPayment.ReceiverBankCode, LiabilityPayment.ReceiverBankName,
                      LiabilityPayment.ReceiverAccount, LiabilityPayment.BaseFIID, Netting);
  end;
end;

macro DV_MsgSWIFT_MT300( DealID:integer, DocKind:integer, Transp ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext, FD;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  array MenuItems;

  if(dockind != 199)
     if( DocKind == DL_DVFXDEAL )
        FD = DVFirstDocFXDeal(DL_DVFXDEAL, DealID);
     elif( Dockind == DL_DVNDEAL )
        FD = DVFirstDocNDeal(DL_DVNDEAL, DealID, IIF(IsDealReverseMode(), 2, 1));
    elif( DocKind == DL_DVDEALT3 )/*CHVA 523288*/
        FD = DVFirstDocNDeal(DL_DVDEALT3, DealID);
     end;

     FD.ПлатежТреб();
     FD.ПлатежОб();
     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT300");

     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;

     SetOutput(ReportFileName);
     message("Печать...");
     PrintCommonMT300(FD, IIF(Dockind == DL_DVNDEAL, OBJTYPE_OUTOPER_DV, OBJTYPE_FXOPER_DV), 0, Transp);
     var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
     var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
     SetOutput(NULL, true);
     close(ReportOutFile);

     var MenuResult = -2;
   
     MenuItems[0] = "Отправить в " + Transp;
     MenuItems[1] = "Печатать сообщение";
     MenuItems[2] = "Отмена";

     if(GetDialogFlag())  /*интерфейсный режим*/
       while (MenuResult < 0)
         MenuResult = Menu(MenuItems, "Выбрать действие");
       end;
     else 
         MenuResult = 0;
     end;

     if( MenuResult == 1 )
        ViewFile(ReportOutFile);

     elif(MenuResult == 0 )
        var Text;
        var Msg = "";
        Open(ReportInFile, ReportFileName);

        while(next(ReportInFile))
           Msg = Msg + ReportInFile.str+"\n";
        end;

        Msg = Trim(Msg);

        if (strlen(ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT)) > 11 )
           msgbox("Код BIC ISO (SWIFT)  для " + rsbparty(FD.Deal.rec.Contractor).shortname + " (" +  ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT) +  ") имеет некорректную длину (" 
                                              + strlen(ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT)) + ") при максимальной длине 11 символов. Сообщение не сформировано." );
           return 1;
        else
           var exec_send = true;
           runmtedit(@msg, @exec_send);
    
           if(exec_send)
              set_mtsend_flag(1);
              close(ReportInFile);
              var query = " begin\n ? := RSP_SECURITY.CREATEPAYMFROMSEC(?,?,?,?,?,?,?);\n end; ";
              var cmd = RSDCommand(query);
              cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
              cmd.AddParam("p_KindMes", RSDBP_IN, "MT300");
              cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
              cmd.AddParam("p_Msg", RSDBP_IN, Msg);
              cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
              cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
              cmd.AddParam("p_Transp", RSDBP_IN, Transp);
              cmd.AddParam("p_Dockind", RSDBP_IN, FD.deal.rec.DocKind);
              cmd.Execute();
              var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
              Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
              MsgBox(Text);
           else
             MsgBox("отмена отправки.");
             set_mtsend_flag(0);
           end;
        end;
     end;
  else
     var i = 0;
  
     while(i != 2)
        i = i + 1;
        /*Авторский финт ушами*/
        FD = null;
        var FD_tmp = DVFirstDocNDeal(dockind, DealID);
        if((i == 1) OR (FD_tmp.IsPctSwap() OR FD_tmp.IsSwap))
          FD = DVFirstDocNDeal(dockind, DealID, i);
        else
          continue;
        end;
        FD.ПлатежТреб();
        FD.ПлатежОб();

        if(GetDialogFlag())
          MenuItems[0] = "Печатать MT300 по " + i + "-й части";
          MenuItems[1] = "Отправить MT300 по " + i + "-й части";
          MenuResult = Menu(MenuItems, "Выбрать действие");
        else
          MenuResult = 1;
        end;

        ReportFileName = GetTxtFileName(FD.DealCode() + "_MT300");
  
        if( Open(ReportOutFile, ReportFileName) == false )
           errcode = status(errtext);
           MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
           return 1;
        end;
  
        SetOutput(ReportFileName);
        message("Печать...");
        PrintCommonMT300(FD, OBJTYPE_OUTOPER_DV, i, Transp);
        SetOutput(NULL, true);
        close(ReportOutFile);
  
        if(MenuResult == 0) 
           ViewFile(ReportOutFile);
        elif( MenuResult == 1 )
           Text;
           Msg = "";
           Open(ReportInFile, ReportFileName);
  
           while(next(ReportInFile))
              Msg = Msg + ReportInFile.str+"\n";
           end;
  
           Msg = Trim(Msg);/*PNV i-support 501082*/

           if (strlen(ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT)) > 11 )
              msgbox("Код BIC ISO (SWIFT)  для " + rsbparty(FD.Deal.rec.Contractor).shortname + " (" +  ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT) +  ") имеет некорректную длину (" 
                                                 + strlen(ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT)) + ") при максимальной длине 11 символов. Сообщение не сформировано." );
              return 1;
           else
              exec_send = true;
              runmtedit(@msg, @exec_send);
     
              if(exec_send)
                 set_mtsend_flag(1);
                 close(ReportInFile);
                 query = " begin\n ? := RSP_SECURITY.CREATEPAYMFROMSEC(?,?,?,?,?,?,?);\n end; ";
                 cmd = RSDCommand(query);
                 cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
                 cmd.AddParam("p_KindMes", RSDBP_IN, "MT300");
                 cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
                 cmd.AddParam("p_Msg", RSDBP_IN, Msg);
                 cmd.AddParam("p_BIC", RSDBP_IN, ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT));
                 cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
                 cmd.AddParam("p_Transport", RSDBP_IN, Transp);  
                 cmd.AddParam("p_DraftKind", RSDBP_IN, FD.Deal.rec.DocKind);  
                 cmd.Execute();
                 stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
                 Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
                 MsgBox(Text);
              else
                 MsgBox("отмена отправки.");
                 set_mtsend_flag(0);
              end;
           end;
        end;
     end;
  end;

  return RetVal;

onError(er)
 msgbox("Невозможно сформировать сообщение. Проверьте корректность параметров сделки и сторон по ней. " + Text);
end;

macro DV_DealsGenMesMT300Paym(DealID, DocKind);
  var Transp;
  getTransportFromDeal(DealID, @transp);
  DV_MsgSWIFT_MT300( DealID, DocKind, Transp );
end;
