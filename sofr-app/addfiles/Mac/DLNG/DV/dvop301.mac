/*
$Name:        dvop301.mac
$Module:      Производные инструменты
$Description: Операция расчетов по ПИ/Шаг - Корректировка счетов по встречным обязательствам
*/

/* Shvetsov Y.A.                             */

import InsCarryDoc, "dvserv.mac", "dv_fun.mac", "dv_carop.mac", "dv_comiss.mac";
MACRO ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  record oper(dvoper);
  var FD_Oper:DVFirstDocOper;
  SetBuff( oper , FDoc );
  var FD;
  var Query:string = "", Data:variant;
  var cmd, cmdF, DataSet, DataSetF;
  var DeltaKi:money = $0;
  var BuySaleID  = "", BuySaleSum = ""; 
  var Count = 0;
  var PrevFairValue:money = $0, FairValue:money = $0, Margin:money = $0;
  accDvdealTrnArr.size = 0;

  FD_Oper = DVFirstDocOper( DL_DVOPER, oper );

  if( УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_DEAL )
      
      Query = " SELECT DEAL.t_ID " +
              "   FROM ddvdllnk_dbt LNK, ddvdeal_dbt DEAL " +
              "  WHERE " + 
              "    DEAL.t_Type in('B', 'S', 'D', 'G') " +
              "    AND DEAL.t_Client = -1 " +
              "    AND LNK.T_DVOPERID  = " + FD_Oper.Dvoper.rec.id +
              "    AND ( (LNK.t_DealID = DEAL.t_ID) OR (LNK.t_SaleDealID = DEAL.t_ID) ) "+
              "    GROUP BY DEAL.t_ID";

      Data = TRsbDataSet(Query);

      if( Data )
         Count = 0;
         InitProgress( SQL_GetNRecs(Query), "Прекращение встречных обязательств", "Выполнение..." );

         // Проводки Пб (корректировка внебалансовых счетов)
         while( Data.MoveNext() )
           
            FD = DVFirstDocDeal( DL_DVDEAL, SQL_ConvTypeInteger(Data.ID) );
            if ( FD.IsBuy() )
               BuySaleID  = "LNK.T_DEALID";
               BuySaleSum = "LNK.T_EXECCOST";
            else
               BuySaleID  = "LNK.T_SALEDEALID";
               BuySaleSum = "LNK.T_SALEEXECCOST";
            end;

            cmd = RsdCommand( " SELECT Sum(LNK.t_Execution) Execution, Sum("+BuySaleSum+") ExecCost"
                              "   FROM ddvdllnk_dbt LNK " +
                              "  WHERE LNK.T_DVOPERID  = " + FD_Oper.Dvoper.rec.id +
                              "  AND " + BuySaleID +" = " +FD.Deal.rec.ID +
                              " GROUP BY " + BuySaleID );
            cmd.execute();
            DataSet = TRsbDataSet(cmd);
            if( DataSet.MoveNext() )
               DeltaKi = SQL_ConvTypeSum(DataSet.rec.Execution);
            else
               RemProgress();
               return 1;
            end;

            /* Сделка полностью исполнена */
           if( FD.Deal.rec.Amount == FD.Deal.rec.Execution )
               /* TEG 06.03.19 ломать не строить if( ВыполнитьПроводкиПоСнятиюСВнебаланса( doc, oper, FD ) == false )
                  RemProgress();
                  return 1;
               end;*/
               if( ВыполнитьПроводкиПоСнятиюСВнебалансаТЕГ( doc, oper, FD,
                                                                (FD.Deal.rec.Amount - FD.Deal.rec.Execution) + SQL_ConvTypeSum(DataSet.rec.Execution),
                                                                FD.Deal.rec.Amount - FD.Deal.rec.Execution,
                                                                FD.Deal.rec.DealCost + SQL_ConvTypeSum(DataSet.rec.ExecCost) ,
                                                                FD.Deal.rec.DealCost ) == false )
                  RemProgress();
                  return 1;
               end; 
            end;

            /* Часть контрактов по сделке исполнено */
            if( (FD.Deal.rec.Amount != FD.Deal.rec.Execution) and (DeltaKi > 0) )
               if( ВыполнитьПроводкиПоКорректировкеВнебаланса( doc, oper, FD,
                                                               (FD.Deal.rec.Amount - FD.Deal.rec.Execution) + SQL_ConvTypeSum(DataSet.rec.Execution),
                                                                FD.Deal.rec.Amount - FD.Deal.rec.Execution,
                                                                FD.Deal.rec.DealCost + SQL_ConvTypeSum(DataSet.rec.ExecCost) ,
                                                                FD.Deal.rec.DealCost ) == false )
                  RemProgress();
                  return 1;
               end;
            end;

           // Проводки Шб (Корректировка справедливой стоимости) и перерасчёт Вариационной Маржи

           cmdF = DL_RsdCommand( " SELECT TURN.t_FairValue, TURN.t_Margin, FIN.t_ParentFI, FIN.t_AvoirKind " +
             "   FROM ddvdlturn_dbt TURN, ddvdeal_dbt DEAL, dfininstr_dbt FIN " +
             "  WHERE TURN.t_Date = " + GetSQLDate(Oper.Date) +
             "    AND DEAL.t_ID     = ? "  +
             "    AND TURN.t_DealID = DEAL.t_ID "     +
             "    AND FIN.t_FIID    = DEAL.t_FIID "   +
             "    ORDER BY TURN.T_DATE DESC"   );
            
           cmdF.AddParam(FD.Deal.rec.ID);
           DataSetF = cmdF.Execute();

            if( DataSetF.MoveNext() )
               PrevFairValue = money(DataSetF.FairValue);
            else
               RemProgress();
               return 1;
            end;
           FairValue = PrevFairValue * (FD.Deal.rec.Amount - FD.Deal.rec.Execution) / ( (FD.Deal.rec.Amount - FD.Deal.rec.Execution) + SQL_ConvTypeSum(DataSet.rec.Execution) );
           Margin    = money(DataSetF.Margin) * (FD.Deal.rec.Amount - FD.Deal.rec.Execution) / ( (FD.Deal.rec.Amount - FD.Deal.rec.Execution) + SQL_ConvTypeSum(DataSet.rec.Execution) );

           //TEG 28.02.19 заглушим проводки по корректировке справедливой стоимости
           /* if( ВыполнитьПроводкиПереоценкиСС( doc, FD, oper, DataSetF.AvoirKind, DataSetF.ParentFI, 0, 0, PrevFairValue, FairValue ) == false )
                RemProgress();
                return 1;
              end;
           */
            if( DV_CalcDealTurn(FD.Deal.rec.ID, oper.Date, 0, FairValue, 0, 1, DV_ACTION_CALCITOG) != 0 )
              RemProgress();
              return 1;
           end;

           UseProgress(Count = Count + 1);
        end;
        RemProgress();
     end;
  end;

  /*Закрытие итогов дня по позициям*/
  /*выполнить ХП: RSB_Derivatives.DV_ClosePositionTurns с сохранением в документах операции*/ 
  if( OprCloseTurns( oper ) == false )
     return 1;
  end;

  if ( not InsertDvdealTrnLink(ID_Operation, ID_Step) )
    MsgBox("Ошибка при сохранении информации о связи проводок со сделками срочного рынка");
    return 1;
  end;

  return 0;
end;
