/*
$Name:        dvfx005.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Настройка операции"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac",funk,dv_lib;

  record deal(dvndeal);


macro executeParamStep( kind_oper, BOf_kind, FDoc )

  var    FD, FD2;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_BEGIN_OP, FD.ДатаСделки());
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_EXEC,     FD.ДатаИсполнения());
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_REQ,      FD.ДатаТребования());
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_OBL,      FD.ДатаОбязательства());
  DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_COMISS,   DL_GetMinComPlanDateByOper(FD.Kind, FD.ID));

  if( FD.IsSWAP() )
     FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, deal, 2);

     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_EXEC_2, FD2.ДатаИсполнения());
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_REQ_2,  FD2.ДатаТребования());
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_OBL_2,  FD2.ДатаОбязательства());
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_CLOSE,  FD2.ДатаЗавершения());
  else
     DL_CalendDefineOprDate(FD, DV_FXDEAL_OPRDATE_CLOSE,  FD.ДатаЗавершения());
  end;

  if( ПИ_ИнтегрРежимРаботы() and FD.IsBNote() )
     if( not УстановитьКатегориюПрихКассСимвол(FD, OBJTYPE_FXOPER_DV, FD.ДатаСделки()) )
        return 1;
     end;
     if( not УстановитьКатегориюРасхКассСимвол(FD, OBJTYPE_FXOPER_DV, FD.ДатаСделки()) )
        return 1;
     end;
  end;

  return 0;
end;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  


  SetBuff(deal, FirstDoc );
  var nn,snn,d2,d0,que,rs5;


  if ( CommitOrRollback == 1 )
 
    if (deal.kind == 2740 )
      snn=3;
    else
      snn=1;
    end;

    d0=DV_DAT(deal.date);
    d2=DV_DAT(d0);
    que="select to_char(t_valuedate,'dd.mm.yyyy') from dpmpaym_dbt a  where a.t_dockind=4813 and a.t_documentid ="+deal.id+" and a.t_purpose="+snn; 
    rs5 = LnGetRecordSet(que);
    if(rs5 != null)
     if (rs5.moveNext) 
        d2=DV_DAT(rs5.value(0));
     end;
    end;

    if ( d0 != d2)
      snn=workdays(d0,d2)-1;
      if ( snn != deal.periodcls)
         msgbox("НЕ верный классификатор сделки !");
         return 1;
      end;
    end;

  end;




  return 0;
END;

