/*
$Name:        dvfx015.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Авторизация"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

macro ExecuteStep( doc, FDoc )

  record deal(dvndeal);
  var    FD, FD2;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  var ДатаИсполненияШага:date;
  var KUNezav, KUNezav_attr; /*PNV 504848*/

  GetOprDate(DV_FXDEAL_OPRDATE_BEGIN_OP, ДатаИсполненияШага);

  /*PNV вместо правок CHVA выше*/
  if (not FD.IsBNote())
      if( ПИКО_АктуализироватьПлатежи(FD, "") != 0 )
          return 1;
      end;

      if( FD.IsSWAP() )
          if( ПИКО_АктуализироватьПлатежи(FD2) != 0 )
              return 1;
          end;
      end;
  else /*PNV 504848 перенесено из макроса dvfx050b.mac - для SWIFT*/
      if (not GetMainObjAttr( null, OBJTYPE_FXOPER_DV, strLpad(string(FD.deal.rec.id), 34, "0"), 202, KUNezav_attr))
         KUNezav_attr = 0;
      end;

      if (FD.DEAL.rec.type == 2); /*Продажа*/
          if(KUNezav_attr != 0)
             if (KUNezav_attr == 2/*"Предоплата"*/)
                 KUNezav = "+Незавершенные";
             else
                 KUNezav = "-Незавершенные";
             end;
         else
             if (SubStr (FD.DEAL.rec.comment,index (FD.DEAL.rec.comment,"рамках лимита"),13) == "рамках лимита")/*CHVA Добавил проверки на сделки в рамках лимита */         
                 if( MsgBoxEx("Подтвердите наличие платежа", MB_YES + MB_NO, IND_YES) == IND_YES ) /*если выбираем Yes, то документ есть, значит предпоставка (счет 30222) иначе предоплата (счет 30221)*/
                     KUNezav = "+Незавершенные";
                 else
                     KUNezav = "-Незавершенные";
                 end;          
             else
                 KUNezav = "-Незавершенные";
             end;
         end;
     elif (FD.DEAL.rec.type == 1);/*Покупка*/
           if(KUNezav_attr != 0)
              if (KUNezav_attr == 2/*"Предоплата"*/)
                  KUNezav = "-Незавершенные";
              else
                  KUNezav = "+Незавершенные";
              end;  
           else                
              if (SubStr (FD.DEAL.rec.comment,index (FD.DEAL.rec.comment,"рамках лимита"),13) == "рамках лимита")/*CHVA Добавил проверки на сделки в рамках лимита */           
                  if( MsgBoxEx("Подтвердите наличие кассовой проводки", MB_YES + MB_NO, IND_YES) == IND_YES ) /*если выбираем Yes, то документ есть, значит предпоставка (счет 30221) иначе предоплата (счет 30222)*/
                      KUNezav = "-Незавершенные";
                  else
                      KUNezav = "+Незавершенные";
                  end;          
              else 
                  KUNezav = "+Незавершенные";
              end;
          end;
     end;
     if( ПИКО_АктуализироватьПлатежи(FD, KUNezav) != 0 )
        return 1;
     end;
  end;
  /*PNV 504848 перенесено из макроса dvfx050b.mac*/

  var PaymentReq = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  var PaymentCom = RsbPayment(FD.ПлатежОб.rec.PaymentID);

  /* устанавливаем признак участия в неттинге */
  if (FD.Netting())
     if( (FD.ПлатежТреб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежТреб.rec.PayerAccount)) )
        PaymentReq.Netting = SET_CHAR;
     end;

     if( (FD.ПлатежОб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежОб.rec.ReceiverAccount)) )
        PaymentCom.Netting = SET_CHAR;
     end;
  end;

  if( FD.IsSWAP() )
     FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, deal, 2);

     var PaymentReq2 = RsbPayment(FD2.ПлатежТреб.rec.PaymentID);
     var PaymentCom2 = RsbPayment(FD2.ПлатежОб.rec.PaymentID);

     /* устанавливаем признак участия в неттинге */
     if( /*FD2.IsClient() and*/ FD2.Netting() ) //Simanov. Неттинг не только для клиентских сделок
        if( (FD2.ПлатежТреб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD2.ПлатежТреб.rec.PayerAccount)) )
           PaymentReq2.Netting = SET_CHAR;
        end;
    
        if( (FD2.ПлатежОб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD2.ПлатежОб.rec.ReceiverAccount)) )
           PaymentCom2.Netting = SET_CHAR;
        end;
     end;
  end;

  // !!! Изменить состояние сделки на "авторизована". Сделке присвоить хронологический номер  - ?????? !!!
  if ((FD.СрокСделки() != DV_PERIODCLS_T0)
       and (not FD.IsClient())
       and IIF(FD.IsBNote(),  
                (FD.ВалютаБазовогоАктива()!=FD.ВалютаКонтрАктива()) and RegVal_УчетРазноВалютныхБанкнотныхСделок(),  
                true  )  
     )

    if (not InsertOprStatus(DV_FX_OPERSTATUS_KIND_OFFBALANCE,
                            DV_FX_OPERSTATUS_DL_RUN))
      MsgBox("Ошибка при установке статуса <Внебаланс> по операции.");
      return 1;
    end;
  else
     if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_OFFBALANCE, DV_FX_OPERSTATUS_DL_COMPLETE) )
        MsgBox("Ошибка при установке статуса <Внебаланс> по операции.");
        return 1;
     end;

     if( not FD.IsClient() )
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_BALANCE, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Баланс> по операции.");
           return 1;
        end;
     else
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_BALANCE, DV_FX_OPERSTATUS_DL_COMPLETE) )
           MsgBox("Ошибка при установке статуса <Баланс> по операции.");
           return 1;
        end;

        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Требования> по операции.");
           return 1;
        end;

        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
           return 1;
        end;
     end;
  end;
  var Дк = DL_GetMinComPlanDateByOper(FD.Kind, FD.ID);
   if(not FD.IsDealMet())
  if( Дк != date(0,0,0) )
     if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_COMISS, DV_FX_OPERSTATUS_PAYM_EX) )
        MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
        return 1;
     end;
         DL_CalendDefineOprDate(FD,DV_FXDEAL_OPRDATE_COMISS, Дк);
  else
     if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_COMISS, DV_FX_OPERSTATUS_PAYM_NOTEX) )
        MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
        return 1;
     end;
  end;
   end;

  if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DOC, DV_FX_OPERSTATUS_DOC_OPEN) )
     MsgBox("Ошибка при установке статуса <Документооборот> по операции.");
     return 1;
  end;

  // KS Если для валюты мы попадаем на выходной день, то надо запланировать блок "Исполнение обязательств"
  var isEastCur = 0;
  var CategValue;/*CHVA*/
  if ( not GetMainObjAttr( null, 2, strLpad(string(FD.ВалютаОбязательства()/*FD.nfi.rec.fiid*/), 10, "0"), 101, isEastCur))/*PNV i-support 500390 надо же проверять валюту обязательства, а не базовую валюту!*/
    isEastCur = 0;
  end;
  if ((isHoliday(FD.nfi.rec.supldate))or(isEastCur == 1))
  //CHVA 498265 для банкнотных сделок "продажа" при БА "Восточные валюты" шаг обязательства не планировать после постановки на внебаланс
   if ( FD.IsBNote() and (isEastCur == 1) and FD.isSale() )
       return 0 ;          
   else     
      if (not GetMainObjAttr( null, 148 , strLpad(string(FD.nfi.rec.dealid), 34, "0"), 202, CategValue))
        CategValue = 0;
      end;

      /*PNV для сделок НЕ T0*/
      if (FD.СрокСделки() != DV_PERIODCLS_T0)
          if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
              MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
              return 1;
          end;
      end;  
      /*CHVA 498265 для сделок покупки восточной валюты необходимо актуализация платежа обязательства на этом шаге, иначе некорректно подбираются счета в проводку ("- Незавершенные"" берется для сделок покупки и категории "Предоплата", "+Незавершенные" -для Предпоставки)*/
      if(CategValue == 2)
        if( ПИКО_АктуализироватьПлатежОбяз( FD, "-Незавершенные") != 0 )
            return 1;
        end;
      elif (CategValue ==1)
        if( ПИКО_АктуализироватьПлатежОбяз( FD, "+Незавершенные") != 0 )
            return 1;
        end;
      end;
       /*CHVA 498265*/
   end;
  end;

  if(FD.IsDealMet())
     if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_CONFIRM, DV_FX_OPERSTATUS_DL_RUN) )
        MsgBox("Ошибка при установке статуса <Подтверждение> по операции.");
        return 1;
     end;
  end;

  return 0;
end;
