/*
$Name:        dv_grfun.mac
$Module:      ФИСС и КО
$Description: Функции работы с графиками
*/

import BankInter, CTInter;
import "dlquery.mac", "dltransf.mac", "dlcnst.inc", "dldlngconst.mac", "spserv.mac", "sp_class.mac", "dl_grfun.mac", "cb_sql.mac", "sp_grfun.mac", "dv_categ.mac";

private var ArrGrDeal = DL_GrDealData();
private var ArrRepozDeal = RepozDealData();
private var TemplDateArr = TArray( false, 100, 100 ); //кеш для видов дат по шаблонам

/*DAN Проврка на существование графика*/
private macro FairValueGrExist(pDocID, pDate, pTemplNum) 
  var gr_sql, gr_cmd, gr_rs;
  gr_sql = "Select 1 gr_vol from ddlgrdeal_dbt where t_templnum = ? and t_plandate = ? and t_docid = ?";
  gr_cmd = RSDCommand(gr_sql);
  gr_cmd.AddParam("", rsdbp_in, pTemplnum );
  gr_cmd.AddParam("", rsdbp_in, pDate);
  gr_cmd.AddParam("", rsdbp_in, pDocID);
  gr_rs = RSdRecordset(gr_cmd);

  if(gr_rs.MoveNext())
    return True;
  end;
    return False; 
end;

/*dan возвращает true если на сделке установлен признак неттинга хотя бы на одной из частей*/
private macro IsSetNetting(dealid)
  var sql, cmd, rs;
  sql = "select 1 from ddvndeal_dbt dvn where dvn.t_id = :dealid and (dvn.t_netting = chr(88) or dvn.t_netting2 = chr(88))";
  cmd = RSDCommand(sql);
  cmd.AddParam("dealid", rsdbp_in, dealid);
  rs = RSDRecordset(cmd, rsdval_client, rsdval_static);
  if (rs.MoveNext())
   return true;
  end;
  return false;
end;

private macro GenerateIRDealCode(dCode:@String)

private macro DV_LZ( num, len:integer ):string
   var RetVal:string = "";
   var str1:string = "", len1:integer = 0;

   str1 = trim(string(num));
   len1 = strlen(str1);
   if( len1 >= len )
      RetVal = str1;
   else
      RetVal = mkstr("0", len-len1) + str1; /* слева */
   end;

   return RetVal;
end;

private macro DateToStrDDMMYYYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + DV_LZ(Year, 4);
end;

const NRDSimbol = "QWERTYUIOPASDFGHJKLZXCVBNM0123456789";
var RefNum;
var i = 0;
var str = "";
var ar = StrSplit2(dCode,1);
while (i < ar.size)
  if (index(NRDSimbol,ar[i])>0 )
    str = str + ar[i];
  end;
i = i + 1;
end;
str =DAteToStrDDMMYYYY({Curdate})+ str;
if(not GenerateReference(1000012, RefNum))
  str = str + RefNum;
end;
  dCode = str;;
end;


//Формирование сообщения
private macro isBulkMessage(Code:string)
  var cmd = DL_RSDCommand();
  var query = " SELECT * FROM DIR_TYPESMESSAGE_DBT " +
              " WHERE T_MESSAGECODE = ? ";
  cmd.AddParam(Code);        
  var DataSet = cmd.Execute(query);
  if( DataSet.moveNext() and ( DataSet.Bulk_Report == "X" ) )
    return true;
  else
    return false;
  end;

end;

PRIVATE MACRO GetProductCode(TypeDeal:integer, TypeProduct:integer, ndeal, MessageCode):string
    
    var RetVal:string = "";

    var FD = DVFirstDocNDeal(ndeal.rec.dockind, ndeal.rec.id);
    if( (TypeDeal == 2 /*Term*/) /* OR (TypeDeal == 3 /*Spot*/)*/ )
        return "UKWN";
    end;

    if( TypeProduct > 0 )
        var Select = " SELECT t_TypeCode "
        + "   FROM dir_typeproduct_dbt "
        + "  WHERE t_ID = ? ";
        
        var cmd = DL_RSDCommand(Select);
        cmd.addParam(TypeProduct);
        
        var DataSet = cmd.Execute();
        if( DataSet.MoveNext() )
        RetVal = DataSet.TypeCode;
        else
            RetVal = "_";
        end;
    end;
    
    if( RetVal == "F" ) // Форвард
      // 2
        if( MessageCode == "CM043" )
            RetVal = RetVal + "D";
        elif( FI_IsShare(FD.BaseFI()) OR FI_IsInvestmentShare(FD.BaseFI()) ) /*Долевая ц/б*/
            RetVal = RetVal + "E";
        elif( FI_IsBond(FD.BaseFI()) == true ) /*Долговое обязательство*/
            RetVal = RetVal + "D";
        elif( FD.ВидБазовогоАктива() == FIKIND_INDEX )
            RetVal = RetVal + "С";
        elif( FD.ВидБазовогоАктива() == FIKIND_CURRENCY )
            RetVal = RetVal + "V";
        elif( FD.ВидБазовогоАктива() == FIKIND_DERIVATIVE )
            RetVal = RetVal + "A";
        else
            RetVal = RetVal + "M";
        end;

        //3
        RetVal = RetVal + "O";

        //4
        RetVal = RetVal + "F";

        //5
        RetVal = RetVal + "N";

    elif( RetVal == "O" ) // Опцион
        // 2
        if( FD.IsOptionPut() )
            RetVal = RetVal + "P";
        else
            RetVal = RetVal + "C";
        end;
            
        // 3
        if( FD.IsOptionAmerican() )
            RetVal = RetVal + "A";
        else
            RetVal = RetVal + "E";
        end;
            
        // 4
        RetVal = RetVal + "F";
            
        // 5
        RetVal = RetVal + "N";
            
        // 6
        if( FI_IsShare(FD.BaseFI()) OR FI_IsInvestmentShare(FD.BaseFI()) ) /*Долевая ц/б*/
            RetVal = RetVal + "E";
        elif( FI_IsBond(FD.BaseFI()) == true ) /*Долговое обязательство*/
            RetVal = RetVal + "D";
        elif( FD.ВидБазовогоАктива() == FIKIND_INDEX )
            RetVal = RetVal + "С";
        elif( FD.ВидБазовогоАктива() == FIKIND_CURRENCY )
            RetVal = RetVal + "V";
        elif( FD.ВидБазовогоАктива() == FIKIND_DERIVATIVE )
            RetVal = RetVal + "A";
        else
            RetVal = RetVal + "M";
        end;
    elif( RetVal == "S" ) // Своп
        // 2
        if (FD.IsSWAP()) // Валютный своп
            if( FD.ВидБазовогоАктива() == FIKIND_CURRENCY )
                RetVal = RetVal + "V";
            else
                RetVal = RetVal + "C";
            end;
                
            // 3
            RetVal = RetVal + "F";
                
            // 4
            RetVal = RetVal + "W";
                
            // 5
          //  RetVal = RetVal + "F";
                
            // 5
            if( FD.ВидБазовогоАктива() == FIKIND_CURRENCY )
                RetVal = RetVal + "N";
            else
                RetVal = RetVal + "F";
            end;

            // 6
            RetVal = RetVal + "N";
	    
            // 7
            RetVal = RetVal + "N";		
        else // Процентный своп
            // 2
            if( not FD.БазовыеВалютыРавны() )
              RetVal = RetVal + "G";
            else
              RetVal = RetVal + "P";
            end;

            // 3
            if ((FD.Deal.rec.Type == ALG_DV_FIX_FLOAT) OR (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX))
                RetVal = RetVal + "D";
            elif (FD.Deal.rec.Type == ALG_DV_FIX_FIX)
                RetVal = RetVal + "F";
            elif (FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT)
                RetVal = RetVal + "V";
            end;

            //4
            RetVal = RetVal + "W";

            //5
            RetVal = RetVal + "N";

            //6
            RetVal = RetVal + "N";

            //7
            RetVal = RetVal + "N";
        end;
    end;
        
    return RetVal;
END;

private macro getMessages( ndeal,
                           FI:integer,
                           AvoirKind:integer,
                           ExecType:integer, 
                           BulkMessage:@string, 
                           EasyMessage:@string,
                           STMES:TRecHandler )
  var flag=true;
  var cmd = DL_RSDCommand(),
      query = " SELECT * " +
              "   FROM DIR_SETUPMESSAGE_DBT STPMSG" +
              " WHERE STPMSG.T_KIND_OPERATION = ? " +
              "    AND STPMSG.T_REPORTING = CHR(88)"    +
              "    AND STPMSG.T_FI_KIND = ? "       +
              "    AND ( STPMSG.T_AVOIRKIND <= 0 OR STPMSG.T_AVOIRKIND = ? ) ";
  
  if (ndeal.rec.Sector == SET_CHAR)
    return 1;
  end;

  //Эта логика хоть и кажется странной, но она нужна
  //Удаление этой логики отламает формирование многих сообщений
  query = query + "    AND ( STPMSG.T_ISPFI = chr(0) "  +
              "    OR STPMSG.T_ISPFI = chr(88) "; 
  if (ndeal.rec.IsPFI == SET_CHAR)
    query = query + " AND (STPMSG.T_ISPFI = CHR(88) or STPMSG.T_ISPFI = chr(0)) )    ";
  else
    query = query + " AND STPMSG.T_ISPFI = CHR(0))";
  end;

  query = query + "    AND (STPMSG.T_TYPE_EXEC = -1 "  +
                  "    OR STPMSG.T_TYPE_EXEC = ?) ";

  cmd.AddParam(ndeal.rec.Kind);
  cmd.AddParam(FI);
  cmd.AddParam(AvoirKind);
  cmd.AddParam(ExecType);
  
  var IsSpot = "";
  if (ndeal.rec.PeriodCls == DV_PERIODCLS_T2)
//    query = query + " AND STPMSG.T_ISSPOT = CHR(88)";
    query = query + " AND (STPMSG.T_ISSPOT = 'X' or STPMSG.T_ISSPOT = CHR(0)) ";
  else
    query = query + " AND STPMSG.T_ISSPOT = CHR(0)";
  end;

  if( ndeal.rec.DVKIND == DV_OPTION ) //Внебиржевой опцион
    cmd.AddParam(ndeal.rec.OptionStyle);
    query = query + " AND ( STPMSG.T_STYLEOPTIONS <= 0 OR STPMSG.T_STYLEOPTIONS = ? ) ";
  end;

  if( ndeal.rec.DVKIND == DV_PCTSWAP )
    if(ndeal.rec.SwapType == 0)
      cmd.AddParam(1);//DAN процентный своп  
    else
      cmd.AddParam(ndeal.rec.SwapType);
    end;
    cmd.AddParam(ndeal.rec.Type);
    query = query + "    AND (STPMSG.T_SWAPTYPE = 0 OR STPMSG.T_SWAPTYPE = ?) " +
                    "    AND (STPMSG.T_SWAPDIRECT = 0 OR STPMSG.T_SWAPDIRECT = ?) ";
  end;

  var DataSet = cmd.Execute(query);
  BulkMessage = EasyMessage = null;
  var stat = 0;
  
  while (DataSet.moveNext() and ( not BulkMessage ) and ( not EasyMessage ))
    if ( ( not DataSet.FI_Kind ) or ( DataSet.FI_Kind == FI) )
      if (isBulkMessage(DataSet.MessageCode))
        if (BulkMessage == null)
          BulkMessage = DataSet.MessageCode;  
        else
          stat = 1;
          flag=false;
        end;
      else
        if (EasyMessage == null)
          EasyMessage = DataSet.MessageCode;
        else
          stat = 1;
          flag=false;
        end;    
      end;
    end;

    if(flag)
        STMES.rec.FI_KIND		    =   DataSet.FI_KIND;		
        STMES.rec.KIND_OPERATION    =   DataSet.KIND_OPERATION;
        STMES.rec.MESSAGECODE	    =   DataSet.MESSAGECODE;	
        STMES.rec.REPORTGROUP	    =   DataSet.REPORTGROUP;	
        STMES.rec.REPORTING		    =   DataSet.REPORTING	;	
        STMES.rec.STYLEOPTIONS	    =   DataSet.STYLEOPTIONS;	
        STMES.rec.SYSTEM	        =   DataSet.SYSTEM;	
        STMES.rec.TYPE_EXEC	        =   DataSet.TYPE_EXEC	;
        STMES.rec.TYPEDEAL	        =   DataSet.TYPEDEAL	;
        STMES.rec.TYPEPRODUCT	    =   DataSet.TYPEPRODUCT;	
        flag=false;
    end;
 
  end;

  if (( not BulkMessage ) and ( not EasyMessage ))
    stat = 1;
  end;

  return stat;   
end;

private macro РАБОТА_С_РЕПОЗИТАРИЕМ()
    const RegPath = "COMMON\\WORK_MODE\\IR_WORK_WITH_DERIVATIVES";
    var workWithRepository = "", err;
    GetRegistryValue( RegPath, V_BOOL, workWithRepository, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( workWithRepository == "X" )
            return true;
        else
            return false;
        end;
    end;
end;

//Формирование записи в репозитарной таблице
private var repozdeal = TRecHandler("dl_repozdeal.dbt");
private macro GetContract(dealid:integer)

    var cmd = DL_RSDCommand();
    var query = "SELECT SPG.T_XLD "
                + " FROM dspgrdoc_dbt spgd, dspground_dbt spg "
                + " WHERE SPG.T_SIGNEDDATE = "
                + " (SELECT MAX (SPG.T_SIGNEDDATE) "
                + " FROM dspgrdoc_dbt spgd, dspground_dbt spg "
                + " WHERE SPG.T_SPGROUNDID = SPGD.T_SPGROUNDID "
                + " AND SPGD.T_SOURCEDOCID = ? "
                + " AND SPG.T_KIND = 26) "
                + " AND SPG.T_SPGROUNDID = SPGD.T_SPGROUNDID "
                + " AND SPG.T_KIND = 26 "
                + " AND SPGD.T_SOURCEDOCID = ? ";
    cmd.AddParam(dealid);  
    cmd.AddParam(dealid);     
    var DataSet = cmd.Execute(query);
    DataSet.moveNext();
    return DataSet.XLD;
    
end; 

PRIVATE MACRO HasInvalidSymbol( Str )

  var stat = 0, i = 1, ch, ValidSymbols = "QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890";

      while( (not stat) and (i <= strlen(Str)) )
        ch = SubStr( Str, i, 1 );
        if( not Index( ValidSymbols, ch ))
          stat = 1; 
        end;
        i = i + 1;
      end;

  return stat;

end;

private macro Вид_Кода_Сделки()
    const RegPath = "РЕПОЗИТАРИЙ\\ВИД КОДА СДЕЛКИ ДЛЯ НОМ. ДОГ.";
    var По_Референсу=1, err;
    
    GetRegistryValue( RegPath, V_INTEGER, По_Референсу, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    end;
    return По_Референсу;
end;

private macro RepozBuff(ndeal:TRecHandler,
                        GA:TRecHandler,
                        BulkMessage:@string,
                        settingValue:integer,
                        EXECTYPE:integer,
                        STMES:TRecHandler)
    private macro GenerateIRDealCode(dCode:@string)

        private macro DV_LZ( num, len:integer ):string
           var RetVal:string = "";
           var str1:string = "", len1:integer = 0;

           str1 = trim(string(num));
           len1 = strlen(str1);
           if( len1 >= len )
              RetVal = str1;
           else
              RetVal = mkstr("0", len-len1) + str1; /* слева */
           end;

           return RetVal;
        end;

        private macro DateToStrDDMMYYYY( pDate:date ):string
          var Day:integer = 0, Month:integer = 0, Year:integer = 0;
          DateSplit(pDate, Day, Month, Year);
          return DV_LZ(Day, 2) + DV_LZ(Month, 2) + DV_LZ(Year, 4);
        end;

        const NRDSimbol = "QWERTYUIOPASDFGHJKLZXCVBNM0123456789";
        var RefNum;
        var i = 0;
        var str = "";
        var ar = StrSplit2(dCode,1);
        while (i < ar.size)
          if (index(NRDSimbol,ar[i])>0 )
            str = str + ar[i];
          end;
        i = i + 1;
        end;
        str =DAteToStrDDMMYYYY({Curdate})+ str;
        if(not GenerateReference(1000012, RefNum))
          str = str + RefNum;
        end;
        dCode = str;
    end;
 
                       
   var cmd = DL_RSDCommand();
    var PTID;
    
    repozdeal.rec.dockind=ndeal.rec.dockind;
    repozdeal.rec.reporting=SET_CHAR;
    repozdeal.rec.docid=ndeal.rec.id;
    repozdeal.rec.date_start=ndeal.rec.date;
    if(GA.rec.GENAGRID>0)
        repozdeal.rec.Reporter_Bank     =   GA.rec.reporter_bank;
        repozdeal.rec.date_end          =   GrDateArray[DLGR_DATEKIND_CLOSEDEAL] ;
        repozdeal.rec.TYPESECUR         =   GA.rec.TYPESECUR;
        repozdeal.rec.FORMSECUR         =   GA.rec.FORMSECUR;
        repozdeal.rec.INITIATOR         =   GA.rec.INITIATOR; //GA.rec.CREATOR_UTI;
        repozdeal.rec.METHOD_WAYTWOWAY  =   GA.rec.METHOD_WAYTWOWAY;
        repozdeal.rec.METHOD_REG        =   GA.rec.METHOD_REG;
        //repozdeal.rec.CONTRACT          =   GA.rec.CODE;
        //repozdeal.rec.CONTRACT_IR       =   GA.rec.NUMREPOZ;
        repozdeal.rec.REPORTER_CONTR    =   GA.rec.REPORTER_CONTR;
        repozdeal.rec.CREATOR_UTI       =   GA.rec.CREATOR_UTI;
        repozdeal.rec.REPOZID_BANK      =   GA.rec.CODE_DEAL;
        repozdeal.rec.TYPE_RECONCILIATION	=   GA.rec.TYPE_sver;
        repozdeal.rec.Creator_UTI	=   GA.rec.Creator_UTI;
        //repozdeal.rec.UTI_contract	=   GA.rec.UTI_Code;
        end;
        GetRegistryValue("РЕПОЗИТАРИЙ\\СРОК ОЖИД.ЗАПР. ПРИ КОМБ.ПОДТВ.", V_INTEGER, repozdeal.rec.RequestTimeout, null);
        
        // РИК Банка
        var BankRIC;
         var cmdRIC = DL_RSDCommand();
            var queryRIC = //" SELECT rsi_rsbparty.PT_GetPartyCode(?, 70) AS RIC FROM DUAL" ;
            "SELECT t_code as RIC"
        +"  FROM (  SELECT OBJ.T_CODE"
        +"            FROM dobjcode_dbt obj"
        +"           WHERE     OBJ.T_OBJECTTYPE = 3"
        +"                 AND OBJ.T_OBJECTID = "+{OurBank}
        +"                 AND OBJ.T_CODEKIND = 70"
        +"                 AND OBJ.T_BANKDATE <="+getsqldate(ndeal.rec.date)
        +"                 AND (   OBJ.T_BANKCLOSEDATE ="
        +"                            TO_DATE ('01.01.0001', 'dd.mm.yyyy')"
        +"                      OR OBJ.T_BANKCLOSEDATE >"+getsqldate(ndeal.rec.date)+")"
        +"        ORDER BY OBJ.T_BANKDATE DESC)"
        +" WHERE ROWNUM = 1";
         
            var DataSetRIC = cmdRIC.Execute(queryRIC);
            if(DataSetRIC.moveNext())
               repozdeal.rec.RepozID_Bank = DataSetRIC.RIC;
            else
               repozdeal.rec.RepozID_Bank = "";
            end;
        //BankRIC = ПолучитьКодСубъекта({OurBank}, PTCK_RIC);
        //repozdeal.rec.RepozID_Bank = BankRIC;
        
        //определяем сообщение
        if ((settingValue==1)and(repozdeal.rec.INITIATOR==2)and(repozdeal.rec.METHOD_WAYTWOWAY==1))
            repozdeal.rec.STATUS_IR     =   11;
        else
            repozdeal.rec.STATUS_IR     =   1;
        end; 
        if(repozdeal.rec.TYPESECUR<=0)
            repozdeal.rec.TYPESECUR     =   4;
        end;
        if(repozdeal.rec.FORMSECUR<=1)
            repozdeal.rec.FORMSECUR     =   3;
        end;
        //var contr=GetContract(ndeal.rec.id);
      
        if (Вид_Кода_Сделки()==2)
            repozdeal.rec.CONTRACT   =   ndeal.rec.EXTCODE;
            if(repozdeal.rec.CONTRACT=="")
              repozdeal.rec.CONTRACT   =   ndeal.rec.code;
            end; 
        elif (Вид_Кода_Сделки()==1)
            repozdeal.rec.CONTRACT   =   ndeal.rec.code;
        elif (Вид_Кода_Сделки()==3)
            repozdeal.rec.CONTRACT   =   "";
        end;
        
        //Определяем LEI код
        var cont;
        var LEI;
        cmd = DL_RSDCommand();
        var query = " SELECT rsi_rsbparty.PT_GetPartyCode(?, 69) AS LEI FROM DUAL" ;
        if(repozdeal.rec.CREATOR_UTI==1)
            cmd.AddParam({OurBank});
            cont=repozdeal.rec.CONTRACT;
        else
            cmd.AddParam(ndeal.rec.CONTRACTOR);
            cont=repozdeal.rec.CONTRACT_CONTR;
        end;
        var DataSet = cmd.Execute(query);
        if (DataSet.moveNext())
          LEI=DataSet.lei;
          if(cont and(valtype(cont)!=26)and (DataSet.lei!=""))
/*DAN*/           GenerateIRDealCode(@cont);
          if (not HasInvalidSymbol(DataSet.lei+cont) )
                  repozdeal.rec.UTI_contract=DataSet.lei+cont; 
          else
              MsgBoxEx("UTI код содержит недопустимые символы",0);
            end;
          end;
        end;
 // Проверка на уникальность UTI
        query ="select 1 from ddl_repozdeal_dbt rd where RD.T_UTI_CONTRACT="+"'"+repozdeal.rec.UTI_contract+"'";
        DataSet = cmd.Execute(query);
        if(DataSet.moveNext())
            repozdeal.rec.UTI_contract="";
            MsgBoxEx("Не удалось сгенерировать уникальный UTI код",0);
        end;

        // Определяем RelCodeID
        query="select t_stdfiid "
                +" from ddvnfi_dbt"
                +" where t_dealid="+ ndeal.rec.id +"AND"
                +" t_type="+DV_NFIType_BaseActiv ;
        DataSet = cmd.Execute(query);
        DataSet.moveNext();
        if((((ndeal.rec.dvkind==dv_option)or(ndeal.rec.dvkind==dv_forward))and
            (DataSet.stdfiid>0))or
            ((ndeal.rec.dvkind==dv_option)and(ndeal.rec.forvard=="X")))
            repozdeal.rec.relcodeid=1;
        else
            repozdeal.rec.relcodeid=2;
        end;
        repozdeal.rec.TYPEPRODUCT=STMES.rec.TYPEPRODUCT;
        repozdeal.rec.TYPEDEAL=STMES.rec.TYPEDEAL;
        repozdeal.rec.messagecode=BulkMessage;
        
        query  =  " SELECT kCode1.T_MAXCODELEN LEI_LEN, kCode2.T_MAXCODELEN RIC_LEN"
            +" FROM DOBJKCODE_DBT kCode1, DOBJKCODE_DBT kCode2"
            +" WHERE KCODE2.T_CODEKIND = 70 AND KCODE1.T_CODEKIND = 69";
        DataSet = cmd.Execute(query);
        if(DataSet.moveNext())  
            if(DataSet.LEI_LEN!=strlen(LEI))
             //   MsgBoxEx("Длина кода LEI должна быть 20 символов",0);
            end;
            if(DataSet.RIC_LEN!=strlen(repozdeal.rec.RepozID_Bank))
                MsgBoxEx("Длина репозитарного идентификационного кода должна быть 12 символов",0);
            end;        
        end;
        
        repozdeal.rec.CodeClassPFI = GetProductCode(repozdeal.rec.TYPEDEAL, repozdeal.rec.TYPEPRODUCT, ndeal, repozdeal.rec.messagecode);
        ArrRepozDeal.Add(repozdeal);
    //end;
    return 0;
end;
/*************/

private var grdeal = TRecHandler("dlgrdeal.dbt");

private macro SetGrDeal(ndeal:TRecHandler, pTemplNum:integer, pPlanDate)
  grdeal.Clear();

  grdeal.rec.DocKind  = ndeal.rec.DocKind;
  grdeal.rec.DocID    = ndeal.rec.ID;
  grdeal.rec.TemplNum = pTemplNum;

  if(ValType(pPlanDate) != V_DATE)
    pPlanDate = date(0,0,0);
    //определить вид даты по шаблону и найти значение в массиве
    if(ValType(TemplDateArr[pTemplNum]) != V_UNDEF)
      pPlanDate = GrDateArray[TemplDateArr[pTemplNum]];
    else
      var templ = TBFile("dlgrtempl.dbt");
      templ.Clear();
      templ.rec.Num = pTemplNum;                        
      if((templ.GetEQ()) and (ValType(GrDateArray[templ.rec.DateKind]) != V_UNDEF))
        pPlanDate = GrDateArray[templ.rec.DateKind];

        TemplDateArr[pTemplNum] = templ.rec.DateKind; //кешируем вид даты для шаблона
      end;
    end;
  end;

  grdeal.rec.PlanDate = pPlanDate;
  grdeal.rec.PlanTime = ndeal.rec.Time;
  grdeal.rec.FIID     = -1;
  if(pTemplNum == 88)   // восстановление из ir_grdoc, левый TemplNum            
      grdeal.rec.TemplNum = DLGR_TEMPL_MAKEDEAL; // возвращаем нормальный TemplNum
      // при восстановлении записываем grdeal сразу, используя номер записи для dlgrdoc
      var DealID;   // номер записи - сюда
      var Op_ID;    // ID операции подготовки сообщения
      var query = "INSERT INTO ddlgrdeal_dbt (T_DocKind, T_DocID, t_TemplNum, t_PlanDate, t_PlanTime, t_FIID) VALUES (" + grdeal.rec.DocKind +
          ", " + grdeal.rec.DocID + ", " + grdeal.rec.TemplNum + ", TO_DATE('"+ grdeal.rec.PlanDate + "'), TO_DATE('01-01-0001 " + grdeal.rec.PlanTime +
          "', 'DD-MM-YYYY:HH24:MI:SS')" + ", -1) RETURNING t_ID INTO :DealID";
      var cmd = RSDCommand(query);      
      cmd.addParam("DealID", RSDBP_OUT, V_INTEGER);
      cmd.execute();
      DealID = cmd.value("DealID");

      var doc = TBFile("dlgrdoc", "W");
      query = "SELECT T_DocID, T_DocKind, T_ServDocID, T_ServDocKind FROM dir_grdoc_dbt WHERE T_DealKind = 199 AND T_DealID = ?"; 
      var cmd2 = DL_RSDCommand(query);                                                     //  199 = DL_DVNDEAL - Внебиржевая операции с ПИ
      cmd2.AddParam(ndeal.rec.ID);
      var DataSet = cmd2.Execute();
      while (DataSet.MoveNext())     
          doc.rec.ID = 0;
          doc.rec.GrDealID = DealID;
          doc.rec.DocID = DataSet.DocID;
          doc.rec.DocKind = DataSet.DocKind;
          doc.rec.ServDocID = DataSet.ServDocID;
          doc.rec.ServDocKind = DataSet.ServDocKind;
          doc.Insert();              
          if(DataSet.ServDocKind == REPOS_SERVICEOPERATION)        // 4851
              Op_ID = DataSet.ServDocID;
          end;
      end;
          
      // меняем статус в графике на "выполнено"
      SQL_Execute("UPDATE ddlgracc_dbt set T_State=" + DLGRACC_STATE_FACTEXEC + ", T_FactDate=(SELECT T_Date FROM dir_op_dbt WHERE T_ID=" + Op_ID +
          ") , T_ID_Operation=" + Op_ID +" WHERE T_GrDealID=" + DealID + "AND T_AccNum=" + DLGR_ACCKIND_REPOSITORY);
      // убираем старые связи
      SQL_Execute("DELETE FROM dir_grdoc_dbt WHERE t_DealID=" + ndeal.rec.ID);
  else
  ArrGrDeal.Add(grdeal);
end;
end;

private macro SetCategory(Tick, ObjGroup:integer, AttrID:integer, CatDate:date, ErrorMsg:@string)
  var stat:integer = 0;
 
  if( ( not DisconnectObjAttr(OBJTYPE_OUTOPER_DV,  UniID( Tick, OBJTYPE_OUTOPER_DV), ObjGroup) ) OR
      ( not ConnectObjAttr(stat, OBJTYPE_OUTOPER_DV, UniID( Tick, OBJTYPE_OUTOPER_DV), ObjGroup, AttrID, null, null, CatDate) ) OR
      ( stat != 0 )
    )
     ErrorMsg = "Ошибка при установке категории. " + GetErrMsg();
  end;
 
  return stat;
end;

private macro DV_GetPayPlanDate(DealID)
  var  PayDate = date(0, 0, 0);
  var cmd = DL_RSDCommand(),
      query = " SELECT T_PAYDATE " +
              "   FROM DDVNFI_DBT " +
              " WHERE T_DEALID = ? ";
  
  cmd.AddParam(DealID);
  
  var DataSet = cmd.Execute(query);
  if( DataSet.moveNext() )
    PayDate = date(DataSet.PayDate); 
  end;
  return PayDate;
end;

private macro DV_GetDeliveryPlanDate(DealID)
  var  SuplDate = date(0, 0, 0);
  var cmd = DL_RSDCommand(),
      query = " SELECT T_SUPLDATE " +
              "   FROM DDVNFI_DBT " +
              " WHERE T_DEALID = ? order by t_supldate desc"; 
 /*DAN  А если поставок несколько, необходимо выбирать максимальную дату*/
  
  cmd.AddParam(DealID);
  
  var DataSet = cmd.Execute(query);
  if(DataSet.moveNext())
    SuplDate = date(DataSet.SuplDate);
  end;
  return SuplDate;
end;

private macro DV_GetExecDate(DealID)
  var ExecDate = date(0, 0, 0);
  var cmd = DL_RSDCommand(),
      query = " SELECT T_EXECDATE " +
              "   FROM DDVNFI_DBT " +
              " WHERE T_DEALID = ? ";
  
  cmd.AddParam(DealID);
  
  var DataSet = cmd.Execute(query);
  if( DataSet.moveNext() )
    ExecDate = date(DataSet.ExecDate); 
  end;
  return ExecDate;
end;


private macro isPendingRequestDeal(GA:TRecHandler)
  return ( GA.rec.INITIATOR == 2 ) and ( GA.rec.METHOD_WAYTWOWAY == 1 );
end;

private macro getGrPlanDate(pTemplNum, pendingDay)
  var planDate = date(0, 0, 0);
  if(ValType(TemplDateArr[pTemplNum]) == V_UNDEF)
    var templ = TBFile("dlgrtempl.dbt");
    templ.rec.Num = pTemplNum;                        
    if((templ.GetEQ()) and (ValType(GrDateArray[templ.rec.DateKind]) != V_UNDEF))
      planDate = GrDateArray[templ.rec.DateKind];
      TemplDateArr[pTemplNum] = templ.rec.DateKind; //кешируем вид даты для шаблона
    end;
  end;
  
  if ((ValType(pendingDay) == V_INTEGER) and (pendingDay > 0))
        planDate = GetDateAfterWorkDays(date(planDate), pendingDay);
  end;

  return planDate;
end;

macro SetAllGrDealDV(ndeal:TRecHandler, GA:TRecHandler)
    GrDateArray.size = 0;
    //1. Дата заключения
    GrDateArray[DLGR_DATEKIND_DELADATE]  = ndeal.rec.Date;
    //2. Дата поставки
    GrDateArray[DLGR_DATEKIND_DELIVERY]  = DV_GetDeliveryPlanDate(ndeal.rec.ID);
    //3. Дата оплаты
    GrDateArray[DLGR_DATEKIND_PAYMENT]   = DV_GetPayPlanDate(ndeal.rec.ID);
    //14. Дата закрытия сделки
    GrDateArray[DLGR_DATEKIND_CLOSEDEAL] = date(max(GrDateArray[DLGR_DATEKIND_PAYMENT], GrDateArray[DLGR_DATEKIND_DELIVERY]));
    
    if( (ndeal.rec.DVKIND == DV_CURSWAP) or (ndeal.rec.DVKIND == DV_PCTSWAP) )
        var rcmd = RsdCommand(
            "SELECT T_PayDate, T_SuplDate FROM ddvnfi_dbt "
            " WHERE T_DealID = ? and T_Type = 2");
        rcmd.addParam("", RSDBP_IN, ndeal.rec.ID);
        rcmd.execute();
        var rsd = TRsbDataSet(rcmd);
        if( rsd.MoveNext() )
            GrDateArray[DLGR_DATEKIND_CLOSEDEAL] = date(max(rsd.rec.PayDate, rsd.rec.SuplDate));
        end;
    end;
 
    if(GrDateArray[DLGR_DATEKIND_CLOSEDEAL] == date(0, 0, 0))
       GrDateArray[DLGR_DATEKIND_CLOSEDEAL] = DV_GetExecDate(ndeal.rec.ID);
    end;

    var STMES = TRecHandler("ir_setupmessage.dbt");
    var BulkMessage = null, EasyMessage = null;
    var cmd = DL_RSDCommand();

    var query = " SELECT  nfi.T_EXECTYPE, FI.T_FI_KIND, "
              + " RSI_RSB_FIInstr.FI_AvrKindsGetRoot(fi.T_FI_KIND, fi.T_AVOIRKIND) AS T_AVOIRKIND "
              + "   FROM ddvnfi_dbt nfi, dfininstr_dbt fi "
              + "   WHERE nfi.T_DealID = ? "
              + "   and FI.T_FIID = NFI.T_FIID ";

    cmd.AddParam(ndeal.rec.ID);
    var DataSet = cmd.Execute(query);
    DataSet.moveNext();   

  if( (not getMessages(ndeal, DataSet.FI_Kind, DataSet.AvoirKind, DataSet.ExecType, @BulkMessage, @EasyMessage, @STMES)) 
      and РАБОТА_С_РЕПОЗИТАРИЕМ() )
    var settingValue = -1;
    GetRegistryValue("РЕПОЗИТАРИЙ\\БАЗА ФОРМ. СООБЩ. В РЕПОЗИТАРИЙ", V_INTEGER, settingValue, null);
      if( ( settingValue == 1 )  or 
         (( settingValue == 0 ) and ( ndeal.rec.Client > 0 )) or
         (( settingValue == 2 ) and ( ndeal.rec.Client == -1 )) 
        )
      //SetCategory(ndeal, OBJGROUP_REPOSREPORTING, OBJATTR_REPOSREPORTING_YES, null);
      var irdoc = TBFile("ir_grdoc");
      irdoc.rec.DealID = ndeal.rec.ID;
      irdoc.rec.DealKind = 199;
      var isInitRecurring = irdoc.getEQ;
                
      if( EasyMessage )
/*DAN*/  if(GA.rec.Reporting == set_char) //Доп условие
            var requestTimeout = 0;
            GetRegistryValue("РЕПОЗИТАРИЙ\\СРОК ОЖИД.ЗАПР. ПРИ КОМБ.ПОДТВ.", V_INTEGER, requestTimeout, null);
                var TradeDate:Date = {curdate};
                //var IntMesID = 0;
                if( isInitRecurring )
                    var cmd2 = DL_RSDCommand();
                    var query2 = " SELECT geninf.t_internalmessageid, geninf.t_TradeDate FROM dir_grdoc_dbt ir_grdoc, dir_generalinf_dbt geninf "
                            + " WHERE ir_grdoc.t_ServDocKind = " + 4852     /*REPOS_MESSAGEGENERATION*/
                            + " AND ir_grdoc.t_DealKind = " + ndeal.rec.DocKind
                            + " AND ir_grdoc.t_DealID =  " + ndeal.rec.ID
                            + " AND ir_grdoc.t_DocKind = " + 4853           /*REPOS_GENERALINF*/
                            + " AND geninf.t_internalmessageid = ir_grdoc.t_DocId ";
                    var data = cmd2.Execute(query2);
                    if(data.MoveNext())
                        TradeDate = data.TradeDate;
                        //IntMesID = data.internalmessageid;
                    end;
                end;
            if( isPendingRequestDeal(GA) and ( requestTimeout > 0 ) )
              if( isInitRecurring )
                        SetGrDeal(ndeal, 88, TradeDate);  //  восстанавливаем, используем левый TemplNum для обозначения восстановления
                SetGrDeal(ndeal, DLGR_TEMPL_MAKEDEAL_CORRECTION, {curdate});
              else
                SetGrDeal(ndeal, DLGR_TEMPL_MAKEDEALWTHREQUEST, getGrPlanDate(DLGR_TEMPL_MAKEDEALWTHREQUEST, requestTimeout));
              end;
              if(ndeal.rec.AutoClose == UNSET_CHAR)
                if (not isSetNetting(ndeal.rec.ID))  /*dan при наличии на сделке признака неттинга планируем график "Прекращение обязательств неттингом c ож. запроса"*/
                  SetGrDeal(ndeal, DLGR_TEMPL_CLOSECONTRWTHREQUEST, getGrPlanDate(DLGR_TEMPL_CLOSECONTRWTHREQUEST, requestTimeout));  
                else
                  SetGrDeal(ndeal, DLGR_TEMPL_NETTINGSUSPWTHREQUEST, getGrPlanDate(DLGR_TEMPL_CLOSECONTRWTHREQUEST, requestTimeout));  
                end;
              end;
            else
              if( isInitRecurring )
                        SetGrDeal(ndeal, 88, TradeDate);  //  восстанавливаем, используем левый TemplNum для обозначения восстановления
                SetGrDeal(ndeal, DLGR_TEMPL_MAKEDEAL_CORRECTION, {curdate});
              else
                SetGrDeal(ndeal, DLGR_TEMPL_MAKEDEAL);
              end;
              if(ndeal.rec.AutoClose == UNSET_CHAR)
                if (not isSetNetting(ndeal.rec.ID))   /*dan при наличии на сделке признака неттинга планируем график "Прекращение обязательств неттингом"*/
                  SetGrDeal(ndeal, DLGR_TEMPL_CLOSECONTR);
                else
                  SetGrDeal(ndeal, DLGR_TEMPL_NETTINGSUSP, getGrPlanDate(DLGR_TEMPL_CLOSECONTR));
                end;
              end;
            end;
              RepozBuff(ndeal,GA,EasyMessage,settingValue,DataSet.EXECTYPE,STMES);          
            end;
/*DAN*/  end;
      end;       
    end;
end;

/*Процедура создания графика по сделке в транзакции начала операции*/
macro InsertAllGrDealDV()
  ArrGrDeal.Insert();
  ArrRepozDeal.Insert();
end;

private macro GetLastDayInMonth( CurDate:Date )
    var day, mon, year;

    DateSplit(CurDate,day,mon,year);
    if( mon == 12 )
      return Date(1,1,year+1) - 1;
    else
      return Date(1,mon+1,year) - 1;
    end;
end;

private macro GetLastWorkDayInMonth( CurDate:Date )
   var LastWorkDate;

   LastWorkDate = GetLastDayInMonth(CurDate);
   if( not IsWorkDay(LastWorkDate))
     LastWorkDate = GetDateAfterWorkDays(LastWorkDate,-1);
   end;
   return LastWorkDate;
end;

macro GetSettingMessageSendingMode()
  var messageSendingMode = 0;

  GetRegistryValue("РЕПОЗИТАРИЙ\\ОТПРАВКА СООБЩЕНИЯ СМ094", V_INTEGER, messageSendingMode, null);

  return messageSendingMode;
end;

macro InsertGrDealFairValueRevaluation(FD, ДатаИсполненияШага, DocKind)
  var repozdeal = TBFile("dl_repozdeal.dbt", "R", 1);
  var planDate;
  repozdeal.Clear();
  repozdeal.rec.DocKind = DocKind;
  repozdeal.rec.DocID   = FD.deal.rec.ID;
  
  if( GetEQ(repozdeal) )
    if(repozdeal.rec.reporting == UNSET_CHAR)  //если флаг репортинг в репозитарий не установлен
      return 0;
    end;
  else 
    return 0;
  end;

  var messageSendingMode = 0;

  GetRegistryValue("РЕПОЗИТАРИЙ\\ОТПРАВКА СООБЩЕНИЯ СМ094", V_INTEGER, messageSendingMode, null);
  if(messageSendingMode == 1)//1-при каждой переоценке
    planDate = ДатаИсполненияШага;
  elif(messageSendingMode == 3)//3-по окончании месяца по последней переоценке
    if((FD.Deal.rec.State == DVDEAL_CLOSE) or (repozdeal.rec.date_end <= ДатаИсполненияШага))
      return 0;
    end;

    if(ДатаИсполненияШага == GetLastWorkDayInMonth(ДатаИсполненияШага))
      planDate = GetLastDayInMonth(ДатаИсполненияШага);
    elif((ДатаИсполненияШага == GetLastDayInMonth(ДатаИсполненияШага)) and not IsWorkDay(ДатаИсполненияШага) and IsWorkDay(ДатаИсполненияШага - 1) )
      planDate = GetLastDayInMonth(ДатаИсполненияШага);
    elif((ДатаИсполненияШага != GetLastDayInMonth(ДатаИсполненияШага)) and (ДатаИсполненияШага == (GetLastWorkDayInMonth(ДатаИсполненияШага) + 1)) and not IsWorkDay(ДатаИсполненияШага) )
      planDate = GetLastDayInMonth(ДатаИсполненияШага);
    else 
      return 0;
    end;
  else//2-по окончании месяца
    planDate = GetLastDayInMonth(ДатаИсполненияШага);
  end;
  if (not FairValueGrExist(FD.deal.rec.ID, planDate, DLGR_TEMPL_REVALUATION_FAIRVALUE)) // DAN: Графика на дату еще нет
    if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID, DLGR_TEMPL_REVALUATION_FAIRVALUE, planDate, time(0,0,0), -1) != 0 )
      return 1;
    end;
  end;

  return 0;
end;
