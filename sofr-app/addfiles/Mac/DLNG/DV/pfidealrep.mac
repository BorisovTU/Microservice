/*
$Name:             pfidealrep.mac
$Module:           Производные инструменты
$Description:      Отчет "Реестр внутреннего учета сделок ПФИ"
*/
import "dvrepfun.mac";
import "dvRepFun2.mac";
import RsbDataSet;
import "or_rep_h.mac";
import "RegistrReport.mac";

private var FinInstr = TBFile( "fininstr.dbt","R", 0 );    /*финансовый инструмент*/

private const UNDF = -1;
private const ALL = "Все";

private const POI_MODE = true;

private var File_DVDeal;
private var IsDprtSort;
private var DVQuery, RsdDVQuery;
private var File_DVDeal_NRec:integer = 0;

/* Структура с исходными данными */
class SourceData( _DprtID:integer,
                  _ByDV:bool,
                  _ByDV_Der:bool,
                  _ByDV_Cur:bool,
                  _ByBO:bool,
                   _IsClientDeals:bool,
                   _IsOurDeals:bool,
                  _BaseFIKind:integer,
                  _BaseFIID:integer,
                  _DVFIKindID:integer,
                  _EmiID:integer, 
                  _DVFIID:integer,
                  _ClientID:integer, 
                  _IsMarket:bool,
                  _ContractorID:integer,
                  _IsOutMarket:bool,
                  _dateMin:date, _dateMax:date,
                  _IsSeparatelyDate:bool,
                  _DealStatus:integer,
                  _IsApp:bool,
                  _IsExcel:bool ) 

   var 
       DprtID            = _DprtID,
       ByDV              = _ByDV,
       ByDV_Der          = _ByDV_Der,
       ByDV_Cur          = _ByDV_Cur,
       ByBO              = _ByBO,
       IsClientDeals     = _IsClientDeals,
       IsOurDeals        = _IsOurDeals,
       BaseFIKind        = _BaseFIKind,
       BaseFIID          = _BaseFIID,        
       DVFIKindID        = _DVFIKindID,      
       EmiID             = _EmiID,           
       DVFIID            = _DVFIID,       
       ClientID          = _ClientID,        
       IsMarket          = _IsMarket,        
       ContractorID      = _ContractorID,    
       IsOutMarket       = _IsOutMarket,     
       dateMin           = _dateMin,         
       dateMax           = _dateMax,         
       IsSeparatelyDate  = _IsSeparatelyDate,
       DealStatus        = _DealStatus,      
       IsApp             = _IsApp,           
       IsExcel           = _IsExcel,
       CCA_NatCUR = DL_GetISOCurr(643);
end;
/*
var str = "┌──────────┬───────────────────┬───────────────────┬──────────────────┬──────────────────┬─────────────────┬────────────────────┬──────────┬─────────┬───────────────┬────────────────────┬────────────────┬──────────────┬─────────────┬──────────────────┬─────────────────┬───────────────┬─────────────────┬────────┬───────────────┬──────────┬────────────────┬─────────────────┬──────────┬─────────────────┬────────┬──────────────────────┐\n"+
          "│          │                   │                   │ Место заключения │    Биржевой №    │   Направление   │                    │          │   №     │    Дата       │    № предложения   │ № Генерального │              │     Вид     │                  │  Тип исполнения │    Способ     │ Цена исполнения │ Валюта │               │  Валюта  │    Кол-во      │ Кол-во базового │ Валюта   │    Стоимость    │ Валюта │    Исп. внебирж.     │\n"+
          "│ № сделки │       Дата        │       Время       │      сделки      │      сделки      │ сделки/операции │       Клиент       │Контрагент│поручения│   принятия    │      (заявки)      │  соглашения    │  № договора  │  контракта  │     Контракт     │                 │    расчетов   │     опциона     │  цены  │  Цена сделки  │   цены   │   контрактов   │     актива      │ единицы  │ базового актива │  цены  │                      │\n"+
          "│          │                   │                   │                  │                  │                 │                    │          │         │  поручения    │                    │                │              │             │                  │                 │               │                 │        │               │  сделки  │                │                 │ базового │                 │базового│                      │\n"+
          "│          │                   │                   │                  │                  │                 │                    │          │         │               │                    │                │              │             │                  │                 │               │                 │        │               │          │                │                 │ актива   │                 │ актива │                      │\n"+
          "├──────────┼───────────────────┼───────────────────┼──────────────────┼──────────────────┼─────────────────┼────────────────────┼──────────┼─────────┼───────────────┼────────────────────┼────────────────┼──────────────┼─────────────┼──────────────────┼─────────────────┼───────────────┼─────────────────┼────────┼───────────────┼──────────┼────────────────┼─────────────────┼──────────┼─────────────────┼────────┼───────────┬──────────┤";
*/
var str = "┌──────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┬──────────────────────────────────────┬───────────────┬─────────────────────┬────────────────────┬────────────┬───────────────────────────┬────────────────────────┬────────────┬───────────────────┬───────────────────┬──────────────┬─────────┬──────────┬────────────────────────────┬──────────────────────────────┬───────────────┬──────────────┬───────────────────┬────────────┬──────────┬──────────────────────────────────┬─────────────────┬─────────────┬──────────────────┬──────────────────┬───────────┬───────────────────┬─────────────────────┬───────────────┬────────┬────────────────────┬───────────────────┬────────────────────┬────────┬──────────────────────────────┬──────────────────────────────┬────────────────┐\n"+
          "│  Номер   │  Дата заключения │ Время заключения │ Место совершения │ Номер соглашения │ Наименование / уникальный код (номер)│    Данные     │ Данные доверенности │      Сторона 1     │ Стронона 2 │      Клиент стороны 2     │     Комиссия брокера   │ Тип сделки │ Номер Поручения / │     Вид сделки    │ Вид договора │ Вид ПФИ │ Базисный │ Наименование (обозначение) │  Цена фьючерсного контракта  │ Размер премии │ Сумма сделки │ Валюта котировки, │   Кол-во   │  Валюта  │  Номер/ дата отчета перед банком │ Клиент является │ Гражданство │ Клиент является/ │ Клиент является/ │ Категория │  Порядок и способ │ Качество, в котором │ Дата принятия │  ПФИ/  │ Право ипользование │ Остаток денежных  │ Плановый исходящий │ Валюта │         Обязательства        │          Требования          │    Наличие     │\n"+
          "│ срочной  │   срочной сделки │  срочной сделки  │  срочной сделки  │    с клиентом    │              клиента                 │ представителе │  на уполномоченного │                    │            │                           │ (обязательства клиента │            │ Номер договора с  │ (покупка-продажа) │              │         │  актив   │  фьючерсного контракта     │ (цена исполнения по опциону) │   по опциону  │  по опциону  │ премии по опциону │ фьючерсных │ расчетов │                                  │    ФЛ/ЮЛ/ИП     │  клиента    │   не является    │   не является    │  клиента  │     исполнения    │   действует банк    │   поручения   │ не ПФИ │  денежных средств  │ средств на счете  │  остаток денежных  │        ├───────────────────┬──────────┼───────────────────┬──────────┤ подтверждающих │\n"+
          "│  сделки  │                  │                  │                  │                  │                                      │   о клиента   │                     │                    │            │                           │     перед Банком)      │            │     клиентом      │                   │              │         │   ПФИ    │        / опциона           │                              │               │              │                   │ контрактов,│          │                                  │                 │             │    налоговым     │квалифицированным │           │    обязательств   │                     │     Биржей    │        │       Клиента      │ внутреннего учета │  средств на счете  │        │ денежные средства │ контракт │ денежные средства │ контракт │   документов   │\n"+
          "│          │                  │                  │                  │                  │                                      │               │                     │                    │            │                           │                        │            │                   │                   │              │         │          │                            │                              │               │              │                   │  опционов  │          │                                  │                 │             │                  │    резидентом    │           │                   │                     │               │        │                    │                   │  внутреннего учета │        │                   │          │                   │          │                │\n"+
          "├──────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────┼──────────────────────────────────────┼───────────────┼─────────────────────┼────────────────────┼────────────┼───────────────────────────┼────────────────────────┼────────────┼───────────────────┼───────────────────┼──────────────┼─────────┼──────────┼────────────────────────────┼──────────────────────────────┼───────────────┼──────────────┼───────────────────┼────────────┼──────────┼──────────────────────────────────┼─────────────────┼─────────────┼──────────────────┼──────────────────┼───────────┼───────────────────┼─────────────────────┼───────────────┼────────┼────────────────────┼───────────────────┼────────────────────┼────────┼───────────────────┼──────────┼───────────────────┼──────────┼────────────────┤";
var Rep = CMakeReport(str);

private macro ЭтоВстроенныйПФИ(ID)
   var Select = " SELECT avr.T_ISIN " +
                        "  FROM davoiriss_dbt avr " +
                        "  WHERE LPAD (avr.t_fiid, 10, 0) IN (SELECT t_AttrID " +
                        "                                       FROM dobjlink_dbt "
                        "                                      WHERE     t_ObjectType = " + string(OBJTYPE_OUTOPER_DV) +
                        "                                            AND t_ObjectID = LPAD("+ string(ID)  +", 34, 0) "  +
                        "                                            AND t_AttrType = " +string(OBJTYPE_AVOIRISS) +
                        "                                            AND t_GroupID = 2)";



   var RS = TRsbDataSet( Select ) ;
   if( RS.MoveNext() )
      return " Встроенный ПФИ для облигации " + RS.ISIN;
   end;
   return "";

end;

MACRO НачальникОтдела()
     var RS = TRsbDataSet("SELECT party.t_Name " +
                          "  FROM dofficer_dbt officer, dparty_dbt party " +
                          " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                          "       officer.t_OfficeID = " + string(SelfDivision) + " AND " +
                          "       officer.t_IsFirstOfficePerson = 'X' AND "
                          "       party.t_PartyID = officer.t_PersonID "
                         );

     if( RS.MoveNext() )
        return RS.Name;
     end;
     return "";
END;

MACRO Операционист()
    var RS = TRsbDataSet("SELECT person.t_Name " +
                         "  FROM dperson_dbt person " +
                         " WHERE person.t_Oper = " + string({oper})
                        );

    if( RS.MoveNext() )
       return RS.Name;
    end;
    return "";
END;

MACRO ДолжностьОперациониста()
    return "Исполнитель";
    var RS = TRsbDataSet("SELECT officer.t_Post " +
                         "  FROM dofficer_dbt officer, dperson_dbt person " +
                         " WHERE officer.t_PartyID  = " + string({OurBank}) + " AND " +
                         "       person.t_Oper = " + string({oper}) + " AND " +
                         "       officer.t_PersonID = person.t_PartyID "
                        );

    if( RS.MoveNext() )
       return RS.Post;
    end;
    return "Ответственный сотрудник";
END;

macro OptionType( type )
   if( type == 0 )
       return " ";
   elif( type == 1 )
       return "Put";
   else
       return "Call";
   end;
end;

private macro OptionStyle( type )
   if( type == 0 )
       return " ";
   elif( type == 1 )
       return "American";
   else
       return "European";
   end;
end;

private MACRO fixdate(par);
  var s = trim(string(par));
  if (strlen(s)<10)
    s = "0" + s;
  end;
  return s;
end;

private macro IsNetting( DocKind:integer, DocumentID:integer )
  var RetVal:bool = false;
  var sql = RSDCommand( " select t_purpose " +
                        "   from dpmpaym_dbt " +
                        "  where t_dockind    = ? " +
                        "    and t_documentid = ? " +
                        "    and t_paymstatus = ? " +
                        "    and t_netting    = chr(88) "
                      );
  sql.addParam("", RSDBP_IN, DocKind);
  sql.addParam("", RSDBP_IN, DocumentID);
  sql.addParam("", RSDBP_IN, PM_CLOSED_W_M_MOVEMENT);
  sql.execute();
  var DataSet = TRsbDataSet(sql);
  if( DataSet.MoveNext() )
     RetVal = true;
  end;

  return RetVal;
end;

PRIVATE CLASS (DL_CReportTemplate) PFIDeals_Report(TemplName, _DprtID:integer,
                                                              _ByDV:bool,
                                                              _ByDV_Der:bool,
                                                              _ByDV_Cur:bool,
                                                              _ByBO:bool,
                                                              _isOurDeals:bool,
                                                              _IsClientDeals:bool,
                                                              _ClientID:integer,
                                                              _IsForm:integer,
                                                              _FormSub:integer,
                                                              _IsVid:integer,
                                                              _VidSub:integer,
                                                              _CharFlag_7:bool,
                                                              _IsMarket:bool,
                                                              _ContractorID:integer,
                                                              _IsOutMarket:bool,
                                                              _BaseFIKind:integer,
                                                              _BaseFIID:integer,
                                                              _DVFIKindID:integer,
                                                              _EmiID:integer,
                                                              _DVFIID:integer,
                                                              _dateMin:date, _dateMax:date,
                                                              _IsSeparatelyDate:bool,
                                                              _DealStatus:integer,
                                                              _IsApp:bool,
                                                              _IsExcel:bool)
                  
    VAR NeedBreak = false;
    VAR IsMarketDeals = true;
    VAR DepartmentName = "";
    VAR m_RegisterTable = false;

    VAR DprtID          = _DprtID,
        byDV            = _ByDV,
        ByDV_Der        = _ByDV_Der,
        ByDV_Cur        = _ByDV_Cur,
        byBO            = _ByBO,
        isOurDeals      = _isOurDeals,
        IsClientDeals   = _IsClientDeals,
        ClientID        = _ClientID,
        IsForm          = _IsForm,
        FormSub         = _FormSub,
        IsVid           = _IsVid,
        VidSub          = _VidSub,
        CharFlag_7      = _CharFlag_7,
        IsMarket        = _IsMarket,
        ContractorID    = _ContractorID,
        IsOutMarket     = _IsOutMarket,
        BaseFIKind      = _BaseFIKind,
        BaseFIID        = _BaseFIID,
        DVFIKindID      = _DVFIKindID,
        EmiID           = _EmiID,
        DVFIID          = _DVFIID,
        dateMin = _dateMin, dateMax = _dateMax,
        IsSeparatelyDate    = _IsSeparatelyDate,
        DealStatus          = _DealStatus,
        IsApp               = _IsApp,
        IsExcel             = _IsExcel;

    MACRO PrintMode():INTEGER
       if( IsExcel and IsApp )
          return DL_OUTREPORT_EXCEL;
       elif( IsExcel and (not IsApp ) )
          return DL_OUTREPORT_EXCEL_NO_FORMAT;
       else
          return DL_OUTREPORT_STD;
       end;
    END;
    
    MACRO CReport_DataExist()
        return true;//not NeedBreak;
    end;

    PRIVATE MACRO BeginReport(NumCopy:integer)
       CreateTotalBook();
       SetUseApp(IsApp);
    end;

    PRIVATE MACRO EndReport()
        SaveTotalBook();
    end;

    MACRO EndReportTab()
       if( m_RegisterTable )
           EndTable();
           CopyAllSheetInTotalBook( "<H11>", false, GetTableRange(), "A"+(GetLastPosition(DepartmentName)+2), DepartmentName, false );
           m_RegisterTable = false;
       end;
    END;

    PRIVATE MACRO PrintReportHead(Data, CurDate)
        var BaseFIKindName = "", BaseFI = "";
        var DVFIKind = "", DVIssuer = "", DVFI = "", SfContr = "";
        var Client = "";

        if( (CurDate != NULL) and (CurDate != date(0, 0, 0)) )
            PrintFormatString("                           Реестр внутреннего учета сделок ПФИ\n" +
                              " Отчетный период # - #", "N1_H1_1", fixdate(CurDate),
                                                        "N1_H1_2", fixdate(CurDate));
        else
            PrintFormatString("                           Реестр внутреннего учета сделок ПФИ\n" +
                              " Отчетный период # - #", "N1_H1_1", fixdate(Data.dateMin),
                                                        "N1_H1_2", fixdate(Data.dateMax));
        end;
/*GAA: 495962  В шаблоне отчета (Report_PFIDEALSvu15.xls) на 21.11.2019 данные поля отсутствуют, поэтому при выполнении PrintFormatString под отладкой ошибки.
В связи с этим данный блок отключен.      
        if( Data.BaseFIKind )
            if( Data.BaseFIKind != UNDF ) 
            BaseFIKindName = GetFIKind( Data.BaseFIKind );
            else 
                BaseFIKindName = ALL;
            end;
        end;
        PrintFormatString("Вид базового актива: #", "N1_H3", BaseFIKindName);

        if( Data.BaseFIID )
           if( Data.BaseFIID != UNDF )
            FinInstr.Clear();
            FinInstr.rec.FIID = Data.BaseFIID;
            if( not FinInstr.GetEQ() ) 
               MsgBox( "Ошибка при определении производного инструмента|(FIID = ", Data.BaseFIID, ")");
            end;
            if( FinInstr.rec.AvoirKind != 0 )
                BaseFI = GetAvoirKind( FinInstr.rec.FI_Kind, FinInstr.rec.AvoirKind ) +" "+ FinInstr.rec.FI_Code;
            else
                BaseFI = FinInstr.rec.FI_Code;
            end;
           else
               BaseFI = ALL; 
           end;
        end;
        PrintFormatString("Исходный актив: #", "N1_H4", BaseFI);

        if( Data.DVFIKindID )
           if ( Data.DVFIKindID == 0 )
              DVFIKind = GetAvoirKind( FIKIND_DERIVATIVE, DERIVATIVE_FUTURES );
           elif ( Data.DVFIKindID == 1 )
              DVFIKind = GetAvoirKind( FIKIND_DERIVATIVE, DERIVATIVE_OPTION );
           elif ( Data.DVFIKindID == 2 )
              DVFIKind = GetAvoirKind( FIKIND_DERIVATIVE, DERIVATIVE_FORWARD );
           elif ( Data.DVFIKindID == UNDF )
              DVFIKind = ALL;
           else
              DVFIKind = "";
           end;
        end;
        PrintFormatString("Вид контракта: #", "N1_H5", DVFIKind);

        if( Data.EmiID )
           if( Data.EmiID != UNDF )
            DVIssuer = GetParty( Data.EmiID );
           else
              DVIssuer = ALL;
           end;
        end;
        PrintFormatString("Эмитент: #", "N1_H6", DVIssuer);

        if( Data.DVFIID )
            if( Data.DVFIID != UNDF ) 
            FinInstr.Clear();
            FinInstr.rec.FIID = Data.DVFIID;
            if( not FinInstr.GetEQ() ) 
               MsgBox( "Ошибка при определении производного инструмента|(FIID = ", Data.BaseFIID, ")");
            end;
            DVFI = FinInstr.rec.FI_Code;
            else
               DVFI = ALL;
            end;
        end;
        PrintFormatString("Контракт: #", "N1_H7", DVFI);

        if( Data.ClientID )
            if( Data.ClientID != UNDF )
            Client = GetParty( Data.ClientID );
            else
               Client = ALL;
            end;
        end;
        PrintFormatString("Клиент: #", "N1_H8", Client);

        if( Data.ContractorID )
            if( Data.ContractorID != UNDF ) 
            SfContr = GetParty( Data.ContractorID );
            else               
               SfContr = ALL;   
            end;               
        end;
        PrintFormatString("Контрагент по расчетам: #", "N1_H9", SfContr);
*/
        CopyAllSheetInTotalBook("<H11>", false, "N1_HEADER", 0, DepartmentName, false);
    end;

    PRIVATE MACRO PrintDealKindHead(IsOutMark:bool)
        
        if(IsOutMark)
            PrintFormatString("#", "N1_H10", "Внебиржевые сделки");
            IsMarketDeals = false;
        else
            PrintFormatString("#", "N1_H10", "Биржевые сделки");
        end;

        CopyAllSheetInTotalBook("<H11>", false, "N1_H10", 0, DepartmentName, false);
    end;

    PRIVATE MACRO ReportRegisterTable(IsOutMark)
       if( not m_RegisterTable )
/*
          RegisterTable( "N1_MainTable", str,
                         "N1_A1",
                         "N1_D1",
                         "N1_T1",
                         "N1_A2",
                         "N1_N_st",
                         "N1_A4",
                         "N1_A5",
                         "N1_A5_1",
                         "N1_A6",
                         "N1_A6.1",
                         "N1_N_z",
                         "N1_N_gs",
                         "N1_A7",
                         "N1_A8",
                         "N1_A9",
                         "N1_T_Isp",
                         "N1_N1",
                         "N1_A10",
                         "N1_N2",
                         "N1_A11",
                         "N1_N3",
                         "N1_N3_1",
                         "N1_N3_2",
                         "N1_N3_3",
                         "N1_N3_4",
                         "N1_A12",
                         "N1_D2" );
*/
  IF((not byDV) or (IsMarket)) /*GAA:495962 Использование одного шаблона для собственных и клиентских сделок*/
          RegisterTable( "N1_MainTableClients", str,

                         "N1_N_st",
                         "N1_D1",
                         "N1_T1",
                         "N1_A2",
                         "N1_A7",
                         "N1_A5",
                         "N1_X1",
                         "N1_X2",
                         "N1_X3",
                         "N1_X4",
                         "N1_X5",
                         "N1_X6",
                         "N1_X7",
                         "N1_X7_1",
                         "N1_X8",
                         "N1_X9",
                         "N1_X10",
                         "N1_A8",
                         "N1_X11",
                         "N1_X12",
                         "N1_X13",
                         "N1_X14",
                         "N1_N1",
                         "N1_A10",
                         "N1_N3",
                         "N1_X15",
                         "N1_X16",
                         "N1_X17",
                         "N1_X18",
                         "N1_X19",
                         "N1_X20",
                         "N1_X21",
                         "N1_X22",
                         "N1_X23",
                         "N1_X24",
                         "N1_X25",
                         "N1_X26",
                         "N1_X27",
                         "N1_X28",
                         "N1_X29",
                         "N1_X30",
                         "N1_X31",
                         "N1_X32",
                         "N1_X33",
                         "N1_X34"
                                 );

  ELSE
          RegisterTable( "N1_MainTableOur", str,
                         "N_st_2","N1_Y1","N1_Y2","N1_Y3","N1_Y4","N1_Y5","N1_Y6","N1_D1_2","N1_T1_2","N1_Y7","N1_Y8","N1_X10_2","N1_A8_2","N1_X11_2","N1_Y9","N1_A2_2","N1_X13_2","N1_Y10","N1_X32_2","N1_Y11","N1_X30_2","N1_Y12","N1_Y13","N1_Y14","N1_Y15","N1_Y16","N1_Y17","N1_Y18","N1_Y19","N1_Y20","N1_Y21","N1_Y22","N1_Y23","N1_Y24","N1_Y25","N1_Y26","N1_Y27","N1_Y28","N1_Y29","N1_Y30","N1_Y31");
  end;
          m_RegisterTable = true;
       end;
    END;

    PRIVATE MACRO PrintTableHeaderWithDepartment(IsOutMark)
       PrintFormatString("Филиал: #", "N1_H11", DepartmentName);
      /*GAA:495962 Использование одного шаблона для собственных и клиентских сделок*/
       CopyAllSheetInTotalBook("<H11>", false, IIF(((not byDV) or (IsMarket)),"N1_TableHeaderClients","N1_TableHeaderOur"), "A"+(GetLastPosition(DepartmentName)+3), DepartmentName, false);

       //RegisterTable();
    end;

    PRIVATE MACRO PrintClientAndOurDeals(isClientDeals:bool, IsOutMark)
       if( m_RegisterTable )
          EndReportTab();
       end;

       if( isClientDeals )
          PrintFormatString("#", "N1_A0", "Сделки, совершенные за счет клиентов");
          CopyAllSheetInTotalBook("<H11>", false, "N1_ClientDeals", 0, DepartmentName, false);
       else
          PrintFormatString("#", "N1_A1", "Собственные сделки");
          CopyAllSheetInTotalBook("<H11>", false, "N1_OurDeals", "A"+(GetLastPosition(DepartmentName)+2), DepartmentName, false);
       end;
      
       ReportRegisterTable(IsOutMark);
    END;

    PRIVATE MACRO PrintTableString( DealNum:string,
                                    DealDate:date,
                                    DealTime:time,
                                    DealPlace:string,
                                    Broker:string,
                                    DealMarkNum:string,
                                    KindOper:string,
                                    Client:string,
                                    Contractor:string,
                                    OrderNum:string,
                                    OrderRegDate:string,
                                    ApplicationNum:string,
                                    AgreeGenCode:string,
                                    SfContrNumber:string,
                                    DVFIKind:string,
                                    ContrCode:string,
                                    IspType:string,
                                    MethodCalc:string,
                                    OptionStrike:money,
                                    OptionCur:string,
                                    DealPrice:money,
                                    DealCur:string,
                                    Amount:money,
                                    BaseAmount:money,
                                    Cost:money,
                                    BAFIID:string,
                                    PayCur:string,
                                    OutMarketEx:string,
                                    DateIsp:variant,
                                    // KS 28.03.2019
                                    x1, // Данные о представителе клиента
                                    x2, // Данные доверенности на уполномоченного
                                    x3, // Сторона 1
                                    x4, // Сторона 2
                                    x5, // Клиент стороны 2
                                    x6, // Комиссия брокера (обязательства клиента перед Банком)
                                    x7, // Тип сделки
                                    x7_1, // Вид сделки (адресная / безадреснрая)
                                    x8, // Номер Поручения / Номер договора с клиентом
                                    x9, // Вид сделки (покупка-продажа)
                                    x10, // Вид договора
                                    x11, // Базисный актив ПФИ
                                    x12, // Наименование (обозначение) фьючерсного контракта/ опциона
                                    x13, // Цена фьючерсного контракта (цена исполнения по опциону)
                                    x14, // Размер премии по опциону
                                    x15, // Валюта расчетов
                                    x16, // Номер/ дата отчета перед банком
                                    x17, // Клиент является ФЛ/ЮЛ/ИП
                                    x18, // Гражданство клиента
                                    x19, // Клиент является/ не является налоговым резидентом
                                    x20, // Клиент является/ не является квалифицированным
                                    x21, // Категория клиента
                                    x22, // Порядок и способ исполнения обязательств
                                    x23, // Качество, в котором действует банк
                                    x24, // Дата принятия поручения Биржей
                                    x25, // ПФИ/не ПФИ
                                    x26, // Право ипользование денежных средств Клиента
                                    x27, // Остаток денежных средств на счете внутреннего учета
                                    x28, // Плановый исходящий остаток денежных средств на счете внутреннего учета
                                    x29, // Валюта
                                    x30, // денежные средства
                                    x31, // контракт
                                    x32, // денежные средства
                                    x33, // контракт
                                    x34, // Наличие подтверждающих документов
                                    y1,  //
                                    y2,  //
                                    y3,  //
                                    y4,  //
                                    y5,  //
                                    y6,  //
                                    y7,  //
                                    y8,  //
                                    y9,  //
                                    y10, //
                                    y11, //
                                    y12, //
                                    y13, //
                                    y14, //
                                    y15, //
                                    y16, //
                                    y17, //
                                    y18, //
                                    y19,  //
                                    y20, //
                                    y21, //
                                    y22, //
                                    y23, //
                                    y24, //
                                    y25, //
                                    y26, //
                                    y27, //
                                    y28, //
                                    y29, //
                                    y30, //
                                    y31, //
                                    ClientFormat
                                  )
     /*
        PrintTableLine("N1_A1",    DealNum,                              NULL,
                       "N1_D1",    DealDate,                             NULL,
                       "N1_T1",    DealTime,                             NULL,
                       "N1_A2",    DealPlace,                            NULL,
                       "N1_N_st",  DealMarkNum,                          NULL,
                       "N1_A4",    KindOper,                             NULL,
                       "N1_A5",    Client,                               NULL,
                       "N1_A5_1",  Contractor,                           NULL,
                       "N1_A6",    OrderNum,                             NULL,
                       "N1_A6.1",  OrderRegDate,                         NULL,
                       "N1_N_z",   ApplicationNum,                       NULL,
                       "N1_N_gs",  AgreeGenCode,                         NULL,
                       "N1_A7",    SfContrNumber,                        NULL,
                       "N1_A8",    DVFIKind,                             NULL,
                       "N1_A9",    ContrCode,                            NULL,
                       "N1_T_Isp", IspType,                              NULL,
                       "N1_S_R",   MethodCalc,                           NULL,
                       "N1_N1",    IIF(OptionStrike == 0, "", OptionStrike),2,
                       "N1_A10",   OptionCur,                            NULL,
                       "N1_N2",    DealPrice,                            4,
                       "N1_A11",   DealCur,                              NULL,
                       "N1_N3",    IIF(Amount == 0, "", Amount),         0,
                       "N1_N3_1",  IIF(BaseAmount == 0, "", BaseAmount), 0,
                       "N1_N3_2",  IIF(Cost == 0, "", BAFIID),           NULL,
                       "N1_N3_3",  IIF(Cost == 0, "", Cost),             2,
                       "N1_N3_4",  PayCur,                               NULL,
                       "N1_A12",   OutMarketEx,                          NULL,
                       "N1_D2",    DateIsp,                              NULL
                      );
   */

      IF( (not byDV) or (IsMarket))
        PrintTableLine("N1_N_st",  DealMarkNum,                          NULL,
                       "N1_D1",    DealDate,                             NULL,
                       "N1_T1",    DealTime,                             NULL,
                       "N1_A2",    DealPlace,                            NULL,
                       "N1_A7",    SfContrNumber,                        NULL,
                       //"N1_A4",    KindOper,                             NULL,
                       "N1_A5",    Client,                               NULL,
                       "N1_X1",    x1,                                   NULL,
                       "N1_X2",    x2,                                   NULL,
                       "N1_X3",    x3,                                   NULL,
                       "N1_X4",    x4,                                   NULL,
                       "N1_X5",    x5,                                   NULL,
                       "N1_X6",    x6,                                   2,
                       "N1_X7",    x7,                                   NULL,
                       "N1_X7_1",  x7_1,                                 NULL,
                       "N1_X8",    x8,                                   NULL,
                       "N1_X9",    x9,                                   NULL,
                       "N1_X10",   x10,                                  NULL,
                       "N1_A8",    DVFIKind,                             NULL,
                       "N1_X11",   x11,                                  NULL,
                       "N1_X12",   x12,                                  NULL,
                       "N1_X13",   DealPrice,                              IIF(x11=="металл",12,IIF(x11=="валюта",6,2)),
                       "N1_X14",   x14,                                  NULL,
                       "N1_N1",    IIF(OptionStrike == 0, "", DealPrice*Amount),2,
                       "N1_A10",   OptionCur,                            NULL,
                       "N1_N3",    IIF(Amount == 0, "", string(money(Amount))), 0,
                       "N1_X15",   x15,                                  NULL,
                       "N1_X16",   x16,                                  NULL,
                       "N1_X17",   x17,                                  NULL,
                       "N1_X18",   x18,                                  NULL,
                       "N1_X19",   x19,                                  NULL,
                       "N1_X20",   x20,                                  NULL,
                       "N1_X21",   x21,                                  NULL,
                       "N1_X22",   x22,                                  NULL,
                       "N1_X23",   x23,                                  NULL,
                       "N1_X24",   x24,                                  NULL,
                       "N1_X25",   x25,                                  NULL,
                       "N1_X26",   x26,                                  NULL,
                       "N1_X27",   x27,                                  NULL,
                       "N1_X28",   x28,                                  NULL,
                       "N1_X29",   x29,                                  NULL,
                       "N1_X30",   x30,                                  NULL,
                       "N1_X31",   x31,                                  0,
                       "N1_X32",   x32,                                  NULL,
                       "N1_X33",   x33,                                  0,
                       "N1_X34",   x34,                                  NULL,
                       "N1_Y1",    y1,                                   NULL,
                       "N1_Y2",    y2,                                   NULL,
                       "N1_Y3",    y3,                                   NULL,
                       "N1_Y4",    y4,                                   NULL,
                       "N1_Y5",    y5,                                   NULL,
                       "N1_Y6",    y6,                                   NULL,
                       "N1_Y7",    y7,                                   NULL,
                       "N1_Y8",    y8,                                   NULL,
                       "N1_Y9",    y9,                                   NULL,
                       "N1_Y10",   y10,                                  NULL,
                       "N1_Y11",   y11,                                  NULL,
                       "N1_Y12",   y12,                                  NULL,
                       "N1_Y13",   y13,                                  NULL,
                       "N1_Y14",   y14,                                  NULL,
                       "N1_Y15",   y15,                                  NULL,
                       "N1_Y16",   y16,                                  NULL,
                       "N1_Y17",   y17,                                  NULL,
                       "N1_Y18",   y18,                                  NULL,
                       "N1_Y19",   y19,                                  NULL,
                       "N1_Y20",   y20,                                  NULL,
                       "N1_Y21",   y21,                                  NULL,
                       "N1_Y22",   y22,                                  NULL,
                       "N1_Y23",   y23,                                  NULL,
                       "N1_Y24",   IIF(x11=="металл",y24,""),            NULL,
                       "N1_Y25",   y25,                                  NULL,
                       "N1_Y26",   y26,                                  NULL,
                       "N1_Y27",   y27,                                  NULL,
                       "N1_Y28",   y28,                                  NULL,
                       "N1_Y29",   y29,                                  NULL,
                       "N1_Y30",   IIF(y30 == 0, "", y30),               2,
                       "N1_Y31",   y31,                                  NULL
                      );
      else
        PrintTableLine("N1_N_st_2",DealMarkNum,                          NULL,
                       "N1_Y1",    y1,                                   NULL,
                       "N1_Y2",    y2,                                   NULL,
                       "N1_Y3",    y3,                                   NULL,
                       "N1_Y4",    y4,                                   NULL,
                       "N1_Y5",    y5,                                   NULL,
                       "N1_Y6",    SfContrNumber,                        NULL,
                       "N1_D1_2",  DealDate,                             NULL,
                       "N1_T1_2",  DealTime,                             NULL,
                       "N1_Y7",    y7,                                   NULL,
                       "N1_Y8",    y8,                                   NULL,
                       "N1_X10_2", x10,                                  NULL,
                       "N1_A8_2",  DVFIKind,                             NULL,
                       "N1_X11_2", x11,                                  NULL,
                       "N1_Y9",    y9,                                   NULL,
                       "N1_A2_2",  DealPlace,                            NULL,
                       "N1_X13_2", IIF(OptionStrike == 0, DealPrice, OptionStrike), IIF(x11=="металл",12,IIF(x11=="валюта",6,2)),
                       "N1_Y10",   y10,                                  NULL,
                       "N1_X32_2", x32,                                  NULL,
                       "N1_Y11",   y11,                                  NULL,
                       "N1_X30_2", x30,                                  NULL,
                       "N1_Y12",   y12,                                  NULL,
                       "N1_Y13",   y13,                                  NULL,
                       "N1_Y14",   y14,                                  NULL,
                       "N1_Y15",   y15,                                  NULL,
                       "N1_Y16",   y16,                                  NULL,
                       "N1_Y17",   y17,                                  NULL,
                       "N1_Y18",   y18,                                  NULL,
                       "N1_Y19",   y19,                                  NULL,
                       "N1_Y20",   y20,                                  NULL,
                       "N1_Y21",   y21,                                  NULL,
                       "N1_Y22",   y22,                                  NULL,
                       "N1_Y23",   y23,                                  NULL,
                       "N1_Y24",   IIF(x11=="металл",y24,""),            NULL,
                       "N1_Y25",   y25,                                  NULL,
                       "N1_Y26",   y26,                                  NULL,
                       "N1_Y27",   y27,                                  NULL,
                       "N1_Y28",   y28,                                  NULL,
                       "N1_Y29",   y29,                                  NULL,
                       "N1_Y30",   IIF(y30 == 0, "", y30),               2,
                       "N1_Y31",   y31,                                  NULL
                      );
      end;
    end;

    MACRO PrintFooter()
        AddStandardFooter( "N1_" );

        CopyAllSheetInTotalBook("<H11>", false, "N1_Footer", 1, DepartmentName, false);
    end;

    private macro ПолучитьСделки( Data, IsClientDeals:bool, IsOurDeals:bool )
       // Вспомогательные методы для Фиссико 
       private macro DealHeadSelect_DV()
          return " SELECT 42 /*IP_DV*/ IDENTPROGRAM,\n"+ 
                 "        DVDeal.T_CLIENTCONTR,\n" +
                          DL_DVDEAL+" T_DocKind,\n" +
                 "        DVDeal.T_DATE," +
                 "        DVDeal.T_TIME," +                
                 "        DVDeal.T_FIID," +
                 "        DVDeal.T_DEPARTMENT," +
                 "        DVDeal.T_KIND," +
                 "        DVDeal.T_CODE," +
                 "        DVDeal.T_ID,"
                 "        DVDeal.t_Broker," +
                 "        (SELECT nvl(Party.t_ShortName, chr(1)) FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.t_Broker) t_BrokerName," +
                 "        DVDeal.t_ExtCode," +
                 "        (SELECT Gagr.T_CODE || ' от ' || to_char(Gagr.t_Start,'DD.MM.YYYY') from ddl_genagr_dbt Gagr where Gagr.t_GenagrID = DVDeal.T_GENAGRID ) AgrCode," +
                 "        ( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = ContrFI.T_FI_KIND and AvrKinds.T_AVOIRKIND = ContrFI.T_AVOIRKIND) DVFIKind," +
                 "        ContrFI.T_FI_CODE," +
                 "        (CASE WHEN DVDeal.t_Broker != -1 " +
                 "              THEN " +
                 "                'брокер ' || (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.t_Broker) " +
                 "              ELSE " +
                 "                (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER) " +
                 "         END) IssuerName, " +
                 "        DECODE( ( SELECT SfContr.T_SERVKIND FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVPos.T_CLIENTCONTR ), NULL, 1, 0) DealType," +
                 "        DVPos.T_CLIENT," +
// KS
                 "        ( SELECT replace(SfContr.T_NUMBER, '_с', '') || ' от ' || to_char(SfContr.t_Datebegin,'DD.MM.YYYY') FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVDeal.T_CLIENTCONTR ) SfContrNumber," +
// KS
                 "        ( SELECT Party.T_SHORTNAME || '/' || (select oc.t_code from ddlobjcode_dbt oc, ddlcontrmp_dbt dcm where oc.t_objecttype = 207 and oc.t_codekind = 1 and oc.t_objectid = dcm.t_dlcontrid and /*oc.t_state = 0 and*/ dcm.t_sfcontrid = DVDeal.T_CLIENTCONTR and rownum = 1)" +
                 "            FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) ClientName," +
                 "        (CASE WHEN DVDeal.t_Broker = -1 and not exists(SELECT 1 FROM DPARTYOWN_DBT WHERE T_PARTYID = ContrFI.T_ISSUER AND T_PARTYKIND = "+PTK_CENTRALCONTR+" ) " +
                 "              THEN " +
                 "                (SELECT Party.T_NAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER) " +
                 "              ELSE " +
                 "                '' " +
                 "         END) ContrName, " +
                 "        DECODE( DvDeal.t_Type, 'E', DECODE( DVDeal.T_POSITION, 1, 'Короткие позиции', 'Длинные позиции' ), DECODE(DvDeal.t_Type, 'B', 'Короткие позиции','Длинные позиции') ) Position," +
                 "        DVDeal.T_AMOUNT," +
                 "        0 t_BaseAmount," +
                 "        0 t_Cost, " +
//                 "        chr(1) t_BAFIID, " +
                 "        'RUB' t_BAFIID, " +
                 "        DVDeal.T_PRICE," +
                 "        ContrDV.T_TicKFIID T_PRICEFIID," +
                 "        ContrDV.T_STRIKE," +
                 "        ContrDV.T_STRIKEFIID," +
                 "        ContrDV.T_OPTIONTYPE, "+
                 "        ContrDV.T_OPTIONSTYLE, " +
                 "        chr(1) t_ExecType, " +
                 "        ContrFI.t_Settlement_Code, " +
                 "        DVDeal.T_STATE, " +
                 "        to_date('01.01.0001', 'DD.MM.YYYY') T_EXECDATE, " +
                 "        ( SELECT SpGround.T_XLD         FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ) OrderNum, " +
                 "        NVL(( SELECT SpGround.T_REGISTRDATE FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ), DVDeal.T_DATE) OrderRegDate, " +
                 "        0 IsOutMark, " +
                 "        DVDeal.T_ID DealID, " +
                 "        0 DVKIND, " +
                 "        -1 as PayFIID, " +
                 "        -1 as T_TYPE_NFI2, " +
                 // KS
                 "        DVDeal.t_type DVDeal_type," +
                 "        (SELECT t_sum from ddvdlcom_dbt dvdlcom where dvdlcom.t_dealid = DVDeal.T_ID and dvdlcom.t_comissid = 322) as x6," +
                 "        (Select utl_raw.cast_to_varchar2(t_text) from dnotetext_dbt t where t_notekind=102 and t_documentid in (lpad(DVDeal.T_ID,34,'0')) and t_objecttype = 140) as x7_1," +
                 "        decode(DVDeal.t_type,'"+"S"+"','SELL','BUY') as x9," +
                 "        decode(DVDeal.t_type,'"+"S"+"','Продажа','Покупка') as x10," +
                 "        (select oc.t_code From dobjcode_dbt oc, dfininstr_dbt fininstr where fininstr.t_facevaluefi = oc.t_objectid and oc.t_codekind = 11 and oc.t_objecttype = 9 and t_state = 0 and fininstr.t_fiid = DVDeal.t_fiid and rownum = 1) as x11," +
                 "        (select fininstr.t_name From dfininstr_dbt fininstr where fininstr.t_fiid=DVDeal.t_fiid) as x12," +
                 "        (select fininstr2.t_fi_code From dfininstr_dbt fininstr, dfininstr_dbt fininstr2 where fininstr.t_fiid=DVDeal.t_fiid and fininstr.t_facevaluefi=fininstr2.t_fiid) as x13," +
                 "        DVDeal.T_BONUS as x14," +
                 "        (select decode(party.t_legalform, 2, 'ФЛ', 'ЮЛ') from dparty_dbt party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) as x17, " +
                 "        (select party.t_nrcountry from dparty_dbt party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) as x18, " +
                 "        (select decode(party.t_notresident, chr(0), 'является', 'не является') from dparty_dbt party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) as x19, " +
                 "        NVL((select decode(t_state, 1, 'является', 'не является') from dv_scqinvhist sih where sih.t_partyid = DVDeal.T_CLIENT and sih.T_BEGDATE <= DVdeal.T_DATE and (sih.T_ENDDATE >= DVdeal.T_DATE or sih.T_ENDDATE = to_date('01.01.0001', 'DD.MM.YYYY'))),'не является') as x20, " +
                 "        NVL((select oa.t_name from ddlcontrmp_dbt dcm, dobjatcor_dbt oac, dobjattr_dbt oa                                       " +
                 "              where dcm.t_sfcontrid = DVDeal.T_CLIENTCONTR                                                                      " +
                 "                and oa.t_objecttype = 207 and oa.t_groupid = 103                                                                " +
                 "                and oac.t_objecttype = oa.t_objecttype and oac.t_groupid = oa.t_groupid                                         " +
                 "                and oac.t_object = lpad(dcm.t_dlcontrid, 34, '0') and oa.t_attrid = oac.t_attrid                                " +
                 "                and oac.t_validfromdate <= DVdeal.T_DATE and oac.t_validtodate >= DVdeal.T_DATE and rownum = 1),chr(1)) as x21, " +
                 "        (select oa.t_name from ddlcontrmp_dbt dcm, dobjattr_dbt oa where dcm.t_sfcontrid = DVDeal.T_CLIENTCONTR and oa.t_objecttype = 659 and oa.t_groupid = 1 and dcm.t_role = oa.t_attrid) as x23, " +
                 "        NVL((SELECT t_margin FROM ddvdlturn_dbt t WHERE t.t_dealid = DVDeal.T_ID and t_Date = ( SELECT MAX(m.t_Date) FROM DDVDLTURN_DBT m WHERE m.t_DealID = DVDeal.T_ID and m.t_Date <= DVdeal.T_DATE)),0) as x30, " +
                 "        (SELECT nvl(sum(t_sum),0) from ddvdlcom_dbt dvdlcom where dvdlcom.t_dealid = DVDeal.T_ID) as comis," +
                 "        '' as y1, " +
                 "        '' as y2, " +
                 "        '' as y3, " +
                 "        '' as y4, " +
                 "        '' as y5_swift, " +
                 "        '' as y5_inn, " +
                 "        (select party_nr.t_notresident from dparty_dbt party_nr WHERE Party_nr.T_PARTYID = DVDeal.t_Contractor ) as y5_notres, " +
                 "        '' as y6, " +
                 "        tick.t_closedate as y7, " +
                 "        '' as y8, " +
                 "        '' as y9, " +
                 "        '' as y10, " +
                 "        '' as y11, " +
                 "        '' as y12, " +
                 "        '' as y13, " +
                 "        '' as y14, " +
                 "        '' as y15, " +
                 "        '' as y16, " +
                 "        '' as y17, " +
                 "        '' as y18, " +
                 "        '' as y19, " +
                 "        '' as y20, " +
                 "        '' as y21, " +
                 "        '' as y22, " +
                 "        '' as y23, " +
                 "        '' as y24, " +
                 "        '' as y25, " +
                 "        '' as y26, " +
                 "        '' as y27, " +
                 "        '' as y28, " +
                 "        to_date('01010001','DDMMYYYY') as y29, " +
                 "        0 as y30, " +
                 "        '' as y31 ";
                 
       end;
       
       private macro DealWhereSelect_DV()
          return " WHERE ContrFI.T_FIID = DVDeal.T_FIID " +
                 "   and BaseFI1.T_FIID = ContrFI.T_FACEVALUEFI " +
                 "   and BaseFI2.T_FIID = DECODE(BaseFI1.T_FI_KIND, 4, BaseFI1.T_FACEVALUEFI, ContrFI.T_FACEVALUEFI) " +
                 "   and ContrDV.T_FIID = DVDeal.T_FIID " +
                 "   and DVPos.T_FIID   = DVDeal.T_FIID " +
                 "   and DVPos.T_DEPARTMENT = DVDeal.T_DEPARTMENT " +
                 "   and DVPos.T_CLIENT = DVDeal.T_CLIENT " +
                 "   and DVPos.T_BROKER = DVDeal.T_BROKER " +
                 "   and DVPos.T_GENAGRID = DVDeal.T_GENAGRID " +
                 "   and DVdeal.T_DATE >= " + GetSQLDate( Data.dateMin ) +
                 "   and DVdeal.T_DATE <= " + GetSQLDate( Data.dateMax ) +
                 "   and tick.t_dealid(+) = DVDeal.T_ID";
       end;

       private macro DealAddWhere_DV()

          var RetVal = "";
        
          if( Data.DprtID and (Data.DprtID != UNDF )  )
             RetVal = RetVal + " and DVDeal.T_DEPARTMENT = " + String( Data.DprtID );
          end;
     
          if( Data.DealStatus != DVDEAL_UNDEF)
             if( Data.DealStatus != DVDEAL_OPEN )
                RetVal = RetVal + " and tick.T_DealStatus = " + DL_READIED;
             else 
                RetVal = RetVal + " and tick.T_DealStatus = " + DL_CLOSED;
             end;
          else
             RetVal = RetVal + " and DVDeal.T_STATE <> 0 ";
          end;

          /* Если надо уставливаем условие типу ПИ*/
          if( (Data.DVFIKindID != -1) and ( Data.DVFIKindID != UNDF ) )
             /*если Data.DVFIKindID == 0 - фьючерс
               если Data.DVFIKindID == 1 - опцион
             */
             if( Data.DVFIKindID == 0 )
                RetVal = RetVal + " and ContrFI.T_AVOIRKIND = " + String( DERIVATIVE_FUTURES );
             elif( Data.DVFIKindID == 1 )
                RetVal = RetVal + " and ContrFI.T_AVOIRKIND = " + String( DERIVATIVE_OPTION );
             end;
          end;

          /* Если надо уставливаем условие по ПИ*/
          if( Data.DVFIID and ( Data.DVFIID != UNDF ) )
             RetVal = RetVal + " and DVDeal.T_FIID = " + String( Data.DVFIID );
          end;

          /* Если надо уставливаем условие по эмитенту*/
          if( Data.EmiID and ( Data.EmiID != UNDF ) )
             RetVal = RetVal + " and ContrFI.T_ISSUER = " + String( Data.EmiID );
          end;

          /* Устанавливаем фильтр по контрактору */
          if( Data.ContractorID and ( Data.ContractorID != UNDF ) )
             RetVal = RetVal + " and (case when DVPos.T_BROKER > 0 then DVPos.T_BROKER else ContrFI.T_ISSUER end) = " + String( Data.ContractorID );
          end;

          /* Если надо уставливаем условие типу базового актива*/
          if( Data.BaseFIKind and (Data.BaseFIKind != UNDF ))
             RetVal = RetVal + " and BaseFI2.T_FI_KIND = " + String( Data.BaseFIKind );
          end;
     
          /* Если надо уставливаем условие базому активу*/
          if( Data.BaseFIID and (Data.BaseFIID != UNDF ) )
             RetVal = RetVal + " and DECODE(BaseFI1.T_FI_KIND, 4, BaseFI1.T_FACEVALUEFI, ContrFI.T_FACEVALUEFI) = " + String( Data.BaseFIID );
          end;

          return RetVal;
       end;

       private macro ПолучитьБиржевыеСделки_DV( IsClientDeals:bool, IsOurDeals:bool )
          DVQuery = "";
          if( IsClientDeals )
             if(IsOurDeals)
                DVQuery = DVQuery + "(";
             end;

             DVQuery = DVQuery + DealHeadSelect_DV() +
                                 " FROM ddvfipos_dbt DVPos, ddvdeal_dbt DVDeal, dfininstr_dbt ContrFI, dfideriv_dbt ContrDV, dfininstr_dbt BaseFI1, dfininstr_dbt BaseFI2, dparty_dbt party, ddl_tick_dbt  tick" +
                                 DealWhereSelect_DV() +
                                 " and DVDeal.t_Client <> -1" +
                                 " and party.t_PartyID = DVDeal.t_Client" +
                                 DealAddWhere_DV();

             if( IsForm == 1 )
                DVQuery = DVQuery + " and party.T_LegalForm = " + string(FormSub);
             elif( IsForm == 2 )
                DVQuery = DVQuery + " and party.T_LegalForm <> " + string(FormSub);
             end;

             if( IsVid == 1 )
                DVQuery = DVQuery + " and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + string(VidSub) + " and party.T_PARTYID = Pto.T_PARTYID)";
             elif( IsVid == 2 )
                DVQuery = DVQuery + " and not EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + string(VidSub) + " and party.T_PARTYID = Pto.T_PARTYID)";
             end;
     
             if( CharFlag_7 == true )
                DVQuery = DVQuery + " and party.t_NotResident = 'X'";
             end;
     
             /*   Если надо уставливаем условие по клиенту*/
             if( Data.ClientID and ( Data.ClientID != UNDF ))
                DVQuery = DVQuery + " and DVDeal.t_Client = " + String(Data.ClientID);
             end;
          end;            
     
          if( IsOurDeals )

             if( IsClientDeals )
                DVQuery = DVQuery + " union all ";
             end;

             DVQuery = DVQuery + DealHeadSelect_DV() +
                                 " FROM ddvfipos_dbt DVPos, ddvdeal_dbt DVDeal, dfininstr_dbt ContrFI, dfideriv_dbt ContrDV, dfininstr_dbt BaseFI1, dfininstr_dbt BaseFI2, ddl_tick_dbt  tick" +
                                 DealWhereSelect_DV() +
                                 " and DVDeal.t_Client = -1 " +
                                 DealAddWhere_DV();

             if (not byBO )
               DVQuery = DVQuery + 
                                 "   and DVdeal.T_KIND in (12615, 12625, 12640)"; // Для ФИССиКО отбираем только опционы
             end;

             if( IsClientDeals )
                DVQuery = DVQuery + ")";
             end;
          elif( not IsClientDeals )
             DVQuery = DVQuery + " and 0 = 1";
          end;
     
       end;

       private macro OutDealHeadSelect_DV()
          return " SELECT 42 /*IP_DV*/ IDENTPROGRAM,\n"+ 
                 "        DVDeal.T_CLIENTCONTR,\n"+
                 "        DVDeal.T_DocKind, " +
                 "        DVDeal.T_DATE, " +         
                 "        DVDeal.T_TIME, " +
                 "        -1 T_FIID, " +
                 "        DVDeal.T_DEPARTMENT, " +
                 "        (CASE WHEN DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ") and nfi2.t_Type = 2 THEN (CASE WHEN DVDeal.T_TYPE = "+ALG_DV_BS+" THEN "+ALG_DV_SALE+" ELSE "+ALG_DV_BUY+" END) ELSE DVDeal.T_TYPE END) T_KIND , " +/*для внебиржевых по типу определяем, покупка?продажа*/
                 "        DVDeal.T_CODE, " +
                 "        DVDeal.T_ID, " +
                 "        0 as Broker, " +
                 "        chr(1) as BrokerName, " +
                 "        chr(1) as t_ExtCode,"
                 "        (SELECT Gagr.T_CODE || ' от ' || to_char(Gagr.t_Start,'DD.MM.YYYY') from ddl_genagr_dbt Gagr where Gagr.t_GenagrID = DVDeal.T_GENAGRID ) AgrCode, " +
                 "        DECODE( DVDeal.T_DVKIND, " + DV_FORWARD + ", 'Форвард', " +
                                                       DV_OPTION  + ", 'Опцион', " +
                                                       DV_CURSWAP + ", 'Валютный своп ' || (CASE when nfi2.t_Type = 2 then '2ч.' else '1ч.' END), " +
                                                       DV_CURSWAP_FX + ", 'Своп ' || (CASE when nfi2.t_Type = 2 then '2ч.' else '1ч.' END), " +
                                                       DV_PCTSWAP + ", 'Процентный своп', " +
                                                       DV_FORWARD_T3 + ", 'Покупка/продажа T+3', " +
                 "                                 chr(1) " +
                 "              ) DVFIKind, " +
                 "        case when DVDeal.t_DvKind = " + DV_PCTSWAP + " then fin.t_FI_CODE || ' ' || " +
                 "                                                            to_char(nfi.t_Period) || '_' || " +
                 "                                                            ( SELECT nvl(n.t_sznamealg, chr(1)) " +
                 "                                                                FROM dnamealg_dbt n " +
                 "                                                               WHERE n.t_itypealg = " + ALG_DV_PERIODKIND_PRRATE +
                 "                                                                 AND n.t_inumberalg = nfi.t_PeriodKind " +
                 "                                                            ) || ' ' || " +
                 "                                                            ( SELECT nvl(n.t_sznamealg, chr(1)) " +
                 "                                                                FROM dnamealg_dbt n " +
                 "                                                               WHERE n.t_itypealg = " + ALG_FI_DVSETTLEMET +
                 "                                                                 AND n.t_inumberalg = nfi.t_ExecType " +
                 "                                                            ) || ' ' || " +
                 "                                                            (case when DVDeal.t_Type in( " + ALG_DV_FIX_FLOAT + "," + ALG_DV_FIX_FIX + " ) then to_char(nfi.t_Rate)  else (select nvl(fn.t_FI_CODE, chr(1)) from dfininstr_dbt fn where fn.t_FIID = nfi.t_RateID) end) || '/' ||  " +
                 "                                                            (case when DVDeal.t_Type in( " + ALG_DV_FLOAT_FIX + "," + ALG_DV_FIX_FIX + " ) then to_char(nfi2.t_Rate) else (select nvl(fn.t_FI_CODE, chr(1)) from dfininstr_dbt fn where fn.t_FIID = nfi2.t_RateID) end) " +
                 "                                                       else ( DECODE(fin.t_FI_KIND, " + FIKIND_AVOIRISS + ", (select avr.t_Name " +
                 "                                                                                                                from davrkinds_dbt avr " +
                 "                                                                                                               where avr.t_fi_kind = fin.t_fi_kind " +
                 "                                                                                                                 and avr.t_avoirkind = RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind, fin.t_avoirkind) " +
                 "                                                                                                             ), " +
                                                                                                          FIKIND_CURRENCY + ", 'Валюта', " +
                                                                                                          FIKIND_INDEX    + ", 'Индекс', " +
                                                                                                          FIKIND_METAL    + ", 'Драг. металл', " +
                                                                                                          FIKIND_ARTICLE  + ", 'Артикул', " +
                 "                                                                                    chr(1) " +
                 "                                                                    ) || ' ' || fin.t_FI_CODE || ' ' || case when DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ") THEN " +
                 "                                                                                                                                                      ( SELECT nvl(n.t_sznamealg, chr(1)) " +
                 "                                                                                                                                                          FROM dnamealg_dbt n " +
                 "                                                                                                                                                         WHERE n.t_itypealg = " + ALG_FI_DVSETTLEMET +
                 "                                                                                                                                                           AND n.t_inumberalg = case when nfi2.t_Type = 2 then nfi2.t_ExecType else nfi.t_ExecType end " +
                 "                                                                                                                                                      ) " +
                 "                                                                                                                                                      || ' ' || CASE WHEN (DVDeal.T_TYPE = " + ALG_DV_BS + " and nfi2.t_Type = 0) or (DVDeal.T_TYPE = " + ALG_DV_SB + " and nfi2.t_Type = 2) then 'покупка' else 'продажа' end " +
                 "                                                                                                                                                      || ' ' || TO_CHAR (case when nfi2.t_Type = 2 then nfi2.t_SuplDate else nfi.t_SuplDate end, 'DD.MM.YY') " +
                 "                                                                                                        else " +
                 "                                                                                                        to_char(nfi.t_SuplDate, 'DD.MM.YY') || ' ' || ( SELECT nvl(n.t_sznamealg, chr(1)) " +
                 "                                                                                                                                                          FROM dnamealg_dbt n " +
                 "                                                                                                                                                         WHERE n.t_itypealg = " + ALG_FI_DVSETTLEMET +
                 "                                                                                                                                                           AND n.t_inumberalg = nfi.t_ExecType " +
                 "                                                                                                                                                      ) " +
                 "                                                                                                        end " +
                 "                                                            ) end t_FI_CODE, " +
//                 "        'вне биржи' IssuerName," +
                 "        decode(DVDeal.T_SECTOR, chr(88), 'Биржевая', 'Внебиржевая') IssuerName," +
                 "        DECODE( ( SELECT SfContr.T_SERVKIND FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVDeal.T_CLIENTCONTR ), NULL, 1, 0 ) DealType," +
                 "        DVDeal.T_CLIENT, " +
// KS
                 "        ( SELECT replace(SfContr.T_NUMBER, '_с', '') || ' от ' || to_char(SfContr.t_Datebegin,'DD.MM.YYYY') FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVDeal.T_CLIENTCONTR ) SfContrNumber," +
// KS
                 "        ( SELECT Party.T_SHORTNAME || '/' || (select oc.t_code from ddlobjcode_dbt oc, ddlcontrmp_dbt dcm where oc.t_objecttype = 207 and oc.t_codekind = 1 and oc.t_objectid = dcm.t_dlcontrid /*and oc.t_state = 0*/ and dcm.t_sfcontrid = DVDeal.T_CLIENTCONTR and rownum = 1)" +
                 "            FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) ClientName," +
                 "        (CASE WHEN DVDeal.t_Agent = -1 " +
                 "              THEN " +
                 "                (SELECT Party.T_NAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.t_Contractor) " +
                 "              ELSE " +
                 "                '' " +
                 "         END) ContrName, " +
                 "        chr(1) Position," +
                 "        case when DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ", " + DV_PCTSWAP + ") then 0 else nfi.t_ContrAmount end t_Amount," + /*для сделок "валютный своп" и "процентный своп" не заполняется*/ 
                 "        case when DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ") and nfi2.t_Type = 2 then nfi2.t_Amount else nfi.t_Amount end t_BaseAmount, " +
                 "        case when DVDeal.t_DvKind = "+ DV_PCTSWAP + " then 0 else (CASE WHEN DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ") and nfi2.t_Type = 2 THEN nfi2.t_Cost ELSE nfi.t_Cost END) end t_Cost, " + /*для внебиржевых сделок ПФИ, кроме сделок "валютный своп", "процентный своп"*/ 
//                 "        case when fin.t_FI_KIND in (" + FIKIND_CURRENCY + ") then (case when fin.T_FIID = "+NATCUR+" then '"+string(Data.CCA_NatCUR)+"' else fin.T_CCY end) else chr(1) end t_BAFIID," + 
                 "        case when fin.t_FI_KIND in (" + FIKIND_CURRENCY + ") then (case when fin.T_FIID = "+NATCUR+" then '"+string(Data.CCA_NatCUR)+"' else fin.T_CCY end) else 'RUB' end t_BAFIID," + 
                 "        case when DVDeal.t_DvKind = " + DV_OPTION + " then DVDeal.T_BONUSPRICE else case when DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ") and nfi2.T_Type = 2 then nfi2.T_PRICE else nfi.T_PRICE end end T_PRICE," +/*для опциона - премию, для форварда - цену*/ 
                 "        case when DVDeal.t_DvKind = " + DV_OPTION + " then DVDeal.t_BonusFIID else nfi.t_PriceFIID end t_PriceFIID," + 
                 "        case when DVDeal.t_DvKind = " + DV_OPTION + " then nfi.T_Price/**nfi.T_Amount*/ else 0 end T_STRIKE, " +/*для опциона*/
                 "        case when DVDeal.t_DvKind = " + DV_OPTION + " then nfi.T_PriceFIID else 0 end T_STRIKEFIID, " +/*для опциона*/
                 "        DVDeal.T_OPTIONTYPE, "+
                 "        DVDeal.T_OPTIONSTYLE, " +
                 "        ( case nfi.t_ExecType " +
                 "            when 0 then 'Безпоставочный' " +
                 "            when 1 then 'Поставочный' " +
                 "            else chr(1) " +
                 "          end " +
                 "        ) t_ExecType, " +
                 "        nfi.t_ExecType Settlement_Code, " +
                 "        DVDeal.T_STATE, " +
                 "        NVL((SELECT step.t_Plan_Date " +
                 "               FROM doprstep_dbt step, doproper_dbt oper " +
                 "              WHERE oper.t_DocKind      = DVDeal.T_DocKind " +
                 "                AND oper.t_DocumentID   = lpad(DVDeal.t_ID, 34, '0') " +
                 "                AND step.t_ID_Operation = oper.t_ID_Operation " +
                 "                AND step.t_Kind_Action  in("+DV_KINDACTION_EXDELCB+","+DV_KINDACTION_EXDELCUR+","+DV_KINDACTION_EXNOTDELCB+") " +
                 "                AND step.t_IsExecute    = 'X' " +
                 "                AND ROWNUM = 1 ), (case when DVDeal.t_DvKind in(" + DV_CURSWAP + ", " + DV_CURSWAP_FX + ") and nfi2.t_Type = 2 then nfi2.t_ExecDate else nfi1.t_ExecDate end) ) t_ExecDate, " +
                 "        ( SELECT SpGround.T_XLD         FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = DVDeal.T_DocKind and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ) OrderNum, " +
                 "        NVL(( SELECT SpGround.T_REGISTRDATE FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = DVDeal.T_DocKind and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ), DVDeal.T_DATE) OrderRegDate, " +
                 "        1 IsOutMark, " +
                 "        DVDeal.T_ID DealID, " +
                 "        DVDeal.t_DVKind DVKIND, " +
                 "        -1 as PayFIID, " +
                 "        nfi2.t_Type as T_TYPE_NFI2, " +
                 // KS
                 "        to_char(DVDeal.t_type,'FM00000') DVDeal_type," +
                 "        (SELECT t_sum from ddvdlcom_dbt dvdlcom where dvdlcom.t_dealid = DVDeal.T_ID and dvdlcom.t_comissid = 322) as x6," +
                 "        '' as x7_1," +
                 "        CASE WHEN (DVDeal.T_TYPE = 1) or (DVDeal.T_TYPE = 5 and nfi2.t_Type = 0) or (DVDeal.T_TYPE = 6 and nfi2.t_Type = 2) then 'BUY'     else 'SELL'    end as x9," +
                 "        CASE WHEN (DVDeal.T_TYPE = 1) or (DVDeal.T_TYPE = 5 and nfi2.t_Type = 0) or (DVDeal.T_TYPE = 6 and nfi2.t_Type = 2) then 'Покупка' else 'Продажа' end as x10," +
                 "        (select decode(fininstr.t_fi_kind, 6,'металл', 'валюта') From dfininstr_dbt fininstr where fininstr.t_fiid = nfi.t_fiid and rownum = 1) as x11," +
                 "        (select fininstr.t_name From dfininstr_dbt fininstr where fininstr.t_fiid=nfi.t_fiid) as x12," +
                 "        (select fininstr2.t_fi_code From dfininstr_dbt fininstr, dfininstr_dbt fininstr2 where fininstr.t_fiid=nfi.t_fiid and fininstr.t_facevaluefi=fininstr2.t_fiid) as x13," +
                 "        DVDeal.T_BONUSPRICE as x14," +
                 "        (select decode(party.t_legalform, 2, 'ФЛ', 'ЮЛ') from dparty_dbt party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) as x17, " +
                 "        (select party.t_nrcountry from dparty_dbt party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) as x18, " +
                 "        (select decode(party.t_notresident, chr(0), 'является', 'не является') from dparty_dbt party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) as x19, " +
                 "        NVL((select decode(t_state, 1, 'является', 'не является') from dv_scqinvhist sih where sih.t_partyid = DVDeal.T_CLIENT and sih.T_BEGDATE <= DVdeal.T_DATE and (sih.T_ENDDATE >= DVdeal.T_DATE or sih.T_ENDDATE = to_date('01.01.0001', 'DD.MM.YYYY'))),'не является') as x20, " +
                 "        NVL((select oa.t_name from ddlcontrmp_dbt dcm, dobjatcor_dbt oac, dobjattr_dbt oa                                       " +
                 "              where dcm.t_sfcontrid = DVDeal.T_CLIENTCONTR                                                                      " +
                 "                and oa.t_objecttype = 207 and oa.t_groupid = 103                                                                " +
                 "                and oac.t_objecttype = oa.t_objecttype and oac.t_groupid = oa.t_groupid                                         " +
                 "                and oac.t_object = lpad(dcm.t_dlcontrid, 34, '0') and oa.t_attrid = oac.t_attrid                                " +
                 "                and oac.t_validfromdate <= DVdeal.T_DATE and oac.t_validtodate >= DVdeal.T_DATE and rownum = 1),chr(1)) as x21, " +
                 "        (select oa.t_name from ddlcontrmp_dbt dcm, dobjattr_dbt oa where dcm.t_sfcontrid = DVDeal.T_CLIENTCONTR and oa.t_objecttype = 659 and oa.t_groupid = 1 and dcm.t_role = oa.t_attrid) as x23, " +
                 "        NVL((SELECT t_margin FROM ddvdlturn_dbt t WHERE t.t_dealid = DVDeal.T_ID and t_Date = ( SELECT MAX(m.t_Date) FROM DDVDLTURN_DBT m WHERE m.t_DealID = DVDeal.T_ID and m.t_Date <= DVdeal.T_DATE)),0) as x30, " +
                 "        (SELECT nvl(sum(t_sum),0) from ddvdlcom_dbt dvdlcom where dvdlcom.t_dealid = DVDeal.T_ID) as comis," +

                 "        DECODE( DVDeal.T_DVKIND, " + DV_FORWARD + ", DVDeal.T_CODE, " +
                                                       DV_OPTION  + ", DVDeal.T_CODE, " +
                                                       DV_CURSWAP + ", DVDeal.T_CODE || (CASE when nfi2.t_Type = 2 then '/2' else '/1' END), " +
                                                       DV_CURSWAP_FX + ", DVDeal.T_CODE || (CASE when nfi2.t_Type = 2 then '/2' else '/1' END), " +
                                                       DV_PCTSWAP + ", DVDeal.T_CODE, " +
                                                       DV_FORWARD_T3 + ", DVDeal.T_CODE, " +
                 "                                 chr(1) " +
                 "              ) as y1, " +
                 "        (select decode(fininstr.t_fi_kind, 6,'металл', 'ПФИ') From dfininstr_dbt fininstr where fininstr.t_fiid = nfi.t_fiid and rownum = 1) as y2," +
                 "        '' as y3, " +
                 "        '' as y4, " +
                 "        (select oc.t_code                            " +
                 "           from dobjcode_dbt oc                      " +
                 "          where oc.t_objecttype = 3                  " +
                 "            and oc.t_codekind = 6                    " +
                 "            and oc.t_objectid = DVDeal.t_Contractor  " +
                 "            and oc.t_state = 0                       " +
                 "            and rownum = 1) as y5_swift,             " +
                 "        (select 'INN_'||oc.t_code                    " +
                 "           from dobjcode_dbt oc                      " +
                 "          where oc.t_objecttype = 3                  " +
                 "            and oc.t_codekind = 16                   " +
                 "            and oc.t_objectid = DVDeal.t_Contractor  " +
                 "            and oc.t_state = 0                       " +
                 "            and rownum = 1) as y5_inn,               " +
                 "        (select party_nr.t_notresident from dparty_dbt party_nr WHERE Party_nr.T_PARTYID = DVDeal.t_Contractor ) as y5_notres, " +
                 "        '' as y6, " +
                 "        nfi.t_execdate as y7, " +
                 "        'Купля-продажа' as y8, " +
                 "        '' as y9, " +
                 "        '' as y10, " +
                 "        fin.T_CCY as y11," + 
                 "        (select fininstr.t_ccy From dfininstr_dbt fininstr where fininstr.t_fiid = nfi1.t_pricefiid and rownum = 1) as y12," +
                 "        '' as y13, " +
                 "        '' as y14, " +
                 "        '' as y15, " +
                 "        '' as y16, " +
                 "        '' as y17, " +
                 "        '' as y18, " +
                 "        (select utl_raw.cast_to_varchar2(nt.t_text) from dnotetext_dbt nt where nt.t_objecttype=145 and nt.t_documentid = lpad(DVDeal.T_ID,34,'0') and nt.t_notekind = 10 and rownum=1) as y19, " +
                 "        '' as y20, " +
                 "        '' as y21, " +
                 "        '' as y22, " +
                 "        '' as y23, " +
                 "        substr(DVDeal.t_Comment,instr(lower(DVDeal.t_Comment),'loco'),instr(lower(replace(DVDeal.t_Comment,'.',' ')),' ',instr(lower(DVDeal.t_Comment),'loco')+5)-instr(lower(DVDeal.t_Comment),'loco'))" + // только loco и первое слово после
                          " || case when DVDeal.t_Comment is null then '' else ' ' end || (select utl_raw.cast_to_varchar2(nt.t_text) from dnotetext_dbt nt where nt.t_objecttype=145 and nt.t_documentid = lpad(DVDeal.T_ID,34,'0') and nt.t_notekind = 191 and rownum=1) as y24, " +
                 "        '' as y25, " +
                 "        '' as y26, " +
                 "        '' as y27, " +
                 "        decode(DVDeal.t_bonusdate,to_date('01.01.0001','DD.MM.YYYY'),'',to_char(DVDeal.t_bonusdate,'DD.MM.YYYY')) as y28, " +
                 "        nfi2.T_expirydate as y29, " +
                 "        DVDeal.t_bonus as y30, " +
                 "        '' as y31 ";
                 
       end;
       
       private macro OutDealWhereSelect_DV()
          return "  WHERE nfi.T_DealID = DVDeal.T_ID " +
                 "    and nfi.T_TYPE = case when DVDeal.T_FORVARD = 'X' then 1 else "+DV_NFIType_BaseActiv+" end " +/*актив по форварду или по сделке*/
                 "    and nfi1.T_DealID = DVDeal.T_ID " +
                 "    and nfi1.T_TYPE = " +DV_NFIType_BaseActiv+/*актив по сделке*/
                 "    and nfi2.T_DealID = DVDeal.T_ID " +
                 "    and nfi2.T_TYPE = case when DVDeal.t_DvKind != " + DV_PCTSWAP + " then nfi2.T_TYPE else "+DV_NFIType_BaseActiv2+" end " +
                 "    and fin.t_fiid = nfi.T_fiid " +/*здесь берем базовый актив*/
                 "    and DVDeal.T_IsTrust = chr(0) " +
                 "    and DVDeal.t_IsPFI = chr(88) " +
                 "    and DVdeal.T_DATE >= " + GetSQLDate( Data.dateMin ) +
                 "    and DVdeal.T_DATE <= " + GetSQLDate( Data.dateMax ) +
                 "    and tick.t_dealid(+) = DVDeal.T_ID";;
       end;

       private macro OutDealAddWhere_DV()

          var RetVal = "";
        
          if( Data.DprtID and (Data.DprtID != UNDF ) )
             RetVal = RetVal + " and DVDeal.T_DEPARTMENT = " + String( Data.DprtID );
          end;

          /* Если надо уставливаем условие на статус сделки*/
          if( Data.DealStatus != DVDEAL_UNDEF )
             RetVal = RetVal + " and DVDeal.T_STATE = " + String( Data.DealStatus );
          else
             RetVal = RetVal + " and DVDeal.T_STATE <> 0 ";
          end;

          if( (Data.DVFIKindID != -1) and (Data.DVFIKindID != UNDF) )
             if(Data.DVFIKindID == 1)
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_OPTION;
             elif(Data.DVFIKindID == 2)
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_FORWARD;
             elif(Data.DVFIKindID == 3)
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_CURSWAP;
             elif(Data.DVFIKindID == 4)
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_PCTSWAP;
             elif(Data.DVFIKindID == 5)
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_FORWARD_T3;
             elif(Data.DVFIKindID == 6)
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_CURSWAP_FX;
             end;
          end;
        
          if( not ( (Data.ByDV_Der == SET_CHAR) AND (Data.ByDV_Cur == SET_CHAR) ) )
             if(Data.ByDV_Der == SET_CHAR)
                 RetVal = RetVal + " and DVDeal.t_DVKind <> " + DV_CURSWAP;
             else
                 RetVal = RetVal + " and DVDeal.t_DVKind = " + DV_CURSWAP;
             end;
          end;
        
          /* Если надо уставливаем условие по ПИ*/      
          if( Data.DVFIID and ( Data.DVFIID != UNDF ) )/*только для стандартного контракта (форвард или опцион), если задан.*/
             RetVal = RetVal + " and DVDeal.T_FORVARD = chr(0) and nfi.T_StdFIID = " + String( Data.DVFIID );
          end;
        
          /* Если надо уставливаем условие типу базового актива*/
          if( Data.BaseFIKind and (Data.BaseFIKind != UNDF) )
             RetVal = RetVal + " and fin.T_FI_KIND = " + String(Data.BaseFIKind);
          else
             RetVal = RetVal + " and fin.T_FI_KIND in ("+FIKIND_AVOIRISS+","+FIKIND_INDEX+","+FIKIND_METAL+","+FIKIND_ARTICLE + ", " + FIKIND_CURRENCY + ")";
          end;
        
          if( Data.BaseFIID and (Data.BaseFIID != UNDF ) )
             RetVal = RetVal + " and nfi.T_FIID = " + String( Data.BaseFIID );
          end;

          return RetVal;
       end;

       private macro ПолучитьВнеБиржевыеСделки_DV( IsClientDeals:bool, IsOurDeals:bool )
      
          if( IsClientDeals )
             if( IsOurDeals )
                DVQuery = DVQuery + "(";
             end;
      
             DVQuery = DVQuery + OutDealHeadSelect_DV() +
                                 " FROM ddvndeal_dbt DVDeal, dfininstr_dbt fin, ddvnfi_dbt nfi, ddvnfi_dbt nfi1, ddvnfi_dbt nfi2, dparty_dbt party, ddl_tick_dbt  tick " +
                                 OutDealWhereSelect_DV() +
                                 " and DVDeal.T_CLIENT > 0" +
                                 " and party.t_PartyID = DVDeal.t_Client" +
                                 OutDealAddWhere_DV();

             if( IsForm == 1 )
                DVQuery = DVQuery + " and party.T_LegalForm = " + string(FormSub) ;
             elif( IsForm == 2 )
                DVQuery = DVQuery + " and party.T_LegalForm <> " + string(FormSub);
             end;
        
             if( IsVid == 1 )
                DVQuery = DVQuery + " and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + string(VidSub) + " and party.T_PARTYID = Pto.T_PARTYID)";
             elif(IsVid == 2)
                DVQuery = DVQuery + " and not EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + string(VidSub) + " and party.T_PARTYID = Pto.T_PARTYID)";
             end;
        
             if( CharFlag_7 )
                DVQuery = DVQuery + " and party.t_NotResident = 'X'";
             end;
        
             if( Data.ClientID and (Data.ClientID != UNDF) )
                DVQuery = DVQuery + " and DVDeal.T_CLIENT = " + String( Data.ClientID );
             end;
          end;
        
          if( IsOurDeals )
             if( IsClientDeals )
                DVQuery = DVQuery + " union all ";
             end;
      
             DVQuery = DVQuery + OutDealHeadSelect_DV() +
                                 "   FROM ddvndeal_dbt DVDeal, dfininstr_dbt fin, ddvnfi_dbt nfi, ddvnfi_dbt nfi1, ddvnfi_dbt nfi2, ddl_tick_dbt  tick " +
                                 OutDealWhereSelect_DV() +
                                 "    and DVDeal.T_CLIENT = -1" +
                                 OutDealAddWhere_DV();

             if( IsClientDeals )
                 DVQuery = DVQuery + ")";
             end;
      
          elif( not IsClientDeals )
             DVQuery = DVQuery + " and 0 = 1";
          end;
      
       end;
       // ----------- КОНЕЦ - Вспомогательные методы для Фиссико ------------

       // Вспомогательные методы для БО ЦБ
       private macro DealHeadSelect_BO()
          return " SELECT 14 /*IP_SEC*/ IDENTPROGRAM,\n"+
                 "        tick.T_CLIENTCONTRID T_CLIENTCONTR,\n"+
                 "        tick.t_BofficeKind     T_DocKind, \n" +
                 "        tick.t_DealDate        T_Date,\n" +
                 "        tick.t_dealTime        T_TIME,\n" +                
                 "        tick.t_PFI             T_FIID,\n" +
                 "        tick.t_Department      T_DEPARTMENT,\n" +
                 "        (CASE  WHEN Rsb_Secur.IsBuy(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) = 1 "+
                 "              THEN " +ALG_DV_BUY+ " ELSE "+ALG_DV_SALE+ "\n"+
                 "        END)                   T_KIND,\n" +
                 "        tick.t_DealCode        T_CODE,\n" +
                 "        tick.t_DealID          T_ID,\n" +
                 "        tick.t_BrokerID        t_Broker,\n" +
                 "        (SELECT nvl(Party.t_ShortName, chr(1)) FROM dparty_dbt Party WHERE Party.T_PARTYID = tick.t_BrokerID) t_BrokerName,\n" +
                 "        tick.t_DealCodeTS      t_ExtCode,\n" +
                 "        (SELECT Gagr.T_CODE from ddl_genagr_dbt Gagr where Gagr.t_GenagrID = tick.T_GENAGRID ) AgrCode,\n" +
                 "        ( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = ContrFI.T_FI_KIND and AvrKinds.T_AVOIRKIND = ContrFI.T_AVOIRKIND) DVFIKind," +
                 "        ContrFI.T_FI_CODE," +
                 "        (CASE WHEN tick.t_BrokerID != -1 " +
                 "              THEN " +
                 "                'брокер ' || (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = tick.t_BrokerID) " +
                 "              ELSE " +
                 "                (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER) " +
                 "         END) IssuerName, " +
                 "         0 DealType,\n"+ //"        DECODE( ( SELECT SfContr.T_SERVKIND FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVPos.T_CLIENTCONTR ), NULL, 1, 0) DealType," +
                 "        tick.t_ClientID   T_CLIENT,\n"+  
                 "        ( SELECT SfContr.T_NUMBER FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = tick.T_CLIENTCONTRID ) SfContrNumber," +
                 "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = tick.T_CLIENTID ) ClientName," +
                 "        (CASE WHEN tick.t_BrokerID = -1 and not exists(SELECT 1 FROM DPARTYOWN_DBT WHERE T_PARTYID = ContrFI.T_ISSUER AND T_PARTYKIND = "+PTK_CENTRALCONTR+" ) " +
                 "              THEN " +
                 "                (SELECT Party.T_NAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER) " +
                 "              ELSE " +
                 "                '' " +
                 "         END) ContrName, " +
                 "        (CASE  WHEN Rsb_Secur.IsBuy(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) = 1 \n" +
                 "               THEN   'Покупка' "+
                 "               ELSE   'Продажа'  \n"+         
                 "         END)             Position,\n" +
                 "        0                 T_AMOUNT,\n"+   // Контракты
                 "        leg.t_Principal   t_BaseAmount,\n" +
                 "        leg.t_Cost        t_Cost, \n" +
                 "        chr(1)            t_BAFIID, \n" +
                 "        leg.t_Price       T_PRICE,\n" +  
                 "        leg.t_CFI         T_PRICEFIID,\n"+      
                 "        0                 T_STRIKE,\n"+        
                 "        0                 T_STRIKEFIID,\n"+        
                 "        0                 T_OPTIONTYPE,\n"+      
                 "        0                 T_OPTIONSTYLE,\n"+
                 "        chr(1)            t_ExecType, " +
                 "        ContrFI.t_Settlement_Code, " +
                 "        tick.t_DealStatus T_STATE, \n" +
                 "        to_date('01.01.0001', 'DD.MM.YYYY') T_EXECDATE, " +
                 "        ( SELECT SpGround.T_XLD         FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = tick.T_DealID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ) OrderNum, " +
                 "        ( SELECT SpGround.T_REGISTRDATE FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = tick.T_DealID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ) OrderRegDate, " +
                 "        (CASE WHEN Rsb_Secur.IsExchange(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) = 1 \n"+
                 "              THEN 0 ELSE 1 \n"+        
                 "        END)              IsOutMark, \n" +
                 "        tick.T_DealID     DealID, \n" +
                 "        0                 DVKIND, \n" +
                 "        -1                as PayFIID, \n" +
                 "        -1                as T_TYPE_NFI2, \n " +
                 // KS
                 "        '' DVDeal_type," +
                 "        (SELECT t_sum from ddvdlcom_dbt dvdlcom where dvdlcom.t_dealid = tick.t_DealID and dvdlcom.t_comissid = 322) as x6," +
                 "        (Select utl_raw.cast_to_varchar2(t_text) from dnotetext_dbt t where t_notekind=102 and t_documentid in (lpad(tick.t_DealID,34,'0')) and t_objecttype = 140) as x7_1," +
                 "        decode(tick.t_DealType,'"+"S"+"','SELL','BUY') as x9," +
                 "        decode(tick.t_DealType,'"+"S"+"','Продажа','Покупка') as x10," +
                 "        (select oc.t_code From dobjcode_dbt oc, dfininstr_dbt fininstr where fininstr.t_facevaluefi = oc.t_objectid and oc.t_codekind = 11 and oc.t_objecttype = 9 and t_state = 0 and fininstr.t_fiid = -1 and rownum = 1) as x11," +
                 "        (select fininstr.t_name From dfininstr_dbt fininstr where fininstr.t_fiid=-1) as x12," +
                 "        (select fininstr2.t_fi_code From dfininstr_dbt fininstr, dfininstr_dbt fininstr2 where fininstr.t_fiid=-1 and fininstr.t_facevaluefi=fininstr2.t_fiid) as x13," +
                 "        0 as x14," +
                 "        (select decode(party.t_legalform, 2, 'ФЛ', 'ЮЛ') from dparty_dbt party WHERE Party.T_PARTYID = tick.T_CLIENTID ) as x17, " +
                 "        (select party.t_nrcountry from dparty_dbt party WHERE Party.T_PARTYID = tick.T_CLIENTID ) as x18, " +
                 "        (select decode(party.t_notresident, chr(0), 'является', 'не является') from dparty_dbt party WHERE Party.T_PARTYID = tick.T_CLIENTID ) as x19, " +
                 "        NVL((select decode(t_state, 1, 'является', 'не является') from dv_scqinvhist sih where sih.t_partyid = tick.T_CLIENTID and sih.T_BEGDATE <= tick.T_DealDATE and (sih.T_ENDDATE >= tick.t_DealDate or sih.T_ENDDATE = to_date('01.01.0001', 'DD.MM.YYYY'))),'не является') as x20, " +
                 "        NVL((select oa.t_name from ddlcontrmp_dbt dcm, dobjatcor_dbt oac, dobjattr_dbt oa                                       " +
                 "              where dcm.t_sfcontrid = tick.T_CLIENTCONTRID                                                                    " +
                 "                and oa.t_objecttype = 207 and oa.t_groupid = 103                                                                " +
                 "                and oac.t_objecttype = oa.t_objecttype and oac.t_groupid = oa.t_groupid                                         " +
                 "                and oac.t_object = lpad(dcm.t_dlcontrid, 34, '0') and oa.t_attrid = oac.t_attrid                                " +
                 "                and oac.t_validfromdate <= tick.t_DealDate and oac.t_validtodate >= tick.t_DealDate and rownum = 1),chr(1)) as x21, " +
                 "        (select oa.t_name from ddlcontrmp_dbt dcm, dobjattr_dbt oa where dcm.t_sfcontrid = tick.T_CLIENTCONTRID and oa.t_objecttype = 659 and oa.t_groupid = 1 and dcm.t_role = oa.t_attrid) as x23, " +
                 "        NVL((SELECT t_margin FROM ddvdlturn_dbt t WHERE t.t_dealid = tick.t_DealID and t_Date = ( SELECT MAX(m.t_Date) FROM DDVDLTURN_DBT m WHERE m.t_DealID = tick.t_DealID and m.t_Date <= tick.t_DealDate)),0) as x30, " +
                 "        (SELECT nvl(sum(t_sum),0) from ddvdlcom_dbt dvdlcom where dvdlcom.t_dealid = tick.t_DealID) as comis," +
                 "        '' as y1, " +
                 "        '' as y2, " +
                 "        '' as y3, " +
                 "        '' as y4, " +
                 "        '' as y5_swift, " +
                 "        '' as y5_inn, " +
                 "        (select party_nr.t_notresident from dparty_dbt party_nr WHERE Party_nr.T_PARTYID = tick.t_ClientContrID ) as y5_notres, " +
                 "        '' as y6, " +
                 "        tick.t_closedate as y7, " +
                 "        '' as y8, " +
                 "        '' as y9, " +
                 "        '' as y10, " +
                 "        '' as y11, " +
                 "        '' as y12, " +
                 "        '' as y13, " +
                 "        '' as y14, " +
                 "        '' as y15, " +
                 "        '' as y16, " +
                 "        '' as y17, " +
                 "        '' as y18, " +
                 "        '' as y19, " +
                 "        '' as y20, " +
                 "        '' as y21, " +
                 "        '' as y22, " +
                 "        '' as y23, " +
                 "        '' as y24, " +
                 "        '' as y25, " +
                 "        '' as y26, " +
                 "        '' as y27, " +
                 "        '' as y28, " +
                 "        to_date('01010001','DDMMYYYY') as y29, " +
                 "        0 as y30, " +
                 "        '' as y31 ";
       end;

       private macro DealWhereSelect_BO()
          return " WHERE ContrFI.T_FIID        = tick.t_PFI " +
                 "   and leg.t_DealID          = tick.T_DealID " +
                 "   and leg.t_legID           = 0 "+
                 "   and leg.t_PFI             = tick.t_PFI" +
                 "   and tick.t_originid      != 0" +  //GAA:   495685
                 //"   and leg.t_LegKind         = " + LEG_KIND_DL_TICK +
                 "   and tick.T_DealDate >= " + GetSQLDate( Data.dateMin ) +
                 "   and tick.T_DealDate <= " + GetSQLDate( Data.dateMax );
       end;

       private macro DealAddWhere_BO()
          var RetVal = "";
        
          if( Data.DprtID and (Data.DprtID != UNDF )  )
             RetVal = RetVal + " and tick.T_DEPARTMENT = " + String( Data.DprtID );
          end;
     
          if( Data.DealStatus != DVDEAL_UNDEF)
             if( Data.DealStatus != DVDEAL_OPEN )
                RetVal = RetVal + " and tick.T_DealStatus = " + DL_READIED;
             else 
                RetVal = RetVal + " and tick.T_DealStatus = " + DL_CLOSED;
             end;
          else
             RetVal = RetVal + " and tick.T_DealStatus <> 0 ";
          end;

          /* Если надо уставливаем условие по ПИ*/
          if( Data.DVFIID and ( Data.DVFIID != UNDF ) )
             RetVal = RetVal + " and tick.t_PFI = " + String( Data.DVFIID );
          end;

          /* Если надо уставливаем условие по эмитенту*/
          if( Data.EmiID and ( Data.EmiID != UNDF ) )
             RetVal = RetVal + " and ContrFI.T_ISSUER = " + String( Data.EmiID );
          end;

          /* Устанавливаем фильтр по контрактору */
          if( Data.ContractorID and ( Data.ContractorID != UNDF ) )
             RetVal = RetVal + " and (case when tick.t_BrokerID > 0 then tick.t_BrokerID else ContrFI.T_ISSUER end) = " + String( Data.ContractorID );
          end;

          /* Если надо уставливаем условие базому активу*/
       /*   if( Data.BaseFIID and (Data.BaseFIID != UNDF ) )
             RetVal = RetVal + " and DECODE(BaseFI1.T_FI_KIND, 4, BaseFI1.T_FACEVALUEFI, ContrFI.T_FACEVALUEFI) = " + String( Data.BaseFIID );
          end;*/

         /*имеющие признак ПФИ*/
         RetVal = RetVal + " and tick.t_IsPFI = chr(88) ";
         /*Покупка/Продажа(не РЕПО)*/
         RetVal = RetVal + " and Rsb_Secur.IsRepo(Rsb_Secur.get_OperationGroupDocKind(Rsb_Secur.get_OperSysTypes(tick.t_DealType, tick.t_BofficeKind), tick.t_BofficeKind)) != 1 "+
                           " and tick.t_BofficeKind = " + DL_SECURITYDOC;
         return RetVal;
       end;

       private macro ПолучитьСделки_БО(IsClientDeals:bool, IsOurDeals:bool)
          
         if ( IsClientDeals )
            if ( IsOurDeals )
               DVQuery = DVQuery + "(";
            end;

            DVQuery = DVQuery + DealHeadSelect_BO() +
                              " FROM ddl_tick_dbt tick,  ddl_leg_dbt leg, dfininstr_dbt ContrFI, dparty_dbt party" +
                              DealWhereSelect_BO() +
                              " and tick.t_ClientID <> -1" +
                              " and party.t_PartyID = tick.t_ClientID" +
                              DealAddWhere_BO();

            if( IsForm == 1 )
                  DVQuery = DVQuery + " and party.T_LegalForm = " + string(FormSub) ;
            elif( IsForm == 2 )
                  DVQuery = DVQuery + " and party.T_LegalForm <> " + string(FormSub);
            end;

            if( IsVid == 1 )
                  DVQuery = DVQuery + " and EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + string(VidSub) + " and party.T_PARTYID = Pto.T_PARTYID)";
            elif(IsVid == 2)
                  DVQuery = DVQuery + " and not EXISTS (select 1 from dpartyown_dbt Pto where Pto.T_PARTYKIND = " + string(VidSub) + " and party.T_PARTYID = Pto.T_PARTYID)";
            end;

            if( CharFlag_7 )
               DVQuery = DVQuery + " and party.t_NotResident = 'X'";
            end;

            if( Data.ClientID and (Data.ClientID != UNDF) )
               DVQuery = DVQuery + " and tick.T_CLIENTID = " + String( Data.ClientID );
            end;
         end;
           
         if( IsOurDeals )
            if( IsClientDeals and (DVQuery != "") )
                DVQuery = DVQuery + " union all ";
            end;
      
            DVQuery = DVQuery + DealHeadSelect_BO() +
                                " FROM  ddl_tick_dbt tick, ddl_leg_dbt leg, dfininstr_dbt ContrFI" +
                                DealWhereSelect_BO() +
                                "    and tick.T_CLIENTID = -1" +
                                DealAddWhere_BO();

            if( (IsClientDeals) and (DVQuery != "") )
                 DVQuery = DVQuery + ")";
            end;
      
         elif( (not IsClientDeals) and (DVQuery != "") )
             DVQuery = DVQuery + " and 0 = 1";
         end;
         
          
      end;
       // ----------- КОНЕЦ - Вспомогательные методы для БО ЦБ -------------- 
       var NRec = 0, NrecData;

       DVQuery = "";
   
       if ( byDV ) // Фиссико
          if( Data.IsMarket and ((Data.DVFIKindID == -1)or(Data.DVFIKindID == 0)or(Data.DVFIKindID == 1)) and Data.ByDV_Der == SET_CHAR )
            ПолучитьБиржевыеСделки_DV(IsClientDeals, IsOurDeals);
       end;

       if( Data.IsOutMarket and (Data.DVFIKindID != 0) )
          if( DVQuery != "" )
             DVQuery = DVQuery + " union all ";
          end;
            ПолучитьВнеБиржевыеСделки_DV(IsClientDeals, IsOurDeals);
         end;

       end;

       if ( byBO ) // БО ЦБ
         if ( DVQuery != "" )
            DVQuery = DVQuery + " union all ";
         end;
         ПолучитьСделки_БО(IsClientDeals, IsOurDeals);
       end;

       if ( DVQuery == "" )
         return 0;
       end;

       /* Уставливаем Нужную сортировку для последующего вывода*/
       if( Data.DprtID and (Data.DprtID == UNDF ) )
           if(Data.IsSeparatelyDate == true)
              DVQuery = DVQuery + " ORDER BY T_DEPARTMENT, 39/*T_DATE*/, IsOutMark, DealType, T_CLIENT, T_TIME, T_ID, T_TYPE_NFI2, T_ID ";
           else
              DVQuery = DVQuery + " ORDER BY T_DEPARTMENT, IsOutMark, DealType, T_CLIENT, 39/*T_DATE*/, T_TIME, T_ID, T_TYPE_NFI2, T_ID ";
           end;
           IsDprtSort = true;
       else
           if(Data.IsSeparatelyDate == true)
              DVQuery = DVQuery + " ORDER BY 39/*T_DATE*/, IsOutMark, DealType, T_CLIENT, T_TIME, T_ID, T_TYPE_NFI2, T_ID ";
           else
           DVQuery = DVQuery + " ORDER BY IsOutMark, DealType, T_CLIENT, 39/*T_DATE*/, T_TIME, T_ID, T_TYPE_NFI2, T_ID ";
           end;
           IsDprtSort = false;
       end;

setoutput("..\\txtfile\\kot_pfidealrep.txt",false);
println(DVQuery);
setoutput();

       RsdDVQuery = RSdCommand(DVQuery);
       RsdDVQuery.NullConversion = true;
       RsdDVQuery.execute();
                                                                                                                       
       File_DVDeal = TRsbDataSet(RsdDVQuery);
     
       NrecData = TRsbDataSet("select count(1) NRec from ("+DVQuery+")");
     
       if( NrecData.MoveNext() )
          NRec = int(NrecData.NRec);
       end;
       File_DVDeal_NRec = NRec;
       return NRec;
     END;

    PRIVATE VAR IsNewDprt = true;
    PRIVATE VAR OldDprt = 0;         /*новый ли филиал*/
    PRIVATE VAR IsOldClientDeals = false;
    PRIVATE VAR IsOldOurDeals = false;
    
    MACRO ПечатьОтчета(Data)
    
      var hasRow = File_DVDeal.MoveNext();
      
      var spground = TRecHandler( "spground.dbt" );
      var KindOper = "";  
      var FI = ПроизводныйИнструмент();
      var OldDate = Date(0,0,0);
      var IsPrintFooter = false;
      var IsOutMark = not File_DVDeal.IsOutMark, FI_Code = "", StrikeFI = "", PriceFIID = "", Price = $0.;
      var OutMarketEx = "", RejDate = Date(0,0,0), SpgrNum = "", SpgrKind = "", SpgrDate = Date(0,0,0);
      var DealTime, PayFIID;
      var opr = TBFile("oprkoper.dbt");
      var IsPrintTableHeader = true;
      var curRec = 0;

      if(GetDialogFlag())
         InitProgress(File_DVDeal_NRec, "Отчет \"Реестр ВУ сделок ПФИ\"", "Просмотр данных ..."); 
      end;

      var lastCLIENTCONTR = -100;
      var Rest = $0;
      var RestPlan = $0;

      while( hasRow )
         IsClientDeals = IIF(File_DVDeal.Client > 0, true, false);
         IsOurDeals = IIF(File_DVDeal.Client > 0, false, true);
          
         if( IsDprtSort )
            /*Если новый филиал взводим-сбрасываем флаги*/
            if( ( not IsNewDprt ) and ( OldDprt != File_DVDeal.Department ) )
               IsNewDprt = true;
               IsOutMark = not File_DVDeal.IsOutMark;//-1;
            end;
            
            /*Если новый филиал печатаем соотвествующие заголовки*/
            if( IsNewDprt )
               IsOutMark = not File_DVDeal.IsOutMark;
               EndReportTab();
               if(IsPrintFooter)
                  PrintFooter();
                  IsPrintFooter = false;
               end;
               UseNewSheetInTotalBook();
               CB_GetDepartmentCodeAndName( int(File_DVDeal.DEPARTMENT), null, DepartmentName );
               
               if(Data.IsSeparatelyDate == false)
                  PrintReportHead( Data,null );
               end;

               OldDprt = File_DVDeal.Department;
               IsNewDprt = false;
               OldDate = Date(0,0,0);
            end; 
         else
            if(IsNewDprt)
               EndReportTab();
               if(IsPrintFooter)
                   PrintFooter();
                   IsPrintFooter = false;
               end;
               UseNewSheetInTotalBook();
               CB_GetDepartmentCodeAndName( int(File_DVDeal.DEPARTMENT), null, DepartmentName );
               if(Data.IsSeparatelyDate == false)
                   PrintReportHead( Data,null );
               end;
               IsNewDprt = false;
            end;
         end;

         //if( (Data.IsSeparatelyDate == true) and (OldDate != SQL_ConvTypeDate(File_DVDeal.Date)) )
         if( (Data.IsSeparatelyDate == true) and (OldDate != SQL_ConvTypeDate(File_DVDeal.OrderRegDate)) )
            EndReportTab();
            //PrintReportHead( Data,SQL_ConvTypeDate(File_DVDeal.Date) );
            PrintReportHead( Data,SQL_ConvTypeDate(File_DVDeal.OrderRegDate) );
            PrintDealKindHead( File_DVDeal.IsOutMark );
            PrintTableHeaderWithDepartment(File_DVDeal.IsOutMark);
            IsOutMark = File_DVDeal.IsOutMark;
            //OldDate = SQL_ConvTypeDate(File_DVDeal.Date);
            OldDate = SQL_ConvTypeDate(File_DVDeal.OrderRegDate);
            IsPrintFooter = true;
            IsPrintTableHeader = false;
            IsOldOurDeals = false;
            IsOldClientDeals = false;
         else
            IsPrintTableHeader = true;
         end;

         if( IsOutMark != File_DVDeal.IsOutMark )
            EndReportTab();
            if(IsPrintTableHeader)
                PrintDealKindHead( File_DVDeal.IsOutMark );
                PrintTableHeaderWithDepartment( File_DVDeal.IsOutMark );
            end;
            IsOutMark = File_DVDeal.IsOutMark;
            IsOldClientDeals = false;
            IsOldOurDeals = false;
         end;

         /*печатаем голову Собственных сделок*/
         if( (IsOldOurDeals != IsOurDeals) and IsOurDeals and (not File_DVDeal.ClientName) )
            PrintClientAndOurDeals(false, IsOutMark);
            IsOldOurDeals = IsOurDeals;
         end;
             
         /*печатаем голову Клиентских сделок*/
         if( (IsOldClientDeals != IsClientDeals) and IsClientDeals and File_DVDeal.ClientName)
            PrintClientAndOurDeals(true, IsOutMark);
            IsOldClientDeals = IsClientDeals;
         end;

         spground.Clear();
         SpgrNum = "";
         SpgrKind = "";
         SpgrDate = Date(0,0,0);
         Price = $0.;

         DealTime = Time(File_DVDeal.Time);
         
         if( File_DVDeal.IsOutMark ) /*внебиржевые*/
            if( (File_DVDeal.Kind == ALG_DV_BUY) or (File_DVDeal.Kind == ALG_DV_BS) )
               KindOper = "Покупка";
            elif( (File_DVDeal.Kind == ALG_DV_SALE) or (File_DVDeal.Kind == ALG_DV_SB) )
               KindOper = "Продажа";
            else
               KindOper = DL_GetNameAlg(ALG_DV_KINDDVDEAL, File_DVDeal.Kind);
            end;

            FI_Code = File_DVDeal.FI_CODE+" "+OptionStyle(File_DVDeal.OPTIONSTYLE);

            /*выводится или договор купли\продажи или распорядительная расписка*/
            if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, File_DVDeal.DocKind, 26, File_DVDeal.Date ) )
               SpgrKind = "договор";
               SpgrDate = spground.rec.REGISTRDATE;
               SpgrNum  = spground.rec.XLD;
            elif( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, File_DVDeal.DocKind, 27 ) )
               SpgrKind = "расп.зап";
               SpgrDate = spground.rec.REGISTRDATE;
               SpgrNum  = spground.rec.XLD;
            end;

            /*выводится инфа об отказе или исполнении (что-то одно из двух)*/
            OutMarketEx = "";
            var OUTMarketDate = date(0, 0, 0);
            if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, File_DVDeal.DocKind, 324 ) )
               OutMarketEx = "отк. ";
               OutMarketDate = spground.rec.RegistrDate;
            end;

            if( (OutMarketEx == "") AND (File_DVDeal.State == DVDEAL_CLOSE) and (SQL_ConvTypeDate(File_DVDeal.ExecDate) != date(0,0,0)) )
               OutMarketEx = "исп. ";
               OutMarketDate = SQL_ConvTypeDate(File_DVDeal.ExecDate);
            end;

            Price = File_DVDeal.Price;
         else/*биржевые*/
            FI.Init(File_DVDeal.FIID);
            KindOper = GetKindOper(File_DVDeal.Kind);
            if( KindOper == "Исполнение" )
               KindOper = KindOper + " " + "\n" + File_DVDeal.Position;
            end;
            FI_Code = File_DVDeal.FI_CODE;                          
            /*выводится вид документа отчет*/
            if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, File_DVDeal.DocKind, 25 ) )
               SpgrKind = "отчет";
               SpgrDate = spground.rec.REGISTRDATE;
               SpgrNum  = spground.rec.XLD;
            end;
            // KS 28.03.2019 Цена за единицу
            Price = File_DVDeal.Price;
//            if ( /*IP_SEC*/14 == File_DVDeal.IDENTPROGRAM )
//               Price = File_DVDeal.Price; 
//            else
//               Price = File_DVDeal.Price * File_DVDeal.Amount;
//            end;
         end;
                                                       
         if( File_DVDeal.STRIKEFIID == -10 )
            StrikeFI = "Пункт(ов)";
         elif( File_DVDeal.Strike > $0. )
            if(File_DVDeal.STRIKEFIID==NATCUR)
               StrikeFI = Data.CCA_NatCUR;
            else
               StrikeFI = GetCCY(File_DVDeal.STRIKEFIID);
            end;
         else
            StrikeFI = "";
         end;

         if( File_DVDeal.PriceFIID == -10 )
            PriceFIID = "Пункт(ов)";
         elif( File_DVDeal.Price > $0. )
            if(File_DVDeal.PriceFIID==NATCUR)
               PriceFIID = Data.CCA_NatCUR;
            else
               PriceFIID = GetCCY(File_DVDeal.PriceFIID);
            end;
         else
            PriceFIID = "";
         end;

         PayFIID = PriceFIID;

         // KS 10.06.2019
         var query_applcode = "Select utl_raw.cast_to_varchar2(t_text) AS ApplCode from dnotetext_dbt t where t_notekind=101 and t_documentid in (lpad('" + string(File_DVDeal.ID) + "',34,'0')) and t_objecttype = 140";

         var ApplRSDQuery = RSdCommand(query_applcode);
         ApplRSDQuery.execute();
         
         var ApplDataSet = TRsbDataSet( ApplRSDQuery );
         var ApplCode = "";
         if((ApplDataSet.MoveNext()) and (Trim(SQL_ConvTypeStr(ApplDataSet.ApplCode)) != ""))
           ApplCode = Trim(SQL_ConvTypeStr(ApplDataSet.ApplCode));
         end;

         if(File_DVDeal.OrderNum == UNDF)
           File_DVDeal.OrderNum = "";
         end;

         var MethodCalc:string = "";
         if( File_DVDeal.Settlement_Code == DVSETTLEMET_STATE )
            MethodCalc = "Поставка";
         end;
         if( IsNetting(File_DVDeal.DocKind, File_DVDeal.DealID) )
            MethodCalc = MethodCalc + " неттинг";
         end;

         var RestQuery;
         var RestDataSet;
         if (lastCLIENTCONTR != File_DVDeal.CLIENTCONTR) // Не будем выполнять один и тот же запрос несколько раз
           if (IsOurDeals)
               // Определим счет, на котором консолидировался остаток на 01.01.2019.
               RestQuery = RSdCommand( "select t_account            " +
                                       "  From dmcaccdoc_dbt t      " +
                                       " where t.t_catnum = 536     " +
                                       "   and t_iscommon = chr(88) " +
                                       "   and rsb_account.restac(t_account, t_currency, to_date('01012019', 'DDMMYYYY'), t_chapter, 0, 0) != 0");
               RestDataSet = TRsbDataSet( RestQuery );
               RestQuery.execute();

               if(RestDataSet.MoveNext()) // Определим остаток на этом счёте. Считаем, что счёт один
                 RestQuery = RSdCommand( "select rsb_account.restac(t_account, acc.t_code_currency," + GetSQLDate( Data.dateMin ) + ", acc.t_chapter, 0, 0)*decode(acc.t_kind_account, 'А', -1, 1) rest, " +
                                         "       rsb_account.restac(t_account, acc.t_code_currency," + GetSQLDate( Data.dateMax ) + ", acc.t_chapter, 0, 0)*decode(acc.t_kind_account, 'А', -1, 1) restPlan " +
                                         "  from daccount_dbt acc                             " +
                                         " where acc.t_account ='" + RestDataSet.account + "' " +
                                         "   and acc.t_chapter = 21");
               else
                 RestQuery = "select 0 rest, 0 restPlan from dual";
               end;
           else
               RestQuery = RSdCommand( "select rsb_account.restac(ac.t_account,ac.t_code_currency," + GetSQLDate( Data.dateMin ) + ",ac.t_chapter,0) rest, " +
                                       "       rsb_account.restac(ac.t_account,ac.t_code_currency," + GetSQLDate( Data.dateMax ) + ",ac.t_chapter,0) restPlan " +
                                       "  from DSFCONTR_DBT   SF, DACCOUNT_DBT   AC, DSETTACC_DBT   SA, DSFSSI_DBT     SI                            " +
                                       " where SF.T_ID = " + File_DVDeal.CLIENTCONTR + "                                                             " +
                                       "   AND SF.T_SERVKIND = 15                                                                                    " +
                                       "   AND SI.T_OBJECTTYPE = 659                                                                                 " +
                                       "   AND SI.T_OBJECTID = LPAD(SF.T_ID, 10, '0')                                                                " +
                                       "   AND SA.T_SETTACCID = SI.T_SETACCID                                                                        " +
                                       "   AND AC.T_ACCOUNT = SA.T_ACCOUNT                                                                           " +
                                       "   AND AC.T_CHAPTER = SA.T_CHAPTER                                                                           " +
                                       "   AND AC.T_CODE_CURRENCY = SA.T_FIID                                                                        " +
                                       "   AND AC.T_BALANCE IN ('30601', '30606');                                                                   ");
           end;

           RestDataSet = TRsbDataSet( RestQuery );
           RestQuery.execute();
         
           if(RestDataSet.MoveNext())
             Rest     = RestDataSet.rest;
             RestPlan = RestDataSet.restPlan;
           else
             Rest = $0;
             RestPlan = $0;
           end;
           lastCLIENTCONTR = File_DVDeal.CLIENTCONTR;
         end;
       /*
       
         PrintTableString(string(File_DVDeal.Code),
                          SQL_ConvTypeDate(File_DVDeal.Date),
                          DealTime,
                          IIF(File_DVDeal.IsOutMark, "вне биржи", File_DVDeal.IssuerName),
                          IIF(File_DVDeal.IsOutMark, "", IIF(File_DVDeal.Broker > 0, "брокер " + File_DVDeal.BrokerName, "")),
                          IIF(File_DVDeal.IsOutMark, "", string(File_DVDEAL.ExtCode) ),
                          KindOper,
                          IIF(File_DVDeal.ClientName, File_DVDeal.ClientName, ""),
                          IIF(File_DVDeal.ContrName, File_DVDeal.ContrName, ""),
                          SQL_ConvTypeStr(File_DVDeal.OrderNum),
                          SQL_ConvTypeDATE(File_DVDeal.OrderRegDate),
                          ApplCode,
                          IIF(File_DVDeal.AgrCode, File_DVDeal.AgrCode, ""),
                          IIF(File_DVDeal.SfContrNumber, File_DVDeal.SfContrNumber, ""),
                          File_DVDeal.DVFIKind + " " + OptionType(File_DVDeal.OptionType) + IIF(File_DVDeal.OptionType, ЭтоВстроенныйПФИ(File_DVDeal.ID) , ""),
                          FI_Code,
                          File_DVDeal.ExecType,
                          MethodCalc,
                          IIF(File_DVDeal.Strike>$0.,File_DVDeal.Strike,""),
                          IIF(File_DVDeal.Strike>$0.,StrikeFI,""),
                          Price,
                          PriceFIID,
                          File_DVDeal.Amount,
                          File_DVDeal.BaseAmount,
                          File_DVDeal.Cost,   //24
                          IIF(14/*IP_SEC*/==File_DVDeal, "", File_DVDeal.BAFIID), 
                          PayFIID,
                          OutMarketEx,
                          IIF(File_DVDeal.IsOutMark, OutMarketDate, "")
                         );
       */

         PrintTableString(string(File_DVDeal.Code),
                          // SQL_ConvTypeDate(File_DVDeal.Date),
                          iif( File_DVDeal.DocKind = OBJTYPE_SECDEAL, SQL_ConvTypeDate(File_DVDeal.Date),SQL_ConvTypeDATE(File_DVDeal.OrderRegDate)), // KS 19.04.2019 Берём правильную дату //GAA: 495962 В сделках в БОЦБ брать дату из сделки (иначе дата не заполнялась)
                          DealTime,
//                          IIF(File_DVDeal.IsOutMark, "вне биржи", File_DVDeal.IssuerName),
                          File_DVDeal.IssuerName,
                          IIF(File_DVDeal.IsOutMark, File_DVDeal.AgrCode, IIF(File_DVDeal.Broker > 0, "брокер " + File_DVDeal.BrokerName, "")),
                          IIF((isClientDeals) or (not File_DVDeal.IsOutMark), string(File_DVDEAL.ExtCode), string(File_DVDeal.Code)),
                          KindOper,
                          IIF(File_DVDeal.ClientName, File_DVDeal.ClientName, ""),
                          IIF(File_DVDeal.ContrName, File_DVDeal.ContrName, ""),
                          SQL_ConvTypeStr(File_DVDeal.OrderNum),
                          SQL_ConvTypeDATE(File_DVDeal.OrderRegDate),
                          ApplCode,
                          IIF(File_DVDeal.AgrCode, File_DVDeal.AgrCode, ""),
                          IIF(isClientDeals, IIF(File_DVDeal.SfContrNumber, File_DVDeal.SfContrNumber, ""), File_DVDeal.AgrCode),
                          File_DVDeal.DVFIKind + " " + OptionType(File_DVDeal.OptionType),
                          FI_Code,
                          File_DVDeal.ExecType,
                          MethodCalc,
                          IIF(File_DVDeal.Strike>$0.,string(money(File_DVDeal.Strike)),""),
                          IIF(File_DVDeal.Strike>$0.,StrikeFI,""),
                          Price,
                          PriceFIID,
                          File_DVDeal.Amount,
                          File_DVDeal.BaseAmount,
                          File_DVDeal.Cost,
                          File_DVDeal.BAFIID,
                          PayFIID,
                          OutMarketEx,
                          IIF(File_DVDeal.IsOutMark, OutMarketDate, ""),
                          "_",
                          "_",
                          "АО \"Россельхозбанк\"",
                          "",
                          IIF(isClientDeals,"БАНК НКЦ (АО)",""),
                          File_DVDeal.x6,
                          IIF(isClientDeals,"Брокерская",""),
                          File_DVDeal.x7_1,
                          ApplCode,
                          File_DVDeal.x9,
                          File_DVDeal.x10,
                          File_DVDeal.x11,
                          File_DVDeal.x12,
                          File_DVDeal.x13,
                          IIF(File_DVDeal.x14>$0.,string(money(File_DVDeal.x14)),""),
                          File_DVDeal.BAFIID,
                          IIF(isClientDeals or (not File_DVDeal.IsOutMark),"Отчет \"Срочный рынок Московской Биржи\" за " + fixdate(SQL_ConvTypeDate(File_DVDeal.Date)),""),
                          IIF(isClientDeals,File_DVDeal.x17,""),
                          IIF(isClientDeals,File_DVDeal.x18,""),
                          IIF(isClientDeals,File_DVDeal.x19,""),
                          IIF(isClientDeals,File_DVDeal.x20,""),
                          IIF(isClientDeals,File_DVDeal.x21,""),
                          "предпоставка",
                          iif(isOurDeals,"от своего имени и за свой счет",File_DVDeal.x23),
                          SQL_ConvTypeDATE(File_DVDeal.OrderRegDate),
                          "ПФИ",
                          IIF(isClientDeals,"право предоставлено", ""),
                          string(money(Rest)),
                          string(money(RestPlan)),
                          File_DVDeal.BAFIID,
                          IIF(isClientDeals or (not File_DVDeal.IsOutMark),
                            IIF(File_DVDeal.x30<0, string(money(-File_DVDeal.x30+File_DVDeal.comis)), IIF(File_DVDeal.comis == 0, "", string(File_DVDeal.comis))),
                            IIF(((File_DVDeal.x9=="SELL") and (File_DVDeal.OptionType!=1))or((File_DVDeal.x9=="BUY") and (File_DVDeal.OptionType==1)),
                                File_DVDeal.BaseAmount, File_DVDeal.Cost)),
                          IIF(isClientDeals or (not File_DVDeal.IsOutMark),
                            IIF(File_DVDeal.x9=="SELL", File_DVDeal.Amount, ""), //31
                            ""),
                          IIF(isClientDeals or (not File_DVDeal.IsOutMark),
                            IIF(File_DVDeal.x30<0, "", string(money(File_DVDeal.x30))),
                            IIF(((File_DVDeal.x9=="SELL") and (File_DVDeal.OptionType!=1))or((File_DVDeal.x9=="BUY") and (File_DVDeal.OptionType==1)),
                                File_DVDeal.Cost, File_DVDeal.BaseAmount)),
                          IIF(isClientDeals or (not File_DVDeal.IsOutMark),
                            IIF(File_DVDeal.x9=="SELL", "", File_DVDeal.Amount), //33
                            ""),
                          "да",
                          IIF(index(File_DVDeal.y1,":")>0,substr(File_DVDeal.y1,index(File_DVDeal.y1,":")+1,strlen(File_DVDeal.y1)-index(File_DVDeal.y1,":")),File_DVDeal.y1),
                          File_DVDeal.y2,
                          File_DVDeal.y3,
                          File_DVDeal.ContrName,
                          IIF(File_DVDeal.y5_notres,File_DVDeal.y5_swift,File_DVDeal.y5_inn),
                          File_DVDeal.y6,
                          SQL_ConvTypeDATE(File_DVDeal.ExecDate),
                          File_DVDeal.y8,
                          File_DVDeal.Exectype,
                          "0",
                          SQL_ConvTypeDATE(IIF(not(((File_DVDeal.x9=="SELL") and (File_DVDeal.OptionType!=1))or((File_DVDeal.x9=="BUY") and (File_DVDeal.OptionType==1))),File_DVDeal.y11,File_DVDeal.y12)),
                          SQL_ConvTypeDATE(IIF(    ((File_DVDeal.x9=="SELL") and (File_DVDeal.OptionType!=1))or((File_DVDeal.x9=="BUY") and (File_DVDeal.OptionType==1)) ,File_DVDeal.y11,File_DVDeal.y12)),
                          "Автоматически",
                          SQL_ConvTypeDATE(File_DVDeal.OrderRegDate), // KS 19.04.2019 Берём правильную дату
                          DealTime,
                          SQL_ConvTypeDATE(File_DVDeal.OrderRegDate),
                          "программно-техническими средствами автоматически",
                          iif(isOurDeals,"от своего имени и за свой счет",""), //18
                          File_DVDeal.y19,
                          IIF(SQL_ConvTypeStr(File_DVDeal.y19)=="","","ММВБ"),
                          IIF(SQL_ConvTypeStr(File_DVDeal.y19)=="","","валютного и тованого рынка"),
                          IIF(SQL_ConvTypeStr(File_DVDeal.y19)=="","","основной"),
                          "нет",
                          File_DVDeal.y24,
                          File_DVDeal.y25,
                          File_DVDeal.y26,
                          OptionType(File_DVDeal.OptionType),
                          File_DVDeal.y28,
                          SQL_ConvTypeDATE(File_DVDeal.y29),
                          File_DVDeal.y30,
                          IIF(File_DVDeal.OptionType==0,"",PriceFIID),
                          (isClientDeals or (not File_DVDeal.IsOutMark))
                         );

         IsPrintFooter = true;
         
         curRec = curRec + 1;   
         if(GetDialogFlag())    
            UseProgress(curRec);
         end;                   
         hasRow = File_DVDeal.MoveNext();
      end;
      if(GetDialogFlag())
         RemProgress();  
      end;               

      EndReportTab();
    END;

    MACRO Create()
       var Count = 0;

       var Data = SourceData(DprtID, byDV, byDV_Der, byDV_Cur, byBO ,IsClientDeals, IsOurDeals, BaseFIKind, BaseFIID, DVFIKindID, EmiID, DVFIID, ClientID, IsMarket,
                             ContractorID, IsOutMarket, dateMin, dateMax, IsSeparatelyDate, DealStatus, IsApp, IsExcel );

       if( (Data.dateMin == Date(0,0,0)) and (Data.dateMax == Date(0,0,0)) )
         return;
       end;

       Dl_CallInsertStat( IIF( IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );

       if(   byBO  or  ((Data.IsMarket or Data.IsOutMarket) and (Data.IsClientDeals or Data.IsOurDeals)) )
          var stat = ПолучитьСделки(Data, Data.IsClientDeals, Data.IsOurDeals);
          if( stat != 0 )
            ПечатьОтчета(Data);
          end;

          if ( (not Data.IsExcel) and (stat == 0))
             PrintLn("\nНе найдено данных для формирования отчета.");
          elif(stat == 0)
             MsgBox( "Не найдено данных для формирования отчета.");
          else
             PrintFooter();
          end;
       end;
    end;

    initDL_CReportTemplate( NULL, TemplName, true, NULL, NULL, POI_MODE );
END;

PRIVATE CLASS (DL_CReportTemplate) PFIDeals_Report2(TemplName, _DprtID:integer,
                                                                  _isOurDeals:bool,
                                                                  _IsClientDeals:bool,
                                                                  _ClientID:integer,
                                                                  _IsForm:integer,
                                                                  _FormSub:integer,
                                                                  _IsVid:integer,
                                                                  _VidSub:integer,
                                                                  _CharFlag_7:bool,
                                                                  _IsMarket:bool,
                                                                  _ContractorID:integer,
                                                                  _IsOutMarket:bool,
                                                                  _BaseFIKind:integer,
                                                                  _BaseFIID:integer,
                                                                  _DVFIKindID:integer,
                                                                  _EmiID:integer,
                                                                  _DVFIID:integer,
                                                                  _dateMin:date, _dateMax:date,
                                                                  _IsSeparatelyDate:bool,
                                                                  _DealStatus:integer,
                                                                  _IsApp:bool,
                                                                  _IsExcel:bool)

    initDL_CReportTemplate( NULL, TemplName );
end;

/*
Собственные сделки - сделки, где клиент/договор не указан, т.е. сделка совершается в интересах нашего банка;
брокерские сделки -указан клиент и договор, где подвид обслуживания - не доверительное управление;
доверительное управление -  указан клиент и договор, где подвид обслуживания - доверительное управление.
*/
MACRO ReportRun( _DprtID:integer,
                 _ByDV:bool,
                 _ByDV_Der:bool,
                 _ByDV_Cur:bool,
                 _ByBO:bool,
                 _isOurDeals:bool,
                 _IsClientDeals:bool,
                 _ClientID:integer,
                 _IsForm:integer,
                 _FormSub:integer,
                 _IsVid:integer,
                 _VidSub:integer,
                 _CharFlag_7:bool,
                 _IsMarket:bool,
                 _ContractorID:integer,
                 _IsOutMarket:bool,
                 //_ByDV:bool,
                 //_ByVA:bool,
                 _BaseFIKind:integer,
                 _BaseFIID:integer,
                 _DVFIKindID:integer,
                 _EmiID:integer,
                 _DVFIID:integer,
                 //_AvrIssuerID:integer,
                 //_DealType:integer, 
                 _dateMin:date, _dateMax:date,
                 _IsSeparatelyDate:bool,
                 _DealStatus:integer,
                 _IsApp:bool,
                 _IsExcel:bool )

   PFIDeals_Report("Report_PFIDEALSvu15.xls", _DprtID,
                                          _ByDV,
                                          _ByDV_Der,
                                          _ByDV_Cur,
                                          _ByBO,
                                          _isOurDeals,
                                          _IsClientDeals,
                                          _ClientID,
                                          _IsForm,
                                          _FormSub,
                                          _IsVid,
                                          _VidSub,
                                          _CharFlag_7,
                                          _IsMarket,
                                          _ContractorID,
                                          _IsOutMarket,
                                          _BaseFIKind,
                                          _BaseFIID,
                                          _DVFIKindID,
                                          _EmiID,
                                          _DVFIID,
                                          _dateMin, _dateMax,
                                          _IsSeparatelyDate,
                                          _DealStatus,
                                          _IsApp,
                                          _IsExcel).Run();
END;

//---------------------------------------------------------------------------------
//  Макропроцедура зовется перед появлением панели PFIDEALS (Реестр ВУ сделок ПФИ).
//  Обработка панели происходит в закрытом коде (сишник), поэтому здесь в открытом коде 
//  реализована возможность установить пользовательские значения полей.
//  Описание параметра TRecHanler находиться в словаре FMT: dpfideals_rec  
//
MACRO initPFIDealsPanel(rec:TRecHandler): bool   
/*
   rec.rec.department     = "1";          // Филиал
   rec.rec.byDV           = "X";          // ФиссиКО   */
   rec.rec.byBO           = "";          // ЮО ЦБ
/*   rec.rec.OurDeals       = "X";          // Сделки за свой счет   GAA:495685 
   rec.rec.ClientDeals    = "X";          // Сделки за счет клиента
   rec.rec.client         = "ММВБ";       // Клиент
   rec.rec.condEnityForm  = "=";          // Форма субъекта (условие)
   rec.rec.entityForm     = 1;            // Форма субъекта
   rec.rec.condEntityKind = "!";          // Вид субъекта (условие)
   rec.rec.entityKind     = 1;            // Вид субъекта
   rec.rec.isNonresident  = "X";          // Нерезидент
   rec.rec.IsMarket       = "X";          // Операции с биржевыми ПФИ
   rec.rec.contr          = "НРД";        // КА по расчетам
   rec.rec.isOutMkt       = "X";          // Прочие ПФИ
   rec.rec.baseFiKind     = 1;            // Вид исходного актива
   rec.rec.baseFI         = "810";        // Исходный актив (код)
   rec.rec.contractKind   = 3;            // Вид контракта
   rec.rec.issuer         = "РТС";        // Эмитент
   rec.rec.contractID     = 262;          // Код контракта (ID)
   rec.rec.conclStart     = {curdate}-1;  // Интервал дат заключения
   rec.rec.conclEnd       = {curdate};    // Интервал дат заключения
   rec.rec.separDate      = "X";          // Признак завершенности сделки
   rec.rec.dealStatus     = DVDEAL_UNDEF; // -1(DVDEAL_UNDEF)-Все, 2(DVDEAL_CLOSE)-Завершенные, 1(DVDEAL_OPEN)-Незавершенные
   rec.rec.apostrophe     = "";           // С апострофами
   rec.rec.repExcel       = "X";          // Отчет в Excel
   */

   //
   //  Если хотим чтобы изменения были применимы к панели, возвращаем true, иначе - false.
   //
   return true/*false*/; // !!!GAA:495685 
END;