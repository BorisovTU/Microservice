/*
$Name:        dvsw205.mac
$Module:      ФИСС и КО
$Description: Процентный СВОП. Шаг: Ожидание неттинга/квитовки Неттинга ПП
*/
import "dvOperSt.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var Payment:RsbPayment;
  var PaymentID:integer = 0;
  var ДатаИсполненияШага:date;

  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);

  if( GetOprStatus(DV_OPERSTATUS_KIND_KVIT_PMGR) == DV_OPERSTATUS_PAYM_EX )
     ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step); 
     if( (DV_FindPaymentID(DocKind, ndeal.ID, PM_PURP_INTERIM, 0, ДатаИсполненияШага, @PaymentID) == true) and (PaymentID > 0) )
        Payment = RsbPayment(PaymentID);
        if( ПИ_ИсполнениеПлатежаНаШагеОжидания(FD, Payment) != 0 )
           return 1;
        end;
     else
        MsgBox("Не найден платеж промежуточного платежа.");
        return 1;
     end;

     if( not InsertOprStatus( DV_OPERSTATUS_KIND_KVIT_PMGR, DV_OPERSTATUS_DOC_CLOSE) )
        MsgBox("Ошибка при установке статуса <Квитовка/неттинг результирующего ПП> по операции.");
        return 1;
     end;
  end;

  return 0;
end;
