/*
$Name:        dvnop030.mac
$Module:      Производные инструменты
$Description: Внебиржевая операция. Шаг: Признание ПФИ
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac", "dvserv.mac", "dv_grfun.mac";

PRIVATE VAR ДатаИсполненияШага:date;


macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  
  record ndeal(dvndeal);
  var FrVal = TRecHandler("dvnfrval");
  var FD, FD_2,DebAcc,CredAcc;
  var Ground,ИспользоватьВыбытие:bool = false;
  var Bonus:money = 0.0;

  SetBuff( ndeal, FDoc );    
  ДатаИсполненияШага = ndeal.Date;
  FD = DVFirstDocNDeal(DocKind, ndeal);
  if( FD.IsSWAP() or FD.IsPctSWAP() )
     FD_2 = DVFirstDocNDeal(DocKind, ndeal, 2);
  end;
  //mda 27.02.2019 Если через сервиску введена певоначалка СС
  if ( FD.ВыполненаПереоценкаСС( ДатаИсполненияШага, FrVal ) )
    MsgBox("В сделку уже введена первичная справедливая стоимость: "+FD.GetLastFrValSum()+" RUB.");
    return 0;
  end;
  IIF( StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL",Ground = FD.GetGround(7) ,Ground="Учет справедливой стоимости при первоначальном признании по сделке "+FD.DealCode());
  
  if( FD.IsOption() ) 
     if( not DV_SmartConvertSumDbl(Bonus, FD.Deal.rec.Bonus, ДатаИсполненияШага, FD.Deal.rec.BonusFIID, NATCUR) )
        MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(FD.Deal.rec.BonusFIID)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        return 1;
     end;

  if( (not FD.IsClient()) and (FD.Deal.rec.IsPFI == SET_CHAR) and ( (FD.IsOption()) or (FD.nFI_BaseActiv.rec.FairValueAlg > 0)  /*not FD.ВалютныйРынок()*/) )
     /* Если в таблице DDVNFRVAL_DBT нет записи по сделке за дату заключения  */
     if( not FD.ВыполненаПереоценкаСС( ДатаИсполненияШага, FrVal ) )
        FrVal.rec.DealID       = ndeal.Id;
        FrVal.rec.DocKind      = ndeal.DocKind;
        FrVal.rec.Date         = ДатаИсполненияШага;
        FrVal.rec.FairValueAlg = FD.nFI_BaseActiv.rec.FairValueAlg;
        FrVal.rec.FairValue    = IIF( FD.IsBuy(), Bonus, -Bonus);
        if( DV_InsFrValPanel(FrVal) == 0 )
           if( DV_InsertFrVal(FrVal) != 0 )
              MsgBox("Ошибка при вставке записи оценки справедливой стоимости.");
              return 1;
           end;
        else
           return 1;
        end;
        if(РАБОТА_С_РЕПОЗИТАРИЕМ() and (GetSettingMessageSendingMode() != 3) ) 
           if( InsertGrDealFairValueRevaluation(FD, ДатаИсполненияШага, DocKind) != 0 )
              MsgBox("Ошибка вставки строки графика \"Переоценка справедливой стоимости\"");
              return 1;
           end;
        end;
  end;
    end;

  if( FD.IsClient() == false )
    if( FD.IsBuy() )
      if( FrVal.rec.FairValue > Bonus )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "+ПФИ", "Доходы ПФИ",
                                           ДатаИсполненияШага, 1,
                                           NATCUR, (FrVal.rec.FairValue - Bonus),
                                           doc,
                                           INPCARRY,"", "",
                                           Ground,//"Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                           NULL,
                                           FIROLE_UNDEF, FIROLE_UNDEF
                                           )
          )
           return 1;
        end;
      elif( FrVal.rec.FairValue < Bonus )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "Расходы ПФИ", "+ПФИ",
                                           ДатаИсполненияШага, 1,
                                           NATCUR, (Bonus - FrVal.rec.FairValue),
                                           doc,
                                           INPCARRY,"", "",
                                           Ground,//"Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                           NULL,
                                           FIROLE_UNDEF, FIROLE_UNDEF
                                           )
          )
           return 1;
        end;
      end;
    elif( FD.IsSale() )
      if( abs(FrVal.rec.FairValue) > Bonus )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "Расходы ПФИ", "-ПФИ",
                                            ДатаИсполненияШага, 1,
                                            NATCUR, (abs(FrVal.rec.FairValue) - Bonus),
                                            doc,
                                            INPCARRY,"", "",
                                            Ground,//"Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                            NULL,
                                            FIROLE_UNDEF, FIROLE_UNDEF
                                            )
          )
            return 1;
        end;
      elif( abs(FrVal.rec.FairValue) < Bonus )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "-ПФИ", "Доходы ПФИ",
                                           ДатаИсполненияШага, 1,
                                           NATCUR, (Bonus - abs(FrVal.rec.FairValue)),
                                           doc,
                                           INPCARRY,"", "",
                                           Ground,//"Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                           NULL,
                                           FIROLE_UNDEF, FIROLE_UNDEF
                                           )
          )
          return 1;
        end;
      end;
    end;
  end;
  else /*mda 20.02.19 Тут остальные сделки : форварды, свопы, проц свопы*/
    if( FrVal.rec.FairValue > 0 )
      DebAcc  = "+ПФИ";
      CredAcc = IIF(ИспользоватьВыбытие, "Выбытие ПФИ", "Доходы ПФИ");
    elif( FrVal.rec.FairValue < 0 )
      DebAcc  = IIF(ИспользоватьВыбытие, "Выбытие ПФИ", "Расходы ПФИ");
      CredAcc = "-ПФИ";
    end;
    if( not ПроводкаПоКатегориямУчета( FD,
          DebAcc, CredAcc,
          ДатаИсполненияШага, 1,
          NATCUR, abs(FrVal.rec.FairValue),
          doc,
          INPCARRY, "", "",
          Ground//"Учет справедливой стоимости при первоначальном признании"
                                      )
    )
      return 1;
    end;
  end;

  return 0;
end;
