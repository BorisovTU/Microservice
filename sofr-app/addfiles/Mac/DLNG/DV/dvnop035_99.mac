/*
$Name:        dvnop035.mac
$Module:      Производные инструменты
$Description: Процентный СВОП. Шаг: Исполнение (2 часть)
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

PRIVATE MACRO IsDealReady( FD )
   var RetVal = false;
   var Query, Data, Sql;

   Sql = " SELECT count(1) as CountStep " +
         "   FROM doprstep_dbt step, doproper_dbt oper " +
         "  WHERE oper.t_DocKind      = ? AND " +
         "        oper.t_DocumentID   = ? AND " +
         "        step.t_ID_Operation = oper.t_ID_Operation AND " +
         "        step.t_IsExecute   != chr(88) ";

   Query = RSDCommand( Sql );
   Query.addParam("", RSDBP_IN, FD.Kind );
   Query.addParam("", RSDBP_IN, UniID(FD.Deal, OBJTYPE_OUTOPER_DV) );
   Query.execute();

   Data = TRsbDataSet(Query);
   if( Data.MoveNext() and (SQL_ConvTypeInteger(Data.CountStep) == 1) )
      RetVal = true;
   end;

   return RetVal;
END;

private macro GetRestNATCURAcc(acc,ondate)
  var sql,rs,rest = 0;
  sql = "SELECT rsb_account.restac('"+acc.rec.account+"',"+acc.rec.code_currency+",to_date('"+date(ondate)+"','dd.mm.yyyy'),"+acc.rec.chapter+",null,"+NATCUR+") FROM dual";
  rs = ExecSqlSelect(sql);
  if (rs.MoveNext())
    rest = rs.value(0);
  end;
  return rest;
end;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var FD,currency,categ,RestAcc;
  var ДатаИсполненияШага:date, Netting:bool = false;
  var ДатаВведеннойОперации:date = date();
  var Счет = TRecHandler("account");
  var sql = "", DataSet, fd_Close_account, rest; /*PNV 493273****/  
  var ДатаДляПроверкиОстатка2:date;

  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal(DocKind, ndeal, 2);
  GetOprDate( DV_NDEAL_OPRDATE_EXEC_2, ДатаИсполненияШага );
  GetOprDate( DV_NDEAL_OPRDATE_PAYM_L, ДатаДляПроверкиОстатка2 );
  /*if (FD.ПоставочныйКонтракт())
    if  (FD.ВалютаОбязательства() == NATCUR) 
      categ = ПИ_КатегорияПлФорвардРПИ();
      currency = FD.ВалютаТребования();
    elif (FD.ВалютаТребования() == NATCUR)
      categ = ПИ_КатегорияМнФорвардРПИ();
      currency = FD.ВалютаОбязательства();
    else
      categ = ПИ_КатегорияПлФорвардРПИ();
      currency = FD.ВалютаТребования();
    end;    
  else
    categ = "Выбытие ПФИ";
    currency = NATCUR;
  end;

  if( FD.IsExistAccount( categ, null, true, FIROLE_UNDEF, Счет, null, ДатаИсполненияШага, currency ) )
      RestAcc = GetRestNATCURAcc(Счет,ДатаИсполненияШага);
      if( RestAcc > 0 )
        if (FD.ПоставочныйКонтракт())
          if( not ПроводкаПоКатегориямУчета( FD,
                                                Счет,                              /* Деб */
                                                 "Доходы ПФИ", /* Кредит */
                                                ДатаИсполненияШага,                      /* Дата */
                                                1,                                       /* Глава */
                                                NATCUR,                                  /* Валюта */
                                                ABS( RestAcc ),                          /* Сумма */
                                                Doc,                                     /* Документ */
                                                INPCARRY,                                /* Result_Carry */
                                                "",                                      /* Kind_Oper */
                                                "",                                      /* Numb_Document */
                                                "Отнесение фин. рез-а на доходы по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/"),//"Отнесение фин. результата на доходы",   /* Ground */
                                                null,
                                                null, null, null, null, null, null, null, null, null, null, null, null, null, null
                                                ,true
                                              )
               )
                 return 1;
             end;
          else
            if( not ПроводкаПоКатегориямУчета( FD,
                                                Счет,                              /* Деб */
                                                 "Доходы ПФИ", /* Кредит */
                                                ДатаИсполненияШага,                      /* Дата */
                                                1,                                       /* Глава */
                                                NATCUR,                                  /* Валюта */
                                                ABS( RestAcc ),                          /* Сумма */
                                                Doc,                                     /* Документ */
                                                INPCARRY,                                /* Result_Carry */
                                                "",                                      /* Kind_Oper */
                                                "",                                      /* Numb_Document */
                                                "Отнесение фин. рез-а на доходы по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/"),//"Отнесение фин. результата на доходы",   /* Ground */
                                                null,
                                                null, null
                                              )
               )
                 return 1;
             end;
          end;
        elif( RestAcc < 0 )
          if (FD.ПоставочныйКонтракт())
           if( not ПроводкаПоКатегориямУчета( FD,
                                              "Расходы ПФИ", /* Деб */
                                              Счет,                              /* Кредит */
                                              ДатаИсполненияШага,                      /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              ABS( RestAcc ),                          /* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              "Отнесение фин. рез-а на расходы по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/"),//"Отнесение фин. результата на расходы",  /* Ground */
                                              null,
                                                null, null, null, null, null, null, null, null, null, null, null, null, null, null
                                                ,false
                                            )
             )
               return 1;
           end;

          else
            if( not ПроводкаПоКатегориямУчета( FD,
                                              "Расходы ПФИ", /* Деб */
                                              Счет,                              /* Кредит */
                                              ДатаИсполненияШага,                      /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              ABS( RestAcc ),                          /* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              "Отнесение фин. рез-а на расходы по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/"),//"Отнесение фин. результата на расходы",  /* Ground */
                                              null,
                                              null, null
                                            )
             )
               return 1;
           end;
        end;
  end;
end;
*/
  if( IsDealReady(FD) == false )
     MsgBox( "Шаг не может быть выполнен. Остальные шаги операции должны иметь статуc \"Выполнен\"." );
     return 1;
  end;
  /*PNV 493273****/  
  if( ПИ_ЗакрыватьСчетаПоСделке() )
      sql = RSDCommand( " select distinct categ.t_code, accdoc.t_account, accdoc.t_currency, accdoc.t_chapter, accdoc.t_firole " +
                        " from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, daccount_dbt acc  " +
                        " where accdoc.t_dockind = ? " +
                        "   and accdoc.t_docid = ? " +
                        "   and accdoc.t_catid = categ.t_id " +
                        "   and categ.t_updatemode = 0 " +
                        "   and ( ( ( DBMS_LOB.SUBSTR(accdoc.t_account, 5, 1) in('61601','52601','52602')) " +  
                        "        or (DBMS_LOB.SUBSTR(accdoc.t_account, 3, 1) in('933','934','939','940','963','964','969','970')) )" + 
                        "       )"
                        "   and ACC.T_ACCOUNT = accdoc.t_account "+
                        "   and ACC.T_CODE_CURRENCY =  accdoc.t_currency "+          
                        "   and ACC.T_OPEN_CLOSE = CHR(0) "                     
                      );
      sql.addParam("", RSDBP_IN, FD.Kind);
      sql.addParam("", RSDBP_IN, FD.ID);
      DataSet = TRsbDataSet(sql);
      while( DataSet.MoveNext() )
             rest = abs(RestA(DataSet.account, /*{curdate}*/IIF((substr(DataSet.account, 1, 3) == "526") OR (substr(DataSet.account, 1, 3) == "933"), ДатаДляПроверкиОстатка2, ДатаИсполненияШага), NULL, DataSet.chapter, DataSet.currency)) +
                        abs(RestA(DataSet.account, date(31,12,9999), NULL, DataSet.chapter, DataSet.currency));

             if( rest > 0 )
                 MsgBox("Не нулевой остаток на счете " + DataSet.account);
                 return 1;
             elif( MC_FindAndCloseAccount(DataSet.code, fd, /*{curdate}*/ДатаИсполненияШага, DataSet.firole, DataSet.currency, MC_ACC_CLOSE_INDIVIDUAL) )
                 MsgBox("Невозможно закрыть счет " + DataSet.account);
                 //return 1;
             end;
      end;
      /*PNV MC_FindAndCloseAccount закрывает только действующие счета по сделке. Нужно закрыть НЕ действующие*/
      sql = RSDCommand( " select distinct categ.t_code, accdoc.t_account, accdoc.t_currency, accdoc.t_chapter, accdoc.t_firole " +
                        " from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, daccount_dbt acc " +
                        " where accdoc.t_dockind = ? " +
                        "   and accdoc.t_docid = ? " +
                        "   and accdoc.t_catid = categ.t_id " +
                        "   and categ.t_updatemode = 0 " +
                        "   and DBMS_LOB.SUBSTR(accdoc.t_account, 3, 1) in('933','934','939','940','963','964','969','970') " + 
                        "   and ACCDOC.T_ISUSABLE <> chr(88) "
                        "   and ACC.T_ACCOUNT = accdoc.t_account "+
                        "   and ACC.T_CODE_CURRENCY =  accdoc.t_currency "+          
                        "   and ACC.T_OPEN_CLOSE = CHR(0) "                     
                     );
      sql.addParam("", RSDBP_IN, FD.Kind);
      sql.addParam("", RSDBP_IN, FD.ID);
      DataSet = TRsbDataSet(sql);
      while( DataSet.MoveNext() )
             rest = abs(RestA(DataSet.account, /*{curdate}*/ДатаИсполненияШага, NULL, DataSet.chapter, DataSet.currency)) +
                        abs(RestA(DataSet.account, date(31,12,9999), NULL, DataSet.chapter, DataSet.currency));

             if( rest > 0 )
                 MsgBox("Не нулевой остаток на счете " + DataSet.account);
                 return 1;
             elif( CB_CloseAccount(DataSet.Chapter, DataSet.currency, DataSet.Account, ДатаИсполненияШага))
                 MsgBox("Невозможно закрыть счет " + DataSet.account);
                 //return 1;
             end;
      end;
      /*PNV а теперь те, которые открыты по графику, а не по сделке*/
      sql = RSDCommand( " select distinct categ.t_code, accdoc.t_account, accdoc.t_currency, accdoc.t_chapter, accdoc.t_firole, accdoc.t_docid " +
                        " from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, daccount_dbt acc " +
                        " where accdoc.t_dockind = ? " +
                        "   and accdoc.t_docid in ( select t_id from DDVNPMGR_DBT where t_dealid = ? ) " +
                        "   and accdoc.t_catid = categ.t_id " +
                        "   and categ.t_updatemode = 0 " +
                        "   and DBMS_LOB.SUBSTR(accdoc.t_account, 3, 1) in('933','934','939','940','963','964','969','970')" + 
                        "   and ACC.T_ACCOUNT = accdoc.t_account "+
                        "   and ACC.T_CODE_CURRENCY =  accdoc.t_currency "+          
                        "   and ACC.T_OPEN_CLOSE = CHR(0) "                     
                       );

      sql.addParam("", RSDBP_IN, DL_DVNDEALPMGR);
      sql.addParam("", RSDBP_IN, FD.ID);
      DataSet = TRsbDataSet(sql);
      while( DataSet.MoveNext() )
             fd_Close_account = DVFirstDocPmGr(DL_DVNDEALPMGR, SQL_ConvTypeInteger(DataSet.docid));

             rest = abs(RestA(DataSet.account, /*{curdate}*/ДатаИсполненияШага, NULL, DataSet.chapter, DataSet.currency)) +
                        abs(RestA(DataSet.account, date(31,12,9999), NULL, DataSet.chapter, DataSet.currency));

             if( rest > 0 )
                 MsgBox("Не нулевой остаток на счете " + DataSet.account);
                 return 1;
             elif( CB_CloseAccount(DataSet.Chapter, DataSet.currency, DataSet.Account, ДатаИсполненияШага))
                 MsgBox("Невозможно закрыть счет " + DataSet.account);
                 //return 1;
             end;
      end;
  end;
  /*PNV 493273****/

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DOC(), DV_OPERSTATUS_DOC_CLOSE) )
        MsgBox("Ошибка при установке статуса <Документооборот> по операции.");
        return 1;
  end;
  if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_ED(), DV_OPERSTATUS_DOC_CLOSE) )
     MsgBox("Ошибка при установке статуса <Исполнение> по операции.");
     return 1;
  end;


  return 0;
end;
