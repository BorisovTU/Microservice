/*
$Name:        dv_carchng.mac
$Module:      Производные инструменты
$Description: Изменение состояния обязательств
*/
import "dv_car.mac";

macro ИзменениеСостоянияОбязательств_ДосрочноеИсполнение(FD, dat, DocKind)
    var requestTimeout = 0;
//    GetRegistryValue("РЕПОЗИТАРИЙ\\СРОК ОЖИД.ЗАПР. ПРИ КОМБ.ПОДТВ.", V_INTEGER, requestTimeout, null);
    var ОжиданиеЗапроса = false;
    var repozdeal = TBFile("dl_repozdeal.dbt", "R", 1);
    repozdeal.Clear();
    repozdeal.rec.DocKind = DocKind;
    repozdeal.rec.DocID   = FD.deal.rec.ID;
    if( GetEQ(repozdeal) )
      if( (repozdeal.rec.INITIATOR == 2) and    (repozdeal.rec.METHOD_WAYTWOWAY == 1))
        ОжиданиеЗапроса = true;
        requestTimeout = repozdeal.rec.requestTimeout;
      end;
      if(repozdeal.rec.reporting == UNSET_CHAR)  //если флаг репортинг в репозитарий не установлен
        return 0;
      end;

    end;

    if( ОжиданиеЗапроса and requestTimeout)
      if( DL_UpdateGrDealAcc( DocKind, FD.deal.rec.ID, -1, DLGR_TEMPL_CLOSECONTRWTHREQUEST, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
        return 1;
      end;

      if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID,  DLGR_TEMPL_EARLYEXECMSGWTHREQUEST, GetDateAfterWorkDays(dat, requestTimeout) , time(0,0,0), -1) != 0 )
        return 1;
      end;

    else
      if( DL_UpdateGrDealAcc( DocKind, FD.deal.rec.ID, -1, DLGR_TEMPL_CLOSECONTR, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
        return 1;
      end;

      if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID, DLGR_TEMPL_EARLYEXECMSG, dat, time(0,0,0), -1) != 0 )
        return 1;
      end;
    end;

    return 0;
end;

macro ИзменениеСостоянияОбязательств_ДосрочноеИсполнениеCПлатежами(FD, dat, DocKind)
    var requestTimeout = 0;
//    GetRegistryValue("РЕПОЗИТАРИЙ\\СРОК ОЖИД.ЗАПР. ПРИ КОМБ.ПОДТВ.", V_INTEGER, requestTimeout, null);
    var ОжиданиеЗапроса = false;
    var repozdeal = TBFile("dl_repozdeal.dbt", "R", 1);
    repozdeal.Clear();
    repozdeal.rec.DocKind = DocKind;
    repozdeal.rec.DocID   = FD.deal.rec.ID;
    if( GetEQ(repozdeal) )
      if( (repozdeal.rec.INITIATOR == 2) and (repozdeal.rec.METHOD_WAYTWOWAY == 1))
        ОжиданиеЗапроса = true;
        requestTimeout = repozdeal.rec.requestTimeout;
      end;
      if(repozdeal.rec.reporting == UNSET_CHAR)  //если флаг репортинг в репозитарий не установлен
        return 0;
      end;
    end;

    // В графике запланировано действие <Закрытие договора> или <Закрытие договора с ожиданием запроса>
    var ClosePAYM = TRecHandler( "pmpaym" );
    var CurPAYM   = TRecHandler( "pmpaym" );
    var SelectClose, DataSetClose, QueryClose;
    var cnt = 0;
    var MaxGrDate:date = date(31,12,9999);
    
    QueryClose = "select * from ddlgrdeal_dbt where t_DocKind = ? and t_DocID = ? and t_TemplNum in(" + DLGR_TEMPL_CLOSECONTR + "," + DLGR_TEMPL_CLOSECONTRWTHREQUEST + ") " ;
    SelectClose = DL_RSDCommand(QueryClose);
    SelectClose.AddParam(DocKind);
    SelectClose.AddParam(FD.deal.rec.ID);

    cnt = SelectClose.GetCount(QueryClose);     // если не запланировано закрытие договора, то ничего не вставляем
    if( cnt == 0 )
      return 0;
    end;

    var Select, DataSet, Query;
    Query  =  "SELECT * "
           +   "FROM dpmpaym_dbt "
           +   "WHERE     t_DocKind = ? "
              +  " AND t_DocumentID = ? "
              +  " AND t_purpose IN (1, 2) "
              +  " AND t_PaymStatus NOT IN (" + PM_CLOSED_W_M_MOVEMENT + ", " + PM_FINISHED + ") "
              +  " AND t_valuedate = "
                       +  " (SELECT MAX (paym.t_valuedate) "
                       +  " FROM dpmpaym_dbt paym "
                       +  " WHERE     paym.t_DocKind = ? "
                            +  "  AND paym.t_DocumentID = ? "
                            +  "  AND paym.t_purpose IN (1, 2) "
                            +  "  AND paym.t_PaymStatus NOT IN (" + PM_CLOSED_W_M_MOVEMENT + ", " + PM_FINISHED + ")) ";

    Select = DL_RSDCommand(Query);
    Select.AddParam(DocKind);
    Select.AddParam(FD.deal.rec.ID);
    Select.AddParam(DocKind);
    Select.AddParam(FD.deal.rec.ID);

    cnt = Select.GetCount(query);
    if( not (cnt == 1) )
      return 0;
    end;

    DataSet = Select.Execute();
    if(DataSet.moveNext())
      DataSet.GetRecord().CopyTo( ClosePAYM.rec );
    end;

    var SelectCur, DataSetCur, QueryCur;
    var Type = 0;
    if(FD.deal.rec.Type == 1)
      Type =  1;
    elif(FD.deal.rec.Type == 2)
      Type =  2;
    else
      return 0;
    end;

    QueryCur =  "SELECT * "
             +   "FROM dpmpaym_dbt "
             +   "WHERE t_DocKind = ? "
               +  " AND t_DocumentID = ? "
               +  " AND t_purpose = ? ";


    SelectCur = DL_RSDCommand(QueryCur);
    SelectCur.AddParam(DocKind);
    SelectCur.AddParam(FD.deal.rec.ID);
    SelectCur.AddParam(Type);

    DataSetCur = SelectCur.Execute();
    if(DataSetCur.moveNext())
      DataSetCur.GetRecord().CopyTo( CurPAYM.rec );
    end;
    if(ClosePAYM.rec.PaymentID == CurPAYM.rec.PaymentID )       // если изменения закрывающего ТО
      if(CurPAYM.rec.ValueDate == dat)            // если вовремя
        return 0;//ничего не вставляем
      end;
      if(CurPAYM.rec.ValueDate > dat)            // если досрочно
         if( ОжиданиеЗапроса and requestTimeout)
           if( DL_UpdateGrDealAcc( DocKind, FD.deal.rec.ID, -1, DLGR_TEMPL_CLOSECONTRWTHREQUEST, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
             return 1;
           end;

           if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID,  DLGR_TEMPL_EARLYEXECMSGWTHREQUEST, GetDateAfterWorkDays(dat, requestTimeout) , time(0,0,0), -1) != 0 )
             return 1;
           end;

         else
           if( DL_UpdateGrDealAcc( DocKind, FD.deal.rec.ID, -1, DLGR_TEMPL_CLOSECONTR, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
             return 1;
           end;

           if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID, DLGR_TEMPL_EARLYEXECMSG, dat, time(0,0,0), -1) != 0 )
             return 1;
           end;
         end;
      end;
    end;
    return 0;
end;

macro ИзменениеСостоянияОбязательств_ОтказИсполнения(FD, dat, DocKind)
    var requestTimeout = 0;
//    GetRegistryValue("РЕПОЗИТАРИЙ\\СРОК ОЖИД.ЗАПР. ПРИ КОМБ.ПОДТВ.", V_INTEGER, requestTimeout, null);
    var ОжиданиеЗапроса = false;
    var repozdeal = TBFile("dl_repozdeal.dbt", "R", 1);
    repozdeal.Clear();
    repozdeal.rec.DocKind = DocKind;
    repozdeal.rec.DocID   = FD.deal.rec.ID;
    if( GetEQ(repozdeal) )
      if( (repozdeal.rec.INITIATOR == 2) and (repozdeal.rec.METHOD_WAYTWOWAY == 1))
        ОжиданиеЗапроса = true;
        requestTimeout = repozdeal.rec.requestTimeout;
      end;
      if(repozdeal.rec.reporting == UNSET_CHAR)  //если флаг репортинг в репозитарий не установлен
        return 0;
      end;
    end;

    if( ОжиданиеЗапроса and requestTimeout)
      if( DL_UpdateGrDealAcc( DocKind, FD.deal.rec.ID, -1, DLGR_TEMPL_CLOSECONTRWTHREQUEST, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
        return 1;
      end;

      if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID,  DLGR_TEMPL_REJECTIONMSGWTHREQUEST, GetDateAfterWorkDays(dat, requestTimeout) , time(0,0,0), -1) != 0 )
        return 1;
      end;

    else
      if( DL_UpdateGrDealAcc( DocKind, FD.deal.rec.ID, -1, DLGR_TEMPL_CLOSECONTR, DLGR_ACCKIND_REPOSITORY, date(0,0,0), DLGRACC_STATE_NOTNEED ) != 0)
        return 1;
      end;

      if(DL_InsertGrDeal( DocKind, FD.deal.rec.ID, DLGR_TEMPL_REJECTIONMSG, dat, time(0,0,0), -1) != 0 )
        return 1;
      end;
    end;

    return 0;
end;
