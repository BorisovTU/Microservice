/*
$Name:         dv_ntglistrep.mac
$Module:       ФИСС и КО
$Description:  Отчет "Лист неттинга"
PROGRAMMED BY: Dubovoy A.A.
CREATION DATE: 20.02.16
*/
IMPORT "dv_ntglist_form.mac", "DLReport_h.mac", "dvserv.mac", "dvrepfun2.mac", "ws_txreportform.mac";

PRIVATE VAR   NtgList_Panel;
PRIVATE VAR   NtgList_Report;
PRIVATE VAR   WebMenuItem;              // Информация о запуске отчета из веб

PRIVATE CONST DVDEAL_OPEN = 1,
              DL_READIED = 10,          // Сделка готова (создана операция)
              UnknownParty = -1,
              DV_CURSWAP = 3,
              DV_PCTSWAP = 4,
              DV_FORWARD_T3 = 5,
              DEMAND = 1,               // Требование
              LEABILITY = 2,            // Обязательство
              DVPOS_OPEN = 1,
              DL_DVNDEAL = 199,         // Внебиржевая операции с ПИ
              //DL_DVFXDEAL = 4813;       // Конверсионная сделка ФИСС и КО
              FI_DVTYPE_PUT        = 1, /* Опцион put*/
              FI_DVTYPE_CALL       = 2, /* Опцион call*/
              DV_FX_TYPEDOC_BUY  = "B", // покупка (66)
              ALG_DV_BUY  = 1,          // Покупка
              ALG_DV_SALE = 2,          // Продажа
              PTK_MARKETPLASE = 3;      // Биржи

PRIVATE CLASS CRepData
   var CN:String;
   var CD:Double;
   var CL:Double;
   var CDT:Double;
   var CLT:Double;
   var CV:String;
   var CVF:String;
   var CVN:String;
   var CDS:Double;
   var CLS:Double;
   var CDTS:Double;
   var CLTS:Double;
   var CVS:String;
   var CVFS:String;
   var CVNS:String;
   var ND:Double;
   var NL:Double;
   var NV:String;
   var NVF:String;
   var NVN:String;
   var OpKindName:String;
   var IsOTC:Bool;
   var IsExchange:Bool;

   var PartyID:Integer;
   var Fiid:Integer;

   private macro Constructor()
      IsOTC = false;
      IsExchange = false;

      PartyID = -1;
      Fiid = -1;
     
      CD = 0;
      CL = 0;
      CDT = 0;
      CLT = 0;
      CDS = 0;
      CLS = 0;
      CDTS = 0;
      CLTS = 0;
      ND = 0;
      NL = 0;
   end;

   Constructor();
END;

private macro GetSQLFIN(table1, table2, table3)
   var sqlFIN = 
             " ( "
             "  CASE "
             "    WHEN " + table1 + ".t_FI_Kind IN (" + FIKIND_CURRENCY + "," + FIKIND_METAL + ") "
             "    THEN "
             "      " + table2 + ".t_ccy "   
             "    WHEN " + table1 + ".t_FI_Kind = " + FIKIND_AVOIRISS +
             "    THEN "
             "      CASE "
             "        WHEN " + table3 + ".t_ISIN != chr(1) "
             "        THEN "
             "          " + table3 + ".t_ISIN "
             "        WHEN " + table3 + ".t_LSIN != chr(1) "
             "        THEN "
             "          " + table3 + ".t_LSIN "
             "        ELSE "
             "          " + table2 + ".t_FI_Code "
             "      END "
             "    WHEN " + table1 + ".t_FI_Kind IN (" + FIKIND_INDEX + "," + FIKIND_DERIVATIVE + "," + FIKIND_ARTICLE + ") "
             "    THEN "
             "      " + table2 + ".t_FI_Code "
             "    ELSE "
             "      chr(1) "
             "  END "
             " ) ";

   return sqlFIN;
end;

PRIVATE CLASS (DL_CReportTemplate) DL_NtgList_Report( Form:DL_CPanel, TemplateName:STRING, UseCSV:BOOL, IsWebService:BOOL, ReportHashCode:INTEGER )
  private var m_IsExistsData = false,
              m_IsExistsPFIOpDataOTC = false, m_IsExistsPFIOpDataExch = false,
              m_IsExistsConvOpDataOTC = false, m_IsExistsConvOpDataExch = false,
              m_IsExistsFastOpDataOTC = false, m_IsExistsFastOpDataExch = false,
              m_IsExistsExchCurOpDataOTC = false, m_IsExistsExchCurOpDataExch = false,
              m_Prefix="N1_",
           m_ByPeriod = "за период", m_By = "по",
              m_SheetPFI = "Сделки ПФИ", m_SheetConv = "Конверсионные сделки", m_SheetFast = "Покупка продажа Т+3", m_SheetExchCur = "Биржевые сделки валютного рынка",
              m_MarketExchange = "Биржевой", m_MarketOTC = "Внебиржевой",
           m_OpKind = "Вид операции",
           m_ArLinesPFIOp, m_ArTotalPFIOp, m_ArNettoPFIOp,
           m_ArLinesConvOp, m_ArTotalConvOp, m_ArNettoConvOp,
           m_ArLinesFastOp, m_ArTotalFastOp, m_ArNettoFastOp,
              m_ArLinesExchCurOp, m_ArTotalExchCurOp, m_ArNettoExchCurOp,
           listpaym;

  MACRO PrintMode():INTEGER
     return DL_OUTREPORT_EXCEL;
  END;

  PRIVATE MACRO BeginReport()
     // Обновим данные из панели отчета
     NtgRepFormData.IsPFIOp     = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsPFIOp );
     NtgRepFormData.IsConvOp    = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsConvOp );
     NtgRepFormData.IsFastOp    = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsFastOp );
     NtgRepFormData.IsExchCurOp = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsExchCurOp );
     NtgRepFormData.IsExchange  = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsExchange );
     NtgRepFormData.IsOTC       = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsOTC );
     NtgRepFormData.Contractor  = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_Contractor );
     NtgRepFormData.OpKind      = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_OpKind );
     NtgRepFormData.FIKind      = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_FIKind );
     NtgRepFormData.FI          = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_FI );
     NtgRepFormData.DateBegin   = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_DateBegin );
     NtgRepFormData.DateEnd     = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_DateEnd );
     NtgRepFormData.IsSplit     = NtgList_Panel.GetFieldValue( PNFLD_NTGLISTREP_IsSplit );
     if( (NtgRepFormData.DateEnd != null)
     and (NtgRepFormData.DateEnd != Date(0,0,0)))
        NtgRepFormData.IsSetEndDate = true;
     end;

     CreateTotalBook();
  END;

  PRIVATE MACRO EndReport()
     SaveTotalBook();
  END;

  private macro GetPrefix(shName:String)
     var p = "";

     if( shName == m_SheetPFI )
        p = "N1_";
     elif( shName == m_SheetConv )
        p = "N2_";
     elif( shName == m_SheetFast )
        p = "N3_";
     elif( shName == m_SheetExchCur )
        p = "N4_";
     end;

     return p;
  end;

  private macro GetSheetName(prefix:String)
     var sheetName = "";

     if( prefix == "N1_" )
        sheetName = m_SheetPFI;
     elif( prefix == "N2_" )
        sheetName = m_SheetConv;
     elif( prefix == "N3_" )
        sheetName = m_SheetFast;
     elif( prefix == "N4_" )
        sheetName = m_SheetExchCur;
     end;

     return sheetName;
  end;

  PRIVATE MACRO PrintEndTable()
     var sheetName = GetSheetName( m_Prefix );
     EndTable();
     CopyAllSheetInTotalBook( sheetName, false, GetTableRange(), 0 );
  END;

  PRIVATE MACRO PrintReportHead()
     var sheetName = GetSheetName( m_Prefix );
  
     PrintFormatString( "",
                        m_Prefix + "A1_1", IIF(NtgRepFormData.IsSetEndDate == true, m_ByPeriod, ""),
                        m_Prefix + "A2",   NtgRepFormData.DateBegin,
                        m_Prefix + "A1_2", IIF(NtgRepFormData.IsSetEndDate == true, m_By, ""),
                        m_Prefix + "A1_3", IIF(NtgRepFormData.IsSetEndDate == true, NtgRepFormData.DateEnd, "")
                      );
     CopyAllSheetInTotalBook( sheetName, false, m_Prefix + "ReportHeader", 1 );
  END;

  PRIVATE MACRO PrintMarketHead(marketName:String)
     var sheetName = GetSheetName( m_Prefix );
  
     PrintFormatString( "",
                        m_Prefix + "A3", marketName
                      );
     CopyAllSheetInTotalBook( sheetName, false, m_Prefix + "MarketHead", 1 );
  END;

  PRIVATE MACRO PrintOpKindHead(OpKindName:String)
     var sheetName = GetSheetName( m_Prefix );
  
     PrintFormatString( "",
                        m_Prefix + "A4_1", m_OpKind,
                        m_Prefix + "A4_2", OpKindName
                      );
     CopyAllSheetInTotalBook( sheetName, false, m_Prefix + "OpKindHead", 0 );
  END;

  PRIVATE MACRO PrintMainTableHead()
     var sheetName = GetSheetName( m_Prefix );

     CopyAllSheetInTotalBook( sheetName, false, m_Prefix + "MainTableHead", 1 );

     if( (m_Prefix == "N1_") or (m_Prefix == "N3_") or (m_Prefix == "N4_") )
        RegisterTable( m_Prefix + "MainTableLine", "",
                       m_Prefix + "CN",
                       m_Prefix + "CD",
                       m_Prefix + "CL",    
                       m_Prefix + "CDT",
                       m_Prefix + "CLT",
                       m_Prefix + "CV",
                       m_Prefix + "CVF",
                       m_Prefix + "CVFV"
                     );
     elif( m_Prefix == "N2_" )
        RegisterTable( m_Prefix + "MainTableLine", "",
                       m_Prefix + "CN",
                       m_Prefix + "CD",
                       m_Prefix + "CL",    
                       m_Prefix + "CDT",
                       m_Prefix + "CLT",
                       m_Prefix + "CVF"
                     );
     end;
  END;

  PRIVATE MACRO PrintMainTableLine( CN, CD, CL, CDT, CLT, CV, CVF, CVFV)
     if( (m_Prefix == "N1_") or (m_Prefix == "N3_") or (m_Prefix == "N4_") )
        PrintTableLine( m_Prefix + "hidden1", "", null, // для отступа слева 1 ячейки
                        m_Prefix + "CN", CN, null,
                        m_Prefix + "CD", CD, null,
                        m_Prefix + "hidden2", "", null, // для объединенной ячейки
                        m_Prefix + "CL", CL, null,
                        m_Prefix + "CDT", CDT, null,
                        m_Prefix + "CLT", CLT, null,
                        m_Prefix + "CV", CV, null,
                        m_Prefix + "CVF", CVF, null,
                        m_Prefix + "CVFV", CVFV, null
                      );
     elif( m_Prefix == "N2_" )
        PrintTableLine( m_Prefix + "hidden1", "", null, // для отступа слева 1 ячейки
                        m_Prefix + "CN", CN, null,
                        m_Prefix + "CD", CD, null,
                        m_Prefix + "hidden2", "", null, // для объединенной ячейки
                        m_Prefix + "CL", CL, null,
                        m_Prefix + "CDT", CDT, null,
                        m_Prefix + "CLT", CLT, null,
                        m_Prefix + "CVF", CVF, null
                      );
     end;
  END;

  PRIVATE MACRO PrintTotalHead()
     var sheetName = GetSheetName( m_Prefix );

     CopyAllSheetInTotalBook( sheetName, false, m_Prefix + "TotalHead", 1 );

     if( (m_Prefix == "N1_") or (m_Prefix == "N3_") or (m_Prefix == "N4_") )
        RegisterTable( m_Prefix + "TotalLine", "",
                       m_Prefix + "CDS",
                       m_Prefix + "CLS",
                       m_Prefix + "CDTS",    
                       m_Prefix + "CLTS",
                       m_Prefix + "CVS",
                       m_Prefix + "CVFS",
                       m_Prefix + "CVNS"
                     );
     elif( m_Prefix == "N2_" )
        RegisterTable( m_Prefix + "TotalLine", "",
                       m_Prefix + "CDS",
                       m_Prefix + "CLS",
                       m_Prefix + "CDTS",    
                       m_Prefix + "CLTS",
                       m_Prefix + "CVFS"
                     );
     end;
  END;

  PRIVATE MACRO PrintTotalLine( CDS, CLS, CDTS, CLTS, CVS, CVFS, CVNS )
     var sheetName = GetSheetName( m_Prefix );

     if( (m_Prefix == "N1_") or (m_Prefix == "N3_") or (m_Prefix == "N4_") )
        PrintTableLine( m_Prefix + "hidden3", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden4", "", null, // для отступа слева ячейки
                        m_Prefix + "CDS", CDS, null,
                        m_Prefix + "hidden5", "", null, // для объединенной ячейки
                        m_Prefix + "CLS", CLS, null,
                        m_Prefix + "CDTS", CDTS, null,
                        m_Prefix + "CLTS", CLTS, null,
                        m_Prefix + "CVS", CVS, null,
                        m_Prefix + "CVFS", CVFS, null,
                        m_Prefix + "CVNS", CVNS, null
                      );
     elif( m_Prefix == "N2_" )
        PrintTableLine( m_Prefix + "hidden3", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden4", "", null, // для отступа слева ячейки
                        m_Prefix + "CDS", CDS, null,
                        m_Prefix + "hidden5", "", null, // для объединенной ячейки
                        m_Prefix + "CLS", CLS, null,
                        m_Prefix + "CDTS", CDTS, null,
                        m_Prefix + "CLTS", CLTS, null,
                        m_Prefix + "CVFS", CVFS, null
                      );
     end;
  END;

  PRIVATE MACRO PrintNettoHead()
     var sheetName = GetSheetName( m_Prefix );

     CopyAllSheetInTotalBook( sheetName, false, m_Prefix + "NettoHead", 1 );

     if( (m_Prefix == "N1_") or (m_Prefix == "N3_") or (m_Prefix == "N4_") )
        RegisterTable( m_Prefix + "NettoLine", "",
                       m_Prefix + "ND",
                       m_Prefix + "NL",
                       m_Prefix + "NV",    
                       m_Prefix + "NVF",
                       m_Prefix + "NVN"
                     );
     elif( m_Prefix == "N2_" )
        RegisterTable( m_Prefix + "NettoLine", "",
                       m_Prefix + "ND",
                       m_Prefix + "NL",
                       m_Prefix + "NVF"
                     );
     end;
  END;

  PRIVATE MACRO PrintNettoLine( ND, NL, NV, NVF, NVN )
     var sheetName = GetSheetName( m_Prefix );

     if( (m_Prefix == "N1_") or (m_Prefix == "N3_") or (m_Prefix == "N4_") )
        PrintTableLine( m_Prefix + "hidden6", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden7", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden8", "", null, // для отступа слева ячейки

                        m_Prefix + "hidden9", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden10", "", null, // для отступа слева ячейки
                        m_Prefix + "ND", ND, null,
                        m_Prefix + "NL", NL, null,
                        m_Prefix + "NV", NV, null,
                        m_Prefix + "NVF", NVF, null,
                        m_Prefix + "NVN", NVN, null
                      );
     elif( m_Prefix == "N2_" )
        PrintTableLine( m_Prefix + "hidden6", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden7", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden8", "", null, // для отступа слева ячейки

                        m_Prefix + "hidden9", "", null, // для отступа слева ячейки
                        m_Prefix + "hidden10", "", null, // для отступа слева ячейки
                        m_Prefix + "ND", ND, null,
                        m_Prefix + "NL", NL, null,
                        m_Prefix + "NVF", NVF, null
                      );
     end;
  END;


  /*Установить жирный шрифт для строки*/
  PRIVATE MACRO SetBoldFont(IsBold)
     var sheetName = GetSheetName( m_Prefix );
     SetCurrentLineFont(sheetName, IsBold, false); 
  END;

  PRIVATE MACRO GetVal(val)
     return IIF(val == 0, "", val);
  END;

  PRIVATE MACRO GetContrVal(curval, prevval)
     return IIF(curval == prevval, "", curval);
  END;

  PRIVATE MACRO ОчиститьДанные()
     m_ArLinesPFIOp = TArray(); m_ArTotalPFIOp = TArray(); m_ArNettoPFIOp = TArray();
    m_ArLinesConvOp = TArray(); m_ArTotalConvOp = TArray(); m_ArNettoConvOp = TArray();
    m_ArLinesFastOp = TArray(); m_ArTotalFastOp = TArray(); m_ArNettoFastOp = TArray();
     m_ArLinesExchCurOp = TArray(); m_ArTotalExchCurOp = TArray(); m_ArNettoExchCurOp = TArray();
  END;
  
  private macro GetSQLMarket(table, fld)
     var sql = 
     " (select 1 "
     "  from DPARTYOWN_DBT PARTYOWN "
     "  where PARTYOWN.T_PARTYID = " + table + "." + fld +
     "    and PARTYOWN.T_PARTYKIND = 3 " // Сделка считается внебиржевой, если контрагент по сделке не равен бирже
     " ) ";
   
     return sql;
  end;

  private macro GetSQLConvDeal()
     return " SELECT " + IIF(NtgRepFormData.IsSplit == "X", " Deal.t_Kind t_OpKind, ", "") +
            "        party.t_partyid, "
            "        paym.t_BaseAmount t_Amount, "
            "        paym.t_BaseFiid t_FIID, "
            "        fi2paym.t_FI_Kind, "
            "        (CASE WHEN paym.t_payer = " + {OurBank} + " THEN " + LEABILITY + " ELSE " + DEMAND + " END) t_Side "
            "   FROM dpmpaym_dbt paym, "
            "        dparty_dbt party, "
            "        ddvndeal_dbt Deal, "
            "        ddvnfi_dbt nFI, "
            "        dfininstr_dbt fi, "
            "        dfininstr_dbt fi2paym "
            "  WHERE Deal.t_ID = paym.t_documentid "
            "        and nFI.t_DealID = Deal.t_ID "
            "        and fi.t_FIID = nFI.t_FIID "
            "        and fi2paym.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")" +
            "        and fi2paym.t_FIID = paym.t_BaseFIID " +
            "        and paym.t_IsPlanPaym = chr(88) "
            "        and deal.t_dockind = paym.t_dockind "
            "        and Deal.t_DocKind = " + DL_DVFXDEAL   +
            "        and Deal.t_DVKind  = " + DV_FORWARD_FX +
            "        and Deal.t_Client < 0 "
            "        and Deal.t_State   = " + DVDEAL_OPEN   +
            "        and not exists( select acnt.t_AccountID " +
            "                          from daccount_dbt acnt " +
            "                         where acnt.t_account in(paym.t_payeraccount, paym.t_receiveraccount) " +
            "                           and acnt.t_chapter = paym.t_chapter " +
            "                           and acnt.t_code_currency = paym.t_fiid " +
            "                           and acnt.t_type_account like '%А%' ) " +
            "        and ((paym.t_payer = party.t_partyid)or(paym.t_receiver = party.t_partyid)) "
            "        and party.t_partyid <> " + {OurBank} +
            "        and ( (not exists " + GetSQLMarket("Deal", "t_contractor") + " and Deal.t_Sector != chr(88))" +
            "        or ( Deal.t_Sector != chr(88) and Deal.t_MarketKind = 0 ) )" +
                     // Фильтры панели отчета
            "        and ((paym.t_valuedate >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( paym.t_valuedate <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
            +        IIF(NtgRepFormData.Contractor != -1, (" and party.t_partyid = " + NtgRepFormData.Contractor), "")
            +        IIF(NtgRepFormData.OpKind     != -1, (" and Deal.t_Kind = "  + NtgRepFormData.OpKind), "")
            +        IIF(NtgRepFormData.FIKind != -1, (" and fi.t_FI_Kind = " + NtgRepFormData.FIKind), "")
            +        IIF(NtgRepFormData.FI != -1, (" and fi.t_FIID = " + NtgRepFormData.FI), "");
  end;

  private macro GetSQLDealT3( IsExchange, Avoiriss:bool )
     var sql =
               "             SELECT  "
               +                    IIF(NtgRepFormData.IsSplit == "X", " nDeal.t_Kind t_OpKind, ", "") +
               "                    party.t_partyid, "
               "                    paym.t_BaseAmount t_Amount, "
               "                    paym.t_BaseFiid t_Fiid, "
               "                    fi2paym.t_FI_Kind, "
               "                    (CASE WHEN paym.t_payer = " + {OurBank} + " THEN " + LEABILITY + " ELSE " + DEMAND + " END) t_Side "
               "             FROM "
               "                  dpmpaym_dbt paym, "
               "                  dparty_dbt party, "
               "                  ddvndeal_dbt nDeal, "
               "                  DDVNFI_DBT nFI, "
               "                  dfininstr_dbt fi, "
               "                  dfininstr_dbt fi2paym "
               "             WHERE "
               "                   nDeal.t_id = paym.t_documentid "
               "                   and nFI.t_DealID = nDeal.t_ID "
               "                   and nFI.t_Type = " + DV_NFIType_BaseActiv +
               "                   and fi.t_FIID = nFI.t_FIID  "
               "                   and fi2paym.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")" +
               "                   and fi2paym.t_FIID = paym.t_BaseFIID " +
               "                   and paym.t_IsPlanPaym = chr(88) "
               "                   and nDeal.t_Client < 0 "
               "                   and nDeal.t_State = " + DVDEAL_OPEN +
               "                   and ((paym.t_payer = party.t_partyid)or(paym.t_receiver = party.t_partyid))"
               "                   and party.t_partyid <> " + {OurBank} +
               "                   and nDeal.t_DVKind = " + DV_FORWARD_T3 +
               "                   and " + IIF(IsExchange == true, "", "not") + " exists " + GetSQLMarket("nDeal", "t_Contractor") +
               "                   and " + IIF(Avoiriss, " fi.t_FI_Kind = " + FIKIND_AVOIRISS, " fi.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")") +
                                   // Фильтры панели отчета
               "                   and ((paym.t_valuedate >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( paym.t_valuedate <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
               +                   IIF(NtgRepFormData.Contractor != -1, (" and party.t_partyid = " + NtgRepFormData.Contractor), "")
               +                   IIF(NtgRepFormData.OpKind != -1, (" and nDeal.t_Kind = " + NtgRepFormData.OpKind), "")
               +                   IIF(NtgRepFormData.FIKind != -1, (" and fi.t_FI_Kind = " + NtgRepFormData.FIKind), "")
               +                   IIF(NtgRepFormData.FI != -1, (" and fi.t_FIID = " + NtgRepFormData.FI), "");
     return sql;
  end;
  
  private macro GetSQLExchCurDeal()
     return " SELECT " + IIF(NtgRepFormData.IsSplit == "X", " Deal.t_Kind t_OpKind, ", "") +
            "        party.t_partyid, "
            "        paym.t_BaseAmount t_Amount, "
            "        paym.t_BaseFiid t_FIID, "
            "        fi2paym.t_FI_Kind, "
            "        (CASE WHEN paym.t_payer = " + {OurBank} + " THEN " + LEABILITY + " ELSE " + DEMAND + " END) t_Side "
            "   FROM dpmpaym_dbt paym, "
            "        dparty_dbt party, "
            "        ddvndeal_dbt Deal, "
            "        ddvnfi_dbt nFI, "
            "        dfininstr_dbt fi, "
            "        dfininstr_dbt fi2paym "
            "  WHERE Deal.t_ID = paym.t_documentid "
            "        and nFI.t_DealID = Deal.t_ID "
            "        and fi.t_FIID = nFI.t_FIID "
            "        and fi2paym.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")" +
            "        and fi2paym.t_FIID = paym.t_BaseFIID " +
            "        and paym.t_IsPlanPaym = chr(88) "
            "        and deal.t_dockind = paym.t_dockind "
            "        and Deal.t_DocKind = " + DL_DVFXDEAL   +
            "        and Deal.t_DVKind  = " + DV_FORWARD_FX +
            "        and Deal.t_Client < 0 "
            "        and not exists( select acnt.t_AccountID " +
            "                          from daccount_dbt acnt " +
            "                         where acnt.t_account in(paym.t_payeraccount, paym.t_receiveraccount) " +
            "                           and acnt.t_chapter = paym.t_chapter " +
            "                           and acnt.t_code_currency = paym.t_fiid " +
            "                           and acnt.t_type_account like '%А%' ) " +
            "        and ((paym.t_payer = party.t_partyid)or(paym.t_receiver = party.t_partyid)) "
            "        and party.t_partyid <> " + {OurBank} +
            "        and ( Deal.t_Sector = chr(88) and Deal.t_MarketKind = 2 ) " +
                     // Фильтры панели отчета
            "        and ((paym.t_valuedate >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( paym.t_valuedate <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
            +        IIF(NtgRepFormData.Contractor != -1, (" and party.t_partyid = " + NtgRepFormData.Contractor), "")
            +        IIF(NtgRepFormData.OpKind     != -1, (" and Deal.t_Kind = "  + NtgRepFormData.OpKind), "")
            +        IIF(NtgRepFormData.FIKind != -1, (" and fi.t_FI_Kind = " + NtgRepFormData.FIKind), "")
            +        IIF(NtgRepFormData.FI != -1, (" and fi.t_FIID = " + NtgRepFormData.FI), "");
  end;
  
  private macro GetSQLPayment(listpaym, OrderBy:bool)
     var Query =
                " SELECT "
                +        IIF(NtgRepFormData.IsSplit == "X", " opr.t_Name t_OpKindName, ", "") +
                "        party.t_partyid, "
                "        party.t_shortname, " 
                "        repdata.t_CD, "
                "        repdata.t_CL, "
                "        (CASE WHEN repdata.t_CD > repdata.t_CL THEN (repdata.t_CD - repdata.t_CL) ELSE 0 END) as t_CDT, "
                "        (CASE WHEN repdata.t_CD < repdata.t_CL THEN (repdata.t_CL - repdata.t_CD) ELSE 0 END) as t_CLT, "
                "        (select t_Name from dfikinds_dbt where t_FI_Kind = repdata.t_FI_Kind) t_FIKindName, "
                +        GetSQLFIN("repdata", "fininstr", "av") + " t_FIN, " +
                "        fininstr.t_Name as t_FIName, "
                "        repdata.t_partyid rept_partyid, "
                "        repdata.t_fiid rept_fiid "
                " FROM "
                +      IIF(NtgRepFormData.IsSplit == "X", " doprkoper_dbt opr, ", "") +
                "      dparty_dbt party, "
                "      dfininstr_dbt fininstr, "
                "      davoiriss_dbt av, "
                "      ( "
                "       SELECT "
                +              IIF(NtgRepFormData.IsSplit == "X", " listpaym.t_OpKind, ", "") +
                "              listpaym.t_partyid, "
                "              listpaym.t_fiid, "
                "              listpaym.t_FI_Kind, "
                "              sum(DECODE(listpaym.t_SIDE, " + LEABILITY + ", 0, listpaym.t_amount)) as t_CD, "
                "              sum(DECODE(listpaym.t_SIDE, " + DEMAND + ", 0, listpaym.t_amount)) as t_CL "
                "       FROM "
                "            ( "
                +             listpaym +
                "            ) listpaym "
                "       GROUP BY "
                +                IIF(NtgRepFormData.IsSplit == "X", " listpaym.t_OpKind, ", "") +
                "                listpaym.t_partyid, listpaym.t_fiid, listpaym.t_FI_Kind "
                "      ) repdata "
                " WHERE "
                "       party.t_partyid = repdata.t_partyid "
                "   and fininstr.t_fiid = repdata.t_fiid "
                "   and av.t_fiid(+) = fininstr.t_fiid "
                "   and ((repdata.t_CD > 0) or (repdata.t_CL > 0)) "
                +   IIF(NtgRepFormData.IsSplit == "X", " and opr.t_Kind_Operation = repdata.t_OpKind ", "");

     if( OrderBy == true )
        Query = Query + 
                " ORDER BY "
                +          IIF(NtgRepFormData.IsSplit == "X", " opr.t_Name, ", "") +
                "          repdata.t_partyid, repdata.t_fiid ";
     end;

     return Query;
  end;
  
  private macro GetSQLTotal(query)
    var sql =
                " SELECT "
                +        IIF(NtgRepFormData.IsSplit == "X", " t_OpKindName, ", "") +
                "        sum(t_CD) as t_CDS, "
                "        sum(t_CL) as t_CLS, "
                "        sum(t_CDT) as t_CDTS, "
                "        sum(t_CLT) as t_CLTS, "
                "        (CASE WHEN sum(t_CDT) > sum(t_CLT) THEN (sum(t_CDT) - sum(t_CLT)) ELSE 0 END) as t_ND, "
                "        (CASE WHEN sum(t_CDT) < sum(t_CLT) THEN (sum(t_CLT) - sum(t_CDT)) ELSE 0 END) as t_NL, "
                "        t_FIKindName, "
                "        t_FIN, "
                "        t_FIName "
                " FROM (" + query + ") "
                " GROUP BY "
                +          IIF(NtgRepFormData.IsSplit == "X", " t_OpKindName, ", "") +
                "          t_FIN, t_FIKindName, t_FIName "
                " ORDER BY "
                +          IIF(NtgRepFormData.IsSplit == "X", " t_OpKindName, ", "") +
                "          t_FIN ";
     return sql;
  end;

  private macro FindDataIn_ArTotalPFIOp(OpKindName, fiid)
     var findPos = -1;
     var i = 0;

     while( i < m_ArTotalPFIOp.size )
        if( (m_ArTotalPFIOp[i].Fiid == fiid) and 
            ((OpKindName == null) or (m_ArTotalPFIOp[i].OpKindName == OpKindName))
          )
           findPos = i;
           break;
        end;
        
        i = i + 1;
     end;

     return findPos;
  end;

  private macro GetSQLOpKindPositionCond()
     var sql =
     " AND dvDeal.t_FIID = t.t_FIID "
     " AND dvDeal.t_Department = t.t_Department "
     " AND dvDeal.t_Broker = t.t_Broker "
     " AND dvDeal.t_BrokerContr = t.t_BrokerContr "
     " AND dvDeal.t_Client = t.t_Client "
     " AND dvDeal.t_ClientContr = t.t_ClientContr "
     " AND dvDeal.t_Sector = t.t_Sector "
     + IIF(NtgRepFormData.OpKind != -1, (" AND dvDeal.t_Kind = " + NtgRepFormData.OpKind), "");

     return sql;
  end;

  private macro GetSQLPosition(kindFI, IsPaymBA)
     var sql =
                " SELECT " +
                "        t.t_FIID, " +
                "        tagContractor.t_PartyID, " +
                "        tagContractor.t_ShortName, "  +
                "        avrkinds.t_ShortName t_OpKindName, " +
                "        dft.t_ShortPosition, " +
                "        dft.t_LongPosition, " +
                "        tagFI.t_FaceValue, " +
                "        dft.t_ShortPositionCost, " +
                "        dft.t_LongPositionCost, " +
                "        kFIKind.t_Name t_kFIKindName, " +
                "        kFI.t_FIID t_kPaymFIID, "
                +        GetSQLFIN("kFI", "kFI", "kAvr") + " t_kFIN, " +
                "        kFI.t_Name kFIName, "
                +        IIF(IsPaymBA == true, " chr(88) ", " chr(0) ") + " t_IsPaymBA " +
                " FROM " +
                "        ddvfipos_dbt t, " +
                "        davrkinds_dbt avrkinds, "  +
                "        ddvfiturn_dbt dft, " +
                "        dparty_dbt tagContractor, " +
                "        dfininstr_dbt tagFI, " +
                "        dfininstr_dbt kFI, " +
                "        dfininstr_dbt fi2paym, "
                "        dFIKinds_dbt kFIKind, " +
                "        davoiriss_dbt kAvr "
                +        IIF(NtgRepFormData.OpKind != -1, " ,DDVDEAL_DBT dvDeal ", "") +
                " WHERE " +
                "        dft.t_FIID(+) = t.t_FIID " +
                "    AND dft.t_Department(+) = t.t_Department " +
                "    AND dft.t_Broker(+) = t.t_Broker " +
                "    AND dft.t_ClientContr(+) = t.t_ClientContr " +
                "    AND dft.t_Sector(+) = t.t_Sector " +
                "    AND (   dft.t_Date IS NULL " +
                "         OR dft.t_Date = " +
                "               NVL ( " +
                "                  (SELECT MAX (tableDVF.t_Date) t_TurnDate " +
                "                     FROM ddvfiturn_dbt tableDVF " +
                "                    WHERE     tableDVF.t_FIID = dft.t_FIID " +
                "                          AND tableDVF.t_Department = dft.t_Department " +
                "                          AND tableDVF.t_Broker = dft.t_Broker " +
                "                          AND tableDVF.t_ClientContr = dft.t_ClientContr " +
//                "                          AND tableDVF.t_Date <= " + GetSQLDate({CurDate})+ ") " // !?
                "                          AND tableDVF.t_Sector = dft.t_Sector), " +
                "                  To_Date('01,01,0001', 'DD.MM.YYYY'))) " +
                "    AND tagFI.t_FIID = t.t_FIID " +
                "    AND fi2paym.t_FIID = tagFI.t_FaceValueFI " +
                "    AND tagContractor.t_PartyID = DECODE(t.t_Broker, -1, tagFI.t_Issuer, t.t_Broker) " +
                "    AND avrkinds.t_FI_Kind = tagFI.t_FI_Kind " +
                "    AND avrkinds.t_AvoirKind = tagFI.t_AvoirKind " +
                "    AND t.t_Client = -1 " +
                "    AND (dft.t_ShortPosition > 0 or dft.t_LongPosition > 0) " +
                "    AND kFI.t_FIID = tagFI." + kindFI +
                "    AND kFIKind.t_FI_Kind = kFI.t_FI_Kind " +
                "    AND kAvr.t_fiid(+) = kFI.t_fiid " +
                "    AND kFI.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")" +
                 // Фильтры панели отчета
                "    and ((tagFI.t_DrawingDate >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( tagFI.t_DrawingDate <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
                +    IIF(NtgRepFormData.Contractor != -1, (" and tagContractor.t_PartyID = " + NtgRepFormData.Contractor), "")
                +    IIF(NtgRepFormData.OpKind != -1, GetSQLOpKindPositionCond(), "")
                +    IIF(NtgRepFormData.FIKind     != -1, (" and fi2paym.t_FI_Kind = " + NtgRepFormData.FIKind), "")
                +    IIF(NtgRepFormData.FI != -1, (" and kFI.t_FIID = " + NtgRepFormData.FI), "");
                
     return sql;
  end;

  PRIVATE MACRO СобратьДанные()
     var ds, Query, data;

     m_IsExistsPFIOpDataOTC = false;
     m_IsExistsPFIOpDataExch = false;
     m_IsExistsConvOpDataOTC = false;
     m_IsExistsConvOpDataExch = false;
     m_IsExistsFastOpDataOTC = false;
     m_IsExistsFastOpDataExch = false;
     m_IsExistsExchCurOpDataOTC = false;
     m_IsExistsExchCurOpDataExch = false;

     // Сделки ПФИ
     if( NtgRepFormData.IsPFIOp == "X" )
        // Внебиржевые операции
        if( NtgRepFormData.IsOTC == "X" )
           Query =
                " SELECT "
                +        IIF(NtgRepFormData.IsSplit == "X", " opr.t_Name t_OpKindName, ", "") +
                "        party.t_partyid, "
                "        party.t_shortname, " 
                "        repdata.t_CD, "
                "        repdata.t_CL, "
                "        (CASE WHEN repdata.t_CD > repdata.t_CL THEN (repdata.t_CD - repdata.t_CL) ELSE 0 END) as t_CDT, "
                "        (CASE WHEN repdata.t_CD < repdata.t_CL THEN (repdata.t_CL - repdata.t_CD) ELSE 0 END) as t_CLT, "
                "        (select t_Name from dfikinds_dbt where t_FI_Kind = repdata.t_FI_Kind) t_FIKindName, "
                +        GetSQLFIN("repdata", "fininstr", "av") + " t_FIN, " +
                "        fininstr.t_Name as t_FIName "
                " FROM "
                +      IIF(NtgRepFormData.IsSplit == "X", " doprkoper_dbt opr, ", "") +
                "      dparty_dbt party, "
                "      dpartyown_dbt own, "
                "      dfininstr_dbt fininstr, "
                "      davoiriss_dbt av, "
                "      ( "
                "       SELECT "
                +              IIF(NtgRepFormData.IsSplit == "X", " listpaym.t_OpKind, ", "") +
                "              listpaym.t_partyid, "
                "              listpaym.t_fiid, "
                "              listpaym.t_FI_Kind, "
                "              sum(DECODE(listpaym.t_SIDE, " + LEABILITY + ", 0, listpaym.t_amount)) as t_CD, "
                "              sum(DECODE(listpaym.t_SIDE, " + DEMAND + ", 0, listpaym.t_amount)) as t_CL "
                "       FROM "
                "            ( "
                "             SELECT "
                +                    IIF(NtgRepFormData.IsSplit == "X", " nDeal.t_Kind t_OpKind, ", "") +
                "                    party.t_partyid, "
                "                    paym.t_BaseFiid t_Fiid, "
                "                    paym.t_BaseAmount t_Amount, "
                "                    fi2paym.t_FI_Kind, "
                "                    (CASE WHEN paym.t_payer = " + {OurBank} + " THEN " + LEABILITY + " ELSE " + DEMAND + " END) t_Side "
                "             FROM "
                "                  dpmpaym_dbt paym, "
                "                  dfininstr_dbt fi, "
                "                  dparty_dbt party, "
                "                  ddvndeal_dbt nDeal, "
                "                  ddvnfi_dbt nFI,     "
                "                  dfininstr_dbt fi2paym "
                "             WHERE "
                "                       nDeal.t_id = paym.t_documentid "
                "                   and nFI.t_DealID = nDeal.t_ID "
                "                   and nFI.t_Type = " + DV_NFIType_BaseActiv +
                "                   and fi.t_FIID = nFI.t_FIID  "
                "                   and fi2paym.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")" +
                "                   and fi2paym.t_FIID = paym.t_BaseFIID " +
                "                   and (paym.t_IsPlanPaym = chr(88))"
                "                   and paym.t_DocKind =  nDeal.t_DocKind " +
                "                   and nDeal.t_IsPFI = chr(88) "
                "                   and nDeal.t_Client < 0 "
                "                   and nDeal.t_State = " + DVDEAL_OPEN +
                "                   and ((paym.t_payer = party.t_partyid)or(paym.t_receiver = party.t_partyid))"
                "                   and party.t_partyid <> " + {OurBank} +
                "                   and nDeal.t_DVKind <> " + DV_PCTSWAP +
                                    // Фильтры панели отчета
                "                   and ((paym.t_valuedate >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( paym.t_valuedate <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
                +                   IIF(NtgRepFormData.Contractor != -1, (" and party.t_partyid = " + NtgRepFormData.Contractor), "")
                +                   IIF(NtgRepFormData.OpKind != -1, (" and nDeal.t_Kind = " + NtgRepFormData.OpKind), "")
                +                   IIF(NtgRepFormData.FIKind != -1, (" and fi.t_FI_Kind = " + NtgRepFormData.FIKind), "")
                +                   IIF(NtgRepFormData.FI != -1, (" and fi.t_FIID = " + NtgRepFormData.FI), "") +
                              // Процентный СВОП
                "             UNION ALL  "
                "             SELECT "
                +                    IIF(NtgRepFormData.IsSplit == "X", " nDeal.t_Kind t_OpKind, ", "") +
                "                    nDeal.t_Contractor t_partyid, " // !?
                "                    PMGR.T_PAYMENTSUM AS T_AMOUNT, "
                "                    (CASE WHEN PMGR.T_SIDE = 2 THEN FI_2.T_FIID ELSE FI.T_FIID END) AS t_FIID, " // PAYMENTCURRENCY
                "                    (CASE WHEN PMGR.T_SIDE = 2 THEN FI_2.T_FI_Kind ELSE FI.T_FI_Kind END) AS t_FI_Kind, "
                "                    PMGR.T_SIDE AS T_SIDE "
                "             FROM "
                "                  DDVNPMGR_DBT PMGR, "
                "                  DDVNFI_DBT nFI, "
                "                  DDVNFI_DBT nFI_2, "
                "                  DFININSTR_DBT FI, "
                "                  DFININSTR_DBT FI_2, "
                "                  DDVNDEAL_DBT nDeal "
                "             WHERE "
                "                       nFI.T_DEALID = PMGR.T_DEALID "
                "                   and nFI.T_TYPE = " + DV_NFIType_BaseActiv +
                "                   and nFI_2.T_DEALID = PMGR.T_DEALID "
                "                   and nFI_2.T_TYPE = " + DV_NFIType_BaseActiv2 +
                "                   and FI.t_FIID = nFI.t_FIID "
                "                   and FI_2.T_FIID = nFI_2.t_FIID "
                "                   and nDeal.T_ID = PMGR.T_DEALID "
                "                   AND NOT EXISTS " // платеж ожидается
                "                    (SELECT DVNACDL.T_ID "
                "                       FROM DDVNACDL_DBT DVNACDL "
                "                      WHERE     DVNACDL.T_PAYKIND = 70 "
                "                            AND DVNACDL.T_DATE = PMGR.T_PAYDATE "
                "                            AND DVNACDL.T_DEALID = PMGR.T_DEALID "
                "                            AND DVNACDL.T_DIRECTION = "
                "                                   (CASE "
                "                                       WHEN nFI.T_ExecType = 1 "
                "                                       THEN "
                "                                          PMGR.T_SIDE "
                "                                       ELSE "
                "                                          DVNACDL.T_DIRECTION "
                "                                    END)) "
                "                   and nDeal.t_IsPFI = chr(88) "
                "                   and nDeal.t_Client < 0 "
                "                   and nDeal.t_State = " + DVDEAL_OPEN +
                "                   and nDeal.t_DVKind = " + DV_PCTSWAP +
                "                   and PMGR.T_SIDE IN (" + DEMAND + "," + LEABILITY + ") "
                "                   and PMGR.T_PAYMENTSUM > 0 " // !?
                                    // Фильтры панели отчета
                "                   and ((PMGR.T_PAYDATE >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( PMGR.T_PAYDATE <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
                +                   IIF(NtgRepFormData.Contractor != -1, (" and nDeal.t_Contractor = " + NtgRepFormData.Contractor), "") // !?
                +                   IIF(NtgRepFormData.OpKind != -1, (" and nDeal.t_Kind = " + NtgRepFormData.OpKind), "")
                +                   IIF(NtgRepFormData.FIKind != -1, (" and (CASE WHEN PMGR.T_SIDE = 2 THEN FI_2.T_FI_Kind ELSE FI.T_FI_Kind END) = " + NtgRepFormData.FIKind), "")
                +                   IIF(NtgRepFormData.FI != -1, (" and (CASE WHEN PMGR.T_SIDE = 2 THEN FI_2.T_FIID ELSE FI.T_FIID END) = " + NtgRepFormData.FI), "") +
            
                "            ) listpaym "
                "       GROUP BY "
                +                IIF(NtgRepFormData.IsSplit == "X", " listpaym.t_OpKind, ", "") +
                "                listpaym.t_partyid, listpaym.t_fiid, listpaym.t_FI_Kind "
                "      ) repdata "
                " WHERE "
                "       party.t_partyid = repdata.t_partyid "
                "   and party.t_partyid = own.t_partyid "
                "   and own.t_partykind = 7 "
                "   and fininstr.t_fiid = repdata.t_fiid "
                "   and av.t_fiid(+) = fininstr.t_fiid "
                "   and ((repdata.t_CD > 0) or (repdata.t_CL > 0)) "
                +   IIF(NtgRepFormData.IsSplit == "X", " and opr.t_Kind_Operation = repdata.t_OpKind ", "") +
                " ORDER BY "
                +          IIF(NtgRepFormData.IsSplit == "X", " opr.t_Name, ", "") +
                "          repdata.t_partyid, repdata.t_fiid ";

           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              m_IsExistsPFIOpDataOTC = true;
              data = CRepData();
              data.IsOTC = true;
              data.CN = ds.shortname;
              data.CD = ds.CD;
              data.CL = ds.CL;
              data.CDT = ds.CDT;
              data.CLT = ds.CLT;
              data.CV = ds.FIKindName;
              data.CVF = ds.FIN;
              data.CVN = ds.FIName;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArLinesPFIOp[m_ArLinesPFIOp.size] = data;
           end;

           Query = GetSQLTotal(Query);
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              data = CRepData();
              data.IsOTC = true;
              data.CDS = ds.CDS;
              data.CLS = ds.CLS;
              data.CDTS = ds.CDTS;
              data.CLTS = ds.CLTS;
              data.CVS = ds.FIKindName;
              data.CVFS = ds.FIN;
              data.CVNS = ds.FIName;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArTotalPFIOp[m_ArTotalPFIOp.size] = data;
   
              if ((ds.ND != 0) or (ds.NL != 0))
                 data = CRepData();
                 data.IsOTC = true;
                 data.ND = ds.ND;
                 data.NL = ds.NL;
                 data.NV = ds.FIKindName;
                 data.NVF = ds.FIN;
                 data.NVN = ds.FIName;
                 if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
                 m_ArNettoPFIOp[m_ArNettoPFIOp.size] = data;
              end;
            end;
         end;


      // Биржевые операции
         if( NtgRepFormData.IsExchange == "X" )
         // Отберем позиции
           Query = 
                " SELECT * " +
                " FROM " +
                " ( " 
                +  GetSQLPosition("t_FaceValueFI", true) + // Данные для платежа по БА
                " UNION ALL "
                +  GetSQLPosition("t_ParentFI", false) + // Данные для платежа по денежным средствам
                " ) data " +
                " ORDER BY  " +
                "          t_OpKindName, " +
                "          t_partyid, " +
                "          t_FIID, " +
                "          t_IsPaymBA desc, " +
                "          t_kPaymFIID ";

           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              var CalcPrice = 0.0;
              var FI = ПроизводныйИнструмент( ds.FIID );
              var IsFutures = (FI.FI.AvoirKind==DERIVATIVE_FUTURES);
              var IsOption = (FI.FI.AvoirKind==DERIVATIVE_OPTION);
              var netto = ABS(ds.LongPosition - ds.ShortPosition);
              var BAPaymSum = 0,   // платеж по БА
                  CashPaymSum = 0; // платеж по ден. ср.
              var PosData = -1;

              m_IsExistsPFIOpDataExch = true;

              // Платеж по БА
              if( ds.IsPaymBA == "X" )
                 if( PosData == -1 )
                    data = CRepData();
   
                    data.IsExchange = true;
                    data.PartyID = ds.PartyID;
                    data.FIID = ds.kPaymFIID;
                    data.CN = ds.shortname;
                    data.CV = ds.kFIKindName;
                    data.CVF = ds.kFIN;
                    data.CVN = ds.kFIName;
                    if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
   
                    m_ArLinesPFIOp[m_ArLinesPFIOp.size] = data;
                    PosData = m_ArLinesPFIOp.size - 1;
                 end;
                 // Платеж по Базовому активу:
                 // сумма Т/О определяется как произведение количества БА по одному контракту на количество контрактов по позиции на конец текущего операционного дня
                 BAPaymSum = ds.FaceValue * netto;
                 
                 if( IsFutures == true )
                    // Требование
                    if( (ds.LongPosition - ds.ShortPosition) > 0 )
                       m_ArLinesPFIOp[PosData].CD = m_ArLinesPFIOp[PosData].CD + BAPaymSum;
                    // Обязательство
                    else
                       m_ArLinesPFIOp[PosData].CL = m_ArLinesPFIOp[PosData].CL + BAPaymSum;
                    end;
                 elif( IsOption == true )
                    // Обязательство
                    if( (((ds.LongPosition - ds.ShortPosition) > 0) and (FI.DV.OptionType == FI_DVTYPE_PUT)) or
                        (((ds.LongPosition - ds.ShortPosition) < 0) and (FI.DV.OptionType == FI_DVTYPE_CALL)) )
                       m_ArLinesPFIOp[PosData].CL = m_ArLinesPFIOp[PosData].CL + BAPaymSum;
                    // Требование
                    else 
                       m_ArLinesPFIOp[PosData].CD = m_ArLinesPFIOp[PosData].CD + BAPaymSum;
                    end;
                 end;
              end;
           
              // Платеж по денежным средствам
                PosData = -1;
              if( ds.IsPaymBA == "" )
                 if( PosData == -1 )
                    data = CRepData();
   
                    data.IsExchange = true;
                    data.PartyID = ds.PartyID;
                    data.FIID = ds.kPaymFIID;
                    data.CN = ds.shortname;
                    data.CV = ds.kFIKindName;
                    data.CVF = ds.kFIN;
                    data.CVN = ds.kFIName;
                    if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
   
                    m_ArLinesPFIOp[m_ArLinesPFIOp.size] = data;
                    PosData = m_ArLinesPFIOp.size - 1;
                 end;
                 if( IsFutures == true )
                    // Платеж по денежным средствам:
                    // рассчитывается как сумма контрактов, умноженная на расчетную цену фьючерса, если расчетная цена не найдена, то как стоимость нетто позиции из итогов дня на текущую операционную дату (если нет итогов текущего дня, то за ближайшую меньшую дату).
                    CashPaymSum;
                    if( NOT ПолучитьКурсЗаданногоTипа( @CalcPrice, ds.FIID, FI.PriceFIID(), ПИ_ПолучитьВидКурса(RATETYPE_CALC_PRICE), {CurDate}, false) )
                       CashPaymSum = abs(ds.LongPositionCost - ds.ShortPositionCost);
                    else
                       CashPaymSum = netto * CalcPrice;
                    end;
              
                    // Обязательство
                    if( (ds.LongPosition - ds.ShortPosition) > 0 )
                       m_ArLinesPFIOp[PosData].CL = m_ArLinesPFIOp[PosData].CL + CashPaymSum;
                    // Требование
                    else
                       m_ArLinesPFIOp[PosData].CD = m_ArLinesPFIOp[PosData].CD + CashPaymSum;
                    end;
                 elif( IsOption == true )
                    // Платеж по денежным средствам:
                    // стоимость нетто позиции из итогов дня на текущую операционную дату (если нет итогов текущего дня, то за ближайшую меньшую дату).
                    CashPaymSum = abs(ds.LongPositionCost - ds.ShortPositionCost);
                    // Требование
                    if( (((ds.LongPosition - ds.ShortPosition) > 0) and (FI.DV.OptionType == FI_DVTYPE_PUT)) or
                        (((ds.LongPosition - ds.ShortPosition) < 0) and (FI.DV.OptionType == FI_DVTYPE_CALL)) )
                       m_ArLinesPFIOp[PosData].CD = m_ArLinesPFIOp[PosData].CD + CashPaymSum;
                    // Обязательство
                    else 
                       m_ArLinesPFIOp[PosData].CL = m_ArLinesPFIOp[PosData].CL + CashPaymSum;
                    end;
                 end;
              end;
           end;

           // Итоги Т/О, Всего
           var i = 0;
           while( i < m_ArLinesPFIOp.size )
              if( m_ArLinesPFIOp[i].IsExchange != true )
                 i = i + 1;
                 continue;
              end;

              var n = m_ArLinesPFIOp[i].CD - m_ArLinesPFIOp[i].CL;
              if( n > 0 )
                 m_ArLinesPFIOp[i].CDT = abs(n);
              else
                 m_ArLinesPFIOp[i].CLT = abs(n);
              end;

              // Всего, Всего итого
              PosData = FindDataIn_ArTotalPFIOp(m_ArLinesPFIOp[i].OpKindName, m_ArLinesPFIOp[i].Fiid);

              if( PosData == -1 )
                 data = CRepData();
                 data.IsExchange = true;
                 data.CVS = m_ArLinesPFIOp[i].CV;
                 data.CVFS = m_ArLinesPFIOp[i].CVF;
                 data.CVNS = m_ArLinesPFIOp[i].CVN;
                 data.Fiid = m_ArLinesPFIOp[i].Fiid;
                 data.PartyID = m_ArLinesPFIOp[i].PartyID;
                 data.OpKindName = m_ArLinesPFIOp[i].OpKindName;
                 if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = m_ArLinesPFIOp[i].OpKindName; end;
                 
                 m_ArTotalPFIOp[m_ArTotalPFIOp.size] = data;
                 PosData = m_ArTotalPFIOp.size - 1;
              end;

              m_ArTotalPFIOp[PosData].CDS = m_ArTotalPFIOp[PosData].CDS + m_ArLinesPFIOp[i].CD;
              m_ArTotalPFIOp[PosData].CLS = m_ArTotalPFIOp[PosData].CLS + m_ArLinesPFIOp[i].CL;
              m_ArTotalPFIOp[PosData].CDTS = m_ArTotalPFIOp[PosData].CDTS + m_ArLinesPFIOp[i].CDT;
              m_ArTotalPFIOp[PosData].CLTS = m_ArTotalPFIOp[PosData].CLTS + m_ArLinesPFIOp[i].CLT;

              i = i + 1;
           end;

           // баланс нетто
           i = 0;
           while( i < m_ArTotalPFIOp.size )
              if( m_ArTotalPFIOp[i].IsExchange != true )
                 i = i + 1;
                 continue;
              end;

              data = CRepData();
              data.IsExchange = true;
              data.NV = m_ArTotalPFIOp[i].CVS;
              data.NVF = m_ArTotalPFIOp[i].CVFS;
              data.NVN = m_ArTotalPFIOp[i].CVNS;
              data.Fiid = m_ArLinesPFIOp[i].Fiid;
              data.PartyID = m_ArLinesPFIOp[i].PartyID;
              data.OpKindName = m_ArLinesPFIOp[i].OpKindName;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = m_ArTotalPFIOp[i].OpKindName; end;

              n = m_ArTotalPFIOp[i].CDTS - m_ArTotalPFIOp[i].CLTS;
              if( n > 0 )
                 data.ND = abs(n);
              else
                 data.NL = abs(n);
              end;

              m_ArNettoPFIOp[m_ArNettoPFIOp.size] = data;

              i = i + 1;
           end;
         end;
     end;
     
     // Конверсионные операции
     if( NtgRepFormData.IsConvOp == "X" )
        // Внебиржевые операции
        if( NtgRepFormData.IsOTC == "X" )
           var listpaym = GetSQLConvDeal();

           Query = GetSQLPayment(listpaym, true);
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              m_IsExistsConvOpDataOTC = true;
              data = CRepData();
              data.CN = ds.shortname;
              data.CD = ds.CD;
              data.CL = ds.CL;
              data.CDT = ds.CDT;
              data.CLT = ds.CLT;
              data.CV = ds.FIKindName;
              data.CVF = ds.FIN;
              data.CVN = ds.FIName;
              data.IsOTC = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArLinesConvOp[m_ArLinesConvOp.size] = data;
           end;
   
           Query = GetSQLTotal(Query);
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              data = CRepData();
              data.CDS = ds.CDS;
              data.CLS = ds.CLS;
              data.CDTS = ds.CDTS;
              data.CLTS = ds.CLTS;
              data.CVS = ds.FIKindName;
              data.CVFS = ds.FIN;
              data.CVNS = ds.FIName;
              data.IsOTC = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArTotalConvOp[m_ArTotalConvOp.size] = data;
   
              if ((ds.ND != 0) or (ds.NL != 0))
                 data = CRepData();
                 data.ND = ds.ND;
                 data.NL = ds.NL;
                 data.NV = ds.FIKindName;
                 data.NVF = ds.FIN;
                 data.NVN = ds.FIName;
                 data.IsOTC = true;
                 if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
                 m_ArNettoConvOp[m_ArNettoConvOp.size] = data;
              end;
            end;
        end;
     end;


     // Сделки Покупка/Продажа Т+3
     if( NtgRepFormData.IsFastOp == "X" )
        // Внебиржевые операции
        if( NtgRepFormData.IsOTC == "X" )
           listpaym = GetSQLDealT3(false, true); // Сделки Т+3
           Query = GetSQLPayment(listpaym, true);
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              m_IsExistsFastOpDataOTC = true;
              data = CRepData();
              data.CN = ds.shortname;
              data.CD = ds.CD;
              data.CL = ds.CL;
              data.CDT = ds.CDT;
              data.CLT = ds.CLT;
              data.CV = ds.FIKindName;
              data.CVF = ds.FIN;
              data.CVN = ds.FIName;
              data.IsOTC = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArLinesFastOp[m_ArLinesFastOp.size] = data;
           end;

           Query = GetSQLTotal(Query);
   
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              data = CRepData();
              data.CDS = ds.CDS;
              data.CLS = ds.CLS;
              data.CDTS = ds.CDTS;
              data.CLTS = ds.CLTS;
              data.CVS = ds.FIKindName;
              data.CVFS = ds.FIN;
              data.CVNS = ds.FIName;
              data.IsOTC = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArTotalFastOp[m_ArTotalFastOp.size] = data;
   
              if ((ds.ND != 0) or (ds.NL != 0))
                 data = CRepData();
                 data.ND = ds.ND;
                 data.NL = ds.NL;
                 data.NV = ds.FIKindName;
                 data.NVF = ds.FIN;
                 data.NVN = ds.FIName;
                 data.IsOTC = true;
                 if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
                 m_ArNettoFastOp[m_ArNettoFastOp.size] = data;
            end;
        end;
     end;

        // Биржевые операции
        if( NtgRepFormData.IsExchange == "X" )
           listpaym = GetSQLDealT3(true, true); // Сделки Т+3
           Query = GetSQLPayment(listpaym, true);
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              m_IsExistsFastOpDataExch = true;
              data = CRepData();
              data.CN = ds.shortname;
              data.CD = ds.CD;
              data.CL = ds.CL;
              data.CDT = ds.CDT;
              data.CLT = ds.CLT;
              data.CV = ds.FIKindName;
              data.CVF = ds.FIN;
              data.CVN = ds.FIName;
              data.IsExchange = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArLinesFastOp[m_ArLinesFastOp.size] = data;
           end;

           Query = GetSQLTotal(Query);
   
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              data = CRepData();
              data.CDS = ds.CDS;
              data.CLS = ds.CLS;
              data.CDTS = ds.CDTS;
              data.CLTS = ds.CLTS;
              data.CVS = ds.FIKindName;
              data.CVFS = ds.FIN;
              data.CVNS = ds.FIName;
              data.IsExchange = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArTotalFastOp[m_ArTotalFastOp.size] = data;

              if ((ds.ND != 0) or (ds.NL != 0))
                 data = CRepData();
                 data.ND = ds.ND;
                 data.NL = ds.NL;
                 data.NV = ds.FIKindName;
                 data.NVF = ds.FIN;
                 data.NVN = ds.FIName;
                 data.IsExchange = true;
                 if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
                 m_ArNettoFastOp[m_ArNettoFastOp.size] = data;
              end;
            end;
        end;
     end;

     // Биржевые сделки валютного рынка           
     if( NtgRepFormData.IsExchCurOp == "X" )
          var Query1 =
                " SELECT "
                +        IIF(NtgRepFormData.IsSplit == "X", " opr.t_Name t_OpKindName, ", "") +
                "        party.t_partyid, "
                "        party.t_shortname, " 
                "        repdata.t_CD, "
                "        repdata.t_CL, "
                "        (CASE WHEN repdata.t_CD > repdata.t_CL THEN (repdata.t_CD - repdata.t_CL) ELSE 0 END) as t_CDT, "
                "        (CASE WHEN repdata.t_CD < repdata.t_CL THEN (repdata.t_CL - repdata.t_CD) ELSE 0 END) as t_CLT, "
                "        (select t_Name from dfikinds_dbt where t_FI_Kind = repdata.t_FI_Kind) t_FIKindName, "
                +        GetSQLFIN("repdata", "fininstr", "av") + " t_FIN, " +
                "        fininstr.t_Name as t_FIName, "
                "        repdata.t_partyid rept_partyid, "
                "        repdata.t_fiid rept_fiid "
                " FROM "
                +      IIF(NtgRepFormData.IsSplit == "X", " doprkoper_dbt opr, ", "") +
                "      dparty_dbt party, "
                "      dpartyown_dbt own, "
                "      dfininstr_dbt fininstr, "
                "      davoiriss_dbt av, "
                "      ( "
                "       SELECT "
                +              IIF(NtgRepFormData.IsSplit == "X", " listpaym.t_OpKind, ", "") +
                "              listpaym.t_partyid, "
                "              listpaym.t_fiid, "
                "              listpaym.t_FI_Kind, "
                "              sum(DECODE(listpaym.t_SIDE, " + LEABILITY + ", 0, listpaym.t_amount)) as t_CD, "
                "              sum(DECODE(listpaym.t_SIDE, " + DEMAND + ", 0, listpaym.t_amount)) as t_CL "
                "       FROM "
                "            ( "
                "             SELECT "
                +                    IIF(NtgRepFormData.IsSplit == "X", " nDeal.t_Kind t_OpKind, ", "") +
                "                    party.t_partyid, "
                "                    paym.t_BaseFiid t_Fiid, "
                "                    paym.t_BaseAmount t_Amount, "
                "                    fi2paym.t_FI_Kind, "
                "                    (CASE WHEN paym.t_payer = " + {OurBank} + " THEN " + LEABILITY + " ELSE " + DEMAND + " END) t_Side "
                "             FROM "
                "                  dpmpaym_dbt paym, "
                "                  dfininstr_dbt fi, "
                "                  dparty_dbt party, "
                "                  ddvndeal_dbt nDeal, "
                "                  ddvnfi_dbt nFI,     "
                "                  dfininstr_dbt fi2paym "
                "             WHERE "
                "                       nDeal.t_id = paym.t_documentid "
                "                   and nFI.t_DealID = nDeal.t_ID "
                "                   and nFI.t_Type = " + DV_NFIType_BaseActiv +
                "                   and fi.t_FIID = nFI.t_FIID  "
                "                   and fi2paym.t_FI_Kind in(" + FIKIND_CURRENCY + "," + FIKIND_METAL + ")" +
                "                   and fi2paym.t_FIID = paym.t_BaseFIID " +
                "                   and (paym.t_IsPlanPaym = chr(88))"
                "                   and paym.t_DocKind =  nDeal.t_DocKind " +
                "                   and nDeal.t_IsPFI = chr(88) "
                "                   and nDeal.t_Client < 0 "
                "                   and nDeal.t_Sector = chr(88) "
                "                   and nDeal.t_MarketKind = 2 "
                "                   and ((paym.t_payer = party.t_partyid)or(paym.t_receiver = party.t_partyid))"
                "                   and party.t_partyid <> " + {OurBank} +
                "                   and nDeal.t_DVKind <> " + DV_PCTSWAP +
                                    // Фильтры панели отчета
                "                   and ((paym.t_valuedate >= " + GetSQLDate(NtgRepFormData.DateBegin)+ ") " + IIF(NtgRepFormData.IsSetEndDate == true, (" and ( paym.t_valuedate <= " + GetSQLDate(NtgRepFormData.DateEnd) + ")"), "") + " ) "
                +                   IIF(NtgRepFormData.Contractor != -1, (" and party.t_partyid = " + NtgRepFormData.Contractor), "")
                +                   IIF(NtgRepFormData.OpKind != -1, (" and nDeal.t_Kind = " + NtgRepFormData.OpKind), "")
                +                   IIF(NtgRepFormData.FIKind != -1, (" and fi.t_FI_Kind = " + NtgRepFormData.FIKind), "")
                +                   IIF(NtgRepFormData.FI != -1, (" and fi.t_FIID = " + NtgRepFormData.FI), "") +
                "            ) listpaym "
                "       GROUP BY "
                +                IIF(NtgRepFormData.IsSplit == "X", " listpaym.t_OpKind, ", "") +
                "                listpaym.t_partyid, listpaym.t_fiid, listpaym.t_FI_Kind "
                "      ) repdata "
                " WHERE "
                "       party.t_partyid = repdata.t_partyid "
                "   and party.t_partyid = own.t_partyid "
                "   and own.t_partykind = 7 "
                "   and fininstr.t_fiid = repdata.t_fiid "
                "   and av.t_fiid(+) = fininstr.t_fiid "
                "   and ((repdata.t_CD > 0) or (repdata.t_CL > 0)) "
                +   IIF(NtgRepFormData.IsSplit == "X", " and opr.t_Kind_Operation = repdata.t_OpKind ", "");

        listpaym = GetSQLExchCurDeal();
        var Query2 = GetSQLPayment(listpaym, false);
        Query = " SELECT * "
                " FROM (" + Query1 + " UNION ALL " + Query2 + ") " + 
                " ORDER BY "
                +          IIF(NtgRepFormData.IsSplit == "X", " t_OpKindName, ", "") +
                "          rept_partyid, rept_fiid ";
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
           m_IsExistsExchCurOpDataExch = true;
              data = CRepData();
              data.CN = ds.shortname;
              data.CD = ds.CD;
              data.CL = ds.CL;
              data.CDT = ds.CDT;
              data.CLT = ds.CLT;
              data.CV = ds.FIKindName;
              data.CVF = ds.FIN;
              data.CVN = ds.FIName;
              data.IsExchange = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
           m_ArLinesExchCurOp[m_ArLinesExchCurOp.size] = data;
           end;

           Query = GetSQLTotal(Query);
           ds = TRsbDataSet( Query );
           while( ds.MoveNext() )
              data = CRepData();
              data.CDS = ds.CDS;
              data.CLS = ds.CLS;
              data.CDTS = ds.CDTS;
              data.CLTS = ds.CLTS;
              data.CVS = ds.FIKindName;
              data.CVFS = ds.FIN;
              data.CVNS = ds.FIName;
              data.IsExchange = true;
              if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
           m_ArTotalExchCurOp[m_ArTotalExchCurOp.size] = data;
   
              if ((ds.ND != 0) or (ds.NL != 0))
                 data = CRepData();
                 data.ND = ds.ND;
                 data.NL = ds.NL;
                 data.NV = ds.FIKindName;
                 data.NVF = ds.FIN;
                 data.NVN = ds.FIName;
                 data.IsExchange = true;
                 if( NtgRepFormData.IsSplit == "X" ) data.OpKindName = ds.OpKindName; end;
              m_ArNettoExchCurOp[m_ArNettoExchCurOp.size] = data;
            end;
        end;
     end;

     m_IsExistsData = (m_IsExistsPFIOpDataOTC == true) or (m_IsExistsPFIOpDataExch == true) or (m_IsExistsConvOpDataOTC == true) or (m_IsExistsConvOpDataExch == true) or 
                      (m_IsExistsFastOpDataOTC == true) or (m_IsExistsFastOpDataExch == true) or (m_IsExistsExchCurOpDataOTC == true) or (m_IsExistsExchCurOpDataExch == true);
  END;

  private macro GetArCount(opKindName, isExch, ar:@variant)
     var count = 0, i = 0;

     while( i < ar.size )
        if(isExch == true)
           if( (ar[i].IsExchange == true) and
                ( (opKindName == null) or (ar[i].OpKindName == opKindName) )
             )
              count = count + 1;
           end;
        else
           if( (ar[i].IsOTC == true) and
                ( (opKindName == null) or (ar[i].OpKindName == opKindName) )
             )
              count = count + 1;
           end;
        end;

        i = i + 1;
     end;

     return count;
  end;

  private macro InitProgressPrint(ProgressIndicator_:@variant, ProgressValue_:@variant, mes, opKindName, isExch, ar:@variant)
     ProgressValue_ = CTxProgressValue();
     ProgressValue_.Maximum = GetArCount( opKindName, isExch, @ar );
     ProgressValue_.Current = 0;
     ProgressIndicator_ = CreateProgressIndicator(m_IsWebService);

     if( m_IsWebService and (WebMenuItem != null) )
        var header = "Формирование отчета " + WebMenuItem.szNameItem;
        ProgressIndicator_.Start(ProgressValue_.Maximum, header, header);
     else
        ProgressIndicator_.Start(ProgressValue_.Maximum, mes, mes );
     end;
  end;

  private macro UpdateProgressPrint(ProgressIndicator_:@variant, ProgressValue_:@variant)
     ProgressValue_.Current = ProgressValue_.Current + 1;
     ProgressIndicator_.Update(ProgressValue_.Current, ProgressValue_.Maximum);
  end;

  private macro PrintRepData(opKindName, ArLines, ArTotal, ArNetto, skipIsOTC, skipIsExchange, mes)
     var i = 0, prevContr = "";
     var ProgressValue, ProgressIndicator, header;

     InitProgressPrint(@ProgressIndicator, @ProgressValue, mes, opKindName, (IIF(skipIsOTC == true, true, false)), @ArLines);
     PrintMainTableHead();
     while( i < ArLines.size)
        if( ((opKindName != null) and (ArLines[i].OpKindName != opKindName)) or
            ((ArLines[i].IsOTC == True) and (skipIsOTC == true)) or
            ((ArLines[i].IsExchange == True) and (skipIsExchange == true))
          )
           i = i + 1;
           continue;
        end;

        PrintMainTableLine(GetContrVal(ArLines[i].CN, prevContr),
                           GetVal(ArLines[i].CD),
                           GetVal(ArLines[i].CL),
                           GetVal(ArLines[i].CDT),
                           GetVal(ArLines[i].CLT),
                           ArLines[i].CV,
                           ArLines[i].CVF,
                           ArLines[i].CVN);

        prevContr = ArLines[i].CN;
        i = i + 1;

        UpdateProgressPrint(@ProgressIndicator, @ProgressValue);
     end;
     PrintEndTable();
     ProgressIndicator.Stop();

     InitProgressPrint(@ProgressIndicator, @ProgressValue, mes, opKindName, (IIF(skipIsOTC == true, true, false)), @ArTotal);
     PrintTotalHead();
     i = 0;
     while( i < ArTotal.size)
        if( ((opKindName != null) and (ArTotal[i].OpKindName != opKindName)) or
            ((ArTotal[i].IsOTC == True) and (skipIsOTC == true)) or
            ((ArTotal[i].IsExchange == True) and (skipIsExchange == true))
          )
           i = i + 1;
           continue;
        end;

        PrintTotalLine(GetVal(ArTotal[i].CDS),
                       GetVal(ArTotal[i].CLS),
                       GetVal(ArTotal[i].CDTS),
                       GetVal(ArTotal[i].CLTS),
                       ArTotal[i].CVS,
                       ArTotal[i].CVFS,
                       ArTotal[i].CVNS);
        i = i + 1;

        UpdateProgressPrint(@ProgressIndicator, @ProgressValue);
     end;
     PrintEndTable();
     ProgressIndicator.Stop();
     
     InitProgressPrint(@ProgressIndicator, @ProgressValue, mes, opKindName, (IIF(skipIsOTC == true, true, false)), @ArNetto);
     PrintNettoHead();
     i = 0;
     while( i < ArNetto.size)
        if( ((opKindName != null) and (ArNetto[i].OpKindName != opKindName)) or
            ((ArNetto[i].IsOTC == True) and (skipIsOTC == true)) or
            ((ArNetto[i].IsExchange == True) and (skipIsExchange == true))
          )
           i = i + 1;
           continue;
        end;

        PrintNettoLine(GetVal(ArNetto[i].ND),
                       GetVal(ArNetto[i].NL),
                       ArNetto[i].NV,
                       ArNetto[i].NVF,
                       ArNetto[i].NVN);
        i = i + 1;

        UpdateProgressPrint(@ProgressIndicator, @ProgressValue);
     end;
     PrintEndTable();
     ProgressIndicator.Stop();
  end;

  // Данные для листа "Сделки ПФИ"
  PRIVATE MACRO ExecuteReport_PFIOp()
     var mes;
     SetActiveSheet( m_SheetPFI );
     m_Prefix = GetPrefix( m_SheetPFI );
     PrintReportHead();

     // Внебиржевой рынок
     if( (NtgRepFormData.IsOTC == "X") and (m_IsExistsPFIOpDataOTC == true) )
        mes = "Формирование отчета для внебиржевых операций ПФИ";
        PrintMarketHead(m_MarketOTC);
        if( NtgRepFormData.IsSplit == "" )
           PrintRepData(null, m_ArLinesPFIOp, m_ArTotalPFIOp, m_ArNettoPFIOp, false, true, mes);
        else
           var i = 0, prevOpKindName = "";
           while( i < m_ArTotalPFIOp.size )
              if( (m_ArTotalPFIOp[i].OpKindName != prevOpKindName) and (m_ArTotalPFIOp[i].IsOTC == true))
                 PrintOpKindHead(m_ArTotalPFIOp[i].OpKindName);
                 PrintRepData(m_ArTotalPFIOp[i].OpKindName, m_ArLinesPFIOp, m_ArTotalPFIOp, m_ArNettoPFIOp, false, true, mes);
              end;
              prevOpKindName = m_ArTotalPFIOp[i].OpKindName;
              i = i + 1;
           end;
        end;
     end;

     // Биржевой рынок
     if( (NtgRepFormData.IsExchange == "X") and (m_IsExistsPFIOpDataExch == true) )
        mes = "Формирование отчета для биржевых операций ПФИ";
        PrintMarketHead(m_MarketExchange);
        if( NtgRepFormData.IsSplit == "" )
           PrintRepData(null, m_ArLinesPFIOp, m_ArTotalPFIOp, m_ArNettoPFIOp, true, false, mes);
        else
           i = 0; prevOpKindName = "";
           while( i < m_ArTotalPFIOp.size )
              if( (m_ArTotalPFIOp[i].OpKindName != prevOpKindName) and (m_ArTotalPFIOp[i].IsExchange == true))
                 PrintOpKindHead(m_ArTotalPFIOp[i].OpKindName);
                 PrintRepData(m_ArTotalPFIOp[i].OpKindName, m_ArLinesPFIOp, m_ArTotalPFIOp, m_ArNettoPFIOp, true, false, mes);
              end;
              prevOpKindName = m_ArTotalPFIOp[i].OpKindName;
              i = i + 1;
           end;
        end;
     end;
  END;

  // Данные для листа "Конверсионные сделки"
  PRIVATE MACRO ExecuteReport_ConvOp()
     var mes;
     SetActiveSheet( m_SheetConv );
     m_Prefix = GetPrefix( m_SheetConv );
     PrintReportHead();

     // Внебиржевой рынок
     if( (NtgRepFormData.IsOTC == "X") and (m_IsExistsConvOpDataOTC == true) )
        mes = "Формирование отчета для внебиржевых конверсионных операций";
        PrintMarketHead(m_MarketOTC);
        if( NtgRepFormData.IsSplit == "" )
           PrintRepData(null, m_ArLinesConvOp, m_ArTotalConvOp, m_ArNettoConvOp, false, true, mes);
        else
           var i = 0, prevOpKindName = "";
           while( i < m_ArTotalConvOp.size )
              if( (m_ArTotalConvOp[i].OpKindName != prevOpKindName) and (m_ArTotalConvOp[i].IsOTC == true))
                 PrintOpKindHead(m_ArTotalConvOp[i].OpKindName);
                 PrintRepData(m_ArTotalConvOp[i].OpKindName, m_ArLinesConvOp, m_ArTotalConvOp, m_ArNettoConvOp, false, true, mes);
              end;
              prevOpKindName = m_ArTotalConvOp[i].OpKindName;
              i = i + 1;
           end;
        end;
     end;
  END;

  // Данные для листа "Срочные сделки с ц.б."
  PRIVATE MACRO ExecuteReport_FastOp()
     var mes;
     SetActiveSheet( m_SheetFast );
     m_Prefix = GetPrefix( m_SheetFast );
     PrintReportHead();

     // Внебиржевой рынок
     if( (NtgRepFormData.IsOTC == "X") and (m_IsExistsFastOpDataOTC == true) )
        mes = "Формирование отчета для внебиржевых сделок Покупка/продажа Т+3 с ц/б";
        PrintMarketHead(m_MarketOTC);
        PrintRepData(null, m_ArLinesFastOp, m_ArTotalFastOp, m_ArNettoFastOp, false, true, mes);
     end;

     // Биржевой рынок
     if( (NtgRepFormData.IsExchange == "X") and (m_IsExistsFastOpDataExch == true) )
        mes = "Формирование отчета для биржевых сделок Покупка/продажа Т+3 с ц/б";
        PrintMarketHead(m_MarketExchange);
        PrintRepData(null, m_ArLinesFastOp, m_ArTotalFastOp, m_ArNettoFastOp, true, false, mes);
     end;
  END;

  // Данные для листа "Биржевые сделки валютного рынка"
  PRIVATE MACRO ExecuteReport_ExchCurOp()
     var mes;
     SetActiveSheet( m_SheetExchCur );
     m_Prefix = GetPrefix( m_SheetExchCur );
     PrintReportHead();

     if( m_IsExistsExchCurOpDataExch == true )
        mes = "Формирование отчета для биржевых сделок валютного рынка";
        if( NtgRepFormData.IsSplit == "" )
           PrintRepData(null, m_ArLinesExchCurOp, m_ArTotalExchCurOp, m_ArNettoExchCurOp, true, false, mes);
        else
           var i = 0, prevOpKindName = "";
           while( i < m_ArTotalExchCurOp.size )
              if( (m_ArTotalExchCurOp[i].OpKindName != prevOpKindName) and (m_ArTotalExchCurOp[i].IsExchange == true))
                 PrintOpKindHead(m_ArTotalExchCurOp[i].OpKindName);
                 PrintRepData(m_ArTotalExchCurOp[i].OpKindName, m_ArLinesExchCurOp, m_ArTotalExchCurOp, m_ArNettoExchCurOp, true, false, mes);
              end;
              prevOpKindName = m_ArTotalExchCurOp[i].OpKindName;
              i = i + 1;
           end;
        end;
     end;
  END;

  PRIVATE MACRO Create()
     ОчиститьДанные();
     СобратьДанные();

     if( (m_IsExistsPFIOpDataOTC == true) or (m_IsExistsPFIOpDataExch == true) )
        ExecuteReport_PFIOp();
     end;

     if( (m_IsExistsConvOpDataOTC == true) or (m_IsExistsConvOpDataExch == true) )
        ExecuteReport_ConvOp();
     end;

     if( (m_IsExistsFastOpDataOTC == true) or (m_IsExistsFastOpDataExch == true) )
        ExecuteReport_FastOp();
     end;

     if( (m_IsExistsExchCurOpDataOTC == true) or (m_IsExistsExchCurOpDataExch == true) )
        ExecuteReport_ExchCurOp();
     end;

     // Нет данных для формирования отчета
     if( (m_IsExistsData == false) and
         (m_IsWebService == false) )
        msgbox("Нет данных для формирования отчета.");
     end;
  END;

  initDL_CReportTemplate( Form, TemplateName, UseCSV, IsWebService, ReportHashCode );
END;


MACRO ReportRunEx(
  IsWebService    : Bool
 ,FormData      //: для веб
 ,ReportHashCode  : Integer
 ,menuItem      //: WsMenuItem
)
   var stat = true;
   var FullReportFileNames = TArray();

   if( not IsWebService )
      NtgList_Panel = DV_NtgListRep_Panel();
   else
      if( ValType( FormData ) != V_UNDEF )
         //NtgList_Panel = WS_NtgList_Panel( FormData );
      else
         stat = false;
      end;
   end;

   while( stat )
      if( not IsWebService )
         stat = NtgList_Panel.Run();
      end;

      if( stat )
         NtgList_Report = DL_NtgList_Report( null, "Report_dv_ntglist.xls", true, IsWebService, ReportHashCode );
         NtgList_Report.Run();

         if( IsWebService )
            //DL_CallInsertStat(DL_OUTREPORT_EXCEL, menuItem.iCaseItem, menuItem.iIdentProgram, menuItem.szNameItem);
            //FullReportFileNames = NtgList_Report.GetFullReportFileNames();
            stat = false;
         else
            //DL_CallInsertStat(DL_OUTREPORT_EXCEL);
         end;
      end;
   end;

   return FullReportFileNames;
end;
