/*
$Name:        dvfx150.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Постановка на балансовый учет 2ч"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dvndeal);
  var FD;
  var ДатаИсполненияШага:date;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal, 2);

  GetOprDate(DV_FXDEAL_OPRDATE_EXEC_2, ДатаИсполненияШага);

  if( FD.IsSWAP() and (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) )
     if( not FD.ВыполненаПереоценкаСС( ДатаИсполненияШага ) )
        if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
           return 1;
        end;
     end;
     if( СВОП_СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ) != 0 )
        return 1;
     end;
  end;

  if( ПИКО_ПоставитьНаБалансЧастьСделки(FD, doc, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_BALANCE_2, DV_FX_OPERSTATUS_DL_COMPLETE) )
     MsgBox("Ошибка при установке статуса <Баланс 2ч> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND_2, DV_FX_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Требования 2ч> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY_2, DV_FX_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Обязательства 2ч> по операции.");
     return 1;
  end;

  return 0;
end;
