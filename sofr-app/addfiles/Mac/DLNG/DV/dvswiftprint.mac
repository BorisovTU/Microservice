/*  
$Name:        dvswiftprint.mac
$Module:      Производные инструменты
$Description: Печать сообщений SWIFT
*/
import "dv_categ.mac", "DvRepFun2.mac", "dldlngfun.mac", "commonutil.mac", dv_lib/*Simanov - избавляемся от библиотеки, CommonInter*/;
import "wlgenmes.mac";
import "wlgenmes_usr.mac";

private macro GetMsgLength(DraftID, ProcName, DraftKind, KindMsg)
  var query, Select, Stat;

  query = "declare v_Mes CLOB; begin\n ? := RSP_SECURITY." + ProcName + "(?, ?, v_Mes, ?); ? := DBMS_LOB.GETLENGTH(v_Mes); \n end;";

  Select = RSDCommand( query );

  Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );

  Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
  Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
  Select.AddParam("p_KindMsg", RSDBP_IN, KindMsg );
  Select.AddParam("p_Len", RSDBP_OUT, V_INTEGER );
  Select.Execute();

  if(NOT SQL_ConvTypeInteger(Select.value("p_Stat")))
    return SQL_ConvTypeInteger(Select.value("p_Len"));
  else
    return 0;
  end;
end;

private macro GetMsgText(DraftID, ProcName, DraftKind, KindMsg)
  var query, Select, Stat, MesLength = GetMsgLength(DraftID, ProcName, DraftKind, KindMsg);
  var Text = "";
  if(MesLength)
    query = "begin\n ? := RSP_SECURITY." + ProcName + "(?, ?, ?, ?); \n end;";
    Select = RSDCommand( query );
    Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );
    Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
    Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
    Select.AddParam("p_Mes", RSDBP_OUT, V_STRING, MesLength );
    Select.AddParam("p_KindMsg", RSDBP_IN, KindMsg );
    Select.Execute();

    if(NOT SQL_ConvTypeInteger(Select.value("p_Stat")))
      Text = SQL_ConvTypeStr(Select.value("p_Mes"));
    end;
  else
    Text = "Сообщение не найдено";
  end;
  return Text;
end;

private macro GetMsgLength_SWP(DraftID, ProcName, DraftKind, PartSWP, KindMsg)
  var query, Select, Stat;

  query = "declare v_Mes CLOB; begin\n ? := RSP_SECURITY." + ProcName + "(?, ?, ?, v_Mes, ?); ? := DBMS_LOB.GETLENGTH(v_Mes); \n end;";
    Select = RSDCommand( query );
  Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );
  Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
  Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
  Select.AddParam("p_PartSWP", RSDBP_IN, PartSWP );
  Select.AddParam("p_KindMsg", RSDBP_IN, KindMsg );
  Select.AddParam("p_Len", RSDBP_OUT, V_INTEGER );
  Select.Execute();

  if(NOT SQL_ConvTypeInteger(Select.value("p_Stat")))
    return SQL_ConvTypeInteger(Select.value("p_Len"));
  else
    return 0;
  end;
end;

private macro GetMsgText_SWP(DraftID, ProcName, DraftKind, PartSWP, KindMsg)
  var query, Select, Stat, MesLength = GetMsgLength_SWP(DraftID, ProcName, DraftKind, PartSWP, KindMsg);
  var Text = "";
  if(MesLength)
    query = "begin\n ? := RSP_SECURITY." + ProcName + "(?, ?, ?, ?, ?); \n end;";
    Select = RSDCommand( query );
    Select.AddParam("p_Stat", RSDBP_OUT, V_INTEGER );
    Select.AddParam("p_DraftKind", RSDBP_IN, DraftKind );
    Select.AddParam("p_DraftID", RSDBP_IN, DraftID );
    Select.AddParam("p_PartSWP", RSDBP_IN, PartSWP );
    Select.AddParam("p_Mes", RSDBP_OUT, V_STRING, MesLength );
    Select.AddParam("p_KindMsg", RSDBP_IN, KindMsg );
    Select.Execute();

    if(NOT SQL_ConvTypeInteger(Select.value("p_Stat")))
      Text = SQL_ConvTypeStr(Select.value("p_Mes"));
    end;
  else
    Text = "Сообщение не найдено";
  end;
  return Text;
end;

macro PrintSWIFTMessage(DealID:integer, IsConf, DraftKind, KindMsg, PartSWP)
  VAR ReportFileName, ProcName;
  ReportFileName = GetTxtFileName( "message");
  SetOutput( ReportFileName );

  if(PartSWP)
    if(IsConf)
      ProcName = "GetConfirmText_SWP";
    else
      ProcName = "GetMsgText_SWP";
    end;
    print(GetMsgText_SWP(DealID, ProcName, DraftKind, PartSWP, KindMsg));
  else
  if(IsConf)
    ProcName = "GetConfirmText";
  else
    ProcName = "GetMsgText";
  end;
    print(GetMsgText(DealID, ProcName, DraftKind, KindMsg));
  end;

  SetOutput( NULL, true );
  ViewFile( ReportFileName );
end;
