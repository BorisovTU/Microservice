/*
$Name:        dlsettl900.mac
$Module:      Ядро Securities
$Description: Операция "Расчеты с биржей", Шаг Квитовка входящих платежей
*/

import PaymInter, "globals.mac", "dldlngfun.mac", "dv_fun.mac", "dv_car.mac";

/* Массивы с информацией о исполняемых платежах для квитовки */
VAR PlanIDs     = TArray;
VAR FactIDs     = TArray;
VAR KvitAmounts = TArray;
VAR ExecDate;

PRIVATE VAR Dl_ValueData = TRecHandler( "dl_value.dbt");

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )

  if( ExecDate == NULL )
     MsgBox("Шаг \"Квитовка входящих платежей\" должен выполняться только из соответствующей сервисной операции.");
     return 1;
  end;

  // инициализация массива сумм плановых платежей
  var i = 0, parms = DL_KvitParms();
  while( i < PlanIDs.size )
     parms.Add(PlanIDs(i), RsbPayment(PlanIDs(i)).FuturePayerAmount);
     i = i + 1;
  end;

  if( ExecDate > {curdate} )
     MsgBox("Преждевременное выполнение шага запрещено");
     return 1;
  end;

  if( not ПИ_ИнтегрРежимРаботы() )
     MsgBox("Квитовка платежей не предусмотрена");
     return 1;
  elif( not DL_КвитовкаПлатежа(PlanIDs, FactIDs) )
     return 1;
  elif( not DL_ВыполнитьПроводкиКвитовки(parms, PlanIDs, FactIDs, KvitAmounts, ExecDate) )
     return 1;
  end;
  return 0;
end;