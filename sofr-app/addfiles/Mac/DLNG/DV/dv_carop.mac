/*
$Name:        dv_carop.mac
$Module:      Производные инструменты
$Description: Процедуры для проводок по операциям расчета по ПИ
*/
IMPORT "dv_categ.mac", "dv_ground.mac", "dv_car.mac", "dvRepFun.mac", "dv_fun.mac", "dvserv.mac";

private var FI         =  TRecHandler( "fininstr.dbt");
private var acc_buf1   =  TRecHandler( "account.dbt" );  
private var acc_buf2   =  TRecHandler( "account.dbt" );  
private var party_buff =  TRecHandler( "party.dbt" );  
private var acc_buf3   =  TRecHandler( "account.dbt" );  
private var acc_buf4   =  TRecHandler( "account.dbt" );  

/*Сохранять информацию об ошибках при массовом исполнении*/
PRIVATE VAR DVOP_CarryError = "";
MACRO DVOP_GetCarryError()
   if (DV_GetCarryError() == "")
      return DVOP_CarryError;
   else
      return DV_GetCarryError();
   end;
END;

PRIVATE MACRO SayCarryError( error )
   if( isOprMultiExec() == false )
      msgbox( error );
   else
      DVOP_CarryError = error;
   end;
   return false;
END;  

PRIVATE MACRO АктуализироватьСчетаДляПроводокПоИтогам( OperDate, FD, FD2, FiRole, FiRole2, Acc, AccFIID, AccBuff:@variant, AnotherAcc, AnotherFIID, AnotherAccBuff:@variant,
                                                       PairAcc, AnotherPairAcc )

   if( ValType( AnotherAcc ) == V_STRING )
      if( not FD2.OpenAccount( AnotherAcc, null, null, FiRole2, acc_buf3, OperDate, AnotherFIID, null, null, AnotherPairAcc ) ) 
         return false;
      else
         AnotherAccBuff = acc_buf3;
      end;
   else
      AnotherAccBuff = AnotherAcc;
   end;
   if( ValType(Acc) == V_STRING )
      if( not FD.OpenAccount( Acc, null, null, FiRole, acc_buf4, OperDate, AccFIID, null, null, PairAcc ) ) 
         return false;
      else
         AccBuff = acc_buf4;
      end;
   else
      AccBuff = Acc;
   end;
   return true;
END;

PRIVATE MACRO ПроводкиПоУчетуРасходов( FD:variant, OperDate:date, Sum:money, SumFIID:integer, Docum, OperCode, FiRole:integer ):bool

   if( Sum != $0 )
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "+Форвард, РПИ ФО", "-Форвард, РПИ ФО", 
                                         OperDate, 1, 
                                         SumFIID, Abs(Sum),
                                         Docum,
                                         INPCARRY, "",
                                         "",//OperCode,
                                         "Учет расходов по оплаченным премиям по опционам",  
                                         null, FiRole, FiRole,
                                         SumFIID, SumFIID,
                                         null, null, null, null, null, null, null, null,
                                         MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                       )
        )
         return false;        
      end;       
      
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "+ПФИ ФО", "+Форвард, РПИ ФО", 
                                         OperDate, 1, 
                                         SumFIID, Abs(Sum), 
                                         Docum,
                                         INPCARRY,"",
                                         "",//OperCode,
                                         "Учет расходов по оплаченным премиям по опционам",  
                                         null, null, FiRole,
                                         NATCUR, SumFIID,
                                         null, null, null, null, null, null, null, null,
                                         null, MC_PAIRACCMODE_MANUAL
                                       ) 
        )
         return false;        
      end;
   end;

   return true;
END;

PRIVATE MACRO ПроводкиПоУчетуДоходов( FD:variant, OperDate:date, Sum:money, SumFIID:integer, Docum, OperCode, FiRole:integer ):bool

   if( Sum != $0 )
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "+Форвард, РПИ ФО", "-Форвард, РПИ ФО", 
                                         OperDate, 1, 
                                         SumFIID, Abs(Sum),
                                         Docum,
                                         INPCARRY, "",
                                         "",//OperCode,
                                         "Учет доходов от полученных премий по опционам",  
                                         null, FiRole, FiRole,
                                         SumFIID, SumFIID,
                                         null, null, null, null, null, null, null, null,
                                         MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                       )
        )
         return false;        
      end;       
      
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         "-Форвард, РПИ ФО", "-ПФИ ФО",
                                         OperDate, 1, 
                                         SumFIID, Abs(Sum), 
                                         Docum,
                                         INPCARRY, "",
                                         "",//OperCode,
                                         "Учет доходов от полученных премий по опционам",  
                                         null, FiRole, null,
                                         SumFIID, NATCUR,
                                         null, null, null, null, null, null, null, null,
                                         MC_PAIRACCMODE_MANUAL, null
                                       ) 
        )
         return false;        
      end;
   end;

   return true;
END;

MACRO ВыполнитьПроводкиПоДоходам( Docum, FD:variant, oper:variant, AvoirKind:integer,
                                  SumFIID:integer, PaydSum:money, ReceivedSum:money
                                ): bool

   var OperDate = oper.Date;
   var OperCode = oper.Code;
   var Sum = $0;
   //TEG 27.02.19
   var ground;
   var FiRole = 0;

   if (StrUpr( GenClassName(FD) ) == StrUpr("DVFirstDocPos"))
      FiRole = IIF(FD.PositionByOption(), FIROLE_OPTION, FIROLE_FUTURES);
   elif (StrUpr( GenClassName(FD) ) == StrUpr("DVFirstDocDeal"))
      FiRole = IIF(FD.DealWithOption(), FIROLE_OPTION, FIROLE_FUTURES);
   end;

  /* if( (AvoirKind == DERIVATIVE_OPTION) )

      if( ПроводкиПоДоходамИРасходам() == 0 )
         if( ПроводкиПоУчетуРасходов( FD, OperDate, Abs(PaydSum), SumFIID, Docum, OperCode, FIROLE_OPTION ) == false )
            return false;
         end;

         if( ПроводкиПоУчетуДоходов( FD, OperDate, Abs(ReceivedSum), SumFIID, Docum, OperCode, FIROLE_OPTION ) == false )
            return false;
         end;
      else
         Sum = PaydSum - ReceivedSum;

         if( Sum > 0.0 )
            if( ПроводкиПоУчетуРасходов( FD, OperDate, Abs(Sum), SumFIID, Docum, OperCode, FIROLE_OPTION ) == false )
               return false;
            end;
         elif( Sum < 0.0 )
            if( ПроводкиПоУчетуДоходов( FD, OperDate, Abs(Sum), SumFIID, Docum, OperCode, FIROLE_OPTION ) == false )
               return false;
            end;
         end;
      end;
   else*/
      Sum = PaydSum;
      //TEG 27.02.19
      ground=" "+Get_FinameDVFUN(FD.DEAL.rec.fiid)+", сделка N "+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+iif(FD.DEAL.rec.type=="S"," по продаже ПФИ "," по покупке ПФИ ")+", количество "+string(FD.DEAL.rec.amount:*:*,5,0);
      if( Sum != $0 )
         if( FD.GetDoc().rec.Sector == SET_CHAR )
            if( not ПроводкаПоКатегориямУчета( FD,
                                               "Расходы ПФИ", "-ПФИ ФО",
                                               OperDate, 1,
                                               SumFIID, Abs(Sum),
                                               Docum,
                                               INPCARRY, "",
                                               "",//OperCode,
                                               "Начисление вариационной маржи"+ground,
                                               null,
                                               iif(AvoirKind == DERIVATIVE_OPTION,FIROLE_OPTION,FIROLE_BA), null,
                                               NATCUR, NATCUR
                                             )
              )
               return false;
            end;
         end;

         if( not ПроводкаПоКатегориямУчета( FD, 
                                            "Выбытие ФО", "-Форвард, РПИ ФО", 
                                            OperDate, 1, 
                                            SumFIID, Abs(Sum), 
                                            Docum,
                                            INPCARRY, "",
                                           "", //OperCode,
                                            "Отражение суммы обязательств по оплате вар. маржи"+ground,  
                                            null, null, FiRole,
                                            NATCUR, SumFIID,
                                            null, null, null, null, null, null, null, null,
                                            null, MC_PAIRACCMODE_MANUAL
                                          ) 
         )
            return false;        
         end;

         if( not ПроводкаПоКатегориямУчета( FD, 
                                            "-ПФИ ФО", "Выбытие ФО", 
                                            OperDate, 1, 
                                            SumFIID, Abs(Sum), 
                                            Docum,
                                            INPCARRY, "",
                                            "",//OperCode,
                                            //"Списание справедливой стоимости"+ground,  
                                            "Отражение суммы обязательств по оплате вар. маржи"+ground,
                                            null, null, null,
                                            NATCUR, NATCUR
                                          )
         )
            return false;        
         end;       
      end;

      Sum = ReceivedSum;

      if( Sum != $0 )
         if( FD.GetDoc().rec.Sector == SET_CHAR )
            if( not ПроводкаПоКатегориямУчета( FD,
                                               "+ПФИ ФО", "Доходы ПФИ",
                                               OperDate, 1,
                                               SumFIID, Abs(Sum),
                                               Docum,
                                               INPCARRY, "",
                                              "",// OperCode,
                                               "Начисление вариационной маржи"+ground,
                                               null,
                                               null, iif(AvoirKind == DERIVATIVE_OPTION,FIROLE_OPTION,FIROLE_BA),
                                               NATCUR, NATCUR
                                             )
              )
               return false;
            end;
         end;

         if( not ПроводкаПоКатегориямУчета( FD, 
                                            "+Форвард, РПИ ФО", "Выбытие ФО", 
                                            OperDate, 1, 
                                            SumFIID, Abs(Sum), 
                                            Docum,
                                            INPCARRY, "",
                                            "",//OperCode,
                                            "Отражение суммы требований по получению вар. маржи"+ground,  
                                            null, FiRole, null,
                                            SumFIID, NATCUR,
                                            null, null, null, null, null, null, null, null,
                                            MC_PAIRACCMODE_MANUAL, null
                                          ) 
         )
            return false;        
         end;       

         if( not ПроводкаПоКатегориямУчета( FD, 
                                            "Выбытие ФО", "+ПФИ ФО",
                                            OperDate, 1, 
                                            SumFIID, Abs(Sum), 
                                            Docum,
                                            INPCARRY, "",
                                            "",//OperCode,
                                            //"Списание справедливой стоимости"+ground,
                                            "Отражение суммы требований по получению вар. маржи"+ground,
                                            null, null, null,
                                            NATCUR, NATCUR
                                           ) 
         )
            return false;        
         end;       
      end;
   /*end;*/

   return true;
END;

MACRO ВыполнитьПроводкиПоЗачислениям( Docum, FD:variant, oper:variant, AvoirKind:integer,
                                      Client:integer, ClientContr:integer, SumFIID:integer, Sum:money, DataSum,
                                      DGround:string
                                    ): bool
   var OperDate  = oper.Date;
   var OperCode  = oper.Code;
   var PartyKind = oper.PartyKind;
   var BrokerContr:integer;
   var Ground = "";
   var AccNumber:string = "", AccBuff = null, AnotherAccBuff = null, BrokerAccount= null, ClientAccount= null;
   var Firole:integer;
   var IsDeal:bool = false;
   var ContrNum,ContrDate;
   //TEG
   var IsPosVM:bool = false;
   var ClassName = StrUpr( GenClassName( FD ));
   var MarketSchemeID = -1, DocID = -1;

   DVOP_CarryError = "";

   var Vground="";

   if( ClassName == StrUpr("DVFirstDocDeal") )
      IsDeal = true;
      MarketSchemeID = FD.Deal.rec.MarketSchemeID;
      DocID = FD.Deal.rec.ID;
      if (Fd.deal.rec.client>0)
        if (not Get_DvContrCode(FD.deal.rec.clientcontr, @ContrNum, @ContrDate))
           ContrNum ="N/A";
           ContrDate = date(0,0,0);
        end;
        vground=" .Дог.N"+ContrNum+" от "+StrSubSt(String(ContrDate:f), ".", "/");
      end;  
   end;
   //TEG
   if( ClassName == StrUpr("DVFIRSTDOCOPER") )
      IsPosVm = true;
   end;
   if (DGround==V_UNDEF)
      DGround="";
   end;

   /*получим счета брокера и/или клиента*/
   if( PartyKind == PTK_BROKER ) /* расчеты с брокером */
      BrokerContr = oper.PartyContr;
      if( BrokerContr >  0 )
         /*счет брокера получаем из договора с брокером*/
         if( (AccNumber = ПолучитьСчетИзДоговора( BrokerContr, SumFIID, true )) != "" )
            if( DV_GetAccount( 1, SumFIID, AccNumber, acc_buf1 ) == true )
               BrokerAccount = acc_buf1;
            end;
         else
            return SayCarryError( "Не найден счет брокера в валюте  " + ПолучитьКодФинИн(SumFIID, null, FICK_ISOSTRING ));
         end;
      end;
   end;

   if( Client > -1 )
      if( ClientContr > 0 )
         /*счет клиента получаем из договора с клиентом*/
         if( (AccNumber = ПолучитьСчетИзДоговора( ClientContr, SumFIID, true )) != "" )
            if( DV_GetAccount( 1, SumFIID, AccNumber, acc_buf2 ) == true )
               ClientAccount = acc_buf2;
            end;
         else
            return SayCarryError( "Не найден счет клиента " + ПолучитьКодСубъекта( Client, PTCK_CONTR ) +" в валюте  " + ПолучитьКодФинИн(SumFIID, null, FICK_ISOSTRING ));
         end;
      end;
   end;

   if (StrUpr( GenClassName(FD) ) == StrUpr("DVFirstDocPos"))
      Firole = IIF(FD.PositionByOption(), FIROLE_OPTION, FIROLE_FUTURES);
   elif (StrUpr( GenClassName(FD) ) == StrUpr("DVFirstDocDeal"))
      Firole = IIF(FD.DealWithOption(), FIROLE_OPTION, FIROLE_FUTURES);
   end;

   if( Sum < $0 )
      if( Client == -1 )
         if( PartyKind == PTK_MARKETPLASE )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, Firole, FIROLE_FIDOC,
                                                             "-Форвард, РПИ ФО", SumFIID, @AccBuff, 
                                                             "-Биржа", SumFIID, @AnotherAccBuff,
                                                             MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                                           )
              )
              return false;
            end;
         elif( PartyKind == PTK_BROKER )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, Firole, FIROLE_FIDOC,
                                                             "-Форвард, РПИ ФО", SumFIID, @AccBuff, 
                                                             BrokerAccount, SumFIID, @AnotherAccBuff,
                                                             MC_PAIRACCMODE_MANUAL, null
                                                           )
              )
              return false;
            end;
         end;
      elif( PartyKind == PTK_MARKETPLASE )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, FIROLE_FIDOC, FIROLE_FIDOC,
                                                             ClientAccount, SumFIID, @AccBuff, 
                                                             "+Биржа", SumFIID, @AnotherAccBuff 
                                                           ) 
              )
              return false;
            end;
      elif( PartyKind == PTK_BROKER )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, FIROLE_FIDOC, FIROLE_FIDOC,
                                                             ClientAccount, SumFIID, @AccBuff, 
                                                             BrokerAccount, SumFIID, @AnotherAccBuff 
                                                           ) 
              )
              return false;
            end;
      end;

      //if( AvoirKind == DERIVATIVE_OPTION )
      //   Ground = ОснованиеПроводкиПИ(DV_GRNUM_OUTBONUS); /*"Списание премии по опционам"*/ 
      //else
         //Вариационная маржа удержанная по контракту RTS-3.19 , сделка N 2230068147 от 13.02.2019.Дог.N78-40191 от 27.04.2015.
         //Ground = ОснованиеПроводкиПИ(DV_GRNUM_OUTMARGIN); 
         Ground="Вариационная маржа удержанная ";
      //end;
     if( IsDeal )
           Ground = Ground + "по контракту "+Get_FinameDVFUN(FD.Deal.rec.Fiid)+" , сделка N "+string(FD.Deal.rec.ExtCode)+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+vGround+".";
      end;
      if( IsPosVm )
         Ground = Ground + " по контракту " + DGround;
      end;
   elif( Sum > $0 )
      if( Client == -1 )
         if( PartyKind == PTK_MARKETPLASE )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, FIROLE_FIDOC, Firole,
                                                             "+Биржа", SumFIID, @AccBuff, 
                                                             "+Форвард, РПИ ФО", SumFIID, @AnotherAccBuff,
                                                             MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                                           )
              )
              return false;
            end;
         elif( PartyKind == PTK_BROKER )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, FIROLE_FIDOC, Firole,
                                                             BrokerAccount, SumFIID, @AccBuff, 
                                                             "+Форвард, РПИ ФО", SumFIID, @AnotherAccBuff,
                                                             null, MC_PAIRACCMODE_MANUAL
                                                           )
              )
              return false;
            end;
         end;
      elif( PartyKind == PTK_MARKETPLASE )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, FIROLE_FIDOC, FIROLE_FIDOC,
                                                             "+Биржа", SumFIID, @AccBuff, 
                                                             ClientAccount, SumFIID, @AnotherAccBuff 
                                                           ) 
              )
              return false;
            end;
      elif( PartyKind == PTK_BROKER )
            if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                             FD, FD, FIROLE_FIDOC, FIROLE_FIDOC,
                                                             BrokerAccount, SumFIID, @AccBuff, 
                                                             ClientAccount, SumFIID, @AnotherAccBuff 
                                                           )
              )
              return false;
            end;
      end;

     // if( AvoirKind == DERIVATIVE_OPTION )
     //    Ground = ОснованиеПроводкиПИ(DV_GRNUM_ADDBONUS); /*"Зачисление премии по опционам"*/           
     // else
         //Вариационная маржа начисленная по контракту RTS-3.19M210319PA107500 .Дог.N78-40191 от 27.04.2015.
         // Ground = ОснованиеПроводкиПИ(DV_GRNUM_ADDMARGIN);
         Ground = "Вариационная маржа начисленная ";
     // end;
      if( IsDeal )
            //TEG 27.02.19
            Ground = Ground + "по контракту "+Get_FinameDVFUN(FD.Deal.rec.Fiid)+" , сделка N "+string(FD.Deal.rec.ExtCode)+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+vGround+".";
      end;
      if( IsPosVm )
         Ground = Ground + " по контракту " + DGround;
      end;
   end;

   if( (AccBuff != NULL) AND (AnotherAccBuff != NULL) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                         AccBuff, AnotherAccBuff, 
                                         OperDate, 1, 
                                         SumFIID, Abs(Sum), 
                                         Docum,
                                         INPCARRY, "",
                                         "",//OperCode,
                                         Ground
                                       ) 
        )
         return false;
      end;

      if( PartyKind == PTK_MARKETPLASE )
         if( Sum < $0 )
            DataSum.AddData(0, abs(Sum), SumFIID, MarketSchemeID, DocID);
         elif( Sum > $0 )
            DataSum.AddData(abs(Sum), 0, SumFIID, MarketSchemeID, DocID);
         end
      end;
   end;

   return true;
END;

MACRO ВыполнитьПроводкуПоУдержаниюНалога(Docum, FD:variant, oper:variant, AvoirKind:integer,
                                         Client:integer, ClientContr:integer, TaxFIID:integer, TaxSum:money ): bool

  var AccNumber:string = "", AccBuff = null, AnotherAccBuff = null, BrokerAccount= null, ClientAccount= null;
  var OperDate  = oper.Date;
  var OperCode  = oper.Code;
  var PartyKind = oper.PartyKind;
  var BrokerContr:integer;

  DVOP_CarryError = "";

  if(TaxSum > 0)
    
    /*получим счета брокера и/или клиента*/
    if( PartyKind == PTK_BROKER ) /* расчеты с брокером */
       BrokerContr = oper.PartyContr;
       if( BrokerContr >  0 )
          /*счет брокера получаем из договора с брокером*/
          if( (AccNumber = ПолучитьСчетИзДоговора( BrokerContr, TaxSum, true )) != "" )
             if( DV_GetAccount( 1, TaxFIID, AccNumber, acc_buf1 ) == true )
                BrokerAccount = acc_buf1;
             end;
          else
             return SayCarryError( "Не найден счет брокера в валюте  " + ПолучитьКодФинИн(TaxFIID, null, FICK_ISOSTRING ));
          end;

          if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                           FD, FD, FIROLE_FIDOC, FIROLE_UNDEF,
                                                           BrokerAccount, TaxFIID, @AccBuff, 
                                                           "-Бюджет, ф.налоги", NATCUR, @AnotherAccBuff 
                                                         )
            )
            return false;
          end;
       end;
    elif( PartyKind == PTK_MARKETPLASE )
      if( not АктуализироватьСчетаДляПроводокПоИтогам( OperDate, 
                                                       FD, FD, FIROLE_FIDOC, FIROLE_UNDEF,
                                                       "+Биржа", TaxFIID, @AccBuff, 
                                                       "-Бюджет, ф.налоги", NATCUR, @AnotherAccBuff,
                                                       MC_PAIRACCMODE_MANUAL
                                                     ) 
        )
        return false;
      end;
    end;

    if( (AccBuff != NULL) AND (AnotherAccBuff != NULL) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                         AccBuff, AnotherAccBuff, 
                                         OperDate, 1, 
                                         TaxFIID, TaxSum, 
                                         Docum,
                                         INPCARRY, "",
                                         "",//OperCode,
                                         "Удержание налога"
                                       ) 
        )
         return false;
      end;
    end;

  end;

  return true;
END; 

/*
MACRO ВыполнитьПроводкиПоИтогамДляКомиссий( Docum, FD:variant, oper:variant, AvoirKind:integer,
                                            Client:integer, ClientContr:integer, SumFIID:integer, SumComm:money, NDSComm:money,
                                            NotResident:string, ComCode:string, DataSum, IsCommBank:bool, Sector:string, BaseFI_Kind:integer
                                          ): bool
*/
MACRO ВыполнитьПроводкиПоИтогамДляКомиссий( Docum, FD:variant, oper:variant, AvoirKind:integer,
                                            Client:integer, ClientContr:integer, SumFIID:integer, SumComm:money, NDSComm:money,
                                            NotResident:string, ComCode:string, DataSum, IsCommBank:bool, Sector:string, BaseFI_Kind:integer, IsBankExpenses:bool//, 
				           // pluscalc:string, ContrName:string
                                          ): bool

  var OperDate  = oper.Date;
  var OperCode  = oper.Code;
  var PartyKind = oper.PartyKind;
  var Party     = oper.Party;
  var BrokerContr:integer;
  var PayerAccount = null, PayerAccountNDS = null, ReceiverAccount =  null, AssignAccount = null;
  var ReceiverFIID = SumFIID, ReceiverFIIDNDS = SumFIID;
  var AccNumber =  "", SumCommNDS = $0, ComName = "", Ground0 = "", Ground = "", GroundNDS = "";
  var IsDeal:bool = false;
  var ContrNum, ContrDate;
  var ClassName = StrUpr( GenClassName( FD ));
  var isITS:bool = false;
  var isBrokCom:bool = false;
  var isCompens:bool = false;
  var vGround="";
  if ((index (strUpr(ComCode), "КЛИР")==0) and (index (strUpr(ComCode), "КЛИЕНТ")==0) AND (index (strUpr(ComCode), "КОМПЕНСАЦ")==0))
    isITS=true;
  elif (index (strUpr(ComCode), "КЛИЕНТ")!=0)
    isBrokCom=true;
  elif(index (strUpr(ComCode), "КОМПЕНСАЦ")!=0)
    isCompens = true;
  end;
  if (FD.DEAL.rec.client>0)
    if (not Get_DvContrCode(FD.deal.rec.clientcontr, @ContrNum, @ContrDate))
      ContrNum ="N/A";
      ContrDate = date(0,0,0);
    end;
    vground=" по Дог. N" + ContrNum+" от "+StrSubSt(String(ContrDate:f), ".", "/")+".";
  end;  
  ///ААИ
  var Account_47423p = "+РасчетыКомисс1"; 
  var FDContr = FD;
  var MarketSchemeID = -1, DocID = -1; 
  var FiRole:integer = 0;

  DVOP_CarryError = "";

  if( ClassName == StrUpr("DVFirstDocDeal") )
    IsDeal = true;
    MarketSchemeID = FD.Deal.rec.MarketSchemeID;
    DocID = FD.Deal.rec.ID;
  end;

  if( SumComm != $0 )
    if( IsDeal )
      if(( IsCommBank ) or (Client != -1))
        Account_47423p= "+РасчетыКомисс1";
      end;
    end;

    if( not(IsCommBank) )
      if( PartyKind == PTK_MARKETPLASE )  /* расчеты с биржей */
        if(IsBankExpenses and (Client != -1))
          ReceiverAccount = "+Биржа";
        elif(Client == -1)
          ReceiverAccount = "-Биржа";    
        else
          ReceiverAccount = "+Биржа";
        end;
      elif( PartyKind == PTK_BROKER )     /* расчеты с брокером */
        BrokerContr = oper.PartyContr;
        if( BrokerContr >  0 )
        /*счет брокера получаем из договора с брокером*/
          if( (AccNumber = ПолучитьСчетИзДоговора(BrokerContr, SumFIID, true) ) != "" )
            if( DV_GetAccount( 1, SumFIID, AccNumber, acc_buf1 ) == true )
              ReceiverAccount = acc_buf1;
            end;
          else
            return SayCarryError( "Не найден счет брокера в валюте  " + ПолучитьКодФинИн(SumFIID, null, FICK_ISOSTRING ));
          end;
        end;
      end;
    else
        if( ClientContr > 0 )
          FDContr = DVFirstDocContract(DL_DVCONTR, ClientContr);
          FDContr.SetFI_Kind(BaseFI_Kind);
        else
          if( not IsDeal )
            FDContr.SetFI_Kind(BaseFI_Kind);
          end;
        end;
        ReceiverAccount = acc_buf1;

        if( ClientContr > 0 )
          FDContr.SetFI_Kind(-1);
        else
          if( not IsDeal )
            FDContr.SetFI_Kind(-1);
          end;
        end;
    end;

    if( Client == -1 )
      if( not IsDeal )
        FD.SetFI_Kind(BaseFI_Kind);
      end;
      if( not FD.IsExistAccount(IIF(Sector == SET_CHAR, "-КВ, к/о", IIF(isITS,"-КВ, ПФИ","-КВ, ц/б")), null, true, null, acc_buf2, null, OperDate) )
        if( not FD.OpenAccount(IIF(Sector == SET_CHAR, "-КВ, к/о",  IIF(isITS,"-КВ, ПФИ","-КВ, ц/б")), null, false, null, acc_buf2, OperDate) )
          return SayCarryError("Не открыт счет категории " + IIF(Sector == SET_CHAR, "-КВ, к/о",  IIF(isITS,"-КВ, ПФИ","-КВ, ц/б")));
        end;
      end;
      PayerAccount = acc_buf2;
      if( not IsDeal )
        FD.SetFI_Kind(-1);
      end;
      PayerAccountNDS = "+НДС";
    else
      if(IsBankExpenses)
        if(SumFIID == NATCUR)
          FiRole = FIROLE_OPCL_MOEX_NAT;
        else
          FiRole = FIROLE_OPCL_MOEX_FRG;
        end;
        if( not FD.IsExistAccount("-Расчеты", null, true, null, acc_buf2, null, OperDate, SumFIID) )
          if( not FD.OpenAccount("-Расчеты", null, false, null, acc_buf2, OperDate, SumFIID) )
            return SayCarryError("Не открыт счет категории -Расчеты");
          end;
        end;
        if( not FD.IsExistAccount("-КВ, др, кл", null, true, FiRole, acc_buf3, null, OperDate, NATCUR) )
          if( not FD.OpenAccount("-КВ, др, кл", null, false, FiRole, acc_buf3, OperDate, NATCUR) )
            return SayCarryError("Не открыт счет категории -КВ, др, кл");
          end;
        end;
        PayerAccount   = acc_buf2;
        PayerAccountNDS= acc_buf2;
        AssignAccount  = acc_buf3;    
      elif( ClientContr > 0 )
        /*счет клиента получаем из договора с клиентом*/
        if( (AccNumber = ПолучитьСчетИзДоговора( ClientContr, SumFIID, true )) != "" )
          if( DV_GetAccount( 1, SumFIID, AccNumber, acc_buf2 ) == true )
            PayerAccount   = acc_buf2;
            PayerAccountNDS= acc_buf2;
          end;
        else
          return SayCarryError( "Не найден счет клиента " + ПолучитьКодСубъекта( Client, PTCK_CONTR ) +" в валюте  " + ПолучитьКодФинИн(SumFIID, null, FICK_ISOSTRING ));        
        end;
      end;
    end;

    if( (PayerAccount != null) AND (PayerAccountNDS != null) AND ((ReceiverAccount != null) or (IsCommBank)) )
      if(( IsCommBank ) or ( ClientContr > 0 ))
        if (isITS) //teg комиссия биржи
          Ground ="Уплата комиссии биржи, сделка N " + FD.Deal.rec.ExtCode + " от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+
                    " контракт "+Get_FinameDVFUN(FD.Deal.rec.Fiid)+vground; 
        elif (isBrokCom) 
        //Брокерская комиссия , сделка N 2230068158 от 13.02.2019 по дог.N78-40191 от 27.04.2015, контракт RTS-3.19.
          Ground ="Брокерская комиссия, сделка N " + FD.Deal.rec.ExtCode + " от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+
                    " контракт "+Get_FinameDVFUN(FD.Deal.rec.Fiid)+vground;
        elif (isCompens)
          Ground ="Компенсационная комиссия, сделка N " + FD.Deal.rec.ExtCode + " от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+
                    " контракт "+Get_FinameDVFUN(FD.Deal.rec.Fiid)+vground;
      
        else
          Ground ="Клиринговый сбор , сделка N " + FD.Deal.rec.ExtCode + " от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+
                    " контракт "+Get_FinameDVFUN (FD.Deal.rec.Fiid)+vground;
        end;  
        GroundNDS = "НДС по комиссии клиента банку";

      else
        var Grnd:string = "";
        if( IsDeal )
          //  Grnd = " по сделке " + FD.DealCode() + " ";
          Grnd = " по сделке N " + FD.Deal.rec.ExtCode + " ";
        else
          Grnd = " по операциям ";
        end;
        if (isITS) //teg комиссия биржи
          Ground0 ="Уплата комиссии биржи , сделка N " + FD.Deal.rec.ExtCode + " от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+
                    " контракт "+Get_FinameDVFUN (FD.Deal.rec.Fiid);
        else
          Ground0 ="Клиринговый сбор , сделка N " + FD.Deal.rec.ExtCode + " от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+
                    " контракт "+Get_FinameDVFUN (FD.Deal.rec.Fiid);
        end;  
      end;

        /* При прочих условиях сумма НДС включена в осн. сумму комиссии */
      if( ((NotResident == "") AND (Client == -1)) OR (IsCommBank) ) /*(контрагент-резидент и сделка наша) или комиссия банку - делаем проводку по НДС*/
        SumCommNDS = NDSComm;

        //TEG 16.03.19
        if( not IsCommBank )
          Ground = Ground0;
        end;
      end;
      if(IsBankExpenses and (Client != -1))/*Клиентская с признаком "Отнесение на расходы банка"*/
        if( not ПроводкаПоКатегориямУчета( FD,
                                            AssignAccount, PayerAccount, 
                                            OperDate, 1, 
                                            SumFIID, SumComm-SumCommNDS,
                                            Docum,
                                            INPCARRY, "",
                                            OperCode,
                                            Ground, null, null, null,
                                            null, ReceiverFIID
                                          )
          )
            return false;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                            PayerAccount, "+Биржа", 
                                            OperDate, 1, 
                                            SumFIID, SumComm-SumCommNDS,
                                            Docum,
                                            INPCARRY, "",
                                            OperCode,
                                            Ground, null, null, null,
                                            null, ReceiverFIID
                                          )
          )
            return false;
        end;
      else
        if(( not IsCommBank ) and (Client == -1 ))/*биржевая по собственным сделкам*/
          if( not ПроводкаПоКатегориямУчета( FD,
                                              PayerAccount, ReceiverAccount, 
                                              OperDate, 1, 
                                              SumFIID, SumComm-SumCommNDS,
                                              Docum,
                                              INPCARRY, "",
                                              "",// OperCode,
                                              Ground, null, null, null,
                                              null, ReceiverFIID, 
                                              null, null, null, null, null,
                                              null, null, null, null, MC_PAIRACCMODE_MANUAL                                                  
                                            )
            )
            return false;
          end;
        elif(( IsCommBank ) and (Client != -1 ))/*брокерская по клиентским сделкам*/
          //teg 07.12.18      
          if( not ПроводкаПоКатегориямУчета( FD,
                                            Account_47423p, "+КВ, ц/б", 
                                            OperDate, 1, 
                                            SumFIID, SumComm-SumCommNDS,
                                            Docum,
                                            INPCARRY, "",
                                            "",//OperCode,
                                            Ground, null, null, null,
                                            ReceiverFIID, ReceiverFIID, null, null, null, null, null,
                                            null, null, null, MC_PAIRACCMODE_MANUAL, null
                                          )
            )                                               
              return false;
          end;
         
          if( not ПроводкаПоКатегориямУчета( FD,
                                              PayerAccount, Account_47423p, 
                                              OperDate, 1, 
                                              SumFIID, SumComm-SumCommNDS,
                                              Docum,
                                              INPCARRY, "",
                                              "",//OperCode,
                                              Ground, null, null, null,
                                              null, ReceiverFIID, null, null, null, null, null,
                                              null, null, null, null, MC_PAIRACCMODE_MANUAL
                                            )
            )                                                             
              return false;
          end;

        else /*биржевая комиссия для клиентов без признака "Отнесение на расходы банка" */
          //teg 07.12.18      
          if( not ПроводкаПоКатегориямУчета( FD,
                                            Account_47423p, "+Биржа", 
                                            OperDate, 1, 
                                            SumFIID, SumComm-SumCommNDS,
                                            Docum,
                                            INPCARRY, "",
                                            "",//OperCode,
                                            Ground, null, null, null,
                                            ReceiverFIID, ReceiverFIID, null, null, null, null, null,
                                            null, null, null, MC_PAIRACCMODE_MANUAL, null
                                          )
            )                                               
              return false;
          end;
         
          if( not ПроводкаПоКатегориямУчета( FD,
                                              PayerAccount, Account_47423p, 
                                              OperDate, 1, 
                                              SumFIID, SumComm-SumCommNDS,
                                              Docum,
                                              INPCARRY, "",
                                              "",//OperCode,
                                              Ground, null, null, null,
                                              null, ReceiverFIID, null, null, null, null, null,
                                              null, null, null, null, MC_PAIRACCMODE_MANUAL
                                            )
            )                                               
              return false;
          end;
         
        end;
      end;

      if( ((NotResident == "") AND (Client == -1)) OR (IsCommBank) ) /*(контрагент-резидент и сделка наша) или комиссия банку - делаем проводку по НДС*/     
                  
        if( IsCommBank )
          ReceiverAccount = "-НДС";
          ReceiverFIIDNDS = null;
        else
          GroundNDS = Ground0 + ", НДС";
        end;

        if( not ПроводкаПоКатегориямУчета( FD, 
                                            PayerAccountNDS, ReceiverAccount, 
                                            OperDate, 1, 
                                            SumFIID, SumCommNDS, 
                                            Docum,
                                            INPCARRY, "",
                                            "",//OperCode,
                                            GroundNDS, null, null, null,
                                            null, ReceiverFIIDNDS
                                          )
          )
            return false;        
        end;       
      end;

      if( not(IsCommBank) and (PartyKind == PTK_MARKETPLASE) )
        DataSum.AddData(0, SumComm, SumFIID, MarketSchemeID, DocID);
      end;
    end;
  end;
   
  return true;
END;

MACRO ВыполнитьПроводкиПоСнятиюСВнебаланса( Docum:variant, oper:variant, FD )

   record DebAcc ("account.dbt");
   record CredAcc ("account.dbt");
   var DebCat:string = "", CredCat:string = "";
   var DebRole:integer = "", CredRole:integer = "";
   var DebRest:money = $0, CredRest:money = $0;
   var DebSum:money = $0, CredSum:money = $0;
   var DebFIID = NATCUR, CredFIID = NATCUR;
   var ground = " " + FD.FI.Rec.NAME + ", сделка N " + FD.DEAL.rec.extcode + " от " + StrSubSt(String(FD.deal.rec.date:f), ".", "/") + iif(FD.DEAL.rec.type=="S"," по продаже ПФИ "," по покупке ПФИ ");

   ClearRecord(DebAcc);
   ClearRecord(CredAcc);

   /* c. Выполнить проводки по снятию с внебаланса */
   ПолучитьВнебалансовыеСчетаБирж( FD, @CredCat, @CredFIID, @CredRole, @DebCat, @DebFIID, @DebRole, true, true );

   if( (FD.ActualAccount( DebCat, null, false, DebRole, DebAcc, oper.Date, DebFIID  ) == false) OR
       (FD.ActualAccount( CredCat, null, false, CredRole, CredAcc, oper.Date, CredFIID ) == false)
   )
      return false;
   end;

   if( ( (DebAcc.Account != "")  AND ((DebRest = DL_GetRestAccount( DebAcc, oper.Date )) != $0  ) ) AND
       ( (CredAcc.Account != "") AND ((CredRest = DL_GetRestAccount( CredAcc, oper.Date )) != $0) )
                                          )
      FD.SetFIIDForCorAccNum(CredAcc.Code_Currency);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         "СчКорреспГлаваГ", CredAcc,
                                         oper.Date, CredAcc.Chapter,
                                         null, null,
                                         Docum,
                                         INPCARRY, "",
                                         "",//oper.Code,
                                         ОснованиеПроводкиПИ(DV_GRNUM_OUT_REQ) + ground, /*Списание требований*/
                                         null, FIROLE_CORACC_ACTIVE, null, null, null,
                                         CredAcc.Code_Currency, abs(CredRest)
      )
      )
         return false;
      end;

      FD.SetFIIDForCorAccNum(DebAcc.Code_Currency);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         DebAcc, "СчКорреспГлаваГ",
                                         oper.Date, DebAcc.Chapter,
                                         DebAcc.Code_Currency, abs(DebRest),
                                         Docum,
                                         INPCARRY, "",
                                         "",//oper.Code,
                                         ОснованиеПроводкиПИ(DV_GRNUM_OUT_COM) + ground, /*Списание бязательств*/
                                         null, null, FIROLE_CORACC_PASSIVE
                                       )
      )
         return false;
      end;

   end;

   return true;
END;

MACRO ВыполнитьПроводкиПоСнятиюСВнебалансаТЕГ( Docum:variant, oper:variant, FD, ON:money, NN:money, OS:money, NS:money )
   /*PNV - перестало работать с 16.12.19. Суммы требований\обязательств перепутаны местами. Как раньше работало??? Пытаемся исправить*/

   record DebAcc ("account.dbt");
   record CredAcc ("account.dbt");
   var DebCat:string = "", CredCat:string = "";
   var DebRole:integer = "", CredRole:integer = "";
   var DebRest:money = $0, CredRest:money = $0;
   var DebSum:money = $0, CredSum:money = $0;
   var DebFIID = NATCUR, CredFIID = NATCUR;
//TEG взято с корректировкивнебаланса
   var IsBaseDV:bool = false; /*базовый ФИ = ПИ*/
   var ВЦ = ПолучитьВалютуЦеныПИ(FD), ВБА = ПолучитьВалютуБазовогоАктиваПИ(FD);
   var ClassName = StrUpr( GenClassName( FD ));    
   var IsDeal:bool = false;
   var СуммаВЦ:money = $0, СуммаВБА:money = $0;
   var IsIncreaseRequirement = true;
   var ground="";
   VAR ReqOrCom:string = "";/*PNV*/
   var ПФИ_НаВалюту = ((FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY) OR (FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_CURRENCY) or (FD.BaseFI.rec.FI_Kind == FIKIND_INDEX) OR (FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_INDEX));

   ClearRecord(DebAcc);
   ClearRecord(CredAcc);
   if( ClassName == StrUpr("DVFirstDocDeal") )
      IsDeal = true;
      ground=" " + FD.v_FI.Rec.NAME + ", сделка N "+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")
            +iif(FD.DEAL.rec.type=="S"," по продаже ПФИ "," по покупке ПФИ ")+", количество "+string(abs(NN - ON)/*FD.DEAL.rec.amount*/:*:*,5,0);
 
   end;
   /* c. Выполнить проводки по снятию с внебаланса */
   ПолучитьВнебалансовыеСчетаБирж( FD, @CredCat, @CredFIID, @CredRole, @DebCat, @DebFIID, @DebRole, true );

   if( (FD.ActualAccount( DebCat, null, false, DebRole, DebAcc, oper.Date, DebFIID  ) == false) OR /*Обяз*//*PNV*/
       (FD.ActualAccount( CredCat, null, false, CredRole, CredAcc, oper.Date, CredFIID ) == false) /*треб*//*PNV*/
   )
      return false;
   end;

   if( ( (DebAcc.Account != "")  AND ((DebRest = DL_GetRestAccount( DebAcc, oper.Date )) != $0  ) ) AND
       ( (CredAcc.Account != "") AND ((CredRest = DL_GetRestAccount( CredAcc, oper.Date )) != $0) )
                                          )
  //TEG посчитаем суммы
    /*Учет на счете Форвадр, ПФИ*/
   var  Пн = NN,
       _Пн = NN - ON;

   if(not IsDeal and 
                   ( ((Пн < 0) and (_Пн < 0)) or ((Пн > 0) and (_Пн > 0)) )
     ) /* увеличение стоимости позиции */
     if( (((Пн < 0) and (_Пн < 0)) and FD.PositionByOptionPUT()) or
          (((Пн > 0) and (_Пн > 0)) and (FD.PositionByFutures() OR FD.PositionByOptionCALL()))
        )
        
         DebFIID    = ВБА;
         CredFIID   = ВЦ;
     else
         DebFIID    = ВЦ;
         CredFIID   = ВБА;
     end;
   else   /*Уменьшение стоимости позиции*/
      IsIncreaseRequirement = false;
      var IsBuyFutures = false;
      var IsBuyOptionCall  = false;
      var IsSaleOptionPut = false;

      if(IsDeal == true)
        IsBuyFutures = FD.DealWithFutures() and FD.IsBuy();
        IsBuyOptionCall = FD.IsBuy() and FD.DealWithOptionCALL();
        IsSaleOptionPut = FD.IsSale() and FD.DealWithOptionPUT();
      end;

      if( ( (IsDeal == true) and  (FD.УсловиеПоСтороне() == true)  and (IsBuyFutures or IsBuyOptionCall or IsSaleOptionPut) )
          OR
          ( (IsDeal == false) and ( (((Пн > 0) and (_Пн < 0)) and (FD.PositionByFutures() OR FD.PositionByOptionCALL())) or       /*Пвбб*/
          (((Пн < 0) and (_Пн > 0)) and FD.PositionByOptionPUT()) )
          )
        )
         DebFIID    = ВЦ;
         CredFIID   = ВБА;
      else
         DebFIID    = ВБА;
         CredFIID   = ВЦ;
      end;
     end;

    СуммаВЦ  = abs(NS-OS);

   /*PNV 516413 нужно чтобы не терять копейку при списании с внебаланса
  Списание со сделки уже было, и сумма была посчитана с округлением до 2-х знаков, а тут мы считаем без округления, и как итог - зависает копейка на счете*/
   if ( (fd.deal.rec.amount) != abs(NN - ON) ) /*списана часть*/
      if( ПФИ_НаВалюту )
        if(( FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY ) or ( FD.BaseFI.rec.FI_Kind == FIKIND_INDEX ))
           СуммаВБА = Round(abs(NN - ON)*FD.FI.rec.FaceValue,2);
        else
           СуммаВБА = Round(abs(NN - ON) * FD.FI.rec.FaceValue * FD.BaseFI.rec.FaceValue,2);
        end; 
      elif (  (not FD.isClient()) and FD.DealWithFutures()    and 
            (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE)   and 
            (FD.FI.rec.Settlement_Code == DVSETTLEMET_CALC) and
            (  (FD.BASEFI_NOTDV.rec.fi_code == "GOLD") or 
               (FD.BASEFI_NOTDV.rec.fi_code == "SILV") or 
               (FD.BASEFI_NOTDV.rec.fi_code == "PLT")  or 
           (FD.BASEFI_NOTDV.rec.fi_code == "PLD")) )
            СуммаВБА = round( (fd.deal.rec.amount*31.1035) - Round(31.1035 *(fd.deal.rec.amount - abs(NN - ON)), 2), 2);
			if(FD.deal.rec.date == oper.Date)
				СуммаВЦ = FD.deal.rec.price;
			else
				if( ПолучитьКурсЗаданногоTипа(@СуммаВЦ, FD.V_FI.rec.FIID, ВЦ, RATETYPE_CALC_PRICE, oper.Date-1, true) == false)
				  msgbox( "Не задан курс вида \"Расчетная цена\ для фьючерса <" + FD.V_FI.rec.FI_Code + "> за дату операции." );
				  return 1;
				end;
			end;
            СуммаВЦ = round( fd.deal.rec.amount * СуммаВЦ, 2) -Round((fd.deal.rec.amount - abs(NN - ON))*СуммаВЦ,2);
      else
         СуммаВБА = round( (FD.Deal.rec.cost*fd.deal.rec.amount) - Round(FD.Deal.rec.cost *(fd.deal.rec.amount - abs(NN - ON)), 2), 2);
      end;
   else
      if( ПФИ_НаВалюту )
        if(( FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY ) or ( FD.BaseFI.rec.FI_Kind == FIKIND_INDEX ))
           СуммаВБА = Round(abs(NN - ON)*FD.FI.rec.FaceValue,2);
        else
           СуммаВБА = Round(abs(NN - ON) * FD.FI.rec.FaceValue * FD.BaseFI.rec.FaceValue,2);
        end; 
      elif (  (not FD.isClient()) and FD.DealWithFutures() and 
            (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE) and 
            (FD.FI.rec.Settlement_Code == DVSETTLEMET_CALC) and
            (  (FD.BASEFI_NOTDV.rec.fi_code == "GOLD") or 
               (FD.BASEFI_NOTDV.rec.fi_code == "SILV") or 
               (FD.BASEFI_NOTDV.rec.fi_code == "PLT") or 
           (FD.BASEFI_NOTDV.rec.fi_code == "PLD")) )
            СуммаВБА = Round(abs(NN - ON)*31.1035,2);
			if(FD.deal.rec.date == oper.Date)
				СуммаВЦ = FD.deal.rec.price;
			else
				if( ПолучитьКурсЗаданногоTипа(@СуммаВЦ, FD.V_FI.rec.FIID, ВЦ, RATETYPE_CALC_PRICE, oper.Date-1, true) == false)
				  msgbox( "Не задан курс вида \"Расчетная цена\ для фьючерса <" + FD.V_FI.rec.FI_Code + "> за дату операции." );
				  return 1;
				end;
			end;
            СуммаВЦ = Round(abs(NN - ON)*СуммаВЦ,2);
      else
         СуммаВБА = Round(abs(NN - ON)*FD.Deal.rec.cost,2);
      end;
   end;

   /* Определяется, требования или обязательства  переоценивались в зависимости от знака позиции, как еще корректно указать по какому счету списывать с переоценкой, а по какому - без... */
   if( FD.УсловиеПоСторонеПоРасчЦене() )
       ReqOrCom = "О";
   else
       ReqOrCom = "Т";
   end;

   if( ReqOrCom == "Т")
         DebSum   = СуммаВБА;
         CredSum  = СуммаВЦ;
   else 
       DebSum   = СуммаВЦ;
       CredSum  = СуммаВБА;
   end;
   /*PNV*/

      FD.SetFIIDForCorAccNum(CredAcc.Code_Currency);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         "СчКорреспГлаваГ", CredAcc, /*треб*//*PNV*/
                                         oper.Date, CredAcc.Chapter,
                                         null, null,
                                         Docum,
                                         INPCARRY, "",
                                         "",//oper.Code,
                                         ОснованиеПроводкиПИ(DV_GRNUM_OUT_REQ)+ground, /*Списание требований*/
                                         null, FIROLE_CORACC_ACTIVE, null, null, null,
                                         CredAcc.Code_Currency, abs(CredSum)//abs(CredRest)
      )
      )
         return false;
      end;

      FD.SetFIIDForCorAccNum(DebAcc.Code_Currency);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         DebAcc, "СчКорреспГлаваГ",  /*Обяз*//*PNV*/
                                         oper.Date, DebAcc.Chapter,
                                         DebAcc.Code_Currency, abs(DebSum),//abs(DebRest),
                                         Docum,
                                         INPCARRY, "",
                                         "",//oper.Code,
                                         ОснованиеПроводкиПИ(DV_GRNUM_OUT_COM)+ground, /*Списание бязательств*/
                                         null, null, FIROLE_CORACC_PASSIVE
                                       )
      )
         return false;
      end;

   end;

   return true;
END;

MACRO ВыполнитьПроводкиПоПостановкеНаВнебаланс( Docum:variant, oper:variant, FD, NN:money, NS:money )

   record DebAcc ("account.dbt");
   record CredAcc ("account.dbt");
   var DebSum:money = $0, CredSum:money = $0, Sum:money = $0, СуммаВЦ:money = $0, СуммаВБА:money = $0;
   var DebFIID:integer = ALLFININSTR, CredFIID:integer = ALLFININSTR,
       FiRoleDeb:integer = FIROLE_UNDEF, FiRoleCred:integer = FIROLE_UNDEF,
       CatDeb:string = "", CatCred:string = "";
   var ground; 

   var ВЦ:integer  = ПолучитьВалютуЦеныПИ(FD);
   var ВБА:integer = ПолучитьВалютуБазовогоАктиваПИ(FD);
   var IsBaseDV:bool = false;
   var ПФИ_НаВалюту = ((FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY) OR (FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_CURRENCY) or (FD.BaseFI.rec.FI_Kind == FIKIND_INDEX) OR (FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_INDEX));

   if( NS != $0 )

    if (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE)
      ПолучитьВнебалансовыеСчетаБиржАртикул( FD, @CatDeb, @DebFIID, @FiRoleDeb, @CatCred, @CredFIID, @FiRoleCred );
    else  
      ПолучитьВнебалансовыеСчетаБирж( FD, @CatDeb, @DebFIID, @FiRoleDeb, @CatCred, @CredFIID, @FiRoleCred, false, true );
    end;

     if( (FD.ActualCheckPeriod( CatDeb,  null, false, FiRoleDeb,  DebAcc,  oper.Date, DebFIID  ) == false) or
          (FD.ActualCheckPeriod( CatCred, null, false, FiRoleCred, CredAcc, oper.Date, CredFIID ) == false)
      )
         return false;
      end;

       СуммаВЦ = abs(NS);

         /* если фьючерс или опцион на валюту или опцион на фьючерс на валюту */
         /* определим еще и вторую сумму проводки в валюте базового актива*/
     if( ПФИ_НаВалюту )
        if(( FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY ) or ( FD.BaseFI.rec.FI_Kind == FIKIND_INDEX ))
           СуммаВБА = Abs(NN) * FD.FI.rec.FaceValue;
        else
           СуммаВБА = Abs(NN) * FD.FI.rec.FaceValue * FD.BaseFI.rec.FaceValue;
        end;
     elif   (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE) 
         if ((FD.BASEFI_NOTDV.rec.fi_code=="BR") or (FD.BASEFI_NOTDV.rec.fi_code=="CL")) 
            СуммаВБА= FD.DEAL.REC.PRICE*FD.v_FI.rec.FaceValue ;//стоимость в условных пунктах на количество
            //TEG переопределим сумму ВЦ в валюту, берем из расчетной цены
            if (not  ПолучитьКурсЗаданногоTипа( @СуммаВЦ, FD.V_FI.rec.FIID,0 , RATETYPE_CALC_PRICE, oper.Date, true ))
                СуммаВЦ= 0;
            else
                СуммаВЦ=СуммаВЦ*FD.v_FI.rec.FaceValue;
            end;
	      else  
            /*ВРЕМЕННОЕ РЕШЕНИЕ ДЛЯ ОШИБОЧНЫХ ФЬЮЧЕРСОВ НА ДМ*/
            if ((not FD.isClient()) and FD.DealWithFutures()  and (FD.FI.rec.Settlement_Code == DVSETTLEMET_CALC) and 
                  ((FD.BASEFI_NOTDV.rec.fi_code=="GOLD") or 
                  (FD.BASEFI_NOTDV.rec.fi_code=="SILV") or 
                  (FD.BASEFI_NOTDV.rec.fi_code=="PLT") or 
                  (FD.BASEFI_NOTDV.rec.fi_code=="PLD")) )
               СуммаВБА = Abs(NN) * FD.FI.rec.FaceValue * 31.1035;
               СуммаВЦ = Abs(NN) * FD.DEAL.REC.PRICE;
            elif( NOT DV_SmartConvertSum( СуммаВБА, СуммаВЦ, oper.Date, ВЦ, ВБА ) )
               msgbox( "Невозможно сконвертировать из " + ПолучитьКодФинИн(ВЦ) + " в "+ ПолучитьКодФинИн(ВБА) +" сумму ТО на дату " + String(oper.Date) );
              return false;
            end;
	      end;  
     else
        if( NOT DV_SmartConvertSum( СуммаВБА, СуммаВЦ, oper.Date, ВЦ, ВБА ) )
           msgbox( "Невозможно сконвертировать из " + ПолучитьКодФинИн(ВЦ) + " в "+ ПолучитьКодФинИн(ВБА) +" сумму ТО на дату " + String(oper.Date) );
           return false;
        end;
     end;

      if(not FD.УсловиеПоСторонеПоРасчЦене())
        DebSum   = СуммаВЦ;
        CredSum  = СуммаВБА;
      else 
        DebSum   = СуммаВБА;
        CredSum  = СуммаВЦ;
      end;

      if( (DebAcc.Account != "") and (CredAcc.Account != "") )

        FD.SetFIIDForCorAccNum(DebAcc.Code_Currency);
	//TEG 27.02.19
        ground="";	
	ground=" "+FD.v_FI.Rec.NAME+", сделка N "+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+iif(FD.DEAL.rec.type=="S"," по продаже ПФИ "," по покупке ПФИ ")+", количество "+string(FD.DEAL.rec.amount:*:*,5,0);
	if   (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE) 
          if ((FD.BASEFI_NOTDV.rec.fi_code=="BR") or (FD.BASEFI_NOTDV.rec.fi_code=="CL")) 
              ground=" "+FD.v_FI.Rec.NAME+", сделка N "+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+iif(FD.DEAL.rec.type=="S"," по продаже ПФИ "," по покупке ПФИ ")+", количество "+string(FD.DEAL.rec.amount:*:*,5,0); 
	  end;
	end;      
        /*проводка требований*/
        if( not ПроводкаПоКатегориямУчета( FD, 
                                           DebAcc, "СчКорреспГлаваГ",
                                           oper.Date, DebAcc.Chapter, 
                                           DebAcc.Code_Currency, DebSum, 
                                           Docum,
                                           INPCARRY, "",
                                           "",//oper.Code,
                                           ОснованиеПроводкиПИ(DV_GRNUM_IN_REQ)+ground, /*Поставнока требований на внебалансовый учет*/ 
                                           NULL,
                                           null, FIROLE_CORACC_ACTIVE
                                        )
         )
           return false;
        end;

        FD.SetFIIDForCorAccNum(CredAcc.Code_Currency);
        /*проводка обязательств*/
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "СчКорреспГлаваГ", CredAcc,
                                           oper.Date, CredAcc.Chapter,
                                           null, null,
                                           Docum,
                                           INPCARRY, "",
                                           "",//oper.Code,
                                           ОснованиеПроводкиПИ(DV_GRNUM_IN_COM)+ground, /*Поставнока обязательств на внебалансовый учет*/ 
                                           NULL,
                                           FIROLE_CORACC_PASSIVE, null,
                                           null, null,
                                           CredAcc.Code_Currency, CredSum
                                          )
         )
            return false;        
         end;             
      end;
   end;

   return true;
END;

MACRO ВыполнитьПроводкиПоКорректировкеВнебаланса( Docum:variant, oper:variant, FD, ON:money, NN:money, OS:money, NS:money ) 

   record DebAcc ("account.dbt");
   record CredAcc ("account.dbt");
   var DebSum:money = $0, CredSum:money = $0, Sum:money = $0;
   var DebCat1:string = "", CredCat1:string = "", DebCat2:string = "", CredCat2:string = "";
   var IsBaseDV:bool = false; /*базовый ФИ = ПИ*/
   var ВЦ = ПолучитьВалютуЦеныПИ(FD), ВБА = ПолучитьВалютуБазовогоАктиваПИ(FD),
       DebFIID = NATCUR, CredFIID = NATCUR, FiRoleDeb, FiRoleCred;
   var IsDeal:bool = false;
   var ClassName = StrUpr( GenClassName( FD ));
   var СуммаВЦ:money = $0, СуммаВБА:money = $0;
   var IsIncreaseRequirement = true;
   var ground;

   if( ClassName == StrUpr("DVFirstDocDeal") )
      IsDeal = true;
      //TEG 27.02.19
      ground=" "+FD.v_FI.Rec.NAME+", сделка N "+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/")+iif(FD.DEAL.rec.type=="S"," по продаже ПФИ "," по покупке ПФИ ")+", количество "+string(FD.DEAL.rec.amount:*:*,5,0);
   end;

   /*Учет на счете Форвадр, ПФИ*/
   if( FD.BaseFI.rec.FI_Kind == FIKIND_DERIVATIVE )
      IsBaseDV = true;
   else
      IsBaseDV = false;
   end;

   ClearRecord(DebAcc);
   ClearRecord(CredAcc);

   var  Пн = NN,
       _Пн = NN - ON;

   var OneDayFut = ( DL_GetMainObjAttr( FD.FI, DV_ATTR_GROUP_ONEDAYFUT, OBJTYPE_DV ) == 2 );

   if(not IsDeal and 
                   ( ((Пн < 0) and (_Пн < 0)) or ((Пн > 0) and (_Пн > 0)) )
     ) /* увеличение стоимости позиции */
      if(OneDayFut)
        DebCat1     = "+Форвард, бессрочные"; 
        CredCat1    = "-Форвард, бессрочные"; 
      else
        DebCat1     = "+Форвард, ФО"; 
        CredCat1    = "-Форвард, ФО";
      end; 

      if( (((Пн < 0) and (_Пн < 0)) and FD.PositionByOptionPUT()) or
          (((Пн > 0) and (_Пн > 0)) and (FD.PositionByFutures() OR FD.PositionByOptionCALL()))
        )
        
         DebFIID    = ВБА;
         FiRoleDeb  = FIROLE_FIDOC;
         CredFIID   = ВЦ;
         FiRoleCred = FIROLE_PRICEFI;
      else
         DebFIID    = ВЦ;
         FiRoleDeb  = FIROLE_PRICEFI;
         CredFIID   = ВБА;
         FiRoleCred = FIROLE_FIDOC;
      end;
   else   /*Уменьшение стоимости позиции*/
      if(OneDayFut)
        DebCat1     = "-Форвард, бессрочные"; 
        CredCat1    = "+Форвард, бессрочные"; 
      else
        DebCat1     = "-Форвард, ФО"; 
        CredCat1    = "+Форвард, ФО";
      end;
 
      IsIncreaseRequirement = false;
      var IsBuyFutures = false;
      var IsBuyOptionCall  = false;
      var IsSaleOptionPut = false;

      if(IsDeal == true)
        IsBuyFutures = FD.DealWithFutures() and FD.IsBuy();
        IsBuyOptionCall = FD.IsBuy() and FD.DealWithOptionCALL();
        IsSaleOptionPut = FD.IsSale() and FD.DealWithOptionPUT();
      end;

      if( ( (IsDeal == true) and  (FD.УсловиеПоСтороне() == true)  and (IsBuyFutures or IsBuyOptionCall or IsSaleOptionPut) )
          OR
          ( (IsDeal == false) and ( (((Пн > 0) and (_Пн < 0)) and (FD.PositionByFutures() OR FD.PositionByOptionCALL())) or       /*Пвбб*/
          (((Пн < 0) and (_Пн > 0)) and FD.PositionByOptionPUT()) )
          )
        )
         DebFIID    = ВЦ;
         FiRoleDeb  = FIROLE_PRICEFI;
         CredFIID   = ВБА;
         FiRoleCred = FIROLE_FIDOC;
      else
         DebFIID    = ВБА;
         FiRoleDeb  = FIROLE_FIDOC;
         CredFIID   = ВЦ;
         FiRoleCred = FIROLE_PRICEFI;
      end;
   end;

   if( (FD.OpenAccount( DebCat1, null, false, FiRoleDeb, DebAcc, oper.Date, DebFIID ) == false) OR
       (FD.OpenAccount( CredCat1, null, false, FiRoleCred, CredAcc, oper.Date, CredFIID ) == false)
     )
      return false;
   end;

   if( (DebAcc.Account != "") AND (CredAcc.Account != "") )
      СуммаВЦ  = abs(NS-OS);
      /* если фьючерс или опцион на валюту или опцион на фьючерс на валюту */
      /* определим еще и вторую сумму проводки в валюте базового актива */
      if( (FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY) OR (FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_CURRENCY) or ( FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_INDEX )  or ( FD.BaseFI.rec.FI_Kind == FIKIND_INDEX ) )
         if(( FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY ) or ( FD.BaseFI.rec.FI_Kind == FIKIND_INDEX ) )
            СуммаВБА = Abs(NN-ON) * FD.FI.rec.FaceValue;
         else
            СуммаВБА = Abs(NN-ON) * FD.FI.rec.FaceValue * FD.BaseFI.rec.FaceValue;
         end;
      else
        /* if( NOT DV_SmartConvertSum( СуммаВБА, СуммаВЦ, oper.Date, ВЦ, ВБА ) )
            msgbox( "Невозможно сконвертировать из " + ПолучитьКодФинИн(ВЦ) + " в "+ ПолучитьКодФинИн(ВБА) +" сумму ТО на дату " + String(oper.Date) );
            return false;
         end;*/
         if (  (not FD.isClient()) and FD.DealWithFutures() and 
               (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE)  and 
               (FD.FI.rec.Settlement_Code == DVSETTLEMET_CALC) and
               (  (FD.BASEFI_NOTDV.rec.fi_code=="GOLD") or 
                  (FD.BASEFI_NOTDV.rec.fi_code=="SILV") or 
                  (FD.BASEFI_NOTDV.rec.fi_code=="PLT") or 
           (FD.BASEFI_NOTDV.rec.fi_code=="PLD")) )
            СуммаВБА = Round(abs(NN - ON)*31.1035,2);
			if(FD.deal.rec.date == oper.Date)
				СуммаВЦ = FD.deal.rec.price;
			else
				if( ПолучитьКурсЗаданногоTипа(@СуммаВЦ, FD.V_FI.rec.FIID, ВЦ, RATETYPE_CALC_PRICE, oper.Date-1, true) == false)
				  msgbox( "Не задан курс вида \"Расчетная цена\ для фьючерса <" + FD.V_FI.rec.FI_Code + "> за дату операции." );
				  return 1;
				end;
			end;
            СуммаВЦ = Round(abs(NN - ON)*СуммаВЦ,2);
         else
            СуммаВБА = Round(abs(NN - ON)*FD.Deal.rec.cost,2);
         end;
     end;

    // потом убрать  if( DebFIID == ВЦ )
    //     DebSum   = СуммаВЦ;
    //     CredSum  = СуммаВБА;
    //  else
         DebSum   = СуммаВБА;
         CredSum  = СуммаВЦ;
    //  end;

   /*ВРЕМЕННОЕ РЕШЕНИЕ, не знаю зачем выше было закомментировано, но выделю отдельно для нашего случая, чтобы не отломить что-то по другому функционалу*/
    if ((not FD.isClient()) and FD.DealWithFutures() and 
	(FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_ARTICLE)  and 
	(FD.FI.rec.Settlement_Code == DVSETTLEMET_CALC) and
           ((FD.BASEFI_NOTDV.rec.fi_code=="GOLD") or 
           (FD.BASEFI_NOTDV.rec.fi_code=="SILV") or 
           (FD.BASEFI_NOTDV.rec.fi_code=="PLT") or 
           (FD.BASEFI_NOTDV.rec.fi_code=="PLD")) )
       if( DebFIID == ВЦ )
         DebSum   = СуммаВЦ;
         CredSum  = СуммаВБА;
      else
         DebSum   = СуммаВБА;
         CredSum  = СуммаВЦ;
      end;
   end;
    if  ( (FD.BASEFI_NOTDV.rec.FI_KIND==FIKIND_INDEX) and (ВБА != NATCUR) and (ВЦ == NATCUR)) /*DEF-36162 фьючерс на индекс, цена в рублях, базовый актив - валюта*/
         /*if( NOT DV_SmartConvertSum( СуммаВБА, СуммаВЦ, oper.Date, ВЦ, ВБА ) )
           msgbox( "Невозможно сконвертировать из " + ПолучитьКодФинИн(ВЦ) + " в "+ ПолучитьКодФинИн(ВБА) +" сумму ТО на дату " + String(oper.Date) );
           return false;
        end;  
         СуммаВЦ = FD.DEAL.rec.price*abs(NN - ON);*/       
         if( DebFIID == ВЦ )
             DebSum   = СуммаВЦ;
             CredSum  = СуммаВБА;
         else
             DebSum   = СуммаВБА;
             CredSum  = СуммаВЦ;
        end;
  end;
  /*DEF-59279 фьючерс на индекс*/
  if( (FD.FI.rec.AvoirKind == DERIVATIVE_FUTURES) and (FD.BaseFI_NotDV.rec.FI_Kind == FIKIND_INDEX) and (FD.BaseFI_NotDV.rec.Settlement_Code == FI_INDEX_CURRENCY) and (ВЦ != NATCUR) )
	if( DebFIID == ВЦ )
             DebSum   = СуммаВЦ;
             CredSum  = СуммаВБА;
         else
             DebSum   = СуммаВБА;
             CredSum  = СуммаВЦ;
        end;
	end;
      if(IsIncreaseRequirement)
      FD.SetFIIDForCorAccNum(DebAcc.Code_Currency);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         DebAcc, "СчКорреспГлаваГ", 
                                         oper.Date, DebAcc.Chapter, 
                                         DebAcc.Code_Currency, DebSum, 
                                         Docum,
                                         INPCARRY, "",
                                        "",// oper.Code,
                                         ОснованиеПроводкиПИ(DV_GRNUM_CORR_REQ)+IIF(IsDeal,ground,""), /*Корректировка требований на внебалансовом учете*/ 
                                         NULL,
                                         null, FIROLE_CORACC_ACTIVE
                                       )
      )
         return false;        
      end;             

      FD.SetFIIDForCorAccNum(CredAcc.Code_Currency);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         "СчКорреспГлаваГ", CredAcc, 
                                         oper.Date, CredAcc.Chapter, 
                                         null, null, 
                                         Docum,
                                         INPCARRY, "",
                                         "",//oper.Code,
                                         ОснованиеПроводкиПИ(DV_GRNUM_CORR_COM)+IIF(IsDeal,ground,""), /*Корректировка обязательств на внебалансовом учете*/ 
                                         NULL,
                                         FIROLE_CORACC_PASSIVE, null, 
                                         null, null, 
                                         CredAcc.Code_Currency, CredSum
                                       )
      )
         return false;        
      end;             
      else
            FD.SetFIIDForCorAccNum(CredAcc.Code_Currency);
            if( not ПроводкаПоКатегориямУчета( FD,
                                               "СчКорреспГлаваГ", CredAcc,
                                               oper.Date, CredAcc.Chapter, 
                                               null, null,
                                               Docum,
                                               INPCARRY, "",
                                              "",// oper.Code,
                                               ОснованиеПроводкиПИ(DV_GRNUM_CORR_REQ)+IIF(IsDeal,ground,""), /*Корректировка требований на внебалансовом учете*/ 
                                               NULL,
                                               FIROLE_CORACC_ACTIVE, null, 
                                               null, null, 
                                               CredAcc.Code_Currency, CredSum
                                             )      
              )
               return false;        
            end;             

            FD.SetFIIDForCorAccNum(DebAcc.Code_Currency);
            if( not ПроводкаПоКатегориямУчета( FD,
                                               DebAcc, "СчКорреспГлаваГ", 
                                               oper.Date, DebAcc.Chapter, 
                                               DebAcc.Code_Currency, DebSum,
                                               Docum,
                                               INPCARRY, "",
                                               "",//oper.Code,
                                               ОснованиеПроводкиПИ(DV_GRNUM_CORR_COM)+IIF(IsDeal,ground,""), /*Корректировка обязательств на внебалансовом учете*/ 
                                               NULL,
                                               NULL,
                                               FIROLE_CORACC_PASSIVE
                                             )
              )
               return false;        
            end;          
      end;

   end;

   return true;
END;

/*делаем проводки на остаток счёта ДС Клиента, ВУ МУ = РЦ биржи/брокер*/
MACRO ПИ_ВУ_ПереводСредствСКлирСчетаКлиента( FD, Doc:MEMADDR, FIID:INTEGER ):BOOL
  record DebAcc(account); 
  record KredAcc(account);
  var sql, DataSql, FD_Contr, KredAccRest = $0, ВидРО = IIF(FD.DVOper.rec.PartyKind == PTK_MARKETPLASE, 4, 5), NumCarry = 0, cnt = 0;

  /*по всем счетам клиентов делаем перевод на счета банка*/
  sql = DL_RSDCommand( " select ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                               " +
                       "   from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dsfcontr_dbt sfcontr                         " +
                       "  where ACCDOC.T_CHAPTER = ?                                                                   " +
                       "    and ACCDOC.T_CURRENCY = ?                                                                  " +
                       "    and ACCDOC.T_CATID = CATEG.T_ID                                                            " +
                       "    and CATEG.T_CODE   = ?                                                                     " +
                       "    and CATEG.T_LEVELTYPE = 1                                                                  " +
                       "    and ACCDOC.T_PLACE                 = ?                                                     " +
                       IIF( FD.DVOper.rec.PartyKind == PTK_MARKETPLASE,
                       "    and ACCDOC.T_MARKETPLACEID         = ?                                                     " +
                       "    and ACCDOC.T_MARKETPLACEOFFICEID   = ?                                                     ", ""
                          ) +
                       "    and ACCDOC.T_CLIENTCONTRID > 0                                                             " +
                       "    and sfcontr.t_ID = ACCDOC.T_CLIENTCONTRID                                                  " +
                       "    and sfcontr.t_servkind = ?                                                                 " +
                       "    and sfcontr.t_DateBegin <= ?                                                               " +
                       "    and (sfcontr.t_DateClose >= ? or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
                       " group by ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                             "
                     );

   sql.addParam( FD.ВУ_ОпределениеГлавы(FIID) );
   sql.addParam( FIID );
   sql.addParam( "ДС Клиента, ВУ" );
   if( FD.DVOper.rec.PartyKind == PTK_MARKETPLASE ) /*Биржа*/
      sql.addParam( FD.DVOper.rec.Centr );
      sql.addParam( FD.DVOper.rec.Centr );
      sql.addParam( FD.DVOper.rec.PartyOffice );
   else
      sql.addParam( FD.DVOper.rec.Party );
   end;
   sql.addParam( PTSK_DV );
   sql.addParam( FD.DVOper.rec.Date );
   sql.addParam( FD.DVOper.rec.Date );

   cnt = sql.GetCount();

   if( cnt > 0 )
      DataSql = sql.execute();
      InitProgress( cnt, "Просмотр клиентов по сделкам ...", "Проводки по клиентам на остаток по счету" );
      while( DataSql.MoveNext() )
         ClearRecord( KredAcc );
         if( DV_GetAccount(FD.ВУ_ОпределениеГлавы(FIID), FIID, DataSql.Account, KredAcc, true ) ) 
            /*берем остаток только если он отрицательный, т.к. счет активный*/
            KredAccRest = max(0,-DL_GetRestAccount( KredAcc, GetDateAfterWorkDays(FD.DVOper.rec.Date, 0) ));

            if( KredAccRest != 0 )
               FD_Contr = DVFirstDocContract(DL_DVCONTR, DataSql.CLIENTCONTRID);
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_FIID, FIID );

               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, null, FD.DVOper.rec.Date, FIID ) )
                  if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, FD.DVOper.rec.Date, FIID ) )
                     UseProgress(NumCarry = NumCarry + 1);
                     continue;
                  end;
               end;

               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  DebAcc, 
                                                  KredAcc,
                                                  FD.DVOper.rec.Date,
                                                  FD.ВУ_ОпределениеГлавы(FIID),
                                                  FIID,
                                                  KredAccRest,
                                                  Doc,
                                                  INPCARRY,
                                                  "",
                                                  "",//FD.DVOper.rec.Code,
                                                  FD.ВУ_ОснованиеПроводки(ВидРО),
                                                  0,
                                                  null, null, null, null, null, null, null, null, 
                                                  true,
                                                  ВидРО 
                                                ) )
                  return false;
               end;
            end;
         end;

         UseProgress( NumCarry = NumCarry + 1 );
      end;
      RemProgress();
   end;

   return true;
END;

/*делаем проводки на остаток счёта ДС Клиента, ВУ МУ = банк*/
MACRO ПИ_ВУ_ПереводСредствНаКлирСчетКлиенту( FD, Doc:MEMADDR, FIID:INTEGER ):BOOL
  record DebAcc(account); 
  record KredAcc(account);
  var sql, DataSql, FD_Contr, KredAccRest = $0, ВидРО = IIF(FD.DVOper.rec.PartyKind == PTK_MARKETPLASE, 2, 3), NumCarry = 0, cnt = 0;

  /*по всем счетам клиентов делаем перевод на счета биржи*/
  sql = DL_RSDCommand( " select ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                        "+
                       "   from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dsfcontr_dbt sfcontr  "+
                       "  where ACCDOC.T_CHAPTER  = ?                                           "+
                       "    and ACCDOC.T_CURRENCY = ?                                           "+
                       "    and ACCDOC.T_CATID    = CATEG.T_ID                                  "+
                       "    and CATEG.T_CODE      = ?                                           "+
                       "    and CATEG.T_LEVELTYPE = 1                                           "+
                       "    and ACCDOC.T_PLACE    = ?                                           "+
                       "    and ACCDOC.T_CLIENTCONTRID       > 0                                "+
                       "    and sfcontr.t_ID = ACCDOC.T_CLIENTCONTRID                           "+
                       "    and sfcontr.t_servkind = ?                                          "+
                       "    and sfcontr.t_DateBegin <= ? " +
                       "    and (sfcontr.t_DateClose >= ? or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
                       " group by ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                      "
                     );             

   sql.addParam( FD.ВУ_ОпределениеГлавы(FIID) );
   sql.addParam( FIID );
   sql.addParam( "ДС Клиента, ВУ" );
   sql.addParam( {OurBank} );
   sql.addParam( PTSK_DV );
   sql.addParam( FD.DVOper.rec.Date );
   sql.addParam( FD.DVOper.rec.Date );

   cnt = sql.GetCount();

   if( cnt > 0 )
      DataSql = sql.execute();
      InitProgress(cnt, "Просмотр клиентов по сделкам...", "Проводки по клиентам на остаток по счету");
      while( DataSql.MoveNext() )
         ClearRecord(KredAcc);
         if( DV_GetAccount(FD.ВУ_ОпределениеГлавы(FIID), FIID, DataSql.Account, KredAcc, true) )
            /* берем остаток только если он отрицательный, т.к. счет активный */
            KredAccRest = max(0, -DL_GetRestAccount(KredAcc, GetDateAfterWorkDays(FD.DVOper.rec.Date, 0)));

            if( KredAccRest != 0 )
               FD_Contr = DVFirstDocContract(DL_DVCONTR, DataSql.ClientContrID);
               FD_Contr.SetParametr(MC_TYPE_PARAMETR_FIID, FIID);
               if( FD.DVOper.rec.PartyKind == PTK_MARKETPLASE ) /*Биржа*/
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_PLACE, FD.DVOper.rec.Centr);
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_MARKET_PLACE, FD.DVOper.rec.Centr);
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE, FD.DVOper.rec.PartyOffice);
               else /*Брокер*/
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_PLACE, FD.DVOper.rec.Party);
               end;

               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount("ДС Клиента, ВУ", null, true, null, DebAcc, null, FD.DVOper.rec.Date, FIID) )
                  if( not FD_Contr.OpenAccount("ДС Клиента, ВУ", null, true, null, DebAcc, FD.DVOper.rec.Date, FIID) )
                     UseProgress(NumCarry = NumCarry + 1);
                     continue;
                  end;
               end;

               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  DebAcc, 
                                                  KredAcc,
                                                  FD.DVOper.rec.Date,
                                                  FD.ВУ_ОпределениеГлавы(FIID),
                                                  FIID,
                                                  KredAccRest,
                                                  Doc,
                                                  INPCARRY,
                                                  "",
                                                  "",//FD.DVOper.rec.Code,
                                                  FD.ВУ_ОснованиеПроводки(ВидРО),
                                                  0,
                                                  null, null, null, null, null, null, null, null, 
                                                  true,
                                                  ВидРО 
                                                ) )
                  return false;
               end;
            end;
         end;

         UseProgress(NumCarry = NumCarry + 1);
      end;
      RemProgress();
   end;

   return true;
END;

/*Расчеты с биржей: делаем проводки на остаток счёта ДС Клиента, ВУ МУ = банк*/
MACRO ПИ_ВУ_РасчетыПереводНаКлирСчетКлиенту( FD:DVFirstDocDLCOMM, Doc:MEMADDR, FIID:INTEGER ):BOOL
  record DebAcc(account); 
  record KredAcc(account);
  var sql, DataSql, FD_Contr, KredAccRest = $0, ВидРО = IIF(FD.IsMARKET(), 2, 3), NumCarry = 0, cnt = 0;
  var Chapter = FD.ВУ_ОпределениеГлавы(FIID);
  var ServKind, TransferDate = FD.comm.rec.CommDate;

  if( FD.IsStockMarket() )
     ServKind = PTSK_STOCKDL;
  elif( FD.IsCurMarket() )
     ServKind = PTSK_CM;
  else
     ServKind = PTSK_DV;
  end;

  /*по всем счетам клиентов делаем перевод на счета биржи*/
  sql = DL_RSDCommand( " select ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                        "+
                       "   from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dsfcontr_dbt sfcontr  "+
                       "  where ACCDOC.T_CHAPTER  = ?                                           "+
                       "    and ACCDOC.T_CURRENCY = ?                                           "+
                       "    and ACCDOC.T_CATID    = CATEG.T_ID                                  "+
                       "    and CATEG.T_CODE      = ?                                           "+
                       "    and CATEG.T_LEVELTYPE = 1                                           "+
                       "    and ACCDOC.T_PLACE    = ?                                           "+
                       "    and ACCDOC.T_CLIENTCONTRID       > 0                                "+
                       "    and sfcontr.t_ID = ACCDOC.T_CLIENTCONTRID                           "+
                       "    and sfcontr.t_servkind = ?                                          "+
                       "    and sfcontr.t_DateBegin <= ? " +
                       "    and (sfcontr.t_DateClose >= ? or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
                       " group by ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                      "
                     );             

   sql.addParam( Chapter );
   sql.addParam( FIID );
   sql.addParam( "ДС Клиента, ВУ" );
   sql.addParam( {OurBank} );
   sql.addParam( ServKind );
   sql.addParam( TransferDate );
   sql.addParam( TransferDate );
   
   cnt = sql.GetCount();

   if( cnt > 0 )
      DataSql = sql.execute();
      InitProgress(cnt, "Просмотр клиентов по сделкам...", "Проводки по клиентам на остаток по счету");
      while( DataSql.MoveNext() )
         ClearRecord(KredAcc);
         if( DV_GetAccount(Chapter, FIID, DataSql.Account, KredAcc, true) )
            /* берем остаток только если он отрицательный, т.к. счет активный */
            KredAccRest = max(0, -DL_GetRestAccount(KredAcc, GetDateAfterWorkDays(TransferDate, 0)));

            if( KredAccRest != 0 )
               FD_Contr = DVFirstDocContract(iif(FD.IsStockMarket(),DL_STOCKCONTR,DL_DVCONTR), DataSql.ClientContrID);
               FD_Contr.SetParametr(MC_TYPE_PARAMETR_FIID, FIID);
               if( FD.IsMARKET() ) /*Биржа*/
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_PLACE, FD.comm.rec.TraderID);
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_MARKET_PLACE, FD.comm.rec.TraderID);
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE, FD.comm.rec.PartyOfficeID);
               else /*Брокер*/
                  FD_Contr.SetParametr(MC_TYPE_PARAMETR_PLACE, FD.comm.rec.PartyID);
               end;
               
               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount("ДС Клиента, ВУ", null, true, null, DebAcc, null, TransferDate, FIID) )
                  if( not FD_Contr.OpenAccount("ДС Клиента, ВУ", null, true, null, DebAcc, TransferDate, FIID) )
                     UseProgress(NumCarry = NumCarry + 1);
                     continue;
                  end;
               end;
               
               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  DebAcc, 
                                                  KredAcc,
                                                  TransferDate,
                                                  Chapter,
                                                  FIID,
                                                  KredAccRest,
                                                  Doc,
                                                  INPCARRY,
                                                  "",
                                                  FD.comm.rec.CommCode,
                                                  FD.ВУ_ОснованиеПроводки(ВидРО),
                                                  0,
                                                  null, null, null, null, null, null, null, null, 
                                                  true,
                                                  ВидРО 
                                                ) )
                  return false;
               end;
            end;
         end;

         UseProgress(NumCarry = NumCarry + 1);
      end;
      RemProgress();
   end;

   return true;
END;

/*Расчеты с биржей: делаем проводки на остаток счёта ДС Клиента, ВУ МУ = РЦ биржи/брокер*/
MACRO ПИ_ВУ_РасчетыВыводСКлирСчетаКлиента( FD:DVFirstDocDLCOMM, Doc:MEMADDR, FIID:INTEGER ):BOOL
  record DebAcc(account); 
  record KredAcc(account);
  var sql, Query, DataSql, FD_Contr, KredAccRest = $0, ВидРО = IIF(FD.IsMARKET(), 4, 5), NumCarry = 0, cnt = 0;
  var Chapter = FD.ВУ_ОпределениеГлавы(FIID);
  var ServKind, TransferDate = FD.comm.rec.CommDate;

  if( FD.IsStockMarket() )
     ServKind = PTSK_STOCKDL;
  elif( FD.IsCurMarket() )
     ServKind = PTSK_CM;
  else
     ServKind = PTSK_DV;
  end;

  sql = DL_RSDCommand();

  /*по всем счетам клиентов делаем перевод на счета банка*/
  Query = " select ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                       " +
          "   from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, dsfcontr_dbt sfcontr " +
          "  where ACCDOC.T_CHAPTER = ?                                           " +
          "    and ACCDOC.T_CURRENCY = ?                                          " +
          "    and ACCDOC.T_CATID = CATEG.T_ID                                    " +
          "    and CATEG.T_CODE   = ?                                             " +
          "    and CATEG.T_LEVELTYPE = 1                                          " +
          "    and ACCDOC.T_PLACE    = ?                                          ";

  sql.addParam( Chapter );
  sql.addParam( FIID );
  sql.addParam( "ДС Клиента, ВУ" );

  if( FD.IsMARKET() )
     sql.addParam( FD.comm.rec.TraderID );
     Query = Query +
             "    and ACCDOC.T_MARKETPLACEID         = ? " +
             "    and ACCDOC.T_MARKETPLACEOFFICEID   = ? ";
     sql.addParam( FD.comm.rec.TraderID );
     sql.addParam( FD.comm.rec.PartyOfficeID );
  else
     sql.addParam( FD.comm.rec.PartyID );
  end;

  Query = Query +
          "    and ACCDOC.T_CLIENTCONTRID > 0                                                             " +
          "    and sfcontr.t_ID = ACCDOC.T_CLIENTCONTRID                                                  " +
          "    and sfcontr.t_servkind = ?                                                                 " +
          "    and sfcontr.t_DateBegin <= ?                                                               " +
          "    and (sfcontr.t_DateClose >= ? or sfcontr.t_DateClose = TO_DATE('01.01.0001','DD.MM.YYYY')) " +
          " group by ACCDOC.T_CLIENTCONTRID, ACCDOC.T_ACCOUNT                                             ";

   sql.addParam( ServKind );
   sql.addParam( TransferDate );
   sql.addParam( TransferDate );

   cnt = sql.GetCount();

   if( cnt > 0 )
      DataSql = sql.execute();
      InitProgress( cnt, "Просмотр клиентов по сделкам ...", "Проводки по клиентам на остаток по счету" );
      while( DataSql.MoveNext() )
         ClearRecord( KredAcc );
         if( DV_GetAccount(Chapter, FIID, DataSql.Account, KredAcc, true ) ) 
            /*берем остаток только если он отрицательный, т.к. счет активный*/
            KredAccRest = max(0,-DL_GetRestAccount( KredAcc, GetDateAfterWorkDays(TransferDate, 0) ));

            if( KredAccRest != 0 )
               FD_Contr = DVFirstDocContract(iif(FD.IsStockMarket(),DL_STOCKCONTR,DL_DVCONTR), DataSql.CLIENTCONTRID);
               FD_Contr.SetParametr( MC_TYPE_PARAMETR_FIID, FIID );

               ClearRecord( DebAcc );
               if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, null, TransferDate, FIID ) )
                  if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, true, null, DebAcc, TransferDate, FIID ) )
                     UseProgress(NumCarry = NumCarry + 1);
                     continue;
                  end;
               end;

               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  DebAcc, 
                                                  KredAcc,
                                                  TransferDate,
                                                  Chapter,
                                                  FIID,
                                                  KredAccRest,
                                                  Doc,
                                                  INPCARRY,
                                                  "",
                                                  FD.comm.rec.CommCode,
                                                  FD.ВУ_ОснованиеПроводки(ВидРО),
                                                  0,
                                                  null, null, null, null, null, null, null, null, 
                                                  true,
                                                  ВидРО 
                                                ) )
                  return false;
               end;
            end;
         end;

         UseProgress( NumCarry = NumCarry + 1 );
      end;
      RemProgress();
   end;

   return true;
END;

MACRO ВыполнитьПлатежПереводаВозвратаСредств( FD, oper, doc, Amount, FIID, Amount_Clir, FIID_Clir, Action, IsRepayment )

 //TEG  03.12.18
  if (FD.DVOPER.REC.operkind!=12600)
    return SayCarryError( "Выполнение данной операции невозможно!" );
  end;
   var pm = TRecHandler("pmpaym.dbt");
   
   record paym( pmpaym );
   record DebProp( pmprop );
   record KredProp( pmprop );
   record RmProp( pmrmprop );
   var PaymentID = 0, StrErr = "", OperKind = "";
   var PMObj = NULL;

   var OperDate  = oper.Date;               
   var PartyKind = oper.PartyKind;

   var PayerAccBuf    = TRecHandler("account"),
       ReceiverAccBuf = TRecHandler("account"),
       ClirAccBuf     = TRecHandler("account");

   var VOGround = "";

   var PayerName:string = "", ReceiverName:string = "", PayerBankName:string = "", ReceiverBankName:string = "";
   var NeedPayment:bool = ((Amount > 0.0) and ((Action != DV_KINDTRANS_RETURN_CLEARING_ACCOUNT) and (Action != DV_KINDTRANS_TRANSFER_CLEARING_ACCOUNT)));
   var NeedClirAcc:bool = ((PartyKind == PTK_MARKETPLASE) and (Amount_Clir > 0.0) and ((Action == DV_KINDTRANS_RETURN) or (Action == DV_KINDTRANS_RETURN_CLEARING_ACCOUNT) or (Action == DV_KINDTRANS_TRANSFER) or (Action == DV_KINDTRANS_TRANSFER_CLEARING_ACCOUNT) or (Action == DV_KINDTRANS_FROM_OTHER_KLIR_ACC)));
   var NeedMarketAcc:bool = ((PartyKind == PTK_MARKETPLASE) and (Amount > 0.0) and ((Action == DV_KINDTRANS_RETURN) or (Action == DV_KINDTRANS_TRANSFER_TRADING_ACCOUNT) or (Action == DV_KINDTRANS_TRANSFER) or (Action == DV_KINDTRANS_RETURN_TRADING_ACCOUNT)));


  //teg 03.12.18
  if (FD.DVOPER.REC.operkind==12600)
    NeedPayment = not NeedPayment ;
    NeedClirAcc = not NeedClirAcc ;
    NeedMarketAcc = not NeedMarketAcc ;
    if (not NeedClirAcc)
      Amount= Amount_Clir;
      FIID  = FIID_Clir  ;
    end;
  end;

   ClearRecord( PayerAccBuf );
   ClearRecord( ReceiverAccBuf );

   DVOP_CarryError = "";

   if( (Amount <= 0.0) and (Amount_Clir <= 0.0) )
      MsgBox("Не задана сумма");
      return false;
   elif( (FIID == ALLFININSTR) and (FIID_Clir == ALLFININSTR) )
     MsgBox("Не задана валюта");
     return false;
   end;

   if( NeedClirAcc and (not NeedMarketAcc) )
      FIID = FIID_Clir;/*торговый счет в проводке должен быть с той же валютой, что и клиринговый счет (так по крайней мере было раньше)*/
   end;

   if( NeedPayment )
      PMObj = RsbPayment(-1);
      if( not PMObj )
         MsgBox("Ошибка при создании платежа");
         return false;
      end;

      if( IsRepayment ) 
         if(PartyKind == PTK_MARKETPLASE)  /*  расчеты с биржей  */
           //TEG VOGround = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_MARKET);
              VOGround = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_CLIR);
         else
            VOGround = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_BROKER);
         end;
      else
         if( PartyKind == PTK_MARKETPLASE)
          //TEG  VOGround = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_MARKET);
            VOGround = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_CLIR2);
         else
            VOGround = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_BROKER);
         end
      end;

      /* заполняем назначение платежа ???*/
      if( not IsRepayment )
         paym.Purpose = PM_PURP_ORDER;
      else
         paym.Purpose = PM_PURP_REPAYMENT;
      end;

      /* заполняем валюту и сумму платежа */
      paym.FIID = FIID;
      paym.Amount = Amount;
      paym.BaseFIID = FIID;
      paym.BaseAmount = Amount;
      paym.OrderAmount = Amount;
      paym.OrderFIID = FIID;                
      paym.PayFIID = FIID;
   end;

   /* находим счета дебета */
   /* Счет по Дт:
         в валюте перевода по документу 
      "Расчеты по ПИ" (с открытием). Отправитель - наш банк.
      ·  В расчетах с брокером берется из договора с брокером, указанным в операции,  в валюте 
      перемещения (брать счет в другой валюте нельзя). Отправитель - клиент по счету.
   */

   if( PartyKind == PTK_MARKETPLASE ) /* расчеты с биржей */

      if( NeedClirAcc )
         if(Action != DV_KINDTRANS_FROM_OTHER_KLIR_ACC)
            if( not FD.IsExistAccount( IIF((DL_ЕдиныйПулОбеспеченияСобств == 1), IIF( FD.IsClient(), "Клиринговый счет1", "+Обеспечение"), "Клиринговый счет"), null, null, null, ClirAccBuf, null, OperDate, FIID_Clir ) )
                return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(FIID_Clir) );
             end;
         else
             if( not FD.IsExistAccount( IIF((DL_ЕдиныйПулОбеспеченияСобств == 1), IIF( FD.IsClient(), "Клиринговый счет1", "+Обеспечение"), "Клиринговый счет"), null, false, null, ClirAccBuf, null, OperDate, FIID_Clir ) )
                return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(FIID_Clir) );
             end;
         end;
      end;

      if( not IsRepayment ) /* перевод */
         if(Action != DV_KINDTRANS_FROM_OTHER_KLIR_ACC)
           //teg  if( not FD.IsExistAccount( "Торговый счет", null, null, null, PayerAccBuf, null, OperDate, FIID ) )
             if( not FD.IsExistAccount( IIF((DL_ЕдиныйПулОбеспеченияСобств == 1), IIF( FD.IsClient(), "Клиринговый счет1", "+Обеспечение"), "Клиринговый счет"), null, null, null, PayerAccBuf, null, OperDate, FIID ) )
               // return SayCarryError( "Ошибка: не открыт торговый счет в валюте FIID = " + String(FIID) );
                  return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(FIID_Clir) );
             end;
         else
            if( not FD.IsExistAccount( IIF((DL_ЕдиныйПулОбеспеченияСобств == 1), IIF( FD.IsClient(), "Клиринговый счет1", "+Обеспечение"), "Клиринговый счет"), null, false, FIROLE_ORCB_OTHCLIRACC, PayerAccBuf, NULL, OperDate, FIID_Clir ) )
                return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(FIID_Clir) );
             end;
         end;

         if( NeedPayment )
            paym.PayerAccount = PayerAccBuf.rec.Account;
            paym.Payer = {OurBank};
            paym.PayerBankID = {OurBank};
         end;
      else /* вывод */
         
        //TEG if( not FD.IsExistAccount( "Торговый счет", null, null, null, ReceiverAccBuf, null, OperDate, FIID ) )
          //teg  return SayCarryError( "Ошибка: не открыт торговый счет в валюте FIID = " + String(FIID) );
         if( not FD.IsExistAccount( IIF((DL_ЕдиныйПулОбеспеченияСобств == 1), IIF( FD.IsClient(), "Клиринговый счет1", "+Обеспечение"), "Клиринговый счет"), null, null, null, ReceiverAccBuf, null, OperDate, FIID ) )
            return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(FIID_Clir) );
         end;

         //TEG 04.12.18 убрал проверку так как не используем торговый счет
         if( NeedMarketAcc and (not NeedClirAcc) )
            /*по торговому проверяем остаток*/
            if(( ABS(DL_GetRestAccount( ReceiverAccBuf.rec, null )) < Amount ) and (FD.DVOPER.REC.operkind!=12600))
               return SayCarryError( "Заданная сумма превышает остаток по торговому счету" );
            end;
         end;

         if( NeedClirAcc )
            /*по клиринговому проверяем остаток*/
            if( ABS(DL_GetRestAccount( ClirAccBuf.rec, null )) < Amount_Clir )
               return SayCarryError( "Заданная сумма превышает остаток по клиринговому счету" );
            end;
         end;

         if( NeedPayment )
            paym.ReceiverAccount = ReceiverAccBuf.rec.Account;
            paym.Receiver = {OurBank};
            paym.ReceiverBankID = {OurBank};
         end;
      end;
   elif( PartyKind == PTK_BROKER ) /* расчеты с брокером */
      if( oper.PartyContr >  0 )
         var BrokerAccount = ПолучитьСчетИзДоговора(oper.PartyContr/*договор брокера*/, FIID, false); /*счет брокера получаем из договора с брокером*/
         if( BrokerAccount != "" )
            if( not IsRepayment )
               paym.PayerAccount = BrokerAccount;
               if( DV_GetAccount( 1, FIID, paym.PayerAccount, PayerAccBuf ) == false )
                  return SayCarryError( "Ошибка при получении счета " + paym.PayerAccount + " расчетов с брокером " );
               end;                      
               paym.Payer = PayerAccBuf.rec.Client;
               paym.PayerBankID = {OurBank};
            else
               paym.ReceiverAccount = BrokerAccount;
               if( DV_GetAccount( 1, FIID, paym.ReceiverAccount, ReceiverAccBuf ) == false )
                  return SayCarryError( "Ошибка при получении счета " + paym.ReceiverAccount + " расчетов с брокером " );
               end;                      
               paym.Receiver = ReceiverAccBuf.rec.Client;
               paym.ReceiverBankID = {OurBank};
            end;
         else
            return SayCarryError( "Ошибка: не найден счет расчетов с брокером в валюте FIID = " + String(FIID) );
         end;
      end;
   end;

   if( NeedPayment )
      /* находим счета кредита */
      /* Получатель - контрагент по расчетам, счет по Кт определяется по автогенерации. */
      if( not IsRepayment )
         paym.Receiver       = oper.Party;
         paym.ReceiverBankID = oper.Centr;
      else
         paym.Payer       = oper.Party;
         paym.PayerBankID = oper.Centr;
      end;
     
      if( DV_FillPayments( oper.DocKind, oper.ID, oper, paym, DebProp, KredProp, RmProp, VOGround, iif(PartyKind == PTK_MARKETPLASE, true, false), StrErr ) )
         MsgBox( "Ошибка при формировании платежа.\n" + StrErr );
         return false;
      end;
     
      PMObj.Purpose          = paym.Purpose;   
      PMObj.SubPurpose       = paym.SubPurpose;
      PMObj.PaymStatus       = paym.PaymStatus;
      PMObj.DocKind          = paym.DocKind;   
      PMObj.DocumentID       = paym.DocumentID;
      PMObj.BaseFIID         = paym.BaseFIID;
      PMObj.ValueDate        = paym.ValueDate; 
      PMObj.Department       = paym.Department;
      PMObj.IsPlanPaym       = paym.IsPlanPaym;
      PMObj.BaseAmount       = paym.BaseAmount;
      PMObj.Ground           = VOGround;
      PMObj.OrderFIID        = paym.OrderFIID;
      PMObj.OrderAmount      = paym.orderAmount;
      PMObj.IsFixPayerAmount = paym.IsFixAmount;
      PMObj.PayerAmount      = paym.Amount;
      PMObj.ReceiverAmount   = paym.PayAmount;
     
      /*Параметры отправителя/получателя*/
      DV_GetPartyName( paym.Payer, @PayerName );
      DV_GetPartyName( paym.PayerBankID, @PayerBankName );
     
      DV_GetPartyName( paym.Receiver, @ReceiverName );
      DV_GetPartyName( paym.ReceiverBankID, @ReceiverBankName );
     
      PMObj.SetPayerPI( PAYMENTS_GROUP_UNDEF, 
                        paym.PayerBankID, 
                        DebProp.CodeKind, 
                        DebProp.BankCode, 
                        PayerBankName,
                        "",
                        paym.FIID, 
                        1,
                        paym.PayerAccount, 
                        paym.Payer, 
                        PayerName, 
                        ПолучитьКодСубъекта(paym.Payer, PTCK_INN) );
     
      PMObj.SetReceiverPI( PAYMENTS_GROUP_UNDEF,
                           paym.ReceiverBankID,
                           KredProp.CodeKind,
                           KredProp.BankCode,
                           ReceiverBankName,
                           "",
                           paym.FIID,
                           1,
                           paym.ReceiverAccount, 
                           paym.Receiver, 
                           ReceiverName, 
                           ПолучитьКодСубъекта(paym.Receiver, PTCK_INN) );
     
      /*Плательщик*/
      PMObj.PayerDpNode              = paym.PayerDpNode;
      PMObj.PayerBankCorrAcc         = DebProp.CorrAcc;
      PMObj.PayerBankCorrCode        = DebProp.CorrCode;
      PMObj.PayerBankCorrCodeKind    = DebProp.CorrCodeKind;
      PMObj.PayerInOurBalance        = DebProp.InOurBalance;
      PMObj.PayerOurCorrAcc          = DebProp.OurCorrAcc;
      PMObj.PayerOurCorrID           = DebProp.OurCorrID;
      /*Получатель*/
      PMObj.ReceiverDpNode           = paym.ReceiverDpNode;
      PMObj.ReceiverBankCorrAcc      = KredProp.CorrAcc;
      PMObj.ReceiverBankCorrCode     = KredProp.CorrCode;
      PMObj.ReceiverBankCorrCodeKind = KredProp.CorrCodeKind;
      PMObj.ReceiverInOurBalance     = KredProp.InOurBalance;
      PMObj.ReceiverOurCorrAcc       = KredProp.OurCorrAcc;
      PMObj.ReceiverOurCorrID        = KredProp.OurCorrID;
     
      PMObj.Actuate();
      
      paym.PaymentID = PMObj.PaymentID;
      copy(pm, paym);
      DV_SetPaymentGround(pm, -1, FD);
   end;

   /*для биржи вывод с клирингового счета*/
   //TEG 03.12.18
   if (FD.DVOPER.REC.operkind!=12600)
    if( (PartyKind == PTK_MARKETPLASE) and ((Action == DV_KINDTRANS_RETURN) or (Action == DV_KINDTRANS_RETURN_CLEARING_ACCOUNT)) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                         ReceiverAccBuf, ClirAccBuf,
                                         OperDate, 1,
                                         FIID_Clir, Amount_Clir,
                                         doc,
                                         INPCARRY, "", "",
                                         ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_CLIR)
                                       )
        )
         return false;
      end;
    end;
   end;

   if( NeedPayment )
      if( ОбработатьДенежныйПлатеж(paym, DebProp, KredProp, FD, OperDate, doc, VOGround , PayerAccBuf, ReceiverAccBuf) )
         MsgBox( "Ошибка при обработке платежа посреднику" + IIF(PartyKind == PTK_MARKETPLASE, "(бирже)", "(брокеру)") );
         return false;
      end;
   end;

   /*для биржи учет на клиринговом счете*/
   //TEG 03.12.18
   if (FD.DVOPER.REC.operkind!=12600)
    if( (PartyKind == PTK_MARKETPLASE) and ((Action == DV_KINDTRANS_TRANSFER) or (Action == DV_KINDTRANS_TRANSFER_CLEARING_ACCOUNT)) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                         ClirAccBuf, PayerAccBuf,
                                         OperDate, 1,
                                         FIID_Clir, Amount_Clir,
                                         doc,
                                         INPCARRY, "", "",
                                         ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_CLIR)
                                       )
        )
         return false;
      end;
    end;
   end;

   if( (PartyKind == PTK_MARKETPLASE) and (Action == DV_KINDTRANS_FROM_OTHER_KLIR_ACC) )
      if( not ПроводкаПоКатегориямУчета( FD,
                                         ClirAccBuf, PayerAccBuf,
                                         OperDate, 1,
                                         FIID_Clir, Amount_Clir,
                                         doc,
                                         INPCARRY, "", "",
                                         "Зачисление на текущий клиринговый счет с другого клирингового счета."
                                       )
        )
         return false;
      end;
   end;

   if( NeedPayment )
      if( FD.IsClient() )
         if( not IsRepayment ) /* не возврат средств */
            if( (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 1) or (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3) )
               if( not ПИ_ВУ_ПереводСредствНаКлирСчетКлиенту(FD, doc, paym.FIID) )
                  return false;
               end;
            end;
         else
            if( ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3 )
               if( not ПИ_ВУ_ПереводСредствСКлирСчетаКлиента(FD, doc, paym.FIID) )
                  return false;
               end;
            end;
         end;
      else
         if( PartyKind == PTK_MARKETPLASE )
            if( IsRepayment == true )
               OperKind = 4;
            else
               OperKind = 2;
            end;
         else
            if( IsRepayment == true)
               OperKind = 5;
            else
               OperKind = 3;
            end;
         end;

         if( paym.FIID != NATCUR )
            FD.SetBankID( GetCorrID(IIF(IsRepayment, DebProp.CorSchem, KredProp.CorSchem), paym.FIID, FIKIND_CURRENCY) );
         end;
         FD.SetParametr( MC_TYPE_PARAMETR_FIID, paym.FIID );
         if( not ПроводкаПоКатегориямВнутреннегоУчета( OperKind,
                                                       FD,
                                                       Doc,
                                                       OperDate,
                                                       paym.FIID,
                                                       paym.Amount
                                                     )
           )
            return false;
         end;
      end;
   end;

   return true;
END;

MACRO ВыполнитьПроводкуУчетаВозвратаГарантий( FD, oper, Doc, Amount, FIID, ClientContr, Client, IsRepayment )

   var OperDate    = oper.Date;
   var OperCode    = oper.Code;
   var PartyKind   = oper.PartyKind;
   var BrokerContr = 0;
   var КатегорияДебета = "", КатегорияКредита = "", Ground = "";
   var Account;
   var DebAccBuf  = TRecHandler("account"),
       CredAccBuf = TRecHandler("account");
   var AccNumber = "";

   DVOP_CarryError = "";

   if( (PartyKind == PTK_MARKETPLASE) and (Client == -1) ) /* расчеты с биржей  */
      if( not IsRepayment )
         КатегорияДебета  = "Гарантийный счет";
         КатегорияКредита = "Торговый счет";
         Ground = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_GUARANT);
      else
         КатегорияДебета  = "Торговый счет";
         КатегорияКредита = "Гарантийный счет";
         Ground = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_GUARANT);;
      end;

      /*счета в любом случае должны быть открыты*/
      if( not FD.IsExistAccount( КатегорияКредита, null, null, null, CredAccBuf, null, OperDate, FIID  ) )   
         return SayCarryError( "Ошибка: не открыт счет категории \""+КатегорияКредита+"\" в валюте FIID = " + String(FIID) );
      end;
      if( not FD.IsExistAccount( КатегорияДебета, null, null, null, DebAccBuf, null, OperDate, FIID ) )   
         return SayCarryError( "Ошибка: не открыт счет категории \""+КатегорияДебета+"\" в валюте FIID = " + String(FIID) );
      end;

   elif( (PartyKind == PTK_BROKER) and (Client == -1) ) /* расчеты с брокером */
      BrokerContr = oper.PartyContr;
      if( not IsRepayment )
         КатегорияДебета   = "+ОД";
         КатегорияКредита  = "Счет брокера из договора";
         Ground = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_GUARANT);
      else
         КатегорияДебета   = "Счет брокера из договора";
         КатегорияКредита  = "+ОД";
         Ground = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_GUARANT);;
      end;
   elif( ClientContr > 0 ) /* клиент задан */
      if( not IsRepayment)
          КатегорияДебета   = "Счет клиента из договора";
          КатегорияКредита  = "-Расчеты";
          Ground = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_GUARANT);
      else
          КатегорияДебета   = "-Расчеты";
          КатегорияКредита  = "Счет клиента из договора";
          Ground = ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_GUARANT);;
      end;
   end;

   if( BrokerContr >  0 )
      /*счет брокера получаем из договора с брокером*/
      if( not IsRepayment )          
         if( (Account = ПолучитьСчетИзДоговора( BrokerContr, FIID, false )) != "" )
            if( DV_GetAccount( 1, FIID, Account, CredAccBuf ) == false )
               return SayCarryError( "Ошибка при получении счета " + Account + " расчетов с брокером " );
            end;  
         else
            return SayCarryError( "Ошибка: не найден счет расчетов с брокером в валюте FIID = " + String(FIID) );      
         end;
      else
         if( (Account = ПолучитьСчетИзДоговора( BrokerContr, FIID, false )) != "" )
            if( DV_GetAccount( 1, FIID, Account, DebAccBuf ) == false )
               return SayCarryError( "Ошибка при получении счета " + Account + " расчетов с брокером " );
            end; 
         else
            return SayCarryError( "Ошибка: не найден счет расчетов с брокером в валюте FIID = " + String(FIID) );         
         end;
      end;
   end;
 
   if( ClientContr > 0 )
      if( not IsRepayment )
         /*счет клиента получаем из договора с клиентом*/
         if( (AccNumber = ПолучитьСчетИзДоговора( ClientContr, FIID, true )) != "" )
            if( DV_GetAccount( 1, FIID, AccNumber, DebAccBuf ) == false )
               return SayCarryError( "Ошибка при получении счета " + Account + " расчетов с клиентом " );
            end;
         else
            return false;               
         end;
      else
         if( (AccNumber = ПолучитьСчетИзДоговора( ClientContr, FIID, true )) != "" )
            if( DV_GetAccount( 1, FIID, AccNumber, CredAccBuf ) == false )
               return SayCarryError( "Ошибка при получении счета " + Account + " расчетов с клиентом " );
            end;                      
         else
            return false;               
         end;      
      end;
   end;

   if( CredAccBuf.rec.Account == "" )
      if( not IsRepayment and (Client == -1) )
         if( not FD.ActualAccount( КатегорияКредита, null, null, FIROLE_SETTL_AGENT, CredAccBuf, OperDate, FIID ) )
            return false;
         end;
      else
         if( not FD.OpenAccount( КатегорияКредита, null, null, FIROLE_SETTL_AGENT, CredAccBuf, OperDate, FIID ) )
            return false;
         end;
      end;
   end;

   if( DebAccBuf.rec.Account == "" )
      if( not IsRepayment and (Client == -1) )
         if( not FD.OpenAccount( КатегорияДебета, null, null, FIROLE_SETTL_AGENT, DebAccBuf, OperDate, FIID ) )
            return false;
         end;
      else
         if( not FD.ActualAccount( КатегорияДебета, null, null, FIROLE_SETTL_AGENT, DebAccBuf, OperDate, FIID ) )
            return false;
         end;
      end;
   end;

/*  if(not IsRepayment)
     if( (ClientContr > 0) and 
         (ABS(DL_GetRestAccount( DebAccBuf.rec, null )) < Amount) )
        return SayCarryError( "Недостаточно средств на счете клиента " + DebAccBuf.rec.Account );
     elif( (BrokerContr > 0) and 
           (ABS(DL_GetRestAccount( CredAccBuf.rec, null )) < Amount) )
        return SayCarryError( "Недостаточно средств на счете брокера " + CredAccBuf.rec.Account + "\n Необходимо выполнить шаг перевода средств брокеру.");
     elif( (ABS(DL_GetRestAccount( CredAccBuf.rec, null )) < Amount) and 
           (ClientContr == 0) and 
           (BrokerContr == 0) ) 
        return SayCarryError( "Недостаточно средств на торговом счете " + CredAccBuf.rec.Account + "\n Необходимо выполнить шаг перевода средств на торговый счет.");
     end;
   end;
  */
   if( not ПроводкаПоКатегориямУчета( FD,
                                      DebAccBuf, CredAccBuf,
                                      OperDate, DebAccBuf.rec.Chapter,
                                      FIID, Amount,
                                      Doc,
                                      INPCARRY, "",
                                     "",// OperCode,
                                      Ground
                                    ) 
   )
      return false;
   end;

   return true;
END;

MACRO ВыполнитьПроводкуПеремещенияУБрокера( FD, oper, Doc, TransAccount, Amount, FIID, IsFrom )

   var   OperDate       =  oper.Date;               
   var   OperCode       =  oper.Code;
   var   PartyKind      =  oper.PartyKind;
   var   BrokerContr    =  oper.PartyContr;
   var   Ground         =  ОснованиеПроводкиПИ(DV_GRNUM_TRANS_BROKER);
   var   Account; 
   var   DebAccBuf    = TRecHandler("account"),
         CredAccBuf   = TRecHandler("account");

   ClearRecord( DebAccBuf );
   ClearRecord( CredAccBuf );

   DVOP_CarryError = "";

/*  Счета по Дт и Кт  определяются направлением перевода, задаваемым в панели
      - Если перевод "С лицевого счета", то счет Дт. задается в панели, а счет Кт берется из 
        договора с брокером в валюте проводки.
      - Если перевод "На лицевой счет", то счет Дт берется из договора с брокером в валюте проводки, 
        а счет Кт задается в проводке.
*/
   if( IsFrom )
      if( DV_GetAccount( 1, FIID, TransAccount, CredAccBuf ) == false )
         return SayCarryError( "Ошибка: не найден лицевой счет" + TransAccount );
      end;                      
      if( (Account = ПолучитьСчетИзДоговора( BrokerContr, FIID, true )) != "" )
         if( DV_GetAccount( 1, FIID, Account, DebAccBuf ) == false )
            return SayCarryError( "Ошибка: не найден счет брокера в валюте FIID = " + FIID );
         end;                      
      end;
   else
      if( DV_GetAccount( 1, FIID, TransAccount, DebAccBuf ) == false )
         return SayCarryError( "Ошибка: не найден лицевой счет" + TransAccount );
      end;                      
      if( (Account = ПолучитьСчетИзДоговора( BrokerContr, FIID, true )) != "" )
         if( DV_GetAccount( 1, FIID, Account, CredAccBuf ) == false )
            return SayCarryError( "Ошибка: не найден счет брокера в валюте FIID = " + FIID );
         end;                      
      end;
   end;

   if( ABS(DL_GetRestAccount( CredAccBuf.rec, null )) < Amount )
      if( IsFrom )
         return SayCarryError( "Заданная сумма превышает остаток по счету брокера" );
      else
         return SayCarryError( "Заданная сумма превышает остаток по счету " + Account );
      end;
   end;

   if( not ПроводкаПоКатегориямУчета( FD,
                                      DebAccBuf, CredAccBuf,
                                      OperDate, DebAccBuf.rec.Chapter,
                                      FIID, Amount,
                                      Doc,
                                      INPCARRY, "",
                                      "",//OperCode,
                                      Ground
                                    )
     )
      return false;
   end;

   if( FD.IsClient() )
      if( not IsFrom )
         if( (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 1) or (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3) )
            if( not ПИ_ВУ_ПереводСредствНаКлирСчетКлиенту(FD, doc, FIID) )
               return false;
            end;
         end;
      else
         if( ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3 )
            if( not ПИ_ВУ_ПереводСредствСКлирСчетаКлиента(FD, doc, FIID) )
               return false;
            end;
         end;
      end;
   else
      FD.SetParametr(MC_TYPE_PARAMETR_FIID, FIID);
      if( not ПроводкаПоКатегориямВнутреннегоУчета( IIF(IsFrom,5,3),
                                                    FD,
                                                    Doc,
                                                    OperDate,
                                                    FIID,
                                                    Amount
                                                  ) )
          return false;
      end;
   end;

   return true;
END;

MACRO ВыполнитьПроводкуУрегулирПарнБирж( FD, FD_Oper, Doc, DataSum )

  var ExchangePlus = TRecHandler("account");
  var ExchangeMinus = TRecHandler("account");
  var AccPlusRest, AccMinusRest;
  var DeltaRest = 0, Ground = "Урегулирование парных счетов. Перенос остатка со счета ";

  ExchangePlus.clear();
  ExchangeMinus.clear();
  DVOP_CarryError = "";

  if( (DataSum.Currency == NATCUR) OR
      (
        ((DataSum.Currency != NATCUR) and (FD.DVOper.rec.Flag1==2)) or
        ((DataSum.Currency != NATCUR) and (FD.DVOper.rec.Flag1==1) and (DL_ЕдиныйПулОбеспеченияСобств==0))
      )
    )
  
      if( not FD.OpenAccount( "+Биржа", null, null, null, ExchangePlus, FD_Oper.DVOper.rec.Date, DataSum.Currency, null, null, MC_PAIRACCMODE_MANUAL ) )
          return SayCarryError("Ошибка при открытии счета категории \"+Биржа\" в валюте FIID = " + String(DataSum.Currency));
      end;

      if( not FD.OpenAccount( "-Биржа", null, null, null, ExchangeMinus, FD_Oper.DVOper.rec.Date, DataSum.Currency, null, null, MC_PAIRACCMODE_MANUAL ) )
          return SayCarryError("Ошибка при открытии счета категории \"-Биржа\" в валюте FIID = " + String(DataSum.Currency));
      end;

      if( (DataSum.DebetSum != $0) and (DataSum.CreditSum != $0) )
           DeltaRest = (DataSum.DebetSum  - DataSum.CreditSum );
           if(DeltaRest >= $0)
              Ground = Ground +string(ExchangeMinus.rec.Account)+" на счет "+string(ExchangePlus.rec.Account);
              if( not ПроводкаПоКатегориямУчета( FD,
                                           ExchangeMinus, ExchangePlus,
                                           FD_Oper.DVOper.rec.Date,
                                           1,
                                           NATCUR, DataSum.CreditSum,
                                           doc,
                                           INPCARRY, "", "",
                                           Ground
                                         )
                 )
                 return 1;
             end;
           else/*DeltaRest < 0)*/
             Ground = Ground +string(ExchangePlus.rec.Account)+" на счет "+string(ExchangeMinus.rec.Account);
             if( not ПроводкаПоКатегориямУчета( FD,
                                           ExchangeMinus, ExchangePlus,
                                           FD_Oper.DVOper.rec.Date,
                                           1,
                                           NATCUR, DataSum.DebetSum,
                                           doc,
                                           INPCARRY, "", "",
                                           Ground
                                         )
                )
                return 1;
             end;
           end;
      end;
  end;
  
  return true;
END;

MACRO ВыполнитьПроводкуВозвратаСредств_CLIENT( FD, FD_Oper, Doc, DataSum )

  var ClirAccBuf = TRecHandler("account");
  var ExchangePlus = TRecHandler("account");
  var ExchangeMinus = TRecHandler("account");

  ClirAccBuf.clear();  
  ExchangePlus.clear();
  ExchangeMinus.clear();
  DVOP_CarryError = "";

  if( (DataSum.Currency == NATCUR) OR
      (
        ((DataSum.Currency != NATCUR) and (FD.DVOper.rec.Flag1==2)) or
        ((DataSum.Currency != NATCUR) and (FD.DVOper.rec.Flag1==1) and (DL_ЕдиныйПулОбеспеченияСобств==0))
      )
    )
    if( not FD.OpenAccount( "+Биржа", null, null, null, ExchangePlus, FD_Oper.DVOper.rec.Date, DataSum.Currency ) )
     return SayCarryError("Ошибка при открытии счета категории \"+Биржа\" в валюте FIID = " + String(DataSum.Currency));
  end;

    if( not FD.OpenAccount( "-Биржа", null, null, null, ExchangeMinus, FD_Oper.DVOper.rec.Date, DataSum.Currency ) )
     return SayCarryError("Ошибка при открытии счета категории \"-Биржа\" в валюте FIID = " + String(DataSum.Currency));
  end;

  if((DataSum.CreditSum > 0) or (DataSum.DebetSum > 0))
// dan> вернул к дистрибутиву
//     if( not FD.IsExistAccount( IIF((DL_ЕдиныйПулОбеспеченияСобств == 1), IIF( FD.IsClient(), "Клиринговый счет1", "+Обеспечение"), "Клиринговый счет"), null, null, null, ClirAccBuf, null, FD_Oper.DVOper.rec.Date, DataSum.Currency ) )
     if( not FD.IsExistAccount(  "Клиринговый счет", null, null, null, ClirAccBuf, null, FD_Oper.DVOper.rec.Date, DataSum.Currency ) )
// <dan
        return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(DataSum.Currency) );
     end;
  end;

  if( DataSum.DebetSum > 0 )
     if( not ПроводкаПоКатегориямУчета( FD_Oper,
                                        ClirAccBuf, ExchangePlus,
                                          FD_Oper.DVOper.rec.Date, ClirAccBuf.rec.Chapter,
                                        DataSum.Currency, DataSum.DebetSum,
                                        Doc,
                                        INPCARRY, "",
                                       "",// FD_Oper.DVOper.rec.Code,
                                        ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_CREDIT)
                                      )
       )
          return false;
     end;
  end;

  if( DataSum.CreditSum > 0 )
     if( not ПроводкаПоКатегориямУчета( FD_Oper,
                                        ExchangePlus/*ExchangeMinus*/, ClirAccBuf,
                                          FD_Oper.DVOper.rec.Date, ClirAccBuf.rec.Chapter,
                                        DataSum.Currency, DataSum.CreditSum,
                                        Doc,
                                        INPCARRY, "",
                                       "",// FD_Oper.DVOper.rec.Code,
                                       ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_DEBIT)
                                      )
       )
          return false;
     end;
  end;
  end;

  return true;
END;

MACRO ВыполнитьПроводкуВозвратаСредств( FD, FD_Oper, Doc, DataSum, AccMarketNumber )

  var ClirAccBuf = TRecHandler("account");
  var ExchangePlus = TRecHandler("account");
  var ExchangeMinus = TRecHandler("account");
  var DeltaRest = 0;

  ClirAccBuf.clear();  
  ExchangePlus.clear();
  ExchangeMinus.clear();
  DVOP_CarryError = "";

  if( (DataSum.Currency == NATCUR) OR
      (
        ((DataSum.Currency != NATCUR) and (FD.DVOper.rec.Flag1==2)) or
        ((DataSum.Currency != NATCUR) and (FD.DVOper.rec.Flag1==1) and (DL_ЕдиныйПулОбеспеченияСобств==0))
      )
    )
       if( not FD.OpenAccount( "+Биржа", null, null, null, ExchangePlus, FD_Oper.DVOper.rec.Date, DataSum.Currency, null, null, MC_PAIRACCMODE_MANUAL ) )
          return SayCarryError("Ошибка при открытии счета категории \"+Биржа\" в валюте FIID = " + String(DataSum.Currency));
       end;

       if( not FD.OpenAccount( "-Биржа", null, null, null, ExchangeMinus, FD_Oper.DVOper.rec.Date, DataSum.Currency, null, null, MC_PAIRACCMODE_MANUAL ) )
          return SayCarryError("Ошибка при открытии счета категории \"-Биржа\" в валюте FIID = " + String(DataSum.Currency));
       end;

    if((DataSum.CreditSum > 0) or (DataSum.DebetSum > 0))
      DeltaRest = (DataSum.DebetSum - DataSum.CreditSum);
      if( not FD.IsExistAccount(  "Клиринговый счет", null, null, null, ClirAccBuf, null, FD_Oper.DVOper.rec.Date, DataSum.Currency ) )
        return SayCarryError( "Ошибка: не открыт клиринговый счет в валюте FIID = " + String(DataSum.Currency) );
     end;
    end;

    if( DeltaRest > 0 )
     if( not ПроводкаПоКатегориямУчета( FD_Oper,
                                        ClirAccBuf, ExchangePlus,
                                        FD_Oper.DVOper.rec.Date, ClirAccBuf.rec.Chapter,
                                        DataSum.Currency, ABS(DeltaRest),
                                        Doc,
                                        INPCARRY, "",
                                        "",// FD_Oper.DVOper.rec.Code,
                                        ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_CREDIT) 
                                      )
       )
          return false;
     end;

    elif( DeltaRest < 0 )
     if( not ПроводкаПоКатегориямУчета( FD_Oper,
                                        ExchangeMinus, ClirAccBuf,
                                        FD_Oper.DVOper.rec.Date, ClirAccBuf.rec.Chapter,
                                        DataSum.Currency, ABS(DeltaRest),
                                        Doc,
                                        INPCARRY, "",
                                        "",// FD_Oper.DVOper.rec.Code,
                                        ОснованиеПроводкиПИ(DV_GRNUM_TRANS_OUT_DEBIT)
                                      )
       )
          return false;
     end;
    end;
  end;

  return true;
END;

MACRO ВыполнитьПроводкиПереоценкиСС( Docum, FD:variant, oper:variant, AvoirKind:integer, SumFIID:integer,
                                     PaydBonus:money, ReceivedBonus:money, СС_т:money, СС_н:money
                                   ): bool
   var OperDate = oper.Date;
   var OperCode = oper.Code;
   var Sum = $0, СС = $0, Bonus = $0, СС_check = $0;
   var IsDeal:bool = false;
   var ClassName = StrUpr( GenClassName( FD ));
   var ground="";

   if( ClassName == StrUpr("DVFirstDocDeal") )
      IsDeal = true;
      //TEG 27.02.19
      ground=Get_FinameDVFUN(FD.DEAL.rec.fiid)+", сделка N"+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/");          
   end;

   if( AvoirKind == DERIVATIVE_OPTION )
      if( NOT DV_SmartConvertSum( Bonus, Abs(ReceivedBonus - PaydBonus), oper.Date, SumFIID, NATCUR ) )
         return SayCarryError( "Невозможно сконвертировать из " + ПолучитьКодФинИн(SumFIID) + " в рубли сумму премии на дату " + String(oper.Date) );
      end;
   end;

   СС = СС_т - СС_н;
   if( (AvoirKind == DERIVATIVE_FUTURES) or ((СС_н < СС_т) and (IsDeal == true) and (OperDate != FD.Deal.rec.Date)) )
      Sum = Abs(СС);
   else
      Sum = Abs(Abs(СС) - Bonus);
   end;

   if( Sum != $0 )
      /*
      ПФИ является обязательством
      СС_т<0 (для уже открытой позиции)
      СС_н<0 (для позиции, открытой в этот день)
      Для этой и обратной проверки, введём переменную СС_check
      */
      if( СС_т != 0 )
         СС_check = СС_т;
      else
         СС_check = СС_н;
      end;

      if( СС_check < 0 )

         if( ((AvoirKind == DERIVATIVE_FUTURES) and (СС_н < СС_т)) OR
             ((AvoirKind == DERIVATIVE_OPTION) and (Abs(СС) > Bonus)) )
            if( not ПроводкаПоКатегориямУчета( FD,
                                               "Расходы ПФИ", "-ПФИ ФО",
                                               OperDate, 1,
                                               NATCUR, Sum,
                                               Docum,
                                               INPCARRY, "",
                                               "",//OperCode,
                                               iif(IsDeal,"Отрицательная вариационная маржа, "+ground, "Учет справедливой стоимости")
                                             ) 
            )
               return false;        
            end;
         elif( ((AvoirKind == DERIVATIVE_FUTURES) and (СС_н > СС_т)) OR
               ((AvoirKind == DERIVATIVE_OPTION) and (Abs(СС) < Bonus)) )
            if( not ПроводкаПоКатегориямУчета( FD, 
                                               "-ПФИ ФО", "Доходы ПФИ",
                                               OperDate, 1, 
                                               NATCUR, Sum,
                                               Docum,
                                               INPCARRY,"",
                                               "",//OperCode,
                                                iif(IsDeal,"Отрицательная вариационная маржа, "+ground, "Учет справедливой стоимости")
                                             ) 
            )
               return false;        
            end;
         end;       
      else
         if( ((AvoirKind == DERIVATIVE_FUTURES) and (СС_н < СС_т)) OR
             ((AvoirKind == DERIVATIVE_OPTION) and (Abs(СС) < Bonus)) )
            if( not ПроводкаПоКатегориямУчета( FD, 
                                               "Расходы ПФИ", "+ПФИ ФО", 
                                               OperDate, 1, 
                                               NATCUR, Sum,
                                               Docum,
                                               INPCARRY,"",
                                               "",//OperCode,
                                               iif(IsDeal,"Положительная вариационная маржа, "+ground, "Учет справедливой стоимости")
                                             ) 
            )
               return false;        
            end;       
         elif( ((AvoirKind == DERIVATIVE_FUTURES) and (СС_н > СС_т)) OR
               ((AvoirKind == DERIVATIVE_OPTION) and (Abs(СС) > Bonus)) )
            if( not ПроводкаПоКатегориямУчета( FD, 
                                               "+ПФИ ФО", "Доходы ПФИ",
                                               OperDate, 1, 
                                               NATCUR, Sum,
                                               Docum,
                                               INPCARRY,"",
                                               "",//OperCode,
                                               iif(IsDeal,"Положительная вариационная маржа, "+ground, "Учет справедливой стоимости")
                                             ) 
            )
               return false;        
            end;       
         end;       
      end;
   end;

   return true;
END;

PRIVATE MACRO ОтражениеФинансовогоРезультата( Docum, FD:variant, oper:variant ):bool

  record Acc ("account.dbt");
  var Rest = $0;

  if( FD.ActualAccount("Выбытие ПФИ", null, false, null, Acc, oper.Date) )
     Rest = DL_GetRestAccount(Acc, oper.Date);

     if( Rest > 0 )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "Выбытие ПФИ", IIF(FD.IsSector(), "+Маржа, ИВ и ДМ", "Доходы ПФИ"),
                                           oper.Date, 1,
                                           NATCUR, Abs(Rest),
                                           Docum,
                                           INPCARRY, "",
                                           "",//oper.Code,
                                           "Отражение финансового результата",
                                           null,
                                           null, IIF(FD.IsSector(), FIROLE_BA, null)
                                         )
          )
           return false;        
        end;       
     else
        if( not ПроводкаПоКатегориямУчета( FD,
                                           IIF(FD.IsSector(), "-Маржа, ИВ и ДМ", "Расходы ПФИ"), "Выбытие ПФИ",
                                           oper.Date, 1,
                                           NATCUR, Abs(Rest),
                                           Docum,
                                           INPCARRY, "",
                                           "",//oper.Code,
                                           "Отражение финансового результата",
                                           null,
                                           IIF(FD.IsSector(), FIROLE_BA, null), null
                                         )
          )
           return false;
        end;
     end;
  end;

  return true;
END;

PRIVATE MACRO СписаниеСправедливойСтоимости( Docum, FD:variant, oper:variant, СС_н:money, СС_сп:money )
  var ground="";
  var ClassName = StrUpr( GenClassName( FD ));
  var IsDeal;
  if( ClassName == StrUpr("DVFirstDocDeal") )
      IsDeal = true;
      ground=Get_FinameDVFUN(FD.DEAL.rec.fiid)+", сделка N"+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/"); 
   end;

  if( СС_н > 0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        "Выбытие ПФИ", "+ПФИ",
                                        oper.Date, 1,
                                        NATCUR, Abs(СС_сп),
                                        Docum,
                                        INPCARRY, "",
                                       "",// oper.Code,
                                        iif(IsDeal,"Положительная вариационная маржа,"+ground,"Списание справедливой стоимости")
                                      )
       )
        return false;
     end;
  else
     if( not ПроводкаПоКатегориямУчета( FD,
                                        "-ПФИ", "Выбытие ПФИ",
                                        oper.Date, 1,
                                        NATCUR, Abs(СС_сп),
                                        Docum,
                                        INPCARRY, "",
                                        "",//oper.Code,
                                        iif(IsDeal,"Отрицательная вариационная маржа,"+ground,"Списание справедливой стоимости")
                                      )
       )
        return false;
     end;
  end;

  return true;
END;

MACRO ВыполнитьПроводкиСписанияСС( Docum, FD:variant, oper:variant, СС_н:money, Netto:money, Margin:money ): bool

   record Acc ("account.dbt");
   var OperDate = oper.Date;
   var OperCode = oper.Code;
   var СС_сп = $0, Rest = $0;
   var FiRole;
   var IsDeal:bool = false;
   var ClassName = StrUpr( GenClassName( FD ));
   var ground="";

   if( ClassName == StrUpr("DVFirstDocDeal") )
      IsDeal = true;
      ground=Get_FinameDVFUN(FD.DEAL.rec.fiid)+", сделка N"+FD.DEAL.rec.extcode+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/"); 
   end;

   if( FD.FI.rec.AvoirKind == DERIVATIVE_FUTURES )
      FiRole = FIROLE_FUTURES;
   else
      FiRole = FIROLE_OPTION;
   end;

   if( Netto != 0.0 )
      if( IsDeal )
         СС_сп = (СС_н - Margin) - СС_н * (FD.Deal.rec.Execution - Netto) / Netto;
      else
         if( FD.PositionLong() )
            СС_сп = (СС_н * FD.FITurnLast.LONGEXECUTION / Netto) - Margin;
         else
            СС_сп = (СС_н * FD.FITurnLast.SHORTEXECUTION / Netto) - Margin;
         end;
      end;
   end;

   if( FD.FI.rec.Settlement_Code == DVSETTLEMET_STATE )
      if( FD.УсловиеПоСтороне() )
         if( СС_н > 0 )
            if( not ПроводкаПоКатегориямУчета( FD, 
                                               "+Форвард, РПИ", "+ПФИ",
                                               OperDate, 1, 
                                               NATCUR, Abs(СС_сп), 
                                               Docum,
                                               INPCARRY, "",
                                               "",//OperCode,
                                               iif(IsDeal,"Положительная вариационная маржа, "+ground,"Списание справедливой стоимости"),  
                                               null, FiRole, null,
                                               FD.FI.rec.ParentFI, NATCUR,
                                               null, null, null, null, null, null, null, null,
                                               MC_PAIRACCMODE_MANUAL, null
                                             ) 
            )
               return false;
            end;       
         end;       
      else
         if( FD.BaseFI.rec.FI_Kind == FIKIND_CURRENCY )
            if( СС_н > 0 )
               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  "-Форвард, РПИ", "+ПФИ",
                                                  OperDate, 1, 
                                                  NATCUR, Abs(СС_сп), 
                                                  Docum,
                                                  INPCARRY, "",
                                                  "",//OperCode,
                                                  iif(IsDeal,"Положительная вариационная маржа, "+ground,"Списание справедливой стоимости"),  
                                                  null, FiRole, null,
                                                  FD.FI.rec.ParentFI, NATCUR,
                                                  null, null, null, null, null, null, null, null,
                                                  MC_PAIRACCMODE_MANUAL, null
                                                ) 
               )
                  return false;        
               end;       
            else
               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  "-ПФИ", "-Форвард, РПИ",
                                                  OperDate, 1, 
                                                  NATCUR, Abs(СС_сп), 
                                                  Docum,
                                                  INPCARRY, "",
                                                  "",//OperCode,
                                                  iif(IsDeal,"Отрицательная вариационная маржа, "+ground,"Списание справедливой стоимости"),   
                                                  null, null, FiRole,
                                                  NATCUR, FD.FI.rec.ParentFI,
                                                  null, null, null, null, null, null, null, null,
                                                  null, MC_PAIRACCMODE_MANUAL
                                                )
               )
                  return false;        
               end;       
            end;       

         elif( FD.BaseFI.rec.FI_Kind == FIKIND_AVOIRISS )
            if( СС_н > 0 )
               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  "Реализация, ц/б", "+ПФИ",
                                                  OperDate, 1, 
                                                  NATCUR, Abs(СС_сп), 
                                                  Docum,
                                                  INPCARRY,"",
                                                  "",//OperCode,
                                                  iif(IsDeal,"Положительная вариационная маржа, "+ground,"Списание справедливой стоимости"),  
                                                  NULL,
                                                  FIROLE_BA
                                                ) 
               )
                  return false;        
               end;       
            else
               if( not ПроводкаПоКатегориямУчета( FD, 
                                                  "-ПФИ", "Реализация, ц/б",
                                                  OperDate, 1, 
                                                  NATCUR, Abs(СС_сп), 
                                                  Docum,
                                                  INPCARRY,"",
                                                  "",//OperCode,
                                                  iif(IsDeal,"Отрицательная вариационная маржа, "+ground,"Списание справедливой стоимости"),  
                                                  NULL, 
                                                  NULL, FIROLE_BA
                                                )
               )
                  return false;
               end;
            end;
         end;
      end;
   else  /*Исполнение расчетных контрактов*/
      if( not СписаниеСправедливойСтоимости(Docum, FD, oper, СС_н, СС_сп) )
         return false;
      end;

      if( not ОтражениеФинансовогоРезультата(Docum, FD, oper) )
         return false;
      end;
   end;

   return true;
END;

MACRO ВыполнитьПроводкиСписанияСС_ЗакрытиеБезИсполнения( Docum, FD:variant, oper:variant, СС_н:money ): bool

   if( not СписаниеСправедливойСтоимости(Docum, FD, oper, СС_н, СС_н/*По ТЗ должно быть СС_сп, но в реализации было так*/) )
      return false;
   end;

   if( not ОтражениеФинансовогоРезультата(Docum, FD, oper) )
      return false;
   end;

   return true;
END;

MACRO ПИ_ПолучитьБанкКорреспондент( FD_Oper, Purpose:integer, Currency:integer )

  var BankID:integer = -1, RS;
  var paym = Trechandler( "pmpaym.dbt" );

  if( Currency != NATCUR )
     RS = TRsbDataSet( " SELECT pmprop.t_CorSchem " +
                       "   FROM dpmpaym_dbt pm, dpmprop_dbt pmprop " +
                       "  WHERE pm.t_DocKind       = " + string(FD_Oper.Kind) +
                       "    AND pm.t_DocumentID    = " + string(FD_Oper.ID)   +
                       "    AND pm.t_Purpose       = " + string(Purpose)      +
                       "    AND pm.t_FIID          = " + string(Currency)     +
                       "    AND pmprop.t_paymentid = pm.t_paymentid " +
                       "    AND pmprop.t_DebetCredit = " + string(IIF(Purpose == PM_PURP_ORDER, 1, 0))
                     );

     if( RS.MoveNext() )
        BankID = GetCorrID(RS.CorSchem, Currency, FIKIND_CURRENCY);
     end;  
  end;

  return BankID;
END;

MACRO ПИ_ПроводкаПоКлиентуВУ( FD, ClientContr, MarketAcc, BankAcc, Currency, Summ, Doc, IsIn:bool )
   var FD_Contr, RoleKind;
   record Acc(account); 

   var DebAcc, KredAcc;

   FD.SetParametr( MC_TYPE_PARAMETR_FIID, Currency );
   FD.SetBankID( ПИ_ПолучитьБанкКорреспондент(FD, IIF(IsIn, PM_PURP_ORDER, PM_PURP_REPAYMENT), Currency) );

   FD_Contr = DVFirstDocContract(DL_DVCONTR, ClientContr);
   FD_Contr.SetParametr( MC_TYPE_PARAMETR_FIID, Currency );

   if( BankAcc == null )
      ClearRecord( Acc );
      if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, FIROLE_BANKROLL_BANK, Acc, null, FD.DVOper.rec.Date, Currency ) )
         if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, null, FIROLE_BANKROLL_BANK, Acc, FD.DVOper.rec.Date, Currency ) )
            return false;
         end;
      end;
      BankAcc = Acc;
   end;

   if( MarketAcc == null )
      if( FD.DVOper.rec.PartyKind == PTK_MARKETPLASE ) /*Биржа*/
         FD_Contr.SetParametr(MC_TYPE_PARAMETR_PLACE, FD.DVOper.rec.Centr);
         FD_Contr.SetParametr(MC_TYPE_PARAMETR_MARKET_PLACE, FD.DVOper.rec.Centr);
         FD_Contr.SetParametr(MC_TYPE_PARAMETR_MARKET_PLACE_OFFICE, FD.DVOper.rec.PartyOffice );
      else /*Брокер*/
         FD_Contr.SetParametr(MC_TYPE_PARAMETR_PLACE, FD.DVOper.rec.Party);
      end;

      ClearRecord( Acc );
      if( not FD_Contr.IsExistAccount( "ДС Клиента, ВУ", null, true, null, Acc, null, FD.DVOper.rec.Date, Currency ) )
         if( not FD_Contr.OpenAccount( "ДС Клиента, ВУ", null, null, null, Acc, FD.DVOper.rec.Date, Currency ) )
            return false;
         end;
      end;

      MarketAcc = Acc;
   end;

   if( IsIn == true )  /*зачисление на счет Клиента*/
      RoleKind = IIF(FD.DVOper.rec.PartyKind == PTK_MARKETPLASE, 2, 3);
      KredAcc = BankAcc;/*здесь буфер счета*/
      DebAcc = MarketAcc;/*здесь буфер счета*/
   else
      RoleKind = IIF(FD.DVOper.rec.PartyKind == PTK_MARKETPLASE, 4, 5);
      KredAcc = MarketAcc;/*здесь буфер счета*/
      DebAcc = BankAcc;/*здесь буфер счета*/
   end;

   if( not ПроводкаПоКатегориямУчета( FD, 
                                      DebAcc,
                                      KredAcc,
                                      FD.DVOper.rec.Date,
                                      FD.ВУ_ОпределениеГлавы(Currency),
                                      Currency,
                                      Abs(Summ),
                                      Doc,
                                      INPCARRY,
                                      "",
                                      "",
                                      FD.ВУ_ОснованиеПроводки(RoleKind, not IsIn),
                                      0,
                                      null, 
                                      null,
                                      Currency, Currency,
                                      null, null, null, null,
                                      true,
                                      RoleKind
                                    ) )
  
      return false;
   end;
   
   return true;
END;

private class TSumData( pFIID:integer, pOFFICEID:integer, pSUM:money )
   var FIID     = pFIID,
       OFFICEID = pOFFICEID,
       SUM      = pSUM;
end;

/*массив счетов*/
private class (TArray) TSumDataArr

   /* Очистить массив. */
   macro ClearArray
      this.Size = 0;
   end;

   macro Add( SumData:TSumData  )
      var
      Counter = 0;

      while( (Counter < this.Size) and ((SumData.FIID != this.(Counter).FIID) or (SumData.OFFICEID != this.(Counter).OFFICEID)) )
         Counter = Counter + 1;
      end;


      if(Counter == this.Size)
         this.(Counter) = SumData;
      else
         this.(Counter).SUM = this.(Counter).SUM + SumData.SUM;
      end;
   end;

end;

private macro ClearDLTOTALOFFISUM(DocumentID:integer, DocKind:integer)
   var cmd = RSDCommand(  "DELETE FROM DDL_TOTALOFFISUM_DBT "
                         +"  WHERE T_DOCID = ?   "
                         +"    AND T_DOCKIND = ? "
                       );

   cmd.NullConversion = true; 
   cmd.AddParam("", RSDBP_IN, DocumentID);
   cmd.AddParam("", RSDBP_IN, DocKind);

   SQL_ExecuteTrn(cmd);
end;

private macro SaveSumsInDB( DocumentID:integer, DocKind:integer, obj )

   var cmd = RSDCommand(  "INSERT INTO DDL_TOTALOFFISUM_DBT ( T_DOCID,    "
                         +"                                   T_DOCKIND,  "
                         +"                                   T_FIID,     "
                         +"                                   T_OFFICEID, "
                         +"                                   T_SUM       "
                         +"                                 ) "
                         +" VALUES (?, ?, ?, ?, ?)");

   cmd.NullConversion = true; 
   cmd.AddParam("", RSDBP_IN, DocumentID);
   cmd.AddParam("", RSDBP_IN, DocKind);
   cmd.AddParam("", RSDBP_IN, obj.FIID);  
   cmd.AddParam("", RSDBP_IN, obj.OFFICEID);  
   cmd.AddParam("", RSDBP_IN, obj.SUM);

   SQL_ExecuteTrn(cmd);
end; /*SaveSumsInDB*/

private macro SaveSumsArrayInDB( DocumentID:integer, DocKind:integer, SumDataArr:TSumDataArr )
   if( SumDataArr.Size > 0 )
       var i = 0;
       while ( i < SumDataArr.Size )
          SaveSumsInDB( DocumentID, DocKind, SumDataArr(i) );
          i = i + 1;
       end;
   end;
onerror(x)
   msgbox( "Ошибка при сохранении данных в БД: " + x.Message );
end; /*SaveSumsArrayInDB*/

MACRO RecalcTotal( DocumentID, DocKind )
   var PaymentBaCaString = BAi + "," + CAi + "," + BRi + "," + CRi;
   var cmd, DealData;
   var cmdPaym, DataSet, sql;
   var cmdBounty, BounData;
   var cmdMargin, MargData;
   var cmdPaymCom, ComData;
   var Query:string = "", QueryDeal:string = "", QueryLateCom:string = "", QueryStateDeal:string = "", Data:variant, cmdData, Nrec = 0;
   var ДатаПерерасчёта:date, ВалютаПересчёта = 0, СуммаПересчёта = $0, ОборотКомиссий = $0;
   var Клиент = -1, FlagOperCheck = false, DvCurQuery, ScAccQuery, DvOperQuery, OperData, NoOprName = "", NoOprCount = 0;
   var CentrOfficesStr:string = "", cmdOffice, DataOffice;        

   if( DocKind == DL_DVCURMARKET )
      Query = " SELECT TotalOFF.T_CodeFI, TotalOFF.t_ID, TotalOFF.t_DocID, Comm.T_CommDate, Comm.T_PartyID, Comm.T_OperSubKind, Comm.T_ContractKind, Fin.T_FI_KIND, TotalOFF.t_MarketSchemeID " +
           "   FROM DDL_COMM_DBT Comm, DDL_TOTALOFFI_DBT TotalOFF, DFININSTR_DBT Fin " +
           "    WHERE Comm.T_DocumentID = ? " +
           "    AND Comm.T_DocKind      = ? " +
           "    AND TotalOFF.t_DocID    = Comm.T_DocumentID " +
           "    AND TotalOFF.t_SettlementEnd != CHR(88) " + 
              "    AND TotalOFF.t_Parent  != 0 " + 
           "    AND Fin.T_FIID = TotalOFF.T_CodeFI ";

   cmdData = DL_RsdCommand(Query);
   cmdData.AddParam(DocumentID);     
   cmdData.AddParam(DocKind);
   Nrec = cmdData.GetCount();
   Data = cmdData.execute();

      if( Nrec > 0 )
      while( Data.MoveNext() )
         СуммаПересчёта = $0;
         ОборотКомиссий = $0;
         ДатаПерерасчёта = Data.CommDate;
         ВалютаПересчёта = Data.CodeFI;
         QueryDeal =  " SELECT deals.t_ID DocumentID, deals.t_DocKind, CASE WHEN t_Client = -1 THEN " + {OurBank} + " ELSE t_Client END as Client " +
                                    "  FROM ddvndeal_dbt deals, ddvnfi_dbt nfi " +
                                    "   WHERE EXISTS( SELECT koper.t_Kind_Operation FROM doprkoper_dbt koper "+
                                    "                    WHERE deals.t_Kind = koper.t_Kind_Operation "+
                                    "   AND koper.t_NotInUse != CHR(88) " +
                                    "   AND koper.t_SysTypes IN ('D', 'NS', 'NH', 'NU')  " + 
                                    "               ) " + 
                                    "    AND deals.t_Sector = CHR(88) " +
                                       "    AND deals.t_MarketKind = " + DV_MARKETKIND_CURRENCY +
                                    "    AND deals.t_State <> 0 "+
                         "    AND deals.t_Client "+ IIF(Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN, "= -1" ,"!= -1") +
                                    "    AND nfi.t_DealID = deals.t_ID " +
                                       "    AND nfi.t_Type = 0 " +
                                       "    AND deals.t_MarketSchemeID = " + Data.MarketSchemeID;

         // Платежи по сделкам
         QueryStateDeal = " AND nfi.t_ExecType = (case when deals.t_DVKind <> " + DV_FORWARD_FX + " then " + DVSETTLEMET_STATE + " else nfi.t_ExecType end) ";
         cmdPaym = DL_RsdCommand( " SELECT nvl(sum(t_amount), 0 ) summ" +
                                    "  FROM dpmpaym_dbt " +
                                  "  WHERE (t_DocumentID, t_DocKind, t_Receiver) IN ( " + QueryDeal + QueryStateDeal + ")" +
                                    "    AND t_FIID       = ? " +
                                    "    AND t_ValueDate  = ? " +
                                  "    AND t_Purpose in (" + PaymentBaCaString + ") " +
                                  "  UNION ALL SELECT nvl(sum(-t_amount), 0 ) summ" +
                                  "  FROM dpmpaym_dbt " +
                                  "  WHERE (t_DocumentID, t_DocKind, t_Payer) IN ( " + QueryDeal + QueryStateDeal + ")" +
                                  "    AND t_FIID       = ? " +
                                  "    AND t_ValueDate  = ? " +
                                  "    AND t_Purpose in (" + PaymentBaCaString + ") " );
            cmdPaym.AddParam(ВалютаПересчёта);
         cmdPaym.AddParam(ДатаПерерасчёта);
         cmdPaym.AddParam(ВалютаПересчёта);
         cmdPaym.AddParam(ДатаПерерасчёта);
            DataSet = cmdPaym.execute();
         while( DataSet.MoveNext() )
               СуммаПересчёта = СуммаПересчёта + DataSet.Summ;
            end;

         // Комисси по сделкам. Первый проход - сделки, заключённые до 19:00, второй - остальные
         var i = 0;
         while (i < 2)
            QueryLateCom = " AND deals.t_Time" + IIF(i == 0, "<", ">=") + " TO_DATE('01/01/0001 19:00:00', 'MM/DD/YYYY HH24:MI:SS') ";

 /*DAN*/    var QueryDealComm =  " SELECT deals.t_ID DocumentID, deals.t_DocKind,  " + {OurBank} + " as Client " +
                                       "  FROM ddvndeal_dbt deals, ddvnfi_dbt nfi " +
                                       "   WHERE EXISTS( SELECT koper.t_Kind_Operation FROM doprkoper_dbt koper " +
                                       "                  WHERE deals.t_Kind = koper.t_Kind_Operation " +
                                       "                    AND koper.t_NotInUse != CHR(88) " +
                                       "                    AND koper.t_SysTypes IN ('D', 'NS', 'NH', 'NU') " +
                                       "               ) " + 
                                       "    AND deals.t_Sector = CHR(88) " +
                                       "    AND deals.t_MarketKind = " + DV_MARKETKIND_CURRENCY +
                                       "    AND deals.t_State <> 0 " +
                         "    AND deals.t_Client "+ IIF(Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN, "= -1" ,"!= -1") +
                                       "    AND nfi.t_DealID = deals.t_ID " +
                                       "    AND nfi.t_Type = 0 " +
                                       "    AND deals.t_MarketSchemeID = " + Data.MarketSchemeID;



            cmdPaymCom = DL_RsdCommand( " SELECT nvl(sum(dlcomis.t_sum), 0) summ" +
                                        "  FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt sfcomis, dsfcontr_dbt contr " +
                                        "  WHERE (dlcomis.t_DocID, dlcomis.t_DocKind, contr.t_PartyID) IN ( " + QueryDealComm + QueryLateCom + ")" +
                                        "    AND  contr.t_ID            = dlcomis.t_Contract " +
                                        "    AND  dlcomis.t_PlanPayDate =  ? " +
                                        "    AND  dlcomis.t_FeeType     =  sfcomis.t_FeeType " +
                                        "    AND  dlcomis.t_ComNumber   =  sfcomis.t_Number " +
                                        "    AND  sfcomis.t_ReceiverID  =  ? " +
                                        "    AND  sfcomis.T_FIID_Comm   =  ?   " );
            cmdPaymCom.AddParam(ДатаПерерасчёта);
            cmdPaymCom.AddParam(Data.PartyID);
            cmdPaymCom.AddParam(ВалютаПересчёта);

            ComData = cmdPaymCom.execute();
            while( ComData.MoveNext() )
               if( i == 0 ) // комиссии до 19:00
                  СуммаПересчёта = СуммаПересчёта - ComData.Summ;
               else         // комиссии после 19:00
                  ОборотКомиссий = ОборотКомиссий - ComData.Summ;
               end;
            end;
            i = i + 1;
         end;

         // "Комиссии и сборы" из операции расчётов на валютном рынке
         cmdBounty = DL_RsdCommand( " SELECT nvl(sum(dlcomis.t_sum), 0) summ" +
                                    "  FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt sfcomis " +
                                    "  WHERE dlcomis.t_DocID       =  ? " +
                                    "    AND dlcomis.t_DocKind     =  ? " + 
                                    //"    AND dlcomis.t_FactPayDate != TO_DATE('01.01.0001', 'dd.mm.yyyy')  " +
                                    "    AND dlcomis.t_PlanPayDate =  ? " +
                                    "    AND dlcomis.t_FeeType     =  sfcomis.t_FeeType " +
                                    "    AND dlcomis.t_ComNumber   =  sfcomis.t_Number " +
                                       "    AND sfcomis.T_FIID_Comm   =  ?   " +
                                       "    AND NVL((SELECT NVL(Analytics.t_MarketSchemeID, ExtCode.t_MarketSchemeID) " +
                                       "               FROM DDL_EXTSETTLECODE_DBT ExtCode LEFT JOIN DDL_EXTSCANALYTICS_DBT Analytics " +
                                       "                 ON     ExtCode.t_InPool = CHR(88) " +
                                       "                    AND Analytics.t_CodeID = case when ExtCode.t_ParentID = 0 then ExtCode.t_ID else ExtCode.t_ParentID end " +
                                       "                    AND Analytics.t_MarketKind = ? " +
                                       "              WHERE ExtCode.t_SettleCode = dlcomis.t_SettleCode " +
                                       "            ), 0) = ? " );
         cmdBounty.AddParam(DocumentID);
         cmdBounty.AddParam(DocKind);
         cmdBounty.AddParam(ДатаПерерасчёта);
         cmdBounty.AddParam(ВалютаПересчёта);
            cmdBounty.AddParam(DL_MARKETKIND_SETTLE_CURRENCY);
            cmdBounty.AddParam(Data.MarketSchemeID);
         BounData = cmdBounty.execute();
         if( BounData.MoveNext() )
            СуммаПересчёта = СуммаПересчёта - BounData.Summ;
         end;

         //Вар. маржа за день по сделкам
         cmdMargin = DL_RsdCommand( " SELECT nvl(sum(CASE WHEN nacdl.t_Direction = 1 THEN -nacdl.t_Sum  ELSE nacdl.t_Sum END), 0 ) summ" +
                                    "  FROM ddvnacdl_dbt nacdl     " +
                                    "  WHERE nacdl.t_DealID IN ( SELECT DocumentID FROM (" + QueryDeal + "))" +
                                    "    AND nacdl.t_Date     =  ? " +
                                    "    AND nacdl.t_PayKind       =  ? " +
                                    "    AND nacdl.t_AccFIID       =  ? " );
         cmdMargin.AddParam(ДатаПерерасчёта);
         cmdMargin.AddParam(DV_CALCOP_PAYKIND_MARGIN);
         cmdMargin.AddParam(ВалютаПересчёта);
         MargData = cmdMargin.execute();
         if( MargData.MoveNext() )
            СуммаПересчёта = СуммаПересчёта + MargData.Summ;
         end;

         //Установка итогов
         sql = RSDCommand( " Call RSB_Derivatives.DV_SetTotal(?, ?, ?) ");
         sql.addParam("", RSDBP_IN, Data.ID);
         sql.addParam("", RSDBP_IN, СуммаПересчёта);
         sql.addParam("", RSDBP_IN, ОборотКомиссий);
         sql.execute();
      end;
      end;

   elif( DocKind == DL_SETTLEMENTFCURM )
      Query = " SELECT TotalOFF.T_CodeFI, TotalOFF.t_ID, TotalOFF.t_DocID, Comm.T_CommDate, Comm.T_OperSubKind, Comm.T_ContractKind, Comm.T_Flag1 InPool, Fin.T_FI_KIND, " +
              "        Comm.T_MarketSchemeID, Comm.T_TraderID, Comm.T_PartyOfficeID, Comm.T_Flag2 IsExistsAnalytics " +
              "   FROM DDL_COMM_DBT Comm, DDL_TOTALOFFI_DBT TotalOFF, DFININSTR_DBT Fin " +
              "  WHERE Comm.T_DocumentID   = ? " +
              "    AND Comm.T_DocKind      = ? " +
              "    AND TotalOFF.t_DocID    = Comm.T_DocumentID " +
              "    AND TotalOFF.t_SettlementEnd != CHR(88) " + 
              "    AND TotalOFF.t_Parent   = 0 " + 
              "    AND Fin.T_FIID = TotalOFF.T_CodeFI ";

      cmdData = DL_RsdCommand(Query);
      cmdData.AddParam(DocumentID);     
      cmdData.AddParam(DocKind);
      Nrec = cmdData.GetCount();
      Data = cmdData.execute();

      if( Nrec > 0 )
      var SumDataArr = TSumDataArr;

      while( Data.MoveNext() )
         СуммаПересчёта = $0;
         ОборотКомиссий = $0;
         ДатаПерерасчёта = Data.CommDate;
         ВалютаПересчёта = Data.CodeFI;
            if( (Data.ContractKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (Data.InPool == SET_CHAR) )
 
            DvCurQuery = " SELECT comm.t_DocumentID id, comm.t_DocKind " +
                                 "  FROM DDL_COMM_DBT comm " +
                                 "   WHERE comm.t_CommDate = ? " +
                                 "    AND  comm.t_DocKind  = ? " +
                         "    AND  comm.t_OperSubKind = ? ";

            ScAccQuery = " SELECT comm2.t_DocumentID id, comm2.t_DocKind " +
                         "  FROM DDL_COMM_DBT comm2 " +
                         "   WHERE comm2.t_CommDate = ? " +
                         "    AND  comm2.t_DocKind  = ? " +
                         "    AND  comm2.t_Flag4 = 'X' " +
                         "    AND  comm2.t_CommStatus = 2 ";

            if( not FlagOperCheck )
               OperData = DL_RsdCommand(DvCurQuery + " AND comm.t_CommStatus != 2 ");
               OperData.AddParam(ДатаПерерасчёта);
               OperData.AddParam(DL_DVCURMARKET);
               OperData.AddParam(Data.OperSubKind);
               
               if( OperData.GetCount() > 0 )
                  NoOprName = "\"Обработка итогов биржевых валютных торгов\"";
                  NoOprCount = NoOprCount + 1;
               end;
               
               DvOperQuery = " SELECT oper.t_id id, oper.t_dockind  " +
                             "  FROM DDVOPER_DBT oper, DOPRKOPER_DBT kop " +
                             "   WHERE oper.t_Date = ? " +
                             "    AND  oper.t_DocKind = ? " +
                             "    AND  oper.t_OperKind = kop.t_Kind_Operation " +
                             "    AND  kop.t_SysTypes = chr(1) " +
                             "    AND  oper.T_Flag1 = ? " +
                             "    AND  oper.T_State != 2 ";
               
               OperData = DL_RsdCommand(DvOperQuery);
               OperData.AddParam(ДатаПерерасчёта);
               OperData.AddParam(DL_DVOPER);
               OperData.AddParam(Data.OperSubKind);
               
               if( OperData.GetCount() > 0 )
                  if( NoOprName != "" )
                    NoOprName = NoOprName + ",\n";
                  end;
                  NoOprName = NoOprName + "\"Обработка сделок срочного рынка по итогам биржевых торгов\"";
                  NoOprCount = NoOprCount + 1;
               end;
               /*
               DvOperQuery = " SELECT oper.t_id id, oper.t_dockind  " +
                             "  FROM DDVOPER_DBT oper, DOPRKOPER_DBT kop " +
                             "   WHERE oper.t_Date = ? " +
                             "    AND  oper.t_DocKind = ? " +
                             "    AND  oper.t_OperKind = kop.t_Kind_Operation " +
                             "    AND  kop.t_SysTypes = 'S' " +
                             "    AND  oper.T_Flag1 = ? " +
                             "    AND  oper.T_State != 2 ";
               
               OperData = DL_RsdCommand(DvOperQuery);
               OperData.AddParam(ДатаПерерасчёта);
               OperData.AddParam(DL_DVOPER);
               OperData.AddParam(Data.OperSubKind);
               
               if( OperData.GetCount() > 0 )
                  if( NoOprName != "" )
                    NoOprName = NoOprName + ",\n";
                  end;
                  NoOprName = NoOprName + "\"Обработка сделок рынка СПФИ по итогам торгов\"";
                  NoOprCount = NoOprCount + 1;
               end;
               */
               OperData = DL_RsdCommand(ScAccQuery);
               OperData.AddParam(ДатаПерерасчёта);
               OperData.AddParam(DL_SCACCOUNTING);
               
               if( OperData.GetCount() <= 0 )
                  if( NoOprName != "" )
                    NoOprName = NoOprName + ",\n";
                  end;
                  NoOprName = NoOprName + "\"СОБУ БОЦБ\"";
                  NoOprCount = NoOprCount + 1;
               end;
               
               if( NoOprCount > 0 )
                  if( NoOprCount == 1 )
                     NoOprName = "Операция "+NoOprName+" не завершена!";
                  else
                     NoOprName = "Операции: "+NoOprName+" - не завершены!";
                  end;
                  if( MsgBoxEx(NoOprName+"\nПродолжить выполнение?", MB_YES+MB_NO, IND_NO) != IND_YES )
                     return 0;
                  end;
               end;
               FlagOperCheck = true;
                  ClearDLTOTALOFFISUM(DocumentID, DocKind);  //Очищаем таблицу с итогами перед первым проходом
            end;

            cmd = DL_RsdCommand( DvCurQuery +
                                 "    UNION ALL " +
                                 " SELECT oper.t_id id, oper.t_dockind  " +
                                  "  FROM DDVOPER_DBT oper, DOPRKOPER_DBT kop " +
                                 "   WHERE oper.t_Date = ? " +
                                  "    AND  oper.t_DocKind = ? " +
                                  "    AND  oper.t_OperKind = kop.t_Kind_Operation " +
                                  "    AND  (kop.t_SysTypes = chr(1) or kop.t_SysTypes = 'S') " +
                                 "    AND  oper.T_Flag1 = ? " +
                                 "    UNION ALL " +
                                    ScAccQuery
                                  );
   
            cmd.AddParam(ДатаПерерасчёта);
            cmd.AddParam(DL_DVCURMARKET);
            cmd.AddParam(Data.OperSubKind);
           
            cmd.AddParam(ДатаПерерасчёта);
            cmd.AddParam(DL_DVOPER);
            cmd.AddParam(Data.OperSubKind);

            cmd.AddParam(ДатаПерерасчёта);
            cmd.AddParam(DL_SCACCOUNTING);

         else/*ветка для фондового рынка*/
            cmd = DL_RsdCommand( " SELECT comm2.t_DocumentID id, comm2.t_DocKind " +
                                 "  FROM DDL_COMM_DBT comm2 " +
                                 "   WHERE comm2.t_CommDate = ? " +
                                 "    AND  comm2.t_DocKind  = ? " +
                                 "    AND  comm2.t_Flag4 = 'X' " +
                                 "    AND  comm2.t_CommStatus = 2 "
                               );
            cmd.AddParam(ДатаПерерасчёта);
            cmd.AddParam(DL_SCACCOUNTING);

               if( not FlagOperCheck )
            if( cmd.GetCount() <= 0 )
               if( MsgBoxEx("Операция \"СОБУ БОЦБ\" - не завершена!\nПродолжить выполнение?", MB_YES+MB_NO, IND_NO) != IND_YES )
                  return 0;
               end;
            end;
                  FlagOperCheck = true;
                  ClearDLTOTALOFFISUM(DocumentID, DocKind);  //Очищаем таблицу с итогами перед первым проходом
               end;

         end;
        
         DealData = cmd.execute();

         while( DealData.MoveNext() )
            if (DealData.DocKind == DL_SCACCOUNTING)

                  cmdPaym = DL_RsdCommand( " SELECT nvl(sum(T_SUM),0) SumDL " +
                                           "   FROM (SELECT case when trans.T_Account_Receiver = acc_market.t_Account then trans.T_Sum_Payer else -trans.T_Sum_Payer end T_SUM " +
                                           "           FROM ddlgrdoc_dbt grdoc, dacctrn_dbt trans, " +
                                           "                (SELECT acc.t_Account " +
                                           "                   FROM dmccateg_dbt cat, dmcaccdoc_dbt acc, dmctempl_dbt templ " + 
                                           "                  WHERE cat.t_LevelType = 1 " +
                                           "                    AND (cat.t_Code = '+Биржа' or cat.t_Code = '-Биржа') " +
                                           "                    AND acc.t_CatNum = cat.t_Number " +
                                           "                    AND acc.t_IsCommon = 'X' " +
                                           "                    AND acc.t_MarketPlaceID = ? " +
                                           "                    AND acc.t_MarketPlaceOfficeID = ? " +
                                           "                    AND acc.t_CatID = templ.t_CatID " +
                                           "                    AND acc.t_TemplNum = templ.t_Number " +
                                           "                    AND templ.t_Value1 = " + IIF(Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN, "1", "2") +
                                           "               GROUP BY acc.t_Account) acc_market, " +
                                           "                (SELECT acc.t_Account " +
                                           "                   FROM dmccateg_dbt cat, dmcaccdoc_dbt acc, dmctempl_dbt templ " + 
                                           "                  WHERE cat.t_LevelType = 1 " +
                                           "                    AND acc.t_CatNum = cat.t_Number " +
                                           "                    AND acc.t_IsCommon = 'X' " +
                                           "                    AND acc.t_MarketPlaceID = ? " +
                                           "                    AND acc.t_MarketPlaceOfficeID = ? " +
                                           "                    AND acc.t_CatID = templ.t_CatID " +
                                           "                    AND acc.t_TemplNum = templ.t_Number " + 
                                           "                    AND (    (cat.t_Code = 'Клиринговый счет' AND templ.t_Value1 = " + IIF(Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN, "1", "2") + ")" +
                                           "                          or (? = 'X' AND (cat.t_Code = '+Обеспечение' or cat.t_Code = '-Обеспечение') AND templ.t_Value2 = " + IIF(Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN, "1", "2") + ")" +
                                        "                    ) " +
                                           "               GROUP BY acc.t_Account) acc_clearing " +   
                                        "  WHERE grdoc.T_ServDocID = ? and grdoc.T_ServDocKind = ? and grdoc.t_DocKind = 1 and trans.T_AcctrnID = grdoc.T_DocID " +
                                        "   AND trans.T_FIID_Payer = ?" +
                                           "            AND (    (trans.T_Account_Payer = acc_market.t_Account and trans.T_Account_Receiver = acc_clearing.t_Account) " +
                                           "                  or (trans.T_Account_Payer = acc_clearing.t_Account and trans.T_Account_Receiver = acc_market.t_Account) " +
                                        "                 ) " +
                                           "        ) ");

              
                     cmdPaym.AddParam(Data.TraderID);
                     cmdPaym.AddParam(Data.PartyOfficeID);
                     cmdPaym.AddParam(Data.TraderID);
                     cmdPaym.AddParam(Data.PartyOfficeID);
                  cmdPaym.AddParam(Data.InPool);

               cmdPaym.AddParam(DealData.ID);
               cmdPaym.AddParam(DealData.DocKind);
               cmdPaym.AddParam(ВалютаПересчёта);
                 



               DataSet = cmdPaym.execute();
               while( DataSet.MoveNext() )
                  if( ВалютаПересчёта != NATCUR )
                        SumDataArr.Add(TSumData(ВалютаПересчёта,Data.PartyOfficeID,DataSet.SumDL));
                  end;
                  СуммаПересчёта = СуммаПересчёта + DataSet.SumDL;
            end;

               else //по СО обработки итогов торгов срочного, валютного рынка и рынка СПФИ

                  if( not( (Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN) and (Data.FI_KIND == FIKIND_METAL) ) )

                     var QueryOffices = " SELECT Analytics.t_CentrOfficeID " +
                                        "   FROM DDL_EXTSETTLECODE_DBT ExtCode, DDL_EXTSCANALYTICS_DBT Analytics " +
                                        "  WHERE ExtCode.T_MarketSchemeID = ? " +
                                        "    AND ExtCode.T_ParentID = 0 " +
                                        "    AND Analytics.T_CodeID = ExtCode.T_ID ";

                     if( ВалютаПересчёта == NATCUR )
                        cmdPaym = DL_RsdCommand( " SELECT nvl(sum(T_SUM),0) SumDL, OfficeID " +
                                                 "   FROM ( SELECT case when substr(trans.T_Account_Receiver,1,5) in('47404','47403') then trans.T_Sum_Payer else -trans.T_Sum_Payer end T_SUM, " +
                                                 "                 acc.t_MarketPlaceOfficeID OfficeID " +
                                                 "           FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper, " +
                                                 "               (SELECT acc.t_Account, acc.t_MarketPlaceOfficeID " +
                                                 "                  FROM dmcaccdoc_dbt acc " +
                                                 "                 WHERE acc.t_MarketPlaceID = ? " +
                                                 "                   AND (acc.t_MarketPlaceOfficeID = ? or acc.t_MarketPlaceOfficeID IN ("+QueryOffices+")) " +
                                                 "              GROUP BY acc.t_Account, acc.t_MarketPlaceOfficeID) acc " +
                                                 "           WHERE ltrim(oper.T_DocumentID) = ? and oper.T_DocKind = ? and oprdocs.T_ID_Operation = oper.T_ID_Operation AND trans.T_AcctrnID = oprdocs.T_AcctrnID " +
                                                 "             AND trans.T_FIID_Payer = ? " +
                                                 "             AND (    (substr(trans.T_Account_Payer,1,5) = '30424' and substr(trans.T_Account_Receiver,1,5) in('47404','47403') and acc.t_Account = trans.T_Account_Receiver) " +
                                                 "                   or (substr(trans.T_Account_Receiver,1,5) = '30424' and substr(trans.T_Account_Payer,1,5) in('47404','47403') and acc.t_Account = trans.T_Account_Payer) " +
                                                 "                  ) " +        
                                                 "        ) " +
                                                 " GROUP BY OfficeID " 
                                               );
                     else                    
                        cmdPaym = DL_RsdCommand( " SELECT nvl(sum(T_SUM),0) SumDL, OfficeID " +
                                                 "   FROM ( SELECT case when acc.t_Account = trans.T_Account_Payer then trans.T_Sum_Payer else -trans.T_Sum_Payer end T_SUM, " +
                                                 "                 acc.t_MarketPlaceOfficeID OfficeID " +
                                                 "            FROM doprdocs_dbt oprdocs, dacctrn_dbt trans, doproper_dbt oper, " +
                                                 "               (SELECT distinct acc.t_Account, Decode(acc.t_MarketPlaceOfficeID, 14, 9, acc.t_MarketPlaceOfficeID) as t_MarketPlaceOfficeID " +/*PNV СПФИ считаем валютным рынком*/
                                                 "                  FROM dmccateg_dbt cat, dmcaccdoc_dbt acc " +
                                                 "                 WHERE cat.t_LevelType = 1  " +
                                                 "                   AND (cat.t_Code = '+Биржа' or cat.t_Code = '-Биржа')" +
                                                 "                   AND acc.t_CatNum = cat.t_Number " +
                                                 "                   AND acc.t_IsCommon = 'X' " +
                                                 "                   AND acc.t_MarketPlaceID = ? " +
                                                 "                   AND (acc.t_MarketPlaceOfficeID = ? or acc.t_MarketPlaceOfficeID IN ("+QueryOffices+")) " +
                                                 "              GROUP BY acc.t_Account, acc.t_MarketPlaceOfficeID) acc " +
                                        "           WHERE ltrim(oper.T_DocumentID) = ? and oper.T_DocKind = ? and oprdocs.T_ID_Operation = oper.T_ID_Operation AND trans.T_AcctrnID = OPRDOCS.T_AcctrnID " +
                                                 "             AND trans.T_FIID_Payer = ? and (acc.t_Account = trans.T_Account_Payer OR acc.t_Account = trans.T_Account_Receiver) " +
                                        "        ) " +
                                        " GROUP BY OfficeID " 
                                      );
                     end;

                     cmdPaym.AddParam(Data.TraderID);
                     cmdPaym.AddParam(Data.PartyOfficeID);
                     cmdPaym.AddParam(Data.MarketSchemeID);
            cmdPaym.AddParam(DealData.ID);
            cmdPaym.AddParam(DealData.DocKind);
            cmdPaym.AddParam(ВалютаПересчёта);
                     

            DataSet = cmdPaym.execute();
            while( DataSet.MoveNext() )
                  if( ВалютаПересчёта != NATCUR )
                     SumDataArr.Add(TSumData(ВалютаПересчёта,DataSet.OfficeID,DataSet.SumDL));
                  end;
               СуммаПересчёта = СуммаПересчёта + DataSet.SumDL;
            end;
            end;
            end;

               if( not((Data.ContractKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (Data.InPool == SET_CHAR) and (Data.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT)) ) // Итоги по клиентской СО ЕП дособерем из сделок и вставим позже  
            sql = RSDCommand( " Call RSB_Derivatives.DV_SetTotal(?, ?, ?) ");
            sql.addParam("", RSDBP_IN, Data.ID);
            sql.addParam("", RSDBP_IN, СуммаПересчёта);
            sql.addParam("", RSDBP_IN, ОборотКомиссий);
            sql.execute();
               end;     
            end;

            if( (Data.ContractKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (Data.InPool == SET_CHAR) and (Data.OperSubKind == ALG_SP_MONEY_SOURCE_CLIENT) )
               if( Data.CodeFI != NATCUR )
                  cmdPaym = DL_RsdCommand( " with t as "
                                          +"   ( SELECT case when substr(trans.T_Account_Payer,1,5) in('47404','47403') then trans.T_Sum_Payer else -trans.T_Sum_Receiver end t_Result,  "
                                          +"            dlmarket.T_CentrOffice t_OfficeID  "
                                          +"       FROM dacctrn_dbt trans, doprdocs_dbt oprdocs, doproper_dbt oper, ddvndeal_dbt deal, ddlmarket_dbt dlmarket "
                                          +"      WHERE TRANS.T_DATE_CARRY = ? "
                                          +"        AND (    (substr(trans.T_Account_Payer,1,5) in('47404','47403') and trans.T_FIID_Payer = ?) "
                                          +"              or (substr(trans.T_Account_Receiver,1,5) in('47404','47403') and trans.T_FIID_Receiver = ?) "
                                          +"            ) "
                                          +"        AND oprdocs.T_AcctrnID = trans.T_AcctrnID "
                                          +"        AND oper.T_ID_Operation = oprdocs.T_ID_Operation "
                                          +"        AND DEAL.T_DOCKIND = oper.T_DocKind "
                                          +"        AND DEAL.T_ID = to_number(OPER.T_DOCUMENTID) "
                                          +"        AND DEAL.T_SECTOR = 'X' "
                                          +"        AND DEAL.T_MARKETKIND = ? "
                                          +"        AND DEAL.T_CLIENT <> -1 " 
                                          +"        AND (   DEAL.T_MARKETSCHEMEID = ? "  
                                          +"             or DEAL.T_MARKETSCHEMEID IN (SELECT Analytics.t_MarketSchemeID " 
                                          +"                                            FROM DDL_EXTSETTLECODE_DBT ExtCode, DDL_EXTSCANALYTICS_DBT Analytics " 
                                          +"                                           WHERE ExtCode.T_MarketSchemeID = ? " 
                                          +"                                             AND ExtCode.T_ParentID = 0 " 
                                          +"                                             AND Analytics.T_MarketKind = ? " 
                                          +"                                             AND Analytics.T_CodeID = ExtCode.T_ID "             
                                          +"                                         ) "
                                          +"            ) "
                                          +"        AND dlmarket.T_ID = DEAL.T_MARKETSCHEMEID "
                                          +"   ) "
                                          +"   SELECT nvl(sum(t.t_Result),0) SumDL, t.t_OfficeID "
                                          +"     FROM t "
                                          +" GROUP BY t.t_OfficeID " 
                                          +"   HAVING sum(t.t_Result) != 0 " 
                                         );

                  cmdPaym.AddParam(ДатаПерерасчёта);
                  cmdPaym.AddParam(ВалютаПересчёта);
                  cmdPaym.AddParam(ВалютаПересчёта);
                  cmdPaym.AddParam(DV_MARKETKIND_CURRENCY);
                  cmdPaym.AddParam(Data.MarketSchemeID);
                  cmdPaym.AddParam(Data.MarketSchemeID);
                  cmdPaym.AddParam(DL_MARKETKIND_SETTLE_CURRENCY);

                  DataSet = cmdPaym.execute();
                  while( DataSet.MoveNext() )
                     if( ВалютаПересчёта != NATCUR )
                        SumDataArr.Add(TSumData(ВалютаПересчёта,DataSet.OfficeID,DataSet.SumDL));
                     end;
                     СуммаПересчёта = СуммаПересчёта + DataSet.SumDL;
                  end;
               end;

               sql = RSDCommand( " Call RSB_Derivatives.DV_SetTotal(?, ?, ?) ");
               sql.addParam("", RSDBP_IN, Data.ID);
               sql.addParam("", RSDBP_IN, СуммаПересчёта);
               sql.addParam("", RSDBP_IN, ОборотКомиссий);
               sql.execute();
         end;   

            /*отдельно найдем проводки по сделкам по драгметаллам (только для собственных СО с рынком "Фондовый Т+" и установленным признаком ЕП)*/
            if( (Data.ContractKind == DL_MARKETKIND_SETTLE_STOCK_TPLUS) and (Data.InPool == SET_CHAR) and (Data.OperSubKind == ALG_SP_MONEY_SOURCE_OWN) and (Data.FI_KIND == FIKIND_METAL) )
            СуммаПересчёта = $0;
            cmdPaym = DL_RsdCommand( " with t as "
                                    +"   ( SELECT case when substr(trans.T_Account_Payer,1,5) = '30413' then trans.T_Sum_Payer else -trans.T_SUM_Receiver end T_SUM "
                                    +"       FROM dacctrn_dbt trans, doprdocs_dbt oprdocs, doproper_dbt oper "
                                    +"      WHERE TRANS.T_DATE_CARRY = ? "
                                    +"        AND ( (substr(trans.T_Account_Payer,1,5) = '30413' /*and trans.T_FIID_Payer = ?*/) "
                                    +"               or (substr(trans.T_Account_Receiver,1,5) = '30413' /*and trans.T_FIID_Receiver = ?*/) "
                                    +"            ) "
                                    +"        AND oprdocs.T_AcctrnID = trans.T_AcctrnID "
                                    +"        AND oper.T_ID_Operation = oprdocs.T_ID_Operation "
                                    +"        AND oper.T_DocKind in(?,?,?) "
                                    +"        AND exists( select 1 from ddvndeal_dbt deal, DDVNFI_DBT fi "
                                    +"                     where DEAL.T_DOCKIND = oper.T_DocKind "
                                    +"                       and DEAL.T_ID = FI.T_dealid "
                                    +"                       and FI.T_FIID = ? "
                                    +"                       and DEAL.T_ID = to_number(OPER.T_DOCUMENTID) "
                                    +"                       and DEAL.T_SECTOR = 'X' "
                                    +"                       and DEAL.T_MARKETKIND = ?"
                                       +"                       and DEAL.T_CLIENT = -1 " 
                                       +"                       and (   DEAL.T_MARKETSCHEMEID = ? "  
                                       +"                            or DEAL.T_MARKETSCHEMEID IN (SELECT Analytics.t_MarketSchemeID " 
                                       +"                                                           FROM DDL_EXTSETTLECODE_DBT ExtCode, DDL_EXTSCANALYTICS_DBT Analytics " 
                                       +"                                                          WHERE ExtCode.T_MarketSchemeID = ? " 
                                       +"                                                            AND ExtCode.T_ParentID = 0 " 
                                       +"                                                            AND Analytics.T_MarketKind = ? " 
                                       +"                                                            AND Analytics.T_CodeID = ExtCode.T_ID "             
                                       +"                                                        ) "
                                       +"                           ) "
                                    +"                  ) "
                                    +"   ) "
                                    +"   select nvl(sum(t.t_sum),0) SumDL "
                                    +"     from t "
                                    +"   having sum(t.t_sum) != 0 " 
                                   );
            
            cmdPaym.AddParam(ДатаПерерасчёта);
            //cmdPaym.AddParam(ВалютаПересчёта);
            //cmdPaym.AddParam(ВалютаПересчёта);
            cmdPaym.AddParam(DL_DVNDEAL);
            cmdPaym.AddParam(DL_DVFXDEAL);
            cmdPaym.AddParam(DL_DVDEALT3);
            cmdPaym.AddParam(ВалютаПересчёта);
            cmdPaym.AddParam(DV_MARKETKIND_CURRENCY);
            cmdPaym.AddParam(Data.MarketSchemeID);
            cmdPaym.AddParam(Data.MarketSchemeID);
            cmdPaym.AddParam(DL_MARKETKIND_SETTLE_CURRENCY);
            
            DataSet = cmdPaym.execute();
            if( DataSet.MoveNext() )
               СуммаПересчёта = SQL_ConvTypeSum(DataSet.SumDL);
               SumDataArr.Add(TSumData(ВалютаПересчёта, 6 , DataSet.SumDL));
            end;

            sql = RSDCommand( " Call RSB_Derivatives.DV_SetTotal(?, ?, ?) ");
            sql.addParam("", RSDBP_IN, Data.ID);
            sql.addParam("", RSDBP_IN, СуммаПересчёта);
            sql.addParam("", RSDBP_IN, ОборотКомиссий);
            sql.execute();
         end;
         end;

      SaveSumsArrayInDB(DocumentID, DocKind, SumDataArr);
   end;
   end;
   return 0;
END;