/*
$Name:        dvcuritog010.mac
$Module:      ФИССИКО
$Description: Операция "Обработка итогов биржевых валютных торгов", Шаг Открытие дня
*/
import InsCarryDoc, "dv_categ.mac";

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )

  record Comm( dl_comm );
  SetBuff( Comm, FirstDoc );

  var Sql = " SELECT count(1) NumRec" +
            "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis  " +
            "  WHERE dlcomis.t_DocKind     = ? " +
            "    AND dlcomis.t_DocID       = ? " +
            "    AND dlcomis.t_FactPayDate = TO_DATE('01.01.0001', 'dd.mm.yyyy') " +
            "    AND dlcomis.t_PlanPayDate = ? " +
            "    AND dlcomis.t_FeeType     = comis.t_FeeType " +
            "    AND dlcomis.t_ComNumber   = comis.t_Number ";

  var Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam( "", RSDBP_IN, Comm.DocKind );
  Query.addParam( "", RSDBP_IN, Comm.DocumentID );
  Query.addParam( "", RSDBP_IN, Comm.CommDate );
  Query.execute();

  var Data = TRsbDataSet(Query);
  if( Data.MoveNext() and (Data.NumRec > 0) )
     if( not InsertOprStatus(463302, 1) )
        MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
        return 1;
     end;
  end;

  if( not InsertOprStatus(463303, 2) )
     MsgBox("Ошибка при установке статуса <Открытие дня> по операции.");
     return 1;
  end;

  return 0;
end;

