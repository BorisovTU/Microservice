/*
$Name:        dvnop030.mac
$Module:      ФИСС и КО
$Description: Внебиржевая операция. Шаг: Признание ПФИ
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac", "dvserv.mac", "dv_grfun.mac";
import dv_loadpfibuf;

PRIVATE VAR ДатаИсполненияШага:date;

//ищет СС пфи в буферной таблице
macro Find_SS (DealCode, dt:date)
  var sql;
  var SS = $0;
  sql = "select 1 from user_sspfi_tmp where valuedate = :dt";
  if (not ExecSqlSelect(sql, MakeArray(SqlParam("dt", dt)), false).MoveNext() )
    WriteBufSSPFI(DealCode);
  end;
  sql = "select SS from user_sspfi_tmp "
      + "where     dealcode = :dealcode "
      + "      and valuedate = :dt ";
  sql = ExecSqlSelect(sql, MakeArray(SqlParam("dealcode", DealCode), SqlParam("dt", dt)), false);
  if (sql.MoveNext() )
    SS = sql.value(0, 0, V_MONEY);
  end;
  return SS;
End;

PRIVATE MACRO GetDealRate( FD:DVFirstDocNDeal, FIID:integer ):double
  var RetVal:double = 0.0;

  if( (FD.ВидБазовогоАктива(true) == FIKIND_AVOIRISS) and (FIID == FD.ВалютаБазовогоАктива()) and (FD.ВалютаРасчётов() == NATCUR) and (FD.ВалютаБазовогоАктива() != NATCUR) )
     RetVal = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_DEALRATE);
  end;

  return RetVal;
END;

PRIVATE MACRO ПоставитьНаВнебаланс( FD:DVFirstDocNDeal ):INTEGER
  record accdoc_plus(mcaccdoc);
  record accdoc_minus(mcaccdoc);
  var DebAccBuf  = TRecHandler("account");
  var CredAccBuf = TRecHandler("account");
  var corr = TRecHandler("account.dbt");
  var NeedTransfer:bool = false;
  var DebAcc:string  = ""; var DebFIID:integer  = ALLFININSTR;  var DebFiRole  = FIROLE_UNDEF;
  var CredAcc:string = ""; var CredFIID:integer = ALLFININSTR;  var CredFiRole = FIROLE_UNDEF;

  ПолучитьСрочныеСчетаВнб( FD, @DebAcc, @DebFIID, @DebFiRole, @CredAcc, @CredFIID, @CredFiRole );

  if( (not FD.OpenAccount( DebAcc,  null, null, DebFiRole,  DebAccBuf,  ДатаИсполненияШага, DebFIID,  null, accdoc_plus ) ) OR
      (not FD.OpenAccount( CredAcc, null, null, CredFiRole, CredAccBuf, ДатаИсполненияШага, CredFIID, null, accdoc_minus ) ) )
     return 1;
  end;

  /*проверяем, существует ли счет для того, чтобы не лезла ошибка, что такой счет уже существует #210153*/
  FD.SetFIIDForCorAccNum(DebFIID);
  if( not FD.IsExistAccount( "СчКорреспГлаваГ", null, false, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE), corr, null, ДатаИсполненияШага ) )
     if( (not FD.OpenAccount( "СчКорреспГлаваГ", null, false, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE), corr, ДатаИсполненияШага ) ) )
        return 1;
     end;
  end;
  if( not ПроводкаПоКатегориямУчета( FD,
                                     DebAccBuf, corr,
                                     ДатаИсполненияШага, 4,
                                     DebFIID, FD.ReqSum(),
                                     doc,
                                     INPCARRY, "", "",
                                     IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"), FD.GetGround(2), "Постановка требования по сделке " + FD.DealCode()),//"Постановка требований на внебалансовый учет по" + IIF( FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode(),
                                     null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null,
                                     GetDealRate(FD, DebFIID), true
                                   )
    )
     return 1;
  end;

  FD.SetFIIDForCorAccNum(CredFIID);
  if( not FD.IsExistAccount( "СчКорреспГлаваГ", null, false, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE), corr, null, ДатаИсполненияШага ) )
     if( (not FD.OpenAccount( "СчКорреспГлаваГ", null, false, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE), corr, ДатаИсполненияШага ) ) )
        return 1;
     end;
  end;
  if( not ПроводкаПоКатегориямУчета( FD,
                                     corr, CredAccBuf,
                                     ДатаИсполненияШага, 4,
                                     null, null,
                                     doc,
                                     INPCARRY, "", "",
                                     IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"), FD.GetGround(1) ,"Постановка обязательства по сделке " + FD.DealCode()),//"Постановка обязательств на внебалансовый учет по" + IIF( FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode(),
                                     null, null, null, null, null,
                                     CredFIID, FD.ComSum(),
                                     null, null, null, null, null, null, null, null, null, null, null,
                                     GetDealRate(FD, CredFIID), false
                                   )
    )
     return 1;
  end;

  var TransfDate:date = date(0,0,0);
  if( ПереноситьПоСрокам(FD, ДатаИсполненияШага, @TransfDate, true, accdoc_plus.PeriodID, accdoc_minus.PeriodID, DebAcc, CredAcc, DebFIID, CredFIID, DebFiRole, CredFiRole, FD.ДатаИсполнения()) )
     NeedTransfer = true;
     DL_CalendDefineOprDate(FD, IIF( FD.DealPart == 1, DV_NDEAL_OPRDATE_COTERMS, DV_NDEAL_OPRDATE_COTERMS_2), TransfDate );
  end;

  if( not InsertOprStatus( IIF(FD.DealPart == 1, FD.DV_OPERSTATUS_COTERMS(), FD.DV_OPERSTATUS_COTERMS_2()), IIF(NeedTransfer, DV_OPERSTATUS_COTERMS_TRANSFER, DV_OPERSTATUS_COTERMS_NOTRANSFER) ) )
     MsgBox("Ошибка при установке статуса <Перенос по срокам> для операции.");
     return 1;
  end;

  if( not InsertOprStatus(IIF(FD.DealPart == 1, FD.DV_OPERSTATUS_OFFBALANCE(), FD.DV_OPERSTATUS_OFFBALANCE_2()), DV_OPERSTATUS_OFFBALANCE_YES) )
     MsgBox("Ошибка при установке статуса <Внебаланс> для операции.");
     return 1;
  end;

  return 0;
END;

PRIVATE MACRO ПоставитьНаВнебалансПП( FD:DVFirstDocNDeal ):INTEGER

  record accdoc_plus(mcaccdoc);
  record accdoc_minus(mcaccdoc);
  var DebAccBuf  = TRecHandler("account");
  var CredAccBuf = TRecHandler("account");
  var DebAcc:string  = ""; var DebFIID:integer  = ALLFININSTR;  var DebFiRole  = FIROLE_UNDEF;
  var CredAcc:string = ""; var CredFIID:integer = ALLFININSTR;  var CredFiRole = FIROLE_UNDEF;
  var MinTransferDate:date = date(31,12,9999), TransferDate:date = date(0,0,0);
  var GrFD;
  var PmGrAccSum = DV_PmGrAccSumCollector();
  var Query, Data, Sql;
  var mQuery, mSql, mData;
  DebAcc  = "+Форвард,дрейф внебирж ПП";
  CredAcc = "-Форвард,дрейф внебирж ПП";
  DebFiRole  = FIROLE_FIREQ;
  CredFiRole  = FIROLE_FICOM;

  /*PNV*/
  if( FD.IsPctSWAP() )
      DebAcc = "+Форвард, дрейф Проц.СВОП";
      CredAcc = "-Форвард, дрейф Проц.СВОП";
      DebFiRole  = FIROLE_FIREQ;
      CredFiRole  = FIROLE_FICOM;
  else   
      ПолучитьСрочныеСчетаВнб( FD, @DebAcc, @DebFIID, @DebFiRole, @CredAcc, @CredFIID, @CredFiRole );
  end;
  /*PNV*/

  Sql = " SELECT * " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID  = ? " +
        "    AND t_PayDate > ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
  Query.addParam("", RSDBP_IN, FD.ДатаСделки() );
  Query.execute();

  Data = TRsbDataSet(Query);
  while( Data.MoveNext() )
     GrFD = DVFirstDocPmGr(DL_DVNDEALPMGR, SQL_ConvTypeInteger(Data.rec.ID));

     DebAccBuf.clear();
     if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_LIABILITY ) /* требование или не задано */
        if( not GrFD.OpenAccount(DebAcc, null, null, DebFiRole, DebAccBuf, ДатаИсполненияШага, FD.ВалютаТребования(), null, accdoc_plus) )
           return 1;
        end;
     end;

     CredAccBuf.clear();
     if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_DEMAND ) /* обязательство или не задано */
        if( not GrFD.OpenAccount(CredAcc, null, null, CredFiRole, CredAccBuf, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, accdoc_minus) )
           return 1;
        end;
     end;
     
     TransferDate = date(0,0,0);
     if( ПереноситьПоСрокам(GrFD, ДатаИсполненияШага, @TransferDate, true, IIF(FD.IsMigrDeal(),GrFD.GetPidFromAccMigr(),accdoc_plus.PeriodID), IIF(FD.IsMigrDeal(),GrFD.GetPidFromAccMigr(),accdoc_minus.PeriodID),
                            IIF(DebAccBuf.rec.Account > 0, DebAcc, ""), IIF(CredAccBuf.rec.Account > 0, CredAcc, ""), FD.ВалютаТребования(), FD.ВалютаОбязательства(), DebFiRole, CredFiRole) )
        MinTransferDate = min(MinTransferDate, TransferDate);
     end;

     if( DV_TransferPm(GrFD.PmGr.rec.ID, ДатаИсполненияШага, TransferDate, DebAccBuf.rec.Account, CredAccBuf.rec.Account, DV_PMGR_CHANGE_PUTONBALANCE) )
        return 1;
     end;

     PmGrAccSum.AddData(DebAccBuf, CredAccBuf, GrFD.ReqSum(), GrFD.ComSum(), GrFD.PmGr.rec.Side, null, null, GrFD.ID); /*PNV 494582*/
  end;

  var i:integer = 0;
  while( i < PmGrAccSum.Size )
     if( ПроводкиПоЗачислениюПП(FD, doc, PmGrAccSum(i), ДатаИсполненияШага, null, GrFD.PmGr) != 0 )/*PNV i-support 488706*/ 
        return 1;
     end;

     i = i + 1;
  end;

  if( MinTransferDate != date(31,12,9999) )
     DL_CalendDefineOprDate(FD,DV_NDEAL_OPRDATE_COTERMS_IP, MinTransferDate);

     if( not InsertOprStatus(DV_OPERSTATUS_KIND_COTERMS_IP, DV_OPERSTATUS_COTERMS_TRANSFER) )
        MsgBox("Ошибка при установке статуса <Перенос по срокам ПП> для операции.");
        return 1;
     end;
  else
     if( not InsertOprStatus(DV_OPERSTATUS_KIND_COTERMS_IP, DV_OPERSTATUS_COTERMS_NOTRANSFER) )
        MsgBox("Ошибка при установке статуса <Перенос по срокам ПП> для операции.");
        return 1;
     end;
  end;

  return 0;
END;

PRIVATE MACRO УчетПремии( FD:DVFirstDocNDeal ):INTEGER
  VAR OurAcc  = TRecHandler("account"),
      AccNalog = TRecHandler("account"),
      Payment:RsbPayment, PaymentNalog:RsbPayment,
      SubPurpose:integer = 0, TmpPaymentID:integer = -1;

  var bonusDate = DV_Calend_GetCorrectDate(FD,DV_NDEAL_OPRDATE_PAY_AWARD,FD.Deal.rec.BonusDate);

  var SumPaym:money = FD.Deal.rec.Bonus;
  var PayNalog = FD.IsPayNalog();
  var SumNalogRUR:money = $0.0;
  var SumNalog:money = $0.0;
  var SumTax:money = $0;

  if( PayNalog )
     SumNalogRUR = FD.SumNalog(bonusDate);
     if( not DV_SmartConvertSumDbl(SumNalog, SumNalogRUR, bonusDate, NATCUR, FD.Deal.rec.BonusFIID) )
        MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(NATCUR)) + " в " + string(ПолучитьКодФинИн(FD.Deal.rec.BonusFIID)) );
        return 1;
     end;
  end;

  if( FD.IsBuy() and (not FD.IsAgent()) and PayNalog )
     SumPaym = SumPaym - SumNalog;
  end;

  if( FD.IsBuy() ) // оплата
     if( not FD.IsClient() )
        if( not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_BONUS, OurAcc, bonusDate, FD.Deal.rec.BonusFIID, null, null, MC_PAIRACCMODE_MANUAL ) )
           return 1;
        end;
     end;

     if( DVND_CreatePayment( FD, PRi, FD.Kind, FD.Deal.rec.ID,
                             bonusDate,
                             IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                             IIF( FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor ), -1,
                             SumPaym, FD.Deal.rec.BonusFIID,
                             IIF(FD.Deal.rec.BonusFIID != NATCUR, FD.GetGround(1008), FD.GetGround(1002)),//"Оплата премии", /*PNV 504472*/
                             IIF( FD.IsClient(), NULL, OurAcc ), NULL,
                             FD.Deal.rec.Department, SubPurpose,
                             NULL,
                             @Payment, TmpPaymentID ) != 0 )
         return 1;
     end;
     TmpPaymentID = TmpPaymentID - 1;
     SubPurpose   = SubPurpose + 1;

     if( (not FD.IsAgent()) and PayNalog )

        if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, null, FIROLE_UNDEF, AccNalog, bonusDate, NATCUR ) )
           return 1;
        end;

        if( DVND_CreatePayment( FD, PM_PURP_TAXINCOME_NJ, FD.Kind, FD.Deal.rec.ID,
                                bonusDate,
                                IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                                {ourbank}, {ourbank},
                                SumNalogRUR, NATCUR,
                                "Удержание налога",
                                IIF( FD.IsClient(), NULL, OurAcc ), AccNalog,
                                FD.Deal.rec.Department, SubPurpose,
                                NULL,
                                @PaymentNalog, TmpPaymentID ) != 0 )
            return 1;
        end;
        TmpPaymentID = TmpPaymentID - 1;
        SubPurpose   = SubPurpose + 1;
     end;

  else // получение
     if( not FD.IsClient() )
        if( not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(),  null, null, FIROLE_BONUS, OurAcc, bonusDate, FD.Deal.rec.BonusFIID, null, null, MC_PAIRACCMODE_MANUAL ) )
           return 1;
        end;
     end;

     if( DVND_CreatePayment( FD, PRi, FD.Kind, FD.Deal.rec.ID, 
                             bonusDate,
                             IIF( FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor ), -1,
                             IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                             SumPaym, FD.Deal.rec.BonusFIID,
                             FD.GetGround(1003),//"Получение премии", 
                             NULL, IIF( FD.IsClient(), NULL, OurAcc ),
                             FD.Deal.rec.Department, SubPurpose,
                             NULL,
                             @Payment, TmpPaymentID ) != 0 )
         return 1;
     end;
     TmpPaymentID = TmpPaymentID - 1;
     SubPurpose   = SubPurpose + 1;
  end;

  return 0;
END;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var FrVal = TRecHandler("dvnfrval");
  var FD, FD_2;
  var SS;
  var Bonus:money = 0.0;
  var HedgeRecs = 0;
  var HedgeType = 0;

  SetBuff( ndeal, FDoc );    

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);
  FD = DVFirstDocNDeal(DocKind, ndeal);

  if( FD.IsSWAP() or FD.IsPctSWAP() )
     FD_2 = DVFirstDocNDeal(DocKind, ndeal, 2);
  end;
  
  // Валютный/процентный своп ИЛИ
  // расчетная на валюту ИЛИ
  // НеРанееТретьегоДня поставочная сделка на валюту (т.е. поставка валюты должна быть осуществлена не ранее третьего дня после даты заключения)
  if(  FD.IsSWAP() OR FD.IsPctSWAP() OR
       (
          (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) AND 
          (
             (not FD.ПоставочныйКонтракт()) OR FD.СделкаНеРанееТретьегоДня() 
          )
       )
    )
     if( not УстановитьКатегориюФИСС( FD.Deal, OBJTYPE_OUTOPER_DV, ДатаИсполненияШага ) )
        return 1;
     end;
  end;

  if (FD.IsPctSWAP() and (not FD.IsClient()) and (FD.Deal.rec.Sector != SET_CHAR))
     var cmdHedge = RSDCommand("SELECT 1 retval, t_hedgetype HT FROM DDLHDGRELATION_DBT WHERE t_instrid = ? AND t_instrdockind = ? AND t_BeginDate = ? ");
     cmdHedge.addParam( "", RSDBP_IN, FD.Deal.rec.ID);
     cmdHedge.addParam( "", RSDBP_IN, FD.Deal.rec.DocKind);
     cmdHedge.addParam( "", RSDBP_IN, ДатаИсполненияШага);
     cmdHedge.execute();
     var HedgeData = TRsbDataSet(cmdHedge);
     if( HedgeData.MoveNext())
        HedgeRecs = HedgeData.retval;
        HedgeType = HedgeData.HT;
     end;
  end;

  if( FD.IsOption() )
     if( not DV_SmartConvertSumDbl(Bonus, FD.Deal.rec.Bonus, ДатаИсполненияШага, FD.Deal.rec.BonusFIID, NATCUR) )
        MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(FD.Deal.rec.BonusFIID)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        return 1;
     end;
  end;
  if( NOT ВстроенныйПФИ (FD))
    if( (not FD.IsClient()) and (FD.Deal.rec.IsPFI == SET_CHAR) and (not FD.IsOption()) and (FD.nFI_BaseActiv.rec.FairValueAlg > 0) and (not (FD.IsSWAP() and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()))) )
     /* Если в таблице DDVNFRVAL_DBT нет записи по сделке за дату заключения  */
     if( not FD.ВыполненаПереоценкаСС( ДатаИсполненияШага, FrVal ) )
        FrVal.rec.DealID       = ndeal.Id;
        FrVal.rec.DocKind      = ndeal.DocKind;
        FrVal.rec.Date         = ДатаИсполненияШага;
        FrVal.rec.FairValueAlg = FD.nFI_BaseActiv.rec.FairValueAlg;
        FrVal.rec.FairValue    = IIF( FD.IsBuy(), Bonus, -Bonus);
       if( DV_InsFrValPanel(FrVal) == 0 )
           if( DV_InsertFrVal(FrVal) != 0 )
              MsgBox("Ошибка при вставке записи оценки справедливой стоимости.");
              return 1;
           end;
        else
           return 1;
        end;  /*CHVA 501597    убрал формирование записи в истории Справедливой стоимости на шаге "Признание ПФИ"*/
              /*PNV 541324 вернула обратно*/
        if(РАБОТА_С_РЕПОЗИТАРИЕМ() and (GetSettingMessageSendingMode() != 3) ) 
           if( InsertGrDealFairValueRevaluation(FD, ДатаИсполненияШага, DocKind) != 0 )
              MsgBox("Ошибка вставки строки графика \"Переоценка справедливой стоимости\"");
              return 1;
           end;
        end;
     end;
  end;

  /* Выполнить проводки по учету СС и премии*/
  if( (not FD.IsClient()) AND (FD.IsForward() OR FD.IsSWAP() OR FD.IsPctSWAP()) )
     if( FD.IsGenerated() AND FD.IsForward() )
        var FD2 = DVFirstDocNDeal(DocKind, FD.Deal.rec.ParentID);
        if( FrVal.rec.FairValue > 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              "+ПФИ", ПИ_КатегорияПлФорвардРПИ(),
                                              ДатаИсполненияШага, 1,
                                              NATCUR, FrVal.rec.FairValue,
                                              doc,
                                              INPCARRY, "", "",
                                              FD.GetGround(7),
                                              null, null, null, null, null, null, null, null, FD2,
                                              null, null, null, null, null, MC_PAIRACCMODE_MANUAL
                                            )
             )
              return 1;
           end;
        elif( FrVal.rec.FairValue < 0 )
           if( not ПроводкаПоКатегориямУчета( FD2,
                                              ПИ_КатегорияМнФорвардРПИ(), "-ПФИ",
                                              ДатаИсполненияШага, 1,
                                              NATCUR, abs(FrVal.rec.FairValue),
                                              doc,
                                              INPCARRY, "", "",
                                              FD.GetGround(7),
                                              null, null, null, null, null, null, null, null, FD,
                                              null, null, null, null, MC_PAIRACCMODE_MANUAL, null
                                            )
             )
              return 1;
           end;
        end;
     else
        if( FrVal.rec.FairValue != 0 )
           var DebAcc:string  = "", CredAcc:string = "";
           var ИспользоватьВыбытие:bool = false;
           if( FD.IsSWAP() )
              if( (FrVal.rec.InterimPayDate != SET_CHAR) or
                  ((FrVal.rec.InterimPayDate == SET_CHAR) and FD.ПоставочныйКонтракт() and ПИ_НеИсп61601ПостСВОП() and (FD.ЧастьСделкиНеРанееТретьегоДня() == false) )
                )
                 ИспользоватьВыбытие = false;
              else
                 ИспользоватьВыбытие = true;
              end;
           elif( FD.IsPctSWAP() )
              var InterimPayDate:bool = ((FD.БазовыеВалютыРавны() == false) OR (FrVal.rec.InterimPayDate == SET_CHAR));
              if( (InterimPayDate != SET_CHAR) or
                  ((InterimPayDate == SET_CHAR) and ПИ_НеИсп61601ПостСВОП() and (FD.ЧастьСделкиНеРанееТретьегоДня() == false) )
                )
                 ИспользоватьВыбытие = false;
              else
                 ИспользоватьВыбытие = true;
              end;
           end;

           if( FrVal.rec.FairValue > 0 )
              DebAcc  = "+ПФИ";
                if(HedgeRecs != 0)
                  if(HedgeType == 1) /*Хеджирование СС*/
                   CredAcc = "Доходы_хедж, ПФИ";
                  elif(HedgeType == 2) /*Хеджирование ДП*/
                   CredAcc = "-Корр,Хедж_ДП";
                  end;
                else
              CredAcc = IIF(ИспользоватьВыбытие, "Выбытие ПФИ", "Доходы ПФИ");
                end;
           elif( FrVal.rec.FairValue < 0 )
                 if(HedgeRecs != 0)
                   if(HedgeType == 1) /*Хеджирование СС*/
                     DebAcc = "Расходы_хедж, ПФИ";
                   elif(HedgeType == 2) /*Хеджирование ДП*/
                     DebAcc = "+Корр,Хедж_ДП";
                  end;
                else
              DebAcc  = IIF(ИспользоватьВыбытие, "Выбытие ПФИ", "Расходы ПФИ");
                end;
              CredAcc = "-ПФИ";
           end;

           if( not ПроводкаПоКатегориямУчета( FD,
                                              DebAcc, CredAcc,
                                              ДатаИсполненияШага, 1,
                                              NATCUR, abs(FrVal.rec.FairValue),
                                              doc,
                                              INPCARRY, "", "",
                                              FD.GetGround(7)
                                            )
             )
              return 1;
           end;
        end;
     end;
elif( FD.IsOption() and FD.Deal.rec.Bonus != 0 )
     if( not DV_SmartConvertSumDbl(Bonus, FD.Deal.rec.Bonus, ДатаИсполненияШага, FD.Deal.rec.BonusFIID, NATCUR) )
        MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(FD.Deal.rec.BonusFIID)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        return 1;
     end;

     /* Учет премии (только для собственных операций) */
     if( FD.IsClient() == false )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(),
                                           ДатаИсполненияШага, 1,
                                           FD.Deal.rec.BonusFIID, FD.Deal.rec.Bonus,
                                           doc,
                                           INPCARRY,"", "",
                                           FD.GetGround(12),
                                           NULL,
                                           FIROLE_BONUS, FIROLE_BONUS,
                                           null, null,
                                           null, null, null, null, null, null, null, null,
                                           MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                         )
          )
           return 1;
        end;

        if( FD.IsBuy() )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              "+ПФИ", ПИ_КатегорияПлФорвардРПИ(),
                                              ДатаИсполненияШага, 1,
                                              FD.Deal.rec.BonusFIID, FD.Deal.rec.Bonus,
                                              doc,
                                              INPCARRY,"", "",
                                              FD.GetGround(13),
                                              NULL,
                                              FIROLE_UNDEF, FIROLE_BONUS,
                                              NATCUR, FD.Deal.rec.BonusFIID,
                                              null, null, null, null, null, null, null, null,
                                              null, MC_PAIRACCMODE_MANUAL
                                            )
             )
              return 1;
           end;
        elif( FD.IsSale() )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              ПИ_КатегорияМнФорвардРПИ(), "-ПФИ",
                                              ДатаИсполненияШага, 1,
                                              FD.Deal.rec.BonusFIID, FD.Deal.rec.Bonus,
                                              doc,
                                              INPCARRY,"", "",
                                              FD.GetGround(13),
                                              NULL,
                                              FIROLE_BONUS, FIROLE_UNDEF,
                                              FD.Deal.rec.BonusFIID, NATCUR,
                                              null, null, null, null, null, null, null, null,
                                              MC_PAIRACCMODE_MANUAL, null
                                            )
             )
              return 1;
           end;
        end;
     end;

     /* Сформировать и выполнить платеж по премии. */
     if ( Bonus != 0.0 )
        if( not InsertOprStatus(DV_OPERSTATUS_KIND_PAY_AWARD, DV_OPERSTATUS_PAY_AWARD_ALLOW) )
           MsgBox("Ошибка при установке статуса <Оплата премии> по операции.");
           return 1;
        end;
          DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_PAY_AWARD, FD.Deal.rec.BONUSDATE );
        if( УчетПремии( FD ) != 0 )
           return 1;
        end;
     else
        if( not InsertOprStatus(DV_OPERSTATUS_KIND_PAY_AWARD, DV_OPERSTATUS_PAY_AWARD_DENY) )
           MsgBox("Ошибка при установке статуса <Оплата премии> по операции.");
           return 1;
        end;
     end;

     /* Учет справедливой стоимости при первоначальном признании (только для собственных операций) */
     /*mda 20.02.2019 Этот блок перенесли в dvnop030_1.mac "Первоначальное признание СС"*/
     /*if( FD.IsClient() == false )
        if( FD.IsBuy() )
           if( FrVal.rec.FairValue > Bonus )
              if( not ПроводкаПоКатегориямУчета( FD,
                                                 "+ПФИ", "Доходы ПФИ",
                                                 ДатаИсполненияШага, 1,
                                                 NATCUR, (FrVal.rec.FairValue - Bonus),
                                                 doc,
                                                 INPCARRY,"", "",
                                                 "Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                                 NULL,
                                                 FIROLE_UNDEF, FIROLE_UNDEF
                                               )
                )
                 return 1;
              end;
           elif( FrVal.rec.FairValue < Bonus )
              if( not ПроводкаПоКатегориямУчета( FD,
                                                 "Расходы ПФИ", "+ПФИ",
                                                 ДатаИсполненияШага, 1,
                                                 NATCUR, (Bonus - FrVal.rec.FairValue),
                                                 doc,
                                                 INPCARRY,"", "",
                                                 "Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                                 NULL,
                                                 FIROLE_UNDEF, FIROLE_UNDEF
                                               )
                )
                 return 1;
              end;
           end;
        elif( FD.IsSale() )
           if( abs(FrVal.rec.FairValue) > Bonus )
              if( not ПроводкаПоКатегориямУчета( FD,
                                                 "Расходы ПФИ", "-ПФИ",
                                                 ДатаИсполненияШага, 1,
                                                 NATCUR, (abs(FrVal.rec.FairValue) - Bonus),
                                                 doc,
                                                 INPCARRY,"", "",
                                                 "Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                                 NULL,
                                                 FIROLE_UNDEF, FIROLE_UNDEF
                                               )
                )
                 return 1;
              end;
           elif( abs(FrVal.rec.FairValue) < Bonus )
              if( not ПроводкаПоКатегориямУчета( FD,
                                                 "-ПФИ", "Доходы ПФИ",
                                                 ДатаИсполненияШага, 1,
                                                 NATCUR, (Bonus - abs(FrVal.rec.FairValue)),
                                                 doc,
                                                 INPCARRY,"", "",
                                                 "Корректировка справедливой стоимости опциона по сделке "+FD.DealCode(),
                                                 NULL,
                                                 FIROLE_UNDEF, FIROLE_UNDEF
                                               )
                )
                 return 1;
              end;
           end;
        end;
     end; */ //END Перенос 20,02,19
  end;
//конец теста
  else
     if( not InsertOprStatus(DV_OPERSTATUS_KIND_PAY_AWARD, DV_OPERSTATUS_PAY_AWARD_DENY) )
        MsgBox("Ошибка при установке статуса <Оплата премии> по операции.");
        return 1;
     end;        
  end;


  /* устанавливаем признак участия в неттинге */
  if( FD.IsClient() )
     var ПлатежТреб = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
     var ПлатежОб   = RsbPayment(FD.ПлатежОб.rec.PaymentID);

     if( FD.ПлатежТреб.rec.PaymentID > 0 )
        ПлатежТреб.Netting = SET_CHAR;
     end;

     if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.Netting = SET_CHAR;
     end;

     if( (FD.IsSWAP()) and (FD.deal.rec.Netting == SET_CHAR)) // для FD.IsPctSWAP() устанавливается в сишнике в зависимости от галочки на пенели
        /* устанавливаем признак участия в неттинге */
        var ПлатежТреб2 = RsbPayment(FD_2.ПлатежТреб.rec.PaymentID);
        var ПлатежОб2   = RsbPayment(FD_2.ПлатежОб.rec.PaymentID);

        if( FD_2.ПлатежТреб.rec.PaymentID > 0 )
           ПлатежТреб2.Netting = SET_CHAR;
        end;

        if( FD_2.ПлатежОб.rec.PaymentID > 0 )
           ПлатежОб2.Netting = SET_CHAR;
        end;
     end;
  end;

  /* Если сделка банка и контракт поставочный */
  var СтавитьНаВнебаланс:bool = (FD.IsClient() == false);
  var СтавитьНаВнебаланс2ч:bool = ( (FD.IsClient() == false) and
                                  (((FD.IsPctSWAP() == false) ) or
                                   (FD.IsPctSWAP() and (FD.БазовыеВалютыРавны() == false))) );

  if( СтавитьНаВнебаланс and ( (FD.IsToDay() == false) or ( FD.IsPctSWAP() and ( (FD.Deal.rec.SwapType == DLSWAP_IRS) or (FD.Deal.rec.SwapType == DLSWAP_OIS) ) ) ) )
     if( ПоставитьНаВнебаланс( FD ) != 0 )
        return 1;
     end;
  else   
       if( not InsertOprStatus( FD.DV_OPERSTATUS_COTERMS(), DV_OPERSTATUS_COTERMS_NOTRANSFER) )
          MsgBox("Ошибка при установке статуса <Перенос по срокам> для операции.");
          return 1;
       end;
  end;

  if( FD.IsSWAP() or FD.IsPctSWAP() )
     if( СтавитьНаВнебаланс2ч and (FD_2.IsToDay() == false) )
        if( ПоставитьНаВнебаланс( FD_2 ) != 0 )
           return 1;
        end;
     else
        if( not InsertOprStatus( FD.DV_OPERSTATUS_COTERMS_2(), DV_OPERSTATUS_COTERMS_NOTRANSFER) )
           MsgBox("Ошибка при установке статуса <Перенос по срокам 2ч> для операции.");
           return 1;
        end;
     end;
  end;

  if( FD.IsSWAP() )
     if( not InsertOprStatus(FD.DV_OPERSTATUS_EXECTYPE(), IIF( FD.ПоставочныйКонтракт(), DV_OPERSTATUS_EXECTYPE_STATE, DV_OPERSTATUS_EXECTYPE_CALC) ) )
        MsgBox("Ошибка при установке статуса <Тип исполнения> для операции.");
        return 1;
     end;
  end;

  if( FD.IsPctSWAP() )
     if( not FD.IsClient() )
        if( ПоставитьНаВнебалансПП(FD) != 0 )
           return 1;
        end;
     else
        if( not InsertOprStatus(DV_OPERSTATUS_KIND_COTERMS_IP, DV_OPERSTATUS_COTERMS_NOTRANSFER) )
           MsgBox("Ошибка при установке статуса <Перенос по срокам ПП> для операции.");
           return 1;
        end;
     end;

     if( (FD.БазовыеВалютыРавны() == false) and (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) )
       if ( АктуализироватьПлатежи(FD, ДатаИсполненияШага) != 0 )
          return 1;
       end;
     end;

     var DatePmGr:date = date(0,0,0);
     if( FD.Deal.rec.Netting_PmGr == SET_CHAR )
        if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM_L(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Платеж по обязательству> для операции.");
           return 1;
        end;

        if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM_D(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Платеж по требованию> для операции.");
           return 1;
        end;

        DatePmGr = FD.GetDatePmGr(ALG_DV_PMGR_SIDE_UNDEF, ДатаИсполненияШага-1);
        if( DatePmGr == date(0,0,0) )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM(), DV_OPERSTATUS_PAYM_NOTEX) )
              MsgBox("Ошибка при установке статуса <Платеж> для операции.");
              return 1;
           end;
        else
           DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_PAYM, DatePmGr );
           if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Платеж> для операции.");
              return 1;
           end;
        end;
     else
        if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Платеж> для операции.");
           return 1;
        end;

        DatePmGr = FD.GetDatePmGr(ALG_DV_PMGR_SIDE_LIABILITY, ДатаИсполненияШага-1);
        if( DatePmGr == date(0,0,0) )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM_L(), DV_OPERSTATUS_PAYM_NOTEX) )
              MsgBox("Ошибка при установке статуса <Платеж по обязательству> для операции.");
              return 1;
           end;
        else
           DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_PAYM_L, DatePmGr );
           if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM_L(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Платеж по обязательству> для операции.");
              return 1;
           end;
        end;

        DatePmGr = FD.GetDatePmGr(ALG_DV_PMGR_SIDE_DEMAND, ДатаИсполненияШага-1);
        if( DatePmGr == date(0,0,0) )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM_D(), DV_OPERSTATUS_PAYM_NOTEX) )
              MsgBox("Ошибка при установке статуса <Платеж по требованию> для операции.");
              return 1;
           end;
        else
           DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_PAYM_D, DatePmGr );
           if( not InsertOprStatus(FD.DV_OPERSTATUS_PAYM_D(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Платеж по требованию> для операции.");
              return 1;
           end;
        end;
     end;
  end;

  if( FD.IsForward() OR FD.IsSWAP() OR FD.IsPctSWAP() )
     var Дк = DL_GetMinComPlanDateByOper(DocKind, FD.Deal.rec.ID);
      if ((FD.Deal.rec.kind == 2715)/*MDA*/ or (fd.deal.rec.kind == 12715)/*MDA*/)
        if( not InsertOprStatus(FD.DV_OPERSTATUS_COMISS(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
           return 1;
        end;
      else
        if( Дк != date(0,0,0) )
          if( not InsertOprStatus(FD.DV_OPERSTATUS_COMISS(), DV_OPERSTATUS_PAYM_EX) )
             MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
             return 1;
          end;
          DL_CalendDefineOprDate(FD,DV_NDEAL_OPRDATE_COMISS, Дк);
        else
          if( not InsertOprStatus(FD.DV_OPERSTATUS_COMISS(), DV_OPERSTATUS_PAYM_NOTEX) )
             MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
             return 1;
          end;
        end;
       end;
      end;

  if( HedgeRecs != 0 )
     if( not InsertOprStatus( DV_OPERSTATUS_KIND_IS_HEDGE, DV_OPERSTATUS_IS_HEDGE_ALLOW) )
        MsgBox("Ошибка при установке статуса <Отношения хеджирования> для операции.");
        return 1;
     end;
  end;
  return 0;
end;
