/*
$Name:        dvrecon.mac
$Module:      îàëë ® äé
$Description: é‚Á•‚ "ë¢•‡™† ¢≠•°†´†≠·† ØÆ Æ‚™‡Î‚Î¨ ØÆß®Ê®Ô¨ ØÆ èà"
*/

import "dvrepfun.mac", "dvRepFun2.mac", RsbDataSet, "or_rep_h.mac", "dv_categ.mac", "dv_fun.mac", "dvserv.mac", "dldlngfun.mac";

const FontBold =  "ex_FS(b)";
const FontTitle = "ex_FS(b):ex_FN(Arial):ex_FZ(12)";

const NOTRETIRE = 0;
const RETIRE = 1;

private var Table = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
                    "≥    äÆ≠‚‡†™‚    ≥   Ç®§ ™Æ≠‚‡†™‚†   ≥       í®Ø      ≥    ë‚®´Ï    ≥    ñ•≠†    ≥  Ç†´Ó‚† Ê•≠Î  ≥ Ç®§ ®·ÂÆ§≠Æ£Æ ≥    à·ÂÆ§≠Î©    ≥   ç†®¨•≠Æ¢†≠®•   ≥    ù¨®‚•≠‚   ≥     Ñ†‚†     ≥  äÆ≠‚‡†£•≠‚  ≥ ç•‚‚Æ-ØÆß®Ê®Ô≥ê†·Á•‚≠†Ô Ê•≠†≥ Ç†´Ó‚† ‡†·Á•‚≠Æ© ≥ ë‚Æ®¨Æ·‚Ï ØÆ ≥ ã®Ê•¢Æ© ·Á•‚ ≥Ñ†‚† ØÆ·‚†≠Æ¢™®≥    é·‚†‚Æ™   ≥ ã®Ê•¢Æ© ·Á•‚ ≥Ñ†‚† ØÆ·‚†≠Æ¢™®≥       é·‚†‚Æ™        ≥\n" +
                    "≥                ≥                   ≥                ≥             ≥ ®·ØÆ´≠•≠®Ô ≥   ®·ØÆ´≠•≠®Ô  ≥    †™‚®¢†     ≥     †™‚®¢      ≥ ®·ÂÆ§≠Æ£Æ †™‚®¢† ≥              ≥  ®·ØÆ´≠•≠®Ô  ≥              ≥              ≥              ≥       Ê•≠Î       ≥‡†·Á•‚≠Æ© Ê•≠•≥  ‚‡•°Æ¢†≠®©  ≥               ≥              ≥ Æ°Ôß†‚•´Ï·‚¢ ≥               ≥                      ≥\n" +
                    "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ≈ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";

private var TableErrors = "⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø\n" +
                          "≥                                          éË®°™® ¢ÎØÆ´≠•≠®Ô                                         ≥\n" +
                          "√ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥";



/* §´Ô Æ°‡†°Æ‚™® ÆË®°Æ™ */
private var ErrorStr = 0;
private var Errors = TArray();
private var ErrorsReportLog = TRUE;
private var ReportData;
private var Dv_Deal;
private var Rep = CMakeReport(Table);

var IsID = -1;

CLASS SourceData( _DateRep:date,
                  _BaseFIKind:integer,
                  _BaseFIID:integer,
                  _DVFIKind:integer,
                  _IssuerID:integer,
                  _DVFIID:integer,
                  _IsApp:bool,
                  _IsExcel:bool )
   /* §†≠≠Î• §´Ô Æ‚Á•‚† */
   var dateRep          = _DateRep,

       BaseFIKind       = _BaseFIKind,
       BaseFIID         = _BaseFIID,
       DVFIKind         = _DVFIKind,
       DVFIID           = _DVFIID,

       IssuerID         = _IssuerID,
       
       IsExcel          = _IsExcel,
       IsApp            = _IsApp,
       ReportRun        = false;

   var FirstSheet       = NULL;
   var Fltr             = "";

   if( BaseFIKind > 0 )
      Fltr = Fltr + " and t_BaseFIKind = " + String(BaseFIKind);
   end;

   if( IssuerID > 0 )
        IsID = IssuerID;
   else 
      IssuerID = -1;
   end;

   if( BaseFIID != ALLFININSTR )
      Fltr = Fltr + " and t_BaseFIID = " + String(BaseFIID);
   end;

   if( DVFIKind > 0 )
      Fltr = Fltr + " and t_FI_Kind = " + String(DVFIKind);
   end;

   if( DVFIID > 0 )
      Fltr = Fltr + " and t_FIID = " + String(DVFIID);
   end;

END;

/*------------------------------------------------------------------------------------------------------------------*/
macro èà_ëà·‚•™Ë®¨ë‡Æ™Æ¨()
  var sqlQuery;
   sqlQuery = "select t_FIID from dfininstr_dbt" +
              " where t_DrawingDate <= " + GetSQLDate( ReportData.dateRep ) + " and " +
              "       t_FI_Kind = " + String(FIKIND_DERIVATIVE);
   return sqlQuery;
end;

macro èÆ´„Á®‚ÏèÆß®Ê®®( WhereCond:string )
  var sqlQuery;
   sqlQuery = "select POS.t_ID, POS.t_FIID, POS.t_Department, POS.t_Broker" + 
              " from ddvfipos_dbt POS "+
              "where POS.t_Client = " + String( -1 );
   if( WhereCond )
      sqlQuery = sqlQuery + " and " + WhereCond;
   end;
   sqlQuery = sqlQuery + " order by POS.t_Department, POS.t_Broker, POS.t_ID";
  return TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
end;

private macro é·‚†‚Æ™ç†ëÁÒ‚•( Account, FIID, DateRest )

  var Rest = $0.0;
  var AccBuf = TRecHandler("account");
   
  ClearRecord( AccBuf );

  if( DV_GetAccount( 4, FIID, Account, AccBuf ) )
     Rest = DL_GetRestAccount( AccBuf.rec, DateRest );
  end;

  return Rest;

end;

/* ÑÆ°Æ¢´•≠®• ÆË®°™® · ¨†··®¢*/
macro ErrorLog( msg:string )
   Errors[ErrorStr]  = msg;
   ErrorStr = ErrorStr + 1;
end;

/* Ø•Á†‚Ï */

macro PrintLog()
  var count = 0;
   if( ErrorsReportLog )
      Rep.AddNewSheetBreak("éË®°™®", TableErrors);
      while( count < ErrorStr )

         Rep.AddPrintCell( Errors[count] , 0, 0, "l");
         Rep.AddStr();

         count = count + 1;
      end;
   end;
end;

/*------------------------------------------------------------------------------------------------------------------*/
/*
î®´®†´: <H0.1>
                                                     ë§•´™® ØÆ Æ‚™‡Î‚Î¨ ØÆß®Ê®Ô¨
Ñ†‚† Æ‚Á•‚†:    <H0.2>
*/
macro PrintHead0( Dprt, DateRep )

   if( ReportData.FirstSheet != NULL )
      Rep.AddNewSheetBreak( Dprt, Table );
   else
      ReportData.FirstSheet = Dprt;
   end;

   Rep.AddPrintCell( "ë¢•‡™† ¢≠•°†´†≠·† ØÆ Æ‚™‡Î‚Î¨ ØÆß®Ê®Ô¨ ØÆ èà",Rep.GetHeaderWidth(), 0, "c:" + FontTitle, REP_ELEM_STR);
   Rep.AddEmptyStr();
   Rep.AddStr();
   Rep.AddPrintCell( "ß†:", 24, 0, "l", REP_ELEM_STR);
   Rep.AddPrintCell( DateRep,       Rep.GetHeaderWidth() - 24, 0, "l", REP_ELEM_STR);
   Rep.AddStr();
end;

macro PrintLine( FICode, AvoirKind, OptionType, OptionStyle, OptionStrike, StrikeFI, InitialKind, InitialCode, InitialName, IssuerCode, DrawingDate, Contractor, NettoPos, CalcPrice, CalcPriceFI, SummPos, AccountPlus, AccountPlusDate, AccountPlusRest, AccountMinus, AccountMinusDate, AccountMinusRest )

   Rep.AddPrintCell( FICode,                0, 0, "c:" + FontBold);
   Rep.AddPrintCell( AvoirKind,             0, 0, "c");
   Rep.AddPrintCell( OptionType,            0, 0, "c");
   Rep.AddPrintCell( OptionStyle,           0, 0, "c");

   if( ReportData.IsApp )
       Rep.AddPrintCell( Money(OptionStrike), 0, 2, "r:a");
   else
       Rep.AddPrintCell( Money(OptionStrike), 0, 2, "r");
   end;
   Rep.AddPrintCell( StrikeFI,             0, 0, "c");
   
   Rep.AddPrintCell( InitialKind,              0, 0, "c");
   Rep.AddPrintCell( InitialCode,              0, 0, "c");
   Rep.AddPrintCell( InitialName,              0, 0, "c");

   Rep.AddPrintCell( IssuerCode,              0, 0, "c");
   Rep.AddPrintCell( Date(DrawingDate),       0, 0, "c");
   Rep.AddPrintCell( Contractor,              0, 0, "c");

   if( ReportData.IsApp )
       Rep.AddPrintCell( Double(NettoPos), 0, 0, "r:a");
   else
       Rep.AddPrintCell( Double(NettoPos), 0, 0, "r");
   end;

   if( CalcPrice == NULL )
       Rep.AddPrintCell(" ");
   else
       Rep.AddPrintCell( Money(CalcPrice), 0, 2, IIF( ReportData.IsApp, "r:a", "r"));
   end;

   Rep.AddPrintCell( CalcPriceFI,              0, 0, "c");
   if( ReportData.IsApp )
       Rep.AddPrintCell( Money(SummPos), 0, 2, "r:a");
   else
       Rep.AddPrintCell( Money(SummPos), 0, 2, "r");
   end;
   Rep.AddPrintCell( AccountPlus,              0, 0, "c");
   Rep.AddPrintCell( Date(AccountPlusDate),              0, 0, "c");
   if( ReportData.IsApp )
       Rep.AddPrintCell( Money(AccountPlusRest), 0, 2, "r:a");
   else
       Rep.AddPrintCell( Money(AccountPlusRest), 0, 2, "r");
   end;

   Rep.AddPrintCell( AccountMinus,             0, 0, "c");
   Rep.AddPrintCell( Date(AccountMinusDate),             0, 0, "c");
   if( ReportData.IsApp )
       Rep.AddPrintCell( Money(AccountMinusRest), 0, 2, "r:a");
   else
       Rep.AddPrintCell( Money(AccountMinusRest), 0, 2, "r");
   end;
 
   Rep.AddStr();
end;

MACRO è‡Æ¢•‡™†î®´Ï‚‡†(FI)
  
  if( (ReportData.BaseFIKind == -1) or (ReportData.BaseFIKind == FI.InitialFI.FI_Kind) )
  else
     return false;
  end;

  if( (ReportData.BaseFIID == -1) or (ReportData.BaseFIID == FI.InitialFI.FIID) )
  else
     return false;
  end; 

  if( (ReportData.DVFIKind == -1) or (ReportData.DVFIKind == FI.FI.AvoirKind) )
  else
     return false;
  end; 

  if( (ReportData.DVFIID == -1) or (ReportData.DVFIID == FI.FI.FIID) )
  else
     return false;
  end; 

  if( (ReportData.IssuerID == -1) or (ReportData.IssuerID == FI.FI.Issuer) )
  else
     return false;
  end; 

  return true;
END;

MACRO ëÆß§†≠®•é‚ÁÒ‚†()

   var DVPos = NULL;
   var NotEofPos;
   var Progress = TProgressBar;
   var TestDate:date;
   var FI;
   var TurnQuery, TurnData;
   var PlusQuery, PlusData;
   var MinusQuery, MinusData;
   var AccountPlus, AccountMinus;
   var AccountPlusDate, AccountMinusDate;
   var AccountPlusRest, AccountMinusRest;
   var NettoPos = 0, SummPos = $0;
   var CalcPrice = 0.0;

   PrintHead0( "é‚ÁÒ‚", ReportData.DateRep );

   /*èÆ´„Á†•¨ ®≠‰Æ‡¨†Ê®Ó §´Ô ‰Æ‡¨®‡Æ¢†≠®Ô Æ‚ÁÒ‚†*/
   DVPos = èÆ´„Á®‚ÏèÆß®Ê®®("POS.t_FIID not in (" + èà_ëà·‚•™Ë®¨ë‡Æ™Æ¨() + ") and (POS.t_State = " + String(DVPOS_OPEN) + " or POS.t_CloseDate > " + GetSQLDate( ReportData.dateRep ) + " )" + "AND EXISTS( Select TURN.* from ddvfiturn_dbt TURN WHERE TURN.t_FIID = POS.t_FIID AND TURN.t_Client = -1 AND TURN.T_DEPARTMENT  = POS.T_DEPARTMENT AND TURN.T_BROKER  = POS.T_BROKER AND TURN.t_Date <= " + GetSQLDate( ReportData.dateRep ) + " )" );
   DVPos.MoveLast();
   ReportData.ReportRun = false;
   if( DVPos.GetRecCount() > 0 )
      Progress.Init( DVPos.GetRecCount(), "é‚°Æ‡ ØÆß®Ê®©", "é‚°Æ‡ ≠•ß†™‡Î‚ÎÂ ØÆß®Ê®©" );
      NotEofPos = DVPos.MoveFirst();
      
      while( NotEofPos )
         FI = è‡Æ®ß¢Æ§≠Î©à≠·‚‡„¨•≠‚( DVPos.FIID );
         if (è‡Æ¢•‡™†î®´Ï‚‡†(FI) == false)
            NotEofPos = DVPos.MoveNext();
            continue;   
         end;
         TurnQuery = "select * from ddvfiturn_dbt TURN WHERE TURN.t_FIID = "+FI.FI.FIID+" AND TURN.T_DEPARTMENT  = "+DVPos.Department+" AND TURN.t_Client ="+ String( -1 )+" AND TURN.T_BROKER  = "+DvPos.Broker+"AND TURN.t_Date <= " + GetSQLDate( ReportData.dateRep ) + " order by TURN.t_Date DESC";
         TurnData = TRsbDataSet( TurnQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
         if (TurnData.MoveFirst())
            NettoPos = TurnData.LongPosition - TurnData.ShortPosition;
            SummPos = TurnData.LongPositionCost - TurnData.ShortPositionCost;
         else
            NettoPos = 0; SummPos = 0;
         end;
         if (FI.FI.AvoirKind == DERIVATIVE_FUTURES)
            if( NOT èÆ´„Á®‚Ïä„‡·á†§†≠≠Æ£ÆT®Ø†( @CalcPrice, FI.FI.FIID, FI.PriceFIID(), èà_èÆ´„Á®‚ÏÇ®§ä„‡·†(RATETYPE_CALC_PRICE), Date(ReportData.dateRep), false ) )
               ErrorLog( "ç•¢Æß¨Æ¶≠Æ ØÆ´„Á®‚Ï ™„‡· ¢®§† 'ê†·Á•‚≠†Ô Ê•≠†' §´Ô FIID = " + String(FI.FI.FIID) + " ≠† §†‚„ " + String(ReportData.dateRep) );
               CalcPrice = 0.0;
            end;     
         else
            CalcPrice = NULL;
         end;

         PlusQuery = "select T_ACCOUNT, T_ACTIVATEDATE, t_Currency from dmcaccdoc_dbt where t_CatID IN (Select t_ID from DMCCATEG_DBT where t_CODE = '+îÆ‡¢†‡§, îé') and t_FIID = "+FI.FI.FIID+" and t_ActivateDate <="+GetSQLDate(ReportData.dateRep)+"  order by t_ActivateDate DESC ";
         PlusData = TRsbDataSet( PlusQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
         if (PlusData.MoveFirst())
            AccountPlus = PlusData.Account;
            AccountPlusDate = PlusData.ActivateDate;
            AccountPlusRest = é·‚†‚Æ™ç†ëÁÒ‚•( PlusData.Account, PlusData.Currency, ReportData.dateRep );

         else
            AccountPlus = "";
            AccountPlusDate = "";
            AccountPlusRest = 0;
         end;

         MinusQuery = "select T_ACCOUNT, T_ACTIVATEDATE, t_Currency from dmcaccdoc_dbt where t_CatID IN (Select t_ID from DMCCATEG_DBT where t_CODE = '-îÆ‡¢†‡§, îé') and t_FIID = "+FI.FI.FIID+" and t_ActivateDate <="+GetSQLDate(ReportData.dateRep)+" order by t_ActivateDate DESC ";
         MinusData = TRsbDataSet( MinusQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
         if (MinusData.MoveFirst())
            AccountMinus = MinusData.Account;
            AccountMinusDate = PlusData.ActivateDate;
            AccountMinusRest = é·‚†‚Æ™ç†ëÁÒ‚•( MinusData.Account, MinusData.Currency, ReportData.dateRep );
         else
            AccountMinus = "";
            AccountMinusDate = "";
            AccountMinusRest = 0;
         end;

         PrintLine( FI.FI.FI_Code,
                    FI.AvoirKind(),
                    FI.OptionType(),
                    FI.OptionStyle(), 
                    FI.DV.Strike,
                    FI.StrikeCCY(),
                    FI.InitialKind(),
                    FI.InitialCode(),
                    FI.InitialFI.Name,
                    FI.IssuerCode(),
                    FI.FI.DrawingDate,
                    èà_èÆ´„Á®‚ÏäÆ‡Æ‚™Æ•à¨Ôë„°Í•™‚†( IIF(DVPos.Broker == -1, FI.FI.Issuer, DVPos.Broker) ),
                    NettoPos,
                    CalcPrice,
                    GetFI_CODE( FI.PriceFIID() ),
                    SummPos,
                    AccountPlus,
                    AccountPlusDate,
                    AccountPlusRest,
                    AccountMinus,
                    AccountMinusDate,
                    AccountMinusRest );

        ReportData.ReportRun = true;
        NotEofPos = DVPos.MoveNext();
        Progress.Use();
      end;
      Progress.Remove();
   end;
   if (ReportData.ReportRun == true)
      after_44_footer( Rep );
      PrintLog();
   end;
END;

macro ReportRun( _DateRep:date,
                 _BaseFIKind:integer,
                 _BaseFIID:integer,
                 _DVFIKind:integer,
                 _IssuerID:integer,
                 _DVFIID:integer,
                 _IsApp:bool,
                 _IsExcel:bool )

   Dl_CallInsertStat( IIF( _IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   ReportData = SourceData( _DateRep, _BaseFIKind, _BaseFIID, _DVFIKind, _IssuerID,
                             _DVFIID, _IsApp, _IsExcel);

   ëÆß§†≠®•é‚ÁÒ‚†();   

   if( ReportData.ReportRun == false )
      MsgBox("\nç•‚ §†≠≠ÎÂ, „§Æ¢´•‚¢Æ‡ÔÓÈ®Â Ø†‡†¨•‚‡†¨ Æ‚Á•‚†.");
   else
     if( ReportData.FirstSheet != NULL )
        if( _IsExcel )
           Rep.PrintWinRep(ReportData.FirstSheet);
           Rep.ShowWinRep();
        else
           Rep.PrintRep();
        end;
     end;
   end;
end;
