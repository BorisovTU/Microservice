/*
$Name:        dvop056.mac
$Module:      ФИСС и КО
$Description: Операция расчетов по ПИ. Шаг - Проверка формирования всех проводок ВУ
*/
import InsCarryDoc, "dvserv.mac", "dv_fun.mac", "dv_carop.mac";

macro ExecuteCaseStep( Kind_Operation, Number_Step, FDoc, KindDoc)
   record oper(dvoper);
   
   SetBuff( oper, FDoc );
   var ID_Operation = 0;
   var QueryOper = " SELECT oper.T_ID_OPERATION " +
                   "   FROM doproper_dbt oper " +
                   "    WHERE oper.T_KIND_OPERATION    =   " + Kind_Operation +
                   "    AND ltrim(oper.t_DocumentID)   =   " + oper.ID;
   var DataOper  = TRsbDataSet(QueryOper);
   if( DataOper.moveNext )
      ID_Operation = DataOper.ID_Operation;
   end;
   var Query = " SELECT DEAL.t_ID, TURN.t_Margin/*, DEAL.t_PositionBonus Bonus*/ " +
               "   FROM ddvdeal_dbt DEAL, ddvdlturn_dbt TURN " +
               "  WHERE " + DLTurnByOperationDate(oper) +
               "    AND DEAL.t_Date_Clr = " + GetSQLDate(oper.Date) +
               "    AND DEAL.t_Type in('B', 'S', 'D', 'G') " +
               "    AND (TURN.t_Margin != 0 /*or DEAL.t_PositionBonus != 0*/) " +
               "    AND DEAL.t_ID  NOT IN (SELECT t_DocID FROM ddlservaction_dbt WHERE t_Action = "+ DV_SERVACTION_KIND_MARGBONUS +" AND t_ID_Operation = " + ID_Operation + " ) ";

   var Data  = TRsbDataSet(Query);

   if( Data.movenext() )
      return "055"; /*шаг Формирование проводок ВУ*/
   else
      var Query1 = " SELECT DEAL.t_ID, sfcom.t_ReceiverID, DEAL.T_CLIENT, DEAL.T_CLIENTCONTR, sfcom.t_FIID_COMM as COMFIID, sfcom.t_Code ComCode, " +
                  "  COM.T_SUM S_OF, COM.T_NDS SN_OF " +
                  "   FROM ddvdlcom_dbt COM, dsfcomiss_dbt sfcom, ddvdeal_dbt DEAL " +
                  "  WHERE " + DealByOperation(oper) +
                  "    AND DEAL.t_Date_Clr = " + GetSQLDate(oper.Date) +
                  "    AND DEAL.t_Type in('B', 'S', 'D', 'G') " +
                  "    AND sfcom.t_ComissID = COM.t_ComissID " +
                  "    AND COM.T_DEALID = DEAL.t_ID " +
                  "    AND COM.T_ISBANKEXPENSES <> CHR(88) " +  //По комиссиям ОРБ не нужны проводки ВУ
                  "    AND DEAL.t_ID  NOT IN (SELECT t_DocID FROM ddlservaction_dbt WHERE t_Action = "+ DV_SERVACTION_KIND_COMISS +" AND t_ID_Operation = " + ID_Operation + " ) " +
                  " ORDER BY DEAL.t_ID";

      var Data1  = TRsbDataSet(Query1);
      if( Data1.movenext() )
         return "055"; /*шаг Формирование проводок ВУ*/
      else
         return "060"; /*шаг Завершение торгового дня*/
      end;
   end;
 
end;
