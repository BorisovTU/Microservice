/*
$Name:        dvfx016.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Оплата комиссий"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "cblogger2.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record deal(dvndeal);
  var nacdl = TRecHandler("dvnacdl.dbt");
  var FD;
  var Дк:date;

  GetOprDate(DV_FXDEAL_OPRDATE_COMISS, Дк);

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  var Sql = " SELECT dlcomis.t_ID,  dlcomis.t_PlanPayDate, dlcomis.t_Sum, dlcomis.t_NDS, dlcomis.t_IsBankExpenses, comis.t_ReceiverID, comis.t_FIID_Comm " +
            "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis  " +
            "  WHERE dlcomis.t_DocKind     = ? " +
            "    AND dlcomis.t_DocID       = ? " +
            "    AND dlcomis.t_FactPayDate = TO_DATE('01.01.0001', 'dd.mm.yyyy') " +
            "    AND dlcomis.t_PlanPayDate <= ? " +
            "    AND dlcomis.t_FeeType     = comis.t_FeeType " +
            "    AND dlcomis.t_ComNumber   = comis.t_Number " +
            " order by dlcomis.t_PlanPayDate ";

  var Query = RSDCommand(Sql);
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, FD.Kind);
  Query.addParam("", RSDBP_IN, FD.ID);
  Query.addParam("", RSDBP_IN, Дк);
  Query.execute();

  var Data = TRsbDataSet(Query);
  while( Data.MoveNext() )
     nacdl.clear();
     nacdl.rec.Date    = Data.rec.PlanPayDate;
     nacdl.rec.Sum     = Data.rec.Sum;
     nacdl.rec.AccFIID = Data.rec.FIID_Comm;
     nacdl.rec.TaxSum  = Data.rec.NDS;
     nacdl.rec.PaySum  = Data.rec.Sum - Data.rec.NDS;

/* >>BPV Убрал закомментаренную оплату комиссий и на всякий случай проверяем на валютный рынок*/
     if (FD.ВалютныйРынок() and FD.IsClient())
/******/
        if(Data.IsBankExpenses != SET_CHAR)
           if(not ПроводкаПоКатегориямУчета( FD, /*FIROLE_COMISS_CLIENT*/
                                             "+РасчетыКомисс1", IIF(( Data.rec.ReceiverID == {OurBank} ), "+КВ, ц/б","+Биржа"), /* КатегДеб , КатегКредит*/
                                             nacdl.rec.Date,                  /* Дата */
                                             1,                               /* Глава */
                                             nacdl.rec.AccFIID,               /* Валюта */
                                             nacdl.rec.Sum,                   /* Сумма  */
                                             null,
                                             INPCARRY,                        /* Result_Carry */
                                             " 1",                            /* Kind_Oper */
                                             "",                              /* Numb_Document */
                                             "Комиссия " + IIF(( Data.rec.ReceiverID == {OurBank} ), "брокера","биржи")+ ". Сделка N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается",
                                             0,null,FIROLE_COMISS_CLIENT,
                                             nacdl.rec.AccFIID, 0           /* валюты счетов: Дт - Кт */ 
                                           )
             )
              return 1;
           end;
        end;

        if( Data.rec.ReceiverID == {OurBank} )
           /*nacdl.rec.Direction = DV_CALCOP_DIRECTION_RECEPTION;
           if( ОплатаКомиссииБанку_КО(FD, doc, nacdl) != 0 )
              return 1;
           end;*/
        elif(Data.IsBankExpenses == SET_CHAR)
           nacdl.rec.Direction = DV_CALCOP_DIRECTION_PAYMENT;
           if( ОплатаКомиссииПосреднику_КО(FD, doc, nacdl, Data.IsBankExpenses == SET_CHAR) != 0 )
              return 1;
           end;
        end;
        
        if( DL_SetComIsPaid(Data.rec.ID, Дк) != 0 )
           MsgBox("Ошибка при установке признака оплаты комиссии");
           return 1;
        end;
     end;
/*<<BPV*/
  end;

  Дк = DL_GetMinComPlanDateByOper(FD.Kind, FD.ID, Дк);

  if(not FD.IsDealMet())
  if( Дк != date(0,0,0) )
     //if( GetOprStatus(DV_OPERSTATUS_KIND_KVIT_PAYM_COM) != DV_OPERSTATUS_PAYM_EX )
        if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_COMISS, DV_FX_OPERSTATUS_PAYM_EX) )
           MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
           return 1;
        end;
            DL_CalendDefineOprDate(FD,DV_FXDEAL_OPRDATE_COMISS, Дк);
     //end;
  else
     if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_COMISS, DV_FX_OPERSTATUS_PAYM_NOTEX) )
        MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
        return 1;
     end;
  end;
  else
      if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_COMISS, DV_FX_OPERSTATUS_PAYM_NOTEX) )
         MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
         return 1;
      end;
  end;

  var accTrnArr = TArray();
  DL_CheckHasPlanAccTrn(accTrnArr);
  var logger:c_logger = LoggerFactory().NewItLog("DVFX016").GetLogger();
  logger.Debug("id = " + FD.ID + "; cnt = " + accTrnArr.size());

  return 0;
end;
