/*
$Name:        dvcuritog030.mac
$Module:      ФИССИКО
$Description: Операция "Обработка итогов биржевых валютных торгов", Шаг Прекращение признания встречных сделок
*/

import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )
  var Query:string = "", Data:variant;
  var Count = 0, FD, FD2, DealRec, sql;
  var ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step); 
  record Comm(dl_comm);
  SetBuff(Comm, FirstDoc);

  Query = " SELECT DEAL.t_ID " +
          "   FROM ddvdllnk_dbt LNK, ddvndeal_dbt DEAL " +
          "  WHERE " + 
          "    LNK.T_DVOPERID  = " + Comm.DocumentID +
          "    AND ( (LNK.t_DealID = DEAL.t_ID) OR (LNK.t_SaleDealID = DEAL.t_ID) ) "+
          "    GROUP BY DEAL.t_ID";
 
  Data = TRsbDataSet(Query);

  if( Data )
     Count = 0;
     InitProgress( SQL_GetNRecs(Query), "Прекращение встречных обязательств", "Выполнение..." );
  
     while( Data.MoveNext() )

        FD = DVFirstDocNDeal(DL_DVNDEAL, SQL_ConvTypeInteger(Data.ID));
        if (FD.Deal.rec.DvKind == DV_DVKIND_CURSWAP)
           FD2 = DVFirstDocNDeal(DL_DVNDEAL, SQL_ConvTypeInteger(Data.ID), 2);
        end;
        sql = RSDCommand(
        " SELECT step.* " +
         "   FROM doprstep_dbt step, doproper_dbt oper " +
             "    WHERE oper.t_DocKind           = ? " +
             "    AND ltrim(oper.t_DocumentID)   = ?  " +
             "    AND step.t_ID_Operation        = oper.t_ID_Operation " +
             "    AND step.t_IsExecute           = 'R' " +
             " ORDER BY step.T_PLAN_DATE ASC "); 

        sql.addParam( "", RSDBP_IN, DL_DVNDEAL );
        sql.addParam( "", RSDBP_IN, Data.ID );
        sql.execute();
        DealRec = TRsbDataSet( sql );

        if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
           RemProgress();
           return 1;
        end;

        if (FD.Deal.rec.DvKind == DV_DVKIND_CURSWAP)
           if( СписаниеТребованияИОбязательства( FD2, doc, ДатаИсполненияШага ) != 0 )
              RemProgress();
              return 1;
           end;
        end;

        if (FD.Deal.rec.DvKind == DV_DVKIND_CURSWAP)
           if( СписаниеССПриПрекращенииПризнания( FD2, doc, ДатаИсполненияШага ) != 0 )
              RemProgress();
              return 1;
           end;
        else
           if( СписаниеССПриПрекращенииПризнания( FD, doc, ДатаИсполненияШага ) != 0 )
              RemProgress();
              return 1;
           end;
        end;

        if( ПИ_ПлатежиЗакрытьБезДвижения( FD ) != 0 )
           RemProgress();
           return 1;
        end;

        if (FD.Deal.rec.DvKind == DV_DVKIND_CURSWAP)
           if( ПИ_ПлатежиЗакрытьБезДвижения( FD2 ) != 0 )
              RemProgress();
              return 1;
           end;
        end;

        if( DealRec.MoveNext() )
           if( DV_ChangeDVNDEAL(FD.Deal, FD.Deal, FD.nFI_BaseActiv, FD.nFI_BaseActiv, NULL, NULL, ALG_DV_CHANGEKIND_OFFSET, ДатаИсполненияШага) != 0 )
              RemProgress();
              MsgBox("Ошибка при изменении условий сделки");
              return 1;
           end;
        end;

        if( DV_CloseNDeal(FD.Deal.rec.ID) != 0 )
           RemProgress();
           MsgBox("Ошибка при закрытии сделки");
           return 1;
        end;
        UseProgress( Count = Count + 1 );
 
     end;
     RemProgress();
  end;
  return 0;
end;
