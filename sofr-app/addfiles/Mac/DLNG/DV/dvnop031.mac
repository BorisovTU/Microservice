/*
$Name:        dvnop031.mac
$Module:      ФИСС и КО
$Description: Внебиржевая операция. Шаг: Отражение отношений хеджирования по ОХ 
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac", "dvserv.mac", "dv_grfun.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  /*record ndeal(dvndeal);
  var FD;

  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal(DocKind, ndeal);

  var FrVal = TRecHandler("dvnfrval");

  var ДатаИсполненияШага = {curdate};//DV_GetPlanDateStep(ID_Operation, ID_Step);

  var Query = RSDCommand( " SELECT * " +
                           "   FROM ddlhdgrelation_dbt " +
                           "  WHERE t_InstrID   = ? " +
                           "    AND t_InstrDocKind = ? " +
                           "    AND t_BeginDate <= ? " +
                           "    AND ( t_EndDate = TO_DATE('01.01.0001', 'DD.MM.YYYY') OR t_EndDate >= ? ) ");
   
   Query.addParam( "", RSDBP_IN, FD.deal.rec.ID );
   Query.addParam( "", RSDBP_IN, FD.deal.rec.DocKind );
   Query.addParam( "", RSDBP_IN, ДатаИсполненияШага );
   Query.addParam( "", RSDBP_IN, ДатаИсполненияШага );
   Query.execute();
   
   var DataSet = TRsbDataSet(Query);
   if( not DataSet.MoveNext() )
     MsgBox("По сделке ПФИ отсутствуют действующие на " + string(ДатаИсполненияШага) + " отношения хеджирования!");
     return 1;   
   end;

  if( not FD.ВыполненаПереоценкаСС( ДатаИсполненияШага, FrVal ) )
     MsgBox("По сделке ПФИ за дату" + string(ДатаИсполненияШага) + " не найдена запись изменения справедливой стоимости");
     return 1;
  elif( (FrVal.rec.FairValue != 0) )
     if( not ПроводкиКорректировкиХеджирования( FD, doc, FrVal.rec.FairValue, ДатаИсполненияШага, DataSet.ObjType, DataSet.ObjID, false, 0 ) )
        return 1;
     end;
  end;

  if( not InsertOprStatus( DV_OPERSTATUS_KIND_IS_HEDGE, DV_OPERSTATUS_IS_HEDGE_DENY) )
     MsgBox("Ошибка при установке статуса <Отношения хеджирования> для операции.");
     return 1;
  end;*/ 
  return 0;
end;
