/*
$Name:        dv_car.mac
$Module:      ФИСС и КО
$Description: Общие процедуры для проводок
*/
IMPORT "dvserv.mac", "mc_lib.mac", "dlcarry.inc", "dv_ground.mac", "dvrepfun2.mac", "dl_car.mac", "dv_categ.mac", "dvservop.mac", "dv_voop.mac", "dv_carsf.mac", "nutxfun.mac","vaacc.mac","vscateg.mac", "sp_categ.mac", "mmlibr.mac";
IMPORT funk, dv_lib,fx_globals,"dv_loadpfibuf_new.mac";
IMPORT CurrInter;
IMPORT "role_model.mac";//ролевая модель
IMPORT "dlcontrfunc.mac"; //bpv для открытия счета ДС клиента, ц/б
import "dlutils.mac";

// Виды изминений
  CONST DV_PMGR_CHANGE_OVERVALUE         = 1; // Переоценка
  CONST DV_PMGR_CHANGE_TRANSFER          = 2; // Перенос по срокам
  CONST DV_PMGR_CHANGE_PUTONBALANCE      = 3; // Постановка на внебаланс
  CONST DV_PMGR_CHANGE_WITHDRWLBLNCE     = 4; // Снятие с внебаланса
/*USR 300809 */
  {OurBank} = 1; // для всех подзователей один OurBank, данная правка нужна для корректной работы funcobj (в какой-то момент OurBank не определен)

// Обработка ПП
CONST DV_PMGR_NOTCALC = -1; // Платежи без общего неттинга (шаги 180, 190)
CONST DV_PMGR_NETTING = -2; // Неттинг ПП (шаг 200)

CONST DV_Требование = 0;
CONST DV_Обязательство = 1;

PRIVATE VAR isPlanMode = false;
PRIVATE VAR PlanInAccData = TArray();
PRIVATE VAR CheckCatArr = TArray();

PRIVATE CONST IsHedge_Yes = 1;

PRIVATE MACRO ДАТА_ВКЛЮЧЕНИЯ_793_П():date
   var ErrCode, RegPath = "РСХБ\\ДАТА ВКЛЮЧЕНИЯ 793-П";
   var Val = "";

   GetRegistryValue( RegPath, V_STRING, Val, ErrCode );

   if( ErrCode != 0 )
      MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"");
	  return date(31,12,9999);
   end;

   return date(Val);
END;

VAR MaxPriority;
VAR MethodID;
/* сохранение информации о проводке в фале при параллельном формировании проводок (funcObj) */
MACRO saveAddTransaction(t:variant, ID_Operation:integer, ID_Step:integer, OperKind:integer ): integer  
  var ErrCode;
  /*
  if(MaxPriority == null)
    GetRegistryValue( "CB\\PAYMENTS\\MaxPriority", V_INTEGER, MaxPriority, ErrCode );
    if( ErrCode != 0 )
      MaxPriority = 5;
    end;
  end;
  if(MethodID == null)
    GetRegistryValue( "COMMON\\MULTYCARRY\\DEFAULT_METHOD", V_INTEGER, MethodID, ErrCode );
    if( ErrCode != 0 )
      MethodID = 0;
    end;
  end; */

  var cmd = RSDCommand( "INSERT INTO dacctrn_add_dbt (T_ACCTRNID, T_OPERID, T_STEP " +
    " , T_CHAPTER, T_DATE_CARRY, T_NUMBER_PACK, T_NUMB_DOCUMENT, T_RESULT_CARRY" +    //1 по пять полей в строке
    " , T_KIND_OPER, T_GROUND, T_DEPARTMENT, T_FIIDEQ_PAYER, T_FIIDEQ_RECEIVER" +     //2 
    " , T_ACCOUNT_PAYER, T_ACCOUNT_RECEIVER, T_SHIFR_OPER, T_OPER, T_USERFIELD1" +   //3
    " , T_USERFIELD2, T_SUM_PAYER, T_SUM_RECEIVER, T_SIDETRANSACTION, T_EXRATEEXTRA" + //4
    " , T_DATE_RATE, T_RATE, T_ISINVERSE, T_TYPEDOCUMENT, T_SUM_NATCUR"+                           //5
  	//" , T_FIID_PAYER, T_FIID_RECEIVER, T_SUMEQ_PAYER, T_SUMEQ_RECEIVER, T_PRIORITY, T_EXRATEACCTRNID, T_SKIPRECALCSUMNATCUR, T_SCALE, T_POINT, T_METHODID" +     //10    
    " ) VALUES (nvl((select max(t_acctrnid)+1 from dacctrn_add_dbt),0)," +ID_Operation+", "+ID_Step+  
    " , ?, ?, ?, ?, ?" +  //1
    " , ?, ?, ?, ?, ?" +  //2
    " , ?, ?, ?, ?, ?" +  //3
    " , ?, ?, ?, ?, ?" +  //4
    " , ?, ?, ?, ?, ?" +   //5
    //" , -1, -1, 0.0, 0.0, ?, 0, chr(0), 1, 4, ? "+    //10 - значения из cbaclf\acctrn.c 
    //остальное по умолчанию = 0
    " )" );
  cmd.addParam( "", RSDBP_IN, t.Chapter );      //строка 1
  cmd.addParam( "", RSDBP_IN, t.Date_Carry );
  cmd.addParam( "", RSDBP_IN, IIF((t.Number_Pack != null), t.Number_Pack, 0) );
  cmd.addParam( "", RSDBP_IN, t.Numb_Document );
  cmd.addParam( "", RSDBP_IN, t.ResultCarry );

  cmd.addParam( "", RSDBP_IN, t.Kind_Oper );  //строка 2
  cmd.addParam( "", RSDBP_IN, t.Ground );
  cmd.addParam( "", RSDBP_IN, t.Department );
  cmd.addParam( "", RSDBP_IN, t.FIIDPayer );
  cmd.addParam( "", RSDBP_IN, t.FIIDReceiver );

  cmd.addParam( "", RSDBP_IN, t.AccountPayer );  //строка 3
  cmd.addParam( "", RSDBP_IN, t.AccountReceiver );
  cmd.addParam( "", RSDBP_IN, t.Shifr_Oper );
  cmd.addParam( "", RSDBP_IN, t.Oper );
  cmd.addParam( "", RSDBP_IN, IIF(((t.userfield1 == null) OR (t.userfield1 == "")), StrFor(1), t.userfield1));  

  cmd.addParam( "", RSDBP_IN, IIF(((OperKind == null) OR (OperKind == 0)), StrFor(1), string(OperKind)));  //строка 4
  cmd.addParam( "", RSDBP_IN, t.SumPayer );
  cmd.addParam( "", RSDBP_IN, t.SumReceiver );
  cmd.addParam( "", RSDBP_IN, IIF((t.SideTransaction != null ), t.SideTransaction, 0));
  cmd.addParam( "", RSDBP_IN, IIF((t.ExRateExtra != null), t.ExRateExtra, 0.0));

  cmd.addParam( "", RSDBP_IN, IIF((t.Date_Rate != null), t.Date_Rate, date(0,0,0)) );   //строка 5
  cmd.addParam( "", RSDBP_IN, IIF((t.Rate != null ), t.Rate, 0.0));   
  cmd.addParam( "", RSDBP_IN, IIF(t.IsInverse, StrFor(88), StrFor(1)));
  cmd.addParam( "", RSDBP_IN, IIF(((t.TypeDocument == null) OR (t.TypeDocument == "")), StrFor(1), t.TypeDocument ));
  cmd.addParam( "", RSDBP_IN, t.SumEquivalentCarry );   //Sum_NatCur
  /*  
  cmd.addParam( "", RSDBP_IN, MaxPriority );   
  cmd.addParam( "", RSDBP_IN, MethodID );   */
  
   return cmd.execute();
 END;

/*Проверить, что сделка Покупка/продажа безналичная или слитики (*2730 или 2731) и дата шага больше или равна, дате из настройки*/
/*В таком случае возьмем новую КУ +/-Маржа, ДМ*/
MACRO CheckDealAndDateFor793P(FD, ДатаИсполненияШага):bool

	if(    ((FD.kind == DL_DVFXDEAL) and ((FD.deal.rec.DVKind == DV_FORWARD_FX) OR (FD.deal.rec.DVKind == 9/*DV_FORWARD_MET_FX*/)))
	      AND (FD.ВидБазовогоАктива() == FIKIND_METAL)
	      AND (ДАТА_ВКЛЮЧЕНИЯ_793_П() <= ДатаИсполненияШага)
      )
		return true; 
	end;
	return false;
END;

PRIVATE MACRO SfIsOurFilial( ReceiverID )   
  var rs;  
  rs = RSDCommand( "SELECT T_PARTYID FROM DDP_DEP_DBT WHERE T_PARTYID = ?");
  rs.addParam( "", RSDBP_IN, ReceiverID );
  rs.execute();
  var DataSet = TRsbDataSet(rs);
  if( DataSet.movenext )    
    return true;                                  
  end;

  return false;
end;



Private macro ПолучитьСуммуПереоценкипоОХ(ID, SSDate, sum:@money)
   var Query = RSDCommand( " select * from ddlhedgeturn_dbt where t_hedgeid = ? and t_date = ? " );
   
   Query.addParam( "", RSDBP_IN, ID );
   Query.addParam( "", RSDBP_IN, SSDate );
   Query.execute();
   
   var DataSet = TRsbDataSet(Query);
   if( DataSet.MoveNext() )
      sum = DataSet.dfv;
      return 1;
   else
      return 0;
   end;

  
End;



//teg 13.01.19
/*PNV чтобы определить счет в проводке по схеме расчетов с банками*/
MACRO ПолучитьКоррсчетИзКоррсхемы(FIID, corrid):string
  var RetAcc:string = "";
  var rs, cmd, str;

  str = " SELECT t_account                   " +
        "   FROM DCORSCHEM_DBT     " +
        "  WHERE t_fiid = ?        " ;

  if (corrid != null)
      str = str + " and t_number = " + corrid;
  end;

  str = str +  "  order by t_number asc ";

  cmd = RsdCommand(str);
  cmd.addParam("fiid",   RSDBP_IN, FIID);

  rs = RsdRecordset(cmd);
  if (rs and rs.MoveNext())
    return string(rs.value("t_account"));
  end;

  return RetAcc;
END;
/*PNV*/
private MACRO write_log(messLog)
    var cmd;
        cmd = RsdCommand( "begin rshb_brkrep.InsertLog(?); end;" );
        cmd.addParam( "mes", RSDBP_IN, messLog );
        cmd.execute();
end;

PRIVATE MACRO ПолучитьИмяСубъекта( PartyID )
   var _rParty = TRecHandler( "party.dbt" );
   var party_name = "";
   if( PartyID >= 0 )
      if( not ПолучитьСубъекта( PartyID, _rParty ) )
         party_name = _rParty.rec.Name;
      end;
   end;
   return party_name;
END;

MACRO ВстроенныйПФИ(FD)
   var ObjectID = UniID(FD.Deal, OBJTYPE_OUTOPER_DV);
   var Query = RSDCommand( " Select t_AttrID " +
                           "   From dobjlink_dbt " +
                           "  Where t_ObjectType = ? " +
                           "    and t_ObjectID   = ? " +
                           "    and t_AttrType   = ? " +
                           "    and t_GroupID    = ? " );
   
   Query.addParam( "", RSDBP_IN, OBJTYPE_OUTOPER_DV );
   Query.addParam( "", RSDBP_IN, ObjectID );
   Query.addParam( "", RSDBP_IN, OBJTYPE_AVOIRISS );
   Query.addParam( "", RSDBP_IN, 2 );  //ценная бумага
   Query.execute();
   
   var DataSet = TRsbDataSet(Query);
   if( DataSet.MoveNext() )
     return 1;
   end;
   return 0;
END;

macro РАБОТА_С_РЕПОЗИТАРИЕМ()
    const RegPath = "COMMON\\WORK_MODE\\IR_WORK_WITH_DERIVATIVES";
    var workWithRepository = "", err;
    GetRegistryValue( RegPath, V_BOOL, workWithRepository, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( workWithRepository == "X" )
            return true;
        else
            return false;
        end;
    end;
end;

macro RegVal_СписаниеФинРезЧерезСС(): bool
    const RegPath = "SECUR\\СПИСАНИЕ ФИН.РЕЗ-ТА ЧЕРЕЗ СС";
    var thruFrVal = "", err;
    GetRegistryValue( RegPath, V_BOOL, thruFrVal, err );
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( thruFrVal == "X" )
            return true;
        else
            return false;
        end;
    end;
end;

// Учет разновалютных банкнотных сделок на внебалансе
macro RegVal_УчетРазноВалютныхБанкнотныхСделок(): bool
  const regPath = "ПРОИЗВОДНЫЕ ИНСТРУМЕНТЫ\\УЧЕТ_РАЗНОВАЛЮТ_БАНКНОТ_СДЕЛОК";
  var sVal = false;//:string  = ""; 
  var stat:integer = 0;
  var b:bool = false;
  GetRegistryValue(regPath, V_BOOL, sVal, stat);
  if ( stat != 0 )
    MsgBox( "Ошибка при получении значения настройки \"" + regPath + "\"" );
  else
    if ( (sVal != V_UNDEF) and sVal )
      b = true;
    end;
  end;
  return b;
end;

macro СуществуетЛиРегистрПереоценки(FD)
  var query = " select 1 from ddvoverreg_dbt "
            + " where T_DOCKIND = ? "
            + " AND T_DOCID = ? ";
  var cmd = DL_RSDCommand(query);
  cmd.addParam(FD.Deal.rec.DocKind);
  cmd.addParam(FD.Deal.rec.Id);
  var dataSet = cmd.execute();
  return dataSet.moveNext();
end;

/**
 @brief Функция получения значений из регистра переоценки на дату
 @param[in]  DocKind Вид документа операции, для которой ведём поиск
 @param[in]  DocId ID операции 
 @param[in]  OnDate Дата получения значений
 @param[out] BAEQ Эквивалент БА
 @param[out] CAEQ Эквивалент КА
 @param[out] P Сумма накопленной переоценки
 @return     Флаг успешности поиска (0 - информация найдена, 1 - информация не найдена)
*/
private macro ПолучитьЗначенияРегистраНаДату(DocKind, DocId, OnDate, BAEQ:@numeric, CAEQ:@numeric, P:@numeric)
  var query = "select t_amount_eq, t_price_eq, t_accum_sum from ddvoverreg_dbt "
            + " where T_DOCKIND = ? "
            + "   AND T_DOCID = ? "
            + "   AND T_DATE <= ?"
            + " ORDER BY T_DATE DESC, T_ID_STEP DESC "
            + " FETCH FIRST 1 ROWS ONLY ";
  var cmd = DL_RSDCommand(query);
  cmd.addParam(DocKind);
  cmd.addParam(DocId);
  cmd.addParam(OnDate);

  var dataSet = cmd.execute();

  if(not dataSet.moveNext())
    return 1;
  end;

  BAEQ = dataSet.amount_eq;
  CAEQ = dataSet.price_eq;
  P = dataSet.accum_sum;

  return 0;
end;

private macro УдалитьПроводкиИзПрошлойПереоценкиТекущегоДня(FD, OnDate)
  var stat = 0;
  var operId,operStepId;
  var query = " select * from ddvoverreg_dbt "
            + " where T_DOCKIND = ? "
            + " AND T_DOCID = ? "
            + " AND T_DATE = ?"
            + " ORDER BY T_DATE DESC, T_ID_STEP DESC";
  var cmd = DL_RSDCommand(query);
  cmd.addParam(FD.Deal.rec.DocKind);
  cmd.addParam(FD.Deal.rec.Id);
  cmd.addParam(OnDate);

  var dataSet = cmd.execute();
  if (dataSet.moveNext())
    operId = dataSet.id_operation;
    operStepId = dataSet.id_step;
    query = 
       "SELECT acctrn.t_acctrnid "
      +"  FROM doprdocs_dbt t, dacctrn_dbt acctrn, dacctrn_state_dbt acctrn_state "
      +" WHERE     (t.t_id_operation = ? AND t.t_id_step = ?) "
      +"       AND (    t.t_DocKind = 1 "
      +"            AND t.t_AccTrnID = acctrn.t_AccTrnID "
      +"            AND (   (acctrn.t_State = 1 OR acctrn.t_State = 2) "
      +"                 OR acctrn.t_State = 3) "
      +"            AND acctrn.t_State = acctrn_state.t_State(+)) ";
    cmd = DL_RSDCommand(query);
    cmd.addParam(operId);
    cmd.addParam(operStepId);
    dataSet = cmd.execute();
    while ((stat == 0) and dataSet.moveNext())
      stat = IIF(Opr_DeleteCarry(dataSet.acctrnid),0,1);
    end;
  end;
  return stat;
end;


PRIVATE MACRO SetPlanMode(_isPlanMode:bool, _CheckCatArr)
  isPlanMode  = _isPlanMode;

  CheckCatArr.size = 0;
  if(ValType(_CheckCatArr) != V_UNDEF)
    CheckCatArr = TArray(_CheckCatArr); 
  end;

  PlanInAccData.size = 0;
END;

CLASS CDVPlanInAccData(_inacc)
  var inacc = TRecHandler("dlinacc.dbt");

  copy(inacc, _inacc);
END;

/*Нужно для информации об ошибках при выполнении проводок в сервисных операциях*/
PRIVATE VAR CarryError = "";
MACRO DV_GetCarryError()
   return CarryError;
END;

PRIVATE MACRO SayCarryError( error )
   if( isOprMultiExec() == false )
      msgbox( error );
   else
      CarryError = error;
   end;

   return false;
END;

MACRO ПолучитьВнешнийСчётХеджирования(DVDealID, DVDealDocKind, vDate, ObjType, ObjID, Sum, ExtAccount:TRecHandler)
  var AccBufPlus = TRecHandler("account");
   var AccBufMinus = TRecHandler("account");

   if ((ObjType == DL_DV_HEDGEOBJTYPE_CB_ACQUIRED) or (ObjType == DL_DV_HEDGEOBJTYPE_CB_EMISSED)) // ц/б приобретённые и выпущенные
      if( ПолучитьСчетаХеджированияБОЦБ_БООЭБ(DVDealDocKind, DVDealID, vDate, AccBufPlus, AccBufMinus) )
         return false;
      else
         Copy(ExtAccount, IIF(Sum > 0, /*AccBufMinus, AccBufPlus*/ AccBufPlus, AccBufMinus));
      end;
   elif ((ObjType == DL_DV_HEDGEOBJTYPE_MBK_PLACEMENT) or (ObjType == DL_DV_HEDGEOBJTYPE_MBK_RAISING)) // сделки МБК привлечение и размещение
      var cmdMBC = RSDCommand("SELECT t_ID as HgID FROM ddlhdgrelation_dbt where T_INSTRID = ? AND T_OBJID = ?;");
      cmdMBC.addParam( "", RSDBP_IN, DVDealID);
      cmdMBC.addParam( "", RSDBP_IN, ObjID);
      cmdMBC.execute();
      var MBCData = TRsbDataSet(cmdMBC);
      if( MBCData.MoveNext() and MBCData.HgID)
         if( MM_GetHedgCorAcc(MBCData.HgID, vDate, AccBufPlus, AccBufMinus) )
            if(ObjType == DL_DV_HEDGEOBJTYPE_MBK_PLACEMENT)
               Copy(ExtAccount, IIF(Sum > 0, /*AccBufMinus, AccBufPlus*/AccBufPlus, AccBufMinus));
            else
               Copy(ExtAccount, IIF(Sum > 0, /*AccBufPlus, AccBufMinus*/AccBufMinus, AccBufPlus));
            end;
         else
            return SayCarryError("Ошибка при получении внешнего счёта МБК");
         end;
      else
         return SayCarryError("Не заданы отношения хеджирования на следке МБК");
      end;
   elif (ObjType == DL_DV_HEDGEOBJTYPE_BN_ACCOUNTED) // учтённые векселя
      if( ПолучитьСчетаХеджированияУВ(DVDealDocKind, DVDealID, vDate, AccBufPlus, AccBufMinus) )
         return false;
      else
         Copy(ExtAccount, IIF(Sum > 0, /*AccBufMinus, AccBufPlus*/ AccBufPlus, AccBufMinus));
      end;
   elif (ObjType == DL_DV_HEDGEOBJTYPE_BN_EMISSED) // выпущенные векселя
      if( ПолучитьСчетаХеджированияСВ(DVDealDocKind, DVDealID, vDate, AccBufPlus, AccBufMinus) )
         return false;
      else
         Copy(ExtAccount, IIF(Sum > 0, /*AccBufMinus, AccBufPlus*/ AccBufPlus, AccBufMinus));
      end;
   end;
   return true;
END;

private macro РасчетнаяОперацияВУ( accTrn :variant /*: RsbAccTransaction*/, FD, ВидРО ) : bool
  var DlInAcc = TBfile("dlinacc.dbt");
  record  InnAcc(DlInAcc);
  var DealSum = $0, spground, dealcode = ""; 
  var stat = true;
  
  InnAcc.Boffice      = OBJTYPE_BACKOFFICE_DV;
  InnAcc.OperType     = ВидРО;
  InnAcc.DocumentID   = FD.ID;
  
  InnAcc.AccTrnID   = accTrn.AccTrnID;
  InnAcc.Date       = accTrn.Date_Carry; 
  InnAcc.Chapter    = accTrn.Chapter;
  InnAcc.DebAcc     = accTrn.AccountPayer;
  InnAcc.KredAcc    = accTrn.AccountReceiver;
  
  if (accTrn.Chapter == 22)
   InnAcc.FIKind    = FIKIND_DERIVATIVE;
  else
   InnAcc.FIKind    = FIKIND_CURRENCY;
  end;
   
  InnAcc.FIID       = accTrn.FIIDPayer;
  InnAcc.Sum        = accTrn.SumPayer;
  InnAcc.Department = accTrn.Department;
  InnAcc.Oper       = accTrn.Oper;
  InnAcc.DocumentKind = FD.Kind;

  if( FD.Kind == DL_DVOPER )
     if( FD.DVOper.rec.PartyKind == PTK_MARKETPLASE )
        InnAcc.GroundKind = 320;
     elif( FD.DVOper.rec.PartyKind == PTK_BROKER )
        InnAcc.GroundKind = 321;
     end;
     spground = GetDVGroundRecByDeal( InnAcc.DocumentID, InnAcc.GroundKind, null, InnAcc.DocumentKind);
     InnAcc.GroundNum = spground.XLD;

     InnAcc.DealKind = FD.DealKindInner;/*вид сделки\операции*/
     dealcode        = FD.DealCodeInner;/*номер сделки\операции*/
  elif( FD.Kind == DL_SETTLEMENTFCURM )
     if( FD.IsMarket() == PTK_MARKETPLASE )
        InnAcc.GroundKind = 320;
     elif( FD.IsBroker() == PTK_BROKER )
        InnAcc.GroundKind = 321;
     end;
     spground = GetDVGroundRecByDeal( InnAcc.DocumentID, InnAcc.GroundKind, null, InnAcc.DocumentKind);
     InnAcc.GroundNum = spground.XLD;
                                  
     InnAcc.DealKind = FD.Kind;/*вид операции*/
     dealcode        = FD.comm.rec.CommCode;/*номер операции*/
  elif( (FD.Kind == DL_DVNDEAL) OR (FD.Kind == DL_DVDEALT3) OR (FD.Kind == DL_DVFXDEAL) )
     /*за дату проводки InnAcc.Date ищем документ вида "Распорядительная записка"*/
     InnAcc.GroundKind = 27;
     spground = TRecHandler("spground.dbt");

     if( GetDV_MaxGroundByDeal( spground, InnAcc.DocumentID, InnAcc.DocumentKind, InnAcc.GroundKind, InnAcc.Date ) )
        InnAcc.GroundNum = spground.rec.XLD;
     end;

     InnAcc.DealKind = FD.Kind;
     dealcode        = FD.DealCode();/*номер внебиржевой операции*/
  elif( FD.Kind == DL_DVDEAL )
     InnAcc.DealKind = FD.Kind;
     dealcode        = FD.DealCode();/*номер внебиржевой операции*/
  end;

  if(isPlanMode == true)
    if((InnAcc.DebAcc != "") or (InnAcc.KredAcc != ""))
      // В "индивидульном счете ВУ" для драг.металлов происходит конвертация accTrn.SumPayer в рубли, т.к. счет для дебета
      // не формируется (алгоритм считает, что валюты разные, хотя в реальной проводке они одинаковые)
      // в ручную записываю нужную сумму для отчета
      // Проблема с заполнением валюты такая же, как и с суммой
      InnAcc.FIID       = IIF((InnAcc.DebAcc == ""), accTrn.FIIDReceiver, accTrn.FIIDPayer) ;
      InnAcc.Sum = IIF((InnAcc.DebAcc == ""), accTrn.SumReceiver, accTrn.SumPayer);
      PlanInAccData[PlanInAccData.size] = CDVPlanInAccData(InnAcc);
    end;
  else
    stat = DL_InsertDLINACC(InnAcc,dealcode);
  end;

  return stat;
end;

var accDvdealTrnArr = TArray();
var accTrnBatch = RsbBatchAccTrn;
MACRO readFromAcctrnAdd(ID_Operation:integer, ID_Step:integer)  
  var cmd = DL_RSDCommand( "SELECT * FROM dacctrn_add_dbt WHERE T_OPERID="+ID_Operation+" AND T_STEP="+ID_Step+" ORDER BY T_ACCTRNID ASC" );
  var sData = cmd.Execute();
  var tr;
  var i, OperKind:integer;
    
  while( sData.moveNext() )
    tr = RsbAccTransactionData();
    tr.Chapter         = SQL_ConvTypeInteger(sData.Chapter);
    tr.Date_Carry      = SQL_ConvTypeDate(sData.Date_Carry);
    tr.Number_Pack     = SQL_ConvTypeInteger(sData.Number_Pack);
    tr.Numb_Document   = SQL_ConvTypeStr(sData.Numb_Document);
    tr.ResultCarry     = SQL_ConvTypeInteger(sData.Result_Carry);
    tr.Kind_Oper       = SQL_ConvTypeStr(sData.Kind_Oper);
    tr.Ground          = SQL_ConvTypeStr(sData.Ground);
    tr.Department      = SQL_ConvTypeInteger(sData.Department);
    tr.Oper            = SQL_ConvTypeInteger(sData.oper);
    tr.FIIDPayer       = SQL_ConvTypeInteger(sData.FIID_Payer);
    tr.FIIDReceiver    = SQL_ConvTypeInteger(sData.FIID_Receiver);
    tr.AccountPayer    = SQL_ConvTypeStr(sData.Account_Payer);
    tr.AccountReceiver = SQL_ConvTypeStr(sData.Account_Receiver);
    tr.Shifr_Oper      = SQL_ConvTypeStr(sData.Shifr_Oper);
    tr.userfield1      = SQL_ConvTypeStr(sData.userfield1);
    OperKind           = SQL_ConvTypeInteger(sData.userfield2); 
    tr.SumPayer        = SQL_ConvTypeSum(sData.Sum_Payer);
    tr.SumReceiver     = SQL_ConvTypeSum(sData.Sum_Receiver);
    tr.SideTransaction = SQL_ConvTypeInteger(sData.SideTransaction);
    tr.ExRateExtra     = SQL_ConvTypeSum(sData.ExRateExtra);
    tr.Date_Rate       = SQL_ConvTypeDate(sData.Date_Rate);
    tr.Rate            = SQL_ConvTypeSum(sData.Rate);
    tr.IsInverse       = SQL_ConvTypeBool( IIF((sData.IsInverse == "X"), true, false) );
    tr.TypeDocument    = SQL_ConvTypeStr(sData.TypeDocument);
    tr.SumEquivalentCarry = SQL_ConvTypeSum(sData.Sum_NatCur);

    accTrnBatch.AddAccTransaction(tr, null, ID_Operation, ID_Step);

    i = accDvdealTrnArr.size;
    accDvdealTrnArr[i] = TRecHandler("dvdealtrn.dbt");
    accDvdealTrnArr[i].Clear();
    if(OperKind == DL_DVDEAL)
      accDvdealTrnArr[i].rec.ID_Operation = ID_Operation;
      accDvdealTrnArr[i].rec.ID_Step      = ID_Step;
      accDvdealTrnArr[i].rec.DealID       = Int(tr.userfield1);
      accDvdealTrnArr[i].rec.AccTrnID     = tr.AccTrnID;
    end;
  end;
  SQL_Execute("DELETE FROM dacctrn_add_dbt WHERE T_OPERID="+ID_Operation+" AND T_STEP="+ID_Step );
END;

MACRO МассоваяОбработкаПроводок(ID_Operation:integer, ID_Step:integer)  
  readFromAcctrnAdd(ID_Operation, ID_Step);
  var isTrn = accTrnBatch.Execute(ACCTRN_EXEC_MODE_ONE_PACK);
  var dvdealTrnCache = RsbSQLInsert("dvdealtrn.dbt");
  var dvdealTrn = TRecHandler("dvdealtrn.dbt"); 
  private var arrErrMessage = TArray();
  private var arrErrCode = TArray();
  var isGeneralError = false;
  var accTrnInfo; 
  var i = 0;

  arrErrCode.size = 0;
  arrErrMessage.size = 0;

  var cntResult = accTrnBatch.GetResult(arrErrCode, arrErrMessage);
  while( i < cntResult )
    accTrnInfo = accTrnBatch.GetAccTransaction(i);
    if( (arrErrCode[i] != 0) and (arrErrCode[i] != 421) )
      MsgBox(String("Ошибка при исполнении проводки \n","Дт:", accTrnInfo.AccountPayer, " - Кт:", accTrnInfo.AccountReceiver, "\n", arrErrMessage[i]));
      accDvdealTrnArr.size = 0;  
      return false;
    elif(arrErrCode[i] == 421)
      isGeneralError = true;
    elif(accDvdealTrnArr[i].rec.AccTrnID != 0) //Для сохранения порядка проводок сохраняли пустые элементы  
      dvdealTrn.Clear();
      dvdealTrn.rec.ID_Operation = accDvdealTrnArr[i].rec.ID_Operation;
      dvdealTrn.rec.ID_Step      = accDvdealTrnArr[i].rec.ID_Step;
      dvdealTrn.rec.DealID       = accDvdealTrnArr[i].rec.DealID;
      dvdealTrn.rec.AccTrnID     = accTrnInfo.AccTrnID; //При пакетном выполнении проводок ID перезаписывается

      dvdealTrnCache.AddRecord(dvdealTrn);
    end;
    i = i + 1;
  end;

  if(isGeneralError)
    MsgBox("При выполнении пакета проводок произошли ошибки");
    accDvdealTrnArr.size = 0;
    return false;
  end;

  if(accDvdealTrnArr.size > 0)
    if(not dvdealTrnCache.insert())
      MsgBox("Ошибка при вставке связей проводок со сделками срочного рынка");
      accDvdealTrnArr.size = 0;
      return false;
    end;
  end;
  
  accDvdealTrnArr.size = 0;
  return isTrn or (cntResult == 0);
END;

/**
 @brief Функция для вставки информации о связях проводок со сделками срочного рынка
 @param[in] ID_Operation ID операции, на котором сформированы проводки
 @param[in] ID_Step ID шага, на котором сформированы проводки
 @return    Флаг исполнения функции (true - исполнена без ошибок, false - с ошибками)
*/
MACRO InsertDvdealTrnLink(ID_Operation:integer, ID_Step:integer)
  var i = 0;
  var ins;

  if(accDvdealTrnArr.size == 0)
    return true;
  end;

  RSDCommand("TRUNCATE TABLE ddvdealtrn_tmp").execute();

  while (i < accDvdealTrnArr.size)
    ins = RSDCommand("INSERT INTO ddvdealtrn_tmp (t_ID_Operation, t_ID_Step, t_DealID, t_AccTrnID) VALUES (?,?,?,?)");
    ins.addParam("", RSDBP_IN, ID_Operation);
    ins.addParam("", RSDBP_IN, ID_Step);
    ins.addParam("", RSDBP_IN, accDvdealTrnArr[i].rec.DealID);
    ins.addParam("", RSDBP_IN, accDvdealTrnArr[i].rec.AccTrnID);

    ins.execute();

    i = i + 1;
  end;

  if( not DV_MassInsertDvdealTrnLink(ID_Operation, ID_Step) )
    accDvdealTrnArr.size = 0;
    return false;
  end;

  accDvdealTrnArr.size = 0;
  return true;
END; 

/* Проводка по категориям учета (в том числе и мультивалютная)
   СчетДебет,СчетКредит - если тип V_STRING то категории, иначе record ACCOUNT*/
MACRO ПроводкаПоКатегориямУчета( FD, СчетДебет, СчетКредит, ДатаВалютирования,
                                 Chapter ,FIID, СуммаОперации, docum,
                                 Result_Carry, Kind_Oper,Numb_Document,Ground,
                                 PaymentID, FIRolePayer, FIRoleReceiver,
                                 СчетДебетFIID, СчетКредитFIID, FIID2, СуммаОперации2,
                                 PaymID_type, FD2, IsInnerCarry, ВидРО,
                                 SideTransaction, ExRateExtra, DebPairAcc, CredPairAcc,
                                 IsSumEqDebet, NatSum:@money, Date_Rate:date, Rate:double, IsInverse:bool,
                                 IsSummaryCarry:bool, /*Признак сводной проводки*/
                                 DebAccNumber:@string, CredAccNumber:@string, SkipRateCarry:bool, TxtLinesRHDP:string
                               )
 var stat:bool = true, CуммаДебет = $0, СуммаКредит  = $0, 
      СчетОВПДебет = "", СчетОВПКредит = "", СчетДоходов = "", СчетРасходов = "";
 var tr, NoCarry:bool = false;
 var PaymentObj = null;
 var ID_Operation = 0, ID_Step = 0;
 var _FD;
 var MassTransMode = false;
 var Query, cmd, DataSet;

 record AccountPayer(account);
 record AccountReceiver(account);

 CarryError = "";

 if( IsSummaryCarry == null )
    IsSummaryCarry = false;
 end;

 if( (СуммаОперации == null) AND (СуммаОперации2 == null) )  
    return SayCarryError( "В проводке не задана ни одна из сумм." );
 end;

 if ( isOprMultiExec() ) // Обычное пакетное выполнение шага
   Query = " SELECT oprtemp.t_ID_Operation, oprtemp.t_ID_Step, oprtemp.t_Dockind, koper.t_Systypes " +
           "   FROM doprtemp_view oprtemp, doproper_dbt oper, doprkoper_dbt koper " +
           "  WHERE oprtemp.t_Dockind = " + DL_DVOPER +
           "    AND oprtemp.t_ID_Operation =  oper.T_ID_Operation " +
           "    AND oper.T_Kind_Operation = koper.T_Kind_Operation " +
           "    AND koper.t_Systypes = CHR(1) "; 
   cmd = DL_RSDCommand(Query); 
   DataSet = cmd.Execute();
   if( DataSet.moveNext() )
     if( (DataSet.DocKind == DL_DVOPER) and (DataSet.Systypes == "") )
       MassTransMode = true;
       ID_Operation  = DataSet.ID_Operation;
       ID_Step       = DataSet.ID_Step;        
     end;
   end;
 end;

 var dvoperLock = UniConcurrentLocker("dvoperfuncobjlock", 0);
 if ( (MassTransMode == false) and ((FD.Kind == DL_DVDEAL) or (FD.Kind == DL_DVOPER)) and (dvoperLock.CheckLockExists()))
   Query = " SELECT ddata.T_OPERID AS ID_Operation, cast(ddata.T_CREDITSUM AS NUMBER(5)) AS ID_Step, "+DL_DVOPER+" AS Dockind, CHR(0) AS Systypes " +
           "   FROM ddatasum_dbt ddata " +
           "  WHERE T_CURRENCY = -1 " +
           "    AND T_MARKETSCHEMEID = 0 " +
           "    AND T_DEBETSUM = 0 " +
           "    AND T_CREDITSUM != 0 ";
   cmd = DL_RSDCommand(Query); 
   DataSet = cmd.Execute();
   if( DataSet.moveNext() )
     if( (DataSet.DocKind == DL_DVOPER) and (DataSet.Systypes == "") )
       MassTransMode = true;
       ID_Operation  = DataSet.ID_Operation;
       ID_Step       = DataSet.ID_Step;        
     end;
   end;
 end;
  
 /*оставить только копейки*/
 /*для первой суммы, если она задана*/
 if( СуммаОперации != null )
    СуммаОперации = money( round( СуммаОперации, 2 ) );    
    if( СуммаОперации < $0 )  
       return SayCarryError( "Сумма проводки < 0." );
    end;
 else  
   СуммаОперации = $0;
 end;
 /*для второй суммы, если она задана*/
 if( СуммаОперации2 != null )
    СуммаОперации2 = money( round( СуммаОперации2, 2 ) );
    if( СуммаОперации2 < $0 )  
       return SayCarryError( "Вторая сумма проводки < 0." );
    end;
 else
   СуммаОперации2 = $0;
 end;

 if( (СуммаОперации == $0) AND (СуммаОперации2 == $0) )  
    return true;
 end;

 if( ValType(СчетДебет) == V_STRING ) /*задан через категорию*/
    if( /*(not FD.IsExistAccount(СчетДебет, null, true, FIRolePayer, AccountPayer, DebPairAcc, ДатаВалютирования, СчетДебетFIID)) and */
        (not FD.OpenAccount(СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, null/*PayerMcAccDoc*/, DebPairAcc))
      )
       if( not FD.ReOpenAccount(СчетДебет, null, false, FIRolePayer, AccountPayer, ДатаВалютирования, СчетДебетFIID, null, DebPairAcc) )
           return SayCarryError( "Ошибка при определении счета по категории " + СчетДебет + " в проводке.");
       end;
    end;
 else
    copy( AccountPayer, СчетДебет );
 end;

 if( ValType(СчетКредит) == V_STRING ) /*задан через категорию*/
    if( FD2 == null )    
      _FD = FD;
    else
      _FD = FD2;
    end;
    if( /*(not _FD.IsExistAccount(СчетКредит, null, true, FIRoleReceiver, AccountReceiver, CredPairAcc, ДатаВалютирования, СчетКредитFIID)) and */
        (not _FD.OpenAccount(СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, null/*ReceiverMcAccDoc*/, CredPairAcc))
      )
       if( not _FD.ReOpenAccount(СчетКредит, null, false, FIRoleReceiver, AccountReceiver, ДатаВалютирования, СчетКредитFIID, null, CredPairAcc) )
           return SayCarryError( "Ошибка при определении счета по категории " + СчетКредит + " в проводке." );
       end;
    end;
 else
    copy( AccountReceiver, СчетКредит );
 end;
 
 if( PaymID_type == null )
    PaymID_type = PMMET_ID;
 end;

 if( AccountPayer.Code_Currency == AccountReceiver.Code_Currency )

    /*задана только вторая сумма в валюте одного из счетов*/
    if( (FIID == null) AND (FIID2 != null) )
       FIID = FIID2;
    elif( (FIID == null) AND (FIID2 == null) )
       return SayCarryError("Не задана ни одна из валют проводки.");
    end;

    if( СуммаОперации != $0 )
       CуммаДебет = СуммаКредит = СуммаОперации;
    elif( СуммаОперации2 != $0 )
       CуммаДебет = СуммаКредит = СуммаОперации2;
    end;

    if( (FIID != AccountPayer.Code_Currency) /*AND (FIID != AccountReceiver.Code_Currency)*/ )
       /* return SayCarryError( "В проводке не совпадают валюты счетов: " 
                                + string(AccountPayer.Code_Currency) + " " + string( AccountReceiver.Code_Currency ) +
                                "| и валюта документа: " + string(FIID) );
       раньше здесь выдавали ошибку, теперь попробуем сконвертировать */
       if( not DV_SmartConvertSum(CуммаДебет, CуммаДебет, ДатаВалютирования, FIID, AccountPayer.Code_Currency, false) )
          return SayCarryError( GetCurrencyConvertErrorMsg(FIID, AccountPayer.Code_Currency, ДатаВалютирования) );
       end;
       СуммаКредит = CуммаДебет;
    end;

 else /* валюты разные - мультивалютная проводка */
     
    СуммаКредит = $0;
    CуммаДебет  = $0;
    
    /*задана одна сумма в валюте одного из счетов*/
    if( (FIID != null) AND (FIID2 == null) )
       if( FIID == AccountPayer.Code_Currency )
          CуммаДебет  = СуммаОперации;
       else
          СуммаКредит = СуммаОперации;
       end;
    /*задана только вторая сумма в валюте одного из счетов*/
    elif( (FIID2 != null) AND (FIID == null) )
       if( FIID2 == AccountPayer.Code_Currency )
          CуммаДебет  = СуммаОперации2;
       else
          СуммаКредит = СуммаОперации2;
       end;
    /*заданы обе суммы в валютах счетов по которым выполняем проводку*/
    elif( (FIID2 != null) AND (FIID != null) )                         
      if( FIID == AccountPayer.Code_Currency ) 
         CуммаДебет  = СуммаОперации;
      elif( FIID2 == AccountPayer.Code_Currency ) 
         CуммаДебет  = СуммаОперации2;
      end;

      if( FIID == AccountReceiver.Code_Currency ) 
         СуммаКредит = СуммаОперации;
      elif( FIID2 == AccountReceiver.Code_Currency ) 
         СуммаКредит = СуммаОперации2;
      end;
    else
       return SayCarryError("Не задана ни одна из валют проводки.");
    end;

    if( (Rate == null) or (Rate == 0.0) )
       if( not CheckMultyCarrySum( AccountPayer.Code_Currency, AccountReceiver.Code_Currency,
                                   CуммаДебет, СуммаКредит, ДатаВалютирования ) )
          return SayCarryError("Ошибка при определении сумм мультивалютной проводки.");
       end;

       if ( (CуммаДебет > 10000000000000000) or (СуммаКредит > 10000000000000000) )
          return SayCarryError("Арифметическая операция: переполнение.");
       end;
    end;
 end;

 if( (IsSummaryCarry == false) AND 
     DV_НужнаСводнаяПроводка(FD, /*AccountPayer*/СчетДебет, /*AccountReceiver*/СчетКредит, Chapter/*, PayerMcAccDoc, ReceiverMcAccDoc*/)
   )
    stat = DV_ДобавитьСводнуюПроводку(FD, AccountPayer, AccountReceiver, ДатаВалютирования, CуммаДебет, СуммаКредит/*IIF(AccountPayer.Code_Currency == AccountReceiver.Code_Currency, $0, СуммаКредит)*/, Result_Carry, Ground);
    if( not stat )
       return SayCarryError("Ошибка при вставке документа сводной проводки.");
    else
       NoCarry = true; /*сформировали сводную проводку - ниже выполнять проводку не надо*/

       if ((FD.kind == 4813) or  (FD.kind == 4815) or (FD.kind == 199)) //teg 15.01.19 нельзя выкидывать 199 биржевые иначе не ставятся
	       NoCarry = false;
       end;	
    end;
 end;
 if( NoCarry == false )
    if( (PaymID_type != PMMET_ID_TMP_OP) AND ((PaymentID != NULL) AND (PaymentID > 0)) )
       /*проводку формируем по платежу*/
       PaymentObj = RSBPayment( PaymentID );
       tr = PaymentObj.MakeTransaction();
    else
       /*проводку формируем без платежа*/
       if (MassTransMode == true)
          tr = RsbAccTransactionData();
       else
          tr = RsbAccTransaction();
       end;

       tr.Shifr_Oper = ""; // стираем, потом заполним правильно
    end;
            
    if( tr == NULL )
       return SayCarryError("Ошибка при создании проводки по платежу");
    end;
   
    tr.Chapter         = Chapter;
    tr.Date_Carry      = ДатаВалютирования;
    if( PaymentObj != null )
       tr.Number_Pack  = PaymentObj.NumberPack;
    end;
    tr.Numb_Document   = Numb_Document;
    tr.ResultCarry     = Result_Carry;
    tr.Kind_Oper       = Kind_Oper;
    tr.Ground          = Ground;
    tr.Department      = {OperDprt};
    //tr.Oper            = {oper};
    tr.FIIDPayer       = AccountPayer.Code_Currency;
    tr.FIIDReceiver    = AccountReceiver.Code_Currency;
    tr.AccountPayer    = AccountPayer.Account;
    tr.AccountReceiver = AccountReceiver.Account;
    if( tr.Shifr_Oper == "" )
       tr.Shifr_Oper = DL_GetShifrOper(Chapter, AccountPayer, AccountReceiver);
    end;
   //TEG 02.05.19 ролевая модель   
   /* Определяем конечного операциониста для проводки */
     if ((FD.kind==140) or (FD.kind==152) or (FD.kind==4626) or (FD.kind==4627) or (FD.kind==4607) or (FD.kind == 4633) or (FD.kind == 4632) )
         Tr.Oper = GetMainOperInGroup(FD.kind);
     elif  (FD.kind==194) 
         Tr.Oper = GetMainOperInGroup(FD.kind,FD.DVOPER.rec.operkind);
     elif(FD.kind==199)
       	   if(FD.ВидБазовогоАктива() == FIKIND_AVOIRISS)
              Tr.Oper = GetMainOperInGroup(101);
       	   else
              Tr.Oper = GetMainOperInGroup(FD.kind,FD.deal.rec.kind);
           end;
     else  
           Tr.Oper = GetMainOperInGroup(FD.kind,FD.deal.rec.kind);
     end;

     /*KD Определение операциониста по проволкам корректировки по ОХ */
     If( (FD.kind==199) and (FD.deal.rec.kind == 22720) )
        If((AccountPayer.balance == "47452") OR (AccountPayer.balance == "47447") OR (AccountPayer.balance == "47450") OR (AccountPayer.balance == "47445") OR  
        (AccountReceiver.balance == "47452") OR (AccountReceiver.balance == "47447") OR (AccountReceiver.balance == "47450") OR (AccountReceiver.balance == "47445")) 
           Tr.Oper = GetMainOperInGroup(102,12300);
        end;
        If( (AccountPayer.balance == "47451")  OR (AccountPayer.balance == "47446") OR (AccountReceiver.balance == "47451")  OR (AccountReceiver.balance == "47446")) 
           Tr.Oper = GetMainOperInGroup(109);
        end;

        If( (AccountPayer.balance == "51526")  OR (AccountPayer.balance == "51527") OR (AccountReceiver.balance == "51526")  OR (AccountReceiver.balance == "51527")) 
           Tr.Oper = GetMainOperInGroup(141);
        end;

        If( (AccountPayer.balance == "50428")  OR (AccountPayer.balance == "50429") OR (AccountReceiver.balance == "50428")  OR (AccountReceiver.balance == "50429")) 
           Tr.Oper = GetMainOperInGroup(141);
        end;

     end;

     if (Tr.Oper <= 0)
         Tr.Oper = {Oper};
     end;
   /**/
    var NumberPackFromReg = 0, err_reg = 0;
    //начнём процесс пачкования . Критерий Биржа/ВнебиржеваяСделкаСПФИ . Для Биржи -30 , внебиржа - 40 . Остальное - 35.
    if (StrUpr(genclassname(FD)) == StrUpr("DVFirstDocNDeal"))
      if (FD.Биржевая())
       tr.Number_Pack  = 35;
      else
       tr.Number_Pack  = 30;
      end;
      if(FD.ВидБазовогоАктива() == FIKIND_AVOIRISS)
                tr.Number_Pack  = 10;
      end;  
      if ((FD.ВалютныйРынок()) and (FD.IsClient())) /*bpv*/
         tr.Number_Pack  = 90; 
      end;
      if(FD.РынокСПФИ())
        GetRegistryValue("РСХБ\\ПАЧКА ДЛЯ СПФИ", V_INTEGER, NumberPackFromReg, err_reg);
        if ((not err_reg) and (NumberPackFromReg >= 0))
          tr.Number_Pack  = NumberPackFromReg;
        end;
	    end;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFirstDocFXDeal") )
      if (FD.Биржевая())
       tr.Number_Pack  = 35;
      else
      	if (FD.deal.rec.kind == 12735) //банкнотные сделки 
          tr.Number_Pack  = 70;
        else
        tr.Number_Pack  = 30;
        end;
      end;

      if ((FD.ВалютныйРынок()) and (FD.IsClient())) /*bpv*/
         tr.Number_Pack  = 90;
      end;
	  
      if(FD.РынокСПФИ())
        GetRegistryValue("РСХБ\\ПАЧКА ДЛЯ СПФИ", V_INTEGER, NumberPackFromReg, err_reg);
        if ((not err_reg) and (NumberPackFromReg >= 0))
          tr.Number_Pack  = NumberPackFromReg;
        end;
      end;

    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFirstDocPmGr") ) //графики только для внебирж. процентных свопов
    	tr.Number_Pack  = 30;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTDOCOPER") ) //первичка расчетов с биржей
    	if (fd.DVOper.rec.operkind== 12602)
          tr.Number_Pack  = 35;
    	else
          tr.Number_Pack  = 40;//пока иначе пачка по умолчанию
    	end;    
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTCSA") ) // Операции по CSA
          tr.Number_Pack  = 80;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTDOCDLCOMM") ) // Новая операция расчетов с биржей
       if (FD.IsClient())
    	tr.Number_Pack  = 90;
       else
    	tr.Number_Pack  = 40;
       end;	
    else
    	tr.Number_Pack  = 40;
    end;
    //TEG для сделок по срочному рынку запишем идентификатор сделки в поле userfild1
    if ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTDOCDEAL") ) //первичка расчетов с биржей
       if (FD.kind==192)
          tr.userfield1= FD.DEAL.rec.ID;
       end;
    end;

    if( IsSumEqDebet != null )
       if( IsSumEqDebet == true )
          tr.SumPayer    = $0;
          tr.SumReceiver = СуммаОперации;
       else
          tr.SumPayer    = СуммаОперации;
          tr.SumReceiver = $0;
       end;
    else
       tr.SumPayer      = CуммаДебет;
       tr.SumReceiver   = СуммаКредит;
    end;
        
    if( SideTransaction != null )
       tr.SideTransaction = SideTransaction;
    end;
   
    if( ExRateExtra != null )
       tr.ExRateExtra = ExRateExtra;
    end;
   
    if( (Date_Rate != null) and (Date_Rate != date(0,0,0)) )
       tr.Date_Rate = Date_Rate;
    end;
   
    if( (Rate != null) and (Rate != 0.0) )
       tr.Rate = Rate;
       if( IsInverse != null )
          tr.IsInverse = IsInverse;
       end;
    end;

    if ((fd.Kind == DL_DVFXDEAL) and IsDVFXBNOTE(DV_GetOperationGroup(fd.Deal.rec.Kind)) and (FD.ВалютаБазовогоАктива() != FD.ВалютаКонтрактива()))
      tr.TypeDocument = "Q";
    end;
   
    if( (SkipRateCarry!=null) and (SkipRateCarry==true) and (AccountPayer.Code_Currency != AccountReceiver.Code_Currency) )
       var SumEq_Payer = tr.SumPayer, SumEq_Receiver = tr.SumReceiver;

      if (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL")

        if (FD.ВалютаТребования() == NATCUR)
          tr.SumEquivalentCarry = SumEq_Payer;
        elif (FD.ВалютаОбязательства() == NATCUR)
          tr.SumEquivalentCarry = SumEq_Receiver;
        else
           //TEG 08.01.19 пробуем для свопа покрытие зафиксировать
           if( not DV_SmartConvertSum(SumEq_Payer, tr.SumPayer, ДатаВалютирования, AccountPayer.Code_Currency, NATCUR, false) )
               return SayCarryError( GetCurrencyConvertErrorMsg(AccountPayer.Code_Currency, NATCUR, ДатаВалютирования) );
           end;
           if( not DV_SmartConvertSum(SumEq_Receiver, tr.SumReceiver, ДатаВалютирования, AccountReceiver.Code_Currency, NATCUR, false) )
               return SayCarryError( GetCurrencyConvertErrorMsg(AccountReceiver.Code_Currency, NATCUR, ДатаВалютирования) );
           end;
           if ((FD.deal.rec.kind==2715) or (FD.deal.rec.kind==12715))
	              if ( (FD.ВалютаТребования() != NATCUR) and (FD.ВалютаОбязательства() != NATCUR) )
                      if (FD.IsBuy())
                          tr.SumEquivalentCarry = SumEq_Receiver;//SumEq_Payer;/*PNV*/
                      else
                         tr.SumEquivalentCarry = SumEq_Payer;// SumEq_Receiver;/*PNV*/
                      end;  
                else	
                      if (FD.IsBuy())
                          tr.SumEquivalentCarry = SumEq_Payer;
                      else
                          tr.SumEquivalentCarry = SumEq_Receiver;
                      end;  
                end;					  		
                //mda 16.02.2019 Данный алгоритм применим и для сделок ПФИ поэтому , тут будет ветка для ПФИ
           elif (FD.deal.rec.kind == 12695) //внебирж опцион
                if (FD.IsBuyOption())
                    tr.SumEquivalentCarry = SumEq_Receiver;
                else
                    tr.SumEquivalentCarry = SumEq_Payer;
                end;
           elif (FD.deal.rec.kind == 22720) //IRS/CIRS процентный своп
                tr.SumEquivalentCarry = SumEq_Receiver;
           elif ( ((FD.deal.rec.kind == 12690) and (FD.ВидБазовогоАктива(true) == FIKIND_CURRENCY)) or (FD.deal.rec.kind == 22710) or (FD.deal.rec.kind == 12745) )//внебиржевой форвард и валютный своп, Покупка\продажа Т+3
                if (FD.IsBuy())
                    tr.SumEquivalentCarry = SumEq_Receiver;
                else
                    tr.SumEquivalentCarry = SumEq_Payer;
                end;
           else
                tr.SumEquivalentCarry = min(SumEq_Payer,SumEq_Receiver);
           end;
        end;
      else

        /*заполняем tr.SumEquivalentCarry, чтобы не было ядерной проводки по переоценке*/
        if ( FD.kind != 4632)
             if( (FD.ВалютаБазовогоАктива()!=NATCUR) and (FD.ВалютаКонтрактива()==NATCUR) )/*Покупка/продажа иностранной валюты за рубли, покупка/продажа драг. металла за рубли*/
                  if( AccountPayer.Code_Currency==NATCUR )
                      tr.SumEquivalentCarry = SumEq_Payer;
                 else/*AccountReceiver.Code_Currency==NATCUR*/
                      tr.SumEquivalentCarry = SumEq_Receiver;
                 end;
             else
                 if( not DV_SmartConvertSum(SumEq_Payer, tr.SumPayer, ДатаВалютирования, AccountPayer.Code_Currency, NATCUR, false) )
                     return SayCarryError( GetCurrencyConvertErrorMsg(AccountPayer.Code_Currency, NATCUR, ДатаВалютирования) );
                 end;
                 if( not DV_SmartConvertSum(SumEq_Receiver, tr.SumReceiver, ДатаВалютирования, AccountReceiver.Code_Currency, NATCUR, false) )
                     return SayCarryError( GetCurrencyConvertErrorMsg(AccountReceiver.Code_Currency, NATCUR, ДатаВалютирования) );
                 end;
                 if( (FD.ВидАктиваОбязательства()==FIKIND_METAL) and (FD.ВалютаТребования() != NATCUR) )/*Продажа драг. металла за иностранную валюту*/
                      tr.SumEquivalentCarry = SumEq_Payer;
                 else
                      if ( StrUpr(genclassname(FD)) == StrUpr("DVFirstDocFXDeal") )
                           if ((FD.deal.rec.kind == 12730) or (FD.deal.rec.kind == 22730) )
                               tr.SumEquivalentCarry = SumEq_Receiver;
                          /*PNV 509039*/
                           elif (FD.IsBNote())
                               tr.SumEquivalentCarry = SumEq_Receiver;
                         /*PNV 509039*/
                           else
                               tr.SumEquivalentCarry = min(SumEq_Payer,SumEq_Receiver);
                           end;    
                     else
                           tr.SumEquivalentCarry = min(SumEq_Payer,SumEq_Receiver);
                     end; 
                 end;
             end;
        else
             if( not DV_SmartConvertSum(SumEq_Payer, tr.SumPayer, ДатаВалютирования, AccountPayer.Code_Currency, NATCUR, false) )
                 return SayCarryError( GetCurrencyConvertErrorMsg(AccountPayer.Code_Currency, NATCUR, ДатаВалютирования) );
             end;
             if( not DV_SmartConvertSum(SumEq_Receiver, tr.SumReceiver, ДатаВалютирования, AccountReceiver.Code_Currency, NATCUR, false) )
                 return SayCarryError( GetCurrencyConvertErrorMsg(AccountReceiver.Code_Currency, NATCUR, ДатаВалютирования) );
             end;
             tr.SumEquivalentCarry = min(SumEq_Payer,SumEq_Receiver); 
        end;
      end;
       /*чтобы не было ядерной проводки урегулирования*/
      tr.TypeDocument = "Ц";/*Исключать из процедуры переоценки*/
    end;

    if((TxtLinesRHDP != NULL) and (TxtLinesRHDP != ""))
      tr.UserField1 = TxtLinesRHDP;
    end;

    if( (isPlanMode == false) and (MassTransMode == false))
      if( not tr.Carry() )
         return SayCarryError("Ошибка при выполнении проводки");
      end;
    elif (MassTransMode == true)
        saveAddTransaction(tr, ID_Operation, ID_Step, FD.Kind);
    end;

    if((FD.Kind == DL_DVDEAL) and (MassTransMode == false)) // Связь транзакции со сделкой Срочного Рынка для последовательного выполнения
      VAR i = accDvdealTrnArr.size;

      accDvdealTrnArr[i] = TRecHandler("dvdealtrn.dbt");

      accDvdealTrnArr[i].Clear();
      if(FD.Kind == DL_DVDEAL)
        accDvdealTrnArr[i].rec.ID_Operation = ID_Operation;
        accDvdealTrnArr[i].rec.ID_Step      = ID_Step;
        accDvdealTrnArr[i].rec.DealID       = FD.Deal.rec.id;
        accDvdealTrnArr[i].rec.AccTrnID     = tr.AccTrnID;
      end;
    end;

    if( IsInnerCarry )
       if( not РасчетнаяОперацияВУ( tr, FD, ВидРО ) )
          return SayCarryError("Ошибка при вставке расчетной операции внутреннего учета");
       end;
    end;
   
    if( NatSum != null )
       if( tr.FIIDPayer == NATCUR )
          NatSum = tr.SumPayer;
       elif( tr.FIIDReceiver == NATCUR )
          NatSum = tr.SumReceiver;
       else
          NatSum = $0.0;
       end;
    end;

    if( DebAccNumber != null )
       DebAccNumber = tr.AccountPayer;
    end;

    if( CredAccNumber != null )
       CredAccNumber = tr.AccountReceiver;
    end;

 end;
 if( not stat ) 
    return SayCarryError("Ошибка при вставке документа проводки.");
 end;

 return stat;
END;

PRIVATE MACRO ActuatePayment( pmobj:RsbPayment )

  if( not DV_SmartConvertSum(pmobj.BaseAmount, pmobj.OrderAmount, pmobj.ValueDate, pmobj.OrderFIID, pmobj.BaseFIID, true) )
     return false;
  end;

  if( not DV_SmartConvertSum(pmobj.PayerAmount, pmobj.BaseAmount, pmobj.ValueDate, pmobj.BaseFIID, pmobj.PayerFIID, true) )
     return false;
  end;

  if( not DV_SmartConvertSum(pmobj.ReceiverAmount, pmobj.BaseAmount, pmobj.ValueDate, pmobj.BaseFIID, pmobj.ReceiverFIID, true) )
     return false;
  end;

  return pmobj.Actuate();
END;

MACRO ПИ_СтутусПлатежИсполнен( PaymStatus )
   return ((PaymStatus >= PM_READY_TO_SEND) OR (PaymStatus == PM_CLOSED_W_M_MOVEMENT));
END;

PRIVATE MACRO ПИ_ПлатежИсполнен( Payment:RsbPayment )
   return ПИ_СтутусПлатежИсполнен(Payment.PaymStatus);
END;

PRIVATE MACRO ПИ_ПроставитьСтатусНаПлатеж( paym, PaymStatus ):bool

  if( (ПИ_СтутусПлатежИсполнен(paym.PaymStatus) == false) and (paym.PaymStatus != PaymStatus) )
     var pmobj = RsbPayment( paym.PaymentID );
     pmobj.PaymStatus = PaymStatus;
     if( PaymStatus == PM_READY_TO_SEND )
        pmobj.IsFactPaym = "X";
     end;
     ActuatePayment( pmobj );
  end;

  return true;
END;

MACRO ПИ_УстановитьСтатусПлатежа( Payment:RsbPayment, PaymStatus:INTEGER )

  if( Payment.PaymStatus != PaymStatus )
     /* IL 02.08.06 обязательно надо устанавливать PaymStatus перед IsFactPaym, иначе
        некорректно установится PMPAYM.PrimDocKind и как следствие такой платеж будет криво
        обрабатываться в арме (SCR 90056 и 92006) */
     Payment.PaymStatus = PaymStatus;
     ActuatePayment( Payment );
     if( PaymStatus == PM_READY_TO_SEND )
        Payment.IsFactPaym = "X";
     end;
  end;   
  return 0;
END;

PRIVATE MACRO IsBNoteByPrm(DocKind, DealID)

  var IsBNone = false;
  if( DocKind == DL_DVFXDEAL )
     var FD = DVFirstDocFXDeal(DL_DVFXDEAL, DealID);
     if( FD != null )
        IsBNone = FD.IsBNote();
     end;
  end;

   return IsBNone;
END;

/*PNV*/
MACRO IsCorschem_LORO (corrid, FIid)

        FILE crs(corschem) key 1;
        crs.Number  = corrid;
        crs.FI_Kind = 1;
        crs.FIid = FIid;
        if( getEQ(crs) )
            if (crs.ISNOSTRO == SET_CHAR)
                return false;
            else
                return true;
            end;
        else
            return false;
        end;
END;
/*PNV*/

PRIVATE MACRO IsCSAByPrm(DocKind)
  if(( DocKind == DV_CSA ) or ( DocKind == DV_CSAPM ))
    return true;
  end;
  return false;
END;

MACRO ПИ_ИсполнитьПлатеж( Payment:RsbPayment ):INTEGER

  if( (Payment != null) AND (ПИ_ПлатежИсполнен(Payment) == false) )
     var НовыйСтатусПлатежа:integer = PM_FINISHED;
     var IsBNote = IsBNoteByPrm(Payment.DocKind, Payment.DocumentID);
     var IsCSA = IsCSAByPrm(Payment.DocKind);

     if( (Payment.ReceiverBankID != {OurBank}) or (Payment.PayerBankID != {OurBank}) ) /*внешний платеж*/
        if( (Payment.ReceiverBankID == {OurBank}) and (Payment.PayerBankID != {OurBank}) ) /*входящий*/
           if( ПИ_ИнтегрРежимРаботы() and IsBNote )
                 НовыйСтатусПлатежа = PM_READY_TO_SEND;
              else
              НовыйСтатусПлатежа = PM_FINISHED;
           end;
        elif( (Payment.ReceiverBankID != {OurBank}) and (Payment.PayerBankID == {OurBank}) ) /*исходящий*/
           if( ПИ_ИнтегрРежимРаботы() /*and (not IsBNote)*/ and (not IsCSA))/*PNV*/
              НовыйСтатусПлатежа = PM_READY_TO_SEND;
           else
              НовыйСтатусПлатежа = PM_FINISHED;
           end;
        end;
     else /*внутренний платеж*/
        if (Payment.OutCorschem != -1) /*PNV есть схема расчетов*/
            if (IsCorschem_LORO (Payment.OutCorschem, Payment.basefiid))
                НовыйСтатусПлатежа = PM_READY_TO_SEND;
            else
                НовыйСтатусПлатежа = PM_FINISHED; 
            end;
        else 
            НовыйСтатусПлатежа = PM_FINISHED;
        end;
     end;

     if( ПИ_УстановитьСтатусПлатежа(Payment, НовыйСтатусПлатежа) )
        MsgBox( "Ошибка при установке платежу статуса \"Исполнен\"" );
        return 1;
     end;
  end;

  return 0;
END;

MACRO ПИ_ПолучитьКорСчет(BankID:integer,FIID:integer,CorrAcc:TRecHandler)
  var CorrAccNum ="";
  var Corschem = ПолучитьКорсхемуПоУмолчанию( BankID, FIID, 1, "К");
  if(Corschem != -1)
     CorrAccNum = GetCorAcc( FIID, Corschem, CORS_ACC_ACCOUNT);
  end;
  if( (CorrAccNum == "") or (not DV_GetAccount( 1, Fiid, CorrAccNum, CorrAcc )) )
     msgbox("Не найден корсчет в валюте FIID = "+string(FIID));
     return false;
  end;

  return true;
END;

MACRO DV_NewSubpurpose( Purpose:INTEGER, DocKind:INTEGER, DocID:INTEGER )

  VAR RS = TRsbDataSet( "SELECT (NVL(MAX(t_SubPurpose), -1)+1) AS NewSubpurpose FROM dpmpaym_dbt " +
                        " WHERE t_DocKind    = " + string(DocKind) + " AND " +
                        "       t_DocumentID = " + string(DocID)   + " AND " +
                        "       t_Purpose    = " + string(Purpose) 
                      );
  if( RS.MoveNext() )
     return RS.NewSubpurpose;
  end;
  return 0;
END;

PRIVATE VAR Party_ForGet = TRecHandler( "party.dbt" );
MACRO DV_GetPartyName( PartyID:INTEGER, LongName:@STRING ) :STRING

  if( ПолучитьСубъекта( PartyID, Party_ForGet ) == 0 )
     if( ValType(LongName) != V_UNDEF )
        LongName = Party_ForGet.rec.Name;
     end;
     return Party_ForGet.rec.ShortName;
  end;
  return "";
end;

/*Сформировать платеж */
PRIVATE VAR Payment  = TRecHandler( "pmpaym.dbt" );
PRIVATE VAR PaymPropDT = TRecHandler( "pmprop.dbt" );
PRIVATE VAR PaymPropCT = TRecHandler( "pmprop.dbt" );
PRIVATE VAR RmProp     = TRecHandler( "pmrmprop.dbt" );

MACRO DVND_CreatePayment( FD/*DVFirstDocNDeal or DVFirstDocFXDeal or DVFirstDocOper or DVFirstDocDLCOMM*/,
                          Purpose:INTEGER, DocKind:INTEGER, DocID:INTEGER,
                          ValueDate:DATE,
                          PayerID:INTEGER, PayerBankID:INTEGER,
                          ReceiverID:INTEGER, ReceiverBankID:INTEGER,
                          Summa:MONEY, FIID:INTEGER,
                          Ground:STRING,
                          PayerAccount:TRecHandler, ReceiverAccount:TRecHandler,
                          Department:INTEGER, SubPurpose:INTEGER,
                          PaymStatus:INTEGER,
                          RetPayment:@RsbPayment, TmpPaymentID:INTEGER,
                          DebProp:@TRecHandler, CredProp:@TRecHandler
                        ) :INTEGER

  var ErrStr = "", PayerName:string = "", ReceiverName:string = "", PayerBankName:string = "", ReceiverBankName:string = "";
  var PMObj, AccountPayerFIID, AccountReceiverFIID;
  var FI = TRecHandler("fininstr.dbt");
  var IsAvoirPaym = false;

  if( ПолучитьФинИн(FIID, FI) == 0 )
     if( FI.rec.FI_Kind == FIKIND_AVOIRISS )
        IsAvoirPaym = true;
     end;
  end;

  /* Если на одном шаге создается несколько обьектов то нужно обязательно передавать TmpPaymentID с отрицательным значением
     изза того что криво работает класс платежа
  */
  if( TmpPaymentID == NULL )
     TmpPaymentID = 0;
  end;

  PMObj = RsbPayment( TmpPaymentID );

  if( PMObj )
     /*Дублировать заполнение полей через Payment (TRecHandler) приходится из за отсутствия
       FillPaymentAccounts в классе платежа*/
     Payment.Clear();

     if( SubPurpose == NULL )
        SubPurpose = DV_NewSubpurpose( Purpose, DocKind, DocID );
     end;

     Payment.rec.Purpose    = PMObj.Purpose      = Purpose;  
     Payment.rec.SubPurpose = PMObj.SubPurpose   = SubPurpose;
     Payment.rec.PaymStatus = PMObj.PaymStatus   = IIF( PaymStatus == NULL, /*PM_PREPARING*/PM_READIED, PaymStatus );
     Payment.rec.DocKind    = PMObj.DocKind      = DocKind;
     Payment.rec.DocumentID = PMObj.DocumentID   = DocID;

     Payment.rec.Payer     = PayerID;
     Payment.rec.Receiver  = ReceiverID;
     Payment.rec.PayFIID   = FIID;
     Payment.rec.FIID      = FIID;
     Payment.rec.BaseFIID  = PMObj.BaseFIID      = FIID;

     Payment.rec.ValueDate  = PMObj.ValueDate    = ValueDate;
     Payment.rec.Department = PMObj.Department   = Department;
     Payment.rec.IsPlanPaym = PMObj.IsPlanPaym   = "X";

     Payment.rec.BaseAmount  = PMObj.BaseAmount  = Summa;
     Payment.rec.OrderAmount = PMObj.OrderAmount = Summa;
                               PMObj.Ground      = Ground;

     Payment.rec.OrderFIID   = PMObj.OrderFIID = FIID;// Валюта суммы распоряжения

     if( (Payment.rec.Payer == FD.ClientID()) OR (Payment.rec.Payer == {OurBank}) )
        Payment.rec.IsFixAmount = PMObj.IsFixPayerAmount = "X";   /*признак - фикс.сумма - дебет*/
     else
        Payment.rec.IsFixAmount = PMObj.IsFixPayerAmount = UNSET_CHAR;   /*признак - фикс.сумма - кредит*/
     end;

     Payment.rec.PayerCodeKind    = PTCK_CONTR;
     Payment.rec.ReceiverCodeKind = PTCK_CONTR;

     PaymPropDT.Clear();
     PaymPropCT.Clear();
     PaymPropDT.rec.DebetCredit = PRT_Debet;
     PaymPropCT.rec.DebetCredit = PRT_Credit;
     PaymPropDT.rec.IsSender = SET_CHAR;
     PaymPropCT.rec.IsSender = UNSET_CHAR;

     if( IsAvoirPaym )
        PaymPropDT.rec.CorrPosType = PaymPropCT.rec.CorrPosType = PM_CORRPOS_TYPE_USER;
     end;

     RmProp.Clear();
     RmProp.rec.Date        = Payment.rec.ValueDate;
     RmProp.rec.PayDate     = Payment.rec.ValueDate;
     RmProp.rec.ClientDate  = Payment.rec.ValueDate;

     AccountPayerFIID = AccountReceiverFIID = FIID;

     if( PayerAccount != NULL ) /*Счет переданный параметром считаем более важным, чем счет из СПИ*/
        Payment.rec.PayerAccount = PayerAccount.rec.Account;
        AccountPayerFIID         = PayerAccount.rec.Code_Currency;
     else
        if( DV_FillPaymentBySPI( FD.ClientID(), FD.ClientContrID(), FD.BrokerID(), FD.BrokerContrID(), FD.Kind_Operation(),
                                 PRT_Debet, Payment, PaymPropDT, RmProp ) )
           MsgBox( "Ошибка определения СПИ плательщика при создании платежа.\n" + ErrStr );
           return 1;
        end;
     end;

     if( ReceiverAccount != NULL ) /*Счет переданный параметром считаем более важным, чем счет из СПИ*/
        Payment.rec.ReceiverAccount = ReceiverAccount.rec.Account;
        AccountReceiverFIID         = ReceiverAccount.rec.Code_Currency;
     else
        if( DV_FillPaymentBySPI( FD.ClientID(), FD.ClientContrID(), FD.BrokerID(), FD.BrokerContrID(), FD.Kind_Operation(),
                                 PRT_Credit, Payment, PaymPropCT, RmProp ) )
           MsgBox( "Ошибка определения СПИ получателя при создании платежа.\n" + ErrStr );
           return 1;
        end;
     end;

     Payment.rec.FIID_FuturePayAcc = AccountPayerFIID;
     Payment.rec.FIID_FutureRecAcc = AccountReceiverFIID;

     /*Дозаполнить параметры плательщика, если они не заполнилось из СПИ*/
     if( PaymPropDT.rec.CodeKind <= 0 ) 
        if (FD.ClientID())
           PaymPropDT.rec.CodeKind     = 3/*PTCK_CONTR*/;
           PMObj.PayerBankCorrCodeKind = 3/*PTCK_CONTR*/;
        else
        PaymPropDT.rec.CodeKind     = PTCK_CONTR;
        PMObj.PayerBankCorrCodeKind = PTCK_CONTR;
     end;
     end;

     if( Payment.rec.PayerBankID <= 0 ) 
        Payment.rec.PayerBankID = PayerBankID;
        PaymPropDT.rec.BankCode = ПолучитьКодСубъекта( PayerBankID, PaymPropDT.rec.CodeKind );
     end;

     /*Дозаполнить параметры получателя, если они не заполнилось из СПИ*/
     if( PaymPropCT.rec.CodeKind <= 0 ) 
        if (FD.ClientID())
           PaymPropCT.rec.CodeKind          = 3/*PTCK_CONTR*/;
           PMObj.ReceiverBankCorrCodeKind   = 3/*PTCK_CONTR*/;
        else
           PaymPropDT.rec.CodeKind     = PTCK_CONTR;
           PMObj.PayerBankCorrCodeKind = PTCK_CONTR;
        end;

     end;

     if( Payment.rec.ReceiverBankID <= 0 ) 
        Payment.rec.ReceiverBankID   = ReceiverBankID;
        PaymPropCT.rec.BankCode = ПолучитьКодСубъекта( Payment.rec.ReceiverBankID, PaymPropCT.rec.CodeKind );
     end;

     /*Параметры отправителя/получателя*/
     DV_GetPartyName( Payment.rec.Payer, @PayerName );
     DV_GetPartyName( Payment.rec.PayerBankID, @PayerBankName );

     DV_GetPartyName( Payment.rec.Receiver, @ReceiverName );
     DV_GetPartyName( Payment.rec.ReceiverBankID, @ReceiverBankName );

     /* Сконвертируем суммы сами */
     if( not DV_SmartConvertSum(Payment.rec.Amount, Payment.rec.BaseAmount, Payment.rec.ValueDate, Payment.rec.BaseFIID, AccountPayerFIID, true) )
        return 1;
     end;
     if( not DV_SmartConvertSum(Payment.rec.PayAmount, Payment.rec.BaseAmount, Payment.rec.ValueDate, Payment.rec.BaseFIID, AccountReceiverFIID, true) )
        return 1;
     end;
     pmobj.PayerAmount = Payment.rec.Amount;
     pmobj.ReceiverAmount = Payment.rec.PayAmount;

     PMObj.SetPayerPI( PAYMENTS_GROUP_UNDEF,
                       Payment.rec.PayerBankID,
                       PaymPropDT.rec.CodeKind,
                       PaymPropDT.rec.BankCode,
                       PayerBankName,
                       "",
                       AccountPayerFIID,
                       IIF(IsAvoirPaym, 5, 1),
                       Payment.rec.PayerAccount,
                       PayerID,
                       PayerName,
                       ПолучитьКодСубъекта(Payment.rec.Payer, PTCK_INN),
                       Payment.rec.PayerCodeKind,
                       Payment.rec.PayerCode,
                       NULL,
                       IIF(IsAvoirPaym, PaymPropDT.rec.CorrPosType, NULL) );

     PMObj.SetReceiverPI( PAYMENTS_GROUP_UNDEF,
                          Payment.rec.ReceiverBankID,
                          PaymPropCT.rec.CodeKind,
                          PaymPropCT.rec.BankCode,
                          ReceiverBankName,
                          "",
                          AccountReceiverFIID,
                          IIF(IsAvoirPaym, 5, 1),
                          Payment.rec.ReceiverAccount,
                          ReceiverID,
                          ReceiverName,
                          ПолучитьКодСубъекта(Payment.rec.Receiver, PTCK_INN),
                          Payment.rec.ReceiverCodeKind,
                          Payment.rec.ReceiverCode,
                          NULL,
                          IIF(IsAvoirPaym, PaymPropCT.rec.CorrPosType, NULL) );

     /*Плательщик*/
     PMObj.PayerDpNode           = Payment.rec.PayerDpNode;

     PMObj.PayerBankCorrAcc      = PaymPropDT.rec.CorrAcc;
     PMObj.PayerBankCorrCode     = PaymPropDT.rec.CorrCode;
     PMObj.PayerBankCorrCodeKind = PaymPropDT.rec.CorrCodeKind;

     PMObj.PayerInOurBalance     = PaymPropDT.rec.InOurBalance;
     PMObj.PayerOurCorrAcc       = PaymPropDT.rec.OurCorrAcc;
     PMObj.PayerOurCorrID        = PaymPropDT.rec.OurCorrID;

     /*Получатель*/
     PMObj.ReceiverDpNode           = Payment.rec.ReceiverDpNode;

     PMObj.ReceiverBankCorrAcc      = PaymPropCT.rec.CorrAcc;
     PMObj.ReceiverBankCorrCode     = PaymPropCT.rec.CorrCode;
     PMObj.ReceiverBankCorrCodeKind = PaymPropCT.rec.CorrCodeKind;

     PMObj.ReceiverInOurBalance     = PaymPropCT.rec.InOurBalance;
     PMObj.ReceiverOurCorrAcc       = PaymPropCT.rec.OurCorrAcc;
     PMObj.ReceiverOurCorrID        = PaymPropCT.rec.OurCorrID;

     PMObj.Actuate();

     Payment.rec.PaymentID = PMObj.PaymentID;
     DV_SetPaymentGround(Payment, -1, FD);

     RetPayment = PMObj;

     if( DebProp != NULL )
        copy(DebProp, PaymPropDT);
     end;
     if( CredProp != NULL )
        copy(CredProp, PaymPropCT);
     end;
  else 
     return 1;
  end;

  return 0;
END;

MACRO ПИ_ПолучитьСчетИзПлатежа( Paym, DebProp, CredProp, IsPayer, AccBuff, NoSayError )

   var payer_receiver, FIID, FindAcc = "";

   if( IsPayer )
      payer_receiver = " для плательщика";
   else
      payer_receiver = " для получателя";
   end;

   if( IsPayer )
      FIID = Paym.FIID;
      if( (Paym.PayerBankID != {OurBank}) and (Paym.PayerBankID > -1) )
         FindAcc = GetCorAcc( FIID, DebProp.Corschem, CORS_ACC_ACCOUNT);
      else
         FindAcc = Paym.PayerAccount;     
      end;
   else   
      FIID = Paym.PayFIID;
      if( (Paym.ReceiverBankID != {OurBank}) and (Paym.ReceiverBankID > -1) )
         FindAcc = GetCorAcc( FIID, CredProp.Corschem, CORS_ACC_ACCOUNT);      
      else
         FindAcc = Paym.ReceiverAccount;     
      end;
   end;
   if( FindAcc != "" )
     if( DV_GetAccount( 1, FIID, FindAcc, AccBuff, true ) == false ) 
        if( NoSayError == false ) 
           msgbox( "Не найден счет ", FindAcc, payer_receiver );
        end;
        return ""; 
     end;        
   else
      if( NoSayError == false ) 
         msgbox( "В платеже не задан счет", payer_receiver );
      end;
   end;
   return FindAcc;
END;

PRIVATE MACRO ПроводкаПриОбработкеПлатежа( paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc ):integer

  record PayerAccountBuff( account );
  record ReceiverAccountBuff( account );

  if( (pay_acc == null) OR (pay_acc.rec.Account == "") )
     if( ПИ_ПолучитьСчетИзПлатежа(paym, debet, credit, true, PayerAccountBuff, false) == "" )
        return 1;
     end;
  else
     copy(PayerAccountBuff, pay_acc);
  end;

  if( (rec_acc == null) OR (rec_acc.rec.Account == "") )
     if( ПИ_ПолучитьСчетИзПлатежа(paym, debet, credit, false, ReceiverAccountBuff, false) == "" )
        return 1;
     end; 
  else
     copy(ReceiverAccountBuff, rec_acc);
  end;

  /*делаем проводку на сумму платежа*/ 
  if( not ПроводкаПоКатегориямУчета( FD, 
                                     PayerAccountBuff, ReceiverAccountBuff, /* КатегДеб , КатегКредит*/
                                     dat,                                   /* Дата */
                                     1 ,                                    /* Глава */
                                     paym.FIID,                             /* Валюта */
                                     paym.Amount,                           /* Сумма  */
                                     Doc,                                   /* Документ */
                                     INPCARRY,                              /* Result_Carry */
                                     "",                                    /* Kind_Oper */
                                     "",                                    /* Numb_Document */
                                     VOGround, paym.PaymentID,
                                     null, null,
                                     paym.FIID, paym.FIID,                  /* валюты счетов: Дт - Кт */ 
                                     paym.FIID, paym.Amount                 /* для мультивалютной проводки: валюта2, сумма2 */
                                   )
    )
     return 1;
  end;

  return 0;
END;

MACRO ОбработатьДенежныйПлатеж( paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc )

  /*если есть в основании платежа код валютной операции - занесенем его в онование проводки*/
  var PaymVOGround = DL_VOOP_GetPaymGround(paym);
  if( PaymVOGround != "" )
     VOGround = PaymVOGround +" "+VOGround; 
  end;

  if( (paym.ReceiverBankID != {OurBank}) or (paym.PayerBankID != {OurBank}) ) /*внешний платеж*/
     if( (paym.ReceiverBankID == {OurBank}) and (paym.PayerBankID != {OurBank}) ) /*входящий*/
        var Payment = RsbPayment(paym.PaymentID); 
        if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей()  and ПИ_ПлатежКвитуетсяПоВидуФИ(Payment) )
           /*когда будет квитовка, ничего не делаем, а пока -> */
           if( ПроводкаПриОбработкеПлатежа(paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc) != 0 )
              return 1;
           end;
           if( ПИ_ПроставитьСтатусНаПлатеж(paym, PM_READY_TO_SEND) == false )
              return 1;
           end;
           /* <- конец */
        else
           if( ПроводкаПриОбработкеПлатежа(paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc) != 0 )
              return 1;
           end;

           if( ПИ_ПроставитьСтатусНаПлатеж(paym, PM_FINISHED) == false )
              return 1;
           end;
        end;
     elif( (paym.ReceiverBankID != {OurBank}) and (paym.PayerBankID == {OurBank}) ) /*исходящий*/
        if( ПИ_ИнтегрРежимРаботы() )
           /* по хорошему должно быть под настройкой, но пока без, т.к. не работает проводка на клиринговый счёт */
           /* разобраться когда будем делать квитовку*/
           //if( ФИСС_ДелатьПроводкуПоИсхПлатежам() )
              if( ПроводкаПриОбработкеПлатежа(paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc) != 0 )
                 return 1;
              end;
           //end;

           if( ПИ_ПроставитьСтатусНаПлатеж(paym, PM_READY_TO_SEND) == false )
              return 1;
           end;
        else
           if( ПроводкаПриОбработкеПлатежа(paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc) != 0 )
              return 1;
           end;

           if( ПИ_ПроставитьСтатусНаПлатеж(paym, PM_FINISHED) == false )
              return 1;
           end;
        end;
     end;
  else /*внутренний платеж*/
     if( ПроводкаПриОбработкеПлатежа(paym, debet, credit, FD, dat, Doc, VOGround, pay_acc, rec_acc) != 0 )
        return 1;
     end;

     if( ПИ_ПроставитьСтатусНаПлатеж(paym, PM_FINISHED) == false )
        return 1;
     end;
  end;

  return 0;
end;

MACRO ПИ_ПроводкаПоПлатежу( FD, PaymentObj:RSBPayment, Chapter:INTEGER, Dat:DATE, DebMcAccDoc, CredMcAccDoc, _TaxSum, _TaxFIID ):BOOL

  var ПИ_ДелатьПроводку:bool = true;
  var IsBNote = IsBNoteByPrm(PaymentObj.DocKind, PaymentObj.DocumentID);
  var СчетДебет = TRecHandler("account"), СчетКредит = TRecHandler("account");
  var AccNalog = TRecHandler("account");
  var IsGetAccount = false;
  var TaxSum = $0, TaxFIID = -1, TS = $0;
  var SumEq_Payer = $0, SumEq_Receiver = $0;
  var Acc_str = ""; /*PNV*/
  file AccBuff( "account.dbt" ); /*PNV*/

  ClearRecord(СчетДебет);
  ClearRecord(СчетКредит);

  CarryError = "";

  if(_TaxSum != NULL)
    TaxSum  = _TaxSum;
    TaxFIID = _TaxFIID;
  end;
/*CHVA*/
    var NumberPackFromReg = 0, err_reg = 0;
    if (StrUpr(genclassname(FD)) == StrUpr("DVFirstDocNDeal"))
      if (FD.Биржевая())
       PaymentObj.Numberpack  = 35;
      else
       PaymentObj.Numberpack  = 30;
      end;
      if(FD.ВидБазовогоАктива() == FIKIND_AVOIRISS)
         PaymentObj.Numberpack  = 10;
      end;
      if ((FD.ВалютныйРынок()) and (FD.IsClient())) /*bpv*/
         PaymentObj.NumberPack  = 90;
      end;
	  if(FD.РынокСПФИ())
		GetRegistryValue("РСХБ\\ПАЧКА ДЛЯ СПФИ", V_INTEGER, NumberPackFromReg, err_reg);
		if ((not err_reg) and (NumberPackFromReg >= 0))
		  PaymentObj.NumberPack  = NumberPackFromReg;
		end;
	  end;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFirstDocFXDeal") )
      if (FD.Биржевая())
       PaymentObj.Numberpack  = 35;
      else
        if (FD.deal.rec.kind == 12735) //банкнотные сделки 
          PaymentObj.Numberpack = 70;
        else
          PaymentObj.Numberpack  = 30;
        end;
      end;
      if ((FD.ВалютныйРынок()) and (FD.IsClient())) /*bpv*/
         PaymentObj.NumberPack  = 90;
      end;
	  if(FD.РынокСПФИ())
		GetRegistryValue("РСХБ\\ПАЧКА ДЛЯ СПФИ", V_INTEGER, NumberPackFromReg, err_reg);
		if ((not err_reg) and (NumberPackFromReg >= 0))
		  PaymentObj.NumberPack  = NumberPackFromReg;
		end;
	  end;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFirstDocPmGr") ) //графики только для внебирж. процентных свопов
      PaymentObj.Numberpack  = 30;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTDOCOPER") ) //первичка расчетов с биржей
      if (fd.DVOper.rec.operkind== 12602)
          PaymentObj.Numberpack  = 35;
      else
          PaymentObj.Numberpack  = 40;//пока иначе пачка по умолчанию
      end;    
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTCSA") ) // Платёж по CSA
    	PaymentObj.Numberpack  = 80;
    elif ( StrUpr(genclassname(FD)) == StrUpr("DVFIRSTDOCDLCOMM") ) //Операция расчеты с Биржей
       if (FD.IsClient())
          PaymentObj.Numberpack  = 90;
       else
          PaymentObj.Numberpack  = 40; // иначе по умолчанию
       end;
    else
     PaymentObj.Numberpack  = 40;
    end;
    //TEG 02.05.19 ролевая модель   
   /* Определяем конечного операциониста для проводки */
      if ((PaymentObj.DocKind==140) or (PaymentObj.DocKind==152) or (PaymentObj.DocKind==4626) or (PaymentObj.DocKind==4627) or (PaymentObj.DocKind==4632) or ( /*bpv*/PaymentObj.DocKind == 4813 ))
         PaymentObj.Oper = GetMainOperInGroup(PaymentObj.DocKind);
      elif (PaymentObj.DocKind==194)
         PaymentObj.Oper = GetMainOperInGroup(PaymentObj.DocKind,FD.DVOPER.rec.operkind);
      else  
         PaymentObj.Oper = GetMainOperInGroup(PaymentObj.DocKind,FD.deal.rec.kind);
      end;
      if ( PaymentObj.Oper<= 0)
            PaymentObj.Oper = {Oper};
      end;
   /**/

/*CHVA*/

    //Simanov. Если платёж уже исполнен - не делать проводку. Иначе задваивается проводка после квитовки
    if ( (ПИ_СтутусПлатежИсполнен(PaymentObj.PaymStatus)) and (StrUpr(genclassname(FD)) != StrUpr("DVFIRSTCSA")) )/*PNV*/ 
      ПИ_ДелатьПроводку = false;
    elif( (PaymentObj.ReceiverBankID != {OurBank}) or (PaymentObj.PayerBankID != {OurBank}) ) /*внешний платеж*/
      if( (PaymentObj.ReceiverBankID != {OurBank}) and (PaymentObj.PayerBankID == {OurBank}) ) /*исходящий*/
        if( /*(not IsBNote) and*/ ПИ_ИнтегрРежимРаботы() and (not ФИСС_ДелатьПроводкуПоИсхПлатежам()) )
            ПИ_ДелатьПроводку = false;
        end;
      elif( (PaymentObj.ReceiverBankID != {OurBank}) and (PaymentObj.PayerBankID != {OurBank}) ) /*транзитный?*//*PNV*/ 
           ПИ_ДелатьПроводку = true;
      end;
    end;

  if( ПИ_ДелатьПроводку )
     var tr = PaymentObj.MakeTransaction();

     if( tr == NULL )
        return SayCarryError("Ошибка при формировании документа проводки.");
     end;

     /*Проводки через класс платежа всегда подставляют первую главу*/
     if( Chapter == NULL )
        Chapter = 1;
     end;
     tr.Chapter = Chapter;

     if( Dat != null )
        tr.Date_Carry = Dat;
     else
        tr.Date_Carry = PaymentObj.ValueDate;
     end;
     tr.Oper = PaymentObj.Oper;
     if( tr.Shifr_Oper == "" )
        /*PNV */
        if (tr.AccountReceiver == "")
            tr.AccountReceiver = ПолучитьКоррсчетИзКоррсхемы(tr.FIIDReceiver);
        end;
        if (tr.AccountPayer == "")
            tr.AccountPayer = ПолучитьКоррсчетИзКоррсхемы(tr.FIIDPayer);
        end;

        if (tr.AccountReceiver == tr.AccountPayer)
           if ((PaymentObj.Receiveraccount != "") and (PaymentObj.ReceiverBankID == {OurBank}))
               tr.AccountReceiver = PaymentObj.Receiveraccount;
           end; 
           if ((PaymentObj.Payeraccount != "") and (PaymentObj.PayerBankID == {OurBank}))        
               tr.AccountPayer = PaymentObj.Payeraccount;
           end; 
        end;
        /*PNV*/

        if( not IsGetAccount )
           if( DL_GetAccount(tr.Chapter, tr.FIIDPayer, tr.AccountPayer, СчетДебет) and
               DL_GetAccount(tr.Chapter, tr.FIIDReceiver, tr.AccountReceiver, СчетКредит)
             )
              IsGetAccount = true;
           end;
        end;

        if( IsGetAccount )
           tr.Shifr_Oper = DL_GetShifrOper(tr.Chapter, СчетДебет.rec, СчетКредит.rec);
        end;
     end;

     if( not IsGetAccount )
        if( DL_GetAccount(tr.Chapter, tr.FIIDPayer, tr.AccountPayer, СчетДебет) and
            DL_GetAccount(tr.Chapter, tr.FIIDReceiver, tr.AccountReceiver, СчетКредит)
          )
           IsGetAccount = true;
        end;
     end;

     /*PNV i-support 487208*/
     if ( (FD.Kind == DL_DVFXDEAL) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and (tr.FIIDPayer == FD.ВалютаБазовогоАктива()) )
           Acc_str = ПолучитьКоррсчетИзКоррсхемы(tr.FIIDPayer, IIF(PaymentObj.InCorschem > 0 , PaymentObj.InCorschem, ПолучитьКорсхемуПоУмолчанию(PaymentObj.payerbankid, PaymentObj.basefiid))); 
           if (Acc_str == tr.AccountPayer)  
              if( DV_GetAccount( 1, FD.ВалютаБазовогоАктива(), Acc_str, AccBuff, true ) == true ) 
                  tr.ground = "Зачисление стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + AccBuff.nameaccount + " по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + " по " + IIF(FD.isbuypart(), "покупке ", "продаже ") + "(" + FD.BaseFI().rec.name + "). К/агент: " + GetPartyNames(FD.GetContractorID(),2)[0];
              end; 
           end;
     elif ( (FD.Kind == DL_DVFXDEAL) and (FD.ВидБазовогоАктива() == FIKIND_METAL))
              /*PNV i-support 488546 - если заполнено примечание, значит сделка со слитками*/ 
              /*PNV i-support 500025 - формируем это основание для всех сделок с ДМ, даже если примечание не заполнено*/ 
              var str = readNoteForObject(OBJTYPE_FXOPER_DV, UniID( FD.deal, OBJTYPE_FXOPER_DV), 101);
             /*PNV i-support 506064*/
              var v_DM_FI = TRecHandler( "fininstr.dbt" );
              if( ПолучитьФинИн( FD.ВалютаБазовогоАктива(), v_DM_FI ) != 0 )
                  v_DM_FI.Clear();
              end;
              if (FD.isbuy())  
                  tr.ground = "ПЕРЕВОД СРЕДСТВ ПО СДЕЛКЕ "+ FD.DealCode() + " ОТ " + FD.ДатаСделки() + " НА " + IIF(FD.isbuypart(), "ПОКУПКУ", "ПРОДАЖУ") + " ДМ(" + StrUpr(v_DM_FI.rec.name) + ") К/агент: " + GetPartyNames(FD.GetContractorID(),2)[0];              //end;
              else
                  if (PaymentObj.Purpose == BAi)
                     tr.ground = "Списание обязательств по сделке "+ FD.DealCode() + " от " + FD.ДатаСделки() + " на " + IIF(FD.isbuypart(), "покупку ", "продажу ") + "слитков. К/агент: " + GetPartyNames(FD.GetContractorID(),2)[0];
                  else
                     tr.ground = "Исполнение требований по сделке "+ FD.DealCode() + " от " + FD.ДатаСделки() + " на " + IIF(FD.isbuypart(), "покупку ", "продажу ") + "слитков. К/агент: " + GetPartyNames(FD.GetContractorID(),2)[0];  
                  end;
              end;                     
              /*PNV i-support 488546*/
     end;
     /*PNV*/
     /*PNV 514269*/
     if ( ( (FD.Kind == DL_DVFXDEAL) or (FD.Kind == DL_DVDEALT3)) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and (tr.FIIDPayer == FD.ВалютаБазовогоАктива()) ) /*PNV 522410*/
           if ((Substr(PaymentObj.Payeraccount, 1, 5) == "61213") and (tr.AccountPayer != PaymentObj.Payeraccount))  
               tr.AccountPayer = PaymentObj.Payeraccount;
               tr.FIIDPayer = PaymentObj.Payerfiid;
           end;
     elif ( (( FD.Kind == DL_DVFXDEAL) or (FD.Kind == DL_DVDEALT3)) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and (tr.FIIDReceiver == FD.ВалютаБазовогоАктива()) ) /*PNV 522410*/
           if ((Substr(PaymentObj.Receiveraccount, 1, 5) == "61213") and (tr.AccountReceiver != PaymentObj.Receiveraccount))  
               tr.AccountReceiver = PaymentObj.Receiveraccount;
               tr.FIIDReceiver = PaymentObj.receiverfiid;
           end;
     end;
     /*PNV 514269*/  
 
     /*для случая продажи драг металла за рубли или иностранную валюту*/
     if( ((FD.Kind == DL_DVFXDEAL) or (FD.Kind == DL_DVDEALT3)) and (not FD.IsDealMet()) and (FD.ДатаИсполнения() != FD.ДатаСделки()) and (not FD.IsClient()) and (/*not FD.IsBNote() and*/ (not FD.Isswap()) ) and /*PNV 522410*/
         (FD.ВидАктиваОбязательства() == FIKIND_METAL) and (FD.ВидАктиваТребования() == FIKIND_CURRENCY) and ( FD.ВалютаТребования() != NATCUR ) and
         ((PaymentObj.Purpose == BAi) or (PaymentObj.Purpose == BRi)) 
       )
          tr.SumReceiver = PaymentObj.ReceiverAmount;
          tr.SumPayer = PaymentObj.PayerAmount;
          /*рассчитываем нужные суммы в проводке*/
          if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребования(), tr.Date_Carry, FD.ВалютаТребования(), NATCUR, false) )
              return SayCarryError( GetCurrencyConvertErrorMsg(FD.ВалютаТребования(), NATCUR, tr.Date_Carry) );
          end;
          /*заполняем tr.SumEquivalentCarry, чтобы не было ядерной проводки по переоценке*/

          tr.SumEquivalentCarry = SumEq_Payer;
          if (FD.isSale() and (FD.ВалютаТребования() != NATCUR))
               tr.SumPayer = FD.СуммаТребования();
           tr.SumReceiver = SumEq_Payer;
          else
               tr.SumReceiver = FD.СуммаТребования();
          end;

          /*чтобы не было ядерной проводки урегулирования*/
          tr.TypeDocument = "Ц";/*Исключать из процедуры переоценки*/
     elif( (FD.Kind == DL_DVFXDEAL) /*and (FD.ДатаИсполнения() == FD.ДатаСделки())*/ and (not FD.IsClient()) and (not FD.IsBNote() and (not FD.Isswap()) ) and
          (FD.ВидАктиваТребования() == FIKIND_METAL) and (FD.ВидАктиваОбязательства() == FIKIND_CURRENCY) and  (FD.ВалютаОбязательства() != NATCUR ) and
         ((PaymentObj.Purpose == BAi) or (PaymentObj.Purpose == BRi)) 
       )
          /*рассчитываем нужные суммы в проводке*/
           tr.SumReceiver = FD.СуммаОбязательства();
           if( not DV_SmartConvertSum(SumEq_Payer, tr.SumPayer, tr.Date_Carry, tr.FIIDPayer, NATCUR, false) )
               return SayCarryError( GetCurrencyConvertErrorMsg(FD.ВалютаОбязательства(), NATCUR, tr.Date_Carry) );
           end;
          /*заполняем tr.SumEquivalentCarry, чтобы не было ядерной проводки по переоценке*/
           tr.SumEquivalentCarry = SumEq_Payer;
          /*чтобы не было ядерной проводки урегулирования*/
          tr.TypeDocument = "Ц";/*Исключать из процедуры переоценки*/

     elif (( (FD.Kind == DL_DVFXDEAL) or (FD.Kind == DL_DVNDEAL) or (FD.Kind == DL_DVDEALT3 )) and (FD.ВидБазовогоАктива() == FIKIND_METAL) )
             tr.SumReceiver = PaymentObj.ReceiverAmount;
             tr.SumPayer = PaymentObj.PayerAmount;

             if ( (FD.isSale()) and (not FD.Isswap() ) )
                   tr.SumPayer = FD.СуммаТребования();
                   tr.SumReceiver = FD.СуммаТребования();
                   if ( (FD.ВалютаТребования() != NATCUR) and ((tr.FIIDPayer == NATCUR) or (tr.FIIDReceiver == NATCUR)) )
                         if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребования(), tr.Date_Carry, FD.ВалютаТребования(), NATCUR, false) )
                             return SayCarryError( GetCurrencyConvertErrorMsg(FD.ВалютаТребования(), NATCUR, tr.Date_Carry) );
                         end;
                         tr.SumReceiver = SumEq_Payer;
                         tr.SumEquivalentCarry = tr.SumReceiver;
                         tr.TypeDocument = "Ц";/*Исключать из процедуры переоценки*/
                   end;
             elif ( (FD.isSale()) and (FD.dealpart() == 2 ) )
                   tr.SumPayer = FD.СуммаТребования();
                   tr.SumReceiver = FD.СуммаТребования();
                   if ( (FD.ВалютаТребования() != NATCUR) and ((tr.FIIDPayer == NATCUR) or (tr.FIIDReceiver == NATCUR)) )
                       if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребования(), tr.Date_Carry, FD.ВалютаТребования(), NATCUR, false) )
                           return SayCarryError( GetCurrencyConvertErrorMsg(FD.ВалютаТребования(), NATCUR, tr.Date_Carry) );
                       end;
                       tr.SumReceiver = SumEq_Payer;
                       tr.SumEquivalentCarry = tr.SumReceiver;
                       tr.TypeDocument = "Ц";/*Исключать из процедуры переоценки*/
                   end;
             elif ( (FD.ДатаИсполнения() != FD.ДатаСделки()) and (not FD.Isswap() ) and (FD.isSale()) )    
                  tr.SumReceiver = FD.СуммаОбязательства();
             end;
     elif ( ((FD.Kind == DL_DVFXDEAL) or (FD.Kind == DL_DVNDEAL)) and (FD.IsClient()) ) /*bpv ни в одну из предыдущих не попадаем. Делаем свою*//*PNV i-support 502911*/
       tr.SumReceiver = PaymentObj.ReceiverAmount;
       tr.SumPayer = PaymentObj.PayerAmount;
       tr.TypeDocument = "Ц";/*Исключать из процедуры переоценки*/ 
     end;

     if((ValType(TaxSum) != V_UNDEF) and (TaxSum > 0))

       if(TaxFIID != СчетДебет.rec.Code_Currency)
         if( not DV_SmartConvertSum(TS, TaxSum, tr.Date_Carry, TaxFIID, СчетДебет.rec.Code_Currency, false) )
            return SayCarryError( GetCurrencyConvertErrorMsg(TaxFIID, СчетДебет.rec.Code_Currency, tr.Date_Carry) );
         end;

         tr.SumPayer = tr.SumPayer - TS;
       else
         tr.SumPayer = tr.SumPayer - TaxSum;
       end;

       if(TaxFIID != СчетКредит.rec.Code_Currency)
         if( not DV_SmartConvertSum(TS, TaxSum, tr.Date_Carry, TaxFIID, СчетКредит.rec.Code_Currency, false) )
            return SayCarryError( GetCurrencyConvertErrorMsg(TaxFIID, СчетКредит.rec.Code_Currency, tr.Date_Carry) );
         end;

         tr.SumReceiver = tr.SumReceiver - TS;
       else
         tr.SumReceiver = tr.SumReceiver - TaxSum;
       end;
     end;

     if( IsGetAccount )
        if( DV_НужнаСводнаяПроводка(FD, СчетДебет, СчетКредит, tr.Chapter, DebMcAccDoc, CredMcAccDoc, PaymentObj.Purpose) )
           if( not DV_ДобавитьСводнуюПроводку(FD, СчетДебет, СчетКредит, tr.Date_Carry, tr.SumPayer, tr.SumReceiver, tr.ResultCarry, tr.Ground) )
              return SayCarryError("Ошибка при вставке документа сводной проводки.");
           else
              ПИ_ДелатьПроводку = false; /*сформировали сводную проводку - ниже выполнять проводку не надо*/
           end;
        end;
     end;

     if (StrUpr(genclassname(FD)) == StrUpr("DVFirstDocNDeal"))
         if ((not FD.IsClient()) and FD.IsBuy() and 
               FD.IsForward() and (FD.ВидБазовогоАктива() == FIKIND_METAL) and 
               (not FD.Биржевая()) and (FD.ВидАктиваТребования() == FIKIND_METAL)
               )
            tr.UserField3 = 1;
         end;
     end;
     if( ПИ_ДелатьПроводку )
        if( not tr.Carry() )
           return SayCarryError("Ошибка при выполнении проводки");
        end;
     end;

     if((ValType(TaxSum) != V_UNDEF) and (TaxSum > 0))

       var trtax = PaymentObj.MakeTransaction();

       if( trtax == NULL )
          return SayCarryError("Ошибка при формировании документа проводки.");
       end;

       trtax.Chapter      = tr.Chapter;
       trtax.Date_Carry   = tr.Date_Carry;
       trtax.FIIDPayer    = tr.FIIDPayer;   
       trtax.AccountPayer = tr.AccountPayer;

       if(TaxFIID != trtax.FIIDPayer)
         if( not DV_SmartConvertSum(TS, TaxSum, trtax.Date_Carry, TaxFIID, trtax.FIIDPayer, false) )
            return SayCarryError( GetCurrencyConvertErrorMsg(TaxFIID, trtax.FIIDPayer, trtax.Date_Carry) );
         end;

         trtax.SumPayer = TS;
       else
         trtax.SumPayer = TaxSum;
       end;

       if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, null, FIROLE_UNDEF, AccNalog, trtax.Date_Carry, NATCUR ) )
          return SayCarryError("Ошибка при открытии счета по категории <-Бюджет, ф.налоги>");
       end;

       trtax.FIIDReceiver    = NATCUR;   
       trtax.AccountReceiver = AccNalog.rec.Account;

       if(TaxFIID != trtax.FIIDReceiver)
         if( not DV_SmartConvertSum(TS, TaxSum, trtax.Date_Carry, TaxFIID, trtax.FIIDReceiver, false) )
            return SayCarryError( GetCurrencyConvertErrorMsg(TaxFIID, trtax.FIIDReceiver, trtax.Date_Carry) );
         end;

         trtax.SumReceiver = TS;
       else
         trtax.SumReceiver = TaxSum;
       end;

       if((DL_UseNUTX() == true) and (FD.IsClient()) and (IsInstNeresForNUTX(GetFactReceiverForNUTX(FD.Deal.rec.Client), PaymentObj.ValueDate) == true))
          trtax.Ground = "Удержание налога с клиента ЮЛН";
       else
          trtax.Ground = "Удержание налога с к/а";
       end;

       if( not trtax.Carry() )
          return SayCarryError("Ошибка при выполнении проводки");
       end;
     end;
  end;

  return true;
END;

/*PNV*/
private macro PartyIsNotResident( PartyID )
  var sqlPartcode, PartyRow;
  sqlPartcode = RSDCommand("select t_NotResident "+
                           "  from dparty_dbt    "+
                           " where t_PartyID = ? "+
                           "   and t_NotResident = 'X'");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartyRow = TRsbDataSet(sqlPartcode);
  if( PartyRow.MoveNext() )
     return true;
end;

  return false;
END;

/*PNV*/

MACRO DV_СохранитьСчетаВПлатеже( _pmobj:RsbPayment, paym:TRecHandler, DtAccount:TRecHandler, CtAccount:TRecHandler, FD ):BOOL
  //mda 14.02.2019 Чтобы втыкать основание платежа - нужна первичка FD
  var pmobj = _pmobj;
  var ground = "";
  var IsCMClient = false; /*bpv валютная брокерка*/

  if( pmobj == NULL )
     pmobj = RsbPayment( paym.rec.PaymentID );

     if( pmobj == NULL )
        return false;                                                     
     end;
  end;

  /*bpv*/
  if ((FD.kind == 199) or (FD.kind == 4813))
     if (FD.IsClient() and FD.IsCurrMarket())
        IsCMClient = true;
     end;
  end;
  /*bpv*/

  if (FD.kind == 199)
    if (pmobj.BaseFIID == NATCUR)
      if (FD.IsOption())
        ground = "";
      /*elif (FD.IsForward()) /*PNV основания на шаге Постановка на баланс 505935*/
        pmobj.ground = FD.GetGround(1001);*/
      elif ((pmobj.OutCorschem != -1 ) and (IsCorschem_LORO (pmobj.OutCorschem, pmobj.basefiid)) )
        if (PartyIsNotResident(pmobj.receiver))
           pmobj.ground = FD.GetGround(1007, pmobj);      
        else
           pmobj.ground = FD.GetGround(1006);  
        end;  
      else
        pmobj.ground = FD.GetGround(1006); 
      end;
    else
      if ( FD.IsPctSWAP() )//chva  500389
         pmobj.ground = FD.GetGround(1007);
      else
         pmobj.ground = FD.GetGround(1007, pmobj);      
      end;
    end;
  elif (FD.kind == 4813)/*PNV*/
    if ((pmobj.OutCorschem != -1 ) and (IsCorschem_LORO (pmobj.OutCorschem, pmobj.basefiid)) )
       if ((PartyIsNotResident(pmobj.receiver)) and (FD.IsBNote()))
           pmobj.ground = FD.GetGround(1008, pmobj);
       elif (PartyIsNotResident(pmobj.receiver))
           pmobj.ground = FD.GetGround(1007);
       else 
           if ((FD.IsBNote()) and (pmobj.BaseFIID != NATCUR))/*PNV 501161*/
                pmobj.ground = FD.GetGround(1008, pmobj);
           elif (pmobj.BaseFIID != NATCUR) 
                pmobj.ground = FD.GetGround(1007, pmobj);/*CHVA сделал 1009 отдельно для валютных лоро 489017*//*PNV i-support 503232*/
           else 
                pmobj.ground = FD.GetGround(1006);
           end;
       end;
    else
       if ((pmobj.OutCorschem != -1 ) and (PartyIsNotResident(pmobj.receiver)) and (FD.IsBNote()) and (Substr(GetCorAcc( pmobj.basefiid, pmobj.OutCorschem, CORS_ACC_ACCOUNT), 1 , 5) == "30102") )
           pmobj.ground = FD.GetGround(1006, pmobj);
       elif ((pmobj.OutCorschem != -1 ) and (PartyIsNotResident(pmobj.receiver)) and (FD.IsBNote()) and (Substr(GetCorAcc( pmobj.basefiid, pmobj.OutCorschem, CORS_ACC_ACCOUNT), 1 , 5) == "30111") )
           pmobj.ground = FD.GetGround(1008, pmobj);
       elif ((PartyIsNotResident(pmobj.receiver)) and (FD.IsBNote()))
           pmobj.ground = FD.GetGround(1008, pmobj);
       elif (PartyIsNotResident(pmobj.receiver)) /*PNV 500023*/
           pmobj.ground = FD.GetGround(1007);
        elif (pmobj.BaseFIID == NATCUR)
            pmobj.ground = FD.GetGround(1006);
        else
            if (FD.IsBNote())
            pmobj.ground = FD.GetGround(1008,pmobj);/*CHVA*/
            else
                pmobj.ground = FD.GetGround(1007);
            end;
        end;
     end;
  end;

  if( (DtAccount != NULL) AND (DtAccount.rec.Account != "") AND (paym.rec.PayerAccount != DtAccount.rec.Account) )
           paym.rec.PayerAccount   = DtAccount.rec.Account;
           paym.rec.Payer          = DtAccount.rec.Client;
           paym.rec.PayerBankID    = {OurBank};/*поскольку заменяем счетом нашего банка, то наш банк становится банком плательшика*/ 

     if( paym.rec.PayFIID != DtAccount.rec.Code_Currency )
         pmobj.PayerAmount = 0;
     end;

           /*поскольку заменяем счетом нашего банка, то сбрасываем корсчет из СПИ и банк корреспондента*/
           pmobj.PayerBankCorrAcc          = "";
           pmobj.PayerBankCorrCodeKind     = 0;
           pmobj.PayerBankCorrCodeKindName = "";
           pmobj.PayerBankCorrCode         = "";
           pmobj.PayerBankCorrName         = "";
           pmobj.PayerBankCorrID           = -1;     
           pmobj.PayerSPI_Ident            = "";
   

      /*bpv IS 503184 #279791*/
      if (IsCMClient)
        pmobj.PayerBankCorrAcc = "";
        pmobj.PayerBankCorrCodeKind = 0;
        pmobj.PayerBankCorrCode = "";
      end;
      /*bpv*/
   /*PNV*/
   if (FD.ВидБазовогоАктива() == FIKIND_METAL)
       if( paym.rec.PayFIID != DtAccount.rec.Code_Currency )
           /*в случае сделки драг металла за рубли по Кт в платеж идет всегда рублевый счет Выбытие ДМ, поэтому сумму надо пересчитать*/
           pmobj.PayerAmount = 0;
       end;
    end;
    /*PNV*/

     pmobj.SetPayerPI( PAYMENTS_GROUP_UNDEF,
                       paym.rec.PayerBankID,
                       IIF(DtAccount.rec.Code_Currency == NATCUR,PTCK_BIC,PTCK_SWIFT),//PTCK_CONTR,
                       ПолучитьКодСубъекта( paym.rec.PayerBankID, IIF(DtAccount.rec.Code_Currency == NATCUR,PTCK_BIC,PTCK_SWIFT)),//ПолучитьКодСубъекта( {OurBank}, PTCK_CONTR),
                       ПолучитьИмяСубъекта(paym.rec.PayerBankID),
                       "",
                       DtAccount.rec.Code_Currency,
                       DtAccount.rec.chapter,
                       DtAccount.rec.Account,
                       pmobj.Payer,
                       pmobj.PayerName,
                       pmobj.PayerINN,
                       pmobj.PayerCodeKind,
                       pmobj.PayerCode,
                       IIF(IsCMClient, -1, null), IIF(IsCMClient, PM_CORRPOS_TYPE_USER, null)
                     );
     //mda 14.02.19 При актуализации платежей, добавим признак БЭСП , номер платежа , jоснование
     if ((pmobj.BaseFIID == NATCUR) and (pmobj.BaseAmount >= 100000000) and (not SfIsOurFilial(pmobj.ReceiverBankID)))/*PNV*/
       pmobj.paymentkind = "С";
     end;
     pmobj.Number = pmobj.PaymentID;
     pmobj.Actuate( pmobj );
  elif( (DtAccount != NULL) AND (DtAccount.rec.Account != ""))
     /*PNV*/
     if (FD.ВидБазовогоАктива() == FIKIND_METAL) 
         if( paym.rec.PayFIID != DtAccount.rec.Code_Currency )
             /*в случае сделки драг металла за рубли по Кт в платеж идет всегда рублевый счет Выбытие ДМ, поэтому сумму надо пересчитать*/
             pmobj.PayerAmount = 0;
         elif (not FD.Netting()) /*PNV i-support 487208*/
             pmobj.PayerAmount = 0;
         end;
     end;
   /*PNV*/
  end;

  if( (CtAccount != NULL) AND (CtAccount.rec.Account!="") AND (paym.rec.ReceiverAccount != CtAccount.rec.Account) )
         paym.rec.ReceiverAccount= CtAccount.rec.Account;
         paym.rec.Receiver       = CtAccount.rec.Client;
         paym.rec.ReceiverBankID = {OurBank};/*поскольку заменяем счетом нашего банка, то наш банк становится банком получателя*/ 
     
         /*поскольку заменяем счетом нашего банка, то сбрасываем корсчет из СПИ и банк корреспондента*/
         pmobj.ReceiverBankCorrAcc          = "";
         pmobj.ReceiverBankCorrCodeKind     = 0;
         pmobj.ReceiverBankCorrCodeKindName = "";
         pmobj.ReceiverBankCorrCode         = "";
         pmobj.ReceiverBankCorrName         = "";
         pmobj.ReceiverBankCorrID           = -1;    
         pmobj.ReceiverSPI_Ident            = "";


     /*bpv IS 503184 #279791*/
     if (IsCMClient)
        pmobj.ReceiverBankCorrAcc = "";
        pmobj.ReceiverBankCorrCodeKind = 0;
        pmobj.ReceiverBankCorrCode = "";
     end;
     /*bpv*/

     if( paym.rec.PayFIID != CtAccount.rec.Code_Currency )
        /*в случае сделки продажи драг металла за рубли по Кт в платеж идет всегда рублевый счет Выбытие ДМ, поэтому сумму надо пересчитать*/
        pmobj.ReceiverAmount = 0;
     end;

     pmobj.SetReceiverPI( PAYMENTS_GROUP_UNDEF, 
                          paym.rec.ReceiverBankID, 
                          IIF(CtAccount.rec.Code_Currency == NATCUR,PTCK_BIC,PTCK_SWIFT),//PTCK_CONTR,
                          ПолучитьКодСубъекта( paym.rec.ReceiverBankID, IIF(CtAccount.rec.Code_Currency == NATCUR,PTCK_BIC,PTCK_SWIFT)),//ПолучитьКодСубъекта( {OurBank}, PTCK_CONTR), 
                          ПолучитьИмяСубъекта(paym.rec.ReceiverBankID), 
                          "", 
                          CtAccount.rec.Code_Currency, 
                          CtAccount.rec.chapter, 
                          CtAccount.rec.Account, 
                          pmobj.Receiver, 
                          pmobj.ReceiverName, 
                          pmobj.ReceiverINN,
                          pmobj.ReceiverCodeKind, 
                          pmobj.ReceiverCode,
                       //   IIF(IsCMClient, -1, null), IIF(IsCMClient, PM_CORRPOS_TYPE_USER, null)
                       IIF(IsCMClient, -1, IIF( ((pmobj.outcorschem != -1) and (FD.ВидБазовогоАктива() == FIKIND_METAL) ), pmobj.outcorschem, null)), IIF(IsCMClient, PM_CORRPOS_TYPE_USER, IIF( ((pmobj.outcorschem != -1) and (FD.ВидБазовогоАктива() == FIKIND_METAL) ), PM_CORRPOS_TYPE_USER, null) )/*PNV 513824*/
                        );
     //mda 14.02.19 При актуализации платежей, добавим признак БЭСП , номер платежа 
     if ((pmobj.BaseFIID == NATCUR) and (pmobj.BaseAmount >= 100000000) and (not SfIsOurFilial(pmobj.ReceiverBankID)))
       pmobj.paymentkind="С";
     end;
     pmobj.Number = pmobj.PaymentID;
     pmobj.Actuate( pmobj );
  elif( (CtAccount != NULL) AND (CtAccount.rec.Account != ""))
     if (FD.ВидБазовогоАктива() == FIKIND_METAL)
         if( paym.rec.PayFIID != CtAccount.rec.Code_Currency ) 
             /*в случае сделки продажи драг металла за рубли по Кт в платеж идет всегда рублевый счет Выбытие ДМ, поэтому сумму надо пересчитать*/
             pmobj.ReceiverAmount = 0;
         elif (not FD.Netting()) /*PNV i-support 487208*/
            pmobj.ReceiverAmount = 0;
         end;
     end;
  end;
  //TEG 02.05.19 ролевая модель   
  /* Определяем конечного операциониста для проводки */
      if ((PmObj.DocKind==140) or (PmObj.DocKind==152) or (PmObj.DocKind==4626) or (PmObj.DocKind==4627))
         PmObj.Oper = GetMainOperInGroup(PmObj.DocKind);
      elif (PmObj.DocKind==194)
         PmObj.Oper = GetMainOperInGroup(PmObj.DocKind,FD.DVOPER.rec.operkind);
      else  
         PmObj.Oper = GetMainOperInGroup(PmObj.DocKind,FD.deal.rec.kind);
      end;
      if ( PmObj.Oper<= 0)
            PmObj.Oper = {Oper};
      end;
   /**/

  if ((StrUpr(GenClassName(FD)) =="DVFIRSTDOCNDEAL"))
    if(((pmobj.Purpose == BRi) OR (pmobj.Purpose == CRi)) AND FD.IsPctSWAP())
      var ExecDate2 = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID( FD.deal, OBJTYPE_OUTOPER_DV), 110);
      if ((ValType(ExecDate2) == V_DATE) AND (ExecDate2 != date(0,0,0)))
        pmobj.ValueDate = ExecDate2;
      end;
    end;
  end;

  pmobj.FutureBaseAmount     = $0;
  pmobj.ActuateFutureAmounts(TBA_AMOUNT);
  pmobj.ActuateFutureAmounts(TKA_AMOUNT);
  ActuatePayment(pmobj);/*иначе сумма к исполнению останется 0, что неверно*/

  return true;
END;

macro СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ):integer
/*Возможны две проводки, когда остатки будут на обоих счетах
  при включенной настройке COMMON\КАТЕГОРИИ СРЕДСТВ\PAIRACCMODE = 1 ("По Дт А, по Кт П")*/
  var DebAccBuf  = TRecHandler("account");
  var CredAccBuf = TRecHandler("account");

  VAR Fin      = TRecHandler( "fininstr" ); 
  var DebAccBuf2  = TRecHandler("account");
  var CredAccBuf2 = TRecHandler("account");

  var PlusPFIAccBuf = TRecHandler("account");
  var MinusPFIAccBuf = TRecHandler("account");

  var Sum:money = $0.0;
  var Sum2:money = $0.0;
  var FrValSum:money = FD.GetLastFrValSum();
  var restAccPlusPFI: money = $0.0;
  var restAccMinusPFI: money = $0.0;
  var СуммаТребования, ВалютаТребования; /*PNV*/
  var ground;
  var НеФормЯдернПроводкуКурсРазницы = null;
  var FIROLE = FIROLE_BA;
  //mda 17/02/19
  var categ="",curr;
  IIF( StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL",ground = FD.GetGround(8) ,ground="Списание справедливой стоимости по сделке "+FD.DealCode());
  if((not FD.OpenAccount("+ПФИ", null, null, FIROLE_UNDEF, PlusPFIAccBuf,  ДатаИсполненияШага, NATCUR, null, null)) or
     (not FD.OpenAccount("-ПФИ", null, null, FIROLE_UNDEF, MinusPFIAccBuf, ДатаИсполненияШага, NATCUR, null, null))
    )
     return 1;  
  end; 

  restAccPlusPFI  = GetRestAccountTRH(PlusPFIAccBuf, ДатаИсполненияШага);
  restAccMinusPFI = GetRestAccountTRH(MinusPFIAccBuf, ДатаИсполненияШага);

  var ВидБазовогоАктива:integer = FD.ВидБазовогоАктива();

  var IsSumEqDebet = null;
  var IsSumEqDebet2 = null;

  //mda 17.02.19 Определим правильно категорию , для корреспонденции по списанию СС в сделках ПФИ! Только для валюты!! ВидБазовогоАктива == FIKIND_CURRENCY
  if ( (FD.БивалютнаяСделка()) and (ВидБазовогоАктива != FIKIND_METAL) )
    if (FD.IsForward() or FD.IsSWAP())
      if (FD.IsBuy)
        categ = ПИ_КатегорияПлФорвардРПИ();
        curr = FD.ВалютаТребования();
      else
        categ = ПИ_КатегорияМнФорвардРПИ();
        curr =  FD.ВалютаОбязательства();
      end; 
    elif (FD.IsOption())
      if (FD.IsBuyOption())
        categ = ПИ_КатегорияПлФорвардРПИ();
        curr = FD.ВалютаТребования();
      else
        categ = ПИ_КатегорияМнФорвардРПИ();
        curr = FD.ВалютаОбязательства();
      end;
    end;
  elif ((ВидБазовогоАктива == FIKIND_METAL) and (not FD.Биржевая()) )
        if (FD.IsBuy)
            categ =  "+Форвард, расчетыДМ";
            curr = IIF( (ВидБазовогоАктива == FIKIND_METAL) , IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования()), FD.ВалютаТребования());/*PNV*/
            FIROLE = FIROLE_FIREQ;
        else 
            categ =  "-Форвард, расчетыДМ";
            curr = IIF( (ВидБазовогоАктива == FIKIND_METAL) , IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования()), FD.ВалютаОбязательства());/*PNV*/
            FIROLE = FIROLE_FICOM;
        end;
  elif ((ВидБазовогоАктива == FIKIND_METAL) and (FD.Биржевая()) )
        if (FD.IsBuy)
            categ =  "+Форвард, расчетыДМ";
            curr = IIF( (ВидБазовогоАктива == FIKIND_METAL) , IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования()), FD.ВалютаТребования());/*PNV*/
            FIROLE = FIROLE_FIREQ;
        else 
            categ =  ПИ_КатегорияМнФорвардРПИ();
            curr = IIF( (ВидБазовогоАктива == FIKIND_METAL) , IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования()), FD.ВалютаОбязательства());/*PNV*/
            FIROLE = FIROLE_FICOM;
        end;
  else
    if ((FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования() != NATCUR))
      categ = ПИ_КатегорияПлФорвардРПИ();
      curr = FD.ВалютаТребования();
    elif ((FD.ВалютаОбязательства() != NATCUR) and (FD.ВалютаТребования() == NATCUR))
      categ = ПИ_КатегорияМнФорвардРПИ();
      curr = FD.ВалютаОбязательства();
    end;
  end;
  //mda 17/02/19 END
  if( FD.IsClient() == false )
     if( FD.IsForward() OR FD.IsSWAP() )    /*Л или Н*/ 
        if( FD.IsBuy() )                   /*ЛА*/
           if ( ВидБазовогоАктива == FIKIND_CURRENCY )  /*ЛАа*/

               if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /*Лааа1 или НААа*/
                //mda 17/02/19 if( (not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                if( (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                     (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                    return 1;
                 end;
                 IsSumEqDebet = true;
                 Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
              end;

              if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )   /*Лааа2 или НААб*/
                 if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                    //mda 17/02/19 (not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                     (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) )
                    return 1;
                 end;
                 IsSumEqDebet2 = false;
                 Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
              end;

           elif (ВидБазовогоАктива == FIKIND_AVOIRISS )/*Лаб*/
              if( FrValSum > 0 ) 
                 if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0)  ) /*Лаб1*/
                    if( (not FD.OpenAccount( "+Форвард, расчеты", null, null, FIROLE_BA, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null ) ) OR
                        (not FD.OpenAccount( "+ПФИ",              null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum = abs (IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) ); 
                 end;

                 if( restAccMinusPFI > 0 )  /*Лаб2*/
                    if( (not FD.OpenAccount( "+Форвард, расчеты", null, null, FIROLE_BA, CredAccBuf2,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null ) ) OR
                        (not FD.OpenAccount( "-ПФИ",              null, null, FIROLE_UNDEF, DebAccBuf2, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum2 = abs( restAccMinusPFI);                       
                 end;
              end;

              If((FD.kind == 199) and (FD.deal.rec.kind == 12690) and (ВидБазовогоАктива == FIKIND_AVOIRISS ))
                 ПолучитьФинИн(FD.NFI_baseactiv.rec.fiid, fin);
                 ground = "Списание справедливой стоимости по сделке "+FD.DealCode()+" с "+Fin.rec.definition + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)/*CHVA*/;
              else
                 ground = "Списание справедливой стоимости по сделке "+FD.DealCode()+" с "+ПолучитьКодФинИн(FD.NFI_baseactiv.rec.fiid) + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)/*CHVA*/;
              end;
           elif( ВидБазовогоАктива == FIKIND_METAL)/*Лаб*/
              if( FrValSum != 0 ) /*PNV */
                 if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0)  ) /*Лаб1*/
                    if( (not FD.OpenAccount( categ, null, null, FIROLE, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null ) ) OR
                        (not FD.OpenAccount( "+ПФИ",null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum = abs (IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) ); 
                   if (FD.ВалютаРасчётов() != NATCUR)
                       НеФормЯдернПроводкуКурсРазницы = true;
                        IsSumEqDebet = true;
                    end;
                 end;

                 if( restAccMinusPFI > 0 )  /*Лаб2*/
                    if( (not FD.OpenAccount( categ, null, null, FIROLE, CredAccBuf2,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null ) ) OR
                        (not FD.OpenAccount( "-ПФИ",null, null, FIROLE_UNDEF, DebAccBuf2, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum2 = abs( restAccMinusPFI); 
                    if (FD.ВалютаРасчётов() != NATCUR)
                       НеФормЯдернПроводкуКурсРазницы = true;
                       IsSumEqDebet2 = false;
                    end;                 
                 end;
              end;
              ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). " + "Списание справедливой стоимости по сделке "+FD.DealCode()+" с "+ПолучитьКодФинИн(FD.NFI_baseactiv.rec.fiid) + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)/*CHVA*/;
          end;
              
        else /*ЛБ - направление "Продажа"*/
          if( ВидБазовогоАктива == FIKIND_CURRENCY )
             if (fd.IsSWAP() and (FD.ВалютаТребования()!=0))//TEG 08.02.19  для свопа на требования
                   if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /*Лбааа1 или НАБа1*/
                       if( (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                           (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                          return 1;
                       end;
                       IsSumEqDebet = true;
                       Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
                    end;

                    if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) ) /*Лбааа2 */
                       if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                             (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) )
                          return 1;
                       end;
                       IsSumEqDebet2 = false;
                       Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                    end;
            else 
              if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /*Лбааа1 или НАБа1*/
                 //mda 17/02/19 if( (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                 if( (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                     (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                    return 1;
                 end;
                 IsSumEqDebet = true;
                 Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
              end;

              if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) ) /*Лбааа2 */
                 if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                     //mda 17/02/19 (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                     (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) )
                    return 1;
                 end;
                 IsSumEqDebet2 = false;
                 Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                    end;
              end;

          elif( ВидБазовогоАктива == FIKIND_AVOIRISS )  /*ЛБб*/

              if( FD.ДатаПоставки() == FD.ДатаИсполнения() ) /*ЛБбa*/
                 if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /* ЛБбa1 */
                    if( (not FD.OpenAccount( "Реализация, ц/б", null, null, FIROLE_BA, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( "+ПФИ",            null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
                 end;

                 if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) ) /*ЛБбa2*/
                   if( (not FD.OpenAccount( "-ПФИ",            null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                       (not FD.OpenAccount( "Реализация, ц/б", null, null, FIROLE_BA,    CredAccBuf2, ДатаИсполненияШага, NATCUR, null, null ) ) )
                      return 1;
                   end;
                   Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                 end;
              elif( (FD.ДатаПоставки() > FD.ДатаИсполнения()) and (FrValSum < 0) ) /*ЛБбб*/

                 if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )
                    if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                       return 1;
                    end;
                    Sum = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                 end;
              end;
              ground="Списание справедливой стоимости по сделке "+FD.DealCode()+" с "+ПолучитьКодФинИн(FD.NFI_baseactiv.rec.fiid) + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/; 

          elif( ВидБазовогоАктива == FIKIND_METAL) /*ЛБб*/

              if( FD.ДатаПоставки() <= FD.ДатаИсполнения() ) /*ЛБбa*/
                 if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /* ЛБбa1 */
                    if( (not FD.OpenAccount( "Выбытие ДМ", null, null, FIROLE_BA, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( "+ПФИ",            null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
                 end;

                 if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) ) /*ЛБбa2*/
                   if( (not FD.OpenAccount( "-ПФИ",            null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                       (not FD.OpenAccount( "Выбытие ДМ", null, null, FIROLE_BA,    CredAccBuf2, ДатаИсполненияШага, NATCUR, null, null ) ) )
                      return 1;
                   end;
                   Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                 end;
              elif( (FD.ДатаПоставки() > FD.ДатаИсполнения()) and (FrValSum < 0) ) /*ЛБбб*/

                 if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )
                    if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                       return 1;
                    end;
                    Sum = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                 end;
              end;
             ground="ПФИ (" + FD.PctSwapTypeName(true) + "). " + "Списание справедливой стоимости по сделке "+FD.DealCode()+" с "+ПолучитьКодФинИн(FD.NFI_baseactiv.rec.fiid) + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/; 
          end;
       end;
     
     elif( FD.IsOption() )
        if ( FD.IsBuyOption() )//if( FD.IsBuy() )
           if( ВидБазовогоАктива == FIKIND_CURRENCY ) /*Лааа1*/

              if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /*Лааа1*/
                //mda 17/02/19 if( (not FD.OpenAccount( IIF(FD.ВалютаОбязательства() == NATCUR,ПИ_КатегорияПлФорвардРПИ(),ПИ_КатегорияМнФорвардРПИ()), null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, IIF(FD.ВалютаОбязательства() == NATCUR,FD.ВалютаТребования(),FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                if( (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                    (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                   return 1;
                end;
                IsSumEqDebet = true;
                Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
              end;
          
              if(restAccMinusPFI > 0)  /*Лааа12*/
                 if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                     //mda 17/02/19 (not FD.OpenAccount( IIF(FD.ВалютаОбязательства() == NATCUR,ПИ_КатегорияПлФорвардРПИ(),ПИ_КатегорияМнФорвардРПИ()), null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, IIF(FD.ВалютаОбязательства() == NATCUR,FD.ВалютаТребования(),FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                     (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) )
                    return 1;
                 end;
                 IsSumEqDebet2 = false;
                 Sum2 = abs( restAccMinusPFI );
              end;
          
           elif( ВидБазовогоАктива == FIKIND_AVOIRISS ) /*Лаб1*/
             if((restAccPlusPFI < 0) or (restAccMinusPFI < 0))
                if( (not FD.OpenAccount( "+Форвард, расчеты", null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null ) ) OR
                    (not FD.OpenAccount( "+ПФИ",              null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                   return 1;
                end;
                Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
             end;
          
             if( restAccMinusPFI > 0)   /*Лаб2*/
                if( (not FD.OpenAccount( "+Форвард, расчеты", null, null, FIROLE_UNDEF, CredAccBuf2,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null ) ) OR
                    (not FD.OpenAccount( "-ПФИ",              null, null, FIROLE_UNDEF, DebAccBuf2, ДатаИсполненияШага, NATCUR, null, null ) ) )
                   return 1;
             end;
                Sum2 = abs( restAccMinusPFI);
             end;       
          
           elif( ВидБазовогоАктива == FIKIND_DERIVATIVE ) /*Лав*/
               if((restAccPlusPFI < 0) or (restAccMinusPFI < 0)) /*Лав1*/
                  if( (not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                      (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                      return 1;
                  end;
                  Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
               end;
          
               if( restAccMinusPFI > 0)    /*Лав2*/
                  if( (not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf2,  ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
                      (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,   ДатаИсполненияШага, NATCUR, null, null ) ) )
                     return 1;
                  end;
                  Sum2 = abs( restAccMinusPFI);
               end;
           end;

        else  /*Лб*/
           if( ВидБазовогоАктива == FIKIND_CURRENCY ) /*Лба*/
             if((restAccPlusPFI > 0) or (restAccMinusPFI > 0))  /*Лбаа11*/
               if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                   //mda 17/02/19 (not FD.OpenAccount( IIF(FD.ВалютаОбязательства() == NATCUR,ПИ_КатегорияПлФорвардРПИ(),ПИ_КатегорияМнФорвардРПИ()), null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, IIF(FD.ВалютаОбязательства() == NATCUR,FD.ВалютаТребования(),FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                   (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) )
                  return 1;
               end;
                 IsSumEqDebet = false;
                 Sum = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
             end;

             if( restAccPlusPFI < 0)     /*Лбаа12*/
                if( (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                    //mda 17/02/19 (not FD.OpenAccount( IIF(FD.ВалютаОбязательства() == NATCUR,ПИ_КатегорияПлФорвардРПИ(),ПИ_КатегорияМнФорвардРПИ()), null, null, FIROLE_UNDEF, DebAccBuf2, ДатаИсполненияШага, IIF(FD.ВалютаОбязательства() == NATCUR,FD.ВалютаТребования(),FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                    (not FD.OpenAccount( categ, null, null, FIROLE_UNDEF, DebAccBuf2, ДатаИсполненияШага, curr, null, null, MC_PAIRACCMODE_MANUAL ) ) )
                   return 1;
                end;
                IsSumEqDebet2 = true;
                Sum2 = abs( restAccPlusPFI);
             end;

           elif( ВидБазовогоАктива == FIKIND_AVOIRISS ) /*Лбб*/

              if( FD.ДатаПоставки() == FD.ДатаИсполнения() ) /*Лбба*/
                 if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )  /*Лбба1*/
                    if( (not FD.OpenAccount( "-ПФИ",            null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( "Реализация, ц/б", null, null, FIROLE_BA, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                 end;

                 if( restAccPlusPFI < 0)  /*Лбба2*/
                    if( (not FD.OpenAccount( "+ПФИ",            null, null, FIROLE_UNDEF, CredAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( "Реализация, ц/б", null, null, FIROLE_BA,    DebAccBuf2, ДатаИсполненияШага, NATCUR, null, null ) ) )
                       return 1;
                    end;
                    Sum2 = abs( restAccPlusPFI);
                 end;
              elif( (FD.ДатаПоставки() > FD.ДатаИсполнения()) and (FrValSum < 0) ) /*Лббб*/

                 if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )
                    if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                        (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                       return 1;
                    end;
                    Sum = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
                 end;
              end;

           elif( ВидБазовогоАктива == FIKIND_DERIVATIVE ) /*Лбв*/
             if((restAccPlusPFI > 0) or (restAccMinusPFI > 0))  /*Лбб1*/
                if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                    (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                   return 1;
                end;
                Sum = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
             end;

             if(restAccPlusPFI < 0)  /*Лбб2*/
                if( (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
                    (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, DebAccBuf2, ДатаИсполненияШага, FD.ВалютаРасчётов(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
                   return 1;
                end;
                Sum2 = abs( restAccPlusPFI);
             end;
           end;
        end;
     end;
  end;

  if( Sum > 0.0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        DebAccBuf, CredAccBuf,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, Sum,
                                        doc,
                                        INPCARRY,"", "",
                                        Ground,// "Списание справедливой стоимости по сделке "+FD.DealCode(),
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet, null, null, null, null, null, null, null, НеФормЯдернПроводкуКурсРазницы
                                      )
       )
        return 1;
     end;
  end;


  if( Sum2 > 0.0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        DebAccBuf2, CredAccBuf2,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, Sum2,
                                        doc,
                                        INPCARRY,"", "",
                                        Ground,//"Списание справедливой стоимостипо сделке "+FD.DealCode(),
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet2, null, null, null, null, null, null, null, НеФормЯдернПроводкуКурсРазницы
                                      )
       )
        return 1;
     end;
  end;
      /*PNV закрываем остаток со счета 61213*/ 
      if ((Sum2 > 0.0) or (Sum > 0.0))
          ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). " + "Зачисление стоимости ДМ (" + FD.BaseFI().rec.name + ") по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor); 
           if ( (ВидБазовогоАктива == FIKIND_METAL) and ((FD.Биржевая()) or (not FD.Netting()) ) and (FD.СрокСделки != DV_PERIODCLS_T3) )
                 if( FD.IsBuy() )
                     categ =  "+Форвард, расчетыДМ";
                     curr = IIF( (ВидБазовогоАктива == FIKIND_METAL) , IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования()), FD.ВалютаТребования());/*PNV*/
                     FIROLE = FIROLE_FIREQ;
                     if( not DV_SmartConvertSum(СуммаТребования, FD.СуммаТребования(), ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, false) )
                        return 1;
                     end;
                     if( not ПроводкаПоКатегориямУчета( FD,
                                        "КлиринговыеСчетаДМ", categ,  
                                        ДатаИсполненияШага, 1,
                                        FD.ВалютаОбязательства(), СуммаТребования,
                                        doc,
                                        INPCARRY,"", "",
                                        Ground,
                                        NULL, FIROLE_FIREQ, FIROLE,
                                        FD.ВалютаТребования(), curr,
                                        FD.ВалютаТребования(), FD.СуммаТребования(),
                                        NULL, NULL, NULL, NULL,
                                        ACCTRN_SIDE_DEBET, NULL, NULL, NULL, NULL, NULL,
                                        null, null, null, null, null, null, true 
                                      )
                          )
                        return 1;
                    end;
                elif( FD.IsSale() )
                    if( not DV_SmartConvertSum(СуммаТребования, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.ВалютаОбязательства(), NATCUR, false) )
                        return 1;
                    end;
     
                    if( not ПроводкаПоКатегориямУчета( FD,
                                        "Выбытие ДМ", "КлиринговыеСчетаДМ", 
                                        ДатаИсполненияШага, 1,
                                        NATCUR, СуммаТребования,
                                        doc,
                                        INPCARRY,"", "",
                                        Ground,
                                        NULL, FIROLE_BA, FIROLE_FIREQ,
                                        NATCUR, FD.ВалютаОбязательства(),
                                        NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                       )
                       return 1;
                    end;
                end;  
           end;
          /*PNV*/
      end;
  return 0;
end;

/*Специально для возможности проведения и закрытия старых сделок короткого свопа закрытой операции 2740*/
macro СВОП_СписаниеСправедливойСтоимости( FD:DVFirstDocFXDeal, doc, ДатаИсполненияШага ):integer
/*Возможны две проводки, когда остатки будут на обоих счетах
  при включенной настройке COMMON\КАТЕГОРИИ СРЕДСТВ\PAIRACCMODE = 1 ("По Дт А, по Кт П")*/
  var DebAccBuf  = TRecHandler("account");
  var CredAccBuf = TRecHandler("account");

  var DebAccBuf2  = TRecHandler("account");
  var CredAccBuf2 = TRecHandler("account");

  var PlusPFIAccBuf = TRecHandler("account");
  var MinusPFIAccBuf = TRecHandler("account");

  var Sum:money = $0.0;
  var Sum2:money = $0.0;
  var restAccPlusPFI: money = $0.0;
  var restAccMinusPFI: money = $0.0;

  if( FD.IsClient() )
     return 0;
  end; 

  if((not FD.OpenAccount("+ПФИ", null, null, FIROLE_UNDEF, PlusPFIAccBuf,  ДатаИсполненияШага, NATCUR, null, null)) or
     (not FD.OpenAccount("-ПФИ", null, null, FIROLE_UNDEF, MinusPFIAccBuf, ДатаИсполненияШага, NATCUR, null, null))
    )
     return 1;  
  end; 

  restAccPlusPFI  = GetRestAccountTRH(PlusPFIAccBuf, ДатаИсполненияШага);
  restAccMinusPFI = GetRestAccountTRH(MinusPFIAccBuf, ДатаИсполненияШага);

  var IsSumEqDebet = null;
  var IsSumEqDebet2 = null;

  if( FD.IsBuy() )                   /*ЛА*/
     if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /*Лааа1 или НААа*/
        if( (not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
            (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
           return 1;
        end;
        IsSumEqDebet = true;
        Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
     end;

     if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) )   /*Лааа2 или НААб*/
        if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
            (not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
           return 1;
        end;
        IsSumEqDebet2 = false;
        Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
     end;
  else /*ЛБ - направление "Продажа"*/
     if( (restAccPlusPFI < 0) or (restAccMinusPFI < 0) ) /*Лбааа1 или НАБа1*/
        if( (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL ) ) OR
            (not FD.OpenAccount( "+ПФИ",          null, null, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ) )
           return 1;
        end;
        IsSumEqDebet = true;
        Sum = abs( IIF((restAccPlusPFI < 0), restAccPlusPFI, restAccMinusPFI) );
     end;

     if( (restAccPlusPFI > 0) or (restAccMinusPFI > 0) ) /*Лбааа2 */
        if( (not FD.OpenAccount( "-ПФИ",          null, null, FIROLE_UNDEF, DebAccBuf2,  ДатаИсполненияШага, NATCUR, null, null ) ) OR
            (not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_UNDEF, CredAccBuf2, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL ) ) )
           return 1;
        end;
        IsSumEqDebet2 = false;
        Sum2 = abs( IIF((restAccPlusPFI > 0), restAccPlusPFI, restAccMinusPFI) );
     end;
  end;

  if( Sum > 0.0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        DebAccBuf, CredAccBuf,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, Sum,
                                        doc,
                                        INPCARRY,"", "",
                                        "Списание справедливой стоимости",
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet
                                      )
       )
        return 1;
     end;
  end;

  if( Sum2 > 0.0 )
     if( not ПроводкаПоКатегориямУчета( FD,
                                        DebAccBuf2, CredAccBuf2,
                                        ДатаИсполненияШага, 1,
                                        NATCUR, Sum2,
                                        doc,
                                        INPCARRY,"", "",
                                        "Списание справедливой стоимости",
                                        NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, IsSumEqDebet2
                                      )
       )
        return 1;
     end;
  end;

  return 0;
end;

MACRO ПолучитьСрочныеСчетаВнб( FD:DVFirstDocNDeal, ReqAcc:@STRING, ReqAccFIID:@INTEGER, ReqFiRole:@INTEGER, ComAcc:@STRING, ComAccFIID:@INTEGER, ComFiRole:@INTEGER )

  /*
    Используем существующие роли, так что небольшое пояснение:
    FIROLE_FIDOC      - требование ВБА
    FIROLE_PRICEFI    - обязательство ВБА
    FIROLE_FIREQ_BACK - требование ВР
    FIROLE_FICOM_BACK - обязательство ВР
  */
   var query, rsbQuery, KindOfInstr;
      query = "select  t_fi_kind      "+ 
              "from dfininstr_dbt a             "+ 
              "where a.t_fiid = "+FD.nFI_BaseActiv.rec.fiid;  
      rsbQuery = TRsbDataSet(query);
   if (rsbQuery.MoveNext())
      KindOfInstr = rsbQuery.fi_kind; 
   end;

   if (FD.Deal.rec.kind == 22710)
         ReqAccFIID = IIF(((FD.IsPctSWAP() or FD.IsSWAP()) ), FD.ВалютаТребования(), FD.ВалютаОбязательства());
        ComAccFIID = IIF(((FD.IsPctSWAP() or FD.IsSWAP()) ), FD.ВалютаОбязательства(), FD.ВалютаТребования());
   else
  //TEG 14.02.19 это единственный кусочек что увидел при анализе макроса от Чепли Владимира 
      if ((StrUpr(GenClassName(FD)) =="DVFIRSTDOCNDEAL") and ((fd.deal.rec.kind == 2715)/*MDA*/ or (fd.deal.rec.kind == 12715)/*MDA*/) and (FD.ВидБазовогоАктива() == FIKIND_METAL) ) 
         ReqAccFIID = IIF(((FD.IsPctSWAP() or FD.IsSWAP()) and (FD.DealPart == 1)), FD.ВалютаТребования(),/* FD.ВалютаОбязательства(),*/ FD.ВалютаТребования());
         ComAccFIID = IIF(((FD.IsPctSWAP() or FD.IsSWAP()) and (FD.DealPart == 1)), FD.ВалютаОбязательства(),/*FD.ВалютаТребования(),*/ FD.ВалютаОбязательства());
      else
         if(FD.IsPctSWAP())/*PNV i-support 492813*/
            ReqAccFIID = IIF(((FD.IsPctSWAP() or FD.IsSWAP()) and (FD.DealPart == 1)), FD.ВалютаОбязательства(), FD.ВалютаТребования());
            ComAccFIID = IIF(((FD.IsPctSWAP() or FD.IsSWAP()) and (FD.DealPart == 1)), FD.ВалютаТребования(), FD.ВалютаОбязательства());
         else
             ReqAccFIID = FD.ВалютаТребования();/*PNV*/
             ComAccFIID = FD.ВалютаОбязательства();/*PNV*/     
         end; 
      end;
   end;
  if( FD.IsForward() OR FD.IsSWAP() OR FD.IsPctSWAP() )

      ReqAcc = "+Форвард, дрейф внебирж";
      ComAcc = "-Форвард, дрейф внебирж";

      if( FD.IsPctSWAP() )
        ReqFiRole  = FIROLE_FIREQ;
        ComFiRole  = FIROLE_FICOM;
     else
        if( FD.IsBuy() )
           ReqFiRole  = FIROLE_FIDOC;
           ComFiRole  = FIROLE_FICOM_BACK;
        else
           ReqFiRole  = FIROLE_FIREQ_BACK;
           ComFiRole  = FIROLE_PRICEFI;
        end;
     end;
  elif( FD.IsOption() )
     if( FD.BuyCallOrSalePut() )
        if( FD.Deal.rec.Forvard == SET_CHAR )
           ReqAcc = "+Форвард, ПФИ внебирж";
           ComAcc = "-Форвард, дрейф внебирж";
        else
           ReqAcc = "+Форвард, дрейф внебирж";
           ComAcc = "-Форвард, дрейф внебирж";
        end;
        ReqFiRole  = FIROLE_FIDOC;
        ComFiRole  = FIROLE_FICOM_BACK;
     else
        if( FD.Deal.rec.Forvard == SET_CHAR )
           ReqAcc = "+Форвард, дрейф внебирж";
           ComAcc = "-Форвард, ПФИ внебирж";
        else
           ReqAcc = "+Форвард, дрейф внебирж";
           ComAcc = "-Форвард, дрейф внебирж";
        end;
        ReqFiRole  = FIROLE_FIREQ_BACK;
        ComFiRole  = FIROLE_PRICEFI;
     end;
  end;

end;

macro СписаниеТребованияИОбязательства( FD, Doc, ДатаИсполненияШага ):integer

  RECORD СчетТреб(account);
  RECORD СчетОбяз(account);
  var DebAcc:string  = "";  var DebFIID:integer  = ALLFININSTR;  var DebFiRole  = FIROLE_UNDEF;
  var CredAcc:string = "";  var CredFIID:integer = ALLFININSTR;  var CredFiRole = FIROLE_UNDEF;

  if( not FD.IsClient() )
     if( (((FD.IsPctSWAP() == false) ) or 
          //mda 17/02/19 (FD.IsPctSWAP() and (FD.БазовыеВалютыРавны() == false)))
          (FD.IsPctSWAP() and (((FD.БазовыеВалютыРавны() == false) and (FD.DealPart == 1)) or (FD.DealPart == 2))))
         and (FD.IsToDay() == false) )

        var ВидБазовогоАктива:integer = FD.ВидБазовогоАктива();

        ПолучитьСрочныеСчетаВнб( FD, @CredAcc, @CredFIID, @CredFiRole, @DebAcc, @DebFIID, @DebFiRole );
        /*if( (not FD.IsExistAccount( DebAcc,  null, false, DebFiRole,  СчетОбяз, null, ДатаИсполненияШага, DebFIID )) or
            (not FD.IsExistAccount( CredAcc, null, false, CredFiRole, СчетТреб, null, ДатаИсполненияШага, CredFIID )) )
           return 1;
        end;*/
        if ( not FD.IsExistAccount( DebAcc,  null, false, DebFiRole,  СчетОбяз, null, ДатаИсполненияШага, DebFIID ) )
            if (not FD.OpenAccount(DebAcc, null, false, DebFiRole, СчетОбяз, ДатаИсполненияШага, DebFIID, null ,null) )
              return 1;
            end;
        end;

        if ( not FD.IsExistAccount( CredAcc,  null, false, CredFiRole,  СчетТреб, null, ДатаИсполненияШага, CredFIID ) )
            if (not FD.OpenAccount(CredAcc, null, false, CredFiRole, СчетТреб, ДатаИсполненияШага, CredFIID, null ,null) )
              return 1;
            end;
        end;

        var СуммаОбяз:money = $0.0, СуммаТреб:money = $0.0;
        if( FD.OpenAccByGenAgr() )
           СуммаОбяз = FD.ComSum();
           СуммаТреб = FD.ReqSum();

           var НКР = DL_ПолучитьПоследнююСумму(FD.Kind, FD.ID, DLSUM_KIND_SUM_DV_NKR);
           if( FD.IsForward() or FD.IsOption() )
              if( FD.IsSale_BuyPutOrSaleCall() )
                 СуммаОбяз = СуммаОбяз + НКР;
              else
                 СуммаТреб = СуммаТреб + НКР;
              end;
           end;
        else
           if( FD.IsSWAP() or FD.IsForward() or ((ВидБазовогоАктива != FIKIND_CURRENCY) and (ВидБазовогоАктива != FIKIND_METAL)) )
              СуммаОбяз = ABS(DL_GetRestAccount(СчетОбяз, ДатаИсполненияШага));
              СуммаТреб = ABS(DL_GetRestAccount(СчетТреб, ДатаИсполненияШага));
           else
              СуммаОбяз = FD.ComSum();
              СуммаТреб = FD.ReqSum();
           end;
        end;

        FD.SetFIIDForCorAccNum(DebFIID);
        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОбяз, "СчКорреспГлаваГ",
                                           ДатаИсполненияШага, 4,
                                           DebFIID, СуммаОбяз,
                                           Doc,
                                           INPCARRY, "", "",
                                           //"Снятие обязательств с внебалансового учета, для собственных сделок",
                                           IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"),FD.GetGround(5) ,"Списание обязательства по сделке "+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/),
                                           NULL,
                                           null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                         )
          )
            return 1;
        end;

        FD.SetFIIDForCorAccNum(CredFIID);
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "СчКорреспГлаваГ", СчетТреб,
                                           ДатаИсполненияШага, 4,
                                           null, null,
                                           Doc,
                                           INPCARRY, "", "",
                                           //"Снятие требований с внебалансового учета, для собственных сделок",
                                           IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"),FD.GetGround(6) ,"Списание требования по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/),
                                           NULL,
                                           FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE), null,
                                           null, null,
                                           CredFIID, СуммаТреб
                                         )
          )
            return 1;
        end;

        if( not InsertOprStatus(IIF(FD.DealPart == 1, FD.DV_OPERSTATUS_OFFBALANCE(), FD.DV_OPERSTATUS_OFFBALANCE_2()), DV_OPERSTATUS_OFFBALANCE_NO) )
           MsgBox("Ошибка при установке статуса <Внебаланс> для операции.");
           return 1;
        end;
     end;
  end;

  return 0;
end;

private macro ПереоценкаТребованияИОбязательства( FD, Doc, nacdl ):integer
   var СчетТреб = TRecHandler("account");
   var СчетОбяз = TRecHandler("account");
   var DebAcc:string  = ""; var DebFIID:integer  = ALLFININSTR; var DebFiRole  = FIROLE_UNDEF;
   var CredAcc:string = ""; var CredFIID:integer = ALLFININSTR; var CredFiRole = FIROLE_UNDEF;
   var swapTypeName = "";
   if (FD.IsSwap())
      swapTypeName = FD.PctSwapTypeName(true);
   end;

   if( (not FD.IsClient()) and (FD.IsToDay() == false) )
      ПолучитьСрочныеСчетаВнб(FD, @CredAcc, @CredFIID, @CredFiRole, @DebAcc, @DebFIID, @DebFiRole);

      if( (not FD.IsExistAccount(DebAcc,  null, false, DebFiRole,  СчетОбяз, null, nacdl.rec.Date, DebFIID)) or
         (not FD.IsExistAccount(CredAcc, null, false, CredFiRole, СчетТреб, null, nacdl.rec.Date, CredFIID)) )
         return 1;
      end;

      if ( FIKIND_METAL == FD.ВидБазовогоАктива() ) // Металлы

         if ( (ALG_DV_BS == FD.GetDoc().rec.Type) or ((ALG_DV_SALE == FD.GetDoc().rec.Type) and FD.IsForward()) )  // Направление сделки -  Покупка-продажа
           if(GetRestAccountTRH(СчетТреб, nacdl.rec.Date) == 0)
              return 0;
           end;

            if ( DV_CALCOP_DIRECTION_RECEPTION == nacdl.rec.Direction  ) // Получение
                  FD.SetFIIDForCorAccNum(CredFIID);
                  if( not ПроводкаПоКатегориямУчета( FD,
                                                      "СчКорреспГлаваГ", СчетТреб,
                                                      nacdl.rec.Date, 4,
                                                      nacdl.rec.AccFiid,
                                                      nacdl.rec.Sum,
                                                      Doc,
                                                      INPCARRY, "", "",
                                                      IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка требований по " + IIF( FD.DealPart == 1,"1 ч. ","2 ч.") + "(контрактива) при отражении вариационной маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                      null,
                                                      FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE)
                                                   )
                  )
                     return 1;
                  end;

            elif( DV_CALCOP_DIRECTION_PAYMENT == nacdl.rec.Direction )   // Оплата
               FD.SetFIIDForCorAccNum(CredFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                   СчетТреб, "СчКорреспГлаваГ",
                                                   nacdl.rec.Date, 4,
                                                   nacdl.rec.AccFiid,
                                                   nacdl.rec.Sum,
                                                   Doc,
                                                   INPCARRY, "", "",
                                                   IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка требований по " + IIF( FD.DealPart == 1,"1 ч. ","2 ч.") + "(контрактива) при отражении вариационной маржи по сделке "  +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                   null,
                                                   null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE)
                                                )
                  )
                  return 1;
               end;
            end;

         elif ( (ALG_DV_SB == FD.GetDoc().rec.Type) or ((ALG_DV_BUY == FD.GetDoc().rec.Type) and FD.IsForward()) )  // Направление сделки - Продажа-покупка
            if(GetRestAccountTRH(СчетОбяз, nacdl.rec.Date) == 0)
               return 0;
            end;

            if ( DV_CALCOP_DIRECTION_PAYMENT == nacdl.rec.Direction )   // Оплата     

               FD.SetFIIDForCorAccNum(DebFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                   СчетОбяз, "СчКорреспГлаваГ",
                                                   nacdl.rec.Date, 4,
                                                   nacdl.rec.AccFiid,
                                                   nacdl.rec.Sum,
                                                   Doc,
                                                   INPCARRY, "", "",
                                                   IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка обязательств по " + IIF( FD.DealPart == 1,"1 ч. ","2 ч.") + "(контрактива) при отражении вариационной маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                   null,
                                                   null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                                )
               )
                  return 1;
               end;

            elif ( DV_CALCOP_DIRECTION_RECEPTION == nacdl.rec.Direction  ) // Получение          
               FD.SetFIIDForCorAccNum(DebFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                "СчКорреспГлаваГ", СчетОбяз,
                                                nacdl.rec.Date, 4,
                                                nacdl.rec.AccFiid,
                                                nacdl.rec.Sum,
                                                Doc,
                                                INPCARRY, "", "",
                                                IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка обязательств по " + IIF( FD.DealPart == 1,"1 ч. ","2 ч.") + "(контрактива) при отражении вариационной маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                null,
                                                FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                             )
               )
                  return 1;
               end;           
            end;
         end;

      else // НЕ МЕТАЛЛ

         var sumNatCur = nacdl.rec.Sum; 
 
         if (  (NATCUR != nacdl.rec.AccFiid) and  
               (not DV_SmartConvertSum(sumNatCur, sumNatCur, nacdl.rec.Date, nacdl.rec.AccFiid, NATCUR, 1)) )
            return 1;
         end;

         if ( (ALG_DV_BS == FD.GetDoc().rec.Type) or ((ALG_DV_SALE == FD.GetDoc().rec.Type) and FD.IsForward()) )  // Направление сделки -  Покупка-Продажа
            if(GetRestAccountTRH(СчетТреб, nacdl.rec.Date) == 0)
               return 0;
            end;

            if ( DV_CALCOP_DIRECTION_RECEPTION == nacdl.rec.Direction  )   // Получение   
               FD.SetFIIDForCorAccNum(CredFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                   "СчКорреспГлаваГ", СчетТреб,
                                                   nacdl.rec.Date, 4,
                                                   NATCUR,//nacdl.rec.AccFiid,
                                                   sumNatCur, //nacdl.rec.Sum,
                                                   Doc,
                                                   INPCARRY, "", "",
                                                   IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка требований по " + IIF( FD.DealPart == 1,"1 ч. ","2 ч.") + "(контрактива) при отражении вариационной маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                   null,
                                                   FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE)
                                                )
               )
                  return 1;
               end;

            elif  ( DV_CALCOP_DIRECTION_PAYMENT == nacdl.rec.Direction )  // Оплата  

               FD.SetFIIDForCorAccNum(CredFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                   СчетТреб, "СчКорреспГлаваГ",
                                                   nacdl.rec.Date, 4,
                                                   NATCUR,//nacdl.rec.AccFiid,
                                                   sumNatCur, //nacdl.rec.Sum,
                                                   Doc,
                                                   INPCARRY, "", "",
                                                   IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка требований по " + IIF( FD.DealPart == 1,"первой части сделки","второй части сделки") + " при получении маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                   null,
                                                   null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE)
                                                )
                  )
                  return 1;
               end;
            end; 

         elif ( (ALG_DV_SB == FD.GetDoc().rec.Type) or ((ALG_DV_BUY == FD.GetDoc().rec.Type) and FD.IsForward())  )  // Направление сделки -  Продажа-Покупка
            if(GetRestAccountTRH(СчетОбяз, nacdl.rec.Date) == 0)
               return 0;
            end;

            if ( DV_CALCOP_DIRECTION_PAYMENT == nacdl.rec.Direction )      // Оплата  
   
               FD.SetFIIDForCorAccNum(DebFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                СчетОбяз, "СчКорреспГлаваГ",
                                                nacdl.rec.Date, 4,
                                                NATCUR,//nacdl.rec.AccFiid,
                                                sumNatCur, //nacdl.rec.Sum,
                                                Doc,
                                                INPCARRY, "", "",
                                                IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка обязательств по " + IIF( FD.DealPart == 1,"первой части сделки","второй части сделки") + " при оплате маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                null,
                                                null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                             )
               )
                  return 1;
               end;

            elif ( DV_CALCOP_DIRECTION_RECEPTION == nacdl.rec.Direction  ) // Получение 

               FD.SetFIIDForCorAccNum(DebFIID);
               if( not ПроводкаПоКатегориямУчета( FD,
                                                "СчКорреспГлаваГ", СчетОбяз,
                                                nacdl.rec.Date, 4,
                                                NATCUR,//nacdl.rec.AccFiid,
                                                sumNatCur, //nacdl.rec.Sum,
                                                Doc,
                                                INPCARRY, "", "",
                                                IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Переоценка обязательств по " + IIF( FD.DealPart == 1,"первой части сделки","второй части сделки") + " при получении маржи по сделке " +FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),
                                                null,
                                                FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                             )
               )
                  return 1;
               end;
           
            end;
         end;
      end;
   end;
end;

CLASS (TArray) DV_PmGrAccSumCollector

  PRIVATE CLASS PmGrAccSum( _Account:TRecHandler, _Sum:money, _Side:integer, _OldSum:money, _PmGrId )/*PNV 494582*/
     var Account = TRecHandler("account");
     var Sum     = _Sum;
     var Side    = _Side;
     var OldSum = _OldSum;
     var PmGrId = _PmGrId;/*PNV 494582*/

     copy(Account, _Account);
  END;

  MACRO ClearArray()
     this.Size = 0;
  END;

  MACRO ExistAccount( CheckAccount ):bool /*используется в отчёте*/
     var Ex:bool = false;
     var i:integer = 0;

     while( i < this.Size )
        if( this.(i).Account.rec.Account == CheckAccount )
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     return Ex;
  END;

  PRIVATE MACRO _AddData( Account:TRecHandler, Sum:money, Side:integer, _OldSum:money, PmGrId ) /*PNV 494582*/
     var Ex:bool = false;
     var i:integer = 0;
     var OldSum:money = $0.0;

     if( _OldSum != NULL )
        OldSum = _OldSum;
     end;

     while( i < this.Size )
        if( (this.(i).Account.rec.Account == Account.rec.Account) and (this.(i).Side == Side) )
           this.(i).Sum = this.(i).Sum + Sum;
           this.(i).OldSum = this.(i).OldSum + OldSum;
           this.(i).PmGrId = this.(i).PmGrId; /*PNV 494582*/
           Ex = true;
           break;
        end;
        i = i + 1;
     end;

     if( Ex == false )
        this.(this.size) = PmGrAccSum(Account, Sum, Side, OldSum, PmGrId); /*PNV 494582*/
     end;
  END;

  MACRO AddData( DemandAccount:TRecHandler, LiabilityAccount:TRecHandler, DemandSum:money, LiabilitySum:money, Side:integer, DemandOldSum:money, LiabilityOldSum:money, PmGrId ) /*PNV 494582*/
     if( Side == ALG_DV_PMGR_SIDE_UNDEF )
        _AddData(DemandAccount, DemandSum, ALG_DV_PMGR_SIDE_DEMAND, DemandOldSum, PmGrId); /*PNV 494582*/
        _AddData(LiabilityAccount, LiabilitySum, ALG_DV_PMGR_SIDE_LIABILITY, LiabilityOldSum, PmGrId);  /*PNV 494582*/
     elif( Side == ALG_DV_PMGR_SIDE_DEMAND )
        _AddData(DemandAccount, DemandSum, ALG_DV_PMGR_SIDE_DEMAND, DemandOldSum, PmGrId);  /*PNV 494582*/
     elif( Side == ALG_DV_PMGR_SIDE_LIABILITY )
        _AddData(LiabilityAccount, LiabilitySum, ALG_DV_PMGR_SIDE_LIABILITY, LiabilityOldSum, PmGrId);  /*PNV 494582*/
     end;
  END;

  MACRO GetSum( Account:TRecHandler, Side:integer, Sum:@money ):bool
     var RetVal:bool = false;
     var i:integer = 0;

     if( Sum != NULL )
        Sum = 0.0;
     end;

     while( i < this.Size )
        if( (this.(i).Account.rec.Account == Account.rec.Account) and (this.(i).Side == Side) )
           if( Sum != NULL )
              Sum = this.(i).Sum;
           end;
           RetVal = true;
           break;
        end;
        i = i + 1;
     end;

     return RetVal;
  END;
END;

MACRO ПроводкиПоЗачислениюПП( FD, Doc, PmGrAccSum, Дата:date, ReportLineData, PmGr ):integer  /*PNV i-support 488706*/ 
  record CorrAcc(account);
  var DebAcc:string  = "", CredAcc:string = "", GTPmGr;
  var swapTypeName = "";
  if (FD.IsPctSWAP() or FD.IsSwap())
     swapTypeName = FD.PctSwapTypeName(true);
  end;

  /*PNV 494582*/     
  if (PmGrAccSum.Pmgrid != null)
     GTPmGr = DVFirstDocPmGr(DL_DVNDEALPMGR, SQL_ConvTypeInteger(PmGrAccSum.Pmgrid));
     PmGr = GTPmGr.pmgr;
  end;
  /*PNV 494582*/

  if( PmGrAccSum.Sum != $0.0 )
     FD.SetFIIDForCorAccNum(PmGrAccSum.Account.rec.Code_Currency);
     if( not FD.OpenAccount("СчКорреспГлаваГ", null, false, IIF(PmGrAccSum.Side == ALG_DV_PMGR_SIDE_DEMAND,
                                                                FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE),
                                                                FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)),
                            CorrAcc, Дата) )
        return 1;
     end;

     if( PmGrAccSum.Side == ALG_DV_PMGR_SIDE_DEMAND )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           PmGrAccSum.Account, CorrAcc,
                                           Дата, PmGrAccSum.Account.rec.Chapter,
                                           PmGrAccSum.Account.rec.Code_Currency, PmGrAccSum.Sum,
                                           Doc,
                                           INPCARRY, "", "",
                                           //"Постановка требований по процентным платежам на внебалансовый учет по сделке "+ FD.DealCode()
                                          IIF((FD.IsPctSWAP() or FD.IsSwap()), "ПФИ (" + swapTypeName + "). ", "") + "Учет требований по промежуточному платежу за период с " + StrSubSt(String(PmGr.rec.BegDate:f), ".", "/") + " по " + StrSubSt(String(PmGr.rec.EndDate:f), ".", "/") + " по сделке " + FD.DealCode() + " от " + StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Дата исполнения сделки: "+ StrSubSt(String(FD.nFI_BaseActiv.rec.ExecDate:f), ".", "/")+ ". К/агент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*PNV i-support 488706*/ 
                                         )
          )
           return 1;
        end;

        DebAcc  = PmGrAccSum.Account.rec.Account;
        CredAcc = CorrAcc.Account;
     elif( PmGrAccSum.Side == ALG_DV_PMGR_SIDE_LIABILITY )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           CorrAcc, PmGrAccSum.Account,
                                           Дата, PmGrAccSum.Account.rec.Chapter,
                                           null, null,
                                           Doc,
                                           INPCARRY, "", "",
                                           //"Постановка обязательств по процентным платежам на внебалансовый учет по сделке "+ FD.DealCode(),
                                           IIF((FD.IsPctSWAP() or FD.IsSwap()), "ПФИ (" + swapTypeName + "). ", "") + "Учет обязательств по промежуточному платежу за период с " + StrSubSt(String(PmGr.rec.BegDate:f), ".", "/") + " по " + StrSubSt(String(PmGr.rec.EndDate:f), ".", "/") + " по сделке " + FD.DealCode() + " от " + StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Дата исполнения сделки: "+ StrSubSt(String(FD.nFI_BaseActiv.rec.ExecDate:f), ".", "/")+ ". К/агент: "+ DV_GetPartyName (FD.Deal.rec.contractor),/*PNV i-support 488706*/ 
                                           null, null, null, null, null,
                                           PmGrAccSum.Account.rec.Code_Currency, PmGrAccSum.Sum
                                         )
          )
           return 1;
        end;

        DebAcc  = CorrAcc.Account;
        CredAcc = PmGrAccSum.Account.rec.Account;
     end;

     if( ReportLineData != NULL )
        ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                   IIF(PmGrAccSum.Side == ALG_DV_PMGR_SIDE_DEMAND, "Т", "О"),
                                                                   $0.0,
                                                                   GetFICode(PmGrAccSum.Account.rec.Code_Currency, null, FICK_ISOSTRING),
                                                                   DebAcc,
                                                                   CredAcc,
                                                                   PmGrAccSum.Sum
                                                                 );
     end;
  end;

  return 0;
END;

MACRO ПроводкиПоСписаниюПП( FD, Doc, PmGrAccSum, Дата:date, Rest:bool, ReportLineData ):integer

  var Sum:money = $0.0;
  record CorrAcc(account);
  var DebAcc:string  = "", CredAcc:string = "";
  var swapTypeName = "";
  if (FD.IsPctSWAP() or FD.IsSwap())
     swapTypeName = FD.PctSwapTypeName(true);
  end;

  if( Rest )
     Sum = abs(GetRestAccountTRH(PmGrAccSum.Account, Дата));
  else
     Sum = PmGrAccSum.Sum;
  end;

  if( Sum != 0.0 )
     FD.SetFIIDForCorAccNum(PmGrAccSum.Account.rec.Code_Currency);
     if( not FD.OpenAccount("СчКорреспГлаваГ", null, false, IIF(PmGrAccSum.Side == ALG_DV_PMGR_SIDE_DEMAND,
                                                                FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE),
                                                                FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)),
                            CorrAcc, Дата) )
        return 1;
     end;

     if( PmGrAccSum.Side != ALG_DV_PMGR_SIDE_LIABILITY ) /* требование или не задано */
        if( not ПроводкаПоКатегориямУчета( FD,
                                           CorrAcc, PmGrAccSum.Account,
                                           Дата, PmGrAccSum.Account.rec.Chapter,
                                           null, null,
                                           Doc,
                                           INPCARRY, "", "",
                                           IIF((FD.IsPctSWAP() or FD.IsSwap()), "ПФИ (" + swapTypeName + "). ", "") + "Снятие требований по промежуточным платежам по сделке "+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Снятие требований по промежуточным платежам с внебалансового учета",
                                           null, null, null, null, null,
                                           PmGrAccSum.Account.rec.Code_Currency, Sum
                                         )
          )
            return 1;
        end;

        DebAcc  = CorrAcc.Account;
        CredAcc = PmGrAccSum.Account.rec.Account;
     elif( PmGrAccSum.Side != ALG_DV_PMGR_SIDE_DEMAND ) /* обязательство или не задано */
        if( not ПроводкаПоКатегориямУчета( FD,
                                           PmGrAccSum.Account, CorrAcc,
                                           Дата, PmGrAccSum.Account.rec.Chapter,
                                           PmGrAccSum.Account.rec.Code_Currency, Sum,
                                           Doc,
                                           INPCARRY, "", "",
                                           IIF((FD.IsPctSWAP() or FD.IsSwap()), "ПФИ (" + swapTypeName + "). ", "") + "Снятие обязательств по промежуточным платежам по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*///"Снятие обязательств по промежуточным платежам с внебалансового учета"
                                         )
          )
            return 1;
        end;

        DebAcc  = PmGrAccSum.Account.rec.Account;
        CredAcc = CorrAcc.Account;
     end;

     if( ReportLineData != NULL )
        ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                   IIF(PmGrAccSum.Side == ALG_DV_PMGR_SIDE_DEMAND, "Т", "О"),
                                                                   Sum,  /*GetRestAccountTRH т.к. Rest == true*/
                                                                   GetFICode(PmGrAccSum.Account.rec.Code_Currency, null, FICK_ISOSTRING),
                                                                   DebAcc,
                                                                   CredAcc,
                                                                   Sum
                                                                 );
     end;
  end;

  return 0;
END;

MACRO СписаниеТребованияИОбязательстваПП( FD, Doc, ДатаИсполненияШага, Direction:integer, Reject:bool ):integer

  var СчетТреб = TRecHandler("account");
  var СчетОбяз = TRecHandler("account");
  var DebAcc:string  = "";  var DebFIID:integer  = ALLFININSTR;  var DebFiRole  = FIROLE_UNDEF;
  var CredAcc:string = "";  var CredFIID:integer = ALLFININSTR;  var CredFiRole = FIROLE_UNDEF;
  var PmGrAccSum = DV_PmGrAccSumCollector();
  var Query, Data, Sql;
  var mQuery,mSql,mData;
  var GrFD;

  if( not FD.IsClient() )

     ПолучитьСрочныеСчетаВнб(FD, @DebAcc, @DebFIID, @DebFiRole, @CredAcc, @CredFIID, @CredFiRole);

     Sql = " SELECT * " +
           "   FROM ddvnpmgr_dbt " +
           "  WHERE t_DealID  = ? " +
           "    AND (t_DemandAccount != chr(1) or t_LiabilityAccount != chr(1)) ";
     if( not Reject )
        Sql = Sql + " AND t_PayDate = ? " +
                    " AND t_Side    = ? "
     end;

     Query = RSDCommand( Sql );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
     if( not Reject )
        Query.addParam("", RSDBP_IN, ДатаИсполненияШага );
        Query.addParam("", RSDBP_IN, IIF(FD.Deal.rec.Netting_PmGr == UNSET_CHAR, IIF(Direction == DV_CALCOP_DIRECTION_PAYMENT, ALG_DV_PMGR_SIDE_LIABILITY, ALG_DV_PMGR_SIDE_DEMAND), ALG_DV_PMGR_SIDE_UNDEF) );
     end;
     Query.execute();

     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )
        GrFD = DVFirstDocPmGr(DL_DVNDEALPMGR, SQL_ConvTypeInteger(Data.rec.ID));

        if (FD.IsMigrDeal())
          mSql = "SELECT * FROM daccount_dbt a WHERE a.t_account = ?";
          if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_LIABILITY )
            mQuery = RSDCommand(mSql);
            mQuery.addParam("",RSDBP_IN,GrFD.PmGr.rec.DEMANDACCOUNT);
            mQuery.execute();
            mData = TRsbDataSet(mQuery);
            if (mData.MoveNext())
              СчетТреб.clear();
              mData.GetRecord().CopyTo(СчетТреб.rec);
            end;
          elif(GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_DEMAND)
            mQuery = RSDCommand(mSql);
            mQuery.addParam("",RSDBP_IN,GrFD.PmGr.rec.LIABILITYACCOUNT);
            mQuery.execute();
            mData = TRsbDataSet(mQuery);
            if (mData.MoveNext())
              СчетОбяз.clear();
              mData.GetRecord().CopyTo(СчетОбяз.rec);
            end;
          end;
          else

            СчетТреб.Clear();
            if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_LIABILITY ) /* требование или не задано */
               if( not DV_GetAccount(4, FD.ВалютаТребования(), GrFD.PmGr.rec.DemandAccount, СчетТреб, false) )
                  return 1;
               end;
            end;

            СчетОбяз.Clear();
            if( GrFD.PmGr.rec.Side != ALG_DV_PMGR_SIDE_DEMAND ) /* обязательство или не задано */
               if( not DV_GetAccount(4, FD.ВалютаОбязательства(), GrFD.PmGr.rec.LiabilityAccount, СчетОбяз, false) )
                  return 1;
               end;
            end;
          end;  

        if( DV_TransferPm(GrFD.PmGr.rec.ID, ДатаИсполненияШага, date(0,0,0), 
                           GrFD.PmGr.rec.DemandAccount, GrFD.PmGr.rec.LiabilityAccount,
                           DV_PMGR_CHANGE_WITHDRWLBLNCE) )
           return 1;
        end;

        PmGrAccSum.AddData(СчетТреб, СчетОбяз, GrFD.ReqSum(), GrFD.ComSum(), GrFD.PmGr.rec.Side, GrFD.PmGr.rec.id);/*PNV 494582*/
     end;

     var i:integer = 0;
     while( i < PmGrAccSum.Size )
        if( ПроводкиПоСписаниюПП(FD, Doc, PmGrAccSum(i), ДатаИсполненияШага, /*false*/true) != 0 )
           return 1;
        end;
       
        i = i + 1;
     end;
  end;

  return 0;
END;

MACRO АктуализироватьПлатежи( FD:DVFirstDocNDeal, Dat:DATE, EarlySettlementPaymKindAct:integer ):integer
  var AccDt = TRecHandler("account"), AccCt = TRecHandler("account"), /*PNV 522410*/
      PaymentRq, PaymentOb,
      Валюта;
  var Course:double = 0.0;
  var CourceSinceDate:date = date(0,0,0);
  var Сумма:money = $0.0;
  var Accounts = ""; /*PNV 520085*/

  ClearRecord(AccDt);/*PNV 522410*/
  ClearRecord(AccCt);/*PNV 522410*/

  if( (ValType(EarlySettlementPaymKindAct) == V_UNDEF) OR (ValType(EarlySettlementPaymKindAct) == NULL))
    EarlySettlementPaymKindAct = 0; // 1 - обяз, 2 - треб
  end;

  if( FD.ПлатежТреб.rec.PaymentID > 0 )
     PaymentRq = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  end;

  if( FD.ПлатежОб.rec.PaymentID > 0 )
     PaymentOb = RsbPayment(FD.ПлатежОб.rec.PaymentID);
  end;

  if( (FD.ПлатежОб.rec.PaymentID > 0) and ((PaymentOb.PaymStatus != PM_CLOSED_W_M_MOVEMENT) or (FD.ВидБазовогоАктива() == FIKIND_METAL) or FD.IsPctSWAP() )  AND/*PNV 507791 платежи по металлам актуализируем в любом случае*/
      ((EarlySettlementPaymKindAct == 1) OR (EarlySettlementPaymKindAct == 0)) )
     Валюта = IIF( (FD.IsPctSWAP() and (FD.DealPArt == 1)), FD.ВалютаТребования(), FD.ВалютаОбязательства());
   
     if( (FD.IsSWAP() or FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) )
        Валюта = FD.ВалютаРасчётов();   
    end;

      /*PNV*/
     if (FD.ВидБазовогоАктива() == FIKIND_METAL)
         Валюта = IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
     end; 
     /*PNV*/
     if( not FD.IsClient() )
        if ((FD.IsSWAP() or FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.isSale())
           if( not FD.OpenAccount("Выбытие ДМ", null, null, FIROLE_BA, AccCt, Dat, NATCUR, null, null, MC_PAIRACCMODE_MANUAL) )/*CHVA заменил FIROLE_FICOM  на FIROLE_BA */
              return 1;
           end;
   
           if ((FD.ВидБазовогоАктива() == FIKIND_METAL) and (not FD.Биржевая()) )
              ClearRecord(AccDt);
              if( (FD.IsSWAP()) and (FD.DealPArt == 2))
                 if (Dat != FD.ДатаИсполнения()) /*PNV 520085 просто получить номер счета без открытия (для неттинга). Открыт будет в дату исполнения*/
                     Accounts = "";
                     if( not FD.FindNumberAccount( "-Форвард, расчетыДМ", Accounts, null, FIROLE_FICOM, Валюта))
                           return 1;
                    end;
                     AccDt.rec.account = Accounts;  
                     AccDt.rec.code_currency = Валюта; 
                else
                  if( not FD.ReOpenAccount("-Форвард, расчетыДМ", null, null, FIROLE_FICOM, AccDt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
                     return 1;
                  end;
                end;
              else
                  if( not FD.OpenAccount("-Форвард, расчетыДМ", null, null, FIROLE_FICOM, AccDt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
                   return 1;
                end;
              end;
           end;
      /*PNV*/      

           if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, Валюта, DV_RATETYPE_CBR, Dat, false, @CourceSinceDate )) /*PNV 522410*/
              MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задана учетная цена Банка России на дату " + String(Dat));
              return 1;
           else
              Сумма = FD.СуммаОбязательства()*Course;
           end;
           PaymentOb.PayerAmount = Сумма;
        else
           if(FD.IsForward() and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.isBuy())
              if( not FD.OpenAccount("-Форвард, расчетыДМ", null, null, FIROLE_FICOM, AccDt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
                 return 1;
              end;
           else
              if( not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_FICOM, AccDt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
                 return 1;
              end;
           end;
        end;
     else
       if( (not FD.IsAgent()) and  FD.КонтрагентНКЦ() )/*bpv биржевые сделки с НКЦ*/
            if(not FD.OpenAccount("+Биржа", null, false, FIROLE_FICOM, AccCt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL))
               return 1;
            end;
        else
          if ( (FD.ВидАктиваОбязательства() == FIKIND_METAL) and (not FD.Netting()) ) 
             if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, FIROLE_BA, AccCt, null, FD.ДатаСделки())) and
                 (not FD.OpenAccount("Выбытие ДМ", null, false, FIROLE_BA, AccCt, FD.ДатаСделки()))
                )
                return 1;
             end;
           end;
         end;
      end;

     if( not DV_СохранитьСчетаВПлатеже(PaymentOb, FD.ПлатежОб, AccDt, AccCt, FD) )
        MsgBox("Ошибка при сохранении счета в платеже");
        return 1;
     end;
  end;

  if( (FD.ПлатежТреб.rec.PaymentID > 0) and ( (PaymentRq.PaymStatus == PM_CLOSED_W_M_MOVEMENT) or ((FD.ВидБазовогоАктива() == FIKIND_METAL) or FD.IsSWAP()/*FD.IsPctSWAP()*/) )  and/*PNV 507791 платежи по металлам актуализируем в любом случае*/
      ((EarlySettlementPaymKindAct == 2) OR (EarlySettlementPaymKindAct == 0)) )
     ClearRecord(AccCt);/*PNV 522410*/
     ClearRecord(AccDt);/*PNV 522410*/

     Валюта = IIF( (/*FD.IsPctSWAP()*/FD.IsSWAP() and ( FD.DealPArt == 1 )), FD.ВалютаОбязательства(), FD.ВалютаТребования());
    
     if( (FD.IsSWAP() or FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) )
         Валюта = FD.ВалютаРасчётов();   
     end;

     /*PNV*/
     if (FD.ВидБазовогоАктива() == FIKIND_METAL)
         Валюта = IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования())
     end;
     /*PNV*/

     if( not FD.IsClient() )
        if( not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_FIREQ, AccCt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
            return 1;
        end;
     
     if ((FD.ВидБазовогоАктива() == FIKIND_METAL) and (not FD.Биржевая()) )
         ClearRecord(AccCt);
         if( (FD.IsSWAP()) and (FD.DealPArt == 2))
             if (Dat != FD.ДатаИсполнения()) /*PNV 520085 просто получить номер счета без открытия (для неттинга). Открыт будет в дату исполнения*/
                 Accounts = "";
                 if( not FD.FindNumberAccount( "+Форвард, расчетыДМ", Accounts, null, FIROLE_FIREQ, Валюта))
                      return 1;
                 end;
                  AccCt.rec.account = Accounts; 
                  AccCt.rec.code_currency = Валюта;  
             else
              if( not FD.ReOpenAccount("+Форвард, расчетыДМ", null, null, FIROLE_FIREQ, AccCt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
                  return 1;
              end;
             end;
         else
              if( not FD.OpenAccount("+Форвард, расчетыДМ", null, null, FIROLE_FIREQ, AccCt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
               return 1;
            end;
        end;
      end;
      /*PNV*/

      if ((FD.IsSWAP() or FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.isBuy()) 
           if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, Валюта, DV_RATETYPE_CBR, Dat, false, @CourceSinceDate ) )
              MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задан курс ЦБ РФ в "+ПолучитьКодФинИн(Валюта)+" на дату " + String(Dat));
            return 1;
           else
            Сумма = FD.СуммаТребования()*Course;
           end;
           PaymentRq.ReceiverAmount = Сумма;
       end;
     else
        if( (not FD.IsAgent()) and /*FD.КонтрагентБиржа()*/ FD.КонтрагентНКЦ() ) /*bpv */
              if( not FD.OpenAccount("+Биржа", null, false, FIROLE_FIREQ, AccDt, Dat, Валюта, null, null, MC_PAIRACCMODE_MANUAL) )
                 return 1;
              end;
        end;
      end;

     if( not DV_СохранитьСчетаВПлатеже(PaymentRq, FD.ПлатежТреб, AccDt, AccCt, FD) )
        MsgBox("Ошибка при сохранении счета в платеже");
        return 1;
     end;
  end;

  return 0;
END;

PRIVATE MACRO CheckCat(CatCode)
  var check = true;
  if((ValType(CheckCatArr) != V_UNDEF) and (CheckCatArr.size > 0))
    check = false;

    var i = 0;
    while(i < CheckCatArr.size)
      if(CatCode == CheckCatArr[i])
        check = true;
        break;
      end;
      i = i + 1;
    end;
  end;

  return check;
END;

PRIVATE MACRO GetAccount(FD, CatCode, FIRole, recAccount:@variant, ActionDate, FIID)
  var stat = true;
  var findAccount = "";

  if(isPlanMode)
    ClearRecord(recAccount);
    if(CheckCat(CatCode, CheckCatArr) == true)
      stat = FD.FindNumberAccount( CatCode,
                                   findAccount,
                                   false,
                                   FIRole,
                                   FIID
                                 );

      recAccount.Account       = findAccount;
      recAccount.Code_Currency = FIID;
    end;
  else
    stat = FD.OpenAccount( CatCode,
                           null,
                           null,
                           FIRole,
                           recAccount,
                           ActionDate,
                           FIID);
  end;

  return stat;
END;

macro ПроводкаВнебиржВУ( ВидРО, FD, doc, OperDate, Curr, Sum, IsOut:bool ):bool

  record DebAcc ("account.dbt");
  record KredAcc ("account.dbt");

  if( FD.IsClient() and ПИ_ВестиВнутреннийУчет() )
     if( GetAccount(FD, FD.ВУ_ПолучитьКатегориюДебет(ВидРО, IsOut), FD.ВУ_ПолучитьРольФИ(ВидРО, true, IsOut), DebAcc, OperDate, Curr) == false )
        return false;
     end;
     if( GetAccount(FD, FD.ВУ_ПолучитьКатегориюКредит(ВидРО, IsOut), FD.ВУ_ПолучитьРольФИ(ВидРО, false, IsOut), KredAcc, OperDate, Curr) == false )
        return false;
     end;
 
     if( not ПроводкаПоКатегориямУчета( FD, 
                                        DebAcc, 
                                        KredAcc,
                                        OperDate,
                                        FD.ВУ_ОпределениеГлавы(Curr),
                                        Curr,
                                        Sum,
                                        doc,
                                        INPCARRY,
                                        "",
                                        "",
                                        FD.ВУ_ОснованиеПроводки(ВидРО, IsOut),
                                        0,
                                        null, 
                                        null,
                                        Curr, Curr,
                                        null, null, NULL, null,
                                        true,
                                        ВидРО
                                      )
       )
        return false;
     end;
  end;

  return true;
end;

PRIVATE MACRO ПИ_ПроводкаВУПоПлатежуДС( ВидРО:integer, FD, Dat:DATE, Doc, Payment, IsOut:bool ):bool

  var FI = TRecHandler("fininstr.dbt");

  if( FD.IsClient() )
     if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
        if( (FI.rec.FI_Kind == FIKIND_CURRENCY) OR (((ВидРО == 100) OR (ВидРО == 101)) AND (FI.rec.FI_Kind == FIKIND_METAL)))
           if( not ПроводкаВнебиржВУ(ВидРО, FD, Doc, Dat, Payment.BaseFIID, Payment.BaseAmount, IsOut) )
              return false;
           end;
        end;
     end;
  end;

  return true;
END;

PRIVATE MACRO ПИ_ПроводкиПоставкиДрагМеталла(FD, Dat:DATE, Doc):INTEGER
   var Course:double = 0.0;
   var CourceSinceDate:date = date(0,0,0);
   var Сумма:money = $0.0; 
   var Валюта = -1;

   if (FD.IsClient() or FD.IsBuy() or (not( (FD.IsSWAP() or FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) ) ) )
      return 0;
   end;
   if ( FD.DealPArt == 1 )
      if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, NATCUR, DV_RATETYPE_CBR, Dat, false, @CourceSinceDate ) )
         MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задан курс ЦБ РФ в "+ПолучитьКодФинИн(NATCUR)+" на дату " + String(Dat));
         return 1;
      else
         Сумма = FD.СуммаОбязательства()*Course;
         Валюта = NATCUR;
      end;
   else
      Сумма = FD.pm_CA().rec.Amount;
      Валюта = FD.ВалютаРасчётов();
      end;
   if( not ПроводкаПоКатегориямУчета( FD, 
                                      ПИ_КатегорияМнФорвардРПИ(),                     /* Деб */
                                      "Выбытие ДМ",                                   /* Кредит */
                                      Dat,                                            /* Дата */
                                      1,                                              /* Глава */
                                      Валюта,                                         /* Валюта */
                                      Сумма,                                          /* Сумма */
                                      Doc,                                            /* Документ */
                                      INPCARRY,                                       /* Result_Carry */
                                      "",                                             /* Kind_Oper */
                                      "",                                             /* Numb_Document */
                                      "Исполнение обязательств по поставке драг. металла", /* Ground */
                                      NULL, NULL, NULL,
                                      FD.ВалютаРасчётов(),  NATCUR
                                      )
             )
               return 1;
           end;
   
   return 0;

END;

MACRO ИсполнитьОбязательство( FD:DVFirstDocNDeal, Dat:DATE, doc ):INTEGER
  var SumeqPayer = 0, Сумма = 0, Acc = ""; /*PNV*/
  file AccBuff( "account.dbt" );
  var ВидРО = 0;
  var FI = TRecHandler("fininstr.dbt");

  if( FD.ПлатежОб.rec.PaymentID > 0 )
  
     var Payment = RsbPayment(FD.ПлатежОб.rec.PaymentID);

     if( Payment.PaymStatus != PM_CLOSED_W_M_MOVEMENT )
      
        if( FD.СобствБиржеваяСделка() and (FD.БиржеваяСделкаНаВалРынке() or FD.РынокСПФИ()) and ПИ_ПлатежВВалюте(Payment) ) //287822 - исполнение ТО для сделок СПФИ не зависит от признака "Биржевая", т.к. они исполняются в общем клиринге
           if( ПИ_УстановитьСтатусПлатежа(Payment, PM_CLOSED_W_M_MOVEMENT) )
              MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения средств\"" );
              return 1;
           end;
        else
          if( FD.IsSHORTSWAP() and (FD.nFI_.rec.DVP == SET_CHAR) )
              if( (FD.ПлатежТреб.rec.PaymStatus == PM_PREPARING)or
                  (FD.ПлатежТреб.rec.PaymStatus == PM_READIED)
                )
                 MsgBox("Сначала должны быть исполнены требования");
                 return 1;
              end;
          end;
           if (
               ((FD.DealPart == 1) and (GetOprStatus(IIF(FD.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_EARLY_SETTLEMENT, DV_OPERSTATUS_EARLY_SETTLEMENT)) == DV_EARLY_SETT_OPERSTATUS_YES)) or
               ((FD.DealPart == 2) and (GetOprStatus(IIF(FD.Kind == DL_DVDEALT3, DV_OPERSTATUS_T3_EARLY_SETTLEMENT_2, DV_OPERSTATUS_EARLY_SETTLEMENT_2)) == DV_EARLY_SETT_OPERSTATUS_YES))
           )
              if ( АктуализироватьПлатежи(FD, Dat) != 0 )
                 return 1;
              end;
           end;
           if ( ПИ_ПроводкиПоставкиДрагМеталла(FD, Dat, doc) )
              return 1;
           end;
           if ((FD.ВидБазовогоАктива() != FIKIND_METAL) or (FD.IsBuy() and FD.IsForward() and (FD.ВидБазовогоАктива() == FIKIND_METAL))) /*PNV 538954 для сделок с металлом проводки формируются в ПИ_ПроводкиПоставкиДрагМеталла*/
           if( not ПИ_ПроводкаПоПлатежу(FD, Payment, null, Dat) )
              return 1;
           end;
          end;
           if( ПИ_ИсполнитьПлатеж(Payment) )
              return 1;
           end;
           /*PNV*/
           if ( (FD.ВидАктиваОбязательства() == FIKIND_METAL) and (not FD.netting()) and (not FD.Биржевая()) and (FD.Issale()) and ((not FD.IsDealMet()) or (FD.Kind == DL_DVDEALT3)))/*PNV 522410*/
                if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаОбязательства(), Dat, FD.ВалютаОбязательства(), NATCUR, false) )
                    return 1;
                end;
                Сумма  = SumeqPayer; 
    
                /*PNV закрываем остаток со счета 61213* */
                Acc = ПолучитьКоррсчетИзКоррсхемы(FD.ВалютаОбязательства(), IIF( Payment.outCorschem > 0, Payment.outCorschem , ПолучитьКорсхемуПоУмолчанию(Payment.receiverbankid, Payment.basefiid))); 
                if( DV_GetAccount( 1, FD.ВалютаОбязательства(), Acc, AccBuff, true ) == true ) 
                    if( not ПроводкаПоКатегориямУчета( FD,
                                            "Выбытие ДМ", AccBuff, 
                                            Dat, 1,
                                            NATCUR, Сумма,
                                            doc,
                                            INPCARRY,"", "",
                                            "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],
                                            NULL, FIROLE_BA, FIROLE_FIREQ,
                                            NATCUR, FD.ВалютаОбязательства(),
                                            FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                            NULL, NULL, NULL, NULL,
                                            NULL, NULL, NULL, NULL, NULL
                                          )
                              )
                              return 1;
                   end;
                end; 
           end;  
           /*PNV*/
        if( FD.IsClient() AND FD.IsSWAP() AND ((FD.ВидБазовогоАктива() == FIKIND_METAL) OR (FD.ВидБазовогоАктива(true) == FIKIND_METAL)) )
            if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
               if( FI.rec.FI_Kind == FIKIND_CURRENCY)
                  ВидРО = 99;
               elif(FI.rec.FI_Kind == FIKIND_METAL)
                  ВидРО = 101;
               end;
            end;
        else
            ВидРО = 34;
        end;


            if( not ПИ_ПроводкаВУПоПлатежуДС(ВидРО, FD, Dat, doc, Payment, true) )
              return 1;
           end;
        end;
     end;
 end;

  return 0;
END;

MACRO ИсполнитьТребование( FD:DVFirstDocNDeal, Dat:DATE, doc ):INTEGER
  var SumeqPayer = 0, Сумма = 0, Acc = ""; /*PNV*/
  file AccBuff( "account.dbt" );
  var FI = TRecHandler("fininstr.dbt");
  var ВидРО = 0;
  if( FD.ПлатежТреб.rec.PaymentID > 0 )

     var Payment = RsbPayment(FD.ПлатежТреб.rec.PaymentID);

     if( not ПИ_СтутусПлатежИсполнен(Payment.PaymStatus) )
        if( FD.СобствБиржеваяСделка() and (FD.БиржеваяСделкаНаВалРынке() or FD.РынокСПФИ()) and ПИ_ПлатежВВалюте(Payment) ) //287822 - исполнение ТО для сделок СПФИ не зависит от признака "Биржевая", т.к. они исполняются в общем клиринге
           if( ПИ_УстановитьСтатусПлатежа(Payment, PM_CLOSED_W_M_MOVEMENT) )
              MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения средств\"" );
              return 1;
           end;
        else
        if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(Payment) and ПИ_ПлатежКвитуетсяПоВидуФИ(Payment) and (not(FD.БиржеваяСделкаНаВалРынке() or FD.РынокСПФИ())) /*bpv*/ and (not FD.IsClient()) )
           if( Payment.FuturePayerAmount != 0 )
              if( not GetTrue(false, "Плановый платеж "+Payment.PaymentID+" не сквитован полностью. Исполнить требование?") )/*просили не запрещать*//*PNV i-support 504362 по умолчанию - "нет"*/
                return 1;
              end;
           end;
        end;
           if( not ПИ_ПроводкаПоПлатежу(FD, Payment, null, Dat) )
              return 1;
           end;
           /*PNV*/
           if ( (FD.ВидАктиваТребования() == FIKIND_METAL) and (not FD.netting()) and (not FD.Биржевая()) and (FD.Issale()) )
                if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), Dat, FD.ВалютаТребования(), NATCUR, false) )
                    return 1;
                end;
                Сумма  = SumeqPayer; 
    
                /*PNV закрываем остаток со счета 61213* */
                Acc = ПолучитьКоррсчетИзКоррсхемы(FD.ВалютаТребования(), IIF( Payment.inCorschem > 0, Payment.inCorschem, ПолучитьКорсхемуПоУмолчанию(Payment.payerbankid, Payment.basefiid))); 
                if( DV_GetAccount( 1, FD.ВалютаТребования(), Acc, AccBuff, true ) == true ) 
                    if( not ПроводкаПоКатегориямУчета( FD,
                                            "Выбытие ДМ", AccBuff, 
                                            Dat, 1,
                                            NATCUR, Сумма,
                                            doc,
                                            INPCARRY,"", "",
                                            "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],
                                            NULL, FIROLE_BA, FIROLE_FIREQ,
                                            NATCUR, FD.ВалютаТребования(),
                                            FD.ВалютаТребования(), FD.СуммаТребования(),
                                            NULL, NULL, NULL, NULL,
                                            NULL, NULL, NULL, NULL, NULL
                                          )
                              )
                              return 1;
                   end;
                end; 
           end;  
           /*PNV*/

           if( ПИ_ИсполнитьПлатеж(Payment) )
              return 1;
           end;
        end;

        if( FD.IsClient() AND FD.IsSWAP() AND ((FD.ВидБазовогоАктива() == FIKIND_METAL) OR (FD.ВидБазовогоАктива(true) == FIKIND_METAL)))
           if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
              if( FI.rec.FI_Kind == FIKIND_CURRENCY)
                 ВидРО = 99;
              elif(FI.rec.FI_Kind == FIKIND_METAL)
                 ВидРО = 100;
              end;
           end;
        else
           ВидРО = 34;
        end;

           if( not ПИ_ПроводкаВУПоПлатежуДС(ВидРО, FD, Dat, doc, Payment, false) )
              return 1;
           end;
        end;
     end;

  return 0;
END;

MACRO CreateNDealClientNUTXObjects(FD, dat:date, IncomeSum:money, IncomeFIID:integer, SumTax:@money, Comment:string)
  var fin = TRecHandler("fininstr.dbt");
  var NFI = TRecHandler("dvnfi");
  var BaseFI_KIND:integer = FIKIND_ALLFI;
  var Type:integer = DV_NFIType_BaseActiv;
  
  var FactReceiverID = GetFactReceiverForNUTX(FD.Deal.rec.Client);
  
  SumTax  = $0;

  if((DL_UseNUTX() == true) and (FD.IsClient()) and (IsInstNeresForNUTX(FactReceiverID, dat) == true))

    if( FD.Deal.rec.Forvard == SET_CHAR )
       Type = DV_NFIType_Forward;
    end;

    if( FindDVNFI(FD.Deal.rec.ID, Type, NFI) != 0 )
       msgbox("Не найден актив внебиржевой операции (DealID = " + string(FD.Deal.rec.ID) + ", Type = " + string(Type) + ")");
       return 1;
    end;

    var BaseFIID:integer = NFI.rec.FIID;

    if( ПолучитьФинИн( BaseFIID, fin ) != 0 )
       msgbox("Не найден финансовый инструмент FIID = " + string(BaseFIID));
       return 1;
    end;

    if( (FD.Deal.rec.DVKind == DV_CURSWAP) or (FD.Deal.rec.DVKind == DV_PCTSWAP) )
       BaseFI_KIND = FIKIND_CURRENCY;
    elif( fin.rec.FI_KIND == FIKIND_DERIVATIVE )
       BaseFIID = fin.rec.FaceValueFI;
       if( ПолучитьФинИн( BaseFIID, fin ) != 0 )
          msgbox("Не найден финансовый инструмент FIID = " + string(BaseFIID));
          return 1;
       end;
       BaseFI_KIND = fin.rec.FI_KIND;
    else
       BaseFI_KIND = fin.rec.FI_KIND;
    end;

    var SecType = DL_GetNPTXSecType(BaseFIID, true, 1);
    if(SecType == NULL)
      SecType = -1;
    end;

    if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                          ,FD.Deal.rec.Client    // Клиент
                                          ,FactReceiverID        // Фактический получатель дохода
                                          ,NUTXOBJ_DIR_IN        // Направление
                                          ,4                     // Уровень
                                          ,""                    // Признак "Пользовательский"
                                          ,IIF(Comment == "Оплата штрафа", NUTXOBJ_PLUS_26, NUTXOBJ_PLUS_15)       // Вид НДР
                                          ,IncomeSum             // Сумма дохода/расхода
                                          ,IncomeFIID            // Валюта дохода/расхода
                                          ,TXOBJ_KIND1090        // Вид аналитики 1
                                          ,FD.Deal.rec.ID        // Аналитика 1
                                          ,0                     // Вид аналитики 2
                                          ,-1                    // Аналитика 2
                                          ,IIF(BaseFI_KIND == FIKIND_AVOIRISS, TXOBJ_KIND3010, TXOBJ_KIND3020) // Вид аналитики 3
                                          ,BaseFIID              // Аналитика 3
                                          ,0                     // Вид аналитики 4
                                          ,-1                    // Аналитика 4
                                          ,IIF(SecType == -1, 0, TXOBJ_KIND5010)  // Вид аналитики 5
                                          ,SecType               // Аналитика 5
                                          ,TXOBJ_KIND6020                 
                                          ,FD.Deal.rec.ClientContr
                                          ,Comment )             // Комментарий
     )
       MsgBox( "Ошибка при создании объекта НДР" );
       return 1;
    end;

    var Rate = GetTaxRateNUTX(INCOME_KIND_OTHER, dat, FactReceiverID);

    if((IsInstNeresForNUTX(FactReceiverID, dat) == true) and (Rate != 0))

       SumTax = IncomeSum * Rate;

       if(SumTax)

         if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                               ,FD.Deal.rec.Client    // Клиент
                                               ,FactReceiverID        // Фактический получатель дохода
                                               ,NUTXOBJ_DIR_OUT       // Направление
                                               ,5                     // Уровень
                                               ,""                    // Признак "Пользовательский"
                                               ,NUTXOBJ_DUETAX        // Вид НДР
                                               ,SumTax                // Сумма дохода/расхода
                                               ,IncomeFIID            // Валюта дохода/расхода
                                               ,TXOBJ_KIND1090        // Вид аналитики 1
                                               ,FD.Deal.rec.ID        // Аналитика 1
                                               ,0                     // Вид аналитики 2
                                               ,-1                    // Аналитика 2
                                               ,IIF(BaseFI_KIND == FIKIND_AVOIRISS, TXOBJ_KIND3010, TXOBJ_KIND3020) // Вид аналитики 3
                                               ,BaseFIID              // Аналитика 3
                                               ,0                     // Вид аналитики 4
                                               ,-1                    // Аналитика 4
                                               ,IIF(SecType == -1, 0, TXOBJ_KIND5010)  // Вид аналитики 5
                                               ,SecType               // Аналитика 5
                                               ,TXOBJ_KIND6020                 
                                               ,FD.Deal.rec.ClientContr
                                               ,"Налог, подлежащий уплате" )         // Комментарий
         )
           MsgBox( "Ошибка при создании объекта НДР" );
           return 1;
        end;


        if(0 != DL_NUTX_InsertTaxObjectOnStep( dat                   // Дата НДР
                                              ,FD.Deal.rec.Client    // Клиент
                                              ,FactReceiverID        // Фактический получатель дохода
                                              ,NUTXOBJ_DIR_OUT       // Направление
                                              ,6                     // Уровень
                                              ,""                    // Признак "Пользовательский"
                                              ,NUTXOBJ_PAIDTAX       // Вид НДР
                                              ,SumTax                // Сумма дохода/расхода
                                              ,IncomeFIID            // Валюта дохода/расхода
                                              ,TXOBJ_KIND1090        // Вид аналитики 1
                                              ,FD.Deal.rec.ID        // Аналитика 1
                                              ,0                     // Вид аналитики 2
                                              ,-1                    // Аналитика 2
                                              ,IIF(BaseFI_KIND == FIKIND_AVOIRISS, TXOBJ_KIND3010, TXOBJ_KIND3020) // Вид аналитики 3
                                              ,BaseFIID              // Аналитика 3
                                              ,0                     // Вид аналитики 4
                                              ,-1                    // Аналитика 4
                                              ,IIF(SecType == -1, 0, TXOBJ_KIND5010)  // Вид аналитики 5
                                              ,SecType               // Аналитика 5
                                              ,TXOBJ_KIND6020                 
                                              ,FD.Deal.rec.ClientContr
                                              ,"Удержанный налог" )  // Комментарий
         )
           MsgBox( "Ошибка при создании объекта НДР" );
           return 1;
        end;

      end;
    end;
  end;

  return 0;
END;

/*проводка на остаток счета ПФИ, в результате остаток на счете ПФИ должен стать = 0*/
private macro ПроводкиСпсССОпционаВДатуИсп(FD:DVFirstDocNDeal,Doc,nacdl:TRecHandler,ПФИКатегория:string)
   var СчетПФИ = TRecHandler("account"),
       ОстатокПФИ = $0,
       debet:variant, credit:variant;

   if( not FD.OpenAccount( ПФИКатегория, null, false, FIROLE_UNDEF, СчетПФИ, nacdl.rec.Date, NATCUR, null, null, MC_PAIRACCMODE_MANUAL ) )
      return 1;
   end;
   ОстатокПФИ = GetRestAccountTRH(СчетПФИ, nacdl.rec.Date);

   if( ОстатокПФИ > $0. )
      debet  = СчетПФИ;
      credit = "Выбытие ПФИ";
   elif( ОстатокПФИ < $0. )
      debet  = "Выбытие ПФИ";
      credit = СчетПФИ;
   end;

   if( abs(ОстатокПФИ) > $0. )
      if( not ПроводкаПоКатегориямУчета( FD, 
                                         debet,                                                                      /* Деб */
                                         credit,                                                                     /* Кредит */
                                         nacdl.rec.Date,                                                             /* Дата */
                                         1,                                                                          /* Глава */
                                         NATCUR,                                                                     /* Валюта */
                                         abs(ОстатокПФИ),                                                            /* Сумма */
                                         Doc,                                                                        /* Документ */
                                         INPCARRY,                                                                   /* Result_Carry */
                                         "",                                                                         /* Kind_Oper */
                                         "",                                                                         /* Numb_Document */
                                         "Списание СС по сделке "+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /* Ground */
                                         NULL, NULL, NULL,
                                         NATCUR, NATCUR
                                       )
        )
          return 1;
      end;
   end;

   return 0;
end;

MACRO УчетВариационнойМаржи( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler, IsExec:bool ):INTEGER
  VAR СчетФорвардРПИ = TRecHandler("account"),
      СчетПФИ = TRecHandler("account"),
      СчетБиржа = TRecHandler("account"),
      AccNalog = TRecHandler("account"),
      DebAcc = TRecHandler("account"),
      CredAcc = TRecHandler("account"),
      settacc = TRecHandler("settacc"),
      PaySumRUR = $0, SumRUR = $0, PaymentObj:RsbPayment = null, PaymentNalog:RsbPayment,
      SubPurpose:integer = 0, TmpPaymentID:integer = -1,
      ExTax:bool = ((not FD.IsAgent()) and (nacdl.rec.TaxSum > 0)),
      КонтрагентБиржа:bool = FD.биржевая(),
      КонтрагентБиржаВКлиентской:bool = (FD.IsClient() and (not FD.IsAgent()) and FD.КонтрагентБиржа()),
      ОплатаМаржи:bool = (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT),
      DebMcAccDoc = NULL, CredMcAccDoc = NULL,
      SumTax = $0, 
      СоздаватьПлатежПоМарже:bool = (FD.NotCreateMarginPaym() == false),
      PaymentCA:RsbPayment = null, PaySum = $0,
      БиржеваяСделка:bool = (FD.БиржеваяСделка() or FD.РынокСПФИ()), swapTypeName = "";
  var FIROLE;

  if (FD.IsSwap())
     swapTypeName = FD.PctSwapTypeName(true);
  end;


  if( not FD.IsClient() )
     if( not DV_SmartConvertSum(PaySumRUR, nacdl.rec.PaySum, nacdl.rec.Date, nacdl.rec.AccFiid, NATCUR, true) )
        return 1;
     end;

     if( not DV_SmartConvertSum(SumRUR, nacdl.rec.Sum, nacdl.rec.Date, nacdl.rec.AccFiid, NATCUR, true) )
        return 1;
     end;
  end;

  if( ОплатаМаржи ) // оплата
     if( not FD.IsClient() )
        if( nacdl.rec.Sum > 0 )
              if( not ПроводкаПоКатегориямУчета( FD,
                                                 "Расходы ПФИ0", "-ПФИ",
                                                 nacdl.rec.Date,
                                                 1,
                                                 nacdl.rec.AccFiid,
                                                 nacdl.rec.Sum,
                                                 Doc,
                                                 INPCARRY,
                                                 "",
                                                 "",
                                                 IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Начисление вариационной маржи по сделке "+ FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),   /*KEA*/
                                                 null,
                                                 FIROLE_BA, null,
                                                 NATCUR, NATCUR
                                               )
                )
                 return 1;
              end;

           DebMcAccDoc = TRecHandler("mcaccdoc");
/*
           if( not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_FICOM, СчетФорвардРПИ, nacdl.rec.Date, nacdl.rec.AccFiid, null, DebMcAccDoc, MC_PAIRACCMODE_MANUAL) )
              return 1;
           end;
*/
           if (FD.ВидБазовогоАктива == FIKIND_METAL)
               if( not FD.OpenAccount("-Форвард, расчетыДМ", null, null, FIROLE_FICOM, СчетФорвардРПИ, nacdl.rec.Date, nacdl.rec.AccFiid, null, DebMcAccDoc, MC_PAIRACCMODE_MANUAL) )
                  return 1;
              end;
           else
              if( not FD.OpenAccount("-Форвард, расчеты0Б", null, null, FIROLE_FICOM, СчетФорвардРПИ, nacdl.rec.Date, nacdl.rec.AccFiid, null, DebMcAccDoc, MC_PAIRACCMODE_MANUAL) )
                  return 1;
              end;
           end;

           if( not ПроводкаПоКатегориямУчета( FD, 
                                              "Выбытие ПФИ",                                  /* Деб */
                                              СчетФорвардРПИ,                                 /* Кредит */
                                              nacdl.rec.Date,                                 /* Дата */
                                              1,                                              /* Глава */
                                              nacdl.rec.AccFiid,                              /* Валюта */
                                              nacdl.rec.Sum,                                  /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательства по уплате вар. маржи по сделке "+ FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, nacdl.rec.AccFiid
                                            )
             )
               return 1;
           end;
        end;

        /* Списание справедливой стоимости
           если форвард или опцион и учет маржи в дату исполнения*/
        if( (FD.IsOption() and IsExec) or
            (FD.IsForward() and IsExec) )
           if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, nacdl,"-ПФИ") )
              return 1;
           end;
           if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, nacdl,"+ПФИ") )
              return 1;
           end;
        else /*не в дату исполнения*/
           if( not FD.OpenAccount( "-ПФИ", null, false, FIROLE_UNDEF, СчетПФИ, nacdl.rec.Date, NATCUR ) )
              return 1;
           end;
           
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              СчетПФИ,                                                                    /* Деб */
                                              "Выбытие ПФИ",                                                              /* Кредит */
                                              nacdl.rec.Date,                                                             /* Дата */
                                              1,                                                                          /* Глава */
                                              NATCUR,                                                                     /* Валюта */
                                              IIF(IsExec, abs(GetRestAccountTRH(СчетПФИ, nacdl.rec.Date)), SumRUR),       /* Сумма */
                                              Doc,                                                                        /* Документ */
                                              INPCARRY,                                                                   /* Result_Carry */
                                              "",                                                                         /* Kind_Oper */
                                              "",                                                                         /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Списание вариационной маржи по сделке " +FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, NATCUR
                                            )
             )
               return 1;
           end;
        end;
     end;

     if( nacdl.rec.Sum > 0 )
         if ( FD.Deal.rec.Contractor = _NKC )
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              СчетФорвардРПИ,                                  /* Деб */
                                              "Клиринговый счетВ",                             /* Кредит */
                                              nacdl.rec.Date,                                 /* Дата */
                                              1,                                              /* Глава */
                                              nacdl.rec.AccFiid,                              /* Валюта */
                                              nacdl.rec.Sum,                                  /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательства по уплате вар. маржи по сделке "+ FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, nacdl.rec.AccFiid
                                            )
             )
               return 1;
           end;

           if( not ПроводкаПоКатегориямУчета( FD, 
                                              "Клиринговый счетВ",
                                              IIF( (DL_ЕдиныйПулОбеспеченияСобств != 1), "Клиринговый счетР","+Обеспечение"),          /* Кредит */
                                              nacdl.rec.Date,                                 /* Дата */
                                              1,                                              /* Глава */
                                              nacdl.rec.AccFiid,                              /* Валюта */
                                              nacdl.rec.Sum,                                  /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательства по уплате вар. маржи по сделке "+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ /* Ground */
                                              NULL, NULL, FIROLE_FIREQ_BACK,
                                              NATCUR, nacdl.rec.AccFiid
                                            )
             )
               return 1;
           end;
        end; 

        if( КонтрагентБиржаВКлиентской )
           CredMcAccDoc = TRecHandler("mcaccdoc");
           if( not FD.OpenAccount("-Биржа", null, null, null, СчетБиржа, nacdl.rec.Date, nacdl.rec.AccFiid, null, CredMcAccDoc) )
              return 1;
           end;
        end;

        /*для свопов и форвардов при настройке = нет платежа по марже не создаем*/
        if( СоздаватьПлатежПоМарже == true)  //МАА4
           if( DVND_CreatePayment( FD, PM_PURP_MARGA, FD.Kind, FD.Deal.rec.ID,
                                nacdl.rec.Date,
                                IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                                   IIF(FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor), IIF( КонтрагентБиржаВКлиентской, {ourbank}, -1),
                                IIF(ExTax, nacdl.rec.PaySum, nacdl.rec.Sum), nacdl.rec.AccFiid,
                                "Оплата вариационной маржи по сделке "+FD.DealCode(),//ОснованиеСписаниеВариационнойМаржи,
                                IIF(FD.IsClient(), NULL, СчетФорвардРПИ),
                                   IIF(КонтрагентБиржаВКлиентской, СчетБиржа, NULL),
                                FD.Deal.rec.Department, SubPurpose,
                                NULL,
                                @PaymentObj, TmpPaymentID
                              ) != 0 )
            return 1;
        end;
        TmpPaymentID = TmpPaymentID - 1;
        SubPurpose   = SubPurpose + 1;
        end;

        if( ExTax )
           if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, null, FIROLE_UNDEF, AccNalog, nacdl.rec.Date, NATCUR ) )
              return 1;
           end;

           if( DVND_CreatePayment( FD, PM_PURP_TAXINCOME_NJ, FD.Kind, FD.Deal.rec.ID,
                                   nacdl.rec.Date,
                                   IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                                   {ourbank}, {ourbank},
                                   nacdl.rec.TaxSum, NATCUR,
                                   "Удержание налога",
                                   IIF(FD.IsClient(), NULL, СчетФорвардРПИ), AccNalog,
                                   FD.Deal.rec.Department, SubPurpose,
                                   NULL,
                                   @PaymentNalog, TmpPaymentID
                                 ) != 0 )
               return 1;
           end;
           TmpPaymentID = TmpPaymentID - 1;
           SubPurpose   = SubPurpose + 1;
        end;
     end;

  else // получение

           CredMcAccDoc = TRecHandler("mcaccdoc");
           if (FD.ВидБазовогоАктива == FIKIND_METAL)
               if (FD.IsBuy)
                   FIROLE = FIROLE_FIREQ;
               else
                   FIROLE = FIROLE_FICOM;
               end; 
               if( not FD.OpenAccount("+Форвард, расчетыДМ", null, null, FIROLE_FICOM, СчетФорвардРПИ, nacdl.rec.Date, nacdl.rec.AccFiid, null, DebMcAccDoc, MC_PAIRACCMODE_MANUAL) )
                  return 1;
              end;
           else
              if( not FD.OpenAccount("+Форвард, расчеты0Б", null, null, FIROLE_FICOM, СчетФорвардРПИ, nacdl.rec.Date, nacdl.rec.AccFiid, null, DebMcAccDoc, MC_PAIRACCMODE_MANUAL) )
                  return 1;
              end;
           end;
           if ( FD.Deal.rec.Contractor = _NKC )
                if( not ПроводкаПоКатегориямУчета( FD, 
                                              IIF( (DL_ЕдиныйПулОбеспеченияСобств != 1), "Клиринговый счетР", "+Обеспечение"),          /* Кредит */
                                              "Клиринговый счетВ3",
                                              nacdl.rec.Date,                                 /* Дата */
                                              1,                                              /* Глава */
                                              nacdl.rec.AccFiid,                              /* Валюта */
                                              nacdl.rec.Sum,                                  /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение требований по получению вар. маржи по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ /* Ground */
                                              NULL, FIROLE_FIREQ_BACK, NULL,
                                              NATCUR, nacdl.rec.AccFiid
                                            )
                  )
                   return 1;
               end;

               if( not ПроводкаПоКатегориямУчета( FD, 
                                              "Клиринговый счетВ3",
                                              СчетФорвардРПИ,                                /* Кредит */
                                              nacdl.rec.Date,                                 /* Дата */
                                              1,                                              /* Глава */
                                              nacdl.rec.AccFiid,                              /* Валюта */
                                              nacdl.rec.Sum,                                  /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение требований по получению вар. маржи по сделке " + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, nacdl.rec.AccFiid
                                            )
                  )
                  return 1;
               end;
           end; 

          if( not FD.IsClient() )
              if( nacdl.rec.Sum > 0 )
                      if( not ПроводкаПоКатегориямУчета( FD,
                                                 "+ПФИ", "Доходы ПФИ0",
                                                 nacdl.rec.Date,
                                                 1,
                                                 nacdl.rec.AccFiid,
                                                 nacdl.rec.Sum,
                                                 Doc,
                                                 INPCARRY,
                                                 "",
                                                 "",
                                                 IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Начисление вариационной маржи по сделке "+ FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*KEA*/
                                                 null,
                                                 null, FIROLE_BA,
                                                 NATCUR, NATCUR
                                               )
                       )
                       return 1;
                     end;
           
           /*
           CredMcAccDoc = TRecHandler("mcaccdoc");
           if( not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_FIREQ, СчетФорвардРПИ, nacdl.rec.Date, nacdl.rec.AccFiid, null, CredMcAccDoc, MC_PAIRACCMODE_MANUAL) )
              return 1;
           end;
           */
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              СчетФорвардРПИ,                                    /* Деб */
                                              "Выбытие ПФИ",                                     /* Кредит */
                                              nacdl.rec.Date,                                    /* Дата */
                                              1,                                                 /* Глава */
                                              nacdl.rec.AccFiid,                                 /* Валюта */
                                              nacdl.rec.Sum,                                     /* Сумма */
                                              Doc,                                               /* Документ */
                                              INPCARRY,                                          /* Result_Carry */
                                              "",                                                /* Kind_Oper */
                                              "",                                                /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение требований по получению вар. маржи по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /* Ground */
                                              NULL, NULL, NULL,
                                              nacdl.rec.AccFiid, NATCUR
                                            )
             )
               return 1;
           end;
        end;

        /*если опцион и Учет маржи в дату исполнения*/
        if( (FD.IsOption() and IsExec) or
            (FD.IsForward() and IsExec)  )
           if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, nacdl,"-ПФИ") )
              return 1;
           end;
           if( ПроводкиСпсССОпционаВДатуИсп(FD, Doc, nacdl,"+ПФИ") )
              return 1;
           end;
        else  /*если не в дату исполнения*/
           if( not FD.OpenAccount( "+ПФИ", null, false, FIROLE_UNDEF, СчетПФИ, nacdl.rec.Date, NATCUR ) )
              return 1; 
           end;
          
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              "Выбытие ПФИ",                           /* Деб */
                                              СчетПФИ,                                 /* Кредит */
                                              nacdl.rec.Date,                          /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              IIF(IsExec, abs(GetRestAccountTRH(СчетПФИ, nacdl.rec.Date)), SumRUR),/* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Списание вариационной маржи по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, NATCUR
                                            )
             )
               return 1;
           end;

        end;

     end;

     if( nacdl.rec.Sum > 0 )

        if( КонтрагентБиржаВКлиентской )
           DebMcAccDoc = TRecHandler("mcaccdoc");
           if( not FD.OpenAccount("+Биржа", null, null, null, СчетБиржа, nacdl.rec.Date, nacdl.rec.AccFiid, null, DebMcAccDoc) )
              return 1;
           end;
        end;

       /*для свопов и форвардов при настройке = нет платежа по марже не создаем*/
       if( СоздаватьПлатежПоМарже == true ) // МБА4
          if( DVND_CreatePayment( FD, PM_PURP_MARGA, FD.Kind, FD.Deal.rec.ID,
                                nacdl.rec.Date,
                                  IIF(FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor), IIF( КонтрагентБиржаВКлиентской, {ourbank}, -1),
                                IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                                nacdl.rec.PaySum, nacdl.rec.AccFiid,
                                "Получение вариационной маржи по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///ОснованиеПолучениеВариационнойМаржи,
                                  IIF( КонтрагентБиржаВКлиентской, СчетБиржа, NULL),
                                IIF(FD.IsClient(), NULL, СчетФорвардРПИ),
                                FD.Deal.rec.Department, SubPurpose,
                                NULL,
                                @PaymentObj, TmpPaymentID
                              ) != 0 )
            return 1;
        end;
        TmpPaymentID = TmpPaymentID - 1;
        SubPurpose   = SubPurpose + 1;
       end;

       if(CreateNDealClientNUTXObjects(FD, nacdl.rec.Date, nacdl.rec.PaySum, nacdl.rec.AccFiid, @SumTax, "Вариационная маржа") != 0)
         return 1;
       end;

     end;
  end;

  if( nacdl.rec.Sum > 0 )

     if( (СоздаватьПлатежПоМарже == true) and (not БиржеваяСделка) and (PaymentObj != null) and (nacdl.rec.Netting == SET_CHAR) )
        PaymentObj.Netting = SET_CHAR; /* устанавливаем признак участия в неттинге */
     end;

     DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_VM, nacdl.rec.Date );
     if( (СоздаватьПлатежПоМарже == true)
         and (not БиржеваяСделка)
         and (PaymentObj != null)
         and ((ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj)) OR (PaymentObj.Netting == SET_CHAR)) 
       )
        if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_VM(), DV_OPERSTATUS_PAYM_EX) )
           MsgBox("Ошибка при установке статуса <Квитовка/Неттинг платежа по вариационной марже> для операции.");
           return 1;
        end;
     else
        if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_VM(), DV_OPERSTATUS_PAYM_NOTEX) )
           MsgBox("Ошибка при установке статуса <Квитовка/Неттинг платежа по вариационной марже> для операции.");
           return 1;
        end;

        /*для свопов и форвардов при настройке = нет платеж по марже не создаем*/
        if( (СоздаватьПлатежПоМарже == true) and (PaymentObj != null) )
           if( FD.СобствБиржеваяСделка() )
              if( ПИ_УстановитьСтатусПлатежа(PaymentObj, PM_CLOSED_W_M_MOVEMENT) )
                 MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения средств\"" );
                 return 1;
              end;
           else
            if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj, null, null, DebMcAccDoc, CredMcAccDoc, SumTax, nacdl.rec.AccFiid) )
               return 1;
          end;
    
          if( ПИ_ИсполнитьПлатеж(PaymentObj) )
              return 1;
          end;
      end;
      /*  else
           /*выполняем такую же проводку, которую делаем по платежу, когда он есть*/
           if( not FD.СобствБиржеваяСделка() )
             if( FD.IsClient() )
                 DebAcc = FD.СчетКлиента(nacdl.rec.AccFiid);
                 if(DebAcc.rec.AccountID <= 0 )
                    MsgBox( "Не найден счет клиента по сделке" );
                    return 1;
                 end;
              else
                 DebAcc = СчетФорвардРПИ;
              end;
           
              if( КонтрагентБиржаВКлиентской )
                 CredAcc = СчетБиржа;
             elif( FD.IsAgent() )
                 CredAcc = FD.СчетПоДоговору(nacdl.rec.AccFiid,FD.BrokerContrID());
                if(CredAcc.rec.AccountID <= 0 )
                    MsgBox( "Не найден счет посредника по сделке" );
                    return 1;
                end;
           else/*ищем счет контрагента*/
                    if (not FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, FIKIND_CURRENCY, nacdl.rec.AccFiid, PTSK_DV, FD.Kind_Operation(), PM_PURP_MARGA, 0, settacc))
                  ;
              elif (not FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, FIKIND_CURRENCY, nacdl.rec.AccFiid, PTSK_DV, FD.Kind_Operation(), 0, 0, settacc))
                  ;
                    elif (not FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, FIKIND_CURRENCY, nacdl.rec.AccFiid, PTSK_DV, 0, PM_PURP_MARGA, 0, settacc))
                  ;
              elif (not FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, FIKIND_CURRENCY, nacdl.rec.AccFiid, PTSK_DV, 0, 0, 0, settacc))
                  ;
              end;

              if( (settacc.rec.SettAccID <= 0) or (not DV_GetAccount( 1, nacdl.rec.AccFiid, settacc.rec.Account, CredAcc )) )
                 MsgBox( "Не найден счет контрагента по сделке" );
                 return 1;
              end;
           end;

           if( ОплатаМаржи ) // оплата
              if( not ПроводкаПоКатегориямУчета( FD, 
                                                 DebAcc,                               /* Деб */
                                                 CredAcc,                              /* Кредит */
                                                 nacdl.rec.Date,                       /* Дата */
                                                 1,                                    /* Глава */
                                                 nacdl.rec.AccFiid,                    /* Валюта */
                                                 nacdl.rec.PaySum,                     /* Сумма */
                                                 Doc,                                  /* Документ */
                                                 INPCARRY,                             /* Result_Carry */
                                                 "",                                   /* Kind_Oper */
                                                 "",                                   /* Numb_Document */
                                                 ОснованиеСписаниеВариационнойМаржи    /* Ground */
                                               )
                )
                  return 1;
              end;
           else
              if( not ПроводкаПоКатегориямУчета( FD, 
                                                 CredAcc,                              /* Деб */
                                                 DebAcc,                               /* Кредит */
                                                 nacdl.rec.Date,                       /* Дата */
                                                 1,                                    /* Глава */
                                                 nacdl.rec.AccFiid,                    /* Валюта */
                                                 nacdl.rec.PaySum,                     /* Сумма */
                                                 Doc,                                  /* Документ */
                                                 INPCARRY,                             /* Result_Carry */
                                                 "",                                   /* Kind_Oper */
                                                 "",                                   /* Numb_Document */
                                                 ОснованиеПолучениеВариационнойМаржи   /* Ground */
                                               )
                )
                  return 1;
              end;
           end;
        end;*/
     end;
     end;

     if( ОплатаМаржи and ExTax )
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentNalog) )
           return 1;
        end;
     end;

     if( ОплатаМаржи and ExTax )
        if( ПИ_ИсполнитьПлатеж(PaymentNalog) )
           return 1;
        end;
     end;
    /* PNV 514726
     if( БиржеваяСделка )  
        ПереоценкаТребованияИОбязательства(FD, Doc, nacdl);//П
     end;
     */
     if( not ПроводкаВнебиржВУ(28, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.PaySum, ОплатаМаржи) )
        return 1;
     end;
     /*только для валютных свопов делаем переоценку ТО 2 части по сумме ВМ и меняем сумму КА 2ч на сумму ВМ*/
     if( БиржеваяСделка and (FD.IsSWAPNDeal() or FD.IsForward()) )
        var FD_2;

     if( FD.IsSWAPNDeal() )
           FD_2 = DVFirstDocNDeal(FD.Kind, FD.Deal, 2);
        else
           FD_2 = FD;
        end;

        if( FD.IsSWAPNDeal() )  
        ПереоценкаТребованияИОбязательства(FD_2, Doc, nacdl); //П
        /*В плановых платежах ищется  платеж <Контрактив обр.>. Для него корректируется сумма платежа с учетом полученной/уплаченной вариационной маржи*/
        end;
 
        if( (СоздаватьПлатежПоМарже == false) and (FD_2.pm_CA().rec.PaymentID > 0) )
           PaymentCA = RsbPayment(FD_2.pm_CA().rec.PaymentID);
           if( PaymentCA.PaymStatus != PM_CLOSED_W_M_MOVEMENT )
              PaySum = nacdl.rec.PaySum;

              // Для корректировки платежа приводим все суммы в рубли. После расчетов конвертируем полученную сумму платежа в исходную валюту
              var _PaymSumRUR = PaymentCA.OrderAmount;
              var _MargRUR    = PaySum;

              if (  (NATCUR != PaymentCA.OrderFIID) and 
                    (not DV_SmartConvertSum(_PaymSumRUR, _PaymSumRUR, nacdl.rec.Date, PaymentCA.OrderFIID, NATCUR, true))  
                 )
                    return 1;
              end;

              if (  (NATCUR != nacdl.rec.AccFiid) and
                    (not DV_SmartConvertSum(_MargRUR, _MargRUR, nacdl.rec.Date, nacdl.rec.AccFiid, NATCUR, true))
                 )
                     return 1;
              end;
              // Собственно определение суммы платежа с учетом маржи (все расчеты пока рублях)
              if( ОплатаМаржи )
                    if ( PaymentCA.PaymentID == FD_2.ПлатежТреб().rec.PaymentID )
                       _PaymSumRUR =  _PaymSumRUR + _MargRUR;                      
                    else
                        _PaymSumRUR = _PaymSumRUR - _MargRUR;  
                    end;
              else // Получение
                    if ( PaymentCA.PaymentID == FD_2.ПлатежТреб().rec.PaymentID )
                       _PaymSumRUR =  _PaymSumRUR - _MargRUR;
              else
                      _PaymSumRUR =  _PaymSumRUR + _MargRUR;
                    end;
              end;

              PaymentCA.OrderAmount = _PaymSumRUR;

              // Теперь после определения корректировочной суммы платежа конвертируем эту же сумму в исходную валюту
              if ( (NATCUR != PaymentCA.OrderFIID)  and
                   (not DV_SmartConvertSum( /*out*/PaymentCA.OrderAmount,  _PaymSumRUR, nacdl.rec.Date, NATCUR, PaymentCA.OrderFIID, true) )
              )
                  return 1;
              end;

              ActuatePayment(PaymentCA);

              PaymentCA.FutureBaseAmount     = $0;
              PaymentCA.ActuateFutureAmounts(TBA_AMOUNT);
              PaymentCA.ActuateFutureAmounts(TKA_AMOUNT);
              ActuatePayment(PaymentCA);/*иначе сумма к исполнению останется 0, что неверно*/

           end;
        end;
     end;

     if( БиржеваяСделка and (FD.IsSWAP() or FD.IsForward()) )
        var FrVal = TRecHandler("dvnfrval");

        FrVal.rec.DealID       = FD.Deal.rec.Id;
        FrVal.rec.DocKind      = FD.Deal.rec.DocKind;
        FrVal.rec.Date         = nacdl.rec.Date;
        FrVal.rec.FairValueAlg = FD.nFI_BaseActiv.rec.FairValueAlg;

        FrVal.rec.FairValue    = FD.GetLastFrValSum()/*+nacdl.rec.Sum*/;
        var МаржаРуб           = nacdl.rec.Sum;
 
        if(  (NATCUR != nacdl.rec.AccFIID) and 
             (not DV_SmartConvertSum(МаржаРуб, МаржаРуб, nacdl.rec.Date, nacdl.rec.AccFIID, NATCUR, true)) )
         return 1;
       end;
     
        if( ОплатаМаржи )
           FrVal.rec.FairValue    =  FrVal.rec.FairValue - МаржаРуб;
        else
           FrVal.rec.FairValue    =  FrVal.rec.FairValue + МаржаРуб;
        end;

        if( DV_InsertFrVal(FrVal) != 0 )
           MsgBox("Ошибка при вставке записи оценки справедливой стоимости.");
           return 1;
        end;
     end;

  end;

  return 0;
END;

MACRO УчетГарантийногоОбеспечения( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler ):INTEGER
  VAR СчетОД = TRecHandler("account"),
      СчетРасчеты = TRecHandler("account"),
      СчетГарантийный = TRecHandler("account"),
      PaymentObj:RsbPayment,
      OurCat:string = "",
      КонтрагентБиржа:bool = FD.КонтрагентБиржа();
      var ground1, ground2;
  if( not FD.IsClient() )
     if( FD.IsAgent() or (not КонтрагентБиржа) )
        if( nacdl.rec.PayKind == DV_CALCOP_PAYKIND_GUARANT_RAISING ) /* привлечение */
           OurCat = "-ОД";
        else /* nacdl.rec.PayKind == DV_CALCOP_PAYKIND_GUARANT_INVESTMENT размещение */
           OurCat = "+ОД";
        end;

        if( not FD.OpenAccount(OurCat, null, null, FIROLE_SETTL_AGENT, СчетОД, nacdl.rec.Date, nacdl.rec.AccFiid) )
           return 1;
        end;
     else
        if( not FD.IsExistAccount("Гарантийный счет", null, true, null, СчетГарантийный, null, nacdl.rec.Date, nacdl.rec.AccFiid) )
           MsgBox("Ошибка: не открыт счет категории \"Гарантийный счет\" в валюте FIID = " + String(nacdl.rec.AccFiid));
           return 1;
        end;
     end;
  else
     if( КонтрагентБиржа )
        if( not FD.OpenAccount("-Расчеты", null, null, null, СчетРасчеты, nacdl.rec.Date, nacdl.rec.AccFiid) )
           return 1;
        end;
     end;
  end;
  if (FD.IsClient())
    ground1 = "Перечисление денежных средств, полученных ранее в качестве обеспечения для клиента "+FD.ClientCodeByID()+" по договору "+FD.ClientContrName();
    ground2 = "Получение денежных средств, переданных в качестве обеспечения для клиента "+FD.ClientCodeByID()+" по договору "+FD.ClientContrName();
  else
    ground1 = "Перечисление банком денежных средств, полученных ранее в качестве обеспечения";
    ground2 = "Получение денежных средств, переданных в качестве обеспечения";
  end;

  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT ) // оплата

     if( DVND_CreatePayment( FD, PM_PURP_GARANT, FD.Kind, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                             IIF(FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor), IIF(FD.IsClient() and КонтрагентБиржа, {ourbank}, -1),
                             nacdl.rec.PaySum, nacdl.rec.AccFiid,
                             ground1,//"Оплата гарантийного обеспечения",
                             IIF(FD.IsClient(), NULL, IIF(FD.IsAgent() or (not КонтрагентБиржа), СчетОД, СчетГарантийный)),
                             IIF(FD.IsClient() and КонтрагентБиржа, СчетРасчеты, NULL),
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
         return 1;
     end;
  else // получение

     if( DVND_CreatePayment( FD, PM_PURP_GARANT, FD.Kind, FD.Deal.rec.ID, 
                             nacdl.rec.Date,
                             IIF(FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor), IIF(FD.IsClient() and КонтрагентБиржа, {ourbank}, -1),
                             IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                             nacdl.rec.PaySum, nacdl.rec.AccFiid, 
                             ground2,//"Получение гарантийного обеспечения",
                             IIF(FD.IsClient() and КонтрагентБиржа, СчетРасчеты, NULL),
                             IIF(FD.IsClient(), NULL, IIF(FD.IsAgent() or (not КонтрагентБиржа), СчетОД, СчетГарантийный)),
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
         return 1;
     end;
  end;

  DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_GO, nacdl.rec.Date );
  if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj) and (not FD.РынокСПФИ())) /*PNV*/
     if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_GO(), DV_OPERSTATUS_PAYM_EX) )
        MsgBox("Ошибка при установке статуса <Квитовка платежа по учету ГО> для операции.");
        return 1;
     end;
  else
     if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
        return 1;
     end;

     if( ПИ_ИсполнитьПлатеж(PaymentObj) )
        return 1;
     end;
  end;

  if( not ПроводкаВнебиржВУ(IIF(nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT, 18, 19), FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.PaySum) )
     return 1;
  end;

  return 0;
END;

MACRO ВозвратПолучениеДепозитнойМаржи( FD:DVFirstDocNDeal, doc, Dat:DATE ):INTEGER
  var СчетОД_Плюс = TRecHandler("account"),
      СчетОД_Минус = TRecHandler("account"),
      СчетБиржа = TRecHandler("account");
  var RestOD_Minus = $0, RestOD_Plus = $0;
  var Query, Data, FIID = -1;

  if( FD.ВнебиржеваяСделкаСПФИ() )
     Query = RSDCommand( " SELECT t_accfiid " +
                         "   FROM ddvnacdl_dbt " +
                         "  WHERE t_dealid  = ? " +
                         "    AND t_PayKind = ? " +
                         " GROUP BY t_accfiid"
                       );
     Query.NullConversion = true;
     Query.addParam("", RSDBP_IN, FD.Deal.rec.ID );
     Query.addParam("", RSDBP_IN, DV_CALCOP_PAYKIND_GUARANT_MARGIN );
     Query.execute();
     Data = TRsbDataSet(Query);
     while( Data.MoveNext() )
        FIID = SQL_ConvTypeInteger(Data.accfiid);

        RestOD_Minus = $0;
        if( FD.IsExistAccount("-ОД", null, true, FIROLE_FIDOC, СчетОД_Минус, null, Dat, FIID) )
           RestOD_Minus = abs(DL_GetRestAccount( СчетОД_Минус.rec, Dat ));
        end;
       
        RestOD_Plus = $0;
        if( FD.IsExistAccount("+ОД", null, true, FIROLE_FIDOC, СчетОД_Плюс, null, Dat, FIID) )
           RestOD_Plus = abs(DL_GetRestAccount( СчетОД_Плюс.rec, Dat ));
        end;
       
        if( RestOD_Minus > $0 )
           if( (not FD.IsExistAccount("-Биржа", null, true, null, СчетБиржа, null, Dat, СчетОД_Минус.rec.Code_Currency)) and
               (not FD.OpenAccount("-Биржа", null, false, null, СчетБиржа, Dat, СчетОД_Минус.rec.Code_Currency))
             )
              return 1;
           end;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              СчетОД_Минус, СчетБиржа,
                                              Dat,
                                              1,
                                              СчетОД_Минус.rec.Code_Currency,
                                              RestOD_Minus,
                                              Doc,
                                              INPCARRY,
                                              "",
                                              "",
                                              "Возврат ранее полученной депозитной маржи"
                                            )
             )
              return 1;
           end;
        end;
       
        if( RestOD_Plus > $0 )
           if( (not FD.IsExistAccount("+Биржа", null, true, null, СчетБиржа, null, Dat, СчетОД_Плюс.rec.Code_Currency)) and
               (not FD.OpenAccount("+Биржа", null, false, null, СчетБиржа, Dat, СчетОД_Плюс.rec.Code_Currency))
             )
              return 1;
           end;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              СчетБиржа, СчетОД_Плюс,
                                              Dat,
                                              1,
                                              СчетОД_Плюс.rec.Code_Currency,
                                              RestOD_Plus,
                                              Doc,
                                              INPCARRY,
                                              "",
                                              "",
                                              "Получение ранее уплаченной депозитной маржи"
                                            )
             )
              return 1;
           end;
        end;
     end;
  end;

  return 0;
END;

MACRO УчетДепозитнойМаржи( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler ):INTEGER
  var СчетОД_Плюс = TRecHandler("account"),
      СчетОД_Минус = TRecHandler("account"),
      СчетБиржа = TRecHandler("account"),
      PaymentObj:RsbPayment;
  var Ground:string = "";
  var RestOD = $0;
  var bCond: bool = FD.IsSWAPNDeal() or FD.IsForwardNDeal() or FD.IsPctSWAP();

   if (bCond)
     if( (not FD.IsExistAccount("-ОД, СПФИ", null, true, FIROLE_UNDEF, СчетОД_Минус, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
      (not FD.OpenAccount("-ОД, СПФИ", null, false, FIROLE_UNDEF, СчетОД_Минус, nacdl.rec.Date, nacdl.rec.AccFiid))
      )
         return 1;
      end;

      if( (not FD.IsExistAccount("+ОД, СПФИ", null, true, FIROLE_UNDEF, СчетОД_Плюс, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
         (not FD.OpenAccount("+ОД, СПФИ", null, false, FIROLE_UNDEF, СчетОД_Плюс, nacdl.rec.Date, nacdl.rec.AccFiid))
      )
      return 1;
      end;
   else
      if( (not FD.IsExistAccount("-ОД", null, true, FIROLE_FIDOC, СчетОД_Минус, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
         (not FD.OpenAccount("-ОД", null, false, FIROLE_FIDOC, СчетОД_Минус, nacdl.rec.Date, nacdl.rec.AccFiid))
         )
         return 1;
      end;

      if( (not FD.IsExistAccount("+ОД", null, true, FIROLE_FIDOC, СчетОД_Плюс, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
         (not FD.OpenAccount("+ОД", null, false, FIROLE_FIDOC, СчетОД_Плюс, nacdl.rec.Date, nacdl.rec.AccFiid))
         )
         return 1;
      end;
   end;

  if( (not FD.IsExistAccount("Клиринговый счет", null, true, null, СчетБиржа, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
      (not FD.OpenAccount("Клиринговый счет", null, false, null, СчетБиржа, nacdl.rec.Date, nacdl.rec.AccFiid))
       )
        return 1;
     end;
                  
  Ground = FD.GetGround(GROUND_GUARANT_MARGIN);

  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT ) // оплата
     RestOD = abs(DL_GetRestAccount( СчетОД_Минус.rec, nacdl.rec.Date ));

     if( (RestOD == $0) or ((nacdl.rec.Date == FD.ДатаСделки()) and (not bCond)))

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОД_Плюс, СчетБиржа,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           nacdl.rec.Sum,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

     elif( RestOD >= nacdl.rec.Sum )

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОД_Минус, СчетБиржа,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           nacdl.rec.Sum,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

     else/*RestOD < nacdl.rec.Sum*/

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОД_Минус, СчетБиржа,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           RestOD,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОД_Плюс, СчетБиржа,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           (nacdl.rec.Sum - RestOD),
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

     end;

     if( DVND_CreatePayment( FD, PM_PURP_GARANT, FD.Kind, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             {ourbank}, {ourbank},
                             FD.Deal.rec.Contractor, -1,
                             nacdl.rec.Sum, nacdl.rec.AccFiid,
                             Ground,
                             СчетОД_Плюс,
                             СчетБиржа,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
         return 1;
     end;

  else // получение

     RestOD = abs(DL_GetRestAccount( СчетОД_Плюс.rec, nacdl.rec.Date ));

     if( (RestOD == $0) or ((nacdl.rec.Date == FD.ДатаСделки()) and (not bCond)))
        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетБиржа, СчетОД_Минус,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           nacdl.rec.Sum,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

     elif( RestOD >= nacdl.rec.Sum )

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетБиржа, СчетОД_Плюс,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           nacdl.rec.Sum,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

     else/*RestOD < nacdl.rec.Sum*/

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетБиржа, СчетОД_Плюс,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           RestOD,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетБиржа, СчетОД_Минус,
                                           nacdl.rec.Date,
                                           1,
                                           nacdl.rec.AccFiid,
                                           nacdl.rec.Sum - RestOD,
                                           Doc,
                                           INPCARRY,
                                           "",
                                           "",
                                           Ground
                                         )
          )
           return 1;
        end;

     end;

     if( DVND_CreatePayment( FD, PM_PURP_GARANT, FD.Kind, FD.Deal.rec.ID, 
                             nacdl.rec.Date,
                             FD.Deal.rec.Contractor, -1,
                             {ourbank}, {ourbank},
                             nacdl.rec.Sum, nacdl.rec.AccFiid, 
                             Ground,
                             СчетБиржа,
                             СчетОД_Минус,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
         return 1;
     end;
  end;

  DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_GO, nacdl.rec.Date );
  if( ПИ_ИсполнитьПлатеж(PaymentObj) )
     return 1;
  end;
  /*поскольку здесь только для собственных сделок, то проводок ВУ не надо*/
  return 0;
END;

MACRO УчетПроцентовНаДепозитМаржу( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler ):INTEGER
  var СчетБиржа      = TRecHandler("account"),
      СчетПКР        = TRecHandler("account"),
      СчеткПогашению = TRecHandler("account"),
      PaymentObj:RsbPayment,
      bCond: bool    = FD.IsSWAPNDeal() or FD.IsForwardNDeal() or FD.IsPctSWAP();
      
  var Ground1= "Оплата процентов по депозитной марже по сделке "+ FD.Deal.rec.code+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/;
  var Ground2= "Начисление процентов по депозитной марже по сделке "+ FD.Deal.rec.code+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)/*CHVA*/;
  var Ground3= "Получение процентов по депозитной марже по сделке "+ FD.Deal.rec.code+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)/*CHVA*/;

  if ( (not FD.IsExistAccount("Клиринговый счет", null, true, null, СчетБиржа, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
       (not FD.OpenAccount("Клиринговый счет", null, false, null, СчетБиржа, nacdl.rec.Date, nacdl.rec.AccFiid))
     )
    return 1;
  end;

   if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT ) // оплата

      if( (not FD.IsExistAccount( /*"-%Пкр"*/"-%ПкрCSA", null, true, null, СчетПКР, null, nacdl.rec.Date )) and
          (not FD.OpenAccount(/*"-%Пкр"*/"-%ПкрCSA", null, false, null, СчетПКР, nacdl.rec.Date ))
       )
         return 1;
      end;
 //TEG оставим нашу категорию, чтоб все не разлезлось    
// Для валютного свопа создается еще одна пара счетов "-%Пкр"(НацВ) И	"-% к погашению"(ВР)
      /*BIQ-12103 Доп.требования. После уточнения, используем новую КУ "+/-% к погашению, СПФИ" вместо пользовательской доработки "+/-%МС"*/
      if ( bCond )  // bCond = FD.IsSWAPNDeal() or FD.IsForwardNDeal() or FD.IsPctSWAP()
         if( (not FD.IsExistAccount("-% к погашению, СПФИ", null, true, null, СчеткПогашению, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
             (not FD.OpenAccount("-% к погашению, СПФИ", null, false, null, СчеткПогашению, nacdl.rec.Date, nacdl.rec.AccFiid))
         )
            return 1;
         end;

         if(  not ПроводкаПоКатегориямУчета( FD,
                                        СчетПКР, СчеткПогашению,
                                        nacdl.rec.Date,
                                        1,
                                        nacdl.rec.AccFiid,
                                        nacdl.rec.PaySum,
                                        Doc,
                                        INPCARRY,
                                        "",
                                        "",
                                        Ground2
                                      )
         )
            return 1;
         end;
      end; // if ( bCond )

      if ( not ПроводкаПоКатегориямУчета( FD,
                                        IIF(bCond, СчеткПогашению, СчетПКР), СчетБиржа,
                                        nacdl.rec.Date,
                                        1,
                                        nacdl.rec.AccFiid,
                                        nacdl.rec.PaySum,
                                        Doc,
                                        INPCARRY,
                                        "",
                                        "",
                                        Ground1
                                      )
      )
         return 1;
      end;

      if( DVND_CreatePayment( FD, PM_PURP_MARGIN_INTEREST, FD.Kind, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             {ourbank}, {ourbank},
                             FD.Deal.rec.Contractor, -1,
                             nacdl.rec.PaySum, nacdl.rec.AccFiid,
                             Ground1,
                             СчетПКР,
                             СчетБиржа,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
         return 1;
      end;

   else // получение

      if( (not FD.IsExistAccount( /*"+%Пкр"*/"+%ПкрCSA", null, true, null, СчетПКР, null, nacdl.rec.Date )) and
          (not FD.OpenAccount( /*"+%Пкр"*/"+%ПкрCSA", null, false, null, СчетПКР, nacdl.rec.Date  ))
        )
         return 1;
      end;

      // Для валютного свопа создается еще одна пара счетов "+% к погашению"(ВР) & "-%Пкр"(НацВ)
      /*BIQ-12103 Доп.требования. После уточнения, используем новую КУ "+/-% к погашению, СПФИ" вместо пользовательской доработки "+/-%МС"*/
      if ( bCond ) // bCond = FD.IsSWAPNDeal() or FD.IsForwardNDeal() or FD.IsPctSWAP()  
         if ( 
              (not FD.IsExistAccount("+% к погашению, СПФИ", null, true, null, СчеткПогашению, null, nacdl.rec.Date, nacdl.rec.AccFiid)) and
             (not FD.OpenAccount("+% к погашению, СПФИ", null, false, null, СчеткПогашению, nacdl.rec.Date, nacdl.rec.AccFiid))
         )
            return 1;
         end;

         if ( not ПроводкаПоКатегориямУчета( FD,
                                        СчеткПогашению, СчетПКР,
                                        nacdl.rec.Date,
                                        1,
                                        nacdl.rec.AccFiid,
                                        nacdl.rec.PaySum,
                                        Doc,
                                        INPCARRY,
                                        "",
                                        "",
                                        Ground2
                                      )
         )
            return 1;
         end;
      end; //if
 
      if ( not ПроводкаПоКатегориямУчета( FD,
                                        СчетБиржа,   IIF(bCond, СчеткПогашению, СчетПКР),
                                        nacdl.rec.Date,
                                        1,
                                        nacdl.rec.AccFiid,
                                        nacdl.rec.PaySum,
                                        Doc,
                                        INPCARRY,
                                        "",
                                        "",
                                        Ground3
                                      )
      )
         return 1;
      end;

      if( DVND_CreatePayment( FD, PM_PURP_MARGIN_INTEREST, FD.Kind, FD.Deal.rec.ID, 
                             nacdl.rec.Date,
                             FD.Deal.rec.Contractor, -1,
                             IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                             nacdl.rec.PaySum, nacdl.rec.AccFiid, 
                             Ground3,
                             СчетБиржа,
                             СчетПКР,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
         return 1;
      end;

   end;

   DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_GO, nacdl.rec.Date );
   if( ПИ_ИсполнитьПлатеж(PaymentObj) )
      return 1;
   end;
   /*поскольку здесь только для собственных сделок, то проводок ВУ не надо*/
   return 0;
END;

MACRO ПроводкиОплатаПолучениеППНеттинг( FD:DVFirstDocNDeal, Doc, PmGr:TRecHandler, ДатаИсполненияШага, Direction ):INTEGER
  VAR OurAcc  = TRecHandler("account");
  VAR AccFIID = FD.nFI_BaseActiv.rec.PriceFIID;
  var swapTypeName = "";
  if (FD.IsSwap())
     swapTypeName = FD.PctSwapTypeName(true);
  end;

  if( Direction == DV_CALCOP_DIRECTION_PAYMENT ) // оплата
     if( not FD.IsClient() )
        if( PmGr.rec.PaymentSUM > 0 )
           if( not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_FICOM, OurAcc, ДатаИсполненияШага, AccFIID, null, null, MC_PAIRACCMODE_MANUAL ) )
              return 1;
           end;
           // Проводка ЗААа
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              "Выбытие ПФИ",                                  /* Деб */
                                              OurAcc,                                         /* Кредит */
                                              ДатаИсполненияШага,                             /* Дата */
                                              1,                                              /* Глава */
                                              AccFIID,                                        /* Валюта */
                                              PmGr.rec.PaymentSUM,                            /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              //"Отражение суммы обязательства по оплате промежуточного платежа", /* Ground */
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по получению промежуточного платежа по сделке " + FD.Deal.rec.code+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, AccFIID
                                            )
             )
               return 1;
           end;
        end;
     end;
  else // получение
     if( not FD.IsClient() )
        if( PmGr.rec.PaymentSUM > 0 )
           if( not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_FIREQ, OurAcc, ДатаИсполненияШага, AccFIID, null, null, MC_PAIRACCMODE_MANUAL ) )
              return 1;
           end;

           if( not ПроводкаПоКатегориямУчета( FD, 
                                              OurAcc,                                            /* Деб */
                                              "Выбытие ПФИ",                                     /* Кредит */
                                              ДатаИсполненияШага,                                /* Дата */
                                              1,                                                 /* Глава */
                                              AccFIID,                                           /* Валюта */
                                              PmGr.rec.PaymentSUM,                               /* Сумма */
                                              Doc,                                               /* Документ */
                                              INPCARRY,                                          /* Result_Carry */
                                              "",                                                /* Kind_Oper */
                                              "",                                                /* Numb_Document */
                                              //"Отражение суммы требований по получению промежуточного платежа", /* Ground */
                                              "Отражение требований по получению промежуточного платежа по сделке " + FD.Deal.rec.code+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /* Ground */
                                              NULL, NULL, NULL,
                                              AccFIID, NATCUR
                                            )
             )
               return 1;
           end;
        end;
     end;
  end;
  return 0;
END;

private var GTmpPaymentID:integer = -1;
MACRO УчетПромежуточногоПлатежа( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler, KvitNetting:@bool ):INTEGER
  VAR OurAcc  = TRecHandler("account"),
      AccNalog = TRecHandler("account"),
      PaySumRUR = $0, SumRUR = $0, PaymentObj:RsbPayment, PaymentNalog:RsbPayment,
      ExTax:bool = ((not FD.IsAgent()) and (nacdl.rec.TaxSum > 0)),
      SumTax = $0,
      OutPFIBuf = TRecHandler("account");
      var Error,RestOutPFI, ground; /*PNV 504618*/
  
  KvitNetting = false;
  var swapTypeName = "";
  if (FD.IsPctSWAP() or FD.IsSwap())
     swapTypeName = FD.PctSwapTypeName(true);
  end;

  if( not FD.IsClient() )
     if( not DV_SmartConvertSum( PaySumRUR, nacdl.rec.PaySum, nacdl.rec.Date, nacdl.rec.AccFiid, NATCUR, true ) )
        return 1;
     end;

     if( not DV_SmartConvertSum( SumRUR, nacdl.rec.Sum, nacdl.rec.Date, nacdl.rec.AccFiid, NATCUR, true ) )
        return 1;
     end;
  end;
  //mda Меняем логику , если Дата ПП = ДатаИсполнения
  
  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT ) // оплата
     if( not FD.IsClient() )
        if( nacdl.rec.Sum > 0 )
           if( not FD.OpenAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_FICOM, OurAcc, nacdl.rec.Date, nacdl.rec.AccFiid, null, null, MC_PAIRACCMODE_MANUAL ) )
              return 1;
           end;
           if (nacdl.rec.ServOperID != DV_PMGR_NETTING)
              // Проводка ЗААа
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              "Выбытие ПФИ",                                  /* Деб */
                                              OurAcc,                                         /* Кредит */
                                              nacdl.rec.Date,                                 /* Дата */
                                              1,                                              /* Глава */
                                              nacdl.rec.AccFiid,                              /* Валюта */
                                              nacdl.rec.Sum,                                  /* Сумма */
                                              Doc,                                            /* Документ */
                                              INPCARRY,                                       /* Result_Carry */
                                              "",                                             /* Kind_Oper */
                                              "",                                             /* Numb_Document */
                                              IIF((FD.IsPctSWAP() or FD.IsSwap()), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательства по уплате денежных средств по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отражение суммы обязательства по оплате промежуточного платежа", /* Ground */
                                              NULL, NULL, NULL,
                                              NATCUR, nacdl.rec.AccFiid
                                            )
             )
               return 1;
           end;
        end;
   end;
   // Проводка ЗААб

        //mda 17.02.19 В не правильном месте определяем остоток на 616!
        //mda в этот момент по замечанию Банка, сумма проводки должна быть равна SumRUR + остаток на "Выбытие ПФИ"
        /*
        if (not RegVal_СписаниеФинРезЧерезСС())
        if( not ПроводкаПоКатегориямУчета( FD, 
                                           "Расходы ПФИ",                      /* Деб */
                                           "Выбытие ПФИ",                      /* Кредит */
                                           nacdl.rec.Date,                     /* Дата */
                                           1,                                  /* Глава */
                                           NATCUR,                             /* Валюта */
                                              SumRUR,                             /* Сумма */
                                           Doc,                                /* Документ */
                                           INPCARRY,                           /* Result_Carry */
                                           "",                                 /* Kind_Oper */
                                           "",                                 /* Numb_Document */
                                           "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), 
                                           NULL, NULL, NULL,
                                           NATCUR, NATCUR
                                         )
          )
            return 1;
        end;
     end;*/
     end;

     if( nacdl.rec.Sum > 0 )
      /*PNV 504618*/
      ground = " Исполнение обязательств по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor); /*CHVA*///
        if (nacdl.rec.AccFiid != NATCUR)  
            ground = StrUpr("TRANSFER OF FUNDS UNDER FX IRS"  + " " + SubStr (FD.Deal.rec.code,index (FD.Deal.rec.code, ":")+1) + " TRADE DATE " + FD.Deal.rec.date + " VALUE " + StrSubSt(String({curdate}:f ), ".", "/") + "" );/*CHVA*/
        end;
       /*PNV 504618*/

        if( DVND_CreatePayment( FD, PM_PURP_INTERIM, FD.Kind, FD.Deal.rec.ID,
                              nacdl.rec.Date,
                              IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                              IIF( FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor ), -1,
                              IIF( ExTax, nacdl.rec.PaySum, nacdl.rec.Sum ), nacdl.rec.AccFiid,
                              ground, //"Оплата промежуточного платежа", /*PNV 504618*/
                              IIF( FD.IsClient(), NULL, OurAcc ), NULL,
                              FD.Deal.rec.Department, 1,
                              NULL,
                              @PaymentObj, GTmpPaymentID
                              ) != 0 )
            return 1;
        end;
        GTmpPaymentID = GTmpPaymentID - 1;

        if( ExTax )
           if( not FD.OpenAccount( "-Бюджет, ф.налоги", null, null, FIROLE_UNDEF, AccNalog, nacdl.rec.Date, NATCUR ) )
              return 1;
           end;

           if( DVND_CreatePayment( FD, PM_PURP_TAXINCOME_NJ, FD.Kind, FD.Deal.rec.ID,
                                   nacdl.rec.Date,
                                   IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                                   {ourbank}, {ourbank},
                                   nacdl.rec.TaxSum, NATCUR,
                                   "Удержание налога",
                                   IIF( FD.IsClient(), NULL, OurAcc ), AccNalog,
                                   FD.Deal.rec.Department, 2,
                                   NULL,
                                   @PaymentNalog, GTmpPaymentID
                                 ) != 0 )
               return 1;
           end;
           GTmpPaymentID = GTmpPaymentID - 1;
        end;
     end;

  else // получение
     if( not FD.IsClient() )
        if( nacdl.rec.Sum > 0 )
           if( not FD.OpenAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_FIREQ, OurAcc, nacdl.rec.Date, nacdl.rec.AccFiid, null, null, MC_PAIRACCMODE_MANUAL ) )
              return 1;
           end;
           if (nacdl.rec.ServOperID != DV_PMGR_NETTING)
              // Проводка ЗБАа
           if( not ПроводкаПоКатегориямУчета( FD, 
                                              OurAcc,                                            /* Деб */
                                              "Выбытие ПФИ",                                     /* Кредит */
                                              nacdl.rec.Date,                                    /* Дата */
                                              1,                                                 /* Глава */
                                              nacdl.rec.AccFiid,                                 /* Валюта */
                                              nacdl.rec.Sum,                                     /* Сумма */
                                              Doc,                                               /* Документ */
                                              INPCARRY,                                          /* Result_Carry */
                                              "",                                                /* Kind_Oper */
                                              "",                                                /* Numb_Document */
                                              IIF((FD.IsPctSWAP() or FD.IsSwap()), "ПФИ (" + swapTypeName + "). ", "") + "Отражение требований по получению денежных средств по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отражение суммы требований по получению промежуточного платежа", /* Ground */
                                              NULL, NULL, NULL,
                                              nacdl.rec.AccFiid, NATCUR
                                            )
             )
               return 1;
           end;
        end;
        end;

        //mda 17.02.19 В не правильном месте определяем остоток на 616!
        //mda в этот момент по замечанию Банка, сумма проводки должна быть равна SumRUR + остаток на "Выбытие ПФИ"
        /*
        if (not RegVal_СписаниеФинРезЧерезСС())
           // Проводка ЗБАа
        if( not ПроводкаПоКатегориямУчета( FD, 
                                           "Выбытие ПФИ",                      /* Деб */
                                           "Доходы ПФИ",                       /* Кредит */
                                           nacdl.rec.Date,                     /* Дата */
                                           1,                                  /* Глава */
                                           NATCUR,                             /* Валюта */
                                              SumRUR,                             /* Сумма */
                                           Doc,                                /* Документ */
                                           INPCARRY,                           /* Result_Carry */
                                           "",                                 /* Kind_Oper */
                                           "",                                 /* Numb_Document */
                                           "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), 
                                           NULL, NULL, NULL,
                                           NATCUR, NATCUR
                                         )
          )
            return 1;
        end;
     end;*/
     end;

     if( nacdl.rec.Sum > 0 )
        if( DVND_CreatePayment( FD, PM_PURP_INTERIM, FD.Kind, FD.Deal.rec.ID,
                              nacdl.rec.Date,
                              IIF( FD.IsAgent(), FD.Deal.rec.Agent, FD.Deal.rec.Contractor ), -1,
                              IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                              nacdl.rec.PaySum, nacdl.rec.AccFiid,
                              "Получение промежуточного платежа",
                              NULL, IIF( FD.IsClient(), NULL, OurAcc ),
                              FD.Deal.rec.Department, 3,
                              NULL,
                              @PaymentObj, GTmpPaymentID
                              ) != 0 )
            return 1;
        end;
        GTmpPaymentID = GTmpPaymentID - 1;

        if(CreateNDealClientNUTXObjects(FD, nacdl.rec.Date, nacdl.rec.PaySum, nacdl.rec.AccFiid, @SumTax, "Оплата промежуточного платежа") != 0)
          return 1;
        end;

     end;
  end;

  if( nacdl.rec.Sum > 0 )
     if( FD.СобствБиржеваяСделка() )
        if( ПИ_УстановитьСтатусПлатежа( PaymentObj, PM_CLOSED_W_M_MOVEMENT ) )
           MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения\"" );
           return 1;
        end;
     else
     if( nacdl.rec.Netting == SET_CHAR )
        PaymentObj.Netting = SET_CHAR; /* устанавливаем признак участия в неттинге */
        KvitNetting = true;
     end;

     if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj) )/*ставим ожидание квитовки или неттинга*/
        KvitNetting = true;
     end;

     if( not KvitNetting )
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj, NULL, NULL, NULL, NULL, SumTax, nacdl.rec.AccFiid) )
           return 1;
        end;
    
        if( ПИ_ИсполнитьПлатеж( PaymentObj ) )
           return 1;
        end;
     end;

     if( (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT) and ExTax )
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentNalog) )
           return 1;
        end;
     end;

     if( (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT) and ExTax )
        if( ПИ_ИсполнитьПлатеж( PaymentNalog ) )
           return 1;
        end;
     end;

     if( not ПроводкаВнебиржВУ(33, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.Sum-SumTax, (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT)) )
        return 1;
     end;
  end;
  end;

  return 0;
END;

MACRO ВставитьКомиссию( nacdl:TRecHandler, SfContrID:integer ):integer

  var ConCom        = TRecHandler( "sfconcom.dbt" );
  var sfdefcom_parm = TRecHandler( "sfdefcom_parm.rec" );

  if( nacdl.rec.ComID > 0 )
     sfdefcom_parm.rec.CommSum      = (nacdl.rec.PaySum - nacdl.rec.TaxSum);
     sfdefcom_parm.rec.NDSSum       = nacdl.rec.TaxSum;
     sfdefcom_parm.rec.FIID_CalcSum = nacdl.rec.AccFiid;
     sfdefcom_parm.rec.DateEnd      = nacdl.rec.Date;
     sfdefcom_parm.rec.DateBegin    = nacdl.rec.Date;
     FindSfConCom_ByID(nacdl.rec.ComID, ConCom);
     if( SfPeriodOprsCalcCom( GetSfContr(SfContrID),
                              ConCom,
                              null,
                              nacdl.rec.Date,
                              nacdl.rec.Date,
                              0/*SFREP_NONE*/,
                              false,
                              0,
                              null,
                              @sfdefcom_parm,
                              SF_PERIOD_STORE ) != 0 )
        DisplayError();
        return 1;
     end;
  end;

  return 0;
END;

MACRO ОплатаКомиссииПосреднику( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler, IsBankExpenses:bool ):INTEGER
  VAR СчетДебет = TRecHandler("account"),
      СчетКредит = NULL,
      СчетОтнесения = NULL,
      AccNDS = TRecHandler("account"),
      PaymentObj:RsbPayment,
      Sum:money = $0.0,
      НужнаПроводкаНДС:bool = false,
      ContractorID = -1, Ground = "",
      КА_Биржа:bool = FD.КонтрагентНКЦ(), //FD.КонтрагентБиржа(),  /*bpv*/
      ComExpenses:bool = (КА_Биржа and IsBankExpenses),
      Purpose:integer = 0,
      ВидРО = -1;
      var СчётБиржаСобств:string = IIF ( (FD.Deal.rec.MarketKind == DV_MARKETKIND_SPFIMARKET) and (FD.Deal.rec.TypeSPFI == DV_TYPE_SPFI_OTC), "Клиринговый счет", "-Биржа" );
      var SubContrFD;

  record ContrAcc( account );

  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT ) /* оплата */
     
     if ( FD.IsClient() ) /*bpv*/
        SubContrFD = DL_SubContrFD(FD.Deal.rec.ClientContr);
     end;
     
     if( КА_Биржа )
        ContractorID = FD.Deal.rec.Contractor;
        Ground = "Комиссия биржи. Сделка N " + FD.deal.rec.code + " дата " + FD.deal.rec.date;
        Purpose = PM_PURP_COMMARKET;
        ВидРО = 9;
     else
        ContractorID = FD.Deal.rec.Agent;
        Ground = "Оплата комиссии посреднику";
        Purpose = PM_PURP_COMBROKER;
        ВидРО = 12;
     end;

     if( not FD.IsClient() )
        if( КА_Биржа )
           if(FD.IsSWAP())
              if( not FD.OpenAccount(/*"-КВ, к/о"*/"-КВ, КОV", null, null, FIROLE_FICOM, СчетДебет, nacdl.rec.Date, NATCUR) )
                 return 1;
              end;
           else
              if( not FD.OpenAccount(/*"-КВ, др"*/"-КВ, КОV", null, null, FIROLE_FICOM, СчетДебет, nacdl.rec.Date, NATCUR) )
                 return 1;
              end;
           end;
           СчетКредит = TRecHandler("account");
           if( not FD.OpenAccount(СчётБиржаСобств, null, null, null, СчетКредит, nacdl.rec.Date, nacdl.rec.AccFiid) )
              return 1;
           end;
        else
           if( not FD.OpenAccount("-КВ, ц/б", null, null, FIROLE_FICOM, СчетДебет, nacdl.rec.Date, NATCUR) )
              return 1;
           end;
        end;

        Sum = nacdl.rec.PaySum;
        НужнаПроводкаНДС = true;
     else/*клиентские*/
        if( КА_Биржа )
           Ground = "Комиссия биржи. Сделка "+IIF(FD.deal.rec.kind == 32715,"СВОП ", "")+"N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается";
           if(IsBankExpenses) //Отнесение на расходы банка
              var FiRole:integer = 0;
              if(nacdl.rec.AccFiid == NATCUR)
                 FiRole = FIROLE_OPCL_MOEX_NAT;
              else
                 FiRole = FIROLE_OPCL_MOEX_FRG;
              end;
              СчетОтнесения = TRecHandler("account");
              if( not FD.OpenAccount("-КВ, др, кл", null, null, FiRole, СчетОтнесения, nacdl.rec.Date, NATCUR) )
                 return 1;
              end;
              if( not FD.OpenAccount("-Расчеты", null, null, null, СчетДебет, nacdl.rec.Date,nacdl.rec.AccFiid ) )
                 return 1;
              end;
              СчетКредит = TRecHandler("account");
              if( not FD.OpenAccount("+Биржа", null, null, null, СчетКредит, nacdl.rec.Date, nacdl.rec.AccFiid) )
                  return 1;
              end;
           else //Другие клиентские комиссии
              СчетКредит = TRecHandler("account");
              if (not SubContrFD.OpenAccount( "+РасчетыКомисс1", NULL, NULL, СчетКредит, nacdl.rec.Date /*SubContrFD.GetSubContr().rec.DateBegin*/, nacdl.rec.AccFiid ))
                 return 1;
              end;
           /*else //Другие клиентские комиссии
              СчетКредит = TRecHandler("account");
              if( not FD.OpenAccount("-Биржа", null, null, FIROLE_FICOM, СчетКредит, nacdl.rec.Date, nacdl.rec.AccFIID) )
                 return 1;
              end;*/
           end;
        end;
        Sum = nacdl.rec.Sum;
     end;

     if(FD.IsClient() and ComExpenses)
        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОтнесения,              /* Деб */
                                           СчетДебет,                  /* Кредит */
                                           nacdl.rec.Date,             /* Дата */
                                           1,                          /* Глава */
                                           nacdl.rec.AccFiid,          /* Валюта */
                                           Sum,                        /* Сумма */
                                           Doc,                        /* Документ */
                                           INPCARRY,                   /* Result_Carry */
                                           "",                         /* Kind_Oper */
                                           "",                         /* Numb_Document */
                                           "Начисление комиссии биржи. Сделка "+IIF(FD.deal.rec.kind == 32715,"СВОП ", "")+"N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается"  /* Ground */
                                         )
          )
           return 1;
        end;
     end;

     if( DVND_CreatePayment( FD, Purpose, FD.Kind, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             IIF((FD.IsClient() and (not ComExpenses)), FD.Deal.rec.Client, {ourbank}), {ourbank},
                             ContractorID, IIF(СчетКредит != NULL, {ourbank}, -1),
                             Sum, nacdl.rec.AccFiid,
                             Ground,
                             IIF((FD.IsClient() and (not ComExpenses)), NULL, СчетДебет),
                             СчетКредит,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
        return 1;
     end;

     if( НужнаПроводкаНДС and (nacdl.rec.TaxSum > 0) )
        if( (PaymentObj.ReceiverAccount == "") OR ((PaymentObj.ReceiverBankID != {OurBank}) and (PaymentObj.ReceiverBankID > -1)) )
           if( DV_GetAccount(1, nacdl.rec.AccFiid, PaymentObj.FutureReceiverAccount, ContrAcc, false) == false )
              return 1;
           end;
        elif( PaymentObj.ReceiverAccount != "" )
           if( DV_GetAccount(1, nacdl.rec.AccFiid, PaymentObj.ReceiverAccount, ContrAcc, false) == false )
              return 1;
           end;
        else
           msgbox("Не найден счёт "+iif(КА_Биржа,"биржи","посредника"));
           return 1;
        end;

        if( not FD.OpenAccount("+НДС", null, null, FIROLE_UNDEF, AccNDS, nacdl.rec.Date, NATCUR) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccNDS,                    /* Деб */
                                           ContrAcc,                  /* Кредит */
                                           nacdl.rec.Date,            /* Дата */
                                           1,                         /* Глава */
                                           nacdl.rec.AccFiid,         /* Валюта */
                                           nacdl.rec.TaxSum,          /* Сумма */
                                           Doc,                       /* Документ */
                                           INPCARRY,                  /* Result_Carry */
                                           "",                        /* Kind_Oper */
                                           "",                        /* Numb_Document */
                                           "Удержание НДС"            /* Ground */
                                         )
          )
           return 1;
        end;

        if(FD.IsSale() AND FD.IsSWAP())
            if( not ПроводкаВнебиржВУ(17, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.TaxSum, true) )
               return 1;
            end;
        end;
     end;
    
     if( (FD.Deal.rec.DVKind == DV_PCTSWAP) or (FD.Deal.rec.DVKind == DV_OPTION) )
        DL_CalendDefineOprDate(FD, DV_NDEAL_OPRDATE_COMISS_BROKER, nacdl.rec.Date );
     end;

     if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj) )
        if( (FD.Deal.rec.DVKind == DV_PCTSWAP) or (FD.Deal.rec.DVKind == DV_OPTION) )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_COM_BROKER(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Квитовка платежа по учету комиссии посреднику> для операции.");
              return 1;
           end;
        else
           if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_COM(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Квитовка платежа по учету комиссии> для операции.");
              return 1;
           end;
        end;
     else
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
           return 1;
        end;
       
        if( ПИ_ИсполнитьПлатеж( PaymentObj ) )
           return 1;
        end;
     end;
     if(FD.IsClient() and ComExpenses) //По комиссиям ОРБ нет проводки ВУ
     else
        if( not ПроводкаВнебиржВУ(ВидРО, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.Sum, (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT)) )
           return 1;
        end;
     end; 
  end;

  return 0;
END;

MACRO ОплатаКомиссииПосреднику_КО( FD:DVFirstDocFXDeal, Doc, nacdl:TRecHandler, IsBankExpenses:bool ):INTEGER
  VAR СчетДебет = TRecHandler("account"),
      СчетКредит = NULL,
      СчетОтнесения = NULL, 
      AccNDS = TRecHandler("account"),
      ClientAcc306 = TRecHandler("account"), /*bpv*/
      PaymentObj:RsbPayment,
      Sum:money = $0.0,
      НужнаПроводкаНДС:bool = false,
      ContractorID = -1, Ground = "",
      Purpose:integer = 0, ReceiverBankID:integer = -1,
      ВидРО = -1;
      var SubContrFD;
  record ContrAcc(account);
  var IsDealMet = FD.IsDealMet();

  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT ) /* оплата */
     
     if ( FD.IsClient() ) /*bpv*/
        SubContrFD = DL_SubContrFD(FD.Deal.rec.ClientContr);
     end;

     if( FD.Биржевая() and FD.ВалютныйРынок() )
        ContractorID = FD.Deal.rec.Contractor;
        Ground = "Оплата комиссии бирже";
        Purpose = PM_PURP_COMMARKET;
        ReceiverBankID = {ourbank};
        ВидРО = 9;
        if(FD.IsClient() AND IsBankExpenses) //Комиссии ОРБ
           var FiRole:integer = 0;     
           if(nacdl.rec.AccFiid == NATCUR)
              FiRole = FIROLE_OPCL_MOEX_NAT;
           else
              FiRole = FIROLE_OPCL_MOEX_FRG;
           end;
           СчетОтнесения = TRecHandler("account");
           if( not FD.OpenAccount("-КВ, др, кл", null, null, FiRole, СчетОтнесения, nacdl.rec.Date, NATCUR) )
              return 1;
           end;
           if( not FD.OpenAccount("-Расчеты", null, null, null, СчетДебет, nacdl.rec.Date,nacdl.rec.AccFiid ) )
              return 1;
           end;
           СчетКредит = TRecHandler("account");
           if( not FD.OpenAccount("+Биржа", null, null, null, СчетКредит, nacdl.rec.Date, nacdl.rec.AccFiid) )
              return 1;
           end;
           Ground = "Комиссия биржи. Сделка N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается";
        elif ( FD.IsClient() ) //Клиентские комиссии
           СчетКредит = TRecHandler("account");
           if (not SubContrFD.OpenAccount( "+РасчетыКомисс1", NULL, NULL, СчетКредит, nacdl.rec.Date/*SubContrFD.GetSubContr().rec.DateBegin*/, nacdl.rec.AccFiid ))
              return 1;
           end;
           Ground = "Комиссия биржи. Сделка N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается";
        else//Другие биржевые комиссии
           СчетКредит = TRecHandler("account");
           if( not FD.OpenAccount("-Биржа", null, null, FIROLE_FICOM, СчетКредит, nacdl.rec.Date, nacdl.rec.AccFIID) )
              return 1;
           end;
        end;
     else
        if(IsDealMet)
           ContractorID = {ourbank};
           Ground = "Оплата комиссии";
        else
            ContractorID = FD.Deal.rec.Agent;
            Ground = "Оплата комиссии посреднику";
        end;
        Purpose = PM_PURP_COMBROKER;
        ВидРО = 12;
     end;

     if( not FD.IsClient() )
        if(IsDealMet)
            if( not FD.OpenAccount("+Расчеты", null, false, FIROLE_FIREQ, СчетДебет, nacdl.rec.Date, nacdl.rec.AccFiid, null, null, MC_PAIRACCMODE_MANUAL))
               return 1;
            end;
           Sum = nacdl.rec.Sum;
           НужнаПроводкаНДС = false;
        else
           if( not FD.OpenAccount("-КВ, к/о", null, null, FIROLE_FICOM, СчетДебет, nacdl.rec.Date, NATCUR) )
              return 1;
           end;

           Sum = nacdl.rec.PaySum;
           НужнаПроводкаНДС = true;
        end;
     elif ( FD.IsClient() ) /*bpv*/
        if (not SubContrFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, ClientAcc306, nacdl.rec.Date/*SubContrFD.GetSubContr().rec.DateBegin*/, nacdl.rec.AccFiid ))
           return 1;
        end;
        Sum = nacdl.rec.Sum;
     else
        Sum = nacdl.rec.Sum;
     end;

     if(FD.IsClient() and IsBankExpenses and FD.Биржевая() and FD.ВалютныйРынок()) //Только для биржевых комиссий ОРБ
        if( not ПроводкаПоКатегориямУчета( FD,
                                           СчетОтнесения,              /* Деб */
                                           СчетДебет,                  /* Кредит */
                                           nacdl.rec.Date,             /* Дата */
                                           1,                          /* Глава */
                                           nacdl.rec.AccFiid,          /* Валюта */
                                           Sum,                        /* Сумма */
                                           Doc,                        /* Документ */
                                           INPCARRY,                   /* Result_Carry */
                                           "",                         /* Kind_Oper */
                                           "",                         /* Numb_Document */
                                           "Начисление комиссии биржи. Сделка N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается"  /* Ground */
                                         )
          )
           return 1;
        end;
     end;

     if( DVND_CreatePayment( FD, Purpose, DL_DVFXDEAL, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             IIF((FD.IsClient() and (not IsBankExpenses)), FD.Deal.rec.Client, {ourbank}), {ourbank},
                             ContractorID, ReceiverBankID,
                             Sum, nacdl.rec.AccFiid,
                             Ground,
                             IIF((FD.IsClient() and (not IsBankExpenses)), ClientAcc306/* bpv NULL*/, СчетДебет), IIF(/*FD.КонтрагентБиржа()*/FD.КонтрагентНКЦ(), СчетКредит, NULL),
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0 )
        return 1;
     end;

     if( НужнаПроводкаНДС and (nacdl.rec.TaxSum > 0) )

        if( (PaymentObj.ReceiverAccount == "") OR ((PaymentObj.ReceiverBankID != {OurBank}) and (PaymentObj.ReceiverBankID > -1)) )
           if( DV_GetAccount(1, nacdl.rec.AccFiid, PaymentObj.FutureReceiverAccount, ContrAcc, false) == false )
              return 1; 
           end;
        elif( PaymentObj.ReceiverAccount != "" )
           if( DV_GetAccount(1, nacdl.rec.AccFiid, PaymentObj.ReceiverAccount, ContrAcc, false) == false )
              return 1; 
           end;
        else
           msgbox("Не найден счёт "+iif(FD.КонтрагентБиржа(),"биржи","посредника"));
           return 1;
        end;

        if( not FD.OpenAccount("+НДС", null, null, null, AccNDS, nacdl.rec.Date, NATCUR) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccNDS,                    /* Деб */
                                           ContrAcc,                  /* Кредит */
                                           nacdl.rec.Date,            /* Дата */
                                           1,                         /* Глава */
                                           nacdl.rec.AccFiid,         /* Валюта */
                                           nacdl.rec.TaxSum,          /* Сумма */
                                           Doc,                       /* Документ */
                                           INPCARRY,                  /* Result_Carry */
                                           "",                        /* Kind_Oper */
                                           "",                        /* Numb_Document */
                                           "Уплата НДС"               /* Ground */
                                         )
          )
           return 1;
        end;

        if(FD.IsSale() AND IsDVFXDEAL(FD.Group))
            if( not ПроводкаВнебиржВУ(17, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.TaxSum, true) )
               return 1;
            end;
        end;
     end;

     if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
        return 1;
     end;
     
     if( ПИ_ИсполнитьПлатеж( PaymentObj ) )
        return 1;
     end;
     if(FD.IsClient() and IsBankExpenses and FD.Биржевая() and FD.ВалютныйРынок()) //По комиссиям ОРБ нет проводки ВУ
     else
        if( not ПроводкаВнебиржВУ(ВидРО, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.Sum, (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT)) )
           return 1;
        end;
     end;
  end;

  return 0;
END;

MACRO ОплатаКомиссииБанку( FD:DVFirstDocNDeal, Doc, nacdl:TRecHandler ):INTEGER
  VAR OurAcc = TRecHandler("account"),
      AccNDS = TRecHandler("account"),
      ClientAcc306 = TRecHandler("account"),/*BPV*/
      ClientAcc47423 = TRecHandler("account"),/*BPV*/
      PaymentObj:RsbPayment;
  record ClientAcc(account);

  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_RECEPTION ) // получение
/*     if( not FD.OpenAccount("+КВ, ц/б", null, null, FIROLE_COMISS_CLIENT, OurAcc, nacdl.rec.Date, NATCUR) )
        return 1;
     end;*/
     var SubContrFD = DL_SubContrFD(FD.Deal.rec.ClientContr);
     if (not SubContrFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, ClientAcc306, nacdl.rec.Date/*SubContrFD.GetSubContr().rec.DateBegin*/, nacdl.rec.AccFiid ))
        return 1;
     end;
     /*bpv*/
     if( not FD.OpenAccount( "+РасчетыКомисс1", null, null, FIROLE_UNDEF, ClientAcc47423, nacdl.rec.Date, nacdl.rec.AccFiid ) )
        return 1;
     end;
     /*bpv*/


     if( DVND_CreatePayment( FD, PM_PURP_COMMBANK, FD.Kind, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             IIF( FD.IsClient(), FD.Deal.rec.Client, {ourbank} ), {ourbank},
                             {ourbank}, {ourbank},
                             nacdl.rec.PaySum, nacdl.rec.AccFiid,
                             "Комиссия брокера. Сделка СВОП N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается",
                             // bpv NULL, OurAcc,
                             ClientAcc306, ClientAcc47423,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0
       )
        return 1;
     end;

     if( nacdl.rec.TaxSum > 0 )

        if( (PaymentObj.PayerAccount == "") OR ((PaymentObj.PayerBankID != {OurBank}) and (PaymentObj.PayerBankID > -1)) )
           if( DV_GetAccount( 1, nacdl.rec.AccFiid, PaymentObj.FuturePayerAccount, ClientAcc, false ) == false )
              return 1; 
           end;
        elif( PaymentObj.PayerAccount != "" )
           if( DV_GetAccount( 1, nacdl.rec.AccFiid, PaymentObj.PayerAccount, ClientAcc, false ) == false )
              return 1; 
           end;
        else
           msgbox("Не найден счёт клиента");
           return 1;
        end;

        if( not FD.OpenAccount("-НДС", null, null, FIROLE_UNDEF, AccNDS, nacdl.rec.Date, NATCUR) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                           ClientAcc,                 /* Деб */
                                           AccNDS,                    /* Кредит */
                                           nacdl.rec.Date,            /* Дата */
                                           1,                         /* Глава */
                                           nacdl.rec.AccFiid,         /* Валюта */
                                           nacdl.rec.TaxSum,          /* Сумма */
                                           Doc,                       /* Документ */
                                           INPCARRY,                  /* Result_Carry */
                                           "",                        /* Kind_Oper */
                                           "",                        /* Numb_Document */
                                           "Удержание НДС"            /* Ground */
                                         )
          )
           return 1;
        end;
     end;

     if( (FD.Deal.rec.DVKind == DV_PCTSWAP) or (FD.Deal.rec.DVKind == DV_OPTION) )
        DL_CalendDefineOprDate(FD,DV_NDEAL_OPRDATE_COMISS_BANK, nacdl.rec.Date);
     end;

     if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj) )
        if( (FD.Deal.rec.DVKind == DV_PCTSWAP) or (FD.Deal.rec.DVKind == DV_OPTION) )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_COM_BANK(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Квитовка платежа по учету комиссии банку> для операции.");
              return 1;
           end;
        else
           if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_COM(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Квитовка платежа по учету комиссии> для операции.");
              return 1;
           end;
        end;
     else
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
           return 1;
        end;

        if( ПИ_ИсполнитьПлатеж(PaymentObj) )
           return 1;
        end;
     end;

     if( not ПроводкаВнебиржВУ(8, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.Sum, (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT)) )
        return 1;
     end;
  end;

  return 0;
END;

MACRO ОплатаКомиссииБанку_КО( FD:DVFirstDocFXDeal, Doc, nacdl:TRecHandler ):INTEGER
  VAR OurAcc = TRecHandler("account"),
      AccNDS = TRecHandler("account"),
      ClientAcc306 = TRecHandler("account"),/*BPV*/
      ClientAcc47423 = TRecHandler("account"),/*BPV*/
      PaymentObj:RsbPayment;
  record ClientAcc(account);
  var IsDealMet = FD.IsDealMet();

  if( nacdl.rec.Direction == DV_CALCOP_DIRECTION_RECEPTION ) // получение
     if(IsDealMet)
         if( not FD.OpenAccount("-Расчеты", null, false, FIROLE_FICOM, OurAcc, nacdl.rec.Date, nacdl.rec.AccFiid, null, null, MC_PAIRACCMODE_MANUAL))
            return 1;
         end;
     else
        var SubContrFD = DL_SubContrFD(FD.Deal.rec.ClientContr);
        if (not SubContrFD.OpenAccount( "ДС клиента, ц/б", NULL, NULL, ClientAcc306, nacdl.rec.Date/*SubContrFD.GetSubContr().rec.DateBegin*/, nacdl.rec.AccFiid ))
       //     if( not FD.OpenAccount("+КВ, к/о", null, null, FIROLE_COMISS_CLIENT, OurAcc, nacdl.rec.Date, NATCUR) )
                 return 1;
            end;
           /*bpv*/
          if( not FD.OpenAccount( "+РасчетыКомисс1", null, null, FIROLE_UNDEF, ClientAcc47423, nacdl.rec.Date, nacdl.rec.AccFiid ) )
              return 1;
          end;
          /*bpv*/
    end;

     if( DVND_CreatePayment( FD, PM_PURP_COMMBANK, DL_DVFXDEAL, FD.Deal.rec.ID,
                             nacdl.rec.Date,
                             IIF(FD.IsClient(), FD.Deal.rec.Client, {ourbank}), {ourbank},
                             {ourbank}, {ourbank},
                             iif(IsDealMet, nacdl.rec.Sum, nacdl.rec.PaySum), nacdl.rec.AccFiid,
                             "Комиссия брокера. Сделка N " + FD.deal.rec.code + " от " + FD.deal.rec.date + " по брокерскому договору N " + FD.ClientDBOContrName() + " от " + FD.ClientDBOContrDate() + ". НДС не облагается",
                             /*NULL*/ ClientAcc306, ClientAcc47423,
                             FD.Deal.rec.Department, NULL, NULL,
                             @PaymentObj
                           ) != 0
       )
        return 1;
     end;

     if( (nacdl.rec.TaxSum > 0) and (not IsDealMet))

        if( (PaymentObj.PayerAccount == "") OR ((PaymentObj.PayerBankID != {OurBank}) and (PaymentObj.PayerBankID > -1)) )
           if( DV_GetAccount(1, nacdl.rec.AccFiid, PaymentObj.FuturePayerAccount, ClientAcc, false) == false )
              return 1;
           end;
        elif( PaymentObj.PayerAccount != "" )
           if( DV_GetAccount(1, nacdl.rec.AccFiid, PaymentObj.PayerAccount, ClientAcc, false) == false )
              return 1;
           end;
        else
           msgbox("Не найден счёт клиента");
           return 1;
        end;

        if( not FD.OpenAccount("-НДС", null, null, null, AccNDS, nacdl.rec.Date, NATCUR) )
           return 1;
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                           ClientAcc,                 /* Деб */
                                           AccNDS,                    /* Кредит */
                                           nacdl.rec.Date,            /* Дата */
                                           1,                         /* Глава */
                                           nacdl.rec.AccFiid,         /* Валюта */
                                           nacdl.rec.TaxSum,          /* Сумма */
                                           Doc,                       /* Документ */
                                           INPCARRY,                  /* Result_Carry */
                                           "",                        /* Kind_Oper */
                                           "",                        /* Numb_Document */
                                           "Удержание НДС"            /* Ground */
                                         )
          )
           return 1;
        end;
     end;
     /*
     if( (FD.Deal.rec.DVKind == DV_PCTSWAP) or (FD.Deal.rec.DVKind == DV_OPTION) )
        DL_CalendDefineOprDate(FD,DV_NDEAL_OPRDATE_COMISS_BANK, nacdl.rec.Date);
     end;

     if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj) )
        if( (FD.Deal.rec.DVKind == DV_PCTSWAP) or (FD.Deal.rec.DVKind == DV_OPTION) )
           if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_COM_BANK(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Квитовка платежа по учету комиссии банку> для операции.");
              return 1;
           end;
        else
           if( not InsertOprStatus(FD.DV_OPERSTATUS_KVIT_PAYM_COM(), DV_OPERSTATUS_PAYM_EX) )
              MsgBox("Ошибка при установке статуса <Квитовка платежа по учету комиссии> для операции.");
              return 1;
           end;
        end;
     else
     */
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
           return 1;
        end;

        if( ПИ_ИсполнитьПлатеж(PaymentObj) )
           return 1;
        end;
     //end;

     if( not ПроводкаВнебиржВУ(8, FD, Doc, nacdl.rec.Date, nacdl.rec.AccFiid, nacdl.rec.Sum, (nacdl.rec.Direction == DV_CALCOP_DIRECTION_PAYMENT)) )
        return 1;
     end;
  end;

  return 0;
END;

MACRO DV_GetPmGrOnDate( DealID:integer, PayDate:date, Side:integer, PmGr:@TRecHandler ):bool
  var RetVal:bool = false;
  var Query, Data, Sql;

  if( PmGr != null )
     PmGr.Clear();
  end;

  Sql = " SELECT * " +
        "   FROM ddvnpmgr_dbt  " +
        "  WHERE t_DealID  = ? " +
        "    AND t_PayDate = ? " +
        "    AND t_Side    = (case when ? = -1 then t_Side else ? end) ";
  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID );
  Query.addParam("", RSDBP_IN, PayDate );
  Query.addParam("", RSDBP_IN, Side );
  Query.addParam("", RSDBP_IN, Side );
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     if( PmGr != null )
        Data.GetRecord().CopyTo(PmGr.rec);
     end;
     RetVal = true;
  end;

  return RetVal;
END;

MACRO ОтражениеКонверсионнойОперацииВБалансе( FD, doc, ДатаИсполненияШага ):integer
  var pmgr1 = TRecHandler("dvnpmgr");
  var pmgr2 = TRecHandler("dvnpmgr");
  var AccDeb = TRecHandler("account");
  var AccCred = TRecHandler("account");

  if( ((FD.ВидБазовогоАктива() == FIKIND_CURRENCY) or (FD.ВидБазовогоАктива() == FIKIND_METAL)) and (FD.IsClient() == false) )

     var FrValSum:money = FD.GetLastFrValSum();
     var SideTransaction:integer = ACCTRN_SIDE_NONE;
     var ExRateExtra:money = 0;
    var ВалютаДебет:integer = ALLFININSTR, ВалютаКредит:integer = ALLFININSTR;
     var СуммаДебет:money = $0.0, СуммаКредит:money = $0.0;

     var LPPSum:money = 0;
     var DPPSum:money = 0;
     //Обязательство
     if ( (FD.IsPctSWAP()) and (FD.ДатаИсполнения() == ДатаИсполненияШага) and (FD.ПоставочныйКонтракт()))
       if( DV_GetPmGrOnDate(FD.Deal.rec.ID, ДатаИсполненияШага, 1, pmgr1) == true )
          LPPSum = pmgr1.rec.PaymentSum;
       end;
       //Требование
       if( DV_GetPmGrOnDate(FD.Deal.rec.ID, ДатаИсполненияШага, 2, pmgr2) == true )
          DPPSum = pmgr2.rec.PaymentSum;
       end;
     end;

     if( FD.IsSWAP() and (FD.ВидБазовогоАктива() == FIKIND_METAL) )/*эту ветку для свопа пока оставляю, думаю, своп должен пойти в следующую, но ответа аналитика пока нет*/
        ВалютаДебет = ВалютаКредит = FD.ВалютаРасчётов();
        СуммаДебет  = СуммаКредит  = FD.pm_CA().rec.Amount;
     elif( (/*FD.IsSWAP() or */FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.NotCreateMarginPaym() )
        СуммаДебет   = FD.pm_CA().rec.Amount;
        СуммаКредит  = NULL; 
        ВалютаДебет  = iif(FD.pm_CA().rec.PaymentID == FD.ПлатежТреб().rec.PaymentID,FD.ВалютаТребования(),FD.ВалютаОбязательства());
        ВалютаКредит = iif(FD.pm_CA().rec.PaymentID == FD.ПлатежОб().rec.PaymentID,FD.ВалютаОбязательства(),FD.ВалютаТребования());
     elif( (FD.IsSWAP() or FD.IsForward()) and (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) and FD.NotCreateMarginPaym() )
        СуммаДебет   = FD.ПлатежТреб().rec.OrderAmount;
        СуммаКредит  = FD.ПлатежОб().rec.OrderAmount; 
        ВалютаДебет  = FD.ВалютаТребования();
        ВалютаКредит = FD.ВалютаОбязательства();
     else
        СуммаДебет   = FD.СуммаТребования();
        СуммаКредит  = FD.СуммаОбязательства();
        ВалютаДебет  = FD.ВалютаТребования();
        ВалютаКредит = FD.ВалютаОбязательства();
     end;

	 FrValSum = FrValSum - FD.ПолучитьНакопВарМаржу();

         if( FD.IsBuy() )
             SideTransaction = ACCTRN_SIDE_DEBET;   ExRateExtra = FrValSum;
         elif( FD.IsSale() )
             SideTransaction = ACCTRN_SIDE_CREDIT;  ExRateExtra = -FrValSum;
         end;
   //TEG29.01.19 изза того что металлические 47407/08 ОТКРЫВАЕМ В КОНТРВАЛЮТЕ
   if (FD.ВидБазовогоАктива() != FIKIND_METAL) 
      //mda 14/02/19 Начинаем менять бух учет , по письму Саранцева от 12.02
     if ( FD.БивалютнаяСделка() ) //Разновалютная сделка, без рублей
     if( not ПроводкаПоКатегориямУчета( FD,
                                        ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(),
                                        ДатаИсполненияШага, 1,
                                        ВалютаДебет, СуммаДебет,
                                        doc,
                                        INPCARRY, "", "",
                                        IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"),FD.GetGround(9) ,"Отражение требований и обязательств по уплате и получению денежных средств "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/),
                                        NULL,
                                        FIROLE_FIREQ, FIROLE_FICOM,
                                        ВалютаДебет, ВалютаКредит,
                                        ВалютаКредит, СуммаКредит,
                                        NULL, NULL, NULL, NULL,
                                        SideTransaction, ExRateExtra,
                                        MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                        null,null,null,null,null,null,null,null,iif(FD.Deal.rec.Kind == 22710, false, true)
                                        
                                      )
       )
        return 1;
       end;
      else
        if( not ПроводкаПоКатегориямУчета( FD,
                                          ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(),
                                          ДатаИсполненияШага, 1,
                                          ВалютаДебет, СуммаДебет,
                                          doc,
                                          INPCARRY, "", "",
                                          IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"),FD.GetGround(9) ,"Отражение требований и обязательств по уплате и получению денежных средств "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/),
                                          NULL,
                                          FIROLE_FIREQ, FIROLE_FICOM,
                                          ВалютаДебет, ВалютаКредит,
                                          iif(СуммаКредит!=NULL,ВалютаКредит,NULL), СуммаКредит, NULL, NULL, NULL, NULL,
                                          SideTransaction, ExRateExtra,
                                          MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                          null,null,null,null,null,null,null,null,iif((FD.IsSWAP() and (FD.Deal.rec.Kind != 22710)) or ((FD.IsPctSWAP() AND (FD.Deal.rec.SwapType != DLSWAP_XCCY)) or FD.IsForward() or FD.IsOption()),true,null) //mda 16/02/19 добавим процентный своп.
                                        )
         )
          return 1;
       end;
     end;
   else //TEG29.01.19 изза того что металлические 47407/08 ОТКРЫВАЕМ В КОНТРВАЛЮТЕ
      var ВалютаТребования, ВалютаОбязательства;
     /*PNV*/
      var Categdeb = "+Форвард, расчетыДМ";
      var CategCred = "-Форвард, расчетыДМ";
      var СуммаТребования =  FD.СуммаТребования();
      
      if ( FD.Биржевая() and FD.isbuy() )
           CategCred = ПИ_КатегорияМнФорвардРПИ();
      elif ( FD.Биржевая() and FD.issale() )
           Categdeb = ПИ_КатегорияПлФорвардРПИ();
      end;
     /*PNV*/
      if( FD.IsBuy() )
          ВалютаТребования = FD.ВалютаОбязательства(); 
          ВалютаОбязательства = FD.ВалютаОбязательства();
          СуммаТребования  = FD.СуммаОбязательства();
      elif( FD.IsSale() )
          ВалютаТребования = FD.ВалютаТребования(); 
          ВалютаОбязательства = FD.ВалютаТребования();
          СуммаТребования  = FD.СуммаТребования();
     end;

     if (not FD.Биржевая())
         if( not FD.ReOpenAccount(Categdeb, null, null, FIROLE_FIREQ, AccDeb, ДатаИсполненияШага, ВалютаТребования) )
             return 1;
         end;  
         if( not FD.ReOpenAccount(CategCred, null, null, FIROLE_FICOM, AccCred, ДатаИсполненияШага, ВалютаОбязательства) )
             return 1;
         end;
         if( not ПроводкаПоКатегориямУчета( FD,
                                        AccDeb, AccCred, /*PNV*/
                                        ДатаИсполненияШага, 1,
                                        ВалютаТребования, IIF(DPPSum != 0,СуммаТребования + DPPSum,СуммаТребования),
                                        doc,
                                        INPCARRY, "", "",
                                        IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"),FD.GetGround(9) ,"Отражение требований и обязательств по уплате и получению денежных средств "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/),
                                        NULL,
                                        FIROLE_FIREQ, FIROLE_FICOM,
                                        ВалютаТребования, ВалютаОбязательства,
                                        ВалютаОбязательства, IIF(LPPSum != 0,FD.СуммаОбязательства() + LPPSum,FD.СуммаОбязательства()),
                                        NULL, NULL, NULL, NULL,
                                        SideTransaction, ExRateExtra,
                                        MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                      )
           )
           return 1;
        end;
     else
        if( FD.IsBuy() )
            ВалютаТребования = FD.ВалютаОбязательства(); 
            ВалютаОбязательства = FD.ВалютаОбязательства();
            СуммаТребования  = IIF(FD.IsSWAPNDeal(), FD.ПлатежОб().rec.OrderAmount, FD.СуммаОбязательства());
        elif( FD.IsSale() )
            ВалютаТребования = FD.ВалютаТребования(); 
            ВалютаОбязательства = FD.ВалютаТребования();
            СуммаТребования  = IIF(FD.IsSWAPNDeal(), FD.ПлатежТреб().rec.OrderAmount, FD.СуммаТребования());
        end;

        if( not ПроводкаПоКатегориямУчета( FD,
                                        Categdeb, CategCred, /*PNV*/
                                        ДатаИсполненияШага, 1,
                                        ВалютаТребования, IIF(DPPSum != 0,СуммаТребования+DPPSum,СуммаТребования),
                                        doc,
                                        INPCARRY, "", "",
                                        IIF( (StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL"),FD.GetGround(9) ,"Отражение требований и обязательств по уплате и получению денежных средств "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/),
                                        NULL,
                                        FIROLE_FIREQ, FIROLE_FICOM,
                                        ВалютаТребования, ВалютаОбязательства,
                                        ВалютаОбязательства, iif(FD.IsSWAPNDeal(),FD.ПлатежОб().rec.OrderAmount+LPPSum,FD.СуммаОбязательства()+ LPPSum),
                                        NULL, NULL, NULL, NULL,
                                        SideTransaction, ExRateExtra,
                                        MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                      )
           )
           return 1;
        end;
      end;
     /*PNV списание для неттинга по драг.металлам посделочно для внебиржи и биржи не Т+3 */
     if ( (FD.ВидБазовогоАктива() == FIKIND_METAL) and (FD.Netting()) and ((FD.СрокСделки != DV_PERIODCLS_T3) or (not FD.Биржевая()))  )
          SideTransaction = ACCTRN_SIDE_NONE;
          ExRateExtra = 0; 
          var Skp = 0, SumEq_Payer = 0, SumEq_Receiver = 0;
          ВалютаТребования=FD.ВалютаТребования();
          СуммаТребования= FD.СуммаТребования();
          ВалютаОбязательства=FD.ВалютаОбязательства();
         var СуммаОбязательства=FD.СуммаОбязательства();
         
         if( FD.IsBuy() )
             СуммаТребования  = FD.СуммаОбязательства();
             ВалютаТребования = FD.ВалютаОбязательства();
             SideTransaction = ACCTRN_SIDE_DEBET;
         elif( FD.IsSale() )
             SideTransaction = ACCTRN_SIDE_CREDIT;
             СуммаТребования  = FD.СуммаТребования();
             ВалютаТребования = FD.ВалютаТребования();
         end;

         var swapTypeName = "";
        if (FD.IsSwap())
           swapTypeName = FD.PctSwapTypeName(true);
        end;

         
         if( FD.IsBuy() )
          else
             if( not FD.ReOpenAccount("-Форвард, расчетыДМ", null, null, FIROLE_FICOM, AccDeb, ДатаИсполненияШага, ВалютаТребования, null, null, MC_PAIRACCMODE_MANUAL) )
                  return 1;
              end;

             if (ВалютаОбязательства != NATCUR)
                 if( not ПроводкаПоКатегориямУчета( FD,
                                              AccDeb, "Выбытие ДМ",
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, СуммаТребования,
                                              doc,
                                              INPCARRY, "", "",
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FICOM, FIROLE_BA,
                                              ВалютаТребования, NATCUR, 
                                              ВалютаТребования, СуммаТребования,
                                              null, null, null, null, 
                                              SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, true
                                            )
                      )
                      return 1;
                 end;
             else    
                 if( not ПроводкаПоКатегориямУчета( FD,
                                              AccDeb, "Выбытие ДМ", 
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, СуммаТребования,
                                              doc,
                                              INPCARRY, "", "",
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FICOM, FIROLE_BA,
                                              ВалютаТребования, NATCUR, 
                                              ВалютаТребования, СуммаТребования,
                                              null, null, null, null, 
                                              SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, true
                                            )
                      )
                      return 1;
                 end;
             end;
          end;   
    end;    
/*PNV*/
     end;
  end;

  return 0;
END;

MACRO ПолучитьВнебалансовыеСчетаБирж( FD, ReqAcc:@STRING, ReqAccFIID:@INTEGER, ReqFiRole:@INTEGER, ComAcc:@STRING, ComAccFIID:@INTEGER, ComFiRole:@INTEGER, IsOld:bool, isFOAcc:bool )

  var ВЦ:integer  = ПолучитьВалютуЦеныПИ(FD);
  var ВБА:integer = ПолучитьВалютуБазовогоАктиваПИ(FD);
  var IsBaseDV:bool = false;
  var Условие:bool = true;
  var OneDayFut = false;

  if( FD.BaseFI.rec.FI_Kind == FIKIND_DERIVATIVE )
     IsBaseDV = true;
  end;

  if( (IsOld != NULL) and (IsOld == true) )
     Условие = FD.СтароеУсловиеПоСтороне();
  else
     Условие = FD.УсловиеПоСтороне();
  end;

  OneDayFut = ( DL_GetMainObjAttr( FD.FI, 1, OBJTYPE_DV ) == 2 );

  if(OneDayFut == true)
    if(Условие)
      ReqAcc = "+Форвард, бессрочные";
      ReqAccFIID = ВБА;
      ReqFiRole  = FIROLE_FIDOC;
      ComAcc = "-Форвард, бессрочные"; 
      ComAccFIID = ВЦ;
      ComFiRole  = FIROLE_PRICEFI;
    else
      ReqAcc = "+Форвард, бессрочные";
      ReqAccFIID = ВЦ;
      ReqFiRole  = FIROLE_PRICEFI;
      ComAcc = "-Форвард, бессрочные"; 
      ComAccFIID = ВБА;
      ComFiRole  = FIROLE_FIDOC;
    end;
  elif( Условие == false )
     if( IsBaseDV )
        ReqAcc = IIF(isFOAcc, "+Форвард, ФО", "+Форвард, дрейф");
        ComAcc = IIF(isFOAcc, "-Форвард, ФО", "-Форвард, дрейф");
     else
        ReqAcc = IIF(isFOAcc, "+Форвард, ФО", "+Форвард, дрейф");
        ComAcc = IIF(isFOAcc, "-Форвард, ФО", "-Форвард, дрейф");
     end;

     ReqAccFIID = ВЦ;
     ReqFiRole  = FIROLE_PRICEFI;
     ComAccFIID = ВБА;
     ComFiRole  = FIROLE_FIDOC;
  else
     if( IsBaseDV )
        ReqAcc = IIF(isFOAcc, "+Форвард, ФО", "+Форвард, дрейф");
        ComAcc = IIF(isFOAcc, "-Форвард, ФО", "-Форвард, дрейф");
        else
        ReqAcc = IIF(isFOAcc, "+Форвард, ФО", "+Форвард, дрейф");
        ComAcc = IIF(isFOAcc, "-Форвард, ФО", "-Форвард, дрейф");
     end;

     ReqAccFIID = ВБА;
     ReqFiRole  = FIROLE_FIDOC;
     ComAccFIID = ВЦ;
     ComFiRole  = FIROLE_PRICEFI;
  end;
end;

MACRO ПолучитьВнебалансовыеСчетаБиржАртикул( FD, ReqAcc:@STRING, ReqAccFIID:@INTEGER, ReqFiRole:@INTEGER, ComAcc:@STRING, ComAccFIID:@INTEGER, ComFiRole:@INTEGER, IsOld:bool )

  var ВЦ:integer;//  = ПолучитьВалютуБазовогоАктиваПИ(FD);//ПолучитьВалютуЦеныПИ(FD);
  var ВБА:integer;// = ПолучитьВалютуБазовогоАктиваПИ(FD);
  var IsBaseDV:bool = false;
  var Условие:bool = true;
 //TEG
  if ( (FD.BASEFI_NOTDV.rec.fi_code=="BR") or (FD.BASEFI_NOTDV.rec.fi_code=="CL"))
    ВЦ  = ПолучитьВалютуБазовогоАктиваПИ(FD);
    ВБА = ПолучитьВалютуБазовогоАктиваПИ(FD);
  else
    ВЦ =  ПолучитьВалютуЦеныПИ(FD);
    ВБА=ПолучитьВалютуБазовогоАктиваПИ(FD);
  end;

  if( FD.BaseFI.rec.FI_Kind == FIKIND_DERIVATIVE )
     IsBaseDV = true;
  end;

  if( (IsOld != NULL) and (IsOld == true) )
     Условие = FD.СтароеУсловиеПоСтороне();
  else
     Условие = FD.УсловиеПоСтороне();
  end;

  if( Условие == false )
     if( IsBaseDV )
           ReqAcc = "+Форвард, дрейф";
           ComAcc = "-Форвард, ПФИ";
        else
           ReqAcc = "+Форвард, дрейф";
           ComAcc = "-Форвард, дрейф";
     end;

     ReqAccFIID = ВЦ;
     ReqFiRole  = FIROLE_PRICEFI;
     ComAccFIID = ВБА;
     ComFiRole  = FIROLE_FIDOC;
  else
     if( IsBaseDV )
           ReqAcc = "+Форвард, ПФИ";
           ComAcc = "-Форвард, дрейф";
        else
           ReqAcc = "+Форвард, дрейф";
           ComAcc = "-Форвард, дрейф";
     end;

     ReqAccFIID = ВБА;
     ReqFiRole  = FIROLE_FIDOC;
     ComAccFIID = ВЦ;
     ComFiRole  = FIROLE_PRICEFI;
  end;
end;

MACRO DV_SrvOpSayError( DocKind:INTEGER, FirstDoc:TRecHandler, StrErr:STRING, NumErr:INTEGER, ServOp:bool ):INTEGER
  if( NumErr == null )
     NumErr = 1;
  end;

  if( ServOp )
     SvOpInsertError( DocKind, FirstDoc, 1, StrErr );
  else
     MsgBox( StrErr );
  end;

  return 1; /*выход по ошибке*/
END;

MACRO ПроводкиКорректировкиХеджирования( FD, doc, FrVal, PrevFrVal, FrSum, PFIFrVal, ДатаИсполненияШага:date, ObjType, ObjID, isBeginDateCarry )

  var DebAccount, CredAccount;
  var ExtAccount = TRecHandler("account");

  // Проводки AC
/* 
  if(isBeginDateCarry)
  if(not ПолучитьВнешнийСчётХеджирования(FD.Deal.rec.ID, FD.Deal.rec.DocKind, ДатаИсполненияШага, ObjType, ObjID, PFIFrVal, ExtAccount))
     return false;
  end;
  DebAccount = IIF(PFIFrVal > 0, /*"Расходы_хедж, ПФИ", ExtAccount*/ ExtAccount, "Расходы_хедж, ПФИ");
  CredAccount = IIF(PFIFrVal > 0, /*ExtAccount, "Доходы_хедж, ПФИ"*/"Доходы_хедж, ПФИ", ExtAccount); 
  
  if( not ПроводкаПоКатегориямУчета( FD,
                                     DebAccount, CredAccount,
                                     ДатаИсполненияШага, 1,
                                     NATCUR, abs(PrevFrVal),
                                     doc,
                                     INPCARRY, "", "",
                                    "Отражение корректировки для ОХ"
                                    )
    )
     return false;
  end;
 
  end;
 */
  // Проводки ББб
  if(not ПолучитьВнешнийСчётХеджирования(FD.Deal.rec.ID, FD.Deal.rec.DocKind, ДатаИсполненияШага, ObjType, ObjID, FrSum, ExtAccount))
     return false;
  end;
  

  DebAccount = IIF(FrSum > 0, /*"Расходы_хедж, ПФИ", ExtAccount*/ ExtAccount, "Расходы_хедж, ПФИ");
  CredAccount = IIF(FrSum > 0, /*ExtAccount, "Доходы_хедж, ПФИ"*/"Доходы_хедж, ПФИ", ExtAccount); 

  
  if( not ПроводкаПоКатегориямУчета( FD,
                                     DebAccount, CredAccount,
                                     ДатаИсполненияШага, 1,
                                     NATCUR, abs(FrSum),
                                     doc,
                                     INPCARRY, "", "",
                                    "Корректировка АС ОХ"
                                    )
    )
     return false;
  end;

  if ((ObjType == DL_DV_HEDGEOBJTYPE_CB_ACQUIRED) or (ObjType == DL_DV_HEDGEOBJTYPE_CB_EMISSED))
     //Добавить сумму на лоты во временной таблице
     VAR cmd = RSDCommand("call RSB_PMWRTOFF.RSI_AddHedgCorrToLotsTMP(?,?,?,?,?)");
     cmd.addParam( "", RSDBP_IN, ДатаИсполненияШага );
     cmd.addParam( "", RSDBP_IN, ObjID );
     cmd.addParam( "", RSDBP_IN, FD.Deal.rec.Department );
     cmd.addParam( "", RSDBP_IN, FrSum); 
     cmd.addParam( "", RSDBP_IN, NATCUR);
     cmd.execute();
     
     //Сохранить в постоянной таблице
     if( DL_WRTSaveHedgCorrLots(ДатаИсполненияШага) )
       return false;
     end;
  end;
  return true;                               
END;


MACRO ПроводкиПоПереоценкеСС( FD, doc, FrVal, FairValueOld:money, ServOp:bool, OutSum:money, OutDebAccount:string, OutCredAccount:string )

  var Sum:money = $0.0;
  var DebAccount:string = "", CredAccount:string = "";
  var NotPFI:bool = ((FD.IsForwardDealT3() or FD.IsSWAPDealT3()) and FD.КонтрагентБиржа());
  var HedgeRecs = 0;
  var HedgeType = 0;

  var HedgeCateg = -1;
  private macro IsLastWorkDay (check_date:date)
   var cmd;

   cmd = RsdCommand(RslDefCon, "{ ? = CALL LoansKernel.IsLastWorkDay (?) }" );

   cmd.addParam("retval", RSDBP_RETVAL, V_INTEGER);
   cmd.addParam("check_date", RSDBP_IN, check_date);

   cmd.execute();

   return cmd.value(0);

  end;
  
  private macro УрегулирПарнПФИ(CatIN,InAccBuf,OpDate,Sum)
  	var PairCat = IIF(CatIN == "+ПФИ","-ПФИ","+ПФИ");
	  var PairBuf = TRecHandler("account");
	  var Error;
	  
	  if( not FD.OpenAccount( PairCat, null, false, FIROLE_UNDEF, PairBuf, OpDate, NATCUR, null, null, MC_PAIRACCMODE_MANUAL ) )
          		Error = "Счет категории \"" + PairCat + "\" неопределен или недоступен в данной операции";
          		return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
	  end;
	  if (PairCat == "-ПФИ")
	  	if( not ПроводкаПоКатегориямУчета( FD,
                                           InAccBuf,PairBuf, 
                                           OpDate, 1,
                                           NATCUR, abs(Sum),
                                           doc,
                                           INPCARRY,"", "",
                                           FD.GetGround(11)
                                         )
          	)
          	 if( ServOp )
             		 return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), DV_GetCarryError(), 1, ServOp );
          	 else
             		 return 1;
          	 end;
          	end;

	   elif (PairCat == "+ПФИ")
		if( not ПроводкаПоКатегориямУчета( FD,
                                           PairBuf, InAccBuf,
                                           OpDate, 1,
                                           NATCUR, abs(Sum),
                                           doc,
                                           INPCARRY,"", "",
                                           FD.GetGround(11)
                                         )
          	)
          	 if( ServOp )
             		 return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), DV_GetCarryError(), 1, ServOp );
          	 else
             		 return 1;
          	 end;
          	end;
	   end; 
  end;

  if( (FD.IsClient() == false) and (not NotPFI) )
     var ДатаИсполненияШага:date = FrVal.rec.Date;
     var DebAccBuf  = TRecHandler("account");
     var CredAccBuf = TRecHandler("account");
     var DebAcc:string  = "", CredAcc:string = "";
     var ИспользоватьВыбытие:bool = false;
     var Error:string = "";
     var AttrID = 2;
     var PlusAccBufDP = TRecHandler("account"), MinusAccBufDP = TRecHandler("account");
     var RestDPPlus = 0, RestDPMinus = 0;

     Sum = abs(FrVal.rec.FairValue - FairValueOld);
    
     /* по умолчанию в зависимости от InterimPayDate */
     //19/12/18 mda Если в дату оплаты БА , то считаем по выбытию
     //Если последний день месяца и на него выпал ПП , то по выбытию. Если без ПП , то 706
     //Если в день исполнения , то 706 , несмотря на ПП
     //if( FrVal.rec.InterimPayDate == SET_CHAR )
     if( (FrVal.rec.InterimPayDate == SET_CHAR) or ((ДатаИсполненияШага == FD.ДатаИсполненияЧасти()) and (FD.DealPart == 1) and (not FD.IsPctSWAP()) ))
        ИспользоватьВыбытие = true;
     end;

     if ( IsLastWorkDay(ДатаИсполненияШага) )
        if (FrVal.rec.InterimPayDate == SET_CHAR)
          ИспользоватьВыбытие = true;
        else
          ИспользоватьВыбытие = false;
        end;
     end;

     if ( (FD.IsPctSWAP() or FD.IsSWAP() ) and (ДатаИсполненияШага == FD.ДатаИсполненияСвопа()))
      ИспользоватьВыбытие = false;
     elif ( (FD.IsForward() or FD.IsOption()) and ( ДатаИсполненияШага == FD.ДатаИсполнения() ) )
      ИспользоватьВыбытие = false;
     end;
     /* частные случаи для вызова из сервисной операции */
     if( ServOp == true )
        if( FD.IsSWAP() )
           if( (FD.ДатаИсполнения() == ДатаИсполненияШага) or (FD.nFI_BAOther.rec.ExecDate == ДатаИсполненияШага) )
              if( FD.ДатаИсполнения() == ДатаИсполненияШага )
                 ИспользоватьВыбытие = true;
              else
                 ИспользоватьВыбытие = false;
              end;
           end;
        elif( FD.IsPctSWAP() )
           if( DV_GetPmGrOnDate(FD.Deal.rec.ID, ДатаИсполненияШага, -1, NULL) == true )
              ИспользоватьВыбытие = true;
           else
              ИспользоватьВыбытие = false;
           end
        end;
     end;

     /* теперь после всего обработаем настройку ПИ_НеИсп61601ПостСВОП()*/
     if( ДатаИсполненияШага <= FD.ДатаИсполнения() )
        if( FD.IsSWAP() )
           //TEG 14.01.19 if( (ИспользоватьВыбытие) and FD.ПоставочныйКонтракт() and ПИ_НеИсп61601ПостСВОП() and (FD.ЧастьСделкиНеРанееТретьегоДня() == false) )
           //TEG 11.02.19  добавлено условие БиржеваяСделкаНаВалРынке() чтобы не падали сюда внебиржевые
           //MDA 12.02.19 Если первая нога Т0 , то 706 , если нет то 616 . Для коротких свопов и где нет шага первичное признание ПФИ
           if (FD.ДатаСделки() == ДатаИсполненияШага)
            ИспользоватьВыбытие = false;
           end;
           if( (ИспользоватьВыбытие) and FD.ПоставочныйКонтракт() and  FD.БиржеваяСделкаНаВалРынке()/*and ПИ_НеИсп61601ПостСВОП() */ and (FD.ЧастьСделкиНеРанееТретьегоДня() == false) )
              ИспользоватьВыбытие = false;
           end;
        elif( FD.IsPctSWAP() )
           if( ( FD.ПоставочныйКонтракт() and ПИ_НеИсп61601ПостСВОП() ) )
              ИспользоватьВыбытие = false;
           end;
            var cmdHedge = RSDCommand("SELECT 1 retval, t_hedgetype HT FROM DDLHDGRELATION_DBT WHERE t_instrid = ? AND t_instrdockind = ? AND t_BeginDate <= ? " +
                                  "  AND ( t_EndDate = TO_DATE('01.01.0001', 'DD.MM.YYYY') OR t_EndDate >= ? )");
            cmdHedge.addParam( "", RSDBP_IN, FD.Deal.rec.ID);
            cmdHedge.addParam( "", RSDBP_IN, FD.Deal.rec.DocKind);
            cmdHedge.addParam( "", RSDBP_IN, ДатаИсполненияШага);
            cmdHedge.addParam( "", RSDBP_IN, ДатаИсполненияШага);
            cmdHedge.execute();
            var HedgeData = TRsbDataSet(cmdHedge);
            if( HedgeData.MoveNext())
               HedgeRecs = HedgeData.retval;
               HedgeType = HedgeData.HT;
            end;
        end;
     end;

     if( FD.IsForward() or FD.IsSWAP() or FD.IsPctSWAP() )
        if( FrVal.rec.FairValue < FairValueOld )
           if(HedgeRecs > 0)
              if(HedgeType == 1) /*Хеджирование СС*/
                 DebAcc = "Расходы_хедж, ПФИ";
              end;
           else
           DebAcc  = IIF(ИспользоватьВыбытие == true, "Выбытие ПФИ", "Расходы ПФИ");
           end;
           CredAcc = IIF(FairValueOld > 0, "+ПФИ", "-ПФИ");
        else
           DebAcc  = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
           if(HedgeRecs > 0)
              if(HedgeType == 1) /*Хеджирование СС*/
                 CredAcc = "Доходы_хедж, ПФИ";
              end;
           else
               CredAcc = IIF(ИспользоватьВыбытие == true, "Выбытие ПФИ", "Доходы ПФИ");
           end;
        end;
     elif( FD.IsOption() )
        /*CHVA*/
        var Bonus:money = 0.0;
        if( not DV_SmartConvertSumDbl(Bonus, FD.Deal.rec.Bonus, ДатаИсполненияШага, FD.Deal.rec.BonusFIID, NATCUR) )
              MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(FD.Deal.rec.BonusFIID)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        return 1;
        end;
        if (FairValueOld == 0)
            //Sum = OptionCorrectSumSS(FD.deal.rec.id,FrVal.rec.FairValue);/*PNV 500574*/
            if( FD.IsClient() == false )
                  if( FD.IsBuy() )
                      if( FrVal.rec.FairValue > Bonus )
                             DebAcc  = "+ПФИ";
                             CredAcc = "Доходы ПФИ";
                             Sum = FrVal.rec.FairValue  - Bonus;/*PNV 500574*/
        
                      elif( FrVal.rec.FairValue < Bonus )
                             DebAcc  ="Расходы ПФИ";
                             CredAcc = "+ПФИ";
                             Sum = Bonus - FrVal.rec.FairValue;/*PNV 500574*/
                      end;
                  elif( FD.IsSale() )
                      if( abs(FrVal.rec.FairValue) > Bonus )
                             DebAcc  = "Расходы ПФИ";
                             CredAcc = "-ПФИ";
                             Sum = (abs(FrVal.rec.FairValue) - Bonus);/*PNV 500574*/

                      elif( abs(FrVal.rec.FairValue) < Bonus )
                             DebAcc  = "-ПФИ";
                             CredAcc = "Доходы ПФИ";
                             Sum = (Bonus - abs(FrVal.rec.FairValue));/*PNV 500574*/
                      end;
                  end;
            end;
        else
          if( FrVal.rec.FairValue < FairValueOld )
             DebAcc  = IIF(ИспользоватьВыбытие == true, "Выбытие ПФИ", "Расходы ПФИ");
             CredAcc = IIF(FD.IsBuy(), "+ПФИ", "-ПФИ");
          else
             DebAcc  = IIF(FD.IsBuy(), "+ПФИ", "-ПФИ");
             CredAcc = IIF(ИспользоватьВыбытие == true, "Выбытие ПФИ", "Доходы ПФИ");
          end;
        end;
     end;
      if(FD.isPctSwap() and (HedgeRecs != 0) and (HedgeType == 2))
         if( not FD.OpenAccount( "-Корр,Хедж_ДП", null, false, FIROLE_UNDEF, MinusAccBufDP,  ДатаИсполненияШага, NATCUR, null, null ) )
            Error = "Счет категории \"" + DebAcc + "\" неопределен или недоступен в данной операции";
            return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
         end;

         if( not FD.OpenAccount( "+Корр,Хедж_ДП", null, false, FIROLE_UNDEF, PlusAccBufDP, ДатаИсполненияШага, NATCUR, null, null ) )
            Error = "Счет категории \"" + CredAcc + "\" неопределен или недоступен в данной операции";
            return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
         end;
         
         RestDPMinus = GetRestAccountTRH(MinusAccBufDP, ДатаИсполненияШага);
         RestDPPlus  = GetRestAccountTRH(PlusAccBufDP, ДатаИсполненияШага);
         if( (RestDPMinus != 0) and (RestDPPlus == 0))
            if( FrVal.rec.FairValue > FairValueOld )
               CredAcc = "-Корр,Хедж_ДП";
               DebAcc = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
            elif( FrVal.rec.FairValue < FairValueOld )
               DebAcc = "-Корр,Хедж_ДП";
               CredAcc = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
            end;
         elif((RestDPMinus == 0) and (RestDPPlus != 0))
            if( FrVal.rec.FairValue < FairValueOld )
               DebAcc = "+Корр,Хедж_ДП";
               CredAcc = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
            elif( FrVal.rec.FairValue > FairValueOld )
               CredAcc = "+Корр,Хедж_ДП";
               DebAcc = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
            end;
         elif((RestDPMinus != 0) and (RestDPPlus != 0))
            Error = "Счета категории + и - Корр,Хедж_ДП имеют ненулевой остаток по сделке " + FD.DealCode();
            if( ServOp )
               return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
            else
               return 1;
            end;
         elif((RestDPMinus == 0) and (RestDPPlus == 0))
            if( FrVal.rec.FairValue > FairValueOld )
               CredAcc = "-Корр,Хедж_ДП";
               DebAcc = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
            elif( FrVal.rec.FairValue < FairValueOld )
               DebAcc = "+Корр,Хедж_ДП";
               CredAcc = IIF(FairValueOld >= 0, "+ПФИ", "-ПФИ");
            end;
         end;
         if ((CredAcc == "") OR (DebAcc == ""))
            Sum = 0;
         else
            if ( (not FD.IsExistAccount(DebAcc, null, true, FIROLE_UNDEF, DebAccBuf, null, ДатаИсполненияШага, NATCUR)) and 
            ( not FD.OpenAccount( DebAcc, null, false, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ))
               Error = "Счет категории \"" + DebAcc + "\" неопределен или недоступен в данной операции";
               if( ServOp )
                  return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
               else
                  return 1;
               end;
            end;

            if( (not FD.IsExistAccount(CredAcc, null, true, FIROLE_UNDEF, CredAccBuf, null, ДатаИсполненияШага, NATCUR)) and 
            ( not FD.OpenAccount( CredAcc, null, false, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ))
               Error = "Счет категории \"" + DebAcc + "\" неопределен или недоступен в данной операции";
               if( ServOp )
                  return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
               else
                  return 1;
               end;
            end;
         end;
      else
         if( (not FD.IsExistAccount(DebAcc, null, true, FIROLE_UNDEF, DebAccBuf, null, ДатаИсполненияШага, NATCUR)) and 
         ( not FD.OpenAccount( DebAcc, null, false, FIROLE_UNDEF, DebAccBuf,  ДатаИсполненияШага, NATCUR, null, null ) ))
            Error = "Счет категории \"" + DebAcc + "\" неопределен или недоступен в данной операции";
            return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
         end;

         if( (not FD.IsExistAccount(CredAcc, null, true, FIROLE_UNDEF, CredAccBuf, null, ДатаИсполненияШага, NATCUR)) and 
         ( not FD.OpenAccount( CredAcc, null, false, FIROLE_UNDEF, CredAccBuf, ДатаИсполненияШага, NATCUR, null, null ) ))
            Error = "Счет категории \"" + CredAcc + "\" неопределен или недоступен в данной операции";
            return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );
         end;
      end;
     if( FD.IsOption() )
        if (FairValueOld !=0)/*CHVA*/
            if( FD.IsBuy() )
               if( FrVal.rec.FairValue < FairValueOld )
                   Sum = min(Sum, abs(GetRestAccountTRH(CredAccBuf, ДатаИсполненияШага)));
               end;
            else
               if( FrVal.rec.FairValue > FairValueOld )
                  Sum = min(Sum, abs(GetRestAccountTRH(DebAccBuf, ДатаИсполненияШага)));
               end;
            end;
        end;
     end;

     if( Sum > 0.0 )
         if( not ПроводкаПоКатегориямУчета( FD,
                                           DebAccBuf, CredAccBuf,
                                           ДатаИсполненияШага, 1,
                                           NATCUR, Sum,
                                           doc,
                                           INPCARRY,"", "",
                                           IIF( StrUpr(GenClassName(FD)) == "DVFIRSTDOCNDEAL",FD.GetGround(7) ,"Учет изменения СС по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) )/*CHVA*///"Учет изменения СС по сделке "+FD.DealCode()
                                         )
          )
           if( ServOp )
              return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), DV_GetCarryError(), 1, ServOp );
           else
              return 1;
           end;
         end;

    //03.12.18 Доработка для РСХБ , урегулирование парных счетов 52601-52602 сразу во премя операции переоценки СС
         if (substr(CredAccBuf.rec.account, 1, 5) == "52601")
            if (GetRestAccountTRH(CredAccBuf, ДатаИсполненияШага) > 0)
               УрегулирПарнПФИ(CredAcc,CredAccBuf,ДатаИсполненияШага,FrVal.rec.FairValue /*GetRestAccountTRH(CredAccBuf, ДатаИсполненияШага)*/);/*CHVA*/
            end;
         elif (substr(DebAccBuf.rec.account, 1, 5) == "52602")
            if (GetRestAccountTRH(DebAccBuf, ДатаИсполненияШага) < 0)
               УрегулирПарнПФИ(DebAcc,DebAccBuf,ДатаИсполненияШага,FrVal.rec.FairValue /*GetRestAccountTRH(DebAccBuf, ДатаИсполненияШага)*/); /*CHVA*/
            end;
         end;

         DebAccount  = DebAccBuf.rec.Account;
         CredAccount = CredAccBuf.rec.Account;
     end;

     if(FD.isPctSwap() and (HedgeRecs != 0) and (HedgeType == 2)) // Урегулирование для Корр,Хедж_ДП
         RestDPMinus = GetRestAccountTRH(MinusAccBufDP, ДатаИсполненияШага);
         RestDPPlus  = GetRestAccountTRH(PlusAccBufDP, ДатаИсполненияШага);
         if ((RestDPMinus < 0) OR (RestDPPlus > 0))
            if( not ПроводкаПоКатегориямУчета( FD,
                                             PlusAccBufDP,MinusAccBufDP, 
                                             ДатаИсполненияШага, 1,
                                             NATCUR, abs(IIF(RestDPMinus != 0, RestDPMinus, RestDPPlus)),
                                             doc,
                                             INPCARRY,"", "",
                                             IIF(RestDPMinus != 0, "Перенос отрицательной разницы от переоценки ИХ", "Перенос положительной разницы от переоценки ИХ")
                                          )
            )
               if( ServOp )
                  return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), DV_GetCarryError(), 1, ServOp );
               else
                  return 1;
               end;
            end;
         end;
     end;

     if(FD.isPctSwap() and (HedgeRecs != 0) and (HedgeType == 1)) // Учёт отношений хеджирования. Только для хеджирования СС
        var QueryH = RSDCommand( " Select * " +
                                "   FROM ddlhdgrelation_dbt " +
                                "  Where t_InstrID   = ? " +
                                "    AND t_InstrDocKind = ? " +
                                "    AND t_OBJTYPE not in (7,8,9) " +
                                "    and t_BeginDate <= ? " +
                                "    and (     t_EndDate   = TO_DATE('01.01.0001', 'DD.MM.YYYY') or  t_EndDate >= ? )");
   
        QueryH.addParam( "", RSDBP_IN, FD.deal.rec.ID );
        QueryH.addParam( "", RSDBP_IN, FD.deal.rec.DocKind );
        QueryH.addParam( "", RSDBP_IN, ДатаИсполненияШага );
        QueryH.addParam( "", RSDBP_IN, ДатаИсполненияШага );
        QueryH.execute();
   
        var DataSetH = TRsbDataSet(QueryH);
        if( DataSetH.MoveNext() ) 
           var QueryHFRV;
           QueryHFRV = RSDCommand( " SELECT fv.t_ActualFV FairValue,  fv.t_PrevFV PrevFairValue, fv.t_dFV, fv.t_CurFIID Currency " +
                                   "   FROM ddlhdgrfairval_dbt fv " +
                                   "    WHERE fv.t_RelationID =  ? " +
                                   "    AND   fv.t_Date  = ? ");
   
           QueryHFRV.addParam( "", RSDBP_IN, DataSetH.ID );
           QueryHFRV.addParam( "", RSDBP_IN, ДатаИсполненияШага );

           QueryHFRV.execute();   
           var DataSetHFRV = TRsbDataSet(QueryHFRV);
           if( DataSetHFRV.MoveNext() )
              var FVSumRUR = $0.0;
              if( not DV_SmartConvertSum( FVSumRUR, DataSetHFRV.dFV, ДатаИсполненияШага, DataSetHFRV.Currency, NATCUR, true ) )
                 return 1;
              end;            

              if(not ПроводкиКорректировкиХеджирования( FD, doc, DataSetHFRV.FairValue, DataSetHFRV.PrevFairValue, FVSumRUR, FrVal.rec.FairValue, ДатаИсполненияШага, DataSetH.ObjType, DataSetH.ObjID, IIF(DataSetH.BeginDate == ДатаИсполненияШага, true, false) ))
                 return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), DV_GetCarryError(), 1, ServOp );
              end;            
        else
              Error = "За дату " + string(ДатаИсполненияШага) + " на отношениях хеджирования отсутствует запись об изменении справедливой стоимости";
              return DV_SrvOpSayError( FD.Kind, FD.DealRecHandler(), Error, 1, ServOp );                  
           end;
        end;
     end;
  end;

  setparm(5, Sum);
  setparm(6, DebAccount);
  setparm(7, CredAccount);
  return 0;
END;
//mda 19.02.2019 Напишем наконец-то грамотный фин рез! 
MACRO ФинРезПФИ( FD, Doc, ДатаИсполненияШага )
  RECORD OutAcc(account);
  RECORD ВыбытиеПФИ(account);
  RECORD AccPlus(account);
  RECORD AccMinus(account);
  var NotPFI:bool = ((FD.IsForwardDealT3() or FD.IsSWAPDealT3()) and FD.КонтрагентБиржа());
  var Rest=$0,RestAcc = "", categ,curr,Data;
  var Query;
  var PaymentID:integer = 0;
  var Платеж:RsbPayment;
  if( not FD.OpenAccount("+Маржа, ИВ и ДМ", null, false, FIROLE_BA, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
    return 1;
  end;
  if( not FD.OpenAccount("-Маржа, ИВ и ДМ", null, false, FIROLE_BA, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
    return 1;
  end;
  if ( (FD.IsPctSWAP) or ( FD.IsOption() and (FD.ПоставочныйКонтракт() == false) ))
    categ = "Выбытие ПФИ";
    if( FD.IsExistAccount( categ, null, true, FIROLE_UNDEF, OutAcc, null, ДатаИсполненияШага, NATCUR ) or
         FD.OpenAccount( categ, null, false, FIROLE_UNDEF, OutAcc, ДатаИсполненияШага, NATCUR )  /* могли открыть на текущем шаге */
      )
      RestAcc = DL_GetRestAccount( OutAcc, ДатаИсполненияШага );
    end;
  else
    if ( FD.ПоставочныйКонтракт() )
      if (FD.БивалютнаяСделка())
        if (FD.IsForward() or FD.IsSWAP())
          if (FD.IsBuy)
            categ = ПИ_КатегорияПлФорвардРПИ();
            curr = FD.ВалютаТребования();
          else
            categ = ПИ_КатегорияМнФорвардРПИ();
            curr = FD.ВалютаОбязательства();
          end; 
        elif (FD.IsOption())
          if (FD.IsBuyOption())
            categ = ПИ_КатегорияПлФорвардРПИ();
            curr = FD.ВалютаТребования();
          else
            categ = ПИ_КатегорияМнФорвардРПИ();
            curr = FD.ВалютаОбязательства();
          end;
        end;
      else
        if ((FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования() != NATCUR))
          categ = ПИ_КатегорияПлФорвардРПИ();
          curr = FD.ВалютаТребования();
        elif ((FD.ВалютаОбязательства() != NATCUR) and (FD.ВалютаТребования() == NATCUR))
          categ = ПИ_КатегорияМнФорвардРПИ();
          curr = FD.ВалютаОбязательства();
        end;
      end;
    else
      if( (DV_FindPaymentID(FD.kind, FD.deal.rec.id, PM_PURP_MARGA, 0, FD.ДатаИсполнения(), @PaymentID) == true) and (PaymentID > 0) )
        Платеж = RsbPayment(PaymentID);
      end;
      if (not Платеж)
        return 1;
      end;
      curr = Платеж.BaseFIID;
      if ( (Платеж.Payer == {OurBank}) and (SubStr(Платеж.PayerAccount,1,5) == "47407") )
        categ = ПИ_КатегорияМнФорвардРПИ();
      elif ( (Платеж.Receiver == {OurBank}) and (SubStr(Платеж.ReceiverAccount,1,5) == "47408") )
        categ = ПИ_КатегорияПлФорвардРПИ();
      end;
    end;
    if( FD.IsExistAccount( categ, null, true, FIROLE_UNDEF, OutAcc, null, ДатаИсполненияШага, curr ) or
         FD.OpenAccount( categ, null, false, FIROLE_UNDEF, OutAcc, ДатаИсполненияШага, curr )  /* могли открыть на текущем шаге */
      )
      Query = RSDCommand(" SELECT SUM(sum_nat) as Rest FROM ( SELECT "+
      " CASE WHEN d.t_account_payer = ? THEN d.t_sum_natcur * (-1) " +
      " WHEN d.t_account_receiver = ? THEN d.t_sum_natcur  "+
      " END sum_nat FROM dacctrn_dbt d "+
      " WHERE d.t_date_carry = ? AND "+
      " ( (d.t_account_payer = ?) or (d.t_account_receiver = ?) ) "+
      " AND  d.t_acctrnid IN ( "+
      " SELECT t.t_acctrnid FROM doprdocs_dbt t "+
      " WHERE t.t_dockind = 1 AND t.t_id_operation IN ( "+
      " SELECT t.t_id_operation FROM doproper_dbt t, ddvndeal_dbt d WHERE t.t_dockind = 199 "+
      " AND d.t_id = ltrim(t.t_documentid,'0') AND d.t_id = ? "+
      " )) ) ");
      Query.NullConversion = true;
      Query.addParam("", RSDBP_IN, OutAcc.Account );
      Query.addParam("", RSDBP_IN, OutAcc.Account );
      Query.addParam("", RSDBP_IN, ДатаИсполненияШага );
      Query.addParam("", RSDBP_IN, OutAcc.Account );
      Query.addParam("", RSDBP_IN, OutAcc.Account );
      Query.addParam("", RSDBP_IN, FD.deal.rec.id );
      Query.execute();
      Data = TRsbDataSet(Query);
      if( Data.MoveNext() )
        Rest = Data.Rest;
      end;
    end;
  end;
  if( not FD.IsClient() )
     /* формируются проводки по учету финансового результата */
        if( Rest > 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              OutAcc,                              /* Деб */
                                              AccPlus, /* Кредит */
                                              ДатаИсполненияШага,                      /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              ABS( Rest ),                          /* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отнесение фин. результата на доходы",   /* Ground */
                                              NULL, NULL, NULL,
                                              NULL, NULL, NULL, NULL,
                                              NULL, NULL, NULL, NULL,
                                              NULL, NULL, NULL, NULL, IIF(categ == "ВыбытиеПФИ",null,true)
                                            )
             )
               return 1;
           end;
        elif( Rest < 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccMinus, /* Деб */
                                              OutAcc,                              /* Кредит */
                                              ДатаИсполненияШага,                      /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              ABS( Rest ),                          /* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*///"Отнесение фин. результата на расходы",  /* Ground */
                                              NULL, NULL, NULL,
                                              NULL, NULL, NULL, NULL,
                                              NULL, NULL, NULL, NULL,
                                              NULL, NULL, NULL, NULL, IIF(categ == "ВыбытиеПФИ",null,false)
                                            )
             )
               return 1;
           end;
        end;
     end;
  return 0;
END;

MACRO ОтнесениеФинРезультата( FD, Doc, ДатаИсполненияШага )

  RECORD ВыбытиеПФИ(account);
  VAR RestAcc;
  var Ground = "Отнесение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor);
 /*CHVA 512385*/
 if ((FD.IsSWAP) or (FD.Isforward()))
     Ground = FD.GetGround(1010);
 end;
 /*CHVA 512385*/
  var NotPFI:bool = ((FD.IsForwardDealT3() or FD.IsSWAPDealT3()) and FD.КонтрагентБиржа());
  if (NotPFI == false)
    if (FD.IsOption)
      Ground = FD.GetGround(14);
    end;
  end;

  if(FD.IsPctSWAP())
   Ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). " + Ground;
  end;

  if( not FD.IsClient() )
     /* формируются проводки по учету финансового результата */
     if( FD.IsExistAccount( "Выбытие ПФИ", null, true, FIROLE_UNDEF, ВыбытиеПФИ, null, ДатаИсполненияШага, NATCUR ) or
         FD.OpenAccount( "Выбытие ПФИ", null, false, FIROLE_UNDEF, ВыбытиеПФИ, ДатаИсполненияШага, NATCUR )  /* могли открыть на текущем шаге */
       )
        RestAcc = DL_GetRestAccount( ВыбытиеПФИ, ДатаИсполненияШага );
        if( RestAcc > 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              ВыбытиеПФИ,                              /* Деб */
                                              IIF(NotPFI, "+Маржа, ИВ и ДМ", "Доходы ПФИ"), /* Кредит */
                                              ДатаИсполненияШага,                      /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              ABS( RestAcc ),                          /* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              //"Отнесение фин. результата на доходы",   /* Ground */
                                              Ground,
                                              null,
                                              null, IIF(NotPFI, FIROLE_BA, null)
                                            )
             )
               return 1;
           end;
        elif( RestAcc < 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              IIF(NotPFI, "-Маржа, ИВ и ДМ", "Расходы ПФИ"), /* Деб */
                                              ВыбытиеПФИ,                              /* Кредит */
                                              ДатаИсполненияШага,                      /* Дата */
                                              1,                                       /* Глава */
                                              NATCUR,                                  /* Валюта */
                                              ABS( RestAcc ),                          /* Сумма */
                                              Doc,                                     /* Документ */
                                              INPCARRY,                                /* Result_Carry */
                                              "",                                      /* Kind_Oper */
                                              "",                                      /* Numb_Document */
                                              //"Отнесение фин. результата на расходы",  /* Ground */
                                              Ground,
                                              null,
                                              IIF(NotPFI, FIROLE_BA, null), null
                                            )
             )
               return 1;
           end;
        end;
     end;
  end;

  return 0;
END;

MACRO ОтнесениеФинРезультатаДМ( FD, Doc, ДатаИсполненияШага )

  RECORD ВыбытиеДМ(account);
  var Course:double = 0.0;
  var CourceSinceDate:date = date(0,0,0);
  VAR RestAcc:money = $0.0;
  var DiffSum:money = $0.0;
  var Сумма:money = $0.0;
  var СчётДебет, СчётКредит, ВалютаДебет, ВалютаКредит, ВалютаСуммы;
  var isRestAcc = false;
  var FiRole1, FiRole2;
  var Ground = "";

  if (FD.IsBuy())
     return 0;/*PNV эта проводка на отдельном шаге списание СС*/
     if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, FD.pm_CA().rec.FIID, DV_RATETYPE_CBR, ДатаИсполненияШага, false, @CourceSinceDate ) )
        MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задан курс ЦБ РФ в "+ПолучитьКодФинИн(FD.pm_CA().rec.FIID)+" на дату " + String(ДатаИсполненияШага));
        return 1;
     else
        Сумма = FD.pm_CA().rec.Amount - FD.СуммаТребования()*Course;
        ВалютаСуммы = FD.pm_CA().rec.FIID;
     end;
     if (Сумма < 0)
        СчётДебет  = ПИ_КатегорияПлФорвардРПИ();
        ВалютаДебет = FD.pm_CA().rec.FIID;
        СчётКредит = "+Маржа, ИВ и ДМ";
        ВалютаКредит = NATCUR;
        FiRole2    = FIROLE_BA;
     else
        СчётКредит  = ПИ_КатегорияПлФорвардРПИ();
        ВалютаКредит = FD.pm_CA().rec.FIID;
        СчётДебет = "-Маржа, ИВ и ДМ";
        ВалютаДебет = NATCUR;
        FiRole1    = FIROLE_BA;
     end;
  else
     if( not ( FD.IsExistAccount( "Выбытие ДМ", null, true, FIROLE_BA, ВыбытиеДМ, null, ДатаИсполненияШага, NATCUR ) or
         FD.OpenAccount( "Выбытие ДМ", null, false, FIROLE_BA, ВыбытиеДМ, ДатаИсполненияШага, NATCUR ) )  /* могли открыть на текущем шаге */
       )
        return 1;
     end;
     Сумма = DL_GetRestAccount( ВыбытиеДМ, ДатаИсполненияШага );
     ВалютаСуммы = NATCUR;
   /*PNV 522410*/
   if (FD.pm_CA().rec.FIID != NATCUR)
    if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, FD.pm_CA().rec.FIID, DV_RATETYPE_CBR, ДатаИсполненияШага, false, @CourceSinceDate ) )
        MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задан курс ЦБ РФ в "+ПолучитьКодФинИн(FD.pm_CA().rec.FIID)+" на дату " + String(ДатаИсполненияШага));
        return 1;
     else
        Сумма = FD.pm_CA().rec.Amount - FD.СуммаОбязательства()*Course;
        if( not DV_SmartConvertSumDbl(Сумма, Сумма, ДатаИсполненияШага, FD.pm_CA().rec.FIID, NATCUR) )
              MsgBox( "Ошибка при конвертации суммы из " + string(ПолучитьКодФинИн(FD.pm_CA().rec.FIID)) + " в " + string(ПолучитьКодФинИн(NATCUR)) );
        return 1;
        end;
    end;
   end;
   /*PNV 522410*/
     
     if (Сумма > 0)
        СчётДебет  = ВыбытиеДМ;
        СчётКредит = "+Маржа, ИВ и ДМ";
        FiRole2    = FIROLE_BA;
     else
        СчётКредит = ВыбытиеДМ;
        СчётДебет  = "-Маржа, ИВ и ДМ";
        FiRole1    = FIROLE_BA;
     end;
     ВалютаДебет = NATCUR;
     ВалютаКредит = NATCUR;
  end;
  /* формируются проводки по учету финансового результата */

  Ground = "Отражение фин. результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor);
  if(FD.IsSWAP())
   Ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). " + Ground;
  end;

  if( not ПроводкаПоКатегориямУчета( FD,
                                     СчётДебет,                               /* Деб */
                                     СчётКредит,                              /* Кредит */
                                     ДатаИсполненияШага,                      /* Дата */
                                     1,                                       /* Глава */
                                     ВалютаСуммы,                             /* Валюта */
                                     ABS( Сумма ),                            /* Сумма */
                                     Doc,                                     /* Документ */
                                     INPCARRY,                                /* Result_Carry */
                                     "",                                      /* Kind_Oper */
                                     "",                                      /* Numb_Document */
                                     Ground,                                  /* Ground */
                                     null,
                                     FiRole1, FiRole2,
                                     ВалютаДебет, 
                                     ВалютаКредит
                                   )
    )
      return 1;
  end;

  return 0;
END;

MACRO ОтражениеСуммыТО( FD/*по первой части*/, Doc, ДатаИсполненияШага )

  var Валюта:integer = ALLFININSTR, Валюта2:integer = ALLFININSTR;
  var Сумма:money = $0.0, Сумма2:money = $0.0;
  var SumeqPayer:money = $0.0;/*CHVA*/
  var Categdeb, CategCred;
  var Course:double = 0.0;
  var CourceSinceDate:date = date(0,0,0);
  var Ground = "";
  /*PNV*/
  var SideTransaction:integer = ACCTRN_SIDE_NONE;
  var ВалютаТребования = FD.ВалютаТребования();
  var СуммаТребования = FD.СуммаТребования();
  var ВалютаОбязательства = FD.ВалютаОбязательства();
  var СуммаОбязательства = FD.СуммаОбязательства();
  var НеФормЯдернПроводкуКурсРазницы = null;
  /*PNV*/

  if( not FD.IsClient() )
     Ground = FD.GetGround(1009);
     /* FD по первой части */
     if( ((ПИ_НеИсп61601ПостСВОП() == false) and (FD.ЧастьСделкиНеРанееТретьегоДня() == false)) or FD.ЧастьСделкиНеРанееТретьегоДня() or ( FD.IsSWAPNDeal() and ( (ПИ_НеИсп61601ПостСВОП() == false) or (FD.ВидБазовогоАктива() == FIKIND_METAL) ) ))

          if( FD.IsSWAPNDeal() and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.isSale() )
               Валюта = FD.ВалютаРасчётов();
               if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, NATCUR, DV_RATETYPE_CBR, ДатаИсполненияШага, false, @CourceSinceDate ) or
                 ((CourceSinceDate != ДатаИсполненияШага) and (Course == 0.0)) )
                   MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задана учетная цена Банка России на дату " + String(ДатаИсполненияШага));
                   return 1;
              else
                   Сумма = FD.СуммаОбязательства()*Course;
              end;
          else
              Валюта = IIF(FD.IsPctSWAP(), FD.ВалютаТребования(), FD.ВалютаОбязательства());
              Сумма  = IIF(FD.IsPctSWAP(), FD.СуммаТребования(), FD.СуммаОбязательства());
          end;
          Categdeb = ПИ_КатегорияПлФорвардРПИ(); /*PNV*/
          CategCred = ПИ_КатегорияМнФорвардРПИ();/*PNV*/

          /*PNV*/
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)
              Валюта = IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
              Сумма  = IIF (FD.isbuy(), FD.СуммаОбязательства(), FD.СуммаТребования());
              Categdeb = "+Форвард, расчетыДМ";
              CategCred = "-Форвард, расчетыДМ";
              /*PNV 515850*/
              if (FD.ВидАктиваОбязательства()==FIKIND_METAL)
                  Ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). " + "Отражение обязательства по уплате драгоценных металлов по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor);
              end;
             /*PNV 515850*/
              if ( FD.Биржевая() and FD.isbuy() )
                   CategCred = ПИ_КатегорияМнФорвардРПИ();
                   Валюта = FD.ВалютаОбязательства(); 
                   if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                       return 1;
                   end;      
                   Сумма = FD.СуммаОбязательства();
              elif ( FD.Биржевая() and FD.issale() )
                   Categdeb = ПИ_КатегорияПлФорвардРПИ();
                   Валюта = FD.ВалютаТребования(); 
                   if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                       return 1;
                   end;      
                   Сумма  = SumeqPayer; 
              elif ( FD.issale() )
                   Валюта = FD.ВалютаТребования(); 
                   if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                       return 1;
                   end;      
                   Сумма  = SumeqPayer; 
              end;
          end;
          /*PNV*/

          if( not ПроводкаПоКатегориямУчета( FD,
                                           "Выбытие ПФИ",                                              /* Деб */
                                           CategCred,                                                /* Кредит *//*PNV*/
                                           ДатаИсполненияШага,                                         /* Дата */
                                           1,                                                          /* Глава */
                                           Валюта,                                                     /* Валюта */
                                           Сумма,                                                      /* Сумма */
                                           Doc,                                                        /* Документ */
                                           INPCARRY,                                                   /* Result_Carry */
                                           "",                                                         /* Kind_Oper */
                                           "",                                                         /* Numb_Document */
                                           Ground, /*PNV 515850*/
                                           NULL,
                                           NULL, FIROLE_FICOM,
                                           NATCUR, Валюта,
                                           null, null, null, null, null, null, null, null,
                                           null, MC_PAIRACCMODE_MANUAL
                                         )
            )
            return 1;
          end;

          if( FD.IsSWAPNDeal() and (FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.isBuy() )
              Валюта = FD.ВалютаРасчётов();
              if( not ПолучитьКурсЗаданногоTипа(@Course, FD.BaseFI().rec.FIID, NATCUR, DV_RATETYPE_CBR, ДатаИсполненияШага, false, @CourceSinceDate ) or
                ((CourceSinceDate != ДатаИсполненияШага) and (Course == 0.0)) )
                 MsgBox("Для драг. металла " + ПолучитьКодФинИн(FD.BaseFI().rec.FIID) + " не задана учетная цена Банка России на дату " + String(ДатаИсполненияШага));
                 return 1;
              else
                 // Сумма = FD.СуммаТребования()*Course;
              end;
          else
              Валюта = IIF(FD.IsPctSWAP(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
              // Сумма  = IIF(FD.IsPctSWAP(), FD.СуммаОбязательства(), FD.СуммаТребования());
          end;

          /*CHVA поскольку счет 47407\08 не должен открываться в металле, добавил конвертацию суммы из металла в валюту контрактива в проводке */
          if ( (StrUpr(GenClassName(FD)) =="DVFIRSTDOCNDEAL") and ((fd.deal.rec.kind == 2715)/*MDA*/ or (fd.deal.rec.kind == 12715)/*MDA*/ or (fd.deal.rec.kind == 22710)) and (FD.ВидБазовогоАктива() == FIKIND_METAL) and (SubStr(FD.V_PM_BA.rec.receiveraccount, 1, 3) == "474") ) 
                Валюта = IIF( (FD.IsPctSWAP() and ( FD.DealPArt == 1 )), FD.ВалютаТребования(),FD.ВалютаОбязательства());
                if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                   return 1;
                end;      
	        Сумма  = SumeqPayer;  
          else
                Валюта = IIF(FD.IsPctSWAP(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
                Сумма  = IIF(FD.IsPctSWAP(), FD.СуммаОбязательства(), FD.СуммаТребования());
          end;
          Ground = FD.GetGround(1011);
          /*PNV*/
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)
              Валюта = IIF (FD.isbuy(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
              if ( (FD.deal.rec.kind == 22710) and (not FD.Биржевая()) and (FD.IsBuy()))/*CHVA добавил конвертацию валют иначе при отражении требований не правильно конвертятся суммы*/
                    if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                        return 1;
                    end;      
                    Сумма  = SumeqPayer;
                    SumeqPayer = null;
                   if (Валюта != NATCUR)
                      if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, NATCUR , false) )
                        return 1;
                    end;      
                   НеФормЯдернПроводкуКурсРазницы = true;
                   end;
             end;
             /*PNV 515850*/
             if (FD.ВидАктиваТребования()==FIKIND_METAL)
                  Ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). " + "Отражение требований по получению драгоценных металлов по сделке "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor); 
             end;
             /*PNV 515850*/
          end;
          /*PNV*/

          if( not ПроводкаПоКатегориямУчета( FD,
                                           CategDeb,                                                   /* Деб *//*PNV*/
                                           "Выбытие ПФИ",                                              /* Кредит */
                                           ДатаИсполненияШага,                                         /* Дата */
                                           1,                                                          /* Глава */
                                           Валюта,                                                     /* Валюта */
                                           Сумма,                                                      /* Сумма */
                                           Doc,                                                        /* Документ */
                                           INPCARRY,                                                   /* Result_Carry */
                                           "",                                                         /* Kind_Oper */
                                           "",                                                         /* Numb_Document */
                                           Ground, /*PNV 515850*/
                                           NULL,
                                           FIROLE_FIREQ, NULL,
                                           Валюта, NATCUR,
                                           NATCUR, SumeqPayer, null, null, null, null, null, null,
                                           MC_PAIRACCMODE_MANUAL, null, null, null, null, null, null, null, null, null,  НеФормЯдернПроводкуКурсРазницы
                                         )
            )
            return 1;
          end;
        
          /*PNV неттинг по драг.металлам*/ 
          if ( (FD.ВидБазовогоАктива() == FIKIND_METAL) and (FD.Netting()) )
             if( FD.IsBuy() )
                 if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                     return 1;
                 end;
                 Сумма  = SumeqPayer; 
                 ВалютаТребования= FD.ВалютаОбязательства(); 
                 ВалютаОбязательства= FD.ВалютаОбязательства();
                 СуммаТребования  = FD.СуммаОбязательства();
             elif( FD.IsSale() )
                 if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid, Валюта , false) )
                     return 1;
                 end;
                 Сумма  = SumeqPayer; 
                 ВалютаТребования = FD.ВалютаТребования(); 
                 ВалютаОбязательства = FD.ВалютаТребования();
                 СуммаТребования  = FD.СуммаТребования();
             end;

             var swapTypeName = "";
             if (FD.IsSwap())
                 swapTypeName = FD.PctSwapTypeName(true);
             end;


             if( FD.IsBuy() )
                 SideTransaction = ACCTRN_SIDE_DEBET;
                        if (FD.Биржевая())
                        if (ВалютаТребования != NATCUR)
                            if( not ПроводкаПоКатегориямУчета( FD,
                                              "КлиринговыеСчетаДМ", "+Форвард, расчетыДМ",
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, Сумма,
                                              doc,
                                              INPCARRY, "", "",
                                              "Отражение требований и обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FIREQ, FIROLE_FIREQ,
                                              FD.ВалютаТребования(), ВалютаОбязательства,
                                              ВалютаОбязательства, СуммаОбязательства,
                                              null, null, null, null, 
                                              SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, true
                                            )
                             )
                             return 1;
                            end;
                        else    
                            if( not ПроводкаПоКатегориямУчета( FD,
                                              "КлиринговыеСчетаДМ", "+Форвард, расчетыДМ",  
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, Сумма,
                                              doc,
                                              INPCARRY, "", "",
                                              "Отражение требований и обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FIREQ, FIROLE_FIREQ,
                                              FD.ВалютаТребования(), ВалютаОбязательства,
                                              ВалютаОбязательства, СуммаОбязательства,
                                              null, null, null, null, 
                                              SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, true
                                            )
                              )
                             return 1;
                            end;
                        end; 
                    end; 
             else
                   SideTransaction = ACCTRN_SIDE_CREDIT;
                   if (ВалютаОбязательства != NATCUR)

                       if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.NFI_BASEACTIV.rec.fiid,  NATCUR, false) )
                           return 1;
                       end;
                       НеФормЯдернПроводкуКурсРазницы = false;
                       if( not ПроводкаПоКатегориямУчета( FD,
                                              "-Форвард, расчетыДМ", "Выбытие ДМ",
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, Сумма,
                                              doc,
                                              INPCARRY, "", "",
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FICOM, FIROLE_BA,
                                              ВалютаТребования, NATCUR, 
                                              NATCUR, SumeqPayer,
                                              null, null, null, null, 
                                              SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, НеФормЯдернПроводкуКурсРазницы
                                            )
                              )
                              return 1;
                       end;
                   else    
                       if( not ПроводкаПоКатегориямУчета( FD,
                                             "-Форвард, расчетыДМ", "Выбытие ДМ", 
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, Сумма,
                                              doc,
                                              INPCARRY, "", "",
                                              IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FICOM, FIROLE_BA,
                                              ВалютаТребования, NATCUR, 
                                              ВалютаТребования, СуммаТребования,
                                              null, null, null, null, 
                                              SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, true
                                            )
                                )
                              return 1;
                       end;
                   end;
                   if ( (FD.IsSWAP()) and (FD.Биржевая()) )
                            /*PNV закрываем остаток со счета 61213* */ 
                            if( not ПроводкаПоКатегориямУчета( FD,
                                            "Выбытие ДМ", "КлиринговыеСчетаДМ", 
                                            ДатаИсполненияШага, 1,
                                            FD.ВалютаТребования(), Сумма,
                                            doc,
                                            INPCARRY,"", "",
                                            IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                            NULL, FIROLE_BA, FIROLE_FIREQ,
                                            NATCUR, FD.ВалютаОбязательства(),
                                            NULL, NULL,
                                            NULL, NULL, NULL, NULL,
                                            NULL, NULL, NULL, NULL, NULL
                                          )
                                  )
                                 return 1;
                            end;
                            /*PNV*/ 
                   end;
             end;   
          end;    
          /*PNV*/
     elif ( (not FD.IsSWAPNDeal()) or ( FD.IsSWAPNDeal() and ((ПИ_НеИсп61601ПостСВОП() == false)) and (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) )) 
          Валюта  = IIF(FD.IsPctSWAP(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
          Валюта2 = IIF(FD.IsPctSWAP(), FD.ВалютаТребования(), FD.ВалютаОбязательства());
          Сумма   = IIF(FD.IsPctSWAP(), FD.СуммаОбязательства(), FD.СуммаТребования());
          Сумма2  = IIF(FD.IsPctSWAP(), FD.СуммаТребования(), FD.СуммаОбязательства());
          /*PNV*/
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)
              Валюта = Валюта2 = IIF (FD.isbuypart(), FD.ВалютаОбязательства(), FD.ВалютаТребования())
          end;
          /*PNV*/

          if( not ПроводкаПоКатегориямУчета( FD,
                                           CategDeb, /*PNV*/
                                           CategCred, /*PNV*/
                                           ДатаИсполненияШага,                                         /* Дата */
                                           1,                                                          /* Глава */
                                           Валюта,                                                     /* Валюта */
                                           Сумма,                                                      /* Сумма */
                                           Doc,                                                        /* Документ */
                                           INPCARRY,                                                   /* Result_Carry */
                                           "",                                                         /* Kind_Oper */
                                           "",                                                         /* Numb_Document */
                                           "Постановка на баланс сделки "+FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor),  /* Ground */
                                           NULL,
                                           FIROLE_FIREQ, FIROLE_FIREQ,
                                           Валюта, Валюта2,
                                           Валюта2, Сумма2,
                                           null, null, null, null, null, null,
                                           MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                         )
            )
              return 1;
          end;
     end;
  end;

  return 0;
END;

MACRO ПромежуточныйПлатеж( FD:DVFirstDocNDeal, Doc, ДатаИсполненияШага, Direction, KvitNetting:@bool, isCalc:bool, PaymentAmount:money  ):INTEGER

  var CalcOp = TRecHandler("dvnacdl");
  KvitNetting = false;
  CalcOp.rec.DealID    = FD.Deal.rec.Id;
  CalcOp.rec.Date      = ДатаИсполненияШага;
  CalcOp.rec.AccFIID   = FD.nFI_BaseActiv.rec.PriceFIID;
  CalcOp.rec.PayKind   = DV_CALCOP_PAYKIND_INTERIM;
  CalcOp.rec.Direction = Direction;
  CalcOp.rec.ServOperID = IIF(isCalc, 0, DV_PMGR_NOTCALC);
  if (PaymentAmount)
     CalcOp.rec.ServOperID = DV_PMGR_NETTING;
     CalcOp.rec.AccFIID    = FD.ВалютаТребования(); 
     CalcOp.rec.Direction  = IIF(PaymentAmount > 0, DV_CALCOP_DIRECTION_RECEPTION, DV_CALCOP_DIRECTION_PAYMENT);
     CalcOp.rec.Sum        = abs(PaymentAmount);
  end;
  if( DV_InsCalcOpPanel(CalcOp) == 0 )
     if( DV_InsertCalcOp(CalcOp) != 0 )
        MsgBox("Ошибка при вставке записи расчётов по сделке.");
        return 1;
     end;
  else
     return 1;
  end;
  if( CalcOp.rec.ServOperID != DV_PMGR_NETTING)
     if( СписаниеТребованияИОбязательстваПП( FD, doc, CalcOp.rec.Date, Direction, false) != 0 )
     return 1;
  end;
  end;
  if( УчетПромежуточногоПлатежа( FD, doc, CalcOp, @KvitNetting ) != 0 )
     return 1;
  end;

  return 0;
END;

MACRO СписаниеССПриПрекращенииПризнания( FD, Doc, ДатаИсполненияШага )

   macro ПроводкаСписанияССПриПрекращПризнания(FD:DVFirstDocNDeal, Doc, ДатаИсполненияШага:date, СчетПФИ:TRecHandler, ПФИКатегория:string)
     var RestAcc:money = $0.0;
     var ground="";
     var Debet, Credit,categ = "Выбытие ПФИ",SideTransaction;
        RestAcc = GetRestAccountTRH(СчетПФИ, ДатаИсполненияШага);

        if (FD.IsPctSWAP() and FD.ПоставочныйКонтракт())
          if  ((FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования != NATCUR))
            categ = ПИ_КатегорияПлФорвардРПИ();
          else
            categ = ПИ_КатегорияМнФорвардРПИ();
          end;
        end;
        if (FD.IsOption())
          ground = FD.GetGround(10);
        elif (FD.Isforward())
          ground = FD.GetGround(16);
        else
          ground = "ПФИ (" + FD.PctSwapTypeName(true) + "). Списание справедливой стоимости при прекращении признания по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0];
        end;
          
        if( RestAcc > $0.0 )
           Debet  = СчетПФИ; /* -ПФИ */
           Credit = categ;
        elif( RestAcc < $0.0 )
           Debet = categ;
           Credit = СчетПФИ; /* +ПФИ */
        end;

        if( FD.IsBuy() )
            SideTransaction = ACCTRN_SIDE_DEBET; 
        elif( FD.IsSale() )
            SideTransaction = ACCTRN_SIDE_CREDIT;
        end;

        if( abs(RestAcc) > $0. )
            if( not ПроводкаПоКатегориямУчета( FD,
                                              Debet, Credit,
                                              ДатаИсполненияШага, 1,
                                              NATCUR, abs(RestAcc),
                                              doc,
                                              INPCARRY, "", "",
                                              ground
                                            )
             )
              return 1;
           end;
        end;
     end;


  if( not FD.IsClient() )
     var СчетПФИ = TRecHandler("account");
     var RestAcc:money = $0.0;
     var Debet, Credit;

     if( FD.IsExistAccount( "+ПФИ", null, true, FIROLE_UNDEF, СчетПФИ, null, ДатаИсполненияШага, NATCUR ) )
         if( ПроводкаСписанияССПриПрекращПризнания(FD, Doc, ДатаИсполненияШага, СчетПФИ, "+ПФИ"))
            return 1;
         end;
     end;

     if( FD.IsExistAccount( "-ПФИ", null, true, FIROLE_UNDEF, СчетПФИ, null, ДатаИсполненияШага, NATCUR ) )
        if( ПроводкаСписанияССПриПрекращПризнания(FD, Doc, ДатаИсполненияШага, СчетПФИ, "-ПФИ"))
            return 1;
        end;
     end;

  end;

  return 0;
END;

MACRO ПИ_ПлатежиЗакрытьБезДвижения( FD ):integer

   if( FD.ПлатежТреб.rec.PaymentID > 0 )
      var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );
      if( ПИ_УстановитьСтатусПлатежа( ПлатежТреб, PM_CLOSED_W_M_MOVEMENT ) )
         MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения\"" );
         return 1;
      end;
   end;
  
   if( FD.ПлатежОб.rec.PaymentID > 0 )
      var ПлатежОб = RsbPayment( FD.ПлатежОб.rec.PaymentID );
      if( ПИ_УстановитьСтатусПлатежа( ПлатежОб, PM_CLOSED_W_M_MOVEMENT ) )
         MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения\"" );
         return 1;
      end;
   end;

   return 0;
END;

MACRO ПИ_ИсполнениеПлатежаНаШагеОжидания( FD, Payment:RsbPayment )
   if( (Payment.FuturePayerAmount != 0) and (not ПИ_СтутусПлатежИсполнен(Payment.PaymStatus)) )/*платеж мог участвовать в неттинге несмотря на то, что галочка неттинга в платеже не установлена*/
      if( ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(Payment)and ПИ_ПлатежКвитуетсяПоВидуФИ(Payment) )
         if( not GetTrue(true, "По платежу с ID = "+string(Payment.PaymentID)+" необходимо выполнить квитовку или учет в неттинге. Исполнить платеж?") )/*просили не запрещать*/
         return 1;
         end;
      end;
         if( not ПИ_ПроводкаПоПлатежу(FD, Payment) )
            return 1;
         end;
         if( ПИ_ИсполнитьПлатеж( Payment ) )
            return 1;
         end;
      end;

   return 0;
END;

//нужен, т.к. ядерный RestAC на остатки после опердаты смотреть не умеет
private macro ПИКО_GetAccRestSTRPRC( Acc:string, FIID:integer, Dt:date, Chapter:integer)
  return execStoredFunc( "rsb_account.restac", V_MONEY, makeArray( SQLParam( "" , Acc      ),
                      SQLParam( "" , FIID     ),
                      SQLParam( "" , Dt),
                      SQLParam( "" , Chapter  ),
                      SQLParam( "" , 0        )) );
end;

PRIVATE MACRO ПИКО_ЕстьПросрочка( FD, ДатаИсполненияШага:DATE, ВидТО ):bool
   var RetVal = false;
   var Query, Data;

   Query = RSDCommand( " SELECT COUNT(1) AS CountStep " +
                       "   FROM doprstep_dbt step, doproper_dbt oper " +
                       "  WHERE oper.t_DocKind      = ? AND " +
                       "        oper.t_DocumentID   = ? AND " +
                       "        step.t_ID_Operation = oper.t_ID_Operation AND " +
                       "        step.t_Symbol       = " + IIF(ВидТО == DV_Обязательство, "'Е'", "'е'") + " AND " +
                       "        step.t_Plan_Date    <= ?  AND " +
                       "        step.t_IsExecute    = 'X' ");
   Query.NullConversion = true;
   Query.addParam("", RSDBP_IN, FD.Kind );
   Query.addParam("", RSDBP_IN, UniID(FD.Deal, OBJTYPE_FXOPER_DV) );
   Query.addParam("", RSDBP_IN, ДатаИсполненияШага );
   Query.execute();

   Data = TRsbDataSet(Query);
   if( Data.MoveNext() and (Data.CountStep > 0) )
      RetVal = true;
  end;

  return RetVal;
END;

MACRO ПИКО_АктуализироватьПлатежОбяз( FD, KUNezav ):integer
  if( FD.ПлатежОб.rec.PaymentID > 0 )
    if( DV_SetPaymentGround(FD.ПлатежОб, -1, FD) == false )
      return 1;
    end;

    var AccountD = TRecHandler("account");
    var AccountC = TRecHandler("account");
    var PaymentCom = RsbPayment(FD.ПлатежОб.rec.PaymentID);

    var датаОткрСчетов = DL_GetBankDateAfterWorkDayByCalendar(FD.ДатаСделки(),0,FD.ПолучитьКалендСвязанный());
//dan
    if( FD.IsClient() )
      if( FD.Биржевая() and FD.ВалютныйРынок() )
        if( not FD.OpenAccount("+Биржа", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL) )
          return 1;
        end;
      else
        AccountC = NULL;
      end;
    else
      if( FD.БиржеваяСделкаНаВалРынке() )
        if( (FD.ВидАктиваОбязательства()==FIKIND_METAL) AND (not FD.IsDealMet()) )
          if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, FIROLE_FICOM, AccountC, null, датаОткрСчетов)) and
              (not FD.OpenAccount("Выбытие ДМ", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов)))
            )
            return 1;
          end;
        elif( ПИ_ИспТранзитныхСчетовОбязательств() == DV_FX_TRAN_BEFOREPAYMENT )
          if( (not FD.IsExistAccount("-Расчеты", null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, FD.ВалютаОбязательства())) and
              (not FD.OpenAccount("-Расчеты", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        else
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)
            if( not FD.OpenAccount("-Биржа", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов), iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()) ) )/*PNV*/
              return 1;
            end;
          else
            if( not FD.OpenAccount("-Биржа", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL) )
              return 1;
            end;
          end;
        end;
      else
        if( FD.ОдновалютнаяБанкнотная() )
          /*Если платеж по обязательству наличный, то в проводку идет счет кассы*/
          if( DV_IsCashAccount(FD.ПлатежОб.rec.ReceiverAccount) )
            PaymentCom.FutureReceiverAccount = FD.ПлатежОб.rec.ReceiverAccount;
          end;
          AccountC = NULL;
        elif( FD.ВалютаБазовогоАктива() != FD.ВалютаКонтрАктива() )
          /*Если платеж по обязательству наличный, то в проводку идет счет кассы*/
          if( DV_IsCashAccount(FD.ПлатежОб.rec.ReceiverAccount) )
            PaymentCom.FutureReceiverAccount = FD.ПлатежОб.rec.ReceiverAccount;
            AccountC = NULL;
          else
            if( (not FD.IsBNote()) and (((FD.ВидАктиваОбязательства()==FIKIND_METAL) AND (not FD.IsDealMet())) OR (FD.IsDealMet() AND FD.IsSale())) )
              if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, FIROLE_FICOM, AccountC, null, датаОткрСчетов)) and
                  (not FD.OpenAccount("Выбытие ДМ", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов)))
                 )
                 return 1;
              end;
            else
              if( ПИ_ИспТранзитныхСчетовОбязательств() == DV_FX_TRAN_BEFOREPAYMENT )
                if( (not FD.IsExistAccount("+Расчеты", null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, FD.ВалютаОбязательства())) and /*PNV*/
                    (not FD.OpenAccount("+Расчеты", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL)) /*PNV*/
                  )
                  return 1;
                end;
              else
                AccountC = NULL;
              end;
            end;
          end;
        end;
      end;
    end;

    if( FD.IsClient() )
      AccountD = NULL;
    elif( FD.ОдновалютнаяБанкнотная() )
      if( (not FD.IsExistAccount(KUNezav/*"-Расчеты"*/, null, true, FIROLE_FICOM, AccountD, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, FD.ВалютаОбязательства())) and /*PNV*/
          (not FD.OpenAccount(KUNezav/*"-Расчеты"*/, null, false, FIROLE_FICOM, AccountD, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL)) /*PNV*/
        )
        return 1;
      end;
    else
      //TEG 21.01.19 по металлу не должно 474 в металле открываться
      if (FD.ВидБазовогоАктива() == FIKIND_METAL)
        if( (not FD.IsExistAccount("-Форвард, расчетыДМ", null, true, FIROLE_FICOM, AccountD, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()))) and /*PNV*/
            (not FD.OpenAccount("-Форвард, расчетыДМ", null, false, FIROLE_FICOM, AccountD, FD.SetAccOpenDate(датаОткрСчетов), iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL)) /*PNV*/
          )
          return 1;
        end;
      else    
        if (FD.IsDealMet() AND ПИКО_ЕстьПросрочка(FD, {curdate}, DV_Обязательство) )
          if( (not FD.IsExistAccount("Обяз. с н.с.",  null, true, null, AccountD, null, {curdate}, FD.ВалютаКонтрАктива())))
            return 1;
          end;
        else
          if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(), null, true, FIROLE_FICOM, AccountD, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, IIF(FD.IsDealMet(), FD.ВалютаКонтрАктива(),FD.ВалютаОбязательства()))) and
              (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountD, FD.SetAccOpenDate(датаОткрСчетов), IIF(FD.IsDealMet(), FD.ВалютаКонтрАктива(), FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL)) 
            )
            return 1;
          end;
        end;
      end;
    end;

    if( not DV_СохранитьСчетаВПлатеже(PaymentCom, FD.ПлатежОб, AccountD, AccountC, FD) )
      MsgBox( "Ошибка при сохранении счета в платеже" );
      return 1;
    end;
  end;

  return 0;
END;

MACRO ПИКО_АктуализироватьПлатежТреб( FD, KUNezav):integer
  if( FD.ПлатежТреб.rec.PaymentID > 0 )
    if( DV_SetPaymentGround(FD.ПлатежТреб, -1, FD) == false )
      return 1;
    end;

    var AccountD = TRecHandler("account");
    var AccountC = TRecHandler("account");
    var PaymentReq = RsbPayment(FD.ПлатежТреб.rec.PaymentID);

    var датаОткрСчетов = DL_GetBankDateAfterWorkDayByCalendar(FD.ДатаСделки(),0,FD.ПолучитьКалендСвязанный());

    if( FD.IsClient() )
      if( FD.БиржеваяСделкаНаВалРынке() )
        if( not FD.OpenAccount("+Биржа", null, false, FIROLE_FIREQ, AccountD, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL) )
          return 1;
        end;
      else
        AccountD = NULL;
      end;
    else
      if( FD.БиржеваяСделкаНаВалРынке() )
        if( (FD.ВидАктиваТребования()==FIKIND_METAL) AND (not FD.IsDealMet()) )
          /*if( DL_ЕдиныйПулОбеспеченияСобств == 1 )
              if( not FD.IsExistAccount("Торговый счет", null, null, FIROLE_FIREQ, AccountD, null, датаОткрСчетов, FD.ВалютаТребования()) )
                return 1;
              end;
          end;*/
        elif( ПИ_ИспТранзитныхСчетовТребований() == DV_FX_TRAN_BEFOREPAYMENT )
          if( (not FD.IsExistAccount("+Расчеты", null, true, FIROLE_FIREQ, AccountD, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, FD.ВалютаТребования())) and
              (not FD.OpenAccount("+Расчеты", null, false, FIROLE_FIREQ, AccountD, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        else
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)/*PNV*/
            if( not FD.OpenAccount("-Биржа", null, false, FIROLE_FICOM, AccountC, FD.SetAccOpenDate(датаОткрСчетов), iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()) ) )
              return 1;
            end;
          else
            if( not FD.OpenAccount("+Биржа", null, false, FIROLE_FIREQ, AccountD, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL) )
              return 1;
            end;
          end;
        end;
      else
        if( FD.ОдновалютнаяБанкнотная() )
          if( DV_IsCashAccount(FD.ПлатежТреб.rec.PayerAccount) )
            /*Если платеж по требованию наличный, то в проводку идет счет кассы*/
            PaymentReq.FuturePayerAccount = FD.ПлатежТреб.rec.PayerAccount;
          end;
          AccountD = NULL;
        elif( FD.ВалютаБазовогоАктива() != FD.ВалютаКонтрАктива() )
          if( DV_IsCashAccount(FD.ПлатежТреб.rec.PayerAccount) )
            /*Если платеж по требованию наличный, то в проводку идет счет кассы*/
            PaymentReq.FuturePayerAccount = FD.ПлатежТреб.rec.PayerAccount;
            AccountD = NULL;
          else
            if( FD.IsDealMet() and FD.IsBuy())
              if( (not FD.IsExistAccount("МХДМ", null, true, FIROLE_FIREQ, AccountD, NULL, датаОткрСчетов, FD.ВалютаТребования())) and
                  (not FD.OpenAccount("МХДМ", null, false, FIROLE_FIREQ, AccountD, датаОткрСчетов, FD.ВалютаТребования(), null, null, NULL))
                )
                return 1;
              end;
            elif( ПИ_ИспТранзитныхСчетовТребований() == DV_FX_TRAN_BEFOREPAYMENT )
              if( (not FD.IsExistAccount("+Расчеты", null, true, FIROLE_FIREQ, AccountD, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, FD.ВалютаТребования())) and
                  (not FD.OpenAccount("+Расчеты", null, false, FIROLE_FIREQ, AccountD, датаОткрСчетов, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
                )
                return 1;
              end;
            else
              AccountD = NULL;
            end;
          end;
        end;
      end;
    end;

    if( FD.IsClient() )
      AccountC = NULL;
    elif( FD.ОдновалютнаяБанкнотная() )
      if( (not FD.IsExistAccount(KUNezav/*"+Расчеты"*/, null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаТребования())) and /*PNV*/
          (not FD.OpenAccount(KUNezav/*"+Расчеты"*/, null, false, FIROLE_FIREQ, AccountC, FD.SetAccOpenDate(датаОткрСчетов), FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL)) /*PNV*/
        )
        return 1;
      end;
    else
      //TEG 21.01.19 по металлам 474 не должны открываться в металле
      if (FD.ВидБазовогоАктива() == FIKIND_METAL)
        if( (not FD.IsExistAccount("+Форвард, расчетыДМ",  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, FD.SetAccOpenDate(датаОткрСчетов), iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()))) and /*PNV*/
            (not FD.OpenAccount("+Форвард, расчетыДМ", null, false, FIROLE_FIREQ, AccountC, FD.SetAccOpenDate(датаОткрСчетов),iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL)) /*PNV*/
          )
          return 1;
        end;
      else
        if (FD.IsDealMet() AND ПИКО_ЕстьПросрочка(FD, {curdate}, DV_Требование) AND FD.IsSale() )
          if( (not FD.IsExistAccount("Треб. с н.с.",  null, true, null, AccountC, null, {curdate}, FD.ВалютаКонтрАктива())))
            return 1;
          end;
        else
          if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, датаОткрСчетов, IIF(FD.IsDealMet(), FD.ВалютаКонтрАктива(), FD.ВалютаТребования()))) and
              (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, FD.SetAccOpenDate(датаОткрСчетов), IIF(FD.IsDealMet(), FD.ВалютаКонтрАктива(), FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        end;
      end;
    end;

     if( not DV_СохранитьСчетаВПлатеже(PaymentReq, FD.ПлатежТреб, AccountD, AccountC, FD) )
        MsgBox( "Ошибка при сохранении счета в платеже" );
        return 1;
     end;
  end;

  return 0;
END;

MACRO ПИКО_АктуализироватьПлатежи( FD, KUNezav):integer
  if( ПИКО_АктуализироватьПлатежТреб( FD, KUNezav) != 0 )
    return 1;
  end;

  if( ПИКО_АктуализироватьПлатежОбяз( FD, KUNezav) != 0 )
    return 1;
  end;

  return 0;
END;

macro ПИКО_ПереоценкаПроверкаВалюты(FD):bool
  return ( ((FD.ВалютаБазовогоАктива()!=NATCUR)and(FD.ВалютаКонтрАктива() == NATCUR)) OR
           ((FD.ВидБазовогоАктива()==FIKIND_CURRENCY)and(FD.ВидКонтрАктива()==FIKIND_CURRENCY)and(FD.ВалютаБазовогоАктива()!=NATCUR)and(FD.ВалютаКонтрАктива()!=NATCUR)) OR
           ((FD.ВидБазовогоАктива()==FIKIND_METAL)and(FD.ВидКонтрАктива()==FIKIND_CURRENCY)and(FD.ВалютаКонтрАктива()!=NATCUR)) OR FD.IsDealMet()
         );
end;

/**
 @brief Получить признак того, что переоценка для сделки не производится
 @param[in] FD Первичный документ операции
 @return    Флаг отсутствия необходимости в пероценке (true - переоценка не нужна, false - нужна)
*/
MACRO ПИКО_ПереоценкаНеНужна(FD):bool
  if( FD.IsClient() or
      (FD.ВалютаБазовогоАктива() == NATCUR) or (FD.ВалютаБазовогоАктива() == FD.ВалютаКонтрактива()) or (FD.ВидКонтрактива() != FIKIND_CURRENCY) or 
      ( FD.IsBNote() and (RegVal_УчетРазноВалютныхБанкнотныхСделок()==false) )
    )
    return true;
  end;
  return false;
END;

/**
 @brief Функция уреголирования папеыз счетов переоценки 
 @param[in] FD Первичный документ операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @param[in] doc Буфер временного файла операции
 @return    Флаг исполнения функции (0 - исполнена без ошибок, 1 - с ошибками)
*/
MACRO ПИКО_УрегулироватьПарныеСчетаПереоценкиЧастиСделки(FD, ДатаИсполненияШага, doc):integer
  var Acc = TRecHandler("account");
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var AccPlusRest = $0, AccMinusRest = $0, DeltaRest = $0;
  var AccPlusAccount = "", AccMinusAccount = "";
  var Ground = "Урегулирование парных счетов за "+string(ДатаИсполненияШага)+" со счета ";
  return 0;

  if( FD.IsExistAccount("+Переоц.,поставка ИВ и ДМ", null, true, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага) and
      FD.IsExistAccount("-Переоц.,поставка ИВ и ДМ", null, true, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага) and 
      (AccPlus.rec.Account != AccMinus.rec.Account)
    )
    AccPlusRest = abs(RestAC( AccPlus.rec.Account, AccPlus.rec.Code_Currency, ДатаИсполненияШага, NULL, AccPlus.rec.Chapter ));
    AccMinusRest = abs(RestAC( AccMinus.rec.Account, AccMinus.rec.Code_Currency, ДатаИсполненияШага, NULL, AccMinus.rec.Chapter ));
  end;

  if( (AccPlusRest != $0) and (AccMinusRest != $0) )
    DeltaRest = AccPlusRest - AccMinusRest;
    if(DeltaRest >= $0)
      Ground = Ground +string(AccMinus.rec.Account)+" на счет "+string(AccPlus.rec.Account);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         AccMinus, AccPlus,
                                         ДатаИсполненияШага,
                                         1,
                                         NATCUR, AccMinusRest,
                                         doc,
                                         INPCARRY, "", "",
                                         Ground
                                       )
        )
        return 1;
      end;
    else/*DeltaRest < 0)*/
      Ground = Ground +string(AccMinus.rec.Account)+" на счет "+string(AccPlus.rec.Account);
      if( not ПроводкаПоКатегориямУчета( FD,
                                         AccMinus, AccPlus,
                                         ДатаИсполненияШага,
                                         1,
                                         NATCUR, AccPlusRest,
                                         doc,
                                         INPCARRY, "", "",
                                         Ground
                                       )
        )
        return 1;
      end;
    end;
  end;
  return 0;
END;

/**
 @brief Функция урегулирования остатка переоценки по части сделки
 @param[in] FD Первичный документ операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @param[in] doc Буфер временного файла операции
 @param[in] Sпер Сумма переоценки
 @return    Флаг исполнения функции (0 - исполнена без ошибок, 1 - с ошибками)
*/
MACRO ПИКО_УрегулироватьОстатокПереоценкиЧастиСделки(FD, ДатаИсполненияШага, doc, Sпер:money):integer
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var Debet = "", Credit = "";
  var БАЭкв_рег = $0, КАЭкв_рег = $0, Р_рег = $0, Delta = $0;
  var Ground = "";

  if( ПолучитьЗначенияРегистраНаДату(FD.Deal.rec.DocKind, FD.Deal.rec.Id, ДатаИсполненияШага, @БАЭкв_рег, @КАЭкв_рег, @Р_рег) )
    MsgBox( "Ошибка при получении величины накопленной переоценки из регистра переоценки" );
    return 1;
  end;
 
  Delta = Р_рег - Sпер;

  if( Delta != 0 )
    Ground = "Отражение переоценки т/о по поставке";

    if( FD.ВидБазовогоАктива() == FIKIND_METAL )                       
      Ground = Ground + " драг. металла";
    else
      Ground = Ground + " иностранной валюты";
    end;
                                                                       
    Ground = Ground + " при исполнении сделки " + FD.DealCode() + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor);

    if( (FD.IsBuyPart() AND (Р_рег > 0)) OR 
        ((not FD.IsBuyPart()) AND (Р_рег < 0)) 
      )
      if( not FD.OpenAccount("+Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
        return 1;
      end;
      if( Delta > 0 )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "-Маржа, ИВ и ДМ", AccPlus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Delta),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           FIROLE_BA 
                                            )
          )
          return 1;
        end;
      else
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccPlus, "+Маржа, ИВ и ДМ",
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Delta),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, FIROLE_BA 
                                         )
          )
          return 1;
        end;
      end;
    else
      if( not FD.OpenAccount("-Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
        return 1;
      end;
      if( Delta > 0 )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccMinus, "+Маржа, ИВ и ДМ", 
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Delta),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, FIROLE_BA 
                                         )
          )
          return 1;
        end;
      else
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "-Маржа, ИВ и ДМ", AccMinus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Delta),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           FIROLE_BA 
                                         )
          )
          return 1;
        end;
      end;
    end;
  end;

  return 0;
END;

/**
 @brief Функция списания переоценки части сделки
 @param[in] FD Первичный документ операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @param[in] doc Буфер временного файла операции
 @return    Флаг исполнения функции (0 - исполнена без ошибок, 1 - с ошибками)

 TEG копия функции для списания вместо переоценки финреза на Т0
*/
MACRO ПИКО_СписатьПереоценкуЧастиСделки(FD, ДатаИсполненияШага, doc):integer
  var AccC = TRecHandler("account");
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var AccountC = TRecHandler("account");
  var Sкр = $0, SumEq_Payer = $0, SumEq_Receiver = $0;
  var Ground = "Списание суммы переоценки т/о по поставке";
  var sum = 0; /*PNV 501129*/

  if( ПИКО_ПереоценкаНеНужна(FD) )
    return 0;
  end;

  if( ПИКО_УрегулироватьПарныеСчетаПереоценкиЧастиСделки(FD, ДатаИсполненияШага, doc) != 0 ) //В2А1
    return 1;
  end;

  if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребованияБезНДС(), ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, true) )
    return 1;
  end;
  if( not DV_SmartConvertSum(SumEq_Receiver, FD.СуммаОбязательстваБезНДС(), ДатаИсполненияШага, FD.ВалютаОбязательства(), NATCUR, true) )
    return 1;
  end;

  Sкр = round(SumEq_Payer, 2) - round(SumEq_Receiver, 2);

  if( ПИКО_УрегулироватьОстатокПереоценкиЧастиСделки(FD, ДатаИсполненияШага, doc, IIF(FD.ВалютаБазовогоАктива()==FD.ВалютаТребования(),Sкр,-Sкр)) != 0 ) //В2А2
    return 1;
  end;/*PNV 537838*/

  if( Sкр != 0 )
    if( FD.ВидБазовогоАктива() == FIKIND_METAL )                       
      Ground = Ground + " драг. металла";
    else
      Ground = Ground + " иностранной валюты";
    end;
     
    Ground = Ground + " по сделке ";
    Ground = Ground + FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/;

    if( (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) or ((FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsBuyPart()) )
      if( Sкр > $0 )
        if( (not FD.IsExistAccount("+Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR)))/*PNV 532711*/
          if( not FD.OpenAccount("+Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
            return 1;
          end;
        end;/*PNV 532711*/
        //TEG 21.09.19 для металла нужно открыть счет в валюте контрактива
        if (FD.ВидБазовогоАктива() == FIKIND_METAL)
          if( (not FD.IsExistAccount("+Форвард, расчетыДМ",  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()))) and
              (not FD.OpenAccount("+Форвард, расчетыДМ", null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        else
          if ( (FD.ВалютаОбязательства() != NATCUR) and (FD.ВалютаТребования() == NATCUR) and (not FD.IsBuyPart()) and not(FD.ВидБазовогоАктива() == FIKIND_METAL)) 
            if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаОбязательства()))) and
                (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL))
              )
              return 1;
            end;
          else
            if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаТребования()))) and
                (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))
              )
              return 1;
            end;
          end;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccountC, AccPlus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, Sкр,
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,true,null)
                                          )
          )
          return 1;
        end;
      else/*Sкр < $0*/
        if( (not FD.IsExistAccount("-Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR)))/*PNV 532711*/
          if( not FD.OpenAccount("-Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
            return 1;
          end;
        end;/*PNV 532711*/
        if (FD.ВидБазовогоАктива() == FIKIND_METAL)
          if( (not FD.IsExistAccount("+Форвард, расчетыДМ",  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()))) and
              (not FD.OpenAccount("+Форвард, расчетыДМ", null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        else
          if ( (FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования() != NATCUR) and ( FD.IsBuyPart() ) and not (FD.ВидБазовогоАктива() == FIKIND_METAL) )
            if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаТребования()))) and
                (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))
              )
              return 1;
            end;
          else
            //TEG 06.02.19 для SPOT  кидаем на счет требования, так как обязательства обнулили
            if ( StrUpr(genclassname(FD)) == StrUpr("DVFirstDocFXDeal") )
              if (((FD.deal.rec.kind == 12730)  or (FD.deal.rec.kind == 22730))and (FD.ВалютаТребования() != NATCUR))
                if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                    (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
                  )
                  return 1;
                end; 
                /*PNV 509039*/
              elif (FD.isBnote() and (FD.ВалютаТребования() != NATCUR))
                if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                    (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
                  )
                  return 1;
                end; 
                /*PNV 509039*/
                else 
                  if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаОбязательства())) and
                      (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL))
                    )
                    return 1;
                  end;
                end;
              else 
                if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаОбязательства()))) and
                    (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, iif(FD.IsDealMet(), FD.nFI.rec.PriceFIID, FD.ВалютаОбязательства()), null, null, MC_PAIRACCMODE_MANUAL))
                  )
                  return 1;
                end;
              end;
            end;
          end;
          if( not ПроводкаПоКатегориямУчета( FD,
                                             AccMinus, AccountC,
                                             ДатаИсполненияШага,
                                             1,
                                             NATCUR, abs(Sкр),
                                             doc,
                                             INPCARRY, "", "",
                                             Ground,
                                             null,
                                             null, null,
                                             null, null,
                                             null, null,
                                             null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                           )
            )
            return 1;
          end;
        end;     
    else/*((FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsSale())*/
      if( Sкр > $0 )
        if( (not FD.IsExistAccount("+Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR))) /*PNV 532711*/
          if( not FD.OpenAccount("+Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
            return 1;
          end;
        end;/*PNV 532711*/
        if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, null, AccountC, null, ДатаИсполненияШага)) and
            (not FD.OpenAccount("Выбытие ДМ", null, false, null, AccountC, ДатаИсполненияШага))
          )
          return 1;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccountC, AccPlus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, Sкр,
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,true,null)
                                          )
          )
          return 1;
        end;

        /*PNV переносим сумму с 61213 на 30118*/
        if ((FD.Биржевая() ) and (FD.ВидБазовогоАктива() == FIKIND_METAL) )
          /*PNV 501129*/
          sum = FD.Суммаобязательства();
          if (FD.ВалютаТребования() == NATCUR)
            sum = FD.СуммаТребования() - abs(Sкр);
          end;          
          /*PNV 501129*/               
          if( not ПроводкаПоКатегориямУчета( FD,
                                             "Выбытие ДМ", "КлиринговыеСчетаДМ", 
                                             ДатаИсполненияШага,
                                             1,
                                             FD.ВалютаТребования(), sum, /*PNV 501129*/
                                             doc,
                                             INPCARRY, "", "",
                                             "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],
                                             null,
                                             FIROLE_BA, FIROLE_FIREQ,
                                             NATCUR, FD.ВалютаОбязательства(),
                                             null, null,
                                             null, null, null, null, null, null, null, null
                                           )
            )
            return 1;
          end;
        end; 
        /*PNV*/
      else/*Sкр < $0*/
        if( (not FD.IsExistAccount("-Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR)))/*PNV 532711*/
          if( not FD.OpenAccount("-Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
            return 1;
          end;
        end; /*PNV 532711*/
        if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, null, AccountC, null, ДатаИсполненияШага)) and
            (not FD.OpenAccount("Выбытие ДМ", null, false, null, AccountC, ДатаИсполненияШага))
          )
          return 1;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccMinus, AccountC,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Sкр),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                         )
          )
          return 1;
        end;
        /*PNV переносим сумму с 61213 на 30118*/
        if ((FD.Биржевая() ) and (FD.ВидБазовогоАктива() == FIKIND_METAL) )
        /*PNV 501129*/
          sum = FD.Суммаобязательства();
          if (FD.ВалютаТребования() == NATCUR)
            sum = FD.СуммаТребования() + abs(Sкр);
          end;          
          /*PNV 501129*/
          if( not ПроводкаПоКатегориямУчета( FD,
                                             "Выбытие ДМ", "КлиринговыеСчетаДМ",
                                             ДатаИсполненияШага,
                                             1,
                                             FD.ВалютаТребования(), sum, /*PNV 501129*/
                                             doc,
                                             INPCARRY, "", "",
                                             "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],
                                             null,
                                             FIROLE_BA, FIROLE_FIREQ,
                                             NATCUR, FD.ВалютаОбязательства(),
                                             null, null,
                                             null, null, null, null, null, null, null, null
                                           )
            )
            return 1;
          end;
        end;
        /*PNV*/
      end;     
    end;
  end;
                                                                                                                                                               
  return 0;
END;

/**
 @brief Проверка, существует ли переоценка на дату выполнения шага
 @param[in] FD Первичный документ операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @return    Флаг результатов поиска (true - шаг переоценки найден, false - шаг не найден)
*/
PRIVATE MACRO ПИКО_ЕстьШагПереоцЗаДатуСделки( FD, ДатаИсполненияШага:DATE ):bool
   var RetVal = false;
   var Query, Data;

   Query = RSDCommand( " SELECT COUNT(1) AS CountStep " +
                       "   FROM doprstep_dbt step, doproper_dbt oper, doprdocs_dbt doc  " +  /*PNV проверяем не просто шаг, а шаг с проводкой*/
                       "  WHERE oper.t_DocKind      = ? AND " +
                       "        oper.t_DocumentID   = ? AND " +
                       "        step.t_ID_Operation = oper.t_ID_Operation AND " +
                       "        step.t_Symbol       = 'П' AND " +
                       "        step.t_Plan_Date    = ?   AND    " +
                       "        doc.t_ID_Operation = oper.t_ID_Operation AND " + /*PNV*/
                       "        doc.t_id_step = step.t_id_step AND "           + /*PNV*/
                       "        doc.t_dockind = ? ");                            /*PNV*/
   Query.NullConversion = true;
   Query.addParam("", RSDBP_IN, FD.Kind );
   Query.addParam("", RSDBP_IN, UniID(FD.Deal, OBJTYPE_FXOPER_DV) );
   Query.addParam("", RSDBP_IN, ДатаИсполненияШага );
   Query.addParam("", RSDBP_IN, DLDOC_CARRY); /*PNV*/
   Query.execute();

   Data = TRsbDataSet(Query);
   if( Data.MoveNext() and (Data.CountStep > 0) )
     RetVal = true;
   end;

  return RetVal;
END;

/**
 @brief Функция формирования проводок по учёту курсовой разницы или финансового результата
 @param[in] FD Первичный документ операции
 @param[in] doc Буфер временного файла операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @param[in] КатегорияУчета Категория учёта для подбора счёта проводок
 @param[in] kind Вид проводок. 1 - курсовая разница, 2 - финансовый результат.
 @param[in] FIROLE Роль финансового инструмента для формирования проводок
 @return    Флаг исполнения функции (0 - исполнена без ошибок, 1 - с ошибками)
*/
MACRO УчетКурсовойРазницыИлиФинРез(FD, doc, ДатаИсполненияШага, КатегорияУчета, kind, FIROLE):integer /*PNV 517605*/
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var Sпер = $0;
  var FIROLE_ = FIROLE_UNDEF; /*PNV 517605*/

  var IsNeedCorrect = false;
  /*PNV 517605*/
  if (FIROLE != null)
    FIROLE_ = FIROLE;
  end;
  /*PNV 517605*/

  if( ПИКО_ЕстьШагПереоцЗаДатуСделки( FD, ДатаИсполненияШага ) )
    return 0;
  end;

   var Rдм = $0, Rвп = $0;
   if( not DV_SmartConvertSumDbl( Rдм, 1.0, ДатаИсполненияШага, FD.ВалютаБазовогоАктива(), NATCUR, true ) )
      return 1;
   end;
   if( not DV_SmartConvertSumDbl( Rвп, 1.0,  ДатаИсполненияШага, FD.ВалютаКонтрАктива(), NATCUR, true ) )
      return 1;
   end;
   Sпер = FD.nFI.rec.Amount * Rдм - (FD.nFI.rec.Cost - FD.nFi.rec.VATSUM) * Rвп;

  if( Sпер != $0 )
    IsNeedCorrect = true;
  end;

  if( IsNeedCorrect )
    if(((Sпер > 0) and (kind == 1)) OR ((Sпер < 0) and (kind == 2)))
      if( not FD.IsExistAccount(КатегорияУчета, null, true, iif(kind, FIROLE_,FIROLE_FIRST_OVERVAL), AccPlus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR))/*PNV 517605*/
        if( not FD.OpenAccount(КатегорияУчета, null, false, iif(kind, FIROLE_,FIROLE_FIRST_OVERVAL), AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )/*PNV 517605*/
          return 1;
        end;
      end;
      if( not ПроводкаПоКатегориямУчета( FD,
                                         AccPlus, IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "+Маржа, ДМ", "+Маржа, ИВ и ДМ"),
                                         ДатаИсполненияШага,
                                         1,
                                         NATCUR, abs(Sпер),
                                         doc,
                                         INPCARRY, "", "",
                                         /*"Учет "*/"Отражение "+ IIF((kind == 1), "курсовой разницы", "финансового результата") + " сделки "+FD.DealCode() + " от "+ FD.ДатаСделки()+ ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],/*CHVA 517782*/
                                         null,
                                         null, FIROLE_BA
                                       )
        )
        return 1;
      end;
    else
      if( not FD.IsExistAccount(КатегорияУчета, null, true, iif(kind, FIROLE_,FIROLE_FIRST_OVERVAL), AccMinus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR)) /*PNV 517605*/
        if( not FD.OpenAccount(КатегорияУчета, null, false, iif(kind, FIROLE_,FIROLE_FIRST_OVERVAL), AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) ) /*PNV 517605*/
          return 1;
        end;
      end;
      if( not ПроводкаПоКатегориямУчета( FD,
                                         IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "-Маржа, ДМ", "-Маржа, ИВ и ДМ"), AccMinus,
                                         ДатаИсполненияШага,
                                         1,
                                         NATCUR, abs(Sпер),
                                         doc,
                                         INPCARRY, "", "",
                                         /*"Учет "*/"Отражение "+ IIF((kind == 1), "курсовой разницы", "финансового результата") + " сделки "+FD.DealCode() + " от "+ FD.ДатаСделки()+ ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],/*CHVA 517782*/
                                         null,
                                         FIROLE_BA)
        )
        return 1;
      end;
    end;
  end;

  return 0;
END;

/**
 @brief Функция списания переоценки финансового результата по части сделки
 @param[in] FD Первичный документ операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @param[in] doc Буфер временного файла операции
 @return    Флаг исполнения функции (0 - исполнена без ошибок, 1 - с ошибками)

 TEG копия функции для списания вместо переоценки финреза на Т0
*/
MACRO ПИКО_СписатьПереоценкуЧастиСделкиФинрез(FD, ДатаИсполненияШага, doc):integer
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var AccountC = TRecHandler("account");
  var Sкр = $0, SumEq_Payer = $0, SumEq_Receiver = $0, categ = "", curr = -1;  /*PNV*/
  var Ground = "Отражение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor);
  /*PNV*/
  if (FD.IsBuy())
    categ = ПИ_КатегорияПлФорвардРПИ();
    curr = FD.ВалютаТребования();
  end;
  /*PNV*/

  if( ПИКО_ПереоценкаНеНужна(FD) )
    return 0;
  end;

  if( ПИКО_УрегулироватьПарныеСчетаПереоценкиЧастиСделки(FD, ДатаИсполненияШага, doc) != 0 )
    return 1;
  end;

  if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребования(), ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, true) )
    return 1;
  end;

  if( not DV_SmartConvertSum(SumEq_Receiver, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.ВалютаОбязательства(), NATCUR, true) )
    return 1;
  end;

  Sкр = SumEq_Payer - SumEq_Receiver;
  if( Sкр != 0 )     
    if( (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) or ((FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsBuyPart()) )
      if( Sкр > $0 )
        if( not FD.OpenAccount(IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "+Маржа, ДМ", "+Маржа, ИВ и ДМ0"), null, false, FIROLE_BA, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
          return 1;
        end;

        if ( (FD.ВалютаОбязательства() != NATCUR) and (FD.ВалютаТребования() == NATCUR) and (not FD.IsBuyPart()) and not(FD.ВидБазовогоАктива() == FIKIND_METAL)) 
          if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаОбязательства())) and
              (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        else
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)               
            if( (not FD.IsExistAccount("+Форвард, расчетыДМ", null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()))) and/*PNV*/
                (not FD.OpenAccount("+Форвард, расчетыДМ", null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))/*PNV*/
              )
              return 1;
            end;
          else
            if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
              )
              return 1;
            end;
            /*PNV 518425*/
            if( not FD.OpenAccount(IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "+Маржа, ДМ", "+Маржа, ИВ и ДМ0"), null, false, FIROLE_FIREQ, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
            end;
            /*PNV 518425*/
          end;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccountC, AccPlus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, Sкр,
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,true,null)
                                         )
          )
          return 1;
        end;
      else/*Sкр < $0*/
        if( not FD.OpenAccount(IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "-Маржа, ДМ", "-Маржа, ИВ и ДМ0"), null, false, FIROLE_BA, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
          return 1;
        end;
        if ( (FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования() != NATCUR) and ( FD.IsBuyPart() ) and not (FD.ВидБазовогоАктива() == FIKIND_METAL) )
          if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
              (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
            )
            return 1;
          end;
        else
          if (FD.ВидБазовогоАктива() == FIKIND_METAL)
            if( (not FD.IsExistAccount("+Форвард, расчетыДМ",  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, IIF( FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()))) and
                (not FD.OpenAccount("+Форвард, расчетыДМ",  null, false,  FIROLE_FIREQ, AccountC, ДатаИсполненияШага, iif(FD.isbuypart(),FD.ВалютаОбязательства(),FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))
              )
              return 1;
            end;
            /*PNV*/
          elif ( (FD.ВалютаОбязательства() != NATCUR) and (FD.ВалютаТребования() != NATCUR) )
            if( (not FD.IsExistAccount(IIF((categ != ""), categ, ПИ_КатегорияПлФорвардРПИ()),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, IIF((curr != -1), curr, FD.ВалютаТребования()))) and  /*PNV*/
                (not FD.OpenAccount(IIF((categ != ""), categ, ПИ_КатегорияПлФорвардРПИ()), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, IIF((curr != -1), curr, FD.ВалютаТребования()), null, null, MC_PAIRACCMODE_MANUAL))  /*PNV*/
              )
              return 1;
            end;
            /*PNV 518425*/
            if( not FD.OpenAccount(IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "-Маржа, ДМ", "-Маржа, ИВ и ДМ0"), null, false, FIROLE_FIREQ, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
            end;
            /*PNV 518425*/
            /*PNV*/
          else
            if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаОбязательства())) and
                (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL))
              )
              return 1;
            end;
          end;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccMinus, AccountC,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Sкр),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                         )
          )
          return 1;
        end;
      end;     
    else/*((FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsSale())*/
      if( Sкр > $0 )
        if( not FD.OpenAccount(IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "+Маржа, ДМ", "+Маржа, ИВ и ДМ0"), null, false, FIROLE_BA/*IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL)*/, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
          return 1;
        end;
        if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, null, AccountC, null, ДатаИсполненияШага)) and
            (not FD.OpenAccount("Выбытие ДМ", null, false, null, AccountC, ДатаИсполненияШага))
          )
          return 1;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccountC, AccPlus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, Sкр,
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,true,null)
                                         )
          )
           return 1;
        end;
        /*PNV переносим сумму с 61213 на 30118*/
        if ((FD.Биржевая() ) and (FD.ВидБазовогоАктива() == FIKIND_METAL)  )
          Ground = "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0];
          if( not ПроводкаПоКатегориямУчета( FD,
                                             "Выбытие ДМ", "КлиринговыеСчетаДМ", 
                                             ДатаИсполненияШага,
                                             1,
                                             FD.ВалютаТребования(), FD.СуммаТребования() - abs(Sкр),
                                             doc,
                                             INPCARRY, "", "",
                                             Ground,
                                             null,
                                             FIROLE_BA, FIROLE_FIREQ,
                                             NATCUR, FD.ВалютаОбязательства(),
                                             null, null,
                                             null, null, null, null, null, null, null, null
                                           )
            )
            return 1;
          end;
        end; 
      /*PNV*/
      else/*Sкр < $0*/
        if( not FD.OpenAccount(IIF(CheckDealAndDateFor793P(FD,ДатаИсполненияШага), "-Маржа, ДМ", "-Маржа, ИВ и ДМ0"), null, false, FIROLE_BA/*IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL)*/, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
          return 1;
        end;
        if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, null, AccountC, null, ДатаИсполненияШага)) and
            (not FD.OpenAccount("Выбытие ДМ", null, false, null, AccountC, ДатаИсполненияШага))
          )
          return 1;
        end;
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccMinus, AccountC,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Sкр),
                                           doc,
                                           INPCARRY, "", "",
                                           Ground,
                                           null,
                                           null, null,
                                           null, null,
                                           null, null,
                                           null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                         )
          )
           return 1;
        end;
        /*PNV переносим сумму с 61213 на 30118*/
        if ((FD.Биржевая() ) and (FD.ВидБазовогоАктива() == FIKIND_METAL) )
          Ground = "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0];
          if( not ПроводкаПоКатегориямУчета( FD,
                                             "Выбытие ДМ", "КлиринговыеСчетаДМ", 
                                             ДатаИсполненияШага,
                                             1,
                                             FD.ВалютаТребования(), FD.СуммаТребования() + abs(Sкр),
                                             doc,
                                             INPCARRY, "", "",
                                             Ground,
                                             null,
                                             FIROLE_BA, FIROLE_FIREQ,
                                             NATCUR, FD.ВалютаОбязательства(),
                                             null, null,
                                             null, null, null, null, null, null, null, null
                                           )
            )
            return 1;
          end;
        end; 
        /*PNV*/
      end;     
    end;
  end;
  return 0;
END;

MACRO ПИКО_СписатьПереоценкуЧастиБанкнотнойСделки(FD, ДатаИсполненияШага, doc):integer
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var AccountC = TRecHandler("account");
  var Sкр = $0, SumEq_Payer = $0, SumEq_Receiver = $0;
  var Ground = "Отражение финансового результата по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/;

  if( ПИКО_УрегулироватьПарныеСчетаПереоценкиЧастиСделки(FD, ДатаИсполненияШага, doc) != 0 )
     return 1;
  end;
  if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребования(), ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, true) )
     return 1;
  end;
  if( not DV_SmartConvertSum(SumEq_Receiver, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.ВалютаОбязательства(), NATCUR, true) )
     return 1;
  end;
  Sкр = SumEq_Payer - SumEq_Receiver;
  if( Sкр != 0 )
     if( (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) or ((FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsBuyPart()) )
        if( Sкр > $0 )
           if ( (FD.ВалютаОбязательства() != NATCUR) and (FD.ВалютаТребования() == NATCUR) and (not(FD.ВидБазовогоАктива() == FIKIND_METAL) ) ) 
              if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаОбязательства())) and
                  (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL))
                )
                 return 1;
              end;
            /*PNV 499068*/
              if( not FD.OpenAccount("+МаржаН", null, false, FIROLE_FICOM, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
                  return 1;
              end;
          /*PNV 499068*/
          /*PNV 511994*/
          elif ( (FD.ВалютаТребования() != NATCUR) and (FD.ВалютаОбязательства() == NATCUR) and ( not(FD.ВидБазовогоАктива() == FIKIND_METAL))) 
              if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                  (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
                )
                 return 1;
              end;
              /*PNV 499068*/
              if( not FD.OpenAccount("+МаржаН", null, false, FIROLE_FIREQ, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
                  return 1;
              end;
              /*PNV 511994*/
           else
             if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                 (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
               )
                return 1;
             end;
           /*PNV 499068*/
             if( not FD.OpenAccount("+МаржаН", null, false, FIROLE_FIREQ, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
                 return 1;
             end;
          /*PNV 499068*/
           end;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccountC, AccPlus,
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, Sкр,
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null,
                                              null, null,
                                              null, null,
                                              null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,true,null)
                                            )
             )
              return 1;
           end;
        else/*Sкр < $0*/
           if ( (FD.ВалютаОбязательства() == NATCUR) and (FD.ВалютаТребования() != NATCUR) and (not (FD.ВидБазовогоАктива() == FIKIND_METAL) )) 
              if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                  (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
                )
                 return 1;
              end;
            /*PNV 499068*/
              if( not FD.OpenAccount("-МаржаН", null, false, FIROLE_FIREQ, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
                  return 1;
              end;
            /*PNV 499068*/
           /*PNV 511994*/
           elif ( (FD.ВалютаТребования() == NATCUR) and (FD.ВалютаОбязательства() != NATCUR) and ( not (FD.ВидБазовогоАктива() == FIKIND_METAL) )) 
              if( (not FD.IsExistAccount(ПИ_КатегорияМнФорвардРПИ(),  null, true, FIROLE_FICOM, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаОбязательства())) and
                  (not FD.OpenAccount(ПИ_КатегорияМнФорвардРПИ(), null, false, FIROLE_FICOM, AccountC, ДатаИсполненияШага, FD.ВалютаОбязательства(), null, null, MC_PAIRACCMODE_MANUAL))
                )
                 return 1;
              end;
            /*PNV 499068*/
              if( not FD.OpenAccount("-МаржаН", null, false, FIROLE_FICOM, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
                  return 1;
              end;
            /*PNV 499068*/
           /*PNV 511994*/
           else
              if( (not FD.IsExistAccount(ПИ_КатегорияПлФорвардРПИ(),  null, true, FIROLE_FIREQ, AccountC, MC_PAIRACCMODE_MANUAL, ДатаИсполненияШага, FD.ВалютаТребования())) and
                  (not FD.OpenAccount(ПИ_КатегорияПлФорвардРПИ(), null, false, FIROLE_FIREQ, AccountC, ДатаИсполненияШага, FD.ВалютаТребования(), null, null, MC_PAIRACCMODE_MANUAL))
                )
                 return 1;
              end;
            /*PNV 499068*/
              if( not FD.OpenAccount("-МаржаН", null, false, /*FIROLE_FICOM*/FIROLE_FIREQ, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
                  return 1;
              end;
            /*PNV 499068*/
           end;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccMinus, AccountC,
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(Sкр),
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null,
                                              null, null,
                                              null, null,
                                              null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                            )
             )
              return 1;
           end;
        end;     
     else/*((FD.ВидБазовогоАктива() == FIKIND_METAL) and FD.IsSale())*/
        if( Sкр > $0 )
           if( not FD.OpenAccount("+МаржаН", null, false, FIROLE_BA/*IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL)*/, AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
           end;
           if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, null, AccountC, null, ДатаИсполненияШага)) and
               (not FD.OpenAccount("Выбытие ДМ", null, false, null, AccountC, ДатаИсполненияШага))
             )
              return 1;
           end;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccountC, AccPlus,
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, Sкр,
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null,
                                              null, null,
                                              null, null,
                                              null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,true,null)
                                            )
             )
              return 1;
           end;
        else/*Sкр < $0*/
           if( not FD.OpenAccount("-МаржаН", null, false, FIROLE_BA/*IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL)*/, AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
              return 1;
           end;
           if( (not FD.IsExistAccount("Выбытие ДМ",  null, true, null, AccountC, null, ДатаИсполненияШага)) and
               (not FD.OpenAccount("Выбытие ДМ", null, false, null, AccountC, ДатаИсполненияШага))
             )
              return 1;
           end;
           if( not ПроводкаПоКатегориямУчета( FD,
                                              AccMinus, AccountC,
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(Sкр),
                                              doc,
                                              INPCARRY, "", "",
                                              Ground,
                                              null,
                                              null, null,
                                              null, null,
                                              null, null,
                                              null, null, null, null, null, null, null, null, iif(AccountC.rec.Code_Currency!=NATCUR,false,null)
                                            )
             )
              return 1;
           end;
        end;     
     end;
  end;
  return 0;
END;
MACRO ПИКО_ПоставитьНаБалансБанкнотнуюСделкуПродажа( FD, doc, ДатаИсполненияШага, KUNezav ):integer

  var СчетОбяз = TRecHandler("account.dbt");
  var СчетТреб = TRecHandler("account.dbt");
  var НеФормЯдернПроводкуКурсРазницы = (FD.nFI.rec.OperState == DL_LEG_OUTBAL);
  VAR ВалютаТребования,ВалютаОбязательства, СуммаОбязательства, СуммаТребования ;



  if( FD.nFI.rec.OperState == DL_LEG_OUTBAL )

     if( (not FD.IsExistAccount(iif(FD.IsSwap(),"-Форвард, дрейф внебирж","-Форвард, прочие"), null, false, FIROLE_FICOM, СчетОбяз, null, ДатаИсполненияШага, FD.ВалютаОбязательства())) or
         (not FD.IsExistAccount(iif(FD.IsSwap(),"+Форвард, дрейф внебирж","+Форвард, прочие"), null, false, FIROLE_FIREQ, СчетТреб, null, ДатаИсполненияШага, FD.ВалютаТребования()))
       )
        return 1;
     end;

     FD.SetFIIDForCorAccNum(FD.ВалютаТребования());
     if( not ПроводкаПоКатегориямУчета( FD,
                                        "СчКорреспГлаваГ", СчетТреб,
                                        ДатаИсполненияШага,
                                        4,
                                        FD.ВалютаТребования(),
                                        FD.СуммаТребования(),
                                        doc,
                                        INPCARRY, "", "",
                                        "Снятие требований с внебалансового учета по" + IIF(FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                        null,
                                        FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE), null
                                      )
       )
        return 1;
     end;

     FD.SetFIIDForCorAccNum(FD.ВалютаОбязательства());
     if( not ПроводкаПоКатегориямУчета( FD,
                                        СчетОбяз, "СчКорреспГлаваГ",
                                        ДатаИсполненияШага,
                                        4,
                                        FD.ВалютаОбязательства(),
                                        FD.СуммаОбязательства(),
                                        doc,
                                        INPCARRY, "", "",
                                        "Снятие обязательств с внебалансового учета по" + IIF(FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                        null,
                                        null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                      )
       )
        return 1;
     end;
  end;

  if( FD.IsBNote() and (FD.ВалютаБазовогоАктива() == FD.ВалютаКонтрАктива()) )
     var ВР:integer = FD.ВалютаТребования();
     var СуммаС:money = min(FD.СуммаТребования(), FD.СуммаОбязательства());

     var AccountNT = TBFile( "account" );
         AccountNT.Clear();

     if( FD.СуммаТребования() != FD.СуммаОбязательства() )
        var СуммаКВ:money = FD.СуммаТребования() - FD.СуммаОбязательства();
        var СуммаКВ_NC:money = $0.0;

        if( not DV_SmartConvertSum(СуммаКВ_NC, СуммаКВ, ДатаИсполненияШага, ВР, NATCUR, true) )
           return 1;
        end;

        if( СуммаКВ < 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                             IIF( (FD.ВалютаТребования() == FD.ВалютаОбязательства()),  "-КВ, н/в",  "-МаржаН"),  "-Расчеты",/*PNV*/
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(СуммаКВ_NC),
                                              doc,
                                              INPCARRY, "", "",
                                              "Отражение требований и обязательств по сделке № "  + FD.DealCode() + " от " +StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              null, FIROLE_FICOM,
                                              NATCUR, ВР,
                                              ВР, abs(СуммаКВ),
                                              null, null, null, null, null, null,
                                              null, MC_PAIRACCMODE_MANUAL
                                            )
             )
              return 1;
           end;
          if (FD.ВалютаТребования() == FD.ВалютаОбязательства())
                СуммаКВ_NC = СуммаКВ;
          end;

          if( not ПроводкаПоКатегориямУчета( FD,
                                            "-Расчеты", KUNezav,  
                                            ДатаИсполненияШага,
                                            1,
                                            IIF ( (FD.ВалютаТребования() == FD.ВалютаОбязательства()), FD.ВалютаТребования(), NATCUR), abs(СуммаКВ_NC),
                                            doc,
                                            INPCARRY, "", "",
                                            "Зачет требований/обязательств по банкнотной сделке № " + FD.DealCode() + " от " +StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ 
                                            null,
                                            null, FIROLE_FICOM,
                                            FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                            FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                            null, null, null, null, null, null,
                                            null, MC_PAIRACCMODE_MANUAL
                                          )
           )
              return 1;
           end;


        elif( СуммаКВ > 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              "+Расчеты", IIF ( (FD.ВалютаТребования() == FD.ВалютаОбязательства()),  "+КВ, н/в", "+МаржаН"), /*PNV*/
                                              //"+Расчеты", "+КВ, н/в", 
                                              ДатаИсполненияШага,
                                              1,
                                              ВР, abs(СуммаКВ),
                                              doc,
                                              INPCARRY, "", "",
                                              "Начисление требований по уплате комиссионного сбора за продажу нал.валюты по банкнотной сделке № " + FD.DealCode() + " от " + FD.ДатаСделки() + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FIREQ, null,
                                              ВР, NATCUR,
                                              NATCUR, abs(СуммаКВ_NC),
                                              null, null, null, null, null, null,
                                              MC_PAIRACCMODE_MANUAL, null
                                            )
             )
              return 1;
           end;

           if (FD.ВалютаТребования() == FD.ВалютаОбязательства())
                СуммаКВ_NC = СуммаКВ;
           end;

           if( not ПроводкаПоКатегориямУчета( FD,
                                            KUNezav, "+Расчеты",
                                            ДатаИсполненияШага,
                                            1,
                                            IIF ( (FD.ВалютаТребования() == FD.ВалютаОбязательства()), FD.ВалютаТребования(), NATCUR), abs(СуммаКВ_NC),
                                            doc,
                                            INPCARRY, "", "",
                                            "Зачет требований/обязательств по банкнотной сделке № " + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/  
                                            null,
                                            null, FIROLE_FICOM,
                                            FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                            FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                            null, null, null, null, null, null,
                                            null, MC_PAIRACCMODE_MANUAL
                                          )
           )
              return 1;
           end;

        end;

     end;
  else



  if (dmdm(FD.id) > 0)
          ВалютаТребования=FD.ВалютаТребования();
          СуммаТребования= FD.СуммаТребования();
          ВалютаОбязательства=FD.ВалютаОбязательства();
          СуммаОбязательства=FD.СуммаОбязательства();
          if (fx_sd(FD.id,"type") == 2)
              ВалютаОбязательства=ВалютаТребования;
              СуммаОбязательства=СуммаТребования;
          else
              ВалютаТребования=ВалютаОбязательства;
              СуммаТребования= СуммаОбязательства;
          end;

     if( not ПроводкаПоКатегориямУчета( FD,
                                        ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(),
                                        ДатаИсполненияШага,
                                        1,
                                        ВалютаТребования, СуммаТребования,
                                        doc,
                                        INPCARRY, "", "",
                                        "! Отражение требований и обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+ FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                        null,
                                        FIROLE_FIREQ, FIROLE_FICOM,
                                        ВалютаТребования, ВалютаОбязательства,
                                        ВалютаОбязательства, СуммаОбязательства,
                                        null, null, null, null, null, null,
                                        MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                        null, null, null, null, null, null, null, null, НеФормЯдернПроводкуКурсРазницы
                                      )
       )
        return 1;
     end;
  else
     var AccountN = TBFile( "account" );
         AccountN.Clear();
         AccountN.rec.account = RsbPayment(FD.ПлатежОб.rec.PaymentID).ReceiverAccount;/*PNV*/
         AccountN.rec.Chapter = 1;
         AccountN.rec.Code_Currency = FD.ВалютаОбязательства();
     

     if( not ПроводкаПоКатегориямУчета( FD,
                                        ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(), 
                                        ДатаИсполненияШага,
                                        1,
                                        FD.ВалютаТребования(), FD.СуммаТребования(),
                                        doc,
                                        INPCARRY, "", "",
                                        "Отражение требований и обязательств по сделке № "  + FD.DealCode() + " от " +StrSubSt(String(FD.ДатаСделки():f), ".", "/")+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                        null,
                                        FIROLE_FIREQ, FIROLE_FICOM,
                                        FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                        FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                            null, null, null, null, null, null,
                                        MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                        null, null, null, null, null, null, null, null, iif( ( (FD.СрокСделки()==0) or (ДатаИсполненияШага == FD.ДатаСделки()) ),true,НеФормЯдернПроводкуКурсРазницы)  /*PNV 511900*/
                                       )
        )
        return 1;
     end;
   end;
   if ((FD.СрокСделки()==0) or (ДатаИсполненияШага == FD.ДатаСделки())) /*PNV 511900*/
       if( ПИКО_СписатьПереоценкуЧастиБанкнотнойСделки(FD, ДатаИсполненияШага, doc) != 0 )
         return 1;
        end;
   end;

    if( НеФормЯдернПроводкуКурсРазницы )
        if( ПИКО_СписатьПереоценкуЧастиСделки(FD, ДатаИсполненияШага, doc) != 0 )
           return 1;
        end;
    end;

  end;

  if( not DV_ОбновитьСтатусЧастиСделки(FD.nFI, DL_LEG_BALANCE) )
     MsgBox("Ошибка при изменении статуса сделки");
     return 1;
  end;

  /* устанавливаем признак участия в неттинге */
  if( (not FD.IsClient()) and FD.Netting() )
     if( (FD.ПлатежТреб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежТреб.rec.PayerAccount)) )
        var ПлатежТреб = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
        ПлатежТреб.Netting = SET_CHAR;
     end;

     if( (FD.ПлатежОб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежОб.rec.ReceiverAccount)) )
        var ПлатежОб = RsbPayment(FD.ПлатежОб.rec.PaymentID);
        ПлатежОб.Netting = SET_CHAR;
     end;
  end;

  return 0;
END;


MACRO ПИКО_ПоставитьНаБалансБанкнотнуюСделку( FD, doc, ДатаИсполненияШага , KUNezav):integer

  var СчетОбяз = TRecHandler("account.dbt");
  var СчетТреб = TRecHandler("account.dbt");
  var НеФормЯдернПроводкуКурсРазницы = (FD.nFI.rec.OperState == DL_LEG_OUTBAL);
  VAR ВалютаТребования,ВалютаОбязательства, СуммаОбязательства, СуммаТребования ;



  if( FD.nFI.rec.OperState == DL_LEG_OUTBAL )

     if( (not FD.IsExistAccount(iif(FD.IsSwap(),"-Форвард, дрейф внебирж","-Форвард, прочие"), null, false, FIROLE_FICOM, СчетОбяз, null, ДатаИсполненияШага, FD.ВалютаОбязательства())) or
         (not FD.IsExistAccount(iif(FD.IsSwap(),"+Форвард, дрейф внебирж","+Форвард, прочие"), null, false, FIROLE_FIREQ, СчетТреб, null, ДатаИсполненияШага, FD.ВалютаТребования()))
       )
        return 1;
     end;

     FD.SetFIIDForCorAccNum(FD.ВалютаТребования());
     if( not ПроводкаПоКатегориямУчета( FD,
                                        "СчКорреспГлаваГ", СчетТреб,
                                        ДатаИсполненияШага,
                                        4,
                                        FD.ВалютаТребования(),
                                        FD.СуммаТребования(),
                                        doc,
                                        INPCARRY, "", "",
                                        "Снятие требований с внебалансового учета по" + IIF(FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                        null,
                                        FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE), null
                                      )
       )
        return 1;
     end;

     FD.SetFIIDForCorAccNum(FD.ВалютаОбязательства());
     if( not ПроводкаПоКатегориямУчета( FD,
                                        СчетОбяз, "СчКорреспГлаваГ",
                                        ДатаИсполненияШага,
                                        4,
                                        FD.ВалютаОбязательства(),
                                        FD.СуммаОбязательства(),
                                        doc,
                                        INPCARRY, "", "",
                                        "Снятие обязательств с внебалансового учета по" + IIF(FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                        null,
                                        null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                      )
       )
        return 1;
     end;
  end;

  if( FD.IsBNote() and (FD.ВалютаБазовогоАктива() == FD.ВалютаКонтрАктива()) )
     var ВР:integer = FD.ВалютаТребования()/*==FD.ВалютаОбязательства()*/;
     var СуммаС:money = min(FD.СуммаТребования(), FD.СуммаОбязательства());

     var AccountNT = TBFile( "account" );
         AccountNT.Clear();
         AccountNT.rec.account = FD.ПлатежТреб.rec.PayerAccount;
         AccountNT.rec.Chapter = 1;
         AccountNT.rec.Code_Currency =FD.ВалютаТребования();
    
      if( FD.СуммаТребования() != FD.СуммаОбязательства() )
        var СуммаКВ:money = FD.СуммаТребования() - FD.СуммаОбязательства();
        var СуммаКВ_NC:money = $0.0;

        if( not DV_SmartConvertSum(СуммаКВ_NC, СуммаКВ, ДатаИсполненияШага, ВР, NATCUR, true) )
           return 1;
        end;

        if( СуммаКВ < 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
                                              "-КВ, н/в", "-Расчеты",
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(СуммаКВ_NC),
                                              doc,
                                              INPCARRY, "", "",
                                              "Начисление обязательств по уплате комиссионного сбора за продажу нал.валюты по банкнотной сделке № " + FD.DealCode() + " от " + FD.ДатаСделки() + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ 
                                              null,
                                              null, FIROLE_FICOM,
                                              NATCUR, ВР,
                                              ВР, abs(СуммаКВ),
                                              null, null, null, null, null, null,
                                              null, MC_PAIRACCMODE_MANUAL
                                            )
             )
              return 1;
           end;

           if( not ПроводкаПоКатегориямУчета( FD,
                                              "-Расчеты", KUNezav,
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(СуммаКВ_NC),
                                              doc,
                                              INPCARRY, "", "",
                                              "Зачет требований/обязательств по банкнотной сделке № " + FD.DealCode() + " от "  + FD.ДатаСделки() + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/ 
                                              null,
                                              null, FIROLE_FICOM,
                                              FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                              FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                              null, null, null, null, null, null,
                                              null, MC_PAIRACCMODE_MANUAL
                                            )
             )
              return 1;
           end;


         elif( СуммаКВ > 0 )
           if( not ПроводкаПоКатегориямУчета( FD,
					      "+Расчеты", IIF ( (FD.ВалютаТребования() == FD.ВалютаОбязательства()),  "+КВ, н/в", "+МаржаН"),/*PNV*/
                                              ДатаИсполненияШага,
                                              1,
                                              ВР, abs(СуммаКВ),
                                              doc,
                                              INPCARRY, "", "",
                                              "Начисление требований по уплате комиссионного сбора за покупку наличной валюты по банкнотной сделке № "  + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/  
                                              null,
                                              FIROLE_FIREQ, null,
                                              ВР, NATCUR,
                                              NATCUR, abs(СуммаКВ_NC),
                                              null, null, null, null, null, null,
                                              MC_PAIRACCMODE_MANUAL, null
                                            )
             )
              return 1;
           end;


        if( not ПроводкаПоКатегориямУчета( FD,
                                              KUNezav, "+Расчеты", 
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(СуммаКВ_NC),
                                              doc,
                                              INPCARRY, "", "",
                                              "Зачет требований/обязательств по банкнотной сделке № " + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              null, FIROLE_FICOM,
                                              FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                              FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                              null, null, null, null, null, null,
                                              null, MC_PAIRACCMODE_MANUAL
                                            )
             )
              return 1;
           end;
 
       end;
      end;
  else

      if (dmdm(FD.id) > 0)
          ВалютаТребования=FD.ВалютаТребования();
          СуммаТребования= FD.СуммаТребования();
          ВалютаОбязательства=FD.ВалютаОбязательства();
          СуммаОбязательства=FD.СуммаОбязательства();
          if (fx_sd(FD.id,"type") == 2)
              ВалютаОбязательства=ВалютаТребования;
              СуммаОбязательства=СуммаТребования;
          else
              ВалютаТребования=ВалютаОбязательства;
              СуммаТребования= СуммаОбязательства;
          end;

           if( not ПроводкаПоКатегориямУчета( FD,
                                              ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(),
                                              ДатаИсполненияШага,
                                              1,
                                              ВалютаТребования, СуммаТребования,
                                              doc,
                                              INPCARRY, "", "",
                                              "! Отражение требований и обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+ FD.DealCode()+ " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              FIROLE_FIREQ, FIROLE_FICOM,
                                              ВалютаТребования, ВалютаОбязательства,
                                              ВалютаОбязательства, СуммаОбязательства,
                                              null, null, null, null, null, null,
                                              MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                              null, null, null, null, null, null, null, null, НеФормЯдернПроводкуКурсРазницы
                                            )
             )
              return 1;
           end;
     else

         var AccountN = TBFile( "account" );
             AccountN.Clear();
             AccountN.rec.account = FD.ПлатежТреб.rec.PayerAccount;
             AccountN.rec.Chapter = 1;
             AccountN.rec.Code_Currency =FD.ВалютаТребования();


         if( not ПроводкаПоКатегориямУчета( FD,
                                            ПИ_КатегорияПлФорвардРПИ(), ПИ_КатегорияМнФорвардРПИ(),
                                            ДатаИсполненияШага,
                                            1,
                                            FD.ВалютаТребования(), FD.СуммаТребования(),
                                            doc,
                                            INPCARRY, "", "",
                                            "Отражение требований и обязательств по сделке  № "  + FD.DealCode() + " от " +StrSubSt(String(FD.ДатаСделки():f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                            null,
                                            FIROLE_FIREQ, FIROLE_FICOM,
                                            FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                            FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                            null, null, null, null, null, null,
                                            MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                            null, null, null, null, null, null, null, null, iif(FD.СрокСделки()==0,true,НеФормЯдернПроводкуКурсРазницы)
                                          )
           )
            return 1;
         end;
      end;  
     if (FD.СрокСделки()==0)
        if( ПИКО_СписатьПереоценкуЧастиБанкнотнойСделки(FD, ДатаИсполненияШага, doc) != 0 )
          return 1;
        end;
      end;

     if( НеФормЯдернПроводкуКурсРазницы )
        if( ПИКО_СписатьПереоценкуЧастиСделки(FD, ДатаИсполненияШага, doc) != 0 )
           return 1;
        end;
     end;

  end;

  if( not DV_ОбновитьСтатусЧастиСделки(FD.nFI, DL_LEG_BALANCE) )
     MsgBox("Ошибка при изменении статуса сделки");
     return 1;
  end;

  /* устанавливаем признак участия в неттинге */
  if( (not FD.IsClient()) and FD.Netting() )
     if( (FD.ПлатежТреб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежТреб.rec.PayerAccount)) )
        var ПлатежТреб = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
        ПлатежТреб.Netting = SET_CHAR;
     end;

     if( (FD.ПлатежОб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежОб.rec.ReceiverAccount)) )
        var ПлатежОб = RsbPayment(FD.ПлатежОб.rec.PaymentID);
        ПлатежОб.Netting = SET_CHAR;
     end;
  end;

  return 0;

END;

/**
 @brief Исполнение проводок по постановке на баланс части сделки
 @param[in] FD Первичный документ операции
 @param[in] doc Буфер временного файла операции
 @param[in] ДатаИсполненияШага Дата шага, на котором формируем проводки
 @return    Флаг исполнения функции (0 - исполнена без ошибок, 1 - с ошибками)
*/
MACRO ПИКО_ПоставитьНаБалансЧастьСделки( FD, doc, ДатаИсполненияШага ):integer
  var СчетОбяз = TRecHandler("account.dbt");
  var СчетТреб = TRecHandler("account.dbt");
  var НеФормЯдернПроводкуКурсРазницы = (FD.nFI.rec.OperState == DL_LEG_OUTBAL);
  VAR ВалютаТребования,ВалютаОбязательства, СуммаОбязательства, СуммаТребования, SumeqPayer, CategDeb, CategCred;/*PNV*/
  var ChangeAccount = false; /*CHVA*/


  if( FD.nFI.rec.OperState == DL_LEG_OUTBAL )
    if( (not FD.IsExistAccount(iif(FD.IsSwap(),"-Форвард, дрейф внебирж","-Форвард, прочие"), null, false, FIROLE_FICOM, СчетОбяз, null, ДатаИсполненияШага, FD.ВалютаОбязательства())) or
        (not FD.IsExistAccount(iif(FD.IsSwap(),"+Форвард, дрейф внебирж","+Форвард, прочие"), null, false, FIROLE_FIREQ, СчетТреб, null, ДатаИсполненияШага, FD.ВалютаТребования()))
      )
      return 1;
    end;

    FD.SetFIIDForCorAccNum(FD.ВалютаТребования());
    if( not ПроводкаПоКатегориямУчета( FD,
                                       "СчКорреспГлаваГ", СчетТреб,
                                       ДатаИсполненияШага,
                                       4,
                                       FD.ВалютаТребования(),
                                       FD.СуммаТребования(),
                                       doc,
                                       INPCARRY, "", "",
                                       "Снятие требований с внебалансового учета по" + IIF(FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                       null,
                                       FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_ACTIVE), null
                                     )
      )
       return 1;
    end;

    FD.SetFIIDForCorAccNum(FD.ВалютаОбязательства());
    if( not ПроводкаПоКатегориямУчета( FD,
                                       СчетОбяз, "СчКорреспГлаваГ",
                                       ДатаИсполненияШага,
                                       4,
                                       FD.ВалютаОбязательства(),
                                       FD.СуммаОбязательства(),
                                       doc,
                                       INPCARRY, "", "",
                                       "Снятие обязательств с внебалансового учета по" + IIF(FD.DealPart == 1," сделке "," второй части сделки ") + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                       null,
                                       null, FD.РольСчКорреспГлаваГВнб(FIROLE_CORACC_PASSIVE)
                                     )
      )
      return 1;
    end;
  /*PNV 508449*/
  else /*не на внебалансе, но даты отличаются, и одна из них соответствует дате заключения - курсовая разница не нужна, мы сформируем свою проводку по фин.резу*/
    if( not FD.IsSWAP()) 
      if ( (FD.СрокСделки() != 0) and (FD.датаТребования() != FD.ДатаОбязательства()) and (FD.датаСделки() == FD.ДатаИсполнения()) and (FD.ВидБазовогоАктива() != FIKIND_METAL) )
        НеФормЯдернПроводкуКурсРазницы = true;
      end;
    end; 
   /*PNV 508449*/
  end;

  if( FD.IsBNote() and (FD.ВалютаБазовогоАктива() == FD.ВалютаКонтрАктива()) )
    var ВР:integer = FD.ВалютаТребования()/*==FD.ВалютаОбязательства()*/;
    var СуммаС:money = min(FD.СуммаТребования(), FD.СуммаОбязательства());

    if( not ПроводкаПоКатегориямУчета( FD,
                                       "+Расчеты", "-Расчеты",
                                       ДатаИсполненияШага,
                                       1,
                                       ВР, СуммаС,
                                       doc,
                                       INPCARRY, "", "",
                                       "Учет банкнотной сделки <" + FD.DealCode() + "> от <" + FD.ДатаСделки() + "> по балансу",
                                       null,
                                       FIROLE_FIREQ, FIROLE_FICOM,
                                       FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                       null, null,
                                       null, null, null, null, null, null,
                                       MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL
                                     )
      )
      return 1;
    end;

    if( FD.СуммаТребования() != FD.СуммаОбязательства() )
      var СуммаКВ:money = FD.СуммаТребования() - FD.СуммаОбязательства();
      var СуммаКВ_NC:money = $0.0;

      if( not DV_SmartConvertSum(СуммаКВ_NC, СуммаКВ, ДатаИсполненияШага, ВР, NATCUR, true) )
        return 1;
      end;

      if( СуммаКВ < 0 )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "-КВ, РКО", "-Расчеты",
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(СуммаКВ_NC),
                                           doc,
                                           INPCARRY, "", "",
                                           "Оплата комиссии по банкнотной сделке <" + FD.DealCode() + "> от <" + FD.ДатаСделки() + "> по балансу",
                                           null,
                                           null, FIROLE_FICOM,
                                           NATCUR, ВР,
                                           ВР, abs(СуммаКВ),
                                           null, null, null, null, null, null,
                                           null, MC_PAIRACCMODE_MANUAL
                                         )
           )
           return 1;
         end;
      elif( СуммаКВ > 0 )
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "+Расчеты", "+КВ, РКО",
                                           ДатаИсполненияШага,
                                           1,
                                           ВР, abs(СуммаКВ),
                                           doc,
                                           INPCARRY, "", "",
                                           "Оплата комиссии по банкнотной сделке <" + FD.DealCode() + "> от <" + FD.ДатаСделки() + "> по балансу",
                                           null,
                                           FIROLE_FIREQ, null,
                                           ВР, NATCUR,
                                           NATCUR, abs(СуммаКВ_NC),
                                           null, null, null, null, null, null,
                                           MC_PAIRACCMODE_MANUAL, null
                                         )
          )
          return 1;
        end;
      end;
    end;
  else
    //teg 19.01.19 убрал излишнюю операцию
    ВалютаТребования=FD.ВалютаТребования();
    СуммаТребования= FD.СуммаТребования();
    ВалютаОбязательства=FD.ВалютаОбязательства();
    СуммаОбязательства=FD.СуммаОбязательства();

    if (dmdm(FD.id) > 0)    
      if (fx_sd(FD.id,"type") == 2)
        ВалютаОбязательства=ВалютаТребования;
        СуммаОбязательства=СуммаТребования;
      else
        ВалютаТребования=ВалютаОбязательства;
        СуммаТребования= СуммаОбязательства;
      end;
    end;

    Categdeb = ПИ_КатегорияПлФорвардРПИ();/*PNV*/
    CategCred = ПИ_КатегорияМнФорвардРПИ();/*PNV*/
    /*PNV здесь по аналогии с исправлениями Чепля Вовы для СВОПов*/     
    if (FD.ВидБазовогоАктива() == FIKIND_METAL) 
      ВалютаТребования = ВалютаОбязательства = IIF (FD.isbuypart(), FD.ВалютаОбязательства(), FD.ВалютаТребования());
      СуммаТребования  = IIF (FD.isbuypart(), FD.СуммаОбязательства(), FD.СуммаТребования());
      Categdeb = "+Форвард, расчетыДМ";/*PNV*/
      CategCred = "-Форвард, расчетыДМ";/*PNV*/
      if ( FD.Биржевая() and FD.isbuy() )
        CategCred = ПИ_КатегорияМнФорвардРПИ();
      elif ( FD.Биржевая() and FD.issale() )
        Categdeb = ПИ_КатегорияПлФорвардРПИ();
      end;
    end;
    /*PNV*/
    if( not ПроводкаПоКатегориямУчета( FD,
                                       Categdeb,/*PNV*/
                                       CategCred,/*PNV*/
                                       ДатаИсполненияШага,
                                       1,
                                       ВалютаТребования, СуммаТребования,
                                       doc,
                                       INPCARRY, "", "",
                                       "Отражение требований и обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                       null,
                                       FIROLE_FIREQ, FIROLE_FICOM,
                                       ВалютаТребования, ВалютаОбязательства,
                                       ВалютаОбязательства, СуммаОбязательства,
                                       null, null, null, null, null, null,
                                       MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                       null, null, null, null, null, null, null, null, iif(FD.СрокСделки()==0,true,НеФормЯдернПроводкуКурсРазницы)
                                     )
      )
      return 1;
    end;
    /*PNV*/
    if ( (FD.ВидБазовогоАктива() == FIKIND_METAL) and ( (FD.Биржевая()) or ( (FD.Netting()) and (FD.СрокСделки() != 0)) /*and (FD.ВалютаКонтрактива() != NATCUR)*/ and (not FD.isbuypart()) ) )/*PNV 491482*//*PNV 501207*/
      var SideTransaction:integer = ACCTRN_SIDE_NONE;
      var ExRateExtra = 0, Skp = 0, SumEq_Payer = 0, SumEq_Receiver = 0;

      if( not DV_SmartConvertSum(SumEq_Payer, FD.СуммаТребования(), ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, false) )
        return SayCarryError( GetCurrencyConvertErrorMsg(FD.ВалютаТребования(), NATCUR, ДатаИсполненияШага) );
      end;
      if( not DV_SmartConvertSum(SumEq_Receiver, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.ВалютаОбязательства(), NATCUR, false) )
        return SayCarryError( GetCurrencyConvertErrorMsg(FD.ВалютаОбязательства(), NATCUR, ДатаИсполненияШага) );
      end;
      Skp = SumEq_Payer - SumEq_Receiver;
      if( FD.IsBuy() )
        SideTransaction = ACCTRN_SIDE_DEBET;   ExRateExtra = Skp;
      elif( FD.IsSale() )
        SideTransaction = ACCTRN_SIDE_CREDIT;  ExRateExtra = -Skp;
      end;

      if(GenClassName(FD) == "DVFIRSTDOCFXDEAL") 
        if (( (FD.Deal.rec.kind == 2730) or (FD.Deal.rec.kind == 22730) or (FD.Deal.rec.kind == 12730) ) and  FD.IsBuy())/*MDA 27.03.19 +12730*/
          ChangeAccount = true;
        end;
      end;
      if( FD.IsBuy() )
        if (ВалютаТребования != NATCUR)
          if( not ПроводкаПоКатегориямУчета( FD,
                                             IIF( ChangeAccount == true ,"КлиринговыеСчетаДМ","Выбытие ДМ"), IIF(FD.isbuypart(), "+Форвард, расчетыДМ", "-Форвард, расчетыДМ"),
                                             ДатаИсполненияШага,
                                             1,
                                             ВалютаТребования, СуммаТребования,
                                             doc,
                                             INPCARRY, "", "",
                                             //"Отражение требований по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                             IIF( ChangeAccount == true ,"Зачисление стоимости ДМ (" + FD.BaseFI().rec.name + ") по сделке " + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), "Отражение требований по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)),/*PNV 525851*/
                                             null,
                                             FIROLE_FIREQ, FIROLE_FIREQ,
                                             IIF( ChangeAccount == true ,FD.ВалютаТребования(), NATCUR), ВалютаОбязательства,
                                             ВалютаОбязательства, СуммаОбязательства,
                                             null, null, null, null, 
                                             SideTransaction, ExRateExtra, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                             null, null, null, null, null, null, null, null, true
                                           )
            )
            return 1;
          end;
        else    
          if( not ПроводкаПоКатегориямУчета( FD,
                                             IIF( ChangeAccount == true ,"КлиринговыеСчетаДМ","Выбытие ДМ"), IIF(FD.isbuypart(), "+Форвард, расчетыДМ", "-Форвард, расчетыДМ"),
                                             ДатаИсполненияШага,
                                             1,
                                             ВалютаТребования, СуммаТребования+ExRateExtra,
                                             doc,
                                             INPCARRY, "", "",
                                             //"Отражение требований по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                             IIF( ChangeAccount == true ,"Зачисление стоимости ДМ (" + FD.BaseFI().rec.name + ") по сделке " + FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), "Отражение требований по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)),/*PNV 525851*/     
                                             null,
                                             FIROLE_FIREQ, FIROLE_FIREQ,
                                             IIF( ChangeAccount == true ,FD.ВалютаТребования(), NATCUR), ВалютаОбязательства,/*CHVA*/
                                             ВалютаОбязательства, СуммаОбязательства,
                                             null, null, null, null, 
                                             SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                             null, null, null, null, null, null, null, null, true
                                           )
            )
            return 1;
          end;
        end;  
      else
        var swapTypeName = "";
        if (FD.IsSwap())
            swapTypeName = FD.PctSwapTypeName(true);
        end;
        if (ВалютаОбязательства != NATCUR)
          if( not ПроводкаПоКатегориямУчета( FD,
                                             IIF(FD.isbuypart(), "+Форвард, расчетыДМ", "-Форвард, расчетыДМ"), "Выбытие ДМ",
                                             ДатаИсполненияШага,
                                             1,
                                             ВалютаОбязательства, СуммаТребования,
                                             doc,
                                             INPCARRY, "", "",
                                             IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                             null,
                                             FIROLE_FICOM, FIROLE_FICOM,
                                             ВалютаТребования, NATCUR, 
                                             ВалютаТребования, СуммаТребования,
                                             null, null, null, null, 
                                             SideTransaction, ExRateExtra, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                             null, null, null, null, null, null, null, null, true
                                           )
            )
            return 1;
          end;
        else    
          if( not ПроводкаПоКатегориямУчета( FD,
                                             IIF(FD.isbuypart(), "+Форвард, расчетыДМ", "-Форвард, расчетыДМ"), "Выбытие ДМ", 
                                             ДатаИсполненияШага,
                                             1,
                                             ВалютаОбязательства, СуммаТребования,
                                             doc,
                                             INPCARRY, "", "",
                                             IIF(FD.IsSwap(), "ПФИ (" + swapTypeName + "). ", "") + "Отражение обязательств по"+IIF(FD.IsSWAP(),iif(FD.DealPart == 1," 1 ч. сделки "," 2 ч. сделки ")," сделке ")+FD.DealCode() + " от "  + FD.ДатаСделки()+ ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                             null,
                                             FIROLE_FICOM, FIROLE_FICOM,
                                             ВалютаТребования, NATCUR, 
                                             ВалютаТребования, СуммаТребования,
                                             null, null, null, null, 
                                             SideTransaction, null, MC_PAIRACCMODE_MANUAL, MC_PAIRACCMODE_MANUAL,
                                             null, null, null, null, null, null, null, null, true
                                           )
            )
            return 1;
          end;
        end;
      end;   
    end;    
    /*PNV*/
    if ( not FD.IsDealMet())
      if ( ((FD.СрокСделки() == 0) and (FD.ВидБазовогоАктива() != FIKIND_METAL)) or ((FD.СрокСделки() == 0) and (FD.датаТребования() == FD.ДатаОбязательства()) and (FD.ВидБазовогоАктива() == FIKIND_METAL)) )/*MDA только для металла условие выше!*/
        if( ПИКО_СписатьПереоценкуЧастиСделкиФинрез(FD, ДатаИсполненияШага, doc) != 0 )
          return 1;
        end;
      end;
    end;
    /*PNV для таких сделок списание переоценки на другом шаге*/
    if (/*(FD.ВидБазовогоАктива() == FIKIND_METAL) and*/ (FD.датаТребования() != FD.ДатаОбязательства() ) ) /*PNV 508449*/
      НеФормЯдернПроводкуКурсРазницы = false;
    end;
    /*PNV 499032*/
    if( НеФормЯдернПроводкуКурсРазницы )
      if( ПИКО_СписатьПереоценкуЧастиСделки(FD, ДатаИсполненияШага, doc) != 0 )
        return 1;
      end;
    end;

    if ( (FD.IsDealMet())  AND (FD.IsBuy()) AND ( (FD.СрокСделки() == 0) OR (FD.ДатаСделки() == FD.ДатаИсполнения()) ) )/*PNV 517605*/
      if( УчетКурсовойРазницыИлиФинРез(FD, doc, ДатаИсполненияШага, /*ПИ_КатегорияПлФорвардРПИ()*/"+Форвард, расчетыДМ", 1, FIROLE_FIREQ) != 0) /*PNV 517605*/
        return 1;
      end;
    end;
  end;

  if( not DV_ОбновитьСтатусЧастиСделки(FD.nFI, DL_LEG_BALANCE) )
    MsgBox("Ошибка при изменении статуса сделки");
    return 1;
  end;

  /* устанавливаем признак участия в неттинге */
  if( (not FD.IsClient()) and FD.Netting() )
    if ( (FD.Биржевая()) and (DL_ЕдиныйПулОбеспеченияСобств == 1) )
    else
      if( (FD.ПлатежТреб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежТреб.rec.PayerAccount)) )
        var ПлатежТреб = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
        ПлатежТреб.Netting = SET_CHAR;
      end;

      if( (FD.ПлатежОб.rec.PaymentID > 0) and (not DV_IsCashAccount(FD.ПлатежОб.rec.ReceiverAccount)) )
        var ПлатежОб = RsbPayment(FD.ПлатежОб.rec.PaymentID);
        ПлатежОб.Netting = SET_CHAR;
      end;
    end;
  end;

  return 0;
END;
MACRO ПИКО_ИсполнитьТребованиеБанкнотнойСделки( FD, ДатаИсполненияШага, doc ):integer
var PaymentTr = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
var ErrMsg = "";
        /*по собственным сделкам актуализируем на шаге постановки на баланс, а по клиентским здесь, т.к. для них шага постановки на баланс нет*/
        if( FD.IsClient() and (ПИКО_АктуализироватьПлатежТреб( FD ) != 0) )
           return 1;
        end;
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentTr, null, ДатаИсполненияШага) )
           return 1;
        end;
        if( ПИ_ИсполнитьПлатеж(PaymentTr) )
           return 1;
        end;
        if( not ПИ_ПроводкаВУПоПлатежуДС(34, FD, ДатаИсполненияШага, doc, PaymentTr, false) )
           return 1;
        end;
  return 0;
END;
MACRO ПИКО_ИсполнитьОбязательствоБанкнотнойСделки( FD, ДатаИсполненияШага, doc ):integer
var PaymentOb = RsbPayment(FD.ПлатежОб.rec.PaymentID);
var ErrMsg = "";
        /*по собственным сделкам актуализируем на шаге постановки на баланс, а по клиентским здесь, т.к. для них шага постановки на баланс нет*/
        if( FD.IsClient() and (ПИКО_АктуализироватьПлатежТреб( FD ) != 0) )
           return 1;
        end;
        if( not ПИ_ПроводкаПоПлатежу(FD, PaymentOb, null, ДатаИсполненияШага) )
           return 1;
        end;
        if( ПИ_ИсполнитьПлатеж(PaymentOb) )
           return 1;
        end;
        if( not ПИ_ПроводкаВУПоПлатежуДС(34, FD, ДатаИсполненияШага, doc, PaymentOb, false) )
           return 1;
        end;
 return 0;
END;

MACRO ПИКО_ИсполнитьТребованиеЧастиСделки( FD, ДатаИсполненияШага, doc ):integer
  var SumeqPayer = 0, Сумма = 0, Acc = ""; /*PNV*/
  file AccBuff( "account.dbt" );

  var Payment = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  var ErrMsg = "";
  var FI = TRecHandler("fininstr.dbt");
  var ВидРО = 0;

  if( not ПИ_СтутусПлатежИсполнен(Payment.PaymStatus) )
     if( FD.СобствБиржеваяСделка() and ПИ_ПлатежВВалюте(Payment) )
        if( ПИ_УстановитьСтатусПлатежа(Payment, PM_CLOSED_W_M_MOVEMENT) )
           MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения средств\"" );
           return 1;
        end;
        if( not ПИ_ПроводкаВУПоПлатежуДС(34, FD, ДатаИсполненияШага, doc, Payment, false) )
           return 1;
        end;
     elif( ПИ_ИнтегрРежимРаботы() and FD.IsBNote() and (DV_IsCashAccount(Payment.PayerAccount)) and (not FD.IsDealMet()))
        if( DVFX_CreateCashOrder(Payment, FD.Deal, true, @ErrMsg) )
           if( ПИ_УстановитьСтатусПлатежа(Payment, PM_READY_TO_SEND) )
              MsgBox("Ошибка при установке платежу статуса \"Готов к отправке\"");
              return 1;
           end;
        else
           MsgBox("Кассовый ордер не сформирован. "+@ErrMsg);
           return 1;
        end;
     else
        if( /*(not FD.IsBNote()) and*/ ПИ_ИнтегрРежимРаботы() and ПИ_РежимКвитовкиПлатежей() and ПИ_ЭтоВнешнийВходящийПлатеж(Payment) and ПИ_ПлатежКвитуетсяПоВидуФИ(Payment) )
           if( Payment.FuturePayerAmount != 0 )
              if( not GetTrue(false, "Плановый платеж "+Payment.PaymentID+" не сквитован полностью. Исполнить требование?") )/*просили не запрещать*//*PNV i-support 504362 по умолчанию - "нет"*/
                 if(not GetDialogFlag())  /*безынтерфейсный режим*/
                    MsgBox("Плановый платеж "+Payment.PaymentID+" не сквитован полностью");
                 end;
                 return 1;
              end;
           end;
        end;
        /*по собственным сделкам актуализируем на шаге постановки на баланс, а по клиентским здесь, т.к. для них шага постановки на баланс нет*/
        if( (FD.IsClient() or FD.IsDealMet()) and (ПИКО_АктуализироватьПлатежТреб( FD ) != 0) )
           return 1;
        end;

       /*PNV i-support 506163*/
        if ( (FD.Kind == DL_DVFXDEAL) and (FD.ВидБазовогоАктива() == FIKIND_METAL))
              /*если заполнено примечание, значит сделка со слитками, проводку не формируем*/ 
              var str = readNoteForObject(OBJTYPE_FXOPER_DV, UniID( FD.deal, OBJTYPE_FXOPER_DV), 101);
              if (( str != null) and (str != 0))
                    return 0;
              end;
        end;
       /*PNV i-support 506163*/
        if (FD.Биржевая() and (not FD.IsClient() ) and (DL_ЕдиныйПулОбеспеченияСобств == 1) )
           if( ПИ_УстановитьСтатусПлатежа(Payment, PM_CLOSED_W_M_MOVEMENT) )
              MsgBox("Ошибка при установке платежу статуса \"Закрыт без движения\"");
              return 1;
           end;
        else
           if( not ПИ_ПроводкаПоПлатежу(FD, Payment, null, ДатаИсполненияШага) )
              return 1;
           end;
        end;

        /*PNV*/
        if ( (FD.ВидАктиваТребования() == FIKIND_METAL) and (not FD.netting()) and (not FD.Биржевая()) and (FD.Issale()) and (not FD.IsDealMet()))
           if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаТребования(), ДатаИсполненияШага, FD.ВалютаТребования(), NATCUR, false) )
              return 1;
           end;
           Сумма  = SumeqPayer; 
    
           /*PNV закрываем остаток со счета 61213* */
           Acc = ПолучитьКоррсчетИзКоррсхемы(FD.ВалютаТребования(), IIF(Payment.inCorschem > 0, Payment.inCorschem, ПолучитьКорсхемуПоУмолчанию(Payment.payerbankid, Payment.basefiid))); 
           if( DV_GetAccount( 1, FD.ВалютаТребования(), Acc, AccBuff, true ) == true ) 
              if( not ПроводкаПоКатегориямУчета( FD,
                                                 "Выбытие ДМ", AccBuff, 
                                                 ДатаИсполненияШага, 1,
                                                 NATCUR, Сумма,
                                                 doc,
                                                 INPCARRY,"", "",
                                                 "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],
                                                 NULL, FIROLE_FIREQ, FIROLE_FIREQ,
                                                 NATCUR, FD.ВалютаТребования(),
                                                 FD.ВалютаТребования(), FD.СуммаТребования(),
                                                 NULL, NULL, NULL, NULL,
                                                 NULL, NULL, NULL, NULL, NULL
                                               )
                )
                 return 1;
              end;
           end; 
        end;  
        /*PNV*/

        if( ПИ_ИсполнитьПлатеж(Payment) )
           return 1;
        end;

        if( FD.IsClient() AND IsDVFXDEAL(FD.Group) AND ((FD.ВидБазовогоАктива() == FIKIND_METAL) OR (FD.ВидКонтрАктива() == FIKIND_METAL)))
           if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
              if( FI.rec.FI_Kind == FIKIND_CURRENCY)
                 ВидРО = 99;
              elif(FI.rec.FI_Kind == FIKIND_METAL)
                 ВидРО = 100;
              end;
           end;
        else
           ВидРО = 34;
        end;

        if( not ПИ_ПроводкаВУПоПлатежуДС(ВидРО, FD, ДатаИсполненияШага, doc, Payment, false) )
           return 1;
        end;

        if(FD.IsDealMet() AND FD.IsBuy())
            if( not ПроводкаПоКатегориямУчета( FD,
                                                "+НДС",                    
                                                "+Форвард, расчетыДМ"/*ПИ_КатегорияПлФорвардРПИ()*/,/*PNV*/                  
                                                ДатаИсполненияШага,            
                                                1,                        
                                                NATCUR,        
                                                null,          
                                                Doc,                      
                                                INPCARRY,                 
                                                "",                       
                                                "",                       
                                                "Учет НДС " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],/*KEA*/          
                                                null, null, FIROLE_FIREQ, NATCUR, FD.ВалютаКонтрАктива(), FD.ВалютаКонтрАктива(), FD.nFi.rec.VATSum
                                             )
               )
               return 1;
            end;
        end;
     end;
  end;

  return 0;
END;

MACRO ПИКО_ИсполнитьОбязательствоЧастиСделки( FD, ДатаИсполненияШага, doc ):integer
  var ErrMsg = "";
  var SumeqPayer = 0, Сумма = 0, Acc = ""; /*PNV*/
  file AccBuff( "account.dbt" );
  var ВидРО = 0;
  var FI = TRecHandler("fininstr.dbt");

  if( FD.IsDealMet() )
      if( (( FD.nFI.rec.CalcCond == FI_CALC_COND_PREPAY ) AND FD.IsSale() ) OR (( FD.nFI.rec.CalcCond == FI_CALC_COND_PREDELIV ) AND FD.IsBuy() ) )
     if( (FD.ПлатежТреб.rec.PaymStatus == PM_PREPARING)or
         (FD.ПлатежТреб.rec.PaymStatus == PM_READIED)
       )
        MsgBox("Сначала должны быть исполнены требования");
        return 1;
     end;
  end;
  end;

  var Payment = RsbPayment(FD.ПлатежОб.rec.PaymentID);

  if( Payment.PaymStatus != PM_CLOSED_W_M_MOVEMENT )
     if( FD.СобствБиржеваяСделка() and ПИ_ПлатежВВалюте(Payment) )
        if( ПИ_УстановитьСтатусПлатежа(Payment, PM_CLOSED_W_M_MOVEMENT) )
           MsgBox( "Ошибка при установке платежу статуса \"Закрыт без движения средств\"" );
           return 1;
        end;
        if( not ПИ_ПроводкаВУПоПлатежуДС(34, FD, ДатаИсполненияШага, doc, Payment, true) )
           return 1;
        end;
     else
        if( FD.nFI.rec.DVP == SET_CHAR )
         if( (FD.ПлатежТреб.rec.PaymStatus == PM_PREPARING)or
            (FD.ПлатежТреб.rec.PaymStatus == PM_READIED)
         )
            MsgBox("Сначала должны быть исполнены требования");
            return 1;
         end;
      end;

     if( ПИ_ИнтегрРежимРаботы() and FD.IsBNote() and (DV_IsCashAccount(Payment.ReceiverAccount)) and (not FD.IsDealMet()))
        if( DVFX_CreateCashOrder(Payment, FD.Deal, false, @ErrMsg) )
           if( ПИ_УстановитьСтатусПлатежа(Payment, PM_READY_TO_SEND) )
              MsgBox("Ошибка при установке платежу статуса \"Готов к отправке\"");
              return 1;
           end;
        else
           MsgBox("Кассовый ордер не сформирован. "+@ErrMsg);
           return 1;
        end;
     else
        if( (FD.IsDealMet()) AND FD.IsSale() and ((FD.СрокСделки() == 0)    OR (FD.ДатаСделки() == FD.ДатаИсполнения()) ) ) /*PNV 517605*/ //HF63_2_1
            if( УчетКурсовойРазницыИлиФинРез(FD, doc, ДатаИсполненияШага, "Выбытие ДМ", 2) != 0)
               return 1;
            end;
        end;
        /*по собственным сделкам актуализируем на шаге постановки на баланс, а по клиентским здесь, т.к. для них шага постановки на баланс нет*/
           /*+ для случая когда обязательство исполняется раньше постановки на баланс (ранние расчёты)*/
           if( (FD.IsClient() OR FD.IsDealMet() OR (GetOprStatus(DV_FX_OPERSTATUS_KIND_BALANCE) != DV_FX_OPERSTATUS_DL_COMPLETE))
              and (ПИКО_АктуализироватьПлатежОбяз( FD ) != 0) )
           return 1;
        end;

        if (FD.Биржевая() and (not FD.IsClient() ) and (DL_ЕдиныйПулОбеспеченияСобств == 1))
            if( ПИ_УстановитьСтатусПлатежа(Payment, PM_CLOSED_W_M_MOVEMENT) )
                MsgBox("Ошибка при установке платежу статуса \"Закрыт без движения\"");
                return 1;
            end;
        else
          if( not ПИ_ПроводкаПоПлатежу(FD, Payment, null, ДатаИсполненияШага) )
              return 1;
          end;
        end;
        /*PNV*/
        if ( (FD.ВидАктиваОбязательства() == FIKIND_METAL) and (not FD.netting()) and (not FD.Биржевая()) and (FD.Issale()) and (not FD.IsDealMet()) )
              /*PNV i-support 488546 - если заполнено примечание, значит сделка со слитками, проводку не формируем*/ 
              var str = readNoteForObject(OBJTYPE_FXOPER_DV, UniID( FD.deal, OBJTYPE_FXOPER_DV), 101);
              if (( str != null) and (str != 0))
                  return 0;
              end;
              /*PNV i-support 488546*/
 
              if( not DV_SmartConvertSum(SumeqPayer, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.ВалютаОбязательства(), NATCUR, false) )
                  return 1;
              end;
              Сумма  = SumeqPayer; 
    
              /*PNV закрываем остаток со счета 61213* */
              Acc = ПолучитьКоррсчетИзКоррсхемы(FD.ВалютаОбязательства(), IIf(Payment.outCorschem > 0, Payment.outCorschem, ПолучитьКорсхемуПоУмолчанию(Payment.receiverbankid, Payment.basefiid)) ); 
              if( DV_GetAccount( 1, FD.ВалютаОбязательства(), Acc, AccBuff, true ) == true ) 
                  if( not ПроводкаПоКатегориямУчета( FD,
                                            "Выбытие ДМ", AccBuff, 
                                            ДатаИсполненияШага, 1,
                                            NATCUR, Сумма,
                                            doc,
                                            INPCARRY,"", "",
                                            "Списание стоимости ДМ (" + FD.BaseFI().rec.name + ") с обезличенного металлического счета " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0],
                                            NULL, FIROLE_BA, FIROLE_FIREQ,
                                            NATCUR, FD.ВалютаОбязательства(),
                                            FD.ВалютаОбязательства(), FD.СуммаОбязательства(),
                                            NULL, NULL, NULL, NULL,
                                            NULL, NULL, NULL, NULL, NULL
                                          )
                              )
                              return 1;
                 end;
             end; 
         end;  
        /*PNV*/

        if( ПИ_ИсполнитьПлатеж(Payment) )
           return 1;
        end;
           if( FD.IsClient() AND IsDVFXDEAL(FD.Group) AND ((FD.ВидБазовогоАктива() == FIKIND_METAL) OR (FD.ВидКонтрАктива() == FIKIND_METAL)))
              if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
                 if( FI.rec.FI_Kind == FIKIND_CURRENCY)
                    ВидРО = 99;
                 elif(FI.rec.FI_Kind == FIKIND_METAL)
                    ВидРО = 101;
                 end;
              end;
           else
              ВидРО = 34;
           end;

        if( not ПИ_ПроводкаВУПоПлатежуДС(ВидРО, FD, ДатаИсполненияШага, doc, Payment, true) )
           return 1;
        end;

           if( (not FD.IsClient()) and (FD.ВидАктиваОбязательства() == FIKIND_METAL) and (not FD.IsDealMet()) )
              var CtAcc = TRecHandler("account");
              /*if( DL_ЕдиныйПулОбеспеченияСобств == 1 )
                 if( not FD.IsExistAccount("Торговый счет", null, null, FIROLE_FICOM, CtAcc, null, ДатаИсполненияШага, FD.ВалютаОбязательства()) )
                    return 1;
                 end;
              else*/
                 if( not ПИ_ПолучитьКорСчет({ourbank},FD.ВалютаОбязательства(),CtAcc) )
                    return 1;
                 end;
              //end;
              /*CHVA закомментил проводку так как эта дублируется выше 512276 надо подтверждение от Наташи*/
           /*   if( not ПроводкаПоКатегориямУчета( FD, 
                                                 "Выбытие ДМ",                                   /* Кредит */
                                                 CtAcc,                                          /* Деб */
                                                 ДатаИсполненияШага,                             /* Дата */
                                                 1,                                              /* Глава */
                                                 FD.ВалютаОбязательства(),                       /* Валюта */
                                                 FD.СуммаОбязательства(),                        /* Сумма */
                                                 Doc,                                            /* Документ */
                                                 INPCARRY,                                       /* Result_Carry */
                                                 "",                                             /* Kind_Oper */
                                                 "",                                             /* Numb_Document */
                                                 "Исполнение обязательств по поставке драг. металла" /* Ground */
                                                 )
                        )
                  return 1;
              end;*/
           end;

        if(FD.IsDealMet() AND FD.IsSale())
            if( not ПроводкаПоКатегориямУчета( FD,
                                                "Выбытие ДМ",                    
                                                "МХДМ",                  
                                                ДатаИсполненияШага,            
                                                1,                        
                                                NATCUR,        
                                                null,          
                                                Doc,                      
                                                INPCARRY,                 
                                                "",                       
                                                "",                       
                                                "Выдача драгметалла из хранилища",           
                                                null, null, null, NATCUR, FD.ВалютаБазовогоАктива(), FD.ВалютаБазовогоАктива(), FD.nFi.rec.Amount)
               )
               return 1;
            end;
            if( not ПроводкаПоКатегориямУчета( FD,
                                                "Выбытие ДМ",                    
                                                "-НДС",                  
                                                ДатаИсполненияШага,            
                                                1,                        
                                                FD.ВалютаКонтрАктива(),        
                                                FD.nFi.rec.VATSum,          
                                                Doc,                      
                                                INPCARRY,                 
                                                "",                       
                                                "",                       
                                                "Учет НДС " + "по сделке №"+ FD.DealCode() + " от " + FD.ДатаСделки() + ". К/агент:" + GetPartyNames(FD.GetContractorID(),2)[0], /*KEA*/          
                                                   null, null, null, NATCUR, NATCUR)
               )
               return 1;
            end;
        end;
     end;
  end;
  end;

  return 0;
END;

MACRO DV_GetPlanInAcc(DocKInd:integer, DocID:integer, PaymentID:integer, DlComID:integer, Дата:date, _CheckCatArr:TArray, inaccArr:@TArray)
  var err = 0;
  var Payment;
  var DealPart;
  var FD;
  var ВидРО;
  var FI = TRecHandler("fininstr.dbt");
  SetPlanMode(true, _CheckCatArr);

  if(PaymentID > 0)
    Payment = RsbPayment(PaymentID);
    DealPart = IIF(((Payment.Purpose == BRi) OR ((Payment.Purpose == CRi))), 2, 1);

    if(DocKind == DL_DVDEALT3)
      FD = DVFirstDocNDeal(DocKind, DocID, DealPart);
      ВидРО = 34;
    elif(DocKind == DL_DVNDEAL)
      FD = DVFirstDocNDeal(DocKind, DocID, DealPart);
      if( FD.IsClient() AND FD.IsSWAP() AND ((FD.ВидБазовогоАктива() == FIKIND_METAL) OR (FD.ВидБазовогоАктива(true) == FIKIND_METAL)))
           if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
              if( FI.rec.FI_Kind == FIKIND_CURRENCY)
                 ВидРО = 99;
              elif(FI.rec.FI_Kind == FIKIND_METAL)
                 if(FD.IsBuy())
                    ВидРО = 100;
                 else
                    ВидРО = 101;
                 end;
              end;
           end;
        else
           ВидРО = 34;
        end;
    elif(DocKind == DL_DVFXDEAL)
      FD = DVFirstDocFXDeal(DocKind, DocID);
      if( FD.IsClient() AND IsDVFXDEAL(FD.Group) AND ((FD.ВидБазовогоАктива() == FIKIND_METAL) OR (FD.ВидКонтрАктива() == FIKIND_METAL)))
           if( ПолучитьФинИн(Payment.BaseFIID, FI) == 0 )
              if( FI.rec.FI_Kind == FIKIND_CURRENCY)
                 ВидРО = 99;
              elif(FI.rec.FI_Kind == FIKIND_METAL)
                 if(FD.IsBuy())
                    ВидРО = 100;
                 else
                    ВидРО = 101;
                 end;
              end;
           end;
      else
         ВидРО = 34;
      end;
    end;

    if(FD.ПлатежТреб.rec.PaymentID == PaymentID)
      if( not ПИ_ПроводкаВУПоПлатежуДС(ВидРО, FD, Дата, NULL, Payment, false) )
         err = 1;
      end;
    elif(FD.ПлатежОб.rec.PaymentID == PaymentID)
      if( not ПИ_ПроводкаВУПоПлатежуДС(ВидРО, FD, Дата, NULL, Payment, true) )
         err = 1;
      end;
    end;
  elif(DlComID > 0)
    var Sql = " SELECT dlcomis.t_ID, dlcomis.t_DocKind, dlcomis.t_DocID, dlcomis.t_PlanPayDate, dlcomis.t_Sum, " +
              "        comis.t_ReceiverID, comis.t_FIID_Comm " +
              "   FROM ddlcomis_dbt dlcomis, dsfcomiss_dbt comis  " +
              "  WHERE dlcomis.t_ID          = ? " +
              "    AND dlcomis.t_FeeType     = comis.t_FeeType " +
              "    AND dlcomis.t_ComNumber   = comis.t_Number ";

    var Query = DL_RSDCommand(Sql);
    Query.addParam(DlComID);

    var Data = Query.execute();
    if( Data.MoveNext() )
       if(DocKind == DL_DVDEALT3)
         FD = DVFirstDocNDeal(Data.DocKind, Data.DocID);
       elif(DocKind == DL_DVNDEAL)
         FD = DVFirstDocNDeal(Data.DocKind, Data.DocID);
       elif(DocKind == DL_DVFXDEAL)
         FD = DVFirstDocFXDeal(Data.DocKind, Data.DocID);
       end;

       if( Data.rec.ReceiverID == {OurBank} )
         if( not ПроводкаВнебиржВУ(8, FD, NULL, date(Data.rec.PlanPayDate), Data.rec.FIID_Comm, Data.rec.Sum, false) )
           err = 1;
         end;
       else
         ВидРО = 0;
         if( (DocKind == DL_DVDEALT3) or (DocKind == DL_DVNDEAL) )
           if( FD.КонтрагентБиржа() )
              ВидРО = 9;
           else
              ВидРО = 12;
           end;
         elif(DocKind == DL_DVFXDEAL)
           if( FD.КонтрагентБиржа() )
              ВидРО = 9;
           else
              ВидРО = 12;
           end;
         end;

         if( not ПроводкаВнебиржВУ(ВидРО, FD, NULL, date(Data.rec.PlanPayDate), Data.rec.FIID_Comm, Data.rec.Sum, true) )
           err = 1;
         end;
       end;
    end;
  end;

  inaccArr = TArray(PlanInAccData);

  SetPlanMode(false);

  return (err == 0);
END;

private macro ПИКО_ПолучитьSперНач( FD, ДатаИсполненияШага, Sвал:money, Sпер:@money, БАЭкв:@money, КАЭкв:@money, БАЭкв_рег:@money, КАЭкв_рег:@money, OffRateBa:@money )
   OffRateBa = 0.0;
   var OffRateСa = 1.0; //Если КА нац валюта, то курс = 1
   var БАЭкв_рег_пред = 0.0; /*PNV 513168*/
   var КАЭкв_рег_пред = 0.0;/*PNV 513168*/

   /*покупка/продажа валюты\драг.металла за нац валюту*/
   /*покупка/продажа валюты за валюту, покупка/продажа драг.металла за валюту, покупка/продажа слитков*/
   if(ПИКО_ПереоценкаПроверкаВалюты(FD))
      if( not DV_SmartConvertSumDbl( OffRateBa, 1.0, ДатаИсполненияШага, FD.ВалютаБазовогоАктива(), NATCUR, true ) )
         return 1;
      end;
      //Ищем курс КА только если КА не нац валюта
      if (FD.ВалютаКонтрАктива() != NATCUR)
         if( not DV_SmartConvertSumDbl( OffRateСa, 1.0, ДатаИсполненияШага, FD.ВалютаКонтрАктива(), NATCUR, true ) )
         return 1;
      end;
      end;

      БАЭкв = round(Sвал * OffRateBa, 2);
      КАЭкв = round(FD.ПолучитьЦенуБезНДС() * OffRateСa, 2);
      Sпер = БАЭкв - КАЭкв;
     /*PNV 513168*/
      if (ПолучитьЗначенияРегистраНаДату(FD.Deal.rec.DocKind, FD.Deal.rec.Id, ДатаИсполненияШага, @БАЭкв_рег_пред, @КАЭкв_рег_пред))
         //return 1;
      end;
      if ((Round(БАЭкв_рег_пред, 5) == Round(БАЭкв, 5)) and (Round(КАЭкв_рег_пред, 5) == Round(КАЭкв, 5)))/*PNV 534705 в регистре хранятся значения с 5-ю знаками после запятой, значит и сравнивать будем до 5-го знака*/
         Sпер = 0;
         БАЭкв = 0;
         КАЭкв = 0;
      end;
     /*PNV 513168*/
   end;
   return 0;
end;

macro ПИКО_ПровестиПереоценкуЧастиСделки ( FD, doc, ДатаИсполненияШага, ФорвПолДопОст, ФорвОтрДопОст, ReportLineData):integer /*PNV 505030*/

  var СчетОбяз = TRecHandler("account");
  var СчетТреб = TRecHandler("account");
  var AccPlus  = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var FI = TRecHandler("fininstr");
  var Sвал = $0, СуммаПереоценки:money = 0, БАЭкв:money = 0, КАЭкв:money = 0;
  var Ground = "Отражение курсовой разницы";
  var датаОткрСчетов = DL_GetBankDateAfterWorkDayByCalendar(FD.ДатаСделки(),0,FD.ПолучитьКалендСвязанный());
  var OffRateBa:money = $0;
  var РублевыйКА = (FD.ВалютаКонтрАктива() == NATCUR);
  var датаОстатков = DL_GetBalanceDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0, FD.ПолучитьКалендСвязанный());

  var replaceGround=true;
  var IsReq = true, AccCode = ""; /*PNV 505030*/
  if ( ПИКО_ПереоценкаНеНужна(FD) )
     return 0;
  end;
 if ((FD.kind == 4813) or  (FD.kind == 4815))
    if ((FD.deal.rec.kind == 2740) or  (FD.deal.rec.kind == 12740) )
       if( (FD.ВалютаБазовогоАктива() == FD.ВалютаОбязательства()) and FD.IsExistAccount("-Форвард, дрейф внебирж0", null, true, FIROLE_FICOM, СчетОбяз, null, DL_GetBankDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0,10003), FD.ВалютаОбязательства()) )
          Sвал = ПИКО_GetAccRestSTRPRC( СчетОбяз.rec.Account, СчетОбяз.rec.Code_Currency, датаОстатков,  СчетОбяз.rec.Chapter );
          Ground = Ground+" обязательства";
                IsReq = false; /*PNV 505030*/
           Sвал = abs(Sвал); 
        elif( (FD.ВалютаБазовогоАктива() == FD.ВалютаТребования()) and FD.IsExistAccount("+Форвард, дрейф внебирж0", null, true, FIROLE_FIREQ, СчетТреб, null, DL_GetBankDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0,10003), FD.ВалютаТребования()) )
             Sвал = ПИКО_GetAccRestSTRPRC( СчетТреб.rec.Account, СчетТреб.rec.Code_Currency, датаОстатков,  СчетТреб.rec.Chapter );
             IsReq = true; /*PNV 505030*/
             Ground = Ground+" требования";
             Sвал = abs(Sвал); 
        end;
     else
        //teg 19.01.19  назанчения свел с шагом переоценки
        replaceGround=false;
        if( (FD.ВалютаБазовогоАктива() == FD.ВалютаОбязательства()) and FD.IsExistAccount("-Форвард, прочие0", null, true, FIROLE_FICOM, СчетОбяз, null, DL_GetBankDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0,10003), FD.ВалютаОбязательства()) )
            //Sвал = ПИКО_GetAccRestSTRPRC( СчетОбяз.rec.Account, СчетОбяз.rec.Code_Currency, датаОстатков, СчетОбяз.rec.Chapter );
			Sвал = FD.СуммаОбязательства();
            ПолучитьФинИн( FD.ВалютаОбязательства(), FI );
            ground = "Отражение переоценки требований и обязательств по поставке "+FI.rec.CCY+" по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor)/*CHVA*/;
            IsReq = false; /*PNV 505030*/
            Sвал = abs(Sвал); 
        elif( (FD.ВалютаБазовогоАктива() == FD.ВалютаТребования()) and FD.IsExistAccount("+Форвард, прочие0", null, true, FIROLE_FIREQ, СчетТреб, null, DL_GetBankDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0,10003), FD.ВалютаТребования()) )
             //Sвал = ПИКО_GetAccRestSTRPRC( СчетТреб.rec.Account, СчетТреб.rec.Code_Currency, датаОстатков,  СчетТреб.rec.Chapter );
             Sвал = FD.СуммаТребования(); 
			 ПолучитьФинИн(FD.ВалютаТребования(), FI );
             ground = "Отражение переоценки требований и обязательств по поставке "+FI.rec.CCY+" по сделке "+FD.DealCode()+" от "+StrSubSt(String(FD.deal.rec.date:f), ".", "/") + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) /*CHVA*/;
             IsReq = true; /*PNV 505030*/
             Sвал = abs(Sвал); 
         end;
    end;

 else
    if( FD.ВалютаБазовогоАктива() == FD.ВалютаОбязательства() )
      if(   (ValType(ФорвОтрДопОст) != V_UNDEF) and (ФорвОтрДопОст != $0)  and FD.IsExistAccount("-Форвард, прочие", null, true, FIROLE_FICOM, СчетОбяз, null, DL_GetBankDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0,10003), FD.ВалютаОбязательства()) )
       Sвал = abs(ПИКО_GetAccRestSTRPRC( СчетОбяз.rec.Account, СчетОбяз.rec.Code_Currency, датаОстатков, СчетОбяз.rec.Chapter )+ ФорвОтрДопОст);
     else
       Sвал = FD.nFI.rec.Amount;
       end;
       Ground = Ground+" обязательства";
       IsReq = false; /*PNV 505030*/
    elif( FD.ВалютаБазовогоАктива() == FD.ВалютаТребования() )
       if(  (ValType(ФорвПолДопОст) != V_UNDEF) and (ФорвПолДопОст != $0) and FD.IsExistAccount("+Форвард, прочие", null, true, FIROLE_FIREQ, СчетТреб, null, DL_GetBankDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0,10003), FD.ВалютаТребования()) )
          Sвал = abs(ПИКО_GetAccRestSTRPRC( СчетТреб.rec.Account, СчетТреб.rec.Code_Currency, датаОстатков, СчетТреб.rec.Chapter )+ ФорвОтрДопОст);
       else
          Sвал = FD.nFI.rec.Amount;
       end;
       Ground = Ground+" требования";
       IsReq = true; /*PNV 505030*/
  end;
 end;

  if( Sвал == $0 )
     return 0;
  end;

  if( ПИКО_ПолучитьSперНач(FD, ДатаИсполненияШага, Sвал, @СуммаПереоценки, @БАЭкв, @КАЭкв, null, null, @OffRateBa  ) != 0 )
     return 1;
  end;

  /*PNV 531719, 513168*/
  if ((БАЭкв == 0) and (КАЭкв == 0) and (СуммаПереоценки == 0))
      return 0;
  end;
  /*PNV 531719, 513168*/
  
  if (DV_InsertOverReg(FD.Deal.rec.DocKind, FD.Deal.rec.Id, ДатаИсполненияШага, БАЭкв, КАЭкв, СуммаПереоценки))
      return 1;
  end;

//teg 19.01.19
if (replaceGround)
    Ground = Ground + " по сделке "+ FD.DealCode();
end;

  if( ( FD.IsBuyPart() AND (СуммаПереоценки > 0) ) OR
      ( (not FD.IsBuyPart()) AND (СуммаПереоценки < 0) ) 
    )
     if( (not FD.IsExistAccount("+Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, MC_PAIRACCMODE_AUTO, FD.SetAccOpenDate(датаОткрСчетов), NATCUR)))/*PNV 532711*/
     if( not FD.OpenAccount("+Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, FD.SetAccOpenDate(датаОткрСчетов), NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
        return 1;
     end;
     end;/*PNV 532711*/
     if( not ПроводкаПоКатегориямУчета( FD,
                                        AccPlus, IIF(CheckDealAndDateFor793P(FD, ДатаИсполненияШага), "+Маржа, ДМ", "+Маржа, ИВ и ДМ"),
                                        ДатаИсполненияШага,
                                        1,
                                        NATCUR, abs(СуммаПереоценки),
                                        doc,
                                        INPCARRY, "", "",
                                        Ground,
                                        null,
                                        null, FIROLE_BA, /*PNV 505030*/
                                        null,null,null,null,null,null,null,null,null,null,MC_PAIRACCMODE_AUTO,null,null,null,null,null,null,null,
                                        null, @AccCode   /*PNV 505030*/
                                      )
       )
        return 1;
     end;
    /*PNV 505030*/
     if( ReportLineData != NULL )
         ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                    IIF(IsReq, "Т", "О"),
                                                                    Sвал,
                                                                    IIF(IsReq, СчетТреб.rec.Code_Currency, СчетОбяз.rec.Code_Currency),
                                                                    AccPlus.rec.account,
                                                                    AccCode,
                                                                    abs(СуммаПереоценки),
                                                                    string(OffRateBa:0:4),
                                                                    СуммаПереоценки,
                                                                    0,
                                                                    БАЭкв,
                                                                    0,
                                                                    IIF(РублевыйКА, 0.0, КАЭкв) 
                                                                    );
    end;
    /*PNV 505030*/
  else
     if( (not FD.IsExistAccount("-Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, MC_PAIRACCMODE_AUTO, FD.SetAccOpenDate(датаОткрСчетов), NATCUR)))/*PNV 532711*/
     if( not FD.OpenAccount("-Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, FD.SetAccOpenDate(датаОткрСчетов), NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
        return 1;
     end;
     end;/*PNV 532711*/
     if( not ПроводкаПоКатегориямУчета( FD,
                                        IIF(CheckDealAndDateFor793P(FD, ДатаИсполненияШага), "-Маржа, ДМ", "-Маржа, ИВ и ДМ"), AccMinus,
                                        ДатаИсполненияШага,
                                        1,
                                        NATCUR, abs(СуммаПереоценки),
                                        doc,
                                        INPCARRY, "", "",
                                        Ground,
                                        null,
                                        FIROLE_BA, null,/*PNV 505030*/
                                        null,null,null,null,null,null,null,null,null,null,MC_PAIRACCMODE_AUTO,null,null,null,null,null,null,null,
                                        @AccCode /*PNV 505030*/
                                      )
       )
        return 1;
     end;
     /*PNV 505030*/
     if( ReportLineData != NULL )
         ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                    IIF(IsReq, "Т", "О"),
                                                                    Sвал,
                                                                    IIF(IsReq, СчетТреб.rec.Code_Currency, СчетОбяз.rec.Code_Currency),
                                                                    AccCode,
                                                                    AccMinus.rec.account,
                                                                    abs(СуммаПереоценки),
                                                                    string(OffRateBa:0:4),
                                                                    СуммаПереоценки,
                                                                    0,
                                                                    БАЭкв,
                                                                    0,
                                                                    IIF(РублевыйКА, 0.0, КАЭкв)
                                                                    );
    end;
    /*PNV 505030*/
  end;

  return 0;

END;

private macro ПИКО_ПолучитьSперКорректир( FD, ДатаИсполненияШага, ПредЗначРавны:@bool, Sпер:@money, БАЭкв:@money, КАЭкв:@money, БАЭкв_рег:@money, КАЭкв_рег:@money, Р_рег:@money, OffRateBa:@money )
   OffRateBa = 0.0;
   var OffRateСa = 1.0;  //Если нац валюта, то курс = 1
   БАЭкв_рег = 0.0; КАЭкв_рег = 0.0; Р_рег = 0.0; //Значения регистра начиная от предыдущего дня - для расчётов
   var БАЭкв_рег_пред = 0.0, КАЭкв_рег_пред = 0.0, Р_рег_пред = 0.0; //Просто предыдущие значения регистра - для проверки что есть отличия (для перестройки переоценки в рамках дня #284812)
   /*покупка/продажа валюты\драг.металла за рубли*/
   /*покупка/продажа валюты за валюту, покупка/продажа драг.металла за валюту*/
   if(ПИКО_ПереоценкаПроверкаВалюты(FD))
      if( not DV_SmartConvertSumDbl( OffRateBa, 1.0, ДатаИсполненияШага, FD.ВалютаБазовогоАктива(), NATCUR, true ) )
         return 1;
      end;
      if (FD.ВалютаКонтрАктива() != NATCUR)
      if( not DV_SmartConvertSumDbl( OffRateСa, 1.0, ДатаИсполненияШага, FD.ВалютаКонтрАктива(), NATCUR, true ) )
         return 1;
      end;
      end;
      if (ПолучитьЗначенияРегистраНаДату(FD.Deal.rec.DocKind, FD.Deal.rec.Id, ДатаИсполненияШага-1, @БАЭкв_рег, @КАЭкв_рег, @Р_рег))
        //Значений за предыдущий день - нету
        //Значит мы пытаемся перезатереть первую переоценку, а значит оставляем значения нулевыми, чтобы она полностью пересчиталась
      end;
      if (ПолучитьЗначенияРегистраНаДату(FD.Deal.rec.DocKind, FD.Deal.rec.Id, ДатаИсполненияШага, @БАЭкв_рег_пред, @КАЭкв_рег_пред, @Р_рег_пред))
         //return 1;/*PNV 513248*/
      end;
      БАЭкв = round(FD.nFI.rec.Amount * OffRateBa, 2);
      КАЭкв = round(FD.ПолучитьЦенуБезНДС() * OffRateСa, 2); // Для случаев, когда валюта КА - рубли, рассчитываем КАЭкв как обычно, чтобы оставить это значение в регистре, а зануляем уже при передаче значения в протокол
      if (FD.ВалютаКонтрАктива() == NATCUR)
         Sпер = БАЭкв - БАЭкв_рег;
      else 
      Sпер = (БАЭкв - БАЭкв_рег) - (КАЭкв - КАЭкв_рег);
      end;
      ПредЗначРавны = (БАЭкв_рег_пред == БАЭкв) and (КАЭкв_рег_пред == КАЭкв);
   end;
   return 0;
end;

MACRO DV_NeedCorrectOverByAcc(FD, doc, ДатаИсполненияШага:date, СчетТО:TRecHandler,IsReq:bool,IsExecCarry:bool,ReportLineData,IsNeedCorrect:@bool):bool
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var Sпер = $0, Sп = $0, deltaS = $0, AccCode = "", AccCode_1 = "",  БАЭкв:money = $0, КАЭкв:money = $0, БАрп:money = $0, КАрп:money = $0, Ррп:money = $0, OffRateBa:money = $0;
  var AccMinusRest = $0, AccPlusRest = $0;
  var РублевыйКА = (FD.ВалютаКонтрАктива() == NATCUR);
  var Fi = TRecHandler("fininstr");

  var датаОстатка = DL_GetBalanceDateAfterWorkDayByCalendar(ДатаИсполненияШага, 0, FD.ПолучитьКалендСвязанный());

  IsNeedCorrect = false;

  var ПредЗначРавны = false;

  if( ПИКО_GetAccRestSTRPRC(СчетТО.rec.Account, СчетТО.rec.Code_Currency, датаОстатка, СчетТО.rec.Chapter) == $0 )
     return 0;
  end;

  if( ПИКО_ПолучитьSперКорректир(FD, ДатаИсполненияШага, @ПредЗначРавны, @Sпер, @БАЭкв, @КАЭкв, @БАрп, @КАрп, @Ррп, @OffRateBa ) != 0 )
     return 1;
  end;

  if( (not ПредЗначРавны) and Sпер != $0 )
     IsNeedCorrect = true;
  end;

  if( IsExecCarry )
     if (УдалитьПроводкиИзПрошлойПереоценкиТекущегоДня(FD, ДатаИсполненияШага))
       return 1;
     end;

     if (DV_InsertOverReg(FD.Deal.rec.DocKind, FD.Deal.rec.Id, ДатаИсполненияШага, БАЭкв, КАЭкв, Ррп+Sпер)) // В сделках, где валюта КА - рубли, в качестве КАЭкв всегда хранится величина КА из формы сделки
        return 1;
     end;
    //TEG
     if (FD.IsBuyPart())
       ПолучитьФинИн( FD.ВалютаТребования(), FI );
     else
       ПолучитьФинИн( FD.ВалютаОбязательства(), FI ); 
     end;
     if( ( (FD.IsBuyPart() and ((FD.ВалютаКонтрАктива()==NATCUR) OR (FD.ВалютаКонтрАктива()!=NATCUR))) AND (Sпер > 0) ) OR
         ( (not FD.IsBuyPart()) and ((FD.ВалютаКонтрАктива()==NATCUR) OR (FD.ВалютаКонтрАктива()!=NATCUR)) AND (Sпер < 0) )
       )
         if( not ПроводкаПоКатегориямУчета( FD,
                                               "+Переоц.,поставка ИВ и ДМ", IIF(CheckDealAndDateFor793P(FD, ДатаИсполненияШага), "+Маржа, ДМ", "+Маржа, ИВ и ДМ"),
                                              ДатаИсполненияШага,
                                              1,
                                              NATCUR, abs(Sпер),
                                              doc,
                                              INPCARRY, "", "",
                                              "Отражение переоценки требований и обязательств по поставке по сделке "+FD.DealCode()+" от "+string(FD.deal.rec.date) + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                              null,
                                              null, FIROLE_BA,
                                              null,null,null,null,null,null,null,null,null,null,MC_PAIRACCMODE_AUTO,null,null,null,null,null,null,null,
                                              @AccCode_1, @AccCode  
                                         )
          )
           return 1;
        end;
        if( ReportLineData != NULL )
           ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                      IIF(IsReq, "Т", "О"),
                                                                      FD.nFI.rec.Amount,
                                                                      GetFICode(СчетТО.rec.Code_Currency, null, FICK_ISOSTRING),
                                                                      AccCode_1,/*PNV 463503*/
                                                                      AccCode,
                                                                      abs(Sпер),
                                                                       string(OffRateBa:0:4),
                                                                      Sпер,
                                                                      БАрп,
                                                                      БАЭкв,
                                                                      IIF(РублевыйКА, 0.0, КАрп),
                                                                      IIF(РублевыйКА, 0.0, КАЭкв)
                                                                    );
        end;
     else
        if( not ПроводкаПоКатегориямУчета( FD,
                                                 IIF(CheckDealAndDateFor793P(FD, ДатаИсполненияШага), "-Маржа, ДМ", "-Маржа, ИВ и ДМ"), "-Переоц.,поставка ИВ и ДМ",
                                                 ДатаИсполненияШага,
                                                 1,
                                                 NATCUR, abs(Sпер), 
                                                 doc,
                                                 INPCARRY, "", "",
                                                 "Отражение переоценки требований и обязательств по поставке по сделке "+FD.DealCode()+" от "+string(FD.deal.rec.date) + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor), /*CHVA*/
                                                 null,
                                                 FIROLE_BA, null,
                                                 null,null,null,null,null,null,null,null,null,null,null,MC_PAIRACCMODE_AUTO,null,null,null,null,null,null,
                                                 @AccCode, @AccCode_1
                                         )
          )
           return 1;
        end;
        if( ReportLineData != NULL )
           ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                      IIF(IsReq, "Т", "О"),
                                                                      FD.nFI.rec.Amount,
                                                                      GetFICode(СчетТО.rec.Code_Currency, null, FICK_ISOSTRING),
                                                                      AccCode,
                                                                      AccCode_1,/*PNV 463503*/
                                                                      abs(Sпер),
                                                                       string(OffRateBa:0:4),
                                                                       Sпер,
                                                                       БАрп,
                                                                       БАЭкв,
                                                                       IIF(РублевыйКА, 0.0, КАрп),
                                                                       IIF(РублевыйКА, 0.0, КАЭкв) 
                                                                    );
        end;
     end;
  end;
  return 0;
END;

/*!!НЕ УДАЛЯТЬ!!(может понадобиться) 
//Второй вариант отражения переоценки в бух учете (Переоценка с учетом типа счетов)
MACRO DV_NeedCorrectOverByAcc(FD, doc, ДатаИсполненияШага:date, СчетТО:TRecHandler,IsReq:bool,IsExecCarry:bool,ReportLineData,IsNeedCorrect:@bool):bool
  var AccPlus = TRecHandler("account");
  var AccMinus = TRecHandler("account");
  var Sпер = $0, Sвал = $0, Sп = $0, deltaS = $0, AccCode = "";

  IsNeedCorrect = false;

  if( ПИКО_ЕстьШагПереоцЗаДатуСделки( FD, ДатаИсполненияШага ) )
     return 0;
  end;

  Sвал = abs(RestAC( СчетТО.rec.Account, СчетТО.rec.Code_Currency, ДатаИсполненияШага, NULL, СчетТО.rec.Chapter ));

  if( Sвал == $0 )
     return 0;
  end;

  if( ПИКО_ПолучитьSперКорректир(FD, ДатаИсполненияШага, Sвал, @Sпер ) != 0 )
     return 1;
  end;

  if( Sпер != $0 )
     IsNeedCorrect = true;
  end;

  if( IsExecCarry )

     if( ( (FD.IsBuyPart() and ((FD.ВалютаКонтрАктива()==NATCUR) OR (FD.ВалютаКонтрАктива()!=NATCUR))) AND (Sпер > 0) ) OR
         ( (not FD.IsBuyPart()) and ((FD.ВалютаКонтрАктива()==NATCUR) OR (FD.ВалютаКонтрАктива()!=NATCUR)) AND (Sпер < 0) )
       )
        if( (not FD.IsExistAccount("+Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR)) /*PNV 532711*/
        if( not FD.OpenAccount("+Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccPlus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
           return 1;
        end;
        end;/*PNV 532711*/
        if( not ПроводкаПоКатегориямУчета( FD,
                                           AccPlus, "+Маржа, ИВ и ДМ",
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Sпер),
                                           doc,
                                           INPCARRY, "", "",
                                           "Курсовая разница от переоценки "+iif(IsReq,"требования","обязательства")+" сделки "+FD.DealCode(),
                                           null,
                                           null, FIROLE_BA,
                                           null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,
                                           null, @AccCode
                                         )
          )
           return 1;
        end;
        if( ReportLineData != NULL )
           ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                      IIF(IsReq, "Т", "О"),
                                                                      Sвал,
                                                                      GetFICode(СчетТО.rec.Code_Currency, null, FICK_ISOSTRING),
                                                                      AccPlus.rec.Account,
                                                                      AccCode,
                                                                      abs(Sпер)
                                                                    );
        end;
     else
        if( (not FD.IsExistAccount("-Переоц.,поставка ИВ и ДМ",  null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, MC_PAIRACCMODE_AUTO, ДатаИсполненияШага, NATCUR)) /*PNV 532711*/
        if( not FD.OpenAccount("-Переоц.,поставка ИВ и ДМ", null, false, IIF(FD.DealPart == 1, FIROLE_FIRST_OVERVAL, FIROLE_SECOND_OVERVAL), AccMinus, ДатаИсполненияШага, NATCUR, null, null, MC_PAIRACCMODE_AUTO) )
           return 1;
        end;
        end; /*PNV 532711*/
        if( not ПроводкаПоКатегориямУчета( FD,
                                           "-Маржа, ИВ и ДМ", AccMinus,
                                           ДатаИсполненияШага,
                                           1,
                                           NATCUR, abs(Sпер),
                                           doc,
                                           INPCARRY, "", "",
                                           "Курсовая разница от переоценки "+iif(IsReq,"требования","обязательства")+" сделки "+FD.DealCode(),
                                           null,
                                           FIROLE_BA, null,
                                           null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,
                                           @AccCode
                                         )
          )
           return 1;
        end;
        if( ReportLineData != NULL )
           ReportLineData[ReportLineData.size] = SvOpOvervalueChange( FD.DealCode(),
                                                                      IIF(IsReq, "Т", "О"),
                                                                      Sвал,
                                                                      GetFICode(СчетТО.rec.Code_Currency, null, FICK_ISOSTRING),
                                                                      AccCode,
                                                                      AccMinus.rec.Account,
                                                                      abs(Sпер)
                                                                    );
        end;
     end;

  end;

  return 0;
END;
*/

/*проверка необходимости вставки шага "Переоценка т/о по поставке" в конверсионную операцию покупки\продажи или свопа*/
MACRO DVFX_NeedOverValue(DealID:integer, FI_KIND:integer, FIID:integer, OnDate:DATE):bool
  var СчетОбяз = TRecHandler("account");
  var СчетТреб = TRecHandler("account");
  var FD = DVFirstDocFXDeal(DL_DVFXDEAL,DealID);
  var По1ч = ((OnDate>=FD.ДатаСделки())and(OnDate<=FD.ДатаИсполнения(true)));
  var FD2 = null;
  var По2ч = false;
  var IsNeedCorrect = false;

  if( FD.IsSwap() )
     FD2 = DVFirstDocFXDeal(DL_DVFXDEAL,DealID,2);
     По2ч = ((OnDate>=FD.ДатаСделки())and(OnDate<=FD2.ДатаИсполнения(true)));
  end;

  if( (ПИКО_ПереоценкаНеНужна(FD) == false) and По1ч )
     if((FI_KIND==FIKIND_ALLFI) or (FD.ВидБазовогоАктива()==FI_KIND))
        if( (FD.ВалютаБазовогоАктива() != NATCUR) and ((FIID==ALLFININSTR) or (FD.ВалютаБазовогоАктива() == FIID)) )
           if( (FD.ВалютаБазовогоАктива() == FD.ВалютаОбязательства()) and FD.IsExistAccount("-Форвард, прочие", null, true, FIROLE_FICOM, СчетОбяз, null, OnDate, FD.ВалютаОбязательства()) )
              DV_NeedCorrectOverByAcc( FD, null, OnDate, СчетОбяз, false, false, null, @IsNeedCorrect );
           elif( (FD.ВалютаБазовогоАктива() == FD.ВалютаТребования()) and FD.IsExistAccount("+Форвард, прочие", null, true, FIROLE_FIREQ, СчетТреб, null, OnDate, FD.ВалютаТребования()) )
              DV_NeedCorrectOverByAcc( FD, null, OnDate, СчетТреб, true, false, null, @IsNeedCorrect );
           end;
        end;
     end;
  end;

  if( (ПИКО_ПереоценкаНеНужна(FD) == false) and По2ч and (not IsNeedCorrect) )
     if((FI_KIND==FIKIND_ALLFI) or (FD2.ВидБазовогоАктива()==FI_KIND))
        if( (FD2.ВалютаБазовогоАктива() != NATCUR) and ((FIID==ALLFININSTR) or (FD2.ВалютаБазовогоАктива() == FIID)) )
           if( (FD2.ВалютаБазовогоАктива() == FD2.ВалютаОбязательства()) and FD2.IsExistAccount("-Форвард, прочие", null, true, FIROLE_FICOM, СчетОбяз, null, OnDate, FD2.ВалютаОбязательства()) )
              DV_NeedCorrectOverByAcc( FD2, null, OnDate, СчетОбяз, false, false, null, @IsNeedCorrect );
           elif( (FD2.ВалютаБазовогоАктива() == FD2.ВалютаТребования()) and FD2.IsExistAccount("+Форвард, прочие", null, true, FIROLE_FIREQ, СчетТреб, null, OnDate, FD2.ВалютаТребования()) )
              DV_NeedCorrectOverByAcc( FD2, null, OnDate, СчетТреб, true, false, null, @IsNeedCorrect );
           end;
        end;
     end;
  end;

  return IsNeedCorrect;
END;

macro ПИКО_ПровестиКорректировкуПереоценкиЧастиСделки ( FD, doc, SvOpDvOper, ReportLineData ):integer

  var СчетОбяз = TRecHandler("account");
  var СчетТреб = TRecHandler("account");

  if( (SvOpDvOper.rec.Date>=FD.ДатаСделки()) and (SvOpDvOper.rec.Date<=FD.ДатаИсполнения(true)) )
     if((SvOpDvOper.rec.FI_KIND==FIKIND_ALLFI) or (FD.ВидБазовогоАктива()==SvOpDvOper.rec.FI_KIND))
        if( (FD.ВалютаБазовогоАктива() != NATCUR) and ((SvOpDvOper.rec.FIID==ALLFININSTR) or (FD.ВалютаБазовогоАктива() == SvOpDvOper.rec.FIID)) )
           if( (FD.ВалютаБазовогоАктива() == FD.ВалютаОбязательства()) and FD.IsExistAccount("-Форвард, прочие", null, true, FIROLE_FICOM, СчетОбяз, null, SvOpDvOper.rec.Date, FD.ВалютаОбязательства()) )
              if( DV_NeedCorrectOverByAcc( FD, doc, SvOpDvOper.rec.Date, СчетОбяз, false, true, ReportLineData ) != 0)
                 return 1;
              end;
           elif( (FD.ВалютаБазовогоАктива() == FD.ВалютаТребования()) and FD.IsExistAccount("+Форвард, прочие", null, true, FIROLE_FIREQ, СчетТреб, null, SvOpDvOper.rec.Date, FD.ВалютаТребования()) )
              if( DV_NeedCorrectOverByAcc( FD, doc, SvOpDvOper.rec.Date, СчетТреб, true, true, ReportLineData ) != 0 )
                 return 1;
              end;
           end;
        end;
     end;
  /*PNV*/
  elif (SvOpDvOper.rec.id == 0)
        if( (FD.ВалютаБазовогоАктива() == FD.ВалютаОбязательства()) and FD.IsExistAccount("-Форвард, прочие", null, true, FIROLE_FICOM, СчетОбяз, null, {Curdate}, FD.ВалютаОбязательства()) )
             if( DV_NeedCorrectOverByAcc( FD, doc, {Curdate}, СчетОбяз, false, true, null ) != 0)
                 return 1;
             end;
        elif( (FD.ВалютаБазовогоАктива() == FD.ВалютаТребования()) and FD.IsExistAccount("+Форвард, прочие", null, true, FIROLE_FIREQ, СчетТреб, null, {Curdate}, FD.ВалютаТребования()) )
             if( DV_NeedCorrectOverByAcc( FD, doc, {Curdate}, СчетТреб, true, true, null ) != 0 )
                return 1;
             end;
        end;
  /*PNV*/
  end;

  return 0;
End;

MACRO ОтражениеВзаимозачётаПП(FD, Doc, СуммаПлатежа, ДатаПлатежа)

  VAR DebAcc  = TRecHandler("account");
  VAR CredAcc  = TRecHandler("account");
  var ВалютаПлатежа = FD.nFI_BaseActiv.rec.PriceFIID;
  if( not FD.IsExistAccount( ПИ_КатегорияМнФорвардРПИ(), null, null, FIROLE_FICOM, DebAcc, MC_PAIRACCMODE_MANUAL, ДатаПлатежа, ВалютаПлатежа, null, null ) )
     return 1;
  end;
  if( not FD.IsExistAccount( ПИ_КатегорияПлФорвардРПИ(), null, null, FIROLE_FIREQ, CredAcc, MC_PAIRACCMODE_MANUAL, ДатаПлатежа, ВалютаПлатежа, null, null ) )
     return 1;
  end;

  // Проводка И1
  if( not ПроводкаПоКатегориямУчета( FD, 
                                     DebAcc,                                         /* Деб */
                                     CredAcc,                                        /* Кредит */
                                     ДатаПлатежа,                                    /* Дата */
                                     1,                                              /* Глава */
                                     ВалютаПлатежа,                                  /* Валюта */
                                     СуммаПлатежа,                                   /* Сумма */
                                     Doc,                                            /* Документ */
                                     INPCARRY,                                       /* Result_Carry */
                                     "",                                             /* Kind_Oper */
                                     "",                                             /* Numb_Document */
                                     "Отражение взаимозачёта ПП по сделке " + FD.DealCode() + " от " + FD.ДатаСделки() + ". Контрагент: "+ DV_GetPartyName (FD.Deal.rec.contractor) ,  /* Ground */ /*pnv 505321*/
                                     NULL, NULL, NULL,
                                     ВалютаПлатежа, ВалютаПлатежа
                                   )
   )
     return 1;
  end;

  return 0;
END;
