/*
$Name:        dvnop120.mac
$Module:      Производные инструменты
$Description: Внебиржевая операция. Шаг: Постановка на балансовый учет
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

var EDate:date;
var SDate:date;
var PDate:date;

/*PNV*/
private macro PartyIsNotResident( PartyID )
   var PartyObj:RsbParty = RsbParty( PartyID );
   return PartyObj.IsNotResident;
end;
/*PNV*/

/*вытащить из комментария номер подтверждения*/
PRIVATE MACRO Get_Num_Doc (str)
  var str1 = "", str2 = "", str3 = "";

  if (index (str, "подтверждение") > 0) 
      str1 = trim(substr(str, index (str, "подтверждение") + strlen("подтверждение "), 9999));
  elif (index (str, "Подтверждение") > 0) 
      str1 = trim(substr(str, index (str, "Подтверждение") + strlen("Подтверждение "), 9999));
  else
      str1 = "";
  end;
  return "Подтверждение №" + str1;
END;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  SetBuff( ndeal, FDoc );

  var FD = DVFirstDocNDeal(DocKind, ndeal);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;
  var ДатаИсполненияШага:date;
  var ПлатежТреб, ПлатежОб;
  var EarlySettlement:integer;

  if( FD.ПлатежТреб.rec.PaymentID > 0 )
     ПлатежТреб = RsbPayment(FD.ПлатежТреб.rec.PaymentID);
  end;

  if( FD.ПлатежОб.rec.PaymentID > 0 )
     ПлатежОб = RsbPayment(FD.ПлатежОб.rec.PaymentID);
  end;

  if( (FD.IsOptionAmerican() or FD.IsForwardOpenDate()) and ((EDate == NULL) or (EDate == date(0,0,0))) )
     MsgBox("Вставка шага должна выполняться из скроллинга операций по Ctrl-E.");
     return 1;
  end;

  if( (EDate != NULL) and (EDate != date(0,0,0)) )
     ДатаИсполненияШага = EDate;
  else
     //ДатаИсполненияШага = FD.ДатаИсполненияОпцион();
     ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);/*FD.ДатаИсполнения();*/
  end;

  /*PNV*/
  if (FD.IsOption)
      if( MsgBoxEx( "Дата исполнения опциона " + FD.ДатаИсполненияОпцион()+ " |Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
      return 1;
      end;
  end;
  /*PNV*/
  if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) )
     if( not FD.ВыполненаПереоценкаСС( ДатаИсполненияШага ) )
        if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
           return 1;
        end;
     end;
  end;

  if( (FD.IsOptionAmerican() or FD.IsForwardOpenDate()) )
     /*Даты передаются шагу и заносятся в платежи*/
     if( FD.ПлатежТреб.rec.PaymentID > 0 )
        ПлатежТреб.ValueDate = FD.ДатаТребования(PDate, SDate);
     end;
     if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.ValueDate   = FD.ДатаОбязательства(PDate, SDate);
     end;

     /* Переинициализировать даты требования и обязтельства */
     if( not OprReplanStepPlanDates( DV_NDEAL_OPRDATE_REQ, FD.ДатаТребования(PDate, SDate), false ) )
        msgbox("Ошибка при попытке переинициализировать дату требования." );
        return 1;
     end;
     if( not OprReplanStepPlanDates( DV_NDEAL_OPRDATE_OBL, FD.ДатаОбязательства(PDate, SDate), false ) )
        msgbox("Ошибка при попытке переинициализировать дату обязательства." );
        return 1;
     end;
  end;

  /* устанавливаем признак участия в неттинге 
  if( FD.IsClient() == false )
     if(FD.Netting())
     if( (FD.ПлатежТреб.rec.PaymentID > 0) and (not ПИ_СтутусПлатежИсполнен(FD.ПлатежТреб.rec.PaymStatus)) )
        ПлатежТреб.Netting = SET_CHAR;
     end;

     if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.Netting = SET_CHAR;
     end;
  end;
  end;*/

  //12.02.2018 mda Кусок кода выше неверен. Нужно смотреть есть ли на сделке признак неттинга и в зависимости от этого завешивать неттинг на платежи.
  if( (FD.IsClient() == false) and (FD.deal.rec.Netting == SET_CHAR))
    if( FD.ПлатежТреб.rec.PaymentID > 0 )
        ПлатежТреб.Netting = SET_CHAR;
     end;

    if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.Netting = SET_CHAR;
     end; 
  end;

  //mda 19/02/19 Назначение платежей!
  if( FD.ПлатежОб.rec.PaymentID > 0 )
     if ((ПлатежОб.OutCorschem != -1 ) and (IsCorschem_LORO (ПлатежОб.OutCorschem, ПлатежОб.basefiid)) )
         if (PartyIsNotResident(ПлатежОб.receiver))
             ПлатежОб.Ground =  FD.GetGround(1007);/*PNV*/
         else
             ПлатежОб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
     else
         if (FD.ПлатежОб.rec.BaseFiid != NATCUR )
             ПлатежОб.Ground =  FD.GetGround(1007);/*PNV*/
         elif (FD.IsOption())
             ПлатежОб.Ground = FD.GetGround(1004);
       /*PNV 505935*/
         elif (FD.IsForward())
             ПлатежОб.Ground = FD.GetGround(1001) + ". " + Get_Num_Doc (FD.deal.rec.comment);
       /*PNV 505935*/
         else
             ПлатежОб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
     end;
  end;
  /*PNV*/
  if( FD.ПлатежТреб.rec.PaymentID > 0 )
     if ((ПлатежТреб.OutCorschem != -1 ) and (IsCorschem_LORO (ПлатежТреб.OutCorschem, ПлатежТреб.basefiid)) )
         if (PartyIsNotResident(ПлатежТреб.receiver))
             ПлатежТреб.Ground =  FD.GetGround(1007);/*PNV*/
         else 
             ПлатежТреб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
     else
         if (FD.ПлатежТреб.rec.BaseFiid != NATCUR)
             ПлатежТреб.Ground =  FD.GetGround(1007);/*PNV*/
       /*PNV 505935*/
         elif (FD.IsForward())
             ПлатежОб.Ground = FD.GetGround(1001) + ". " + Get_Num_Doc (FD.deal.rec.comment);
       /*PNV 505935*/
         else    
            ПлатежТреб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
    end;
  end;
  /*PNV*/
  if( GetOprStatus(IIF(DocKind == DL_DVDEALT3, DV_OPERSTATUS_T3_EARLY_SETTLEMENT, DV_OPERSTATUS_EARLY_SETTLEMENT)) == DV_EARLY_SETT_OPERSTATUS_YES )
    EarlySettlement = 2;
  end;

  if ( АктуализироватьПлатежи(FD, ДатаИсполненияШага, EarlySettlement) != 0 )
     return 1;
  end;

  //mda 15.02.2019 Для всей внебиржи унесем списание СС в отдельный шаг.
  //экстренно пока только опционы
  if (FD.Биржевая())
    if( СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ) != 0 )
       return 1;
    end;
  end;
  if( ОтражениеКонверсионнойОперацииВБалансе( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( FD.IsOptionAmerican() )
     if( ДатаИсполненияШага < FD.ДатаИсполнения() )
        /* вставить документ "Уведомление об исполнении" и распечатать */
     end;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND(), DV_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Требования> по операции.");
     return 1;
  end;

  if (GetOprStatus(IIF(DocKind == DL_DVDEALT3, DV_OPERSTATUS_T3_EARLY_SETTLEMENT, DV_OPERSTATUS_EARLY_SETTLEMENT)) != DV_EARLY_SETT_OPERSTATUS_YES)
  if( not InsertOprStatus(FD.DV_OPERSTATUS_LIABILITY(), DV_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
     return 1;
  end;
  else
     if( not InsertOprStatus(FD.DV_OPERSTATUS_LIABILITY(), DV_OPERSTATUS_DL_COMPLETE) )
        MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
        return 1;
     end;
  end;

  return 0;
end;
