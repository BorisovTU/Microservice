/*
$Name:        dlsettl099.mac
$Module:      Ядро Securities
$Description: Операция "Расчеты с биржей", Шаг Завершение расчетов с биржей по ФИ
*/
import InsCarryDoc, "dv_fun.mac", "dv_class.mac", "dv_car.mac", "dv_categ.mac", "dv_carop.mac";

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )
  record comm( dl_comm );
  var    FD, DebAcc, CredAcc; 
  var OurAcc = TRecHandler("account");
  var СчетБиржа = TRecHandler("account");
  var ground = ""; // Golovkin
  var ФинансовыйИнструмент = TRecHandler("fininstr"); // Golovkin


  SetBuff( comm, FirstDoc );                                
  FD = DVFirstDocDLCOMM( comm );
  if( FD.IsExistsAnalytics() )
     var sql = DL_RSDCommand(  " SELECT S.T_FIID, S.T_SUM, S.T_OFFICEID "      
                              +"   FROM DDL_TOTALOFFISUM_DBT S, DDL_TOTALOFFI_DBT T, DFININSTR_DBT FI "
                              +"  WHERE S.T_DOCKIND = ?  "                      
                              +"    AND S.T_DOCID   = ?  "                      
                              +"    AND S.T_DOCKIND = T.T_DOCKIND "                      
                              +"    AND S.T_DOCID   = T.T_DOCID  "                      
                              +"    AND S.T_FIID   = T.T_CODEFI  "                      
                              +"    AND T.T_PARENT = 0  "
                              +"    AND S.T_FIID != ? "             
                              +"    AND FI.T_FIID = S.T_FIID "
                              +"    AND FI.T_FI_KIND != ? "
                              +"    AND S.T_OFFICEID in(SELECT Analytics.t_CentrOfficeID " 
                              +"                          FROM DDL_EXTSETTLECODE_DBT ExtCode, DDL_EXTSCANALYTICS_DBT Analytics " 
                              +"                         WHERE ExtCode.T_MarketSchemeID = ? " 
                              +"                           AND ExtCode.T_ParentID = 0 " 
                              +"                           AND Analytics.T_CodeID = ExtCode.T_ID) "
                            ); 
     sql.addParam( FD.Kind );
     sql.addParam( FD.ID );
     sql.addParam( NATCUR );
     sql.addParam( FIKIND_METAL );
     sql.addParam( FD.GetMarketSchemeID() );
    
     var DataSet = sql.execute();
     while( DataSet.MoveNext() )

        if( ( not FD.IsExistAccount("+Обеспечение", null, true, null, OurAcc, null, FD.Comm.rec.CommDate, DataSet.FIID) ) and 
           (not FD.OpenAccount("+Обеспечение", null, false, null, OurAcc, FD.Comm.rec.CommDate, DataSet.FIID))
           )
           MsgBox("Ошибка: не открыт счет категории \"+Обеспечение\" в валюте FIID = " + String(DataSet.FIID));
           return 1;
        end;
        var FIID = DataSet.FIID;

        FD.SetOfficeID(DataSet.OFFICEID);
        if( DataSet.Sum > 0 )
              if( (not FD.IsExistAccount(IIF((DataSet.OFFICEID) == 4, "Клиринговый счетВ3", "+Биржа"), null, true, null, СчетБиржа, null, FD.Comm.rec.CommDate, DataSet.FIID)) and
                  (not FD.OpenAccount(IIF((DataSet.OFFICEID) == 4, "Клиринговый счетВ3", "+Биржа"), null, false, null, СчетБиржа, FD.Comm.rec.CommDate, DataSet.FIID))
             )
              return 1;
           end;
               DebAcc  = OurAcc;
               CredAcc = СчетБиржа;        
        else
              if( (not FD.IsExistAccount(IIF((DataSet.OFFICEID) == 4, "Клиринговый счетВ", "-Биржа"), null, true, null, СчетБиржа, null, FD.Comm.rec.CommDate, DataSet.FIID)) and
                  (not FD.OpenAccount(IIF((DataSet.OFFICEID) == 4, "Клиринговый счетВ", "-Биржа"), null, false, null, СчетБиржа, FD.Comm.rec.CommDate, DataSet.FIID))
             )
              return 1;
           end;
           DebAcc  = СчетБиржа;
           CredAcc = OurAcc;
        end;
        FD.SetOfficeID(-1);

        ПолучитьФинИн(DataSet.FIID, ФинансовыйИнструмент);
        ground = "Урегулирование расчетов ЕП по итогам торгов от "+string(FD.Comm.rec.CommDate:f)+" г. "+ФинансовыйИнструмент.rec.name+"";

        if( not ПроводкаПоКатегориямУчета( FD,
                                           DebAcc, CredAcc,
                                           FD.Comm.rec.CommDate,
                                           1,
                                           DataSet.FIID, abs(DataSet.Sum),
                                           doc,
                                           INPCARRY, "", "",
                                           ground,//"Отражение сальдо по итогам торгов",
                                           NULL, FIROLE_BA, FIROLE_BA,
                                           FIID, DataSet.FIID,
                                           FIID, abs(DataSet.Sum),
                                           NULL, NULL, NULL, NULL,
                                           ACCTRN_SIDE_DEBET, NULL, NULL, NULL, NULL, NULL,
                                           null, null, null, null, null, null, true 
                                         )
          )
            return 1;
        end;

     end;
  end;

  return 0;
end;

PRIVATE MACRO DL_Scroll( Select:STRING, Header:STRING, X:INTEGER, Y:INTEGER /*...*/):RsdRecordset

  var rs     = RsdRecordset( Select, null, RSDVAL_STATIC ),
      Column = TArray(),
      i, ColumnValue, ColumnName, NumColumns = 0;

  macro EvProc( rs, cmd, id, key )
    return CM_DEFAULT;
  end;
  
  /* атрибуты полей */
  macro AddColumn( ar,ind, fld, head )
     ar.value( ind * 6 + 0 ) = fld;  // fieldName
     ar.value( ind * 6 + 1 ) = head; // header 
     ar.value( ind * 6 + 2 ) = null; // width
     ar.value( ind * 6 + 3 ) = 2;    // fldType (2 = FBT)
     ar.value( ind * 6 + 4 ) = null; // decPoint
     ar.value( ind * 6 + 5 ) = 0;    // reserv
     NumColumns = NumColumns + 1;
  end;
 
  i = 4;
  while( GetParm(i, ColumnValue ) AND GetParm(i+1, ColumnName) )              
     AddColumn( Column, NumColumns, ColumnValue, ColumnName );
     i = i + 2;
  end;   

  if( rs.moveNext() )
    if( RunScroll( rs, NumColumns, Column, null, @EvProc, Header, "Esc Выход F4 Поиск Enter Выбор", true, X, Y, null, 25 ) )
       return rs;
    end;
  end;

  return null;
END;

/* Макрос печати */
MACRO PrintStepDocs (
                ID_Operation,  /* Номер экземпляра операции */
                ID_Step,       /* Номер шага операции */
                Kind_Operation,/* Вид операции */
                KindStep)      /* Вид шага операции */
  var opersql = DL_RSDCommand(" select to_number(oproper.t_documentid) documentid_number, oproper.* from doproper_dbt oproper where oproper.t_id_operation = :id_operation ");
      opersql.addParam( ID_Operation );

  var oproper = opersql.execute();
  if(not oproper.MoveNext())
     return 1;
  end;

  var dl_comm_sql = DL_RSDCommand(" select * from ddl_comm_dbt dl_comm where dl_comm.t_documentid = :documentid and dl_comm.t_dockind = :dockind ");
      dl_comm_sql.addParam( int(oproper.documentid_number) );
      dl_comm_sql.addParam( int(oproper.dockind) );

  var dl_comm = dl_comm_sql.execute();
  if(not dl_comm.MoveNext())
     return 1;
  end;
  
     var addTrn;
     var Trns = RSDCommand("BEGIN Rsb_Secur.FillItogClirAccTrn(:p_DocID, :p_DocKind); END; ");
     Trns.addParam( "", RSDBP_IN, dl_comm.DocumentID );
     Trns.addParam( "", RSDBP_IN, dl_comm.DocKind );
     Trns.execute();
    
  var Choice = DL_Scroll(" SELECT TRN.T_NUMB_DOCUMENT,                                           " +
                         "        TRN.T_DATE_CARRY,                                              " +
                         "        TRN.T_ACCOUNT_PAYER,                                           " +
                         "        TRN.T_SUM_PAYER,                                               " +
                         "        TRN.T_ACCOUNT_RECEIVER,                                        " +
                         "        TRN.T_SUM_RECEIVER,                                            " +
                         "        TRN.T_GROUND                                                   " +
                         "   FROM DDL_ITOGCLIRACCTRN_TMP tmp, dacctrn_dbt trn                    " +
                         "  WHERE tmp.t_acctrnid = trn.t_acctrnid                                ", 
                         /*"    AND not exists (select 1                                           " +
                         "                      from doprdocs_dbt docs                           " +
                         "                     where docs.t_acctrnid = tmp.t_acctrnid            " +
                         "                        and docs.t_id_operation = "+int(ID_Operation)+"" + 
                         "                        and docs.t_id_step = "+int(ID_STEP)+")         "*/
                         "Проводки", null,null, 
                         "T_NUMB_DOCUMENT", "Номер документа",
                         "T_DATE_CARRY", "Дата проводки",
                         "T_ACCOUNT_PAYER", "Счет дебета",
                         "T_SUM_PAYER", "Сумма дебета",
                         "T_ACCOUNT_RECEIVER", "Счет кредита",
                         "T_SUM_RECEIVER", "Сумма кредита",
                         "T_GROUND", "Основание проводки");     

END;                

