/* Операция расчетов по ПИ            */
/* Шаг: Учет гарантийного обеспечения */

import InsCarryDoc, "dvserv.mac", "dv_fun.mac", "dv_carop.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step)

  record oper(dvoper);

  var FD_Oper:DVFirstDocOper;
  var Query:string = "", Data:variant;
  var Count:integer = 0;
  accDvdealTrnArr.size = 0;

  SetBuff( oper , FDoc );

  FD_Oper = DVFirstDocOper( DL_DVOPER, oper );
  Query = " SELECT TURN.T_CLIENT, POS.T_CLIENTCONTR, FIN.T_PARENTFI, sum(TURN.T_GUARANTY) GUARANTY " +
          "   FROM ddvfiturn_dbt TURN, ddvfipos_dbt POS, dfininstr_dbt FIN " +
          "  WHERE FIN.T_FIID = TURN.T_FIID " +
          "    AND " + TurnByOperationPrev(oper) +
          "    AND " + TurnByPosition(null,null,"POS") +
          " GROUP BY TURN.T_CLIENT, POS.T_CLIENTCONTR, FIN.T_PARENTFI ";

  Data = TRsbDataSet(Query);

  if( Data )
     InitProgress( SQL_GetNRecs( Query ), "Выполнение проводок по учету гарантийного обеспечения", "Выполнение..." );
     while( Data.MoveNext() )
        if( Data.Guaranty > 0 )
           if( ВыполнитьПроводкуУчетаВозвратаГарантий( FD_Oper, oper, doc, Data.Guaranty, Data.Parentfi, Data.ClientContr, Data.Client, false ) == false )
              RemProgress();
              return 1;
           end;
        end;
        UseProgress( Count = Count + 1 );
     end;
     RemProgress();
  end;

  if ( not InsertDvdealTrnLink(ID_Operation, ID_Step) )
    MsgBox("Ошибка при сохранении информации о связи проводок со сделками срочного рынка");
    return 1;
  end;

  return 0;
end;
