/*
$Name:        dvfx050b.mac
$Module:      Производные инструменты
$Description: Банкнотная сделка. Шаг "Постановка на балансовый учет"
*/
Import InsCarryDoc, "dv_categ.mac", "dv_car.mac";
Import rsd, RsbDataSet;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
  
  record deal(dvndeal);
  var FD, FD2;
  var ДатаИсполненияШага:date;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  GetOprDate(DV_FXDEAL_OPRDATE_EXEC, ДатаИсполненияШага);

  var que,rs,PartyCateg;
  var sel_pr, rs_pr;
  var KUNezav; 
      sel_pr =  "select t_name from dobjattr_dbt ttr, dobjatcor_dbt cor "
                "where ttr.t_objecttype = 148 "
                "and TTR.T_ATTRID = COR.T_ATTRID "
                "and ttr.t_groupid = cor. t_groupid " 
                "and ttr.t_groupid = 202 "
                "and  cor.t_object = lpad(" + FD.id +", 34, '0')";
      rs_pr = RsdRecordSet(RsdCommand(sel_pr));
 /* CHVA*/
 /*Отбираем даты платежей по сделке для заполнени категорий на сделке по условиям: если даты валютирования равны, то ничего не проставляем,*/
 /* если дата БА > даты КА, то ставим предоплату, если дата БА < даты КА, то предпоставку*/
 var valdate;
 var valDateFirst = date(0,0,0);
 var valDateSecond = date(0,0,0);
 var purp;
 var sql = "select t_valuedate, t_purpose from dpmpaym_dbt where t_documentid = " + FD.Deal.rec.id;
 var q = DL_RSDCommand(sql);
 var Data = q.execute();
    while( Data.MoveNext() )
      valdate = date(0,0,0);
      purp = 0;

      valdate = Data.valuedate;
      purp = Data.purpose;
       if (purp == 1) /* t_purpose = 1  платеж по базовому активу*/
         valDateFirst = valdate;
       elif (purp == 2)/* t_purpose = 2  платеж по контрактиву активу*/
         valDateSecond = valdate;
       end;
    end;
 
 if ((valDateFirst > valDateSecond) and ( FD.IsBuy() ))
            PartyCateg = RsbObjCategories( 148, mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id) );
            PartyCateg.ConnectAttr( 202, 2, null, null,ДатаИсполненияШага);
            PartyCateg.Save(mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id));
            PartyCateg = Null;
 elif ((valDateFirst < valDateSecond) and ( FD.IsSale() ))
            PartyCateg = RsbObjCategories( 148, mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id) );
            PartyCateg.ConnectAttr( 202, 1, null, null,ДатаИсполненияШага);
            PartyCateg.Save(mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id));
            PartyCateg = Null;
 end;
 /*CHVA*/

 if (FD.DEAL.rec.type == 2); /*Продажа*/
     if(rs_pr.moveNext())
              if (rs_pr.value("t_name") == "Предоплата")
                KUNezav = "+Незавершенные";
              else
              KUNezav = "-Незавершенные";
             end;
     else
           if (SubStr (FD.DEAL.rec.comment,index (FD.DEAL.rec.comment,"рамках лимита"),13) == "рамках лимита")/*CHVA Добавил проверки на сделки в рамках лимита */
              if( MsgBoxEx("Подтвердите наличие платежа", MB_YES + MB_NO, IND_YES) == IND_YES ) /*если выбираем Yes, то документ есть, значит предпоставка (счет 30222) иначе предоплата (счет 30221)*/
                     KUNezav = "+Незавершенные";
              else
                     KUNezav = "-Незавершенные";
              end;
            PartyCateg = RsbObjCategories( 148, mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id) );
            PartyCateg.ConnectAttr( 202, 3, null, null,ДатаИсполненияШага);
            PartyCateg.Save(mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id));
            PartyCateg = Null;
           else/*CHVA*/
              KUNezav = "-Незавершенные";
           end;/*CHVA*/
     end;
 elif (FD.DEAL.rec.type == 1);/*Покупка*/
     if(rs_pr.moveNext())
            if (rs_pr.value("t_name") == "Предоплата")
              KUNezav = "-Незавершенные";
            else
              KUNezav = "+Незавершенные";
           end;
     else
         if (SubStr (FD.DEAL.rec.comment,index (FD.DEAL.rec.comment,"рамках лимита"),13) == "рамках лимита")/*CHVA Добавил проверки на сделки в рамках лимита */
              if( MsgBoxEx("Подтвердите наличие кассовой проводки", MB_YES + MB_NO, IND_YES) == IND_YES ) /*если выбираем Yes, то документ есть, значит предпоставка (счет 30221) иначе предоплата (счет 30222)*/
                     KUNezav = "-Незавершенные";
              else
                     KUNezav = "+Незавершенные";
              end;
            PartyCateg = RsbObjCategories( 148, mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id) );
            PartyCateg.ConnectAttr( 202, 3, null, null,ДатаИсполненияШага);
            PartyCateg.Save(mkStr("0", 34-StrLen(string(FD.id))) + string(FD.id));
            PartyCateg = Null;
         else /*CHVA*/
           KUNezav = "+Незавершенные";
         end; /*CHVA*/
     end;
 end;

  if( FD.IsSWAP() )
     FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, deal, 2);
  end;

  if( ПИКО_АктуализироватьПлатежи(FD, KUNezav) != 0 )
     return 1;
  end;

  if( FD.IsSWAP() )
     if( ПИКО_АктуализироватьПлатежи(FD2) != 0 )
        return 1;
     end;
  end;
  
 if (FD.DEAL.rec.type == 1);
    if( ПИКО_ПоставитьНаБалансБанкнотнуюСделку(FD, doc, ДатаИсполненияШага, KUNezav) != 0 )
       return 1;
    end;
 elif (FD.DEAL.rec.type == 2);

    if( ПИКО_ПоставитьНаБалансБанкнотнуюСделкуПродажа(FD, doc, ДатаИсполненияШага, KUNezav) != 0 )
       return 1;
    end;
 end;

  if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_BALANCE, DV_FX_OPERSTATUS_DL_COMPLETE) )
     MsgBox("Ошибка при установке статуса <Баланс> по операции.");
     return 1;
  end;
  var isEast = 0;
  var kindbnote = "";
  GetMainObjAttr(null, OBJTYPE_FXOPER_DV, uniid(deal, OBJTYPE_FXOPER_DV), 202, null, null, kindbnote);  //Получаем значение категории 202 Предоплата/предпоставка 
  //SVE механизм планировки шагов исполнения Т/О
  if (kindbnote == "")         
     if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
        MsgBox("Ошибка при установке статуса <Требования> по операции.");
        return 1;
     end;
     /*CHVA*/  
     if (not GetMainObjAttr( null, 2, strLpad(string(/*FD.nfi.rec.fiid*/FD.Валютаобязательства()), 10, "0"), 101, isEast))/*PNV i-support 500390 надо же проверять валюту обязательства, а не базовую валюту!*/
        isEast = 0;
     end;
     //CHVA 498265 для банкнотных сделок  "Покупка " при БА "Восточные валюты" шаг обязательства при постановке на баланс повторно планировать не надо
     if ( FD.IsBNote() and (isEast == 1)  and FD.IsBuy() )
        return 0 ;
     end;   
     if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
        MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
        return 1;
     end;
  elif (kindbnote == 2) //Предоплата 
     if (FD.IsBuy())
        if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
           return 1;
        end;
     else
        if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Требования> по операции.");
           return 1;
        end;
    end;
  elif (kindbnote == 1) //Предпоставка
     if (FD.IsBuy())
        if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Требования> по операции.");
           return 1;
        end;
     else
        if ( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
           MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
           return 1;
        end;
     end;
  else//PNV В любой другой непонятной ситуации планируем как в дистрибутиве
     if ((GetOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND) != DV_FX_OPERSTATUS_DL_RUN) and (GetOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND) != DV_FX_OPERSTATUS_DL_COMPLETE))
          if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND, DV_FX_OPERSTATUS_DL_RUN) )
              MsgBox("Ошибка при установке статуса <Требования> по операции.");
              return 1;
          end;
     end;

      if ((GetOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY) != DV_FX_OPERSTATUS_DL_RUN) and (GetOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY) != DV_FX_OPERSTATUS_DL_COMPLETE))
           if( not InsertOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY, DV_FX_OPERSTATUS_DL_RUN) )
                MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
                return 1;
          end;
     end;

     if((GetOprStatus(DV_FX_OPERSTATUS_KIND_DEMAND) == DV_FX_OPERSTATUS_DL_COMPLETE) and (GetOprStatus(DV_FX_OPERSTATUS_KIND_LIABILITY) == DV_FX_OPERSTATUS_DL_COMPLETE))
         if( not DV_ОбновитьСтатусЧастиСделки(FD.nFI, DL_LEG_FORM) )
              MsgBox("Ошибка при изменении статуса сделки");
              return 1;
        end;
    end;
  end;
  
  return 0;
end;
