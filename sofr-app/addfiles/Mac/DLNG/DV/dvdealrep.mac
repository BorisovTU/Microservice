/*
$Name:             dvdealrep.mac
$Module:           Производные инструменты
$Description:      Отчет "Субрегистр срочных сделок"
*/
import "dvrepfun.mac";
import "dvRepFun2.mac";
import RsbDataSet;
import "or_rep_h.mac";

private var Dprt     = TBFile( "dp_dep",      "R", 0 );    /*филиал*/
private var FinInstr = TBFile( "fininstr.dbt","R", 0 );    /*финансовый инструмент*/

private const UNDF   =  -1;
const POS_SHORT      =  1;    // Короткая позиция
const POS_LONG       =  2;    // Длинная позиция
const FontStyleTitel =  "ex_FS(b)";

private var File_DVDeal;
private var IsDprtSort;
private var DVQuery, RsdDVQuery;

/* Структура с исходными данными */
class SourceData( _DprtID:integer,
                  _ByDV:bool,
                  _ByVA:bool,
                  _BaseFIKind:integer,
                  _BaseFIID:integer,
                  _DVFIKindID:integer,
                  _EmiID:integer, 
                  _DVFIID:integer,
                  _AvrIssuerID:integer,
                  _DealType:integer, 
                  _ClientID:integer, 
                  _IsMarket:bool,
                  _ContractorID:integer,
                  _IsOutMarket:bool,
                  _dateMin:date, _dateMax:date,
                  _IsSeparatelyDate:bool,
                  _DealStatus:integer,
                  _IsApp:bool,
                  _IsExcel:bool ) 

   var 
       DprtID            = _DprtID,
       ByDV              = _ByDV,
       ByVA              = _ByVA,
       BaseFIKind        = _BaseFIKind,
       BaseFIID          = _BaseFIID,        
       DVFIKindID        = _DVFIKindID,      
       EmiID             = _EmiID,           
       DVFIID            = _DVFIID,
       AvrIssuerID       = _AvrIssuerID,         
       DealType          = _DealType,        
       ClientID          = _ClientID,        
       IsMarket          = _IsMarket,        
       ContractorID      = _ContractorID,    
       IsOutMarket       = _IsOutMarket,     
       dateMin           = _dateMin,         
       dateMax           = _dateMax,         
       IsSeparatelyDate  = _IsSeparatelyDate,
       DealStatus        = _DealStatus,      
       IsApp             = _IsApp,           
       IsExcel           = _IsExcel;
end;

var str = "┌──────────┬───────────────────┬───────────────────┬──────────────────┬──────────────────┬────────────────────┬─────────┬──────────────┬─────────────┬──────────────────┬─────────────────┬────────┬───────────────┬──────────┬────────────────┬────────┬────────┬───────────────────────────────────┐\n"+
          "│          │                   │                   │ Место заключения │    Вид сделки/   │                    │   №     │              │     Вид     │                  │ Цена исполнения │ Валюта │               │  Валюта  │                │ Валюта │  Исп.  │      Подтверждающий документ      │\n"+
          "│ № сделки │       Дата        │       Время       │      сделки      │     операции     │       Клиент       │поручения│  № договора  │  контракта  │     Контракт     │     опциона     │  цены  │  Цена сделки  │   цены   │   Количество   │расчетов│внебирж.├───────────┬───────────┬───────────┤\n"+
          "│          │                   │                   │                  │                  │                    │         │              │             │                  │                 │        │               │  сделки  │                │        │        │ Вид док-та│  № док-та │   Дата    │\n"+
          "├──────────┼───────────────────┼───────────────────┼──────────────────┼──────────────────┼────────────────────┼─────────┼──────────────┼─────────────┼──────────────────┼─────────────────┼────────┼───────────────┼──────────┼────────────────┼────────┼────────┼───────────┼───────────┼───────────┤";

var Rep = CMakeReport(str);

private macro ПечатьЗаголовка()
                       
[                                          
                                      ОТЧЕТ 
                           СУБРЕГИСТР СРОЧНЫХ СДЕЛОК
];
end;

macro OptionType( type )
   if( type == 0 )
       return " ";
   elif( type == 1 )
       return "Put";
   else
       return "Call";
   end;
end;

private macro OptionStyle( type )
   if( type == 0 )
       return " ";
   elif( type == 1 )
       return "American";
   else
       return "European";
   end;
end;

private macro OptionEXECTYPE( type )
   if( type == -1 )
       return "";
   elif( type == 0 )
       return "Расчетный";
   else
       return "Поставочный";
   end;
end;

macro PrintReportHead( Data, CurDate )
  var BaseFIKindName = "", BaseFI = "";
  var DVFiKind = "", DVIssuer = "", DVFI = "";
  var Client = "", SfContr = "", Deal = "", PeriodDate, AvrIssuer = "";

   if( Data.BaseFIKind and ( Data.BaseFIKind != UNDF ) )
       BaseFIKindName = GetFIKind( Data.BaseFIKind );
   end;
   if( Data.BaseFIID and ( Data.BaseFIID != UNDF ) )
       FinInstr.Clear();
       FinInstr.rec.FIID = Data.BaseFIID;
       if( not FinInstr.GetEQ() ) 
          MsgBox( "Ошибка при определении производного инструмента|(FIID = ", Data.BaseFIID, ")");
       end;
       if( FinInstr.rec.AvoirKind != 0 )
           BaseFI = GetAvoirKind( FinInstr.rec.FI_Kind, FinInstr.rec.AvoirKind ) +" "+ FinInstr.rec.FI_Code;
       else
           BaseFI = FinInstr.rec.FI_Code;
       end;
   end;
   if( Data.DVFIID and ( Data.DVFIID != UNDF ) )
       FinInstr.Clear();
       FinInstr.rec.FIID = Data.DVFIID;
       if( not FinInstr.GetEQ() ) 
          MsgBox( "Ошибка при определении производного инструмента|(FIID = ", Data.BaseFIID, ")");
       end;
       DVFI = FinInstr.rec.FI_Code;
   end;
   if( Data.DVFIKindID and ( Data.DVFIKindID != UNDF ) )
       DVFIKind = GetAvoirKind( 4, Data.DVFIKindID );
   end;
   if( Data.EmiID and ( Data.EmiID != UNDF ) )
       DVIssuer = GetParty( Data.EmiID );
   end;
   if( Data.ClientID and ( Data.ClientID != UNDF ) )
       Client = GetParty( Data.ClientID );
   end;
   if( Data.ContractorID and ( Data.ContractorID != UNDF ) )
       SfContr = GetParty( Data.ContractorID );
   end;

   if(Data.IsSeparatelyDate == true)
      PeriodDate = CurDate;
   else
      PeriodDate = Data.dateMin + " - " + Data.dateMax;
   end;
   if( Data.AvrIssuerID and ( Data.AvrIssuerID != UNDF ) )
       AvrIssuer = GetParty( Data.AvrIssuerID );
   end;

   Rep.AutoScan(
  " [                                                                          Субрегистр срочных сделок. \n" +
  "                                                                                                       \n" +
  "    Отчетный период #######################                                                            \n" +
  "                                                                                                       \n" +
  "    Вид исходного актива:    #                                                                         \n" +
  "    Исходный актив:          #                                                                         \n" +
  "    Вид контракта:           #                                                                         \n" +
  "    Эмитент контракта:       #                                                                         \n" +
  "    Контракт:                #                                                                         \n" +
  "    Эмитент ц/б:             #                                                                         \n" +
  "    Клиент:                  #                                                                         \n" +
  "    Контрагент по расчетам:  #                                                                         \n" +
  "    #                                                                                                  \n" +
  "  ]()",
          PeriodDate,    "l:" + FontStyleTitel, 
          BaseFIKindName,"l:" + FontStyleTitel,
          BaseFI,        "l:" + FontStyleTitel,
          DVFIKind,      "l:" + FontStyleTitel,
          DVIssuer,      "l:" + FontStyleTitel,
          DVFI,          "l:" + FontStyleTitel,
          AvrIssuer,     "l:" + FontStyleTitel,
          Client,        "l:" + FontStyleTitel,
          SfContr,       "l:" + FontStyleTitel,
          Deal,          "l:" + FontStyleTitel);

end;

macro PrintReportSubHead( DepartmentName )
   Rep.AddPrintCell("Филиал: " + DepartmentName, strlen("Филиал: " + DepartmentName), 0, "l:" + FontStyleTitel, REP_ELEM_STR);
   Rep.AddStr();
end;

macro PrintSubHeadTable( DealType )
  var DealName = "";
  if( DealType == 0)
      DealName = "Брокерские сделки";
  elif( DealType == 1 )
        DealName = "Собственные сделки";
    else
        DealName = "Доверительное управление";
  end;
  Rep.AddPrintCell(DealName, Rep.GetHeaderWidth(), 0, "l:" + FontStyleTitel);
  Rep.AddStr();

end;

macro PrintDealKindHead( IsOutMark )
  var DealName = "";
  if( IsOutMark )
      DealName = "Внебиржевые сделки";
  else
      DealName = "Биржевые сделки";
  end;

   Rep.AutoScan(
  " [\n" +
  "      ###################" +
  "  ]()",
          DealName,    "l:" + FontStyleTitel);
end;

macro PrintStr( Data,
                Fild_A1:string,
                Fild_D1:date, Fild_T1:string,
                Fild_A2:string,
                Fild_A4:string,
                Fild_A5:string,
                Fild_A6:string,
                Fild_A7:string,
                Fild_A8:string,
                Fild_A9:string,
                Fild_N1:money,
                Fild_A10:string,
                Fild_N2:money,
                Fild_A11:string,
                Fild_N3:money,
                Fild_A11_1:string,
                Fild_A12:string,
                Fild_A13:string,
                Fild_A14:string,
                Fild_A15:date
              )

  Rep.AddPrintCell( Fild_A1, 0, 0, "c:ex_FS(b)" );                         /* поле А1 */
  Rep.AddPrintCell( Fild_D1, 0, 0, "c" );                                  /* поле D1 */
  Rep.AddPrintCell( Fild_T1, 0, 0, "c" );                                  /* поле Т1 */
  Rep.AddPrintCell( Fild_A2, 0, 0, "c" );                                  /* поле А2 */
  Rep.AddPrintCell( Fild_A4, 0, 0, "c" );                                  /* поле А4 */
  if( Fild_A5 )
     Rep.AddPrintCell( Fild_A5, 0, 0, "c" );                               /* поле А5 */
  else
     Rep.AddPrintCell( " ", 0, 0, "c" );
  end;
  if( Fild_A6 )
     Rep.AddPrintCell( Fild_A6, 0, 0, "c" );                               /* поле А6 */
  else
     Rep.AddPrintCell( " ", 0, 0, "c" );
  end;
  if( Fild_A7 )
     Rep.AddPrintCell( Fild_A7, 0, 0, "c" );                               /* поле А7 */
  else
     Rep.AddPrintCell( " ", 0, 0, "c" );
  end;
  Rep.AddPrintCell( Fild_A8, 0, 0, "c" );                                  /* поле А8 */
  Rep.AddPrintCell( Fild_A9, 0, 0, "l" );                                  /* поле А9 */

  if( Fild_N1 > $0.0)   
     if( Data.IsApp )
        Rep.AddPrintCell( Fild_N1, 0, 0, "12:2:a:r" );                     /* поле N1 с разделителями  */
     else                                                             
        Rep.AddPrintCell( Fild_N1, 0, 0, "12:2:r" );                       /* поле N1 */
     end;
     Rep.AddPrintCell( Fild_A10, 0, 0, "c" );                              /* поле А10 */
  else
     Rep.AddPrintCell( " ", 0, 0, "c" );
     Rep.AddPrintCell( " ", 0, 0, "c" );
  end;

  if( Data.IsApp )
     Rep.AddPrintCell( Fild_N2, 0, 0, "12:4:a:r" );                        /* поле N2 с разделителями  */
  else
     Rep.AddPrintCell( Fild_N2, 0, 0, "12:4:r" );                          /* поле N2 */
  end;
  Rep.AddPrintCell( Fild_A11, 0, 0, "c" );                                 /* поле А11 */
  if( Data.IsApp )
     Rep.AddPrintCell( Fild_N3, 0, 0, "12:0:a:r" );                        /* поле N3 с разделителями */
  else
     Rep.AddPrintCell( Fild_N3, 0, 0, "12:0:r" );                          /* поле N3 */
  end;
  Rep.AddPrintCell( Fild_A11_1, 0, 0, "c" );                               /* поле А11 */
  Rep.AddPrintCell( Fild_A12, 0, 0, "c" );                                 
  Rep.AddPrintCell( Fild_A13, 0, 0, "c" );                                 
  Rep.AddPrintCell( Fild_A14, 0, 0, "c" );                                 
  Rep.AddPrintCell( IIF(Fild_A15==Date(0,0,0),"",Fild_A15), 0, 0, "c" );                                 
  Rep.AddStr();

end;

private macro ПолучитьСделки( Data )
   /* Создаем SQL запрос для того чтобы в один прием выгрести все данные для отчета. */
   macro ПолучитьБиржевыеСделки()
      DVQuery =   " SELECT 0 as ModuleType, " +
                  "        DVDeal.T_DATE," +
                  "        DVDeal.T_TIME," +                
                  "        DVDeal.T_FIID," +
                  "        DVDeal.T_DEPARTMENT," +
                  "        DVDeal.T_KIND," +
                  "        DVDeal.T_CODE," +
                  "        ( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = ContrFI.T_FI_KIND and AvrKinds.T_AVOIRKIND = ContrFI.T_AVOIRKIND) DVFIKind," +
                  "        ContrFI.T_FI_CODE," +
                  "        (CASE WHEN DVDeal.t_Broker != -1 " +
                  "              THEN " +
                  "                (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER) || " +
                  "                '\n Брокер: ' || (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.t_Broker) " +
                  "              ELSE " +
                  "                (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = ContrFI.T_ISSUER) " +
                  "         END) IssuerName, " +
                  "        DECODE( ( SELECT SfContr.T_SERVKIND FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVPos.T_CLIENTCONTR ), NULL, 1, 0) DealType," +
                  "        DVPos.T_CLIENT," +
                  "        ( SELECT SfContr.T_NUMBER FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVDeal.T_CLIENTCONTR ) SfContrNumber," +
                  "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) ClientName," +
                  "        DECODE( DvDeal.t_Type, 'E', DECODE( DVDeal.T_POSITION, 1, 'Короткие позиции', 'Длинные позиции' ), DECODE(DvDeal.t_Type, 'B', 'Короткие позиции','Длинные позиции') ) Position," +
                  "        DVDeal.T_AMOUNT," +
                  "        DVDeal.T_PRICE," +
                  "        ContrDV.T_TicKFIID T_PRICEFIID," +
                  "        ContrDV.T_STRIKE," +
                  "        ContrDV.T_STRIKEFIID," +
                  "        ContrDV.T_OPTIONTYPE, "+
                  "        ContrDV.T_OPTIONSTYLE, " +
                  "        0 T_EXECTYPE, "
                  "        DVDeal.T_STATE, " +
                  "        to_date('01.01.0001', 'DD.MM.YYYY') T_EXECDATE, " +
                  "        ( SELECT SpGround.T_XLD FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = 192 and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ) OrderNum, " +
                  "        0 IsOutMark, " +
                  "        0 IsOutMarkTable, " +
                  "        DVDeal.T_ID DealID, " +
                  "        0 DVKIND, " +
                  "        -1 as PayFIID " +
                  "   FROM ddvfipos_dbt DVPos, ddvdeal_dbt DVDeal, dfininstr_dbt ContrFI, " +
                  "        dfideriv_dbt ContrDV, dfininstr_dbt BaseFI1, dfininstr_dbt BaseFI2" +
                  "  WHERE ContrFI.T_FIID = DVDeal.T_FIID and " +
                  "        BaseFI1.T_FIID = ContrFI.T_FACEVALUEFI and " +
                  "        BaseFI2.T_FIID = DECODE(BaseFI1.T_FI_KIND, 4, BaseFI1.T_FACEVALUEFI,ContrFI.T_FACEVALUEFI) and " +
                  "        ContrDV.T_FIID = DVDeal.T_FIID and " +
                  "        DVPos.T_FIID = DVDeal.T_FIID and " +
                  "        DVPos.T_DEPARTMENT = DVDeal.T_DEPARTMENT and " +
                  "        DVPos.T_CLIENT = DVDeal.T_CLIENT and " +
                  "        DVPos.T_BROKER = DVDeal.T_BROKER " +
                  /*условия по датам*/                                  
                  "      and DVdeal.T_DATE >= " + GetSQLDate( Data.dateMin ) +
                  "      and DVdeal.T_DATE <= " + GetSQLDate( Data.dateMax ); 
      /*   Если надо уставливаем условие */
      if(  Data.DprtID and (Data.DprtID != UNDF )  )
          DVQuery = DVQuery + " and DVDeal.T_DEPARTMENT = " + String( Data.DprtID );
      end;
      /*   Если надо уставливаем условие на статус сделки*/
      if( Data.DealStatus != DVDEAL_UNDEF)
          DVQuery = DVQuery + " and DVDeal.T_STATE = " + String( Data.DealStatus );
      else
          DVQuery = DVQuery + " and DVDeal.T_STATE <> 0 ";
      end;
      /*   Если надо уставливаем условие на тип сделки*/
      if( Data.DealType == 0) 
          DVQuery = DVQuery + " and DVDeal.T_CLIENT <> -1";
      elif( Data.DealType == 1 )
            DVQuery = DVQuery + " and DVDeal.T_CLIENT = -1";
      end;
      /*   Если надо уставливаем условие по клиенту*/
      if( Data.ClientID and ( Data.ClientID != UNDF ) )
          DVQuery = DVQuery + " and DVDeal.T_CLIENT = " + String( Data.ClientID );
      end;
      /*   Если надо уставливаем условие типу ПИ*/
      if( Data.DVFIKindID and ( Data.DVFIKindID != UNDF ) )
          DVQuery = DVQuery + " and ContrFI.T_AVOIRKIND = " + String( Data.DVFIKindID );
      end;
      /*   Если надо уставливаем условие по ПИ*/
      if( Data.DVFIID and ( Data.DVFIID != UNDF ) )
          DVQuery = DVQuery + " and DVDeal.T_FIID = " + String( Data.DVFIID );
      end;
      /*   Если надо уставливаем условие по эмитенту*/
      if( Data.EmiID and ( Data.EmiID != UNDF ) )
          DVQuery = DVQuery + " and ContrFI.T_ISSUER = " + String( Data.EmiID );
      end;
      /*   Устанавливаем фильтр по контрактору */
      if( Data.ContractorID and ( Data.ContractorID != UNDF ) )
          DVQuery = DVQuery + " and (case when DVPos.T_BROKER > 0 then DVPos.T_BROKER else ContrFI.T_ISSUER end) = " + String( Data.ContractorID );
      end;
      /*   Если надо уставливаем условие типу базового актива*/
      if( Data.BaseFIKind and (Data.BaseFIKind != UNDF ) )
          DVQuery = DVQuery + " and BaseFI2.T_FI_KIND = " + String( Data.BaseFIKind );
      end;
      /*   Если надо уставливаем условие базому активу*/
      if( Data.BaseFIID and (Data.BaseFIID != UNDF ) )
          DVQuery = DVQuery + " and DECODE(BaseFI1.T_FI_KIND, 4, BaseFI1.T_FACEVALUEFI, ContrFI.T_FACEVALUEFI) = " + String( Data.BaseFIID );
      end;
   end;

   /* Биржевые или внебиржевые Т+3*/
   private macro GetSQLIsMarketT3(IsMarket)
      var flag = IIF(IsMarket, "", " not ");

      return 
         " and (case when ((DVDeal.t_DVKind = "+DV_FORWARD_T3+") and ("+flag+" EXISTS ( SELECT * " +
         "                                                                        FROM DPARTYOWN_DBT " +
         "                                                                       WHERE T_PARTYID   = DVDeal.t_Contractor " +
         "                                                                         AND T_PARTYKIND = " + PTK_MARKETPLASE +
         "                                                                    ) " +
         "                                                           ) ) then 0 else 1 end) = 0 ";
   end;

   macro ПолучитьВнеБиржевыеСделки()
     DVQuery = DVQuery +
                 " SELECT 0 as ModuleType, " +
                 "        DVDeal.T_DATE," +         
                 "        DVDeal.T_TIME," +
                 "        -1 T_FIID," +
                 "        DVDeal.T_DEPARTMENT," +
                 "        DVDeal.T_TYPE T_KIND," +/*для внебиржевых по типу определяем, покупка?продажа*/
                 "        DVDeal.T_CODE," +
                 "        NVL(( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds WHERE AvrKinds.T_FI_KIND = "+FIKIND_DERIVATIVE+
                 "                 and AvrKinds.T_AVOIRKIND = "
                 "                    ( "
                 "                     CASE "
                 "                        WHEN (    (DVDeal.t_DVKind = " + DV_FORWARD_T3 + ") "
                 "                              AND (NOT EXISTS  " // Сделка считается внебиржевой, если контрагент по сделке не равен бирже
                 "                                      (SELECT * "
                 "                                         FROM DPARTYOWN_DBT "
                 "                                        WHERE     T_PARTYID = DVDeal.t_Contractor "
                 "                                              AND T_PARTYKIND = " + PTK_MARKETPLASE + "))) "
                 "                        THEN "
                 "                           DECODE (DVDeal.T_DVKIND,  5, 3,  1, 1,  2) " // для внебиржевых сделок Т+3
                 "                        ELSE "
                 "                           DECODE (DVDeal.T_DVKIND,  1, 3,  5, 1,  2) " 
                 "                     END "
                 "                    ) "
                 "           ),'') DVFIKind," +
                 "        DECODE(fin.T_FI_KIND,"+FIKIND_AVOIRISS+","+
                 "               (select avr.t_Name from davrkinds_dbt avr where avr.t_fi_kind = fin.t_fi_kind "+
                 "                and avr.t_avoirkind = RSB_FIInstr.FI_AvrKindsGetRoot(fin.t_fi_kind,fin.t_avoirkind) ),"+
                 "               'Индекс')||' '||fin.T_FI_CODE||' '||" +
                 "        to_char(nfi.T_SuplDate,'DD.MM.YY') as T_FI_CODE," +
                 "        case when ((DVDeal.t_DVKind = " + DV_FORWARD_T3 + ") and ( EXISTS ( SELECT * " +
                 "                                                                              FROM DPARTYOWN_DBT " +
                 "                                                                             WHERE T_PARTYID   = DVDeal.t_Contractor " +
                 "                                                                               AND T_PARTYKIND = " + PTK_MARKETPLASE +
                 "                                                                          ) " +
                 "                                                                 ) ) then (SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.t_Contractor) else 'вне биржи' end IssuerName," +
                 "        DECODE( ( SELECT SfContr.T_SERVKIND FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVDeal.T_CLIENTCONTR ), NULL, 1, 0 ) DealType," +
                 "        DVDeal.T_CLIENT, " +
                 "        ( SELECT SfContr.T_NUMBER FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = DVDeal.T_CLIENTCONTR ) SfContrNumber," +
                 "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = DVDeal.T_CLIENT ) ClientName," +
                 "        '' Position," +
                 "        nfi.T_CONTRAMOUNT T_AMOUNT," +
                 "        case when DVDeal.T_DVKIND = 2 then DVDeal.T_BONUSPRICE else (nfi.T_PRICE*nfi.T_Amount) end T_PRICE," +/*для опциона - премию, для форварда - цену*/ 
                 "        case when DVDeal.T_DVKIND = 2 then DVDeal.T_BONUSFIID else nfi.T_PriceFIID end T_PRICEFIID," + 
                 "        case when DVDeal.T_DVKIND = 2 then nfi.T_Price*nfi.T_Amount else 0 end T_STRIKE, " +/*для опциона*/
                 "        case when DVDeal.T_DVKIND = 2 then nfi.T_PriceFIID else 0 end T_STRIKEFIID, " +/*для опциона*/
                 "        DVDeal.T_OPTIONTYPE, "+
                 "        DVDeal.T_OPTIONSTYLE, " +
                 "        DECODE(DVDeal.T_DVKIND, 2, nfi.T_EXECTYPE, -1) T_EXECTYPE, " +
                 "        DVDeal.T_STATE, " +
                 "        NVL((SELECT step.t_Plan_Date " +
                 "              FROM doprstep_dbt step, doproper_dbt oper " +
                 "             WHERE oper.t_DocKind      in( " + DL_DVNDEAL + ", " + DL_DVDEALT3 + " ) "
                 "               AND oper.t_DocumentID   = lpad(DVDeal.t_ID, 34, '0') " +
                 "               AND step.t_ID_Operation = oper.t_ID_Operation " +
                 "               AND step.t_Kind_Action  in("+DV_KINDACTION_EXDELCB+","+DV_KINDACTION_EXDELCUR+","+DV_KINDACTION_EXNOTDELCB+") " +
                 "               AND step.t_IsExecute    = 'X' " +
                 "               AND ROWNUM = 1 ), nfi2.t_ExecDate ) t_ExecDate, " +
                 "        ( SELECT SpGround.T_XLD FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND IN (" + DL_DVNDEAL + "," + DL_DVDEALT3 + ") and SpGrDoc.T_SOURCEDOCID = DVDeal.T_ID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ) OrderNum, " +
                 "        case when ((DVDeal.t_DVKind = " + DV_FORWARD_T3 + ") and ( EXISTS ( SELECT * " +
                 "                                                                              FROM DPARTYOWN_DBT " +
                 "                                                                             WHERE T_PARTYID   = DVDeal.t_Contractor " +
                 "                                                                               AND T_PARTYKIND = " + PTK_MARKETPLASE +
                 "                                                                          ) " +
                 "                                                                 ) ) then 0 else 1 end IsOutMark," +
                 "        1 IsOutMarkTable, " +
                 "        DVDeal.T_ID DealID, " +
                 "        DVDeal.t_DVKind DVKIND, " +
                 "        -1 as PayFIID " +
                 "   FROM ddvndeal_dbt DVDeal, dfininstr_dbt fin, ddvnfi_dbt nfi, ddvnfi_dbt nfi2 " +
                 "  WHERE nfi.T_DealID = DVDeal.T_ID " +
                 "    and nfi.T_TYPE = case when DVDeal.T_FORVARD = 'X' then 1 else 0 end " +/*актив по форварду или по сделке*/
                 "    and nfi2.T_DealID = DVDeal.T_ID " +
                 "    and nfi2.T_TYPE = 0 " +/*актив по сделке*/
                 "    and fin.t_fiid = nfi.T_fiid " +/*здесь берем базовый актив*/
                 "    and DVDeal.T_IsTrust = chr(0) " +
                 /*условия по датам*/
                 "    and DVdeal.T_DATE >= " + GetSQLDate( Data.dateMin ) +
                 "    and DVdeal.T_DATE <= " + GetSQLDate( Data.dateMax ); 
     /*   Если надо уставливаем условие */
     if(  Data.DprtID and (Data.DprtID != UNDF )  )
         DVQuery = DVQuery + " and DVDeal.T_DEPARTMENT = " + String( Data.DprtID );
     end;
     /*   Если надо уставливаем условие на статус сделки*/
     if( Data.DealStatus != DVDEAL_UNDEF)
         DVQuery = DVQuery + " and DVDeal.T_STATE = " + String( Data.DealStatus );
     else
         DVQuery = DVQuery + " and DVDeal.T_STATE <> 0 ";
     end;
     /*   Если надо уставливаем условие на тип сделки*/
     if( Data.DealType == 0) 
         DVQuery = DVQuery + " and DVDeal.T_CLIENT <> -1";
     elif( Data.DealType == 1 )
         DVQuery = DVQuery + " and DVDeal.T_CLIENT = -1";
     end;
     /*   Если надо уставливаем условие по клиенту*/
     if( Data.ClientID and ( Data.ClientID != UNDF ) )
         DVQuery = DVQuery + " and DVDeal.T_CLIENT = " + String( Data.ClientID );
     end;
     /*   Если надо уставливаем условие типу ПИ*/
     if( Data.DVFIKindID and ( Data.DVFIKindID != UNDF ) )
         /*из панели: 1 - Фьючерс, 2 - Опцион, 3 - Форвард*/
         if( Data.DVFIKindID == 1 )
            DVQuery = DVQuery + " and DVDeal.T_DVKIND = " + DV_FORWARD_T3;
            DVQuery = DVQuery + GetSQLIsMarketT3(true);
         elif( Data.DVFIKindID == 2 )
            DVQuery = DVQuery + " and DVDeal.T_DVKIND = " + DV_OPTION;
         elif( Data.DVFIKindID == 3 )
            DVQuery = DVQuery + " and DVDeal.T_DVKIND IN (" + DV_FORWARD + "," + DV_FORWARD_T3 + ")";
            DVQuery = DVQuery + GetSQLIsMarketT3(false);
         end;
     else
        DVQuery = DVQuery + " and DVDeal.T_DVKIND in( " + DV_FORWARD + ", " + DV_FORWARD_T3 + ", " + DV_OPTION + " ) ";
     end;
     /*   Если надо уставливаем условие по ПИ*/      
     if( Data.DVFIID and ( Data.DVFIID != UNDF ) )/*только для стандартного контракта (форвард или опцион), если задан.*/
         DVQuery = DVQuery + " and DVDeal.T_FORVARD = chr(0) and nfi.T_StdFIID = " + String( Data.DVFIID );
     end;

     /*   Если надо уставливаем условие типу базового актива*/
     if( Data.BaseFIKind and (Data.BaseFIKind != UNDF ) )
        DVQuery = DVQuery + " and fin.T_FI_KIND = " + String( Data.BaseFIKind );
     else/*"ценная бумага" или "индекс"*/
        DVQuery = DVQuery + " and fin.T_FI_KIND in ("+FIKIND_AVOIRISS+","+FIKIND_INDEX+")";
     end;
     
      /*   Если надо уставливаем условие базому активу*/
     if( Data.BaseFIID and (Data.BaseFIID != UNDF ) )
         DVQuery = DVQuery + " and nfi.T_FIID = " + String( Data.BaseFIID );
     end;

     /* Биржевые/Внебиржевые/Все Т+3*/
     if( not (Data.IsOutMarket and Data.IsMarket) ) // если взведен только один флаг
        DVQuery = DVQuery + GetSQLIsMarketT3(Data.IsMarket);
     end;
   end;

   macro ПолучитьСделкиУВ()
     DVQuery = DVQuery + " SELECT 1 as ModuleType, "
                       + "        tick.t_DealDate as t_Date, "
                       + "        tick.t_DealTime as t_Time, "
                       + "        -1 as t_FIID, "
                       + "        tick.t_Department, "
                       + "        tick.t_DealType as t_Kind, "
                       + "        tick.t_DealCode as t_Code, "
                       + "        NVL(( SELECT AvrKinds.T_NAME FROM davrkinds_dbt AvrKinds "
                       + "               WHERE AvrKinds.T_FI_KIND = "+FIKIND_DERIVATIVE
                       + "                 and AvrKinds.T_AVOIRKIND = "+DERIVATIVE_FORWARD+"),'') DVFIKind, " 
                       + "        (case when NOT EXISTS "
                       + "                       (SELECT 1 "
                       + "                          FROM dvsordlnk_dbt lnk, dvsbanner_dbt bnr "
                       + "                         WHERE lnk.t_DocKind = tick.t_BOfficeKind "
                       + "                               AND lnk.t_ContractID = tick.t_DealID "
                       + "                               AND bnr.t_BCID = lnk.t_BCID "
                       + "                               AND EXISTS "
                       + "                                      (SELECT DISTINCT lnk1.t_BCCFI "
                       + "                                         FROM dvsordlnk_dbt lnk1, dvsbanner_dbt bnr1 "
                       + "                                        WHERE lnk1.t_DocKind = lnk.t_DocKind "
                       + "                                              AND lnk1.t_ContractID = lnk.t_ContractID "
                       + "                                              AND lnk1.t_BCID <> lnk.t_BCID "
                       + "                                              AND lnk1.t_LinkKind = lnk.t_LinkKind "
                       + "                                              AND bnr1.t_BCID = lnk1.t_BCID "
                       + "                                              AND bnr1.t_Issuer <> bnr.t_Issuer)) "
                       + "              then  ('вексель '||(select pt.t_ShortName "
                       + "                        from dvsordlnk_dbt lnk, dvsbanner_dbt bnr, dparty_dbt pt "
                       + "                       where lnk.t_ContractID = tick.t_DealID "
                       + "                         and lnk.t_DocKind = tick.t_BOfficeKind "
                       + "                         and bnr.t_BCID = lnk.t_BCID "
                       + "                         and pt.t_PartyID = bnr.t_Issuer "
                       + "                         and rownum = 1"
                       + "                     )) "
                       + "              else CHR(1) end) as T_FI_CODE, "
                       + "        'вне биржи' as IssuerName, "
                       + "        tick.t_DealType as DealType, "
                       + "        tick.t_ClientID as t_Client, "
                       + "        ( SELECT SfContr.T_NUMBER FROM dsfcontr_dbt SfContr WHERE SfContr.T_ID = tick.T_CLIENTCONTRID ) SfContrNumber," 
                       + "        ( SELECT Party.T_SHORTNAME FROM dparty_dbt Party WHERE Party.T_PARTYID = tick.T_CLIENTID ) ClientName," 
                       + "        CHR(1) as Position, "
                       + "        (select count(1) from dvsordlnk_dbt lnk where lnk.t_ContractID = tick.t_DealID and lnk.t_DocKind = tick.t_BOfficeKind) as t_Amount, "
                       + "        leg.t_Cost as t_Price, "
                       + "        (case when NOT EXISTS "
                       + "                       (SELECT 1 "
                       + "                          FROM dvsordlnk_dbt lnk "
                       + "                         WHERE lnk.t_DocKind = tick.t_BOfficeKind "
                       + "                               AND lnk.t_ContractID = tick.t_DealID "
                       + "                               AND EXISTS "
                       + "                                      (SELECT DISTINCT lnk1.t_BCCFI "
                       + "                                         FROM dvsordlnk_dbt lnk1 "
                       + "                                        WHERE lnk1.t_DocKind = lnk.t_DocKind "
                       + "                                              AND lnk1.t_ContractID = lnk.t_ContractID "
                       + "                                              AND lnk1.t_BCID <> lnk.t_BCID "
                       + "                                              AND lnk1.t_LinkKind = lnk.t_LinkKind "
                       + "                                              AND lnk1.t_BCCFI <> lnk.t_BCCFI)) "
                       + "              then (select lnk.t_BCCFI from dvsordlnk_dbt lnk where lnk.t_ContractID = tick.t_DealID and lnk.t_DocKind = tick.t_BOfficeKind and rownum = 1) "
                       + "              else -1 end) as t_PriceFIID,"
                       + "        0 as t_Strike, "
                       + "        -1 as t_StrikeFIID, "
                       + "        0 as t_OptionType, "
                       + "        0 as t_OptionStyle, "
                       + "        -1 as t_ExecType, "
                       + "        tick.t_DealStatus as t_State, "
                       + "        TO_DATE('01.01.0001','DD.MM.YYYY') as t_ExecDate, "
                       + "        NVL((SELECT SpGround.T_XLD FROM dspgrdoc_dbt SpGrDoc, dspground_dbt SpGround WHERE SpGrDoc.T_SOURCEDOCKIND = "+DL_VEKSELACCOUNTED+" and SpGrDoc.T_SOURCEDOCID = tick.t_DealID and SpGround.T_SPGROUNDID = SpGrDoc.T_SPGROUNDID and SpGround.T_KIND = 251 AND ROWNUM = 1 ), CHR(1)) OrderNum, " 
                       + "        1 as IsOutMark, "
                       + "        1 as IsOutMarkTable, " 
                       + "        tick.t_DealID as DealID, "
                       + "        0 as DVKIND, " 
                       + "        leg.t_PayFIID as PayFIID "

                       + "   FROM ddl_tick_dbt tick, ddl_leg_dbt leg "
                       + "  WHERE tick.t_BOfficeKind = " + DL_VEKSELACCOUNTED
                       + "    AND tick.t_DealDate >= " + GetSQLDate( Data.dateMin )
                       + "    AND tick.t_DealDate <= " + GetSQLDate( Data.dateMax )
                       + "    AND tick.t_AvoirKind = " + AVOIRISSKIND_BILL
                       + "    AND tick.t_DealStatus > " + DL_PREPARING
                       + "    AND Exists(select 1 "
                       + "                 from dobjatcor_dbt atc "
                       + "                where atc.t_ObjectType = " + OBJTYPE_VEKSELACCOUNTED
                       + "                  and atc.t_Object = LPAD(tick.t_DealID, 34, '0') "
                       + "                  and atc.t_GroupID = 23 "  //"Исполнение поставочных срочных контрактов"
                       + "                  and atc.t_ValidFromDate <= tick.t_DealDate " 
                       + "                  and atc.t_ValidToDate >= tick.t_DealDate "  
                       + "                  and atc.t_AttrID = 1" //Да
                       + "              ) "
                       + "   AND leg.t_DealID = tick.t_DealID "
                       + "   AND leg.t_LegID = 0 "
                       + "   AND leg.t_LegKind = " + LEG_KIND_DL_TICK;


     if(Data.DprtID and (Data.DprtID != UNDF )  )
       DVQuery = DVQuery + " and tick.t_Department = " + Data.DprtID;
     end;

     if( Data.DealStatus != DVDEAL_UNDEF)
       if(Data.DealStatus == DVDEAL_OPEN)
         DVQuery = DVQuery + " and tick.t_DealStatus = " + DL_READIED;
       elif(Data.DealStatus == DVDEAL_CLOSE)
         DVQuery = DVQuery + " and tick.t_DealStatus = " + DL_CLOSED;
       end;
     end;

     if( Data.DealType == 0) 
         DVQuery = DVQuery + " and tick.T_CLIENTID <> -1";
     elif( Data.DealType == 1 )
         DVQuery = DVQuery + " and tick.T_CLIENTID = -1";
     end;

     if( Data.AvrIssuerID and ( Data.AvrIssuerID != UNDF ) )
       DVQuery = DVQuery + " and Exists(select 1"
                         + "              from dvsordlnk_dbt lnk, dvsbanner_dbt bnr  "
                         + "             where lnk.t_ContractID = tick.t_DealID "
                         + "               and lnk.t_DocKind = tick.t_BOfficeKind "
                         + "               and bnr.t_BCID = lnk.t_BCID "
                         + "               and bnr.t_Issuer = " + Data.AvrIssuerID   
                         + "           ) ";
     end;


   end;

   var NRec = 0, NrecData;

   DVQuery = "";

   if(Data.ByDV)
     if( Data.IsMarket )
        ПолучитьБиржевыеСделки();
     end;

	 if( Data.IsOutMarket or Data.IsMarket ) /*во внебиржевых таблицах живут биржевые сделки Т+3*/
        if( DVQuery != "" )
           DVQuery = DVQuery + " union all ";
        end;
        ПолучитьВнеБиржевыеСделки();
     end;
   end;

   if(Data.ByVA)
     if( DVQuery != "" )
        DVQuery = DVQuery + " union all ";
     end;
     ПолучитьСделкиУВ();
   end;

   /* Уставливаем Нужную сортировку для последующего вывода*/
   if( Data.DprtID and (Data.DprtID == UNDF ) )
       if(Data.IsSeparatelyDate == true)
          DVQuery = DVQuery + " ORDER BY T_DEPARTMENT, T_DATE, T_TIME, IsOutMark, DealType, T_CLIENT ";
       else
       DVQuery = DVQuery + " ORDER BY T_DEPARTMENT, IsOutMark, DealType, T_CLIENT, T_DATE, T_TIME";
       end;
       IsDprtSort = true;
   else
       if(Data.IsSeparatelyDate == true)
          DVQuery = DVQuery + " ORDER BY T_DATE, T_TIME, IsOutMark, DealType, T_CLIENT ";
       else
       DVQuery = DVQuery + " ORDER BY IsOutMark, DealType, T_CLIENT, T_DATE, T_TIME";
       end;
       IsDprtSort = false;
   end;

   RsdDVQuery = RSdCommand(DVQuery);
   RsdDVQuery.execute();
                                                                                                                   
   File_DVDeal = TRsbDataSet( RsdDVQuery );

   NrecData  = TRsbDataSet( "select count(1) NRec from ("+DVQuery+")" );

   if( NrecData.MoveNext() )
      NRec = int(NrecData.NRec);
   end;

   return NRec;
end;

macro ПечатьБиржевогоОтчета(Data)
  var spground = TRecHandler( "spground.dbt" );
  var IsOurDeals = false;                    /*печатаются ли Собственные сделки*/
  var IsHeadDeals = false;                   /*Голова сделок*/
  var IsBeginReport = true;                  /*начало отчета*/
  var IsBrokerDeals = false;                 /*печатаются ли Брокерские сделки*/
  var IsNewDprt = true, OldDprt = 0;         /*новый ли филиал*/
  var IsNewDealType = true, OldDealType = 0; /*новый ли Тип сделок*/
  var IsNotEof;                              /*конец выборки*/
  var KindOper = "";  
  var FI = ПроизводныйИнструмент();
  var IsDate = true;
  var OldDate = Date(0,0,0);
  var PrintFooter = false;
  var DprtName = "";
  var IsOutMark = -1, FI_Code = "", StrikeFI = "", PriceFIID = "", Price = $0.;
  var OutMarketEx = "", RejDate = Date(0,0,0), SpgrNum = "", SpgrKind = "", SpgrDate = Date(0,0,0);
  var DealTime, PayFIID;
  var opr = TBFile("oprkoper.dbt");

   while( File_DVDeal.MoveNext() )

      if( IsDprtSort )
         /*Если новый филиал взводим-сбрасываем флаги*/
         if( ( not IsNewDprt ) and ( OldDprt != File_DVDeal.Department ) )
             IsNewDprt = true;
             IsOutMark = -1;
             IsOurDeals = false;
             IsBrokerDeals = false;
         end; 
         /*Если новый филиал печатаем соотвествующие заголовки*/
         if( IsNewDprt )
             DprtName = "";
             CB_GetDepartmentCodeAndName( int(File_DVDeal.DEPARTMENT), null, DprtName );
             PrintReportSubHead( DprtName );
             if( IsBeginReport )
                 IsBeginReport = false;
             end;
             OldDprt = File_DVDeal.Department;
             IsNewDprt = false;
             OldDate = Date(0,0,0);
         end; 
      else
         if(IsNewDprt)
            DprtName = "";
            CB_GetDepartmentCodeAndName( int(File_DVDeal.DEPARTMENT), null, DprtName );
            PrintReportSubHead( DprtName );
            IsNewDprt = false;
         end;
      end;

      if( (Data.IsSeparatelyDate == true) and (OldDate != SQL_ConvTypeDate(File_DVDeal.Date)) )
         if( PrintFooter == true )
            after_44_footer( Rep );
         end;
         PrintReportHead( Data,SQL_ConvTypeDate(File_DVDeal.Date) );
         PrintDealKindHead( File_DVDeal.IsOutMark );
         IsOutMark = File_DVDeal.IsOutMark;
         OldDate = SQL_ConvTypeDate(File_DVDeal.Date);
         IsOurDeals = false;                   
         IsHeadDeals = false;                  
         IsBeginReport = true;                 
         IsBrokerDeals = false;                
         IsNewDealType = true; OldDealType = 0;
         PrintFooter = true;
      end;

      if( IsOutMark != File_DVDeal.IsOutMark )
         PrintDealKindHead( File_DVDeal.IsOutMark );
         IsOutMark = File_DVDeal.IsOutMark;
         IsOurDeals = false;                   
         IsBrokerDeals = false;                
      end;

      /*печатаем голову Собственных сделок*/
      if( not IsOurDeals and not File_DVDeal.ClientName )
          IsOurDeals = true;
          IsHeadDeals = true;
          PrintSubHeadTable( 1 );
      end;
      /*печатаем голову Брокерских сделок*/
      if( not IsBrokerDeals and File_DVDeal.ClientName)
          IsBrokerDeals = true;
          IsHeadDeals = true;
          PrintSubHeadTable( 0 );
      end;

      spground.Clear();
      SpgrNum = "";
      SpgrKind = "";
      SpgrDate = Date(0,0,0);
      Price = $0.;

      if(File_DVDeal.ModuleType == 0) //по данным ПИ
        
        DealTime = Time(File_DVDeal.Time);
        
        if( File_DVDeal.IsOutMarkTable )/*внебиржевые*/
          if( File_DVDeal.Kind == 1 )
             KindOper = "Покупка";
          else
             KindOper = "Продажа";
          end;
          FI_Code = File_DVDeal.FI_CODE+" "+OptionEXECTYPE(File_DVDeal.EXECTYPE)+" "+OptionStyle(File_DVDeal.OPTIONSTYLE);

          /*выводится или договор купли\продажи или распорядительная расписка*/
          if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, /*IIF((File_DVDeal.DVKind == DV_FORWARD_T3) or (File_DVDeal.DVKind == DV_CURSWAP_T3), DL_DVDEALT3, DL_DVNDEAL)*/DL_DVNDEAL, 26, File_DVDeal.Date ) )
             SpgrKind = "договор";
             SpgrDate = spground.rec.REGISTRDATE;
             SpgrNum  = spground.rec.XLD;
          elif( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, /*IIF((File_DVDeal.DVKind == DV_FORWARD_T3) or (File_DVDeal.DVKind == DV_CURSWAP_T3), DL_DVDEALT3, DL_DVNDEAL)*/DL_DVNDEAL, 27 ) )
             SpgrKind = "расп.зап";
             SpgrDate = spground.rec.REGISTRDATE;
             SpgrNum  = spground.rec.XLD;
          end;

          /*выводится инфа об отказе или исполнении (что-то одно из двух)*/
          OutMarketEx = "";
          if( File_DVDeal.IsOutMark )
           if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, /*IIF((File_DVDeal.DVKind == DV_FORWARD_T3) or (File_DVDeal.DVKind == DV_CURSWAP_T3), DL_DVDEALT3, DL_DVNDEAL)*/DL_DVNDEAL, 324 ) )
               OutMarketEx = "отк. " + date_as_string( 1, spground.rec.REGISTRDATE );
            end;
                                           
            if( (OutMarketEx == "") AND (File_DVDeal.State == DVDEAL_CLOSE) and (SQL_ConvTypeDate(File_DVDeal.ExecDate) != date(0,0,0)) )
               OutMarketEx = "исп. " + date_as_string( 1, SQL_ConvTypeDate(File_DVDeal.ExecDate) );
            end;
          end;

          Price = File_DVDeal.Price;
        else/*биржевые*/
          FI.Init( File_DVDeal.FIID );
          KindOper = GetKindOper( File_DVDeal.Kind );
          if(KindOper == "Исполнение")
            KindOper = KindOper + "\n" + File_DVDeal.Position;
          end;
          FI_Code = File_DVDeal.FI_CODE;                          
          /*выводится вид документа отчет*/
          if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, DL_DVDEAL, 25 ) )
             SpgrKind = "отчет";
             SpgrDate = spground.rec.REGISTRDATE;
             SpgrNum  = spground.rec.XLD;
          end;
          Price = File_DVDeal.Price * File_DVDeal.Amount;
        end;
                                                      
        if( File_DVDeal.STRIKEFIID == -10 )
           StrikeFI = "Пункт(ов)";
        elif( File_DVDeal.Strike > $0. )
           StrikeFI = GetCCY(File_DVDeal.STRIKEFIID);
        else
           StrikeFI = "";
        end;

        if( File_DVDeal.PriceFIID == -10 )
           PriceFIID = "Пункт(ов)";
        elif( File_DVDeal.Price > $0. )
           PriceFIID = GetCCY(File_DVDeal.PriceFIID);
        else
           PriceFIID = "";
        end;

        PayFIID = PriceFIID;
      elif(File_DVDeal.ModuleType == 1) //по данным УВ

        DealTime = "";

        opr.rec.Kind_Operation = File_DVDeal.Kind;
        if(opr.GetEQ())
          KindOper = opr.rec.Name;
        end;

        FI_Code = File_DVDeal.FI_CODE;

        Price = File_DVDeal.Price;
        
        if(File_DVDeal.PriceFIID == -1)
          PriceFIID = "";
        else
          PriceFIID = GetCCY(File_DVDeal.PriceFIID);
        end;
        
        if(File_DVDeal.PayFIID == -1)
          PayFIID = "";
        else
          PayFIID = GetCCY(File_DVDeal.PayFIID);
        end;
        
        /*выводится или договор купли\продажи или распорядительная расписка*/
        if( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, DL_VEKSELACCOUNTED, 26, File_DVDeal.Date ) )
           SpgrKind = "договор";
           SpgrDate = spground.rec.REGISTRDATE;
           SpgrNum  = spground.rec.XLD;
        elif( GetDV_MaxGroundByDeal( spground, File_DVDeal.DealID, DL_VEKSELACCOUNTED, 27 ) )
           SpgrKind = "расп.зап";
           SpgrDate = spground.rec.REGISTRDATE;
           SpgrNum  = spground.rec.XLD;
        end;

      end;

      PrintStr( Data,
                File_DVDeal.Code,
                SQL_ConvTypeDate(File_DVDeal.Date), DealTime,
                File_DVDeal.IssuerName,
                KindOper,
                File_DVDeal.ClientName,
                File_DVDeal.OrderNum,
                File_DVDeal.SfContrNumber,
                File_DVDeal.DVFIKind + "\n" + OptionType(File_DVDeal.OptionType),
                FI_Code,
                IIF(File_DVDeal.Strike>$0.,File_DVDeal.Strike,""),
                IIF(File_DVDeal.Strike>$0.,StrikeFI,""),
                Price,
                PriceFIID,
                File_DVDeal.Amount,
                PayFIID,
                OutMarketEx,
                SpgrKind,
                SpgrNum,
                SpgrDate
              );

   end;
end;

/*
Собственные сделки - сделки, где клиент/договор не указан, т.е. сделка совершается в интересах нашего банка;
брокерские сделки -указан клиент и договор, где подвид обслуживания - не доверительное управление;
доверительное управление -  указан клиент и договор, где подвид обслуживания - доверительное управление.
*/
MACRO ReportRun(  _DprtID:integer,
                  _ByDV:bool,
                  _ByVA:bool,
                  _BaseFIKind:integer,
                  _BaseFIID:integer,
                  _DVFIKindID:integer,
                  _EmiID:integer, 
                  _DVFIID:integer,
                  _AvrIssuerID:integer,
                  _DealType:integer, 
                  _ClientID:integer, 
                  _IsMarket:bool,
                  _ContractorID:integer,
                  _IsOutMarket:bool,
                  _dateMin:date, _dateMax:date,
                  _IsSeparatelyDate:bool,
                  _DealStatus:integer,
                  _IsApp:bool,
                  _IsExcel:bool )

   var IsNotEof;
   var Count = 0;

   var Data = SourceData(_DprtID, _ByDV, _ByVA, _BaseFIKind, _BaseFIID, _DVFIKindID, _EmiID, _DVFIID, _AvrIssuerID, _DealType, _ClientID, _IsMarket,
                         _ContractorID, _IsOutMarket, _dateMin, _dateMax, _IsSeparatelyDate, _DealStatus, _IsApp, _IsExcel );
   
   if( (Data.dateMin == Date(0,0,0)) and (Data.dateMax == Date(0,0,0)) )
     return;
   end;
   Dl_CallInsertStat( IIF( _IsExcel, DL_OUTREPORT_EXCEL, DL_OUTREPORT_STD ) );
   if( ((Data.IsMarket or Data.IsOutMarket) and (Data.ByDV)) or (Data.ByVA))
      if( ПолучитьСделки( Data ) != 0 )
         if(Data.IsSeparatelyDate == false)
            PrintReportHead( Data,null );
         end;
         ПечатьБиржевогоОтчета(Data);
         after_44_footer( Rep );
         if( Data.IsExcel )
            Rep.PrintWinRep();
            Rep.ShowWinRep();
         else
            Rep.PrintRep();
         end;
      else
         if ( not Data.IsExcel )
            ПечатьЗаголовка();
            PrintLn("\nНе найдено данных для формирования отчета.");
         else
            MsgBox( "Не найдено данных для формирования отчета.");
         end;
      end;
   end;
   
END;