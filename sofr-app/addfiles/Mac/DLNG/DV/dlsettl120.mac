/*
$Name:        dlsettl120.mac
$Module:      Ядро Securities
$Description: Операция "Расчеты с биржей", Шаг Возврат обеспечения в валюте на корсчет
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_carop.mac";

PRIVATE VAR Dl_ValueData = TRecHandler( "dl_value.dbt");

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )

  record comm( dl_comm );
  var    FD; 

  SetBuff( comm, FirstDoc );
  FD = DVFirstDocDLCOMM( comm );

  var СчетБиржа = TRecHandler("account"),
      PaymentObj:RsbPayment;

  if( FD.IsExistsAnalytics() )
     if( ( not FD.IsExistAccount("-Обеспечение", null, true, null, СчетБиржа, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) ) and /*PNV 532124 возврат обеспечения на 47403**/
      //if( (not FD.IsExistAccount("+Обеспечение", null, true, null, СчетБиржа, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID)) and
         (not FD.OpenAccount("+Обеспечение", null, false, null, СчетБиржа, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID))
       )
        MsgBox("Ошибка: не открыт счет категории \"+Обеспечение\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;
  else
  if( (not FD.IsExistAccount("+Биржа", null, true, null, СчетБиржа, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID)) and
      (not FD.OpenAccount("+Биржа", null, false, null, СчетБиржа, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID))
    )
     return 1;
  end;
  end;

  if( DVND_CreatePayment( FD, PM_PURP_REPAYMENT, FD.Kind, FD.ID,
                          Dl_ValueData.rec.Date,
                          Comm.PartyID, -1,
                          {ourbank}, {ourbank},
                          Dl_ValueData.rec.Sum, Dl_ValueData.rec.SumFIID,
                          //"Возврат средств в валюте на корсчет",
                          "/BNF/COLLATERAL FUNDS RETURN UNDER //ORDER FROM CLIENT OF " + Dl_ValueData.rec.Date + " SC 01356 T58 /6160005663 RUAGRUMM",
                          NULL, СчетБиржа,
                          comm.Division, NULL, NULL,
                          @PaymentObj
                        ) != 0 )
     return 1;
  end;

//  if( not((ПИ_ИнтегрРежимРаботы() and ПИ_ЭтоВнешнийВходящийПлатеж(PaymentObj))) )
     if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
        return 1;
     end;
   
     if( ПИ_ИсполнитьПлатеж(PaymentObj) )
        return 1;
     end;
//  end;

  if( FD.IsClient() and ПИ_ВестиВнутреннийУчет() and
      ((ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 1) or (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3))
    )
     if( not ПИ_ВУ_РасчетыВыводСКлирСчетаКлиента(FD, Doc, Dl_ValueData.rec.SumFIID) )
        return 1;
     end;
  end;

  return 0;
end;
