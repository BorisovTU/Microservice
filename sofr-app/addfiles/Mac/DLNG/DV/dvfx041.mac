/*
$Name:        dvfx041.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Переоценка т/о по поставке"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac","dvserv.mac", "dv_fun.mac", "dv_ground.mac", "dvservop.mac";

PRIVATE VAR rNDeal = TRecHandler( "dvndeal" );
PRIVATE VAR rDocKind;

PRIVATE MACRO SayError( StrErr:STRING, NumErr:INTEGER ):INTEGER
  if( NumErr == null )
     NumErr = 1;
  end;
  SvOpInsertError( rDocKind, rNDeal, NumErr, StrErr );

  return 1; /*выход по ошибке*/
END;

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )
       
  record tick(dvndeal);
  var InsOperPS = TRecHandler( "dvoperps" );
  var FD, FD2;
  var isBloomDeal = 0; /*PNV 504715*/
  var ДатаИсполненияШага =  {Curdate}; /*PNV 504715*/
  /*PNV*/
  /*if( SvOpDvOper.rec.ID <= 0 )
     MsgBox("Шаг \"Переоценка т/о по поставке\" должен выполняться только из соответствующей сервисной операции.");
     return 1;
  end;*/
  /*PNV*/

  SetBuff(tick, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, tick);
  copy( rNDeal, FDoc );
  rDocKind = DocKind;

  /*PNV 504715*/
  if (not GetMainObjAttr( null, OBJTYPE_FXOPER_DV, strLpad(string(FD.deal.rec.id), 34, "0"), 5, isBloomDeal))
    isBloomDeal = 0;
  end;
  /*PNV 505030*/
  /*if (isBloomDeal == 3)/*PNV не через bloomberg*/
      return 0;
  end;*/
/*PNV 505030*/

  if( SvOpDvOper.rec.ID > 0 )
      ДатаИсполненияШага = SvOpDvOper.rec.date;
  end;

  if (not СуществуетЛиРегистрПереоценки(FD))/*Первая переоценка если не существует регистров переоценки*/
      if ( ПИКО_ПровестиПереоценкуЧастиСделки(FD, doc, ДатаИсполненияШага, null, null, SvOpReportLineData) != 0 ) /*PNV 505030*/
           return 1;
      end; 
      if( FD.IsSWAP() )
          FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, tick, 2);
          if ( ПИКО_ПровестиПереоценкуЧастиСделки(FD2, doc, ДатаИсполненияШага, null, null, SvOpReportLineData) != 0 ) /*PNV 505030*/
               return 1;
          end;
      end;
 
  else /*PNV 504715*/
      if ( ПИКО_ПровестиКорректировкуПереоценкиЧастиСделки(FD, doc, SvOpDvOper, SvOpReportLineData) != 0 )
           return 1;
      end;
      
      if( FD.IsSWAP() )
          FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, tick, 2);
          if ( ПИКО_ПровестиКорректировкуПереоценкиЧастиСделки(FD2, doc, SvOpDvOper, SvOpReportLineData) != 0 )
               return 1;
          end;
      end;
  end;   /*PNV 504715*/

  /*PNV*/
  if( SvOpDvOper.rec.ID > 0 )
      InsOperPS.Clear();
      InsOperPS.rec.DocID = tick.id;
      if( OprInsertDVOPERPS( InsOperPS ) == false )
          return SayError( "Ошибка при вставке записи во временный файл операций." );
      end;

      /* Сохраняем данные для отчета. */
      DL_SaveDataForReport_XML(SvOpDvOper.rec.ID, SvOpDvOper.rec.DocKind, SvOpReportLineData, LOG_TYPE_DATA);
      SvOpReportLineData.Size = 0;
  end;/*PNV*/
  return 0;

OnError( RslErrObj )
  return SayError( RslErrObj.Module + " строка " + RslErrObj.Line + "|" + RslErrObj.Message, RslErrObj.Code );
END;
