/*
$Name:        dvsw200.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг: Исполнение без поставки
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  VAR    ДатаИсполненияШага, FD;

  SetBuff( ndeal, FDoc );

  FD = DVFirstDocNDeal(DocKind, ndeal);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;
  ДатаИсполненияШага = FD.ДатаИсполнения();

  if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
     if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  if( not FD.ВыполненУчетВариационнойМаржи( ДатаИсполненияШага ) )
     if( MsgBoxEx( "Не выполнен расчет вариационной маржи!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  if( (not FD.IsClient()) and (СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0) )
     return 1;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND(), DV_OPERSTATUS_DL_COMPLETE ) )
     MsgBox("Ошибка при установке статуса <Требования> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_LIABILITY(), DV_OPERSTATUS_DL_COMPLETE ) )
     MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
     return 1;
  end;

  var Дк = DL_GetMinComPlanDateByOper(DocKind, FD.Deal.rec.ID);

  if( Дк != date(0,0,0) )
     if( not InsertOprStatus(FD.DV_OPERSTATUS_COMISS(), DV_OPERSTATUS_PAYM_EX) )
        MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
        return 1;
     end;
     DL_CalendDefineOprDate(FD,DV_NDEAL_OPRDATE_COMISS, Дк);
  else
     if( not InsertOprStatus(FD.DV_OPERSTATUS_COMISS(), DV_OPERSTATUS_PAYM_NOTEX) )
        MsgBox("Ошибка при установке статуса <Оплата комиссий> по операции.");
        return 1;
     end;
  end;

  return 0;
end;
