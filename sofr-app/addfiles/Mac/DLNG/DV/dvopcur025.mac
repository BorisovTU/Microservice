/*
$Name:        dvopcur025.mac
$Module:      Производные инструменты
$Description: Расчеты по производным инструментам на валютном рынке/рынке СПФИ. Шаг "Перевод средств на клиринговый счет"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_carop.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record oper(dvoper);
  var Query, Data;

  SetBuff(oper, FDoc);

  var FD_Oper = DVFirstDocOper(DL_DVOPER, oper);

  Query = RSDCommand( " SELECT dlvalue.* " +
                      "   FROM ddl_value_dbt dlvalue " +
                      "  WHERE dlvalue.t_DocKind = ? " +
                      "    AND dlvalue.t_DocID   = ? " +
                      "    AND dlvalue.t_Kind    = ? " +
                      "    AND dlvalue.t_ID_Operation = 0 " +
                      "    AND dlvalue.t_ID_Step      = 0 "
                    );

  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, FD_Oper.Kind);
  Query.addParam("", RSDBP_IN, FD_Oper.ID);
  Query.addParam("", RSDBP_IN, ALG_DV_TYPE_CALC_ADD_CLEARING);
  Query.execute();
  Data = TRsbDataSet(Query);
  while( Data.MoveNext() )

     var OurAcc = TRecHandler("account"),
         PaymentObj:RsbPayment,
         DebProp = TRecHandler("pmprop.dbt"),
         FIID:integer = SQL_ConvTypeInteger(Data.SumFIID),
         Sum:money = SQL_ConvTypeInteger(Data.Sum);
/*
     if( not FD_Oper.IsExistAccount("Клиринговый счет", null, true, null, OurAcc, null, FD_Oper.DVOper.rec.Date, FIID) )
        MsgBox("Ошибка: ! не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(FIID));
        return 1;
     end;
*/

     if( not FD_Oper.OpenAccount( "Клиринговый счет", null, null, null, OurAcc, FD_Oper.DVOper.rec.Date, FIID ) )
        MsgBox("Ошибка: ! не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(FIID));
     end;



     if( DVND_CreatePayment( FD_Oper, PM_PURP_ORDER, FD_Oper.Kind, FD_Oper.ID,
                             FD_Oper.DVOper.rec.Date,
                             {ourbank}, {ourbank},
                             FD_Oper.GetContractorID(), -1,
                             Sum, FIID,
                             // ОснованиеПроводкиПИ(DV_GRNUM_TRANS_IN_CLIR),
                             ОснованиеПроводкиПИ(100),
                             OurAcc, NULL,
                             FD_Oper.DVOper.rec.Department, NULL, NULL,
                             @PaymentObj, NULL,
                             @DebProp
                           ) != 0 )
        return 1;
     end;

     if( not ПИ_ПроводкаПоПлатежу(FD_Oper, PaymentObj) )
        return 1;
     end;

     if( ПИ_ИсполнитьПлатеж(PaymentObj) )
        return 1;
     end;


/*
     if( FD_Oper.IsClient() )
        if( (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 1) or (ВУ_ПроводкиВводаВыводаДСНаОРЦБ() == 3) )
           if( not ПИ_ВУ_ПереводСредствНаКлирСчетКлиенту(FD_Oper, doc, FIID) )
              return 1;
           end;
        end;
     else
        if( FIID != NATCUR )
           FD_Oper.SetBankID(GetCorrID(DebProp.rec.CorSchem, FIID, FIKIND_CURRENCY));
        end;
        FD_Oper.SetParametr(MC_TYPE_PARAMETR_FIID, FIID);
        if( not ПроводкаПоКатегориямВнутреннегоУчета( 2,
                                                      FD_Oper,
                                                      doc,
                                                      FD_Oper.DVOper.rec.Date,
                                                      FIID,
                                                      Sum
                                                    )
          )
           return 1;
        end;
     end;
*/
  end;

  if( not InsertOprStatus(DV_OPCUR_OPERSTATUS_KIND_CLEARING, DV_OPCUR_OPERSTATUS_COMPLETE) )
     MsgBox("Ошибка при установке статуса <Перевод средств на клиринговый счёт> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(DV_OPCUR_OPERSTATUS_KIND_SUM_CARRY, DV_OPCUR_OPERSTATUS_RUN) )
     MsgBox("Ошибка при установке статуса <Сводные проводки> по операции.");
     return 1;
  end;

  return 0;
end;
