/*  
$Name:        dvswift.mac
$Module:      Производные инструменты
$Description: Печать сообщений SWIFT
*/
import "dv_categ.mac", "DvRepFun2.mac", "dldlngfun.mac", "commonutil.mac", dv_lib ,CommonInter;
import "wlgenmes.mac";

PRIVATE VAR settacc = TRecHandler("settacc.dbt");

//mda 19/02/2019 Определяем яв-ся ли контрагент банком
private macro ContrIsBank(pid):bool
  var sql;
  var que = "SELECT p.t_partyid as PID FROM dpartyown_dbt p WHERE p.t_partyid = ? AND p.t_partykind = 2";
  sql = DL_RSDCommand(que);
  sql.addParam( pid );
  var rs = sql.execute();
  if( rs.MoveNext() )
    if (rs.PID > 0)
      return true;
    else
      return false;
    end;
  end;
end;

private macro получитьКорСчет(BankId)
  var query, DataSet, cmd;
  var queryAcc, DataSetAcc, cmdAcc;
  query = "Select bank.t_Coracc Coracc From dbankdprt_dbt bank Where bank.t_PartyID = ?" ;
  cmd = DL_RSDCommand(query);
  cmd.AddParam(BankId);
  DataSet = cmd.Execute();

  if( DataSet.moveNext() )
    return DataSet.Coracc;
  end;
  return "";
end;

private macro DateToStrDDMMYYYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + DV_LZ(Year, 4);
end;

private macro DateToStrDDMMYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + InvertStr(SubStr(InvertStr(string(Year)), 1, 2));
end;

private macro DateToStrYYYYMMDD( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Year, 4) + DV_LZ(Month, 2) + DV_LZ(Day, 2);
end;

private macro DateToStrYYMMDD( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return InvertStr(SubStr(InvertStr(string(Year)), 1, 2)) + DV_LZ(Month, 2) + DV_LZ(Day, 2);
end;

private macro DateToStrYYMM( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return InvertStr(SubStr(InvertStr(string(Year)), 1, 2)) + DV_LZ(Month, 2);
end;

private macro GetField_22C( Code1:string, Code2:string, pDate:date ):string
  var RetVal:string = "";

  private macro RetStr( _Code1:string, _Code2:string, _pDate:date ):string
     return SubStr(_Code1, 1, 4) + SubStr(_Code1, 7, 2) + DateToStrYYMM(_pDate) + SubStr(_Code2, 1, 4) + SubStr(_Code2, 7, 2);
  end;

  if( Code1 < Code2 )
     RetVal = RetStr(Code1, Code2, pDate);
  else
     RetVal = RetStr(Code2, Code1, pDate);
  end;

  return RetVal;
end;

private macro GetQueryGenAgrISDA():string
  var query = "SELECT t.T_DATE_GENAGR,              "+
              "       dl.t_code Version,            "+
              "       ag.t_code Type                "+
              "  FROM DDL_GENAGR_DBT t,             "+
              "       DLLVALUES_DBT dl,             "+
              "       DIR_TYPEAGREEMENT_DBT ag      "+
              " WHERE t.t_genagrid = ?              "+ 
              "   AND dl.t_list = 4018              "+
              "   AND dl.t_element = t.t_version_gs "+
              "   AND ag.t_id = t.t_type_gs";
  return query;
end;

private macro GetField_77H( ID:integer ):string
  var sql = DL_RSDCommand(GetQueryGenAgrISDA());
  sql.addParam( ID );
  var Field = sql.execute();
  if( Field.MoveNext() )
     var str = Field.Type + "/" + DateToStrYYYYMMDD(Field.t_date_genagr) + "//" + Field.Version;
     return str;
  else
     return "OTHER";
  end;
end;

private macro GetQueryGenAgr():string
  var query = "SELECT t.T_CODE Code,   "+
              "       t.T_DATE_GENAGR  "+
              "  FROM DDL_GENAGR_DBT t "+
              " WHERE t.T_GENAGRID = ?";
  return query;
end;

private macro GetField_77D( ID:integer ):string
  var sql = DL_RSDCommand(GetQueryGenAgr());
  sql.addParam( ID );
  var Field = sql.execute();
  if( Field.MoveNext() )
     return DateToStrYYYYMMDD(Field.t_date_genagr) + "/" + Field.Code;
  else
     return "OTHER";
  end;
end;

private macro GetField_57D( ID, DOCKIND, BS ,buy):string
  var str,name,inn,kpp,sql;
  var query = "SELECT p.t_payer, p.t_receiver,p.t_payeraccount,p.t_receiveraccount "+
              "  FROM dpmpaym_dbt p           "+
              " WHERE p.t_documentid = ?      "+
              "   AND p.t_dockind = ?    "+
              "   AND p.t_purpose = ?";
  sql = DL_RSDCommand(query);
  sql.addParam( ID );
  sql.addParam( DOCKIND );
  sql.addParam( BS );
  var Pay = sql.execute();
  if( Pay.MoveNext() )
    if (buy)
      if ( not iFindBankClnt(Pay.t_payer,name,inn,kpp) )
        name ="";
        inn = "";
        kpp = "";
      end;
      if(DOCKIND == 4813)
        str = "\r\n/"+Pay.t_payeraccount+"\r\nBIC "+ПолучитьКодСубъекта(Pay.t_payer, PTCK_BIC)+"\r\n";
      else
        str = "\r\n /"+Pay.t_payeraccount+"\r\n K/S "+Pay.t_receiveraccount+"\r\n BIC "+ПолучитьКодСубъекта(Pay.t_payer, PTCK_BIC)+"\r\n INN "+inn;
      end;
    else
      if ( not iFindBankClnt(Pay.t_receiver,name,inn,kpp) )
        name ="";
        inn = "";
        kpp = "";
      end;
      if(DOCKIND == 4813)
        str = "\r\n/"+Pay.t_receiveraccount+"\r\nBIC "+ПолучитьКодСубъекта(Pay.t_receiver, PTCK_BIC)+"\r\n";
      else
        str = "\r\n /"+Pay.t_receiveraccount+"\r\n K/S "+Pay.t_payeraccount+"\r\n BIC "+ПолучитьКодСубъекта(Pay.t_receiver, PTCK_BIC)+"\r\n INN "+inn;
      end;
    end;
  end;
  return str;
end;
//mda 20.02.2019 Пока отдельно для 305 , потом сделать общую и совместить!
private macro GetField_57D_305( FD ):string
  record Account(account);
  const NOACC:string = "ACC YOUR INSTRUCTIONS";
  const SYMB_END:string = "\r\n";
  var PaymentID:integer = 0,RecAcc:string = "";
  var Платеж:RsbPayment;
  var MTStr:string = "";

  if (FD.deal.rec.Netting == SET_CHAR)
    MTStr = "NETTING";
    return MTStr;
  end;

  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, PRi/*6 - премия*/, 0, FD.deal.rec.bonusdate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж = RsbPayment(PaymentID);
  end;

  if (Платеж)
    if (FD.IsBuy())
      /*Тут мы премию платим*/
      MTStr = "/" + IIF(strlen(Платеж.ReceiverAccount) > 1,Платеж.ReceiverAccount,NOACC) + SYMB_END;
      if (strlen(Платеж.ReceiverBankCode) > 1)
        MTStr = MTStr + "BIC " + Платеж.ReceiverBankCode + SYMB_END;
      end; 
      if (strlen(Платеж.ReceiverCorrAccNostro) > 1)
        MTStr = MTStr + "CA " + Платеж.ReceiverCorrAccNostro + SYMB_END; 
      end;
      if (strlen(Платеж.ReceiverINN) > 1)
        MTStr = MTStr + "INN " + IIF(strlen(Платеж.ReceiverINN) > 10,SubStr(Платеж.ReceiverINN,1,10),Платеж.ReceiverINN) ;
      end;

    else
      /*Тут мы премию получаем*/
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, null, FD.deal.rec.bonusdate, FD.deal.rec.bonusfiid)) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.bonusdate, FD.deal.rec.bonusfiid)) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
      MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
      MTStr = MTStr + "INN " + {INN_Bank}; 
    end;
  end;

  return MTStr;

end;

//kvv 26.02.2019 Пока отдельно для 360-362!
private macro GetField_57D_36X( FD, IsBuy ):string
  record Account(account);
  const NOACC:string = "ACC YOUR INSTRUCTIONS";
  const SYMB_END:string = "\r\n";
  var PaymentID:integer = 0,RecAcc:string = "";
  var Платеж:RsbPayment;
  var MTStr:string = "";

  if (FD.deal.rec.Netting == SET_CHAR)
    MTStr = "NETTING";
    return MTStr;
  end;

  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, 2, 0, FD.deal.rec.begindate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж = RsbPayment(PaymentID);
  end;

  if (Платеж)
    if (IsBuy)
      /*Тут мы премию платим*/
      MTStr = "/" + IIF(strlen(Платеж.ReceiverAccount) > 1,Платеж.ReceiverAccount,NOACC) + SYMB_END;
      if (strlen(Платеж.ReceiverBankCode) > 1)
        MTStr = MTStr + "BIC " + Платеж.ReceiverBankCode + SYMB_END;
      end; 
      if (strlen(Платеж.ReceiverCorrAccNostro) > 1)
        MTStr = MTStr + "CA " + Платеж.ReceiverCorrAccNostro + SYMB_END; 
      end;
      if (strlen(Платеж.ReceiverINN) > 1)
        MTStr = MTStr + "INN " + IIF(strlen(Платеж.ReceiverINN) > 10, SubStr(Платеж.ReceiverINN, 1, 10), Платеж.ReceiverINN);
      end;

    else
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, null, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования())) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
      MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
      MTStr = MTStr + "INN " + {INN_Bank}; 
    end;
  else
    if (IsBuy)
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, null, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования())) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + "BIC " + {MFO_Bank} + SYMB_END; /* ВР. Получатель рублей - всегда наш банк */
      MTStr = MTStr + "CA " + {CORAC_Bank} + SYMB_END; 
      MTStr = MTStr + "INN " + {INN_Bank}; 
    else
      FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, 1/*FiKind*/, FD.nfi_baseactiv.rec.FIID, 15/*ServiceKind*/, 0/*KindOper*/, 0/*Purpose*/, 0/*BankID*/, Settacc);
      MTStr = "/" + IIF(strlen(Settacc.rec.account) > 1, Settacc.rec.account, NOACC) + SYMB_END;
      if (strlen(Settacc.rec.bankcode) > 1)
         MTStr = MTStr + "BIC " + Settacc.rec.bankcode + SYMB_END;
      end;
      if (strlen(Settacc.rec.corracc) > 1)
         MTStr = MTStr + "CA " + Settacc.rec.corracc + SYMB_END; 
      end;
      if (strlen(Settacc.rec.inn) > 1)
         MTStr = MTStr + "INN " + IIF(strlen(Settacc.rec.inn) > 10, SubStr(Settacc.rec.inn, 1, 10), Settacc.rec.inn);
      end;
    end;
  end;

  return MTStr;
end;

//kvv 26.02.2019 Пока отдельно для 360-362!
private macro GetField_57A_36X( FD, IsBuy ):string
  record Account(account);
  const NOACC:string = "ACC YOUR INSTRUCTIONS";
  const SYMB_END:string = "\r\n";
  var PaymentID:integer = 0,RecAcc:string = "";
  var Платеж:RsbPayment;
  var MTStr:string = "";

  if (FD.deal.rec.Netting == SET_CHAR)
    MTStr = "NETTING";
    return MTStr;
  end;

  if( (DV_FindPaymentID(FD.Kind, FD.deal.rec.ID, 2, 0, FD.deal.rec.begindate, @PaymentID) == true) and (PaymentID > 0) )
      Платеж = RsbPayment(PaymentID);
  end;

  if (Платеж)
    if (IsBuy)
      /*Тут мы премию платим*/
      MTStr = "/" + IIF(strlen(Платеж.ReceiverAccount) > 1,Платеж.ReceiverAccount,NOACC) + SYMB_END;
      if (strlen(Платеж.ReceiverBankCode) > 1)
        MTStr = MTStr + ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
      end; 
    else
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, null, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования())) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT); /* ВР. Получатель рублей - всегда наш банк */
    end;
  else
    if (IsBuy)
      if (strlen(Платеж.ReceiverAccount) > 1)
        RecAcc = Платеж.ReceiverAccount;
      else
        if( (not FD.IsExistAccount("+Форвард, расчеты", null, true, FIROLE_FIREQ, Account, null, FD.deal.rec.begindate, FD.ВалютаТребования())) and
            (not FD.OpenAccount("+Форвард, расчеты", null, false, FIROLE_FIREQ, Account, FD.deal.rec.begindate, FD.ВалютаТребования())) )
            RunError("|Ошибка при определении счета по категории '+Форвард, расчеты'");
        end;
        RecAcc = Account.Account;
      end;
      MTStr = "/" + IIF(strlen(RecAcc) > 1,RecAcc,NOACC) + SYMB_END;
      MTStr = MTStr + ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
    else
      FindSETTACC_PMAUTO(FD.Deal.rec.Contractor, 1/*FiKind*/, FD.nfi_baseactiv.rec.FIID, 15/*ServiceKind*/, 0/*KindOper*/, 0/*Purpose*/, 0/*BankID*/, Settacc);
      MTStr = "/" + IIF(strlen(Settacc.rec.account) > 1, Settacc.rec.account, NOACC) + SYMB_END;
      if (strlen(Settacc.rec.bankcode) > 1)
         MTStr = MTStr + ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
      end;
    end;
  end;

  return MTStr;
end;

private macro GetField_14C( ID:integer ):string
  var sql = DL_RSDCommand(GetQueryGenAgrISDA());
  sql.addParam( ID );
  var Field = sql.execute();
  if( Field.MoveNext() )
     var str = Field.Version;
     return str;
  else
     return "0000";
  end;
end;

private macro GetField_22( Code1:string, Code2:string, Course:string ):string
  var RetVal:string = "";
  Course = StrSubst(Course, ",", "");
  var len = StrLen(Course);

  if( len > 4 )
     Course = SubStr(Course, len - 3);
  elif( len < 4 )
     while( len < 4 )
           Course = "0" + Course;
           len = StrLen(Course);
     end;
  end;

  private macro RetStr( _Code1:string, _Code2:string, _Course:string ):string
     return SubStr(_Code1, 1, 4) + SubStr(_Code1, 7, 2) + _Course + SubStr(_Code2, 1, 4) + SubStr(_Code2, 7, 2);
  end;

  if( Code1 < Code2 )
     RetVal = RetStr(Code1, Code2, Course);
  else
     RetVal = RetStr(Code2, Code1, Course);
  end;

  return RetVal;
end;

private macro GetField_22B( FD, NoteKind ):string
  var str22B = "";
/*
  var str = readNoteForObject( OBJTYPE_OUTOPER_DV,
                               UniID( FD.deal, OBJTYPE_OUTOPER_DV ),
                               NoteKind);
*/
var str = "LOPO JHGH NHJK";

  var strArr = StrSplit2(StrSubst(str, " ", ""), 4);
  var i = 0;

  while(i < strArr.size)
    str22B = IIF(strlen(str22B) > 0, str22B + "\r\n", str22B) + ":22B:" + strArr[i];
    i = i + 1;
  end;

  println(":18A:" + strArr.size);
  println(str22B);
end;

private macro GetField_23A( Type:integer, Netting ):string
  var RetVal:string = "";

  if( Type == ALG_DV_FIX_FLOAT )
     RetVal = "FIXEDFLOAT";
  elif( Type == ALG_DV_FLOAT_FIX )
     RetVal = "FLOATFIXED";
  elif( Type == ALG_DV_FIX_FIX )
     RetVal = "FIXEDFIXED";
  elif( Type == ALG_DV_FLOAT_FLOAT )
     RetVal = "FLOATFLOAT";
  end;

  if( Netting != SET_CHAR )
     RetVal = RetVal + "/GROSS";
  else
     RetVal = RetVal + "/NET";
  end;

  return RetVal;
end;

private macro GetField_23( Type:integer, OptionType:integer, OptionStyle:integer, Валюта ):string
  var RetVal:string = "";

  if( Type == ALG_DV_BUY )
     RetVal = "BUY";
  elif( Type == ALG_DV_SALE )
     RetVal = "SELL";
  end;

  if( OptionType == OPTIONKIND_CALL )
     RetVal = RetVal + "/CALL";
  elif( OptionType == OPTIONKIND_PUT)
     RetVal = RetVal + "/PUT";
  end;

  if( OptionStyle == DVSTYLE_AMERICAN )
     RetVal = RetVal + "/A";
  else
     RetVal = RetVal + "/E";
  end;

  RetVal = RetVal + "/" + Валюта;

  return RetVal;
end;

private macro GetField_14A( TypeCalc:integer ):string
  var RetVal:string = "";

  if( TypeCalc == ALG_DV_TYPECALC_FOLLOWING )
     RetVal = "FOLLOWING";
  elif( TypeCalc == ALG_DV_TYPECALC_MODIFIED )
     RetVal = "MODIFIEDF";
  elif( TypeCalc == ALG_DV_TYPECALC_PRECEDING )
     RetVal = "PRECEDING";
  end;

  return RetVal;
end;

private macro NumToStr( Number, Point:integer, DelR:bool ):string
  var RetVal = ЧислоCЗаданнойТочностью(Number, Point);
  var index_ = Index(RetVal, ".");
  if( index_ == 0 ) /* нет дробной части */
     //mda 21.02.2019 По замечанию от банка , если дробной части нет, то всё равно закрываем запятой
     RetVal = RetVal+","; // SVE+ ",";
  else
     var i:integer = 0;
     if( (DelR != NULL) and (DelR == true) )
        RetVal = SubStr(RetVal, 1, index_ - 1) + "," + SubStr(RetVal, index_ + 1, strlen(RetVal) - 1);
        /* убираем нули справа */
        i = strlen(RetVal);
        while( i > 0 )
          if( SubStr(RetVal, i, 1) == "0" )
             RetVal = SubStr(RetVal, 1, i-1);
             i = strlen(RetVal);
          else
             break;
          end;
        end;
     else
        var ExFlag:bool = false;
        var Estr = SubStr(RetVal, index_ + 1, strlen(RetVal) - 1); /* дробная часть */
        i = strlen(Estr);
        while( i > 0 )
           if( SubStr(Estr, i, 1) != "0" )
              ExFlag = true;
              break;
           end;
           i = i - 1;
        end;

        RetVal = SubStr(RetVal, 1, index_ - 1) + ",";

        if( ExFlag )
           RetVal = RetVal + Estr;
        end;
        //mda 21.02.2019 если дробная часть нулевая , то закрываем запятой
        /* SVE вернул вариант Карлова чтобы при отсутствии дробной части ставилась запятая
        if (Estr == "00")
          RetVal = RetVal + ",";
        end;
        */
     end;
  end;

  return RetVal;
end;

private macro GetCountPmGr( DealID:integer, Side:integer, Netting ):integer
  var RetVal:integer = 0;
  var Query, Data, Sql;

  Sql = " SELECT count(1) as cnt " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID  = ? " +
        "    AND t_Side    = ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting != SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     RetVal = SQL_ConvTypeInteger(Data.cnt);
  end;

  return RetVal;
end;

private macro GetNumberPmGr( PmGr:TRecHandler ):integer
  var RetVal:integer = 0;
  var Query, Data, Sql;

  Sql = " SELECT q.t_Num " +
        "   FROM (SELECT row_number() over(ORDER BY pmgr.t_BegDate) t_Num, pmgr.* " +
        "           FROM ddvnpmgr_dbt pmgr " +
        "          WHERE pmgr.t_DealID = ? " +
        "            AND pmgr.t_Side   = ?) q " +
        "  WHERE q.t_ID = ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, PmGr.rec.DealID);
  Query.addParam("", RSDBP_IN, PmGr.rec.Side);
  Query.addParam("", RSDBP_IN, PmGr.rec.ID);
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     RetVal = SQL_ConvTypeInteger(Data.Num);
  end;

  return RetVal;
end;

private macro GetPmGrViewByNumber( DealID:integer, Side:integer, Number:integer, Netting )
  var RetVal = NULL;
  var Query, Data, Sql;
  Sql = " SELECT pm.* " +
        "   FROM (SELECT row_number() over(ORDER BY pmgr.t_BegDate) t_Num, pmgr.* " +
        "           FROM ddvnpmgr_dbt pmgr " +
        "          WHERE pmgr.t_DealID = ? "
        "            AND pmgr.t_Side = ?) q, dv_dvnpmgr pm " +
        "  WHERE q.t_Num = ? " +
        "    AND pm.t_ID = q.t_ID " +
        "    AND pm.t_Type = 3 ";
  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting != SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.addParam("", RSDBP_IN, Number);
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     RetVal = Data;
  end;

  return RetVal;
end;

private macro GetBegEndDatePmGr( DealID:integer, Side:integer, Netting, BegDate:@date, EndDate:@date )
  var RetVal:integer = 0;
  var Query, Data, Sql;

  BegDate = date(0,0,0);
  EndDate = date(0,0,0);

  Sql = " SELECT Min(t_BegDate) as t_BDate, Max(t_EndDate) as t_EDate " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID = ? " +
        "    AND t_Side   = ? ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting != SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.execute();

  Data = TRsbDataSet(Query);
  if( Data.MoveNext() )
     BegDate = SQL_ConvTypeDate(Data.BDate);
     EndDate = SQL_ConvTypeDate(Data.EDate);
  end;
end;

private macro Print_30F_32M( DealID:integer, Side:integer, Netting, Currency:string, print32M:bool )
  var Query, Data, Sql;

  Sql = " SELECT t_PayDate, t_DemandSum, t_LiabilitySum " +
        "   FROM ddvnpmgr_dbt " +
        "  WHERE t_DealID  = ? " +
        "    AND t_Side    = ? " +
        " ORDER BY t_PayDate ";

  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, DealID);
  Query.addParam("", RSDBP_IN, IIF(Netting !=SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
  Query.execute();

  Data = TRsbDataSet(Query);
  while( Data.MoveNext() )
     /* Дата платежа */
     println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(Data.PayDate)));
     if( print32M )
        /* Валюта, сумма платежа */
        println(":32M:" + Currency + NumToStr(SQL_ConvTypeSum(IIF(Side == ALG_DV_PMGR_SIDE_DEMAND, Data.DemandSum, Data.LiabilitySum)), 2));
     end;
  end;
end;

private macro Print_18A_30F_32M( nFi, DealID:integer, Side:integer, Netting, Currency:string, print32M:bool )
  var Query, Data, Sql, i = 0;
  Sql = "SELECT CASE WHEN F.T_PERIODKIND = 1                              "+
        "            THEN F.T_EXECDATE - D.T_BEGINDATE                    "+
        "            WHEN F.T_PERIODKIND = 2                              "+
        "            THEN months_between(F.T_EXECDATE,  D.T_BEGINDATE)    "+
        "            WHEN F.T_PERIODKIND = 3                              "+
        "            THEN months_between(F.T_EXECDATE,  D.T_BEGINDATE)/12 "+
        "       END dif,                                                  "+
        "       D.T_BEGINDATE BeginDate,                                  "+
        "       f.T_EXECDATE ExecDate                                     "+
        "  FROM ddvndeal_dbt d,                                           "+
        "       ddvnfi_dbt f                                              "+
        " WHERE D.T_ID = ?                                                "+
        "   AND F.T_DEALID = D.T_ID                                       "+
        "   AND F.T_TYPE = ?";
  Query = RSDCommand( Sql );
  Query.NullConversion = true;
  Query.addParam("", RSDBP_IN, nFi.rec.DealID);
  Query.addParam("", RSDBP_IN, IIF(Side == 1, 0, 2));
  Query.execute();
  Data = TRsbDataSet(Query);

  if( Data.MoveNext() )  
     var BeginDate = date(Data.BeginDate);
     var ExecDate = date(Data.ExecDate);
     var NextDate:Date;
     var Rest = mod(Data.dif, nFi.rec.Period);
     var Cnt = round(Data.dif/nFi.rec.Period, 0, 2);
     var str30F = "";

     /* Дата платежа */
     if( Data.dif/nFi.rec.Period > Cnt )
        if( nFi.rec.PeriodKind == 1)
           NextDate = DateShift(BeginDate, int(round(Rest, 2, 1)));
        end;
        if( nFi.rec.PeriodKind == 2)
           NextDate = DateShift(BeginDate, int(round(30 * Rest, 2, 1)));
        end;
        if( nFi.rec.PeriodKind == 3)
           NextDate = DateShift(BeginDate, int(round(365 * Rest, 2, 1)));
        end;

        str30F = ":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(NextDate));
        BeginDate = NextDate;
     end;

     /* Дата платежа */
     while(i < cnt)
       
       if( nFi.rec.PeriodKind == 1)
          NextDate = DateShift(BeginDate, nFi.rec.Period);
       end;
       if( nFi.rec.PeriodKind == 2)
          NextDate = DateShift(BeginDate, null, nFi.rec.Period);
       end;
       if( nFi.rec.PeriodKind == 3)
          NextDate = DateShift(BeginDate, null, null, nFi.rec.Period);
       end;

       if( NextDate > ExecDate ) 
          str30F = IIF(strlen(str30F) > 0, str30F + "\r\n", str30F) + ":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(ExecDate));
          if( print32M )
             /* Валюта, сумма платежа */
             Sql = "SELECT t_DemandSum, t_LiabilitySum " +
                   "  FROM ddvnpmgr_dbt " +
                   " WHERE t_DealID  = ? " +
                   "   AND t_Side    = ? " +
                   " ORDER BY t_PayDate ";
             Query = RSDCommand( Sql );
             Query.NullConversion = true;
             Query.addParam("", RSDBP_IN, DealID);
             Query.addParam("", RSDBP_IN, IIF(Netting !=SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
             Query.execute();
             Data = TRsbDataSet(Query);
            
             if( Data.MoveNext() )
                str30F = str30F + "\r\n:32M:" + Currency + NumToStr(SQL_ConvTypeSum(IIF(Side == ALG_DV_PMGR_SIDE_DEMAND, Data.DemandSum, Data.LiabilitySum)), 2);
             end;
          end;
          i = i + 1;
          break;
       end;
       
       str30F = IIF(strlen(str30F) > 0, str30F + "\r\n", str30F) + ":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(NextDate));

       if( print32M )
          /* Валюта, сумма платежа */
          Sql = "SELECT t_DemandSum, t_LiabilitySum " +
                "  FROM ddvnpmgr_dbt " +
                " WHERE t_DealID  = ? " +
                "   AND t_Side    = ? " +
                " ORDER BY t_PayDate ";
          Query = RSDCommand( Sql );
          Query.NullConversion = true;
          Query.addParam("", RSDBP_IN, DealID);
          Query.addParam("", RSDBP_IN, IIF(Netting !=SET_CHAR, Side, ALG_DV_PMGR_SIDE_UNDEF));
          Query.execute();
          Data = TRsbDataSet(Query);

          if( Data.MoveNext() )
             str30F = str30F + "\r\n:32M:" + Currency + NumToStr(SQL_ConvTypeSum(IIF(Side == ALG_DV_PMGR_SIDE_DEMAND, Data.DemandSum, Data.LiabilitySum)), 2);
          end;
       end;
       BeginDate = NextDate;
       i = i + 1;
    end;

    if( Data.dif/nFi.rec.Period > Cnt )
       i = i + 1;
    end;
    /* Количество повторений */
    println(":18A:" + i);
    println(str30F);
  end;
end;

private macro GetBasis( Basis:integer ):string
  var RetVal:string = "";

  if( Basis == DV_BASIS_ACTACT )
     RetVal = "ACT/365";
  elif( Basis == DV_BASIS_ACT365 )
     RetVal = "AFI/365";
  elif( Basis == DV_BASIS_ACT360 )
     RetVal = "ACT/360";
  elif( Basis == DV_BASIS_30360 )
     RetVal = "360/360";
  elif( Basis == DV_BASIS_31360 )
     RetVal = "36E/360";
  end;

  return RetVal;
end;

private macro GetPeriod( Period:integer, PeriodKind:integer ):string
  var RetVal:string = string(Period);

  if( PeriodKind == ALG_DV_PERIODKIND_PRRATE_DAY )
     RetVal = RetVal + "D";
  elif( PeriodKind == ALG_DV_PERIODKIND_PRRATE_MONTH )
     RetVal = RetVal + "M";
  elif( PeriodKind == ALG_DV_PERIODKIND_PRRATE_YEAR )
     RetVal = RetVal + "Y";
  end;

  return RetVal;
end;

PRIVATE MACRO GetIsNotResident ( PartyID:integer )
  var sqlPartcode, PartyRow;

  sqlPartcode = RSDCommand("select t_NotResident from dparty_dbt " +
                           " where t_PartyID = ?");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartyRow = TRsbDataSet(sqlPartcode);
  if( PartyRow.MoveNext() )
     return PartyRow.t_NotResident;
  end;

  return "";
END;

PRIVATE MACRO GetCode_103 ( PartyID:integer )
  var sqlPartcode, PartyRow;

  sqlPartcode = RSDCommand("SELECT t_code FROM dobjcode_dbt WHERE t_objecttype = 3 AND t_codekind = 103 AND t_objectid = ?");

  sqlPartcode.addParam("", RSDBP_IN, PartyID);
  sqlPartcode.execute();

  PartyRow = TRsbDataSet(sqlPartcode);
  if( PartyRow.MoveNext() )
     return PartyRow.t_code;
  end;

  return "";
END;


private macro PrintFixMT360_MT361( nFI:TRecHandler, Deal:TBFile, Side:integer, Netting, Валюта:integer, Kind:integer/*360,361*/ )
/*
  /* Фиксированная ставка */
  println(":37U:" + NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true));
  if( Kind == 361 )
     /* Детали процентной ставки */
     println(":37N:");
  end; 
*/
  if( nFi.rec.RateId == -1 )
     /* Фиксированная ставка */
     println(":37M:" + NumToStr(nFI.rec.Rate, nFI.rec.RatePoint, true));
  else
     /* Детали процентной ставки */
     println(":37N:");
  end;       
  Print_18A_30F_32M(nFI, Deal.rec.ID, Side, Netting, ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING), IIF(nFi.rec.RateId == -1, false, true));
//  Print_30F_32M(Deal.rec.ID, Side, Netting, ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING), IIF(nFi.rec.RateId == -1, false, true));
  if( nFi.rec.RateId == -1 )
     /* Признак корректировки даты окончания периода */
//     println(":17F:" + IIF(Deal.rec.CorrectDate == SET_CHAR, "Y", IIF(Kind == 361, "N", "")));
     println(":17F:" + IIF(Deal.rec.CorrectDate == SET_CHAR, "Y", "N"));
     /* Порядок расчета рабочих дней */
     println(":14D:" + GetBasis(nFI.rec.Basis));
  end;
  println(":14A:" + GetField_14A(nFI.rec.TypeCalc));
  /* Финансовый центр */
  GetField_22B(Deal /*,<указать номер причечания>*/);
end;

private macro GetField_14F( nFi )
  var sqlQuery, ret; 
      sqlQuery = RSDCommand("select t_NAME, t_DEFINITION from dfininstr_dbt where t_FIID = ? " );
      sqlQuery.addParam( "", RSDBP_IN, nFi.rec.RateId );
      sqlQuery.execute();
      ret = TRsbDataSet( sqlQuery, RSDVAL_CLIENT, RSDVAL_STATIC );
      ret.MoveLast();
      if( ret.DEFINITION )
         println(":14F:OTHER");
         /* Детали процентной ставки */
         println(":37N:/FROP/" + ret.NAME);
      else
         println(":14F:" + ПолучитьКодФинИн(nFi.rec.FiId, null, FICK_ISOSTRING) + "-" + ret.NAME);
      end;
end;

private macro GetField_14J( ID )
  var sql; 
  var Query = "SELECT CASE WHEN BD.T_BEGDATE >= BD.T_FIXDATE "+
                     "            THEN 'FISTR'                      "+
                     "            ELSE 'LAST'                       "+
                     "       END str                                "+
                     "  FROM ddvnpmgr_dbt bd,                       "+
                     "       ddvndeal_dbt nd                        "+
                     " WHERE nd.T_ID = ?                            "+
                     "   AND BD.T_SIDE = 1                          "+
                     "   AND BD.T_BEGDATE = ND.T_BEGINDATE          "+
                     "   AND BD.T_DEALID = nd.T_ID";
  sql = DL_RSDCommand(Query);
  sql.addParam( ID );
  var rs = sql.execute();
  if( rs.MoveNext() )
     println(":14J:" + rs.str);
  end;
end;

private macro PrintFloatMT360_MT361( nFI:TRecHandler, Deal:TBFile, Side:integer, Netting, Kind:integer/*360,361*/ )
  /* Вариант плавающей ставки */
  GetField_14F(nFi);
//  println(":14F:" + ПолучитьКодФинИн(nFi.rec.FiId, null, FICK_ISOSTRING) + "-" + GetFI_NAME(nFi.rec.FiId));
  /* Определение даты изменения ставки */
  GetField_14J( Deal.rec.Id);
//  println(":14J:OTHER");
  /* Расчетный срок погашения */
  println(":38E:" + GetPeriod(nFI.rec.Period, nFI.rec.PeriodKind));
  Print_18A_30F_32M(nFI, Deal.rec.ID, Side, Netting, null, false);
//  Print_30F_32M(Deal.rec.ID, Side, Netting, NULL/*не используется*/, false);
  /* Признак корректировки даты окончания периода */
//  println(":17F:" + IIF(Deal.rec.CorrectDate == SET_CHAR, "Y", IIF(Kind == 361, "N", "")));
  println(":17F:" + IIF(Deal.rec.CorrectDate == SET_CHAR, "Y", "N"));
  /* Порядок расчета рабочих дней */
  println(":14D:" + GetBasis(nFI.rec.Basis));
  println(":14A:" + GetField_14A(nFI.rec.TypeCalc));
  /* Финансовый центр */
  GetField_22B(Deal /*,<указать номер причечания>*/);
  if( Kind == 361 )
     if( nFI.rec.Spread != 0.0 )
        /* Спред */
        println(":37R:" + NumToStr(nFI.rec.Spread, 4, true));
     end;
  end;
end;

private macro PrintCommonMT360_MT361( FD, Kind:integer/*360,361*/ )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  println(":20:" + DateToStrDDMMYYYY(FD.ДатаСделки()) + "-" + FD.DealCode());
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  end;
  /* Тип операции */
  println(":22A:NEWT");
  /* Общий референс */
  println(":22C:" + GetField_22C(CodeSWIFT_Our, CodeSWIFT_Contr, FD.ДатаИсполнения()));
  /* Определение свопа */
  println(":23A:" + GetField_23A(FD.Deal.rec.Type, FD.Deal.rec.netting_pmgr));
  /* Номер контракта */
  println(":21N:" + FD.DealCode() + IIF(Kind == 361, "-CCYIRS", "-IRS"));
  /* Дата сделки */
  println(":30T:" + DateToStrYYYYMMDD(FD.ДатаСделки()));
  /* Дата вступления в силу */
  println(":30V:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
  /* Дата закрытия */
  println(":30P:" + DateToStrYYYYMMDD(FD.ДатаИсполнения()));
  /* Порядок расчета рабочих дней */
  println(":14A:" + GetField_14A(FD.nFI_BaseActiv.rec.TypeCalc));

  if( Kind == 361 )
     /* Валюта, условная основная сумма стороны B */
     println(":32B:" + ПолучитьКодФинИн(FD.ВалютаТребования(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаТребования(), 2));
     /* Валюта, условная основная сумма стороны A */
     println(":33B:" + ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));
  elif( Kind == 360 )
     /* Валюта, сумма */
     println(":32B:" + ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) + NumToStr(FD.СуммаОбязательства(), 2));
  end;

  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  /* Тип, дата, версия соглашения */
/*
  var OptionsAgreement:string = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_OPTIONSAGREEMENT);
  if( OptionsAgreement == "" )
     OptionsAgreement = "XXXXX/00000000//0000";
  end;
*/
  if( GetField_77H(FD.Deal.rec.GenAgrId) == "OTHER" )
     /* Условия контракта */
     println(":77D:" + GetField_77D(FD.Deal.rec.GenAgrId));
  else
     println(":77H:" + GetField_77H(FD.Deal.rec.GenAgrId));
  end;
  /* Год версий определений */
/*
  var YearDefinitions:string = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_YEARDEFINITIONS);
  if( YearDefinitions == "" )
     YearDefinitions = "0000";
  end;
  println(":14C:" + YearDefinitions);
*/
  println(":14C:" + GetField_14C(FD.Deal.rec.genagrid));

  /* Фиксированный процент, выплачиваемый стороной B */
  if( (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX) or (FD.Deal.rec.Type == ALG_DV_FIX_FIX) )
     println(":15B:");
     PrintFixMT360_MT361(FD.nFI_BAOther, FD.Deal, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, FD.ВалютаТребования(), Kind);
  end;

  /* Плавающий процент, выплачиваемый стороной B */
  if( (FD.Deal.rec.Type == ALG_DV_FIX_FLOAT) or (FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT) )
     println(":15C:");
     PrintFloatMT360_MT361(FD.nFI_BAOther, FD.Deal, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, Kind);
  end;

  /* Платежные инструкции для процентов выплачиваемых контрагентом */
  println(":15D:");
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     println(":57A:/" + получитьКорСчет(1));
     println(trim(CodeSWIFT_Our));
//     println(":57A:" + GetField_57A_36X( FD, true ));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD, true ));
  else
     println(":57A:/" + получитьКорСчет(1));
     println(trim(CodeSWIFT_Our));
//     println(":57A:" + GetField_57A_36X( FD, true ));
  end;

  /* Фиксированный процент, выплачиваемый стороной A */
  if( (FD.Deal.rec.Type == ALG_DV_FIX_FLOAT) or (FD.Deal.rec.Type == ALG_DV_FIX_FIX) )
     println(":15E:");
     PrintFixMT360_MT361(FD.nFI_BaseActiv, FD.Deal, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, FD.ВалютаОбязательства(), Kind);
  end;

  /* Плавающий процент, выплачиваемый стороной A */
  if( (FD.Deal.rec.Type == ALG_DV_FLOAT_FIX) or (FD.Deal.rec.Type == ALG_DV_FLOAT_FLOAT) )
     println(":15F:");
     PrintFloatMT360_MT361(FD.nFI_BaseActiv, FD.Deal, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, Kind);
  end;

  /* Платежные инструкции для процентов выплачиваемых контрагенту */
  println(":15G:");
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     println(":57A:/" + получитьКорСчет(FD.Deal.rec.Contractor));
     println(trim(CodeSWIFT_Contr));
//     println(":57A:" + GetField_57A_36X( FD ));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     println(":57A:/" + получитьКорСчет(FD.Deal.rec.Contractor));
     println(trim(CodeSWIFT_Contr));
//     println(":57A:" + GetField_57A_36X( FD ));
  end;
end;

private macro PrintPaymMT361( BegDate:date, EndDate:date, Платеж, Платеж2, CodeSWIFT:string, TypeCalc:integer, FD )
  /* Количество повторений */
  println(":18A:2");
  /* Тип обмена */
  println(":22X:INLX");
  /* Дата, валюта, сумма платежа */
  println(":30F:" + DateToStrYYYYMMDD(BegDate));
  println(":32M:" + ПолучитьКодФинИн(Платеж.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж.rec.OrderAmount, 2));
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     println(":57A:/" + получитьКорСчет(IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), 1, FD.Deal.rec.Contractor)));
     println(trim(CodeSWIFT));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     println(":57A:/" + получитьКорСчет(IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), 1, FD.Deal.rec.Contractor)));
     println(trim(CodeSWIFT));
  end;
  /* Тип обмена */
  println(":22X:FINX");
  /* Дата, валюта, сумма платежа */
  println(":30F:" + DateToStrYYYYMMDD(EndDate));
  println(":32M:" + ПолучитьКодФинИн(Платеж2.rec.OrderFIID, null, FICK_ISOSTRING) + NumToStr(Платеж2.rec.OrderAmount, 2));
  /* Агент получатель */
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     println(":57A:/" + получитьКорСчет(IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), 1, FD.Deal.rec.Contractor)));
     println(trim(CodeSWIFT));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     println(":57A:/" + получитьКорСчет(IIF(CodeSWIFT == ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT), 1, FD.Deal.rec.Contractor)));
     println(trim(CodeSWIFT));
  end;
  /* Порядок расчета рабочих дней */
  println(":14A:" + GetField_14A(TypeCalc));
  /* Финансовый центр */
  GetField_22B(FD.Deal /*,<указать номер причечания>*/);
end;

private macro PrintBsMT362( PmGr, nFI:TRecHandler, Deal:TBFile, Валюта:integer, Сумма:money, Side:integer, Это_ВП_СВОП:bool )
  /* Валюта, величина условной основной суммы */
  println(":33F:"+ ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(SQL_ConvTypeSum(PmGr.BaseSum), 2));
  /* Дата начала периода */
  println(":30X:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.BegDate)));
  /* Дата окончания периода */
  println(":30Q:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.EndDate)));
  /* Новая ставка */
  var Rate:money = 0.0;
  var Point:integer = 0;
  if( not DV_NDealSideFix(Side, Deal) )
     Rate  = SQL_ConvTypeSum(PmGr.FloatRateValue);
     Point = SQL_ConvTypeInteger(PmGr.FloatRatePoint);
  else
     Rate  = SQL_ConvTypeSum(PmGr.FixRate);
     Point = nFI.rec.RatePoint;
  end;
  println(":37G:" + NumToStr(Rate, Point, true));
  /* Спред */
  println(":37R:" + NumToStr(SQL_ConvTypeSum(PmGr.Spread), 4, true));
  /* Общая величина ставки */
  println(":37M:" + NumToStr(SQL_ConvTypeSum(PmGr.Spread) + Rate, max(4, Point), true));
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.PayDate)));
  /* Валюта, сумма процентов */
  if( not Это_ВП_СВОП )
     println(":32H:"+ ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(Сумма, 2));
  end;
end;

private macro PrintClMT362( PmGr, Валюта:integer, Сумма:money, CodeSWIFT:string, FD )
  /* Количество повторений */
  println(":18A:1");
  /* Дата платежа */
  println(":30F:" + DateToStrYYYYMMDD(SQL_ConvTypeDate(PmGr.PayDate)));
  /* Валюта, сумма платежа */
  println(":32M:" + ПолучитьКодФинИн(Валюта, null, FICK_ISOSTRING) + NumToStr(Сумма, 2));
  /* Агент получатель */
/*
  if( GetIsNotResident(FD.Deal.rec.Contractor))
     println(":57A:" + trim(CodeSWIFT));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
     println(":57D:" + GetField_57D_36X( FD ));
  else
     println(":57A:" + trim(CodeSWIFT));
  end;
*/
end;

macro DV_MsgSWIFT_MT360( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT360");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT360_MT361(FD, 360);

     SetOutput(NULL, true);
     close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить в SWIFT";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;

     close(ReportInFile);
     var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
     var cmd = RSDCommand(query);
     cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
     cmd.AddParam("p_KindMes", RSDBP_IN, "MT360");
     cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
     cmd.AddParam("p_Msg", RSDBP_IN, Msg);
     cmd.AddParam("p_Num", RSDBP_IN, 0);
     cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
     cmd.Execute();
     var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
     Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
     MsgBox(Text);
  end;

  return RetVal;
end;

macro DV_MsgSWIFT_MT361( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();
  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT361");
  if( Open(ReportOutFile, ReportFileName) == false )
     errcode = status(errtext);
     MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
     return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT360_MT361(FD, 361);

  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var FD2 = DVFirstDocNDeal(DL_DVNDEAL, DealID, 2);
  var BegDate:date = date(0,0,0), EndDate:date = date(0,0,0);

  GetBegEndDatePmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_DEMAND, FD.Deal.rec.netting_pmgr, @BegDate, @EndDate);
  /* Обмены основных сумм стороной В */
  println(":15K:");
  PrintPaymMT361(BegDate, EndDate, FD.ПлатежТреб, FD2.ПлатежТреб, CodeSWIFT_Our, FD.nFI_BAOther.rec.TypeCalc, FD);

  GetBegEndDatePmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, FD.Deal.rec.netting_pmgr, @BegDate, @EndDate);
  /* Обмены основных сумм стороной A */
  println(":15L:");
  PrintPaymMT361(BegDate, EndDate, FD.ПлатежОб, FD2.ПлатежОб, CodeSWIFT_Contr, FD.nFI_BaseActiv.rec.TypeCalc, FD);

  SetOutput(NULL, true);
  close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить в SWIFT";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;

     close(ReportInFile);
     var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
     var cmd = RSDCommand(query);
     cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
     cmd.AddParam("p_KindMes", RSDBP_IN, "MT361");
     cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
     cmd.AddParam("p_Msg", RSDBP_IN, Msg);
     cmd.AddParam("p_Num", RSDBP_IN, 0);
     cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
     cmd.Execute();
     var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
     Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
     MsgBox(Text);
  end;

  return RetVal;
end;

macro DV_MsgSWIFT_MT362( PmGrID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;
  var PmGr = TRecHandler("dvnpmgr.dbt");
  var DemandPmGr, LiabilityPmGr, Это_ВП_СВОП = false;
  array MenuItems;
  if( DL_GetRecHandler( PmGr, " SELECT * " +
                              "   FROM ddvnpmgr_dbt " +
                              "  WHERE t_ID = " + string(PmGrID)
                      ) )
     var FD = DVFirstDocNDeal(DL_DVNDEAL, PmGr.rec.DealID);
     var Number:integer = GetNumberPmGr(PmGr);
     //Это_ВП_СВОП = (FD.IsPctSWAP() and (FD.ВалютаТребования() != FD.ВалютаОбязательства()));
     Это_ВП_СВОП = true;
     /* проверка на равенство количества периодов - ограничение реализации */
/*
     if( FD.ПоставочныйКонтракт() and (GetCountPmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_DEMAND, true) != GetCountPmGr(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, true)) )
        MsgBox("Количество периодов требований и обязательств не равны");
        return 1;
     end;
*/

     /* Найдём строки view требования и обязательства */
     DemandPmGr    = GetPmGrViewByNumber(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_DEMAND, Number, FD.Deal.rec.netting_pmgr);
     LiabilityPmGr = GetPmGrViewByNumber(FD.Deal.rec.ID, ALG_DV_PMGR_SIDE_LIABILITY, Number, FD.Deal.rec.netting_pmgr);

     //mda 21.02.2019 c OR никогда не отработает , надо ставить AND , если не FRA //if( (DemandPmGr == NULL) or (LiabilityPmGr == NULL) )
     if( (DemandPmGr == NULL) and (LiabilityPmGr == NULL) )
        MsgBox("Не найдена строка графика");
        return 1;
     end;

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT362");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
     var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

     /* Общая информация */
     println(":15A:");
     /* Референс отправителя */
     println(":20:" + DateToStrDDMMYYYY(FD.ДатаСделки()) + "-" + FD.DealCode() + "-" + string(Number));
     /* Связанный референс */
     var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
     if( RelatedReference != "" )
        println(":21:" + RelatedReference);
     end;
     /* Тип операции */
     println(":22A:NEWT");
     /* Общий референс */
     println(":22C:" + GetField_22C(CodeSWIFT_Our, CodeSWIFT_Contr, FD.ДатаИсполнения()));
     /* Определение свопа */
     println(":23A:" + GetField_23A(FD.Deal.rec.Type, FD.Deal.rec.netting_pmgr));
     /* Номер контракта */
     println(":21N:" + FD.DealCode() + "-IRS");
     /* Дата вступления в силу */
     println(":30V:" + DateToStrYYYYMMDD(FD.ДатаНачала()));
     /* Дата закрытия */
     println(":30P:" + DateToStrYYYYMMDD(FD.ДатаИсполнения()));
     /* Сторона А */
     println(":82A:" + CodeSWIFT_Our);
     /* Сторона В */
     println(":87A:" + CodeSWIFT_Contr);

     /* Процентная ставка/основная сумма, выплачиваемая контрагентом */
     println(":15B:");
     PrintBsMT362(DemandPmGr, FD.nFI_BAOther, FD.Deal, FD.ВалютаТребования(), SQL_ConvTypeSum(DemandPmGr.Demand), ALG_DV_PMGR_SIDE_DEMAND, Это_ВП_СВОП);

     /* Чистая (неттинг) сумма, выплачиваемая контрагентом */
     var PaySum:money = $0;

     if( Это_ВП_СВОП )
         PaySum = SQL_ConvTypeSum(DemandPmGr.Demand);
     else
         PaySum = SQL_ConvTypeSum(LiabilityPmGr.Demand) - SQL_ConvTypeSum(DemandPmGr.Liability);
     end;

     if( PaySum > 0 )
        println(":15C:");
        PrintClMT362(DemandPmGr, FD.ВалютаТребования(), PaySum, CodeSWIFT_Our, FD);
     end;

     /* Процентная ставка/основная сумма, выплачиваемая Банком (нами) контрагенту */
     println(":15D:");
     PrintBsMT362(LiabilityPmGr, FD.nFI_BaseActiv, FD.Deal, FD.ВалютаОбязательства(), SQL_ConvTypeSum(LiabilityPmGr.Liability), ALG_DV_PMGR_SIDE_LIABILITY, Это_ВП_СВОП);

     /* Чистая (неттинг) сумма, выплачиваемая контрагенту */
     if( Это_ВП_СВОП )
        PaySum = SQL_ConvTypeSum(LiabilityPmGr.Liability);
     else
        PaySum = SQL_ConvTypeSum(LiabilityPmGr.Demand) - SQL_ConvTypeSum(DemandPmGr.Liability);
        if( PaySum < 0 )
            PaySum = abs(PaySum);
        else
            PaySum = 0;
        end;
     end;

     if( PaySum > 0 )
        println(":15E:");
        PrintClMT362(LiabilityPmGr, FD.ВалютаОбязательства(), PaySum, CodeSWIFT_Contr);
     end;

     SetOutput(NULL, true);
     close(ReportOutFile);

     MenuItems[0] = "Печатать сообщение";
     MenuItems[1] = "Отправить в SWIFT";
     var MenuResult = Menu(MenuItems, "Выбрать действие");

     if( MenuResult == 0 )
        ViewFile(ReportOutFile);
     elif( MenuResult == 1 )
        var Text;
        var Msg = "";
        Open(ReportInFile, ReportFileName);

        while(next(ReportInFile))
           Msg = Msg + ReportInFile.str+"\n";
        end;

        close(ReportInFile);
        var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
        var cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT362");
        cmd.AddParam("p_DraftID", RSDBP_IN, PmGr.rec.DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_Num", RSDBP_IN, 8);
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.Execute();
        var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
     end;

  else
     MsgBox("Не найдена строка графика с ID=" + string(PmGrID));
     RetVal = 1;
  end;

  return RetVal;
end;


private macro PrintCommonMT305( FD, Kind:integer/*305*/ )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);

  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  //mda 21.02.19 Транслит , по просьбе банка
  var deal_tr;
  StrChangeRusXSet( StrSubst(FD.DealCode(),":",""),deal_tr );
  println(":20:" + DateToStrDDMMYYYY(FD.ДатаСделки()) + deal_tr);
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  else
     println(":21:NEW");
  end;
  /* Код/Общий референс */
  //mda 20.02.19 для опциона не FD.nfi_baseactiv.rec.course ,а FD.nfi_baseactiv.rec.price
  println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi_baseactiv.rec.price, 2)));
  /* Дополнительное определение */
  println(":23:" + GetField_23(FD.Deal.rec.Type, FD.Deal.rec.OptionType, FD.Deal.rec.OptionStyle, ПолучитьКодФинИн(FD.nfi_baseactiv.rec.fiid, null, FICK_ISOSTRING)));
  /* Характер операции */
  println(":94A:BILA");
  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  /* Фонд или клиент-бенефициар */
//  println(":83A:");
  /* Дата заключения/изменения контракта */
  println(":30:" + DateToStrYYMMDD(FD.ДатаСделки()));
  /* Начальная дата исполнения */
  if( FD.Deal.rec.OptionStyle == 1)
     println(":31C:" + DateToStrYYMMDD(FD.ДатаНачала()));
  end;
  /* Детали истечения срока */
  println(":31G:" + DateToStrYYMMDD(FD.ДатаИстеченияСрокаДействия()) + "/1230/RUMO");
  /* Дата окончательного расчета */
  if (FD.ПоставочныйКонтракт())
    println(":31E:" + DateToStrYYMMDD(FD.ДатаПоставки()));
  else
    println(":31E:" + DateToStrYYMMDD(FD.ДатаИсполнения()));
  end;
  /* Тип расчетов  */
  if( FD.nfi_baseactiv.rec.exectype == DVSETTLEMET_STATE )
    println(":26F:PRINCIPAL");
  else
    println(":26F:NETCASH");
  end;
  /* Индикатор отсутствия поставок */
//  println(":17F:");
  /* Источник значения курса для расчетов */
//  println(":14S:");
  /* Валюта расчета */
  if( FD.nfi_baseactiv.rec.exectype != DVSETTLEMET_STATE )
     println(":32E:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING));
  end;
  /* Базисная валюта и сумма */
  println(":32B:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.fiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.amount, 2));
  /* Цена исполнения */
  println(":36:" + NumToStr(FD.nfi_baseactiv.rec.price, 2));
  /* Валюта и сумма оплаты */
  println(":33B:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.cost, 2));
  /* Цена опциона (премия) */
  println(":37K:" + ПолучитьКодФинИн(FD.Deal.rec.bonusfiid, null, FICK_ISOSTRING) + NumToStr(FD.Deal.rec.bonus, 2));
  /* Оплата премии */
  var TypeDeal;
  if( FD.Deal.rec.type == ALG_DV_BUY )
     TypeDeal = "P";
  elif( FD.Deal.rec.type == ALG_DV_SALE )
     TypeDeal = "R";
  end;
  //println(":34" + TypeDeal +":" + DateToStrYYMMDD(FD.ДатаНачала()) + ПолучитьКодФинИн(FD.Deal.rec.bonusfiid, null, FICK_ISOSTRING) + NumToStr(FD.Deal.rec.bonus, 2));
  println(":34" + TypeDeal +":" + DateToStrYYMMDD(FD.Deal.rec.bonusdate) + ПолучитьКодФинИн(FD.Deal.rec.bonusfiid, null, FICK_ISOSTRING) + NumToStr(FD.Deal.rec.bonus, 2));
  /* Корреспондент Отправителя*/
//  println(":53a:");
  /* Посредник */
//  println(":56a:");
  /* Банк бенефициара */
  if (FD.Deal.rec.bonusfiid != 0)
    println(":57A:" + CodeSWIFT_Contr);
  end;
  /*Год версии определений*/
    /*println(":14C:" + GetField_14C(FD.Deal.rec.genagrid));*/
  /*Если рубли то такое поле*/
  if (FD.Deal.rec.bonusfiid == 0)
    println(":57D:" + GetField_57D_305(FD));
  end;
  /* Условия контракта */
  println(":77H:" + GetField_77H(FD.Deal.rec.genagrid));
  /* Информация Отправителя Получателю */
  if( FD.Deal.rec.Comment )
     println(":72:" + substr(FD.Deal.rec.Comment, 1, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 36, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 36, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 71, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 71, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 116, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 116, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 151, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 151, 35));
  end;
  if( substr(FD.Deal.rec.Comment, 176, 35) )
     println("//" + substr(FD.Deal.rec.Comment, 176, 35));
  end;

/*
  if( (FD.v_pm_BA) or (FD.v_pm_CA) )
    /* Отчетная информация */
    println(":15B:");
//    PrintBsMT305(DemandPmGr, FD.nFI_BAOther, FD.Deal, FD.ВалютаТребования(), SQL_ConvTypeSum(DemandPmGr.Demand), ALG_DV_PMGR_SIDE_DEMAND, Это_ВП_СВОП);
  end;
*/

end;

macro DV_MsgSWIFT_MT305( DealID:integer ):integer

  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT305");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT305(FD, 305);

     SetOutput(NULL, true);
     close(ReportOutFile);

  array MenuItems;
  MenuItems[0] = "Печатать сообщение";
  MenuItems[1] = "Отправить в SWIFT";

  var MenuResult = Menu(MenuItems, "Выбрать действие");

  if( MenuResult == 0 )
     ViewFile(ReportOutFile);
  elif( MenuResult == 1 )
     var Text;
     var Msg = "";
     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;

     close(ReportInFile);
     var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
     var cmd = RSDCommand(query);
     cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
     cmd.AddParam("p_KindMes", RSDBP_IN, "MT305");
     cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
     cmd.AddParam("p_Msg", RSDBP_IN, Msg);
     cmd.AddParam("p_Num", RSDBP_IN, 0);
     cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
     cmd.Execute();
     var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
     Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
     MsgBox(Text);
  end;

  return RetVal;
end;

private macro GetQueryPayment():string
  //var query = "SELECT p.t_payer, p.t_receiver,p.t_payeraccount,p.t_receiveraccount "+  //SVE
  var query = "SELECT p.t_payerbankid, p.t_receiverbankid,p.t_payeraccount,p.t_receiveraccount "+   
              "  FROM dpmpaym_dbt p           "+
              " WHERE p.t_documentid = ?      "+
              "   AND p.t_dockind = ?         "+
              "   AND p.t_purpose = ?";
  return query;
end;

private macro GetField_87A15( ID, DOCKIND, BS ):string
  var str;
  var sql = DL_RSDCommand(GetQueryPayment());
  sql.addParam( ID );
  sql.addParam( DOCKIND );
  sql.addParam( BS );
  var Pay = sql.execute();
  if( Pay.MoveNext() )
     if( BS == 1 )
        //str = ПолучитьКодСубъекта(Pay.t_payer, PTCK_SWIFT); //SVE
        str = ПолучитьКодСубъекта(Pay.t_payerbankid, PTCK_SWIFT);
     else
        //str = ПолучитьКодСубъекта(Pay.t_receiver, PTCK_SWIFT);  //SVE
        str = ПолучитьКодСубъекта(Pay.t_receiverbankid, PTCK_SWIFT);
     end;
  end;
  return str;
end;

private macro GetQueryFIID():string
  var query = "SELECT p.t_definition  "+
              "  FROM dfininstr_dbt p "+
              " WHERE p.t_fiid = ?";
  return query;
end;

private macro GetFiidDefinition( ID ):string
  var str;
  var sql = DL_RSDCommand(GetQueryFIID());
  sql.addParam( ID );
  var FIID = sql.execute();
  if( FIID.MoveNext() )
     str = FIID.t_definition;
  end;
  return str;
end;

private macro GetField_57A( ID, BS ):string
  var str;
  var sql = DL_RSDCommand(GetQueryPayment());
  sql.addParam( ID );
  sql.addParam( BS );
  var Pay = sql.execute();
  if( Pay.MoveNext() )
     if( BS == 2 )
        str = ПолучитьКодСубъекта(Pay.t_receiver, PTCK_SWIFT);
     else
        str = ПолучитьКодСубъекта(Pay.t_payer, PTCK_SWIFT);
     end;
  end;
  return str;
end;


private macro GetField_26C( FD, NoteKind ):string
  var doc;
  var str = readNoteForObject( OBJTYPE_FXOPER_DV,
                               UniID( FD.deal, OBJTYPE_FXOPER_DV ),
                               NoteKind);
  //SVE
  if (FD.Deal.rec.dockind != 199)
    str = str + readNoteForObject( OBJTYPE_FXOPER_DV,
                               UniID( FD.deal, OBJTYPE_FXOPER_DV ),
                               NoteKind);
  else
    str = str + readNoteForObject( OBJTYPE_OUTOPER_DV,
                               UniID( FD.deal, OBJTYPE_OUTOPER_DV ),
                               NoteKind);
  end;

  if( readNoteForObject( OBJTYPE_FXOPER_DV,
                         UniID( FD.deal, OBJTYPE_FXOPER_DV ),
                         101))
      str = str + "/ALLOC";
  else
  str = str + "/UNALL";
  end;
  return str;
end;

private macro GetISONumber(fiid)  //SVE
  var sql = DL_RSDCommand("select t_ccy from dfininstr_dbt where t_fiid = ?");
  sql.addParam( fiid );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.ccy;
  end;
  return -1;
end;

private macro GetSWIFTCode(partyid) //SVE
  var sql = DL_RSDCommand("select t_code from dobjcode_dbt where t_codekind = 6 and t_objectid = ?");
  sql.addParam( partyid );
  var Data = sql.execute();
  if( Data.MoveNext() )
    return Data.code;
  end;
  return -1; 
end;

private macro PrintCommonMT600( FD, Kind:integer/*600*/, Y )
  var CodeSWIFT_Our:string   = ПолучитьКодСубъекта({OurBank}, PTCK_SWIFT);
  var CodeSWIFT_Contr:string = ПолучитьКодСубъекта(FD.Deal.rec.Contractor, PTCK_SWIFT);
  var ssu;
  var contractiv = FD.v_pm_CA.rec.fiid;
  var baseactiv = FD.v_pm_BA.rec.fiid;
  /* Основная последовательность */
  println(":15A:");
  /* Референс отправителя */
  println(":20:" + DateToStrDDMMYY(FD.ДатаСделки()) + GetCode_103(FD.Deal.rec.Contractor) + Y + substr(FD.DealCode(), strlen(FD.DealCode()) - 4));
  /* Связанный референс */
  var RelatedReference = readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.Deal, OBJTYPE_OUTOPER_DV), NOTEKIND_DVNDEAL_RELATEDREFERENCE);
  if( RelatedReference != "" )
     println(":21:" + RelatedReference);
  else
     println(":21:NEW");
  end;
  /* Код/Общий референс */
  //println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi_baseactiv.rec.price, 2)));  //SVE
  if (FD.Deal.rec.dockind != 199)
    println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi.rec.price, 2)));
  else
    println(":22:NEW/" + GetField_22(CodeSWIFT_Our, CodeSWIFT_Contr, NumToStr(FD.nfi_baseactiv.rec.price, 2)));
  end;
  /* Характер операции */
  println(":94A:BILA");
  /* Сторона А */
  println(":82A:" + CodeSWIFT_Our);
  /* Сторона В */
  println(":87A:" + CodeSWIFT_Contr);
  /* Дата заключения/изменения контракта */
  println(":30:" + DateToStrYYMMDD(FD.ДатаСделки()));
  /* Идентификация металла  */
  println(":26С:" + GetField_26C(FD, 191) + GetFiidDefinition(baseactiv));
  /* Цена за единицу */
  /*SVE для СВОПов значение OBJTYPE_FXOPER_DV(148) не подходит необходимо OBJTYPE_OUTOPER_DV(145)*/
  if (FD.deal.rec.dockind == 199)
    if (FD.dealpart == 1)
      println(":33G:" + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.deal, OBJTYPE_OUTOPER_DV), 102, FD.deal.rec.Date), 3));  //SVE для унций банк сказал указывать 3 знака после запятой
    else
      println(":33G:" + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(readNoteForObject(OBJTYPE_OUTOPER_DV, UniID(FD.deal, OBJTYPE_OUTOPER_DV), 106, FD.deal.rec.Date), 3));
    end;
  else
    if (FD.dealpart == 1)
      println(":33G:" + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(readNoteForObject(OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 102, FD.deal.rec.Date), 3));
    else
      println(":33G:" + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(readNoteForObject(OBJTYPE_FXOPER_DV, UniID(FD.deal, OBJTYPE_FXOPER_DV), 106, FD.deal.rec.Date), 3)); 
    end;
  end;
  //println(":33G:" + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.price, 2));
  /* Условия контракта */
  println(":77H:" + GetField_77H(FD.Deal.rec.genagrid));
  /* Информация Отправителя Получателю */ //SVE сейчас город берется из примечания на сделке, так как объект account не используется нигде в данном макросе, нужно обсудить с банком
  println(":72:/ELEC/");
  //println("//PAYMENT IN " + GetFiidDefinition(FD.nfi_baseactiv.rec.fiid) + " " + IIF(FD.IsBuy() == true, "FROM", "TO") + " "+ CodeSWIFT_Contr);  //SVE

  println("//PAYMENT IN " + GetISONumber(baseactiv) + " " + IIF(FD.IsBuy() != true, "FROM " + ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT), "TO " + ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiverbankid, PTCK_SWIFT)));  

  //println("//DD "+ DateToStrYYMMDD(FD.nfi_baseactiv.rec.execdate) + IIF(FD.Deal.rec.netting_pmgr == true, " NETTING/", null) + " /GRM "+ IIF(GetIsNotResident(FD.Deal.rec.Contractor) == true, FD.nfi_baseactiv.rec.amount, null));  //SVE
  println("//DD "+ DateToStrYYMMDD(FD.v_rm_CA.rec.date) + IIF(FD.Deal.rec.netting_pmgr == true, " NETTING/", "") + IIF(GetIsNotResident(FD.Deal.rec.Contractor) == true, " GRM " + NumToStr(FD.v_pm_BA.rec.amount, 2), ""));  
  if( (FD.Deal.rec.type == 1) or (FD.Deal.rec.type == 5) )
    /* Купленный металл */
    if (FD.dealpart == 1)
      println(":15B:");
    else
      println(":15C:");
    end;
  elif( (FD.Deal.rec.type == 2) or (FD.Deal.rec.type == 6) )
    /* Проданный металл */
    if (FD.dealpart == 1)
      println(":15C:");
    else
      println(":15B:");
    end;
  end;
  /* Количество металла */
  //  msgbox(FD.Deal.rec.id);
  //    msgbox(plat_dil5(FD.Deal.rec.id,4813,1,"baseamount"));

//  println(":32F:FOZ" + NumToStr(FD.nfi_baseactiv.rec.amount, 2));

  ssu = readNoteForObject( IIF( ((FD.Deal.rec.type != 5) AND (FD.Deal.rec.type != 6)), OBJTYPE_FXOPER_DV, OBJTYPE_OUTOPER_DV ),
                           UniID( FD.deal, IIF( ((FD.Deal.rec.type != 5) AND (FD.Deal.rec.type != 6)), OBJTYPE_FXOPER_DV, OBJTYPE_OUTOPER_DV )),  //SVE
                           IIF( Y == 2, 105, 101));

//   ssu = string (plat_dil5(Fd.Deal.rec.id, FD.Deal.rec.dockind, 1, "baseamount"));

  if( GetFiidDefinition(baseactiv) == "GOLD" )
  //println(":32F:FOZ" + NumToStr(ssu, 2));
  println(":32F:FOZ" + NumToStr(ssu, 3));  //SVE
  else
  //println(":32F:GOZ" + NumToStr(ssu, 2));
    println(":32F:GOZ" + NumToStr(ssu, 3));  //SVE
  end;


  /* Получатель/поставщик металла */
  //println(":87A:" + GetField_87A15(FD.Deal.rec.ID, FD.Deal.rec.dockind, IIF(Y == 2, 3, 1)));  //SVE
  if ( FD.IsBuy() )
    println(":87A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.receiverbankid, PTCK_SWIFT));
  else
    println(":87A:" + ПолучитьКодСубъекта(FD.v_pm_BA.rec.payerbankid, PTCK_SWIFT));
  end;

  /* Выполнение */
  if( (FD.Deal.rec.type == 1) or ((FD.Deal.rec.type == 5) and (FD.Dealpart == 1)) or  ((FD.Deal.rec.type == 6) and (FD.Dealpart == 2)) )  //SVE
    //println(":34P:" + DateToStrYYMMDD(FD.nfi_baseactiv.rec.paydate) + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.cost, 2));  //SVE
    println(":34P:" + DateToStrYYMMDD(FD.v_rm_CA.rec.date) + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(FD.v_pm_CA.rec.amount, 2));
  elif( (FD.Deal.rec.type == 2) or ((FD.Deal.rec.type == 6) and (FD.Dealpart == 1)) or ((FD.Deal.rec.type == 5) and (FD.Dealpart == 2)) )  //SVE
    //println(":34R:" + DateToStrYYMMDD(FD.nfi_baseactiv.rec.paydate) + ПолучитьКодФинИн(FD.nfi_baseactiv.rec.pricefiid, null, FICK_ISOSTRING) + NumToStr(FD.nfi_baseactiv.rec.cost, 2));  //SVE
    println(":34R:" + DateToStrYYMMDD(FD.v_rm_CA.rec.date) + ПолучитьКодФинИн(contractiv, null, FICK_ISOSTRING) + NumToStr(FD.v_pm_CA.rec.amount, 2));
  end;
  /* Счет в банке */
//  println(":57A:" + GetField_57A(FD.Deal.rec.ID, FD.Deal.rec.type));
/* SVE
  if( GetIsNotResident(FD.Deal.rec.Contractor) )
     println(":57A:" + trim(CodeSWIFT_Contr));
  elif( ПолучитьКодФинИн(FD.ВалютаОбязательства(), null, FICK_ISOSTRING) == "RUB" )
//     println(":57D:" + GetField_57D_305( FD ));
     println(":57D:" + GetField_57D(FD.Deal.rec.id, FD.Deal.rec.dockind, IIF(Y == 2, 3, 1), FD.IsBuy()));
  else
     println(":57A:" + trim(CodeSWIFT_Contr));
  end;
*/
  if ( FD.IsBuy() )
    println(":57A:" + ПолучитьКодСубъекта(FD.v_pm_CA.rec.receiverbankid, PTCK_SWIFT));
  else
    println(":57A:" + ПолучитьКодСубъекта(FD.v_pm_CA.rec.payerbankid, PTCK_SWIFT));
  end;

end;

macro DV_MsgSWIFT_MT600( DealID:integer,dockind:integer, fl ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var stat, cmd, query, MenuResult, Text, Msg;
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  //var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);  //SVE
  
  array MenuItems;
  //if(FD.Deal.rec.dvkind != 6) SVE 
  if(dockind != 199)

    var FD = DVFirstDocFXDeal(dockind, DealID);
    FD.ПлатежТреб();
    FD.ПлатежОб();
      

    ReportFileName = GetTxtFileName(FD.DealCode() + "_MT600");
    if( Open(ReportOutFile, ReportFileName) == false )
      errcode = status(errtext);
      MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
      return 1;
    end;
    SetOutput(ReportFileName);
    message("Печать...");

    PrintCommonMT600(FD, 600, 0);

    SetOutput(NULL, true);
    close(ReportOutFile);
    MenuItems[0] = "Печатать сообщение";
    MenuItems[1] = "Отправить в SWIFT";

//  var MenuResult = Menu(MenuItems, "Выбрать действие");

    if (fl == 1 )
      MenuResult=1;
    else
      MenuResult = Menu(MenuItems, "Выбрать действие");
    end;

      if( MenuResult == 0 )
        ViewFile(ReportOutFile);
      elif( MenuResult == 1 )
        Text;
        Msg = "";
        Open(ReportInFile, ReportFileName);

        while(next(ReportInFile))
           Msg = Msg + ReportInFile.str+"\n";
        end;

        close(ReportInFile);
        query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
        cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT600");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_Num", RSDBP_IN, 0);
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.Execute();
        stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
      end;
  else
    var i = 0;
    while(i != 2)
      i = i + 1;

      /*Авторский финт ушами*/
      FD = null;
      FD = DVFirstDocNDeal(dockind, DealID, i);
      FD.ПлатежТреб();
      FD.ПлатежОб();

      ReportFileName = GetTxtFileName(FD.DealCode() + "_MT600");
      if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
      end;
      SetOutput(ReportFileName);
      message("Печать...");

      PrintCommonMT600(FD, 600, i);

      SetOutput(NULL, true);
      close(ReportOutFile);

      MenuItems[0] = "Печатать сообщение по " + i + "-й части";
      MenuItems[1] = "Отправить в SWIFT сообщение по " + i + "-й части";

//  var MenuResult = Menu(MenuItems, "Выбрать действие");

      if (fl == 1 )
        MenuResult=1;
      else
        MenuResult = Menu(MenuItems, "Выбрать действие");
      end;

      if( MenuResult == 0 )
        ViewFile(ReportOutFile);
      elif( MenuResult == 1 )
        Text;
        Msg = "";
        Open(ReportInFile, ReportFileName);

        while(next(ReportInFile))
          Msg = Msg + ReportInFile.str+"\n";
        end;

        close(ReportInFile);

        query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?,?);\n end; ";
        cmd = RSDCommand(query);
        cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
        cmd.AddParam("p_KindMes", RSDBP_IN, "MT600");
        cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
        cmd.AddParam("p_Msg", RSDBP_IN, Msg);
        cmd.AddParam("p_Num", RSDBP_IN, i);
        cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
        cmd.Execute();

        stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
        Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
        MsgBox(Text);
      end;
    end;
  end;
  return RetVal;
end;

macro DV_MsgSWIFT_MT305_Send( DealID:integer ):integer

  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Text;
  var Msg = "";
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;


  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);
  FD.ПлатежТреб();
  FD.ПлатежОб();

  ReportFileName = GetTxtFileName(FD.DealCode() + "_MT305");
  if( Open(ReportOutFile, ReportFileName) == false )
    errcode = status(errtext);
    MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
    return 1;
  end;
  SetOutput(ReportFileName);

  message("Печать...");

  PrintCommonMT305(FD, 305);

  SetOutput(NULL, true);
  close(ReportOutFile);


  Open(ReportInFile, ReportFileName);

  while(next(ReportInFile))
    Msg = Msg + ReportInFile.str+"\n";
  end;

  close(ReportInFile);
  var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?);\n end; ";
  var cmd = RSDCommand(query);
  cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
  cmd.AddParam("p_KindMes", RSDBP_IN, "MT305");
  cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
  cmd.AddParam("p_Msg", RSDBP_IN, Msg);
  cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
  cmd.Execute();
  var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
  Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
  MsgBox(Text);

  return RetVal;
end;


macro DV_MsgSWIFT_MT360_Send( DealID:integer ):integer
  var RetVal:integer = 0;
  var ReportFileName, errcode, errtext;
  var Text;
  var Msg = "";
  FILE ReportOutFile() txt write; /*файл вывода*/
  FILE ReportInFile() txt;

  var FD = DVFirstDocNDeal(DL_DVNDEAL, DealID);

     ReportFileName = GetTxtFileName(FD.DealCode() + "_MT360");
     if( Open(ReportOutFile, ReportFileName) == false )
        errcode = status(errtext);
        MsgBox("Ошибка при открытии файла |"+ ReportFileName +"|(" + errcode + ") " + errtext);
        return 1;
     end;
     SetOutput(ReportFileName);

     message("Печать...");

     PrintCommonMT360_MT361(FD, 360);

     SetOutput(NULL, true);
     close(ReportOutFile);

     Open(ReportInFile, ReportFileName);

     while(next(ReportInFile))
        Msg = Msg + ReportInFile.str+"\n";
     end;

     close(ReportInFile);
     var query = " begin\n ? := RSP_SECURITY.CREATEPAYM4SWIFT(?,?,?,?);\n end; ";
     var cmd = RSDCommand(query);
     cmd.AddParam("p_Stat", RSDBP_OUT, V_INTEGER);
     cmd.AddParam("p_KindMes", RSDBP_IN, "MT360");
     cmd.AddParam("p_DraftID", RSDBP_IN, DealID);
     cmd.AddParam("p_Msg", RSDBP_IN, Msg);
     cmd.AddParam("p_Text", RSDBP_OUT, V_STRING, Text);
     cmd.Execute();
     var stat = SQL_ConvTypeInteger(cmd.value("p_Stat"));
     Text = SQL_ConvTypeInteger(cmd.value("p_Text"));
     MsgBox(Text);

  return RetVal;
end;
