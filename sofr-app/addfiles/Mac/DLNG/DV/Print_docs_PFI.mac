
//IMPORT total;
IMPORT LoansFind, dl_activex, VBAConst, dlwreps, dv_categ;
IMPORT globals/*,replib,*/;

/*CSA*/
IMPORT oralib, likepy;

MACRO СформироватьТребУплатыМаржСуммы(CSA_ID, Pay_ID)
  
  private CONST TemplateName = "PFI_1_margpay_treb.dotx";
  var sql;

    sql = "select partbank.t_shortname ourshname, nvl(adr.t_adress, chr(1)) adr , csa.t_code code, part.t_shortname shname, ";
    sql = sql + " csa.t_begdate begdate, pm.t_date paydt , ";
    //sql = sql + " replace (trim(to_char(pm.t_sumpay,'999G999G999G999G999D00')), ' ', ',') sumpay"; //разделитель запятые    ";
    sql = sql + " trim(to_char(pm.t_sumpay,'999G999G999G999G999D00')) sumpay"; //разделитель пробелы    ";
    sql = sql + " ,fi.t_ccy val, partbank.t_shortname rcvbank, ";
    sql = sql + " bic.t_code bic ,inn.t_code inn, partbank.t_name ourname, part_corr.t_name corname, swift_corr.t_code swift, ";
    sql = sql + " schem.t_coraccount coracc,  ";
    sql = sql + " schem.t_account schemacc, paym.t_receiveraccount rcvacc   ";
    sql = sql + " FROM ddvcsapm_dbt pm ";
    sql = sql + " inner join ddvcsa_dbt csa on pm.t_csaid=csa.t_csaid  ";
    sql = sql + " inner join   dparty_dbt part on csa.t_partyid = part.t_partyid ";
    sql = sql + " inner join   dfininstr_dbt fi on pm.t_sumpaycur = fi.t_fiid  ";
    sql = sql + " left join    dadress_dbt adr   on (adr.t_partyid=1 and adr.t_type=1) ";
    sql = sql + " left join    dpmpaym_dbt paym on (paym.t_documentid=pm.t_pmid and paym.t_dockind=4627) ";
    sql = sql + " left join    dparty_dbt partbank on paym.t_receiverbankid=partbank.t_partyid ";
    sql = sql + " left join    dobjcode_dbt inn on (inn.t_objectid=partbank.t_partyid and inn.t_codekind = 16 and inn.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')) ";
    sql = sql + " left join    dobjcode_dbt bic on (bic.t_objectid=partbank.t_partyid and bic.t_codekind = 3 and bic.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')) ";
    sql = sql + " left join    dpmprop_dbt prop on (prop.t_paymentid =  paym.t_paymentid and prop.t_debetcredit =0) ";
    sql = sql + " left join    dcorschem_dbt schem  on (schem.t_Number = prop.t_corschem and schem.t_FIID = paym.t_fiid and schem.t_fi_kind = 1) ";
    sql = sql + " left join    dparty_dbt part_corr on part_corr.t_partyid = schem.t_corrid ";
    sql = sql + " left join    dobjcode_dbt swift_corr on (swift_corr.t_objectid=part_corr.t_partyid and swift_corr.t_codekind = 6 and swift_corr.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')) ";
    sql = sql + " where pm.t_csaid = :csaid and pm.t_pmid = :pmid ";     
    
    sql = ExecSqlSelect(sql,MakeArray(SqlParam("csaid", CSA_ID),SqlParam("pmid", Pay_ID)), false);
   
    while (sql.moveNext())
          
       println(TemplateName); //Имя файла-шаблона
       println( "TR_", CSA_ID+"_"+Pay_ID, ".doc" ); // Генерируем имя результирующего файла документа

      [~DateCntr0];
      println (date(sql.value("begdate")):f);

      [~NumCntr0];
      println(sql.value("code"));

      [~CurDat];
      println ({curdate}:f);

      [~NameAddrReceiver];
      println (sql.value("ourshname")+", "+sql.value("adr")); //РСХБ

      [~NumCntr];
      println(sql.value("code"));

      [~Contractor];
      println (sql.value("shname")); 

      [~DateCntr];
      println (date(sql.value("begdate")):f);

      [~Dat];
      println (date(sql.value("paydt")):f); 
      
      [~Sum];
      println (sql.value("sumpay"));       

      [~Val];
      println (sql.value("val"));

      //Реквизиты
      [~Rekv];
      if (sql.value("val") == "RUB")
        println ("Корреспондентский счет 30101810200000000111 в ГУ Банка России по ЦФО ");
        println ("БИК 044525111 ");
        println ("Лицевой счет "+sql.value("rcvacc"));
      else
        println ("NAME: "+sql.value("corname"));
        println ("SWIFT: "+sql.value("swift"));
        println ("ACCOUNT NUMBER: "+sql.value("coracc"));
      end;

      [~NameOurBank];
      println (sql.value("ourname")); 
      
/*      
      [~LeaderName];
      println ("LeaderName"); 
      
      [~LeaderPos];
      println ("LeaderPos"); 
*/
     end;

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);
   return 0;

   onError (err)
      if(err.Code!=0)
         WordError(err);
         Exit(1);
      end; 
 END;


MACRO СформироватьУведомление_о_Процентах(CSA_ID, Pay_ID)
  
  private CONST TemplateName = "PFI_2_uved_proc.dotx";
  var sql;

    sql = "select pm.t_sumpay sumpay, pm.t_sumtotal sumtotal, csa.t_code code, csa.t_begdate begdate, part.t_shortname shname, pm.t_date paydt ";
    sql = sql + " ,pm.t_direction direc, fi.t_ccy ccy, adr_cntr.t_adress adrcntr, partbank.t_shortname ourshname, adr.t_adress adr  ";
    /*
    sql = sql + "  ,(select replace (trim(to_char(nvl(sumb.t_eveningsum, 0),'999G999G999G999G999D00')), ' ', ',') from ddvcsash_dbt sumb where sumb.t_CSAID = sash.t_CSAID and sumb.t_dmain = sash.t_dmain - 1) SumBeg,  ";
    sql = sql + " replace (trim(to_char(sash.t_insum,'999G999G999G999G999D00')), ' ', ',') Zach, "; 
    sql = sql + " replace (trim(to_char(sash.t_outsum,'999G999G999G999G999D00')), ' ', ',') Spis, ";
    sql = sql + " replace (trim(to_char(sash.t_eveningsum,'999G999G999G999G999D00')), ' ', ',') SumEnd, ";
    sql = sql + " replace (trim(to_char(sash.t_rate,'999G999G999G999G999D00')), ' ', ',') Rate, ";
    sql = sql + " replace (trim(to_char(sash.t_sumproccalc,'999G999G999G999G999D00')), ' ', ',') RateDay,";
    sql = sql + " (select replace (trim(to_char(sum(sumprocacc.t_sumprocacc),'999G999G999G999G999D00')), ' ', ',') from ddvcsash_dbt sumprocacc where sumprocacc.t_csaid=csa.t_csaid and sumprocacc.t_dmain <= pm.t_date) RateBeg  ";
    */
    sql = sql + "  ,(select trim(to_char(nvl(sumb.t_eveningsum, 0),'999G999G999G999G999D00')) from ddvcsash_dbt sumb where sumb.t_CSAID = sash.t_CSAID and sumb.t_dmain = sash.t_dmain - 1) SumBeg,  ";
    sql = sql + " trim(to_char(sash.t_insum,'999G999G999G999G999D00')) Zach, "; 
    sql = sql + " trim(to_char(sash.t_outsum,'999G999G999G999G999D00')) Spis, ";
    sql = sql + " trim(to_char(sash.t_eveningsum,'999G999G999G999G999D00')) SumEnd, ";
    sql = sql + " trim(to_char(sash.t_rate,'999G999G999G999G999D00')) Rate, ";
    sql = sql + " trim(to_char(sash.t_sumproccalc,'999G999G999G999G999D00')) RateDay,";
    sql = sql + " (select trim(to_char(sum(sumprocacc.t_sumprocacc),'999G999G999G999G999D00')) from ddvcsash_dbt sumprocacc where sumprocacc.t_csaid=csa.t_csaid and sumprocacc.t_dmain <= pm.t_date) RateBeg  ";
    sql = sql + " FROM ddvcsapm_dbt pm  ";
    sql = sql + " inner join ddvcsa_dbt csa on pm.t_csaid=csa.t_csaid ";
    sql = sql + " inner join dparty_dbt part on csa.t_partyid = part.t_partyid ";
    sql = sql + " inner join dparty_dbt partbank on partbank.t_partyid = 1 ";
    sql = sql + " inner join dfininstr_dbt fi on pm.t_sumpaycur = fi.t_fiid ";
    sql = sql + " left join dadress_dbt adr_cntr on csa.t_partyid=adr_cntr.t_partyid ";
    sql = sql + " inner join dadress_dbt adr on (adr.t_partyid=1 and adr.t_type=1)";
    sql = sql + " left join ddvcsash_dbt sash on (pm.t_csaid = sash.t_CSAID and pm.t_date = sash.t_dmain) ";
    sql = sql + " where pm.t_csaid = :csaid and pm.t_pmid  = :pmid ORDER BY adr_cntr.t_type asc fetch first 1 rows only ";

    sql = ExecSqlSelect(sql,MakeArray(SqlParam("csaid", CSA_ID),SqlParam("pmid", Pay_ID)), false);
    while (sql.moveNext())

       println(TemplateName); //Имя файла-шаблона
       println( "PN_", CSA_ID+"_"+Pay_ID, ".doc" ); // Генерируем имя результирующего файла документа

      [~DateCntr];
      println(date(sql.value("begdate")):f);

      [~NumCntr];
      println(sql.value("code"));

      [~CurDat];
      println ({curdate}:f);

      if (sql.value("direc") == 1) 
          [~NameAddrReceiver];
          println (sql.value("shname")+", "+sql.value("adrcntr")); //контрагент
          
          [~NameAddrPayer];
          println (sql.value("ourshname")+", "+sql.value("adr")); //РСХБ

      elif (sql.value("direc") == 0)
          [~NameAddrReceiver];
          println (sql.value("ourshname")+", "+sql.value("adr")); //РСХБ
          
          [~NameAddrPayer];
         println (sql.value("shname")+", "+sql.value("adrcntr")); //контрагент

      end;
    /*  
      [~CalcProc];
      println ("CalcProc"); //???
    */  
      [~NumCntr2];
      println (sql.value("code"));
      
      [~DateCntr2];
      println (date(sql.value("begdate")):f);
      
      [~Contractor];
      println (sql.value("shname")); 
      
      [~Dat];
      println (date(sql.value("paydt")):f); 
      
      [~SumBeg];
      println (sql.value("SumBeg")); 
      
      [~Zach_Spis];
      println (sql.value("Zach")+" / "+sql.value("Spis")); 
      
      [~SumEnd];
      println (sql.value("SumEnd")); 
      
      [~Rate];
      println (sql.value("Rate")); 
      
      [~RateDay];
      println (sql.value("RateDay")); 
      
      [~RateBeg];
      println (sql.value("RateBeg")); 
      
      [~Curr];
      println (sql.value("ccy")); 
      
   /*   
      [~LeaderName];
      println ("LeaderName"); //???
      
      [~LeaderPos];
      println ("LeaderPos"); //???
   */
     end;

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);
   return 0;

   onError (err)
      if(err.Code!=0)
         WordError(err);
         Exit(1);
      end; 
 END;


private macro DV_LZ( num, len:integer ):string
   var RetVal:string = "";
   var str1:string = "", len1:integer = 0;

   str1 = trim(string(num));
   len1 = strlen(str1);
   if( len1 >= len )
      RetVal = str1;
   else
      RetVal = mkstr("0", len-len1) + str1;
   end;

   return RetVal;
end;
 
private macro DateToStrDDMMYYYY( pDate:date ):string
  var Day:integer = 0, Month:integer = 0, Year:integer = 0;
  DateSplit(pDate, Day, Month, Year);
  return DV_LZ(Day, 2) + DV_LZ(Month, 2) + DV_LZ(Year, 4);
end;

MACRO ПодтверждениеСделки(Deal_ID)

  var TemplateName;
  private CONST Bank = "АО 'Россельхозбанк'";
  var sql;
  
sql = " select deal.t_id dealid, deal.t_dockind dockind, deal.t_code code, nfi.t_exectype exectype, deal.t_type napr, part.t_shortname shname, nvl(RSI_RSBPARTY.PT_GetPartyCode(part.t_partyid, 3), CHR(1)) BIKParty, nvl(genagr.t_code, CHR(1)) contr, genagr.t_start datcontr, deal.t_date begdate, fipay.t_ccy curr,  ";
sql = sql + " nvl((select t_account from (select t_account from dmcaccdoc_dbt accdoc where accdoc.t_catid = 605 and accdoc.t_iscommon != chr(88) and accdoc.t_docid = deal.t_id and accdoc.t_dockind = deal.t_dockind order by t_activatedate desc) where rownum=1), chr(1)) acc, ";
//sql = sql + " replace (trim(to_char(decode (nfi.t_cost, 0, nfi.t_amount*nfi.t_price, nfi.t_cost ),'999G999G999G999G999D00')), ' ', ',') SumVal, 
sql = sql + " trim(to_char(decode (nfi.t_cost, 0, nfi.t_amount*nfi.t_price, nfi.t_cost ),'999G999G999G999G999D00')) SumVal,  "; //пробелы
//sql = sql + " replace (trim(to_char(nfi.t_amount,'999G999G999G999G999D00')), ' ', ',') SumBaseVal ,--"; //разделитель запятые    
sql = sql + " trim(to_char(nfi.t_amount,'999G999G999G999G999D00')) SumBaseVal ,"; //разделитель пробелы    
sql = sql + " fibase.t_ccy currbase,  ";
sql = sql + " trim(to_char(nfi.t_price, '9999990D9999')) Rate, nfi.t_execdate paydt, nfi.t_supldate calcdate, nvl(paym1.t_receiveraccount, CHR(1)) rcvacc, nvl(paym2.t_payeraccount, CHR(1)) pracc, ";
sql = sql + " fibase.t_name currbasename, nvl(fipaym1.t_name, CHR(1)) paymcurrname1, nvl(fipaym1.t_ccy, CHR(1)) paymcurr1, nvl(fipaym2.t_name, CHR(1)) paymcurrname2, nvl(fipaym2.t_ccy, CHR(1)) paymcurr2, nvl(s1.t_account, CHR(1)) acc1, nvl(s1.t_bankname, CHR(1)) bank1, nvl(s1.t_corracc, CHR(1)) corracc1, ";
sql = sql + " fipay.t_name currname, nvl(s2.t_account, CHR(1)) acc2, nvl(s2.t_bankname, CHR(1)) bank2, nvl(s2.t_corracc, CHR(1)) corracc2 ";
//sql = sql + " nvl(schem.t_coraccount, CHR(1)) corr_acc, nvl(part_corr.t_name, CHR(1)) corr_name, nvl(swift_corr.t_code, CHR(1)) corr_swift  ";
sql = sql + " FROM ddvndeal_dbt deal  ";
sql = sql + " inner join ddvnfi_dbt nfi on deal.t_id=nfi.t_dealid ";
sql = sql + " inner join dparty_dbt part on deal.t_contractor=part.t_partyid ";
sql = sql + " inner join dfininstr_dbt fibase on nfi.t_fiid=fibase.t_fiid ";
sql = sql + " inner join dfininstr_dbt fipay on nfi.t_pricefiid=fipay.t_fiid ";
sql = sql + " left join  ddl_genagr_dbt genagr on deal.t_genagrid=genagr.t_genagrid  ";
sql = sql + " left join  dpmautoac_dbt a1 on (a1.t_partyid=deal.t_contractor and a1.t_servicekind=15 and a1.t_fiid = nfi.t_fiid) ";
sql = sql + " left join  dsettacc_dbt s1 on (s1.t_partyid=a1.t_partyid and s1.t_settaccid=a1.t_settaccid) ";
sql = sql + " left join  dpmautoac_dbt a2 on (a2.t_partyid=deal.t_contractor and a2.t_servicekind=15 and a2.t_fiid = nfi.t_pricefiid ) ";
sql = sql + " left join  dsettacc_dbt s2 on (s2.t_partyid=a2.t_partyid and s2.t_settaccid=a2.t_settaccid)  ";
sql = sql + " left join  dpmpaym_dbt paym1 on (paym1.t_documentid=deal.t_id and paym1.t_dockind=199 and paym1.t_payer !=1) ";
sql = sql + " left join  dfininstr_dbt fipaym1 on paym1.t_fiid=fipaym1.t_fiid ";
sql = sql + " left join  dpmpaym_dbt paym2 on (paym2.t_documentid=deal.t_id and paym2.t_dockind=199 and paym2.t_receiver !=1) ";
sql = sql + " left join  dfininstr_dbt fipaym2 on paym2.t_fiid=fipaym2.t_fiid ";
//sql = sql + " left join  dpmprop_dbt prop on (prop.t_paymentid =  paym.t_paymentid and prop.t_debetcredit =0)  ";
//sql = sql + " left join  dcorschem_dbt schem  on (schem.t_Number = prop.t_corschem and schem.t_FIID = paym.t_fiid and schem.t_fi_kind = 1)  ";
//sql = sql + " left join  dparty_dbt part_corr on part_corr.t_partyid = schem.t_corrid  ";
//sql = sql + " left join  dobjcode_dbt swift_corr on (swift_corr.t_objectid = part_corr.t_partyid and swift_corr.t_codekind = 6 and swift_corr.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')) ";
sql = sql + " where   deal.t_id = :dealid "; 

    sql = ExecSqlSelect(sql,MakeArray(SqlParam("dealid", Deal_ID)), false);
    while (sql.moveNext())
	
      if (sql.value("exectype") == 0) // расчетный
	     TemplateName = "PFI_3_podtver.dotx";
      else
	     TemplateName = "PFI_3_podtver_p.dotx";
      end;
           
      println(TemplateName); //Имя файла-шаблона
      println( "PODTV_", Deal_ID+".doc" ); // Генерируем имя результирующего файла документа

      [~NumDoc];
      println (DateToStrDDMMYYYY(date(sql.value("begdate"))) + "-" + sql.value("code"));
      
      [~DateSdel_1];
      println (date(sql.value("begdate")):f); 
      
      [~Contractor];
      println (sql.value("shname"));

      [~NumCntr];
      println(sql.value("contr") + " от " + date(sql.value("datcontr")) + " ");

      [~DateSdel_2];
      println (date(sql.value("begdate")):f); 
      
      [~Curr];
      println (sql.value("curr"));       

      if ((sql.value("napr") == 1) or (sql.value("exectype") == 0) ) //направление - покупка или тип исполнения расчетный
         [~SumVal];
         println (sql.value("SumVal") + " " + sql.value("curr"));  

         [~SumBaseVal];
         println (sql.value("SumBaseVal") + " " + sql.value("currbase")); 
      else 
         [~SumVal];
         println (sql.value("SumBaseVal") + " " + sql.value("currbase")); 

         [~SumBaseVal];
         println (sql.value("SumVal") + " " + sql.value("curr"));  
      end;
	  
	  [~Rate];
      println (sql.value("Rate") + " " + sql.value("curr") + "/" + sql.value("currbase"));
      
      [~Curr_2_2];
      println (sql.value("curr"));

      [~CurrBase_2_2];
      println (sql.value("currbase"));
	  
	  [~Bank];
      println (Bank);

      [~DatePay];
      println (date(sql.value("paydt")):f);

      [~CurrBaseName];
      println (sql.value("currbasename"));

      [~CurrBaseName_2];
      println (sql.value("currbasename"));

      [~Curr_3];
      println (sql.value("curr"));

      [~CurrBase_3];
      println (sql.value("currbase"));
	  
      if (sql.value("napr") == 2 ) //направление - продажа
      //Вариант для расчетной валюты. Для базовой валюты Customer и Saler должны поменяться местами
          [~Customer]; 
          println (sql.value("shname"));
    
          [~Saler];
          println (Bank);

      elif (sql.value("napr") == 1 ) //направление -покупка

          [~Customer]; 
          println (Bank);
    
          [~Saler];
          println (sql.value("shname"));

      end;

      [~DateOc];
      println (date(sql.value("calcdate")):f);

      //Реквизиты  
      [~Side1Details];
      if (sql.value("exectype") == 1) // поставочный
         println ("Для платежей в валюте "+sql.value("paymcurrname1") + ":");
         println ("Корреспондентский счет 30101810200000000111 в ГУ Банка России по ЦФО ");
         println ("БИК: 044525111 ");
         println ("Лицевой счет: "+sql.value("rcvacc"));
      else
         println ("Для платежей в валюте "+sql.value("paymcurrname2") + ":");
         println ("Корреспондентский счет 30101810200000000111 в ГУ Банка России по ЦФО ");
         println ("БИК: 044525111 ");
         println ("Лицевой счет: "+sql.value("acc"));   
      end;
      
	  [~Side2Details];
      if ((sql.value("napr") == 1) or (sql.value("exectype") == 0) ) //направление - покупка или тип исполнения расчетный
        println ("Для расчетов в валюте " + sql.value("currname"));
        println ("Счет: " + sql.value("acc2"));
        println ("В банке: " + sql.value("bank2"));
        println ("БИК: " + sql.value("BIKParty"));
        println ("К/счет: " + sql.value("corracc2"));
      elif (sql.value("napr") == 2 ) //направление -продажа
        println ("Для расчетов в валюте " + sql.value("currbasename"));
        println ("Счет: " + sql.value("acc1"));
        println ("В банке: " + sql.value("bank1"));
        println ("БИК: " + sql.value("BIKParty"));
        println ("К/счет: " + sql.value("corracc1"));
      end; 
		
      [~Contractor1]; 
      println (sql.value("shname"));
      
      [~TypeSdel];
      if (sql.value("exectype") == 0)
         println ("Сделка расчетный валютный форвард");
      else
         println ("Сделка поставочный валютный форвард");	  
      end;
	  
	  [~Post]; 
      println ("\nДиректор Департамента операций на финансовых рынках");

     end;

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);
   return 0;

   onError (err)
      if(err.Code!=0)
         WordError(err);
         Exit(1);
      end; 
 END;

MACRO СоглашениеОНеттинге(DealNmb, SignDate:Date)

  private CONST TemplateName = "PFI_4_sogl_nett.dotx";
  var sql, sql_deal, sql_tr_ob, sql_sum_prek, sql_val_prek, sql_pay, deals="", sum_tr="", sum_ob="";
  var sum_prek_tr="", sum_prek_ob="", sum_payA="", sum_payB="", fiid=0;
  var rekv_klnt_cur : TArray = TArray();
  var rekv_klnt_acc : TArray = TArray();
  var rekv_klnt_bnk : TArray = TArray();
  var rekv_klnt_kor_acc : TArray = TArray();
  var rekv_klnt_bik : TArray = TArray();
  var rekv_bank_cur : TArray = TArray();
  var rekv_bank_acc : TArray = TArray();
  var rekv_bank_bnk : TArray = TArray();
  var rekv_bank_swift : TArray = TArray();
  var rekv_bank_bik : TArray = TArray();
  var rekv_bank_rcv_acc : TArray = TArray();
  var rekv_bank_inn : TArray = TArray();
  var our_i=1, klnt_i=1;
  var i=1, j=1;
 
    //sql = " select nvl(genagr.t_code, chr(1)) contr, nvl(to_char(genagr.t_start), chr(1)) datcontr, part.t_shortname shname, ";
    sql = " select nvl(genagr.t_code, chr(1)) contr, genagr.t_start datcontr, part.t_shortname shname, ";
    sql = sql + " nvl(adr_cntr.t_adress, chr(1)) adrcntr, net.t_valuedate paydt ";
    sql = sql + " from ddl_nett_dbt net  ";
    sql = sql + " inner join dparty_dbt part on net.t_contractor = part.t_partyid ";
    sql = sql + " left join ddl_genagr_dbt genagr on net.t_genagrid = genagr.t_genagrid ";
    sql = sql + " left join dadress_dbt adr_cntr on net.t_contractor = adr_cntr.t_partyid ";
    sql = sql + " where   net.t_dealnumber = :dealnmb and net.t_signingdate = :sigdt ORDER BY adr_cntr.t_type asc fetch first 1 rows only ";   
 
    sql = ExecSqlSelect(sql,MakeArray(SqlParam("dealnmb", DealNmb),SqlParam("sigdt", SignDate)), false);
    while (sql.moveNext())
           
       println(TemplateName); //Имя файла-шаблона
       println( "Sogl_nett_", DealNmb+".doc" ); // Генерируем имя результирующего файла документа

     [~test_colont];
      println("верхний колонтитул ");

      [~NumCntr];
      println(sql.value("contr"));

      [~DateCntr];
      println(substr(string(sql.value("datcontr")),1,10));
      
      [~CurDat];
      println ({curdate}:f);

      [~NameAdrrConrtagent];
      println (sql.value("shname")+" "+sql.value("adrcntr")); 

          sql_deal = "select distinct deal.t_code dealnum, deal.t_date dealdt from ddl_nett_dbt net, dpmlink_dbt lnk, dpmpaym_dbt paym, ddvndeal_dbt deal ";
          sql_deal = sql_deal + " where lnk.t_dockind = 140 and lnk.t_documentid = net.t_nettingid ";
          sql_deal = sql_deal + " and lnk.t_initialpayment = paym.t_paymentid  ";
          sql_deal = sql_deal + " and paym.t_dockind=deal.t_dockind and paym.t_documentid=deal.t_id ";
          sql_deal = sql_deal + " and net.t_dealnumber = :dealnmb and net.t_signingdate = :sigdt  ";   

          sql_deal = ExecSqlSelect(sql_deal,MakeArray(SqlParam("dealnmb", DealNmb),SqlParam("sigdt", SignDate)), false);
          while (sql_deal.moveNext())
            //deals = deals + sql_deal.value("dealnum")+" от "+substr(string(sql_deal.value("dealdt")),1,10)+", " ;
            deals = deals + sql_deal.value("dealnum")+" от "+string(date(sql_deal.value("dealdt")):f)+", " ;
          end;
          if (StrLen (deals) > 1)
            deals = substr(deals,1,StrLen (deals)-2) ;
          end;

      [~NumsSdel];
      println (deals); 
     
      [~DatePay];
      println(date(sql.value("paydt")):f);

      [~NumCntr_1];
      println(sql.value("contr"));

      [~DateCntr_1];
      println(substr(string(sql.value("datcontr")),1,10));
      
      [~NumsSdel1];
      println (deals);

      [~DatePay1];
      println(date(sql.value("paydt")):f);
     
      [~Contractor];
      println (sql.value("shname")); 

      [~DatePay_1];
      //println (substr(string(sql.value("paydt"):f),1,10)); 
      println(date(sql.value("paydt")):f);

        //  sql_tr_ob = " select fi.t_ccy val, decode(lnk.t_ipsign,'-', 'ob', '+', 'tr' ) napr, sum (lnk.t_amount) summ";
        sql_tr_ob = " select fi.t_ccy val, decode(lnk.t_ipsign,'-', 'ob', '+', 'tr' ) napr, ";
        //sql_tr_ob = sql_tr_ob + " replace (trim(to_char(sum (lnk.t_amount),'999G999G999G999G999D00')), ' ', ',') summ"; //разделитель запятые
        sql_tr_ob = sql_tr_ob + " trim(to_char(sum (lnk.t_amount),'999G999G999G999G999D00')) summ"; //разделитель пробелы
          sql_tr_ob = sql_tr_ob + " from ddl_nett_dbt net, dpmlink_dbt lnk, dfininstr_dbt fi ";
          sql_tr_ob = sql_tr_ob + " where lnk.t_dockind = 140 and lnk.t_documentid = net.t_nettingid and lnk.t_fiid=fi.t_fiid ";
          sql_tr_ob = sql_tr_ob + " and net.t_dealnumber = :dealnmb and net.t_signingdate = :sigdt ";
          sql_tr_ob = sql_tr_ob + " group by fi.t_ccy, lnk.t_ipsign order by fi.t_ccy ";
          
          sql_tr_ob = ExecSqlSelect(sql_tr_ob,MakeArray(SqlParam("dealnmb", DealNmb),SqlParam("sigdt", SignDate)), false);
          while (sql_tr_ob.moveNext())
            if (sql_tr_ob.value("napr")== "ob")
               // sum_ob = sum_ob+ money(sql_tr_ob.value("summ"))+" "+ sql_tr_ob.value("val")+", ";
                sum_ob = sum_ob+ sql_tr_ob.value("summ")+" "+ sql_tr_ob.value("val")+", ";
            elif(sql_tr_ob.value("napr")== "tr")
                //sum_tr = sum_tr+ money(sql_tr_ob.value("summ"))+" "+ sql_tr_ob.value("val")+", ";
                sum_tr = sum_tr+ sql_tr_ob.value("summ")+" "+ sql_tr_ob.value("val")+", ";
            end;
          end;
          if (StrLen (sum_ob) > 1)
            sum_ob = substr(sum_ob,1,StrLen (sum_ob)-2) ;
          end;
          if (StrLen (sum_tr) > 1)
            sum_tr = substr(sum_tr,1,StrLen (sum_tr)-2) ;
          end;

      [~Sum1];
      println (sum_ob); 

      [~Sum2];
      println (sum_tr); 

          sql_val_prek = " select val from (select val, count(1) cnt from (select fi.t_fiid val, decode(lnk.t_ipsign,'-', 'ob', '+', 'tr' ) napr ";
          sql_val_prek = sql_val_prek + " from ddl_nett_dbt net, dpmlink_dbt lnk, dfininstr_dbt fi where lnk.t_dockind = 140 and lnk.t_documentid = net.t_nettingid and lnk.t_fiid=fi.t_fiid  ";
          sql_val_prek = sql_val_prek + " and net.t_dealnumber = :dealnmb and net.t_signingdate = :sigdt group by fi.t_fiid, lnk.t_ipsign) group by val) where cnt >1 ";


          sql_val_prek = ExecSqlSelect(sql_val_prek,MakeArray(SqlParam("dealnmb", DealNmb),SqlParam("sigdt", SignDate)), false);
          while (sql_val_prek.moveNext())
                
            sql_sum_prek = " select fi.t_ccy val, decode(lnk.t_ipsign,'-', 'ob', '+', 'tr' ) napr, ";
            //sql_sum_prek = sql_sum_prek + " replace (trim(to_char(sum (lnk.t_amount),'999G999G999G999G999D00')), ' ', ',') summ  ";
            sql_sum_prek = sql_sum_prek + " trim(to_char(sum (lnk.t_amount),'999G999G999G999G999D00')) summ  ";
            sql_sum_prek = sql_sum_prek + " from ddl_nett_dbt net, dpmlink_dbt lnk, dfininstr_dbt fi  ";
            sql_sum_prek = sql_sum_prek + " where lnk.t_dockind = 140 and lnk.t_documentid = net.t_nettingid and lnk.t_fiid=fi.t_fiid  ";
            sql_sum_prek = sql_sum_prek + " and net.t_dealnumber = :dealnmb and net.t_signingdate = :sigdt and fi.t_fiid = :fiid ";
            sql_sum_prek = sql_sum_prek + " group by fi.t_ccy, lnk.t_ipsign order by summ fetch first 1 rows only ";

            sql_sum_prek = ExecSqlSelect(sql_sum_prek,MakeArray(SqlParam("dealnmb", DealNmb),SqlParam("sigdt", SignDate),SqlParam("fiid", sql_val_prek.value("val"))), false);
            while (sql_sum_prek.moveNext())   
                if  (sql_sum_prek.value("napr") == "tr")
                  sum_prek_tr = sum_prek_tr + sql_sum_prek.value("summ")+" "+ sql_sum_prek.value("val")+", ";
                elif (sql_sum_prek.value("napr") == "ob")
                  sum_prek_ob = sum_prek_ob + sql_sum_prek.value("summ")+" "+ sql_sum_prek.value("val")+", ";
                end;
            end;
            
          end;  
          if (StrLen (sum_prek_tr) > 0)
            sum_prek_tr = substr(sum_prek_tr,1,StrLen (sum_prek_tr)-2) ;
          else
            sum_prek_tr = "0.00 RUB";
          end;
          if (StrLen (sum_prek_ob) > 0)
            sum_prek_ob = substr(sum_prek_ob,1,StrLen (sum_prek_ob)-2) ;
          else
            sum_prek_ob = "0.00 RUB";
          end;
          
          [~Sum];
          println (sum_prek_ob);
              
          [~Sum_1];
          println (sum_prek_tr);
       
          sql_pay = " select fi.t_fiid fiid, fi.t_name val, ";
          //sql_pay = sql_pay + " replace (trim(to_char(pay.t_baseamount,'999G999G999G999G999D00')), ' ', ',') summ, ";
          sql_pay = sql_pay + " trim(to_char(pay.t_baseamount,'999G999G999G999G999D00')) summ, ";
          sql_pay = sql_pay + " pay.t_payer payer, pay.t_receiver receiver, pay.t_receiveraccount rcv_acc  ";
          sql_pay = sql_pay + "  , code_swift.t_code swift, nvl(code_bik.t_code, ' ') bik , nvl(inn.t_code, ' ') inn ";
          sql_pay = sql_pay + "  , nvl(decode(pay.t_payer, 1, prop.t_corracc, schem.t_coraccount), chr(1)) kor_acc ";
          sql_pay = sql_pay + "  , nvl(decode(pay.t_payer, 1, part.t_shortname, part_schem.t_name), chr(1)) rcv_bank ";
          sql_pay = sql_pay + "  from ddl_nett_dbt net   ";
          sql_pay = sql_pay + " inner join dpmpaym_dbt pay on (net.t_nettingid = pay.t_documentid and net.t_dockind = pay.t_dockind) ";
          sql_pay = sql_pay + " inner join dpmprop_dbt prop on (prop.t_paymentid = pay.t_paymentid and prop.t_debetcredit = 0) ";
          sql_pay = sql_pay + " inner join dfininstr_dbt fi on pay.t_basefiid=fi.t_fiid ";
          sql_pay = sql_pay + " inner join dparty_dbt part on part.t_partyid = pay.t_receiverbankid ";
          sql_pay = sql_pay + " left join dobjcode_dbt code_bik on (code_bik.t_objectid = pay.t_receiverbankid and code_bik.t_codekind = 3) ";
          sql_pay = sql_pay + " left join dobjcode_dbt inn on (inn.t_objectid=pay.t_receiverbankid and inn.t_codekind = 16 and inn.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')) ";
          sql_pay = sql_pay + " left join dcorschem_dbt schem on (schem.t_Number = prop.t_corschem and schem.t_FIID = pay.t_fiid and schem.t_fi_kind = 1) ";
          sql_pay = sql_pay + " left join dparty_dbt part_schem on part_schem.t_partyid = schem.t_corrid ";
          sql_pay = sql_pay + " left join dobjcode_dbt code_swift on (code_swift.t_objectid = part_schem.t_partyid and code_swift.t_codekind = 6) ";
          sql_pay = sql_pay + " where net.t_dealnumber = :dealnmb and net.t_signingdate = :sigdt ";
       
          sql_pay = ExecSqlSelect(sql_pay,MakeArray(SqlParam("dealnmb", DealNmb),SqlParam("sigdt", SignDate)), false);
          while (sql_pay.moveNext())
                if (sql_pay.value("payer") != 1) //если плательшик -клиент, реквизиты банка
                  sum_payB = sum_payB + sql_pay.value("summ")+" "+ sql_pay.value("val")+", ";
                  
                  rekv_bank_bik(our_i) = sql_pay.value("bik");
                  rekv_bank_cur(our_i) = sql_pay.value("val");
                  rekv_bank_rcv_acc(our_i) = sql_pay.value("rcv_acc");
                  rekv_bank_bnk(our_i) = sql_pay.value("rcv_bank");
                  rekv_bank_swift(our_i) = sql_pay.value("swift");
                  rekv_bank_inn(our_i) = sql_pay.value("inn");
                  rekv_bank_acc(our_i) = sql_pay.value("kor_acc");
                  
                  our_i = our_i + 1; 
                else //иначе реквизиты клиента
                  sum_payA = sum_payA + sql_pay.value("summ")+" "+ sql_pay.value("val")+", "; 
                  
                  rekv_klnt_bik(klnt_i) = sql_pay.value("bik");
                  rekv_klnt_cur(klnt_i) = sql_pay.value("val");
                  rekv_klnt_acc(klnt_i) = sql_pay.value("rcv_acc");
                  rekv_klnt_bnk(klnt_i) = sql_pay.value("rcv_bank");
                  rekv_klnt_kor_acc(klnt_i) = sql_pay.value("kor_acc");
                  klnt_i = klnt_i + 1; 
                end;
                
          end;
          if (StrLen (sum_payA) > 0)
            sum_payA = substr(sum_payA,1,StrLen (sum_payA)-2) ;
          else
            sum_payA = "0.00 RUB";
          end;
          if (StrLen (sum_payB) > 0)
            sum_payB = substr(sum_payB,1,StrLen (sum_payB)-2) ;
          else
            sum_payB = "0.00 RUB";
          end;

      [~Sum_2A];
      println (sum_payA);
      
      [~Sum_2B];
      println (sum_payB);

      //Реквизиты для платежей 
       [~OurRekv];
       //for (j, 1, our_i-1)
       while (j < our_i)
         println("Для платежей в валюте "+rekv_bank_cur(j)+":");
        if (rekv_bank_cur(j) == "Российский рубль")
         println("Корреспондентский счет "+rekv_bank_acc(j)+" в "+rekv_bank_bnk(j)) ;
         println("БИК "+rekv_bank_bik(j)+", ИНН "+rekv_bank_inn(j));
         println ("Лицевой счет "+rekv_bank_rcv_acc(j));
        else
         println("NAME: "+rekv_bank_bnk(j)+" SWIFT: "+rekv_bank_swift(j)+" ACCOUNT NUMBER: "+rekv_bank_acc(j));
        end;
        j = j + 1;
       end;
       j = 1;
       
       [~KlntRekv];
       while (j < klnt_i)
        println("Для платежей в валюте "+rekv_klnt_cur(j)+":");
        if (rekv_klnt_cur(j) == "Российский рубль")
         println("Р/С № "+rekv_klnt_acc(j)+" в "+rekv_klnt_bnk(j)); 
         println("К/С # "+rekv_klnt_kor_acc(j)+", БИК "+rekv_klnt_bik(j));
        else
         println("Счет "+rekv_klnt_acc(j)+", в банке "+rekv_klnt_bnk(j));
        end;
        j = j + 1;
       end;
      

     end;

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);
   return 0;

   onError (err)
      if(err.Code!=0)
         WordError(err);
         Exit(1);
      end; 
 END;

MACRO СформироватьТребУплатыПроцентов(CSA_ID, Pay_ID)
  
  private CONST TemplateName = "PFI_5s_treb_proc.dotx";
  var sql;
    
    sql = "select part.t_shortname shname, adr_cntr.t_adress adrcntr, genagr.t_code contr, genagr.t_start datcontr, pm.t_date paydt, pm.t_sumpay sumpay, fipay.t_ccy fipay, ";
    sql = sql + " paym.t_receiveraccount rcvacc ,partbank.t_shortname rcvbank, bic.t_code bic ,inn.t_code inn, schem.t_coraccount coracc "; //реквизиты получателя РСХБ
    sql = sql + " FROM ddvcsapm_dbt pm, ddvcsa_dbt csa, dparty_dbt part, dfininstr_dbt fipay, dadress_dbt adr_cntr, ddl_genagr_dbt genagr, ";
    sql = sql + " dpmpaym_dbt paym, dparty_dbt partbank, dobjcode_dbt inn, dobjcode_dbt bic, dpmprop_dbt prop, dcorschem_dbt schem  ";
    sql = sql + " where pm.t_csaid=csa.t_csaid and csa.t_partyid = part.t_partyid and pm.t_sumpaycur = fipay.t_fiid  ";
    sql = sql + " and csa.t_partyid=adr_cntr.t_partyid and adr_cntr.t_type=1 and genagr.t_genagrid = csa.t_genagrid ";
    sql = sql + " and paym.t_documentid=pm.t_pmid and paym.t_dockind=4627 and partbank.t_partyid = 1  "; //РСХБ
    sql = sql + " and inn.t_objectid=partbank.t_partyid and inn.t_codekind = 16 and inn.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')  ";
    sql = sql + " and bic.t_objectid=partbank.t_partyid and bic.t_codekind = 3 and bic.t_bankclosedate = to_date('01.01.0001','DD.MM.YYYY')  ";
    sql = sql + " and prop.t_paymentid =  paym.t_paymentid and prop.t_debetcredit =0  ";
    sql = sql + " and schem.t_Number = prop.t_corschem and schem.t_FIID = paym.t_fiid and schem.t_fi_kind = 1  ";
    sql = sql + " and pm.t_csaid = :csaid and pm.t_pmid = :pmid "; 


    sql = ExecSqlSelect(sql,MakeArray(SqlParam("csaid", CSA_ID),SqlParam("pmid", Pay_ID)), false);
    while (sql.moveNext())
           
       println(TemplateName); //Имя файла-шаблона
       println( "TRProc_", CSA_ID+"_"+Pay_ID, ".doc" ); // Генерируем имя результирующего файла документа

      [~CurDat];
      println ({curdate});

      [~NameAdrContractor];
      println (sql.value("shname")+" "+sql.value("adrcntr")); 

      [~NumCntr];
      println(sql.value("contr"));

      [~DateCntr];
      println(substr(string(sql.value("datcontr")),1,10));

      [~Contractor];
      println (sql.value("shname")); 

      [~DatePay];
      println (substr(string(sql.value("paydt")),1,10)); 
      
      [~Sum];
      println (sql.value("sumpay"));       

      [~Cur];
      println (sql.value("fipay")); 

      [~Name];
      println (sql.value("rcvbank")); 

      [~BIK_INN];
      println (sql.value("bic")+"/"+sql.value("inn")); 
      
      [~Kor_acc];
      println (sql.value("coracc")); 
      
     end;

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);
   return 0;

   onError (err)
      if(err.Code!=0)
         WordError(err);
         Exit(1);
      end; 
 END;

MACRO ПодтверждениеСделкиФорвард(Deal_ID)
msgbox("Печать ПодтверждениеСделкиФорвард");
/*
  private CONST TemplateName = "PFI_3_podtver.dotx";
  private CONST Bank = "АО 'Россельхозбанк'";
  var sql;

    sql = " select deal.t_type napr, part.t_shortname shname, genagr.t_code contr, genagr.t_start datcontr, deal.t_date begdate, fipay.t_ccy curr, ";
    sql = sql + " decode (nfi.t_cost, 0, nfi.t_amount*nfi.t_price, nfi.t_cost ) SumVal, nfi.t_amount SumBaseVal, fibase.t_ccy currbase, nfi.t_price Rate, nfi.t_execdate paydt, 'DateOc' calcdate, ";
    sql = sql + " fipay.t_name currname, s1.t_account acc1, s1.t_bankname bank1, fibase.t_name currbasename, s2.t_account acc2, s2.t_bankname bank2 ";
    sql = sql + " FROM ddvndeal_dbt deal, ddvnfi_dbt nfi, dparty_dbt part, dfininstr_dbt fibase, dfininstr_dbt fipay, ddl_genagr_dbt genagr, ";
    sql = sql + " dpmautoac_dbt a1, dsettacc_dbt s1, dpmautoac_dbt a2, dsettacc_dbt s2 ";
    sql = sql + " where deal.t_id=nfi.t_dealid and deal.t_contractor=part.t_partyid and deal.t_genagrid=genagr.t_genagrid  ";
    sql = sql + " and nfi.t_fiid=fibase.t_fiid and nfi.t_pricefiid=fipay.t_fiid  ";
    sql = sql + " and a1.t_partyid=deal.t_contractor and a1.t_servicekind=15 and a1.t_fiid = nfi.t_pricefiid ";
    sql = sql + " and s1.t_partyid=a1.t_partyid and s1.t_settaccid=a1.t_settaccid ";
    sql = sql + " and a2.t_partyid=deal.t_contractor and a2.t_servicekind=15 and a2.t_fiid = nfi.t_fiid ";
    sql = sql + " and s2.t_partyid=a2.t_partyid and s2.t_settaccid=a2.t_settaccid ";
    sql = sql + " and deal.t_id = :dealid ";

    sql = ExecSqlSelect(sql,MakeArray(SqlParam("dealid", Deal_ID)), false);
    while (sql.moveNext())
           
       println(TemplateName); //Имя файла-шаблона
       println( "PODTV_", Deal_ID+".doc" ); // Генерируем имя результирующего файла документа

      [~CurDat];
      println ({curdate});

      [~Contractor];
      println (sql.value("shname"));

      [~NumCntr];
      println(sql.value("contr"));

      [~DateCntr];
      println(substr(string(sql.value("datcontr")),1,10));

      [~DateSdel];
      println (substr(string(sql.value("begdate")),1,10)); 
      
      [~Curr];
      println (sql.value("curr"));       

      [~SumVal];
      println (sql.value("SumVal"));  

      [~Curr_1];
      println (sql.value("curr"));      

      [~SumBaseVal];
      println (sql.value("SumBaseVal")); 

      [~CurrBase];
      println (sql.value("currbase"));

      [~Rate];
      println (sql.value("Rate"));

      [~Curr_2];
      println (sql.value("curr"));

      [~CurrBase_2];
      println (sql.value("currbase"));

      if (sql.value("napr") == 1 ) //направление - покупка
      //Вариант для расчетной валюты. Для базовой валюты Customer и Saler должны поменяться местами
          [~Customer]; 
          println (sql.value("shname"));
    
          [~Saler];
          println (Bank);

      elif (sql.value("napr") == 2 ) //направление -продажа

          [~Customer]; 
          println (Bank);
    
          [~Saler];
          println (sql.value("shname"));

      end;

      [~DatePay];
      println (substr(string(sql.value("paydt")),1,10));

      [~DateOc];
      //println (substr(string(sql.value("calcdate")),1,10));
      println (sql.value("calcdate"));

      [~CurrName1];
      println (sql.value("currname"));

      [~AccContr1];
      println (sql.value("acc1"));

      [~BankContr1];
      println (sql.value("bank1"));

      [~CurrName2];
      println (sql.value("currbasename"));

      [~AccContr2];
      println (sql.value("acc2"));

      [~BankContr2];
      println (sql.value("bank2"));

      [~Contractor1]; 
      println (sql.value("shname"));

     end;

   DLWREPS_PrintReportFromTagFile (SetOutput (GetTxtFileName ("tmpout")));
   SetOutput(NULL, false);
   return 0;

   onError (err)
      if(err.Code!=0)
         WordError(err);
         Exit(1);
      end; */
 END;

macro CheckDealPrintConfirm ( DealID:integer )
  /*проверка соответствия сделки - вид сделки "Форвард" и базовый актив - Валюта*/
  var sqlExectype, Exectype;
  sqlExectype = RSDCommand("select 1 from ddvndeal_dbt d, ddvnfi_dbt f, dfininstr_dbt fi " +
                           "where d.t_id=f.t_dealid and f.t_fiid=fi.t_fiid and d.t_id = ? and fi.t_fi_kind=1 and d.t_dvkind = 1 ");

  sqlExectype.addParam("", RSDBP_IN, DealID);
  sqlExectype.execute();

  Exectype = TRsbDataSet(sqlExectype);
  if( Exectype.MoveNext() )
     return True;
  else
     return False;
  end;

END;  

macro CheckDealPrintConfirmForward ( DealID:integer )
  /*проверка соответствия сделки  вид сделки "Форвард", тип исполнения "поставочный" и базовый актив - Валюта*/
  var sqlExectype, Exectype;
  sqlExectype = RSDCommand("select 1 from ddvndeal_dbt d, ddvnfi_dbt f, dfininstr_dbt fi " +
                           "where d.t_id=f.t_dealid and f.t_fiid=fi.t_fiid and d.t_id = ? and f.t_exectype=1 and fi.t_fi_kind=1 and d.t_dvkind = 1 ");

  sqlExectype.addParam("", RSDBP_IN, DealID);
  sqlExectype.execute();

  Exectype = TRsbDataSet(sqlExectype);
  if( Exectype.MoveNext() )
     return True;
  else
     return False;
  end;

END;

exit(1);
