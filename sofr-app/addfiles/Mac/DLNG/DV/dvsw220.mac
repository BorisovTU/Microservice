/*
$Name:        dvsw220.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг: Завершение операции
*/
import InsCarryDoc, DVInter, "dv_categ.mac", "dv_car.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  record ndeal(dvndeal);
  var ДатаИсполненияШага:date;

  SetBuff( ndeal, FDoc );
  var FD = DVFirstDocNDeal(DocKind, ndeal);
  var sql = "", DataSet;
  if (FD.ОтказОтИсполнения())
     return 0;
  end;

  GetOprDate( DV_NDEAL_OPRDATE_CLOSE, ДатаИсполненияШага );

  if( ВозвратПолучениеДепозитнойМаржи(FD, doc, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  /*PNV 493273****/  
  if( ПИ_ЗакрыватьСчетаПоСделке() )
      sql = RSDCommand( " select categ.t_code, accdoc.t_account, accdoc.t_currency, accdoc.t_chapter, accdoc.t_firole " +
                        " from dmcaccdoc_dbt accdoc, dmccateg_dbt categ,  dmctempl_dbt Templ " +
                        " where accdoc.t_dockind = ? " +
                        "   and accdoc.t_docid = ? " +
                        "   and accdoc.t_catid = categ.t_id " +
                        "   and categ.t_updatemode = 0 " +
                        "   and  templ.T_CATID = categ.T_ID " +
                        "   and accdoc.t_TemplNum = templ.t_Number "+
                        "   and (/*exists( select * " +
                        "                  from daccount_dbt acc " +
                        "                 where acc.t_chapter = accdoc.t_chapter " +
                        "                   and acc.t_account = accdoc.t_account " +
                        "                   and acc.t_code_currency = accdoc.t_currency " +
                        "                   and acc.t_close_date = '01.01.0001' )" 
                        "                   and( ( (Categ.t_Param1 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class1 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value1 <> 2) ) OR " +
                        "                        ( (Categ.t_Param2 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class2 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value2 <> 2) ) OR " +
                        "                        ( (Categ.t_Param3 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class3 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value3 <> 2) ) OR " +
                        "                        ( (Categ.t_Param4 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class4 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value4 <> 2) ) OR " +
                        "                        ( (Categ.t_Param5 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class5 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value5 <> 2) ) OR " +
                        "                        ( (Categ.t_Param6 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class6 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value6 <> 2) ) OR " +
                        "                        ( (Categ.t_Param7 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class7 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value7 <> 2) ) OR " +
                        "                        ( (Categ.t_Param8 = " + string( OBJTYPE_DV_KIND_ACCOUNTING) + " ) and (Categ.t_Class8 = " + string( LLCLASS_DV_KIND_ACCOUNTING) + " ) and (Templ.t_Value8 <> 2) ) ) " +
                        "        or*/ ( ( DBMS_LOB.SUBSTR(accdoc.t_account, 5, 1) in('61601','52601','52602')) " +  /*PNV*/
                        "        or (DBMS_LOB.SUBSTR(accdoc.t_account, 3, 1) in('933','934','939','940','963','964','969','970')) )" + /*PNV*/
                        "       )"
                      );
      sql.addParam("", RSDBP_IN, FD.Kind);
      sql.addParam("", RSDBP_IN, FD.ID);
      DataSet = TRsbDataSet(sql);
      while( DataSet.MoveNext() )
             var rest = abs(RestA(DataSet.account, /*{curdate}*/ДатаИсполненияШага, NULL, DataSet.chapter, DataSet.currency)) +
                        abs(RestA(DataSet.account, date(31,12,9999), NULL, DataSet.chapter, DataSet.currency));

             if( rest > 0 )
                 MsgBox("Не нулевой остаток на счете " + DataSet.account);
                 return 1;
             elif( MC_FindAndCloseAccount(DataSet.code, fd, /*{curdate}*/ДатаИсполненияШага, DataSet.firole, DataSet.currency, MC_ACC_CLOSE_INDIVIDUAL) )
                 MsgBox("Невозможно закрыть счет " + DataSet.account);
                 return 1;
             end;
      end;
  end;
  /*PNV 493273****/  
      /*PNV MC_FindAndCloseAccount закрывает только действующие счета по сделке. Нужно закрыть НЕ действующие*/
      sql = RSDCommand( " select distinct categ.t_code, accdoc.t_account, accdoc.t_currency, accdoc.t_chapter, accdoc.t_firole " +
                        " from dmcaccdoc_dbt accdoc, dmccateg_dbt categ, daccount_dbt acc " +
                        " where accdoc.t_dockind = ? " +
                        "   and accdoc.t_docid = ? " +
                        "   and accdoc.t_catid = categ.t_id " +
                        "   and categ.t_updatemode = 0 " +
                        "   and DBMS_LOB.SUBSTR(accdoc.t_account, 3, 1) in('933','934','939','940','963','964','969','970') " + 
                        "   and ACCDOC.T_ISUSABLE <> chr(88) "
                        "   and ACC.T_ACCOUNT = accdoc.t_account "+
                        "   and ACC.T_CODE_CURRENCY =  accdoc.t_currency "+          
                        "   and ACC.T_OPEN_CLOSE = CHR(0) "                     
                     );
      sql.addParam("", RSDBP_IN, FD.Kind);
      sql.addParam("", RSDBP_IN, FD.ID);
      DataSet = TRsbDataSet(sql);
      while( DataSet.MoveNext() )
             rest = abs(RestA(DataSet.account, /*{curdate}*/ДатаИсполненияШага, NULL, DataSet.chapter, DataSet.currency)) +
                        abs(RestA(DataSet.account, date(31,12,9999), NULL, DataSet.chapter, DataSet.currency));

             if( rest > 0 )
                 MsgBox("Не нулевой остаток на счете " + DataSet.account);
                 return 1;
             elif( CB_CloseAccount(DataSet.Chapter, DataSet.currency, DataSet.Account, ДатаИсполненияШага))
                 MsgBox("Невозможно закрыть счет " + DataSet.account);
                 //return 1;
             end;
      end;
 /*PNV 519783****/  

  // Проверяем, что закрыты все платежи по операции 
  sql = DL_RSDCommand( "SELECT LISTAGG(pm.t_PaymentID, ', ') WITHIN GROUP (ORDER BY pm.t_PaymentID) Payments " +
                           "  FROM dpmpaym_dbt pm      " +
                           " WHERE pm.t_documentid = ? " +
                           "   AND pm.t_dockind    = ? " +
                           "   AND pm.t_paymstatus < ? and pm.t_paymstatus != ? "
                     );
  sql.addParam( FD.ID );
  sql.addParam( FD.Kind );
  sql.addParam( PM_READY_TO_SEND );
  sql.addParam( PM_CLOSED_W_M_MOVEMENT );
  var Data = sql.execute();

  if( Data.MoveNext() and (SQL_ConvTypeStr(Data.Payments) != "") )
     MsgBox("В операции есть неисполненные платежи с ID: " + SQL_ConvTypeStr(Data.Payments));
     return 1;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DOC(), DV_OPERSTATUS_DOC_CLOSE) )
     MsgBox("Ошибка при установке статуса <Документооборот> по операции.");
     return 1;
  end;

  return 0;
end;
