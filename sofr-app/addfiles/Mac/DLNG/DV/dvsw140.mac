/*
$Name:        dvsw140.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг "Постановка на баланс 2ч"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac";

/*AEA*/
macro VarMargin(dealid)
 var sql = " select nvl((deb.sumdeb - cred.sumcred), 0) summargin from " 
         + " (select nvl(sum(trn.t_sum_payer), 0) sumdeb from doprdocs_dbt doc, doproper_dbt oper, dacctrn_dbt trn "
         + "  where doc.t_id_operation = oper.t_id_operation and oper.t_documentid = " + dealid
         + "   and trn.t_acctrnid = doc.t_acctrnid and substr(TRN.T_ACCOUNT_PAYER, 1, 5) = '30424') deb,"
         + " (select nvl(sum(trn.t_sum_receiver), 0) sumcred from doprdocs_dbt doc, doproper_dbt oper, dacctrn_dbt trn "
         + "  where doc.t_id_operation = oper.t_id_operation and oper.t_documentid = " + dealid 
         + "    and trn.t_acctrnid = doc.t_acctrnid and substr(TRN.T_ACCOUNT_receiver, 1, 5) = '30424') cred";
 var q = DL_RSDCommand(sql);
 var Data = q.execute();
    if( Data.MoveNext() )
      return Data.summargin;
    end;

    return 0;
 
end;
/***********/

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  RECORD ndeal(dvndeal);
  VAR ДатаИсполненияШага, FD;
  var СуммаEq = 0, Валюта = 0, Sqp = 0;
  SetBuff( ndeal, FDoc );
  var restAccPlusPFI: money = $0.0;
  var restAccMinusPFI: money = $0.0;
  var PlusPFIAccBuf = TRecHandler("account");
  var MinusPFIAccBuf = TRecHandler("account");

  FD = DVFirstDocNDeal(DocKind, ndeal, 2);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);
  if( ДатаИсполненияШага == date(0,0,0) )
     ДатаИсполненияШага = FD.ДатаИсполнения();
  end;

  if( (GetOprStatus(FD.DV_OPERSTATUS_EXECTYPE()) == DV_OPERSTATUS_EXECTYPE_STATE) and
      ((GetOprStatus(FD.DV_OPERSTATUS_DEMAND()) != DV_OPERSTATUS_DL_COMPLETE) or
      (GetOprStatus(FD.DV_OPERSTATUS_LIABILITY()) != DV_OPERSTATUS_DL_COMPLETE)) )
     MsgBox( "Шаг не может быть выполнен. Не выполнены шаги блока \"Исполнение поставочной сделки\"." );
     return 1;
  end;

  if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
     if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );
  var ПлатежОб   = RsbPayment( FD.ПлатежОб.rec.PaymentID );

   /*bpv  */
  if (FD.IsClient())
     if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.Ground =  FD.GetGround(1007);
        ПлатежТреб.Ground =  FD.GetGround(1007);
     end;
  end;

  /* устанавливаем признак участия в неттинге */
  if (FD.IsClient() == false)
   if ( (DL_ЕдиныйПулОбеспеченияСобств == 1) and (FD.Биржевая()))
    elif (FD.Netting2())
     if( FD.ПлатежТреб.rec.PaymentID > 0 )
        ПлатежТреб.Netting = SET_CHAR;
     end;

     if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.Netting = SET_CHAR;
      end;
     end;
  end;

  if ( АктуализироватьПлатежи(FD, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( ОтражениеКонверсионнойОперацииВБалансе( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;
  //13/02/2019 mda Для биржевых сделок списывем СС в этом шаге , для внебиржи отдельный шаг "Списание СС"
  if( FD.Биржевая()  and /*bpv*/(not FD.IsClient()))
    if( СписаниеСправедливойСтоимости( FD, doc, ДатаИсполненияШага ) != 0 )
       return 1;
    end; 
    if (FD.СрокСделки == DV_PERIODCLS_T3)
        if ( (FD.ВидБазовогоАктива == FIKIND_METAL) )
           if( FD.IsBuy() )  
             Валюта = FD.ВалютаОбязательства();
             if( not DV_SmartConvertSum(СуммаEq, FD.СуммаТребования(), ДатаИсполненияШага, FD.ВалютаТребования(), Валюта, false) )
                 return 1;
             end;

             if( not ПроводкаПоКатегориямУчета( FD,
                                        "КлиринговыеСчетаДМ", "+Форвард, расчетыДМ",  //SVE Новые торговые счета 30413* 
                                        ДатаИсполненияШага, 1,
                                        FD.ВалютаОбязательства(), СуммаEq,
                                        doc,
                                        INPCARRY,"", "",
                                        "Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        NULL, FIROLE_FIREQ, FIROLE_FIREQ,
                                        FD.ВалютаТребования(), FD.ВалютаОбязательства(),
                                        FD.ВалютаТребования(), FD.СуммаТребования(),
                                        NULL, NULL, NULL, NULL,
                                        ACCTRN_SIDE_DEBET, NULL, NULL, NULL, NULL, NULL,
                                        null, null, null, null, null, null, true 
                                      )
                )
                return 1;
            end;
            Sqp = (СуммаEq - FD.СуммаОбязательства() - VarMargin(FD.deal.rec.id));   /*AEA*/
            if (Sqp > 0)
                if( not ПроводкаПоКатегориямУчета( FD,
                                        "+Форвард, расчетыДМ", "+Маржа, ИВ и ДМ",
                                        ДатаИсполненияШага, 1,
                                        FD.ВалютаОбязательства(), ABS(Sqp),
                                        doc,
                                        INPCARRY,"", "",
                                        "Отражение финансового результата по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        //"Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        NULL, FIROLE_FIREQ, FIROLE_BA, 
                                        FD.ВалютаОбязательства(), NATCUR, 
                                        NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                      )
                      return 1;
                 end;
            else
                if( not ПроводкаПоКатегориямУчета( FD,
                                        "-Маржа, ИВ и ДМ", "+Форвард, расчетыДМ", 
                                        ДатаИсполненияШага, 1,
                                        NATCUR, ABS(Sqp),
                                        doc,
                                        INPCARRY,"", "",
                                        "Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        NULL, FIROLE_BA, FIROLE_FIREQ,
                                        NATCUR, FD.ВалютаОбязательства(),
                                        NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                      )
                      return 1;
                 end;
            end;
           elif( FD.IsSale() ) /*PNV i-support 499194 проводки при продаже переписаны в соответствии с требованиями банка*/
                Валюта = FD.ВалютаТребования();
                if( not DV_SmartConvertSum(СуммаEq, FD.СуммаОбязательства(), ДатаИсполненияШага, FD.ВалютаОбязательства(), Валюта, false) )
                   return 1;
                end;

                if( not ПроводкаПоКатегориямУчета( FD,
                                        "Выбытие ДМ", "КлиринговыеСчетаДМ",   //SVE Новые торговые счета 30413*
                                        ДатаИсполненияШага, 1,
                                        FD.ВалютаТребования(), СуммаEq,
                                        doc,
                                        INPCARRY,"", "",
                                        "Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        NULL, FIROLE_BA, FIROLE_FIREQ,
                                        NATCUR, FD.ВалютаОбязательства(),
                                        NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                   )
                   return 1;
                end;
                if( not ПроводкаПоКатегориямУчета( FD,
                                        "-Форвард, расчетыДМ", "Выбытие ДМ",
                                        ДатаИсполненияШага, 1,
                                        FD.ВалютаТребования(), FD.ПлатежТреб().rec.OrderAmount,
                                        doc,
                                        INPCARRY,"", "",
                                        "Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        NULL, FIROLE_FICOM, FIROLE_BA,
                                        FD.ВалютаТребования(), NATCUR,
                                        FD.ВалютаТребования(), FD.СуммаТребования(),
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                   )
                   return 1;
                end;

                Sqp = (FD.СуммаТребования() - VarMargin(FD.deal.rec.id)) - СуммаEq;  /*AEA*/
                if (Sqp > 0)
                    if( not ПроводкаПоКатегориямУчета( FD,
                                        "Выбытие ДМ", "+Маржа, ИВ и ДМ",
                                        ДатаИсполненияШага, 1,
                                        NATCUR, ABS(Sqp),
                                        doc,
                                        INPCARRY,"", "",
                                        //"Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        "Отражение фин. результата с " + DV_GetPartyName (FD.Deal.rec.contractor) + " по сделке "+FD.DealCode() + " от "  + FD.ДатаСделки(),
                                        NULL, FIROLE_BA, FIROLE_BA, 
                                        NATCUR, NATCUR, 
                                        NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                        )
                        return 1;
                    end;
                else
                    if( not ПроводкаПоКатегориямУчета( FD,
                                        "-Маржа, ИВ и ДМ", "Выбытие ДМ", 
                                        ДатаИсполненияШага, 1,
                                        NATCUR, ABS(Sqp),
                                        doc,
                                        INPCARRY,"", "",
                                        //"Расчеты по " + IIF (FD.isbuy(), "покупке", "продаже") + " обезличенного металла с " + DV_GetPartyName (FD.GetContractorID()) + " по сделке " + FD.DealCode() + " от " + FD.ДатаСделки(),
                                        "Отражение фин. результата с " +  DV_GetPartyName (FD.Deal.rec.contractor) + " по сделке "+FD.DealCode() + " от "  + FD.ДатаСделки(),
                                        NULL, FIROLE_BA, FIROLE_BA,
                                        NATCUR, NATCUR,
                                        NULL, NULL,
                                        NULL, NULL, NULL, NULL,
                                        NULL, NULL, NULL, NULL, NULL
                                      )
                         )
                         return 1;
                    end;
                end;
            end;  
         end;
    end;
  elif ( FD.Биржевая() and /*bpv*/(not FD.IsClient())  and (FD.СрокСделки == DV_PERIODCLS_T3))/*523414 спец. для Тихонова, дебильная проверка на остатки которых никогда не может быть*/
        if((not FD.OpenAccount("+ПФИ", null, null, FIROLE_UNDEF, PlusPFIAccBuf,  ДатаИсполненияШага, NATCUR, null, null)) or
           (not FD.OpenAccount("-ПФИ", null, null, FIROLE_UNDEF, MinusPFIAccBuf, ДатаИсполненияШага, NATCUR, null, null))
          )
          restAccPlusPFI = 0;
          restAccMinusPFI = 0;
        else
          restAccPlusPFI  = GetRestAccountTRH(PlusPFIAccBuf, ДатаИсполненияШага);
          restAccMinusPFI = GetRestAccountTRH(MinusPFIAccBuf, ДатаИсполненияШага);
        end;
        if (restAccPlusPFI != 0)
           msgbox("Обнаружен остаток на счете " + PlusPFIAccBuf.rec.account);
           return 1;
        elif (restAccMinusPFI != 0)
           msgbox("Обнаружен остаток на счете " + MinusPFIAccBuf.rec.account);
           return 1;
        end;
  end;

  if (GetOprStatus(DV_OPERSTATUS_EARLY_SETTLEMENT_2) != DV_EARLY_SETT_OPERSTATUS_YES)

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND_2(), DV_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Требования 2ч> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_LIABILITY_2(), DV_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Обязательства 2ч> по операции.");
     return 1;
  end;

  end;

  return 0;
end;

MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -отакат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */
    if (errTrn OR (CommitOrRollback==2)) 
         /* Произошла ошибка или происходит откат */
         return;
    end;
    record rFirstDoc( dvndeal );
    SetBuff( rFirstDoc, FirstDoc );
    if (( errTrn == 0 ) and ( CommitOrRollback == 1 ))
		var FD = DVFirstDocNDeal(KindDoc, rFirstDoc, 2);
		var stat = 0;
		var query = "SELECT trn.t_acctrnid " +
					"  FROM dacctrn_dbt trn, DOPRDOCS_DBT docs " +
					" WHERE     docs.T_ID_OPERATION = ? " +
					"       AND docs.t_id_step = ? " +
					"       AND trn.t_acctrnid = docs.t_acctrnid "+
					"       AND trn.t_result_carry = 83 ";

		var  cmd = DL_RSDCommand(query);

		cmd.AddParam(ID_Operation);
		cmd.AddParam(ID_Step);

		var DataSet = cmd.Execute();
		if(DataSet.moveNext())
			query = "update dacctrn_dbt set t_ground = ? where t_acctrnid = ?";
			var cmd_up = RsdCommand(query);
			cmd_up.AddParam("", RSDBP_IN, FD.GetGround(17));
			cmd_up.AddParam("", RSDBP_IN, DataSet.AccTrnID);
			cmd_up.Execute();
			return ;
		end;
      
    end;
	return 0;
END;