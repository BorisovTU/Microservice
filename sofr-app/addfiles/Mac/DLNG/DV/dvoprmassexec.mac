/*
$Name:         dvoprmassexec.mac
$Module:       ФИСС и КО
$Description:  Вспомогательные общие ф-и для массового исполнения сделок
*/
import rsd, "cb_sql.mac", "dlmisc.mac";

/* Добавить SQL код, вызываемый при откате операции */
/* Используется в транзакции массового исполнения шагов операций для дальнейшего восстановления объекта при откате операции */
PRIVATE MACRO Opr_SetBkoutData( ExecStr:STRING, AddFrom:STRING, AddWhere:STRING, Mes:STRING ):INTEGER
  VAR SqlCmd = " DECLARE " +
               "    c_RollbackData RSI_RsbOperation.BkoutData_cur; " +
               " BEGIN " +
               "    open c_RollbackData for select opr.t_ID_Operation, opr.t_ID_Step, " + ExecStr +
               "                              from doprtemp_view opr, ddvdeal_dbt deal " + IIF(AddFrom != NULL, ", " + AddFrom, "") +
               "                             where deal.t_ID = TO_NUMBER(opr.t_DocumentID) " +
               "                               and opr.t_DocKind = " + string(DL_DVDEAL) + IIF(AddWhere != NULL, " and " + AddWhere, "") + "; " +
               "       RSI_RsbOperation.SetBkoutDataForAll( c_RollbackData ); " +
               "    close c_RollbackData; " +
               " END; ";

  SQL_Execute(SqlCmd, Mes, true);
  return 0;

ONERROR
  return 1;
END;

/* Добавить SQL код, вызываемый при откате операции расчётов */
/* Используется в транзакции массового исполнения шагов операций для дальнейшего восстановления объекта при откате операции */
PRIVATE MACRO Opr_SetBkoutData_Oper( ExecStr:STRING, AddFrom:STRING, AddWhere:STRING, Mes:STRING ):INTEGER
  VAR SqlCmd = " DECLARE " +
               "    c_RollbackData RSI_RsbOperation.BkoutData_cur; " +
               " BEGIN " +
               "    open c_RollbackData for select opr.t_ID_Operation, opr.t_ID_Step, " + ExecStr +
               "                              from doprtemp_view opr, ddvoper_dbt oper " + IIF(AddFrom != NULL, ", " + AddFrom, "") +
               "                             where oper.t_ID = TO_NUMBER(opr.t_DocumentID) " +
               "                               and opr.t_DocKind = " + string(DL_DVOPER) + IIF(AddWhere != NULL, " and " + AddWhere, "") + "; " +
               "       RSI_RsbOperation.SetBkoutDataForAll( c_RollbackData ); " +
               "    close c_RollbackData; " +
               " END; ";

  SQL_Execute(SqlCmd, Mes, true);
  return 0;

ONERROR
  return 1;
END;

/* Откат установки признака учета по позиции на операции */
MACRO DV_SaveMassDealPosAcc():INTEGER
  return Opr_SetBkoutData( "'call RSB_Derivatives.RSI_DV_UnsetDealPosAcc('||to_char(deal.t_ID)||');'",
                           NULL,  
                           "(deal.t_Type = 'B' OR deal.t_Type = 'S' OR deal.t_Type = 'D' OR deal.t_Type = 'G')",
                           "Сохранение признака учета по позиции для возможности дальнейшего отката изменений"
                         );
END;

/* Установка признака учета по позиции на операции */
/* Аналог DV_SetDealPosAcc для единичного режима исполнения */
MACRO DV_MassSetDealPosAcc():INTEGER

  var cmd = RsdCommand("{ CALL RSB_Derivatives.DV_MassSetDealPosAcc }");

  SQL_Execute(cmd, "Установка признака учета по позиции на операции", true);

  return 0;

ONERROR
  return 1;
END;

/* Откат вставки комиссий по биржевым операциям */
MACRO DV_SaveMassInsertDlCom():INTEGER
  return Opr_SetBkoutData( "'call Rsb_Derivatives.RSI_DV_DeleteDlCom('||to_char(deal.t_ID)||', '||to_char(comis.t_ComissID)||');'",
                           "dsfdef_dbt sfdef, dsfcomiss_dbt comis",

                           "     (((deal.t_Client > 0) AND (comis.t_ReceiverID = " + string({OurBank}) + ")) OR " +
                           "      (((RSB_Derivatives.RSI_DV_PartyCalcTotalAmount(RSB_Derivatives.RSI_DVGetContractorID(deal.t_ID)) <> 1)) AND (comis.t_ReceiverID <> " + string({OurBank}) + ")) " +
                           "     ) " +
                           " AND sfdef.t_ID_Operation = opr.t_ID_Operation " +
                           " AND sfdef.t_ID_Step      = opr.t_ID_Step " +
                           " AND sfdef.t_Sum         <> 0 " +
                           " AND comis.t_FeeType      = sfdef.t_FeeType " +
                           " AND comis.t_Number       = sfdef.t_CommNumber ",
                           "Сохранение состаяния комиссий для возможности дальнейшего отката изменений"
                         );
END;

/* Вставка комиссий по биржевым операциям */
/* Аналог DVInsertDlCom для единичного режима исполнения */
MACRO DV_MassInsertDlCom():INTEGER
  var cmd = RsdCommand("{ CALL RSB_Derivatives.DV_MassInsertDlCom }");
  SQL_Execute(cmd, "Вставка комиссий по биржевым операциям", true);
  return 0;
ONERROR
  return 1;
END;

// Закрыть сделки на конец дня.
// Аналог DV_CloseDeals для массовых операций 
MACRO DV_MassCloseDvDeals( oper:variant ):INTEGER

  VAR cmd = RsdCommand( "{ CALL Rsb_Derivatives.RSI_DV_CloseDeals(?) }" );

  cmd.addParam( "", RSDBP_IN, oper.ID );

  SQL_Execute( cmd, "Закрытие сделок", true );
  return 0;

ONERROR
  return 1;
END;

/* Откат закрытых по расчётам сделок */
MACRO DV_SaveMassCloseDvDeals():INTEGER
  return Opr_SetBkoutData_Oper( "'call RSB_Derivatives.RSI_DV_RecoilCloseDeals('||to_char(oper.t_ID)||');'",
                           NULL,  
                           NULL,
                           "Сохранение закрытых сделок для возможности отката изменений"
                         );
END;

// Закрыть позиции на конец дня.
// Аналог DV_ClosePositions для массовых операций 
MACRO DV_MassClosePosition( oper:variant ):INTEGER
  VAR cmd = RsdCommand( "{ CALL Rsb_Derivatives.RSI_DV_ClosePositions(?) }" );
  cmd.addParam( "", RSDBP_IN, oper.ID );
  SQL_Execute( cmd, "Закрытие позиций", true );
  return 0;
ONERROR
  return 1;
END;

/* Откат закрытых по расчётам позиций */
MACRO DV_SaveMassClosePosition():INTEGER
  return Opr_SetBkoutData_Oper( "'call RSB_Derivatives.RSI_DV_RecoilClosePositions('||to_char(oper.t_ID)||');'",
                           NULL,  
                           NULL,
                           "Сохранение закрытых позиций для возможности отката изменений"
                         );
END;

// Изменение итогов по сделке за день.
// Аналог DV_CalcDealTurn для массовых операций 
MACRO DV_MassCalcDealTurn( DealID, DealDate, Margin, FairValue, CalcSum, CalcFairValue, Action ):INTEGER
  VAR cmd = RsdCommand( "{ CALL Rsb_Derivatives.RSI_DV_CalcDealTurn(?,?,?,?,?,?,?) }" );
  cmd.addParam( "", RSDBP_IN, DealID );
  cmd.addParam( "", RSDBP_IN, DealDate );
  cmd.addParam( "", RSDBP_IN, Margin );
  cmd.addParam( "", RSDBP_IN, FairValue );
  cmd.addParam( "", RSDBP_IN, CalcSum );
  cmd.addParam( "", RSDBP_IN, CalcFairValue );
  cmd.addParam( "", RSDBP_IN, Action );
  SQL_Execute( cmd, "Изменение итогов по сделке", true );
  return 0;
ONERROR
  return 1;
END;

/* Откат итогов по сделке за день */
MACRO DV_SaveMassCalcDealTurn(DealID:integer):INTEGER
  return Opr_SetBkoutData_Oper( "'call RSB_Derivatives.RSI_DV_MassRecoilInsertDealTurn("+DealID+",'||to_char(oper.t_ID)||',"+4+");'",
                           NULL,  
                           NULL,
                           "Сохранение итогов по сделке для возможности отката изменений"
                         );
END;

// Вставка данных о сервисной операции расчётов на срочном рынке
MACRO DV_MassSaveServAction( ID_Operation, ID_Step ):INTEGER
  VAR cmd = RsdCommand( "{ CALL Rsb_Derivatives.RSI_DV_MassSaveServAction(?,?) }" );
  cmd.addParam( "", RSDBP_IN, ID_Operation );
  cmd.addParam( "", RSDBP_IN, ID_Step );
  SQL_Execute( cmd, "Вставка данных о сервисной операции", true );
  return 0;
ONERROR
  return 1;
END;

// Откат данных о сервисной операции расчётов на срочном рынке
MACRO DV_MassSaveRecoilServAction():INTEGER
  return Opr_SetBkoutData_Oper( "'call RSB_Derivatives.RSI_DV_MassRecoilServAction('||to_char(opr.t_ID_Operation)||','||to_char(opr.t_ID_Step)||');'",
                                NULL,  
                                NULL,
                                "Сохранение данных о сервисной операции"
                               );
END;

// Изменение итогов по позиции за день.
// Аналог DV_CalcPositionTurn для массовых операций 
MACRO DV_MassCalcPositionTurn( DvPos:variant, PosDate:date, Margin, FairValue, CalcSum, CalcFairValue ):INTEGER
  VAR cmd = RsdCommand( "{ CALL Rsb_Derivatives.RSI_DV_CalcPositionTurn(?,?,?,?,?,?,?,?,?,?) }" );
  cmd.addParam( "", RSDBP_IN, DvPos.FIID );
  cmd.addParam( "", RSDBP_IN, DvPos.Department );
  cmd.addParam( "", RSDBP_IN, DvPos.Broker );
  cmd.addParam( "", RSDBP_IN, DvPos.ClientContr );
  cmd.addParam( "", RSDBP_IN, PosDate );
  cmd.addParam( "", RSDBP_IN, Margin );
  cmd.addParam( "", RSDBP_IN, FairValue );
  cmd.addParam( "", RSDBP_IN, CalcSum );
  cmd.addParam( "", RSDBP_IN, CalcFairValue );
  cmd.addParam( "", RSDBP_IN, DvPos.GenAgrID );
  SQL_Execute( cmd, "Изменение итогов по позиции", true );
  return 0;
ONERROR
  return 1;
END;

/* Откат итогов по позиции за день */
MACRO DV_SaveMassCalcPositionTurn(PosID:integer):INTEGER
  return Opr_SetBkoutData_Oper( "'call RSB_Derivatives.RSI_DV_MassRecoilInsertPosTurn("+PosID+",'||to_char(oper.t_ID)||',"+4+");'",
                           NULL,  
                           NULL,
                           "Сохранение итогов по позиции для возможности отката изменений"
                         );
END;
// Откат данных о связях проводок со сделками срочного рынка
MACRO DV_MassSaveRecoilDvdealTrnLink():INTEGER
  return Opr_SetBkoutData_Oper( "'call RSB_Derivatives.RSI_DV_MassRecoilDvdealTrnLink('||to_char(opr.t_ID_Operation)||','||to_char(opr.t_ID_Step)||');'",
                                NULL,  
                                NULL,
                                "Сохранение связей проводок со сделками срочного рынка для возможности отката изменений"
                               );
END;