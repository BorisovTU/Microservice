/*
$Name:        dvDealMassActions.mac
$Module:      à®¨§¢®¤­ë¥ ¨­áâàã¬¥­âë
$Description: Œ áá®¢ë¥ ¤¥©áâ¢¨ï á ¡¨à¦¥¢ë¬¨ á¤¥«ª ¬¨ ”ˆ‘‘¨ŠŽ
*/
import XmlRpcInter, BankInter, DVInter, "dvDeal.mac", "cb_sql.mac", "dlquery.mac";

PRIVATE MACRO PrintHead( Head:STRING )
[
                   #
ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
³            Š®¤           ³  ü   ³                      ‘®®¡é¥­¨¥                                                                    ³
³         ®¯¥à æ¨¨         ³®è¨¡ª¨³                                                                                                   ³
ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´](Head);
END;


PRIVATE MACRO PrintFooter()
[ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
];

END;

PRIVATE MACRO PrintLine( Code:STRING, ErrStatus:INTEGER, ErrMessage:STRING )
[³##########################³######³###################################################################################################³]
( Code:w, ErrStatus, ErrMessage:w );
END;

//ª« áá á ¤ ­­ë¬¨ ¤«ï ª®­¢¥©¥à 
class DealCnvData(_Key)
  var Key = _Key;
end;

macro Žâ®¡à âì‘¤¥«ª¨( _taskID, _execID, _conveyerID, _packetSize, _Params )
  var cnt = 0;
  var query, DataSet;

  query = " INSERT INTO DCNVDOC_DBT(T_TASKID, T_EXECID, T_CONVTYPEID, T_PACKID, T_OBJECTTYPE, T_OBJECTID) " +
          " SELECT "+_taskID+","+_execID+","+_conveyerID+", ROWNUM, 0, oprtemp.t_DocumentID " +
          "   FROM doprtemp_tmp oprtemp ";

  SQL_Execute(query, "Žâ¡®à ®¡ê¥ªâ®¢", false);

  if( _packetSize == 0 )
     cnt = 1;
  else
     query = " select NVL(max(t_PackID), 0) as cnt " +
             "   from dcnvdoc_dbt " +
             "  where t_ExecID = " + _execID;

     DataSet = TRsbDataSet(query);
     if( DataSet.moveNext() )
        cnt = int(round(int(DataSet.cnt), 0));
     end;
  end;

  return cnt;
end;

macro ExecuteMassActions( _taskID, _execID, _conveyerID, _operationID, _packetID, _Params )
  var query, cmd, DataSet;
  var cnt = 0;
  var err = 0;
  var stat = true;

  if( (_conveyerID) and (_packetID) )

     query = " select t_ObjectID as t_DealID from dcnvdoc_dbt where t_ExecID = ? and t_ConvTypeID = ? and t_PackID = ?";

     cmd = DL_RSDCommand(query);

     cmd.AddParam(_execID);
     cmd.AddParam(_conveyerID);
     cmd.AddParam(_packetID);

     DataSet = cmd.Execute();
     if( DataSet.moveNext() )
        if( _Params.Key == 322/*K_F8*/ )
           err = DV_DealsDelRecord(DataSet.DealID);
        elif( _Params.Key == 367/*K_ALTF8*/ )
           err = DV_DealsMoveToPrepRecord(DataSet.DealID);
        end;
     end;

     /*­¥ § ¢¨á¨¬® ®â â®£®, ¤¥« «¨ çâ®-â® ¨«¨ ­¥â - áâ ¢¨¬ ¨áå®¤ïé¨© áâ âãá ®¡à ¡ âë¢ ¥¬®© ¯ çª¥*/
     var exec = RSDCommand(" UPDATE dcnvpack_dbt " +
                           "    SET t_State = t_State + 1, " +
                           "        t_Error = ?, " +
                           "        t_ErrMsg = ? " +
                           "  WHERE t_ExecID = ? " +
                           "    AND t_ConvTypeID = ? " +
                           "    AND t_PackID = ? ");

     exec.addParam("", RSDBP_IN, err);
     exec.addParam("", RSDBP_IN, GetErrMsg());   
     exec.addParam("", RSDBP_IN, _execID);
     exec.addParam("", RSDBP_IN, _conveyerID);
     exec.addParam("", RSDBP_IN, _packetID);
     exec.execute();
  end;

  return err;

OnError(e);
  var t = 0;
end;

macro RunConveyer( Key:INTEGER )

  var ReportFileName, errcode, errtext;
  FILE ReportOutFile() txt write; /*ä ©« ¢ë¢®¤ */
  var ErrStatus:integer = 0, ErrMessage:string = "", first:bool = true;
  var OperID = 20;
  var ConvID = 24;
  var rslObj = DealCnvData(Key);

  var cnv = RsbConveyerExec(ConvID);

  cnv.AddParamsForConveyer(ConvID, rslObj, 0);
  cnv.AddParamsForOperation(ConvID, OperID, rslObj, "", 0);
  cnv.showPanelMonitoring(1);
  cnv.Run();

  var Cmd, Query, DataSet, err = 0;
  Query = " select pack.t_Error, nvl(pack.t_ErrMsg, '') ErrMsg, nvl((select deal.t_Code from ddvdeal_dbt deal where deal.t_ID = doc.t_ObjectID), '') DealCode " +
          "   from dcnvpack_dbt pack, dcnvdoc_dbt doc " +
          "  where pack.t_ExecID =  " + string(cnv.ExecID) +
          "    and pack.t_Error > 0 " +
          "    and doc.t_ExecID     = pack.t_ExecID " +
          "    and doc.t_ConvTypeID = pack.t_ConvTypeID " +
          "    and doc.t_PackID     = pack.t_PackID " +
          " order by pack.t_Error, ErrMsg, DealCode";

  Cmd = RSDCommand(Query);

  Cmd.Execute();
  DataSet = TRsbDataSet(Cmd);

  while( DataSet.MoveNext() )
     if( first )
        ReportFileName = GetTxtFileName("¯à®â®ª®«");
        if( Open(ReportOutFile, ReportFileName) == false )
           errcode = status(errtext);
           MsgBox("Žè¨¡ª  ¯à¨ ®âªàëâ¨¨ ä ©«  |"+ ReportFileName +"|(" + errcode + ") " + errtext);
           return 1;
        end;
        SetOutput(ReportFileName);

        if( Key == 322/*K_F8*/ )
           PrintHead( "Žâç¥â ®¡ ®è¨¡ª å ¯à¨ ¬ áá®¢®¬ ã¤ «¥­¨¨ ®¯¥à æ¨©." );
        elif( Key == 367/*K_ALTF8*/ )
           PrintHead( "Žâç¥â ®¡ ®è¨¡ª å ¯à¨ ¬ áá®¢®¬ ¯¥à¥¬¥é¥­¨¨ ®¯¥à æ¨© ¢ ®â«®¦¥­­ë¥." );
        end;

        first = false;
     end;

     if( (DataSet.ErrMsg != NULL) and (DataSet.ErrMsg != "") )
        ErrMessage = DataSet.ErrMsg;
     else
        if( Key == 322/*K_F8*/ )
           ErrMessage = "Žè¨¡ª  ¯à¨ ã¤ «¥­¨¨ ®¯¥à æ¨¨";
        elif( Key == 367/*K_ALTF8*/ )
           ErrMessage = "Žè¨¡ª  ¯à¨ ¯¥à¥¬¥é¥­¨¨ ®¯¥à æ¨¨ ¢ ®â«®¦¥­­ë¥";
        end;
     end;

     PrintLine(DataSet.DealCode, DataSet.Error, ErrMessage);
  end;

  if( not first )
     PrintFooter();
     SetOutput(NULL, true);
     close(ReportOutFile);
     ViewFile(ReportOutFile);
  end;

  return 0;

OnError(e);
  var t = 0;
end;
