/* Внебиржевая операция
   Шаг: Подтверждение сделки */

import "dv_categ.mac";

macro ExecuteStep( doc, FDoc)

  record ndeal(dvndeal);

  SetBuff( ndeal, FDoc );

  /* 2 оч.: Выполнить печать тикета, распорядительной записки */
  // KS Если для валюты мы попадаем на выходной день, то надо запланировать блок "Исполнение обязательств"
  var FD = DVFirstDocFXDeal(DL_DVFXDEAL, ndeal);
  var _newStatus;
  var isEastCur = 0;
  if (FD.isclient() == false)
      if (not GetMainObjAttr( null, 2, strLpad(string(FD.ВалютаОбязательства()/*FD.nfi.rec.fiid*/), 10, "0"), 101, isEastCur))/*PNV i-support 500390 надо же проверять валюту обязательства, а не базовую валюту!*/
          isEastCur = 0;
     end;

     if ((FD.ДатаОбязательства()>=FD.deal.rec.date) and (isHoliday(FD.ДатаОбязательства()))or(isEastCur == 1))
          if (ndeal.kind == 12715)
              _newStatus = DV_OPERSTATUS_KIND_LIABILITY;
          else
              _newStatus = DV_OPERSTATUS_T3_KIND_LIABILITY;
          end;
          if( not InsertOprStatus(_newStatus, DV_FX_OPERSTATUS_DL_RUN) )
              MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
              return 1;
          end;
      end;
  end;

  return 0;
end;
