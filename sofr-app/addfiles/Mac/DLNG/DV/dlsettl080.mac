/*
$Name:        dlsettl080.mac
$Module:      Ядро Securities
$Description: Операция "Расчеты с биржей", Шаг Зачисление с другого клирингового счета
*/

import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_carop.mac";

PRIVATE VAR Dl_ValueData = TRecHandler( "dl_value.dbt");

MACRO ExecuteStep( Doc, FirstDoc, DocKind, ID_Operation, ID_Step )
  record comm( dl_comm );
  var    FD; 
  SetBuff( comm, FirstDoc );
  FD = DVFirstDocDLCOMM( comm );
  Var OperSubKindTemp;
  var AccBuff = TRecHandler("account"),
      AccBuffOther = TRecHandler("account"),
      PaymentObj:RsbPayment;

  if( (FD.ВидБиржевогоРынка() == DV_MARKETKIND_ALL) /*AND (Dl_ValueData.rec.SumFIID == NATCUR) ID : 514639 */ AND (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_OWN) ) // Golovkin с счета 30424 ЕП 
     if( not FD.IsExistAccount("+Обеспечение", null, true, null, AccBuff, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
        MsgBox("Ошибка: не открыт счет категории \"+Обеспечение\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;
  elif((Dl_ValueData.rec.SumFIID == NATCUR) or (comm.ContractKind == DV_MARKETKIND_STOCK)) // Golovkin + фондовый и единый пул сюда
     if( not FD.IsExistAccount("Клиринговый счет", null, true, DV_GetSettlFiRoleByOperSubKind(comm.OperSubKind,false), AccBuff, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
        MsgBox("Ошибка: не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;
  /*KD*/
  elif( (FD.ВидБиржевогоРынка() == DV_MARKETKIND_ALL) AND (FD.comm.rec.OperSubKind != ALG_SP_MONEY_SOURCE_OWN) AND FD.comm.rec.flag1 != "X") 
     if( not FD.IsExistAccount("Клиринговый счет", null, true, DV_GetSettlFiRoleByOperSubKind(comm.OperSubKind,false), AccBuff, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
        MsgBox("Ошибка: не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;
  elif( (FD.ВидБиржевогоРынка() == DV_MARKETKIND_ALL) AND (Dl_ValueData.rec.SumFIID != NATCUR) AND (FD.comm.rec.OperSubKind != ALG_SP_MONEY_SOURCE_OWN) AND FD.comm.rec.flag1 == "X" )
     if( not FD.IsExistAccount("+Обеспечение", null, true, null, AccBuff, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
        MsgBox("Ошибка: не открыт счет категории \"+Обеспечение\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;

  else
     if( not FD.IsExistAccount("+Биржа", null, true, null, AccBuff, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
        MsgBox("Ошибка: не открыт счет категории \"+Биржа\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;
  end;

  var marketName = "";
  var marketQuery = DL_RsdCommand("select * from ddlmarket_dbt where t_id = :mrktschmid");
      marketQuery.AddParam(Dl_ValueData.rec.MarketSchemeID);
  
  var marketScheme = marketQuery.execute();
  if(marketScheme.movenext)
      marketName = marketScheme.code;
  end;

  FD.SetDlMarketOther(Dl_ValueData.rec.MarketSchemeID);
  /*Переводим в рублях, с клиентского на собственный - для клиентов должен быть счет КУ Клиринговый счет*/
  if( (strUpr(marketName) != "ММВБ_ФР") AND DL_ЕдиныйПулОбеспеченияСобств AND (Dl_ValueData.rec.SumFIID == NATCUR) AND (FD.comm.rec.OperSubKind == ALG_SP_MONEY_SOURCE_OWN) AND (Dl_ValueData.rec.MoneySource == ALG_SP_MONEY_SOURCE_CLIENT AND (strUpr(marketName) == "КЛФОНДОВЫЙ_Т+_ЕП") ) ) 
       if( not FD.IsExistAccount("Клиринговый счет", null, true, DV_GetSettlFiRoleByOperSubKind(Dl_ValueData.rec.MoneySource,true), AccBuffOther, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
           MsgBox("Ошибка: не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
           return 1;
       end;  
  // Golovkin Если перевод собственных средств в рублях, клиринговый счет, с которого переводим, не рынка Т0 и включен режим единого пула обеспечения, то используем +Обеспечение
  elif( (strUpr(marketName) != "ММВБ_ФР") AND DL_ЕдиныйПулОбеспеченияСобств /*AND (Dl_ValueData.rec.SumFIID == NATCUR) ID : 514639 */ AND ((Dl_ValueData.rec.MoneySource == ALG_SP_MONEY_SOURCE_OWN) OR (Dl_ValueData.rec.MoneySource == ALG_SP_MONEY_SOURCE_CLIENT AND (strUpr(marketName) == "КЛФОНДОВЫЙ_Т+_ЕП") ) ) ) // Golovkin с счета 30424 ЕП 
     /*KD переопределим OperSubKind для такого случая, так как зачисляем с собственного счета, а в операции принадлежность "клиентская"*/
     If(comm.OperSubKind !=Dl_ValueData.rec.MoneySource) 
        OperSubKindTemp = FD.comm.rec.OperSubKind;
        FD.comm.rec.OperSubKind = Dl_ValueData.rec.MoneySource;
     end;
     if( not FD.IsExistAccount("+Обеспечение", null, true, null, AccBuffOther, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
        MsgBox("Ошибка: не открыт счет категории \"+Обеспечение\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
        return 1;
     end;
     /*KD вернем обратно после поиска счета*/

     If(comm.OperSubKind !=Dl_ValueData.rec.MoneySource) 
        FD.comm.rec.OperSubKind = OperSubKindTemp;
     end;
  elif( not FD.IsExistAccount("Клиринговый счет", null, true, DV_GetSettlFiRoleByOperSubKind(Dl_ValueData.rec.MoneySource,true), AccBuffOther, null, Dl_ValueData.rec.Date, Dl_ValueData.rec.SumFIID) )
     MsgBox("Ошибка: не открыт счет категории \"Клиринговый счет\" в валюте FIID = " + String(Dl_ValueData.rec.SumFIID));
     return 1;
  end;

  if( DVND_CreatePayment( FD, PM_PURP_ORDER, FD.Kind, FD.ID,
                          Dl_ValueData.rec.Date,
                          Comm.PartyID, {ourbank},
                          Comm.PartyID, {ourbank},
                          Dl_ValueData.rec.Sum, Dl_ValueData.rec.SumFIID,
                          "Зачисление с другого клирингового счета" + IIF(GetCodeParty("АО СПВБ",PTCK_CONTR) == FD.comm.rec.PartyID, " " + GetCodeParty(FD.comm.rec.PartyID,PTCK_CONTR), ""),
                          AccBuff, AccBuffOther,
                          comm.Division, NULL, NULL,
                          @PaymentObj
                        ) != 0 )
     return 1;
  end;

  if( not ПИ_ПроводкаПоПлатежу(FD, PaymentObj) )
     return 1;
  end;

  if( ПИ_ИсполнитьПлатеж(PaymentObj) )
     return 1;
  end;

  return 0;
end;
