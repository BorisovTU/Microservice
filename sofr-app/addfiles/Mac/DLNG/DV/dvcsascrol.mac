/*
$Name:        dvcsascrol.mac
$Module:      ФИССиКО
$Description: Макрос скроллинга соглашений CSA
*/
import DVInter;
import "dv_class.mac";

PRIVATE VAR Документ = TRecHandler("dvcsa");
PRIVATE VAR СтарыйДокумент = TRecHandler("dvcsa");
PRIVATE VAR CSApayment = TRecHandler("dvcsapm");


private macro РАБОТА_С_РЕПОЗИТАРИЕМ()
    const RegPath = "COMMON\\WORK_MODE\\IR_WORK_WITH_DERIVATIVES";
    var workWithRepository = "", err;
    
    GetRegistryValue(RegPath, V_BOOL, workWithRepository, err);
    
    if ( err != 0 )
        MsgBox( "Ошибка при получении значения настройки \"" + RegPath + "\"" );
    else
        if ( workWithRepository == SET_CHAR )
            return true;
        else
            return false;
        end;
    end;
end;

private macro GetSetupMessages(MessageCode:@string)
    var query = " SELECT * " +
                "   FROM DIR_SETUPMESSAGE_DBT STPMSG " +
                "  WHERE     T_KIND_OPERATION = 2795 " +
                "        AND T_REPORTING = CHR(88)";
    
    var cmd = RSDCommand(query);
    var DataSet = TRsbDataSet(cmd);
    var stat = 0;
    
    MessageCode = null;
    
    if( DataSet.moveNext )
        MessageCode = DataSet.MessageCode;
    end;
    
    if( not MessageCode )
        stat = 1;
    end;
    
    return stat;
end;

PRIVATE MACRO Новый_Документ()
    if( РАБОТА_С_РЕПОЗИТАРИЕМ() )
        var outMsg:string = "";
        GetSetupMessages(@outMsg);
        if( (outMsg != null) and (outMsg == "CM092") )
            Документ.rec.ReposRep = SET_CHAR;
        else
            Документ.rec.ReposRep = UNSET_CHAR;
        end;
    end;
    
    return 0;
END;

PRIVATE MACRO Проверить_Документ()
    return 0;
END;

/* Макрофункция вызывается по Ctrl-Z из скроллинга */
PRIVATE MACRO Функция_Пользователя()
    return 0;
END;

PRIVATE MACRO MarginPaymPreprocess()
    return 0;
END;