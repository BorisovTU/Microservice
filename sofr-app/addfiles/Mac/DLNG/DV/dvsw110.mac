/*
$Name:        dvsw110.mac
$Module:      Производные инструменты
$Description: Валютный СВОП. Шаг "Постановка на баланс"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac", "dv_period.mac";

/*PNV*/
private macro PartyIsNotResident( PartyID )
   var PartyObj:RsbParty = RsbParty( PartyID );
   return PartyObj.IsNotResident;
end;
/*PNV*/

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  RECORD ndeal(dvndeal);
  RECORD ВыбытиеПФИ(account);
  VAR ДатаИсполненияШага, FD, RestAcc;

  SetBuff( ndeal, FDoc );

  FD = DVFirstDocNDeal(DocKind, ndeal);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;

  ДатаИсполненияШага = DV_GetPlanDateStep(ID_Operation, ID_Step);
  if( ДатаИсполненияШага == date(0,0,0) )
     ДатаИсполненияШага = FD.ДатаИсполнения();
  end;

  /*PNV i-support 493230*/
  if (FD.Биржевая() and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) and ((not FD.IsClient()) and (not FD.ВалютныйРынок())) and (not FD.РынокСПФИ()) )/*bpv кроме валютки*/ /*PDV 529609*/
   // if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
      MsgBox("Не выполнена переоценка справедливой стоимости!");
      return 1;
  end;
  /*PNV i-support 493230*/

  if( (not FD.IsClient()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) and (FD.deal.rec.Kind != 2710) and (FD.deal.rec.Kind != 22710)  and (FD.deal.rec.Kind != 32710) and (FD.Биржевая()))/*PNV i-support 493230*/
     if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );
  var ПлатежОб   = RsbPayment( FD.ПлатежОб.rec.PaymentID );
  /* устанавливаем признак участия в неттинге */
  if ( (DL_ЕдиныйПулОбеспеченияСобств == 1) and (FD.Биржевая()) and (not FD.IsClient()) )
  elif( (FD.IsClient() == false) and (FD.deal.rec.Netting == SET_CHAR))
     if( FD.ПлатежТреб.rec.PaymentID > 0 )
        ПлатежТреб.Netting = SET_CHAR;
     end;

     if( FD.ПлатежОб.rec.PaymentID > 0 )
        ПлатежОб.Netting = SET_CHAR;
     end;
  end;
  //mda 19/02/19 Назначение платежей!
  if( FD.ПлатежОб.rec.PaymentID > 0 )
     if ((ПлатежОб.OutCorschem != -1 ) and (IsCorschem_LORO (ПлатежОб.OutCorschem, ПлатежОб.basefiid)) )
         if (PartyIsNotResident(ПлатежОб.receiver))
             ПлатежОб.Ground =  FD.GetGround(1007);/*PNV*/
         else
             ПлатежОб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
     else
         if (FD.ПлатежОб.rec.BaseFiid != NATCUR )
             ПлатежОб.Ground =  FD.GetGround(1007);/*PNV*/
         elif (FD.IsOption())
             ПлатежОб.Ground = FD.GetGround(1004);
         else
             ПлатежОб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
     end;  
  end;
  /*PNV*/
  if( FD.ПлатежТреб.rec.PaymentID > 0 )
     if ((ПлатежТреб.OutCorschem != -1 ) and (IsCorschem_LORO (ПлатежТреб.OutCorschem, ПлатежТреб.basefiid)) )
         if (PartyIsNotResident(ПлатежТреб.receiver))
             ПлатежТреб.Ground =  FD.GetGround(1007);/*PNV*/
         else 
             ПлатежТреб.Ground =  FD.GetGround(1006);/*PNV*/
         end;
     else
        if (FD.ПлатежТреб.rec.BaseFiid != NATCUR)
            ПлатежТреб.Ground =  FD.GetGround(1007);/*PNV*/
        else    
            ПлатежТреб.Ground =  FD.GetGround(1006);/*PNV*/
        end;
     end;
  end;
  /*PNV*/

  if ( АктуализироватьПлатежи(FD, ДатаИсполненияШага) != 0 )
     return 1;
  end;

  if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( FD.ПоставочныйКонтракт() )
     if( ОтражениеСуммыТО( FD, doc, ДатаИсполненияШага ) != 0 )
         return 1;
     end;
  end;

  /*if ( (FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) or ( (FD.deal.rec.kind == 22710) and (FD.Биржевая()))  )/*Сделка Т+3 на бирже, по ним вар.маржа*/
    if( ОтнесениеФинРезультата( FD, doc, ДатаИсполненияШага ) != 0 )
       return 1;
    end;
  end;*/
  /*PNV вынесено на отдельный шаг*/

  if (GetOprStatus(DV_OPERSTATUS_EARLY_SETTLEMENT) != DV_EARLY_SETT_OPERSTATUS_YES)

  if( not InsertOprStatus(FD.DV_OPERSTATUS_DEMAND(), DV_OPERSTATUS_DL_RUN) )
     MsgBox("Ошибка при установке статуса <Требования> по операции.");
     return 1;
  end;

  if( not InsertOprStatus(FD.DV_OPERSTATUS_LIABILITY(), DV_OPERSTATUS_DL_RUN ) )
     MsgBox("Ошибка при установке статуса <Обязательства> по операции.");
     return 1;
  end;

  end;

  return 0;
end;
