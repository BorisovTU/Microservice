/*
$Name:        dvnop038.mac
$Module:      Производные инструменты
$Description: Процентный СВОП. Шаг: Исполнение 1ч
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac";

macro ExecuteStep( doc, FDoc, DocKind, ID_Operation, ID_Step )

  /* FD.БазовыеВалютыРавны() == false */

  record ndeal(dvndeal);
  var FD;
  var ДатаИсполненияШага:date;
  SetBuff( ndeal, FDoc );
  FD = DVFirstDocNDeal(DocKind, ndeal);
  if (FD.ОтказОтИсполнения())
     return 0;
  end;
  GetOprDate( DV_NDEAL_OPRDATE_EXEC, ДатаИсполненияШага );

  if( (not FD.IsClient()) and (not FD.БиржеваяСделкаКромеВнебиржСПФИ()) and (not FD.ВыполненаПереоценкаСС(ДатаИсполненияШага)) )
     if( MsgBoxEx( "Не выполнена переоценка справедливой стоимости!|Продолжить?", MB_YES+MB_NO, IND_NO ) == IND_NO )
        return 1;
     end;
  end;

  var ПлатежТреб = RsbPayment( FD.ПлатежТреб.rec.PaymentID );
  var ПлатежОб = RsbPayment( FD.ПлатежОб.rec.PaymentID );
  var stat = true;
  var findAccount = "";

  if (ПлатежТреб.PaymStatus == PM_OVERDUE)
      stat = FD.FindNumberAccount( "Треб. с н.с.",  FindAccount );
      ПлатежТреб.FutureReceiverAccount = FindAccount;
  end;

  if (ПлатежОб.PaymStatus == PM_OVERDUE)
      stat = FD.FindNumberAccount( "Обяз. с н.с.",  FindAccount );
      ПлатежОб.FuturePayerAccount = FindAccount;
  end;

  if( СписаниеТребованияИОбязательства( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( ОтражениеСуммыТО( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( ОтнесениеФинРезультата( FD, doc, ДатаИсполненияШага ) != 0 )
     return 1;
  end;

  if( FD.СобствБиржеваяСделка() )
     if( ИсполнитьОбязательство(FD, ДатаИсполненияШага, doc) != 0 )
        return 1;
     end;

     if( ИсполнитьТребование(FD, ДатаИсполненияШага, doc) != 0 )
        return 1;
     end;

     if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_OD(), DV_OPERSTATUS_PAYM_NOTEX) )
        MsgBox("Ошибка при установке статуса <Неттинг платежей Т/О 1ч> для операции.");
        return 1;
     end;
  else
/*
  if( FD.Netting() )
     if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_OD(), DV_OPERSTATUS_PAYM_EX) )
        MsgBox("Ошибка при установке статуса <Неттинг платежей Т/О 1ч> для операции.");
        return 1;
     end;
  else
     if( ИсполнитьОбязательство(FD, ДатаИсполненияШага, doc) != 0 )
        return 1;
     end;

     if( ИсполнитьТребование(FD, ДатаИсполненияШага, doc) != 0 )
        return 1;
     end;

     if( not InsertOprStatus(FD.DV_OPERSTATUS_NETTING_PAYM_OD(), DV_OPERSTATUS_PAYM_NOTEX) )
        MsgBox("Ошибка при установке статуса <Неттинг платежей Т/О 1ч> для операции.");
        return 1;
     end;
  end;
*/

    if( FD.IsPctSWAP() and (FD.БазовыеВалютыРавны() == false) and (FD.ВидБазовогоАктива() == FIKIND_CURRENCY) )
      var FD2 = DVFirstDocNDeal(DocKind, ndeal, 2);
      var ДатаИсполненияШага_ч2:date;
      GetOprDate( DV_NDEAL_OPRDATE_EXEC_2, ДатаИсполненияШага_ч2 );  
      if ( АктуализироватьПлатежи(FD2, ДатаИсполненияШага_ч2) != 0 )
         return 1;
      end;
    end;
  end;

/*
  if( not InsertOprStatus(FD.DV_OPERSTATUS_EXEC(), DV_OPERSTATUS_EXEC_CLOSE) )
     MsgBox("Ошибка при установке статуса <Исполнение> по операции.");
     return 1;
  end;
*/
  return 0;
end;
