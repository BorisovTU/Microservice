/** 
 @file  dvop034.mac
 @brief Операция расчетов на срочном рынке. Шаг "Переоценка по расчетной цене"

 Исполнение шага "Переоценка по расчетной цене" 

 # tag
 - functional_block:Лимиты
 - code_type:BP_Step

 # changeLog 
 |date       |author         |tasks            |note                            
 |-----------|---------------|-----------------|--------------------------------------------
 |2023.09.19 |Швецов  Я. А.  |CCBO-7598        | Добавлены комментарии, отформатирован текст          
 |           |               |                 |                 

*/

import "dvOperSt.mac";

/**
 @brief Исполнение шага
 @param[in] Doc  Буфер временного файла операций
 @param[in] FDoc Первичный документ операции (dvoper.dbt)
 @return         Флаг исполнения шага (0 - исполнен без ошибок, 1 - с ошибками)
*/
macro ExecuteStep( Doc, FDoc, DocKind, ID_Operation, ID_Step )
  record oper(dvoper);

  SetBuff( oper , FDoc );
  accDvdealTrnArr.size = 0;
  //Переоценка требований/обязательств позиций/сделок по фьючерсам и по опционам на фьючерс по расчетной цене фьючерса
  if( УчетБиржевыхКонтрактов() == DV_ACCEXCONTR_DEAL )
    if( ПереоценкаПоРасчЦенеПоСделке(Doc, oper) != 0 )
      return 1;
    end;
  else
    if( ПереоценкаПоРасчЦенеПоПозиции(Doc, oper) != 0 )
      return 1;
    end;
  end;

  if ( not InsertDvdealTrnLink(ID_Operation, ID_Step) )
    MsgBox("Ошибка при сохранении информации о связи проводок со сделками срочного рынка");
    return 1;
  end;

  return 0;
end;
