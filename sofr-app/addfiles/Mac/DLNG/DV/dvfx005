/*
$Name:        dvfx005.mac
$Module:      Производные инструменты
$Description: Конверсионная операция. Шаг "Настройка операции"
*/
import InsCarryDoc, "dv_categ.mac", "dv_car.mac",dv_lib;

  record deal(dvndeal);


macro executeParamStep( kind_oper, BOf_kind, FDoc )

  var    FD, FD2;

  SetBuff(deal, FDoc);
  FD = DVFirstDocFXDeal(DL_DVFXDEAL, deal);

  DefineOprDate(DV_FXDEAL_OPRDATE_BEGIN_OP, FD.ДатаСделки());
  DefineOprDate(DV_FXDEAL_OPRDATE_EXEC,     FD.ДатаИсполнения());
  DefineOprDate(DV_FXDEAL_OPRDATE_REQ,      FD.ДатаТребования());
  DefineOprDate(DV_FXDEAL_OPRDATE_OBL,      FD.ДатаОбязательства());
  DefineOprDate(DV_FXDEAL_OPRDATE_COMISS,   DL_GetMinComPlanDateByOper(FD.Kind, FD.ID));

  if( FD.IsSWAP() )
     FD2 = DVFirstDocFXDeal(DL_DVFXDEAL, deal, 2);

     DefineOprDate(DV_FXDEAL_OPRDATE_EXEC_2, FD2.ДатаИсполнения());
     DefineOprDate(DV_FXDEAL_OPRDATE_REQ_2,  FD2.ДатаТребования());
     DefineOprDate(DV_FXDEAL_OPRDATE_OBL_2,  FD2.ДатаОбязательства());
     DefineOprDate(DV_FXDEAL_OPRDATE_CLOSE,  FD2.ДатаЗавершения());
  else
     DefineOprDate(DV_FXDEAL_OPRDATE_CLOSE,  FD.ДатаЗавершения());
  end;

  if( ПИ_ИнтегрРежимРаботы() and FD.IsBNote() )
     if( not УстановитьКатегориюПрихКассСимвол(FD, OBJTYPE_FXOPER_DV, FD.ДатаСделки()) )
        return 1;
     end;
     if( not УстановитьКатегориюРасхКассСимвол(FD, OBJTYPE_FXOPER_DV, FD.ДатаСделки()) )
        return 1;
     end;
  end;

  return 0;
end;



MACRO PostStep (    
                CommitOrRollback, /*1-выполнение шага,2 -откат шага*/
                errTrn,        /* Статус выполнения шага-!0-произошла ошибка */
                FirstDoc,      /* Указатель на первичный документ */
                ID_Operation,  /* Номер экземпляра операции */
                Num_Step,      /* Номер шага операции(из настроек) */
                Kind_Operation,/* Вид операции */
                KindDoc,       /* Вид первичного документа */
                KindStep,      /* Вид шага операции */
                ID_Step)       /* Номер шага операции */  

   var rs51,rs2,que,npack,da,paymentid,su;

  SetBuff(deal, FirstDoc);


  if ( CommitOrRollback == 1 )
      paymentid=plat_dil5(deal.id,4813,1,"paymentid");
      su=1000.00;
      que = "update dpmpaym_dbt SET  t_FUTUREPAYERAMOUNT = '"+su+"' ,  t_FUTURERECEIVERAMOUNT = '"+su+"' ,  t_BASEAMOUNT = '"+su+"' , t_AMOUNT = '"+su+"' ,  t_PAYAMOUNT ='"+su+"' ";
      que=que+" where t_paymentid = "+paymentid; 
      rs51 = LnGetRecordSet(que);
  end;
  

  return 0;
END;

