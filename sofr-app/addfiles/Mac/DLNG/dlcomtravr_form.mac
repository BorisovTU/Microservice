/*
$Name:        dlcomtravr_form.mac
$Module:      Ядро Securities
$Description: Отчет "Поручение на перевод ценных бумаг"
*/

/********************************************************************************
 DESCRIPTION  :   Отчет "Поручения на перевод ценных бумаг"
                   - форма ввода данных (общая для БОЦБ, УВ и ПИ)
 PROGRAMMED BY:   Shalygo
 CREATION DATE:   24.02.2009
*******************************************************************************/
import "DlRepForm_h.mac", "globals.mac";

CONST PNFLD_COMTRAVR_CLIENT_CODE              = 0,       /* Клиент               */
      PNFLD_COMTRAVR_CLIENT_NAME              = 1,       /*                      */
      PNFLD_COMTRAVR_ISFORM                   = 2,       /*                      */
      PNFLD_COMTRAVR_FORMSUB                  = 3,       /* Форма субъекта       */
      PNFLD_COMTRAVR_ISVID                    = 4,       /*                      */
      PNFLD_COMTRAVR_VIDSUB                   = 5,       /* Вид субъекта         */
      PNFLD_COMTRAVR_NORESIDENT               = 6,       /* Флаг резидентности   */
      PNFLD_COMTRAVR_SERVICE_KIND_BO          = 7,       /* Фондовый дилинг      */
      PNFLD_COMTRAVR_CONTR_NAME               = 8,       /* Договор              */
      PNFLD_COMTRAVR_PRINT_OPERATIONS_PLANNED = 9,       /* Включать планируемые */
      PNFLD_COMTRAVR_BEGINDATE                = 10,       /* Дата начала          */
      PNFLD_COMTRAVR_ENDDATE                  = 11,       /* Дата завершения      */
      PNFLD_COMTRAVR_OPER_NUM                 = 12,       /* Операционист         */
      PNFLD_COMTRAVR_OPER_NAME                = 13,       /*                      */
      PNFLD_COMTRAVR_WITH_APP                 = 14;      /* С апострофами        */

CLASS Dl_ComTrAvr_Form_Data()
  VAR 
  ClientCode,
  ClientName,
  IsForm,
  FormSub,
  IsVid,
  VidSub,
  Noresident,
  ServKind_BO,
  ContrName,
  OperPlanned,
  BegDate,
  EndDate,
  OperNum,
  OperName,
  IsUseApp;

  ClientCode = -1;
  ClientName = -1;
  IsForm     =   0;
  FormSub    =   0;
  IsVid      =   0;
  VidSub     =   0;
  Noresident =  "";
  ServKind_BO = "X";
  ContrName = -1;
  OperPlanned = "X";
  BegDate = {curdate};
  EndDate = {curdate};
  OperNum = {oper};
  OperName = "";
  IsUseApp = "X";

END;

VAR DlComTrAvrRepFormData = Dl_ComTrAvr_Form_Data();

PRIVATE CONST
  H_CLIENT_CODE     = 101,
  H_PNFLD_OPERNUM   = 102,
  H_ISFORM          = 103,
  H_FORMSUB         = 104,
  H_ISVID           = 105,
  H_VIDSUB          = 106; 
PRIVATE MACRO DL_FldProc_FormSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if(FldRealValue == 0)
    FldShowValue = "";
  end;
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))
     DL_ListNA( 3400, @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), NULL );
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_VidSub( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT )
  if(FldRealValue == 0)
    FldShowValue = "";
  end;
  if((Cmd == DLG_KEY) AND (Key == KEY_F3))

    return DL_ComboBox( "select t_Name2, t_PartyKind from dptkind_dbt ",
                        "t_Name2", "t_PartyKind", 
                        @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY()
                      );

  end; 
END;

PRIVATE MACRO DL_FldProc_IsFormVid( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT, pos:INTEGER):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
    if ( FldRealValue == 0)
        FldShowValue = "=";
        FldRealValue = "1";
        EnableFields( pThis.Data(), pos );

    elif(FldRealValue == 1)
        FldShowValue = "!";
        FldRealValue = "2";
    else
        FldShowValue = "";
        FldRealValue = "0";
        DisableFields( pThis.Data(), pos );
    end;
  end;
  return CM_DEFAULT;        
END;

PRIVATE MACRO DL_FldProc_IsFormVid1( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_COMTRAVR_FORMSUB);
	 if (FldRealValue==0)
			pThis.SetLinkedValue( H_FORMSUB, 0 );
	 end;
  end;
END;

PRIVATE MACRO DL_FldProc_IsFormVid2( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if((Cmd == DLG_KEY) AND (Key == KEY_SPACE))
     DL_FldProc_IsFormVid( pThis, Cmd, Key, @FldShowValue, @FldRealValue, PNFLD_COMTRAVR_VIDSUB);
	 if (FldRealValue==0)
			pThis.SetLinkedValue( H_VIDSUB, 0 );
	 end;
  end;
END;

PRIVATE MACRO DLUSR_FldProc_ClientContr( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  var ClientID =  -1;
  var ServKind = TArray();

  ClientID = pThis.GetFieldValue( PNFLD_COMTRAVR_CLIENT_CODE );
  
  if( Cmd == DLG_INIT )
     if( FldRealValue == null )
        FldRealValue = -1;
     end;
     if( FldRealValue <= 0 )                           
        FldShowValue = STR_ALLVALUE;
     end;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_SPACE) )
     FldRealValue = -1;
     FldShowValue = STR_ALLVALUE;
  elif( (Cmd == DLG_KEY) AND (Key == KEY_F3) AND
        (ClientID > 0) )
     ServKind[ServKind.Size] = 1;
     DL_ListSfContrByServKind( @FldShowValue, @FldRealValue, pThis.CurrentFldX(), pThis.CurrentFldY(), ClientID, ServKind ); 
  end;
  return CM_DEFAULT;
END;

PRIVATE MACRO Default( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
  if( Cmd == DLG_INIT )
    FldShowValue = FldRealValue;
  elif( Cmd == DLG_CHANGEVALUE ) /*значение поля было изменено*/
    FldRealValue = FldRealValue;
  end;
  return CM_DEFAULT;
END;
                    
CLASS (DL_CPanel) DL_ComTrAvr_Panel()

  PRIVATE MACRO Init()

     AddFieldProc( 0, PNFLD_COMTRAVR_CLIENT_CODE,              H_CLIENT_CODE,             @DL_FldProc_SecClient,      DlComTrAvrRepFormData.ClientCode);
     AddFieldProc( 0, PNFLD_COMTRAVR_CLIENT_NAME,              DL_PNFLD_CLIENT_NAME_OFBU, @Default,                   DlComTrAvrRepFormData.ClientName);

     AddFieldProc( 0, PNFLD_COMTRAVR_ISFORM,                   H_ISFORM,                  @DL_FldProc_IsFormVid1,     DlComTrAvrRepFormData.IsForm);
     AddFieldProc( 0, PNFLD_COMTRAVR_FORMSUB,                  H_FORMSUB,                 @DL_FldProc_FormSub,        DlComTrAvrRepFormData.FormSub, 28, 9);
     AddFieldProc( 0, PNFLD_COMTRAVR_ISVID,                    H_ISVID,                   @DL_FldProc_IsFormVid2,     DlComTrAvrRepFormData.IsVid);
     AddFieldProc( 0, PNFLD_COMTRAVR_VIDSUB,                   H_VIDSUB,                  @DL_FldProc_VidSub,         DlComTrAvrRepFormData.VidSub , 28, 10);
     AddFieldProc( 0, PNFLD_COMTRAVR_NORESIDENT,               DL_PNFLD_CHECKBOX,         @DL_FldProc_CheckBox,       DlComTrAvrRepFormData.Noresident);

     AddFieldProc( 0, PNFLD_COMTRAVR_SERVICE_KIND_BO,          DL_PNFLD_CHECKBOX,         @Default,                   DlComTrAvrRepFormData.ServKind_BO);
                                                                                         
     AddFieldProc( 0, PNFLD_COMTRAVR_CONTR_NAME,               DL_PNFLD_CONTRACT_OFBU,    @DLUSR_FldProc_ClientContr, DlComTrAvrRepFormData.ContrName);
                                                                                         
     AddFieldProc( 0, PNFLD_COMTRAVR_PRINT_OPERATIONS_PLANNED, DL_PNFLD_CHECKBOX,         @DL_FldProc_CheckBox,       DlComTrAvrRepFormData.OperPlanned);
                                                                                         
     AddFieldProc( 0, PNFLD_COMTRAVR_BEGINDATE,                DL_PNFLD_BEGINDATE,        @DL_FldProc_BeginDate,      DlComTrAvrRepFormData.BegDate);
     AddFieldProc( 0, PNFLD_COMTRAVR_ENDDATE,                  DL_PNFLD_ENDDATE,          @DL_FldProc_EndDate,        DlComTrAvrRepFormData.EndDate );                 
                                                                                         
     AddFieldProc( 0, PNFLD_COMTRAVR_OPER_NUM,                 H_PNFLD_OPERNUM,           @DL_FldProc_OperName,       DlComTrAvrRepFormData.OperNum );                 
     AddFieldProc( 0, PNFLD_COMTRAVR_OPER_NAME,                DL_PNFLD_OPERNAME,         @Default,                   DlComTrAvrRepFormData.OperName);
                                                                                         
     AddFieldProc( 0, PNFLD_COMTRAVR_WITH_APP,                 DL_PNFLD_CHECKBOX,         @DL_FldProc_CheckBox,       DlComTrAvrRepFormData.IsUseApp);

     DisableFields( This.Data(), PNFLD_COMTRAVR_SERVICE_KIND_BO );/*только по БОЦБ*/
	 if(this.GetFieldValue( PNFLD_COMTRAVR_ISFORM ) == 0)
     DisableFields( This.Data(), PNFLD_COMTRAVR_FORMSUB ); 
     end;
	 if(this.GetFieldValue( PNFLD_COMTRAVR_ISVID ) == 0)
     DisableFields( This.Data(), PNFLD_COMTRAVR_VIDSUB ); 
     end;

  END;

  PRIVATE MACRO Check():BOOL
     return true;
  END;
  
  initDL_CPanel( "sp_res.lbr", "COMTRAVR" );
 
END;