/*
$Name:        dlgenagr20.mac
$Module:      Dealing
$Description: Актуализация счетов по ген. соглашению
*/

IMPORT mmcnst_j, mmcateg, RsbDataSet, dlgenagrfd, mctplprm;

RECORD genagr(dl_genagr);

PRIVATE VAR
    ProgressIDX = 0;

PRIVATE VAR
    ARR_DIRECTION  = TArray,
    ARR_STATECONT  = TArray,
    ARR_TOOLCATEG  = TArray,
    ARR_OTNSEBES   = TArray,
    ARR_DIRECTIONP = TArray,
    ARR_FINDATE    = TArray,
    ARR_FIID       = TArray,
    ARR_DEALTYPE   = TArray,
    ARR_ISSWAP     = TArray;

PRIVATE MACRO ОткрытьСчетаПоГС_МБК(Categ, fd, ActionDate, FiRole)
    var
        i1 = 0, i2 = 0, i3 = 0, i4 = 0, i5 = 0, i6 = 0, i7 = 0,
        FindAccount = "", FiRole_l, isFirstFINDATE = true;

    while (i1 < ARR_DIRECTION.size)
        i2 = 0;
        while (i2 < ARR_STATECONT.size)
           i3 = 0;
            while (i3 < ARR_TOOLCATEG.size)
               i4 = 0;
                while (i4 < ARR_OTNSEBES.size)
                   i5 = 0;
                    while (i5 < ARR_DIRECTIONP.size)
                       i6 = 0;
                        isFirstFINDATE = true;
                        while (i6 < ARR_FINDATE.size)
                           if (ValType(ARR_FINDATE[i6]) == V_UNDEF)
                              break;
                           elif (ValType(ARR_FINDATE[i6]) == V_DATE)
                               if ((ARR_FINDATE[i6] > (genagr.Start + genagr.Duration))and
                                   (isFirstFINDATE == false))
                                   break;
                               end;
                               if (ARR_FINDATE[i6] >= (genagr.Start + genagr.Duration))
                                   isFirstFINDATE = false;
                               end;
                           end;

                           i7 = 0;
                            while (i7 < ARR_FIID.size)
                                fd.SetUsParametr(MC_TYPE_USPARAMETR_DIRECTION,  ARR_DIRECTION[i1]);
                                fd.SetUsParametr(MC_TYPE_USPARAMETR_STATECONT,  ARR_STATECONT[i2]);
                                fd.SetUsParametr(MC_TYPE_USPARAMETR_TOOLCATEG,  ARR_TOOLCATEG[i3]);
                                fd.SetUsParametr(MC_TYPE_USPARAMETR_OTNSEBES,   ARR_OTNSEBES[i4]);
                                fd.SetUsParametr(MC_TYPE_USPARAMETR_DIRECTIONP, ARR_DIRECTIONP[i5]);
                                fd.SetParametr(MC_TYPE_PARAMETR_FINDATE,        ARR_FINDATE[i6]);
                                if (ARR_FIID[i7] != -1)
                                    fd.SetParametr(MC_TYPE_PARAMETR_CURRENCY,       ARR_FIID[i7]);
                                    fd.SetParametr(MC_TYPE_PARAMETR_FIID,           ARR_FIID[i7]);
                                    fd.SetParametr(MC_TYPE_PARAMETR_PAYCURRENCY,    ARR_FIID[i7]);
                                end;

                                if (FiRole == NULL)
                                    FiRole_l = fd.GetFIRoleByCategory(Categ, ARR_FIID[i7]);
                                else
                                    FiRole_l = FiRole;
                                end;

                                if (not fd.OpenAccount(Categ, FindAccount, NULL, FiRole_l, NULL, ActionDate, ARR_FIID[i7]))
                                    return false;
                                end;
                                i7 = i7 + 1;

                                UseProgress(ProgressIDX = ProgressIDX + 1);
                            end;
                            i6 = i6 + 1;
                        end;
                        i5 = i5 + 1;
                    end;
                    i4 = i4 + 1;
                end;
                i3 = i3 + 1;
            end;
            i2 = i2 + 1;
        end;
        i1 = i1 + 1;
    end;

    return true;
END;

PRIVATE MACRO ОткрытьСчетаПоГС_КО(Categ, fd, ActionDate, FiRole)
    var
        i1 = 0, i2 = 0, i3 = 0, i4 = 0,
        FindAccount = "", FiRole_l, isFirstFINDATE = true;

    while (i1 < ARR_ISSWAP.size)
        i2 = 0;
        while (i2 < ARR_DEALTYPE.size)
           i3 = 0;
            isFirstFINDATE = true;
            while (i3 < ARR_FINDATE.size)
                if (ValType(ARR_FINDATE[i3]) == V_UNDEF)
                   break;
                elif (ValType(ARR_FINDATE[i3]) == V_DATE)
                    if ((ARR_FINDATE[i3] > (genagr.Start + genagr.Duration))and
                        (isFirstFINDATE == false))
                        break;
                    end;
                    if (ARR_FINDATE[i3] >= (genagr.Start + genagr.Duration))
                        isFirstFINDATE = false;
                    end;
                end;

                i4 = 0;
                while (i4 < ARR_FIID.size)

                    fd.SetUsParametr(MC_TYPE_USPARAMETR_ISSWAP,    ARR_ISSWAP[i1]);
                    fd.SetUsParametr(MC_TYPE_USPARAMETR_DEALTYPE,  ARR_DEALTYPE[i2]);
                    fd.SetParametr(MC_TYPE_PARAMETR_FINDATE,        ARR_FINDATE[i3]);
                    if (ARR_FIID[i4] != -1)
                        fd.SetParametr(MC_TYPE_PARAMETR_FIID, ARR_FIID[i4]);
                    end;

                    FiRole_l = fd.GetFIRoleByCategory(Categ, ARR_FIID[i4], FiRole);

                    if (not fd.OpenAccount(Categ, FindAccount, NULL, FiRole_l, NULL, ActionDate, ARR_FIID[i4]))
                        return false;
                    end;

                    UseProgress(ProgressIDX = ProgressIDX + 1);

                    i4 = i4 + 1;
                end;
                i3 = i3 + 1;
            end;
            i2 = i2 + 1;
        end;
        i1 = i1 + 1;
    end;

    return true;

END;

PRIVATE MACRO ClearUsParmArray()
    ARR_DIRECTION.size  = 0;
    ARR_STATECONT.size  = 0;
    ARR_TOOLCATEG.size  = 0;
    ARR_OTNSEBES.size   = 0;
    ARR_DIRECTIONP.size = 0;
    ARR_FINDATE.size    = 0;
    ARR_FIID.size       = 0;
    ARR_DEALTYPE.size   = 0;
    ARR_ISSWAP.size     = 0;

    ARR_DIRECTION[0]  = -1;
    ARR_STATECONT[0]  = -1;
    ARR_TOOLCATEG[0]  = -1;
    ARR_OTNSEBES[0]   = -1;
    ARR_DIRECTIONP[0] = -1;
    ARR_FINDATE[0]    = -1;
    ARR_FIID[0]       = -1;
    ARR_DEALTYPE[0]   = -1;
    ARR_ISSWAP[0]     = -1;	
END;

MACRO FillAllFI()
    var
        rs  = TRsbDataSet("select t_fiid as fiid from dfininstr_dbt where t_fi_kind = " + FIKIND_CURRENCY);

    ARR_FIID.size = 0;

    while (rs.MoveNext())
        ARR_FIID[ARR_FIID.size] = Int(rs.FIID);
    end;

    if (ARR_FIID.size == 0)
        ARR_FIID.[0] = -1;
    end;
END;

macro ExecuteStep(Buffer, Document)
    VAR
         FirstDoc = NULL, idx = 0;

    SetBuff(genagr, Document );

    FirstDoc = DLGenAgrFD(genagr.DocKind, genagr.GenAgrID);  

    InitProgress(-1, "Актуализация счетов по ГС", "Актуализация счетов по ГС" );

    // при автовыполнении шага после пролонгации срок еще старый, поэтому подправим его
    genagr.Duration = Int(FirstDoc.GetParametr(MC_TYPE_PARAMETR_FINDATE) - genagr.Start);

    if (genagr.DocKind == 4611) // Для ГС в МБК
//tdr_mainrest
        if (FirstDoc.GetParametrTemplate(OBJTYPE_KINDSUBJ, LLCLASS_KINDSUBJ_KONTRMM) == 1)   // Центробанк
            ClearUsParmArray();
            ARR_DIRECTION[0]  = 1;
            ARR_STATECONT[0]  = 1;
            ARR_STATECONT[0]  = 2;
            ARR_TOOLCATEG[0]  = 1;
            ARR_FINDATE[0]    = genagr.Start;
            ARR_FINDATE[1]    = genagr.Start + 1;
            ARR_FINDATE[2]    = genagr.Start + 7;
            ARR_FINDATE[3]    = genagr.Start + 30;
            ARR_FINDATE[4]    = genagr.Start + 90;
            ARR_FINDATE[5]    = genagr.Start + 180;
            ARR_FINDATE[6]    = genagr.Start + 200;
            ARR_FINDATE[7]    = genagr.Start + 500;
            FillAllFI();

            if (not ОткрытьСчетаПоГС_МБК(tdr_mainrest, FirstDoc, genagr.Start))
                RunError();
            end; 

            ClearUsParmArray();
            ARR_DIRECTION[0]  = 1;
            ARR_STATECONT[0]  = 1;
            ARR_TOOLCATEG[0]  = 2;
            ARR_TOOLCATEG[0]  = 3;
            ARR_FINDATE[0]    = genagr.Start;
            ARR_FINDATE[1]    = genagr.Start + 1;
            ARR_FINDATE[2]    = genagr.Start + 7;
            ARR_FINDATE[3]    = genagr.Start + 30;
            ARR_FINDATE[4]    = genagr.Start + 90;
            ARR_FINDATE[5]    = genagr.Start + 180;
            ARR_FINDATE[6]    = genagr.Start + 200;
            ARR_FINDATE[7]    = genagr.Start + 500;
            ARR_FINDATE[8]    = genagr.Start + 1500;
            FillAllFI();

            if (not ОткрытьСчетаПоГС_МБК(tdr_mainrest, FirstDoc, genagr.Start))
                RunError();
            end; 

            ClearUsParmArray();
            ARR_DIRECTION[0]  = 2;
            ARR_STATECONT[0]  = 1;
            ARR_TOOLCATEG[0]  = 2;
            ARR_FINDATE[0]    = genagr.Start;
            ARR_FINDATE[1]    = genagr.Start + 1;
            ARR_FINDATE[2]    = genagr.Start + 7;
            ARR_FINDATE[3]    = genagr.Start + 30;
            ARR_FINDATE[4]    = genagr.Start + 90;
            ARR_FINDATE[5]    = genagr.Start + 180;
            ARR_FINDATE[6]    = genagr.Start + 200;
            ARR_FINDATE[7]    = genagr.Start + 500;
            ARR_FINDATE[8]    = genagr.Start + 1500;
            FillAllFI();

            if (not ОткрытьСчетаПоГС_МБК(tdr_mainrest, FirstDoc, genagr.Start))
                RunError();
            end; 
        elif ((FirstDoc.GetParametrTemplate(OBJTYPE_KINDSUBJ, LLCLASS_KINDSUBJ_KONTRMM) == 2) or // КредОргРезидент
              (FirstDoc.GetParametrTemplate(OBJTYPE_KINDSUBJ, LLCLASS_KINDSUBJ_KONTRMM) == 3)) // Банк-нерезидент
            ClearUsParmArray();
            ARR_DIRECTION[0]  = 1;
            ARR_DIRECTION[1]  = 2;
            ARR_STATECONT[0]  = 1;
            ARR_TOOLCATEG[0]  = 1;
            ARR_TOOLCATEG[1]  = 2;
            ARR_FINDATE[0]    = genagr.Start;
            ARR_FINDATE[1]    = genagr.Start + 1;
            ARR_FINDATE[2]    = genagr.Start + 7;
            ARR_FINDATE[3]    = genagr.Start + 30;
            ARR_FINDATE[4]    = genagr.Start + 90;
            ARR_FINDATE[5]    = genagr.Start + 180;
            ARR_FINDATE[6]    = genagr.Start + 200;
            ARR_FINDATE[7]    = genagr.Start + 500;
            ARR_FINDATE[8]    = genagr.Start + 1500;
            FillAllFI();

            if (not ОткрытьСчетаПоГС_МБК(tdr_mainrest, FirstDoc, genagr.Start))
                RunError();
            end;

//tdr_exprestR
//tdr_exprestP
//tdr_exppercR
//tdr_exppercP
//tdr_perc_vb
//tdr_expperc_vb
//"Задолж.% по спис ОД (ВБ)"
//"Задолж. По ОД спис (ВБ)"
            ClearUsParmArray();
            FillAllFI();

            if (not ОткрытьСчетаПоГС_МБК(tdr_exprestR, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_exprestP, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_exppercR, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_exppercP, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК("Задолж.% по спис ОД (ВБ)", FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК("Задолж. По ОД спис (ВБ)", FirstDoc, genagr.Start))
                RunError();
            end;

//tdr_rezerve1
//tdr_rezerve2
//tdr_rez_mainrest
//tdr_rez_exprest
//tdr_rez_perc
//tdr_rez_expperc
        ClearUsParmArray();
        ARR_FIID[0]       = NATCUR;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rez_mainrest, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rez_exprest, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rez_perc, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rez_expperc, FirstDoc, genagr.Start))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rezerve1, FirstDoc, genagr.Start, FIROLE_RVPS))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rezerve1, FirstDoc, genagr.Start, FIROLE_RVP))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rezerve2, FirstDoc, genagr.Start, FIROLE_RVPS))
                RunError();
            end;

            if (not ОткрытьСчетаПоГС_МБК(tdr_rezerve2, FirstDoc, genagr.Start, FIROLE_RVP))
                RunError();
            end;
        end;

//tdr_claimR
//tdr_claimP
        ClearUsParmArray();
        FillAllFI();

        if (not ОткрытьСчетаПоГС_МБК(tdr_claimR, FirstDoc, genagr.Start))
            RunError();
        end; 
    
        if (not ОткрытьСчетаПоГС_МБК(tdr_claimP, FirstDoc, genagr.Start))
            RunError();
        end; 

//tdr_perc1R
//tdr_perc1P
//tdr_perc2R
//tdr_perc2P
//tdr_pennyR
//tdr_pennyP
        ClearUsParmArray();
        ARR_FIID[0]       = NATCUR;

        if (not ОткрытьСчетаПоГС_МБК(tdr_pennyR, FirstDoc, genagr.Start))
            RunError();
        end; 

        if (not ОткрытьСчетаПоГС_МБК(tdr_pennyP, FirstDoc, genagr.Start))
            RunError();
        end;


        if (not ОткрытьСчетаПоГС_МБК(tdr_perc1R, FirstDoc, genagr.Start))
            RunError();
        end; 

        if (not ОткрытьСчетаПоГС_МБК(tdr_perc2R, FirstDoc, genagr.Start))
            RunError();
        end; 

        if (not ОткрытьСчетаПоГС_МБК(tdr_perc1P, FirstDoc, genagr.Start))
            RunError();
        end; 

        if (not ОткрытьСчетаПоГС_МБК(tdr_perc2P, FirstDoc, genagr.Start))
            RunError();
        end;
    elif (genagr.DocKind == 4610)
        if (FirstDoc.GetUsParametr(MC_TYPE_USPARAMETR_ISMARKET))   // Ьиржа
;
//"+/- Биржа"
            ClearUsParmArray();
            ARR_DEALTYPE[0]   = DL_FORWARDDEAL;
            ARR_DEALTYPE[0]   = DL_SPOTDEAL;
            ARR_ISSWAP[0]     = -1;
            ARR_ISSWAP[1]     = 9;

            FillAllFI();

            if (not ОткрытьСчетаПоГС_КО("+Биржа", FirstDoc, genagr.Start, FIROLE_FIREQ))
                RunError();
            end;
    
            if (not ОткрытьСчетаПоГС_КО("-Биржа", FirstDoc, genagr.Start, FIROLE_FICOM))
                RunError();
            end; 
        else
//"+/- КВ, РКО"
//"+/- РС"
//"Резерв, договор"
            ClearUsParmArray();
            ARR_FIID[0]       = NATCUR;
            ARR_DEALTYPE[0]   = DL_FORWARDDEAL;
            ARR_DEALTYPE[0]   = DL_SPOTDEAL;
            ARR_ISSWAP[0]     = -1;
            ARR_ISSWAP[1]     = 9;

            if (not ОткрытьСчетаПоГС_КО("+КВ, РКО", FirstDoc, genagr.Start))
                RunError();
            end;
    
            if (not ОткрытьСчетаПоГС_КО("-КВ, РКО", FirstDoc, genagr.Start))
                RunError();
            end; 

            if (not ОткрытьСчетаПоГС_КО("+РС", FirstDoc, genagr.Start, FIROLE_RVP))
                RunError();
            end;
    
            if (not ОткрытьСчетаПоГС_КО("-РС", FirstDoc, genagr.Start, FIROLE_RVP))
                RunError();
            end; 

            if (not ОткрытьСчетаПоГС_КО("Резерв, договор", FirstDoc, genagr.Start, FIROLE_FIREQ))
                RunError();
            end; 
//"+/- Расчеты"
            ClearUsParmArray();
            FillAllFI();

            if (not ОткрытьСчетаПоГС_КО("+Расчеты", FirstDoc, genagr.Start, FIROLE_FIREQ))
                RunError();
            end;
    
            if (not ОткрытьСчетаПоГС_КО("-Расчеты", FirstDoc, genagr.Start, FIROLE_FICOM))
                RunError();
            end; 
        end;

//"+/- FOREX"
//"+/- ОТО"
        ClearUsParmArray();
        ARR_FIID[0]       = NATCUR;

        if (not ОткрытьСчетаПоГС_КО("+FOREX", FirstDoc, genagr.Start, FIROLE_INCOME))
            RunError();
        end;
    
        if (not ОткрытьСчетаПоГС_КО("-FOREX", FirstDoc, genagr.Start, FIROLE_EXPEND))
            RunError();
        end; 

        if (not ОткрытьСчетаПоГС_КО("+ОТО", FirstDoc, genagr.Start, FIROLE_FIREQ))
            RunError();
        end;
    
        if (not ОткрытьСчетаПоГС_КО("-ОТО", FirstDoc, genagr.Start, FIROLE_FICOM))
            RunError();
        end; 

//"+/- Форвард, прочие"
        ClearUsParmArray();
        FillAllFI();

        if (not ОткрытьСчетаПоГС_КО("+Форвард, прочие", FirstDoc, genagr.Start, FIROLE_FIREQ))
            RunError();
        end;
    
        if (not ОткрытьСчетаПоГС_КО("-Форвард, прочие", FirstDoc, genagr.Start, FIROLE_FICOM))
            RunError();
        end; 

//"+/- Форвард, дрейф"
        ClearUsParmArray();
        ARR_FINDATE[0]    = genagr.Start;
        ARR_FINDATE[1]    = genagr.Start + 1;
        ARR_FINDATE[2]    = genagr.Start + 7;
        ARR_FINDATE[3]    = genagr.Start + 30;
        ARR_FINDATE[4]    = genagr.Start + 90;
        ARR_FINDATE[5]    = genagr.Start + 180;

        FillAllFI();

        if (not ОткрытьСчетаПоГС_КО("+Форвард, дрейф", FirstDoc, genagr.Start, FIROLE_FIREQ))
            RunError();
        end;
    
        if (not ОткрытьСчетаПоГС_КО("-Форвард, дрейф", FirstDoc, genagr.Start, FIROLE_FICOM))
            RunError();
        end;
    end;

    RemProgress();

    return 0;

    OnError(err)
        RemProgress();
        return 1;
end;
