/*
$Name:         vsz2_10.mac
$Module:       Векселя банка
$Description:  Залог векселей. Возврат векселей из залога. Возврат векселя из залога
*/

IMPORT OprInter, vsdates, vszlib;

PRIVATE record ord("dl_order");
PRIVATE VAR StepDate;

PRIVATE MACRO Возвратить_залог(bnr, leg)
var
    stat = 0;

    if(VSZLIB_НужноОформлять(ord) and (not VSZLIB_ПроводкаЗалога("возврат", ord, bnr, leg, StepDate)))
        stat = 1;
    end;

    if(stat == 0)
        if(bnr.rec.BCStatus != VSBANNER_STATUS_PAWN)
            stat = Ошибка("Вексель " + VSZLIB_СерияНомерВекселя(bnr) + "| не в залоге");
        end;
    end;

    if(stat == 0)
        if(not ИзменитьВексель(bnr.rec.BCID, StepDate,
                             "bcstatus", VSBANNER_STATUS_SENDED))
            stat = Ошибка("Ошибка при изменении векселя");
        end;
    end;

    return stat;
END;

MACRO ExecuteStep(docbuf, ordbuf)
var
    stat = 0;

    SetBuff(ord, ordbuf);

    if(not VS_TestStepDate(DATE_PAWN_DOC, @StepDate, ord.SignDate))
        stat = 1;
    end;

    if(stat == 0)
        stat = ДляКаждогоВекселя(ord, @Возвратить_залог, null, null, "BL");
    end;

    return stat;
END;
