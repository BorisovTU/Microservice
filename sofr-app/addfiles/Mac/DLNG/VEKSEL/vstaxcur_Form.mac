/*
$Name:         vstaxcur_Form.mac
$Module:       ‚¥ªá¥«ï ¡ ­ª 
$Description:  âç¥â " «®£®¢ë© ãç¥â ®¯¥à æ¨© ¢ ¢ «îâ¥" - ä®à¬  ¢¢®¤  ¤ ­­ëå
*/

IMPORT "DlRepForm_h.mac", vslib;

// ®¬¥à  ¯®«¥© ¢ ä®à¬¥ ®âç¥â 
CONST
    PNFLD_VSBNRCUR_PERIOD     = 0, //  §¢ ­¨¥ ®âç¥â­®£® ¯¥à¨®¤ 
    PNFLD_VSBNRCUR_YEAR       = 1, // ƒ®¤ ®âç¥â­®£® ¯¥à¨®¤ 
    PNFLD_VSBNRCUR_BEGINDATE  = 2, // „ â  ­ ç «  ®âç¥â­®£® ¯¥à¨®¤ 
    PNFLD_VSBNRCUR_ENDDATE    = 3, // „ â  ®ª®­ç ­¨ï ®âç¥â­®£® ¯¥à¨®¤ 
    PNFLD_VSBNRCUR_CURCODE    = 4, // Š®¤ ¢ «îâë
    PNFLD_VSBNRCUR_CURNAME    = 5, //  §¢ ­¨¥ ¢ «îâë
    PNFLD_VSBNRCUR_DEPARTCODE = 6, // Š®¤ ä¨«¨ « 
    PNFLD_VSBNRCUR_DEPARTMENT = 7; //  ¨¬¥­®¢ ­¨¥ ä¨«¨ « 

PRIVATE CONST // ¡à ¡®âç¨ª¨ ¤«ï ­¥áâ ­¤ à­ëå ª®­âà®«®¢
    PNFLD_PERIOD = 100,
    PNFLD_YEAR   = 101;

PRIVATE MACRO FldProc_Period( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    FldShowValue = FldRealValue;
    return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_Year( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    FldShowValue = FldRealValue;
    return CM_DEFAULT;
END;

PRIVATE MACRO ClearPeriod( pForm )
    pForm.SetLinkedValue( PNFLD_PERIOD, "" );
    pForm.SetLinkedValue( PNFLD_YEAR, "" );
end;

PRIVATE MACRO MonthName( i )
    Array Months;

    Months(  0 ) = "Ÿ­¢ àì";
    Months(  1 ) = "”¥¢à «ì";
    Months(  2 ) = "Œ àâ";
    Months(  3 ) = "€¯à¥«ì";
    Months(  4 ) = "Œ ©";
    Months(  5 ) = "ˆî­ì";
    Months(  6 ) = "ˆî«ì";
    Months(  7 ) = "€¢£ãáâ";
    Months(  8 ) = "‘¥­âï¡àì";
    Months(  9 ) = "ªâï¡àì";
    Months( 10 ) = "®ï¡àì";
    Months( 11 ) = "„¥ª ¡àì";

    if( ( ValType( i ) == V_INTEGER ) and ( i >= 1 ) and ( i <= 12 ) )
        return Months( i - 1 );
    else
        return "";
    end;
END;

PRIVATE MACRO UpdatePeriod( BeginDate, EndDate, pForm )
    var bDay, bMonth, bYear, eDay, eMonth, eYear, ndDay, ndMonth, ndYear, NextDayDate,DayPeriod, MonthPeriod;

    DateSplit( BeginDate, bDay, bMonth, bYear );
    DateSplit( EndDate, eDay, eMonth, eYear );

    if( bDay != 1 ) // …á«¨ ­ ç «ì­®¥ ç¨á«® ­¥ 1 â® á®®â¢ ¯¥à¨®¤ ­¥áâ à­¤ à­ë©
        ClearPeriod( pForm );
        return;
    end;

    NextDayDate = DateAfterCalenDays( EndDate, 1 );
    DateSplit( NextDayDate, ndDay, ndMonth, ndYear );

    if( ( ndYear - bYear == 1 ) AND ( bYear == eYear ) AND ( ndMonth - bMonth == 0 ) AND ( eDay == 31 ) )
        pForm.SetLinkedValue( PNFLD_PERIOD, "ƒ®¤" );
        pForm.SetLinkedValue( PNFLD_YEAR, bYear );
    elif( ( ( ndMonth - bMonth == 3 ) AND ( eMonth < ndMonth ) AND ( bYear == eYear ) ) OR ( ( ndMonth - bMonth == -9 ) AND ( eMonth == 12 ) ) )
        if( bMonth == 1 )
            pForm.SetLinkedValue( PNFLD_PERIOD, "I Š¢ àâ «" );
            pForm.SetLinkedValue( PNFLD_YEAR, bYear );
        elif( bMonth == 4 )
            pForm.SetLinkedValue( PNFLD_PERIOD, "II Š¢ àâ «" );
            pForm.SetLinkedValue( PNFLD_YEAR, bYear );
        elif( bMonth == 7 )
            pForm.SetLinkedValue( PNFLD_PERIOD, "III Š¢ àâ «" );
            pForm.SetLinkedValue( PNFLD_YEAR, bYear );
        elif( bMonth == 10 )
            pForm.SetLinkedValue( PNFLD_PERIOD, "VI Š¢ àâ «" );
            pForm.SetLinkedValue( PNFLD_YEAR, bYear );
        else
            ClearPeriod( pForm );
        end;
    elif( DateAfterCalenMonths( BeginDate, 1 ) == NextDayDate )
        pForm.SetLinkedValue( PNFLD_PERIOD, MonthName( eMonth ) );
        pForm.SetLinkedValue( PNFLD_YEAR, bYear );
    else
        ClearPeriod( pForm );
    end;
end;

PRIVATE MACRO FldProc_BeginDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    DL_FldProc_BeginDate( pThis, Cmd, Key, @FldShowValue, @FldRealValue );
    if( Cmd == DLG_CHANGEVALUE ) // §­ ç¥­¨¥ ¯®«ï ¡ë«® ¨§¬¥­¥­®
        UpdatePeriod( FldRealValue, pThis.GetFieldValue( PNFLD_VSBNRCUR_ENDDATE ), pThis );
    end;
    return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_EndDate( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    DL_FldProc_EndDate( pThis, Cmd, Key, @FldShowValue, @FldRealValue );
    if( Cmd == DLG_CHANGEVALUE ) // §­ ç¥­¨¥ ¯®«ï ¡ë«® ¨§¬¥­¥­®
        UpdatePeriod( pThis.GetFieldValue( PNFLD_VSBNRCUR_BEGINDATE ), FldRealValue, pThis );
    end;
    return CM_DEFAULT;
END;

PRIVATE MACRO FldProc_FI( pThis:DL_CPanel, Cmd:INTEGER, Key:INTEGER, FldShowValue:@VARIANT, FldRealValue:@VARIANT ):INTEGER
    RECORD FI( fininstr );
    if( ( Cmd == DLG_KEY ) AND ( Key == KEY_F3 ) ) // ‚ë§®¢ «¨áâ «ª¨ ¨ § ¯®«­¥­¨¥ FldShowValue ¨ FldRealValue
        if( ListFI( FIKIND_CURRENCY, 0, FI ) )
            if( FI.FIID == NATCUR )
                return CM_IGNORE;
            else
                FldRealValue = FI.FIID;
                FldShowValue = GetCcyCode( FldRealValue );
            end;
        end;
    else
        DL_FldProc_FI( pThis, Cmd, Key, @FldShowValue, @FldRealValue );
    end;
    return CM_DEFAULT;
END;

CLASS ( DL_CPanel ) VA_CurBnrRep_Panel()
    PRIVATE MACRO Init()
        PRIVATE VAR CurMonth, CurYear;

        DateSplit( {curdate}, null, CurMonth, CurYear );

        AddFieldProc( 0, PNFLD_VSBNRCUR_PERIOD,     PNFLD_PERIOD,        @FldProc_Period, "" );
        AddFieldProc( 0, PNFLD_VSBNRCUR_YEAR,       PNFLD_YEAR,          @FldProc_Year, "" );
        AddFieldProc( 0, PNFLD_VSBNRCUR_BEGINDATE,  DL_PNFLD_BEGINDATE,  @FldProc_BeginDate, Date( 1, CurMonth, CurYear ) );
        AddFieldProc( 0, PNFLD_VSBNRCUR_ENDDATE,    DL_PNFLD_ENDDATE,    @FldProc_EndDate, {curdate} );
        AddFieldProc( 0, PNFLD_VSBNRCUR_CURCODE,    DL_PNFLD_FI,         @FldProc_FI, ALLFININSTR, 1, 1 );
        AddFieldProc( 0, PNFLD_VSBNRCUR_CURNAME,    DL_PNFLD_FI_NAME,    @DL_FldProc_FI_Name, ALLFININSTR, 1, 1 );
        AddFieldProc( 0, PNFLD_VSBNRCUR_DEPARTCODE, DL_PNFLD_DEPARTMENT, @DL_FldProc_DepartCode, {OperDprt}, 1, 1 );
        AddFieldProc( 0, PNFLD_VSBNRCUR_DEPARTMENT, DL_PNFLD_DEPARTCODE, @DL_FldProc_Department, {OperDprt}, 1, 1 );
    END;

    PRIVATE MACRO Check():BOOL
        return true;
    END;

    initDL_CPanel( "vs_rep.lbr", "VSBNRCUR" );
END;
