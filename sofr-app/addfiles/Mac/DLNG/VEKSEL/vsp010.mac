/*
$Name:         vsp010.mac
$Module:       Векселя банка
$Description:  Погашение собств.векселя в другом филиале банка. Инициализация операции

               vs-вексель
                p-операция погашения собств.векселя в другом филиале банка
               10-номер (соответствующий шагу)
*/

IMPORT InsCarryDoc, vsdates, vslib, vs4each, vsrepay6;

// Установка признака "На погашении" для векселей, отобранных для погашения.
// Производится в режиме "Не ЦАБС". (В режиме "ЦАБС" производится в филиале-погашения).
//
PRIVATE MACRO Инициализация(order)
    var stat = 0, CABS = false;

    if(not VS_GetRegistryValue("ВЕКСЕЛЯ БАНКА\\РЕЖИМ РАБОТЫ\\CABS", V_BOOL, @CABS))
        stat = 1;
    end;

    if((stat == 0) and not CABS and not ИнициализацияПогашения(order, order.SignDate))
        stat = 1;
    end;

    return (stat == 0);
END;

// Запуск шага
//
MACRO ExecuteStep(Buffer, dl_order)
    var stat = 0, paym = null;
    record order(dl_order); SetBuff(order, dl_order);

    if(not Инициализация(order))
        stat = 1;
    end;

    if((stat == 0) and not НайтиПлатежПоДоговору(@paym, order, -1))
        stat = Ошибка("Не найден платеж по договору");
    end;

    if((stat == 0) and not OprReplanStepPlanDates(DATE_EMI_PAY, paym.ValueDate)) // Дата оплаты
        stat = 1;
    end;

    return stat;
END;
